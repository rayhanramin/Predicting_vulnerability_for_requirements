<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25588:4ae0c5713dfecf37275060a0695be6702906adfd</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4ae0c5713dfecf37275060a0695be6702906adfd" />
<meta property="og:url" content="/comm-central/rev/4ae0c5713dfecf37275060a0695be6702906adfd" />
<meta property="og:description" content="Bug 1458367 - Mass replace the Components.interface/Components.utils uses with Ci/Cu in Calendar. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4ae0c5713dfecf37275060a0695be6702906adfd 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4ae0c5713dfecf37275060a0695be6702906adfd">shortlog</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4ae0c5713dfecf37275060a0695be6702906adfd">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd">files</a> |
changeset |
<a href="/comm-central/raw-rev/4ae0c5713dfecf37275060a0695be6702906adfd">raw</a>  | <a href="/comm-central/archive/4ae0c5713dfecf37275060a0695be6702906adfd.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1458367">Bug 1458367</a> - Mass replace the Components.interface/Components.utils uses with Ci/Cu in Calendar. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#116;&#105;&#110;&#32;&#83;&#99;&#104;&#114;&#111;&#101;&#100;&#101;&#114;&#32;&#60;&#109;&#115;&#99;&#104;&#114;&#111;&#101;&#100;&#101;&#114;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#120;&#45;&#104;&#111;&#109;&#101;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 23 Sep 2018 01:20:13 +0200</td></tr>

<tr>
 <td>changeset 25588</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4ae0c5713dfecf37275060a0695be6702906adfd">4ae0c5713dfecf37275060a0695be6702906adfd</a></td>
</tr>



<tr>
<td>parent 25587</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7144956c64ee446af66d70d9bc461c7d1cff46cc">7144956c64ee446af66d70d9bc461c7d1cff46cc</a>
</td>
</tr>

<tr>
<td>child 25589</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8015b21deff6cc830908f042f1847e60780178ed">8015b21deff6cc830908f042f1847e60780178ed</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4ae0c5713dfecf37275060a0695be6702906adfd">15358</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 15 Jan 2019 04:48:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4ae0c5713dfe [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4ae0c5713dfecf37275060a0695be6702906adfd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4ae0c5713dfecf37275060a0695be6702906adfd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ae0c5713dfecf37275060a0695be6702906adfd&newProject=comm-central&newRevision=7144956c64ee446af66d70d9bc461c7d1cff46cc&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ae0c5713dfecf37275060a0695be6702906adfd&newProject=comm-central&newRevision=7144956c64ee446af66d70d9bc461c7d1cff46cc&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ae0c5713dfecf37275060a0695be6702906adfd&newProject=comm-central&newRevision=7144956c64ee446af66d70d9bc461c7d1cff46cc&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1458367">1458367</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1458367">Bug 1458367</a> - Mass replace the Components.interface/Components.utils uses with Ci/Cu in Calendar. r=MakeMyDay</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/.eslintrc.js">calendar/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/calBackendLoader.js">calendar/base/backend/calBackendLoader.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/calBackendLoader.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/calBackendLoader.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/calBackendLoader.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/calBackendLoader.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/calBackendLoader.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calICSService.js">calendar/base/backend/icaljs/calICSService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calICSService.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calICSService.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calICSService.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calICSService.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calICSService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calRecurrenceRule.js">calendar/base/backend/icaljs/calRecurrenceRule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calRecurrenceRule.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calRecurrenceRule.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calRecurrenceRule.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calRecurrenceRule.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/backend/icaljs/calRecurrenceRule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.xml">calendar/base/content/agenda-listbox.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/agenda-listbox.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-chrome-startup.js">calendar/base/content/calendar-chrome-startup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-chrome-startup.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-chrome-startup.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-chrome-startup.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-chrome-startup.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-chrome-startup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-clipboard.js">calendar/base/content/calendar-clipboard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-clipboard.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-clipboard.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-clipboard.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-clipboard.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-clipboard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-extract.js">calendar/base/content/calendar-extract.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-extract.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-extract.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-extract.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-extract.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-extract.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-management.js">calendar/base/content/calendar-management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-management.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-management.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-management.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-management.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-management.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-month-view.xml">calendar/base/content/calendar-month-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-month-view.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-month-view.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-month-view.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-month-view.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-month-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-statusbar.js">calendar/base/content/calendar-statusbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-statusbar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-statusbar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-statusbar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-statusbar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-statusbar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.js">calendar/base/content/calendar-task-tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-view.js">calendar/base/content/calendar-task-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-view.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-view.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-view.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-view.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-task-view.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-view-core.xml">calendar/base/content/calendar-view-core.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-view-core.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-view-core.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-view-core.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-view-core.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-view-core.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-views.js">calendar/base/content/calendar-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-views.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-views.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-views.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-views.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/calendar-views.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-alarm-dialog.js">calendar/base/content/dialogs/calendar-alarm-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-alarm-dialog.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-alarm-dialog.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-alarm-dialog.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-alarm-dialog.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-alarm-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-creation.js">calendar/base/content/dialogs/calendar-creation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-creation.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-creation.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-creation.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-dialog-utils.js">calendar/base/content/dialogs/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-error-prompt.xul">calendar/base/content/dialogs/calendar-error-prompt.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-error-prompt.xul">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-error-prompt.xul">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-error-prompt.xul">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-error-prompt.xul">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-error-prompt.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">calendar/base/content/dialogs/calendar-event-dialog-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-invitations-list.xml">calendar/base/content/dialogs/calendar-invitations-list.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-invitations-list.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-invitations-list.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-invitations-list.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-invitations-list.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-invitations-list.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-migration-dialog.js">calendar/base/content/dialogs/calendar-migration-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-migration-dialog.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-migration-dialog.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-migration-dialog.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-migration-dialog.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-migration-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-print-dialog.js">calendar/base/content/dialogs/calendar-print-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-print-dialog.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-print-dialog.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-print-dialog.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-print-dialog.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-print-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">calendar/base/content/dialogs/calendar-subscriptions-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-summary-dialog.js">calendar/base/content/dialogs/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/chooseCalendarDialog.js">calendar/base/content/dialogs/chooseCalendarDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/chooseCalendarDialog.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/chooseCalendarDialog.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/chooseCalendarDialog.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/chooseCalendarDialog.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/dialogs/chooseCalendarDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/import-export.js">calendar/base/content/import-export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/import-export.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/import-export.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/import-export.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/import-export.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/import-export.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/alarms.js">calendar/base/content/preferences/alarms.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/alarms.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/alarms.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/alarms.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/alarms.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/alarms.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/general.js">calendar/base/content/preferences/general.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/general.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/general.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/general.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/general.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/preferences/general.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-alarm-widget.xml">calendar/base/content/widgets/calendar-alarm-widget.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-alarm-widget.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-alarm-widget.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-alarm-widget.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-alarm-widget.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-alarm-widget.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-list-tree.xml">calendar/base/content/widgets/calendar-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-list-tree.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-list-tree.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-widgets.xml">calendar/base/content/widgets/calendar-widgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-widgets.xml">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-widgets.xml">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-widgets.xml">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-widgets.xml">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/content/widgets/calendar-widgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calExtract.jsm">calendar/base/modules/calExtract.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calExtract.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calExtract.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calExtract.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calExtract.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calExtract.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calRecurrenceUtils.jsm">calendar/base/modules/calRecurrenceUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calRecurrenceUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calRecurrenceUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calRecurrenceUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calRecurrenceUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calRecurrenceUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAlarmUtils.jsm">calendar/base/modules/utils/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAsyncUtils.jsm">calendar/base/modules/utils/calAsyncUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAsyncUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAsyncUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAsyncUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAsyncUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAsyncUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAuthUtils.jsm">calendar/base/modules/utils/calAuthUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAuthUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAuthUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAuthUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAuthUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calAuthUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDataUtils.jsm">calendar/base/modules/utils/calDataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDataUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDataUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDateTimeUtils.jsm">calendar/base/modules/utils/calDateTimeUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDateTimeUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDateTimeUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDateTimeUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDateTimeUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calDateTimeUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calEmailUtils.jsm">calendar/base/modules/utils/calEmailUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calEmailUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calEmailUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calEmailUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calEmailUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calEmailUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItemUtils.jsm">calendar/base/modules/utils/calItemUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItemUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItemUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItemUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItemUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItemUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItipUtils.jsm">calendar/base/modules/utils/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calL10NUtils.jsm">calendar/base/modules/utils/calL10NUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calL10NUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calL10NUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calL10NUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calL10NUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calL10NUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calProviderUtils.jsm">calendar/base/modules/utils/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calViewUtils.jsm">calendar/base/modules/utils/calViewUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calViewUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calViewUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calViewUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calViewUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/modules/utils/calViewUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmMonitor.js">calendar/base/src/calAlarmMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmMonitor.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmMonitor.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmMonitor.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmMonitor.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmService.js">calendar/base/src/calAlarmService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmService.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmService.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmService.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmService.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAlarmService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calApplicationUtils.js">calendar/base/src/calApplicationUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calApplicationUtils.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calApplicationUtils.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calApplicationUtils.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calApplicationUtils.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calApplicationUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttachment.js">calendar/base/src/calAttachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttachment.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttachment.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttachment.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttachment.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttachment.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttendee.js">calendar/base/src/calAttendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttendee.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttendee.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttendee.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttendee.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calAttendee.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarSearchService.js">calendar/base/src/calCalendarSearchService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarSearchService.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarSearchService.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarSearchService.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarSearchService.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calCalendarSearchService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDefaultACLManager.js">calendar/base/src/calDefaultACLManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDefaultACLManager.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDefaultACLManager.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDefaultACLManager.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDefaultACLManager.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDefaultACLManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDeletedItems.js">calendar/base/src/calDeletedItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDeletedItems.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDeletedItems.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDeletedItems.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDeletedItems.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calDeletedItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calEvent.js">calendar/base/src/calEvent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calEvent.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calEvent.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calEvent.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calEvent.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calEvent.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calFreeBusyService.js">calendar/base/src/calFreeBusyService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calFreeBusyService.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calFreeBusyService.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calFreeBusyService.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calFreeBusyService.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calFreeBusyService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsSerializer.js">calendar/base/src/calIcsSerializer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsSerializer.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsSerializer.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsSerializer.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsSerializer.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calIcsSerializer.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItipItem.js">calendar/base/src/calItipItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItipItem.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItipItem.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItipItem.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItipItem.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calItipItem.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calProtocolHandler.js">calendar/base/src/calProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceDate.js">calendar/base/src/calRecurrenceDate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceDate.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceDate.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceDate.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceDate.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceDate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRelation.js">calendar/base/src/calRelation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRelation.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRelation.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRelation.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRelation.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calRelation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calSleepMonitor.js">calendar/base/src/calSleepMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calSleepMonitor.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calSleepMonitor.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calSleepMonitor.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calSleepMonitor.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calSleepMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calStartupService.js">calendar/base/src/calStartupService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calStartupService.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calStartupService.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calStartupService.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calStartupService.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calStartupService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calHtmlExport.js">calendar/import-export/calHtmlExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calHtmlExport.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calHtmlExport.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calHtmlExport.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calHtmlExport.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calHtmlExport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calIcsImportExport.js">calendar/import-export/calIcsImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calIcsImportExport.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calIcsImportExport.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calIcsImportExport.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calIcsImportExport.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calIcsImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calListFormatter.js">calendar/import-export/calListFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calListFormatter.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calListFormatter.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calListFormatter.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calListFormatter.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calListFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calMonthGridPrinter.js">calendar/import-export/calMonthGridPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calMonthGridPrinter.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calMonthGridPrinter.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calMonthGridPrinter.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calMonthGridPrinter.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calMonthGridPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calOutlookCSVImportExport.js">calendar/import-export/calOutlookCSVImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calOutlookCSVImportExport.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calOutlookCSVImportExport.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calOutlookCSVImportExport.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calOutlookCSVImportExport.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calOutlookCSVImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calWeekPrinter.js">calendar/import-export/calWeekPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calWeekPrinter.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calWeekPrinter.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calWeekPrinter.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calWeekPrinter.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/import-export/calWeekPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/calItipProtocolHandler.js">calendar/lightning/components/calItipProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/calItipProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/calItipProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/calItipProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/calItipProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/calItipProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/lightningTextCalendarConverter.js">calendar/lightning/components/lightningTextCalendarConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/lightningTextCalendarConverter.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/lightningTextCalendarConverter.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/lightningTextCalendarConverter.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/lightningTextCalendarConverter.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/components/lightningTextCalendarConverter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/imip-bar.js">calendar/lightning/content/imip-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/imip-bar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/imip-bar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/imip-bar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/imip-bar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/imip-bar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-panel.js">calendar/lightning/content/lightning-item-panel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-panel.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-panel.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-panel.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-panel.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-item-panel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-migration.xul">calendar/lightning/content/lightning-migration.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-migration.xul">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-migration.xul">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-migration.xul">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-migration.xul">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-migration.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-utils.js">calendar/lightning/content/lightning-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-utils.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-utils.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-utils.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-utils.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/lightning-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/messenger-overlay-sidebar.js">calendar/lightning/content/messenger-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/messenger-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/messenger-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/messenger-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/messenger-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/content/messenger-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/modules/ltnInvitationUtils.jsm">calendar/lightning/modules/ltnInvitationUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/modules/ltnInvitationUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/modules/ltnInvitationUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/modules/ltnInvitationUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/modules/ltnInvitationUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/lightning/modules/ltnInvitationUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/composite/calCompositeCalendar.js">calendar/providers/composite/calCompositeCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/composite/calCompositeCalendar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/composite/calCompositeCalendar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/composite/calCompositeCalendar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/composite/calCompositeCalendar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/composite/calCompositeCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/browserRequest.js">calendar/providers/gdata/content/browserRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/browserRequest.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/browserRequest.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/browserRequest.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/browserRequest.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/browserRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/gdata-calendar-creation.js">calendar/providers/gdata/content/gdata-calendar-creation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/gdata-calendar-creation.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/gdata-calendar-creation.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/gdata-calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/gdata-calendar-creation.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/content/gdata-calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/OAuth2.jsm">calendar/providers/gdata/modules/OAuth2.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/OAuth2.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/OAuth2.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/OAuth2.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/OAuth2.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/OAuth2.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataLogging.jsm">calendar/providers/gdata/modules/gdataLogging.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataLogging.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataLogging.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataLogging.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataLogging.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataLogging.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataRequest.jsm">calendar/providers/gdata/modules/gdataRequest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataRequest.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataRequest.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataRequest.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataRequest.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataRequest.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataSession.jsm">calendar/providers/gdata/modules/gdataSession.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataSession.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataSession.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataSession.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataSession.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataUtils.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarModule.js">calendar/providers/wcap/calWcapCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarModule.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarModule.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapErrors.js">calendar/providers/wcap/calWcapErrors.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapErrors.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapErrors.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapErrors.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapErrors.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapErrors.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapUtils.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapUtils.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/public/calIWcapCalendar.idl">calendar/providers/wcap/public/calIWcapCalendar.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/public/calIWcapCalendar.idl">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/public/calIWcapCalendar.idl">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/public/calIWcapCalendar.idl">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/public/calIWcapCalendar.idl">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/providers/wcap/public/calIWcapCalendar.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/calendarCreation.js">calendar/resources/content/calendarCreation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/calendarCreation.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/calendarCreation.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/calendarCreation.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/calendarCreation.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/calendarCreation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/publish.js">calendar/resources/content/publish.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/publish.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/publish.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/publish.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/publish.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/resources/content/publish.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/mozmill/testLocalICS.js">calendar/test/mozmill/testLocalICS.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/mozmill/testLocalICS.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/mozmill/testLocalICS.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/mozmill/testLocalICS.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/mozmill/testLocalICS.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/mozmill/testLocalICS.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarm.js">calendar/test/unit/test_alarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarm.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarm.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarm.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarm.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarm.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarmservice.js">calendar/test/unit/test_alarmservice.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarmservice.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarmservice.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarmservice.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarmservice.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_alarmservice.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug1199942.js">calendar/test/unit/test_bug1199942.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug1199942.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug1199942.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug1199942.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug1199942.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug1199942.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug350845.js">calendar/test/unit/test_bug350845.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug350845.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug350845.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug350845.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug350845.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_bug350845.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_calmgr.js">calendar/test/unit/test_calmgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_calmgr.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_calmgr.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_calmgr.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_calmgr.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_calmgr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_data_bags.js">calendar/test/unit/test_data_bags.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_data_bags.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_data_bags.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_data_bags.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_data_bags.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_data_bags.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_datetimeformatter.js">calendar/test/unit/test_datetimeformatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_datetimeformatter.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_datetimeformatter.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_datetimeformatter.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_datetimeformatter.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_datetimeformatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_deleted_items.js">calendar/test/unit/test_deleted_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_deleted_items.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_deleted_items.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_deleted_items.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_deleted_items.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_deleted_items.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy.js">calendar/test/unit/test_freebusy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy_service.js">calendar/test/unit/test_freebusy_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy_service.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy_service.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy_service.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy_service.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_freebusy_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_gdata_provider.js">calendar/test/unit/test_gdata_provider.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_gdata_provider.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_gdata_provider.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_gdata_provider.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_gdata_provider.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_gdata_provider.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ics_parser.js">calendar/test/unit/test_ics_parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ics_parser.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ics_parser.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ics_parser.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ics_parser.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ics_parser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_imip.js">calendar/test/unit/test_imip.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_imip.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_imip.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_imip.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_imip.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_imip.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_items.js">calendar/test/unit/test_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_items.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_items.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_items.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_items.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_items.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ltninvitationutils.js">calendar/test/unit/test_ltninvitationutils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ltninvitationutils.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ltninvitationutils.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ltninvitationutils.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ltninvitationutils.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_ltninvitationutils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_providers.js">calendar/test/unit/test_providers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_providers.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_providers.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_providers.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_providers.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_providers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_recur.js">calendar/test/unit/test_recur.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_recur.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_recur.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_recur.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_recur.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_recur.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_search_service.js">calendar/test/unit/test_search_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_search_service.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_search_service.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_search_service.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_search_service.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_search_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_startup_service.js">calendar/test/unit/test_startup_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_startup_service.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_startup_service.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_startup_service.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_startup_service.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_startup_service.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_storage.js">calendar/test/unit/test_storage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_storage.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_storage.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_storage.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_storage.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_storage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_utils.js">calendar/test/unit/test_utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_utils.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_utils.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_utils.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_utils.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_webcal.js">calendar/test/unit/test_webcal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_webcal.js">file</a> |
<a href="/comm-central/annotate/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_webcal.js">annotate</a> |
<a href="/comm-central/diff/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_webcal.js">diff</a> |
<a href="/comm-central/comparison/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_webcal.js">comparison</a> |
<a href="/comm-central/log/4ae0c5713dfecf37275060a0695be6702906adfd/calendar/test/unit/test_webcal.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/.eslintrc.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/.eslintrc.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,18 +1,15 @@</span>
<a href="#l1.4"></a><span id="l1.4"> &quot;use strict&quot;;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> module.exports = {</span>
<a href="#l1.7"></a><span id="l1.7">     &quot;extends&quot;: [</span>
<a href="#l1.8"></a><span id="l1.8">         &quot;../../toolkit/.eslintrc.js&quot;</span>
<a href="#l1.9"></a><span id="l1.9">     ],</span>
<a href="#l1.10"></a><span id="l1.10">     &quot;rules&quot;: {</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-        // Awaiting bug 1458367.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        &quot;mozilla/use-cc-etc&quot;: &quot;off&quot;,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-</span>
<a href="#l1.14"></a><span id="l1.14">         // Enforce one true brace style (opening brace on the same line)</span>
<a href="#l1.15"></a><span id="l1.15">         // Allow single line (for now) because of the vast number of changes needed</span>
<a href="#l1.16"></a><span id="l1.16">         &quot;brace-style&quot;: [2, &quot;1tbs&quot;, { allowSingleLine: true }],</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">         // Enforce newline at the end of file, with no multiple empty lines.</span>
<a href="#l1.19"></a><span id="l1.19">         &quot;eol-last&quot;: 2,</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">         // Disallow using variables outside the blocks they are defined</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/backend/calBackendLoader.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/backend/calBackendLoader.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -40,17 +40,17 @@ calBackendLoader.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">             };</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">             // Load ical.js backend</span>
<a href="#l2.7"></a><span id="l2.7">             let scope = {};</span>
<a href="#l2.8"></a><span id="l2.8">             Services.scriptloader.loadSubScript(&quot;resource://calendar/components/calICALJSComponents.js&quot;, scope);</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">             // Register the icaljs components. We used to unregisterFactory, but this caused all</span>
<a href="#l2.11"></a><span id="l2.11">             // sorts of problems. Just registering over it seems to work quite fine.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            let registrar = Components.manager.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+            let registrar = Components.manager.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l2.14"></a><span id="l2.14">             for (let [contractID, classID] of Object.entries(contracts)) {</span>
<a href="#l2.15"></a><span id="l2.15">                 let newClassID = Components.ID(classID);</span>
<a href="#l2.16"></a><span id="l2.16">                 let newFactory = lazyFactoryFor(scope, newClassID);</span>
<a href="#l2.17"></a><span id="l2.17">                 registrar.registerFactory(newClassID, &quot;&quot;, contractID, newFactory);</span>
<a href="#l2.18"></a><span id="l2.18">             }</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">             dump(&quot;[calBackendLoader] Using Lightning's icaljs backend\n&quot;);</span>
<a href="#l2.21"></a><span id="l2.21">         } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -277,17 +277,17 @@ calIcalComponent.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">     set categories(val) { this.innerObject.updatePropertyWithValue(&quot;categories&quot;, val); },</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">     get URL() { return this.innerObject.getFirstPropertyValue(&quot;url&quot;); },</span>
<a href="#l3.7"></a><span id="l3.7">     set URL(val) { this.innerObject.updatePropertyWithValue(&quot;url&quot;, val); },</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">     get priority() {</span>
<a href="#l3.10"></a><span id="l3.10">         // If there is no value for this integer property, then we must return</span>
<a href="#l3.11"></a><span id="l3.11">         // the designated INVALID_VALUE.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        const INVALID_VALUE = Components.interfaces.calIIcalComponent.INVALID_VALUE;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        const INVALID_VALUE = Ci.calIIcalComponent.INVALID_VALUE;</span>
<a href="#l3.14"></a><span id="l3.14">         let prop = this.innerObject.getFirstProperty(&quot;priority&quot;);</span>
<a href="#l3.15"></a><span id="l3.15">         let val = prop ? prop.getFirstValue() : null;</span>
<a href="#l3.16"></a><span id="l3.16">         return (val === null ? INVALID_VALUE : val);</span>
<a href="#l3.17"></a><span id="l3.17">     },</span>
<a href="#l3.18"></a><span id="l3.18">     set priority(val) { this.innerObject.updatePropertyWithValue(&quot;priority&quot;, val); },</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">     _setTimeAttr: function(propName, val) {</span>
<a href="#l3.21"></a><span id="l3.21">         let prop = this.innerObject.updatePropertyWithValue(propName, val);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -422,18 +422,18 @@ calIcalComponent.prototype = {</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">     getReferencedTimezones: function(aCount) {</span>
<a href="#l3.25"></a><span id="l3.25">         let vals = Object.keys(this.mReferencedZones).map(timezone =&gt; this.mReferencedZones[timezone]);</span>
<a href="#l3.26"></a><span id="l3.26">         aCount.value = vals.length;</span>
<a href="#l3.27"></a><span id="l3.27">         return vals;</span>
<a href="#l3.28"></a><span id="l3.28">     },</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">     serializeToICSStream: function() {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-        let unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-                                         .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+        let unicodeConverter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+                                 .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l3.35"></a><span id="l3.35">         unicodeConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l3.36"></a><span id="l3.36">         return unicodeConverter.convertToInputStream(this.innerObject.toString());</span>
<a href="#l3.37"></a><span id="l3.37">     }</span>
<a href="#l3.38"></a><span id="l3.38"> };</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40"> function calICSService() {</span>
<a href="#l3.41"></a><span id="l3.41">     this.wrappedJSObject = this;</span>
<a href="#l3.42"></a><span id="l3.42"> }</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -450,39 +450,39 @@ calICSService.prototype = {</span>
<a href="#l3.44"></a><span id="l3.44">     },</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46">     parseICSAsync: function(serialized, tzProvider, listener) {</span>
<a href="#l3.47"></a><span id="l3.47">         // There are way too many error checking messages here, but I had so</span>
<a href="#l3.48"></a><span id="l3.48">         // much pain with this method that I don't want it to break again.</span>
<a href="#l3.49"></a><span id="l3.49">         try {</span>
<a href="#l3.50"></a><span id="l3.50">             let worker = new ChromeWorker(&quot;resource://calendar/calendar-js/calICSService-worker.js&quot;);</span>
<a href="#l3.51"></a><span id="l3.51">             worker.onmessage = function(event) {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-                let rc = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+                let rc = Cr.NS_ERROR_FAILURE;</span>
<a href="#l3.54"></a><span id="l3.54">                 let icalComp = null;</span>
<a href="#l3.55"></a><span id="l3.55">                 try {</span>
<a href="#l3.56"></a><span id="l3.56">                     rc = event.data.rc;</span>
<a href="#l3.57"></a><span id="l3.57">                     icalComp = new calIcalComponent(new ICAL.Component(event.data.data));</span>
<a href="#l3.58"></a><span id="l3.58">                     if (!Components.isSuccessCode(rc)) {</span>
<a href="#l3.59"></a><span id="l3.59">                         cal.ERROR(&quot;[calICSService] Error in parser worker: &quot; + data);</span>
<a href="#l3.60"></a><span id="l3.60">                     }</span>
<a href="#l3.61"></a><span id="l3.61">                 } catch (e) {</span>
<a href="#l3.62"></a><span id="l3.62">                     cal.ERROR(&quot;[calICSService] Exception parsing item: &quot; + e);</span>
<a href="#l3.63"></a><span id="l3.63">                 }</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65">                 listener.onParsingComplete(rc, icalComp);</span>
<a href="#l3.66"></a><span id="l3.66">             };</span>
<a href="#l3.67"></a><span id="l3.67">             worker.onerror = function(event) {</span>
<a href="#l3.68"></a><span id="l3.68">                 cal.ERROR(&quot;[calICSService] Error in parser worker: &quot; + event.message);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-                listener.onParsingComplete(Components.results.NS_ERROR_FAILURE, null);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+                listener.onParsingComplete(Cr.NS_ERROR_FAILURE, null);</span>
<a href="#l3.71"></a><span id="l3.71">             };</span>
<a href="#l3.72"></a><span id="l3.72">             worker.postMessage(serialized);</span>
<a href="#l3.73"></a><span id="l3.73">         } catch (e) {</span>
<a href="#l3.74"></a><span id="l3.74">             // If an error occurs above, the calling code will hang. Catch the exception just in case</span>
<a href="#l3.75"></a><span id="l3.75">             cal.ERROR(&quot;[calICSService] Error starting parsing worker: &quot; + e);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-            listener.onParsingComplete(Components.results.NS_ERROR_FAILURE, null);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+            listener.onParsingComplete(Cr.NS_ERROR_FAILURE, null);</span>
<a href="#l3.78"></a><span id="l3.78">         }</span>
<a href="#l3.79"></a><span id="l3.79">     },</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81">     createIcalComponent: function(kind) {</span>
<a href="#l3.82"></a><span id="l3.82">         return new calIcalComponent(new ICAL.Component(kind.toLowerCase()));</span>
<a href="#l3.83"></a><span id="l3.83">     },</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85">     createIcalProperty: function(kind) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calRecurrenceRule.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calRecurrenceRule.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -6,18 +6,18 @@ var { ICAL, unwrapSetter, unwrapSingle, </span>
<a href="#l4.4"></a><span id="l4.4"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> function calRecurrenceRule(innerObject) {</span>
<a href="#l4.7"></a><span id="l4.7">     this.innerObject = innerObject || new ICAL.Recur();</span>
<a href="#l4.8"></a><span id="l4.8">     this.wrappedJSObject = this;</span>
<a href="#l4.9"></a><span id="l4.9"> }</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> var calRecurrenceRuleInterfaces = [</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    Components.interfaces.calIRecurrenceRule,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    Components.interfaces.calIRecurrenceItem</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    Ci.calIRecurrenceRule,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    Ci.calIRecurrenceItem</span>
<a href="#l4.16"></a><span id="l4.16"> ];</span>
<a href="#l4.17"></a><span id="l4.17"> var calRecurrenceRuleClassID = Components.ID(&quot;{df19281a-5389-4146-b941-798cb93a7f0d}&quot;);</span>
<a href="#l4.18"></a><span id="l4.18"> calRecurrenceRule.prototype = {</span>
<a href="#l4.19"></a><span id="l4.19">     QueryInterface: cal.generateQI(calRecurrenceRuleInterfaces),</span>
<a href="#l4.20"></a><span id="l4.20">     classID: calRecurrenceRuleClassID,</span>
<a href="#l4.21"></a><span id="l4.21">     classInfo: cal.generateCI({</span>
<a href="#l4.22"></a><span id="l4.22">         contractID: &quot;@mozilla.org/calendar/recurrence-rule;1&quot;,</span>
<a href="#l4.23"></a><span id="l4.23">         classDescription: &quot;Calendar Recurrence Rule&quot;,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineat">@@ -41,17 +41,17 @@ calRecurrenceRule.prototype = {</span>
<a href="#l4.25"></a><span id="l4.25">     },</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">     getOccurrences: function(aStartTime, aRangeStart, aRangeEnd, aMaxCount, aCount) {</span>
<a href="#l4.28"></a><span id="l4.28">         aStartTime = unwrapSingle(ICAL.Time, aStartTime);</span>
<a href="#l4.29"></a><span id="l4.29">         aRangeStart = unwrapSingle(ICAL.Time, aRangeStart);</span>
<a href="#l4.30"></a><span id="l4.30">         aRangeEnd = unwrapSingle(ICAL.Time, aRangeEnd);</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">         if (!aMaxCount &amp;&amp; !aRangeEnd &amp;&amp; this.count == 0 &amp;&amp; this.until == null) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l4.35"></a><span id="l4.35">         }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">         let occurrences = [];</span>
<a href="#l4.38"></a><span id="l4.38">         let rangeStart = aRangeStart.clone();</span>
<a href="#l4.39"></a><span id="l4.39">         rangeStart.isDate = false;</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">         let dtend = null;</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43" class="difflineat">@@ -114,17 +114,17 @@ calRecurrenceRule.prototype = {</span>
<a href="#l4.44"></a><span id="l4.44">     get type() { return this.innerObject.freq; },</span>
<a href="#l4.45"></a><span id="l4.45">     set type(val) { this.innerObject.freq = val; },</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">     get interval() { return this.innerObject.interval; },</span>
<a href="#l4.48"></a><span id="l4.48">     set interval(val) { this.innerObject.interval = val; },</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">     get count() {</span>
<a href="#l4.51"></a><span id="l4.51">         if (!this.isByCount) {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-            throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+            throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l4.54"></a><span id="l4.54">         }</span>
<a href="#l4.55"></a><span id="l4.55">         return this.innerObject.count || -1;</span>
<a href="#l4.56"></a><span id="l4.56">     },</span>
<a href="#l4.57"></a><span id="l4.57">     set count(val) { this.innerObject.count = (val &amp;&amp; val &gt; 0 ? val : null); },</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59">     get untilDate() {</span>
<a href="#l4.60"></a><span id="l4.60">         if (this.innerObject.until) {</span>
<a href="#l4.61"></a><span id="l4.61">             return new calDateTime(this.innerObject.until);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -631,17 +631,17 @@ agendaListbox.refreshCalendarQuery = fun</span>
<a href="#l5.4"></a><span id="l5.4">             }</span>
<a href="#l5.5"></a><span id="l5.5">             for (let item of aItems) {</span>
<a href="#l5.6"></a><span id="l5.6">                 this.agendaListbox.addItem(item);</span>
<a href="#l5.7"></a><span id="l5.7">             }</span>
<a href="#l5.8"></a><span id="l5.8">         },</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">         cancel: function() {</span>
<a href="#l5.11"></a><span id="l5.11">             this.cancelled = true;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-            let operation = cal.wrapInstance(this.operation, Components.interfaces.calIOperation);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+            let operation = cal.wrapInstance(this.operation, Ci.calIOperation);</span>
<a href="#l5.14"></a><span id="l5.14">             if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l5.15"></a><span id="l5.15">                 operation.cancel();</span>
<a href="#l5.16"></a><span id="l5.16">                 this.operation = null;</span>
<a href="#l5.17"></a><span id="l5.17">             }</span>
<a href="#l5.18"></a><span id="l5.18">         },</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">         execute: function() {</span>
<a href="#l5.21"></a><span id="l5.21">             if (!(aStart || aEnd || aCalendar)) {</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -676,17 +676,17 @@ agendaListbox.refreshCalendarQuery = fun</span>
<a href="#l5.23"></a><span id="l5.23">                     this.agendaListbox.mPendingRefreshJobs.delete(this.calId);</span>
<a href="#l5.24"></a><span id="l5.24">                 }</span>
<a href="#l5.25"></a><span id="l5.25">             }</span>
<a href="#l5.26"></a><span id="l5.26">             this.calendar = aCalendar;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">             let filter = this.calendar.ITEM_FILTER_CLASS_OCCURRENCES |</span>
<a href="#l5.29"></a><span id="l5.29">                          this.calendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l5.30"></a><span id="l5.30">             let operation = this.calendar.getItems(filter, 0, aStart, aEnd, this);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-            operation = cal.wrapInstance(operation, Components.interfaces.calIOperation);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+            operation = cal.wrapInstance(operation, Ci.calIOperation);</span>
<a href="#l5.33"></a><span id="l5.33">             if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l5.34"></a><span id="l5.34">                 this.operation = operation;</span>
<a href="#l5.35"></a><span id="l5.35">                 this.agendaListbox.mPendingRefreshJobs.set(this.calId, this);</span>
<a href="#l5.36"></a><span id="l5.36">             }</span>
<a href="#l5.37"></a><span id="l5.37">         }</span>
<a href="#l5.38"></a><span id="l5.38">     };</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">     refreshJob.execute();</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineat">@@ -1109,18 +1109,17 @@ function scheduleNextCurrentEventUpdate(</span>
<a href="#l5.42"></a><span id="l5.42">         // Add observer</span>
<a href="#l5.43"></a><span id="l5.43">         Services.obs.addObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">         // Remove observer on unload</span>
<a href="#l5.46"></a><span id="l5.46">         window.addEventListener(&quot;unload&quot;, () =&gt; {</span>
<a href="#l5.47"></a><span id="l5.47">             Services.obs.removeObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l5.48"></a><span id="l5.48">         });</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-        gEventTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-                                   .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+        gEventTimer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l5.53"></a><span id="l5.53">     }</span>
<a href="#l5.54"></a><span id="l5.54">     gEventTimer.initWithCallback(udCallback, aMsUntil, gEventTimer.TYPE_ONE_SHOT);</span>
<a href="#l5.55"></a><span id="l5.55"> }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57"> /**</span>
<a href="#l5.58"></a><span id="l5.58">  * Gets a right value for calendar.agendaListbox.soondays preference, avoid</span>
<a href="#l5.59"></a><span id="l5.59">  * erroneus values edited in the lightning.js preference file</span>
<a href="#l5.60"></a><span id="l5.60">  **/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -196,18 +196,18 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">     &lt;implementation&gt;</span>
<a href="#l6.6"></a><span id="l6.6">       &lt;method name=&quot;setOccurrence&quot;&gt;</span>
<a href="#l6.7"></a><span id="l6.7">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.8"></a><span id="l6.8">         &lt;parameter name=&quot;aPeriod&quot;/&gt;</span>
<a href="#l6.9"></a><span id="l6.9">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.10"></a><span id="l6.10">             this.mOccurrence = aItem;</span>
<a href="#l6.11"></a><span id="l6.11">             this.setAttribute(&quot;status&quot;, aItem.status);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-            let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                                          .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+            let dateFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                                  .getService(Ci.calIDateTimeFormatter);</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">             let periodStartDate = aPeriod.start.clone();</span>
<a href="#l6.18"></a><span id="l6.18">             periodStartDate.isDate = true;</span>
<a href="#l6.19"></a><span id="l6.19">             let periodEndDate = aPeriod.end.clone();</span>
<a href="#l6.20"></a><span id="l6.20">             periodEndDate.day--;</span>
<a href="#l6.21"></a><span id="l6.21">             let start = this.mOccurrence[cal.dtz.startDateProp(this.mOccurrence)]</span>
<a href="#l6.22"></a><span id="l6.22">                             .getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l6.23"></a><span id="l6.23">             let end = this.mOccurrence[cal.dtz.endDateProp(this.mOccurrence)]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -233,18 +233,18 @@</span>
<a href="#l7.4"></a><span id="l7.4">           this.tasksInView = (document.getElementById(kTasksInViewCommand)</span>
<a href="#l7.5"></a><span id="l7.5">                                   .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l7.6"></a><span id="l7.6">           this.rotated = (document.getElementById(kOrientation)</span>
<a href="#l7.7"></a><span id="l7.7">                                   .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l7.8"></a><span id="l7.8">           this.showCompleted = (document.getElementById(kShowCompleted)</span>
<a href="#l7.9"></a><span id="l7.9">                                   .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">           this.mTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-          let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                                       .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+          let alarmService = Cc[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+                               .getService(Ci.calIAlarmService);</span>
<a href="#l7.16"></a><span id="l7.16">           alarmService.addObserver(this.mObserver);</span>
<a href="#l7.17"></a><span id="l7.17">           this.setAttribute(&quot;type&quot;, this.type);</span>
<a href="#l7.18"></a><span id="l7.18">           this.mResizeHandler = () =&gt; {</span>
<a href="#l7.19"></a><span id="l7.19">               this.onResize(this);</span>
<a href="#l7.20"></a><span id="l7.20">           };</span>
<a href="#l7.21"></a><span id="l7.21">           this.viewBroadcaster.addEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l7.22"></a><span id="l7.22">           // add a preference observer to monitor changes</span>
<a href="#l7.23"></a><span id="l7.23">           Services.prefs.addObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineat">@@ -257,18 +257,18 @@</span>
<a href="#l7.25"></a><span id="l7.25">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l7.28"></a><span id="l7.28">           ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">           if (this.mCalendar) {</span>
<a href="#l7.31"></a><span id="l7.31">               this.mCalendar.removeObserver(this.mObserver);</span>
<a href="#l7.32"></a><span id="l7.32">           }</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-          let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                                       .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+          let alarmService = Cc[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+                               .getService(Ci.calIAlarmService);</span>
<a href="#l7.37"></a><span id="l7.37">           alarmService.removeObserver(this.mObserver);</span>
<a href="#l7.38"></a><span id="l7.38">           this.viewBroadcaster.removeEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l7.39"></a><span id="l7.39">           Services.prefs.removeObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l7.40"></a><span id="l7.40">           Services.obs.removeObserver(this.mTimezoneObserver, &quot;defaultTimezoneChanged&quot;);</span>
<a href="#l7.41"></a><span id="l7.41">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">       &lt;property name=&quot;type&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.44"></a><span id="l7.44">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineat">@@ -478,17 +478,17 @@</span>
<a href="#l7.46"></a><span id="l7.46">                             this.calView.doAddItem(item);</span>
<a href="#l7.47"></a><span id="l7.47">                         }</span>
<a href="#l7.48"></a><span id="l7.48">                     }</span>
<a href="#l7.49"></a><span id="l7.49">                 },</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51">                 cancel: function() {</span>
<a href="#l7.52"></a><span id="l7.52">                     this.calView.mLog.info(&quot;Refresh cancelled for calendar &quot; + this.calId);</span>
<a href="#l7.53"></a><span id="l7.53">                     this.cancelled = true;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-                    let operation = cal.wrapInstance(this.operation, Components.interfaces.calIOperation);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                    let operation = cal.wrapInstance(this.operation, Ci.calIOperation);</span>
<a href="#l7.56"></a><span id="l7.56">                     if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l7.57"></a><span id="l7.57">                         operation.cancel();</span>
<a href="#l7.58"></a><span id="l7.58">                         this.operation = null;</span>
<a href="#l7.59"></a><span id="l7.59">                     }</span>
<a href="#l7.60"></a><span id="l7.60">                 },</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62">                 execute: function() {</span>
<a href="#l7.63"></a><span id="l7.63">                     if (!this.calView.startDate || !this.calView.endDate || !aCalendar) {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineat">@@ -530,33 +530,33 @@</span>
<a href="#l7.65"></a><span id="l7.65">                         filter |= this.calendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l7.66"></a><span id="l7.66">                     }</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">                     let operation = this.calendar.getItems(filter,</span>
<a href="#l7.69"></a><span id="l7.69">                                                            0,</span>
<a href="#l7.70"></a><span id="l7.70">                                                            this.calView.startDate,</span>
<a href="#l7.71"></a><span id="l7.71">                                                            this.calView.queryEndDate,</span>
<a href="#l7.72"></a><span id="l7.72">                                                            this);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-                    operation = cal.wrapInstance(operation, Components.interfaces.calIOperation);</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+                    operation = cal.wrapInstance(operation, Ci.calIOperation);</span>
<a href="#l7.75"></a><span id="l7.75">                     if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l7.76"></a><span id="l7.76">                         this.operation = operation;</span>
<a href="#l7.77"></a><span id="l7.77">                         this.calView.mPendingRefreshJobs.set(this.calId, this);</span>
<a href="#l7.78"></a><span id="l7.78">                     }</span>
<a href="#l7.79"></a><span id="l7.79">                 }</span>
<a href="#l7.80"></a><span id="l7.80">             };</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">             refreshJob.execute();</span>
<a href="#l7.83"></a><span id="l7.83">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.84"></a><span id="l7.84">       &lt;/method&gt;</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86">       &lt;method name=&quot;deleteItemsFromCalendar&quot;&gt;</span>
<a href="#l7.87"></a><span id="l7.87">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l7.88"></a><span id="l7.88">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.89"></a><span id="l7.89">             /* This method must be implemented in subclasses. */</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+            throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.92"></a><span id="l7.92">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.93"></a><span id="l7.93">       &lt;/method&gt;</span>
<a href="#l7.94"></a><span id="l7.94"> </span>
<a href="#l7.95"></a><span id="l7.95">       &lt;!-- the end date that should be used for getItems and similar queries --&gt;</span>
<a href="#l7.96"></a><span id="l7.96">       &lt;property name=&quot;queryEndDate&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.97"></a><span id="l7.97">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.98"></a><span id="l7.98">             let end = this.endDate;</span>
<a href="#l7.99"></a><span id="l7.99">             if (!end) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-chrome-startup.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-chrome-startup.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -31,19 +31,17 @@ async function commonInitCalendar() {</span>
<a href="#l8.4"></a><span id="l8.4">     // Set up the command controller from calendar-common-sets.js</span>
<a href="#l8.5"></a><span id="l8.5">     injectCalendarCommandController();</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">     // Set up item and day selection listeners</span>
<a href="#l8.8"></a><span id="l8.8">     getViewDeck().addEventListener(&quot;dayselect&quot;, observeViewDaySelect);</span>
<a href="#l8.9"></a><span id="l8.9">     getViewDeck().addEventListener(&quot;itemselect&quot;, calendarController.onSelectionChanged, true);</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">     // Start alarm service</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-              .getService(Components.interfaces.calIAlarmService)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-              .startup();</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    Cc[&quot;@mozilla.org/calendar/alarm-service;1&quot;].getService(Ci.calIAlarmService).startup();</span>
<a href="#l8.16"></a><span id="l8.16">     document.getElementById(&quot;calsidebar_splitter&quot;).addEventListener(&quot;command&quot;, onCalendarViewResize);</span>
<a href="#l8.17"></a><span id="l8.17">     window.addEventListener(&quot;resize&quot;, onCalendarViewResize, true);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">     // Set up the category colors</span>
<a href="#l8.20"></a><span id="l8.20">     categoryManagement.initCategories();</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">     // Set up window pref observers</span>
<a href="#l8.23"></a><span id="l8.23">     calendarWindowPrefs.init();</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineat">@@ -141,17 +139,17 @@ var calendarWindowPrefs = {</span>
<a href="#l8.25"></a><span id="l8.25">                     let attributeValue = Preferences.get(&quot;calendar.view.useSystemColors&quot;, false) &amp;&amp; &quot;true&quot;;</span>
<a href="#l8.26"></a><span id="l8.26">                     for (let win of fixIterator(Services.ww.getWindowEnumerator())) {</span>
<a href="#l8.27"></a><span id="l8.27">                         setElementValue(win.document.documentElement, attributeValue, &quot;systemcolors&quot;);</span>
<a href="#l8.28"></a><span id="l8.28">                     }</span>
<a href="#l8.29"></a><span id="l8.29">                     break;</span>
<a href="#l8.30"></a><span id="l8.30">                 }</span>
<a href="#l8.31"></a><span id="l8.31">             }</span>
<a href="#l8.32"></a><span id="l8.32">         } else if (aTopic == &quot;domwindowopened&quot;) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-            let win = aSubject.QueryInterface(Components.interfaces.nsIDOMWindow);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+            let win = aSubject.QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l8.35"></a><span id="l8.35">             win.addEventListener(&quot;load&quot;, () =&gt; {</span>
<a href="#l8.36"></a><span id="l8.36">                 let attributeValue = Preferences.get(&quot;calendar.view.useSystemColors&quot;, false) &amp;&amp; &quot;true&quot;;</span>
<a href="#l8.37"></a><span id="l8.37">                 setElementValue(win.document.documentElement, attributeValue, &quot;systemcolors&quot;);</span>
<a href="#l8.38"></a><span id="l8.38">             });</span>
<a href="#l8.39"></a><span id="l8.39">         }</span>
<a href="#l8.40"></a><span id="l8.40">     }</span>
<a href="#l8.41"></a><span id="l8.41"> };</span>
<a href="#l8.42"></a><span id="l8.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-clipboard.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-clipboard.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -82,33 +82,33 @@ function copyToClipboard(aCalendarItemAr</span>
<a href="#l9.4"></a><span id="l9.4">         aCutMode ? &quot;cut&quot; : &quot;copy&quot;</span>
<a href="#l9.5"></a><span id="l9.5">     );</span>
<a href="#l9.6"></a><span id="l9.6">     if (!response) {</span>
<a href="#l9.7"></a><span id="l9.7">         // The user canceled the dialog, bail out</span>
<a href="#l9.8"></a><span id="l9.8">         return;</span>
<a href="#l9.9"></a><span id="l9.9">     }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">     let icsSerializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                        .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                          .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l9.14"></a><span id="l9.14">     icsSerializer.addItems(targetItems, targetItems.length);</span>
<a href="#l9.15"></a><span id="l9.15">     let icsString = icsSerializer.serializeToString();</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">     let clipboard = Services.clipboard;</span>
<a href="#l9.18"></a><span id="l9.18">     let trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-                .createInstance(Ci.nsITransferable);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+                  .createInstance(Ci.nsITransferable);</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22">     if (trans &amp;&amp; clipboard) {</span>
<a href="#l9.23"></a><span id="l9.23">         // Register supported data flavors</span>
<a href="#l9.24"></a><span id="l9.24">         trans.init(null);</span>
<a href="#l9.25"></a><span id="l9.25">         trans.addDataFlavor(&quot;text/calendar&quot;);</span>
<a href="#l9.26"></a><span id="l9.26">         trans.addDataFlavor(&quot;text/unicode&quot;);</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28">         // Create the data objects</span>
<a href="#l9.29"></a><span id="l9.29">         let icsWrapper = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-                         .createInstance(Ci.nsISupportsString);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+                           .createInstance(Ci.nsISupportsString);</span>
<a href="#l9.32"></a><span id="l9.32">         icsWrapper.data = icsString;</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">         // Add data objects to transferable</span>
<a href="#l9.35"></a><span id="l9.35">         // Both Outlook 2000 client and Lotus Organizer use text/unicode</span>
<a href="#l9.36"></a><span id="l9.36">         // when pasting iCalendar data.</span>
<a href="#l9.37"></a><span id="l9.37">         trans.setTransferData(&quot;text/calendar&quot;,</span>
<a href="#l9.38"></a><span id="l9.38">                               icsWrapper,</span>
<a href="#l9.39"></a><span id="l9.39">                               icsWrapper.data.length * 2); // double byte data</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineat">@@ -156,17 +156,17 @@ function pasteFromClipboard() {</span>
<a href="#l9.41"></a><span id="l9.41">     let flavor = {};</span>
<a href="#l9.42"></a><span id="l9.42">     let data = {};</span>
<a href="#l9.43"></a><span id="l9.43">     trans.getAnyTransferData(flavor, data, {});</span>
<a href="#l9.44"></a><span id="l9.44">     data = data.value.QueryInterface(Ci.nsISupportsString).data;</span>
<a href="#l9.45"></a><span id="l9.45">     switch (flavor.value) {</span>
<a href="#l9.46"></a><span id="l9.46">         case &quot;text/calendar&quot;:</span>
<a href="#l9.47"></a><span id="l9.47">         case &quot;text/unicode&quot;: {</span>
<a href="#l9.48"></a><span id="l9.48">             let icsParser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-                           .createInstance(Ci.calIIcsParser);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+                              .createInstance(Ci.calIIcsParser);</span>
<a href="#l9.51"></a><span id="l9.51">             try {</span>
<a href="#l9.52"></a><span id="l9.52">                 icsParser.parseString(data);</span>
<a href="#l9.53"></a><span id="l9.53">             } catch (e) {</span>
<a href="#l9.54"></a><span id="l9.54">                 // Ignore parser errors from the clipboard data, if it fails</span>
<a href="#l9.55"></a><span id="l9.55">                 // there will just be 0 items.</span>
<a href="#l9.56"></a><span id="l9.56">             }</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">             let items = icsParser.getItems({});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -26,19 +26,19 @@ var itemConversion = {</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">         aItem.calendar = getSelectedCalendar();</span>
<a href="#l10.6"></a><span id="l10.6">         aItem.title = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">         cal.dtz.setDefaultStartEndHour(aItem);</span>
<a href="#l10.9"></a><span id="l10.9">         cal.alarms.setDefaultValues(aItem);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">         let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-                        .createInstance(Ci.nsIMessenger);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+                          .createInstance(Ci.nsIMessenger);</span>
<a href="#l10.14"></a><span id="l10.14">         let streamListener = Cc[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-                             .createInstance(Ci.nsISyncStreamListener);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+                               .createInstance(Ci.nsISyncStreamListener);</span>
<a href="#l10.17"></a><span id="l10.17">         messenger.messageServiceFromURI(msgUri).streamMessage(msgUri,</span>
<a href="#l10.18"></a><span id="l10.18">                                                               streamListener,</span>
<a href="#l10.19"></a><span id="l10.19">                                                               null,</span>
<a href="#l10.20"></a><span id="l10.20">                                                               null,</span>
<a href="#l10.21"></a><span id="l10.21">                                                               false,</span>
<a href="#l10.22"></a><span id="l10.22">                                                               &quot;&quot;,</span>
<a href="#l10.23"></a><span id="l10.23">                                                               false);</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineat">@@ -210,17 +210,17 @@ calDNDBaseObserver.prototype = {</span>
<a href="#l10.26"></a><span id="l10.26">     },</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">     /**</span>
<a href="#l10.29"></a><span id="l10.29">      * Action to take when dropping the event.</span>
<a href="#l10.30"></a><span id="l10.30">      */</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">     onDrop: function(aEvent, aTransferData, aDragSession) {</span>
<a href="#l10.33"></a><span id="l10.33">         let transferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-                           .createInstance(Ci.nsITransferable);</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+                             .createInstance(Ci.nsITransferable);</span>
<a href="#l10.36"></a><span id="l10.36">         transferable.init(null);</span>
<a href="#l10.37"></a><span id="l10.37">         transferable.addDataFlavor(&quot;text/calendar&quot;);</span>
<a href="#l10.38"></a><span id="l10.38">         transferable.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l10.39"></a><span id="l10.39">         transferable.addDataFlavor(&quot;text/x-moz-message&quot;);</span>
<a href="#l10.40"></a><span id="l10.40">         transferable.addDataFlavor(&quot;text/unicode&quot;);</span>
<a href="#l10.41"></a><span id="l10.41">         transferable.addDataFlavor(&quot;application/x-moz-file&quot;);</span>
<a href="#l10.42"></a><span id="l10.42"> </span>
<a href="#l10.43"></a><span id="l10.43">         aDragSession.getData(transferable, 0);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineat">@@ -553,17 +553,17 @@ calTaskButtonDNDObserver.prototype = {</span>
<a href="#l10.45"></a><span id="l10.45">  * Invoke a drag session for the passed item. The passed box will be used as a</span>
<a href="#l10.46"></a><span id="l10.46">  * source.</span>
<a href="#l10.47"></a><span id="l10.47">  *</span>
<a href="#l10.48"></a><span id="l10.48">  * @param aItem     The item to drag.</span>
<a href="#l10.49"></a><span id="l10.49">  * @param aXULBox   The XUL box to invoke the drag session from.</span>
<a href="#l10.50"></a><span id="l10.50">  */</span>
<a href="#l10.51"></a><span id="l10.51"> function invokeEventDragSession(aItem, aXULBox) {</span>
<a href="#l10.52"></a><span id="l10.52">     let transfer = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-                   .createInstance(Ci.nsITransferable);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+                     .createInstance(Ci.nsITransferable);</span>
<a href="#l10.55"></a><span id="l10.55">     transfer.init(null);</span>
<a href="#l10.56"></a><span id="l10.56">     transfer.addDataFlavor(&quot;text/calendar&quot;);</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58">     let flavourProvider = {</span>
<a href="#l10.59"></a><span id="l10.59">         QueryInterface: ChromeUtils.generateQI([Ci.nsIFlavorDataProvider]),</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61">         item: aItem,</span>
<a href="#l10.62"></a><span id="l10.62">         getFlavorData: function(aInTransferable, aInFlavor, aOutData, aOutDataLen) {</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineat">@@ -582,34 +582,33 @@ function invokeEventDragSession(aItem, a</span>
<a href="#l10.64"></a><span id="l10.64">         transfer.setTransferData(&quot;application/vnd.x-moz-cal-event&quot;, flavourProvider, 0);</span>
<a href="#l10.65"></a><span id="l10.65">     } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l10.66"></a><span id="l10.66">         transfer.addDataFlavor(&quot;application/vnd.x-moz-cal-task&quot;);</span>
<a href="#l10.67"></a><span id="l10.67">         transfer.setTransferData(&quot;application/vnd.x-moz-cal-task&quot;, flavourProvider, 0);</span>
<a href="#l10.68"></a><span id="l10.68">     }</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70">     // Also set some normal data-types, in case we drag into another app</span>
<a href="#l10.71"></a><span id="l10.71">     let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-                     .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+                       .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l10.74"></a><span id="l10.74">     serializer.addItems([aItem], 1);</span>
<a href="#l10.75"></a><span id="l10.75"> </span>
<a href="#l10.76"></a><span id="l10.76">     let supportsString = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-                         .createInstance(Ci.nsISupportsString);</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+                           .createInstance(Ci.nsISupportsString);</span>
<a href="#l10.79"></a><span id="l10.79">     supportsString.data = serializer.serializeToString();</span>
<a href="#l10.80"></a><span id="l10.80">     transfer.setTransferData(&quot;text/calendar&quot;, supportsString, supportsString.data.length * 2);</span>
<a href="#l10.81"></a><span id="l10.81">     transfer.setTransferData(&quot;text/unicode&quot;, supportsString, supportsString.data.length * 2);</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83">     let action = Ci.nsIDragService.DRAGDROP_ACTION_MOVE;</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-    let mutArray = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-                   .createInstance(Ci.nsIMutableArray);</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+    let mutArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l10.87"></a><span id="l10.87">     mutArray.appendElement(transfer);</span>
<a href="#l10.88"></a><span id="l10.88">     aXULBox.sourceObject = aItem;</span>
<a href="#l10.89"></a><span id="l10.89">     try {</span>
<a href="#l10.90"></a><span id="l10.90">         cal.getDragService().invokeDragSession(aXULBox, &quot;&quot;, mutArray, action);</span>
<a href="#l10.91"></a><span id="l10.91">     } catch (e) {</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-        if (e.result != Components.results.NS_ERROR_FAILURE) {</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+        if (e.result != Cr.NS_ERROR_FAILURE) {</span>
<a href="#l10.94"></a><span id="l10.94">             // Pressing Escape on some platforms results in NS_ERROR_FAILURE</span>
<a href="#l10.95"></a><span id="l10.95">             // being thrown. Catch this exception, but throw anything else.</span>
<a href="#l10.96"></a><span id="l10.96">             throw e;</span>
<a href="#l10.97"></a><span id="l10.97">         }</span>
<a href="#l10.98"></a><span id="l10.98">     }</span>
<a href="#l10.99"></a><span id="l10.99"> }</span>
<a href="#l10.100"></a><span id="l10.100"> </span>
<a href="#l10.101"></a><span id="l10.101"> /* exported calendarViewDNDObserver, calendarMailButtonDNDObserver,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-extract.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-extract.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -6,19 +6,19 @@ const { Extractor } = ChromeUtils.import</span>
<a href="#l11.4"></a><span id="l11.4"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l11.5"></a><span id="l11.5"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l11.6"></a><span id="l11.6"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> var calendarExtract = {</span>
<a href="#l11.9"></a><span id="l11.9">     onShowLocaleMenu: function(target) {</span>
<a href="#l11.10"></a><span id="l11.10">         let localeList = document.getElementById(target.id);</span>
<a href="#l11.11"></a><span id="l11.11">         let langs = [];</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-        let chrome = Components.classes[&quot;@mozilla.org/chrome/chrome-registry;1&quot;]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                               .getService(Components.interfaces.nsIXULChromeRegistry);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-        chrome.QueryInterface(Components.interfaces.nsIToolkitChromeRegistry);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+        let chrome = Cc[&quot;@mozilla.org/chrome/chrome-registry;1&quot;]</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+                       .getService(Ci.nsIXULChromeRegistry)</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+                       .QueryInterface(Ci.nsIToolkitChromeRegistry);</span>
<a href="#l11.18"></a><span id="l11.18">         let locales = chrome.getLocalesForPackage(&quot;calendar&quot;);</span>
<a href="#l11.19"></a><span id="l11.19">         let langRegex = /^(([^-]+)-*(.*))$/;</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">         while (locales.hasMore()) {</span>
<a href="#l11.22"></a><span id="l11.22">             let localeParts = langRegex.exec(locales.getNext());</span>
<a href="#l11.23"></a><span id="l11.23">             let langName = localeParts[2];</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">             try {</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineat">@@ -65,20 +65,19 @@ var calendarExtract = {</span>
<a href="#l11.27"></a><span id="l11.27">         let locale = event.target.value;</span>
<a href="#l11.28"></a><span id="l11.28">         this.extractFromEmail(isEvent, true, locale);</span>
<a href="#l11.29"></a><span id="l11.29">     },</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31">     extractFromEmail: function(isEvent, fixedLang, fixedLocale) {</span>
<a href="#l11.32"></a><span id="l11.32">         // TODO would be nice to handle multiple selected messages,</span>
<a href="#l11.33"></a><span id="l11.33">         // though old conversion functionality didn't</span>
<a href="#l11.34"></a><span id="l11.34">         let message = gFolderDisplay.selectedMessage;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-        let messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-                                  .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-        let listener = Components.classes[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-                                 .createInstance(Components.interfaces.nsISyncStreamListener);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+        let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+        let listener = Cc[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+                         .createInstance(Ci.nsISyncStreamListener);</span>
<a href="#l11.42"></a><span id="l11.42">         let uri = message.folder.getUriForMsg(message);</span>
<a href="#l11.43"></a><span id="l11.43">         messenger.messageServiceFromURI(uri)</span>
<a href="#l11.44"></a><span id="l11.44">                  .streamMessage(uri, listener, null, null, false, &quot;&quot;);</span>
<a href="#l11.45"></a><span id="l11.45">         let folder = message.folder;</span>
<a href="#l11.46"></a><span id="l11.46">         let title = message.mime2DecodedSubject;</span>
<a href="#l11.47"></a><span id="l11.47">         let content = folder.getMsgTextFromStream(listener.inputStream,</span>
<a href="#l11.48"></a><span id="l11.48">                                                   message.Charset,</span>
<a href="#l11.49"></a><span id="l11.49">                                                   65536,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -144,25 +144,25 @@ InvitationsManager.prototype = {</span>
<a href="#l12.4"></a><span id="l12.4">                     this.mInvitationsManager.mItemList.sort((a, b) =&gt; {</span>
<a href="#l12.5"></a><span id="l12.5">                         return a.startDate.compare(b.startDate);</span>
<a href="#l12.6"></a><span id="l12.6">                     });</span>
<a href="#l12.7"></a><span id="l12.7">                     for (let listener of listeners) {</span>
<a href="#l12.8"></a><span id="l12.8">                         try {</span>
<a href="#l12.9"></a><span id="l12.9">                             if (this.mInvitationsManager.mItemList.length) {</span>
<a href="#l12.10"></a><span id="l12.10">                                 // Only call if there are actually items</span>
<a href="#l12.11"></a><span id="l12.11">                                 listener.onGetResult(null,</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-                                                     Components.results.NS_OK,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-                                                     Components.interfaces.calIItemBase,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+                                                     Cr.NS_OK,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+                                                     Ci.calIItemBase,</span>
<a href="#l12.16"></a><span id="l12.16">                                                      null,</span>
<a href="#l12.17"></a><span id="l12.17">                                                      this.mInvitationsManager.mItemList.length,</span>
<a href="#l12.18"></a><span id="l12.18">                                                      this.mInvitationsManager.mItemList);</span>
<a href="#l12.19"></a><span id="l12.19">                             }</span>
<a href="#l12.20"></a><span id="l12.20">                             listener.onOperationComplete(null,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-                                                         Components.results.NS_OK,</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-                                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+                                                         Cr.NS_OK,</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+                                                         Ci.calIOperationListener.GET,</span>
<a href="#l12.25"></a><span id="l12.25">                                                          null,</span>
<a href="#l12.26"></a><span id="l12.26">                                                          null);</span>
<a href="#l12.27"></a><span id="l12.27">                         } catch (exc) {</span>
<a href="#l12.28"></a><span id="l12.28">                             cal.ERROR(exc);</span>
<a href="#l12.29"></a><span id="l12.29">                         }</span>
<a href="#l12.30"></a><span id="l12.30">                     }</span>
<a href="#l12.31"></a><span id="l12.31">                 }</span>
<a href="#l12.32"></a><span id="l12.32">             },</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineat">@@ -197,24 +197,24 @@ InvitationsManager.prototype = {</span>
<a href="#l12.34"></a><span id="l12.34">             // temporary hack unless calCachedCalendar supports REQUEST_NEEDS_ACTION filter:</span>
<a href="#l12.35"></a><span id="l12.35">             calendar = calendar.getProperty(&quot;cache.uncachedCalendar&quot;);</span>
<a href="#l12.36"></a><span id="l12.36">             if (!calendar) {</span>
<a href="#l12.37"></a><span id="l12.37">                 opListener.onOperationComplete();</span>
<a href="#l12.38"></a><span id="l12.38">                 continue;</span>
<a href="#l12.39"></a><span id="l12.39">             }</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41">             try {</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-                calendar = calendar.QueryInterface(Components.interfaces.calICalendar);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+                calendar = calendar.QueryInterface(Ci.calICalendar);</span>
<a href="#l12.44"></a><span id="l12.44">                 let endDate = this.mStartDate.clone();</span>
<a href="#l12.45"></a><span id="l12.45">                 endDate.year += 1;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-                let operation = calendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION |</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-                                                  Components.interfaces.calICalendar.ITEM_FILTER_TYPE_ALL |</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+                let operation = calendar.getItems(Ci.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION |</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+                                                  Ci.calICalendar.ITEM_FILTER_TYPE_ALL |</span>
<a href="#l12.50"></a><span id="l12.50">                                                   // we need to retrieve by occurrence to properly filter exceptions,</span>
<a href="#l12.51"></a><span id="l12.51">                                                   // should be fixed with bug 416975</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-                                                  Components.interfaces.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES,</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+                                                  Ci.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES,</span>
<a href="#l12.54"></a><span id="l12.54">                                                   0, this.mStartDate,</span>
<a href="#l12.55"></a><span id="l12.55">                                                   endDate /* we currently cannot pass null here, because of bug 416975 */,</span>
<a href="#l12.56"></a><span id="l12.56">                                                   opListener);</span>
<a href="#l12.57"></a><span id="l12.57">                 gInvitationsRequestManager.addRequestStatus(calendar, operation);</span>
<a href="#l12.58"></a><span id="l12.58">             } catch (exc) {</span>
<a href="#l12.59"></a><span id="l12.59">                 opListener.onOperationComplete();</span>
<a href="#l12.60"></a><span id="l12.60">                 cal.ERROR(exc);</span>
<a href="#l12.61"></a><span id="l12.61">             }</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineat">@@ -269,17 +269,17 @@ InvitationsManager.prototype = {</span>
<a href="#l12.63"></a><span id="l12.63">         operationListener.prototype = {</span>
<a href="#l12.64"></a><span id="l12.64">             QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l12.65"></a><span id="l12.65">             onOperationComplete: function(aCalendar,</span>
<a href="#l12.66"></a><span id="l12.66">                                           aStatus,</span>
<a href="#l12.67"></a><span id="l12.67">                                           aOperationType,</span>
<a href="#l12.68"></a><span id="l12.68">                                           aId,</span>
<a href="#l12.69"></a><span id="l12.69">                                           aDetail) {</span>
<a href="#l12.70"></a><span id="l12.70">                 if (Components.isSuccessCode(aStatus) &amp;&amp;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-                    aOperationType == Components.interfaces.calIOperationListener.MODIFY) {</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+                    aOperationType == Ci.calIOperationListener.MODIFY) {</span>
<a href="#l12.73"></a><span id="l12.73">                     cal.itip.checkAndSend(aOperationType, aDetail, this.mOldItem);</span>
<a href="#l12.74"></a><span id="l12.74">                     this.mInvitationsManager.deleteItem(aDetail);</span>
<a href="#l12.75"></a><span id="l12.75">                     this.mInvitationsManager.addItem(aDetail);</span>
<a href="#l12.76"></a><span id="l12.76">                 }</span>
<a href="#l12.77"></a><span id="l12.77">                 this.mInvitationsManager.mJobsPending--;</span>
<a href="#l12.78"></a><span id="l12.78">                 if (this.mInvitationsManager.mJobsPending == 0 &amp;&amp;</span>
<a href="#l12.79"></a><span id="l12.79">                     this.mJobQueueFinishedCallBack) {</span>
<a href="#l12.80"></a><span id="l12.80">                     this.mJobQueueFinishedCallBack();</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineat">@@ -404,16 +404,16 @@ InvitationsManager.prototype = {</span>
<a href="#l12.82"></a><span id="l12.82">      * Checks if the item is valid for the invitation manager. Checks if the</span>
<a href="#l12.83"></a><span id="l12.83">      * item is in the range of the invitation manager and if the item is a valid</span>
<a href="#l12.84"></a><span id="l12.84">      * invitation.</span>
<a href="#l12.85"></a><span id="l12.85">      *</span>
<a href="#l12.86"></a><span id="l12.86">      * @param item      The item to check</span>
<a href="#l12.87"></a><span id="l12.87">      * @return          A boolean indicating if the item is a valid invitation.</span>
<a href="#l12.88"></a><span id="l12.88">      */</span>
<a href="#l12.89"></a><span id="l12.89">     validateItem: function(item) {</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-        if (item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+        if (item.calendar instanceof Ci.calISchedulingSupport &amp;&amp;</span>
<a href="#l12.92"></a><span id="l12.92">             !item.calendar.isInvitation(item)) {</span>
<a href="#l12.93"></a><span id="l12.93">             return false; // exclude if organizer has invited himself</span>
<a href="#l12.94"></a><span id="l12.94">         }</span>
<a href="#l12.95"></a><span id="l12.95">         let start = item[cal.dtz.startDateProp(item)] || item[cal.dtz.endDateProp(item)];</span>
<a href="#l12.96"></a><span id="l12.96">         return cal.itip.isOpenInvitation(item) &amp;&amp; start.compare(this.mStartDate) &gt;= 0;</span>
<a href="#l12.97"></a><span id="l12.97">     }</span>
<a href="#l12.98"></a><span id="l12.98"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -466,17 +466,17 @@ function openEventDialog(calendarItem, c</span>
<a href="#l13.4"></a><span id="l13.4">     };</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">     // the dialog will reset this to auto when it is done loading.</span>
<a href="#l13.7"></a><span id="l13.7">     window.setCursor(&quot;wait&quot;);</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">     // ask the provide if this item is an invitation. if this is the case</span>
<a href="#l13.10"></a><span id="l13.10">     // we'll open the summary dialog since the user is not allowed to change</span>
<a href="#l13.11"></a><span id="l13.11">     // the details of the item.</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    let wrappedCalendar = cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    let wrappedCalendar = cal.wrapInstance(calendar, Ci.calISchedulingSupport);</span>
<a href="#l13.14"></a><span id="l13.14">     let isInvitation = wrappedCalendar &amp;&amp; wrappedCalendar.isInvitation(calendarItem);</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16">     // open the dialog modeless</span>
<a href="#l13.17"></a><span id="l13.17">     let url;</span>
<a href="#l13.18"></a><span id="l13.18">     let isEditable = mode == &quot;modify&quot; &amp;&amp; !isInvitation &amp;&amp; cal.acl.userCanModifyItem(calendarItem);</span>
<a href="#l13.19"></a><span id="l13.19">     if (cal.acl.isCalendarWritable(calendar) &amp;&amp; (mode == &quot;new&quot; || isEditable)) {</span>
<a href="#l13.20"></a><span id="l13.20">         if (args.inTab) {</span>
<a href="#l13.21"></a><span id="l13.21">             url = args.useNewItemUI ? &quot;chrome://lightning/content/html-item-editing/lightning-item-iframe.html&quot;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -580,17 +580,17 @@ function promptOccurrenceModification(aI</span>
<a href="#l13.23"></a><span id="l13.23">     }</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">     switch (type) {</span>
<a href="#l13.26"></a><span id="l13.26">         case MODIFY_PARENT:</span>
<a href="#l13.27"></a><span id="l13.27">             pastItems = items.map(item =&gt; item.parentItem);</span>
<a href="#l13.28"></a><span id="l13.28">             break;</span>
<a href="#l13.29"></a><span id="l13.29">         case MODIFY_FOLLOWING:</span>
<a href="#l13.30"></a><span id="l13.30">             // TODO tbd in a different bug</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+            throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.33"></a><span id="l13.33">         case MODIFY_OCCURRENCE:</span>
<a href="#l13.34"></a><span id="l13.34">             pastItems = items;</span>
<a href="#l13.35"></a><span id="l13.35">             break;</span>
<a href="#l13.36"></a><span id="l13.36">         case CANCEL:</span>
<a href="#l13.37"></a><span id="l13.37">             // Since we have not set past or futureItem, the return below will</span>
<a href="#l13.38"></a><span id="l13.38">             // take care.</span>
<a href="#l13.39"></a><span id="l13.39">             break;</span>
<a href="#l13.40"></a><span id="l13.40">     }</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineat">@@ -603,21 +603,20 @@ function promptOccurrenceModification(aI</span>
<a href="#l13.42"></a><span id="l13.42"> // Undo/Redo code</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44"> /**</span>
<a href="#l13.45"></a><span id="l13.45">  * Helper to return the transaction manager service.</span>
<a href="#l13.46"></a><span id="l13.46">  *</span>
<a href="#l13.47"></a><span id="l13.47">  * @return      The calITransactionManager service.</span>
<a href="#l13.48"></a><span id="l13.48">  */</span>
<a href="#l13.49"></a><span id="l13.49"> function getTransactionMgr() {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/calendar/transactionmanager;1&quot;]</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-                     .getService(Components.interfaces.calITransactionManager);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    return Cc[&quot;@mozilla.org/calendar/transactionmanager;1&quot;]</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+             .getService(Ci.calITransactionManager);</span>
<a href="#l13.54"></a><span id="l13.54"> }</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-</span>
<a href="#l13.57"></a><span id="l13.57"> /**</span>
<a href="#l13.58"></a><span id="l13.58">  * Create and commit a transaction with the given arguments to the transaction</span>
<a href="#l13.59"></a><span id="l13.59">  * manager. Also updates the undo/redo menu.</span>
<a href="#l13.60"></a><span id="l13.60">  *</span>
<a href="#l13.61"></a><span id="l13.61">  * @see                 calITransactionManager</span>
<a href="#l13.62"></a><span id="l13.62">  * @param aAction       The action to do.</span>
<a href="#l13.63"></a><span id="l13.63">  * @param aItem         The new item to add/modify/delete</span>
<a href="#l13.64"></a><span id="l13.64">  * @param aCalendar     The calendar to do the transaction on</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/calendar-management.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/calendar-management.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -25,18 +25,18 @@ function getSelectedCalendar() {</span>
<a href="#l14.4"></a><span id="l14.4"> /**</span>
<a href="#l14.5"></a><span id="l14.5">  * Deletes the passed calendar, prompting the user if he really wants to do</span>
<a href="#l14.6"></a><span id="l14.6">  * this. If there is only one calendar left, no calendar is removed and the user</span>
<a href="#l14.7"></a><span id="l14.7">  * is not prompted.</span>
<a href="#l14.8"></a><span id="l14.8">  *</span>
<a href="#l14.9"></a><span id="l14.9">  * @param aCalendar     The calendar to delete.</span>
<a href="#l14.10"></a><span id="l14.10">  */</span>
<a href="#l14.11"></a><span id="l14.11"> function promptDeleteCalendar(aCalendar) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    const nIPS = Components.interfaces.nsIPromptService;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-    const cICM = Components.interfaces.calICalendarManager;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+    const nIPS = Ci.nsIPromptService;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    const cICM = Ci.calICalendarManager;</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17">     let calMgr = cal.getCalendarManager();</span>
<a href="#l14.18"></a><span id="l14.18">     let calendars = calMgr.getCalendars({});</span>
<a href="#l14.19"></a><span id="l14.19">     if (calendars.length &lt;= 1) {</span>
<a href="#l14.20"></a><span id="l14.20">         // If this is the last calendar, don't delete it.</span>
<a href="#l14.21"></a><span id="l14.21">         return;</span>
<a href="#l14.22"></a><span id="l14.22">     }</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24" class="difflineat">@@ -125,17 +125,17 @@ function initHomeCalendar() {</span>
<a href="#l14.25"></a><span id="l14.25">     composite.addCalendar(homeCalendar);</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">     // Wrapping this in a try/catch block, as if any of the migration code</span>
<a href="#l14.28"></a><span id="l14.28">     // fails, the app may not load.</span>
<a href="#l14.29"></a><span id="l14.29">     if (Preferences.get(&quot;calendar.migrator.enabled&quot;, true)) {</span>
<a href="#l14.30"></a><span id="l14.30">         try {</span>
<a href="#l14.31"></a><span id="l14.31">             gDataMigrator.checkAndMigrate();</span>
<a href="#l14.32"></a><span id="l14.32">         } catch (e) {</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-            Components.utils.reportError(&quot;Migrator error: &quot; + e);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+            Cu.reportError(&quot;Migrator error: &quot; + e);</span>
<a href="#l14.35"></a><span id="l14.35">         }</span>
<a href="#l14.36"></a><span id="l14.36">     }</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">     return homeCalendar;</span>
<a href="#l14.39"></a><span id="l14.39"> }</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41"> /**</span>
<a href="#l14.42"></a><span id="l14.42">  * Called to clean up the calendar manager for a window.</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineat">@@ -407,27 +407,27 @@ function openCalendarSubscriptionsDialog</span>
<a href="#l14.44"></a><span id="l14.44"> /**</span>
<a href="#l14.45"></a><span id="l14.45">  * Calendar Offline Manager</span>
<a href="#l14.46"></a><span id="l14.46">  */</span>
<a href="#l14.47"></a><span id="l14.47"> var calendarOfflineManager = {</span>
<a href="#l14.48"></a><span id="l14.48">     QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver]),</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">     init: function() {</span>
<a href="#l14.51"></a><span id="l14.51">         if (this.initialized) {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-            throw Components.results.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+            throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l14.54"></a><span id="l14.54">         }</span>
<a href="#l14.55"></a><span id="l14.55">         Services.obs.addObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57">         this.updateOfflineUI(!this.isOnline());</span>
<a href="#l14.58"></a><span id="l14.58">         this.initialized = true;</span>
<a href="#l14.59"></a><span id="l14.59">     },</span>
<a href="#l14.60"></a><span id="l14.60"> </span>
<a href="#l14.61"></a><span id="l14.61">     uninit: function() {</span>
<a href="#l14.62"></a><span id="l14.62">         if (!this.initialized) {</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+            throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.65"></a><span id="l14.65">         }</span>
<a href="#l14.66"></a><span id="l14.66">         Services.obs.removeObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l14.67"></a><span id="l14.67">         this.initialized = false;</span>
<a href="#l14.68"></a><span id="l14.68">     },</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70">     isOnline: function() {</span>
<a href="#l14.71"></a><span id="l14.71">         return !Services.io.offline;</span>
<a href="#l14.72"></a><span id="l14.72">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -75,18 +75,18 @@</span>
<a href="#l15.4"></a><span id="l15.4">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l15.5"></a><span id="l15.5">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l15.6"></a><span id="l15.6">             cal.ASSERT(!this.mOccurrence, &quot;Code changes needed to set the occurrence twice&quot;, true);</span>
<a href="#l15.7"></a><span id="l15.7">             this.mOccurrence = val;</span>
<a href="#l15.8"></a><span id="l15.8">             if (cal.item.isEvent(val)) {</span>
<a href="#l15.9"></a><span id="l15.9">                 if (!val.startDate.isDate) {</span>
<a href="#l15.10"></a><span id="l15.10">                     let icon = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-icon&quot;);</span>
<a href="#l15.11"></a><span id="l15.11">                     let label = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-label&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-                    let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                                              .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+                    let formatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+                                      .getService(Ci.calIDateTimeFormatter);</span>
<a href="#l15.16"></a><span id="l15.16">                     let timezone = this.calendarView ? this.calendarView.mTimezone</span>
<a href="#l15.17"></a><span id="l15.17">                                                      : cal.dtz.defaultTimezone;</span>
<a href="#l15.18"></a><span id="l15.18">                     let parentDate = this.parentBox.date;</span>
<a href="#l15.19"></a><span id="l15.19">                     let parentTime = cal.createDateTime();</span>
<a href="#l15.20"></a><span id="l15.20">                     parentTime.resetTo(parentDate.year, parentDate.month, parentDate.day, 0, 0, 0, timezone);</span>
<a href="#l15.21"></a><span id="l15.21">                     let startTime = val.startDate.getInTimezone(timezone);</span>
<a href="#l15.22"></a><span id="l15.22">                     let endTime = val.endDate.getInTimezone(timezone);</span>
<a href="#l15.23"></a><span id="l15.23">                     let nextDay = parentTime.clone();</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineat">@@ -195,17 +195,17 @@</span>
<a href="#l15.25"></a><span id="l15.25">             return val;</span>
<a href="#l15.26"></a><span id="l15.26">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l15.27"></a><span id="l15.27">       &lt;/property&gt;</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">       &lt;method name=&quot;setDate&quot;&gt;</span>
<a href="#l15.30"></a><span id="l15.30">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l15.31"></a><span id="l15.31">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.32"></a><span id="l15.32">             if (!aDate) {</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-                throw Components.results.NS_ERROR_NULL_POINTER;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+                throw Cr.NS_ERROR_NULL_POINTER;</span>
<a href="#l15.35"></a><span id="l15.35">             }</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37">             // Remove all the old events</span>
<a href="#l15.38"></a><span id="l15.38">             this.mItemHash = {};</span>
<a href="#l15.39"></a><span id="l15.39">             removeChildren(this);</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41">             if (this.mDate &amp;&amp; this.mDate.compare(aDate) == 0) {</span>
<a href="#l15.42"></a><span id="l15.42">                 return;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineat">@@ -501,17 +501,17 @@</span>
<a href="#l15.44"></a><span id="l15.44">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l15.45"></a><span id="l15.45">       &lt;/property&gt;</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47">       &lt;method name=&quot;handlePreference&quot;&gt;</span>
<a href="#l15.48"></a><span id="l15.48">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l15.49"></a><span id="l15.49">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l15.50"></a><span id="l15.50">         &lt;parameter name=&quot;aPreference&quot;/&gt;</span>
<a href="#l15.51"></a><span id="l15.51">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-            aSubject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+            aSubject.QueryInterface(Ci.nsIPrefBranch);</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55">             switch (aPreference) {</span>
<a href="#l15.56"></a><span id="l15.56">                 case &quot;calendar.previousweeks.inview&quot;:</span>
<a href="#l15.57"></a><span id="l15.57">                     this.updateDaysOffPrefs();</span>
<a href="#l15.58"></a><span id="l15.58">                     this.refreshView();</span>
<a href="#l15.59"></a><span id="l15.59">                     break;</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">                 case &quot;calendar.week.start&quot;:</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineat">@@ -749,17 +749,17 @@</span>
<a href="#l15.63"></a><span id="l15.63">                 }</span>
<a href="#l15.64"></a><span id="l15.64">             }</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66">             if (this.mSelectedItems.length) {</span>
<a href="#l15.67"></a><span id="l15.67">                 this.mSelectedItems = [];</span>
<a href="#l15.68"></a><span id="l15.68">             }</span>
<a href="#l15.69"></a><span id="l15.69"> </span>
<a href="#l15.70"></a><span id="l15.70">             if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-                throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+                throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l15.73"></a><span id="l15.73">             }</span>
<a href="#l15.74"></a><span id="l15.74"> </span>
<a href="#l15.75"></a><span id="l15.75">             // Days that are not in the main month on display are displayed with</span>
<a href="#l15.76"></a><span id="l15.76">             // a gray background.  Unless the month actually starts on a Sunday,</span>
<a href="#l15.77"></a><span id="l15.77">             // this means that mStartDate.month is 1 month less than the main month</span>
<a href="#l15.78"></a><span id="l15.78">             let mainMonth = this.mStartDate.month;</span>
<a href="#l15.79"></a><span id="l15.79">             if (this.mStartDate.day != 1) {</span>
<a href="#l15.80"></a><span id="l15.80">                 mainMonth++;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -37,17 +37,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">       &lt;method name=&quot;setDayStartEndHours&quot;&gt;</span>
<a href="#l16.6"></a><span id="l16.6">         &lt;parameter name=&quot;aDayStartHour&quot;/&gt;</span>
<a href="#l16.7"></a><span id="l16.7">         &lt;parameter name=&quot;aDayEndHour&quot;/&gt;</span>
<a href="#l16.8"></a><span id="l16.8">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.9"></a><span id="l16.9">             if (aDayStartHour * 60 &lt; this.mStartMin ||</span>
<a href="#l16.10"></a><span id="l16.10">                 aDayStartHour &gt; aDayEndHour ||</span>
<a href="#l16.11"></a><span id="l16.11">                 aDayEndHour * 60 &gt; this.mEndMin) {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.14"></a><span id="l16.14">             }</span>
<a href="#l16.15"></a><span id="l16.15">             if (this.mDayStartHour != aDayStartHour ||</span>
<a href="#l16.16"></a><span id="l16.16">                 this.mDayEndHour != aDayEndHour) {</span>
<a href="#l16.17"></a><span id="l16.17">                 this.mDayEndHour = aDayEndHour;</span>
<a href="#l16.18"></a><span id="l16.18">                 this.mDayStartHour = aDayStartHour;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">                 let topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l16.21"></a><span id="l16.21">                 if (topbox.childNodes.length) {</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -635,18 +635,18 @@</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24">             // bgbox is used mainly for drawing the grid.  at some point it may</span>
<a href="#l16.25"></a><span id="l16.25">             // also be used for all-day events.</span>
<a href="#l16.26"></a><span id="l16.26">             let otherorient = getOtherOrientation(orient);</span>
<a href="#l16.27"></a><span id="l16.27">             let configBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;config-box&quot;);</span>
<a href="#l16.28"></a><span id="l16.28">             configBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l16.29"></a><span id="l16.29">             let minSize = configBox.getOptimalMinSize();</span>
<a href="#l16.30"></a><span id="l16.30">             configBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-            this.mMinDuration = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                                              .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+            this.mMinDuration = Cc[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+                                  .createInstance(Ci.calIDuration);</span>
<a href="#l16.35"></a><span id="l16.35">             this.mMinDuration.minutes = Math.trunc(minSize / this.mPixPerMin);</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37">             let theMin = this.mStartMin;</span>
<a href="#l16.38"></a><span id="l16.38">             while (theMin &lt; this.mEndMin) {</span>
<a href="#l16.39"></a><span id="l16.39">                 let dur = theMin % 60;</span>
<a href="#l16.40"></a><span id="l16.40">                 theMin += dur;</span>
<a href="#l16.41"></a><span id="l16.41">                 if (dur == 0) {</span>
<a href="#l16.42"></a><span id="l16.42">                     dur = 60;</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineat">@@ -1797,17 +1797,17 @@</span>
<a href="#l16.44"></a><span id="l16.44">         &lt;parameter name=&quot;aGrabbedElement&quot;/&gt;</span>
<a href="#l16.45"></a><span id="l16.45">         &lt;!-- mouse screenX/screenY from the event --&gt;</span>
<a href="#l16.46"></a><span id="l16.46">         &lt;parameter name=&quot;aMouseX&quot;/&gt;</span>
<a href="#l16.47"></a><span id="l16.47">         &lt;parameter name=&quot;aMouseY&quot;/&gt;</span>
<a href="#l16.48"></a><span id="l16.48">         &lt;parameter name=&quot;aSnapInt&quot;/&gt;</span>
<a href="#l16.49"></a><span id="l16.49">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.50"></a><span id="l16.50">             if (!cal.acl.isCalendarWritable(aOccurrence.calendar) ||</span>
<a href="#l16.51"></a><span id="l16.51">                 !cal.acl.userCanModifyItem(aOccurrence) ||</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-                (aOccurrence.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; aOccurrence.calendar.isInvitation(aOccurrence)) ||</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+                (aOccurrence.calendar instanceof Ci.calISchedulingSupport &amp;&amp; aOccurrence.calendar.isInvitation(aOccurrence)) ||</span>
<a href="#l16.54"></a><span id="l16.54">                 aOccurrence.calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l16.55"></a><span id="l16.55">                 return;</span>
<a href="#l16.56"></a><span id="l16.56">             }</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58">             this.mDragState = {</span>
<a href="#l16.59"></a><span id="l16.59">                 origColumn: this,</span>
<a href="#l16.60"></a><span id="l16.60">                 dragOccurrence: aOccurrence,</span>
<a href="#l16.61"></a><span id="l16.61">                 mouseOffset: 0,</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineat">@@ -1982,17 +1982,17 @@</span>
<a href="#l16.63"></a><span id="l16.63">       &lt;/method&gt;</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65">       &lt;method name=&quot;setDayStartEndMinutes&quot;&gt;</span>
<a href="#l16.66"></a><span id="l16.66">         &lt;parameter name=&quot;aDayStartMin&quot;/&gt;</span>
<a href="#l16.67"></a><span id="l16.67">         &lt;parameter name=&quot;aDayEndMin&quot;/&gt;</span>
<a href="#l16.68"></a><span id="l16.68">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.69"></a><span id="l16.69">             if (aDayStartMin &lt; this.mStartMin || aDayStartMin &gt; aDayEndMin ||</span>
<a href="#l16.70"></a><span id="l16.70">                 aDayEndMin &gt; this.mEndMin) {</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+                throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.73"></a><span id="l16.73">             }</span>
<a href="#l16.74"></a><span id="l16.74">             if (this.mDayStartMin != aDayStartMin || this.mDayEndMin != aDayEndMin) {</span>
<a href="#l16.75"></a><span id="l16.75">                 this.mDayStartMin = aDayStartMin;</span>
<a href="#l16.76"></a><span id="l16.76">                 this.mDayEndMin = aDayEndMin;</span>
<a href="#l16.77"></a><span id="l16.77">             }</span>
<a href="#l16.78"></a><span id="l16.78">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.79"></a><span id="l16.79">       &lt;/method&gt;</span>
<a href="#l16.80"></a><span id="l16.80"> </span>
<a href="#l16.81"></a><span id="l16.81" class="difflineat">@@ -2636,17 +2636,17 @@</span>
<a href="#l16.82"></a><span id="l16.82">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.83"></a><span id="l16.83">       &lt;/method&gt;</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85">       &lt;method name=&quot;handlePreference&quot;&gt;</span>
<a href="#l16.86"></a><span id="l16.86">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l16.87"></a><span id="l16.87">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l16.88"></a><span id="l16.88">         &lt;parameter name=&quot;aPreference&quot;/&gt;</span>
<a href="#l16.89"></a><span id="l16.89">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-            aSubject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+            aSubject.QueryInterface(Ci.nsIPrefBranch);</span>
<a href="#l16.92"></a><span id="l16.92">             switch (aPreference) {</span>
<a href="#l16.93"></a><span id="l16.93">                 case &quot;calendar.view.daystarthour&quot;:</span>
<a href="#l16.94"></a><span id="l16.94">                     this.setDayStartEndMinutes(aSubject.getIntPref(aPreference) * 60,</span>
<a href="#l16.95"></a><span id="l16.95">                                                this.mDayEndMin);</span>
<a href="#l16.96"></a><span id="l16.96">                     this.refreshView();</span>
<a href="#l16.97"></a><span id="l16.97">                     break;</span>
<a href="#l16.98"></a><span id="l16.98"> </span>
<a href="#l16.99"></a><span id="l16.99">                 case &quot;calendar.view.dayendhour&quot;:</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineat">@@ -3781,17 +3781,17 @@</span>
<a href="#l16.101"></a><span id="l16.101">             if (!(&quot;setDayStartEndHours&quot; in this.timebar)) {</span>
<a href="#l16.102"></a><span id="l16.102">                 this.timebar.addEventListener(</span>
<a href="#l16.103"></a><span id="l16.103">                   &quot;bindingattached&quot;, () =&gt; this.setDayStartEndMinutes(aDayStartMin, aDayEndMin), { once: true }</span>
<a href="#l16.104"></a><span id="l16.104">                 );</span>
<a href="#l16.105"></a><span id="l16.105">                 return;</span>
<a href="#l16.106"></a><span id="l16.106">             }</span>
<a href="#l16.107"></a><span id="l16.107">             if (aDayStartMin &lt; this.mStartMin || aDayStartMin &gt; aDayEndMin ||</span>
<a href="#l16.108"></a><span id="l16.108">                 aDayEndMin &gt; this.mEndMin) {</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+                throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.111"></a><span id="l16.111">             }</span>
<a href="#l16.112"></a><span id="l16.112">             if (this.mDayStartMin != aDayStartMin ||</span>
<a href="#l16.113"></a><span id="l16.113">                 this.mDayEndMin != aDayEndMin) {</span>
<a href="#l16.114"></a><span id="l16.114">                 this.mDayStartMin = aDayStartMin;</span>
<a href="#l16.115"></a><span id="l16.115">                 this.mDayEndMin = aDayEndMin;</span>
<a href="#l16.116"></a><span id="l16.116"> </span>
<a href="#l16.117"></a><span id="l16.117">                 // Also update on the time-bar</span>
<a href="#l16.118"></a><span id="l16.118">                 this.timebar.setDayStartEndHours(this.mDayStartMin / 60,</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineat">@@ -3801,17 +3801,17 @@</span>
<a href="#l16.120"></a><span id="l16.120">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.121"></a><span id="l16.121">       &lt;/method&gt;</span>
<a href="#l16.122"></a><span id="l16.122"> </span>
<a href="#l16.123"></a><span id="l16.123">       &lt;method name=&quot;setVisibleMinutes&quot;&gt;</span>
<a href="#l16.124"></a><span id="l16.124">         &lt;parameter name=&quot;aVisibleMinutes&quot;/&gt;</span>
<a href="#l16.125"></a><span id="l16.125">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.126"></a><span id="l16.126">             if (aVisibleMinutes &lt;= 0 ||</span>
<a href="#l16.127"></a><span id="l16.127">                 aVisibleMinutes &gt; (this.mEndMin - this.mStartMin)) {</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+                throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.130"></a><span id="l16.130">             }</span>
<a href="#l16.131"></a><span id="l16.131">             if (this.mVisibleMinutes != aVisibleMinutes) {</span>
<a href="#l16.132"></a><span id="l16.132">                 this.mVisibleMinutes = aVisibleMinutes;</span>
<a href="#l16.133"></a><span id="l16.133">             }</span>
<a href="#l16.134"></a><span id="l16.134">             return this.mVisibleMinutes;</span>
<a href="#l16.135"></a><span id="l16.135">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.136"></a><span id="l16.136">       &lt;/method&gt;</span>
<a href="#l16.137"></a><span id="l16.137"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/calendar-statusbar.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/calendar-statusbar.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -13,17 +13,17 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l17.4"></a><span id="l17.4"> var gCalendarStatusFeedback = {</span>
<a href="#l17.5"></a><span id="l17.5">     mCalendarStep: 0,</span>
<a href="#l17.6"></a><span id="l17.6">     mCalendarCount: 0,</span>
<a href="#l17.7"></a><span id="l17.7">     mWindow: null,</span>
<a href="#l17.8"></a><span id="l17.8">     mStatusText: null,</span>
<a href="#l17.9"></a><span id="l17.9">     mStatusBar: null,</span>
<a href="#l17.10"></a><span id="l17.10">     mStatusProgressPanel: null,</span>
<a href="#l17.11"></a><span id="l17.11">     mThrobber: null,</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    mProgressMode: Components.interfaces.calIStatusObserver.NO_PROGRESS,</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+    mProgressMode: Ci.calIStatusObserver.NO_PROGRESS,</span>
<a href="#l17.14"></a><span id="l17.14">     mCurIndex: 0,</span>
<a href="#l17.15"></a><span id="l17.15">     mInitialized: false,</span>
<a href="#l17.16"></a><span id="l17.16">     mCalendars: {},</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18">     QueryInterface: ChromeUtils.generateQI([Ci.calIStatusObserver]),</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20">     initialize: function(aWindow) {</span>
<a href="#l17.21"></a><span id="l17.21">         if (!this.mInitialized) {</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -40,62 +40,62 @@ var gCalendarStatusFeedback = {</span>
<a href="#l17.23"></a><span id="l17.23">         this.mStatusText.setAttribute(&quot;label&quot;, status);</span>
<a href="#l17.24"></a><span id="l17.24">     },</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">     get spinning() {</span>
<a href="#l17.27"></a><span id="l17.27">         return this.mProgressMode;</span>
<a href="#l17.28"></a><span id="l17.28">     },</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">     startMeteors: function(aProgressMode, aCalendarCount) {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-        if (aProgressMode != Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+        if (aProgressMode != Ci.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l17.33"></a><span id="l17.33">             if (!this.mInitialized) {</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-                Components.utils.reportError(&quot;StatusObserver has not been initialized!&quot;);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+                Cu.reportError(&quot;StatusObserver has not been initialized!&quot;);</span>
<a href="#l17.36"></a><span id="l17.36">                 return;</span>
<a href="#l17.37"></a><span id="l17.37">             }</span>
<a href="#l17.38"></a><span id="l17.38">             this.mCalendars = {};</span>
<a href="#l17.39"></a><span id="l17.39">             this.mCurIndex = 0;</span>
<a href="#l17.40"></a><span id="l17.40">             if (aCalendarCount) {</span>
<a href="#l17.41"></a><span id="l17.41">                 this.mCalendarCount = this.mCalendarCount + aCalendarCount;</span>
<a href="#l17.42"></a><span id="l17.42">                 this.mCalendarStep = Math.trunc(100 / this.mCalendarCount);</span>
<a href="#l17.43"></a><span id="l17.43">             }</span>
<a href="#l17.44"></a><span id="l17.44">             this.mProgressMode = aProgressMode;</span>
<a href="#l17.45"></a><span id="l17.45">             this.mStatusProgressPanel.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-            if (this.mProgressMode == Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+            if (this.mProgressMode == Ci.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l17.48"></a><span id="l17.48">                 this.mStatusBar.value = 0;</span>
<a href="#l17.49"></a><span id="l17.49">                 let commonStatus = cal.l10n.getCalString(&quot;gettingCalendarInfoCommon&quot;);</span>
<a href="#l17.50"></a><span id="l17.50">                 this.showStatusString(commonStatus);</span>
<a href="#l17.51"></a><span id="l17.51">             }</span>
<a href="#l17.52"></a><span id="l17.52">             if (this.mThrobber) {</span>
<a href="#l17.53"></a><span id="l17.53">                 this.mThrobber.setAttribute(&quot;busy&quot;, true);</span>
<a href="#l17.54"></a><span id="l17.54">             }</span>
<a href="#l17.55"></a><span id="l17.55">         }</span>
<a href="#l17.56"></a><span id="l17.56">     },</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58">     stopMeteors: function() {</span>
<a href="#l17.59"></a><span id="l17.59">         if (!this.mInitialized) {</span>
<a href="#l17.60"></a><span id="l17.60">             return;</span>
<a href="#l17.61"></a><span id="l17.61">         }</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-        if (this.spinning != Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-            this.mProgressMode = Components.interfaces.calIStatusObserver.NO_PROGRESS;</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+        if (this.spinning != Ci.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+            this.mProgressMode = Ci.calIStatusObserver.NO_PROGRESS;</span>
<a href="#l17.66"></a><span id="l17.66">             this.mStatusProgressPanel.collapsed = true;</span>
<a href="#l17.67"></a><span id="l17.67">             this.mStatusBar.value = 0;</span>
<a href="#l17.68"></a><span id="l17.68">             this.mCalendarCount = 0;</span>
<a href="#l17.69"></a><span id="l17.69">             this.showStatusString(&quot;&quot;);</span>
<a href="#l17.70"></a><span id="l17.70">             if (this.mThrobber) {</span>
<a href="#l17.71"></a><span id="l17.71">                 this.mThrobber.setAttribute(&quot;busy&quot;, false);</span>
<a href="#l17.72"></a><span id="l17.72">             }</span>
<a href="#l17.73"></a><span id="l17.73">         }</span>
<a href="#l17.74"></a><span id="l17.74">     },</span>
<a href="#l17.75"></a><span id="l17.75"> </span>
<a href="#l17.76"></a><span id="l17.76">     calendarCompleted: function(aCalendar) {</span>
<a href="#l17.77"></a><span id="l17.77">         if (!this.mInitialized) {</span>
<a href="#l17.78"></a><span id="l17.78">             return;</span>
<a href="#l17.79"></a><span id="l17.79">         }</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-        if (this.spinning != Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-            if (this.spinning == Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+        if (this.spinning != Ci.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+            if (this.spinning == Ci.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l17.84"></a><span id="l17.84">                 if (!this.mCalendars[aCalendar.id] || this.mCalendars[aCalendar.id] === undefined) {</span>
<a href="#l17.85"></a><span id="l17.85">                     this.mCalendars[aCalendar.id] = true;</span>
<a href="#l17.86"></a><span id="l17.86">                     this.mStatusBar.value = parseInt(this.mStatusBar.value, 10) + this.mCalendarStep;</span>
<a href="#l17.87"></a><span id="l17.87">                     this.mCurIndex++;</span>
<a href="#l17.88"></a><span id="l17.88">                     let curStatus = cal.l10n.getCalString(&quot;gettingCalendarInfoDetail&quot;,</span>
<a href="#l17.89"></a><span id="l17.89">                                                                [this.mCurIndex, this.mCalendarCount]);</span>
<a href="#l17.90"></a><span id="l17.90">                     this.showStatusString(curStatus);</span>
<a href="#l17.91"></a><span id="l17.91">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -163,17 +163,17 @@ function changeMenuForTask(aEvent) {</span>
<a href="#l18.4"></a><span id="l18.4">  */</span>
<a href="#l18.5"></a><span id="l18.5"> function contextChangeTaskProgress(aEvent, aProgress) {</span>
<a href="#l18.6"></a><span id="l18.6">     if (gTabmail &amp;&amp; gTabmail.currentTabInfo.mode.type == &quot;calendarTask&quot;) {</span>
<a href="#l18.7"></a><span id="l18.7">         editToDoStatus(aProgress);</span>
<a href="#l18.8"></a><span id="l18.8">     } else {</span>
<a href="#l18.9"></a><span id="l18.9">         startBatchTransaction();</span>
<a href="#l18.10"></a><span id="l18.10">         let tasks = getSelectedTasks(aEvent);</span>
<a href="#l18.11"></a><span id="l18.11">         for (let task of tasks) {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-            let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+            let newTask = task.clone().QueryInterface(Ci.calITodo);</span>
<a href="#l18.14"></a><span id="l18.14">             newTask.percentComplete = aProgress;</span>
<a href="#l18.15"></a><span id="l18.15">             switch (aProgress) {</span>
<a href="#l18.16"></a><span id="l18.16">                 case 0:</span>
<a href="#l18.17"></a><span id="l18.17">                     newTask.isCompleted = false;</span>
<a href="#l18.18"></a><span id="l18.18">                     break;</span>
<a href="#l18.19"></a><span id="l18.19">                 case 100:</span>
<a href="#l18.20"></a><span id="l18.20">                     newTask.isCompleted = true;</span>
<a href="#l18.21"></a><span id="l18.21">                     break;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -215,17 +215,17 @@ function contextChangeTaskCalendar(aEven</span>
<a href="#l18.23"></a><span id="l18.23"> function contextChangeTaskPriority(aEvent, aPriority) {</span>
<a href="#l18.24"></a><span id="l18.24">     let tabType = gTabmail &amp;&amp; gTabmail.currentTabInfo.mode.type;</span>
<a href="#l18.25"></a><span id="l18.25">     if (tabType == &quot;calendarTask&quot; || tabType == &quot;calendarEvent&quot;) {</span>
<a href="#l18.26"></a><span id="l18.26">         editConfigState({ priority: aPriority });</span>
<a href="#l18.27"></a><span id="l18.27">     } else {</span>
<a href="#l18.28"></a><span id="l18.28">         startBatchTransaction();</span>
<a href="#l18.29"></a><span id="l18.29">         let tasks = getSelectedTasks(aEvent);</span>
<a href="#l18.30"></a><span id="l18.30">         for (let task of tasks) {</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-            let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+            let newTask = task.clone().QueryInterface(Ci.calITodo);</span>
<a href="#l18.33"></a><span id="l18.33">             newTask.priority = aPriority;</span>
<a href="#l18.34"></a><span id="l18.34">             doTransaction(&quot;modify&quot;, newTask, newTask.calendar, task, null);</span>
<a href="#l18.35"></a><span id="l18.35">         }</span>
<a href="#l18.36"></a><span id="l18.36">         endBatchTransaction();</span>
<a href="#l18.37"></a><span id="l18.37">     }</span>
<a href="#l18.38"></a><span id="l18.38"> }</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -542,17 +542,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">                 // prevent toggling completed status for parent items of</span>
<a href="#l19.5"></a><span id="l19.5">                 // repeating tasks or when the calendar is read-only.</span>
<a href="#l19.6"></a><span id="l19.6">                 if (!task || task.recurrenceInfo || task.calendar.readOnly) {</span>
<a href="#l19.7"></a><span id="l19.7">                     return;</span>
<a href="#l19.8"></a><span id="l19.8">                 }</span>
<a href="#l19.9"></a><span id="l19.9">                 if (aCol != null) {</span>
<a href="#l19.10"></a><span id="l19.10">                     let content = aCol.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l19.11"></a><span id="l19.11">                     if (content == &quot;completed&quot;) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-                        let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+                        let newTask = task.clone().QueryInterface(Ci.calITodo);</span>
<a href="#l19.14"></a><span id="l19.14">                         newTask.isCompleted = !task.completedDate;</span>
<a href="#l19.15"></a><span id="l19.15">                         doTransaction(&quot;modify&quot;, newTask, newTask.calendar, task, null);</span>
<a href="#l19.16"></a><span id="l19.16">                     }</span>
<a href="#l19.17"></a><span id="l19.17">                 }</span>
<a href="#l19.18"></a><span id="l19.18">             },</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">             // Called on the view when a header is clicked.</span>
<a href="#l19.21"></a><span id="l19.21">             cycleHeader: function(aCol) {</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -779,18 +779,18 @@</span>
<a href="#l19.23"></a><span id="l19.23">                 if (!childElt.value) {</span>
<a href="#l19.24"></a><span id="l19.24">                     return false;</span>
<a href="#l19.25"></a><span id="l19.25">                 }</span>
<a href="#l19.26"></a><span id="l19.26">                 return aRow &amp;&amp; aRow.value &gt; -1 &amp;&amp; this.binding.mTaskArray[aRow.value];</span>
<a href="#l19.27"></a><span id="l19.27">             },</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29">             // Helper function to display datetimes</span>
<a href="#l19.30"></a><span id="l19.30">             _formatDateTime: function(aDateTime) {</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-                let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-                                              .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+                let dateFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+                                      .getService(Ci.calIDateTimeFormatter);</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36">                 // datetime is from todo object, it is not a javascript date</span>
<a href="#l19.37"></a><span id="l19.37">                 if (aDateTime &amp;&amp; aDateTime.isValid) {</span>
<a href="#l19.38"></a><span id="l19.38">                     let dateTime = aDateTime.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l19.39"></a><span id="l19.39">                     return dateFormatter.formatDateTime(dateTime);</span>
<a href="#l19.40"></a><span id="l19.40">                 }</span>
<a href="#l19.41"></a><span id="l19.41">                 return &quot;&quot;;</span>
<a href="#l19.42"></a><span id="l19.42">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/content/calendar-task-view.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-view.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -18,19 +18,18 @@ var taskDetailsView = {</span>
<a href="#l20.4"></a><span id="l20.4">      * its the only function in taskDetailsView.</span>
<a href="#l20.5"></a><span id="l20.5">      */</span>
<a href="#l20.6"></a><span id="l20.6">     onSelect: function(event) {</span>
<a href="#l20.7"></a><span id="l20.7">         function displayElement(id, flag) {</span>
<a href="#l20.8"></a><span id="l20.8">             setBooleanAttribute(id, &quot;hidden&quot;, !flag);</span>
<a href="#l20.9"></a><span id="l20.9">             return flag;</span>
<a href="#l20.10"></a><span id="l20.10">         }</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-        let dateFormatter =</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-            Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-            .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+        let dateFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+                              .getService(Ci.calIDateTimeFormatter);</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18">         let item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l20.19"></a><span id="l20.19">         if (displayElement(&quot;calendar-task-details-container&quot;, item != null) &amp;&amp;</span>
<a href="#l20.20"></a><span id="l20.20">             displayElement(&quot;calendar-task-view-splitter&quot;, item != null)) {</span>
<a href="#l20.21"></a><span id="l20.21">             displayElement(&quot;calendar-task-details-title-row&quot;, true);</span>
<a href="#l20.22"></a><span id="l20.22">             document.getElementById(&quot;calendar-task-details-title&quot;).textContent =</span>
<a href="#l20.23"></a><span id="l20.23">                 (item.title ? item.title.replace(/\n/g, &quot; &quot;) : &quot;&quot;);</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25" class="difflineat">@@ -406,15 +405,15 @@ function taskViewOnLoad() {</span>
<a href="#l20.26"></a><span id="l20.26"> /**</span>
<a href="#l20.27"></a><span id="l20.27">  * Copy the value of the given link node to the clipboard</span>
<a href="#l20.28"></a><span id="l20.28">  *</span>
<a href="#l20.29"></a><span id="l20.29">  * @param linkNode      The node containing the value to copy to the clipboard</span>
<a href="#l20.30"></a><span id="l20.30">  */</span>
<a href="#l20.31"></a><span id="l20.31"> function taskViewCopyLink(linkNode) {</span>
<a href="#l20.32"></a><span id="l20.32">     if (linkNode) {</span>
<a href="#l20.33"></a><span id="l20.33">         let linkAddress = linkNode.value;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-        let clipboard = Components.classes[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-                                  .getService(Components.interfaces.nsIClipboardHelper);</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+        let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+                          .getService(Ci.nsIClipboardHelper);</span>
<a href="#l20.38"></a><span id="l20.38">         clipboard.copyString(linkAddress);</span>
<a href="#l20.39"></a><span id="l20.39">     }</span>
<a href="#l20.40"></a><span id="l20.40"> }</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42"> window.addEventListener(&quot;load&quot;, taskViewOnLoad);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/content/calendar-view-core.xml</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/content/calendar-view-core.xml</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -359,17 +359,17 @@</span>
<a href="#l21.4"></a><span id="l21.4">               onMouseOverItem(event);</span>
<a href="#l21.5"></a><span id="l21.5">           }</span>
<a href="#l21.6"></a><span id="l21.6">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l21.7"></a><span id="l21.7">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l21.8"></a><span id="l21.8">           if (event.target.localName == &quot;calendar-event-box&quot;) {</span>
<a href="#l21.9"></a><span id="l21.9">               return;</span>
<a href="#l21.10"></a><span id="l21.10">           }</span>
<a href="#l21.11"></a><span id="l21.11">           let item = this.occurrence;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-          let isInvitation = item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; item.calendar.isInvitation(item);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+          let isInvitation = item.calendar instanceof Ci.calISchedulingSupport &amp;&amp; item.calendar.isInvitation(item);</span>
<a href="#l21.14"></a><span id="l21.14">           if (!cal.acl.isCalendarWritable(item.calendar) || !cal.acl.userCanModifyItem(item) || isInvitation) {</span>
<a href="#l21.15"></a><span id="l21.15">               return;</span>
<a href="#l21.16"></a><span id="l21.16">           }</span>
<a href="#l21.17"></a><span id="l21.17">           if (!this.selected) {</span>
<a href="#l21.18"></a><span id="l21.18">               this.select(event);</span>
<a href="#l21.19"></a><span id="l21.19">           }</span>
<a href="#l21.20"></a><span id="l21.20">           invokeEventDragSession(item, this);</span>
<a href="#l21.21"></a><span id="l21.21">       ]]&gt;&lt;/handler&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/content/calendar-views.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -348,34 +348,32 @@ function scheduleMidnightUpdate(aRefresh</span>
<a href="#l22.4"></a><span id="l22.4">         // Observer for wake after sleep/hibernate/standby to create new timers and refresh UI</span>
<a href="#l22.5"></a><span id="l22.5">         let wakeObserver = {</span>
<a href="#l22.6"></a><span id="l22.6">             observe: function(aSubject, aTopic, aData) {</span>
<a href="#l22.7"></a><span id="l22.7">                 if (aTopic == &quot;wake_notification&quot;) {</span>
<a href="#l22.8"></a><span id="l22.8">                     // postpone refresh for another couple of seconds to get netwerk ready:</span>
<a href="#l22.9"></a><span id="l22.9">                     if (this.mTimer) {</span>
<a href="#l22.10"></a><span id="l22.10">                         this.mTimer.cancel();</span>
<a href="#l22.11"></a><span id="l22.11">                     } else {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-                        this.mTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-                                                .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+                        this.mTimer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l22.15"></a><span id="l22.15">                     }</span>
<a href="#l22.16"></a><span id="l22.16">                     this.mTimer.initWithCallback(udCallback, 10 * 1000,</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-                                                 Components.interfaces.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+                                                 Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l22.19"></a><span id="l22.19">                 }</span>
<a href="#l22.20"></a><span id="l22.20">             }</span>
<a href="#l22.21"></a><span id="l22.21">         };</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23">         // Add observer</span>
<a href="#l22.24"></a><span id="l22.24">         Services.obs.addObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26">         // Remove observer on unload</span>
<a href="#l22.27"></a><span id="l22.27">         window.addEventListener(&quot;unload&quot;, () =&gt; {</span>
<a href="#l22.28"></a><span id="l22.28">             Services.obs.removeObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l22.29"></a><span id="l22.29">         });</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-        gMidnightTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-                                   .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+        gMidnightTimer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l22.33"></a><span id="l22.33">     }</span>
<a href="#l22.34"></a><span id="l22.34">     gMidnightTimer.initWithCallback(udCallback, msUntilTomorrow, gMidnightTimer.TYPE_ONE_SHOT);</span>
<a href="#l22.35"></a><span id="l22.35"> }</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37"> /**</span>
<a href="#l22.38"></a><span id="l22.38">  * Retuns a cached copy of the view stylesheet.</span>
<a href="#l22.39"></a><span id="l22.39">  *</span>
<a href="#l22.40"></a><span id="l22.40">  * @return      The view stylesheet object.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-alarm-dialog.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-alarm-dialog.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -12,18 +12,18 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> /**</span>
<a href="#l23.6"></a><span id="l23.6">  * Helper function to get the alarm service and cache it.</span>
<a href="#l23.7"></a><span id="l23.7">  *</span>
<a href="#l23.8"></a><span id="l23.8">  * @return The alarm service component</span>
<a href="#l23.9"></a><span id="l23.9">  */</span>
<a href="#l23.10"></a><span id="l23.10"> function getAlarmService() {</span>
<a href="#l23.11"></a><span id="l23.11">     if (!(&quot;mAlarmService&quot; in window)) {</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-        window.mAlarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-                                         .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+        window.mAlarmService = Cc[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+                                 .getService(Ci.calIAlarmService);</span>
<a href="#l23.16"></a><span id="l23.16">     }</span>
<a href="#l23.17"></a><span id="l23.17">     return window.mAlarmService;</span>
<a href="#l23.18"></a><span id="l23.18"> }</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20"> /**</span>
<a href="#l23.21"></a><span id="l23.21">  * Event handler for the 'snooze' event. Snoozes the given alarm by the given</span>
<a href="#l23.22"></a><span id="l23.22">  * number of minutes using the alarm service.</span>
<a href="#l23.23"></a><span id="l23.23">  *</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineat">@@ -212,17 +212,17 @@ function getDuration(aMinutes) {</span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26"> /**</span>
<a href="#l23.27"></a><span id="l23.27">  * Check whether the snooze period exceeds the current limitation of the AlarmService and prompt</span>
<a href="#l23.28"></a><span id="l23.28">  * the user with a message if so</span>
<a href="#l23.29"></a><span id="l23.29">  * @param   {calIDuration}   aDuration   The duration to snooze</span>
<a href="#l23.30"></a><span id="l23.30">  * @returns {Boolean}</span>
<a href="#l23.31"></a><span id="l23.31">  */</span>
<a href="#l23.32"></a><span id="l23.32"> function aboveSnoozeLimit(aDuration) {</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-    const LIMIT = Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+    const LIMIT = Ci.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l23.35"></a><span id="l23.35"> </span>
<a href="#l23.36"></a><span id="l23.36">     let currentTime = cal.dtz.now().getInTimezone(cal.dtz.UTC);</span>
<a href="#l23.37"></a><span id="l23.37">     let limitTime = currentTime.clone();</span>
<a href="#l23.38"></a><span id="l23.38">     limitTime.month += LIMIT;</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40">     let durationUntilLimit = limitTime.subtractDate(currentTime);</span>
<a href="#l23.41"></a><span id="l23.41">     if (aDuration.compare(durationUntilLimit) &gt; 0) {</span>
<a href="#l23.42"></a><span id="l23.42">         let msg = PluralForm.get(LIMIT, cal.l10n.getCalString(&quot;alarmSnoozeLimitExceeded&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-creation.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-creation.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -6,18 +6,18 @@</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> /**</span>
<a href="#l24.8"></a><span id="l24.8">  * Shows the filepicker and creates a new calendar with a local file using the ICS</span>
<a href="#l24.9"></a><span id="l24.9">  * provider.</span>
<a href="#l24.10"></a><span id="l24.10">  */</span>
<a href="#l24.11"></a><span id="l24.11"> function openLocalCalendar() {</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-    let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+    const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+    let picker = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l24.16"></a><span id="l24.16">     picker.init(window, cal.l10n.getCalString(&quot;Open&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l24.17"></a><span id="l24.17">     let wildmat = &quot;*.ics&quot;;</span>
<a href="#l24.18"></a><span id="l24.18">     let description = cal.l10n.getCalString(&quot;filterIcs&quot;, [wildmat]);</span>
<a href="#l24.19"></a><span id="l24.19">     picker.appendFilter(description, wildmat);</span>
<a href="#l24.20"></a><span id="l24.20">     picker.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22">     picker.open(rv =&gt; {</span>
<a href="#l24.23"></a><span id="l24.23">         if (rv != nsIFilePicker.returnOK || !picker.file) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -214,17 +214,17 @@ function updateReminderDetails() {</span>
<a href="#l25.4"></a><span id="l25.4"> }</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6"> var gLastAlarmSelection = 0;</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> function matchCustomReminderToMenuitem(reminder) {</span>
<a href="#l25.9"></a><span id="l25.9">     let defaultAlarmType = getDefaultAlarmType();</span>
<a href="#l25.10"></a><span id="l25.10">     let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l25.11"></a><span id="l25.11">     let reminderPopup = reminderList.firstChild;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-    if (reminder.related != Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE &amp;&amp;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+    if (reminder.related != Ci.calIAlarm.ALARM_RELATED_ABSOLUTE &amp;&amp;</span>
<a href="#l25.14"></a><span id="l25.14">         reminder.offset &amp;&amp;</span>
<a href="#l25.15"></a><span id="l25.15">         reminder.action == defaultAlarmType) {</span>
<a href="#l25.16"></a><span id="l25.16">         // Exactly one reminder thats not absolute, we may be able to match up</span>
<a href="#l25.17"></a><span id="l25.17">         // popup items.</span>
<a href="#l25.18"></a><span id="l25.18">         let relation = (reminder.related == reminder.ALARM_RELATED_START ? &quot;START&quot; : &quot;END&quot;);</span>
<a href="#l25.19"></a><span id="l25.19">         let origin;</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21">         // If the time duration for offset is 0, means the reminder is '0 minutes before'</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -532,17 +532,17 @@ function updateLink() {</span>
<a href="#l25.23"></a><span id="l25.23">         } catch (e) {</span>
<a href="#l25.24"></a><span id="l25.24">             // No protocol handler for the given protocol, or invalid uri</span>
<a href="#l25.25"></a><span id="l25.25">             hideOrShow(false);</span>
<a href="#l25.26"></a><span id="l25.26">             return;</span>
<a href="#l25.27"></a><span id="l25.27">         }</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29">         // Only show if its either an internal protcol handler, or its external</span>
<a href="#l25.30"></a><span id="l25.30">         // and there is an external app for the scheme</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-        handler = cal.wrapInstance(handler, Components.interfaces.nsIExternalProtocolHandler);</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+        handler = cal.wrapInstance(handler, Ci.nsIExternalProtocolHandler);</span>
<a href="#l25.33"></a><span id="l25.33">         hideOrShow(!handler || handler.externalAppExistsForScheme(uri.scheme));</span>
<a href="#l25.34"></a><span id="l25.34"> </span>
<a href="#l25.35"></a><span id="l25.35">         setTimeout(() =&gt; {</span>
<a href="#l25.36"></a><span id="l25.36">             // HACK the url-link doesn't crop when setting the value in onLoad</span>
<a href="#l25.37"></a><span id="l25.37">             setElementValue(&quot;url-link&quot;, itemUrlString);</span>
<a href="#l25.38"></a><span id="l25.38">             setElementValue(&quot;url-link&quot;, itemUrlString, &quot;href&quot;);</span>
<a href="#l25.39"></a><span id="l25.39">         }, 0);</span>
<a href="#l25.40"></a><span id="l25.40">     }</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineat">@@ -702,17 +702,17 @@ function determineAttendeesInRow() {</span>
<a href="#l25.42"></a><span id="l25.42">  *</span>
<a href="#l25.43"></a><span id="l25.43">  * @param {calIEvent|calIToDo} aItem      Item to apply the change on</span>
<a href="#l25.44"></a><span id="l25.44">  */</span>
<a href="#l25.45"></a><span id="l25.45"> function adaptScheduleAgent(aItem) {</span>
<a href="#l25.46"></a><span id="l25.46">     if (aItem.calendar &amp;&amp; aItem.calendar.type == &quot;caldav&quot; &amp;&amp;</span>
<a href="#l25.47"></a><span id="l25.47">         aItem.calendar.getProperty(&quot;capabilities.autoschedule.supported&quot;)) {</span>
<a href="#l25.48"></a><span id="l25.48">         let identity = aItem.calendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l25.49"></a><span id="l25.49">         let orgEmail = identity &amp;&amp;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-                       identity.QueryInterface(Components.interfaces.nsIMsgIdentity).email;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+                       identity.QueryInterface(Ci.nsIMsgIdentity).email;</span>
<a href="#l25.52"></a><span id="l25.52">         let organizerAction = aItem.organizer &amp;&amp; orgEmail &amp;&amp;</span>
<a href="#l25.53"></a><span id="l25.53">                               aItem.organizer.id == &quot;mailto:&quot; + orgEmail;</span>
<a href="#l25.54"></a><span id="l25.54">         if (aItem.calendar.getProperty(&quot;forceEmailScheduling&quot;)) {</span>
<a href="#l25.55"></a><span id="l25.55">             cal.LOG(&quot;Enforcing clientside email based scheduling.&quot;);</span>
<a href="#l25.56"></a><span id="l25.56">             // for attendees, we change schedule-agent only in case of an</span>
<a href="#l25.57"></a><span id="l25.57">             // organizer triggered action</span>
<a href="#l25.58"></a><span id="l25.58">             if (organizerAction) {</span>
<a href="#l25.59"></a><span id="l25.59">                 aItem.getAttendees({}).forEach((aAttendee) =&gt; {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-error-prompt.xul</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-error-prompt.xul</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -19,17 +19,17 @@</span>
<a href="#l26.4"></a><span id="l26.4">         onload=&quot;loadErrorPrompt()&quot;</span>
<a href="#l26.5"></a><span id="l26.5">         persist=&quot;screenX screenY&quot;</span>
<a href="#l26.6"></a><span id="l26.6">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l26.7"></a><span id="l26.7">         width=&quot;500&quot;</span>
<a href="#l26.8"></a><span id="l26.8">         xmlns:nc=&quot;http://home.netscape.com/NC-rdf#&quot;&gt;</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10">     &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l26.11"></a><span id="l26.11">         function loadErrorPrompt() {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-            var args = window.arguments[0].QueryInterface(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+            var args = window.arguments[0].QueryInterface(Ci.nsIDialogParamBlock);</span>
<a href="#l26.14"></a><span id="l26.14">             document.getElementById(&quot;general-text&quot;).value = args.GetString(0);</span>
<a href="#l26.15"></a><span id="l26.15">             document.getElementById(&quot;error-code&quot;).value = args.GetString(1);</span>
<a href="#l26.16"></a><span id="l26.16">             document.getElementById(&quot;error-description&quot;).value = args.GetString(2);</span>
<a href="#l26.17"></a><span id="l26.17">             this.sizeToContent();</span>
<a href="#l26.18"></a><span id="l26.18">         }</span>
<a href="#l26.19"></a><span id="l26.19">         function toggleDetails() {</span>
<a href="#l26.20"></a><span id="l26.20">             var grid = document.getElementById(&quot;details-grid&quot;);</span>
<a href="#l26.21"></a><span id="l26.21">             if (grid.collapsed)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -600,17 +600,17 @@ function onChangeCalendar(calendar) {</span>
<a href="#l27.4"></a><span id="l27.4">     // set 'mIsReadOnly' if the calendar is read-only</span>
<a href="#l27.5"></a><span id="l27.5">     if (calendar &amp;&amp; calendar.readOnly) {</span>
<a href="#l27.6"></a><span id="l27.6">         gIsReadOnly = true;</span>
<a href="#l27.7"></a><span id="l27.7">     }</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9">     // assume we're the organizer [in case that the calendar</span>
<a href="#l27.10"></a><span id="l27.10">     // does not support the concept of identities].</span>
<a href="#l27.11"></a><span id="l27.11">     gIsInvitation = false;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-    calendar = cal.wrapInstance(args.item.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+    calendar = cal.wrapInstance(args.item.calendar, Ci.calISchedulingSupport);</span>
<a href="#l27.14"></a><span id="l27.14">     if (calendar) {</span>
<a href="#l27.15"></a><span id="l27.15">         gIsInvitation = calendar.isInvitation(args.item);</span>
<a href="#l27.16"></a><span id="l27.16">     }</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18">     if (gIsReadOnly || gIsInvitation) {</span>
<a href="#l27.19"></a><span id="l27.19">         document.getElementById(&quot;next-slot&quot;)</span>
<a href="#l27.20"></a><span id="l27.20">             .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l27.21"></a><span id="l27.21">         document.getElementById(&quot;previous-slot&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -56,17 +56,17 @@</span>
<a href="#l28.4"></a><span id="l28.4">             this.mIsReadOnly = calendar.readOnly;</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6">             // assume we're the organizer [in case that the calendar</span>
<a href="#l28.7"></a><span id="l28.7">             // does not support the concept of identities].</span>
<a href="#l28.8"></a><span id="l28.8">             let organizerID = ((organizer &amp;&amp; organizer.id)</span>
<a href="#l28.9"></a><span id="l28.9">                                ? organizer.id</span>
<a href="#l28.10"></a><span id="l28.10">                                : calendar.getProperty(&quot;organizerId&quot;));</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-            calendar = cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+            calendar = cal.wrapInstance(calendar, Ci.calISchedulingSupport);</span>
<a href="#l28.14"></a><span id="l28.14">             this.mIsInvitation = (calendar &amp;&amp; calendar.isInvitation(args.item));</span>
<a href="#l28.15"></a><span id="l28.15"> </span>
<a href="#l28.16"></a><span id="l28.16">             let template = this.querySelector(&quot;.addressingWidgetItem&quot;);</span>
<a href="#l28.17"></a><span id="l28.17">             template.focus();</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19">             if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l28.20"></a><span id="l28.20">                 this.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.21"></a><span id="l28.21">             }</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -390,27 +390,27 @@</span>
<a href="#l28.23"></a><span id="l28.23">         &lt;parameter name=&quot;entryname&quot;/&gt;</span>
<a href="#l28.24"></a><span id="l28.24">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l28.25"></a><span id="l28.25">             let allAddressBooks = MailServices.ab.directories;</span>
<a href="#l28.26"></a><span id="l28.26"> </span>
<a href="#l28.27"></a><span id="l28.27">             while (allAddressBooks.hasMoreElements()) {</span>
<a href="#l28.28"></a><span id="l28.28">                 let abDir = null;</span>
<a href="#l28.29"></a><span id="l28.29">                 try {</span>
<a href="#l28.30"></a><span id="l28.30">                     abDir = allAddressBooks.getNext()</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-                                           .QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+                                           .QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l28.33"></a><span id="l28.33">                 } catch (ex) {</span>
<a href="#l28.34"></a><span id="l28.34">                     cal.WARN(&quot;[eventDialog] Error Encountered&quot; + ex);</span>
<a href="#l28.35"></a><span id="l28.35">                 }</span>
<a href="#l28.36"></a><span id="l28.36"> </span>
<a href="#l28.37"></a><span id="l28.37">                 if (abDir != null &amp;&amp; abDir.supportsMailingLists) {</span>
<a href="#l28.38"></a><span id="l28.38">                     let childNodes = abDir.childNodes;</span>
<a href="#l28.39"></a><span id="l28.39">                     while (childNodes.hasMoreElements()) {</span>
<a href="#l28.40"></a><span id="l28.40">                         let dir = null;</span>
<a href="#l28.41"></a><span id="l28.41">                         try {</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-                            dir = childNodes.getNext().QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+                            dir = childNodes.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l28.44"></a><span id="l28.44">                         } catch (ex) {</span>
<a href="#l28.45"></a><span id="l28.45">                             cal.WARN(&quot;[eventDialog] Error Encountered&quot; + ex);</span>
<a href="#l28.46"></a><span id="l28.46">                         }</span>
<a href="#l28.47"></a><span id="l28.47"> </span>
<a href="#l28.48"></a><span id="l28.48">                         if (dir &amp;&amp; dir.isMailList &amp;&amp; (dir.dirName == entryname)) {</span>
<a href="#l28.49"></a><span id="l28.49">                             return dir;</span>
<a href="#l28.50"></a><span id="l28.50">                         }</span>
<a href="#l28.51"></a><span id="l28.51">                     }</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineat">@@ -422,17 +422,17 @@</span>
<a href="#l28.53"></a><span id="l28.53"> </span>
<a href="#l28.54"></a><span id="l28.54">       &lt;method name=&quot;_getListEntriesInt&quot;&gt;</span>
<a href="#l28.55"></a><span id="l28.55">         &lt;parameter name=&quot;mailingList&quot;/&gt;</span>
<a href="#l28.56"></a><span id="l28.56">         &lt;parameter name=&quot;attendees&quot;/&gt;</span>
<a href="#l28.57"></a><span id="l28.57">         &lt;parameter name=&quot;allListsUri&quot;/&gt;</span>
<a href="#l28.58"></a><span id="l28.58">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l28.59"></a><span id="l28.59">             let addressLists = mailingList.addressLists;</span>
<a href="#l28.60"></a><span id="l28.60">             for (let i = 0; i &lt; addressLists.length; i++) {</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-                let abCard = addressLists.queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+                let abCard = addressLists.queryElementAt(i, Ci.nsIAbCard);</span>
<a href="#l28.63"></a><span id="l28.63">                 let thisId = abCard.primaryEmail;</span>
<a href="#l28.64"></a><span id="l28.64">                 if (abCard.displayName.length &gt; 0) {</span>
<a href="#l28.65"></a><span id="l28.65">                     let rCn = abCard.displayName;</span>
<a href="#l28.66"></a><span id="l28.66">                     if (rCn.includes(&quot;,&quot;)) {</span>
<a href="#l28.67"></a><span id="l28.67">                         rCn = '&quot;' + rCn + '&quot;';</span>
<a href="#l28.68"></a><span id="l28.68">                     }</span>
<a href="#l28.69"></a><span id="l28.69">                     thisId = rCn + &quot; &lt;&quot; + thisId + &quot;&gt;&quot;;</span>
<a href="#l28.70"></a><span id="l28.70">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -159,21 +159,18 @@</span>
<a href="#l29.4"></a><span id="l29.4">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l29.5"></a><span id="l29.5">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l29.6"></a><span id="l29.6">             let date = val.clone();</span>
<a href="#l29.7"></a><span id="l29.7">             date.hour = 0;</span>
<a href="#l29.8"></a><span id="l29.8">             date.minute = 0;</span>
<a href="#l29.9"></a><span id="l29.9">             date.isDate = false;</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11">             if (!this.mDateFormatter) {</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-                this.mDateFormatter =</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-                    Components.classes[</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-                        &quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-                            .getService(</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-                                Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+                this.mDateFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+                                        .getService(Ci.calIDateTimeFormatter);</span>
<a href="#l29.19"></a><span id="l29.19">             }</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21">             // First set the formatted date string as title</span>
<a href="#l29.22"></a><span id="l29.22">             let day =</span>
<a href="#l29.23"></a><span id="l29.23">                 document.getAnonymousElementByAttribute(</span>
<a href="#l29.24"></a><span id="l29.24">                     this, &quot;anonid&quot;, &quot;day&quot;);</span>
<a href="#l29.25"></a><span id="l29.25">             let dateValue = this.mZoomFactor &gt; 100 ? this.mDateFormatter.formatDateShort(date)</span>
<a href="#l29.26"></a><span id="l29.26">                                                    : this.mDateFormatter.formatDateLong(date);</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineat">@@ -620,24 +617,22 @@</span>
<a href="#l29.28"></a><span id="l29.28">           this.onLoad();</span>
<a href="#l29.29"></a><span id="l29.29">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l29.32"></a><span id="l29.32">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l29.33"></a><span id="l29.33">             let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l29.34"></a><span id="l29.34">             this.mState = new Array(this.mRange * numHours);</span>
<a href="#l29.35"></a><span id="l29.35">             for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-                this.mState[i] = Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+                this.mState[i] = Ci.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l29.38"></a><span id="l29.38">             }</span>
<a href="#l29.39"></a><span id="l29.39"> </span>
<a href="#l29.40"></a><span id="l29.40">             let step_in_minutes = Math.floor(60 * this.mZoomFactor / 100);</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-            let formatter = Components.classes[</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-                &quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-                    .getService(</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-                        Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+            let formatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+                              .getService(Ci.calIDateTimeFormatter);</span>
<a href="#l29.47"></a><span id="l29.47">             let date = cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l29.48"></a><span id="l29.48">             date.hour = this.mStartHour;</span>
<a href="#l29.49"></a><span id="l29.49">             date.minute = 0;</span>
<a href="#l29.50"></a><span id="l29.50">             let hours =</span>
<a href="#l29.51"></a><span id="l29.51">                 document.getAnonymousElementByAttribute(</span>
<a href="#l29.52"></a><span id="l29.52">                     this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l29.53"></a><span id="l29.53">             if (hours.childNodes.length &lt;= 0) {</span>
<a href="#l29.54"></a><span id="l29.54">                 let template = createXULElement(&quot;text&quot;);</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineat">@@ -695,17 +690,17 @@</span>
<a href="#l29.56"></a><span id="l29.56">                 start.second = 0;</span>
<a href="#l29.57"></a><span id="l29.57">                 start.timezone = kDefaultTimezone;</span>
<a href="#l29.58"></a><span id="l29.58">                 let end = start.clone();</span>
<a href="#l29.59"></a><span id="l29.59">                 end.day += this.mRange;</span>
<a href="#l29.60"></a><span id="l29.60">                 end.timezone = kDefaultTimezone;</span>
<a href="#l29.61"></a><span id="l29.61"> </span>
<a href="#l29.62"></a><span id="l29.62">                 // First of all set all state slots to 'free'</span>
<a href="#l29.63"></a><span id="l29.63">                 for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-                    this.mState[i] = Components.interfaces.calIFreeBusyInterval.FREE;</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+                    this.mState[i] = Ci.calIFreeBusyInterval.FREE;</span>
<a href="#l29.66"></a><span id="l29.66">                 }</span>
<a href="#l29.67"></a><span id="l29.67"> </span>
<a href="#l29.68"></a><span id="l29.68">                 // Iterate all incoming freebusy entries</span>
<a href="#l29.69"></a><span id="l29.69">                 for (let entry of aEntries) {</span>
<a href="#l29.70"></a><span id="l29.70">                     let rangeStart = entry.interval.start.getInTimezone(kDefaultTimezone);</span>
<a href="#l29.71"></a><span id="l29.71">                     let rangeEnd = entry.interval.end.getInTimezone(kDefaultTimezone);</span>
<a href="#l29.72"></a><span id="l29.72"> </span>
<a href="#l29.73"></a><span id="l29.73">                     if (rangeStart.compare(start) &lt; 0) {</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineat">@@ -790,42 +785,42 @@</span>
<a href="#l29.75"></a><span id="l29.75">                         for (let i = start_offset; i &lt;= end_offset; i++) {</span>
<a href="#l29.76"></a><span id="l29.76">                             this.mState[i] = entry.freeBusyType;</span>
<a href="#l29.77"></a><span id="l29.77">                         }</span>
<a href="#l29.78"></a><span id="l29.78">                     }</span>
<a href="#l29.79"></a><span id="l29.79">                 }</span>
<a href="#l29.80"></a><span id="l29.80">             } else {</span>
<a href="#l29.81"></a><span id="l29.81">                 // First of all set all state slots to 'unknown'</span>
<a href="#l29.82"></a><span id="l29.82">                 for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-                    this.mState[i] = Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+                    this.mState[i] = Ci.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l29.85"></a><span id="l29.85">                 }</span>
<a href="#l29.86"></a><span id="l29.86">             }</span>
<a href="#l29.87"></a><span id="l29.87"> </span>
<a href="#l29.88"></a><span id="l29.88">             this.showState();</span>
<a href="#l29.89"></a><span id="l29.89">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.90"></a><span id="l29.90">       &lt;/method&gt;</span>
<a href="#l29.91"></a><span id="l29.91"> </span>
<a href="#l29.92"></a><span id="l29.92">       &lt;method name=&quot;showState&quot;&gt;</span>
<a href="#l29.93"></a><span id="l29.93">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l29.94"></a><span id="l29.94">             let hours =</span>
<a href="#l29.95"></a><span id="l29.95">                 document.getAnonymousElementByAttribute(</span>
<a href="#l29.96"></a><span id="l29.96">                     this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l29.97"></a><span id="l29.97">             for (let i = 0; i &lt; hours.childNodes.length; i++) {</span>
<a href="#l29.98"></a><span id="l29.98">                 let hour = hours.childNodes[i];</span>
<a href="#l29.99"></a><span id="l29.99">                 switch (this.mState[i + this.mOffset]) {</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineminus">-                    case Components.interfaces.calIFreeBusyInterval.FREE:</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+                    case Ci.calIFreeBusyInterval.FREE:</span>
<a href="#l29.102"></a><span id="l29.102">                         hour.setAttribute(&quot;state&quot;, &quot;free&quot;);</span>
<a href="#l29.103"></a><span id="l29.103">                         break;</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-                    case Components.interfaces.calIFreeBusyInterval.BUSY:</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+                    case Ci.calIFreeBusyInterval.BUSY:</span>
<a href="#l29.106"></a><span id="l29.106">                         hour.setAttribute(&quot;state&quot;, &quot;busy&quot;);</span>
<a href="#l29.107"></a><span id="l29.107">                         break;</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-                    case Components.interfaces.calIFreeBusyInterval.BUSY_TENTATIVE:</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+                    case Ci.calIFreeBusyInterval.BUSY_TENTATIVE:</span>
<a href="#l29.110"></a><span id="l29.110">                         hour.setAttribute(&quot;state&quot;, &quot;busy_tentative&quot;);</span>
<a href="#l29.111"></a><span id="l29.111">                         break;</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineminus">-                    case Components.interfaces.calIFreeBusyInterval.BUSY_UNAVAILABLE:</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+                    case Ci.calIFreeBusyInterval.BUSY_UNAVAILABLE:</span>
<a href="#l29.114"></a><span id="l29.114">                         hour.setAttribute(&quot;state&quot;, &quot;busy_unavailable&quot;);</span>
<a href="#l29.115"></a><span id="l29.115">                         break;</span>
<a href="#l29.116"></a><span id="l29.116">                     default:</span>
<a href="#l29.117"></a><span id="l29.117">                         hour.removeAttribute(&quot;state&quot;);</span>
<a href="#l29.118"></a><span id="l29.118">                 }</span>
<a href="#l29.119"></a><span id="l29.119">             }</span>
<a href="#l29.120"></a><span id="l29.120">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.121"></a><span id="l29.121">       &lt;/method&gt;</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineat">@@ -1150,23 +1145,23 @@</span>
<a href="#l29.123"></a><span id="l29.123">                         end.day += this.mRange;</span>
<a href="#l29.124"></a><span id="l29.124">                         // Update with 'no data available' until response will be received</span>
<a href="#l29.125"></a><span id="l29.125">                         freebusy.onFreeBusy(null);</span>
<a href="#l29.126"></a><span id="l29.126">                         try {</span>
<a href="#l29.127"></a><span id="l29.127">                             let listener = new calFreeBusyListener(freebusy, this);</span>
<a href="#l29.128"></a><span id="l29.128">                             let request = fbService.getFreeBusyIntervals(calid,</span>
<a href="#l29.129"></a><span id="l29.129">                                                                          start,</span>
<a href="#l29.130"></a><span id="l29.130">                                                                          end,</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineminus">-                                                                         Components.interfaces.calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineplus">+                                                                         Ci.calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l29.133"></a><span id="l29.133">                                                                          listener);</span>
<a href="#l29.134"></a><span id="l29.134">                             if (request &amp;&amp; request.isPending) {</span>
<a href="#l29.135"></a><span id="l29.135">                                 this.mPendingRequests.push(request);</span>
<a href="#l29.136"></a><span id="l29.136">                             }</span>
<a href="#l29.137"></a><span id="l29.137">                         } catch (ex) {</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineminus">-                            Components.utils.reportError(ex);</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineplus">+                            Cu.reportError(ex);</span>
<a href="#l29.140"></a><span id="l29.140">                         }</span>
<a href="#l29.141"></a><span id="l29.141">                     }</span>
<a href="#l29.142"></a><span id="l29.142">                 }</span>
<a href="#l29.143"></a><span id="l29.143">             }</span>
<a href="#l29.144"></a><span id="l29.144">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.145"></a><span id="l29.145">       &lt;/method&gt;</span>
<a href="#l29.146"></a><span id="l29.146"> </span>
<a href="#l29.147"></a><span id="l29.147">       &lt;method name=&quot;nextSlot&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -44,20 +44,20 @@ function onLoad() {</span>
<a href="#l30.4"></a><span id="l30.4">     if (recinfo) {</span>
<a href="#l30.5"></a><span id="l30.5">         // Split out rules and exceptions</span>
<a href="#l30.6"></a><span id="l30.6">         try {</span>
<a href="#l30.7"></a><span id="l30.7">             let rrules = splitRecurrenceRules(recinfo);</span>
<a href="#l30.8"></a><span id="l30.8">             let rules = rrules[0];</span>
<a href="#l30.9"></a><span id="l30.9">             // Deal with the rules</span>
<a href="#l30.10"></a><span id="l30.10">             if (rules.length &gt; 0) {</span>
<a href="#l30.11"></a><span id="l30.11">                 // We only handle 1 rule currently</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-                rule = cal.wrapInstance(rules[0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+                rule = cal.wrapInstance(rules[0], Ci.calIRecurrenceRule);</span>
<a href="#l30.14"></a><span id="l30.14">             }</span>
<a href="#l30.15"></a><span id="l30.15">         } catch (ex) {</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-            Components.utils.reportError(ex);</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+            Cu.reportError(ex);</span>
<a href="#l30.18"></a><span id="l30.18">         }</span>
<a href="#l30.19"></a><span id="l30.19">     }</span>
<a href="#l30.20"></a><span id="l30.20">     if (!rule) {</span>
<a href="#l30.21"></a><span id="l30.21">         rule = cal.createRecurrenceRule();</span>
<a href="#l30.22"></a><span id="l30.22">         rule.type = &quot;DAILY&quot;;</span>
<a href="#l30.23"></a><span id="l30.23">         rule.interval = 1;</span>
<a href="#l30.24"></a><span id="l30.24">         rule.count = -1;</span>
<a href="#l30.25"></a><span id="l30.25">     }</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineat">@@ -737,17 +737,17 @@ function changeOrderForElements(aPropKey</span>
<a href="#l30.27"></a><span id="l30.27">     }</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29">     try {</span>
<a href="#l30.30"></a><span id="l30.30">         localeOrder = cal.l10n.getString(&quot;calendar-event-dialog&quot;, aPropKey, aPropParams).split(&quot; &quot;);</span>
<a href="#l30.31"></a><span id="l30.31">     } catch (ex) {</span>
<a href="#l30.32"></a><span id="l30.32">         let msg = &quot;The key &quot; + aPropKey + &quot; in calendar-event-dialog.prop&quot; +</span>
<a href="#l30.33"></a><span id="l30.33">                   &quot;erties has incorrect number of params. Expected &quot; +</span>
<a href="#l30.34"></a><span id="l30.34">                   aPropParams.length + &quot; params.&quot;;</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-        Components.utils.reportError(msg + &quot; &quot; + ex);</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+        Cu.reportError(msg + &quot; &quot; + ex);</span>
<a href="#l30.37"></a><span id="l30.37">         return;</span>
<a href="#l30.38"></a><span id="l30.38">     }</span>
<a href="#l30.39"></a><span id="l30.39"> </span>
<a href="#l30.40"></a><span id="l30.40">     // Add elements in the right order, removing them from their old parent</span>
<a href="#l30.41"></a><span id="l30.41">     for (let i = 0; i &lt; aPropParams.length; i++) {</span>
<a href="#l30.42"></a><span id="l30.42">         let newEl = document.getElementById(localeOrder[i]);</span>
<a href="#l30.43"></a><span id="l30.43">         if (newEl) {</span>
<a href="#l30.44"></a><span id="l30.44">             parents[i].appendChild(newEl);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -258,17 +258,17 @@ function onReminderSelected() {</span>
<a href="#l31.4"></a><span id="l31.4">         try {</span>
<a href="#l31.5"></a><span id="l31.5">             suppressListUpdate = true;</span>
<a href="#l31.6"></a><span id="l31.6">             let reminder = listitem.reminder;</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8">             // Action</span>
<a href="#l31.9"></a><span id="l31.9">             actionType.value = reminder.action;</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11">             // Absolute/relative things</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-            if (reminder.related == Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+            if (reminder.related == Ci.calIAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l31.14"></a><span id="l31.14">                 relationType.value = &quot;absolute&quot;;</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16">                 // Date</span>
<a href="#l31.17"></a><span id="l31.17">                 absDate.value = cal.dtz.dateTimeToJsDate(reminder.alarmDate || cal.dtz.getDefaultStartDate());</span>
<a href="#l31.18"></a><span id="l31.18">             } else {</span>
<a href="#l31.19"></a><span id="l31.19">                 relationType.value = &quot;relative&quot;;</span>
<a href="#l31.20"></a><span id="l31.20"> </span>
<a href="#l31.21"></a><span id="l31.21">                 // Unit and length</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -284,19 +284,19 @@ function onReminderSelected() {</span>
<a href="#l31.23"></a><span id="l31.23">                     length.value = alarmlen;</span>
<a href="#l31.24"></a><span id="l31.24">                 }</span>
<a href="#l31.25"></a><span id="l31.25"> </span>
<a href="#l31.26"></a><span id="l31.26">                 // Relation</span>
<a href="#l31.27"></a><span id="l31.27">                 let relation = (reminder.offset.isNegative ? &quot;before&quot; : &quot;after&quot;);</span>
<a href="#l31.28"></a><span id="l31.28"> </span>
<a href="#l31.29"></a><span id="l31.29">                 // Origin</span>
<a href="#l31.30"></a><span id="l31.30">                 let origin;</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-                if (reminder.related == Components.interfaces.calIAlarm.ALARM_RELATED_START) {</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+                if (reminder.related == Ci.calIAlarm.ALARM_RELATED_START) {</span>
<a href="#l31.33"></a><span id="l31.33">                     origin = &quot;START&quot;;</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-                } else if (reminder.related == Components.interfaces.calIAlarm.ALARM_RELATED_END) {</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+                } else if (reminder.related == Ci.calIAlarm.ALARM_RELATED_END) {</span>
<a href="#l31.36"></a><span id="l31.36">                     origin = &quot;END&quot;;</span>
<a href="#l31.37"></a><span id="l31.37">                 }</span>
<a href="#l31.38"></a><span id="l31.38"> </span>
<a href="#l31.39"></a><span id="l31.39">                 relationOrigin.value = [relation, origin].join(&quot;-&quot;);</span>
<a href="#l31.40"></a><span id="l31.40">             }</span>
<a href="#l31.41"></a><span id="l31.41">         } finally {</span>
<a href="#l31.42"></a><span id="l31.42">             suppressListUpdate = false;</span>
<a href="#l31.43"></a><span id="l31.43">         }</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineat">@@ -338,29 +338,29 @@ function updateReminder(event) {</span>
<a href="#l31.45"></a><span id="l31.45">     let absDate = document.getElementById(&quot;reminder-absolute-date&quot;);</span>
<a href="#l31.46"></a><span id="l31.46">     let action = document.getElementById(&quot;reminder-actions-menulist&quot;).selectedItem.value;</span>
<a href="#l31.47"></a><span id="l31.47"> </span>
<a href="#l31.48"></a><span id="l31.48">     // Action</span>
<a href="#l31.49"></a><span id="l31.49">     reminder.action = action;</span>
<a href="#l31.50"></a><span id="l31.50"> </span>
<a href="#l31.51"></a><span id="l31.51">     if (relationItem.value == &quot;relative&quot;) {</span>
<a href="#l31.52"></a><span id="l31.52">         if (origin == &quot;START&quot;) {</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-            reminder.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+            reminder.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l31.55"></a><span id="l31.55">         } else if (origin == &quot;END&quot;) {</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-            reminder.related = Components.interfaces.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+            reminder.related = Ci.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l31.58"></a><span id="l31.58">         }</span>
<a href="#l31.59"></a><span id="l31.59"> </span>
<a href="#l31.60"></a><span id="l31.60">         // Set up offset, taking units and before/after into account</span>
<a href="#l31.61"></a><span id="l31.61">         let offset = cal.createDuration();</span>
<a href="#l31.62"></a><span id="l31.62">         offset[unit.value] = length.value;</span>
<a href="#l31.63"></a><span id="l31.63">         offset.normalize();</span>
<a href="#l31.64"></a><span id="l31.64">         offset.isNegative = (relation == &quot;before&quot;);</span>
<a href="#l31.65"></a><span id="l31.65">         reminder.offset = offset;</span>
<a href="#l31.66"></a><span id="l31.66">     } else if (relationItem.value == &quot;absolute&quot;) {</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-        reminder.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+        reminder.related = Ci.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l31.69"></a><span id="l31.69"> </span>
<a href="#l31.70"></a><span id="l31.70">         if (absDate.value) {</span>
<a href="#l31.71"></a><span id="l31.71">             reminder.alarmDate = cal.dtz.jsDateToDateTime(absDate.value,</span>
<a href="#l31.72"></a><span id="l31.72">                                                       window.arguments[0].timezone);</span>
<a href="#l31.73"></a><span id="l31.73">         } else {</span>
<a href="#l31.74"></a><span id="l31.74">             reminder.alarmDate = null;</span>
<a href="#l31.75"></a><span id="l31.75">         }</span>
<a href="#l31.76"></a><span id="l31.76">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -201,17 +201,17 @@</span>
<a href="#l32.4"></a><span id="l32.4">             return (att ? att.participationStatus : null);</span>
<a href="#l32.5"></a><span id="l32.5">         ]]&gt;&lt;/body&gt;</span>
<a href="#l32.6"></a><span id="l32.6">       &lt;/method&gt;</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8">       &lt;method name=&quot;setCalendarItemParticipationStatus&quot;&gt;</span>
<a href="#l32.9"></a><span id="l32.9">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l32.10"></a><span id="l32.10">         &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l32.11"></a><span id="l32.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-            let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+            let calendar = cal.wrapInstance(aItem.calendar, Ci.calISchedulingSupport);</span>
<a href="#l32.14"></a><span id="l32.14">             if (calendar) {</span>
<a href="#l32.15"></a><span id="l32.15">                 let att = calendar.getInvitedAttendee(aItem);</span>
<a href="#l32.16"></a><span id="l32.16">                 if (att) {</span>
<a href="#l32.17"></a><span id="l32.17">                     let att_ = att.clone();</span>
<a href="#l32.18"></a><span id="l32.18">                     att_.participationStatus = aStatus;</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20">                     // Update attendee</span>
<a href="#l32.21"></a><span id="l32.21">                     aItem.removeAttendee(att);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -258,17 +258,17 @@ var gDataMigrator = {</span>
<a href="#l33.4"></a><span id="l33.4">             migLOG(&quot;nodes: &quot; + nodes.length);</span>
<a href="#l33.5"></a><span id="l33.5">             for (let i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l33.6"></a><span id="l33.6">                 migLOG(&quot;Beginning calendar node&quot;);</span>
<a href="#l33.7"></a><span id="l33.7">                 let calendar;</span>
<a href="#l33.8"></a><span id="l33.8">                 let node = nodes[i];</span>
<a href="#l33.9"></a><span id="l33.9">                 if (getRDFAttr(node, &quot;remote&quot;) == &quot;false&quot;) {</span>
<a href="#l33.10"></a><span id="l33.10">                     migLOG(&quot;not remote&quot;);</span>
<a href="#l33.11"></a><span id="l33.11">                     let localFile = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-                                    .createInstance(Ci.nsIFile);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+                                      .createInstance(Ci.nsIFile);</span>
<a href="#l33.14"></a><span id="l33.14">                     localFile.initWithPath(getRDFAttr(node, &quot;path&quot;));</span>
<a href="#l33.15"></a><span id="l33.15">                     calendar = gDataMigrator.importICSToStorage(localFile);</span>
<a href="#l33.16"></a><span id="l33.16">                 } else {</span>
<a href="#l33.17"></a><span id="l33.17">                     // Remote subscription</span>
<a href="#l33.18"></a><span id="l33.18">                     // XXX check for duplicates</span>
<a href="#l33.19"></a><span id="l33.19">                     let url = Services.io.newURI(getRDFAttr(node, &quot;remotePath&quot;));</span>
<a href="#l33.20"></a><span id="l33.20">                     calendar = calManager.createCalendar(&quot;ics&quot;, url);</span>
<a href="#l33.21"></a><span id="l33.21">                 }</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -343,21 +343,21 @@ var gDataMigrator = {</span>
<a href="#l33.23"></a><span id="l33.23">                 let dataDir = dirs.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l33.24"></a><span id="l33.24">                 let dataStore = dataDir.clone();</span>
<a href="#l33.25"></a><span id="l33.25">                 dataStore.append(&quot;corestorage.ics&quot;);</span>
<a href="#l33.26"></a><span id="l33.26">                 if (!dataStore.exists()) {</span>
<a href="#l33.27"></a><span id="l33.27">                     continue;</span>
<a href="#l33.28"></a><span id="l33.28">                 }</span>
<a href="#l33.29"></a><span id="l33.29"> </span>
<a href="#l33.30"></a><span id="l33.30">                 let fileStream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-                                 .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+                                   .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l33.33"></a><span id="l33.33"> </span>
<a href="#l33.34"></a><span id="l33.34">                 fileStream.init(dataStore, 0x01, parseInt(&quot;0444&quot;, 8), {});</span>
<a href="#l33.35"></a><span id="l33.35">                 let convIStream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-                                  .getService(Ci.nsIConverterInputStream);</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+                                    .getService(Ci.nsIConverterInputStream);</span>
<a href="#l33.38"></a><span id="l33.38">                 convIStream.init(fileStream, &quot;UTF-8&quot;, 0, 0x0000);</span>
<a href="#l33.39"></a><span id="l33.39">                 let tmpStr = {};</span>
<a href="#l33.40"></a><span id="l33.40">                 let str = &quot;&quot;;</span>
<a href="#l33.41"></a><span id="l33.41">                 while (convIStream.readString(-1, tmpStr)) {</span>
<a href="#l33.42"></a><span id="l33.42">                     str += tmpStr.value;</span>
<a href="#l33.43"></a><span id="l33.43">                 }</span>
<a href="#l33.44"></a><span id="l33.44"> </span>
<a href="#l33.45"></a><span id="l33.45">                 // Strip out the timezone definitions, since it makes the file</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineat">@@ -374,20 +374,20 @@ var gDataMigrator = {</span>
<a href="#l33.47"></a><span id="l33.47">                     index = str.indexOf(&quot;;TZID=&quot;);</span>
<a href="#l33.48"></a><span id="l33.48">                 }</span>
<a href="#l33.49"></a><span id="l33.49">                 let tempFile = gDataMigrator.dirService.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l33.50"></a><span id="l33.50">                 tempFile.append(&quot;icalTemp.ics&quot;);</span>
<a href="#l33.51"></a><span id="l33.51">                 tempFile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l33.52"></a><span id="l33.52">                                       parseInt(&quot;0600&quot;, 8));</span>
<a href="#l33.53"></a><span id="l33.53"> </span>
<a href="#l33.54"></a><span id="l33.54">                 let stream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-                             .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+                               .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l33.57"></a><span id="l33.57">                 stream.init(tempFile, 0x2A, parseInt(&quot;0600&quot;, 8), 0);</span>
<a href="#l33.58"></a><span id="l33.58">                 let convOStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-                                 .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+                                    .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l33.61"></a><span id="l33.61">                 convOStream.init(stream, &quot;UTF-8&quot;);</span>
<a href="#l33.62"></a><span id="l33.62">                 convOStream.writeString(str);</span>
<a href="#l33.63"></a><span id="l33.63"> </span>
<a href="#l33.64"></a><span id="l33.64">                 let calendar = gDataMigrator.importICSToStorage(tempFile);</span>
<a href="#l33.65"></a><span id="l33.65">                 calendar.name = &quot;iCalendar&quot;+i;</span>
<a href="#l33.66"></a><span id="l33.66">                 i++;</span>
<a href="#l33.67"></a><span id="l33.67">                 calManager.registerCalendar(calendar);</span>
<a href="#l33.68"></a><span id="l33.68">                 cal.view.getCompositeCalendar(window).addCalendar(calendar);</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineat">@@ -530,20 +530,20 @@ var gDataMigrator = {</span>
<a href="#l33.70"></a><span id="l33.70">      */</span>
<a href="#l33.71"></a><span id="l33.71">     importICSToStorage: function(icsFile) {</span>
<a href="#l33.72"></a><span id="l33.72">         const uri = &quot;moz-storage-calendar://&quot;;</span>
<a href="#l33.73"></a><span id="l33.73">         let calendar = cal.getCalendarManager().createCalendar(</span>
<a href="#l33.74"></a><span id="l33.74">             &quot;storage&quot;,</span>
<a href="#l33.75"></a><span id="l33.75">             Services.io.newURI(uri)</span>
<a href="#l33.76"></a><span id="l33.76">         );</span>
<a href="#l33.77"></a><span id="l33.77">         let icsImporter = Cc[&quot;@mozilla.org/calendar/import;1?type=ics&quot;]</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-                          .getService(Ci.calIImporter);</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+                            .getService(Ci.calIImporter);</span>
<a href="#l33.80"></a><span id="l33.80"> </span>
<a href="#l33.81"></a><span id="l33.81">         let inputStream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineminus">-                          .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+                            .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l33.84"></a><span id="l33.84">         let items = [];</span>
<a href="#l33.85"></a><span id="l33.85"> </span>
<a href="#l33.86"></a><span id="l33.86">         calendar.id = cal.getUUID();</span>
<a href="#l33.87"></a><span id="l33.87"> </span>
<a href="#l33.88"></a><span id="l33.88">         try {</span>
<a href="#l33.89"></a><span id="l33.89">             inputStream.init(icsFile, MODE_RDONLY, parseInt(&quot;0444&quot;, 8), {});</span>
<a href="#l33.90"></a><span id="l33.90">             items = icsImporter.importFromStream(inputStream, {});</span>
<a href="#l33.91"></a><span id="l33.91">         } catch (ex) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -37,18 +37,17 @@ function loadCalendarPrintDialog() {</span>
<a href="#l34.4"></a><span id="l34.4">     document.getElementById(theView ? &quot;printCurrentViewRadio&quot; : &quot;custom-range&quot;)</span>
<a href="#l34.5"></a><span id="l34.5">             .setAttribute(&quot;selected&quot;, true);</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7">     // Get a list of formatters.</span>
<a href="#l34.8"></a><span id="l34.8">     // Walk the list, adding items to the layout menupopup.</span>
<a href="#l34.9"></a><span id="l34.9">     let layoutList = document.getElementById(&quot;layout-field&quot;);</span>
<a href="#l34.10"></a><span id="l34.10">     for (let { data } of Services.catMan.enumerateCategory(&quot;cal-print-formatters&quot;)) {</span>
<a href="#l34.11"></a><span id="l34.11">         let contractid = Services.catMan.getCategoryEntry(&quot;cal-print-formatters&quot;, data);</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-        let formatter = Components.classes[contractid]</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-                                  .getService(Components.interfaces.calIPrintFormatter);</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+        let formatter = Cc[contractid].getService(Ci.calIPrintFormatter);</span>
<a href="#l34.15"></a><span id="l34.15">         // Use the contractid as value</span>
<a href="#l34.16"></a><span id="l34.16">         layoutList.appendItem(formatter.name, contractid);</span>
<a href="#l34.17"></a><span id="l34.17">     }</span>
<a href="#l34.18"></a><span id="l34.18">     layoutList.selectedIndex = 0;</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l34.21"></a><span id="l34.21"> </span>
<a href="#l34.22"></a><span id="l34.22">     eventsAndTasksOptions(&quot;tasks&quot;);</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineat">@@ -170,27 +169,27 @@ function getPrintSettings(receiverFunc) </span>
<a href="#l34.24"></a><span id="l34.24">  * Sets up the filter for a getItems call based on the javascript settings</span>
<a href="#l34.25"></a><span id="l34.25">  * object</span>
<a href="#l34.26"></a><span id="l34.26">  *</span>
<a href="#l34.27"></a><span id="l34.27">  * @param settings      The settings data to base upon</span>
<a href="#l34.28"></a><span id="l34.28">  */</span>
<a href="#l34.29"></a><span id="l34.29"> function getFilter(settings) {</span>
<a href="#l34.30"></a><span id="l34.30">     let filter = 0;</span>
<a href="#l34.31"></a><span id="l34.31">     if (settings.printTasks) {</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-        filter |= Components.interfaces.calICalendar.ITEM_FILTER_TYPE_TODO;</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+        filter |= Ci.calICalendar.ITEM_FILTER_TYPE_TODO;</span>
<a href="#l34.34"></a><span id="l34.34">         if (settings.printCompletedTasks) {</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-            filter |= Components.interfaces.calICalendar.ITEM_FILTER_COMPLETED_ALL;</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+            filter |= Ci.calICalendar.ITEM_FILTER_COMPLETED_ALL;</span>
<a href="#l34.37"></a><span id="l34.37">         } else {</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-            filter |= Components.interfaces.calICalendar.ITEM_FILTER_COMPLETED_NO;</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+            filter |= Ci.calICalendar.ITEM_FILTER_COMPLETED_NO;</span>
<a href="#l34.40"></a><span id="l34.40">         }</span>
<a href="#l34.41"></a><span id="l34.41">     }</span>
<a href="#l34.42"></a><span id="l34.42"> </span>
<a href="#l34.43"></a><span id="l34.43">     if (settings.printEvents) {</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-        filter |= Components.interfaces.calICalendar.ITEM_FILTER_TYPE_EVENT |</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-                  Components.interfaces.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+        filter |= Ci.calICalendar.ITEM_FILTER_TYPE_EVENT |</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+                  Ci.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l34.48"></a><span id="l34.48">     }</span>
<a href="#l34.49"></a><span id="l34.49">     return filter;</span>
<a href="#l34.50"></a><span id="l34.50"> }</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52"> /**</span>
<a href="#l34.53"></a><span id="l34.53">  * Looks at the selections the user has made (start date, layout, etc.), and</span>
<a href="#l34.54"></a><span id="l34.54">  * updates the HTML in the iframe accordingly. This is also called when a</span>
<a href="#l34.55"></a><span id="l34.55">  * dialog UI element has changed, since we'll want to refresh the preview.</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineat">@@ -221,17 +220,17 @@ function refreshHtml(finishFunc) {</span>
<a href="#l34.57"></a><span id="l34.57">                 let portion = {};</span>
<a href="#l34.58"></a><span id="l34.58">                 while (convStream.readString(-1, portion)) {</span>
<a href="#l34.59"></a><span id="l34.59">                     printContent += portion.value;</span>
<a href="#l34.60"></a><span id="l34.60">                 }</span>
<a href="#l34.61"></a><span id="l34.61">             } finally {</span>
<a href="#l34.62"></a><span id="l34.62">                 convStream.close();</span>
<a href="#l34.63"></a><span id="l34.63">             }</span>
<a href="#l34.64"></a><span id="l34.64">         } catch (e) {</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-            Components.utils.reportError(&quot;Calendar print dialog:refreshHtml: &quot; + e);</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+            Cu.reportError(&quot;Calendar print dialog:refreshHtml: &quot; + e);</span>
<a href="#l34.67"></a><span id="l34.67">         }</span>
<a href="#l34.68"></a><span id="l34.68"> </span>
<a href="#l34.69"></a><span id="l34.69">         printContent = &quot;data:text/html,&quot; + encodeURIComponent(printContent);</span>
<a href="#l34.70"></a><span id="l34.70">         document.getElementById(&quot;content&quot;).src = printContent;</span>
<a href="#l34.71"></a><span id="l34.71"> </span>
<a href="#l34.72"></a><span id="l34.72">         if (finishFunc) {</span>
<a href="#l34.73"></a><span id="l34.73">             finishFunc();</span>
<a href="#l34.74"></a><span id="l34.74">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l35.4"></a><span id="l35.4"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l35.5"></a><span id="l35.5"> </span>
<a href="#l35.6"></a><span id="l35.6"> /**</span>
<a href="#l35.7"></a><span id="l35.7">  * Cancels any pending search operations.</span>
<a href="#l35.8"></a><span id="l35.8">  */</span>
<a href="#l35.9"></a><span id="l35.9"> var gCurrentSearchOperation = null;</span>
<a href="#l35.10"></a><span id="l35.10"> function cancelPendingSearchOperation() {</span>
<a href="#l35.11"></a><span id="l35.11">     if (gCurrentSearchOperation &amp;&amp; gCurrentSearchOperation.isPending) {</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-        gCurrentSearchOperation.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+        gCurrentSearchOperation.cancel(Ci.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l35.14"></a><span id="l35.14">     }</span>
<a href="#l35.15"></a><span id="l35.15">     gCurrentSearchOperation = null;</span>
<a href="#l35.16"></a><span id="l35.16"> }</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18"> /**</span>
<a href="#l35.19"></a><span id="l35.19">  * Sets up the subscriptions dialog.</span>
<a href="#l35.20"></a><span id="l35.20">  */</span>
<a href="#l35.21"></a><span id="l35.21"> function onLoad() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -475,13 +475,13 @@ function openAttachment(aAttachmentId) {</span>
<a href="#l36.4"></a><span id="l36.4">     if (!aAttachmentId) {</span>
<a href="#l36.5"></a><span id="l36.5">         return;</span>
<a href="#l36.6"></a><span id="l36.6">     }</span>
<a href="#l36.7"></a><span id="l36.7">     let args = window.arguments[0];</span>
<a href="#l36.8"></a><span id="l36.8">     let item = args.calendarEvent;</span>
<a href="#l36.9"></a><span id="l36.9">     let attachments = item.getAttachments({})</span>
<a href="#l36.10"></a><span id="l36.10">                           .filter(aAttachment =&gt; aAttachment.hashId == aAttachmentId);</span>
<a href="#l36.11"></a><span id="l36.11">     if (attachments.length &amp;&amp; attachments[0].uri &amp;&amp; attachments[0].uri.spec != &quot;about:blank&quot;) {</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-        let externalLoader = Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-                             .getService(Ci.nsIExternalProtocolService);</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-        externalLoader.loadURI(attachments[0].uri);</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+        Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+          .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+          .loadURI(attachments[0].uri);</span>
<a href="#l36.18"></a><span id="l36.18">     }</span>
<a href="#l36.19"></a><span id="l36.19"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/base/content/dialogs/chooseCalendarDialog.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/base/content/dialogs/chooseCalendarDialog.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -1,18 +1,18 @@</span>
<a href="#l37.4"></a><span id="l37.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.5"></a><span id="l37.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.6"></a><span id="l37.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> /* exported loadCalendars, doOK, doExtra1 */</span>
<a href="#l37.9"></a><span id="l37.9"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l37.10"></a><span id="l37.10"> </span>
<a href="#l37.11"></a><span id="l37.11"> function loadCalendars() {</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-    const calendarManager = Components.classes[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-                                    .getService(Components.interfaces.calICalendarManager);</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+    const calendarManager = Cc[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+                              .getService(Ci.calICalendarManager);</span>
<a href="#l37.16"></a><span id="l37.16">     let listbox = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l37.17"></a><span id="l37.17">     let composite = cal.view.getCompositeCalendar(window.opener);</span>
<a href="#l37.18"></a><span id="l37.18">     let selectedIndex = 0;</span>
<a href="#l37.19"></a><span id="l37.19">     let calendars;</span>
<a href="#l37.20"></a><span id="l37.20"> </span>
<a href="#l37.21"></a><span id="l37.21">     if (window.arguments[0].calendars) {</span>
<a href="#l37.22"></a><span id="l37.22">         calendars = window.arguments[0].calendars;</span>
<a href="#l37.23"></a><span id="l37.23">     } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/base/content/import-export.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/base/content/import-export.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -14,35 +14,31 @@ var MODE_TRUNCATE = 0x20;</span>
<a href="#l38.4"></a><span id="l38.4"> </span>
<a href="#l38.5"></a><span id="l38.5"> /**</span>
<a href="#l38.6"></a><span id="l38.6">  * Shows a file dialog, reads the selected file(s) and tries to parse events from it.</span>
<a href="#l38.7"></a><span id="l38.7">  *</span>
<a href="#l38.8"></a><span id="l38.8">  * @param aCalendar  (optional) If specified, the items will be imported directly</span>
<a href="#l38.9"></a><span id="l38.9">  *                              into the calendar</span>
<a href="#l38.10"></a><span id="l38.10">  */</span>
<a href="#l38.11"></a><span id="l38.11"> function loadEventsFromFile(aCalendar) {</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-    const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-    let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-                           .createInstance(nsIFilePicker);</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+    let picker = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l38.17"></a><span id="l38.17">     picker.init(window,</span>
<a href="#l38.18"></a><span id="l38.18">                 cal.l10n.getCalString(&quot;filepickerTitleImport&quot;),</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-                nsIFilePicker.modeOpen);</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+                Ci.nsIFilePicker.modeOpen);</span>
<a href="#l38.21"></a><span id="l38.21">     picker.defaultExtension = &quot;ics&quot;;</span>
<a href="#l38.22"></a><span id="l38.22"> </span>
<a href="#l38.23"></a><span id="l38.23">     // Get a list of importers</span>
<a href="#l38.24"></a><span id="l38.24">     let contractids = [];</span>
<a href="#l38.25"></a><span id="l38.25">     let currentListLength = 0;</span>
<a href="#l38.26"></a><span id="l38.26">     let defaultCIDIndex = 0;</span>
<a href="#l38.27"></a><span id="l38.27">     for (let { data } of Services.catMan.enumerateCategory(&quot;cal-importers&quot;)) {</span>
<a href="#l38.28"></a><span id="l38.28">         let contractid = Services.catMan.getCategoryEntry(&quot;cal-importers&quot;, data);</span>
<a href="#l38.29"></a><span id="l38.29">         let importer;</span>
<a href="#l38.30"></a><span id="l38.30">         try {</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-            importer = Components.classes[contractid]</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-                                 .getService(Components.interfaces.calIImporter);</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+            importer = Cc[contractid].getService(Ci.calIImporter);</span>
<a href="#l38.34"></a><span id="l38.34">         } catch (e) {</span>
<a href="#l38.35"></a><span id="l38.35">             cal.WARN(&quot;Could not initialize importer: &quot; + contractid + &quot;\nError: &quot; + e);</span>
<a href="#l38.36"></a><span id="l38.36">             continue;</span>
<a href="#l38.37"></a><span id="l38.37">         }</span>
<a href="#l38.38"></a><span id="l38.38">         let types = importer.getFileTypes({});</span>
<a href="#l38.39"></a><span id="l38.39">         for (let type of types) {</span>
<a href="#l38.40"></a><span id="l38.40">             picker.appendFilter(type.description, type.extensionFilter);</span>
<a href="#l38.41"></a><span id="l38.41">             if (type.extensionFilter == &quot;*.&quot; + picker.defaultExtension) {</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineat">@@ -50,44 +46,41 @@ function loadEventsFromFile(aCalendar) {</span>
<a href="#l38.43"></a><span id="l38.43">                 defaultCIDIndex = currentListLength;</span>
<a href="#l38.44"></a><span id="l38.44">             }</span>
<a href="#l38.45"></a><span id="l38.45">             contractids.push(contractid);</span>
<a href="#l38.46"></a><span id="l38.46">             currentListLength++;</span>
<a href="#l38.47"></a><span id="l38.47">         }</span>
<a href="#l38.48"></a><span id="l38.48">     }</span>
<a href="#l38.49"></a><span id="l38.49"> </span>
<a href="#l38.50"></a><span id="l38.50">     picker.open(rv =&gt; {</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-        if (rv != nsIFilePicker.returnOK || !picker.file || !picker.file.path) {</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+        if (rv != Ci.nsIFilePicker.returnOK || !picker.file || !picker.file.path) {</span>
<a href="#l38.53"></a><span id="l38.53">             return;</span>
<a href="#l38.54"></a><span id="l38.54">         }</span>
<a href="#l38.55"></a><span id="l38.55"> </span>
<a href="#l38.56"></a><span id="l38.56">         let filterIndex = picker.filterIndex;</span>
<a href="#l38.57"></a><span id="l38.57">         if (picker.filterIndex &lt; 0 || picker.filterIndex &gt; contractids.length) {</span>
<a href="#l38.58"></a><span id="l38.58">             // For some reason the wrong filter was selected, assume default extension</span>
<a href="#l38.59"></a><span id="l38.59">             filterIndex = defaultCIDIndex;</span>
<a href="#l38.60"></a><span id="l38.60">         }</span>
<a href="#l38.61"></a><span id="l38.61"> </span>
<a href="#l38.62"></a><span id="l38.62">         let filePath = picker.file.path;</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-        let importer = Components.classes[contractids[filterIndex]]</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineminus">-                                 .getService(Components.interfaces.calIImporter);</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+        let importer = Cc[contractids[filterIndex]].getService(Ci.calIImporter);</span>
<a href="#l38.66"></a><span id="l38.66"> </span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-        const nsIFileInputStream = Components.interfaces.nsIFileInputStream;</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineminus">-        let inputStream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineminus">-                                    .createInstance(nsIFileInputStream);</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+        let inputStream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+                            .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l38.73"></a><span id="l38.73">         let items = [];</span>
<a href="#l38.74"></a><span id="l38.74">         let exception;</span>
<a href="#l38.75"></a><span id="l38.75"> </span>
<a href="#l38.76"></a><span id="l38.76">         try {</span>
<a href="#l38.77"></a><span id="l38.77">             inputStream.init(picker.file, MODE_RDONLY, parseInt(&quot;0444&quot;, 8), {});</span>
<a href="#l38.78"></a><span id="l38.78">             items = importer.importFromStream(inputStream, {});</span>
<a href="#l38.79"></a><span id="l38.79">         } catch (ex) {</span>
<a href="#l38.80"></a><span id="l38.80">             exception = ex;</span>
<a href="#l38.81"></a><span id="l38.81">             switch (ex.result) {</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineminus">-                case Components.interfaces.calIErrors.INVALID_TIMEZONE:</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+                case Ci.calIErrors.INVALID_TIMEZONE:</span>
<a href="#l38.84"></a><span id="l38.84">                     cal.showError(cal.l10n.getCalString(&quot;timezoneError&quot;, [filePath]), window);</span>
<a href="#l38.85"></a><span id="l38.85">                     break;</span>
<a href="#l38.86"></a><span id="l38.86">                 default:</span>
<a href="#l38.87"></a><span id="l38.87">                     cal.showError(cal.l10n.getCalString(&quot;unableToRead&quot;) + filePath + &quot;\n&quot; + ex, window);</span>
<a href="#l38.88"></a><span id="l38.88">             }</span>
<a href="#l38.89"></a><span id="l38.89">         } finally {</span>
<a href="#l38.90"></a><span id="l38.90">             inputStream.close();</span>
<a href="#l38.91"></a><span id="l38.91">         }</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineat">@@ -151,17 +144,17 @@ function putItemsIntoCal(destCal, aItems</span>
<a href="#l38.93"></a><span id="l38.93">     // (example of something very wrong: importing the same file twice.</span>
<a href="#l38.94"></a><span id="l38.94">     //  quite easy to trigger, so we really should do this)</span>
<a href="#l38.95"></a><span id="l38.95">     let lastError;</span>
<a href="#l38.96"></a><span id="l38.96">     let listener = {</span>
<a href="#l38.97"></a><span id="l38.97">         QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l38.98"></a><span id="l38.98">         onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l38.99"></a><span id="l38.99">             count++;</span>
<a href="#l38.100"></a><span id="l38.100">             if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineminus">-                if (aStatus == Components.interfaces.calIErrors.DUPLICATE_ID) {</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+                if (aStatus == Ci.calIErrors.DUPLICATE_ID) {</span>
<a href="#l38.103"></a><span id="l38.103">                     duplicateCount++;</span>
<a href="#l38.104"></a><span id="l38.104">                 } else {</span>
<a href="#l38.105"></a><span id="l38.105">                     failedCount++;</span>
<a href="#l38.106"></a><span id="l38.106">                     lastError = aStatus;</span>
<a href="#l38.107"></a><span id="l38.107">                 }</span>
<a href="#l38.108"></a><span id="l38.108">             }</span>
<a href="#l38.109"></a><span id="l38.109">             // See if it is time to end the calendar's batch.</span>
<a href="#l38.110"></a><span id="l38.110">             if (count == aItems.length) {</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineat">@@ -188,17 +181,17 @@ function putItemsIntoCal(destCal, aItems</span>
<a href="#l38.112"></a><span id="l38.112">             destCal.addItem(item, listener);</span>
<a href="#l38.113"></a><span id="l38.113">         } catch (e) {</span>
<a href="#l38.114"></a><span id="l38.114">             failedCount++;</span>
<a href="#l38.115"></a><span id="l38.115">             lastError = e;</span>
<a href="#l38.116"></a><span id="l38.116">             // Call the listener's operationComplete, to increase the</span>
<a href="#l38.117"></a><span id="l38.117">             // counter and not miss failed items. Otherwise, endBatch might</span>
<a href="#l38.118"></a><span id="l38.118">             // never be called.</span>
<a href="#l38.119"></a><span id="l38.119">             listener.onOperationComplete(null, null, null, null, null);</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineminus">-            Components.utils.reportError(&quot;Import error: &quot; + e);</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+            Cu.reportError(&quot;Import error: &quot; + e);</span>
<a href="#l38.122"></a><span id="l38.122">         }</span>
<a href="#l38.123"></a><span id="l38.123">     }</span>
<a href="#l38.124"></a><span id="l38.124"> </span>
<a href="#l38.125"></a><span id="l38.125">     // End transmgr batch</span>
<a href="#l38.126"></a><span id="l38.126">     endBatchTransaction();</span>
<a href="#l38.127"></a><span id="l38.127"> }</span>
<a href="#l38.128"></a><span id="l38.128"> </span>
<a href="#l38.129"></a><span id="l38.129"> /**</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineat">@@ -209,24 +202,21 @@ function putItemsIntoCal(destCal, aItems</span>
<a href="#l38.131"></a><span id="l38.131">  * @param aDefaultFileName   (optional) Initial filename shown in SaveAs dialog.</span>
<a href="#l38.132"></a><span id="l38.132">  */</span>
<a href="#l38.133"></a><span id="l38.133"> function saveEventsToFile(calendarEventArray, aDefaultFileName) {</span>
<a href="#l38.134"></a><span id="l38.134">     if (!calendarEventArray || !calendarEventArray.length) {</span>
<a href="#l38.135"></a><span id="l38.135">         return;</span>
<a href="#l38.136"></a><span id="l38.136">     }</span>
<a href="#l38.137"></a><span id="l38.137"> </span>
<a href="#l38.138"></a><span id="l38.138">     // Show the 'Save As' dialog and ask for a filename to save to</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineminus">-    const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineminus">-</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineminus">-    let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineminus">-                       .createInstance(nsIFilePicker);</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineplus">+    let picker = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l38.144"></a><span id="l38.144"> </span>
<a href="#l38.145"></a><span id="l38.145">     picker.init(window,</span>
<a href="#l38.146"></a><span id="l38.146">                 cal.l10n.getCalString(&quot;filepickerTitleExport&quot;),</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineminus">-                nsIFilePicker.modeSave);</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineplus">+                Ci.nsIFilePicker.modeSave);</span>
<a href="#l38.149"></a><span id="l38.149"> </span>
<a href="#l38.150"></a><span id="l38.150">     if (aDefaultFileName &amp;&amp; aDefaultFileName.length &amp;&amp; aDefaultFileName.length &gt; 0) {</span>
<a href="#l38.151"></a><span id="l38.151">         picker.defaultString = aDefaultFileName;</span>
<a href="#l38.152"></a><span id="l38.152">     } else if (calendarEventArray.length == 1 &amp;&amp; calendarEventArray[0].title) {</span>
<a href="#l38.153"></a><span id="l38.153">         picker.defaultString = calendarEventArray[0].title;</span>
<a href="#l38.154"></a><span id="l38.154">     } else {</span>
<a href="#l38.155"></a><span id="l38.155">         picker.defaultString = cal.l10n.getCalString(&quot;defaultFileName&quot;);</span>
<a href="#l38.156"></a><span id="l38.156">     }</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineat">@@ -236,18 +226,17 @@ function saveEventsToFile(calendarEventA</span>
<a href="#l38.158"></a><span id="l38.158">     // Get a list of exporters</span>
<a href="#l38.159"></a><span id="l38.159">     let contractids = [];</span>
<a href="#l38.160"></a><span id="l38.160">     let currentListLength = 0;</span>
<a href="#l38.161"></a><span id="l38.161">     let defaultCIDIndex = 0;</span>
<a href="#l38.162"></a><span id="l38.162">     for (let { data } of Services.catMan.enumerateCategory(&quot;cal-exporters&quot;)) {</span>
<a href="#l38.163"></a><span id="l38.163">         let contractid = Services.catMan.getCategoryEntry(&quot;cal-exporters&quot;, data);</span>
<a href="#l38.164"></a><span id="l38.164">         let exporter;</span>
<a href="#l38.165"></a><span id="l38.165">         try {</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineminus">-            exporter = Components.classes[contractid]</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineminus">-                                 .getService(Components.interfaces.calIExporter);</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineplus">+            exporter = Cc[contractid].getService(Ci.calIExporter);</span>
<a href="#l38.169"></a><span id="l38.169">         } catch (e) {</span>
<a href="#l38.170"></a><span id="l38.170">             cal.WARN(&quot;Could not initialize exporter: &quot; + contractid + &quot;\nError: &quot; + e);</span>
<a href="#l38.171"></a><span id="l38.171">             continue;</span>
<a href="#l38.172"></a><span id="l38.172">         }</span>
<a href="#l38.173"></a><span id="l38.173">         let types = exporter.getFileTypes({});</span>
<a href="#l38.174"></a><span id="l38.174">         for (let type of types) {</span>
<a href="#l38.175"></a><span id="l38.175">             picker.appendFilter(type.description, type.extensionFilter);</span>
<a href="#l38.176"></a><span id="l38.176">             if (type.extensionFilter == &quot;*.&quot; + picker.defaultExtension) {</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineat">@@ -256,44 +245,42 @@ function saveEventsToFile(calendarEventA</span>
<a href="#l38.178"></a><span id="l38.178">             }</span>
<a href="#l38.179"></a><span id="l38.179">             contractids.push(contractid);</span>
<a href="#l38.180"></a><span id="l38.180">             currentListLength++;</span>
<a href="#l38.181"></a><span id="l38.181">         }</span>
<a href="#l38.182"></a><span id="l38.182">     }</span>
<a href="#l38.183"></a><span id="l38.183"> </span>
<a href="#l38.184"></a><span id="l38.184">     // Now find out as what to save, convert the events and save to file.</span>
<a href="#l38.185"></a><span id="l38.185">     picker.open(rv =&gt; {</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineminus">-        if (rv == nsIFilePicker.returnCancel || !picker.file || !picker.file.path) {</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineplus">+        if (rv == Ci.nsIFilePicker.returnCancel || !picker.file || !picker.file.path) {</span>
<a href="#l38.188"></a><span id="l38.188">             return;</span>
<a href="#l38.189"></a><span id="l38.189">         }</span>
<a href="#l38.190"></a><span id="l38.190"> </span>
<a href="#l38.191"></a><span id="l38.191">         let filterIndex = picker.filterIndex;</span>
<a href="#l38.192"></a><span id="l38.192">         if (picker.filterIndex &lt; 0 || picker.filterIndex &gt; contractids.length) {</span>
<a href="#l38.193"></a><span id="l38.193">             // For some reason the wrong filter was selected, assume default extension</span>
<a href="#l38.194"></a><span id="l38.194">             filterIndex = defaultCIDIndex;</span>
<a href="#l38.195"></a><span id="l38.195">         }</span>
<a href="#l38.196"></a><span id="l38.196"> </span>
<a href="#l38.197"></a><span id="l38.197" class="difflineminus">-        let exporter = Components.classes[contractids[filterIndex]]</span>
<a href="#l38.198"></a><span id="l38.198" class="difflineminus">-                                 .getService(Components.interfaces.calIExporter);</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineplus">+        let exporter = Cc[contractids[filterIndex]].getService(Ci.calIExporter);</span>
<a href="#l38.200"></a><span id="l38.200"> </span>
<a href="#l38.201"></a><span id="l38.201">         let filePath = picker.file.path;</span>
<a href="#l38.202"></a><span id="l38.202">         if (!filePath.includes(&quot;.&quot;)) {</span>
<a href="#l38.203"></a><span id="l38.203">             filePath += &quot;.&quot; + exporter.getFileTypes({})[0].defaultExtension;</span>
<a href="#l38.204"></a><span id="l38.204">         }</span>
<a href="#l38.205"></a><span id="l38.205"> </span>
<a href="#l38.206"></a><span id="l38.206" class="difflineminus">-        const nsIFile = Components.interfaces.nsIFile;</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineminus">-        const nsIFileOutputStream = Components.interfaces.nsIFileOutputStream;</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineplus">+        const nsIFile = Ci.nsIFile;</span>
<a href="#l38.209"></a><span id="l38.209" class="difflineplus">+        const nsIFileOutputStream = Ci.nsIFileOutputStream;</span>
<a href="#l38.210"></a><span id="l38.210"> </span>
<a href="#l38.211"></a><span id="l38.211">         let outputStream;</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineminus">-        let localFileInstance = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineminus">-                                          .createInstance(nsIFile);</span>
<a href="#l38.214"></a><span id="l38.214" class="difflineplus">+        let localFileInstance = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(nsIFile);</span>
<a href="#l38.215"></a><span id="l38.215">         localFileInstance.initWithPath(filePath);</span>
<a href="#l38.216"></a><span id="l38.216"> </span>
<a href="#l38.217"></a><span id="l38.217" class="difflineminus">-        outputStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l38.218"></a><span id="l38.218" class="difflineminus">-                                 .createInstance(nsIFileOutputStream);</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineplus">+        outputStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineplus">+                         .createInstance(nsIFileOutputStream);</span>
<a href="#l38.221"></a><span id="l38.221">         try {</span>
<a href="#l38.222"></a><span id="l38.222">             outputStream.init(localFileInstance,</span>
<a href="#l38.223"></a><span id="l38.223">                               MODE_WRONLY | MODE_CREATE | MODE_TRUNCATE,</span>
<a href="#l38.224"></a><span id="l38.224">                               parseInt(&quot;0664&quot;, 8),</span>
<a href="#l38.225"></a><span id="l38.225">                               0);</span>
<a href="#l38.226"></a><span id="l38.226"> </span>
<a href="#l38.227"></a><span id="l38.227">             // XXX Do the right thing with unicode and stuff. Or, again, should the</span>
<a href="#l38.228"></a><span id="l38.228">             //     exporter handle that?</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineat">@@ -324,17 +311,17 @@ function exportEntireCalendar(aCalendar)</span>
<a href="#l38.230"></a><span id="l38.230">         onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l38.231"></a><span id="l38.231">             for (let item of aItems) {</span>
<a href="#l38.232"></a><span id="l38.232">                 itemArray.push(item);</span>
<a href="#l38.233"></a><span id="l38.233">             }</span>
<a href="#l38.234"></a><span id="l38.234">         }</span>
<a href="#l38.235"></a><span id="l38.235">     };</span>
<a href="#l38.236"></a><span id="l38.236"> </span>
<a href="#l38.237"></a><span id="l38.237">     let getItemsFromCal = function(aCal) {</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineminus">-        aCal.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineplus">+        aCal.getItems(Ci.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l38.240"></a><span id="l38.240">                       0, null, null, getListener);</span>
<a href="#l38.241"></a><span id="l38.241">     };</span>
<a href="#l38.242"></a><span id="l38.242"> </span>
<a href="#l38.243"></a><span id="l38.243">     if (aCalendar) {</span>
<a href="#l38.244"></a><span id="l38.244">         getItemsFromCal(aCalendar);</span>
<a href="#l38.245"></a><span id="l38.245">     } else {</span>
<a href="#l38.246"></a><span id="l38.246">         let count = {};</span>
<a href="#l38.247"></a><span id="l38.247">         let calendars = cal.getCalendarManager().getCalendars(count);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/base/content/preferences/alarms.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/base/content/preferences/alarms.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -30,17 +30,17 @@ var gAlarmsPane = {</span>
<a href="#l39.4"></a><span id="l39.4">      * @param aFileURL    A string with a file:// url.</span>
<a href="#l39.5"></a><span id="l39.5">      * @return            The corresponding nsIFile.</span>
<a href="#l39.6"></a><span id="l39.6">      */</span>
<a href="#l39.7"></a><span id="l39.7">     convertURLToLocalFile: function(aFileURL) {</span>
<a href="#l39.8"></a><span id="l39.8">         // Convert the file url into a nsIFile</span>
<a href="#l39.9"></a><span id="l39.9">         if (aFileURL) {</span>
<a href="#l39.10"></a><span id="l39.10">             let fph = Services.io</span>
<a href="#l39.11"></a><span id="l39.11">                          .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-                         .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+                         .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l39.14"></a><span id="l39.14">             return fph.getFileFromURLSpec(aFileURL);</span>
<a href="#l39.15"></a><span id="l39.15">         } else {</span>
<a href="#l39.16"></a><span id="l39.16">             return null;</span>
<a href="#l39.17"></a><span id="l39.17">         }</span>
<a href="#l39.18"></a><span id="l39.18">     },</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20">     /**</span>
<a href="#l39.21"></a><span id="l39.21">      * Handler function to be called when the calendar.alarms.soundURL pref has</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineat">@@ -67,46 +67,43 @@ var gAlarmsPane = {</span>
<a href="#l39.23"></a><span id="l39.23">         document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l39.24"></a><span id="l39.24">         this.readSoundLocation();</span>
<a href="#l39.25"></a><span id="l39.25">     },</span>
<a href="#l39.26"></a><span id="l39.26"> </span>
<a href="#l39.27"></a><span id="l39.27">     /**</span>
<a href="#l39.28"></a><span id="l39.28">      * Opens a filepicker to open a local sound for the alarm.</span>
<a href="#l39.29"></a><span id="l39.29">      */</span>
<a href="#l39.30"></a><span id="l39.30">     browseAlarm: function() {</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-        const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-        let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-                               .createInstance(nsIFilePicker);</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+        let picker = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l39.35"></a><span id="l39.35"> </span>
<a href="#l39.36"></a><span id="l39.36">         let bundlePreferences = document.getElementById(&quot;bundleCalendarPreferences&quot;);</span>
<a href="#l39.37"></a><span id="l39.37">         let title = bundlePreferences.getString(&quot;Open&quot;);</span>
<a href="#l39.38"></a><span id="l39.38">         let wildmat = &quot;*.wav&quot;;</span>
<a href="#l39.39"></a><span id="l39.39">         let label = bundlePreferences.getFormattedString(&quot;filterWav&quot;, [wildmat], 1);</span>
<a href="#l39.40"></a><span id="l39.40"> </span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-        picker.init(window, title, nsIFilePicker.modeOpen);</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+        picker.init(window, title, Ci.nsIFilePicker.modeOpen);</span>
<a href="#l39.43"></a><span id="l39.43">         picker.appendFilter(label, wildmat);</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-        picker.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+        picker.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l39.46"></a><span id="l39.46"> </span>
<a href="#l39.47"></a><span id="l39.47">         picker.open(rv =&gt; {</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineminus">-            if (rv != nsIFilePicker.returnOK || !picker.file) {</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+            if (rv != Ci.nsIFilePicker.returnOK || !picker.file) {</span>
<a href="#l39.50"></a><span id="l39.50">                 return;</span>
<a href="#l39.51"></a><span id="l39.51">             }</span>
<a href="#l39.52"></a><span id="l39.52">             document.getElementById(&quot;calendar.alarms.soundURL&quot;).value = picker.fileURL.spec;</span>
<a href="#l39.53"></a><span id="l39.53">             document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l39.54"></a><span id="l39.54">             this.readSoundLocation();</span>
<a href="#l39.55"></a><span id="l39.55">         });</span>
<a href="#l39.56"></a><span id="l39.56">     },</span>
<a href="#l39.57"></a><span id="l39.57"> </span>
<a href="#l39.58"></a><span id="l39.58">     /**</span>
<a href="#l39.59"></a><span id="l39.59">      * Plays the alarm sound currently selected.</span>
<a href="#l39.60"></a><span id="l39.60">      */</span>
<a href="#l39.61"></a><span id="l39.61">     previewAlarm: function() {</span>
<a href="#l39.62"></a><span id="l39.62">         let soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;).value;</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-        let soundIfc = Components.classes[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-                                 .createInstance(Components.interfaces.nsISound);</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+        let soundIfc = Cc[&quot;@mozilla.org/sound;1&quot;].createInstance(Ci.nsISound);</span>
<a href="#l39.66"></a><span id="l39.66">         let url;</span>
<a href="#l39.67"></a><span id="l39.67">         try {</span>
<a href="#l39.68"></a><span id="l39.68">             soundIfc.init();</span>
<a href="#l39.69"></a><span id="l39.69">             if (soundUrl &amp;&amp; soundUrl.length &amp;&amp; soundUrl.length &gt; 0) {</span>
<a href="#l39.70"></a><span id="l39.70">                 url = Services.io.newURI(soundUrl);</span>
<a href="#l39.71"></a><span id="l39.71">                 soundIfc.play(url);</span>
<a href="#l39.72"></a><span id="l39.72">             } else {</span>
<a href="#l39.73"></a><span id="l39.73">                 soundIfc.beep();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/base/content/preferences/general.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/base/content/preferences/general.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -10,18 +10,18 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l40.4"></a><span id="l40.4">  * Global Object to hold methods for the general pref pane</span>
<a href="#l40.5"></a><span id="l40.5">  */</span>
<a href="#l40.6"></a><span id="l40.6"> var gCalendarGeneralPane = {</span>
<a href="#l40.7"></a><span id="l40.7">     /**</span>
<a href="#l40.8"></a><span id="l40.8">      * Initialize the general pref pane. Sets up dialog controls to match the</span>
<a href="#l40.9"></a><span id="l40.9">      * values set in prefs.</span>
<a href="#l40.10"></a><span id="l40.10">      */</span>
<a href="#l40.11"></a><span id="l40.11">     init: function() {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-        let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-                                  .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+        let formatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+                          .getService(Ci.calIDateTimeFormatter);</span>
<a href="#l40.16"></a><span id="l40.16"> </span>
<a href="#l40.17"></a><span id="l40.17">         let dateFormattedLong = formatter.formatDateLong(cal.dtz.now());</span>
<a href="#l40.18"></a><span id="l40.18">         let dateFormattedShort = formatter.formatDateShort(cal.dtz.now());</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20">         // menu items include examples of current date formats.</span>
<a href="#l40.21"></a><span id="l40.21">         document.getElementById(&quot;dateformat-long-menuitem&quot;)</span>
<a href="#l40.22"></a><span id="l40.22">                 .setAttribute(&quot;label&quot;, labelLong + &quot;: &quot; + dateFormattedLong);</span>
<a href="#l40.23"></a><span id="l40.23">         document.getElementById(&quot;dateformat-short-menuitem&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -87,17 +87,17 @@</span>
<a href="#l41.4"></a><span id="l41.4">                         &quot;alarmStarts&quot;,</span>
<a href="#l41.5"></a><span id="l41.5">                         [formatter.formatDateTime(startDate)]</span>
<a href="#l41.6"></a><span id="l41.6">                     );</span>
<a href="#l41.7"></a><span id="l41.7">                 } else {</span>
<a href="#l41.8"></a><span id="l41.8">                     // If the task has no start date, then format the alarm date.</span>
<a href="#l41.9"></a><span id="l41.9">                     dateLabel.textContent = formatter.formatDateTime(this.mAlarm.alarmDate);</span>
<a href="#l41.10"></a><span id="l41.10">                 }</span>
<a href="#l41.11"></a><span id="l41.11">             } else {</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-                throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+                throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l41.14"></a><span id="l41.14">             }</span>
<a href="#l41.15"></a><span id="l41.15"> </span>
<a href="#l41.16"></a><span id="l41.16">             // Relative date</span>
<a href="#l41.17"></a><span id="l41.17">             this.updateRelativeDateLabel();</span>
<a href="#l41.18"></a><span id="l41.18"> </span>
<a href="#l41.19"></a><span id="l41.19">             // Title, location</span>
<a href="#l41.20"></a><span id="l41.20">             titleLabel.textContent = this.mItem.title || &quot;&quot;;</span>
<a href="#l41.21"></a><span id="l41.21">             locationDescription.textContent = this.mItem.getProperty(&quot;LOCATION&quot;) || &quot;&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -28,17 +28,17 @@</span>
<a href="#l42.4"></a><span id="l42.4">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6">       &lt;field name=&quot;mAddingFromComposite&quot;&gt;false&lt;/field&gt;</span>
<a href="#l42.7"></a><span id="l42.7"> </span>
<a href="#l42.8"></a><span id="l42.8">       &lt;property name=&quot;compositeCalendar&quot;&gt;</span>
<a href="#l42.9"></a><span id="l42.9">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l42.10"></a><span id="l42.10">             if (!this.mCompositeCalendar) {</span>
<a href="#l42.11"></a><span id="l42.11">                 throw Components.Exception(&quot;Calendar list has no composite calendar yet&quot;,</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-                                           Components.results.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+                                           Cr.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l42.14"></a><span id="l42.14">             }</span>
<a href="#l42.15"></a><span id="l42.15">             return this.mCompositeCalendar;</span>
<a href="#l42.16"></a><span id="l42.16">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l42.17"></a><span id="l42.17">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l42.18"></a><span id="l42.18">             this.mCompositeCalendar = val;</span>
<a href="#l42.19"></a><span id="l42.19">             this.mCompositeCalendar.addObserver(this.compositeObserver);</span>
<a href="#l42.20"></a><span id="l42.20"> </span>
<a href="#l42.21"></a><span id="l42.21">             // Now that we have a composite calendar, we can get all calendars</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -55,17 +55,17 @@</span>
<a href="#l42.23"></a><span id="l42.23">       &lt;property name=&quot;calendars&quot;&gt;</span>
<a href="#l42.24"></a><span id="l42.24">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l42.25"></a><span id="l42.25">             return this.mCalendarList;</span>
<a href="#l42.26"></a><span id="l42.26">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l42.27"></a><span id="l42.27">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l42.28"></a><span id="l42.28">             // Setting calendars externally is not wanted. This is done internally</span>
<a href="#l42.29"></a><span id="l42.29">             // in the compositeCalendar setter.</span>
<a href="#l42.30"></a><span id="l42.30">             throw Components.Exception(&quot;Seting calendars on type='full' is not supported&quot;,</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-                                       Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+                                       Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l42.33"></a><span id="l42.33">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l42.34"></a><span id="l42.34">       &lt;/property&gt;</span>
<a href="#l42.35"></a><span id="l42.35"> </span>
<a href="#l42.36"></a><span id="l42.36">       &lt;field name=&quot;calMgrObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l42.37"></a><span id="l42.37">         ({</span>
<a href="#l42.38"></a><span id="l42.38">             listTree: this,</span>
<a href="#l42.39"></a><span id="l42.39">             QueryInterface: ChromeUtils.generateQI([Ci.calICalendarManagerObserver]),</span>
<a href="#l42.40"></a><span id="l42.40"> </span>
<a href="#l42.41"></a><span id="l42.41" class="difflineat">@@ -356,27 +356,26 @@</span>
<a href="#l42.42"></a><span id="l42.42">                 this.treebox.endUpdateBatch();</span>
<a href="#l42.43"></a><span id="l42.43">             }</span>
<a href="#l42.44"></a><span id="l42.44">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l42.45"></a><span id="l42.45">       &lt;/property&gt;</span>
<a href="#l42.46"></a><span id="l42.46"> </span>
<a href="#l42.47"></a><span id="l42.47">       &lt;property name=&quot;compositeCalendar&quot;&gt;</span>
<a href="#l42.48"></a><span id="l42.48">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l42.49"></a><span id="l42.49">             if (!this.mCompositeCalendar) {</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineminus">-                this.mCompositeCalendar =</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineminus">-                    Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-                              .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+                this.mCompositeCalendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+                                            .createInstance(Ci.calICompositeCalendar);</span>
<a href="#l42.55"></a><span id="l42.55">             }</span>
<a href="#l42.56"></a><span id="l42.56"> </span>
<a href="#l42.57"></a><span id="l42.57">             return this.mCompositeCalendar;</span>
<a href="#l42.58"></a><span id="l42.58">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l42.59"></a><span id="l42.59">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l42.60"></a><span id="l42.60">             if (this.mCompositeCalendar) {</span>
<a href="#l42.61"></a><span id="l42.61">                 throw Components.Exception(&quot;A composite calendar has already been set&quot;,</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-                                           Components.results.NS_ERROR_ALREADY_INITIALIZED);</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+                                           Cr.NS_ERROR_ALREADY_INITIALIZED);</span>
<a href="#l42.64"></a><span id="l42.64">             }</span>
<a href="#l42.65"></a><span id="l42.65">             this.mCompositeCalendar = val;</span>
<a href="#l42.66"></a><span id="l42.66">             this.mCompositeCalendar.addObserver(this.compositeObserver);</span>
<a href="#l42.67"></a><span id="l42.67">             return val;</span>
<a href="#l42.68"></a><span id="l42.68">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l42.69"></a><span id="l42.69">       &lt;/property&gt;</span>
<a href="#l42.70"></a><span id="l42.70"> </span>
<a href="#l42.71"></a><span id="l42.71">       &lt;property name=&quot;sortOrder&quot;</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineat">@@ -814,17 +813,17 @@</span>
<a href="#l42.73"></a><span id="l42.73">             if (!this.allowDrag || !dataTransfer) {</span>
<a href="#l42.74"></a><span id="l42.74">                 // If dragging is not allowed or there is no data transfer then</span>
<a href="#l42.75"></a><span id="l42.75">                 // we can't drop (i.e dropping a file on the calendar list).</span>
<a href="#l42.76"></a><span id="l42.76">                 return false;</span>
<a href="#l42.77"></a><span id="l42.77">             }</span>
<a href="#l42.78"></a><span id="l42.78"> </span>
<a href="#l42.79"></a><span id="l42.79">             let dragCalId = dataTransfer.getData(&quot;application/x-moz-calendarID&quot;);</span>
<a href="#l42.80"></a><span id="l42.80"> </span>
<a href="#l42.81"></a><span id="l42.81" class="difflineminus">-            return (aOrientation != Components.interfaces.nsITreeView.DROP_ON &amp;&amp;</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+            return (aOrientation != Ci.nsITreeView.DROP_ON &amp;&amp;</span>
<a href="#l42.83"></a><span id="l42.83">                     dragCalId != null);</span>
<a href="#l42.84"></a><span id="l42.84">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.85"></a><span id="l42.85">       &lt;/method&gt;</span>
<a href="#l42.86"></a><span id="l42.86"> </span>
<a href="#l42.87"></a><span id="l42.87">       &lt;method name=&quot;drop&quot;&gt;</span>
<a href="#l42.88"></a><span id="l42.88">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l42.89"></a><span id="l42.89">         &lt;parameter name=&quot;aOrientation&quot;/&gt;</span>
<a href="#l42.90"></a><span id="l42.90">         &lt;body&gt;&lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -438,18 +438,18 @@</span>
<a href="#l43.4"></a><span id="l43.4">       &lt;handler event=&quot;drop&quot;&gt;&lt;![CDATA[</span>
<a href="#l43.5"></a><span id="l43.5">           let session = cal.getDragService().getCurrentSession();</span>
<a href="#l43.6"></a><span id="l43.6">           if (!session || !session.sourceNode || !session.sourceNode.sourceObject) {</span>
<a href="#l43.7"></a><span id="l43.7">               // No source node? Not our drag.</span>
<a href="#l43.8"></a><span id="l43.8">               return;</span>
<a href="#l43.9"></a><span id="l43.9">           }</span>
<a href="#l43.10"></a><span id="l43.10">           let item = session.sourceNode.sourceObject.clone();</span>
<a href="#l43.11"></a><span id="l43.11">           this.setAttribute(&quot;dropbox&quot;, &quot;false&quot;);</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-          let transfer = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-                                   .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+          let transfer = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+                           .createInstance(Ci.nsITransferable);</span>
<a href="#l43.16"></a><span id="l43.16">           transfer.init(null);</span>
<a href="#l43.17"></a><span id="l43.17"> </span>
<a href="#l43.18"></a><span id="l43.18">           if (cal.item.isEvent(item)) {</span>
<a href="#l43.19"></a><span id="l43.19">               transfer.addDataFlavor(&quot;application/x-moz-cal-event&quot;);</span>
<a href="#l43.20"></a><span id="l43.20">           } else {</span>
<a href="#l43.21"></a><span id="l43.21">               transfer.addDataFlavor(&quot;application/x-moz-cal-task&quot;);</span>
<a href="#l43.22"></a><span id="l43.22">           }</span>
<a href="#l43.23"></a><span id="l43.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/calendar/base/modules/calExtract.jsm</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/calendar/base/modules/calExtract.jsm</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -137,20 +137,18 @@ Extractor.prototype = {</span>
<a href="#l44.4"></a><span id="l44.4">                 if (idx == -1) {</span>
<a href="#l44.5"></a><span id="l44.5">                     Preferences.set(pref, this.fallbackLocale + &quot;,&quot; + lastUsedLangs);</span>
<a href="#l44.6"></a><span id="l44.6">                 } else {</span>
<a href="#l44.7"></a><span id="l44.7">                     langs.splice(idx, 1);</span>
<a href="#l44.8"></a><span id="l44.8">                     Preferences.set(pref, this.fallbackLocale + &quot;,&quot; + langs.join(&quot;,&quot;));</span>
<a href="#l44.9"></a><span id="l44.9">                 }</span>
<a href="#l44.10"></a><span id="l44.10">             }</span>
<a href="#l44.11"></a><span id="l44.11">         } else {</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-            let spellclass = &quot;@mozilla.org/spellchecker/engine;1&quot;;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-            let mozISpellCheckingEngine = Components.interfaces.mozISpellCheckingEngine;</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-            let spellchecker = Components.classes[spellclass]</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">-                                         .getService(mozISpellCheckingEngine);</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+            let spellchecker = Cc[&quot;@mozilla.org/spellchecker/engine;1&quot;]</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+                                 .getService(Ci.mozISpellCheckingEngine);</span>
<a href="#l44.18"></a><span id="l44.18"> </span>
<a href="#l44.19"></a><span id="l44.19">             let arr = {};</span>
<a href="#l44.20"></a><span id="l44.20">             let cnt = {};</span>
<a href="#l44.21"></a><span id="l44.21">             spellchecker.getDictionaryList(arr, cnt);</span>
<a href="#l44.22"></a><span id="l44.22">             let dicts = arr.value;</span>
<a href="#l44.23"></a><span id="l44.23"> </span>
<a href="#l44.24"></a><span id="l44.24">             if (dicts.length == 0) {</span>
<a href="#l44.25"></a><span id="l44.25">                 cal.LOG(&quot;[calExtract] There are no dictionaries installed and &quot; +</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineat">@@ -984,18 +982,17 @@ Extractor.prototype = {</span>
<a href="#l44.27"></a><span id="l44.27">                 cal.LOG(&quot;[calExtract] Pattern not found: &quot; + name);</span>
<a href="#l44.28"></a><span id="l44.28">                 return this.defPattern;</span>
<a href="#l44.29"></a><span id="l44.29">             }</span>
<a href="#l44.30"></a><span id="l44.30"> </span>
<a href="#l44.31"></a><span id="l44.31">             let vals = this.cleanPatterns(value).split(&quot;|&quot;);</span>
<a href="#l44.32"></a><span id="l44.32">             for (let idx = vals.length - 1; idx &gt;= 0; idx--) {</span>
<a href="#l44.33"></a><span id="l44.33">                 if (vals[idx].trim() == &quot;&quot;) {</span>
<a href="#l44.34"></a><span id="l44.34">                     vals.splice(idx, 1);</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineminus">-                    Components.utils.reportError(&quot;[calExtract] Faulty extraction pattern &quot; +</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineminus">-                                                 value + &quot; for &quot; + name);</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+                    Cu.reportError(&quot;[calExtract] Faulty extraction pattern &quot; + value + &quot; for &quot; + name);</span>
<a href="#l44.38"></a><span id="l44.38">                 }</span>
<a href="#l44.39"></a><span id="l44.39">             }</span>
<a href="#l44.40"></a><span id="l44.40"> </span>
<a href="#l44.41"></a><span id="l44.41">             if (this.overrides[name] !== undefined &amp;&amp;</span>
<a href="#l44.42"></a><span id="l44.42">                 this.overrides[name].add !== undefined) {</span>
<a href="#l44.43"></a><span id="l44.43">                 let additions = this.overrides[name].add;</span>
<a href="#l44.44"></a><span id="l44.44">                 additions = this.cleanPatterns(additions).split(&quot;|&quot;);</span>
<a href="#l44.45"></a><span id="l44.45">                 for (let pattern in additions) {</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineat">@@ -1037,18 +1034,17 @@ Extractor.prototype = {</span>
<a href="#l44.47"></a><span id="l44.47">                 cal.LOG(&quot;[calExtract] Pattern empty: &quot; + name);</span>
<a href="#l44.48"></a><span id="l44.48">                 return alts;</span>
<a href="#l44.49"></a><span id="l44.49">             }</span>
<a href="#l44.50"></a><span id="l44.50"> </span>
<a href="#l44.51"></a><span id="l44.51">             let vals = this.cleanPatterns(value).split(&quot;|&quot;);</span>
<a href="#l44.52"></a><span id="l44.52">             for (let idx = vals.length - 1; idx &gt;= 0; idx--) {</span>
<a href="#l44.53"></a><span id="l44.53">                 if (vals[idx].trim() == &quot;&quot;) {</span>
<a href="#l44.54"></a><span id="l44.54">                     vals.splice(idx, 1);</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineminus">-                    Components.utils.reportError(&quot;[calExtract] Faulty extraction pattern &quot; +</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineminus">-                                                 value + &quot; for &quot; + name);</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+                    Cu.reportError(&quot;[calExtract] Faulty extraction pattern &quot; + value + &quot; for &quot; + name);</span>
<a href="#l44.58"></a><span id="l44.58">                 }</span>
<a href="#l44.59"></a><span id="l44.59">             }</span>
<a href="#l44.60"></a><span id="l44.60"> </span>
<a href="#l44.61"></a><span id="l44.61">             if (this.overrides[name] !== undefined &amp;&amp;</span>
<a href="#l44.62"></a><span id="l44.62">                 this.overrides[name].add !== undefined) {</span>
<a href="#l44.63"></a><span id="l44.63">                 let additions = this.overrides[name].add;</span>
<a href="#l44.64"></a><span id="l44.64">                 additions = this.cleanPatterns(additions).split(&quot;|&quot;);</span>
<a href="#l44.65"></a><span id="l44.65">                 for (let pattern in additions) {</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineat">@@ -1102,18 +1098,17 @@ Extractor.prototype = {</span>
<a href="#l44.67"></a><span id="l44.67">         while ((match = re.exec(str))) {</span>
<a href="#l44.68"></a><span id="l44.68">             i++;</span>
<a href="#l44.69"></a><span id="l44.69">             positions[parseInt(match[1], 10)] = i;</span>
<a href="#l44.70"></a><span id="l44.70">         }</span>
<a href="#l44.71"></a><span id="l44.71"> </span>
<a href="#l44.72"></a><span id="l44.72">         // correctness checking</span>
<a href="#l44.73"></a><span id="l44.73">         for (i = 1; i &lt;= count; i++) {</span>
<a href="#l44.74"></a><span id="l44.74">             if (positions[i] === undefined) {</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineminus">-                Components.utils.reportError(&quot;[calExtract] Faulty extraction pattern &quot; + name +</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineminus">-                                             &quot;, missing parameter #&quot; + i);</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineplus">+                Cu.reportError(&quot;[calExtract] Faulty extraction pattern &quot; + name + &quot;, missing parameter #&quot; + i);</span>
<a href="#l44.78"></a><span id="l44.78">             }</span>
<a href="#l44.79"></a><span id="l44.79">         }</span>
<a href="#l44.80"></a><span id="l44.80">         return positions;</span>
<a href="#l44.81"></a><span id="l44.81">     },</span>
<a href="#l44.82"></a><span id="l44.82"> </span>
<a href="#l44.83"></a><span id="l44.83">     cleanPatterns: function(pattern) {</span>
<a href="#l44.84"></a><span id="l44.84">         // remove whitespace around | if present</span>
<a href="#l44.85"></a><span id="l44.85">         let value = pattern.replace(/\s*\|\s*/g, &quot;|&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -52,17 +52,17 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l45.4"></a><span id="l45.4"> </span>
<a href="#l45.5"></a><span id="l45.5"> </span>
<a href="#l45.6"></a><span id="l45.6">     // Retrieve a valid recurrence rule from the currently</span>
<a href="#l45.7"></a><span id="l45.7">     // set recurrence info. Bail out if there's more</span>
<a href="#l45.8"></a><span id="l45.8">     // than a single rule or something other than a rule.</span>
<a href="#l45.9"></a><span id="l45.9">     recurrenceInfo = recurrenceInfo.clone();</span>
<a href="#l45.10"></a><span id="l45.10">     let rrules = splitRecurrenceRules(recurrenceInfo);</span>
<a href="#l45.11"></a><span id="l45.11">     if (rrules[0].length == 1) {</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-        let rule = cal.wrapInstance(rrules[0][0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+        let rule = cal.wrapInstance(rrules[0][0], Ci.calIRecurrenceRule);</span>
<a href="#l45.14"></a><span id="l45.14">         // Currently we allow only for BYDAY, BYMONTHDAY, BYMONTH rules.</span>
<a href="#l45.15"></a><span id="l45.15">         let byparts = [</span>
<a href="#l45.16"></a><span id="l45.16">             &quot;BYSECOND&quot;, &quot;BYMINUTE&quot;, /* &quot;BYDAY&quot;, */ &quot;BYHOUR&quot;, /* &quot;BYMONTHDAY&quot;, */</span>
<a href="#l45.17"></a><span id="l45.17">             &quot;BYYEARDAY&quot;, &quot;BYWEEKNO&quot;, /* &quot;BYMONTH&quot;, */ &quot;BYSETPOS&quot;</span>
<a href="#l45.18"></a><span id="l45.18">         ];</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20">         if (rule &amp;&amp; !checkRecurrenceRule(rule, byparts)) {</span>
<a href="#l45.21"></a><span id="l45.21">             let dateFormatter = cal.getDateFormatter();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -5,79 +5,79 @@</span>
<a href="#l46.4"></a><span id="l46.4"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l46.5"></a><span id="l46.5"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l46.6"></a><span id="l46.6"> const { ConsoleAPI } = ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;, null);</span>
<a href="#l46.7"></a><span id="l46.7"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9"> // Usually the backend loader gets loaded via profile-after-change, but in case</span>
<a href="#l46.10"></a><span id="l46.10"> // a calendar component hooks in earlier, its very likely it will use calUtils.</span>
<a href="#l46.11"></a><span id="l46.11"> // Getting the service here will load if its not already loaded</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-Components.classes[&quot;@mozilla.org/calendar/backend-loader;1&quot;].getService();</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+Cc[&quot;@mozilla.org/calendar/backend-loader;1&quot;].getService();</span>
<a href="#l46.14"></a><span id="l46.14"> </span>
<a href="#l46.15"></a><span id="l46.15"> // The calendar console instance</span>
<a href="#l46.16"></a><span id="l46.16"> var gCalendarConsole = new ConsoleAPI({</span>
<a href="#l46.17"></a><span id="l46.17">     prefix: &quot;Lightning&quot;,</span>
<a href="#l46.18"></a><span id="l46.18">     consoleID: &quot;calendar&quot;,</span>
<a href="#l46.19"></a><span id="l46.19">     maxLogLevel: Preferences.get(&quot;calendar.debug.log&quot;, false) ? &quot;all&quot; : &quot;warn&quot;</span>
<a href="#l46.20"></a><span id="l46.20"> });</span>
<a href="#l46.21"></a><span id="l46.21"> </span>
<a href="#l46.22"></a><span id="l46.22"> this.EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l46.23"></a><span id="l46.23"> var cal = {</span>
<a href="#l46.24"></a><span id="l46.24">     // These functions exist to reduce boilerplate code for creating instances</span>
<a href="#l46.25"></a><span id="l46.25">     // as well as getting services and other (cached) objects.</span>
<a href="#l46.26"></a><span id="l46.26">     createEvent: _instance(&quot;@mozilla.org/calendar/event;1&quot;,</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineminus">-                           Components.interfaces.calIEvent,</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineplus">+                           Ci.calIEvent,</span>
<a href="#l46.29"></a><span id="l46.29">                            &quot;icalString&quot;),</span>
<a href="#l46.30"></a><span id="l46.30">     createTodo: _instance(&quot;@mozilla.org/calendar/todo;1&quot;,</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-                          Components.interfaces.calITodo,</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+                          Ci.calITodo,</span>
<a href="#l46.33"></a><span id="l46.33">                           &quot;icalString&quot;),</span>
<a href="#l46.34"></a><span id="l46.34">     createDateTime: _instance(&quot;@mozilla.org/calendar/datetime;1&quot;,</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineminus">-                              Components.interfaces.calIDateTime,</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineplus">+                              Ci.calIDateTime,</span>
<a href="#l46.37"></a><span id="l46.37">                               &quot;icalString&quot;),</span>
<a href="#l46.38"></a><span id="l46.38">     createDuration: _instance(&quot;@mozilla.org/calendar/duration;1&quot;,</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineminus">-                              Components.interfaces.calIDuration,</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineplus">+                              Ci.calIDuration,</span>
<a href="#l46.41"></a><span id="l46.41">                               &quot;icalString&quot;),</span>
<a href="#l46.42"></a><span id="l46.42">     createAttendee: _instance(&quot;@mozilla.org/calendar/attendee;1&quot;,</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineminus">-                              Components.interfaces.calIAttendee,</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineplus">+                              Ci.calIAttendee,</span>
<a href="#l46.45"></a><span id="l46.45">                               &quot;icalString&quot;),</span>
<a href="#l46.46"></a><span id="l46.46">     createAttachment: _instance(&quot;@mozilla.org/calendar/attachment;1&quot;,</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineminus">-                                Components.interfaces.calIAttachment,</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineplus">+                                Ci.calIAttachment,</span>
<a href="#l46.49"></a><span id="l46.49">                                 &quot;icalString&quot;),</span>
<a href="#l46.50"></a><span id="l46.50">     createAlarm: _instance(&quot;@mozilla.org/calendar/alarm;1&quot;,</span>
<a href="#l46.51"></a><span id="l46.51" class="difflineminus">-                           Components.interfaces.calIAlarm,</span>
<a href="#l46.52"></a><span id="l46.52" class="difflineplus">+                           Ci.calIAlarm,</span>
<a href="#l46.53"></a><span id="l46.53">                            &quot;icalString&quot;),</span>
<a href="#l46.54"></a><span id="l46.54">     createRelation: _instance(&quot;@mozilla.org/calendar/relation;1&quot;,</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineminus">-                              Components.interfaces.calIRelation,</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineplus">+                              Ci.calIRelation,</span>
<a href="#l46.57"></a><span id="l46.57">                               &quot;icalString&quot;),</span>
<a href="#l46.58"></a><span id="l46.58">     createRecurrenceDate: _instance(&quot;@mozilla.org/calendar/recurrence-date;1&quot;,</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineminus">-                                    Components.interfaces.calIRecurrenceDate,</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineplus">+                                    Ci.calIRecurrenceDate,</span>
<a href="#l46.61"></a><span id="l46.61">                                     &quot;icalString&quot;),</span>
<a href="#l46.62"></a><span id="l46.62">     createRecurrenceRule: _instance(&quot;@mozilla.org/calendar/recurrence-rule;1&quot;,</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineminus">-                                    Components.interfaces.calIRecurrenceRule,</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineplus">+                                    Ci.calIRecurrenceRule,</span>
<a href="#l46.65"></a><span id="l46.65">                                     &quot;icalString&quot;),</span>
<a href="#l46.66"></a><span id="l46.66">     createRecurrenceInfo: _instance(&quot;@mozilla.org/calendar/recurrence-info;1&quot;,</span>
<a href="#l46.67"></a><span id="l46.67" class="difflineminus">-                                    Components.interfaces.calIRecurrenceInfo,</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineplus">+                                    Ci.calIRecurrenceInfo,</span>
<a href="#l46.69"></a><span id="l46.69">                                     &quot;item&quot;),</span>
<a href="#l46.70"></a><span id="l46.70"> </span>
<a href="#l46.71"></a><span id="l46.71">     getCalendarManager: _service(&quot;@mozilla.org/calendar/manager;1&quot;,</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineminus">-                                 Components.interfaces.calICalendarManager),</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineplus">+                                 Ci.calICalendarManager),</span>
<a href="#l46.74"></a><span id="l46.74">     getIcsService: _service(&quot;@mozilla.org/calendar/ics-service;1&quot;,</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineminus">-                            Components.interfaces.calIICSService),</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineplus">+                            Ci.calIICSService),</span>
<a href="#l46.77"></a><span id="l46.77">     getTimezoneService: _service(&quot;@mozilla.org/calendar/timezone-service;1&quot;,</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineminus">-                                 Components.interfaces.calITimezoneService),</span>
<a href="#l46.79"></a><span id="l46.79" class="difflineplus">+                                 Ci.calITimezoneService),</span>
<a href="#l46.80"></a><span id="l46.80">     getCalendarSearchService: _service(&quot;@mozilla.org/calendar/calendarsearch-service;1&quot;,</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineminus">-                                       Components.interfaces.calICalendarSearchProvider),</span>
<a href="#l46.82"></a><span id="l46.82" class="difflineplus">+                                       Ci.calICalendarSearchProvider),</span>
<a href="#l46.83"></a><span id="l46.83">     getFreeBusyService: _service(&quot;@mozilla.org/calendar/freebusy-service;1&quot;,</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineminus">-                                 Components.interfaces.calIFreeBusyService),</span>
<a href="#l46.85"></a><span id="l46.85" class="difflineplus">+                                 Ci.calIFreeBusyService),</span>
<a href="#l46.86"></a><span id="l46.86">     getWeekInfoService: _service(&quot;@mozilla.org/calendar/weekinfo-service;1&quot;,</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineminus">-                                 Components.interfaces.calIWeekInfoService),</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+                                 Ci.calIWeekInfoService),</span>
<a href="#l46.89"></a><span id="l46.89">     getDateFormatter: _service(&quot;@mozilla.org/calendar/datetime-formatter;1&quot;,</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineminus">-                               Components.interfaces.calIDateTimeFormatter),</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineplus">+                               Ci.calIDateTimeFormatter),</span>
<a href="#l46.92"></a><span id="l46.92">     getDragService: _service(&quot;@mozilla.org/widget/dragservice;1&quot;,</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineminus">-                             Components.interfaces.nsIDragService),</span>
<a href="#l46.94"></a><span id="l46.94" class="difflineplus">+                             Ci.nsIDragService),</span>
<a href="#l46.95"></a><span id="l46.95"> </span>
<a href="#l46.96"></a><span id="l46.96">     /**</span>
<a href="#l46.97"></a><span id="l46.97">      * The calendar console instance</span>
<a href="#l46.98"></a><span id="l46.98">      */</span>
<a href="#l46.99"></a><span id="l46.99">     console: gCalendarConsole,</span>
<a href="#l46.100"></a><span id="l46.100"> </span>
<a href="#l46.101"></a><span id="l46.101">     /**</span>
<a href="#l46.102"></a><span id="l46.102">      * Logs a calendar message to the console. Needs calendar.debug.log enabled to show messages.</span>
<a href="#l46.103"></a><span id="l46.103" class="difflineat">@@ -137,20 +137,20 @@ var cal = {</span>
<a href="#l46.104"></a><span id="l46.104">      */</span>
<a href="#l46.105"></a><span id="l46.105">     ASSERT: function(aCondition, aMessage, aCritical=false) {</span>
<a href="#l46.106"></a><span id="l46.106">         if (aCondition) {</span>
<a href="#l46.107"></a><span id="l46.107">             return;</span>
<a href="#l46.108"></a><span id="l46.108">         }</span>
<a href="#l46.109"></a><span id="l46.109"> </span>
<a href="#l46.110"></a><span id="l46.110">         let string = `Assert failed: ${aMessage}\n ${cal.STACK(0, 1)}`;</span>
<a href="#l46.111"></a><span id="l46.111">         if (aCritical) {</span>
<a href="#l46.112"></a><span id="l46.112" class="difflineminus">-            let rescode = aCritical === true ? Components.results.NS_ERROR_UNEXPECTED : aCritical;</span>
<a href="#l46.113"></a><span id="l46.113" class="difflineplus">+            let rescode = aCritical === true ? Cr.NS_ERROR_UNEXPECTED : aCritical;</span>
<a href="#l46.114"></a><span id="l46.114">             throw new Components.Exception(string, rescode);</span>
<a href="#l46.115"></a><span id="l46.115">         } else {</span>
<a href="#l46.116"></a><span id="l46.116" class="difflineminus">-            Components.utils.reportError(string);</span>
<a href="#l46.117"></a><span id="l46.117" class="difflineplus">+            Cu.reportError(string);</span>
<a href="#l46.118"></a><span id="l46.118">         }</span>
<a href="#l46.119"></a><span id="l46.119">     },</span>
<a href="#l46.120"></a><span id="l46.120"> </span>
<a href="#l46.121"></a><span id="l46.121">     /**</span>
<a href="#l46.122"></a><span id="l46.122">      * Generates a QueryInterface method on the given global. To be used as follows:</span>
<a href="#l46.123"></a><span id="l46.123">      *</span>
<a href="#l46.124"></a><span id="l46.124">      *     class calThing {</span>
<a href="#l46.125"></a><span id="l46.125">      *       QueryInterface(aIID) { return cal.generateClassQI(this, aIID, [Ci.calIThing]); }</span>
<a href="#l46.126"></a><span id="l46.126" class="difflineat">@@ -238,17 +238,17 @@ var cal = {</span>
<a href="#l46.127"></a><span id="l46.127">     },</span>
<a href="#l46.128"></a><span id="l46.128"> </span>
<a href="#l46.129"></a><span id="l46.129">     /**</span>
<a href="#l46.130"></a><span id="l46.130">      * Schedules execution of the passed function to the current thread's queue.</span>
<a href="#l46.131"></a><span id="l46.131">      */</span>
<a href="#l46.132"></a><span id="l46.132">     postPone: function(func) {</span>
<a href="#l46.133"></a><span id="l46.133">         if (this.threadingEnabled) {</span>
<a href="#l46.134"></a><span id="l46.134">             Services.tm.currentThread.dispatch({ run: func },</span>
<a href="#l46.135"></a><span id="l46.135" class="difflineminus">-                                               Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l46.136"></a><span id="l46.136" class="difflineplus">+                                               Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l46.137"></a><span id="l46.137">         } else {</span>
<a href="#l46.138"></a><span id="l46.138">             func();</span>
<a href="#l46.139"></a><span id="l46.139">         }</span>
<a href="#l46.140"></a><span id="l46.140">     },</span>
<a href="#l46.141"></a><span id="l46.141"> </span>
<a href="#l46.142"></a><span id="l46.142">     /**</span>
<a href="#l46.143"></a><span id="l46.143">      * Create an adapter for the given interface. If passed, methods will be</span>
<a href="#l46.144"></a><span id="l46.144">      * added to the template object, otherwise a new object will be returned.</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineat">@@ -307,18 +307,17 @@ var cal = {</span>
<a href="#l46.146"></a><span id="l46.146">     },</span>
<a href="#l46.147"></a><span id="l46.147"> </span>
<a href="#l46.148"></a><span id="l46.148">     /**</span>
<a href="#l46.149"></a><span id="l46.149">      * Make a UUID, without enclosing brackets, e.g. 0d3950fd-22e5-4508-91ba-0489bdac513f</span>
<a href="#l46.150"></a><span id="l46.150">      *</span>
<a href="#l46.151"></a><span id="l46.151">      * @return {String}         The generated UUID</span>
<a href="#l46.152"></a><span id="l46.152">      */</span>
<a href="#l46.153"></a><span id="l46.153">     getUUID: function() {</span>
<a href="#l46.154"></a><span id="l46.154" class="difflineminus">-        let uuidGen = Components.classes[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l46.155"></a><span id="l46.155" class="difflineminus">-                                .getService(Components.interfaces.nsIUUIDGenerator);</span>
<a href="#l46.156"></a><span id="l46.156" class="difflineplus">+        let uuidGen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;].getService(Ci.nsIUUIDGenerator);</span>
<a href="#l46.157"></a><span id="l46.157">         // generate uuids without braces to avoid problems with</span>
<a href="#l46.158"></a><span id="l46.158">         // CalDAV servers that don't support filenames with {}</span>
<a href="#l46.159"></a><span id="l46.159">         return uuidGen.generateUUID().toString().replace(/[{}]/g, &quot;&quot;);</span>
<a href="#l46.160"></a><span id="l46.160">     },</span>
<a href="#l46.161"></a><span id="l46.161"> </span>
<a href="#l46.162"></a><span id="l46.162">     /**</span>
<a href="#l46.163"></a><span id="l46.163">      * Adds an observer listening for the topic.</span>
<a href="#l46.164"></a><span id="l46.164">      *</span>
<a href="#l46.165"></a><span id="l46.165" class="difflineat">@@ -446,33 +445,33 @@ XPCOMUtils.defineLazyModuleGetter(cal, &quot;</span>
<a href="#l46.166"></a><span id="l46.166">  * Returns a function that provides access to the given service.</span>
<a href="#l46.167"></a><span id="l46.167">  *</span>
<a href="#l46.168"></a><span id="l46.168">  * @param cid           The contract id to create</span>
<a href="#l46.169"></a><span id="l46.169">  * @param iid           The interface id to create with</span>
<a href="#l46.170"></a><span id="l46.170">  * @return {function}   A function that returns the given service</span>
<a href="#l46.171"></a><span id="l46.171">  */</span>
<a href="#l46.172"></a><span id="l46.172"> function _service(cid, iid) {</span>
<a href="#l46.173"></a><span id="l46.173">     return function() {</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineminus">-        return Components.classes[cid].getService(iid);</span>
<a href="#l46.175"></a><span id="l46.175" class="difflineplus">+        return Cc[cid].getService(iid);</span>
<a href="#l46.176"></a><span id="l46.176">     };</span>
<a href="#l46.177"></a><span id="l46.177"> }</span>
<a href="#l46.178"></a><span id="l46.178"> </span>
<a href="#l46.179"></a><span id="l46.179"> /**</span>
<a href="#l46.180"></a><span id="l46.180">  * Returns a function that creates an instance of the given component and</span>
<a href="#l46.181"></a><span id="l46.181">  * optionally initializes it using the property name passed.</span>
<a href="#l46.182"></a><span id="l46.182">  *</span>
<a href="#l46.183"></a><span id="l46.183">  * @param cid           The contract id to create</span>
<a href="#l46.184"></a><span id="l46.184">  * @param iid           The interface id to create with</span>
<a href="#l46.185"></a><span id="l46.185">  * @param prop          The property name used for initialization</span>
<a href="#l46.186"></a><span id="l46.186">  * @return {function}   A function that creates the given instance, which takes an</span>
<a href="#l46.187"></a><span id="l46.187">  *                          initialization value.</span>
<a href="#l46.188"></a><span id="l46.188">  */</span>
<a href="#l46.189"></a><span id="l46.189"> function _instance(cid, iid, prop) {</span>
<a href="#l46.190"></a><span id="l46.190">     return function(propval) {</span>
<a href="#l46.191"></a><span id="l46.191" class="difflineminus">-        let thing = Components.classes[cid].createInstance(iid);</span>
<a href="#l46.192"></a><span id="l46.192" class="difflineplus">+        let thing = Cc[cid].createInstance(iid);</span>
<a href="#l46.193"></a><span id="l46.193">         if (propval) {</span>
<a href="#l46.194"></a><span id="l46.194">             thing[prop] = propval;</span>
<a href="#l46.195"></a><span id="l46.195">         }</span>
<a href="#l46.196"></a><span id="l46.196">         return thing;</span>
<a href="#l46.197"></a><span id="l46.197">     };</span>
<a href="#l46.198"></a><span id="l46.198"> }</span>
<a href="#l46.199"></a><span id="l46.199"> </span>
<a href="#l46.200"></a><span id="l46.200"> // will be used to clean up global objects on shutdown</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/calendar/base/modules/utils/calAlarmUtils.jsm</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/calendar/base/modules/utils/calAlarmUtils.jsm</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -38,17 +38,17 @@ var calalarms = {</span>
<a href="#l47.4"></a><span id="l47.4"> </span>
<a href="#l47.5"></a><span id="l47.5">             alarmOffset[units] = Preferences.get(&quot;calendar.alarms.&quot; + type + &quot;alarmlen&quot;, 0);</span>
<a href="#l47.6"></a><span id="l47.6">             alarmOffset.normalize();</span>
<a href="#l47.7"></a><span id="l47.7">             alarmOffset.isNegative = true;</span>
<a href="#l47.8"></a><span id="l47.8">             if (type == &quot;todo&quot; &amp;&amp; !aItem.entryDate) {</span>
<a href="#l47.9"></a><span id="l47.9">                 // You can't have an alarm if the entryDate doesn't exist.</span>
<a href="#l47.10"></a><span id="l47.10">                 aItem.entryDate = cal.dtz.now();</span>
<a href="#l47.11"></a><span id="l47.11">             }</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-            alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+            alarm.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l47.14"></a><span id="l47.14">             alarm.offset = alarmOffset;</span>
<a href="#l47.15"></a><span id="l47.15"> </span>
<a href="#l47.16"></a><span id="l47.16">             // Default to a display alarm, unless the calendar doesn't support</span>
<a href="#l47.17"></a><span id="l47.17">             // it or we have no calendar yet. (Man this is hard to wrap)</span>
<a href="#l47.18"></a><span id="l47.18">             let actionValues = (aItem.calendar &amp;&amp;</span>
<a href="#l47.19"></a><span id="l47.19">                                  aItem.calendar.getProperty(&quot;capabilities.alarms.actionValues&quot;)) ||</span>
<a href="#l47.20"></a><span id="l47.20">                                 [&quot;DISPLAY&quot;];</span>
<a href="#l47.21"></a><span id="l47.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/calendar/base/modules/utils/calAsyncUtils.jsm</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/calendar/base/modules/utils/calAsyncUtils.jsm</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -8,18 +8,18 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l48.4"></a><span id="l48.4">  * Asynchronous tools for handling calendar operations</span>
<a href="#l48.5"></a><span id="l48.5">  */</span>
<a href="#l48.6"></a><span id="l48.6"> </span>
<a href="#l48.7"></a><span id="l48.7"> // NOTE: This module should not be loaded directly, it is available when</span>
<a href="#l48.8"></a><span id="l48.8"> // including calUtils.jsm under the cal.async namespace.</span>
<a href="#l48.9"></a><span id="l48.9"> </span>
<a href="#l48.10"></a><span id="l48.10"> this.EXPORTED_SYMBOLS = [&quot;calasync&quot;]; /* exported calasync */</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-var cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-var cIC = Components.interfaces.calICalendar;</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+var cIOL = Ci.calIOperationListener;</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+var cIC = Ci.calICalendar;</span>
<a href="#l48.16"></a><span id="l48.16"> </span>
<a href="#l48.17"></a><span id="l48.17"> var promisifyProxyHandler = {</span>
<a href="#l48.18"></a><span id="l48.18">     promiseOperation: function(target, name, args) {</span>
<a href="#l48.19"></a><span id="l48.19">         let deferred = PromiseUtils.defer();</span>
<a href="#l48.20"></a><span id="l48.20">         let listener = calasync.promiseOperationListener(deferred);</span>
<a href="#l48.21"></a><span id="l48.21">         args.push(listener);</span>
<a href="#l48.22"></a><span id="l48.22">         target[name](...args);</span>
<a href="#l48.23"></a><span id="l48.23">         return deferred.promise;</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineat">@@ -35,17 +35,17 @@ var promisifyProxyHandler = {</span>
<a href="#l48.25"></a><span id="l48.25">             case &quot;getItems&quot;:</span>
<a href="#l48.26"></a><span id="l48.26">                 return (...args) =&gt; this.promiseOperation(target, name, args);</span>
<a href="#l48.27"></a><span id="l48.27">             // calIOfflineStorage methods</span>
<a href="#l48.28"></a><span id="l48.28">             case &quot;addOfflineItem&quot;:</span>
<a href="#l48.29"></a><span id="l48.29">             case &quot;modifyOfflineItem&quot;:</span>
<a href="#l48.30"></a><span id="l48.30">             case &quot;deleteOfflineItem&quot;:</span>
<a href="#l48.31"></a><span id="l48.31">             case &quot;getOfflineItemFlag&quot;:</span>
<a href="#l48.32"></a><span id="l48.32">             case &quot;resetItemOfflineFlag&quot;: {</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineminus">-                let offline = target.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+                let offline = target.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l48.35"></a><span id="l48.35">                 return (...args) =&gt; this.promiseOperation(offline, name, args);</span>
<a href="#l48.36"></a><span id="l48.36">             }</span>
<a href="#l48.37"></a><span id="l48.37"> </span>
<a href="#l48.38"></a><span id="l48.38">             // Special getAllItems shortcut</span>
<a href="#l48.39"></a><span id="l48.39">             case &quot;getAllItems&quot;:</span>
<a href="#l48.40"></a><span id="l48.40">                 return () =&gt; this.promiseOperation(target, &quot;getItems&quot;, [cIC.ITEM_FILTER_ALL_ITEMS, 0, null, null]);</span>
<a href="#l48.41"></a><span id="l48.41">             default:</span>
<a href="#l48.42"></a><span id="l48.42">                 return target[name];</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineat">@@ -103,17 +103,17 @@ var calasync = {</span>
<a href="#l48.44"></a><span id="l48.44">      *     let calendar = cal.async.promisifyCalendar(aItem.calendar);</span>
<a href="#l48.45"></a><span id="l48.45">      *     return calendar.addItem(aItem);</span>
<a href="#l48.46"></a><span id="l48.46">      *   }</span>
<a href="#l48.47"></a><span id="l48.47">      */</span>
<a href="#l48.48"></a><span id="l48.48">     promiseOperationListener: function(deferred) {</span>
<a href="#l48.49"></a><span id="l48.49">         return {</span>
<a href="#l48.50"></a><span id="l48.50">             QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l48.51"></a><span id="l48.51">             items: [],</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-            itemStatus: Components.results.NS_OK,</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+            itemStatus: Cr.NS_OK,</span>
<a href="#l48.54"></a><span id="l48.54">             onGetResult: function(aCalendar, aStatus, aItemType, aDetail,</span>
<a href="#l48.55"></a><span id="l48.55">                                   aCount, aItems) {</span>
<a href="#l48.56"></a><span id="l48.56">                 this.itemStatus = aStatus;</span>
<a href="#l48.57"></a><span id="l48.57">                 if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l48.58"></a><span id="l48.58">                     this.items = this.items.concat(aItems);</span>
<a href="#l48.59"></a><span id="l48.59">                 } else {</span>
<a href="#l48.60"></a><span id="l48.60">                     this.itemSuccess = aStatus;</span>
<a href="#l48.61"></a><span id="l48.61">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/calendar/base/modules/utils/calAuthUtils.jsm</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/calendar/base/modules/utils/calAuthUtils.jsm</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -88,17 +88,17 @@ var calauth = {</span>
<a href="#l49.4"></a><span id="l49.4">         //                    in nsIAuthInformation authInfo)</span>
<a href="#l49.5"></a><span id="l49.5">         promptAuth(aChannel, aLevel, aAuthInfo) {</span>
<a href="#l49.6"></a><span id="l49.6">             let hostRealm = {};</span>
<a href="#l49.7"></a><span id="l49.7">             hostRealm.prePath = aChannel.URI.prePath;</span>
<a href="#l49.8"></a><span id="l49.8">             hostRealm.realm = aAuthInfo.realm;</span>
<a href="#l49.9"></a><span id="l49.9">             let port = aChannel.URI.port;</span>
<a href="#l49.10"></a><span id="l49.10">             if (port == -1) {</span>
<a href="#l49.11"></a><span id="l49.11">                 let handler = Services.io.getProtocolHandler(aChannel.URI.scheme)</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-                                         .QueryInterface(Components.interfaces.nsIProtocolHandler);</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+                                         .QueryInterface(Ci.nsIProtocolHandler);</span>
<a href="#l49.14"></a><span id="l49.14">                 port = handler.defaultPort;</span>
<a href="#l49.15"></a><span id="l49.15">             }</span>
<a href="#l49.16"></a><span id="l49.16">             hostRealm.passwordRealm = aChannel.URI.host + &quot;:&quot; + port + &quot; (&quot; + aAuthInfo.realm + &quot;)&quot;;</span>
<a href="#l49.17"></a><span id="l49.17"> </span>
<a href="#l49.18"></a><span id="l49.18">             let pwInfo = this.getPasswordInfo(hostRealm);</span>
<a href="#l49.19"></a><span id="l49.19">             aAuthInfo.username = pwInfo.username;</span>
<a href="#l49.20"></a><span id="l49.20">             if (pwInfo &amp;&amp; pwInfo.found) {</span>
<a href="#l49.21"></a><span id="l49.21">                 aAuthInfo.password = pwInfo.password;</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineat">@@ -161,18 +161,18 @@ var calauth = {</span>
<a href="#l49.23"></a><span id="l49.23">                     aCallback.onAuthCancelled(aContext, true);</span>
<a href="#l49.24"></a><span id="l49.24">                 }</span>
<a href="#l49.25"></a><span id="l49.25">             };</span>
<a href="#l49.26"></a><span id="l49.26"> </span>
<a href="#l49.27"></a><span id="l49.27">             let hostKey = aChannel.URI.prePath + &quot;:&quot; + aAuthInfo.realm;</span>
<a href="#l49.28"></a><span id="l49.28">             gAuthCache.planForAuthInfo(hostKey);</span>
<a href="#l49.29"></a><span id="l49.29"> </span>
<a href="#l49.30"></a><span id="l49.30">             let queuePrompt = function() {</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-                let asyncprompter = Components.classes[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-                                              .getService(Components.interfaces.nsIMsgAsyncPrompter);</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+                let asyncprompter = Cc[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+                                      .getService(Ci.nsIMsgAsyncPrompter);</span>
<a href="#l49.35"></a><span id="l49.35">                 asyncprompter.queueAsyncAuthPrompt(hostKey, false, promptlistener);</span>
<a href="#l49.36"></a><span id="l49.36">             };</span>
<a href="#l49.37"></a><span id="l49.37"> </span>
<a href="#l49.38"></a><span id="l49.38">             self.mWindow = cal.window.getCalendarWindow();</span>
<a href="#l49.39"></a><span id="l49.39"> </span>
<a href="#l49.40"></a><span id="l49.40">             // the prompt will fail if we are too early</span>
<a href="#l49.41"></a><span id="l49.41">             if (self.mWindow.document.readyState == &quot;complete&quot;) {</span>
<a href="#l49.42"></a><span id="l49.42">                 queuePrompt();</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineat">@@ -194,17 +194,17 @@ var calauth = {</span>
<a href="#l49.44"></a><span id="l49.44">      * @param {Boolean} aFixedUsername          Whether the user name is fixed or editable</span>
<a href="#l49.45"></a><span id="l49.45">      * @return {Boolean}                        Could a password be retrieved?</span>
<a href="#l49.46"></a><span id="l49.46">      */</span>
<a href="#l49.47"></a><span id="l49.47">     getCredentials: function(aTitle, aCalendarName, aUsername, aPassword,</span>
<a href="#l49.48"></a><span id="l49.48">                              aSavePassword, aFixedUsername) {</span>
<a href="#l49.49"></a><span id="l49.49">         if (typeof aUsername != &quot;object&quot; ||</span>
<a href="#l49.50"></a><span id="l49.50">             typeof aPassword != &quot;object&quot; ||</span>
<a href="#l49.51"></a><span id="l49.51">             typeof aSavePassword != &quot;object&quot;) {</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineminus">-            throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+            throw new Components.Exception(&quot;&quot;, Cr.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l49.54"></a><span id="l49.54">         }</span>
<a href="#l49.55"></a><span id="l49.55"> </span>
<a href="#l49.56"></a><span id="l49.56">         let prompter = Services.ww.getNewPrompter(null);</span>
<a href="#l49.57"></a><span id="l49.57"> </span>
<a href="#l49.58"></a><span id="l49.58">         // Only show the save password box if we are supposed to.</span>
<a href="#l49.59"></a><span id="l49.59">         let savepassword = null;</span>
<a href="#l49.60"></a><span id="l49.60">         if (Preferences.get(&quot;signon.rememberSignons&quot;, true)) {</span>
<a href="#l49.61"></a><span id="l49.61">             savepassword = cal.l10n.getAnyString(&quot;passwordmgr&quot;, &quot;passwordmgr&quot;, &quot;rememberPassword&quot;);</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineat">@@ -266,45 +266,45 @@ var calauth = {</span>
<a href="#l49.63"></a><span id="l49.63">         if (!Services.logins.getLoginSavingEnabled(origin)) {</span>
<a href="#l49.64"></a><span id="l49.64">             throw new Components.Exception(&quot;Password saving is disabled for &quot; + origin,</span>
<a href="#l49.65"></a><span id="l49.65">                                            Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l49.66"></a><span id="l49.66">         }</span>
<a href="#l49.67"></a><span id="l49.67"> </span>
<a href="#l49.68"></a><span id="l49.68">         try {</span>
<a href="#l49.69"></a><span id="l49.69">             let logins = Services.logins.findLogins({}, origin, null, aRealm);</span>
<a href="#l49.70"></a><span id="l49.70"> </span>
<a href="#l49.71"></a><span id="l49.71" class="difflineminus">-            let newLoginInfo = Components.classes[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l49.72"></a><span id="l49.72" class="difflineminus">-                                         .createInstance(Components.interfaces.nsILoginInfo);</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineplus">+            let newLoginInfo = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineplus">+                                 .createInstance(Ci.nsILoginInfo);</span>
<a href="#l49.75"></a><span id="l49.75">             newLoginInfo.init(origin, null, aRealm, aUsername, aPassword, &quot;&quot;, &quot;&quot;);</span>
<a href="#l49.76"></a><span id="l49.76">             if (logins.length &gt; 0) {</span>
<a href="#l49.77"></a><span id="l49.77">                 Services.logins.modifyLogin(logins[0], newLoginInfo);</span>
<a href="#l49.78"></a><span id="l49.78">             } else {</span>
<a href="#l49.79"></a><span id="l49.79">                 Services.logins.addLogin(newLoginInfo);</span>
<a href="#l49.80"></a><span id="l49.80">             }</span>
<a href="#l49.81"></a><span id="l49.81">         } catch (exc) {</span>
<a href="#l49.82"></a><span id="l49.82">             // Only show the message if its not an abort, which can happen if</span>
<a href="#l49.83"></a><span id="l49.83">             // the user canceled the master password dialog</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineminus">-            cal.ASSERT(exc.result == Components.results.NS_ERROR_ABORT, exc);</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+            cal.ASSERT(exc.result == Cr.NS_ERROR_ABORT, exc);</span>
<a href="#l49.86"></a><span id="l49.86">         }</span>
<a href="#l49.87"></a><span id="l49.87">     },</span>
<a href="#l49.88"></a><span id="l49.88"> </span>
<a href="#l49.89"></a><span id="l49.89">     /**</span>
<a href="#l49.90"></a><span id="l49.90">      * Helper to retrieve an entry from the password manager.</span>
<a href="#l49.91"></a><span id="l49.91">      *</span>
<a href="#l49.92"></a><span id="l49.92">      * @param {String} aUsername    The username to search</span>
<a href="#l49.93"></a><span id="l49.93">      * @param {String} aPassword    The corresponding password</span>
<a href="#l49.94"></a><span id="l49.94">      * @param {String} aOrigin      The corresponding origin</span>
<a href="#l49.95"></a><span id="l49.95">      * @param {String} aRealm       The password realm (unused on branch)</span>
<a href="#l49.96"></a><span id="l49.96">      * @return {Boolean}            True, if an entry exists in the password manager</span>
<a href="#l49.97"></a><span id="l49.97">      */</span>
<a href="#l49.98"></a><span id="l49.98">     passwordManagerGet: function(aUsername, aPassword, aOrigin, aRealm) {</span>
<a href="#l49.99"></a><span id="l49.99">         cal.ASSERT(aUsername);</span>
<a href="#l49.100"></a><span id="l49.100"> </span>
<a href="#l49.101"></a><span id="l49.101">         if (typeof aPassword != &quot;object&quot;) {</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineminus">-            throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+            throw new Components.Exception(&quot;&quot;, Cr.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l49.104"></a><span id="l49.104">         }</span>
<a href="#l49.105"></a><span id="l49.105"> </span>
<a href="#l49.106"></a><span id="l49.106">         let origin = this._ensureOrigin(aOrigin);</span>
<a href="#l49.107"></a><span id="l49.107"> </span>
<a href="#l49.108"></a><span id="l49.108">         try {</span>
<a href="#l49.109"></a><span id="l49.109">             let logins = Services.logins.findLogins({}, origin, null, aRealm);</span>
<a href="#l49.110"></a><span id="l49.110">             for (let loginInfo of logins) {</span>
<a href="#l49.111"></a><span id="l49.111">                 if (loginInfo.username == aUsername) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/calendar/base/modules/utils/calDataUtils.jsm</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/calendar/base/modules/utils/calDataUtils.jsm</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -35,17 +35,17 @@ class ListenerSet extends Set {</span>
<a href="#l50.4"></a><span id="l50.4"> </span>
<a href="#l50.5"></a><span id="l50.5">     notify(func, args=[]) {</span>
<a href="#l50.6"></a><span id="l50.6">         let currentObservers = [...this.values()];</span>
<a href="#l50.7"></a><span id="l50.7">         for (let observer of currentObservers) {</span>
<a href="#l50.8"></a><span id="l50.8">             try {</span>
<a href="#l50.9"></a><span id="l50.9">                 observer[func](...args);</span>
<a href="#l50.10"></a><span id="l50.10">             } catch (exc) {</span>
<a href="#l50.11"></a><span id="l50.11">                 let stack = exc.stack || (exc.location ? exc.location.formattedStack : null);</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-                Components.utils.reportError(exc + &quot;\nSTACK: &quot; + stack);</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+                Cu.reportError(exc + &quot;\nSTACK: &quot; + stack);</span>
<a href="#l50.14"></a><span id="l50.14">             }</span>
<a href="#l50.15"></a><span id="l50.15">         }</span>
<a href="#l50.16"></a><span id="l50.16">     }</span>
<a href="#l50.17"></a><span id="l50.17"> }</span>
<a href="#l50.18"></a><span id="l50.18"> </span>
<a href="#l50.19"></a><span id="l50.19"> class ObserverSet extends ListenerSet {</span>
<a href="#l50.20"></a><span id="l50.20">     constructor(iid, iterable) {</span>
<a href="#l50.21"></a><span id="l50.21">         super(iid, iterable);</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -100,17 +100,17 @@ class OperationGroup {</span>
<a href="#l50.23"></a><span id="l50.23">     }</span>
<a href="#l50.24"></a><span id="l50.24"> </span>
<a href="#l50.25"></a><span id="l50.25">     constructor(aCancelFunc) {</span>
<a href="#l50.26"></a><span id="l50.26">         this.mId = cal.getUUID() + &quot;-&quot; + OperationGroup.nextGroupId();</span>
<a href="#l50.27"></a><span id="l50.27">         this.mIsPending = true;</span>
<a href="#l50.28"></a><span id="l50.28"> </span>
<a href="#l50.29"></a><span id="l50.29">         this.mCancelFunc = aCancelFunc;</span>
<a href="#l50.30"></a><span id="l50.30">         this.mSubOperations = [];</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-        this.mStatus = Components.results.NS_OK;</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+        this.mStatus = Cr.NS_OK;</span>
<a href="#l50.33"></a><span id="l50.33">     }</span>
<a href="#l50.34"></a><span id="l50.34"> </span>
<a href="#l50.35"></a><span id="l50.35">     get id() { return this.mId; }</span>
<a href="#l50.36"></a><span id="l50.36">     get isPending() { return this.mIsPending; }</span>
<a href="#l50.37"></a><span id="l50.37">     get status() { return this.mStatus; }</span>
<a href="#l50.38"></a><span id="l50.38">     get isEmpty() { return this.mSubOperations.length == 0; }</span>
<a href="#l50.39"></a><span id="l50.39"> </span>
<a href="#l50.40"></a><span id="l50.40">     add(aOperation) {</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineat">@@ -130,28 +130,28 @@ class OperationGroup {</span>
<a href="#l50.42"></a><span id="l50.42">         if (this.isPending) {</span>
<a href="#l50.43"></a><span id="l50.43">             this.mIsPending = false;</span>
<a href="#l50.44"></a><span id="l50.44">             if (aStatus) {</span>
<a href="#l50.45"></a><span id="l50.45">                 this.mStatus = aStatus;</span>
<a href="#l50.46"></a><span id="l50.46">             }</span>
<a href="#l50.47"></a><span id="l50.47">         }</span>
<a href="#l50.48"></a><span id="l50.48">     }</span>
<a href="#l50.49"></a><span id="l50.49"> </span>
<a href="#l50.50"></a><span id="l50.50" class="difflineminus">-    cancel(aStatus=Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineplus">+    cancel(aStatus=Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l50.52"></a><span id="l50.52">         if (this.isPending) {</span>
<a href="#l50.53"></a><span id="l50.53">             this.notifyCompleted(aStatus);</span>
<a href="#l50.54"></a><span id="l50.54">             let cancelFunc = this.mCancelFunc;</span>
<a href="#l50.55"></a><span id="l50.55">             if (cancelFunc) {</span>
<a href="#l50.56"></a><span id="l50.56">                 this.mCancelFunc = null;</span>
<a href="#l50.57"></a><span id="l50.57">                 cancelFunc();</span>
<a href="#l50.58"></a><span id="l50.58">             }</span>
<a href="#l50.59"></a><span id="l50.59">             let subOperations = this.mSubOperations;</span>
<a href="#l50.60"></a><span id="l50.60">             this.mSubOperations = [];</span>
<a href="#l50.61"></a><span id="l50.61">             for (let operation of subOperations) {</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineminus">-                operation.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+                operation.cancel(Ci.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l50.64"></a><span id="l50.64">             }</span>
<a href="#l50.65"></a><span id="l50.65">         }</span>
<a href="#l50.66"></a><span id="l50.66">     }</span>
<a href="#l50.67"></a><span id="l50.67"> </span>
<a href="#l50.68"></a><span id="l50.68">     toString() {</span>
<a href="#l50.69"></a><span id="l50.69">         return `[OperationGroup id=${this.id}]`;</span>
<a href="#l50.70"></a><span id="l50.70">     }</span>
<a href="#l50.71"></a><span id="l50.71"> }</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineat">@@ -278,22 +278,22 @@ var caldata = {</span>
<a href="#l50.73"></a><span id="l50.73">     compareObjects: function(aObject, aOtherObject, aIID) {</span>
<a href="#l50.74"></a><span id="l50.74">         // xxx todo: seems to work fine e.g. for WCAP, but I still mistrust this trickery...</span>
<a href="#l50.75"></a><span id="l50.75">         //           Anybody knows an official API that could be used for this purpose?</span>
<a href="#l50.76"></a><span id="l50.76">         //           For what reason do clients need to pass aIID since</span>
<a href="#l50.77"></a><span id="l50.77">         //           every XPCOM object has to implement nsISupports?</span>
<a href="#l50.78"></a><span id="l50.78">         //           XPCOM (like COM, like UNO, ...) defines that QueryInterface *only* needs to return</span>
<a href="#l50.79"></a><span id="l50.79">         //           the very same pointer for nsISupports during its lifetime.</span>
<a href="#l50.80"></a><span id="l50.80">         if (!aIID) {</span>
<a href="#l50.81"></a><span id="l50.81" class="difflineminus">-            aIID = Components.interfaces.nsISupports;</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineplus">+            aIID = Ci.nsISupports;</span>
<a href="#l50.83"></a><span id="l50.83">         }</span>
<a href="#l50.84"></a><span id="l50.84" class="difflineminus">-        let sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineminus">-                             .createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l50.86"></a><span id="l50.86" class="difflineplus">+        let sip1 = Cc[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l50.87"></a><span id="l50.87" class="difflineplus">+                     .createInstance(Ci.nsISupportsInterfacePointer);</span>
<a href="#l50.88"></a><span id="l50.88">         sip1.data = aObject;</span>
<a href="#l50.89"></a><span id="l50.89">         sip1.dataIID = aIID;</span>
<a href="#l50.90"></a><span id="l50.90"> </span>
<a href="#l50.91"></a><span id="l50.91" class="difflineminus">-        let sip2 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineminus">-                             .createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineplus">+        let sip2 = Cc[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineplus">+                     .createInstance(Ci.nsISupportsInterfacePointer);</span>
<a href="#l50.95"></a><span id="l50.95">         sip2.data = aOtherObject;</span>
<a href="#l50.96"></a><span id="l50.96">         sip2.dataIID = aIID;</span>
<a href="#l50.97"></a><span id="l50.97">         return sip1.data == sip2.data;</span>
<a href="#l50.98"></a><span id="l50.98">     }</span>
<a href="#l50.99"></a><span id="l50.99"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/calendar/base/modules/utils/calDateTimeUtils.jsm</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/calendar/base/modules/utils/calDateTimeUtils.jsm</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -114,30 +114,30 @@ var caldtz = {</span>
<a href="#l51.4"></a><span id="l51.4">      * event's start date or a task's entry date.</span>
<a href="#l51.5"></a><span id="l51.5">      */</span>
<a href="#l51.6"></a><span id="l51.6">     startDateProp: function(aItem) {</span>
<a href="#l51.7"></a><span id="l51.7">         if (cal.item.isEvent(aItem)) {</span>
<a href="#l51.8"></a><span id="l51.8">             return &quot;startDate&quot;;</span>
<a href="#l51.9"></a><span id="l51.9">         } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l51.10"></a><span id="l51.10">             return &quot;entryDate&quot;;</span>
<a href="#l51.11"></a><span id="l51.11">         }</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l51.14"></a><span id="l51.14">     },</span>
<a href="#l51.15"></a><span id="l51.15"> </span>
<a href="#l51.16"></a><span id="l51.16">     /**</span>
<a href="#l51.17"></a><span id="l51.17">      * Returns the property name used for the end date of an item, ie either an</span>
<a href="#l51.18"></a><span id="l51.18">      * event's end date or a task's due date.</span>
<a href="#l51.19"></a><span id="l51.19">      */</span>
<a href="#l51.20"></a><span id="l51.20">     endDateProp: function(aItem) {</span>
<a href="#l51.21"></a><span id="l51.21">         if (cal.item.isEvent(aItem)) {</span>
<a href="#l51.22"></a><span id="l51.22">             return &quot;endDate&quot;;</span>
<a href="#l51.23"></a><span id="l51.23">         } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l51.24"></a><span id="l51.24">             return &quot;dueDate&quot;;</span>
<a href="#l51.25"></a><span id="l51.25">         }</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l51.28"></a><span id="l51.28">     },</span>
<a href="#l51.29"></a><span id="l51.29"> </span>
<a href="#l51.30"></a><span id="l51.30">     /**</span>
<a href="#l51.31"></a><span id="l51.31">      * Check if the two dates are on the same day (ignoring time)</span>
<a href="#l51.32"></a><span id="l51.32">      *</span>
<a href="#l51.33"></a><span id="l51.33">      * @param date1     The left date to compare</span>
<a href="#l51.34"></a><span id="l51.34">      * @param date2     The right date to compare</span>
<a href="#l51.35"></a><span id="l51.35">      * @return          True, if dates are on the same day</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/calendar/base/modules/utils/calEmailUtils.jsm</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/calendar/base/modules/utils/calEmailUtils.jsm</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -23,46 +23,46 @@ var calemail = {</span>
<a href="#l52.4"></a><span id="l52.4">      * to create a recipient list string.</span>
<a href="#l52.5"></a><span id="l52.5">      *</span>
<a href="#l52.6"></a><span id="l52.6">      * @param {String} aRecipient       The email recipients string.</span>
<a href="#l52.7"></a><span id="l52.7">      * @param {String} aSubject         The email subject.</span>
<a href="#l52.8"></a><span id="l52.8">      * @param {String} aBody            The encoded email body text.</span>
<a href="#l52.9"></a><span id="l52.9">      * @param {nsIMsgIdentity} aIdentity    The email identity to use for sending</span>
<a href="#l52.10"></a><span id="l52.10">      */</span>
<a href="#l52.11"></a><span id="l52.11">     sendTo: function(aRecipient, aSubject, aBody, aIdentity) {</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-        let msgParams = Components.classes[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-                                  .createInstance(Components.interfaces.nsIMsgComposeParams);</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineminus">-        let composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineminus">-                                      .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+        let msgParams = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+                          .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+        let composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineplus">+                              .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l52.20"></a><span id="l52.20"> </span>
<a href="#l52.21"></a><span id="l52.21">         composeFields.to = aRecipient;</span>
<a href="#l52.22"></a><span id="l52.22">         composeFields.subject = aSubject;</span>
<a href="#l52.23"></a><span id="l52.23">         composeFields.body = aBody;</span>
<a href="#l52.24"></a><span id="l52.24"> </span>
<a href="#l52.25"></a><span id="l52.25" class="difflineminus">-        msgParams.type = Components.interfaces.nsIMsgCompType.New;</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineminus">-        msgParams.format = Components.interfaces.nsIMsgCompFormat.Default;</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineplus">+        msgParams.type = Ci.nsIMsgCompType.New;</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineplus">+        msgParams.format = Ci.nsIMsgCompFormat.Default;</span>
<a href="#l52.29"></a><span id="l52.29">         msgParams.composeFields = composeFields;</span>
<a href="#l52.30"></a><span id="l52.30">         msgParams.identity = aIdentity;</span>
<a href="#l52.31"></a><span id="l52.31"> </span>
<a href="#l52.32"></a><span id="l52.32">         MailServices.compose.OpenComposeWindowWithParams(null, msgParams);</span>
<a href="#l52.33"></a><span id="l52.33">     },</span>
<a href="#l52.34"></a><span id="l52.34"> </span>
<a href="#l52.35"></a><span id="l52.35">     /**</span>
<a href="#l52.36"></a><span id="l52.36">      * Iterates all email identities and calls the passed function with identity and account.</span>
<a href="#l52.37"></a><span id="l52.37">      * If the called function returns false, iteration is stopped.</span>
<a href="#l52.38"></a><span id="l52.38">      *</span>
<a href="#l52.39"></a><span id="l52.39">      * @param {Function} aFunc       The function to be called for each identity and account</span>
<a href="#l52.40"></a><span id="l52.40">      */</span>
<a href="#l52.41"></a><span id="l52.41">     iterateIdentities: function(aFunc) {</span>
<a href="#l52.42"></a><span id="l52.42">         let accounts = MailServices.accounts.accounts;</span>
<a href="#l52.43"></a><span id="l52.43">         for (let i = 0; i &lt; accounts.length; ++i) {</span>
<a href="#l52.44"></a><span id="l52.44" class="difflineminus">-            let account = accounts.queryElementAt(i, Components.interfaces.nsIMsgAccount);</span>
<a href="#l52.45"></a><span id="l52.45" class="difflineplus">+            let account = accounts.queryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l52.46"></a><span id="l52.46">             let identities = account.identities;</span>
<a href="#l52.47"></a><span id="l52.47">             for (let j = 0; j &lt; identities.length; ++j) {</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineminus">-                let identity = identities.queryElementAt(j, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l52.49"></a><span id="l52.49" class="difflineplus">+                let identity = identities.queryElementAt(j, Ci.nsIMsgIdentity);</span>
<a href="#l52.50"></a><span id="l52.50">                 if (!aFunc(identity, account)) {</span>
<a href="#l52.51"></a><span id="l52.51">                     break;</span>
<a href="#l52.52"></a><span id="l52.52">                 }</span>
<a href="#l52.53"></a><span id="l52.53">             }</span>
<a href="#l52.54"></a><span id="l52.54">         }</span>
<a href="#l52.55"></a><span id="l52.55">     },</span>
<a href="#l52.56"></a><span id="l52.56"> </span>
<a href="#l52.57"></a><span id="l52.57">     /**</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineat">@@ -134,18 +134,18 @@ var calemail = {</span>
<a href="#l52.59"></a><span id="l52.59"> </span>
<a href="#l52.60"></a><span id="l52.60">     /**</span>
<a href="#l52.61"></a><span id="l52.61">      * Returns a basically checked recipient list - malformed elements will be removed</span>
<a href="#l52.62"></a><span id="l52.62">      *</span>
<a href="#l52.63"></a><span id="l52.63">      * @param {String} aRecipients      A comma-seperated list of e-mail addresses</span>
<a href="#l52.64"></a><span id="l52.64">      * @return {String}                 A validated comma-seperated list of e-mail addresses</span>
<a href="#l52.65"></a><span id="l52.65">      */</span>
<a href="#l52.66"></a><span id="l52.66">     validateRecipientList: function(aRecipients) {</span>
<a href="#l52.67"></a><span id="l52.67" class="difflineminus">-        let compFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l52.69"></a><span id="l52.69" class="difflineplus">+        let compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l52.70"></a><span id="l52.70" class="difflineplus">+                           .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l52.71"></a><span id="l52.71">         // Resolve the list considering also configured common names</span>
<a href="#l52.72"></a><span id="l52.72">         let members = compFields.splitRecipients(aRecipients, false, {});</span>
<a href="#l52.73"></a><span id="l52.73">         let list = [];</span>
<a href="#l52.74"></a><span id="l52.74">         let prefix = &quot;&quot;;</span>
<a href="#l52.75"></a><span id="l52.75">         for (let member of members) {</span>
<a href="#l52.76"></a><span id="l52.76">             if (prefix != &quot;&quot;) {</span>
<a href="#l52.77"></a><span id="l52.77">                 // the previous member had no email address - this happens if a recipients CN</span>
<a href="#l52.78"></a><span id="l52.78">                 // contains a ',' or ';' (splitRecipients(..) behaves wrongly here and produces an</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/calendar/base/modules/utils/calItemUtils.jsm</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/calendar/base/modules/utils/calItemUtils.jsm</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -228,27 +228,27 @@ var calitem = {</span>
<a href="#l53.4"></a><span id="l53.4"> </span>
<a href="#l53.5"></a><span id="l53.5">     /**</span>
<a href="#l53.6"></a><span id="l53.6">      * Determines whether or not the aObject is a calIEvent</span>
<a href="#l53.7"></a><span id="l53.7">      *</span>
<a href="#l53.8"></a><span id="l53.8">      * @param aObject  the object to test</span>
<a href="#l53.9"></a><span id="l53.9">      * @returns        true if the object is a calIEvent, false otherwise</span>
<a href="#l53.10"></a><span id="l53.10">      */</span>
<a href="#l53.11"></a><span id="l53.11">     isEvent: function(aObject) {</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-        return cal.wrapInstance(aObject, Components.interfaces.calIEvent) != null;</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+        return cal.wrapInstance(aObject, Ci.calIEvent) != null;</span>
<a href="#l53.14"></a><span id="l53.14">     },</span>
<a href="#l53.15"></a><span id="l53.15"> </span>
<a href="#l53.16"></a><span id="l53.16">     /**</span>
<a href="#l53.17"></a><span id="l53.17">      * Determines whether or not the aObject is a calITodo</span>
<a href="#l53.18"></a><span id="l53.18">      *</span>
<a href="#l53.19"></a><span id="l53.19">      * @param aObject  the object to test</span>
<a href="#l53.20"></a><span id="l53.20">      * @returns        true if the object is a calITodo, false otherwise</span>
<a href="#l53.21"></a><span id="l53.21">      */</span>
<a href="#l53.22"></a><span id="l53.22">     isToDo: function(aObject) {</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineminus">-        return cal.wrapInstance(aObject, Components.interfaces.calITodo) != null;</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+        return cal.wrapInstance(aObject, Ci.calITodo) != null;</span>
<a href="#l53.25"></a><span id="l53.25">     },</span>
<a href="#l53.26"></a><span id="l53.26"> </span>
<a href="#l53.27"></a><span id="l53.27">     /**</span>
<a href="#l53.28"></a><span id="l53.28">      * Checks whether the passed item fits into the demanded range.</span>
<a href="#l53.29"></a><span id="l53.29">      *</span>
<a href="#l53.30"></a><span id="l53.30">      * @param item               the item</span>
<a href="#l53.31"></a><span id="l53.31">      * @param rangeStart         (inclusive) range start or null (open range)</span>
<a href="#l53.32"></a><span id="l53.32">      * @param rangeStart         (exclusive) range end or null (open range)</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineat">@@ -537,18 +537,18 @@ var calitem = {</span>
<a href="#l53.34"></a><span id="l53.34">         }</span>
<a href="#l53.35"></a><span id="l53.35">         return newItem;</span>
<a href="#l53.36"></a><span id="l53.36">     },</span>
<a href="#l53.37"></a><span id="l53.37"> </span>
<a href="#l53.38"></a><span id="l53.38">     /**</span>
<a href="#l53.39"></a><span id="l53.39">      * Shortcut function to serialize an item (including all overridden items).</span>
<a href="#l53.40"></a><span id="l53.40">      */</span>
<a href="#l53.41"></a><span id="l53.41">     serialize: function(aItem) {</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineminus">-        let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineminus">-                                   .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineplus">+        let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+                           .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l53.46"></a><span id="l53.46">         serializer.addItems([aItem], 1);</span>
<a href="#l53.47"></a><span id="l53.47">         return serializer.serializeToString();</span>
<a href="#l53.48"></a><span id="l53.48">     },</span>
<a href="#l53.49"></a><span id="l53.49"> </span>
<a href="#l53.50"></a><span id="l53.50">     /**</span>
<a href="#l53.51"></a><span id="l53.51">      * Centralized funtions for accessing prodid and version</span>
<a href="#l53.52"></a><span id="l53.52">      */</span>
<a href="#l53.53"></a><span id="l53.53">     get productId() { return &quot;-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;; },</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineat">@@ -559,19 +559,19 @@ var calitem = {</span>
<a href="#l53.55"></a><span id="l53.55">      * ical component.  This should be used whenever you need to set the prodid</span>
<a href="#l53.56"></a><span id="l53.56">      * and version on a calIcalComponent object.</span>
<a href="#l53.57"></a><span id="l53.57">      *</span>
<a href="#l53.58"></a><span id="l53.58">      * @param aIcalComponent        The ical component to set the prodid and</span>
<a href="#l53.59"></a><span id="l53.59">      *                                version on.</span>
<a href="#l53.60"></a><span id="l53.60">      */</span>
<a href="#l53.61"></a><span id="l53.61">     setStaticProps: function(aIcalComponent) {</span>
<a href="#l53.62"></a><span id="l53.62">         // Throw for an invalid parameter</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineminus">-        aIcalComponent = cal.wrapInstance(aIcalComponent, Components.interfaces.calIIcalComponent);</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineplus">+        aIcalComponent = cal.wrapInstance(aIcalComponent, Ci.calIIcalComponent);</span>
<a href="#l53.65"></a><span id="l53.65">         if (!aIcalComponent) {</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l53.68"></a><span id="l53.68">         }</span>
<a href="#l53.69"></a><span id="l53.69">         // Set the prodid and version</span>
<a href="#l53.70"></a><span id="l53.70">         aIcalComponent.prodid = calitem.productId;</span>
<a href="#l53.71"></a><span id="l53.71">         aIcalComponent.version = calitem.productVersion;</span>
<a href="#l53.72"></a><span id="l53.72">     },</span>
<a href="#l53.73"></a><span id="l53.73"> </span>
<a href="#l53.74"></a><span id="l53.74">     /**</span>
<a href="#l53.75"></a><span id="l53.75">      * Search for already open item dialog.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/calendar/base/modules/utils/calItipUtils.jsm</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/calendar/base/modules/utils/calItipUtils.jsm</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -25,17 +25,17 @@ var calitip = {</span>
<a href="#l54.4"></a><span id="l54.4">      *</span>
<a href="#l54.5"></a><span id="l54.5">      * @param {calIAttendee|calIItemBase} aItem     The item or attendee to get the sequence info</span>
<a href="#l54.6"></a><span id="l54.6">      *                                                from.</span>
<a href="#l54.7"></a><span id="l54.7">      * @return {Number}                             The sequence number</span>
<a href="#l54.8"></a><span id="l54.8">      */</span>
<a href="#l54.9"></a><span id="l54.9">     getSequence: function(aItem) {</span>
<a href="#l54.10"></a><span id="l54.10">         let seq = null;</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-        let wrappedItem = cal.wrapInstance(aItem, Components.interfaces.calIAttendee);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+        let wrappedItem = cal.wrapInstance(aItem, Ci.calIAttendee);</span>
<a href="#l54.14"></a><span id="l54.14">         if (wrappedItem) {</span>
<a href="#l54.15"></a><span id="l54.15">             seq = wrappedItem.getProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l54.16"></a><span id="l54.16">         } else if (aItem) {</span>
<a href="#l54.17"></a><span id="l54.17">             // Unless the below is standardized, we store the last original</span>
<a href="#l54.18"></a><span id="l54.18">             // REQUEST/PUBLISH SEQUENCE in X-MOZ-RECEIVED-SEQUENCE to test against it</span>
<a href="#l54.19"></a><span id="l54.19">             // when updates come in:</span>
<a href="#l54.20"></a><span id="l54.20">             seq = aItem.getProperty(&quot;X-MOZ-RECEIVED-SEQUENCE&quot;);</span>
<a href="#l54.21"></a><span id="l54.21">             if (seq === null) {</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineat">@@ -62,17 +62,17 @@ var calitip = {</span>
<a href="#l54.23"></a><span id="l54.23">      * see &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.2&gt;.</span>
<a href="#l54.24"></a><span id="l54.24">      *</span>
<a href="#l54.25"></a><span id="l54.25">      * @param {calIAttendee|calIItemBase} aItem     The item or attendee to retrieve the stamp from</span>
<a href="#l54.26"></a><span id="l54.26">      * @return {calIDateTime}                       The timestamp for the item</span>
<a href="#l54.27"></a><span id="l54.27">      */</span>
<a href="#l54.28"></a><span id="l54.28">     getStamp: function(aItem) {</span>
<a href="#l54.29"></a><span id="l54.29">         let dtstamp = null;</span>
<a href="#l54.30"></a><span id="l54.30"> </span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-        let wrappedItem = cal.wrapInstance(aItem, Components.interfaces.calIAttendee);</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineplus">+        let wrappedItem = cal.wrapInstance(aItem, Ci.calIAttendee);</span>
<a href="#l54.33"></a><span id="l54.33">         if (wrappedItem) {</span>
<a href="#l54.34"></a><span id="l54.34">             let stamp = wrappedItem.getProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l54.35"></a><span id="l54.35">             if (stamp) {</span>
<a href="#l54.36"></a><span id="l54.36">                 dtstamp = cal.createDateTime(stamp);</span>
<a href="#l54.37"></a><span id="l54.37">             }</span>
<a href="#l54.38"></a><span id="l54.38">         } else if (aItem) {</span>
<a href="#l54.39"></a><span id="l54.39">             // Unless the below is standardized, we store the last original</span>
<a href="#l54.40"></a><span id="l54.40">             // REQUEST/PUBLISH DTSTAMP in X-MOZ-RECEIVED-DTSTAMP to test against it</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineat">@@ -176,17 +176,17 @@ var calitip = {</span>
<a href="#l54.42"></a><span id="l54.42">         // Get the recipient identity and save it with the itip item.</span>
<a href="#l54.43"></a><span id="l54.43">         itipItem.identity = calitip.getMessageRecipient(aMsgHdr);</span>
<a href="#l54.44"></a><span id="l54.44"> </span>
<a href="#l54.45"></a><span id="l54.45">         // We are only called upon receipt of an invite, so ensure that isSend</span>
<a href="#l54.46"></a><span id="l54.46">         // is false.</span>
<a href="#l54.47"></a><span id="l54.47">         itipItem.isSend = false;</span>
<a href="#l54.48"></a><span id="l54.48"> </span>
<a href="#l54.49"></a><span id="l54.49">         // XXX Get these from preferences</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineminus">-        itipItem.autoResponse = Components.interfaces.calIItipItem.USER;</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineplus">+        itipItem.autoResponse = Ci.calIItipItem.USER;</span>
<a href="#l54.52"></a><span id="l54.52"> </span>
<a href="#l54.53"></a><span id="l54.53">         if (imipMethod &amp;&amp; imipMethod.length != 0 &amp;&amp; imipMethod.toLowerCase() != &quot;nomethod&quot;) {</span>
<a href="#l54.54"></a><span id="l54.54">             itipItem.receivedMethod = imipMethod.toUpperCase();</span>
<a href="#l54.55"></a><span id="l54.55">         } else { // There is no METHOD in the content-type header (spec violation).</span>
<a href="#l54.56"></a><span id="l54.56">                  // Fall back to using the one from the itipItem's ICS.</span>
<a href="#l54.57"></a><span id="l54.57">             imipMethod = itipItem.receivedMethod;</span>
<a href="#l54.58"></a><span id="l54.58">         }</span>
<a href="#l54.59"></a><span id="l54.59">         cal.LOG(&quot;iTIP method: &quot; + imipMethod);</span>
<a href="#l54.60"></a><span id="l54.60" class="difflineat">@@ -194,18 +194,18 @@ var calitip = {</span>
<a href="#l54.61"></a><span id="l54.61">         let isWritableCalendar = function(aCalendar) {</span>
<a href="#l54.62"></a><span id="l54.62">             /* TODO: missing ACL check for existing items (require callback API) */</span>
<a href="#l54.63"></a><span id="l54.63">             return calitip.isSchedulingCalendar(aCalendar) &amp;&amp;</span>
<a href="#l54.64"></a><span id="l54.64">                    cal.acl.userCanAddItemsToCalendar(aCalendar);</span>
<a href="#l54.65"></a><span id="l54.65">         };</span>
<a href="#l54.66"></a><span id="l54.66"> </span>
<a href="#l54.67"></a><span id="l54.67">         let writableCalendars = cal.getCalendarManager().getCalendars({}).filter(isWritableCalendar);</span>
<a href="#l54.68"></a><span id="l54.68">         if (writableCalendars.length &gt; 0) {</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineminus">-            let compCal = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineminus">-                                    .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineplus">+            let compCal = Cc[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineplus">+                            .createInstance(Ci.calICompositeCalendar);</span>
<a href="#l54.73"></a><span id="l54.73">             writableCalendars.forEach(compCal.addCalendar, compCal);</span>
<a href="#l54.74"></a><span id="l54.74">             itipItem.targetCalendar = compCal;</span>
<a href="#l54.75"></a><span id="l54.75">         }</span>
<a href="#l54.76"></a><span id="l54.76">     },</span>
<a href="#l54.77"></a><span id="l54.77"> </span>
<a href="#l54.78"></a><span id="l54.78">     /**</span>
<a href="#l54.79"></a><span id="l54.79">      * Scope: iTIP message receiver</span>
<a href="#l54.80"></a><span id="l54.80">      *</span>
<a href="#l54.81"></a><span id="l54.81" class="difflineat">@@ -213,17 +213,17 @@ var calitip = {</span>
<a href="#l54.82"></a><span id="l54.82">      * This text is ready localized and can be displayed to the user.</span>
<a href="#l54.83"></a><span id="l54.83">      *</span>
<a href="#l54.84"></a><span id="l54.84">      * @param {Number} aStatus         The status of the processing (i.e NS_OK, an error code)</span>
<a href="#l54.85"></a><span id="l54.85">      * @param {Number} aOperationType  An operation type from calIOperationListener</span>
<a href="#l54.86"></a><span id="l54.86">      * @return {String}                The suggested text.</span>
<a href="#l54.87"></a><span id="l54.87">      */</span>
<a href="#l54.88"></a><span id="l54.88">     getCompleteText: function(aStatus, aOperationType) {</span>
<a href="#l54.89"></a><span id="l54.89">         let text = &quot;&quot;;</span>
<a href="#l54.90"></a><span id="l54.90" class="difflineminus">-        const cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l54.91"></a><span id="l54.91" class="difflineplus">+        const cIOL = Ci.calIOperationListener;</span>
<a href="#l54.92"></a><span id="l54.92">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l54.93"></a><span id="l54.93">             switch (aOperationType) {</span>
<a href="#l54.94"></a><span id="l54.94">                 case cIOL.ADD: text = cal.l10n.getLtnString(&quot;imipAddedItemToCal2&quot;); break;</span>
<a href="#l54.95"></a><span id="l54.95">                 case cIOL.MODIFY: text = cal.l10n.getLtnString(&quot;imipUpdatedItem2&quot;); break;</span>
<a href="#l54.96"></a><span id="l54.96">                 case cIOL.DELETE: text = cal.l10n.getLtnString(&quot;imipCanceledItem2&quot;); break;</span>
<a href="#l54.97"></a><span id="l54.97">             }</span>
<a href="#l54.98"></a><span id="l54.98">         } else {</span>
<a href="#l54.99"></a><span id="l54.99">             text = cal.l10n.getLtnString(&quot;imipBarProcessingFailed&quot;, [aStatus.toString(16)]);</span>
<a href="#l54.100"></a><span id="l54.100" class="difflineat">@@ -283,17 +283,17 @@ var calitip = {</span>
<a href="#l54.101"></a><span id="l54.101">         let data = { label: imipLabel, showItems: [], hideItems: [] };</span>
<a href="#l54.102"></a><span id="l54.102">         let separateButtons = Preferences.get(&quot;calendar.itip.separateInvitationButtons&quot;, false);</span>
<a href="#l54.103"></a><span id="l54.103"> </span>
<a href="#l54.104"></a><span id="l54.104">         let disallowedCounter = false;</span>
<a href="#l54.105"></a><span id="l54.105">         if (foundItems &amp;&amp; foundItems.length) {</span>
<a href="#l54.106"></a><span id="l54.106">             let disallow = foundItems[0].getProperty(&quot;X-MICROSOFT-DISALLOW-COUNTER&quot;);</span>
<a href="#l54.107"></a><span id="l54.107">             disallowedCounter = disallow &amp;&amp; disallow == &quot;TRUE&quot;;</span>
<a href="#l54.108"></a><span id="l54.108">         }</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineminus">-        if (rc == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l54.110"></a><span id="l54.110" class="difflineplus">+        if (rc == Ci.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l54.111"></a><span id="l54.111">             // No writable calendars, tell the user about it</span>
<a href="#l54.112"></a><span id="l54.112">             data.label = cal.l10n.getLtnString(&quot;imipBarNotWritable&quot;);</span>
<a href="#l54.113"></a><span id="l54.113">         } else if (Components.isSuccessCode(rc) &amp;&amp; !actionFunc) {</span>
<a href="#l54.114"></a><span id="l54.114">             // This case, they clicked on an old message that has already been</span>
<a href="#l54.115"></a><span id="l54.115">             // added/updated, we want to tell them that.</span>
<a href="#l54.116"></a><span id="l54.116">             data.label = cal.l10n.getLtnString(&quot;imipBarAlreadyProcessedText&quot;);</span>
<a href="#l54.117"></a><span id="l54.117">             if (foundItems &amp;&amp; foundItems.length) {</span>
<a href="#l54.118"></a><span id="l54.118">                 data.showItems.push(&quot;imipDetailsButton&quot;);</span>
<a href="#l54.119"></a><span id="l54.119" class="difflineat">@@ -317,18 +317,18 @@ var calitip = {</span>
<a href="#l54.120"></a><span id="l54.120">                                 }</span>
<a href="#l54.121"></a><span id="l54.121">                             }</span>
<a href="#l54.122"></a><span id="l54.122">                         }</span>
<a href="#l54.123"></a><span id="l54.123">                     }</span>
<a href="#l54.124"></a><span id="l54.124">                 }</span>
<a href="#l54.125"></a><span id="l54.125">             } else if (itipItem.receivedMethod == &quot;REPLY&quot;) {</span>
<a href="#l54.126"></a><span id="l54.126">                 // The item has been previously removed from the available calendars or the calendar</span>
<a href="#l54.127"></a><span id="l54.127">                 // containing the item is not available</span>
<a href="#l54.128"></a><span id="l54.128" class="difflineminus">-                let delmgr = Components.classes[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;]</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineminus">-                                       .getService(Components.interfaces.calIDeletedItems);</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineplus">+                let delmgr = Cc[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;]</span>
<a href="#l54.131"></a><span id="l54.131" class="difflineplus">+                               .getService(Ci.calIDeletedItems);</span>
<a href="#l54.132"></a><span id="l54.132">                 let delTime = null;</span>
<a href="#l54.133"></a><span id="l54.133">                 let items = itipItem.getItemList({});</span>
<a href="#l54.134"></a><span id="l54.134">                 if (items &amp;&amp; items.length) {</span>
<a href="#l54.135"></a><span id="l54.135">                     delTime = delmgr.getDeletedDate(items[0].id);</span>
<a href="#l54.136"></a><span id="l54.136">                 }</span>
<a href="#l54.137"></a><span id="l54.137">                 if (delTime) {</span>
<a href="#l54.138"></a><span id="l54.138">                     data.label = cal.l10n.getLtnString(&quot;imipBarReplyToRecentlyRemovedItem&quot;, [delTime.toString()]);</span>
<a href="#l54.139"></a><span id="l54.139">                 } else {</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineat">@@ -450,18 +450,18 @@ var calitip = {</span>
<a href="#l54.141"></a><span id="l54.141">      * Scope: iTIP message receiver</span>
<a href="#l54.142"></a><span id="l54.142">      * Retrieves the message sender.</span>
<a href="#l54.143"></a><span id="l54.143">      *</span>
<a href="#l54.144"></a><span id="l54.144">      * @param {nsIMsgDBHdr} aMsgHdr     The message header to check.</span>
<a href="#l54.145"></a><span id="l54.145">      * @return {String}                 The email address of the intended recipient.</span>
<a href="#l54.146"></a><span id="l54.146">      */</span>
<a href="#l54.147"></a><span id="l54.147">     getMessageSender: function(aMsgHdr) {</span>
<a href="#l54.148"></a><span id="l54.148">         let author = (aMsgHdr &amp;&amp; aMsgHdr.author) || &quot;&quot;;</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineminus">-        let compFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l54.150"></a><span id="l54.150" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l54.151"></a><span id="l54.151" class="difflineplus">+        let compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l54.152"></a><span id="l54.152" class="difflineplus">+                           .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l54.153"></a><span id="l54.153">         let addresses = compFields.splitRecipients(author, true, {});</span>
<a href="#l54.154"></a><span id="l54.154">         if (addresses.length != 1) {</span>
<a href="#l54.155"></a><span id="l54.155">             cal.LOG(&quot;No unique email address for lookup in message.\r\n&quot; + cal.STACK(20));</span>
<a href="#l54.156"></a><span id="l54.156">         }</span>
<a href="#l54.157"></a><span id="l54.157">         return addresses[0] || null;</span>
<a href="#l54.158"></a><span id="l54.158">     },</span>
<a href="#l54.159"></a><span id="l54.159"> </span>
<a href="#l54.160"></a><span id="l54.160">     /**</span>
<a href="#l54.161"></a><span id="l54.161" class="difflineat">@@ -498,27 +498,27 @@ var calitip = {</span>
<a href="#l54.162"></a><span id="l54.162">                 identity = defaultAccount.defaultIdentity;</span>
<a href="#l54.163"></a><span id="l54.163">             }</span>
<a href="#l54.164"></a><span id="l54.164">             if (!identity) {</span>
<a href="#l54.165"></a><span id="l54.165">                 // If there isn't a default identity (i.e Local Folders is your</span>
<a href="#l54.166"></a><span id="l54.166">                 // default identity), then go ahead and use the first available</span>
<a href="#l54.167"></a><span id="l54.167">                 // identity.</span>
<a href="#l54.168"></a><span id="l54.168">                 let allIdentities = actMgr.allIdentities;</span>
<a href="#l54.169"></a><span id="l54.169">                 if (allIdentities.length &gt; 0) {</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineminus">-                    identity = allIdentities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineplus">+                    identity = allIdentities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l54.172"></a><span id="l54.172">                 } else {</span>
<a href="#l54.173"></a><span id="l54.173">                     // If there are no identities at all, we cannot get a recipient.</span>
<a href="#l54.174"></a><span id="l54.174">                     return null;</span>
<a href="#l54.175"></a><span id="l54.175">                 }</span>
<a href="#l54.176"></a><span id="l54.176">             }</span>
<a href="#l54.177"></a><span id="l54.177">             emailMap[identity.email.toLowerCase()] = true;</span>
<a href="#l54.178"></a><span id="l54.178">         } else {</span>
<a href="#l54.179"></a><span id="l54.179">             // Build a map of usable email addresses</span>
<a href="#l54.180"></a><span id="l54.180">             for (let i = 0; i &lt; identities.length; i++) {</span>
<a href="#l54.181"></a><span id="l54.181" class="difflineminus">-                let identity = identities.queryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l54.182"></a><span id="l54.182" class="difflineplus">+                let identity = identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l54.183"></a><span id="l54.183">                 emailMap[identity.email.toLowerCase()] = true;</span>
<a href="#l54.184"></a><span id="l54.184">             }</span>
<a href="#l54.185"></a><span id="l54.185">         }</span>
<a href="#l54.186"></a><span id="l54.186"> </span>
<a href="#l54.187"></a><span id="l54.187">         // First check the recipient list</span>
<a href="#l54.188"></a><span id="l54.188">         let toList = MailServices.headerParser.makeFromDisplayAddress(aMsgHdr.recipients || &quot;&quot;);</span>
<a href="#l54.189"></a><span id="l54.189">         for (let recipient of toList) {</span>
<a href="#l54.190"></a><span id="l54.190">             if (recipient.email.toLowerCase() in emailMap) {</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineat">@@ -657,27 +657,27 @@ var calitip = {</span>
<a href="#l54.192"></a><span id="l54.192">             case &quot;CANCEL&quot;:</span>
<a href="#l54.193"></a><span id="l54.193">             case &quot;COUNTER&quot;:</span>
<a href="#l54.194"></a><span id="l54.194">             case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l54.195"></a><span id="l54.195">             case &quot;REPLY&quot;: {</span>
<a href="#l54.196"></a><span id="l54.196">                 // Per iTIP spec (new Draft 4), multiple items in an iTIP message MUST have</span>
<a href="#l54.197"></a><span id="l54.197">                 // same ID, this simplifies our searching, we can just look for Item[0].id</span>
<a href="#l54.198"></a><span id="l54.198">                 let itemList = itipItem.getItemList({});</span>
<a href="#l54.199"></a><span id="l54.199">                 if (!itipItem.targetCalendar) {</span>
<a href="#l54.200"></a><span id="l54.200" class="difflineminus">-                    optionsFunc(itipItem, Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l54.201"></a><span id="l54.201" class="difflineplus">+                    optionsFunc(itipItem, Ci.calIErrors.CAL_IS_READONLY);</span>
<a href="#l54.202"></a><span id="l54.202">                 } else if (itemList.length &gt; 0) {</span>
<a href="#l54.203"></a><span id="l54.203">                     ItipItemFinderFactory.findItem(itemList[0].id, itipItem, optionsFunc);</span>
<a href="#l54.204"></a><span id="l54.204">                 } else if (optionsFunc) {</span>
<a href="#l54.205"></a><span id="l54.205" class="difflineminus">-                    optionsFunc(itipItem, Components.results.NS_OK);</span>
<a href="#l54.206"></a><span id="l54.206" class="difflineplus">+                    optionsFunc(itipItem, Cr.NS_OK);</span>
<a href="#l54.207"></a><span id="l54.207">                 }</span>
<a href="#l54.208"></a><span id="l54.208">                 break;</span>
<a href="#l54.209"></a><span id="l54.209">             }</span>
<a href="#l54.210"></a><span id="l54.210">             default: {</span>
<a href="#l54.211"></a><span id="l54.211">                 if (optionsFunc) {</span>
<a href="#l54.212"></a><span id="l54.212" class="difflineminus">-                    optionsFunc(itipItem, Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l54.213"></a><span id="l54.213" class="difflineplus">+                    optionsFunc(itipItem, Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l54.214"></a><span id="l54.214">                 }</span>
<a href="#l54.215"></a><span id="l54.215">                 break;</span>
<a href="#l54.216"></a><span id="l54.216">             }</span>
<a href="#l54.217"></a><span id="l54.217">         }</span>
<a href="#l54.218"></a><span id="l54.218">     },</span>
<a href="#l54.219"></a><span id="l54.219"> </span>
<a href="#l54.220"></a><span id="l54.220">     /**</span>
<a href="#l54.221"></a><span id="l54.221">      * Scope: iTIP message sender</span>
<a href="#l54.222"></a><span id="l54.222" class="difflineat">@@ -711,37 +711,37 @@ var calitip = {</span>
<a href="#l54.223"></a><span id="l54.223">                 }</span>
<a href="#l54.224"></a><span id="l54.224">             }</span>
<a href="#l54.225"></a><span id="l54.225"> </span>
<a href="#l54.226"></a><span id="l54.226">             if (aOriginalItem.recurrenceInfo &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l54.227"></a><span id="l54.227">                 // check whether the two differ only in EXDATEs</span>
<a href="#l54.228"></a><span id="l54.228">                 let clonedItem = aItem.clone();</span>
<a href="#l54.229"></a><span id="l54.229">                 let exdates = [];</span>
<a href="#l54.230"></a><span id="l54.230">                 for (let ritem of clonedItem.recurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l54.231"></a><span id="l54.231" class="difflineminus">-                    let wrappedRItem = cal.wrapInstance(ritem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l54.232"></a><span id="l54.232" class="difflineplus">+                    let wrappedRItem = cal.wrapInstance(ritem, Ci.calIRecurrenceDate);</span>
<a href="#l54.233"></a><span id="l54.233">                     if (ritem.isNegative &amp;&amp;</span>
<a href="#l54.234"></a><span id="l54.234">                         wrappedRItem &amp;&amp;</span>
<a href="#l54.235"></a><span id="l54.235">                         !aOriginalItem.recurrenceInfo.getRecurrenceItems({}).some((recitem) =&gt; {</span>
<a href="#l54.236"></a><span id="l54.236" class="difflineminus">-                            let wrappedR = cal.wrapInstance(recitem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l54.237"></a><span id="l54.237" class="difflineplus">+                            let wrappedR = cal.wrapInstance(recitem, Ci.calIRecurrenceDate);</span>
<a href="#l54.238"></a><span id="l54.238">                             return recitem.isNegative &amp;&amp;</span>
<a href="#l54.239"></a><span id="l54.239">                                    wrappedR &amp;&amp;</span>
<a href="#l54.240"></a><span id="l54.240">                                    wrappedR.date.compare(wrappedRItem.date) == 0;</span>
<a href="#l54.241"></a><span id="l54.241">                         })) {</span>
<a href="#l54.242"></a><span id="l54.242">                         exdates.push(wrappedRItem);</span>
<a href="#l54.243"></a><span id="l54.243">                     }</span>
<a href="#l54.244"></a><span id="l54.244">                 }</span>
<a href="#l54.245"></a><span id="l54.245">                 if (exdates.length &gt; 0) {</span>
<a href="#l54.246"></a><span id="l54.246">                     // check whether really only EXDATEs have been added:</span>
<a href="#l54.247"></a><span id="l54.247">                     let recInfo = clonedItem.recurrenceInfo;</span>
<a href="#l54.248"></a><span id="l54.248">                     exdates.forEach(recInfo.deleteRecurrenceItem, recInfo);</span>
<a href="#l54.249"></a><span id="l54.249">                     if (cal.item.compareContent(clonedItem, aOriginalItem)) { // transition into &quot;delete occurrence(s)&quot;</span>
<a href="#l54.250"></a><span id="l54.250">                         // xxx todo: support multiple</span>
<a href="#l54.251"></a><span id="l54.251">                         aItem = aOriginalItem.recurrenceInfo.getOccurrenceFor(exdates[0].date);</span>
<a href="#l54.252"></a><span id="l54.252">                         aOriginalItem = null;</span>
<a href="#l54.253"></a><span id="l54.253" class="difflineminus">-                        aOpType = Components.interfaces.calIOperationListener.DELETE;</span>
<a href="#l54.254"></a><span id="l54.254" class="difflineplus">+                        aOpType = Ci.calIOperationListener.DELETE;</span>
<a href="#l54.255"></a><span id="l54.255">                     }</span>
<a href="#l54.256"></a><span id="l54.256">                 }</span>
<a href="#l54.257"></a><span id="l54.257">             }</span>
<a href="#l54.258"></a><span id="l54.258">         }</span>
<a href="#l54.259"></a><span id="l54.259">         // for backward compatibility, we assume USER mode if not set otherwise</span>
<a href="#l54.260"></a><span id="l54.260">         let autoResponse = { mode: Ci.calIItipItem.USER };</span>
<a href="#l54.261"></a><span id="l54.261">         if (aExtResponse &amp;&amp; aExtResponse.hasOwnProperty(&quot;responseMode&quot;)) {</span>
<a href="#l54.262"></a><span id="l54.262">             switch (aExtResponse.responseMode) {</span>
<a href="#l54.263"></a><span id="l54.263" class="difflineat">@@ -781,17 +781,17 @@ var calitip = {</span>
<a href="#l54.264"></a><span id="l54.264">                     invitedAttendee = invitedAttendee.clone();</span>
<a href="#l54.265"></a><span id="l54.265">                     invitedAttendee.setProperty(&quot;SENT-BY&quot;, &quot;mailto:&quot; + userAddresses[0]);</span>
<a href="#l54.266"></a><span id="l54.266">                 }</span>
<a href="#l54.267"></a><span id="l54.267">             }</span>
<a href="#l54.268"></a><span id="l54.268"> </span>
<a href="#l54.269"></a><span id="l54.269">             if (aItem.organizer) {</span>
<a href="#l54.270"></a><span id="l54.270">                 let origInvitedAttendee = (aOriginalItem &amp;&amp; aOriginalItem.getAttendeeById(invitedAttendee.id));</span>
<a href="#l54.271"></a><span id="l54.271"> </span>
<a href="#l54.272"></a><span id="l54.272" class="difflineminus">-                if (aOpType == Components.interfaces.calIOperationListener.DELETE) {</span>
<a href="#l54.273"></a><span id="l54.273" class="difflineplus">+                if (aOpType == Ci.calIOperationListener.DELETE) {</span>
<a href="#l54.274"></a><span id="l54.274">                     // in case the attendee has just deleted the item, we want to send out a DECLINED REPLY:</span>
<a href="#l54.275"></a><span id="l54.275">                     origInvitedAttendee = invitedAttendee;</span>
<a href="#l54.276"></a><span id="l54.276">                     invitedAttendee = invitedAttendee.clone();</span>
<a href="#l54.277"></a><span id="l54.277">                     invitedAttendee.participationStatus = &quot;DECLINED&quot;;</span>
<a href="#l54.278"></a><span id="l54.278">                 }</span>
<a href="#l54.279"></a><span id="l54.279"> </span>
<a href="#l54.280"></a><span id="l54.280">                 // We want to send a REPLY send if:</span>
<a href="#l54.281"></a><span id="l54.281">                 // - there has been a PARTSTAT change</span>
<a href="#l54.282"></a><span id="l54.282" class="difflineat">@@ -845,24 +845,24 @@ var calitip = {</span>
<a href="#l54.283"></a><span id="l54.283">             return;</span>
<a href="#l54.284"></a><span id="l54.284">         }</span>
<a href="#l54.285"></a><span id="l54.285"> </span>
<a href="#l54.286"></a><span id="l54.286">         // special handling for invitation with event status cancelled</span>
<a href="#l54.287"></a><span id="l54.287">         if (aItem.getAttendees({}).length &gt; 0 &amp;&amp;</span>
<a href="#l54.288"></a><span id="l54.288">             aItem.getProperty(&quot;STATUS&quot;) == &quot;CANCELLED&quot;) {</span>
<a href="#l54.289"></a><span id="l54.289">             if (calitip.getSequence(aItem) &gt; 0) {</span>
<a href="#l54.290"></a><span id="l54.290">                 // make sure we send a cancellation and not an request</span>
<a href="#l54.291"></a><span id="l54.291" class="difflineminus">-                aOpType = Components.interfaces.calIOperationListener.DELETE;</span>
<a href="#l54.292"></a><span id="l54.292" class="difflineplus">+                aOpType = Ci.calIOperationListener.DELETE;</span>
<a href="#l54.293"></a><span id="l54.293">             } else {</span>
<a href="#l54.294"></a><span id="l54.294">                 // don't send an invitation, if the event was newly created and has status cancelled</span>
<a href="#l54.295"></a><span id="l54.295">                 return;</span>
<a href="#l54.296"></a><span id="l54.296">             }</span>
<a href="#l54.297"></a><span id="l54.297">         }</span>
<a href="#l54.298"></a><span id="l54.298"> </span>
<a href="#l54.299"></a><span id="l54.299" class="difflineminus">-        if (aOpType == Components.interfaces.calIOperationListener.DELETE) {</span>
<a href="#l54.300"></a><span id="l54.300" class="difflineplus">+        if (aOpType == Ci.calIOperationListener.DELETE) {</span>
<a href="#l54.301"></a><span id="l54.301">             sendMessage(aItem, &quot;CANCEL&quot;, aItem.getAttendees({}), autoResponse);</span>
<a href="#l54.302"></a><span id="l54.302">             return;</span>
<a href="#l54.303"></a><span id="l54.303">         } // else ADD, MODIFY:</span>
<a href="#l54.304"></a><span id="l54.304"> </span>
<a href="#l54.305"></a><span id="l54.305">         let originalAtt = (aOriginalItem ? aOriginalItem.getAttendees({}) : []);</span>
<a href="#l54.306"></a><span id="l54.306">         let itemAtt = aItem.getAttendees({});</span>
<a href="#l54.307"></a><span id="l54.307">         let canceledAttendees = [];</span>
<a href="#l54.308"></a><span id="l54.308">         let addedAttendees = [];</span>
<a href="#l54.309"></a><span id="l54.309" class="difflineat">@@ -1018,18 +1018,17 @@ var calitip = {</span>
<a href="#l54.310"></a><span id="l54.310">      * itipItem.clone() instead if only a simple copy is required</span>
<a href="#l54.311"></a><span id="l54.311">      *</span>
<a href="#l54.312"></a><span id="l54.312">      * @param  {calIItipItem} aItipItem  ItipItem to derive a new one from</span>
<a href="#l54.313"></a><span id="l54.313">      * @param  {calIItemBase[]} aItems   calIEvent or calITodo items to be contained in the new itipItem</span>
<a href="#l54.314"></a><span id="l54.314">      * @param  {Object} aProps           Properties to be different in the new itipItem</span>
<a href="#l54.315"></a><span id="l54.315">      * @return {calIItipItem}            The copied and modified item</span>
<a href="#l54.316"></a><span id="l54.316">      */</span>
<a href="#l54.317"></a><span id="l54.317">     getModifiedItipItem: function(aItipItem, aItems=[], aProps={}) {</span>
<a href="#l54.318"></a><span id="l54.318" class="difflineminus">-        let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l54.319"></a><span id="l54.319" class="difflineminus">-                                 .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l54.320"></a><span id="l54.320" class="difflineplus">+        let itipItem = Cc[&quot;@mozilla.org/calendar/itip-item;1&quot;].createInstance(Ci.calIItipItem);</span>
<a href="#l54.321"></a><span id="l54.321">         let serializedItems = &quot;&quot;;</span>
<a href="#l54.322"></a><span id="l54.322">         for (let item of aItems) {</span>
<a href="#l54.323"></a><span id="l54.323">             serializedItems += cal.item.serialize(item);</span>
<a href="#l54.324"></a><span id="l54.324">         }</span>
<a href="#l54.325"></a><span id="l54.325">         itipItem.init(serializedItems);</span>
<a href="#l54.326"></a><span id="l54.326"> </span>
<a href="#l54.327"></a><span id="l54.327">         itipItem.autoResponse = (&quot;autoResponse&quot; in aProps) ? aProps.autoResponse : aItipItem.autoResponse;</span>
<a href="#l54.328"></a><span id="l54.328">         itipItem.identity = (&quot;identity&quot; in aProps) ? aProps.identity : aItipItem.identity;</span>
<a href="#l54.329"></a><span id="l54.329" class="difflineat">@@ -1091,33 +1090,33 @@ var calitip = {</span>
<a href="#l54.330"></a><span id="l54.330">     /**</span>
<a href="#l54.331"></a><span id="l54.331">      * Shortcut function to check whether an item is an invitation copy.</span>
<a href="#l54.332"></a><span id="l54.332">      *</span>
<a href="#l54.333"></a><span id="l54.333">      * @param {calIItemBase} aItem      The item to check for an invitation.</span>
<a href="#l54.334"></a><span id="l54.334">      * @return {Boolean}                True, if the item is an invitation.</span>
<a href="#l54.335"></a><span id="l54.335">      */</span>
<a href="#l54.336"></a><span id="l54.336">     isInvitation: function(aItem) {</span>
<a href="#l54.337"></a><span id="l54.337">         let isInvitation = false;</span>
<a href="#l54.338"></a><span id="l54.338" class="difflineminus">-        let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l54.339"></a><span id="l54.339" class="difflineplus">+        let calendar = cal.wrapInstance(aItem.calendar, Ci.calISchedulingSupport);</span>
<a href="#l54.340"></a><span id="l54.340">         if (calendar) {</span>
<a href="#l54.341"></a><span id="l54.341">             isInvitation = calendar.isInvitation(aItem);</span>
<a href="#l54.342"></a><span id="l54.342">         }</span>
<a href="#l54.343"></a><span id="l54.343">         return isInvitation;</span>
<a href="#l54.344"></a><span id="l54.344">     },</span>
<a href="#l54.345"></a><span id="l54.345"> </span>
<a href="#l54.346"></a><span id="l54.346">     /**</span>
<a href="#l54.347"></a><span id="l54.347">      * Shortcut function to check whether an item is an invitation copy and has a participation</span>
<a href="#l54.348"></a><span id="l54.348">      * status of either NEEDS-ACTION or TENTATIVE.</span>
<a href="#l54.349"></a><span id="l54.349">      *</span>
<a href="#l54.350"></a><span id="l54.350">      * @param {calIAttendee|calIItemBase} aItem     either calIAttendee or calIItemBase</span>
<a href="#l54.351"></a><span id="l54.351">      * @return {Boolean}                            True, if the attendee partstat is NEEDS-ACTION</span>
<a href="#l54.352"></a><span id="l54.352">      *                                                or TENTATIVE</span>
<a href="#l54.353"></a><span id="l54.353">      */</span>
<a href="#l54.354"></a><span id="l54.354">     isOpenInvitation: function(aItem) {</span>
<a href="#l54.355"></a><span id="l54.355" class="difflineminus">-        let wrappedItem = cal.wrapInstance(aItem, Components.interfaces.calIAttendee);</span>
<a href="#l54.356"></a><span id="l54.356" class="difflineplus">+        let wrappedItem = cal.wrapInstance(aItem, Ci.calIAttendee);</span>
<a href="#l54.357"></a><span id="l54.357">         if (!wrappedItem) {</span>
<a href="#l54.358"></a><span id="l54.358">             aItem = calitip.getInvitedAttendee(aItem);</span>
<a href="#l54.359"></a><span id="l54.359">         }</span>
<a href="#l54.360"></a><span id="l54.360">         if (aItem) {</span>
<a href="#l54.361"></a><span id="l54.361">             switch (aItem.participationStatus) {</span>
<a href="#l54.362"></a><span id="l54.362">                 case &quot;NEEDS-ACTION&quot;:</span>
<a href="#l54.363"></a><span id="l54.363">                 case &quot;TENTATIVE&quot;:</span>
<a href="#l54.364"></a><span id="l54.364">                     return true;</span>
<a href="#l54.365"></a><span id="l54.365" class="difflineat">@@ -1173,17 +1172,17 @@ var calitip = {</span>
<a href="#l54.366"></a><span id="l54.366">      *                                        calendar</span>
<a href="#l54.367"></a><span id="l54.367">      * @return {?calIAttendee}              The attendee that was invited</span>
<a href="#l54.368"></a><span id="l54.368">      */</span>
<a href="#l54.369"></a><span id="l54.369">     getInvitedAttendee: function(aItem, aCalendar) {</span>
<a href="#l54.370"></a><span id="l54.370">         if (!aCalendar) {</span>
<a href="#l54.371"></a><span id="l54.371">             aCalendar = aItem.calendar;</span>
<a href="#l54.372"></a><span id="l54.372">         }</span>
<a href="#l54.373"></a><span id="l54.373">         let invitedAttendee = null;</span>
<a href="#l54.374"></a><span id="l54.374" class="difflineminus">-        let calendar = cal.wrapInstance(aCalendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l54.375"></a><span id="l54.375" class="difflineplus">+        let calendar = cal.wrapInstance(aCalendar, Ci.calISchedulingSupport);</span>
<a href="#l54.376"></a><span id="l54.376">         if (calendar) {</span>
<a href="#l54.377"></a><span id="l54.377">             invitedAttendee = calendar.getInvitedAttendee(aItem);</span>
<a href="#l54.378"></a><span id="l54.378">         }</span>
<a href="#l54.379"></a><span id="l54.379">         return invitedAttendee;</span>
<a href="#l54.380"></a><span id="l54.380">     },</span>
<a href="#l54.381"></a><span id="l54.381"> </span>
<a href="#l54.382"></a><span id="l54.382">     /**</span>
<a href="#l54.383"></a><span id="l54.383">      * Returns all attendees from given set of attendees matching based on the attendee id</span>
<a href="#l54.384"></a><span id="l54.384" class="difflineat">@@ -1191,18 +1190,18 @@ var calitip = {</span>
<a href="#l54.385"></a><span id="l54.385">      *</span>
<a href="#l54.386"></a><span id="l54.386">      * @param {calIAttendee[]} aAttendees       An array of calIAttendee objects</span>
<a href="#l54.387"></a><span id="l54.387">      * @param {String} aEmailAddress            A string containing the email address for lookup</span>
<a href="#l54.388"></a><span id="l54.388">      * @return {calIAttendee[]}                 Returns an array of matching attendees</span>
<a href="#l54.389"></a><span id="l54.389">      */</span>
<a href="#l54.390"></a><span id="l54.390">     getAttendeesBySender: function(aAttendees, aEmailAddress) {</span>
<a href="#l54.391"></a><span id="l54.391">         let attendees = [];</span>
<a href="#l54.392"></a><span id="l54.392">         // we extract the email address to make it work also for a raw header value</span>
<a href="#l54.393"></a><span id="l54.393" class="difflineminus">-        let compFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l54.394"></a><span id="l54.394" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l54.395"></a><span id="l54.395" class="difflineplus">+        let compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l54.396"></a><span id="l54.396" class="difflineplus">+                           .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l54.397"></a><span id="l54.397">         let addresses = compFields.splitRecipients(aEmailAddress, true, {});</span>
<a href="#l54.398"></a><span id="l54.398">         if (addresses.length == 1) {</span>
<a href="#l54.399"></a><span id="l54.399">             let searchFor = cal.email.prependMailTo(addresses[0]);</span>
<a href="#l54.400"></a><span id="l54.400">             aAttendees.forEach(aAttendee =&gt; {</span>
<a href="#l54.401"></a><span id="l54.401">                 if ([aAttendee.id, aAttendee.getProperty(&quot;SENT-BY&quot;)].includes(searchFor)) {</span>
<a href="#l54.402"></a><span id="l54.402">                     attendees.push(aAttendee);</span>
<a href="#l54.403"></a><span id="l54.403">                 }</span>
<a href="#l54.404"></a><span id="l54.404">             });</span>
<a href="#l54.405"></a><span id="l54.405" class="difflineat">@@ -1215,17 +1214,17 @@ var calitip = {</span>
<a href="#l54.406"></a><span id="l54.406"> </span>
<a href="#l54.407"></a><span id="l54.407"> /** local to this module file</span>
<a href="#l54.408"></a><span id="l54.408">  * Sets the received info either on the passed attendee or item object.</span>
<a href="#l54.409"></a><span id="l54.409">  *</span>
<a href="#l54.410"></a><span id="l54.410">  * @param {calIItemBase|calIAttendee} item      The item to set info on</span>
<a href="#l54.411"></a><span id="l54.411">  * @param {calIItipItem} itipItemItem           The received iTIP item</span>
<a href="#l54.412"></a><span id="l54.412">  */</span>
<a href="#l54.413"></a><span id="l54.413"> function setReceivedInfo(item, itipItemItem) {</span>
<a href="#l54.414"></a><span id="l54.414" class="difflineminus">-    let wrappedItem = cal.wrapInstance(item, Components.interfaces.calIAttendee);</span>
<a href="#l54.415"></a><span id="l54.415" class="difflineplus">+    let wrappedItem = cal.wrapInstance(item, Ci.calIAttendee);</span>
<a href="#l54.416"></a><span id="l54.416">     item.setProperty(wrappedItem ? &quot;RECEIVED-SEQUENCE&quot;</span>
<a href="#l54.417"></a><span id="l54.417">                                  : &quot;X-MOZ-RECEIVED-SEQUENCE&quot;,</span>
<a href="#l54.418"></a><span id="l54.418">                                  String(calitip.getSequence(itipItemItem)));</span>
<a href="#l54.419"></a><span id="l54.419">     let dtstamp = calitip.getStamp(itipItemItem);</span>
<a href="#l54.420"></a><span id="l54.420">     if (dtstamp) {</span>
<a href="#l54.421"></a><span id="l54.421">         item.setProperty(wrappedItem ? &quot;RECEIVED-DTSTAMP&quot;</span>
<a href="#l54.422"></a><span id="l54.422">                                      : &quot;X-MOZ-RECEIVED-DTSTAMP&quot;,</span>
<a href="#l54.423"></a><span id="l54.423">                                      dtstamp.getInTimezone(cal.dtz.UTC).icalString);</span>
<a href="#l54.424"></a><span id="l54.424" class="difflineat">@@ -1373,40 +1372,39 @@ function createOrganizer(aCalendar) {</span>
<a href="#l54.425"></a><span id="l54.425">  *</span>
<a href="#l54.426"></a><span id="l54.426">  * @param {calIEvent} aItem                 item to be sent</span>
<a href="#l54.427"></a><span id="l54.427">  * @param {String} aMethod                  iTIP method</span>
<a href="#l54.428"></a><span id="l54.428">  * @param {calIAttendee[]} aRecipientsList  array of calIAttendee objects the message should be sent to</span>
<a href="#l54.429"></a><span id="l54.429">  * @param {Object} autoResponse             inout object whether the transport should ask before sending</span>
<a href="#l54.430"></a><span id="l54.430">  * @return {Boolean}                        True, if the message could be sent</span>
<a href="#l54.431"></a><span id="l54.431">  */</span>
<a href="#l54.432"></a><span id="l54.432"> function sendMessage(aItem, aMethod, aRecipientsList, autoResponse) {</span>
<a href="#l54.433"></a><span id="l54.433" class="difflineminus">-    let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l54.434"></a><span id="l54.434" class="difflineplus">+    let calendar = cal.wrapInstance(aItem.calendar, Ci.calISchedulingSupport);</span>
<a href="#l54.435"></a><span id="l54.435">     if (calendar) {</span>
<a href="#l54.436"></a><span id="l54.436" class="difflineminus">-        if (calendar.QueryInterface(Components.interfaces.calISchedulingSupport)</span>
<a href="#l54.437"></a><span id="l54.437" class="difflineplus">+        if (calendar.QueryInterface(Ci.calISchedulingSupport)</span>
<a href="#l54.438"></a><span id="l54.438">                     .canNotify(aMethod, aItem)) {</span>
<a href="#l54.439"></a><span id="l54.439">             // provider will handle that, so we return - we leave it also to the provider to</span>
<a href="#l54.440"></a><span id="l54.440">             // deal with user canceled notifications (if possible), so set the return value</span>
<a href="#l54.441"></a><span id="l54.441">             // to true as false would prevent any further notification within this cycle</span>
<a href="#l54.442"></a><span id="l54.442">             return true;</span>
<a href="#l54.443"></a><span id="l54.443">         }</span>
<a href="#l54.444"></a><span id="l54.444">     }</span>
<a href="#l54.445"></a><span id="l54.445"> </span>
<a href="#l54.446"></a><span id="l54.446">     if (aRecipientsList.length == 0) {</span>
<a href="#l54.447"></a><span id="l54.447">         return false;</span>
<a href="#l54.448"></a><span id="l54.448">     }</span>
<a href="#l54.449"></a><span id="l54.449"> </span>
<a href="#l54.450"></a><span id="l54.450">     let transport = aItem.calendar.getProperty(&quot;itip.transport&quot;);</span>
<a href="#l54.451"></a><span id="l54.451">     if (!transport) { // can only send if there's a transport for the calendar</span>
<a href="#l54.452"></a><span id="l54.452">         return false;</span>
<a href="#l54.453"></a><span id="l54.453">     }</span>
<a href="#l54.454"></a><span id="l54.454" class="difflineminus">-    transport = transport.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l54.455"></a><span id="l54.455" class="difflineplus">+    transport = transport.QueryInterface(Ci.calIItipTransport);</span>
<a href="#l54.456"></a><span id="l54.456"> </span>
<a href="#l54.457"></a><span id="l54.457">     let _sendItem = function(aSendToList, aSendItem) {</span>
<a href="#l54.458"></a><span id="l54.458" class="difflineminus">-        let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l54.459"></a><span id="l54.459" class="difflineminus">-                                 .createInstance(Ci.calIItipItem);</span>
<a href="#l54.460"></a><span id="l54.460" class="difflineplus">+        let itipItem = Cc[&quot;@mozilla.org/calendar/itip-item;1&quot;].createInstance(Ci.calIItipItem);</span>
<a href="#l54.461"></a><span id="l54.461">         itipItem.init(cal.item.serialize(aSendItem));</span>
<a href="#l54.462"></a><span id="l54.462">         itipItem.responseMethod = aMethod;</span>
<a href="#l54.463"></a><span id="l54.463">         itipItem.targetCalendar = aSendItem.calendar;</span>
<a href="#l54.464"></a><span id="l54.464">         itipItem.autoResponse = autoResponse.mode;</span>
<a href="#l54.465"></a><span id="l54.465">         // we switch to AUTO for each subsequent call of _sendItem()</span>
<a href="#l54.466"></a><span id="l54.466">         autoResponse.mode = Ci.calIItipItem.AUTO;</span>
<a href="#l54.467"></a><span id="l54.467">         // XXX I don't know whether the below is used at all, since we don't use the itip processor</span>
<a href="#l54.468"></a><span id="l54.468">         itipItem.isSend = true;</span>
<a href="#l54.469"></a><span id="l54.469" class="difflineat">@@ -1623,17 +1621,17 @@ ItipItemFinder.prototype = {</span>
<a href="#l54.470"></a><span id="l54.470">         this.processFoundItems();</span>
<a href="#l54.471"></a><span id="l54.471">     },</span>
<a href="#l54.472"></a><span id="l54.472"> </span>
<a href="#l54.473"></a><span id="l54.473">     destroy: function() {</span>
<a href="#l54.474"></a><span id="l54.474">         this._unobserveChanges();</span>
<a href="#l54.475"></a><span id="l54.475">     },</span>
<a href="#l54.476"></a><span id="l54.476"> </span>
<a href="#l54.477"></a><span id="l54.477">     processFoundItems: function() {</span>
<a href="#l54.478"></a><span id="l54.478" class="difflineminus">-        let rc = Components.results.NS_OK;</span>
<a href="#l54.479"></a><span id="l54.479" class="difflineplus">+        let rc = Cr.NS_OK;</span>
<a href="#l54.480"></a><span id="l54.480">         const method = this.mItipItem.receivedMethod.toUpperCase();</span>
<a href="#l54.481"></a><span id="l54.481">         let actionMethod = method;</span>
<a href="#l54.482"></a><span id="l54.482">         let operations = [];</span>
<a href="#l54.483"></a><span id="l54.483"> </span>
<a href="#l54.484"></a><span id="l54.484">         if (this.mFoundItems.length &gt; 0) {</span>
<a href="#l54.485"></a><span id="l54.485">             // Save the target calendar on the itip item</span>
<a href="#l54.486"></a><span id="l54.486">             this.mItipItem.targetCalendar = this.mFoundItems[0].calendar;</span>
<a href="#l54.487"></a><span id="l54.487">             this._observeChanges(this.mItipItem.targetCalendar);</span>
<a href="#l54.488"></a><span id="l54.488" class="difflineat">@@ -1869,17 +1867,17 @@ ItipItemFinder.prototype = {</span>
<a href="#l54.489"></a><span id="l54.489">                                     item.calendar.deleteItem(item, opListener)</span>
<a href="#l54.490"></a><span id="l54.490">                                 );</span>
<a href="#l54.491"></a><span id="l54.491">                             }</span>
<a href="#l54.492"></a><span id="l54.492">                         }</span>
<a href="#l54.493"></a><span id="l54.493">                     }</span>
<a href="#l54.494"></a><span id="l54.494">                     break;</span>
<a href="#l54.495"></a><span id="l54.495">                 }</span>
<a href="#l54.496"></a><span id="l54.496">                 default:</span>
<a href="#l54.497"></a><span id="l54.497" class="difflineminus">-                    rc = Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.498"></a><span id="l54.498" class="difflineplus">+                    rc = Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.499"></a><span id="l54.499">                     break;</span>
<a href="#l54.500"></a><span id="l54.500">             }</span>
<a href="#l54.501"></a><span id="l54.501">         } else { // not found:</span>
<a href="#l54.502"></a><span id="l54.502">             cal.LOG(&quot;iTIP on &quot; + method + &quot;: no existing items.&quot;);</span>
<a href="#l54.503"></a><span id="l54.503"> </span>
<a href="#l54.504"></a><span id="l54.504">             // If the item was not found, observe the target calendar anyway.</span>
<a href="#l54.505"></a><span id="l54.505">             // It will likely be the composite calendar, so we should update</span>
<a href="#l54.506"></a><span id="l54.506">             // if an item was added or removed</span>
<a href="#l54.507"></a><span id="l54.507" class="difflineat">@@ -1925,17 +1923,17 @@ ItipItemFinder.prototype = {</span>
<a href="#l54.508"></a><span id="l54.508">                         operations.push(action);</span>
<a href="#l54.509"></a><span id="l54.509">                         break;</span>
<a href="#l54.510"></a><span id="l54.510">                     }</span>
<a href="#l54.511"></a><span id="l54.511">                     case &quot;CANCEL&quot;: // has already been processed</span>
<a href="#l54.512"></a><span id="l54.512">                     case &quot;REPLY&quot;: // item has been previously removed from the calendar</span>
<a href="#l54.513"></a><span id="l54.513">                     case &quot;COUNTER&quot;: // the item has been previously removed form the calendar</span>
<a href="#l54.514"></a><span id="l54.514">                         break;</span>
<a href="#l54.515"></a><span id="l54.515">                     default:</span>
<a href="#l54.516"></a><span id="l54.516" class="difflineminus">-                        rc = Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.517"></a><span id="l54.517" class="difflineplus">+                        rc = Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.518"></a><span id="l54.518">                         break;</span>
<a href="#l54.519"></a><span id="l54.519">                 }</span>
<a href="#l54.520"></a><span id="l54.520">             }</span>
<a href="#l54.521"></a><span id="l54.521">         }</span>
<a href="#l54.522"></a><span id="l54.522"> </span>
<a href="#l54.523"></a><span id="l54.523">         cal.LOG(&quot;iTIP operations: &quot; + operations.length);</span>
<a href="#l54.524"></a><span id="l54.524">         let actionFunc = null;</span>
<a href="#l54.525"></a><span id="l54.525">         if (operations.length &gt; 0) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/calendar/base/modules/utils/calL10NUtils.jsm</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/calendar/base/modules/utils/calL10NUtils.jsm</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -33,17 +33,17 @@ function _getString(aComponent, aBundleN</span>
<a href="#l55.4"></a><span id="l55.4"> </span>
<a href="#l55.5"></a><span id="l55.5">         if (aParams &amp;&amp; aParams.length) {</span>
<a href="#l55.6"></a><span id="l55.6">             return props.formatStringFromName(aStringName, aParams, aParams.length);</span>
<a href="#l55.7"></a><span id="l55.7">         } else {</span>
<a href="#l55.8"></a><span id="l55.8">             return props.GetStringFromName(aStringName);</span>
<a href="#l55.9"></a><span id="l55.9">         }</span>
<a href="#l55.10"></a><span id="l55.10">     } catch (ex) {</span>
<a href="#l55.11"></a><span id="l55.11">         let msg = `Failed to read '${aStringName}' from ${propName}.`;</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-        Components.utils.reportError(`${msg} Error: ${ex}`);</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+        Cu.reportError(`${msg} Error: ${ex}`);</span>
<a href="#l55.14"></a><span id="l55.14">         return aStringName;</span>
<a href="#l55.15"></a><span id="l55.15">     }</span>
<a href="#l55.16"></a><span id="l55.16"> }</span>
<a href="#l55.17"></a><span id="l55.17"> _getString._bundleCache = {};</span>
<a href="#l55.18"></a><span id="l55.18"> </span>
<a href="#l55.19"></a><span id="l55.19"> /**</span>
<a href="#l55.20"></a><span id="l55.20">  * Provides locale dependent parameters for displaying calendar views</span>
<a href="#l55.21"></a><span id="l55.21">  *</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineat">@@ -143,19 +143,19 @@ var call10n = {</span>
<a href="#l55.23"></a><span id="l55.23">     },</span>
<a href="#l55.24"></a><span id="l55.24"> </span>
<a href="#l55.25"></a><span id="l55.25">     /**</span>
<a href="#l55.26"></a><span id="l55.26">      * Create a new locale collator</span>
<a href="#l55.27"></a><span id="l55.27">      *</span>
<a href="#l55.28"></a><span id="l55.28">      * @return {nsICollation}       A new locale collator</span>
<a href="#l55.29"></a><span id="l55.29">      */</span>
<a href="#l55.30"></a><span id="l55.30">     createLocaleCollator: function() {</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-        return Components.classes[&quot;@mozilla.org/intl/collation-factory;1&quot;]</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineminus">-                         .getService(Components.interfaces.nsICollationFactory)</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineminus">-                         .CreateCollation();</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineplus">+        return Cc[&quot;@mozilla.org/intl/collation-factory;1&quot;]</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineplus">+                 .getService(Ci.nsICollationFactory)</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+                 .CreateCollation();</span>
<a href="#l55.37"></a><span id="l55.37">     },</span>
<a href="#l55.38"></a><span id="l55.38"> </span>
<a href="#l55.39"></a><span id="l55.39">     /**</span>
<a href="#l55.40"></a><span id="l55.40">      * Sort an array of strings in place, according to the current locale.</span>
<a href="#l55.41"></a><span id="l55.41">      *</span>
<a href="#l55.42"></a><span id="l55.42">      * @param {String[]} aStringArray   The strings to sort</span>
<a href="#l55.43"></a><span id="l55.43">      * @return {String[]}               The sorted strings, more specifically aStringArray</span>
<a href="#l55.44"></a><span id="l55.44">      */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -36,36 +36,36 @@ var calprovider = {</span>
<a href="#l56.4"></a><span id="l56.4">      * @param {?nsIChannel} aExisting                           An existing channel to modify (optional)</span>
<a href="#l56.5"></a><span id="l56.5">      * @return {nsIChannel}                                     The prepared channel</span>
<a href="#l56.6"></a><span id="l56.6">      */</span>
<a href="#l56.7"></a><span id="l56.7">     prepHttpChannel: function(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting=null) {</span>
<a href="#l56.8"></a><span id="l56.8">         let channel = aExisting || Services.io.newChannelFromURI2(aUri,</span>
<a href="#l56.9"></a><span id="l56.9">                                                                   null,</span>
<a href="#l56.10"></a><span id="l56.10">                                                                   Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l56.11"></a><span id="l56.11">                                                                   null,</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-                                                                  Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-                                                                  Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineminus">-        let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+                                                                  Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l56.16"></a><span id="l56.16" class="difflineplus">+                                                                  Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l56.17"></a><span id="l56.17" class="difflineplus">+        let httpchannel = channel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l56.18"></a><span id="l56.18"> </span>
<a href="#l56.19"></a><span id="l56.19">         httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/xml&quot;, false);</span>
<a href="#l56.20"></a><span id="l56.20">         httpchannel.setRequestHeader(&quot;Accept-Charset&quot;, &quot;utf-8,*;q=0.1&quot;, false);</span>
<a href="#l56.21"></a><span id="l56.21" class="difflineminus">-        httpchannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineplus">+        httpchannel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l56.23"></a><span id="l56.23">         httpchannel.notificationCallbacks = aNotificationCallbacks;</span>
<a href="#l56.24"></a><span id="l56.24"> </span>
<a href="#l56.25"></a><span id="l56.25">         if (aUploadData) {</span>
<a href="#l56.26"></a><span id="l56.26" class="difflineminus">-            httpchannel = httpchannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l56.27"></a><span id="l56.27" class="difflineplus">+            httpchannel = httpchannel.QueryInterface(Ci.nsIUploadChannel);</span>
<a href="#l56.28"></a><span id="l56.28">             let stream;</span>
<a href="#l56.29"></a><span id="l56.29" class="difflineminus">-            if (aUploadData instanceof Components.interfaces.nsIInputStream) {</span>
<a href="#l56.30"></a><span id="l56.30" class="difflineplus">+            if (aUploadData instanceof Ci.nsIInputStream) {</span>
<a href="#l56.31"></a><span id="l56.31">                 // Make sure the stream is reset</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineminus">-                stream = aUploadData.QueryInterface(Components.interfaces.nsISeekableStream);</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineminus">-                stream.seek(Components.interfaces.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineplus">+                stream = aUploadData.QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l56.35"></a><span id="l56.35" class="difflineplus">+                stream.seek(Ci.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l56.36"></a><span id="l56.36">             } else {</span>
<a href="#l56.37"></a><span id="l56.37">                 // Otherwise its something that should be a string, convert it.</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineminus">-                let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l56.39"></a><span id="l56.39" class="difflineminus">-                                          .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l56.40"></a><span id="l56.40" class="difflineplus">+                let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l56.41"></a><span id="l56.41" class="difflineplus">+                                  .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l56.42"></a><span id="l56.42">                 converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l56.43"></a><span id="l56.43">                 stream = converter.convertToInputStream(aUploadData.toString());</span>
<a href="#l56.44"></a><span id="l56.44">             }</span>
<a href="#l56.45"></a><span id="l56.45"> </span>
<a href="#l56.46"></a><span id="l56.46">             httpchannel.setUploadStream(stream, aContentType, -1);</span>
<a href="#l56.47"></a><span id="l56.47">         }</span>
<a href="#l56.48"></a><span id="l56.48"> </span>
<a href="#l56.49"></a><span id="l56.49">         return httpchannel;</span>
<a href="#l56.50"></a><span id="l56.50" class="difflineat">@@ -84,18 +84,17 @@ var calprovider = {</span>
<a href="#l56.51"></a><span id="l56.51">     },</span>
<a href="#l56.52"></a><span id="l56.52"> </span>
<a href="#l56.53"></a><span id="l56.53">     /**</span>
<a href="#l56.54"></a><span id="l56.54">      * Shortcut to create an nsIStreamLoader</span>
<a href="#l56.55"></a><span id="l56.55">      *</span>
<a href="#l56.56"></a><span id="l56.56">      * @return {nsIStreamLoader}        A fresh streamloader</span>
<a href="#l56.57"></a><span id="l56.57">      */</span>
<a href="#l56.58"></a><span id="l56.58">     createStreamLoader: function() {</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineminus">-        return Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l56.60"></a><span id="l56.60" class="difflineminus">-                         .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l56.61"></a><span id="l56.61" class="difflineplus">+        return Cc[&quot;@mozilla.org/network/stream-loader;1&quot;].createInstance(Ci.nsIStreamLoader);</span>
<a href="#l56.62"></a><span id="l56.62">     },</span>
<a href="#l56.63"></a><span id="l56.63"> </span>
<a href="#l56.64"></a><span id="l56.64">     /**</span>
<a href="#l56.65"></a><span id="l56.65">      * Convert a byte array to a string</span>
<a href="#l56.66"></a><span id="l56.66">      *</span>
<a href="#l56.67"></a><span id="l56.67">      * @param {octet[]} aResult         The bytes to convert</span>
<a href="#l56.68"></a><span id="l56.68">      * @param {Number} aResultLength    The number of bytes</span>
<a href="#l56.69"></a><span id="l56.69">      * @param {String} aCharset         The character set of the bytes, defaults to utf-8</span>
<a href="#l56.70"></a><span id="l56.70" class="difflineat">@@ -138,25 +137,25 @@ var calprovider = {</span>
<a href="#l56.71"></a><span id="l56.71">      */</span>
<a href="#l56.72"></a><span id="l56.72">     InterfaceRequestor_getInterface: function(aIID) {</span>
<a href="#l56.73"></a><span id="l56.73">         try {</span>
<a href="#l56.74"></a><span id="l56.74">             // Try to query the this object for the requested interface but don't</span>
<a href="#l56.75"></a><span id="l56.75">             // throw if it fails since that borks the network code.</span>
<a href="#l56.76"></a><span id="l56.76">             return this.QueryInterface(aIID);</span>
<a href="#l56.77"></a><span id="l56.77">         } catch (e) {</span>
<a href="#l56.78"></a><span id="l56.78">             // Support Auth Prompt Interfaces</span>
<a href="#l56.79"></a><span id="l56.79" class="difflineminus">-            if (aIID.equals(Components.interfaces.nsIAuthPrompt2)) {</span>
<a href="#l56.80"></a><span id="l56.80" class="difflineplus">+            if (aIID.equals(Ci.nsIAuthPrompt2)) {</span>
<a href="#l56.81"></a><span id="l56.81">                 if (!this.calAuthPrompt) {</span>
<a href="#l56.82"></a><span id="l56.82">                     this.calAuthPrompt = new cal.auth.Prompt();</span>
<a href="#l56.83"></a><span id="l56.83">                 }</span>
<a href="#l56.84"></a><span id="l56.84">                 return this.calAuthPrompt;</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineminus">-            } else if (aIID.equals(Components.interfaces.nsIAuthPromptProvider) ||</span>
<a href="#l56.86"></a><span id="l56.86" class="difflineminus">-                       aIID.equals(Components.interfaces.nsIPrompt)) {</span>
<a href="#l56.87"></a><span id="l56.87" class="difflineplus">+            } else if (aIID.equals(Ci.nsIAuthPromptProvider) ||</span>
<a href="#l56.88"></a><span id="l56.88" class="difflineplus">+                       aIID.equals(Ci.nsIPrompt)) {</span>
<a href="#l56.89"></a><span id="l56.89">                 return Services.ww.getNewPrompter(null);</span>
<a href="#l56.90"></a><span id="l56.90" class="difflineminus">-            } else if (aIID.equals(Components.interfaces.nsIBadCertListener2)) {</span>
<a href="#l56.91"></a><span id="l56.91" class="difflineplus">+            } else if (aIID.equals(Ci.nsIBadCertListener2)) {</span>
<a href="#l56.92"></a><span id="l56.92">                 if (!this.badCertHandler) {</span>
<a href="#l56.93"></a><span id="l56.93">                     this.badCertHandler = new cal.provider.BadCertHandler(this);</span>
<a href="#l56.94"></a><span id="l56.94">                 }</span>
<a href="#l56.95"></a><span id="l56.95">                 return this.badCertHandler;</span>
<a href="#l56.96"></a><span id="l56.96">             } else {</span>
<a href="#l56.97"></a><span id="l56.97">                 Components.returnCode = e;</span>
<a href="#l56.98"></a><span id="l56.98">             }</span>
<a href="#l56.99"></a><span id="l56.99">         }</span>
<a href="#l56.100"></a><span id="l56.100" class="difflineat">@@ -200,22 +199,21 @@ var calprovider = {</span>
<a href="#l56.101"></a><span id="l56.101">                     if (this.thisProvider.canRefresh &amp;&amp;</span>
<a href="#l56.102"></a><span id="l56.102">                         params.exceptionAdded) {</span>
<a href="#l56.103"></a><span id="l56.103">                         // Refresh the provider if the</span>
<a href="#l56.104"></a><span id="l56.104">                         // exception certificate was added</span>
<a href="#l56.105"></a><span id="l56.105">                         this.thisProvider.refresh();</span>
<a href="#l56.106"></a><span id="l56.106">                     }</span>
<a href="#l56.107"></a><span id="l56.107">                 }</span>
<a href="#l56.108"></a><span id="l56.108">             };</span>
<a href="#l56.109"></a><span id="l56.109" class="difflineminus">-            this.timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l56.110"></a><span id="l56.110" class="difflineminus">-                                   .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l56.111"></a><span id="l56.111" class="difflineplus">+            this.timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l56.112"></a><span id="l56.112">             this.timer.initWithCallback(</span>
<a href="#l56.113"></a><span id="l56.113">                 timerCallback,</span>
<a href="#l56.114"></a><span id="l56.114">                 0,</span>
<a href="#l56.115"></a><span id="l56.115" class="difflineminus">-                Components.interfaces.nsITimer.TYPE_ONE_SHOT</span>
<a href="#l56.116"></a><span id="l56.116" class="difflineplus">+                Ci.nsITimer.TYPE_ONE_SHOT</span>
<a href="#l56.117"></a><span id="l56.117">             );</span>
<a href="#l56.118"></a><span id="l56.118">             return true;</span>
<a href="#l56.119"></a><span id="l56.119">         }</span>
<a href="#l56.120"></a><span id="l56.120">     },</span>
<a href="#l56.121"></a><span id="l56.121"> </span>
<a href="#l56.122"></a><span id="l56.122">     /**</span>
<a href="#l56.123"></a><span id="l56.123">      * Freebusy interval implementation. All parameters are optional.</span>
<a href="#l56.124"></a><span id="l56.124">      *</span>
<a href="#l56.125"></a><span id="l56.125" class="difflineat">@@ -227,65 +225,65 @@ var calprovider = {</span>
<a href="#l56.126"></a><span id="l56.126">      */</span>
<a href="#l56.127"></a><span id="l56.127">     FreeBusyInterval: class {</span>
<a href="#l56.128"></a><span id="l56.128">         QueryInterface() {</span>
<a href="#l56.129"></a><span id="l56.129">             return ChromeUtils.generateQI([Ci.calIFreeBusyInterval]);</span>
<a href="#l56.130"></a><span id="l56.130">         }</span>
<a href="#l56.131"></a><span id="l56.131"> </span>
<a href="#l56.132"></a><span id="l56.132">         constructor(aCalId, aFreeBusyType, aStart, aEnd) {</span>
<a href="#l56.133"></a><span id="l56.133">             this.calId = aCalId;</span>
<a href="#l56.134"></a><span id="l56.134" class="difflineminus">-            this.interval = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l56.135"></a><span id="l56.135" class="difflineminus">-                                      .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l56.136"></a><span id="l56.136" class="difflineplus">+            this.interval = Cc[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l56.137"></a><span id="l56.137" class="difflineplus">+                              .createInstance(Ci.calIPeriod);</span>
<a href="#l56.138"></a><span id="l56.138">             this.interval.start = aStart;</span>
<a href="#l56.139"></a><span id="l56.139">             this.interval.end = aEnd;</span>
<a href="#l56.140"></a><span id="l56.140"> </span>
<a href="#l56.141"></a><span id="l56.141" class="difflineminus">-            this.freeBusyType = aFreeBusyType || Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l56.142"></a><span id="l56.142" class="difflineplus">+            this.freeBusyType = aFreeBusyType || Ci.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l56.143"></a><span id="l56.143">         }</span>
<a href="#l56.144"></a><span id="l56.144">     },</span>
<a href="#l56.145"></a><span id="l56.145"> </span>
<a href="#l56.146"></a><span id="l56.146">     /**</span>
<a href="#l56.147"></a><span id="l56.147">      * Gets the iTIP/iMIP transport if the passed calendar has configured email.</span>
<a href="#l56.148"></a><span id="l56.148">      *</span>
<a href="#l56.149"></a><span id="l56.149">      * @param {calICalendar} aCalendar      The calendar to get the transport for</span>
<a href="#l56.150"></a><span id="l56.150">      * @return {?calIItipTransport}         The email transport, or null if no identity configured</span>
<a href="#l56.151"></a><span id="l56.151">      */</span>
<a href="#l56.152"></a><span id="l56.152">     getImipTransport: function(aCalendar) {</span>
<a href="#l56.153"></a><span id="l56.153">         // assure an identity is configured for the calendar</span>
<a href="#l56.154"></a><span id="l56.154">         if (aCalendar &amp;&amp; aCalendar.getProperty(&quot;imip.identity&quot;)) {</span>
<a href="#l56.155"></a><span id="l56.155" class="difflineminus">-            return Components.classes[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;]</span>
<a href="#l56.156"></a><span id="l56.156" class="difflineminus">-                             .getService(Components.interfaces.calIItipTransport);</span>
<a href="#l56.157"></a><span id="l56.157" class="difflineplus">+            return Cc[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;]</span>
<a href="#l56.158"></a><span id="l56.158" class="difflineplus">+                     .getService(Ci.calIItipTransport);</span>
<a href="#l56.159"></a><span id="l56.159">         }</span>
<a href="#l56.160"></a><span id="l56.160">         return null;</span>
<a href="#l56.161"></a><span id="l56.161">     },</span>
<a href="#l56.162"></a><span id="l56.162"> </span>
<a href="#l56.163"></a><span id="l56.163">     /**</span>
<a href="#l56.164"></a><span id="l56.164">      * Gets the configured identity and account of a particular calendar instance, or null.</span>
<a href="#l56.165"></a><span id="l56.165">      *</span>
<a href="#l56.166"></a><span id="l56.166">      * @param {calICalendar} aCalendar      Calendar instance</span>
<a href="#l56.167"></a><span id="l56.167">      * @param {?Object} outAccount          Optional out value for account</span>
<a href="#l56.168"></a><span id="l56.168">      * @return {nsIMsgIdentity}             The configured identity</span>
<a href="#l56.169"></a><span id="l56.169">      */</span>
<a href="#l56.170"></a><span id="l56.170">     getEmailIdentityOfCalendar: function(aCalendar, outAccount) {</span>
<a href="#l56.171"></a><span id="l56.171" class="difflineminus">-        cal.ASSERT(aCalendar, &quot;no calendar!&quot;, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l56.172"></a><span id="l56.172" class="difflineplus">+        cal.ASSERT(aCalendar, &quot;no calendar!&quot;, Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l56.173"></a><span id="l56.173">         let key = aCalendar.getProperty(&quot;imip.identity.key&quot;);</span>
<a href="#l56.174"></a><span id="l56.174">         if (key === null) { // take default account/identity:</span>
<a href="#l56.175"></a><span id="l56.175">             let findIdentity = function(account) {</span>
<a href="#l56.176"></a><span id="l56.176">                 if (account &amp;&amp; account.identities.length) {</span>
<a href="#l56.177"></a><span id="l56.177">                     return account.defaultIdentity ||</span>
<a href="#l56.178"></a><span id="l56.178" class="difflineminus">-                           account.identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l56.179"></a><span id="l56.179" class="difflineplus">+                           account.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l56.180"></a><span id="l56.180">                 }</span>
<a href="#l56.181"></a><span id="l56.181">                 return null;</span>
<a href="#l56.182"></a><span id="l56.182">             };</span>
<a href="#l56.183"></a><span id="l56.183"> </span>
<a href="#l56.184"></a><span id="l56.184">             let foundAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l56.185"></a><span id="l56.185">             let foundIdentity = findIdentity(foundAccount);</span>
<a href="#l56.186"></a><span id="l56.186"> </span>
<a href="#l56.187"></a><span id="l56.187">             if (!foundAccount || !foundIdentity) {</span>
<a href="#l56.188"></a><span id="l56.188">                 let accounts = MailServices.accounts.accounts;</span>
<a href="#l56.189"></a><span id="l56.189" class="difflineminus">-                for (let account of fixIterator(accounts, Components.interfaces.nsIMsgAccount)) {</span>
<a href="#l56.190"></a><span id="l56.190" class="difflineplus">+                for (let account of fixIterator(accounts, Ci.nsIMsgAccount)) {</span>
<a href="#l56.191"></a><span id="l56.191">                     let identity = findIdentity(account);</span>
<a href="#l56.192"></a><span id="l56.192"> </span>
<a href="#l56.193"></a><span id="l56.193">                     if (account &amp;&amp; identity) {</span>
<a href="#l56.194"></a><span id="l56.194">                         foundAccount = account;</span>
<a href="#l56.195"></a><span id="l56.195">                         foundIdentity = identity;</span>
<a href="#l56.196"></a><span id="l56.196">                         break;</span>
<a href="#l56.197"></a><span id="l56.197">                     }</span>
<a href="#l56.198"></a><span id="l56.198">                 }</span>
<a href="#l56.199"></a><span id="l56.199" class="difflineat">@@ -344,21 +342,21 @@ var calprovider = {</span>
<a href="#l56.200"></a><span id="l56.200"> </span>
<a href="#l56.201"></a><span id="l56.201">     /**</span>
<a href="#l56.202"></a><span id="l56.202">      * Gets the calendar directory, defaults to &lt;profile-dir&gt;/calendar-data</span>
<a href="#l56.203"></a><span id="l56.203">      *</span>
<a href="#l56.204"></a><span id="l56.204">      * @return {nsIFile}        The calendar-data directory as nsIFile</span>
<a href="#l56.205"></a><span id="l56.205">      */</span>
<a href="#l56.206"></a><span id="l56.206">     getCalendarDirectory: function() {</span>
<a href="#l56.207"></a><span id="l56.207">         if (calprovider.getCalendarDirectory.mDir === undefined) {</span>
<a href="#l56.208"></a><span id="l56.208" class="difflineminus">-            let dir = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l56.209"></a><span id="l56.209" class="difflineplus">+            let dir = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l56.210"></a><span id="l56.210">             dir.append(&quot;calendar-data&quot;);</span>
<a href="#l56.211"></a><span id="l56.211">             if (!dir.exists()) {</span>
<a href="#l56.212"></a><span id="l56.212">                 try {</span>
<a href="#l56.213"></a><span id="l56.213" class="difflineminus">-                    dir.create(Components.interfaces.nsIFile.DIRECTORY_TYPE, 0o700);</span>
<a href="#l56.214"></a><span id="l56.214" class="difflineplus">+                    dir.create(Ci.nsIFile.DIRECTORY_TYPE, 0o700);</span>
<a href="#l56.215"></a><span id="l56.215">                 } catch (exc) {</span>
<a href="#l56.216"></a><span id="l56.216">                     cal.ASSERT(false, exc);</span>
<a href="#l56.217"></a><span id="l56.217">                     throw exc;</span>
<a href="#l56.218"></a><span id="l56.218">                 }</span>
<a href="#l56.219"></a><span id="l56.219">             }</span>
<a href="#l56.220"></a><span id="l56.220">             calprovider.getCalendarDirectory.mDir = dir;</span>
<a href="#l56.221"></a><span id="l56.221">         }</span>
<a href="#l56.222"></a><span id="l56.222">         return calprovider.getCalendarDirectory.mDir.clone();</span>
<a href="#l56.223"></a><span id="l56.223" class="difflineat">@@ -383,51 +381,51 @@ var calprovider = {</span>
<a href="#l56.224"></a><span id="l56.224">                 &quot;imip.identity.disabled&quot;: true,</span>
<a href="#l56.225"></a><span id="l56.225">                 &quot;organizerId&quot;: true,</span>
<a href="#l56.226"></a><span id="l56.226">                 &quot;organizerCN&quot;: true</span>
<a href="#l56.227"></a><span id="l56.227">             };</span>
<a href="#l56.228"></a><span id="l56.228">         }</span>
<a href="#l56.229"></a><span id="l56.229"> </span>
<a href="#l56.230"></a><span id="l56.230">         QueryInterface(iid) {</span>
<a href="#l56.231"></a><span id="l56.231">             return cal.generateClassQI(this, iid, [</span>
<a href="#l56.232"></a><span id="l56.232" class="difflineminus">-                Components.interfaces.calICalendar,</span>
<a href="#l56.233"></a><span id="l56.233" class="difflineminus">-                Components.interfaces.calISchedulingSupport</span>
<a href="#l56.234"></a><span id="l56.234" class="difflineplus">+                Ci.calICalendar,</span>
<a href="#l56.235"></a><span id="l56.235" class="difflineplus">+                Ci.calISchedulingSupport</span>
<a href="#l56.236"></a><span id="l56.236">             ]);</span>
<a href="#l56.237"></a><span id="l56.237">         }</span>
<a href="#l56.238"></a><span id="l56.238"> </span>
<a href="#l56.239"></a><span id="l56.239">         /**</span>
<a href="#l56.240"></a><span id="l56.240">          * Initialize the base class, this should be migrated to an ES6 constructor once all</span>
<a href="#l56.241"></a><span id="l56.241">          * subclasses are also es6 classes. Call this from the constructor.</span>
<a href="#l56.242"></a><span id="l56.242">          */</span>
<a href="#l56.243"></a><span id="l56.243">         initProviderBase() {</span>
<a href="#l56.244"></a><span id="l56.244">             this.wrappedJSObject = this;</span>
<a href="#l56.245"></a><span id="l56.245">             this.mID = null;</span>
<a href="#l56.246"></a><span id="l56.246">             this.mUri = null;</span>
<a href="#l56.247"></a><span id="l56.247">             this.mACLEntry = null;</span>
<a href="#l56.248"></a><span id="l56.248">             this.mBatchCount = 0;</span>
<a href="#l56.249"></a><span id="l56.249">             this.transientProperties = false;</span>
<a href="#l56.250"></a><span id="l56.250" class="difflineminus">-            this.mObservers = new cal.data.ObserverSet(Components.interfaces.calIObserver);</span>
<a href="#l56.251"></a><span id="l56.251" class="difflineplus">+            this.mObservers = new cal.data.ObserverSet(Ci.calIObserver);</span>
<a href="#l56.252"></a><span id="l56.252">             this.mProperties = {};</span>
<a href="#l56.253"></a><span id="l56.253" class="difflineminus">-            this.mProperties.currentStatus = Components.results.NS_OK;</span>
<a href="#l56.254"></a><span id="l56.254" class="difflineplus">+            this.mProperties.currentStatus = Cr.NS_OK;</span>
<a href="#l56.255"></a><span id="l56.255">         }</span>
<a href="#l56.256"></a><span id="l56.256"> </span>
<a href="#l56.257"></a><span id="l56.257">         /**</span>
<a href="#l56.258"></a><span id="l56.258">          * Returns the calIObservers for this calendar</span>
<a href="#l56.259"></a><span id="l56.259">          */</span>
<a href="#l56.260"></a><span id="l56.260">         get observers() {</span>
<a href="#l56.261"></a><span id="l56.261">             return this.mObservers;</span>
<a href="#l56.262"></a><span id="l56.262">         }</span>
<a href="#l56.263"></a><span id="l56.263"> </span>
<a href="#l56.264"></a><span id="l56.264">         // attribute AUTF8String id;</span>
<a href="#l56.265"></a><span id="l56.265">         get id() {</span>
<a href="#l56.266"></a><span id="l56.266">             return this.mID;</span>
<a href="#l56.267"></a><span id="l56.267">         }</span>
<a href="#l56.268"></a><span id="l56.268">         set id(aValue) {</span>
<a href="#l56.269"></a><span id="l56.269">             if (this.mID) {</span>
<a href="#l56.270"></a><span id="l56.270" class="difflineminus">-                throw Components.results.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l56.271"></a><span id="l56.271" class="difflineplus">+                throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l56.272"></a><span id="l56.272">             }</span>
<a href="#l56.273"></a><span id="l56.273">             this.mID = aValue;</span>
<a href="#l56.274"></a><span id="l56.274"> </span>
<a href="#l56.275"></a><span id="l56.275">             let calMgr = cal.getCalendarManager();</span>
<a href="#l56.276"></a><span id="l56.276"> </span>
<a href="#l56.277"></a><span id="l56.277">             // make all properties persistent that have been set so far:</span>
<a href="#l56.278"></a><span id="l56.278">             for (let aName in this.mProperties) {</span>
<a href="#l56.279"></a><span id="l56.279">                 if (!this.constructor.mTransientProperties[aName]) {</span>
<a href="#l56.280"></a><span id="l56.280" class="difflineat">@@ -448,20 +446,20 @@ var calprovider = {</span>
<a href="#l56.281"></a><span id="l56.281">         set name(aValue) {</span>
<a href="#l56.282"></a><span id="l56.282">             return this.setProperty(&quot;name&quot;, aValue);</span>
<a href="#l56.283"></a><span id="l56.283">         }</span>
<a href="#l56.284"></a><span id="l56.284"> </span>
<a href="#l56.285"></a><span id="l56.285">         // readonly attribute calICalendarACLManager aclManager;</span>
<a href="#l56.286"></a><span id="l56.286">         get aclManager() {</span>
<a href="#l56.287"></a><span id="l56.287">             const defaultACLProviderClass = &quot;@mozilla.org/calendar/acl-manager;1?type=default&quot;;</span>
<a href="#l56.288"></a><span id="l56.288">             let providerClass = this.getProperty(&quot;aclManagerClass&quot;);</span>
<a href="#l56.289"></a><span id="l56.289" class="difflineminus">-            if (!providerClass || !Components.classes[providerClass]) {</span>
<a href="#l56.290"></a><span id="l56.290" class="difflineplus">+            if (!providerClass || !Cc[providerClass]) {</span>
<a href="#l56.291"></a><span id="l56.291">                 providerClass = defaultACLProviderClass;</span>
<a href="#l56.292"></a><span id="l56.292">             }</span>
<a href="#l56.293"></a><span id="l56.293" class="difflineminus">-            return Components.classes[providerClass].getService(Components.interfaces.calICalendarACLManager);</span>
<a href="#l56.294"></a><span id="l56.294" class="difflineplus">+            return Cc[providerClass].getService(Ci.calICalendarACLManager);</span>
<a href="#l56.295"></a><span id="l56.295">         }</span>
<a href="#l56.296"></a><span id="l56.296"> </span>
<a href="#l56.297"></a><span id="l56.297">         // readonly attribute calICalendarACLEntry aclEntry;</span>
<a href="#l56.298"></a><span id="l56.298">         get aclEntry() {</span>
<a href="#l56.299"></a><span id="l56.299">             return this.mACLEntry;</span>
<a href="#l56.300"></a><span id="l56.300">         }</span>
<a href="#l56.301"></a><span id="l56.301"> </span>
<a href="#l56.302"></a><span id="l56.302">         // attribute calICalendar superCalendar;</span>
<a href="#l56.303"></a><span id="l56.303" class="difflineat">@@ -542,46 +540,46 @@ var calprovider = {</span>
<a href="#l56.304"></a><span id="l56.304">          * @param {Number} aOperationType                   The operation type component</span>
<a href="#l56.305"></a><span id="l56.305">          * @param {String} aId                              The item id</span>
<a href="#l56.306"></a><span id="l56.306">          * @param {*} aDetail                               The item detail for the listener</span>
<a href="#l56.307"></a><span id="l56.307">          * @param {String} aExtraMessage                    An extra message to pass to notifyError</span>
<a href="#l56.308"></a><span id="l56.308">          */</span>
<a href="#l56.309"></a><span id="l56.309">         notifyOperationComplete(aListener, aStatus, aOperationType, aId, aDetail, aExtraMessage) {</span>
<a href="#l56.310"></a><span id="l56.310">             this.notifyPureOperationComplete(aListener, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l56.311"></a><span id="l56.311"> </span>
<a href="#l56.312"></a><span id="l56.312" class="difflineminus">-            if (aStatus == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l56.313"></a><span id="l56.313" class="difflineplus">+            if (aStatus == Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l56.314"></a><span id="l56.314">                 return; // cancellation doesn't change current status, no notification</span>
<a href="#l56.315"></a><span id="l56.315">             }</span>
<a href="#l56.316"></a><span id="l56.316">             if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l56.317"></a><span id="l56.317">                 this.setProperty(&quot;currentStatus&quot;, aStatus);</span>
<a href="#l56.318"></a><span id="l56.318">             } else {</span>
<a href="#l56.319"></a><span id="l56.319" class="difflineminus">-                if (aDetail instanceof Components.interfaces.nsIException) {</span>
<a href="#l56.320"></a><span id="l56.320" class="difflineplus">+                if (aDetail instanceof Ci.nsIException) {</span>
<a href="#l56.321"></a><span id="l56.321">                     this.notifyError(aDetail); // will set currentStatus</span>
<a href="#l56.322"></a><span id="l56.322">                 } else {</span>
<a href="#l56.323"></a><span id="l56.323">                     this.notifyError(aStatus, aDetail); // will set currentStatus</span>
<a href="#l56.324"></a><span id="l56.324">                 }</span>
<a href="#l56.325"></a><span id="l56.325" class="difflineminus">-                this.notifyError(aOperationType == Components.interfaces.calIOperationListener.GET</span>
<a href="#l56.326"></a><span id="l56.326" class="difflineminus">-                                 ? Components.interfaces.calIErrors.READ_FAILED</span>
<a href="#l56.327"></a><span id="l56.327" class="difflineminus">-                                 : Components.interfaces.calIErrors.MODIFICATION_FAILED,</span>
<a href="#l56.328"></a><span id="l56.328" class="difflineplus">+                this.notifyError(aOperationType == Ci.calIOperationListener.GET</span>
<a href="#l56.329"></a><span id="l56.329" class="difflineplus">+                                 ? Ci.calIErrors.READ_FAILED</span>
<a href="#l56.330"></a><span id="l56.330" class="difflineplus">+                                 : Ci.calIErrors.MODIFICATION_FAILED,</span>
<a href="#l56.331"></a><span id="l56.331">                                  aExtraMessage || &quot;&quot;);</span>
<a href="#l56.332"></a><span id="l56.332">             }</span>
<a href="#l56.333"></a><span id="l56.333">         }</span>
<a href="#l56.334"></a><span id="l56.334"> </span>
<a href="#l56.335"></a><span id="l56.335">         /**</span>
<a href="#l56.336"></a><span id="l56.336">          * Notify observers using the onError notification with a readable error message</span>
<a href="#l56.337"></a><span id="l56.337">          *</span>
<a href="#l56.338"></a><span id="l56.338">          * @param {Number|nsIException} aErrNo      The error number from Components.results, or</span>
<a href="#l56.339"></a><span id="l56.339">          *                                            the exception which contains the error number</span>
<a href="#l56.340"></a><span id="l56.340">          * @param {?String} aMessage                The message to show for the error</span>
<a href="#l56.341"></a><span id="l56.341">          */</span>
<a href="#l56.342"></a><span id="l56.342">         notifyError(aErrNo, aMessage=null) {</span>
<a href="#l56.343"></a><span id="l56.343" class="difflineminus">-            if (aErrNo == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l56.344"></a><span id="l56.344" class="difflineplus">+            if (aErrNo == Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l56.345"></a><span id="l56.345">                 return; // cancellation doesn't change current status, no notification</span>
<a href="#l56.346"></a><span id="l56.346">             }</span>
<a href="#l56.347"></a><span id="l56.347" class="difflineminus">-            if (aErrNo instanceof Components.interfaces.nsIException) {</span>
<a href="#l56.348"></a><span id="l56.348" class="difflineplus">+            if (aErrNo instanceof Ci.nsIException) {</span>
<a href="#l56.349"></a><span id="l56.349">                 if (!aMessage) {</span>
<a href="#l56.350"></a><span id="l56.350">                     aMessage = aErrNo.message;</span>
<a href="#l56.351"></a><span id="l56.351">                 }</span>
<a href="#l56.352"></a><span id="l56.352">                 aErrNo = aErrNo.result;</span>
<a href="#l56.353"></a><span id="l56.353">             }</span>
<a href="#l56.354"></a><span id="l56.354">             this.setProperty(&quot;currentStatus&quot;, aErrNo);</span>
<a href="#l56.355"></a><span id="l56.355">             this.observers.notify(&quot;onError&quot;, [this.superCalendar, aErrNo, aMessage]);</span>
<a href="#l56.356"></a><span id="l56.356">         }</span>
<a href="#l56.357"></a><span id="l56.357" class="difflineat">@@ -611,24 +609,24 @@ var calprovider = {</span>
<a href="#l56.358"></a><span id="l56.358">                         if (calprovider.getEmailIdentityOfCalendar(this, outAccount)) {</span>
<a href="#l56.359"></a><span id="l56.359">                             ret = outAccount.value;</span>
<a href="#l56.360"></a><span id="l56.360">                         }</span>
<a href="#l56.361"></a><span id="l56.361">                         break;</span>
<a href="#l56.362"></a><span id="l56.362">                     }</span>
<a href="#l56.363"></a><span id="l56.363">                     case &quot;organizerId&quot;: { // itip/imip default: derived out of imip.identity</span>
<a href="#l56.364"></a><span id="l56.364">                         let identity = this.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l56.365"></a><span id="l56.365">                         ret = (identity</span>
<a href="#l56.366"></a><span id="l56.366" class="difflineminus">-                               ? (&quot;mailto:&quot; + identity.QueryInterface(Components.interfaces.nsIMsgIdentity).email)</span>
<a href="#l56.367"></a><span id="l56.367" class="difflineplus">+                               ? (&quot;mailto:&quot; + identity.QueryInterface(Ci.nsIMsgIdentity).email)</span>
<a href="#l56.368"></a><span id="l56.368">                                : null);</span>
<a href="#l56.369"></a><span id="l56.369">                         break;</span>
<a href="#l56.370"></a><span id="l56.370">                     }</span>
<a href="#l56.371"></a><span id="l56.371">                     case &quot;organizerCN&quot;: { // itip/imip default: derived out of imip.identity</span>
<a href="#l56.372"></a><span id="l56.372">                         let identity = this.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l56.373"></a><span id="l56.373">                         ret = (identity</span>
<a href="#l56.374"></a><span id="l56.374" class="difflineminus">-                               ? identity.QueryInterface(Components.interfaces.nsIMsgIdentity).fullName</span>
<a href="#l56.375"></a><span id="l56.375" class="difflineplus">+                               ? identity.QueryInterface(Ci.nsIMsgIdentity).fullName</span>
<a href="#l56.376"></a><span id="l56.376">                                : null);</span>
<a href="#l56.377"></a><span id="l56.377">                         break;</span>
<a href="#l56.378"></a><span id="l56.378">                     }</span>
<a href="#l56.379"></a><span id="l56.379">                 }</span>
<a href="#l56.380"></a><span id="l56.380">                 if ((ret === null) &amp;&amp;</span>
<a href="#l56.381"></a><span id="l56.381">                     !this.constructor.mTransientProperties[aName] &amp;&amp;</span>
<a href="#l56.382"></a><span id="l56.382">                     !this.transientProperties) {</span>
<a href="#l56.383"></a><span id="l56.383">                     if (this.id) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/calendar/base/modules/utils/calViewUtils.jsm</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/calendar/base/modules/utils/calViewUtils.jsm</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -149,24 +149,24 @@ var calview = {</span>
<a href="#l57.4"></a><span id="l57.4"> </span>
<a href="#l57.5"></a><span id="l57.5">     /**</span>
<a href="#l57.6"></a><span id="l57.6">      * Gets the cached instance of the composite calendar.</span>
<a href="#l57.7"></a><span id="l57.7">      *</span>
<a href="#l57.8"></a><span id="l57.8">      * @param aWindow       The window to get the composite calendar for.</span>
<a href="#l57.9"></a><span id="l57.9">      */</span>
<a href="#l57.10"></a><span id="l57.10">     getCompositeCalendar: function(aWindow) {</span>
<a href="#l57.11"></a><span id="l57.11">         if (typeof aWindow._compositeCalendar == &quot;undefined&quot;) {</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-            let comp = aWindow._compositeCalendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineminus">-                                                              .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+            let comp = aWindow._compositeCalendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineplus">+                                                      .createInstance(Ci.calICompositeCalendar);</span>
<a href="#l57.16"></a><span id="l57.16">             comp.prefPrefix = &quot;calendar-main&quot;;</span>
<a href="#l57.17"></a><span id="l57.17"> </span>
<a href="#l57.18"></a><span id="l57.18">             if (typeof aWindow.gCalendarStatusFeedback != &quot;undefined&quot;) {</span>
<a href="#l57.19"></a><span id="l57.19">                 // If we are in a window that has calendar status feedback, set</span>
<a href="#l57.20"></a><span id="l57.20">                 // up our status observer.</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineminus">-                let chromeWindow = aWindow.QueryInterface(Components.interfaces.nsIDOMChromeWindow);</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+                let chromeWindow = aWindow.QueryInterface(Ci.nsIDOMChromeWindow);</span>
<a href="#l57.23"></a><span id="l57.23">                 comp.setStatusObserver(aWindow.gCalendarStatusFeedback, chromeWindow);</span>
<a href="#l57.24"></a><span id="l57.24">             }</span>
<a href="#l57.25"></a><span id="l57.25">         }</span>
<a href="#l57.26"></a><span id="l57.26">         return aWindow._compositeCalendar;</span>
<a href="#l57.27"></a><span id="l57.27">     },</span>
<a href="#l57.28"></a><span id="l57.28"> </span>
<a href="#l57.29"></a><span id="l57.29">     /**</span>
<a href="#l57.30"></a><span id="l57.30">      * Hash the given string into a color from the color palette of the standard</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -1,18 +1,18 @@</span>
<a href="#l58.4"></a><span id="l58.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l58.5"></a><span id="l58.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l58.6"></a><span id="l58.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l58.7"></a><span id="l58.7"> </span>
<a href="#l58.8"></a><span id="l58.8"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l58.9"></a><span id="l58.9"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l58.10"></a><span id="l58.10"> </span>
<a href="#l58.11"></a><span id="l58.11" class="difflineminus">-var ALARM_RELATED_ABSOLUTE = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-var ALARM_RELATED_START = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-var ALARM_RELATED_END = Components.interfaces.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+var ALARM_RELATED_ABSOLUTE = Ci.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+var ALARM_RELATED_START = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineplus">+var ALARM_RELATED_END = Ci.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l58.17"></a><span id="l58.17"> </span>
<a href="#l58.18"></a><span id="l58.18"> function calAlarm() {</span>
<a href="#l58.19"></a><span id="l58.19">     this.wrappedJSObject = this;</span>
<a href="#l58.20"></a><span id="l58.20">     this.mProperties = new Map();</span>
<a href="#l58.21"></a><span id="l58.21">     this.mPropertyParams = {};</span>
<a href="#l58.22"></a><span id="l58.22">     this.mAttendees = [];</span>
<a href="#l58.23"></a><span id="l58.23">     this.mAttachments = [];</span>
<a href="#l58.24"></a><span id="l58.24"> }</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineat">@@ -37,17 +37,17 @@ calAlarm.prototype = {</span>
<a href="#l58.26"></a><span id="l58.26">     mRepeat: 0,</span>
<a href="#l58.27"></a><span id="l58.27"> </span>
<a href="#l58.28"></a><span id="l58.28">     /**</span>
<a href="#l58.29"></a><span id="l58.29">      * calIAlarm</span>
<a href="#l58.30"></a><span id="l58.30">      */</span>
<a href="#l58.31"></a><span id="l58.31"> </span>
<a href="#l58.32"></a><span id="l58.32">     ensureMutable: function() {</span>
<a href="#l58.33"></a><span id="l58.33">         if (this.mImmutable) {</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineplus">+            throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l58.36"></a><span id="l58.36">         }</span>
<a href="#l58.37"></a><span id="l58.37">     },</span>
<a href="#l58.38"></a><span id="l58.38"> </span>
<a href="#l58.39"></a><span id="l58.39">     get isMutable() {</span>
<a href="#l58.40"></a><span id="l58.40">         return !this.mImmutable;</span>
<a href="#l58.41"></a><span id="l58.41">     },</span>
<a href="#l58.42"></a><span id="l58.42"> </span>
<a href="#l58.43"></a><span id="l58.43">     makeImmutable: function() {</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineat">@@ -64,17 +64,17 @@ calAlarm.prototype = {</span>
<a href="#l58.45"></a><span id="l58.45">         for (let member of objectMembers) {</span>
<a href="#l58.46"></a><span id="l58.46">             if (this[member] &amp;&amp; this[member].isMutable) {</span>
<a href="#l58.47"></a><span id="l58.47">                 this[member].makeImmutable();</span>
<a href="#l58.48"></a><span id="l58.48">             }</span>
<a href="#l58.49"></a><span id="l58.49">         }</span>
<a href="#l58.50"></a><span id="l58.50"> </span>
<a href="#l58.51"></a><span id="l58.51">         // Properties</span>
<a href="#l58.52"></a><span id="l58.52">         for (let propval of this.mProperties.values()) {</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineminus">-            if ((propval instanceof Components.interfaces.calIDateTime) &amp;&amp; propval.isMutable) {</span>
<a href="#l58.54"></a><span id="l58.54" class="difflineplus">+            if ((propval instanceof Ci.calIDateTime) &amp;&amp; propval.isMutable) {</span>
<a href="#l58.55"></a><span id="l58.55">                 propval.makeImmutable();</span>
<a href="#l58.56"></a><span id="l58.56">             }</span>
<a href="#l58.57"></a><span id="l58.57">         }</span>
<a href="#l58.58"></a><span id="l58.58"> </span>
<a href="#l58.59"></a><span id="l58.59">         this.mImmutable = true;</span>
<a href="#l58.60"></a><span id="l58.60">     },</span>
<a href="#l58.61"></a><span id="l58.61"> </span>
<a href="#l58.62"></a><span id="l58.62">     clone: function() {</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineat">@@ -117,17 +117,17 @@ calAlarm.prototype = {</span>
<a href="#l58.64"></a><span id="l58.64">             } else {</span>
<a href="#l58.65"></a><span id="l58.65">                 cloned[member] = this[member];</span>
<a href="#l58.66"></a><span id="l58.66">             }</span>
<a href="#l58.67"></a><span id="l58.67">         }</span>
<a href="#l58.68"></a><span id="l58.68"> </span>
<a href="#l58.69"></a><span id="l58.69">         // X-Props</span>
<a href="#l58.70"></a><span id="l58.70">         cloned.mProperties = new Map();</span>
<a href="#l58.71"></a><span id="l58.71">         for (let [name, value] of this.mProperties.entries()) {</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineminus">-            if (value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineplus">+            if (value instanceof Ci.calIDateTime) {</span>
<a href="#l58.74"></a><span id="l58.74">                 value = value.clone();</span>
<a href="#l58.75"></a><span id="l58.75">             }</span>
<a href="#l58.76"></a><span id="l58.76"> </span>
<a href="#l58.77"></a><span id="l58.77">             cloned.mProperties.set(name, value);</span>
<a href="#l58.78"></a><span id="l58.78"> </span>
<a href="#l58.79"></a><span id="l58.79">             let propBucket = this.mPropertyParams[name];</span>
<a href="#l58.80"></a><span id="l58.80">             if (propBucket) {</span>
<a href="#l58.81"></a><span id="l58.81">                 let newBucket = {};</span>
<a href="#l58.82"></a><span id="l58.82" class="difflineat">@@ -189,36 +189,36 @@ calAlarm.prototype = {</span>
<a href="#l58.83"></a><span id="l58.83">         this.ensureMutable();</span>
<a href="#l58.84"></a><span id="l58.84">         return (this.mSummary = aValue);</span>
<a href="#l58.85"></a><span id="l58.85">     },</span>
<a href="#l58.86"></a><span id="l58.86"> </span>
<a href="#l58.87"></a><span id="l58.87">     get offset() {</span>
<a href="#l58.88"></a><span id="l58.88">         return this.mOffset;</span>
<a href="#l58.89"></a><span id="l58.89">     },</span>
<a href="#l58.90"></a><span id="l58.90">     set offset(aValue) {</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineminus">-        if (aValue &amp;&amp; !(aValue instanceof Components.interfaces.calIDuration)) {</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineplus">+        if (aValue &amp;&amp; !(aValue instanceof Ci.calIDuration)) {</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.95"></a><span id="l58.95">         }</span>
<a href="#l58.96"></a><span id="l58.96">         if (this.related != ALARM_RELATED_START &amp;&amp;</span>
<a href="#l58.97"></a><span id="l58.97">             this.related != ALARM_RELATED_END) {</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineminus">-            throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineplus">+            throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l58.100"></a><span id="l58.100">         }</span>
<a href="#l58.101"></a><span id="l58.101">         this.ensureMutable();</span>
<a href="#l58.102"></a><span id="l58.102">         return (this.mOffset = aValue);</span>
<a href="#l58.103"></a><span id="l58.103">     },</span>
<a href="#l58.104"></a><span id="l58.104"> </span>
<a href="#l58.105"></a><span id="l58.105">     get alarmDate() {</span>
<a href="#l58.106"></a><span id="l58.106">         return this.mAbsoluteDate;</span>
<a href="#l58.107"></a><span id="l58.107">     },</span>
<a href="#l58.108"></a><span id="l58.108">     set alarmDate(aValue) {</span>
<a href="#l58.109"></a><span id="l58.109" class="difflineminus">-        if (aValue &amp;&amp; !(aValue instanceof Components.interfaces.calIDateTime)) {</span>
<a href="#l58.110"></a><span id="l58.110" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineplus">+        if (aValue &amp;&amp; !(aValue instanceof Ci.calIDateTime)) {</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.113"></a><span id="l58.113">         }</span>
<a href="#l58.114"></a><span id="l58.114">         if (this.related != ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l58.115"></a><span id="l58.115" class="difflineminus">-            throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineplus">+            throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l58.117"></a><span id="l58.117">         }</span>
<a href="#l58.118"></a><span id="l58.118">         this.ensureMutable();</span>
<a href="#l58.119"></a><span id="l58.119">         return (this.mAbsoluteDate = aValue);</span>
<a href="#l58.120"></a><span id="l58.120">     },</span>
<a href="#l58.121"></a><span id="l58.121"> </span>
<a href="#l58.122"></a><span id="l58.122">     get repeat() {</span>
<a href="#l58.123"></a><span id="l58.123">         if ((this.mRepeat != 0) ^ (this.mDuration != null)) {</span>
<a href="#l58.124"></a><span id="l58.124">             return 0;</span>
<a href="#l58.125"></a><span id="l58.125" class="difflineat">@@ -227,33 +227,33 @@ calAlarm.prototype = {</span>
<a href="#l58.126"></a><span id="l58.126">     },</span>
<a href="#l58.127"></a><span id="l58.127">     set repeat(aValue) {</span>
<a href="#l58.128"></a><span id="l58.128">         this.ensureMutable();</span>
<a href="#l58.129"></a><span id="l58.129">         if (aValue === null) {</span>
<a href="#l58.130"></a><span id="l58.130">             this.mRepeat = null;</span>
<a href="#l58.131"></a><span id="l58.131">         } else {</span>
<a href="#l58.132"></a><span id="l58.132">             this.mRepeat = parseInt(aValue, 10);</span>
<a href="#l58.133"></a><span id="l58.133">             if (isNaN(this.mRepeat)) {</span>
<a href="#l58.134"></a><span id="l58.134" class="difflineminus">-                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineplus">+                throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.136"></a><span id="l58.136">             }</span>
<a href="#l58.137"></a><span id="l58.137">         }</span>
<a href="#l58.138"></a><span id="l58.138">         return aValue;</span>
<a href="#l58.139"></a><span id="l58.139">     },</span>
<a href="#l58.140"></a><span id="l58.140"> </span>
<a href="#l58.141"></a><span id="l58.141">     get repeatOffset() {</span>
<a href="#l58.142"></a><span id="l58.142">         if ((this.mRepeat != 0) ^ (this.mDuration != null)) {</span>
<a href="#l58.143"></a><span id="l58.143">             return null;</span>
<a href="#l58.144"></a><span id="l58.144">         }</span>
<a href="#l58.145"></a><span id="l58.145">         return this.mDuration;</span>
<a href="#l58.146"></a><span id="l58.146">     },</span>
<a href="#l58.147"></a><span id="l58.147">     set repeatOffset(aValue) {</span>
<a href="#l58.148"></a><span id="l58.148">         this.ensureMutable();</span>
<a href="#l58.149"></a><span id="l58.149">         if (aValue !== null &amp;&amp;</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineminus">-            !(aValue instanceof Components.interfaces.calIDuration)) {</span>
<a href="#l58.151"></a><span id="l58.151" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.152"></a><span id="l58.152" class="difflineplus">+            !(aValue instanceof Ci.calIDuration)) {</span>
<a href="#l58.153"></a><span id="l58.153" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.154"></a><span id="l58.154">         }</span>
<a href="#l58.155"></a><span id="l58.155">         return (this.mDuration = aValue);</span>
<a href="#l58.156"></a><span id="l58.156">     },</span>
<a href="#l58.157"></a><span id="l58.157"> </span>
<a href="#l58.158"></a><span id="l58.158">     get repeatDate() {</span>
<a href="#l58.159"></a><span id="l58.159">         if (this.related != ALARM_RELATED_ABSOLUTE ||</span>
<a href="#l58.160"></a><span id="l58.160">             !this.mAbsoluteDate ||</span>
<a href="#l58.161"></a><span id="l58.161">             !this.mRepeat ||</span>
<a href="#l58.162"></a><span id="l58.162" class="difflineat">@@ -390,17 +390,17 @@ calAlarm.prototype = {</span>
<a href="#l58.163"></a><span id="l58.163">         } else if (this.related != ALARM_RELATED_ABSOLUTE &amp;&amp; this.mOffset) {</span>
<a href="#l58.164"></a><span id="l58.164">             triggerProp.valueAsIcalString = this.mOffset.icalString;</span>
<a href="#l58.165"></a><span id="l58.165">             if (this.related == ALARM_RELATED_END) {</span>
<a href="#l58.166"></a><span id="l58.166">                 // An alarm related to the end of the event.</span>
<a href="#l58.167"></a><span id="l58.167">                 triggerProp.setParameter(&quot;RELATED&quot;, &quot;END&quot;);</span>
<a href="#l58.168"></a><span id="l58.168">             }</span>
<a href="#l58.169"></a><span id="l58.169">         } else {</span>
<a href="#l58.170"></a><span id="l58.170">             // No offset or absolute date is not valid.</span>
<a href="#l58.171"></a><span id="l58.171" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l58.172"></a><span id="l58.172" class="difflineplus">+            throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l58.173"></a><span id="l58.173">         }</span>
<a href="#l58.174"></a><span id="l58.174">         comp.addProperty(triggerProp);</span>
<a href="#l58.175"></a><span id="l58.175"> </span>
<a href="#l58.176"></a><span id="l58.176">         // Set up repeat and duration (OPTIONAL, but if one exists, the other</span>
<a href="#l58.177"></a><span id="l58.177">         // MUST also exist)</span>
<a href="#l58.178"></a><span id="l58.178">         if (this.repeat &amp;&amp; this.repeatOffset) {</span>
<a href="#l58.179"></a><span id="l58.179">             let repeatProp = icssvc.createIcalProperty(&quot;REPEAT&quot;);</span>
<a href="#l58.180"></a><span id="l58.180">             let durationProp = icssvc.createIcalProperty(&quot;DURATION&quot;);</span>
<a href="#l58.181"></a><span id="l58.181" class="difflineat">@@ -410,25 +410,25 @@ calAlarm.prototype = {</span>
<a href="#l58.182"></a><span id="l58.182"> </span>
<a href="#l58.183"></a><span id="l58.183">             comp.addProperty(repeatProp);</span>
<a href="#l58.184"></a><span id="l58.184">             comp.addProperty(durationProp);</span>
<a href="#l58.185"></a><span id="l58.185">         }</span>
<a href="#l58.186"></a><span id="l58.186"> </span>
<a href="#l58.187"></a><span id="l58.187">         // Set up attendees (REQUIRED for EMAIL action)</span>
<a href="#l58.188"></a><span id="l58.188">         /* TODO should we be strict here?</span>
<a href="#l58.189"></a><span id="l58.189">         if (this.action == &quot;EMAIL&quot; &amp;&amp; !this.getAttendees({}).length) {</span>
<a href="#l58.190"></a><span id="l58.190" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l58.191"></a><span id="l58.191" class="difflineplus">+            throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l58.192"></a><span id="l58.192">         } */</span>
<a href="#l58.193"></a><span id="l58.193">         for (let attendee of this.getAttendees({})) {</span>
<a href="#l58.194"></a><span id="l58.194">             comp.addProperty(attendee.icalProperty);</span>
<a href="#l58.195"></a><span id="l58.195">         }</span>
<a href="#l58.196"></a><span id="l58.196"> </span>
<a href="#l58.197"></a><span id="l58.197">         /* TODO should we be strict here?</span>
<a href="#l58.198"></a><span id="l58.198">         if (this.action == &quot;EMAIL&quot; &amp;&amp; !this.attachments.length) {</span>
<a href="#l58.199"></a><span id="l58.199" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l58.200"></a><span id="l58.200" class="difflineplus">+            throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l58.201"></a><span id="l58.201">         } */</span>
<a href="#l58.202"></a><span id="l58.202"> </span>
<a href="#l58.203"></a><span id="l58.203">         for (let attachment of this.getAttachments({})) {</span>
<a href="#l58.204"></a><span id="l58.204">             comp.addProperty(attachment.icalProperty);</span>
<a href="#l58.205"></a><span id="l58.205">         }</span>
<a href="#l58.206"></a><span id="l58.206"> </span>
<a href="#l58.207"></a><span id="l58.207">         // Set up summary (REQUIRED for EMAIL)</span>
<a href="#l58.208"></a><span id="l58.208">         if (this.summary || this.action == &quot;EMAIL&quot;) {</span>
<a href="#l58.209"></a><span id="l58.209" class="difflineat">@@ -466,17 +466,17 @@ calAlarm.prototype = {</span>
<a href="#l58.210"></a><span id="l58.210">             // Add parameters</span>
<a href="#l58.211"></a><span id="l58.211">             let propBucket = this.mPropertyParams[propName];</span>
<a href="#l58.212"></a><span id="l58.212">             if (propBucket) {</span>
<a href="#l58.213"></a><span id="l58.213">                 for (let paramName in propBucket) {</span>
<a href="#l58.214"></a><span id="l58.214">                     try {</span>
<a href="#l58.215"></a><span id="l58.215">                         icalprop.setParameter(paramName,</span>
<a href="#l58.216"></a><span id="l58.216">                                               propBucket[paramName]);</span>
<a href="#l58.217"></a><span id="l58.217">                     } catch (e) {</span>
<a href="#l58.218"></a><span id="l58.218" class="difflineminus">-                        if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l58.219"></a><span id="l58.219" class="difflineplus">+                        if (e.result == Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l58.220"></a><span id="l58.220">                             // Illegal values should be ignored, but we could log them if</span>
<a href="#l58.221"></a><span id="l58.221">                             // the user has enabled logging.</span>
<a href="#l58.222"></a><span id="l58.222">                             cal.LOG(&quot;Warning: Invalid alarm parameter value &quot; + paramName + &quot;=&quot; + propBucket[paramName]);</span>
<a href="#l58.223"></a><span id="l58.223">                         } else {</span>
<a href="#l58.224"></a><span id="l58.224">                             throw e;</span>
<a href="#l58.225"></a><span id="l58.225">                         }</span>
<a href="#l58.226"></a><span id="l58.226">                     }</span>
<a href="#l58.227"></a><span id="l58.227">                 }</span>
<a href="#l58.228"></a><span id="l58.228" class="difflineat">@@ -484,52 +484,52 @@ calAlarm.prototype = {</span>
<a href="#l58.229"></a><span id="l58.229">             comp.addProperty(icalprop);</span>
<a href="#l58.230"></a><span id="l58.230">         }</span>
<a href="#l58.231"></a><span id="l58.231">         return comp;</span>
<a href="#l58.232"></a><span id="l58.232">     },</span>
<a href="#l58.233"></a><span id="l58.233">     set icalComponent(aComp) {</span>
<a href="#l58.234"></a><span id="l58.234">         this.ensureMutable();</span>
<a href="#l58.235"></a><span id="l58.235">         if (!aComp || aComp.componentType != &quot;VALARM&quot;) {</span>
<a href="#l58.236"></a><span id="l58.236">             // Invalid Component</span>
<a href="#l58.237"></a><span id="l58.237" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.238"></a><span id="l58.238" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.239"></a><span id="l58.239">         }</span>
<a href="#l58.240"></a><span id="l58.240"> </span>
<a href="#l58.241"></a><span id="l58.241">         let actionProp = aComp.getFirstProperty(&quot;ACTION&quot;);</span>
<a href="#l58.242"></a><span id="l58.242">         let triggerProp = aComp.getFirstProperty(&quot;TRIGGER&quot;);</span>
<a href="#l58.243"></a><span id="l58.243">         let repeatProp = aComp.getFirstProperty(&quot;REPEAT&quot;);</span>
<a href="#l58.244"></a><span id="l58.244">         let durationProp = aComp.getFirstProperty(&quot;DURATION&quot;);</span>
<a href="#l58.245"></a><span id="l58.245">         let summaryProp = aComp.getFirstProperty(&quot;SUMMARY&quot;);</span>
<a href="#l58.246"></a><span id="l58.246">         let descriptionProp = aComp.getFirstProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l58.247"></a><span id="l58.247">         let lastAckProp = aComp.getFirstProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l58.248"></a><span id="l58.248"> </span>
<a href="#l58.249"></a><span id="l58.249">         if (actionProp) {</span>
<a href="#l58.250"></a><span id="l58.250">             this.action = actionProp.value;</span>
<a href="#l58.251"></a><span id="l58.251">         } else {</span>
<a href="#l58.252"></a><span id="l58.252" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.253"></a><span id="l58.253" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.254"></a><span id="l58.254">         }</span>
<a href="#l58.255"></a><span id="l58.255"> </span>
<a href="#l58.256"></a><span id="l58.256">         if (triggerProp) {</span>
<a href="#l58.257"></a><span id="l58.257">             if (triggerProp.getParameter(&quot;VALUE&quot;) == &quot;DATE-TIME&quot;) {</span>
<a href="#l58.258"></a><span id="l58.258">                 this.mAbsoluteDate = triggerProp.valueAsDatetime;</span>
<a href="#l58.259"></a><span id="l58.259">                 this.related = ALARM_RELATED_ABSOLUTE;</span>
<a href="#l58.260"></a><span id="l58.260">             } else {</span>
<a href="#l58.261"></a><span id="l58.261">                 this.mOffset = cal.createDuration(triggerProp.valueAsIcalString);</span>
<a href="#l58.262"></a><span id="l58.262"> </span>
<a href="#l58.263"></a><span id="l58.263">                 let related = triggerProp.getParameter(&quot;RELATED&quot;);</span>
<a href="#l58.264"></a><span id="l58.264">                 this.related = (related == &quot;END&quot; ? ALARM_RELATED_END : ALARM_RELATED_START);</span>
<a href="#l58.265"></a><span id="l58.265">             }</span>
<a href="#l58.266"></a><span id="l58.266">         } else {</span>
<a href="#l58.267"></a><span id="l58.267" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.268"></a><span id="l58.268" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.269"></a><span id="l58.269">         }</span>
<a href="#l58.270"></a><span id="l58.270"> </span>
<a href="#l58.271"></a><span id="l58.271">         if (durationProp &amp;&amp; repeatProp) {</span>
<a href="#l58.272"></a><span id="l58.272">             this.repeatOffset = cal.createDuration(durationProp.valueAsIcalString);</span>
<a href="#l58.273"></a><span id="l58.273">             this.repeat = repeatProp.value;</span>
<a href="#l58.274"></a><span id="l58.274">         } else if (durationProp || repeatProp) {</span>
<a href="#l58.275"></a><span id="l58.275" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.276"></a><span id="l58.276" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.277"></a><span id="l58.277">         } else {</span>
<a href="#l58.278"></a><span id="l58.278">             this.repeatOffset = null;</span>
<a href="#l58.279"></a><span id="l58.279">             this.repeat = 0;</span>
<a href="#l58.280"></a><span id="l58.280">         }</span>
<a href="#l58.281"></a><span id="l58.281"> </span>
<a href="#l58.282"></a><span id="l58.282">         // Set up attendees</span>
<a href="#l58.283"></a><span id="l58.283">         this.clearAttendees();</span>
<a href="#l58.284"></a><span id="l58.284">         for (let attendeeProp of cal.iterate.icalProperty(aComp, &quot;ATTENDEE&quot;)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -14,28 +14,24 @@ function peekAlarmWindow() {</span>
<a href="#l59.4"></a><span id="l59.4">  * The alarm monitor takes care of playing the alarm sound and opening one copy</span>
<a href="#l59.5"></a><span id="l59.5">  * of the calendar-alarm-dialog. Both depend on their respective prefs to be</span>
<a href="#l59.6"></a><span id="l59.6">  * set. This monitor is only used for DISPLAY type alarms.</span>
<a href="#l59.7"></a><span id="l59.7">  */</span>
<a href="#l59.8"></a><span id="l59.8"> function calAlarmMonitor() {</span>
<a href="#l59.9"></a><span id="l59.9">     this.wrappedJSObject = this;</span>
<a href="#l59.10"></a><span id="l59.10">     this.mAlarms = [];</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-    this.mSound = Components.classes[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-                            .createInstance(Components.interfaces.nsISound);</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+    this.mSound = Cc[&quot;@mozilla.org/sound;1&quot;].createInstance(Ci.nsISound);</span>
<a href="#l59.15"></a><span id="l59.15"> </span>
<a href="#l59.16"></a><span id="l59.16">     Services.obs.addObserver(this, &quot;alarm-service-startup&quot;);</span>
<a href="#l59.17"></a><span id="l59.17">     Services.obs.addObserver(this, &quot;alarm-service-shutdown&quot;);</span>
<a href="#l59.18"></a><span id="l59.18"> }</span>
<a href="#l59.19"></a><span id="l59.19"> </span>
<a href="#l59.20"></a><span id="l59.20"> var calAlarmMonitorClassID = Components.ID(&quot;{4b7ae030-ed79-11d9-8cd6-0800200c9a66}&quot;);</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineminus">-var calAlarmMonitorInterfaces = [</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineminus">-    Components.interfaces.nsIObserver,</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineminus">-    Components.interfaces.calIAlarmServiceObserver</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineminus">-];</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineplus">+var calAlarmMonitorInterfaces = [Ci.nsIObserver, Ci.calIAlarmServiceObserver];</span>
<a href="#l59.26"></a><span id="l59.26"> calAlarmMonitor.prototype = {</span>
<a href="#l59.27"></a><span id="l59.27">     mAlarms: null,</span>
<a href="#l59.28"></a><span id="l59.28"> </span>
<a href="#l59.29"></a><span id="l59.29">     // This is a work-around for the fact that there is a delay between when</span>
<a href="#l59.30"></a><span id="l59.30">     // we call openWindow and when it appears via getMostRecentWindow.  If an</span>
<a href="#l59.31"></a><span id="l59.31">     // alarm is fired in that time-frame, it will actually end up in another window.</span>
<a href="#l59.32"></a><span id="l59.32">     mWindowOpening: null,</span>
<a href="#l59.33"></a><span id="l59.33"> </span>
<a href="#l59.34"></a><span id="l59.34" class="difflineat">@@ -44,25 +40,25 @@ calAlarmMonitor.prototype = {</span>
<a href="#l59.35"></a><span id="l59.35"> </span>
<a href="#l59.36"></a><span id="l59.36">     classID: calAlarmMonitorClassID,</span>
<a href="#l59.37"></a><span id="l59.37">     QueryInterface: cal.generateQI(calAlarmMonitorInterfaces),</span>
<a href="#l59.38"></a><span id="l59.38">     classInfo: cal.generateCI({</span>
<a href="#l59.39"></a><span id="l59.39">         contractID: &quot;@mozilla.org/calendar/alarm-monitor;1&quot;,</span>
<a href="#l59.40"></a><span id="l59.40">         classDescription: &quot;Calendar Alarm Monitor&quot;,</span>
<a href="#l59.41"></a><span id="l59.41">         classID: calAlarmMonitorClassID,</span>
<a href="#l59.42"></a><span id="l59.42">         interfaces: calAlarmMonitorInterfaces,</span>
<a href="#l59.43"></a><span id="l59.43" class="difflineminus">-        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l59.44"></a><span id="l59.44" class="difflineplus">+        flags: Ci.nsIClassInfo.SINGLETON</span>
<a href="#l59.45"></a><span id="l59.45">     }),</span>
<a href="#l59.46"></a><span id="l59.46"> </span>
<a href="#l59.47"></a><span id="l59.47">     /**</span>
<a href="#l59.48"></a><span id="l59.48">      * nsIObserver</span>
<a href="#l59.49"></a><span id="l59.49">      */</span>
<a href="#l59.50"></a><span id="l59.50">     observe: function(aSubject, aTopic, aData) {</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineminus">-        let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l59.52"></a><span id="l59.52" class="difflineminus">-                                     .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l59.53"></a><span id="l59.53" class="difflineplus">+        let alarmService = Cc[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l59.54"></a><span id="l59.54" class="difflineplus">+                             .getService(Ci.calIAlarmService);</span>
<a href="#l59.55"></a><span id="l59.55">         switch (aTopic) {</span>
<a href="#l59.56"></a><span id="l59.56">             case &quot;alarm-service-startup&quot;:</span>
<a href="#l59.57"></a><span id="l59.57">                 alarmService.addObserver(this);</span>
<a href="#l59.58"></a><span id="l59.58">                 break;</span>
<a href="#l59.59"></a><span id="l59.59">             case &quot;alarm-service-shutdown&quot;:</span>
<a href="#l59.60"></a><span id="l59.60">                 alarmService.removeObserver(this);</span>
<a href="#l59.61"></a><span id="l59.61">                 break;</span>
<a href="#l59.62"></a><span id="l59.62">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/calendar/base/src/calAlarmService.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/calendar/base/src/calAlarmService.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -9,34 +9,33 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l60.4"></a><span id="l60.4"> </span>
<a href="#l60.5"></a><span id="l60.5"> var kHoursBetweenUpdates = 6;</span>
<a href="#l60.6"></a><span id="l60.6"> </span>
<a href="#l60.7"></a><span id="l60.7"> function nowUTC() {</span>
<a href="#l60.8"></a><span id="l60.8">     return cal.dtz.jsDateToDateTime(new Date()).getInTimezone(cal.dtz.UTC);</span>
<a href="#l60.9"></a><span id="l60.9"> }</span>
<a href="#l60.10"></a><span id="l60.10"> </span>
<a href="#l60.11"></a><span id="l60.11"> function newTimerWithCallback(aCallback, aDelay, aRepeating) {</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-    let timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineminus">-                          .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+    let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l60.15"></a><span id="l60.15"> </span>
<a href="#l60.16"></a><span id="l60.16">     timer.initWithCallback(aCallback,</span>
<a href="#l60.17"></a><span id="l60.17">                            aDelay,</span>
<a href="#l60.18"></a><span id="l60.18">                            (aRepeating ? timer.TYPE_REPEATING_PRECISE : timer.TYPE_ONE_SHOT));</span>
<a href="#l60.19"></a><span id="l60.19">     return timer;</span>
<a href="#l60.20"></a><span id="l60.20"> }</span>
<a href="#l60.21"></a><span id="l60.21"> </span>
<a href="#l60.22"></a><span id="l60.22"> function calAlarmService() {</span>
<a href="#l60.23"></a><span id="l60.23">     this.wrappedJSObject = this;</span>
<a href="#l60.24"></a><span id="l60.24"> </span>
<a href="#l60.25"></a><span id="l60.25">     this.mLoadedCalendars = {};</span>
<a href="#l60.26"></a><span id="l60.26">     this.mTimerMap = {};</span>
<a href="#l60.27"></a><span id="l60.27" class="difflineminus">-    this.mObservers = new cal.data.ListenerSet(Components.interfaces.calIAlarmServiceObserver);</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineplus">+    this.mObservers = new cal.data.ListenerSet(Ci.calIAlarmServiceObserver);</span>
<a href="#l60.29"></a><span id="l60.29"> </span>
<a href="#l60.30"></a><span id="l60.30">     this.calendarObserver = {</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineminus">-        QueryInterface: ChromeUtils.generateQI([Components.interfaces.calIObserver]),</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+        QueryInterface: ChromeUtils.generateQI([Ci.calIObserver]),</span>
<a href="#l60.33"></a><span id="l60.33">         alarmService: this,</span>
<a href="#l60.34"></a><span id="l60.34"> </span>
<a href="#l60.35"></a><span id="l60.35">         // calIObserver:</span>
<a href="#l60.36"></a><span id="l60.36">         onStartBatch: function() { },</span>
<a href="#l60.37"></a><span id="l60.37">         onEndBatch: function() { },</span>
<a href="#l60.38"></a><span id="l60.38">         onLoad: function(calendar) {</span>
<a href="#l60.39"></a><span id="l60.39">             // ignore any onLoad events until initial getItems() call of startup has finished:</span>
<a href="#l60.40"></a><span id="l60.40">             if (calendar &amp;&amp; this.alarmService.mLoadedCalendars[calendar.id]) {</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineat">@@ -71,17 +70,17 @@ function calAlarmService() {</span>
<a href="#l60.42"></a><span id="l60.42">             }</span>
<a href="#l60.43"></a><span id="l60.43">         },</span>
<a href="#l60.44"></a><span id="l60.44">         onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l60.45"></a><span id="l60.45">             this.onPropertyChanged(aCalendar, aName);</span>
<a href="#l60.46"></a><span id="l60.46">         }</span>
<a href="#l60.47"></a><span id="l60.47">     };</span>
<a href="#l60.48"></a><span id="l60.48"> </span>
<a href="#l60.49"></a><span id="l60.49">     this.calendarManagerObserver = {</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineminus">-        QueryInterface: ChromeUtils.generateQI([Components.interfaces.calICalendarManagerObserver]),</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+        QueryInterface: ChromeUtils.generateQI([Ci.calICalendarManagerObserver]),</span>
<a href="#l60.52"></a><span id="l60.52">         alarmService: this,</span>
<a href="#l60.53"></a><span id="l60.53"> </span>
<a href="#l60.54"></a><span id="l60.54">         onCalendarRegistered: function(aCalendar) {</span>
<a href="#l60.55"></a><span id="l60.55">             this.alarmService.observeCalendar(aCalendar);</span>
<a href="#l60.56"></a><span id="l60.56">             // initial refresh of alarms for new calendar:</span>
<a href="#l60.57"></a><span id="l60.57">             this.alarmService.initAlarms([aCalendar]);</span>
<a href="#l60.58"></a><span id="l60.58">         },</span>
<a href="#l60.59"></a><span id="l60.59">         onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineat">@@ -93,37 +92,34 @@ function calAlarmService() {</span>
<a href="#l60.61"></a><span id="l60.61">         onCalendarDeleting: function(aCalendar) {</span>
<a href="#l60.62"></a><span id="l60.62">             this.alarmService.unobserveCalendar(aCalendar);</span>
<a href="#l60.63"></a><span id="l60.63">             delete this.alarmService.mLoadedCalendars[aCalendar.id];</span>
<a href="#l60.64"></a><span id="l60.64">         }</span>
<a href="#l60.65"></a><span id="l60.65">     };</span>
<a href="#l60.66"></a><span id="l60.66"> }</span>
<a href="#l60.67"></a><span id="l60.67"> </span>
<a href="#l60.68"></a><span id="l60.68"> var calAlarmServiceClassID = Components.ID(&quot;{7a9200dd-6a64-4fff-a798-c5802186e2cc}&quot;);</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineminus">-var calAlarmServiceInterfaces = [</span>
<a href="#l60.70"></a><span id="l60.70" class="difflineminus">-    Components.interfaces.calIAlarmService,</span>
<a href="#l60.71"></a><span id="l60.71" class="difflineminus">-    Components.interfaces.nsIObserver</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineminus">-];</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+var calAlarmServiceInterfaces = [Ci.calIAlarmService, Ci.nsIObserver];</span>
<a href="#l60.74"></a><span id="l60.74"> calAlarmService.prototype = {</span>
<a href="#l60.75"></a><span id="l60.75">     mRangeStart: null,</span>
<a href="#l60.76"></a><span id="l60.76">     mRangeEnd: null,</span>
<a href="#l60.77"></a><span id="l60.77">     mUpdateTimer: null,</span>
<a href="#l60.78"></a><span id="l60.78">     mStarted: false,</span>
<a href="#l60.79"></a><span id="l60.79">     mTimerMap: null,</span>
<a href="#l60.80"></a><span id="l60.80">     mObservers: null,</span>
<a href="#l60.81"></a><span id="l60.81">     mTimezone: null,</span>
<a href="#l60.82"></a><span id="l60.82"> </span>
<a href="#l60.83"></a><span id="l60.83">     classID: calAlarmServiceClassID,</span>
<a href="#l60.84"></a><span id="l60.84">     QueryInterface: cal.generateQI(calAlarmServiceInterfaces),</span>
<a href="#l60.85"></a><span id="l60.85">     classInfo: cal.generateCI({</span>
<a href="#l60.86"></a><span id="l60.86">         classID: calAlarmServiceClassID,</span>
<a href="#l60.87"></a><span id="l60.87">         contractID: &quot;@mozilla.org/calendar/alarm-service;1&quot;,</span>
<a href="#l60.88"></a><span id="l60.88">         classDescription: &quot;Calendar Alarm Service&quot;,</span>
<a href="#l60.89"></a><span id="l60.89">         interfaces: calAlarmServiceInterfaces,</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineminus">-        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l60.91"></a><span id="l60.91" class="difflineplus">+        flags: Ci.nsIClassInfo.SINGLETON</span>
<a href="#l60.92"></a><span id="l60.92">     }),</span>
<a href="#l60.93"></a><span id="l60.93"> </span>
<a href="#l60.94"></a><span id="l60.94">     /**</span>
<a href="#l60.95"></a><span id="l60.95">      * nsIObserver</span>
<a href="#l60.96"></a><span id="l60.96">      */</span>
<a href="#l60.97"></a><span id="l60.97">     observe: function(aSubject, aTopic, aData) {</span>
<a href="#l60.98"></a><span id="l60.98">         // This will also be called on app-startup, but nothing is done yet, to</span>
<a href="#l60.99"></a><span id="l60.99">         // prevent unwanted dialogs etc. See bug 325476 and 413296</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineat">@@ -248,21 +244,21 @@ calAlarmService.prototype = {</span>
<a href="#l60.101"></a><span id="l60.101">                     // This is a subsequent search, so we got all the past alarms before</span>
<a href="#l60.102"></a><span id="l60.102">                     start = this.alarmService.mRangeEnd.clone();</span>
<a href="#l60.103"></a><span id="l60.103">                 } else {</span>
<a href="#l60.104"></a><span id="l60.104">                     // This is our first search for alarms.  We're going to look for</span>
<a href="#l60.105"></a><span id="l60.105">                     // alarms +/- 1 month from now.  If someone sets an alarm more than</span>
<a href="#l60.106"></a><span id="l60.106">                     // a month ahead of an event, or doesn't start Lightning</span>
<a href="#l60.107"></a><span id="l60.107">                     // for a month, they'll miss some, but that's a slim chance</span>
<a href="#l60.108"></a><span id="l60.108">                     start = now.clone();</span>
<a href="#l60.109"></a><span id="l60.109" class="difflineminus">-                    start.month -= Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l60.110"></a><span id="l60.110" class="difflineplus">+                    start.month -= Ci.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l60.111"></a><span id="l60.111">                     this.alarmService.mRangeStart = start.clone();</span>
<a href="#l60.112"></a><span id="l60.112">                 }</span>
<a href="#l60.113"></a><span id="l60.113">                 let until = now.clone();</span>
<a href="#l60.114"></a><span id="l60.114" class="difflineminus">-                until.month += Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineplus">+                until.month += Ci.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l60.116"></a><span id="l60.116"> </span>
<a href="#l60.117"></a><span id="l60.117">                 // We don't set timers for every future alarm, only those within 6 hours</span>
<a href="#l60.118"></a><span id="l60.118">                 let end = now.clone();</span>
<a href="#l60.119"></a><span id="l60.119">                 end.hour += kHoursBetweenUpdates;</span>
<a href="#l60.120"></a><span id="l60.120">                 this.alarmService.mRangeEnd = end.getInTimezone(cal.dtz.UTC);</span>
<a href="#l60.121"></a><span id="l60.121"> </span>
<a href="#l60.122"></a><span id="l60.122">                 this.alarmService.findAlarms(cal.getCalendarManager().getCalendars({}),</span>
<a href="#l60.123"></a><span id="l60.123">                                              start, until);</span>
<a href="#l60.124"></a><span id="l60.124" class="difflineat">@@ -344,17 +340,17 @@ calAlarmService.prototype = {</span>
<a href="#l60.125"></a><span id="l60.125">             // Check for snooze</span>
<a href="#l60.126"></a><span id="l60.126">             let snoozeDate;</span>
<a href="#l60.127"></a><span id="l60.127">             if (aItem.parentItem == aItem) {</span>
<a href="#l60.128"></a><span id="l60.128">                 snoozeDate = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l60.129"></a><span id="l60.129">             } else {</span>
<a href="#l60.130"></a><span id="l60.130">                 snoozeDate = aItem.parentItem.getProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + aItem.recurrenceId.nativeTime);</span>
<a href="#l60.131"></a><span id="l60.131">             }</span>
<a href="#l60.132"></a><span id="l60.132"> </span>
<a href="#l60.133"></a><span id="l60.133" class="difflineminus">-            if (snoozeDate &amp;&amp; !(snoozeDate instanceof Components.interfaces.calIDateTime)) {</span>
<a href="#l60.134"></a><span id="l60.134" class="difflineplus">+            if (snoozeDate &amp;&amp; !(snoozeDate instanceof Ci.calIDateTime)) {</span>
<a href="#l60.135"></a><span id="l60.135">                 snoozeDate = cal.createDateTime(snoozeDate);</span>
<a href="#l60.136"></a><span id="l60.136">             }</span>
<a href="#l60.137"></a><span id="l60.137"> </span>
<a href="#l60.138"></a><span id="l60.138">             // an alarm can only be snoozed to a later time, if earlier it's from another alarm.</span>
<a href="#l60.139"></a><span id="l60.139">             if (snoozeDate &amp;&amp; snoozeDate.compare(alarmDate) &gt; 0) {</span>
<a href="#l60.140"></a><span id="l60.140">                 // If the alarm was snoozed, the snooze time is more important.</span>
<a href="#l60.141"></a><span id="l60.141">                 alarmDate = snoozeDate;</span>
<a href="#l60.142"></a><span id="l60.142">             }</span>
<a href="#l60.143"></a><span id="l60.143" class="difflineat">@@ -488,30 +484,30 @@ calAlarmService.prototype = {</span>
<a href="#l60.144"></a><span id="l60.144">                 }</span>
<a href="#l60.145"></a><span id="l60.145">                 delete this.mTimerMap[calendar.id];</span>
<a href="#l60.146"></a><span id="l60.146">             }</span>
<a href="#l60.147"></a><span id="l60.147">         }</span>
<a href="#l60.148"></a><span id="l60.148">     },</span>
<a href="#l60.149"></a><span id="l60.149"> </span>
<a href="#l60.150"></a><span id="l60.150">     findAlarms: function(aCalendars, aStart, aUntil) {</span>
<a href="#l60.151"></a><span id="l60.151">         let getListener = {</span>
<a href="#l60.152"></a><span id="l60.152" class="difflineminus">-            QueryInterface: ChromeUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l60.153"></a><span id="l60.153" class="difflineplus">+            QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l60.154"></a><span id="l60.154">             alarmService: this,</span>
<a href="#l60.155"></a><span id="l60.155">             addRemovePromise: PromiseUtils.defer(),</span>
<a href="#l60.156"></a><span id="l60.156">             batchCount: 0,</span>
<a href="#l60.157"></a><span id="l60.157">             results: false,</span>
<a href="#l60.158"></a><span id="l60.158">             onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l60.159"></a><span id="l60.159">                 this.addRemovePromise.promise.then((aValue) =&gt; {</span>
<a href="#l60.160"></a><span id="l60.160">                     // calendar has been loaded, so until now, onLoad events can be ignored:</span>
<a href="#l60.161"></a><span id="l60.161">                     this.alarmService.mLoadedCalendars[aCalendar.id] = true;</span>
<a href="#l60.162"></a><span id="l60.162"> </span>
<a href="#l60.163"></a><span id="l60.163">                     // notify observers that the alarms for the calendar have been loaded</span>
<a href="#l60.164"></a><span id="l60.164">                     this.alarmService.mObservers.notify(&quot;onAlarmsLoaded&quot;, [aCalendar]);</span>
<a href="#l60.165"></a><span id="l60.165">                 }, (aReason) =&gt; {</span>
<a href="#l60.166"></a><span id="l60.166" class="difflineminus">-                    Components.utils.reportError(&quot;Promise was rejected: &quot; + aReason);</span>
<a href="#l60.167"></a><span id="l60.167" class="difflineplus">+                    Cu.reportError(&quot;Promise was rejected: &quot; + aReason);</span>
<a href="#l60.168"></a><span id="l60.168">                     this.alarmService.mLoadedCalendars[aCalendar.id] = true;</span>
<a href="#l60.169"></a><span id="l60.169">                     this.alarmService.mObservers.notify(&quot;onAlarmsLoaded&quot;, [aCalendar]);</span>
<a href="#l60.170"></a><span id="l60.170">                 });</span>
<a href="#l60.171"></a><span id="l60.171"> </span>
<a href="#l60.172"></a><span id="l60.172">                 // if no results were returned we still need to resolve the promise</span>
<a href="#l60.173"></a><span id="l60.173">                 if (!this.results) {</span>
<a href="#l60.174"></a><span id="l60.174">                     this.addRemovePromise.resolve();</span>
<a href="#l60.175"></a><span id="l60.175">                 }</span>
<a href="#l60.176"></a><span id="l60.176" class="difflineat">@@ -531,17 +527,17 @@ calAlarmService.prototype = {</span>
<a href="#l60.177"></a><span id="l60.177">                 }, () =&gt; {</span>
<a href="#l60.178"></a><span id="l60.178">                     if (--this.batchCount &lt;= 0) {</span>
<a href="#l60.179"></a><span id="l60.179">                         promise.resolve();</span>
<a href="#l60.180"></a><span id="l60.180">                     }</span>
<a href="#l60.181"></a><span id="l60.181">                 });</span>
<a href="#l60.182"></a><span id="l60.182">             }</span>
<a href="#l60.183"></a><span id="l60.183">         };</span>
<a href="#l60.184"></a><span id="l60.184"> </span>
<a href="#l60.185"></a><span id="l60.185" class="difflineminus">-        const calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l60.186"></a><span id="l60.186" class="difflineplus">+        const calICalendar = Ci.calICalendar;</span>
<a href="#l60.187"></a><span id="l60.187">         let filter = calICalendar.ITEM_FILTER_COMPLETED_ALL |</span>
<a href="#l60.188"></a><span id="l60.188">                      calICalendar.ITEM_FILTER_CLASS_OCCURRENCES |</span>
<a href="#l60.189"></a><span id="l60.189">                      calICalendar.ITEM_FILTER_TYPE_ALL;</span>
<a href="#l60.190"></a><span id="l60.190"> </span>
<a href="#l60.191"></a><span id="l60.191">         for (let calendar of aCalendars) {</span>
<a href="#l60.192"></a><span id="l60.192">             // assuming that suppressAlarms does not change anymore until refresh:</span>
<a href="#l60.193"></a><span id="l60.193">             if (!calendar.getProperty(&quot;suppressAlarms&quot;) &amp;&amp;</span>
<a href="#l60.194"></a><span id="l60.194">                 !calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l60.195"></a><span id="l60.195" class="difflineat">@@ -565,18 +561,18 @@ calAlarmService.prototype = {</span>
<a href="#l60.196"></a><span id="l60.196">         }</span>
<a href="#l60.197"></a><span id="l60.197"> </span>
<a href="#l60.198"></a><span id="l60.198">         // Total refresh similar to startup.  We're going to look for</span>
<a href="#l60.199"></a><span id="l60.199">         // alarms +/- 1 month from now.  If someone sets an alarm more than</span>
<a href="#l60.200"></a><span id="l60.200">         // a month ahead of an event, or doesn't start Lightning</span>
<a href="#l60.201"></a><span id="l60.201">         // for a month, they'll miss some, but that's a slim chance</span>
<a href="#l60.202"></a><span id="l60.202">         let start = nowUTC();</span>
<a href="#l60.203"></a><span id="l60.203">         let until = start.clone();</span>
<a href="#l60.204"></a><span id="l60.204" class="difflineminus">-        start.month -= Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l60.205"></a><span id="l60.205" class="difflineminus">-        until.month += Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l60.206"></a><span id="l60.206" class="difflineplus">+        start.month -= Ci.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l60.207"></a><span id="l60.207" class="difflineplus">+        until.month += Ci.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l60.208"></a><span id="l60.208">         this.findAlarms(aCalendars, start, until);</span>
<a href="#l60.209"></a><span id="l60.209">     },</span>
<a href="#l60.210"></a><span id="l60.210"> </span>
<a href="#l60.211"></a><span id="l60.211">     alarmFired: function(aItem, aAlarm) {</span>
<a href="#l60.212"></a><span id="l60.212">         if (!aItem.calendar.getProperty(&quot;suppressAlarms&quot;) &amp;&amp;</span>
<a href="#l60.213"></a><span id="l60.213">             !aItem.calendar.getProperty(&quot;disabled&quot;) &amp;&amp;</span>
<a href="#l60.214"></a><span id="l60.214">             aItem.getProperty(&quot;STATUS&quot;) != &quot;CANCELLED&quot;) {</span>
<a href="#l60.215"></a><span id="l60.215">             this.mObservers.notify(&quot;onAlarm&quot;, [aItem, aAlarm]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/calendar/base/src/calApplicationUtils.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/calendar/base/src/calApplicationUtils.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -19,25 +19,24 @@ function launchBrowser(url, event) {</span>
<a href="#l61.4"></a><span id="l61.4">         return;</span>
<a href="#l61.5"></a><span id="l61.5">     }</span>
<a href="#l61.6"></a><span id="l61.6"> </span>
<a href="#l61.7"></a><span id="l61.7">     // 0. Prevent people from trying to launch URLs such as javascript:foo();</span>
<a href="#l61.8"></a><span id="l61.8">     //    by only allowing URLs starting with http or https.</span>
<a href="#l61.9"></a><span id="l61.9">     // XXX: We likely will want to do this using nsIURLs in the future to</span>
<a href="#l61.10"></a><span id="l61.10">     //      prevent sneaky nasty escaping issues, but this is fine for now.</span>
<a href="#l61.11"></a><span id="l61.11">     if (!url.startsWith(&quot;http&quot;)) {</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-        Components.utils.reportError(&quot;launchBrowser: &quot; +</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineminus">-                                     &quot;Invalid URL provided: &quot; + url +</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineminus">-                                     &quot; Only http:// and https:// URLs are valid.&quot;);</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+        Cu.reportError(&quot;launchBrowser: Invalid URL provided: &quot; + url +</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineplus">+                       &quot; Only http:// and https:// URLs are valid.&quot;);</span>
<a href="#l61.17"></a><span id="l61.17">         return;</span>
<a href="#l61.18"></a><span id="l61.18">     }</span>
<a href="#l61.19"></a><span id="l61.19"> </span>
<a href="#l61.20"></a><span id="l61.20" class="difflineminus">-    Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l61.21"></a><span id="l61.21" class="difflineminus">-              .getService(Components.interfaces.nsIExternalProtocolService)</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineminus">-              .loadURI(Services.io.newURI(url));</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+    Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l61.24"></a><span id="l61.24" class="difflineplus">+        .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l61.25"></a><span id="l61.25" class="difflineplus">+        .loadURI(Services.io.newURI(url));</span>
<a href="#l61.26"></a><span id="l61.26"> </span>
<a href="#l61.27"></a><span id="l61.27">     // Make sure that any default click handlers don't do anything, we have taken</span>
<a href="#l61.28"></a><span id="l61.28">     // care of all processing</span>
<a href="#l61.29"></a><span id="l61.29">     if (event) {</span>
<a href="#l61.30"></a><span id="l61.30">         event.stopPropagation();</span>
<a href="#l61.31"></a><span id="l61.31">         event.preventDefault();</span>
<a href="#l61.32"></a><span id="l61.32">     }</span>
<a href="#l61.33"></a><span id="l61.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/calendar/base/src/calAttachment.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/calendar/base/src/calAttachment.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -17,21 +17,21 @@ calAttachment.prototype = {</span>
<a href="#l62.4"></a><span id="l62.4">     QueryInterface: ChromeUtils.generateQI([Ci.calIAttachment]),</span>
<a href="#l62.5"></a><span id="l62.5">     classID: Components.ID(&quot;{5f76b352-ab75-4c2b-82c9-9206dbbf8571}&quot;),</span>
<a href="#l62.6"></a><span id="l62.6"> </span>
<a href="#l62.7"></a><span id="l62.7">     mData: null,</span>
<a href="#l62.8"></a><span id="l62.8">     mHashId: null,</span>
<a href="#l62.9"></a><span id="l62.9"> </span>
<a href="#l62.10"></a><span id="l62.10">     get hashId() {</span>
<a href="#l62.11"></a><span id="l62.11">         if (!this.mHashId) {</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-            let cryptoHash = Components.classes[&quot;@mozilla.org/security/hash;1&quot;]</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineminus">-                                       .createInstance(Components.interfaces.nsICryptoHash);</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+            let cryptoHash = Cc[&quot;@mozilla.org/security/hash;1&quot;]</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+                               .createInstance(Ci.nsICryptoHash);</span>
<a href="#l62.16"></a><span id="l62.16"> </span>
<a href="#l62.17"></a><span id="l62.17" class="difflineminus">-            let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineminus">-                                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineplus">+            let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l62.20"></a><span id="l62.20" class="difflineplus">+                              .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l62.21"></a><span id="l62.21">             converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l62.22"></a><span id="l62.22">             let data = converter.convertToByteArray(this.rawData, {});</span>
<a href="#l62.23"></a><span id="l62.23"> </span>
<a href="#l62.24"></a><span id="l62.24">             cryptoHash.init(cryptoHash.MD5);</span>
<a href="#l62.25"></a><span id="l62.25">             cryptoHash.update(data, data.length);</span>
<a href="#l62.26"></a><span id="l62.26">             this.mHashId = cryptoHash.finish(true);</span>
<a href="#l62.27"></a><span id="l62.27">         }</span>
<a href="#l62.28"></a><span id="l62.28">         return this.mHashId;</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineat">@@ -90,17 +90,17 @@ calAttachment.prototype = {</span>
<a href="#l62.30"></a><span id="l62.30"> </span>
<a href="#l62.31"></a><span id="l62.31">     get icalProperty() {</span>
<a href="#l62.32"></a><span id="l62.32">         let icalatt = cal.getIcsService().createIcalProperty(&quot;ATTACH&quot;);</span>
<a href="#l62.33"></a><span id="l62.33"> </span>
<a href="#l62.34"></a><span id="l62.34">         for (let [key, value] of this.mProperties.entries()) {</span>
<a href="#l62.35"></a><span id="l62.35">             try {</span>
<a href="#l62.36"></a><span id="l62.36">                 icalatt.setParameter(key, value);</span>
<a href="#l62.37"></a><span id="l62.37">             } catch (e) {</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineminus">-                if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineplus">+                if (e.result == Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l62.40"></a><span id="l62.40">                     // Illegal values should be ignored, but we could log them if</span>
<a href="#l62.41"></a><span id="l62.41">                     // the user has enabled logging.</span>
<a href="#l62.42"></a><span id="l62.42">                     cal.LOG(&quot;Warning: Invalid attachment parameter value &quot; + key + &quot;=&quot; + value);</span>
<a href="#l62.43"></a><span id="l62.43">                 } else {</span>
<a href="#l62.44"></a><span id="l62.44">                     throw e;</span>
<a href="#l62.45"></a><span id="l62.45">                 }</span>
<a href="#l62.46"></a><span id="l62.46">             }</span>
<a href="#l62.47"></a><span id="l62.47">         }</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineat">@@ -124,17 +124,17 @@ calAttachment.prototype = {</span>
<a href="#l62.49"></a><span id="l62.49"> </span>
<a href="#l62.50"></a><span id="l62.50">     get icalString() {</span>
<a href="#l62.51"></a><span id="l62.51">         let comp = this.icalProperty;</span>
<a href="#l62.52"></a><span id="l62.52">         return (comp ? comp.icalString : &quot;&quot;);</span>
<a href="#l62.53"></a><span id="l62.53">     },</span>
<a href="#l62.54"></a><span id="l62.54">     set icalString(val) {</span>
<a href="#l62.55"></a><span id="l62.55">         let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l62.56"></a><span id="l62.56">         if (prop.propertyName != &quot;ATTACH&quot;) {</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineminus">-            throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+            throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l62.59"></a><span id="l62.59">         }</span>
<a href="#l62.60"></a><span id="l62.60">         this.icalProperty = prop;</span>
<a href="#l62.61"></a><span id="l62.61">         return val;</span>
<a href="#l62.62"></a><span id="l62.62">     },</span>
<a href="#l62.63"></a><span id="l62.63"> </span>
<a href="#l62.64"></a><span id="l62.64">     getParameter: function(aName) {</span>
<a href="#l62.65"></a><span id="l62.65">         return this.mProperties.get(aName);</span>
<a href="#l62.66"></a><span id="l62.66">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/calendar/base/src/calAttendee.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/calendar/base/src/calAttendee.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -13,17 +13,17 @@ calAttendee.prototype = {</span>
<a href="#l63.4"></a><span id="l63.4">     QueryInterface: ChromeUtils.generateQI([Ci.calIAttendee]),</span>
<a href="#l63.5"></a><span id="l63.5">     classID: Components.ID(&quot;{5c8dcaa3-170c-4a73-8142-d531156f664d}&quot;),</span>
<a href="#l63.6"></a><span id="l63.6"> </span>
<a href="#l63.7"></a><span id="l63.7">     mImmutable: false,</span>
<a href="#l63.8"></a><span id="l63.8">     get isMutable() { return !this.mImmutable; },</span>
<a href="#l63.9"></a><span id="l63.9"> </span>
<a href="#l63.10"></a><span id="l63.10">     modify: function() {</span>
<a href="#l63.11"></a><span id="l63.11">         if (this.mImmutable) {</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+            throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l63.14"></a><span id="l63.14">         }</span>
<a href="#l63.15"></a><span id="l63.15">     },</span>
<a href="#l63.16"></a><span id="l63.16"> </span>
<a href="#l63.17"></a><span id="l63.17">     makeImmutable: function() {</span>
<a href="#l63.18"></a><span id="l63.18">         this.mImmutable = true;</span>
<a href="#l63.19"></a><span id="l63.19">     },</span>
<a href="#l63.20"></a><span id="l63.20"> </span>
<a href="#l63.21"></a><span id="l63.21">     clone: function() {</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineat">@@ -90,40 +90,40 @@ calAttendee.prototype = {</span>
<a href="#l63.23"></a><span id="l63.23">         let icalatt;</span>
<a href="#l63.24"></a><span id="l63.24">         if (this.mIsOrganizer) {</span>
<a href="#l63.25"></a><span id="l63.25">             icalatt = icssvc.createIcalProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l63.26"></a><span id="l63.26">         } else {</span>
<a href="#l63.27"></a><span id="l63.27">             icalatt = icssvc.createIcalProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l63.28"></a><span id="l63.28">         }</span>
<a href="#l63.29"></a><span id="l63.29"> </span>
<a href="#l63.30"></a><span id="l63.30">         if (!this.id) {</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+            throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l63.33"></a><span id="l63.33">         }</span>
<a href="#l63.34"></a><span id="l63.34">         icalatt.valueAsIcalString = this.id;</span>
<a href="#l63.35"></a><span id="l63.35">         for (let i = 0; i &lt; this.icalAttendeePropMap.length; i++) {</span>
<a href="#l63.36"></a><span id="l63.36">             let prop = this.icalAttendeePropMap[i];</span>
<a href="#l63.37"></a><span id="l63.37">             if (this[prop.cal]) {</span>
<a href="#l63.38"></a><span id="l63.38">                 try {</span>
<a href="#l63.39"></a><span id="l63.39">                     icalatt.setParameter(prop.ics, this[prop.cal]);</span>
<a href="#l63.40"></a><span id="l63.40">                 } catch (e) {</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineminus">-                    if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineplus">+                    if (e.result == Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l63.43"></a><span id="l63.43">                         // Illegal values should be ignored, but we could log them if</span>
<a href="#l63.44"></a><span id="l63.44">                         // the user has enabled logging.</span>
<a href="#l63.45"></a><span id="l63.45">                         cal.LOG(&quot;Warning: Invalid attendee parameter value &quot; + prop.ics + &quot;=&quot; + this[prop.cal]);</span>
<a href="#l63.46"></a><span id="l63.46">                     } else {</span>
<a href="#l63.47"></a><span id="l63.47">                         throw e;</span>
<a href="#l63.48"></a><span id="l63.48">                     }</span>
<a href="#l63.49"></a><span id="l63.49">                 }</span>
<a href="#l63.50"></a><span id="l63.50">             }</span>
<a href="#l63.51"></a><span id="l63.51">         }</span>
<a href="#l63.52"></a><span id="l63.52">         for (let [key, value] of this.mProperties.entries()) {</span>
<a href="#l63.53"></a><span id="l63.53">             try {</span>
<a href="#l63.54"></a><span id="l63.54">                 icalatt.setParameter(key, value);</span>
<a href="#l63.55"></a><span id="l63.55">             } catch (e) {</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineminus">-                if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l63.57"></a><span id="l63.57" class="difflineplus">+                if (e.result == Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l63.58"></a><span id="l63.58">                     // Illegal values should be ignored, but we could log them if</span>
<a href="#l63.59"></a><span id="l63.59">                     // the user has enabled logging.</span>
<a href="#l63.60"></a><span id="l63.60">                     cal.LOG(&quot;Warning: Invalid attendee parameter value &quot; + key + &quot;=&quot; + value);</span>
<a href="#l63.61"></a><span id="l63.61">                 } else {</span>
<a href="#l63.62"></a><span id="l63.62">                     throw e;</span>
<a href="#l63.63"></a><span id="l63.63">                 }</span>
<a href="#l63.64"></a><span id="l63.64">             }</span>
<a href="#l63.65"></a><span id="l63.65">         }</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineat">@@ -132,17 +132,17 @@ calAttendee.prototype = {</span>
<a href="#l63.67"></a><span id="l63.67"> </span>
<a href="#l63.68"></a><span id="l63.68">     get icalString() {</span>
<a href="#l63.69"></a><span id="l63.69">         let comp = this.icalProperty;</span>
<a href="#l63.70"></a><span id="l63.70">         return (comp ? comp.icalString : &quot;&quot;);</span>
<a href="#l63.71"></a><span id="l63.71">     },</span>
<a href="#l63.72"></a><span id="l63.72">     set icalString(val) {</span>
<a href="#l63.73"></a><span id="l63.73">         let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l63.74"></a><span id="l63.74">         if (prop.propertyName != &quot;ORGANIZER&quot; &amp;&amp; prop.propertyName != &quot;ATTENDEE&quot;) {</span>
<a href="#l63.75"></a><span id="l63.75" class="difflineminus">-            throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l63.76"></a><span id="l63.76" class="difflineplus">+            throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l63.77"></a><span id="l63.77">         }</span>
<a href="#l63.78"></a><span id="l63.78">         this.icalProperty = prop;</span>
<a href="#l63.79"></a><span id="l63.79">         return val;</span>
<a href="#l63.80"></a><span id="l63.80">     },</span>
<a href="#l63.81"></a><span id="l63.81"> </span>
<a href="#l63.82"></a><span id="l63.82">     get properties() { return this.mProperties.entries(); },</span>
<a href="#l63.83"></a><span id="l63.83"> </span>
<a href="#l63.84"></a><span id="l63.84">     // The has/get/set/deleteProperty methods are case-insensitive.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l64.4"></a><span id="l64.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l64.5"></a><span id="l64.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l64.6"></a><span id="l64.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l64.7"></a><span id="l64.7"> </span>
<a href="#l64.8"></a><span id="l64.8"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l64.9"></a><span id="l64.9"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l64.10"></a><span id="l64.10"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-var calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-var cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineminus">-var cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+var calICalendar = Ci.calICalendar;</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+var cICL = Ci.calIChangeLog;</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineplus">+var cIOL = Ci.calIOperationListener;</span>
<a href="#l64.18"></a><span id="l64.18"> </span>
<a href="#l64.19"></a><span id="l64.19"> var gNoOpListener = {</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineminus">-    QueryInterface: ChromeUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+    QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.22"></a><span id="l64.22">     onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l64.23"></a><span id="l64.23">     },</span>
<a href="#l64.24"></a><span id="l64.24"> </span>
<a href="#l64.25"></a><span id="l64.25">     onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.26"></a><span id="l64.26">     }</span>
<a href="#l64.27"></a><span id="l64.27"> };</span>
<a href="#l64.28"></a><span id="l64.28"> </span>
<a href="#l64.29"></a><span id="l64.29"> /**</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineat">@@ -38,29 +38,29 @@ function isUnavailableCode(result) {</span>
<a href="#l64.31"></a><span id="l64.31">         !Components.isSuccessCode(result)) {</span>
<a href="#l64.32"></a><span id="l64.32">         // This is a network error, which most likely means we should</span>
<a href="#l64.33"></a><span id="l64.33">         // retry it some time.</span>
<a href="#l64.34"></a><span id="l64.34">         return true;</span>
<a href="#l64.35"></a><span id="l64.35">     }</span>
<a href="#l64.36"></a><span id="l64.36"> </span>
<a href="#l64.37"></a><span id="l64.37">     // Other potential errors we want to retry with</span>
<a href="#l64.38"></a><span id="l64.38">     switch (result) {</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineminus">-        case Components.results.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+        case Cr.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l64.41"></a><span id="l64.41">             return true;</span>
<a href="#l64.42"></a><span id="l64.42">         default:</span>
<a href="#l64.43"></a><span id="l64.43">             return false;</span>
<a href="#l64.44"></a><span id="l64.44">     }</span>
<a href="#l64.45"></a><span id="l64.45"> }</span>
<a href="#l64.46"></a><span id="l64.46"> </span>
<a href="#l64.47"></a><span id="l64.47"> function calCachedCalendarObserverHelper(home, isCachedObserver) {</span>
<a href="#l64.48"></a><span id="l64.48">     this.home = home;</span>
<a href="#l64.49"></a><span id="l64.49">     this.isCachedObserver = isCachedObserver;</span>
<a href="#l64.50"></a><span id="l64.50"> }</span>
<a href="#l64.51"></a><span id="l64.51"> calCachedCalendarObserverHelper.prototype = {</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineminus">-    QueryInterface: ChromeUtils.generateQI([Components.interfaces.calIObserver]),</span>
<a href="#l64.53"></a><span id="l64.53" class="difflineplus">+    QueryInterface: ChromeUtils.generateQI([Ci.calIObserver]),</span>
<a href="#l64.54"></a><span id="l64.54">     isCachedObserver: false,</span>
<a href="#l64.55"></a><span id="l64.55"> </span>
<a href="#l64.56"></a><span id="l64.56">     onStartBatch: function() {</span>
<a href="#l64.57"></a><span id="l64.57">         this.home.mObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l64.58"></a><span id="l64.58">     },</span>
<a href="#l64.59"></a><span id="l64.59"> </span>
<a href="#l64.60"></a><span id="l64.60">     onEndBatch: function() {</span>
<a href="#l64.61"></a><span id="l64.61">         this.home.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineat">@@ -114,39 +114,39 @@ calCachedCalendarObserverHelper.prototyp</span>
<a href="#l64.63"></a><span id="l64.63">             this.home.mObservers.notify(&quot;onPropertyDeleting&quot;, [this.home, aName]);</span>
<a href="#l64.64"></a><span id="l64.64">         }</span>
<a href="#l64.65"></a><span id="l64.65">     }</span>
<a href="#l64.66"></a><span id="l64.66"> };</span>
<a href="#l64.67"></a><span id="l64.67"> </span>
<a href="#l64.68"></a><span id="l64.68"> function calCachedCalendar(uncachedCalendar) {</span>
<a href="#l64.69"></a><span id="l64.69">     this.wrappedJSObject = this;</span>
<a href="#l64.70"></a><span id="l64.70">     this.mSyncQueue = [];</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineminus">-    this.mObservers = new cal.data.ObserverSet(Components.interfaces.calIObserver);</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+    this.mObservers = new cal.data.ObserverSet(Ci.calIObserver);</span>
<a href="#l64.73"></a><span id="l64.73">     uncachedCalendar.superCalendar = this;</span>
<a href="#l64.74"></a><span id="l64.74">     uncachedCalendar.addObserver(new calCachedCalendarObserverHelper(this, false));</span>
<a href="#l64.75"></a><span id="l64.75">     this.mUncachedCalendar = uncachedCalendar;</span>
<a href="#l64.76"></a><span id="l64.76">     this.setupCachedCalendar();</span>
<a href="#l64.77"></a><span id="l64.77">     if (this.supportsChangeLog) {</span>
<a href="#l64.78"></a><span id="l64.78">         uncachedCalendar.offlineStorage = this.mCachedCalendar;</span>
<a href="#l64.79"></a><span id="l64.79">     }</span>
<a href="#l64.80"></a><span id="l64.80">     this.offlineCachedItems = {};</span>
<a href="#l64.81"></a><span id="l64.81">     this.offlineCachedItemFlags = {};</span>
<a href="#l64.82"></a><span id="l64.82"> }</span>
<a href="#l64.83"></a><span id="l64.83"> calCachedCalendar.prototype = {</span>
<a href="#l64.84"></a><span id="l64.84">     /* eslint-disable mozilla/use-chromeutils-generateqi */</span>
<a href="#l64.85"></a><span id="l64.85">     QueryInterface: function(aIID) {</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineminus">-        if (aIID.equals(Components.interfaces.calISchedulingSupport) &amp;&amp;</span>
<a href="#l64.87"></a><span id="l64.87" class="difflineplus">+        if (aIID.equals(Ci.calISchedulingSupport) &amp;&amp;</span>
<a href="#l64.88"></a><span id="l64.88">             this.mUncachedCalendar.QueryInterface(aIID)) {</span>
<a href="#l64.89"></a><span id="l64.89">             // check whether uncached calendar supports it:</span>
<a href="#l64.90"></a><span id="l64.90">             return this;</span>
<a href="#l64.91"></a><span id="l64.91" class="difflineminus">-        } else if (aIID.equals(Components.interfaces.calICalendar) ||</span>
<a href="#l64.92"></a><span id="l64.92" class="difflineminus">-                   aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l64.93"></a><span id="l64.93" class="difflineplus">+        } else if (aIID.equals(Ci.calICalendar) ||</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+                   aIID.equals(Ci.nsISupports)) {</span>
<a href="#l64.95"></a><span id="l64.95">             return this;</span>
<a href="#l64.96"></a><span id="l64.96">         } else {</span>
<a href="#l64.97"></a><span id="l64.97" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l64.98"></a><span id="l64.98" class="difflineplus">+            throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l64.99"></a><span id="l64.99">         }</span>
<a href="#l64.100"></a><span id="l64.100">     },</span>
<a href="#l64.101"></a><span id="l64.101">     /* eslint-enable mozilla/use-chromeutils-generateqi */</span>
<a href="#l64.102"></a><span id="l64.102"> </span>
<a href="#l64.103"></a><span id="l64.103">     mCachedCalendar: null,</span>
<a href="#l64.104"></a><span id="l64.104">     mCachedObserver: null,</span>
<a href="#l64.105"></a><span id="l64.105">     mUncachedCalendar: null,</span>
<a href="#l64.106"></a><span id="l64.106">     mObservers: null,</span>
<a href="#l64.107"></a><span id="l64.107" class="difflineat">@@ -162,42 +162,42 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.108"></a><span id="l64.108">             // afterwards.</span>
<a href="#l64.109"></a><span id="l64.109"> </span>
<a href="#l64.110"></a><span id="l64.110">             let listener = {</span>
<a href="#l64.111"></a><span id="l64.111">                 onDeleteCalendar: function(aCalendar, aStatus, aDetail) {</span>
<a href="#l64.112"></a><span id="l64.112">                     self.mCachedCalendar = null;</span>
<a href="#l64.113"></a><span id="l64.113">                 }</span>
<a href="#l64.114"></a><span id="l64.114">             };</span>
<a href="#l64.115"></a><span id="l64.115"> </span>
<a href="#l64.116"></a><span id="l64.116" class="difflineminus">-            this.mCachedCalendar.QueryInterface(Components.interfaces.calICalendarProvider)</span>
<a href="#l64.117"></a><span id="l64.117" class="difflineplus">+            this.mCachedCalendar.QueryInterface(Ci.calICalendarProvider)</span>
<a href="#l64.118"></a><span id="l64.118">                                 .deleteCalendar(this.mCachedCalendar, listener);</span>
<a href="#l64.119"></a><span id="l64.119">         }</span>
<a href="#l64.120"></a><span id="l64.120">     },</span>
<a href="#l64.121"></a><span id="l64.121"> </span>
<a href="#l64.122"></a><span id="l64.122">     setupCachedCalendar: function() {</span>
<a href="#l64.123"></a><span id="l64.123">         try {</span>
<a href="#l64.124"></a><span id="l64.124">             if (this.mCachedCalendar) { // this is actually a resetupCachedCalendar:</span>
<a href="#l64.125"></a><span id="l64.125">                 // Although this doesn't really follow the spec, we know the</span>
<a href="#l64.126"></a><span id="l64.126">                 // storage calendar's deleteCalendar method is synchronous.</span>
<a href="#l64.127"></a><span id="l64.127">                 // TODO put changes into a different calendar and delete</span>
<a href="#l64.128"></a><span id="l64.128">                 // afterwards.</span>
<a href="#l64.129"></a><span id="l64.129" class="difflineminus">-                this.mCachedCalendar.QueryInterface(Components.interfaces.calICalendarProvider)</span>
<a href="#l64.130"></a><span id="l64.130" class="difflineplus">+                this.mCachedCalendar.QueryInterface(Ci.calICalendarProvider)</span>
<a href="#l64.131"></a><span id="l64.131">                                     .deleteCalendar(this.mCachedCalendar, null);</span>
<a href="#l64.132"></a><span id="l64.132">                 if (this.supportsChangeLog) {</span>
<a href="#l64.133"></a><span id="l64.133">                     // start with full sync:</span>
<a href="#l64.134"></a><span id="l64.134">                     this.mUncachedCalendar.resetLog();</span>
<a href="#l64.135"></a><span id="l64.135">                 }</span>
<a href="#l64.136"></a><span id="l64.136">             } else {</span>
<a href="#l64.137"></a><span id="l64.137">                 let calType = Preferences.get(&quot;calendar.cache.type&quot;, &quot;storage&quot;);</span>
<a href="#l64.138"></a><span id="l64.138">                 // While technically, the above deleteCalendar should delete the</span>
<a href="#l64.139"></a><span id="l64.139">                 // whole calendar, this is nothing more than deleting all events</span>
<a href="#l64.140"></a><span id="l64.140">                 // todos and properties. Therefore the initialization can be</span>
<a href="#l64.141"></a><span id="l64.141">                 // skipped.</span>
<a href="#l64.142"></a><span id="l64.142" class="difflineminus">-                let cachedCalendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + calType]</span>
<a href="#l64.143"></a><span id="l64.143" class="difflineminus">-                                               .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l64.144"></a><span id="l64.144" class="difflineplus">+                let cachedCalendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + calType]</span>
<a href="#l64.145"></a><span id="l64.145" class="difflineplus">+                                       .createInstance(Ci.calICalendar);</span>
<a href="#l64.146"></a><span id="l64.146">                 switch (calType) {</span>
<a href="#l64.147"></a><span id="l64.147">                     case &quot;memory&quot;: {</span>
<a href="#l64.148"></a><span id="l64.148">                         if (this.supportsChangeLog) {</span>
<a href="#l64.149"></a><span id="l64.149">                             // start with full sync:</span>
<a href="#l64.150"></a><span id="l64.150">                             this.mUncachedCalendar.resetLog();</span>
<a href="#l64.151"></a><span id="l64.151">                         }</span>
<a href="#l64.152"></a><span id="l64.152">                         break;</span>
<a href="#l64.153"></a><span id="l64.153">                     }</span>
<a href="#l64.154"></a><span id="l64.154" class="difflineat">@@ -217,25 +217,25 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.155"></a><span id="l64.155">                 cachedCalendar.superCalendar = this;</span>
<a href="#l64.156"></a><span id="l64.156">                 if (!this.mCachedObserver) {</span>
<a href="#l64.157"></a><span id="l64.157">                     this.mCachedObserver = new calCachedCalendarObserverHelper(this, true);</span>
<a href="#l64.158"></a><span id="l64.158">                 }</span>
<a href="#l64.159"></a><span id="l64.159">                 cachedCalendar.addObserver(this.mCachedObserver);</span>
<a href="#l64.160"></a><span id="l64.160">                 this.mCachedCalendar = cachedCalendar;</span>
<a href="#l64.161"></a><span id="l64.161">             }</span>
<a href="#l64.162"></a><span id="l64.162">         } catch (exc) {</span>
<a href="#l64.163"></a><span id="l64.163" class="difflineminus">-            Components.utils.reportError(exc);</span>
<a href="#l64.164"></a><span id="l64.164" class="difflineplus">+            Cu.reportError(exc);</span>
<a href="#l64.165"></a><span id="l64.165">         }</span>
<a href="#l64.166"></a><span id="l64.166">     },</span>
<a href="#l64.167"></a><span id="l64.167"> </span>
<a href="#l64.168"></a><span id="l64.168">     getOfflineAddedItems: function(callbackFunc) {</span>
<a href="#l64.169"></a><span id="l64.169">         let self = this;</span>
<a href="#l64.170"></a><span id="l64.170">         self.offlineCachedItems = {};</span>
<a href="#l64.171"></a><span id="l64.171">         let getListener = {</span>
<a href="#l64.172"></a><span id="l64.172" class="difflineminus">-            QueryInterface: ChromeUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l64.173"></a><span id="l64.173" class="difflineplus">+            QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.174"></a><span id="l64.174">             onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l64.175"></a><span id="l64.175">                 for (let item of aItems) {</span>
<a href="#l64.176"></a><span id="l64.176">                     self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l64.177"></a><span id="l64.177">                     self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l64.178"></a><span id="l64.178">                 }</span>
<a href="#l64.179"></a><span id="l64.179">             },</span>
<a href="#l64.180"></a><span id="l64.180"> </span>
<a href="#l64.181"></a><span id="l64.181">             onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.182"></a><span id="l64.182" class="difflineat">@@ -244,17 +244,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.183"></a><span id="l64.183">         };</span>
<a href="#l64.184"></a><span id="l64.184">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_ALL_ITEMS | calICalendar.ITEM_FILTER_OFFLINE_CREATED,</span>
<a href="#l64.185"></a><span id="l64.185">                                       0, null, null, getListener);</span>
<a href="#l64.186"></a><span id="l64.186">     },</span>
<a href="#l64.187"></a><span id="l64.187"> </span>
<a href="#l64.188"></a><span id="l64.188">     getOfflineModifiedItems: function(callbackFunc) {</span>
<a href="#l64.189"></a><span id="l64.189">         let self = this;</span>
<a href="#l64.190"></a><span id="l64.190">         let getListener = {</span>
<a href="#l64.191"></a><span id="l64.191" class="difflineminus">-            QueryInterface: ChromeUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l64.192"></a><span id="l64.192" class="difflineplus">+            QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.193"></a><span id="l64.193">             onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l64.194"></a><span id="l64.194">                 for (let item of aItems) {</span>
<a href="#l64.195"></a><span id="l64.195">                     self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l64.196"></a><span id="l64.196">                     self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l64.197"></a><span id="l64.197">                 }</span>
<a href="#l64.198"></a><span id="l64.198">             },</span>
<a href="#l64.199"></a><span id="l64.199"> </span>
<a href="#l64.200"></a><span id="l64.200">             onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.201"></a><span id="l64.201" class="difflineat">@@ -263,17 +263,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.202"></a><span id="l64.202">         };</span>
<a href="#l64.203"></a><span id="l64.203">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_MODIFIED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l64.204"></a><span id="l64.204">                                       0, null, null, getListener);</span>
<a href="#l64.205"></a><span id="l64.205">     },</span>
<a href="#l64.206"></a><span id="l64.206"> </span>
<a href="#l64.207"></a><span id="l64.207">     getOfflineDeletedItems: function(callbackFunc) {</span>
<a href="#l64.208"></a><span id="l64.208">         let self = this;</span>
<a href="#l64.209"></a><span id="l64.209">         let getListener = {</span>
<a href="#l64.210"></a><span id="l64.210" class="difflineminus">-            QueryInterface: ChromeUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l64.211"></a><span id="l64.211" class="difflineplus">+            QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.212"></a><span id="l64.212">             onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l64.213"></a><span id="l64.213">                 for (let item of aItems) {</span>
<a href="#l64.214"></a><span id="l64.214">                     self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l64.215"></a><span id="l64.215">                     self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l64.216"></a><span id="l64.216">                 }</span>
<a href="#l64.217"></a><span id="l64.217">             },</span>
<a href="#l64.218"></a><span id="l64.218"> </span>
<a href="#l64.219"></a><span id="l64.219">             onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.220"></a><span id="l64.220" class="difflineat">@@ -286,17 +286,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.221"></a><span id="l64.221">                                       0, null, null, getListener);</span>
<a href="#l64.222"></a><span id="l64.222">     },</span>
<a href="#l64.223"></a><span id="l64.223"> </span>
<a href="#l64.224"></a><span id="l64.224">     mPendingSync: null,</span>
<a href="#l64.225"></a><span id="l64.225">     mSyncQueue: null,</span>
<a href="#l64.226"></a><span id="l64.226">     synchronize: function(respFunc) {</span>
<a href="#l64.227"></a><span id="l64.227">         let self = this;</span>
<a href="#l64.228"></a><span id="l64.228">         if (this.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l64.229"></a><span id="l64.229" class="difflineminus">-            return emptyQueue(Components.results.NS_OK);</span>
<a href="#l64.230"></a><span id="l64.230" class="difflineplus">+            return emptyQueue(Cr.NS_OK);</span>
<a href="#l64.231"></a><span id="l64.231">         }</span>
<a href="#l64.232"></a><span id="l64.232"> </span>
<a href="#l64.233"></a><span id="l64.233">         this.mSyncQueue.push(respFunc);</span>
<a href="#l64.234"></a><span id="l64.234">         if (this.mSyncQueue.length &gt; 1) { // don't use mPendingSync here</span>
<a href="#l64.235"></a><span id="l64.235">             cal.LOG(&quot;[calCachedCalendar] sync in action/pending.&quot;);</span>
<a href="#l64.236"></a><span id="l64.236">             return this.mPendingSync;</span>
<a href="#l64.237"></a><span id="l64.237">         }</span>
<a href="#l64.238"></a><span id="l64.238"> </span>
<a href="#l64.239"></a><span id="l64.239" class="difflineat">@@ -313,25 +313,25 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.240"></a><span id="l64.240">             queue.forEach(execResponseFunc);</span>
<a href="#l64.241"></a><span id="l64.241">             cal.LOG(&quot;[calCachedCalendar] sync queue empty.&quot;);</span>
<a href="#l64.242"></a><span id="l64.242">             let operation = self.mPendingSync;</span>
<a href="#l64.243"></a><span id="l64.243">             self.mPendingSync = null;</span>
<a href="#l64.244"></a><span id="l64.244">             return operation;</span>
<a href="#l64.245"></a><span id="l64.245">         }</span>
<a href="#l64.246"></a><span id="l64.246"> </span>
<a href="#l64.247"></a><span id="l64.247">         if (this.offline) {</span>
<a href="#l64.248"></a><span id="l64.248" class="difflineminus">-            return emptyQueue(Components.results.NS_OK);</span>
<a href="#l64.249"></a><span id="l64.249" class="difflineplus">+            return emptyQueue(Cr.NS_OK);</span>
<a href="#l64.250"></a><span id="l64.250">         }</span>
<a href="#l64.251"></a><span id="l64.251"> </span>
<a href="#l64.252"></a><span id="l64.252">         if (this.supportsChangeLog) {</span>
<a href="#l64.253"></a><span id="l64.253">             cal.LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l64.254"></a><span id="l64.254">             let opListener = {</span>
<a href="#l64.255"></a><span id="l64.255">                 onResult: function(operation, result) {</span>
<a href="#l64.256"></a><span id="l64.256">                     if (!operation || !operation.isPending) {</span>
<a href="#l64.257"></a><span id="l64.257" class="difflineminus">-                        let status = (operation ? operation.status : Components.results.NS_OK);</span>
<a href="#l64.258"></a><span id="l64.258" class="difflineplus">+                        let status = (operation ? operation.status : Cr.NS_OK);</span>
<a href="#l64.259"></a><span id="l64.259">                         if (!Components.isSuccessCode(status)) {</span>
<a href="#l64.260"></a><span id="l64.260">                             cal.ERROR(&quot;[calCachedCalendar] replay action failed: &quot; +</span>
<a href="#l64.261"></a><span id="l64.261">                                       (operation ? operation.id : &quot;&lt;unknown&gt;&quot;) + &quot;, uri=&quot; +</span>
<a href="#l64.262"></a><span id="l64.262">                                       self.uri.spec + &quot;, result=&quot; +</span>
<a href="#l64.263"></a><span id="l64.263">                                       result + &quot;, operation=&quot; + operation);</span>
<a href="#l64.264"></a><span id="l64.264">                         }</span>
<a href="#l64.265"></a><span id="l64.265">                         cal.LOG(&quot;[calCachedCalendar] replayChangesOn finished.&quot;);</span>
<a href="#l64.266"></a><span id="l64.266">                         emptyQueue(status);</span>
<a href="#l64.267"></a><span id="l64.267" class="difflineat">@@ -339,17 +339,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.268"></a><span id="l64.268">                 }</span>
<a href="#l64.269"></a><span id="l64.269">             };</span>
<a href="#l64.270"></a><span id="l64.270">             this.mPendingSync = this.mUncachedCalendar.replayChangesOn(opListener);</span>
<a href="#l64.271"></a><span id="l64.271">             return this.mPendingSync;</span>
<a href="#l64.272"></a><span id="l64.272">         }</span>
<a href="#l64.273"></a><span id="l64.273"> </span>
<a href="#l64.274"></a><span id="l64.274">         cal.LOG(&quot;[calCachedCalendar] Doing full sync for calendar &quot; + this.uri.spec);</span>
<a href="#l64.275"></a><span id="l64.275">         let completeListener = {</span>
<a href="#l64.276"></a><span id="l64.276" class="difflineminus">-            QueryInterface: ChromeUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l64.277"></a><span id="l64.277" class="difflineplus">+            QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.278"></a><span id="l64.278">             modifiedTimes: {},</span>
<a href="#l64.279"></a><span id="l64.279">             hasRenewedCalendar: false,</span>
<a href="#l64.280"></a><span id="l64.280">             getsCompleted: 0,</span>
<a href="#l64.281"></a><span id="l64.281">             getsReceived: 0,</span>
<a href="#l64.282"></a><span id="l64.282">             opCompleted: false,</span>
<a href="#l64.283"></a><span id="l64.283"> </span>
<a href="#l64.284"></a><span id="l64.284">             onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l64.285"></a><span id="l64.285">                 if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l64.286"></a><span id="l64.286" class="difflineat">@@ -437,17 +437,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.287"></a><span id="l64.287">                 } else {</span>
<a href="#l64.288"></a><span id="l64.288">                     self.playbackOfflineItems(() =&gt; self.mCachedObserver.onLoad(self.mCachedCalendar));</span>
<a href="#l64.289"></a><span id="l64.289">                     emptyQueue(aStatus);</span>
<a href="#l64.290"></a><span id="l64.290">                 }</span>
<a href="#l64.291"></a><span id="l64.291">             }</span>
<a href="#l64.292"></a><span id="l64.292">         };</span>
<a href="#l64.293"></a><span id="l64.293"> </span>
<a href="#l64.294"></a><span id="l64.294">         this.getOfflineAddedItems(() =&gt; {</span>
<a href="#l64.295"></a><span id="l64.295" class="difflineminus">-            this.mPendingSync = this.mUncachedCalendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l64.296"></a><span id="l64.296" class="difflineplus">+            this.mPendingSync = this.mUncachedCalendar.getItems(Ci.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l64.297"></a><span id="l64.297">                                                                     0, null, null, completeListener);</span>
<a href="#l64.298"></a><span id="l64.298">         });</span>
<a href="#l64.299"></a><span id="l64.299">         return this.mPendingSync;</span>
<a href="#l64.300"></a><span id="l64.300">     },</span>
<a href="#l64.301"></a><span id="l64.301"> </span>
<a href="#l64.302"></a><span id="l64.302">     onOfflineStatusChanged: function(aNewState) {</span>
<a href="#l64.303"></a><span id="l64.303">         if (aNewState) {</span>
<a href="#l64.304"></a><span id="l64.304">             // Going offline: (XXX get items before going offline?) =&gt; we may ask the user to stay online a bit longer</span>
<a href="#l64.305"></a><span id="l64.305" class="difflineat">@@ -476,17 +476,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.306"></a><span id="l64.306">      * @param aPlaybackType     (optional) The starting operation type. This function will be</span>
<a href="#l64.307"></a><span id="l64.307">      *                          called recursively through playback operations in the order of</span>
<a href="#l64.308"></a><span id="l64.308">      *                          add, modify, delete. By default playback will start with the add</span>
<a href="#l64.309"></a><span id="l64.309">      *                          operation. Valid values for this parameter are defined as</span>
<a href="#l64.310"></a><span id="l64.310">      *                          OFFLINE_FLAG_XXX constants in the calIChangeLog interface.</span>
<a href="#l64.311"></a><span id="l64.311">      */</span>
<a href="#l64.312"></a><span id="l64.312">     playbackOfflineItems: function(aCallback, aPlaybackType) {</span>
<a href="#l64.313"></a><span id="l64.313">         let self = this;</span>
<a href="#l64.314"></a><span id="l64.314" class="difflineminus">-        let storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l64.315"></a><span id="l64.315" class="difflineplus">+        let storage = this.mCachedCalendar.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l64.316"></a><span id="l64.316"> </span>
<a href="#l64.317"></a><span id="l64.317">         let resetListener = gNoOpListener;</span>
<a href="#l64.318"></a><span id="l64.318">         let itemQueue = [];</span>
<a href="#l64.319"></a><span id="l64.319">         let debugOp;</span>
<a href="#l64.320"></a><span id="l64.320">         let nextCallback;</span>
<a href="#l64.321"></a><span id="l64.321">         let uncachedOp;</span>
<a href="#l64.322"></a><span id="l64.322">         let listenerOp;</span>
<a href="#l64.323"></a><span id="l64.323">         let filter;</span>
<a href="#l64.324"></a><span id="l64.324" class="difflineat">@@ -590,17 +590,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.325"></a><span id="l64.325">     set superCalendar(val) {</span>
<a href="#l64.326"></a><span id="l64.326">         return (this.mSuperCalendar = val);</span>
<a href="#l64.327"></a><span id="l64.327">     },</span>
<a href="#l64.328"></a><span id="l64.328"> </span>
<a href="#l64.329"></a><span id="l64.329">     get offline() {</span>
<a href="#l64.330"></a><span id="l64.330">         return Services.io.offline;</span>
<a href="#l64.331"></a><span id="l64.331">     },</span>
<a href="#l64.332"></a><span id="l64.332">     get supportsChangeLog() {</span>
<a href="#l64.333"></a><span id="l64.333" class="difflineminus">-        return (cal.wrapInstance(this.mUncachedCalendar, Components.interfaces.calIChangeLog) != null);</span>
<a href="#l64.334"></a><span id="l64.334" class="difflineplus">+        return (cal.wrapInstance(this.mUncachedCalendar, Ci.calIChangeLog) != null);</span>
<a href="#l64.335"></a><span id="l64.335">     },</span>
<a href="#l64.336"></a><span id="l64.336"> </span>
<a href="#l64.337"></a><span id="l64.337">     get canRefresh() { // enable triggering sync using the reload button</span>
<a href="#l64.338"></a><span id="l64.338">         return true;</span>
<a href="#l64.339"></a><span id="l64.339">     },</span>
<a href="#l64.340"></a><span id="l64.340"> </span>
<a href="#l64.341"></a><span id="l64.341">     getProperty: function(aName) {</span>
<a href="#l64.342"></a><span id="l64.342">         switch (aName) {</span>
<a href="#l64.343"></a><span id="l64.343" class="difflineat">@@ -688,17 +688,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.344"></a><span id="l64.344">     adoptOfflineItem: function(item, listener) {</span>
<a href="#l64.345"></a><span id="l64.345">         let self = this;</span>
<a href="#l64.346"></a><span id="l64.346">         let opListener = {</span>
<a href="#l64.347"></a><span id="l64.347">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l64.348"></a><span id="l64.348">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l64.349"></a><span id="l64.349">             },</span>
<a href="#l64.350"></a><span id="l64.350">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.351"></a><span id="l64.351">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l64.352"></a><span id="l64.352" class="difflineminus">-                    let storage = self.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l64.353"></a><span id="l64.353" class="difflineplus">+                    let storage = self.mCachedCalendar.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l64.354"></a><span id="l64.354">                     storage.addOfflineItem(detail, listener);</span>
<a href="#l64.355"></a><span id="l64.355">                 } else if (listener) {</span>
<a href="#l64.356"></a><span id="l64.356">                     listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l64.357"></a><span id="l64.357">                 }</span>
<a href="#l64.358"></a><span id="l64.358">             }</span>
<a href="#l64.359"></a><span id="l64.359">         };</span>
<a href="#l64.360"></a><span id="l64.360">         this.mCachedCalendar.adoptItem(item, opListener);</span>
<a href="#l64.361"></a><span id="l64.361">     },</span>
<a href="#l64.362"></a><span id="l64.362" class="difflineat">@@ -766,17 +766,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.363"></a><span id="l64.363">         let opListener = {</span>
<a href="#l64.364"></a><span id="l64.364">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l64.365"></a><span id="l64.365">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l64.366"></a><span id="l64.366">             },</span>
<a href="#l64.367"></a><span id="l64.367">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.368"></a><span id="l64.368">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l64.369"></a><span id="l64.369">                     // Modify the offline item in the storage, passing the</span>
<a href="#l64.370"></a><span id="l64.370">                     // listener will make sure its notified</span>
<a href="#l64.371"></a><span id="l64.371" class="difflineminus">-                    let storage = self.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l64.372"></a><span id="l64.372" class="difflineplus">+                    let storage = self.mCachedCalendar.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l64.373"></a><span id="l64.373">                     storage.modifyOfflineItem(detail, listener);</span>
<a href="#l64.374"></a><span id="l64.374">                 } else if (listener) {</span>
<a href="#l64.375"></a><span id="l64.375">                     // If there was not a success, then we need to notify the</span>
<a href="#l64.376"></a><span id="l64.376">                     // listener ourselves</span>
<a href="#l64.377"></a><span id="l64.377">                     listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l64.378"></a><span id="l64.378">                 }</span>
<a href="#l64.379"></a><span id="l64.379">             }</span>
<a href="#l64.380"></a><span id="l64.380">         };</span>
<a href="#l64.381"></a><span id="l64.381" class="difflineat">@@ -823,17 +823,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.382"></a><span id="l64.382">                     cal.LOG(&quot;[calCachedCalendar] Calendar &quot; + calendar.name + &quot; is unavailable, deleting item offline&quot;);</span>
<a href="#l64.383"></a><span id="l64.383">                     self.deleteOfflineItem(item, listener);</span>
<a href="#l64.384"></a><span id="l64.384">                 } else if (Components.isSuccessCode(status)) {</span>
<a href="#l64.385"></a><span id="l64.385">                     // On success, delete the item from the cache</span>
<a href="#l64.386"></a><span id="l64.386">                     self.mCachedCalendar.deleteItem(item, listener);</span>
<a href="#l64.387"></a><span id="l64.387"> </span>
<a href="#l64.388"></a><span id="l64.388">                     // Also, remove any meta data associated with the item</span>
<a href="#l64.389"></a><span id="l64.389">                     try {</span>
<a href="#l64.390"></a><span id="l64.390" class="difflineminus">-                        let storage = self.mCachedCalendar.QueryInterface(Components.interfaces.calISyncWriteCalendar);</span>
<a href="#l64.391"></a><span id="l64.391" class="difflineplus">+                        let storage = self.mCachedCalendar.QueryInterface(Ci.calISyncWriteCalendar);</span>
<a href="#l64.392"></a><span id="l64.392">                         storage.deleteMetaData(item.id);</span>
<a href="#l64.393"></a><span id="l64.393">                     } catch (e) {</span>
<a href="#l64.394"></a><span id="l64.394">                         cal.LOG(&quot;[calCachedCalendar] Offline storage doesn't support metadata&quot;);</span>
<a href="#l64.395"></a><span id="l64.395">                     }</span>
<a href="#l64.396"></a><span id="l64.396">                 } else if (listener) {</span>
<a href="#l64.397"></a><span id="l64.397">                     // This happens on error, forward the error through the listener</span>
<a href="#l64.398"></a><span id="l64.398">                     listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l64.399"></a><span id="l64.399">                 }</span>
<a href="#l64.400"></a><span id="l64.400" class="difflineat">@@ -846,17 +846,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.401"></a><span id="l64.401">         } else {</span>
<a href="#l64.402"></a><span id="l64.402">             // Otherwise, get the item flags, the listener will further</span>
<a href="#l64.403"></a><span id="l64.403">             // process the item.</span>
<a href="#l64.404"></a><span id="l64.404">             this.mCachedCalendar.getItemOfflineFlag(item, flagListener);</span>
<a href="#l64.405"></a><span id="l64.405">         }</span>
<a href="#l64.406"></a><span id="l64.406">     },</span>
<a href="#l64.407"></a><span id="l64.407">     deleteOfflineItem: function(item, listener) {</span>
<a href="#l64.408"></a><span id="l64.408">         /* We do not delete the item from the cache, as we will need it when reconciling the cache content and the server content. */</span>
<a href="#l64.409"></a><span id="l64.409" class="difflineminus">-        let storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l64.410"></a><span id="l64.410" class="difflineplus">+        let storage = this.mCachedCalendar.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l64.411"></a><span id="l64.411">         storage.deleteOfflineItem(item, listener);</span>
<a href="#l64.412"></a><span id="l64.412">     }</span>
<a href="#l64.413"></a><span id="l64.413"> };</span>
<a href="#l64.414"></a><span id="l64.414"> (function() {</span>
<a href="#l64.415"></a><span id="l64.415">     function defineForwards(proto, targetName, functions, getters, gettersAndSetters) {</span>
<a href="#l64.416"></a><span id="l64.416">         function defineForwardGetter(attr) {</span>
<a href="#l64.417"></a><span id="l64.417">             proto.__defineGetter__(attr, function() { return this[targetName][attr]; });</span>
<a href="#l64.418"></a><span id="l64.418">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -9,35 +9,31 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l65.4"></a><span id="l65.4"> </span>
<a href="#l65.5"></a><span id="l65.5"> var REGISTRY_BRANCH = &quot;calendar.registry.&quot;;</span>
<a href="#l65.6"></a><span id="l65.6"> var DB_SCHEMA_VERSION = 10;</span>
<a href="#l65.7"></a><span id="l65.7"> var MAX_INT = Math.pow(2, 31) - 1;</span>
<a href="#l65.8"></a><span id="l65.8"> var MIN_INT = -MAX_INT;</span>
<a href="#l65.9"></a><span id="l65.9"> </span>
<a href="#l65.10"></a><span id="l65.10"> function calCalendarManager() {</span>
<a href="#l65.11"></a><span id="l65.11">     this.wrappedJSObject = this;</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-    this.mObservers = new cal.data.ListenerSet(Components.interfaces.calICalendarManagerObserver);</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-    this.mCalendarObservers = new cal.data.ListenerSet(Components.interfaces.calIObserver);</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+    this.mObservers = new cal.data.ListenerSet(Ci.calICalendarManagerObserver);</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+    this.mCalendarObservers = new cal.data.ListenerSet(Ci.calIObserver);</span>
<a href="#l65.16"></a><span id="l65.16"> }</span>
<a href="#l65.17"></a><span id="l65.17"> </span>
<a href="#l65.18"></a><span id="l65.18"> var calCalendarManagerClassID = Components.ID(&quot;{f42585e7-e736-4600-985d-9624c1c51992}&quot;);</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineminus">-var calCalendarManagerInterfaces = [</span>
<a href="#l65.20"></a><span id="l65.20" class="difflineminus">-    Components.interfaces.calICalendarManager,</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineminus">-    Components.interfaces.calIStartupService,</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineminus">-    Components.interfaces.nsIObserver,</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineminus">-];</span>
<a href="#l65.24"></a><span id="l65.24" class="difflineplus">+var calCalendarManagerInterfaces = [Ci.calICalendarManager, Ci.calIStartupService, Ci.nsIObserver];</span>
<a href="#l65.25"></a><span id="l65.25"> calCalendarManager.prototype = {</span>
<a href="#l65.26"></a><span id="l65.26">     classID: calCalendarManagerClassID,</span>
<a href="#l65.27"></a><span id="l65.27">     QueryInterface: cal.generateQI(calCalendarManagerInterfaces),</span>
<a href="#l65.28"></a><span id="l65.28">     classInfo: cal.generateCI({</span>
<a href="#l65.29"></a><span id="l65.29">         classID: calCalendarManagerClassID,</span>
<a href="#l65.30"></a><span id="l65.30">         contractID: &quot;@mozilla.org/calendar/manager;1&quot;,</span>
<a href="#l65.31"></a><span id="l65.31">         classDescription: &quot;Calendar Manager&quot;,</span>
<a href="#l65.32"></a><span id="l65.32">         interfaces: calCalendarManagerInterfaces,</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineminus">-        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineplus">+        flags: Ci.nsIClassInfo.SINGLETON</span>
<a href="#l65.35"></a><span id="l65.35">     }),</span>
<a href="#l65.36"></a><span id="l65.36"> </span>
<a href="#l65.37"></a><span id="l65.37">     get networkCalendarCount() { return this.mNetworkCalendarCount; },</span>
<a href="#l65.38"></a><span id="l65.38">     get readOnlyCalendarCount() { return this.mReadonlyCalendarCount; },</span>
<a href="#l65.39"></a><span id="l65.39">     get calendarCount() { return this.mCalendarCount; },</span>
<a href="#l65.40"></a><span id="l65.40"> </span>
<a href="#l65.41"></a><span id="l65.41">     // calIStartupService:</span>
<a href="#l65.42"></a><span id="l65.42">     startup: function(aCompleteListener) {</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineat">@@ -54,17 +50,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.44"></a><span id="l65.44">         Services.obs.addObserver(this, &quot;http-on-modify-request&quot;);</span>
<a href="#l65.45"></a><span id="l65.45"> </span>
<a href="#l65.46"></a><span id="l65.46">         // We only add the observer if the pref is set and only check for the</span>
<a href="#l65.47"></a><span id="l65.47">         // pref on startup to avoid checking for every http request</span>
<a href="#l65.48"></a><span id="l65.48">         if (Preferences.get(&quot;calendar.network.multirealm&quot;, false)) {</span>
<a href="#l65.49"></a><span id="l65.49">             Services.obs.addObserver(this, &quot;http-on-examine-response&quot;);</span>
<a href="#l65.50"></a><span id="l65.50">         }</span>
<a href="#l65.51"></a><span id="l65.51"> </span>
<a href="#l65.52"></a><span id="l65.52" class="difflineminus">-        aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineplus">+        aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l65.54"></a><span id="l65.54">     },</span>
<a href="#l65.55"></a><span id="l65.55"> </span>
<a href="#l65.56"></a><span id="l65.56">     shutdown: function(aCompleteListener) {</span>
<a href="#l65.57"></a><span id="l65.57">         for (let id in this.mCache) {</span>
<a href="#l65.58"></a><span id="l65.58">             let calendar = this.mCache[id];</span>
<a href="#l65.59"></a><span id="l65.59">             calendar.removeObserver(this.mCalObservers[calendar.id]);</span>
<a href="#l65.60"></a><span id="l65.60">         }</span>
<a href="#l65.61"></a><span id="l65.61"> </span>
<a href="#l65.62"></a><span id="l65.62" class="difflineat">@@ -76,17 +72,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.63"></a><span id="l65.63"> </span>
<a href="#l65.64"></a><span id="l65.64">         // Remove the observer if the pref is set. This might fail when the</span>
<a href="#l65.65"></a><span id="l65.65">         // user flips the pref, but we assume he is going to restart anyway</span>
<a href="#l65.66"></a><span id="l65.66">         // afterwards.</span>
<a href="#l65.67"></a><span id="l65.67">         if (Preferences.get(&quot;calendar.network.multirealm&quot;, false)) {</span>
<a href="#l65.68"></a><span id="l65.68">             Services.obs.removeObserver(this, &quot;http-on-examine-response&quot;);</span>
<a href="#l65.69"></a><span id="l65.69">         }</span>
<a href="#l65.70"></a><span id="l65.70"> </span>
<a href="#l65.71"></a><span id="l65.71" class="difflineminus">-        aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineplus">+        aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l65.73"></a><span id="l65.73">     },</span>
<a href="#l65.74"></a><span id="l65.74"> </span>
<a href="#l65.75"></a><span id="l65.75"> </span>
<a href="#l65.76"></a><span id="l65.76">     setupOfflineObservers: function() {</span>
<a href="#l65.77"></a><span id="l65.77">         Services.obs.addObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l65.78"></a><span id="l65.78">     },</span>
<a href="#l65.79"></a><span id="l65.79"> </span>
<a href="#l65.80"></a><span id="l65.80">     cleanupOfflineObservers: function() {</span>
<a href="#l65.81"></a><span id="l65.81" class="difflineat">@@ -110,68 +106,68 @@ calCalendarManager.prototype = {</span>
<a href="#l65.82"></a><span id="l65.82">                     if (calendar instanceof calCachedCalendar) {</span>
<a href="#l65.83"></a><span id="l65.83">                         calendar.onOfflineStatusChanged(aData == &quot;offline&quot;);</span>
<a href="#l65.84"></a><span id="l65.84">                     }</span>
<a href="#l65.85"></a><span id="l65.85">                 }</span>
<a href="#l65.86"></a><span id="l65.86">                 break;</span>
<a href="#l65.87"></a><span id="l65.87">             }</span>
<a href="#l65.88"></a><span id="l65.88">             case &quot;http-on-examine-response&quot;: {</span>
<a href="#l65.89"></a><span id="l65.89">                 try {</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineminus">-                    let channel = aSubject.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineplus">+                    let channel = aSubject.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l65.92"></a><span id="l65.92">                     if (channel.notificationCallbacks) {</span>
<a href="#l65.93"></a><span id="l65.93">                         // We use the notification callbacks to get the calendar interface,</span>
<a href="#l65.94"></a><span id="l65.94">                         // which likely works for our requests since getInterface is called</span>
<a href="#l65.95"></a><span id="l65.95">                         // from the calendar provider context.</span>
<a href="#l65.96"></a><span id="l65.96">                         let authHeader = channel.getResponseHeader(&quot;WWW-Authenticate&quot;);</span>
<a href="#l65.97"></a><span id="l65.97">                         let calendar = channel.notificationCallbacks</span>
<a href="#l65.98"></a><span id="l65.98" class="difflineminus">-                                              .getInterface(Components.interfaces.calICalendar);</span>
<a href="#l65.99"></a><span id="l65.99" class="difflineplus">+                                              .getInterface(Ci.calICalendar);</span>
<a href="#l65.100"></a><span id="l65.100">                         if (calendar &amp;&amp; !calendar.getProperty(&quot;capabilities.realmrewrite.disabled&quot;)) {</span>
<a href="#l65.101"></a><span id="l65.101">                             // The provider may choose to explicitly disable the</span>
<a href="#l65.102"></a><span id="l65.102">                             // rewriting, for example if all calendars on a</span>
<a href="#l65.103"></a><span id="l65.103">                             // domain have the same credentials</span>
<a href="#l65.104"></a><span id="l65.104">                             let escapedName = calendar.name.replace(/\\/g, &quot;\\\\&quot;)</span>
<a href="#l65.105"></a><span id="l65.105">                                                            .replace(/&quot;/g, '\\&quot;');</span>
<a href="#l65.106"></a><span id="l65.106">                             authHeader = appendToRealm(authHeader, &quot;(&quot; + escapedName + &quot;)&quot;);</span>
<a href="#l65.107"></a><span id="l65.107">                             channel.setResponseHeader(&quot;WWW-Authenticate&quot;, authHeader, false);</span>
<a href="#l65.108"></a><span id="l65.108">                         }</span>
<a href="#l65.109"></a><span id="l65.109">                     }</span>
<a href="#l65.110"></a><span id="l65.110">                 } catch (e) {</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineminus">-                    if (e.result != Components.results.NS_NOINTERFACE &amp;&amp;</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineminus">-                        e.result != Components.results.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l65.113"></a><span id="l65.113" class="difflineplus">+                    if (e.result != Cr.NS_NOINTERFACE &amp;&amp;</span>
<a href="#l65.114"></a><span id="l65.114" class="difflineplus">+                        e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l65.115"></a><span id="l65.115">                         throw e;</span>
<a href="#l65.116"></a><span id="l65.116">                     }</span>
<a href="#l65.117"></a><span id="l65.117">                     // Possible reasons we got here:</span>
<a href="#l65.118"></a><span id="l65.118">                     // - Its not a http channel (wtf? Oh well)</span>
<a href="#l65.119"></a><span id="l65.119">                     // - The owner is not a calICalendar (looks like its not our deal)</span>
<a href="#l65.120"></a><span id="l65.120">                     // - The WWW-Authenticate header is missing (thats ok)</span>
<a href="#l65.121"></a><span id="l65.121">                 }</span>
<a href="#l65.122"></a><span id="l65.122">                 break;</span>
<a href="#l65.123"></a><span id="l65.123">             }</span>
<a href="#l65.124"></a><span id="l65.124">             case &quot;http-on-modify-request&quot;: {</span>
<a href="#l65.125"></a><span id="l65.125">                 // Unfortunately, the ability to do this with a general pref has</span>
<a href="#l65.126"></a><span id="l65.126">                 // been removed. Calendar servers might still want to know what</span>
<a href="#l65.127"></a><span id="l65.127">                 // client is used for access, so add our UA String to each</span>
<a href="#l65.128"></a><span id="l65.128">                 // request.</span>
<a href="#l65.129"></a><span id="l65.129" class="difflineminus">-                let httpChannel = aSubject.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineplus">+                let httpChannel = aSubject.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l65.131"></a><span id="l65.131">                 try {</span>
<a href="#l65.132"></a><span id="l65.132">                     // NOTE: For some reason, this observer call doesn't have</span>
<a href="#l65.133"></a><span id="l65.133">                     // the &quot;cal&quot; namespace defined</span>
<a href="#l65.134"></a><span id="l65.134">                     let userAgent = httpChannel.getRequestHeader(&quot;User-Agent&quot;);</span>
<a href="#l65.135"></a><span id="l65.135">                     let calUAString = Preferences.get(&quot;calendar.useragent.extra&quot;, &quot;&quot;).trim();</span>
<a href="#l65.136"></a><span id="l65.136"> </span>
<a href="#l65.137"></a><span id="l65.137">                     // Don't add an empty string or an already included token.</span>
<a href="#l65.138"></a><span id="l65.138">                     if (calUAString &amp;&amp; !userAgent.includes(calUAString)) {</span>
<a href="#l65.139"></a><span id="l65.139">                         // User-Agent is not a mergeable header. We need to</span>
<a href="#l65.140"></a><span id="l65.140">                         // merge the user agent ourselves.</span>
<a href="#l65.141"></a><span id="l65.141">                         httpChannel.setRequestHeader(&quot;User-Agent&quot;,</span>
<a href="#l65.142"></a><span id="l65.142">                                                      userAgent + &quot; &quot; + calUAString,</span>
<a href="#l65.143"></a><span id="l65.143">                                                      false);</span>
<a href="#l65.144"></a><span id="l65.144">                     }</span>
<a href="#l65.145"></a><span id="l65.145">                 } catch (e) {</span>
<a href="#l65.146"></a><span id="l65.146" class="difflineminus">-                    if (e.result != Components.results.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l65.147"></a><span id="l65.147" class="difflineplus">+                    if (e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l65.148"></a><span id="l65.148">                         throw e;</span>
<a href="#l65.149"></a><span id="l65.149">                     }</span>
<a href="#l65.150"></a><span id="l65.150">                     // We swallow this error since it means the User Agent</span>
<a href="#l65.151"></a><span id="l65.151">                     // header is not set. We don't want to force it to be set.</span>
<a href="#l65.152"></a><span id="l65.152">                 }</span>
<a href="#l65.153"></a><span id="l65.153">                 break;</span>
<a href="#l65.154"></a><span id="l65.154">             }</span>
<a href="#l65.155"></a><span id="l65.155">         }</span>
<a href="#l65.156"></a><span id="l65.156" class="difflineat">@@ -311,21 +307,21 @@ calCalendarManager.prototype = {</span>
<a href="#l65.157"></a><span id="l65.157">             flushPrefs();</span>
<a href="#l65.158"></a><span id="l65.158">         } finally {</span>
<a href="#l65.159"></a><span id="l65.159">             selectPrefs.reset();</span>
<a href="#l65.160"></a><span id="l65.160">             selectCalendars.reset();</span>
<a href="#l65.161"></a><span id="l65.161">         }</span>
<a href="#l65.162"></a><span id="l65.162">     },</span>
<a href="#l65.163"></a><span id="l65.163"> </span>
<a href="#l65.164"></a><span id="l65.164">     checkAndMigrateDB: function() {</span>
<a href="#l65.165"></a><span id="l65.165" class="difflineminus">-        let storageSdb = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l65.166"></a><span id="l65.166" class="difflineplus">+        let storageSdb = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l65.167"></a><span id="l65.167">         storageSdb.append(&quot;storage.sdb&quot;);</span>
<a href="#l65.168"></a><span id="l65.168">         let db = Services.storage.openDatabase(storageSdb);</span>
<a href="#l65.169"></a><span id="l65.169"> </span>
<a href="#l65.170"></a><span id="l65.170" class="difflineminus">-        db.defaultTransactionType = Components.interfaces.mozIStorageConnection.TRANSACTION_EXCLUSIVE;</span>
<a href="#l65.171"></a><span id="l65.171" class="difflineplus">+        db.defaultTransactionType = Ci.mozIStorageConnection.TRANSACTION_EXCLUSIVE;</span>
<a href="#l65.172"></a><span id="l65.172">         db.beginTransaction();</span>
<a href="#l65.173"></a><span id="l65.173">         try {</span>
<a href="#l65.174"></a><span id="l65.174">             if (db.tableExists(&quot;cal_calendars_prefs&quot;)) {</span>
<a href="#l65.175"></a><span id="l65.175">                 // Check if we need to upgrade:</span>
<a href="#l65.176"></a><span id="l65.176">                 let version = this.getSchemaVersion(db);</span>
<a href="#l65.177"></a><span id="l65.177">                 if (version &lt; DB_SCHEMA_VERSION) {</span>
<a href="#l65.178"></a><span id="l65.178">                     this.upgradeDB(version, db);</span>
<a href="#l65.179"></a><span id="l65.179">                 }</span>
<a href="#l65.180"></a><span id="l65.180" class="difflineat">@@ -382,17 +378,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.181"></a><span id="l65.181">                 // This is the only place to leave this function gracefully.</span>
<a href="#l65.182"></a><span id="l65.182">                 return version;</span>
<a href="#l65.183"></a><span id="l65.183">             }</span>
<a href="#l65.184"></a><span id="l65.184">         } catch (e) {</span>
<a href="#l65.185"></a><span id="l65.185">             if (stmt) {</span>
<a href="#l65.186"></a><span id="l65.186">                 stmt.reset();</span>
<a href="#l65.187"></a><span id="l65.187">             }</span>
<a href="#l65.188"></a><span id="l65.188">             cal.ERROR(&quot;++++++++++++ calMgrGetSchemaVersion() error: &quot; + db.lastErrorString);</span>
<a href="#l65.189"></a><span id="l65.189" class="difflineminus">-            Components.utils.reportError(&quot;Error getting calendar schema version! DB Error: &quot; + db.lastErrorString);</span>
<a href="#l65.190"></a><span id="l65.190" class="difflineplus">+            Cu.reportError(&quot;Error getting calendar schema version! DB Error: &quot; + db.lastErrorString);</span>
<a href="#l65.191"></a><span id="l65.191">             throw e;</span>
<a href="#l65.192"></a><span id="l65.192">         }</span>
<a href="#l65.193"></a><span id="l65.193"> </span>
<a href="#l65.194"></a><span id="l65.194">         throw table + &quot; SELECT returned no results&quot;;</span>
<a href="#l65.195"></a><span id="l65.195">     },</span>
<a href="#l65.196"></a><span id="l65.196"> </span>
<a href="#l65.197"></a><span id="l65.197">     //</span>
<a href="#l65.198"></a><span id="l65.198">     // / DB migration code ends here</span>
<a href="#l65.199"></a><span id="l65.199" class="difflineat">@@ -421,60 +417,59 @@ calCalendarManager.prototype = {</span>
<a href="#l65.200"></a><span id="l65.200">                             null, // No second button text</span>
<a href="#l65.201"></a><span id="l65.201">                             null, // No third button text</span>
<a href="#l65.202"></a><span id="l65.202">                             null, // No checkbox</span>
<a href="#l65.203"></a><span id="l65.203">                             { value: false }); // Unnecessary checkbox state</span>
<a href="#l65.204"></a><span id="l65.204"> </span>
<a href="#l65.205"></a><span id="l65.205">         // Disable Lightning</span>
<a href="#l65.206"></a><span id="l65.206">         AddonManager.getAddonByID(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;, (aAddon) =&gt; {</span>
<a href="#l65.207"></a><span id="l65.207">             aAddon.userDisabled = true;</span>
<a href="#l65.208"></a><span id="l65.208" class="difflineminus">-            Services.startup.quit(Components.interfaces.nsIAppStartup.eRestart |</span>
<a href="#l65.209"></a><span id="l65.209" class="difflineminus">-                Components.interfaces.nsIAppStartup.eForceQuit);</span>
<a href="#l65.210"></a><span id="l65.210" class="difflineplus">+            Services.startup.quit(Ci.nsIAppStartup.eRestart | Ci.nsIAppStartup.eForceQuit);</span>
<a href="#l65.211"></a><span id="l65.211">         });</span>
<a href="#l65.212"></a><span id="l65.212">     },</span>
<a href="#l65.213"></a><span id="l65.213"> </span>
<a href="#l65.214"></a><span id="l65.214">     /**</span>
<a href="#l65.215"></a><span id="l65.215">      * calICalendarManager interface</span>
<a href="#l65.216"></a><span id="l65.216">      */</span>
<a href="#l65.217"></a><span id="l65.217">     createCalendar: function(type, uri) {</span>
<a href="#l65.218"></a><span id="l65.218">         try {</span>
<a href="#l65.219"></a><span id="l65.219" class="difflineminus">-            if (!Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]) {</span>
<a href="#l65.220"></a><span id="l65.220" class="difflineplus">+            if (!Cc[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]) {</span>
<a href="#l65.221"></a><span id="l65.221">                 // Don't notify the user with an extra dialog if the provider</span>
<a href="#l65.222"></a><span id="l65.222">                 // interface is missing.</span>
<a href="#l65.223"></a><span id="l65.223">                 return null;</span>
<a href="#l65.224"></a><span id="l65.224">             }</span>
<a href="#l65.225"></a><span id="l65.225" class="difflineminus">-            let calendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]</span>
<a href="#l65.226"></a><span id="l65.226" class="difflineminus">-                                     .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l65.227"></a><span id="l65.227" class="difflineplus">+            let calendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]</span>
<a href="#l65.228"></a><span id="l65.228" class="difflineplus">+                             .createInstance(Ci.calICalendar);</span>
<a href="#l65.229"></a><span id="l65.229">             calendar.uri = uri;</span>
<a href="#l65.230"></a><span id="l65.230">             return calendar;</span>
<a href="#l65.231"></a><span id="l65.231">         } catch (ex) {</span>
<a href="#l65.232"></a><span id="l65.232">             let rc = ex;</span>
<a href="#l65.233"></a><span id="l65.233">             let uiMessage = ex;</span>
<a href="#l65.234"></a><span id="l65.234" class="difflineminus">-            if (ex instanceof Components.interfaces.nsIException) {</span>
<a href="#l65.235"></a><span id="l65.235" class="difflineplus">+            if (ex instanceof Ci.nsIException) {</span>
<a href="#l65.236"></a><span id="l65.236">                 rc = ex.result;</span>
<a href="#l65.237"></a><span id="l65.237">                 uiMessage = ex.message;</span>
<a href="#l65.238"></a><span id="l65.238">             }</span>
<a href="#l65.239"></a><span id="l65.239">             switch (rc) {</span>
<a href="#l65.240"></a><span id="l65.240" class="difflineminus">-                case Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR:</span>
<a href="#l65.241"></a><span id="l65.241" class="difflineplus">+                case Ci.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR:</span>
<a href="#l65.242"></a><span id="l65.242">                     // For now we alert and quit on schema errors like we've done before:</span>
<a href="#l65.243"></a><span id="l65.243">                     this.alertAndQuit();</span>
<a href="#l65.244"></a><span id="l65.244">                     return null;</span>
<a href="#l65.245"></a><span id="l65.245" class="difflineminus">-                case Components.interfaces.calIErrors.STORAGE_UNKNOWN_TIMEZONES_ERROR:</span>
<a href="#l65.246"></a><span id="l65.246" class="difflineplus">+                case Ci.calIErrors.STORAGE_UNKNOWN_TIMEZONES_ERROR:</span>
<a href="#l65.247"></a><span id="l65.247">                     uiMessage = cal.l10n.getCalString(&quot;unknownTimezonesError&quot;, [uri.spec]);</span>
<a href="#l65.248"></a><span id="l65.248">                     break;</span>
<a href="#l65.249"></a><span id="l65.249">                 default:</span>
<a href="#l65.250"></a><span id="l65.250">                     uiMessage = cal.l10n.getCalString(&quot;unableToCreateProvider&quot;, [uri.spec]);</span>
<a href="#l65.251"></a><span id="l65.251">                     break;</span>
<a href="#l65.252"></a><span id="l65.252">             }</span>
<a href="#l65.253"></a><span id="l65.253">             // Log the original exception via error console to provide more debug info</span>
<a href="#l65.254"></a><span id="l65.254">             cal.ERROR(ex);</span>
<a href="#l65.255"></a><span id="l65.255"> </span>
<a href="#l65.256"></a><span id="l65.256">             // Log the possibly translated message via the UI.</span>
<a href="#l65.257"></a><span id="l65.257" class="difflineminus">-            let paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l65.258"></a><span id="l65.258" class="difflineminus">-                                       .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l65.259"></a><span id="l65.259" class="difflineplus">+            let paramBlock = Cc[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l65.260"></a><span id="l65.260" class="difflineplus">+                               .createInstance(Ci.nsIDialogParamBlock);</span>
<a href="#l65.261"></a><span id="l65.261">             paramBlock.SetNumberStrings(3);</span>
<a href="#l65.262"></a><span id="l65.262">             paramBlock.SetString(0, uiMessage);</span>
<a href="#l65.263"></a><span id="l65.263">             paramBlock.SetString(1, &quot;0x&quot; + rc.toString(0x10));</span>
<a href="#l65.264"></a><span id="l65.264">             paramBlock.SetString(2, ex);</span>
<a href="#l65.265"></a><span id="l65.265">             Services.ww.openWindow(null,</span>
<a href="#l65.266"></a><span id="l65.266">                                    &quot;chrome://calendar/content/calendar-error-prompt.xul&quot;,</span>
<a href="#l65.267"></a><span id="l65.267">                                    &quot;_blank&quot;,</span>
<a href="#l65.268"></a><span id="l65.268">                                    &quot;chrome,dialog=yes,alwaysRaised=yes&quot;,</span>
<a href="#l65.269"></a><span id="l65.269" class="difflineat">@@ -541,24 +536,23 @@ calCalendarManager.prototype = {</span>
<a href="#l65.270"></a><span id="l65.270">         if (refreshInterval === null) {</span>
<a href="#l65.271"></a><span id="l65.271">             // Default to 30 minutes, in case the value is missing</span>
<a href="#l65.272"></a><span id="l65.272">             refreshInterval = 30;</span>
<a href="#l65.273"></a><span id="l65.273">         }</span>
<a href="#l65.274"></a><span id="l65.274"> </span>
<a href="#l65.275"></a><span id="l65.275">         this.clearRefreshTimer(aCalendar);</span>
<a href="#l65.276"></a><span id="l65.276"> </span>
<a href="#l65.277"></a><span id="l65.277">         if (refreshInterval &gt; 0) {</span>
<a href="#l65.278"></a><span id="l65.278" class="difflineminus">-            this.mRefreshTimer[aCalendar.id] =</span>
<a href="#l65.279"></a><span id="l65.279" class="difflineminus">-                Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l65.280"></a><span id="l65.280" class="difflineminus">-                          .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l65.281"></a><span id="l65.281" class="difflineplus">+            this.mRefreshTimer[aCalendar.id] = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l65.282"></a><span id="l65.282" class="difflineplus">+                                                 .createInstance(Ci.nsITimer);</span>
<a href="#l65.283"></a><span id="l65.283"> </span>
<a href="#l65.284"></a><span id="l65.284">             this.mRefreshTimer[aCalendar.id]</span>
<a href="#l65.285"></a><span id="l65.285">                 .initWithCallback(new timerCallback(aCalendar),</span>
<a href="#l65.286"></a><span id="l65.286">                                   refreshInterval * 60000,</span>
<a href="#l65.287"></a><span id="l65.287" class="difflineminus">-                                  Components.interfaces.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l65.288"></a><span id="l65.288" class="difflineplus">+                                  Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l65.289"></a><span id="l65.289">         }</span>
<a href="#l65.290"></a><span id="l65.290">     },</span>
<a href="#l65.291"></a><span id="l65.291"> </span>
<a href="#l65.292"></a><span id="l65.292">     clearRefreshTimer: function(aCalendar) {</span>
<a href="#l65.293"></a><span id="l65.293">         if (aCalendar.id in this.mRefreshTimer &amp;&amp;</span>
<a href="#l65.294"></a><span id="l65.294">             this.mRefreshTimer[aCalendar.id]) {</span>
<a href="#l65.295"></a><span id="l65.295">             this.mRefreshTimer[aCalendar.id].cancel();</span>
<a href="#l65.296"></a><span id="l65.296">             delete this.mRefreshTimer[aCalendar.id];</span>
<a href="#l65.297"></a><span id="l65.297" class="difflineat">@@ -589,17 +583,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.298"></a><span id="l65.298">             this.mNetworkCalendarCount--;</span>
<a href="#l65.299"></a><span id="l65.299">         }</span>
<a href="#l65.300"></a><span id="l65.300">         this.mCalendarCount--;</span>
<a href="#l65.301"></a><span id="l65.301"> </span>
<a href="#l65.302"></a><span id="l65.302">         this.clearRefreshTimer(calendar);</span>
<a href="#l65.303"></a><span id="l65.303">     },</span>
<a href="#l65.304"></a><span id="l65.304"> </span>
<a href="#l65.305"></a><span id="l65.305">     removeCalendar: function(calendar, mode=0) {</span>
<a href="#l65.306"></a><span id="l65.306" class="difflineminus">-        const cICM = Components.interfaces.calICalendarManager;</span>
<a href="#l65.307"></a><span id="l65.307" class="difflineplus">+        const cICM = Ci.calICalendarManager;</span>
<a href="#l65.308"></a><span id="l65.308"> </span>
<a href="#l65.309"></a><span id="l65.309">         let removeModes = new Set(calendar.getProperty(&quot;capabilities.removeModes&quot;) || [&quot;unsubscribe&quot;]);</span>
<a href="#l65.310"></a><span id="l65.310">         if (!removeModes.has(&quot;unsubscribe&quot;) &amp;&amp; !removeModes.has(&quot;delete&quot;)) {</span>
<a href="#l65.311"></a><span id="l65.311">             // Removing is not allowed</span>
<a href="#l65.312"></a><span id="l65.312">             return;</span>
<a href="#l65.313"></a><span id="l65.313">         }</span>
<a href="#l65.314"></a><span id="l65.314"> </span>
<a href="#l65.315"></a><span id="l65.315">         if ((mode &amp; cICM.REMOVE_NO_UNREGISTER) &amp;&amp; this.mCache &amp;&amp;</span>
<a href="#l65.316"></a><span id="l65.316" class="difflineat">@@ -610,17 +604,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.317"></a><span id="l65.317">         }</span>
<a href="#l65.318"></a><span id="l65.318"> </span>
<a href="#l65.319"></a><span id="l65.319">         // This observer notification needs to be fired for both unsubscribe</span>
<a href="#l65.320"></a><span id="l65.320">         // and delete, we don't differ this at the moment.</span>
<a href="#l65.321"></a><span id="l65.321">         this.notifyObservers(&quot;onCalendarDeleting&quot;, [calendar]);</span>
<a href="#l65.322"></a><span id="l65.322"> </span>
<a href="#l65.323"></a><span id="l65.323">         // For deleting, we also call the deleteCalendar method from the provider.</span>
<a href="#l65.324"></a><span id="l65.324">         if (removeModes.has(&quot;delete&quot;) &amp;&amp; (mode &amp; cICM.REMOVE_NO_DELETE) == 0) {</span>
<a href="#l65.325"></a><span id="l65.325" class="difflineminus">-            let wrappedCalendar = cal.wrapInstance(calendar, Components.interfaces.calICalendarProvider);</span>
<a href="#l65.326"></a><span id="l65.326" class="difflineplus">+            let wrappedCalendar = cal.wrapInstance(calendar, Ci.calICalendarProvider);</span>
<a href="#l65.327"></a><span id="l65.327">             if (!wrappedCalendar) {</span>
<a href="#l65.328"></a><span id="l65.328">                 throw new Components.Exception(&quot;Calendar is missing a provider implementation for delete&quot;);</span>
<a href="#l65.329"></a><span id="l65.329">             }</span>
<a href="#l65.330"></a><span id="l65.330"> </span>
<a href="#l65.331"></a><span id="l65.331">             wrappedCalendar.deleteCalendar(calendar, null);</span>
<a href="#l65.332"></a><span id="l65.332">         }</span>
<a href="#l65.333"></a><span id="l65.333">     },</span>
<a href="#l65.334"></a><span id="l65.334"> </span>
<a href="#l65.335"></a><span id="l65.335" class="difflineat">@@ -791,18 +785,18 @@ function calMgrCalendarObserver(calendar</span>
<a href="#l65.336"></a><span id="l65.336"> }</span>
<a href="#l65.337"></a><span id="l65.337"> </span>
<a href="#l65.338"></a><span id="l65.338"> calMgrCalendarObserver.prototype = {</span>
<a href="#l65.339"></a><span id="l65.339">     calendar: null,</span>
<a href="#l65.340"></a><span id="l65.340">     storedReadOnly: null,</span>
<a href="#l65.341"></a><span id="l65.341">     calMgr: null,</span>
<a href="#l65.342"></a><span id="l65.342"> </span>
<a href="#l65.343"></a><span id="l65.343">     QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l65.344"></a><span id="l65.344" class="difflineminus">-        Components.interfaces.nsIWindowMediatorListener,</span>
<a href="#l65.345"></a><span id="l65.345" class="difflineminus">-        Components.interfaces.calIObserver</span>
<a href="#l65.346"></a><span id="l65.346" class="difflineplus">+        Ci.nsIWindowMediatorListener,</span>
<a href="#l65.347"></a><span id="l65.347" class="difflineplus">+        Ci.calIObserver</span>
<a href="#l65.348"></a><span id="l65.348">     ]),</span>
<a href="#l65.349"></a><span id="l65.349"> </span>
<a href="#l65.350"></a><span id="l65.350">     // calIObserver:</span>
<a href="#l65.351"></a><span id="l65.351">     onStartBatch: function() { return this.calMgr.notifyCalendarObservers(&quot;onStartBatch&quot;, arguments); },</span>
<a href="#l65.352"></a><span id="l65.352">     onEndBatch: function() { return this.calMgr.notifyCalendarObservers(&quot;onEndBatch&quot;, arguments); },</span>
<a href="#l65.353"></a><span id="l65.353">     onLoad: function(calendar) { return this.calMgr.notifyCalendarObservers(&quot;onLoad&quot;, arguments); },</span>
<a href="#l65.354"></a><span id="l65.354">     onAddItem: function(aItem) { return this.calMgr.notifyCalendarObservers(&quot;onAddItem&quot;, arguments); },</span>
<a href="#l65.355"></a><span id="l65.355">     onModifyItem: function(aNewItem, aOldItem) { return this.calMgr.notifyCalendarObservers(&quot;onModifyItem&quot;, arguments); },</span>
<a href="#l65.356"></a><span id="l65.356" class="difflineat">@@ -831,17 +825,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.357"></a><span id="l65.357">                 if (!aValue &amp;&amp; aCalendar.canRefresh) {</span>
<a href="#l65.358"></a><span id="l65.358">                     aCalendar.refresh();</span>
<a href="#l65.359"></a><span id="l65.359">                 }</span>
<a href="#l65.360"></a><span id="l65.360">                 break;</span>
<a href="#l65.361"></a><span id="l65.361">         }</span>
<a href="#l65.362"></a><span id="l65.362">     },</span>
<a href="#l65.363"></a><span id="l65.363"> </span>
<a href="#l65.364"></a><span id="l65.364">     changeCalendarCache: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l65.365"></a><span id="l65.365" class="difflineminus">-        const cICM = Components.interfaces.calICalendarManager;</span>
<a href="#l65.366"></a><span id="l65.366" class="difflineplus">+        const cICM = Ci.calICalendarManager;</span>
<a href="#l65.367"></a><span id="l65.367">         aOldValue = aOldValue || false;</span>
<a href="#l65.368"></a><span id="l65.368">         aValue = aValue || false;</span>
<a href="#l65.369"></a><span id="l65.369"> </span>
<a href="#l65.370"></a><span id="l65.370">         // hack for bug 1182264 to deal with calendars, which have set cache.enabled, but in fact do</span>
<a href="#l65.371"></a><span id="l65.371">         // not support caching (like storage calendars) - this also prevents enabling cache again</span>
<a href="#l65.372"></a><span id="l65.372">         if (aCalendar.getProperty(&quot;cache.supported&quot;) === false) {</span>
<a href="#l65.373"></a><span id="l65.373">             if (aCalendar.getProperty(&quot;cache.enabled&quot;) === true) {</span>
<a href="#l65.374"></a><span id="l65.374">                 aCalendar.deleteProperty(&quot;cache.enabled&quot;);</span>
<a href="#l65.375"></a><span id="l65.375" class="difflineat">@@ -898,18 +892,18 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.376"></a><span id="l65.376">     },</span>
<a href="#l65.377"></a><span id="l65.377"> </span>
<a href="#l65.378"></a><span id="l65.378">     onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l65.379"></a><span id="l65.379">         this.onPropertyChanged(aCalendar, aName, false, true);</span>
<a href="#l65.380"></a><span id="l65.380">     },</span>
<a href="#l65.381"></a><span id="l65.381"> </span>
<a href="#l65.382"></a><span id="l65.382">     // Error announcer specific functions</span>
<a href="#l65.383"></a><span id="l65.383">     announceError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l65.384"></a><span id="l65.384" class="difflineminus">-        let paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l65.385"></a><span id="l65.385" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l65.386"></a><span id="l65.386" class="difflineplus">+        let paramBlock = Cc[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l65.387"></a><span id="l65.387" class="difflineplus">+                           .createInstance(Ci.nsIDialogParamBlock);</span>
<a href="#l65.388"></a><span id="l65.388">         let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l65.389"></a><span id="l65.389">         let errMsg;</span>
<a href="#l65.390"></a><span id="l65.390">         paramBlock.SetNumberStrings(3);</span>
<a href="#l65.391"></a><span id="l65.391">         if (!this.storedReadOnly &amp;&amp; this.calendar.readOnly) {</span>
<a href="#l65.392"></a><span id="l65.392">             // Major errors change the calendar to readOnly</span>
<a href="#l65.393"></a><span id="l65.393">             errMsg = props.formatStringFromName(&quot;readOnlyMode&quot;, [this.calendar.name], 1);</span>
<a href="#l65.394"></a><span id="l65.394">         } else if (!this.storedReadOnly &amp;&amp; !this.calendar.readOnly) {</span>
<a href="#l65.395"></a><span id="l65.395">             // Minor errors don't, but still tell the user something went wrong</span>
<a href="#l65.396"></a><span id="l65.396" class="difflineat">@@ -917,17 +911,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.397"></a><span id="l65.397">         } else {</span>
<a href="#l65.398"></a><span id="l65.398">             // The calendar was already in readOnly mode, but still tell the user</span>
<a href="#l65.399"></a><span id="l65.399">             errMsg = props.formatStringFromName(&quot;stillReadOnlyError&quot;, [this.calendar.name], 1);</span>
<a href="#l65.400"></a><span id="l65.400">         }</span>
<a href="#l65.401"></a><span id="l65.401"> </span>
<a href="#l65.402"></a><span id="l65.402">         // When possible, change the error number into its name, to</span>
<a href="#l65.403"></a><span id="l65.403">         // make it slightly more readable.</span>
<a href="#l65.404"></a><span id="l65.404">         let errCode = &quot;0x&quot; + aErrNo.toString(16);</span>
<a href="#l65.405"></a><span id="l65.405" class="difflineminus">-        const calIErrors = Components.interfaces.calIErrors;</span>
<a href="#l65.406"></a><span id="l65.406" class="difflineplus">+        const calIErrors = Ci.calIErrors;</span>
<a href="#l65.407"></a><span id="l65.407">         // Check if it is worth enumerating all the error codes.</span>
<a href="#l65.408"></a><span id="l65.408">         if (aErrNo &amp; calIErrors.ERROR_BASE) {</span>
<a href="#l65.409"></a><span id="l65.409">             for (let err in calIErrors) {</span>
<a href="#l65.410"></a><span id="l65.410">                 if (calIErrors[err] == aErrNo) {</span>
<a href="#l65.411"></a><span id="l65.411">                     errCode = err;</span>
<a href="#l65.412"></a><span id="l65.412">                 }</span>
<a href="#l65.413"></a><span id="l65.413">             }</span>
<a href="#l65.414"></a><span id="l65.414">         }</span>
<a href="#l65.415"></a><span id="l65.415" class="difflineat">@@ -959,17 +953,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.416"></a><span id="l65.416">         this.storedReadOnly = this.calendar.readOnly;</span>
<a href="#l65.417"></a><span id="l65.417">         let errorCode = cal.l10n.getCalString(&quot;errorCode&quot;, [errCode]);</span>
<a href="#l65.418"></a><span id="l65.418">         let errorDescription = cal.l10n.getCalString(&quot;errorDescription&quot;, [message]);</span>
<a href="#l65.419"></a><span id="l65.419">         let summary = errMsg + &quot; &quot; + errorCode + &quot;. &quot; + errorDescription;</span>
<a href="#l65.420"></a><span id="l65.420"> </span>
<a href="#l65.421"></a><span id="l65.421">         // Log warnings in error console.</span>
<a href="#l65.422"></a><span id="l65.422">         // Report serious errors in both error console and in prompt window.</span>
<a href="#l65.423"></a><span id="l65.423">         if (aErrNo == calIErrors.MODIFICATION_FAILED) {</span>
<a href="#l65.424"></a><span id="l65.424" class="difflineminus">-            Components.utils.reportError(summary);</span>
<a href="#l65.425"></a><span id="l65.425" class="difflineplus">+            Cu.reportError(summary);</span>
<a href="#l65.426"></a><span id="l65.426">             this.announceParamBlock(paramBlock);</span>
<a href="#l65.427"></a><span id="l65.427">         } else {</span>
<a href="#l65.428"></a><span id="l65.428">             cal.WARN(summary);</span>
<a href="#l65.429"></a><span id="l65.429">         }</span>
<a href="#l65.430"></a><span id="l65.430">     },</span>
<a href="#l65.431"></a><span id="l65.431"> </span>
<a href="#l65.432"></a><span id="l65.432">     announceParamBlock: function(paramBlock) {</span>
<a href="#l65.433"></a><span id="l65.433">         function awaitLoad(event) {</span>
<a href="#l65.434"></a><span id="l65.434" class="difflineat">@@ -980,17 +974,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.435"></a><span id="l65.435">             // remove paramBlock and unload listener.</span>
<a href="#l65.436"></a><span id="l65.436">             try {</span>
<a href="#l65.437"></a><span id="l65.437">                 // remove the message that has been shown from</span>
<a href="#l65.438"></a><span id="l65.438">                 // the list of all announced messages.</span>
<a href="#l65.439"></a><span id="l65.439">                 this.announcedMessages = this.announcedMessages.filter((msg) =&gt; {</span>
<a href="#l65.440"></a><span id="l65.440">                     return !equalMessage(msg, paramBlock);</span>
<a href="#l65.441"></a><span id="l65.441">                 });</span>
<a href="#l65.442"></a><span id="l65.442">             } catch (e) {</span>
<a href="#l65.443"></a><span id="l65.443" class="difflineminus">-                Components.utils.reportError(e);</span>
<a href="#l65.444"></a><span id="l65.444" class="difflineplus">+                Cu.reportError(e);</span>
<a href="#l65.445"></a><span id="l65.445">             }</span>
<a href="#l65.446"></a><span id="l65.446">         };</span>
<a href="#l65.447"></a><span id="l65.447"> </span>
<a href="#l65.448"></a><span id="l65.448">         // silently don't do anything if this message already has been</span>
<a href="#l65.449"></a><span id="l65.449">         // announced without being acknowledged.</span>
<a href="#l65.450"></a><span id="l65.450">         if (this.announcedMessages.some(equalMessage.bind(null, paramBlock))) {</span>
<a href="#l65.451"></a><span id="l65.451">             return;</span>
<a href="#l65.452"></a><span id="l65.452">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -45,53 +45,53 @@ calCalendarSearchListener.prototype = {</span>
<a href="#l66.4"></a><span id="l66.4"> };</span>
<a href="#l66.5"></a><span id="l66.5"> </span>
<a href="#l66.6"></a><span id="l66.6"> function calCalendarSearchService() {</span>
<a href="#l66.7"></a><span id="l66.7">     this.wrappedJSObject = this;</span>
<a href="#l66.8"></a><span id="l66.8">     this.mProviders = new Set();</span>
<a href="#l66.9"></a><span id="l66.9"> }</span>
<a href="#l66.10"></a><span id="l66.10"> var calCalendarSearchServiceClassID = Components.ID(&quot;{f5f743cd-8997-428e-bc1b-644e73f61203}&quot;);</span>
<a href="#l66.11"></a><span id="l66.11"> var calCalendarSearchServiceInterfaces = [</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-    Components.interfaces.calICalendarSearchProvider,</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineminus">-    Components.interfaces.calICalendarSearchService</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineplus">+    Ci.calICalendarSearchProvider,</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineplus">+    Ci.calICalendarSearchService</span>
<a href="#l66.16"></a><span id="l66.16"> ];</span>
<a href="#l66.17"></a><span id="l66.17"> calCalendarSearchService.prototype = {</span>
<a href="#l66.18"></a><span id="l66.18">     mProviders: null,</span>
<a href="#l66.19"></a><span id="l66.19"> </span>
<a href="#l66.20"></a><span id="l66.20">     classID: calCalendarSearchServiceClassID,</span>
<a href="#l66.21"></a><span id="l66.21">     QueryInterface: cal.generateQI(calCalendarSearchServiceInterfaces),</span>
<a href="#l66.22"></a><span id="l66.22">     classInfo: cal.generateCI({</span>
<a href="#l66.23"></a><span id="l66.23">         classID: calCalendarSearchServiceClassID,</span>
<a href="#l66.24"></a><span id="l66.24">         contractID: &quot;@mozilla.org/calendar/calendarsearch-service;1&quot;,</span>
<a href="#l66.25"></a><span id="l66.25">         classDescription: &quot;Calendar Search Service&quot;,</span>
<a href="#l66.26"></a><span id="l66.26">         interfaces: calCalendarSearchServiceInterfaces,</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineminus">-        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+        flags: Ci.nsIClassInfo.SINGLETON</span>
<a href="#l66.29"></a><span id="l66.29">     }),</span>
<a href="#l66.30"></a><span id="l66.30"> </span>
<a href="#l66.31"></a><span id="l66.31">     // calICalendarSearchProvider:</span>
<a href="#l66.32"></a><span id="l66.32">     searchForCalendars: function(aString, aHints, aMaxResults, aListener) {</span>
<a href="#l66.33"></a><span id="l66.33">         let groupListener = new calCalendarSearchListener(this.mProviders.size, aListener);</span>
<a href="#l66.34"></a><span id="l66.34">         for (let provider of this.mProviders.values()) {</span>
<a href="#l66.35"></a><span id="l66.35">             try {</span>
<a href="#l66.36"></a><span id="l66.36">                 groupListener.opGroup.add(provider.searchForCalendars(aString,</span>
<a href="#l66.37"></a><span id="l66.37">                                                                       aHints,</span>
<a href="#l66.38"></a><span id="l66.38">                                                                       aMaxResults,</span>
<a href="#l66.39"></a><span id="l66.39">                                                                       groupListener));</span>
<a href="#l66.40"></a><span id="l66.40">             } catch (exc) {</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineminus">-                Components.utils.reportError(exc);</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineplus">+                Cu.reportError(exc);</span>
<a href="#l66.43"></a><span id="l66.43">                 groupListener.onResult(null, []); // dummy to adopt mNumOperations</span>
<a href="#l66.44"></a><span id="l66.44">             }</span>
<a href="#l66.45"></a><span id="l66.45">         }</span>
<a href="#l66.46"></a><span id="l66.46">         return groupListener.opGroup;</span>
<a href="#l66.47"></a><span id="l66.47">     },</span>
<a href="#l66.48"></a><span id="l66.48"> </span>
<a href="#l66.49"></a><span id="l66.49">     // calICalendarSearchService:</span>
<a href="#l66.50"></a><span id="l66.50">     getProviders: function(out_aCount) {</span>
<a href="#l66.51"></a><span id="l66.51">         out_aCount.value = this.mProviders.size;</span>
<a href="#l66.52"></a><span id="l66.52">         return [...this.mProviders];</span>
<a href="#l66.53"></a><span id="l66.53">     },</span>
<a href="#l66.54"></a><span id="l66.54">     addProvider: function(aProvider) {</span>
<a href="#l66.55"></a><span id="l66.55" class="difflineminus">-        this.mProviders.add(aProvider.QueryInterface(Components.interfaces.calICalendarSearchProvider));</span>
<a href="#l66.56"></a><span id="l66.56" class="difflineplus">+        this.mProviders.add(aProvider.QueryInterface(Ci.calICalendarSearchProvider));</span>
<a href="#l66.57"></a><span id="l66.57">     },</span>
<a href="#l66.58"></a><span id="l66.58">     removeProvider: function(aProvider) {</span>
<a href="#l66.59"></a><span id="l66.59" class="difflineminus">-        this.mProviders.delete(aProvider.QueryInterface(Components.interfaces.calICalendarSearchProvider));</span>
<a href="#l66.60"></a><span id="l66.60" class="difflineplus">+        this.mProviders.delete(aProvider.QueryInterface(Ci.calICalendarSearchProvider));</span>
<a href="#l66.61"></a><span id="l66.61">     }</span>
<a href="#l66.62"></a><span id="l66.62"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -22,18 +22,18 @@ calDefaultACLManager.prototype = {</span>
<a href="#l67.4"></a><span id="l67.4">         if (!(calUri in this.mCalendarEntries)) {</span>
<a href="#l67.5"></a><span id="l67.5">             this.mCalendarEntries[calUri] = new calDefaultCalendarACLEntry(this, aCalendar);</span>
<a href="#l67.6"></a><span id="l67.6">         }</span>
<a href="#l67.7"></a><span id="l67.7"> </span>
<a href="#l67.8"></a><span id="l67.8">         return this.mCalendarEntries[calUri];</span>
<a href="#l67.9"></a><span id="l67.9">     },</span>
<a href="#l67.10"></a><span id="l67.10">     getCalendarEntry: function(aCalendar, aListener) {</span>
<a href="#l67.11"></a><span id="l67.11">         let entry = this._getCalendarEntryCached(aCalendar);</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-        aListener.onOperationComplete(aCalendar, Components.results.NS_OK,</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineminus">-                                      Components.interfaces.calIOperationListener.GET,</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+        aListener.onOperationComplete(aCalendar, Cr.NS_OK,</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineplus">+                                      Ci.calIOperationListener.GET,</span>
<a href="#l67.16"></a><span id="l67.16">                                       null,</span>
<a href="#l67.17"></a><span id="l67.17">                                       entry);</span>
<a href="#l67.18"></a><span id="l67.18">     },</span>
<a href="#l67.19"></a><span id="l67.19">     getItemEntry: function(aItem) {</span>
<a href="#l67.20"></a><span id="l67.20">         let calEntry = this._getCalendarEntryCached(aItem.calendar);</span>
<a href="#l67.21"></a><span id="l67.21">         return new calDefaultItemACLEntry(calEntry);</span>
<a href="#l67.22"></a><span id="l67.22">     },</span>
<a href="#l67.23"></a><span id="l67.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/calendar/base/src/calDeletedItems.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/calendar/base/src/calDeletedItems.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -20,30 +20,30 @@ function calDeletedItems() {</span>
<a href="#l68.4"></a><span id="l68.4">         handleResult: function() {},</span>
<a href="#l68.5"></a><span id="l68.5">         handleError: function() {},</span>
<a href="#l68.6"></a><span id="l68.6">         handleCompletion: function() {},</span>
<a href="#l68.7"></a><span id="l68.7">     };</span>
<a href="#l68.8"></a><span id="l68.8"> }</span>
<a href="#l68.9"></a><span id="l68.9"> </span>
<a href="#l68.10"></a><span id="l68.10"> var calDeletedItemsClassID = Components.ID(&quot;{8e6799af-e7e9-4e6c-9a82-a2413e86d8c3}&quot;);</span>
<a href="#l68.11"></a><span id="l68.11"> var calDeletedItemsInterfaces = [</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-    Components.interfaces.calIDeletedItems,</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineminus">-    Components.interfaces.nsIObserver,</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineminus">-    Components.interfaces.calIObserver</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineplus">+    Ci.calIDeletedItems,</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+    Ci.nsIObserver,</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineplus">+    Ci.calIObserver</span>
<a href="#l68.18"></a><span id="l68.18"> ];</span>
<a href="#l68.19"></a><span id="l68.19"> calDeletedItems.prototype = {</span>
<a href="#l68.20"></a><span id="l68.20"> </span>
<a href="#l68.21"></a><span id="l68.21">     classID: calDeletedItemsClassID,</span>
<a href="#l68.22"></a><span id="l68.22">     QueryInterface: cal.generateQI(calDeletedItemsInterfaces),</span>
<a href="#l68.23"></a><span id="l68.23">     classInfo: cal.generateCI({</span>
<a href="#l68.24"></a><span id="l68.24">         classID: calDeletedItemsClassID,</span>
<a href="#l68.25"></a><span id="l68.25">         contractID: &quot;@mozilla.org/calendar/deleted-items-manager;1&quot;,</span>
<a href="#l68.26"></a><span id="l68.26">         classDescription: &quot;Database containing information about deleted items&quot;,</span>
<a href="#l68.27"></a><span id="l68.27">         interfaces: calDeletedItemsInterfaces,</span>
<a href="#l68.28"></a><span id="l68.28" class="difflineminus">-        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l68.29"></a><span id="l68.29" class="difflineplus">+        flags: Ci.nsIClassInfo.SINGLETON</span>
<a href="#l68.30"></a><span id="l68.30">     }),</span>
<a href="#l68.31"></a><span id="l68.31"> </span>
<a href="#l68.32"></a><span id="l68.32">     DB_SCHEMA_VERSION: 1,</span>
<a href="#l68.33"></a><span id="l68.33">     STALE_TIME: 30 * 24 * 60 * 60 / 1000, /* 30 days */</span>
<a href="#l68.34"></a><span id="l68.34"> </span>
<a href="#l68.35"></a><span id="l68.35">     // To make the tests more failsafe, we have an internal notifier function.</span>
<a href="#l68.36"></a><span id="l68.36">     // As the deleted items store is just meant to be a hint, this should not</span>
<a href="#l68.37"></a><span id="l68.37">     // be used in real code.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/calendar/base/src/calEvent.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/calendar/base/src/calEvent.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -13,19 +13,19 @@ function calEvent() {</span>
<a href="#l69.4"></a><span id="l69.4">     this.eventPromotedProps = {</span>
<a href="#l69.5"></a><span id="l69.5">         DTSTART: true,</span>
<a href="#l69.6"></a><span id="l69.6">         DTEND: true,</span>
<a href="#l69.7"></a><span id="l69.7">         __proto__: this.itemBasePromotedProps</span>
<a href="#l69.8"></a><span id="l69.8">     };</span>
<a href="#l69.9"></a><span id="l69.9"> }</span>
<a href="#l69.10"></a><span id="l69.10"> var calEventClassID = Components.ID(&quot;{974339d5-ab86-4491-aaaf-2b2ca177c12b}&quot;);</span>
<a href="#l69.11"></a><span id="l69.11"> var calEventInterfaces = [</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-    Components.interfaces.calIItemBase,</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineminus">-    Components.interfaces.calIEvent,</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-    Components.interfaces.calIInternalShallowCopy</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+    Ci.calIItemBase,</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineplus">+    Ci.calIEvent,</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineplus">+    Ci.calIInternalShallowCopy</span>
<a href="#l69.18"></a><span id="l69.18"> ];</span>
<a href="#l69.19"></a><span id="l69.19"> calEvent.prototype = {</span>
<a href="#l69.20"></a><span id="l69.20">     __proto__: calItemBase.prototype,</span>
<a href="#l69.21"></a><span id="l69.21"> </span>
<a href="#l69.22"></a><span id="l69.22">     classID: calEventClassID,</span>
<a href="#l69.23"></a><span id="l69.23">     QueryInterface: cal.generateQI(calEventInterfaces),</span>
<a href="#l69.24"></a><span id="l69.24">     classInfo: cal.generateCI({</span>
<a href="#l69.25"></a><span id="l69.25">         classID: calEventClassID,</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineat">@@ -102,17 +102,17 @@ calEvent.prototype = {</span>
<a href="#l69.27"></a><span id="l69.27">                     let icalprop = icssvc.createIcalProperty(name);</span>
<a href="#l69.28"></a><span id="l69.28">                     icalprop.value = value;</span>
<a href="#l69.29"></a><span id="l69.29">                     let propBucket = this.mPropertyParams[name];</span>
<a href="#l69.30"></a><span id="l69.30">                     if (propBucket) {</span>
<a href="#l69.31"></a><span id="l69.31">                         for (let paramName in propBucket) {</span>
<a href="#l69.32"></a><span id="l69.32">                             try {</span>
<a href="#l69.33"></a><span id="l69.33">                                 icalprop.setParameter(paramName, propBucket[paramName]);</span>
<a href="#l69.34"></a><span id="l69.34">                             } catch (e) {</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineminus">-                                if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineplus">+                                if (e.result == Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l69.37"></a><span id="l69.37">                                     // Illegal values should be ignored, but we could log them if</span>
<a href="#l69.38"></a><span id="l69.38">                                     // the user has enabled logging.</span>
<a href="#l69.39"></a><span id="l69.39">                                     cal.LOG(&quot;Warning: Invalid event parameter value &quot; + paramName + &quot;=&quot; + propBucket[paramName]);</span>
<a href="#l69.40"></a><span id="l69.40">                                 } else {</span>
<a href="#l69.41"></a><span id="l69.41">                                     throw e;</span>
<a href="#l69.42"></a><span id="l69.42">                                 }</span>
<a href="#l69.43"></a><span id="l69.43">                             }</span>
<a href="#l69.44"></a><span id="l69.44">                         }</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineat">@@ -128,17 +128,17 @@ calEvent.prototype = {</span>
<a href="#l69.46"></a><span id="l69.46"> </span>
<a href="#l69.47"></a><span id="l69.47">     eventPromotedProps: null,</span>
<a href="#l69.48"></a><span id="l69.48"> </span>
<a href="#l69.49"></a><span id="l69.49">     set icalComponent(event) {</span>
<a href="#l69.50"></a><span id="l69.50">         this.modify();</span>
<a href="#l69.51"></a><span id="l69.51">         if (event.componentType != &quot;VEVENT&quot;) {</span>
<a href="#l69.52"></a><span id="l69.52">             event = event.getFirstSubcomponent(&quot;VEVENT&quot;);</span>
<a href="#l69.53"></a><span id="l69.53">             if (!event) {</span>
<a href="#l69.54"></a><span id="l69.54" class="difflineminus">-                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l69.55"></a><span id="l69.55" class="difflineplus">+                throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l69.56"></a><span id="l69.56">             }</span>
<a href="#l69.57"></a><span id="l69.57">         }</span>
<a href="#l69.58"></a><span id="l69.58"> </span>
<a href="#l69.59"></a><span id="l69.59">         this.mEndDate = undefined;</span>
<a href="#l69.60"></a><span id="l69.60">         this.setItemBaseFromICS(event);</span>
<a href="#l69.61"></a><span id="l69.61">         this.mapPropsFromICS(event, this.icsEventPropMap);</span>
<a href="#l69.62"></a><span id="l69.62"> </span>
<a href="#l69.63"></a><span id="l69.63">         this.importUnpromotedProperties(event, this.eventPromotedProps);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/calendar/base/src/calFreeBusyService.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/calendar/base/src/calFreeBusyService.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -33,17 +33,17 @@ calFreeBusyListener.prototype = {</span>
<a href="#l70.4"></a><span id="l70.4">     onResult: function(aOperation, aResult) {</span>
<a href="#l70.5"></a><span id="l70.5">         if (this.mFinalListener) {</span>
<a href="#l70.6"></a><span id="l70.6">             if (!aOperation || !aOperation.isPending) {</span>
<a href="#l70.7"></a><span id="l70.7">                 --this.mNumOperations;</span>
<a href="#l70.8"></a><span id="l70.8">                 if (this.mNumOperations == 0) {</span>
<a href="#l70.9"></a><span id="l70.9">                     this.opGroup.notifyCompleted();</span>
<a href="#l70.10"></a><span id="l70.10">                 }</span>
<a href="#l70.11"></a><span id="l70.11">             }</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-            let opStatus = aOperation ? aOperation.status : Components.results.NS_OK;</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+            let opStatus = aOperation ? aOperation.status : Cr.NS_OK;</span>
<a href="#l70.14"></a><span id="l70.14">             if (Components.isSuccessCode(opStatus) &amp;&amp;</span>
<a href="#l70.15"></a><span id="l70.15">                 aResult &amp;&amp; Array.isArray(aResult)) {</span>
<a href="#l70.16"></a><span id="l70.16">                 this.notifyResult(aResult);</span>
<a href="#l70.17"></a><span id="l70.17">             } else {</span>
<a href="#l70.18"></a><span id="l70.18">                 this.notifyResult([]);</span>
<a href="#l70.19"></a><span id="l70.19">             }</span>
<a href="#l70.20"></a><span id="l70.20">         }</span>
<a href="#l70.21"></a><span id="l70.21">     }</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineat">@@ -69,14 +69,14 @@ calFreeBusyService.prototype = {</span>
<a href="#l70.23"></a><span id="l70.23">                                                           groupListener);</span>
<a href="#l70.24"></a><span id="l70.24">             groupListener.opGroup.add(operation);</span>
<a href="#l70.25"></a><span id="l70.25">         }</span>
<a href="#l70.26"></a><span id="l70.26">         return groupListener.opGroup;</span>
<a href="#l70.27"></a><span id="l70.27">     },</span>
<a href="#l70.28"></a><span id="l70.28"> </span>
<a href="#l70.29"></a><span id="l70.29">     // calIFreeBusyService:</span>
<a href="#l70.30"></a><span id="l70.30">     addProvider: function(aProvider) {</span>
<a href="#l70.31"></a><span id="l70.31" class="difflineminus">-        this.mProviders.add(aProvider.QueryInterface(Components.interfaces.calIFreeBusyProvider));</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineplus">+        this.mProviders.add(aProvider.QueryInterface(Ci.calIFreeBusyProvider));</span>
<a href="#l70.33"></a><span id="l70.33">     },</span>
<a href="#l70.34"></a><span id="l70.34">     removeProvider: function(aProvider) {</span>
<a href="#l70.35"></a><span id="l70.35" class="difflineminus">-        this.mProviders.delete(aProvider.QueryInterface(Components.interfaces.calIFreeBusyProvider));</span>
<a href="#l70.36"></a><span id="l70.36" class="difflineplus">+        this.mProviders.delete(aProvider.QueryInterface(Ci.calIFreeBusyProvider));</span>
<a href="#l70.37"></a><span id="l70.37">     }</span>
<a href="#l70.38"></a><span id="l70.38"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -70,49 +70,49 @@ calIcsParser.prototype = {</span>
<a href="#l71.4"></a><span id="l71.4">                     parent.setProperty(&quot;DTSTART&quot;, item.recurrenceId);</span>
<a href="#l71.5"></a><span id="l71.5">                     parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;); // this tag might be useful in the future</span>
<a href="#l71.6"></a><span id="l71.6">                     parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l71.7"></a><span id="l71.7">                     fakedParents[item.id] = true;</span>
<a href="#l71.8"></a><span id="l71.8">                     state.uid2parent[item.id] = parent;</span>
<a href="#l71.9"></a><span id="l71.9">                     state.items.push(parent);</span>
<a href="#l71.10"></a><span id="l71.10">                 }</span>
<a href="#l71.11"></a><span id="l71.11">                 if (item.id in fakedParents) {</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-                    let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineminus">-                                          .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+                    let rdate = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l71.15"></a><span id="l71.15" class="difflineplus">+                                  .createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l71.16"></a><span id="l71.16">                     rdate.date = item.recurrenceId;</span>
<a href="#l71.17"></a><span id="l71.17">                     parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l71.18"></a><span id="l71.18">                     // we'll keep the parentless-API until we switch over using itip-process for import (e.g. in dnd code)</span>
<a href="#l71.19"></a><span id="l71.19">                     self.mParentlessItems.push(item);</span>
<a href="#l71.20"></a><span id="l71.20">                 }</span>
<a href="#l71.21"></a><span id="l71.21"> </span>
<a href="#l71.22"></a><span id="l71.22">                 parent.recurrenceInfo.modifyException(item, true);</span>
<a href="#l71.23"></a><span id="l71.23">             }</span>
<a href="#l71.24"></a><span id="l71.24"> </span>
<a href="#l71.25"></a><span id="l71.25">             if (Object.keys(state.tzErrors).length &gt; 0) {</span>
<a href="#l71.26"></a><span id="l71.26">                 // Use an alert rather than a prompt because problems may appear in</span>
<a href="#l71.27"></a><span id="l71.27">                 // remote subscribed calendars the user cannot change.</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineminus">-                if (Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]) {</span>
<a href="#l71.29"></a><span id="l71.29" class="difflineminus">-                    let notifier = Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineminus">-                                             .getService(Components.interfaces.nsIAlertsService);</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineplus">+                if (Cc[&quot;@mozilla.org/alerts-service;1&quot;]) {</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+                    let notifier = Cc[&quot;@mozilla.org/alerts-service;1&quot;]</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineplus">+                                     .getService(Ci.nsIAlertsService);</span>
<a href="#l71.34"></a><span id="l71.34">                     let title = cal.l10n.getCalString(&quot;TimezoneErrorsAlertTitle&quot;);</span>
<a href="#l71.35"></a><span id="l71.35">                     let text = cal.l10n.getCalString(&quot;TimezoneErrorsSeeConsole&quot;);</span>
<a href="#l71.36"></a><span id="l71.36">                     try {</span>
<a href="#l71.37"></a><span id="l71.37">                         notifier.showAlertNotification(&quot;&quot;, title, text, false, null, null, title);</span>
<a href="#l71.38"></a><span id="l71.38">                     } catch (e) {</span>
<a href="#l71.39"></a><span id="l71.39">                         // The notifier may not be available, e.g. on xpcshell tests</span>
<a href="#l71.40"></a><span id="l71.40">                     }</span>
<a href="#l71.41"></a><span id="l71.41">                 }</span>
<a href="#l71.42"></a><span id="l71.42">             }</span>
<a href="#l71.43"></a><span id="l71.43"> </span>
<a href="#l71.44"></a><span id="l71.44">             // We are done, push the items to the parser and notify the listener</span>
<a href="#l71.45"></a><span id="l71.45">             self.mItems = self.mItems.concat(state.items);</span>
<a href="#l71.46"></a><span id="l71.46">             self.mComponents = self.mComponents.concat(state.extraComponents);</span>
<a href="#l71.47"></a><span id="l71.47"> </span>
<a href="#l71.48"></a><span id="l71.48">             if (aAsyncParsing) {</span>
<a href="#l71.49"></a><span id="l71.49" class="difflineminus">-                aAsyncParsing.onParsingComplete(Components.results.NS_OK, self);</span>
<a href="#l71.50"></a><span id="l71.50" class="difflineplus">+                aAsyncParsing.onParsingComplete(Cr.NS_OK, self);</span>
<a href="#l71.51"></a><span id="l71.51">             }</span>
<a href="#l71.52"></a><span id="l71.52">         });</span>
<a href="#l71.53"></a><span id="l71.53">     },</span>
<a href="#l71.54"></a><span id="l71.54"> </span>
<a href="#l71.55"></a><span id="l71.55">     parseString: function(aICSString, aTzProvider, aAsyncParsing) {</span>
<a href="#l71.56"></a><span id="l71.56">         if (aAsyncParsing) {</span>
<a href="#l71.57"></a><span id="l71.57">             let self = this;</span>
<a href="#l71.58"></a><span id="l71.58"> </span>
<a href="#l71.59"></a><span id="l71.59" class="difflineat">@@ -289,17 +289,17 @@ parserState.prototype = {</span>
<a href="#l71.60"></a><span id="l71.60">                 self.checkCompletion();</span>
<a href="#l71.61"></a><span id="l71.61">             }</span>
<a href="#l71.62"></a><span id="l71.62">         };</span>
<a href="#l71.63"></a><span id="l71.63"> </span>
<a href="#l71.64"></a><span id="l71.64">         this.threadCount++;</span>
<a href="#l71.65"></a><span id="l71.65">         if (this.listener) {</span>
<a href="#l71.66"></a><span id="l71.66">             // If we have a listener, we are doing this asynchronously. Go ahead</span>
<a href="#l71.67"></a><span id="l71.67">             // and use the thread manager to dispatch the above runner</span>
<a href="#l71.68"></a><span id="l71.68" class="difflineminus">-            Services.tm.currentThread.dispatch(runner, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l71.69"></a><span id="l71.69" class="difflineplus">+            Services.tm.currentThread.dispatch(runner, Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l71.70"></a><span id="l71.70">         } else {</span>
<a href="#l71.71"></a><span id="l71.71">             // No listener means synchonous. Just run the runner instead</span>
<a href="#l71.72"></a><span id="l71.72">             runner.run();</span>
<a href="#l71.73"></a><span id="l71.73">         }</span>
<a href="#l71.74"></a><span id="l71.74">     },</span>
<a href="#l71.75"></a><span id="l71.75"> </span>
<a href="#l71.76"></a><span id="l71.76">     /**</span>
<a href="#l71.77"></a><span id="l71.77">      * Checks if the processing of all events has completed. If a join function</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/calendar/base/src/calIcsSerializer.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/calendar/base/src/calIcsSerializer.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -38,18 +38,18 @@ calIcsSerializer.prototype = {</span>
<a href="#l72.4"></a><span id="l72.4">         return calComp.serializeToICSStream();</span>
<a href="#l72.5"></a><span id="l72.5">     },</span>
<a href="#l72.6"></a><span id="l72.6"> </span>
<a href="#l72.7"></a><span id="l72.7">     serializeToStream: function(aStream) {</span>
<a href="#l72.8"></a><span id="l72.8">         let str = this.serializeToString();</span>
<a href="#l72.9"></a><span id="l72.9"> </span>
<a href="#l72.10"></a><span id="l72.10">         // Convert the javascript string to an array of bytes, using the</span>
<a href="#l72.11"></a><span id="l72.11">         // UTF8 encoder</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-        let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+        let convStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineplus">+                           .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l72.16"></a><span id="l72.16">         convStream.init(aStream, &quot;UTF-8&quot;);</span>
<a href="#l72.17"></a><span id="l72.17"> </span>
<a href="#l72.18"></a><span id="l72.18">         convStream.writeString(str);</span>
<a href="#l72.19"></a><span id="l72.19">         convStream.close();</span>
<a href="#l72.20"></a><span id="l72.20">     },</span>
<a href="#l72.21"></a><span id="l72.21"> </span>
<a href="#l72.22"></a><span id="l72.22">     getIcalComponent: function() {</span>
<a href="#l72.23"></a><span id="l72.23">         let calComp = cal.getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -120,17 +120,17 @@ calItemBase.prototype = {</span>
<a href="#l73.4"></a><span id="l73.4">     },</span>
<a href="#l73.5"></a><span id="l73.5"> </span>
<a href="#l73.6"></a><span id="l73.6">     // attribute calIItemBase parentItem;</span>
<a href="#l73.7"></a><span id="l73.7">     get parentItem() {</span>
<a href="#l73.8"></a><span id="l73.8">         return this.mParentItem || this;</span>
<a href="#l73.9"></a><span id="l73.9">     },</span>
<a href="#l73.10"></a><span id="l73.10">     set parentItem(value) {</span>
<a href="#l73.11"></a><span id="l73.11">         if (this.mImmutable) {</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+            throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l73.14"></a><span id="l73.14">         }</span>
<a href="#l73.15"></a><span id="l73.15">         return (this.mParentItem = cal.unwrapInstance(value));</span>
<a href="#l73.16"></a><span id="l73.16">     },</span>
<a href="#l73.17"></a><span id="l73.17"> </span>
<a href="#l73.18"></a><span id="l73.18">     /**</span>
<a href="#l73.19"></a><span id="l73.19">      * Initializes the base item to be an item proxy. Used by inheriting</span>
<a href="#l73.20"></a><span id="l73.20">      * objects createProxy() method.</span>
<a href="#l73.21"></a><span id="l73.21">      *</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineat">@@ -160,17 +160,17 @@ calItemBase.prototype = {</span>
<a href="#l73.23"></a><span id="l73.23"> </span>
<a href="#l73.24"></a><span id="l73.24">     /**</span>
<a href="#l73.25"></a><span id="l73.25">      * This function should be called by all members that modify the item. It</span>
<a href="#l73.26"></a><span id="l73.26">      * checks if the item is immutable and throws accordingly, and sets the</span>
<a href="#l73.27"></a><span id="l73.27">      * mDirty property.</span>
<a href="#l73.28"></a><span id="l73.28">      */</span>
<a href="#l73.29"></a><span id="l73.29">     modify: function() {</span>
<a href="#l73.30"></a><span id="l73.30">         if (this.mImmutable) {</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+            throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l73.33"></a><span id="l73.33">         }</span>
<a href="#l73.34"></a><span id="l73.34">         this.mDirty = true;</span>
<a href="#l73.35"></a><span id="l73.35">     },</span>
<a href="#l73.36"></a><span id="l73.36"> </span>
<a href="#l73.37"></a><span id="l73.37">     /**</span>
<a href="#l73.38"></a><span id="l73.38">      * Makes sure the item is not dirty. If the item is dirty, properties like</span>
<a href="#l73.39"></a><span id="l73.39">      * LAST-MODIFIED and DTSTAMP are set to now.</span>
<a href="#l73.40"></a><span id="l73.40">      */</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineat">@@ -202,17 +202,17 @@ calItemBase.prototype = {</span>
<a href="#l73.42"></a><span id="l73.42">         }</span>
<a href="#l73.43"></a><span id="l73.43">         if (this.mAttendees) {</span>
<a href="#l73.44"></a><span id="l73.44">             for (let att of this.mAttendees) {</span>
<a href="#l73.45"></a><span id="l73.45">                 att.makeImmutable();</span>
<a href="#l73.46"></a><span id="l73.46">             }</span>
<a href="#l73.47"></a><span id="l73.47">         }</span>
<a href="#l73.48"></a><span id="l73.48"> </span>
<a href="#l73.49"></a><span id="l73.49">         for (let propValue of this.mProperties.values()) {</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineminus">-            if (propValue instanceof Components.interfaces.calIDateTime &amp;&amp;</span>
<a href="#l73.51"></a><span id="l73.51" class="difflineplus">+            if (propValue instanceof Ci.calIDateTime &amp;&amp;</span>
<a href="#l73.52"></a><span id="l73.52">                 propValue.isMutable) {</span>
<a href="#l73.53"></a><span id="l73.53">                 propValue.makeImmutable();</span>
<a href="#l73.54"></a><span id="l73.54">             }</span>
<a href="#l73.55"></a><span id="l73.55">         }</span>
<a href="#l73.56"></a><span id="l73.56"> </span>
<a href="#l73.57"></a><span id="l73.57">         if (this.mAlarms) {</span>
<a href="#l73.58"></a><span id="l73.58">             for (let alarm of this.mAlarms) {</span>
<a href="#l73.59"></a><span id="l73.59">                 alarm.makeImmutable();</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineat">@@ -267,17 +267,17 @@ calItemBase.prototype = {</span>
<a href="#l73.61"></a><span id="l73.61"> </span>
<a href="#l73.62"></a><span id="l73.62">         cloned.mAttendees = [];</span>
<a href="#l73.63"></a><span id="l73.63">         for (let att of this.getAttendees({})) {</span>
<a href="#l73.64"></a><span id="l73.64">             cloned.mAttendees.push(att.clone());</span>
<a href="#l73.65"></a><span id="l73.65">         }</span>
<a href="#l73.66"></a><span id="l73.66"> </span>
<a href="#l73.67"></a><span id="l73.67">         cloned.mProperties = new Map();</span>
<a href="#l73.68"></a><span id="l73.68">         for (let [name, value] of this.mProperties.entries()) {</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineminus">-            if (value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineplus">+            if (value instanceof Ci.calIDateTime) {</span>
<a href="#l73.71"></a><span id="l73.71">                 value = value.clone();</span>
<a href="#l73.72"></a><span id="l73.72">             }</span>
<a href="#l73.73"></a><span id="l73.73"> </span>
<a href="#l73.74"></a><span id="l73.74">             cloned.mProperties.set(name, value);</span>
<a href="#l73.75"></a><span id="l73.75"> </span>
<a href="#l73.76"></a><span id="l73.76">             let propBucket = this.mPropertyParams[name];</span>
<a href="#l73.77"></a><span id="l73.77">             if (propBucket) {</span>
<a href="#l73.78"></a><span id="l73.78">                 let newBucket = {};</span>
<a href="#l73.79"></a><span id="l73.79" class="difflineat">@@ -575,17 +575,17 @@ calItemBase.prototype = {</span>
<a href="#l73.80"></a><span id="l73.80">             return [];</span>
<a href="#l73.81"></a><span id="l73.81">         }</span>
<a href="#l73.82"></a><span id="l73.82">     },</span>
<a href="#l73.83"></a><span id="l73.83"> </span>
<a href="#l73.84"></a><span id="l73.84">     // void removeAttachment(in calIAttachment attachment);</span>
<a href="#l73.85"></a><span id="l73.85">     removeAttachment: function(aAttachment) {</span>
<a href="#l73.86"></a><span id="l73.86">         this.modify();</span>
<a href="#l73.87"></a><span id="l73.87">         for (let attIndex in this.mAttachments) {</span>
<a href="#l73.88"></a><span id="l73.88" class="difflineminus">-            if (cal.data.compareObjects(this.mAttachments[attIndex], aAttachment, Components.interfaces.calIAttachment)) {</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineplus">+            if (cal.data.compareObjects(this.mAttachments[attIndex], aAttachment, Ci.calIAttachment)) {</span>
<a href="#l73.90"></a><span id="l73.90">                 this.modify();</span>
<a href="#l73.91"></a><span id="l73.91">                 this.mAttachments.splice(attIndex, 1);</span>
<a href="#l73.92"></a><span id="l73.92">                 break;</span>
<a href="#l73.93"></a><span id="l73.93">             }</span>
<a href="#l73.94"></a><span id="l73.94">         }</span>
<a href="#l73.95"></a><span id="l73.95">     },</span>
<a href="#l73.96"></a><span id="l73.96"> </span>
<a href="#l73.97"></a><span id="l73.97">     // void addAttachment(in calIAttachment attachment);</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineat">@@ -651,17 +651,17 @@ calItemBase.prototype = {</span>
<a href="#l73.99"></a><span id="l73.99">         if (!this.mCalendar &amp;&amp; (this.parentItem != this)) {</span>
<a href="#l73.100"></a><span id="l73.100">             return this.parentItem.calendar;</span>
<a href="#l73.101"></a><span id="l73.101">         } else {</span>
<a href="#l73.102"></a><span id="l73.102">             return this.mCalendar;</span>
<a href="#l73.103"></a><span id="l73.103">         }</span>
<a href="#l73.104"></a><span id="l73.104">     },</span>
<a href="#l73.105"></a><span id="l73.105">     set calendar(calendar) {</span>
<a href="#l73.106"></a><span id="l73.106">         if (this.mImmutable) {</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineplus">+            throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l73.109"></a><span id="l73.109">         }</span>
<a href="#l73.110"></a><span id="l73.110">         this.mHashId = null; // recompute hashId</span>
<a href="#l73.111"></a><span id="l73.111">         this.mCalendar = calendar;</span>
<a href="#l73.112"></a><span id="l73.112">     },</span>
<a href="#l73.113"></a><span id="l73.113"> </span>
<a href="#l73.114"></a><span id="l73.114">     // attribute calIAttendee organizer;</span>
<a href="#l73.115"></a><span id="l73.115">     get organizer() {</span>
<a href="#l73.116"></a><span id="l73.116">         if (this.mIsProxy &amp;&amp; (this.mOrganizer === undefined)) {</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineat">@@ -694,20 +694,20 @@ calItemBase.prototype = {</span>
<a href="#l73.118"></a><span id="l73.118">     //                    [array, size_is(aCount)] in wstring aCategories);</span>
<a href="#l73.119"></a><span id="l73.119">     setCategories: function(aCount, aCategories) {</span>
<a href="#l73.120"></a><span id="l73.120">         this.modify();</span>
<a href="#l73.121"></a><span id="l73.121">         this.mCategories = aCategories.concat([]);</span>
<a href="#l73.122"></a><span id="l73.122">     },</span>
<a href="#l73.123"></a><span id="l73.123"> </span>
<a href="#l73.124"></a><span id="l73.124">     // attribute AUTF8String icalString;</span>
<a href="#l73.125"></a><span id="l73.125">     get icalString() {</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.128"></a><span id="l73.128">     },</span>
<a href="#l73.129"></a><span id="l73.129">     set icalString(str) {</span>
<a href="#l73.130"></a><span id="l73.130" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.132"></a><span id="l73.132">     },</span>
<a href="#l73.133"></a><span id="l73.133"> </span>
<a href="#l73.134"></a><span id="l73.134">     /**</span>
<a href="#l73.135"></a><span id="l73.135">      * The map of promoted properties is a list of those properties that are</span>
<a href="#l73.136"></a><span id="l73.136">      * represented directly by getters/setters.</span>
<a href="#l73.137"></a><span id="l73.137">      * All of these property names must be in upper case isPropertyPromoted to</span>
<a href="#l73.138"></a><span id="l73.138">      * function correctly. The has/get/set/deleteProperty interfaces</span>
<a href="#l73.139"></a><span id="l73.139">      * are case-insensitive, but these are not.</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineat">@@ -753,17 +753,17 @@ calItemBase.prototype = {</span>
<a href="#l73.141"></a><span id="l73.141">      *</span>
<a href="#l73.142"></a><span id="l73.142">      * @param icalcomp      The calIIcalComponent to read from.</span>
<a href="#l73.143"></a><span id="l73.143">      * @param propmap       The property map to walk through.</span>
<a href="#l73.144"></a><span id="l73.144">      */</span>
<a href="#l73.145"></a><span id="l73.145">     mapPropsFromICS: function(icalcomp, propmap) {</span>
<a href="#l73.146"></a><span id="l73.146">         for (let i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l73.147"></a><span id="l73.147">             let prop = propmap[i];</span>
<a href="#l73.148"></a><span id="l73.148">             let val = icalcomp[prop.ics];</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineminus">-            if (val != null &amp;&amp; val != Components.interfaces.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+            if (val != null &amp;&amp; val != Ci.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l73.151"></a><span id="l73.151">                 this.setProperty(prop.cal, val);</span>
<a href="#l73.152"></a><span id="l73.152">             }</span>
<a href="#l73.153"></a><span id="l73.153">         }</span>
<a href="#l73.154"></a><span id="l73.154">     },</span>
<a href="#l73.155"></a><span id="l73.155"> </span>
<a href="#l73.156"></a><span id="l73.156">     /**</span>
<a href="#l73.157"></a><span id="l73.157">      * Walks through the propmap and sets all properties on the given icalcomp</span>
<a href="#l73.158"></a><span id="l73.158">      * from the properties set on this item.</span>
<a href="#l73.159"></a><span id="l73.159" class="difflineat">@@ -771,17 +771,17 @@ calItemBase.prototype = {</span>
<a href="#l73.160"></a><span id="l73.160">      *</span>
<a href="#l73.161"></a><span id="l73.161">      * @param icalcomp      The calIIcalComponent to write to.</span>
<a href="#l73.162"></a><span id="l73.162">      * @param propmap       The property map to walk through.</span>
<a href="#l73.163"></a><span id="l73.163">      */</span>
<a href="#l73.164"></a><span id="l73.164">     mapPropsToICS: function(icalcomp, propmap) {</span>
<a href="#l73.165"></a><span id="l73.165">         for (let i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l73.166"></a><span id="l73.166">             let prop = propmap[i];</span>
<a href="#l73.167"></a><span id="l73.167">             let val = this.getProperty(prop.cal);</span>
<a href="#l73.168"></a><span id="l73.168" class="difflineminus">-            if (val != null &amp;&amp; val != Components.interfaces.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l73.169"></a><span id="l73.169" class="difflineplus">+            if (val != null &amp;&amp; val != Ci.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l73.170"></a><span id="l73.170">                 icalcomp[prop.ics] = val;</span>
<a href="#l73.171"></a><span id="l73.171">             }</span>
<a href="#l73.172"></a><span id="l73.172">         }</span>
<a href="#l73.173"></a><span id="l73.173">     },</span>
<a href="#l73.174"></a><span id="l73.174"> </span>
<a href="#l73.175"></a><span id="l73.175"> </span>
<a href="#l73.176"></a><span id="l73.176">     /**</span>
<a href="#l73.177"></a><span id="l73.177">      * Reads an ical component and sets up the base item's properties to match</span>
<a href="#l73.178"></a><span id="l73.178" class="difflineat">@@ -908,20 +908,20 @@ calItemBase.prototype = {</span>
<a href="#l73.179"></a><span id="l73.179"> </span>
<a href="#l73.180"></a><span id="l73.180">     // boolean isPropertyPromoted(in AString name);</span>
<a href="#l73.181"></a><span id="l73.181">     isPropertyPromoted: function(name) {</span>
<a href="#l73.182"></a><span id="l73.182">         return this.itemBasePromotedProps[name.toUpperCase()];</span>
<a href="#l73.183"></a><span id="l73.183">     },</span>
<a href="#l73.184"></a><span id="l73.184"> </span>
<a href="#l73.185"></a><span id="l73.185">     // attribute calIIcalComponent icalComponent;</span>
<a href="#l73.186"></a><span id="l73.186">     get icalComponent() {</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.189"></a><span id="l73.189">     },</span>
<a href="#l73.190"></a><span id="l73.190">     set icalComponent(val) {</span>
<a href="#l73.191"></a><span id="l73.191" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.192"></a><span id="l73.192" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.193"></a><span id="l73.193">     },</span>
<a href="#l73.194"></a><span id="l73.194"> </span>
<a href="#l73.195"></a><span id="l73.195">     // attribute PRUint32 generation;</span>
<a href="#l73.196"></a><span id="l73.196">     get generation() {</span>
<a href="#l73.197"></a><span id="l73.197">         let gen = this.getProperty(&quot;X-MOZ-GENERATION&quot;);</span>
<a href="#l73.198"></a><span id="l73.198">         return (gen ? parseInt(gen, 10) : 0);</span>
<a href="#l73.199"></a><span id="l73.199">     },</span>
<a href="#l73.200"></a><span id="l73.200">     set generation(aValue) {</span>
<a href="#l73.201"></a><span id="l73.201" class="difflineat">@@ -981,17 +981,17 @@ calItemBase.prototype = {</span>
<a href="#l73.202"></a><span id="l73.202">             lastAck.value = alarmLastAck.icalString;</span>
<a href="#l73.203"></a><span id="l73.203">             icalcomp.addProperty(lastAck);</span>
<a href="#l73.204"></a><span id="l73.204">         }</span>
<a href="#l73.205"></a><span id="l73.205">     },</span>
<a href="#l73.206"></a><span id="l73.206"> </span>
<a href="#l73.207"></a><span id="l73.207">     // void getAlarms(out PRUint32 count, [array, size_is(count), retval] out calIAlarm aAlarms);</span>
<a href="#l73.208"></a><span id="l73.208">     getAlarms: function(aCount) {</span>
<a href="#l73.209"></a><span id="l73.209">         if (typeof aCount != &quot;object&quot;) {</span>
<a href="#l73.210"></a><span id="l73.210" class="difflineminus">-            throw Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT;</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineplus">+            throw Cr.NS_ERROR_XPC_NEED_OUT_OBJECT;</span>
<a href="#l73.212"></a><span id="l73.212">         }</span>
<a href="#l73.213"></a><span id="l73.213"> </span>
<a href="#l73.214"></a><span id="l73.214">         if (!this.mAlarms &amp;&amp; this.mIsProxy) {</span>
<a href="#l73.215"></a><span id="l73.215">             this.mAlarms = this.mParentItem.getAlarms(aCount);</span>
<a href="#l73.216"></a><span id="l73.216">         }</span>
<a href="#l73.217"></a><span id="l73.217">         if (this.mAlarms) {</span>
<a href="#l73.218"></a><span id="l73.218">             aCount.value = this.mAlarms.length;</span>
<a href="#l73.219"></a><span id="l73.219">             return this.mAlarms.concat([]); // clone</span>
<a href="#l73.220"></a><span id="l73.220" class="difflineat">@@ -1010,31 +1010,31 @@ calItemBase.prototype = {</span>
<a href="#l73.221"></a><span id="l73.221">      *                            errors.</span>
<a href="#l73.222"></a><span id="l73.222">      */</span>
<a href="#l73.223"></a><span id="l73.223">     addAlarm: function(aAlarm, aDoNotValidate) {</span>
<a href="#l73.224"></a><span id="l73.224">         if (!aDoNotValidate) {</span>
<a href="#l73.225"></a><span id="l73.225">             try {</span>
<a href="#l73.226"></a><span id="l73.226">                 // Trigger the icalComponent getter to make sure the alarm is valid.</span>
<a href="#l73.227"></a><span id="l73.227">                 aAlarm.icalComponent; // eslint-disable-line no-unused-expressions</span>
<a href="#l73.228"></a><span id="l73.228">             } catch (e) {</span>
<a href="#l73.229"></a><span id="l73.229" class="difflineminus">-                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l73.230"></a><span id="l73.230" class="difflineplus">+                throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l73.231"></a><span id="l73.231">             }</span>
<a href="#l73.232"></a><span id="l73.232">         }</span>
<a href="#l73.233"></a><span id="l73.233"> </span>
<a href="#l73.234"></a><span id="l73.234">         this.modify();</span>
<a href="#l73.235"></a><span id="l73.235">         this.mAlarms = this.getAlarms({});</span>
<a href="#l73.236"></a><span id="l73.236">         this.mAlarms.push(aAlarm);</span>
<a href="#l73.237"></a><span id="l73.237">     },</span>
<a href="#l73.238"></a><span id="l73.238"> </span>
<a href="#l73.239"></a><span id="l73.239">     // void deleteAlarm(in calIAlarm aAlarm);</span>
<a href="#l73.240"></a><span id="l73.240">     deleteAlarm: function(aAlarm) {</span>
<a href="#l73.241"></a><span id="l73.241">         this.modify();</span>
<a href="#l73.242"></a><span id="l73.242">         this.mAlarms = this.getAlarms({});</span>
<a href="#l73.243"></a><span id="l73.243">         for (let i = 0; i &lt; this.mAlarms.length; i++) {</span>
<a href="#l73.244"></a><span id="l73.244" class="difflineminus">-            if (cal.data.compareObjects(this.mAlarms[i], aAlarm, Components.interfaces.calIAlarm)) {</span>
<a href="#l73.245"></a><span id="l73.245" class="difflineplus">+            if (cal.data.compareObjects(this.mAlarms[i], aAlarm, Ci.calIAlarm)) {</span>
<a href="#l73.246"></a><span id="l73.246">                 this.mAlarms.splice(i, 1);</span>
<a href="#l73.247"></a><span id="l73.247">                 break;</span>
<a href="#l73.248"></a><span id="l73.248">             }</span>
<a href="#l73.249"></a><span id="l73.249">         }</span>
<a href="#l73.250"></a><span id="l73.250">     },</span>
<a href="#l73.251"></a><span id="l73.251"> </span>
<a href="#l73.252"></a><span id="l73.252">     // void clearAlarms();</span>
<a href="#l73.253"></a><span id="l73.253">     clearAlarms: function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/calendar/base/src/calItipItem.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/calendar/base/src/calItipItem.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -39,17 +39,17 @@ calItipItem.prototype = {</span>
<a href="#l74.4"></a><span id="l74.4">     },</span>
<a href="#l74.5"></a><span id="l74.5">     set receivedMethod(aMethod) {</span>
<a href="#l74.6"></a><span id="l74.6">         return (this.mReceivedMethod = aMethod.toUpperCase());</span>
<a href="#l74.7"></a><span id="l74.7">     },</span>
<a href="#l74.8"></a><span id="l74.8"> </span>
<a href="#l74.9"></a><span id="l74.9">     mResponseMethod: &quot;REPLY&quot;,</span>
<a href="#l74.10"></a><span id="l74.10">     get responseMethod() {</span>
<a href="#l74.11"></a><span id="l74.11">         if (!this.mIsInitialized) {</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+            throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l74.14"></a><span id="l74.14">         }</span>
<a href="#l74.15"></a><span id="l74.15">         return this.mResponseMethod;</span>
<a href="#l74.16"></a><span id="l74.16">     },</span>
<a href="#l74.17"></a><span id="l74.17">     set responseMethod(aMethod) {</span>
<a href="#l74.18"></a><span id="l74.18">         return (this.mResponseMethod = aMethod.toUpperCase());</span>
<a href="#l74.19"></a><span id="l74.19">     },</span>
<a href="#l74.20"></a><span id="l74.20"> </span>
<a href="#l74.21"></a><span id="l74.21">     mAutoResponse: null,</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineat">@@ -82,18 +82,17 @@ calItipItem.prototype = {</span>
<a href="#l74.23"></a><span id="l74.23">     },</span>
<a href="#l74.24"></a><span id="l74.24">     set localStatus(aValue) {</span>
<a href="#l74.25"></a><span id="l74.25">         return (this.mLocalStatus = aValue);</span>
<a href="#l74.26"></a><span id="l74.26">     },</span>
<a href="#l74.27"></a><span id="l74.27"> </span>
<a href="#l74.28"></a><span id="l74.28">     mItemList: {},</span>
<a href="#l74.29"></a><span id="l74.29"> </span>
<a href="#l74.30"></a><span id="l74.30">     init: function(aIcalString) {</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l74.34"></a><span id="l74.34">         parser.parseString(aIcalString, null);</span>
<a href="#l74.35"></a><span id="l74.35"> </span>
<a href="#l74.36"></a><span id="l74.36">         // - User specific alarms as well as X-MOZ- properties are irrelevant w.r.t. iTIP messages,</span>
<a href="#l74.37"></a><span id="l74.37">         //   should not be sent out and should not be relevant for incoming messages</span>
<a href="#l74.38"></a><span id="l74.38">         // - faked master items</span>
<a href="#l74.39"></a><span id="l74.39">         // so clean them out:</span>
<a href="#l74.40"></a><span id="l74.40"> </span>
<a href="#l74.41"></a><span id="l74.41">         function cleanItem(item) {</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineat">@@ -179,17 +178,17 @@ calItipItem.prototype = {</span>
<a href="#l74.43"></a><span id="l74.43">     },</span>
<a href="#l74.44"></a><span id="l74.44"> </span>
<a href="#l74.45"></a><span id="l74.45">     /**</span>
<a href="#l74.46"></a><span id="l74.46">      * This returns both the array and the number of items. An easy way to</span>
<a href="#l74.47"></a><span id="l74.47">      * call it is: let itemArray = itipItem.getItemList({ });</span>
<a href="#l74.48"></a><span id="l74.48">      */</span>
<a href="#l74.49"></a><span id="l74.49">     getItemList: function(itemCountRef) {</span>
<a href="#l74.50"></a><span id="l74.50">         if (!this.mIsInitialized) {</span>
<a href="#l74.51"></a><span id="l74.51" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineplus">+            throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l74.53"></a><span id="l74.53">         }</span>
<a href="#l74.54"></a><span id="l74.54">         itemCountRef.value = this.mItemList.length;</span>
<a href="#l74.55"></a><span id="l74.55">         return this.mItemList;</span>
<a href="#l74.56"></a><span id="l74.56">     },</span>
<a href="#l74.57"></a><span id="l74.57"> </span>
<a href="#l74.58"></a><span id="l74.58">     /**</span>
<a href="#l74.59"></a><span id="l74.59">      * Note that this code forces the user to respond to all items in the same</span>
<a href="#l74.60"></a><span id="l74.60">      * way, which is a current limitation of the spec.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/calendar/base/src/calProtocolHandler.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/calendar/base/src/calProtocolHandler.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -15,23 +15,21 @@ function calProtocolHandler(scheme) {</span>
<a href="#l75.4"></a><span id="l75.4">     this.wrappedJSObject = this;</span>
<a href="#l75.5"></a><span id="l75.5"> }</span>
<a href="#l75.6"></a><span id="l75.6"> </span>
<a href="#l75.7"></a><span id="l75.7"> calProtocolHandler.prototype = {</span>
<a href="#l75.8"></a><span id="l75.8">     get defaultPort() { return this.mHttpProtocol.defaultPort; },</span>
<a href="#l75.9"></a><span id="l75.9">     get protocolFlags() { return this.mHttpProtocol.protocolFlags; },</span>
<a href="#l75.10"></a><span id="l75.10"> </span>
<a href="#l75.11"></a><span id="l75.11">     newURI: function(aSpec, anOriginalCharset, aBaseURI) {</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-        return Components.classes[&quot;@mozilla.org/network/standard-url-mutator;1&quot;]</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineminus">-                         .createInstance(Components.interfaces.nsIStandardURLMutator)</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineminus">-                         .init(Components.interfaces.nsIStandardURL.URLTYPE_STANDARD,</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineminus">-                               this.mHttpProtocol.defaultPort,</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineminus">-                               aSpec, anOriginalCharset, aBaseURI)</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineminus">-                         .finalize()</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineminus">-                         .QueryInterface(Components.interfaces.nsIStandardURL);</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineplus">+        return Cc[&quot;@mozilla.org/network/standard-url-mutator;1&quot;]</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+            .createInstance(Ci.nsIStandardURLMutator)</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineplus">+            .init(Ci.nsIStandardURL.URLTYPE_STANDARD, this.mHttpProtocol.defaultPort, aSpec, anOriginalCharset, aBaseURI)</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineplus">+            .finalize()</span>
<a href="#l75.23"></a><span id="l75.23" class="difflineplus">+            .QueryInterface(Ci.nsIStandardURL);</span>
<a href="#l75.24"></a><span id="l75.24">     },</span>
<a href="#l75.25"></a><span id="l75.25"> </span>
<a href="#l75.26"></a><span id="l75.26">     newChannel: function(aUri) {</span>
<a href="#l75.27"></a><span id="l75.27">         return this.newChannel2(aUri, null);</span>
<a href="#l75.28"></a><span id="l75.28">     },</span>
<a href="#l75.29"></a><span id="l75.29"> </span>
<a href="#l75.30"></a><span id="l75.30">     newChannel2: function(aUri, aLoadInfo) {</span>
<a href="#l75.31"></a><span id="l75.31">         let uri = aUri.mutate().setScheme(this.mHttpProtocol.scheme).finalize();</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineat">@@ -39,18 +37,18 @@ calProtocolHandler.prototype = {</span>
<a href="#l75.33"></a><span id="l75.33">         let channel;</span>
<a href="#l75.34"></a><span id="l75.34">         if (aLoadInfo) {</span>
<a href="#l75.35"></a><span id="l75.35">             channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l75.36"></a><span id="l75.36">         } else {</span>
<a href="#l75.37"></a><span id="l75.37">             channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l75.38"></a><span id="l75.38">                                                      null,</span>
<a href="#l75.39"></a><span id="l75.39">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l75.40"></a><span id="l75.40">                                                      null,</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineminus">-                                                     Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineminus">-                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l75.43"></a><span id="l75.43" class="difflineplus">+                                                     Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l75.44"></a><span id="l75.44" class="difflineplus">+                                                     Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l75.45"></a><span id="l75.45">         }</span>
<a href="#l75.46"></a><span id="l75.46">         channel.originalURI = aUri;</span>
<a href="#l75.47"></a><span id="l75.47">         return channel;</span>
<a href="#l75.48"></a><span id="l75.48">     },</span>
<a href="#l75.49"></a><span id="l75.49"> </span>
<a href="#l75.50"></a><span id="l75.50">     // We are not overriding any special ports</span>
<a href="#l75.51"></a><span id="l75.51">     allowPort: function(aPort, aScheme) { return false; }</span>
<a href="#l75.52"></a><span id="l75.52"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceDate.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceDate.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -4,20 +4,17 @@</span>
<a href="#l76.4"></a><span id="l76.4"> </span>
<a href="#l76.5"></a><span id="l76.5"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l76.6"></a><span id="l76.6"> </span>
<a href="#l76.7"></a><span id="l76.7"> function calRecurrenceDate() {</span>
<a href="#l76.8"></a><span id="l76.8">     this.wrappedJSObject = this;</span>
<a href="#l76.9"></a><span id="l76.9"> }</span>
<a href="#l76.10"></a><span id="l76.10"> </span>
<a href="#l76.11"></a><span id="l76.11"> var calRecurrenceDateClassID = Components.ID(&quot;{806b6423-3aaa-4b26-afa3-de60563e9cec}&quot;);</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-var calRecurrenceDateInterfaces = [</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineminus">-    Components.interfaces.calIRecurrenceItem,</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineminus">-    Components.interfaces.calIRecurrenceDate</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineminus">-];</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineplus">+var calRecurrenceDateInterfaces = [Ci.calIRecurrenceItem, Ci.calIRecurrenceDate];</span>
<a href="#l76.17"></a><span id="l76.17"> calRecurrenceDate.prototype = {</span>
<a href="#l76.18"></a><span id="l76.18">     isMutable: true,</span>
<a href="#l76.19"></a><span id="l76.19"> </span>
<a href="#l76.20"></a><span id="l76.20">     mIsNegative: false,</span>
<a href="#l76.21"></a><span id="l76.21">     mDate: null,</span>
<a href="#l76.22"></a><span id="l76.22"> </span>
<a href="#l76.23"></a><span id="l76.23">     classID: calRecurrenceDateClassID,</span>
<a href="#l76.24"></a><span id="l76.24">     QueryInterface: cal.generateQI(calRecurrenceDateInterfaces),</span>
<a href="#l76.25"></a><span id="l76.25" class="difflineat">@@ -29,17 +26,17 @@ calRecurrenceDate.prototype = {</span>
<a href="#l76.26"></a><span id="l76.26">     }),</span>
<a href="#l76.27"></a><span id="l76.27"> </span>
<a href="#l76.28"></a><span id="l76.28">     makeImmutable: function() {</span>
<a href="#l76.29"></a><span id="l76.29">         this.isMutable = false;</span>
<a href="#l76.30"></a><span id="l76.30">     },</span>
<a href="#l76.31"></a><span id="l76.31"> </span>
<a href="#l76.32"></a><span id="l76.32">     ensureMutable: function() {</span>
<a href="#l76.33"></a><span id="l76.33">         if (!this.isMutable) {</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_MUTABLE;</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+            throw Cr.NS_ERROR_OBJECT_IS_MUTABLE;</span>
<a href="#l76.36"></a><span id="l76.36">         }</span>
<a href="#l76.37"></a><span id="l76.37">     },</span>
<a href="#l76.38"></a><span id="l76.38"> </span>
<a href="#l76.39"></a><span id="l76.39">     clone: function() {</span>
<a href="#l76.40"></a><span id="l76.40">         let other = new calRecurrenceDate();</span>
<a href="#l76.41"></a><span id="l76.41">         other.mDate = (this.mDate ? this.mDate.clone() : null);</span>
<a href="#l76.42"></a><span id="l76.42">         other.mIsNegative = this.mIsNegative;</span>
<a href="#l76.43"></a><span id="l76.43">         return other;</span>
<a href="#l76.44"></a><span id="l76.44" class="difflineat">@@ -82,34 +79,33 @@ calRecurrenceDate.prototype = {</span>
<a href="#l76.45"></a><span id="l76.45">     get icalString() {</span>
<a href="#l76.46"></a><span id="l76.46">         let comp = this.icalProperty;</span>
<a href="#l76.47"></a><span id="l76.47">         return (comp ? comp.icalString : &quot;&quot;);</span>
<a href="#l76.48"></a><span id="l76.48">     },</span>
<a href="#l76.49"></a><span id="l76.49">     set icalString(val) {</span>
<a href="#l76.50"></a><span id="l76.50">         let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l76.51"></a><span id="l76.51">         let propName = prop.propertyName;</span>
<a href="#l76.52"></a><span id="l76.52">         if (propName != &quot;RDATE&quot; &amp;&amp; propName != &quot;EXDATE&quot;) {</span>
<a href="#l76.53"></a><span id="l76.53" class="difflineminus">-            throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l76.54"></a><span id="l76.54" class="difflineplus">+            throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l76.55"></a><span id="l76.55">         }</span>
<a href="#l76.56"></a><span id="l76.56"> </span>
<a href="#l76.57"></a><span id="l76.57">         this.icalProperty = prop;</span>
<a href="#l76.58"></a><span id="l76.58">         return val;</span>
<a href="#l76.59"></a><span id="l76.59">     },</span>
<a href="#l76.60"></a><span id="l76.60"> </span>
<a href="#l76.61"></a><span id="l76.61">     get icalProperty() {</span>
<a href="#l76.62"></a><span id="l76.62">         let prop = cal.getIcsService().createIcalProperty(this.mIsNegative ? &quot;EXDATE&quot; : &quot;RDATE&quot;);</span>
<a href="#l76.63"></a><span id="l76.63">         prop.valueAsDatetime = this.mDate;</span>
<a href="#l76.64"></a><span id="l76.64">         return prop;</span>
<a href="#l76.65"></a><span id="l76.65">     },</span>
<a href="#l76.66"></a><span id="l76.66">     set icalProperty(prop) {</span>
<a href="#l76.67"></a><span id="l76.67">         if (prop.propertyName == &quot;RDATE&quot;) {</span>
<a href="#l76.68"></a><span id="l76.68">             this.mIsNegative = false;</span>
<a href="#l76.69"></a><span id="l76.69">             if (prop.getParameter(&quot;VALUE&quot;) == &quot;PERIOD&quot;) {</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineminus">-                let period = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l76.71"></a><span id="l76.71" class="difflineminus">-                                       .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l76.72"></a><span id="l76.72" class="difflineplus">+                let period = Cc[&quot;@mozilla.org/calendar/period;1&quot;].createInstance(Ci.calIPeriod);</span>
<a href="#l76.73"></a><span id="l76.73">                 period.icalString = prop.valueAsIcalString;</span>
<a href="#l76.74"></a><span id="l76.74">                 this.mDate = period.start;</span>
<a href="#l76.75"></a><span id="l76.75">             } else {</span>
<a href="#l76.76"></a><span id="l76.76">                 this.mDate = prop.valueAsDatetime;</span>
<a href="#l76.77"></a><span id="l76.77">             }</span>
<a href="#l76.78"></a><span id="l76.78">         } else if (prop.propertyName == &quot;EXDATE&quot;) {</span>
<a href="#l76.79"></a><span id="l76.79">             this.mIsNegative = true;</span>
<a href="#l76.80"></a><span id="l76.80">             this.mDate = prop.valueAsDatetime;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -32,22 +32,22 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l77.4"></a><span id="l77.4">     mNegativeRules: null,</span>
<a href="#l77.5"></a><span id="l77.5">     mExceptionMap: null,</span>
<a href="#l77.6"></a><span id="l77.6"> </span>
<a href="#l77.7"></a><span id="l77.7">     /**</span>
<a href="#l77.8"></a><span id="l77.8">      * Helpers</span>
<a href="#l77.9"></a><span id="l77.9">      */</span>
<a href="#l77.10"></a><span id="l77.10">     ensureBaseItem: function() {</span>
<a href="#l77.11"></a><span id="l77.11">         if (!this.mBaseItem) {</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+            throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l77.14"></a><span id="l77.14">         }</span>
<a href="#l77.15"></a><span id="l77.15">     },</span>
<a href="#l77.16"></a><span id="l77.16">     ensureMutable: function() {</span>
<a href="#l77.17"></a><span id="l77.17">         if (this.mImmutable) {</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineminus">-            throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineplus">+            throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l77.20"></a><span id="l77.20">         }</span>
<a href="#l77.21"></a><span id="l77.21">     },</span>
<a href="#l77.22"></a><span id="l77.22">     ensureSortedRecurrenceRules: function() {</span>
<a href="#l77.23"></a><span id="l77.23">         if (!this.mPositiveRules || !this.mNegativeRules) {</span>
<a href="#l77.24"></a><span id="l77.24">             this.mPositiveRules = [];</span>
<a href="#l77.25"></a><span id="l77.25">             this.mNegativeRules = [];</span>
<a href="#l77.26"></a><span id="l77.26">             for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l77.27"></a><span id="l77.27">                 if (ritem.isNegative) {</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineat">@@ -156,17 +156,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l77.29"></a><span id="l77.29"> </span>
<a href="#l77.30"></a><span id="l77.30">         return this.mRecurrenceItems.length;</span>
<a href="#l77.31"></a><span id="l77.31">     },</span>
<a href="#l77.32"></a><span id="l77.32"> </span>
<a href="#l77.33"></a><span id="l77.33">     getRecurrenceItemAt: function(aIndex) {</span>
<a href="#l77.34"></a><span id="l77.34">         this.ensureBaseItem();</span>
<a href="#l77.35"></a><span id="l77.35"> </span>
<a href="#l77.36"></a><span id="l77.36">         if (aIndex &lt; 0 || aIndex &gt;= this.mRecurrenceItems.length) {</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.39"></a><span id="l77.39">         }</span>
<a href="#l77.40"></a><span id="l77.40"> </span>
<a href="#l77.41"></a><span id="l77.41">         return this.mRecurrenceItems[aIndex];</span>
<a href="#l77.42"></a><span id="l77.42">     },</span>
<a href="#l77.43"></a><span id="l77.43"> </span>
<a href="#l77.44"></a><span id="l77.44">     appendRecurrenceItem: function(aItem) {</span>
<a href="#l77.45"></a><span id="l77.45">         this.ensureBaseItem();</span>
<a href="#l77.46"></a><span id="l77.46">         this.ensureMutable();</span>
<a href="#l77.47"></a><span id="l77.47" class="difflineat">@@ -180,52 +180,52 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l77.48"></a><span id="l77.48">         }</span>
<a href="#l77.49"></a><span id="l77.49">     },</span>
<a href="#l77.50"></a><span id="l77.50"> </span>
<a href="#l77.51"></a><span id="l77.51">     deleteRecurrenceItemAt: function(aIndex) {</span>
<a href="#l77.52"></a><span id="l77.52">         this.ensureBaseItem();</span>
<a href="#l77.53"></a><span id="l77.53">         this.ensureMutable();</span>
<a href="#l77.54"></a><span id="l77.54"> </span>
<a href="#l77.55"></a><span id="l77.55">         if (aIndex &lt; 0 || aIndex &gt;= this.mRecurrenceItems.length) {</span>
<a href="#l77.56"></a><span id="l77.56" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.58"></a><span id="l77.58">         }</span>
<a href="#l77.59"></a><span id="l77.59"> </span>
<a href="#l77.60"></a><span id="l77.60">         if (this.mRecurrenceItems[aIndex].isNegative) {</span>
<a href="#l77.61"></a><span id="l77.61">             this.mNegativeRules = null;</span>
<a href="#l77.62"></a><span id="l77.62">         } else {</span>
<a href="#l77.63"></a><span id="l77.63">             this.mPositiveRules = null;</span>
<a href="#l77.64"></a><span id="l77.64">         }</span>
<a href="#l77.65"></a><span id="l77.65"> </span>
<a href="#l77.66"></a><span id="l77.66">         this.mRecurrenceItems.splice(aIndex, 1);</span>
<a href="#l77.67"></a><span id="l77.67">     },</span>
<a href="#l77.68"></a><span id="l77.68"> </span>
<a href="#l77.69"></a><span id="l77.69">     deleteRecurrenceItem: function(aItem) {</span>
<a href="#l77.70"></a><span id="l77.70">         // Because xpcom objects can be wrapped in various ways, testing for</span>
<a href="#l77.71"></a><span id="l77.71">         // mere == sometimes returns false even when it should be true.  Use</span>
<a href="#l77.72"></a><span id="l77.72">         // the interface pointer returned by sip to avoid that problem.</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineminus">-        let sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineminus">-                            .createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineplus">+        let sip1 = Cc[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l77.76"></a><span id="l77.76" class="difflineplus">+                     .createInstance(Ci.nsISupportsInterfacePointer);</span>
<a href="#l77.77"></a><span id="l77.77">         sip1.data = aItem;</span>
<a href="#l77.78"></a><span id="l77.78" class="difflineminus">-        sip1.dataIID = Components.interfaces.calIRecurrenceItem;</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineplus">+        sip1.dataIID = Ci.calIRecurrenceItem;</span>
<a href="#l77.80"></a><span id="l77.80"> </span>
<a href="#l77.81"></a><span id="l77.81">         let pos;</span>
<a href="#l77.82"></a><span id="l77.82">         if ((pos = this.mRecurrenceItems.indexOf(sip1.data)) &gt; -1) {</span>
<a href="#l77.83"></a><span id="l77.83">             this.deleteRecurrenceItemAt(pos);</span>
<a href="#l77.84"></a><span id="l77.84">         } else {</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.87"></a><span id="l77.87">         }</span>
<a href="#l77.88"></a><span id="l77.88">     },</span>
<a href="#l77.89"></a><span id="l77.89"> </span>
<a href="#l77.90"></a><span id="l77.90">     insertRecurrenceItemAt: function(aItem, aIndex) {</span>
<a href="#l77.91"></a><span id="l77.91">         this.ensureBaseItem();</span>
<a href="#l77.92"></a><span id="l77.92">         this.ensureMutable();</span>
<a href="#l77.93"></a><span id="l77.93">         this.ensureSortedRecurrenceRules();</span>
<a href="#l77.94"></a><span id="l77.94"> </span>
<a href="#l77.95"></a><span id="l77.95">         if (aIndex &lt; 0 || aIndex &gt; this.mRecurrenceItems.length) {</span>
<a href="#l77.96"></a><span id="l77.96" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.97"></a><span id="l77.97" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.98"></a><span id="l77.98">         }</span>
<a href="#l77.99"></a><span id="l77.99"> </span>
<a href="#l77.100"></a><span id="l77.100">         if (aItem.isNegative) {</span>
<a href="#l77.101"></a><span id="l77.101">             this.mNegativeRules.push(aItem);</span>
<a href="#l77.102"></a><span id="l77.102">         } else {</span>
<a href="#l77.103"></a><span id="l77.103">             this.mPositiveRules.push(aItem);</span>
<a href="#l77.104"></a><span id="l77.104">         }</span>
<a href="#l77.105"></a><span id="l77.105"> </span>
<a href="#l77.106"></a><span id="l77.106" class="difflineat">@@ -288,18 +288,18 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l77.107"></a><span id="l77.107">             // Go through all positive rules and get the next recurrence id</span>
<a href="#l77.108"></a><span id="l77.108">             // according to that rule. If for all rules the rid is &quot;invalid&quot;,</span>
<a href="#l77.109"></a><span id="l77.109">             // (i.e an EXDATE removed it, or an exception moved it somewhere</span>
<a href="#l77.110"></a><span id="l77.110">             // else), then get the respective next rid.</span>
<a href="#l77.111"></a><span id="l77.111">             //</span>
<a href="#l77.112"></a><span id="l77.112">             // If in a loop at least one rid is valid (i.e not an exception, not</span>
<a href="#l77.113"></a><span id="l77.113">             // an exdate, is after aTime), then remember the lowest one.</span>
<a href="#l77.114"></a><span id="l77.114">             for (let i = 0; i &lt; this.mPositiveRules.length; i++) {</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineminus">-                let rDateInstance = cal.wrapInstance(this.mPositiveRules[i], Components.interfaces.calIRecurrenceDate);</span>
<a href="#l77.116"></a><span id="l77.116" class="difflineminus">-                let rRuleInstance = cal.wrapInstance(this.mPositiveRules[i], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l77.117"></a><span id="l77.117" class="difflineplus">+                let rDateInstance = cal.wrapInstance(this.mPositiveRules[i], Ci.calIRecurrenceDate);</span>
<a href="#l77.118"></a><span id="l77.118" class="difflineplus">+                let rRuleInstance = cal.wrapInstance(this.mPositiveRules[i], Ci.calIRecurrenceRule);</span>
<a href="#l77.119"></a><span id="l77.119">                 if (rDateInstance) {</span>
<a href="#l77.120"></a><span id="l77.120">                     // RDATEs are special. there is only one date in this rule,</span>
<a href="#l77.121"></a><span id="l77.121">                     // so no need to search anything.</span>
<a href="#l77.122"></a><span id="l77.122">                     let rdate = rDateInstance.date;</span>
<a href="#l77.123"></a><span id="l77.123">                     if (!nextOccurrences[i] &amp;&amp; rdate.compare(aTime) &gt; 0) {</span>
<a href="#l77.124"></a><span id="l77.124">                         // The RDATE falls into range, save it.</span>
<a href="#l77.125"></a><span id="l77.125">                         nextOccurrences[i] = rdate;</span>
<a href="#l77.126"></a><span id="l77.126">                     } else {</span>
<a href="#l77.127"></a><span id="l77.127" class="difflineat">@@ -598,41 +598,41 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l77.128"></a><span id="l77.128">         }</span>
<a href="#l77.129"></a><span id="l77.129">         return proxy;</span>
<a href="#l77.130"></a><span id="l77.130">     },</span>
<a href="#l77.131"></a><span id="l77.131"> </span>
<a href="#l77.132"></a><span id="l77.132">     removeOccurrenceAt: function(aRecurrenceId) {</span>
<a href="#l77.133"></a><span id="l77.133">         this.ensureBaseItem();</span>
<a href="#l77.134"></a><span id="l77.134">         this.ensureMutable();</span>
<a href="#l77.135"></a><span id="l77.135"> </span>
<a href="#l77.136"></a><span id="l77.136" class="difflineminus">-        let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l77.137"></a><span id="l77.137" class="difflineminus">-                              .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l77.138"></a><span id="l77.138" class="difflineplus">+        let rdate = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l77.139"></a><span id="l77.139" class="difflineplus">+                      .createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l77.140"></a><span id="l77.140">         rdate.isNegative = true;</span>
<a href="#l77.141"></a><span id="l77.141">         rdate.date = aRecurrenceId.clone();</span>
<a href="#l77.142"></a><span id="l77.142"> </span>
<a href="#l77.143"></a><span id="l77.143">         this.removeExceptionFor(rdate.date);</span>
<a href="#l77.144"></a><span id="l77.144"> </span>
<a href="#l77.145"></a><span id="l77.145">         this.appendRecurrenceItem(rdate);</span>
<a href="#l77.146"></a><span id="l77.146">     },</span>
<a href="#l77.147"></a><span id="l77.147"> </span>
<a href="#l77.148"></a><span id="l77.148">     restoreOccurrenceAt: function(aRecurrenceId) {</span>
<a href="#l77.149"></a><span id="l77.149">         this.ensureBaseItem();</span>
<a href="#l77.150"></a><span id="l77.150">         this.ensureMutable();</span>
<a href="#l77.151"></a><span id="l77.151">         this.ensureSortedRecurrenceRules();</span>
<a href="#l77.152"></a><span id="l77.152"> </span>
<a href="#l77.153"></a><span id="l77.153">         for (let i = 0; i &lt; this.mRecurrenceItems.length; i++) {</span>
<a href="#l77.154"></a><span id="l77.154" class="difflineminus">-            let rdate = cal.wrapInstance(this.mRecurrenceItems[i], Components.interfaces.calIRecurrenceDate);</span>
<a href="#l77.155"></a><span id="l77.155" class="difflineplus">+            let rdate = cal.wrapInstance(this.mRecurrenceItems[i], Ci.calIRecurrenceDate);</span>
<a href="#l77.156"></a><span id="l77.156">             if (rdate) {</span>
<a href="#l77.157"></a><span id="l77.157">                 if (rdate.isNegative &amp;&amp; rdate.date.compare(aRecurrenceId) == 0) {</span>
<a href="#l77.158"></a><span id="l77.158">                     return this.deleteRecurrenceItemAt(i);</span>
<a href="#l77.159"></a><span id="l77.159">                 }</span>
<a href="#l77.160"></a><span id="l77.160">             }</span>
<a href="#l77.161"></a><span id="l77.161">         }</span>
<a href="#l77.162"></a><span id="l77.162"> </span>
<a href="#l77.163"></a><span id="l77.163" class="difflineminus">-        throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.164"></a><span id="l77.164" class="difflineplus">+        throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.165"></a><span id="l77.165">     },</span>
<a href="#l77.166"></a><span id="l77.166"> </span>
<a href="#l77.167"></a><span id="l77.167">     //</span>
<a href="#l77.168"></a><span id="l77.168">     // exceptions</span>
<a href="#l77.169"></a><span id="l77.169">     //</span>
<a href="#l77.170"></a><span id="l77.170"> </span>
<a href="#l77.171"></a><span id="l77.171">     //</span>
<a href="#l77.172"></a><span id="l77.172">     // Some notes:</span>
<a href="#l77.173"></a><span id="l77.173" class="difflineat">@@ -665,22 +665,22 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l77.174"></a><span id="l77.174">     modifyException: function(anItem, aTakeOverOwnership) {</span>
<a href="#l77.175"></a><span id="l77.175">         this.ensureBaseItem();</span>
<a href="#l77.176"></a><span id="l77.176"> </span>
<a href="#l77.177"></a><span id="l77.177">         anItem = cal.unwrapInstance(anItem);</span>
<a href="#l77.178"></a><span id="l77.178"> </span>
<a href="#l77.179"></a><span id="l77.179">         if (anItem.parentItem.calendar != this.mBaseItem.calendar &amp;&amp;</span>
<a href="#l77.180"></a><span id="l77.180">             anItem.parentItem.id != this.mBaseItem.id) {</span>
<a href="#l77.181"></a><span id="l77.181">             cal.ERROR(&quot;recurrenceInfo::addException: item parentItem != this.mBaseItem (calendar/id)!&quot;);</span>
<a href="#l77.182"></a><span id="l77.182" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.183"></a><span id="l77.183" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.184"></a><span id="l77.184">         }</span>
<a href="#l77.185"></a><span id="l77.185"> </span>
<a href="#l77.186"></a><span id="l77.186">         if (anItem.recurrenceId == null) {</span>
<a href="#l77.187"></a><span id="l77.187">             cal.ERROR(&quot;recurrenceInfo::addException: item with null recurrenceId!&quot;);</span>
<a href="#l77.188"></a><span id="l77.188" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.189"></a><span id="l77.189" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l77.190"></a><span id="l77.190">         }</span>
<a href="#l77.191"></a><span id="l77.191"> </span>
<a href="#l77.192"></a><span id="l77.192">         let itemtoadd;</span>
<a href="#l77.193"></a><span id="l77.193">         if (aTakeOverOwnership &amp;&amp; anItem.isMutable) {</span>
<a href="#l77.194"></a><span id="l77.194">             itemtoadd = anItem;</span>
<a href="#l77.195"></a><span id="l77.195">             itemtoadd.parentItem = this.mBaseItem;</span>
<a href="#l77.196"></a><span id="l77.196">         } else {</span>
<a href="#l77.197"></a><span id="l77.197">             itemtoadd = anItem.cloneShallow(this.mBaseItem);</span>
<a href="#l77.198"></a><span id="l77.198" class="difflineat">@@ -734,21 +734,21 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l77.199"></a><span id="l77.199">         }</span>
<a href="#l77.200"></a><span id="l77.200"> </span>
<a href="#l77.201"></a><span id="l77.201">         // convert both dates to UTC since subtractDate is not timezone aware.</span>
<a href="#l77.202"></a><span id="l77.202">         let timeDiff = aNewStartTime.getInTimezone(cal.dtz.UTC).subtractDate(aOldStartTime.getInTimezone(cal.dtz.UTC));</span>
<a href="#l77.203"></a><span id="l77.203"> </span>
<a href="#l77.204"></a><span id="l77.204">         let rdates = {};</span>
<a href="#l77.205"></a><span id="l77.205"> </span>
<a href="#l77.206"></a><span id="l77.206">         // take RDATE's and EXDATE's into account.</span>
<a href="#l77.207"></a><span id="l77.207" class="difflineminus">-        const kCalIRecurrenceDate = Components.interfaces.calIRecurrenceDate;</span>
<a href="#l77.208"></a><span id="l77.208" class="difflineplus">+        const kCalIRecurrenceDate = Ci.calIRecurrenceDate;</span>
<a href="#l77.209"></a><span id="l77.209">         let ritems = this.getRecurrenceItems({});</span>
<a href="#l77.210"></a><span id="l77.210">         for (let ritem of ritems) {</span>
<a href="#l77.211"></a><span id="l77.211">             let rDateInstance = cal.wrapInstance(ritem, kCalIRecurrenceDate);</span>
<a href="#l77.212"></a><span id="l77.212" class="difflineminus">-            let rRuleInstance = cal.wrapInstance(ritem, Components.interfaces.calIRecurrenceRule);</span>
<a href="#l77.213"></a><span id="l77.213" class="difflineplus">+            let rRuleInstance = cal.wrapInstance(ritem, Ci.calIRecurrenceRule);</span>
<a href="#l77.214"></a><span id="l77.214">             if (rDateInstance) {</span>
<a href="#l77.215"></a><span id="l77.215">                 ritem = rDateInstance;</span>
<a href="#l77.216"></a><span id="l77.216">                 let date = ritem.date;</span>
<a href="#l77.217"></a><span id="l77.217">                 date.addDuration(timeDiff);</span>
<a href="#l77.218"></a><span id="l77.218">                 if (!ritem.isNegative) {</span>
<a href="#l77.219"></a><span id="l77.219">                     rdates[getRidKey(date)] = date;</span>
<a href="#l77.220"></a><span id="l77.220">                 }</span>
<a href="#l77.221"></a><span id="l77.221">                 ritem.date = date;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/calendar/base/src/calRelation.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/calendar/base/src/calRelation.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -49,17 +49,17 @@ calRelation.prototype = {</span>
<a href="#l78.4"></a><span id="l78.4">         if (this.mType) {</span>
<a href="#l78.5"></a><span id="l78.5">             icalatt.setParameter(&quot;RELTYPE&quot;, this.mType);</span>
<a href="#l78.6"></a><span id="l78.6">         }</span>
<a href="#l78.7"></a><span id="l78.7"> </span>
<a href="#l78.8"></a><span id="l78.8">         for (let [key, value] of this.mProperties.entries()) {</span>
<a href="#l78.9"></a><span id="l78.9">             try {</span>
<a href="#l78.10"></a><span id="l78.10">                 icalatt.setParameter(key, value);</span>
<a href="#l78.11"></a><span id="l78.11">             } catch (e) {</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-                if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+                if (e.result == Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l78.14"></a><span id="l78.14">                     // Illegal values should be ignored, but we could log them if</span>
<a href="#l78.15"></a><span id="l78.15">                     // the user has enabled logging.</span>
<a href="#l78.16"></a><span id="l78.16">                     cal.LOG(&quot;Warning: Invalid relation property value &quot; + key + &quot;=&quot; + value);</span>
<a href="#l78.17"></a><span id="l78.17">                 } else {</span>
<a href="#l78.18"></a><span id="l78.18">                     throw e;</span>
<a href="#l78.19"></a><span id="l78.19">                 }</span>
<a href="#l78.20"></a><span id="l78.20">             }</span>
<a href="#l78.21"></a><span id="l78.21">         }</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineat">@@ -86,17 +86,17 @@ calRelation.prototype = {</span>
<a href="#l78.23"></a><span id="l78.23"> </span>
<a href="#l78.24"></a><span id="l78.24">     get icalString() {</span>
<a href="#l78.25"></a><span id="l78.25">         let comp = this.icalProperty;</span>
<a href="#l78.26"></a><span id="l78.26">         return (comp ? comp.icalString : &quot;&quot;);</span>
<a href="#l78.27"></a><span id="l78.27">     },</span>
<a href="#l78.28"></a><span id="l78.28">     set icalString(val) {</span>
<a href="#l78.29"></a><span id="l78.29">         let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l78.30"></a><span id="l78.30">         if (prop.propertyName != &quot;RELATED-TO&quot;) {</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineminus">-            throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineplus">+            throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l78.33"></a><span id="l78.33">         }</span>
<a href="#l78.34"></a><span id="l78.34">         this.icalProperty = prop;</span>
<a href="#l78.35"></a><span id="l78.35">         return val;</span>
<a href="#l78.36"></a><span id="l78.36">     },</span>
<a href="#l78.37"></a><span id="l78.37"> </span>
<a href="#l78.38"></a><span id="l78.38">     getParameter: function(aName) {</span>
<a href="#l78.39"></a><span id="l78.39">         return this.mProperties.get(aName);</span>
<a href="#l78.40"></a><span id="l78.40">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/calendar/base/src/calSleepMonitor.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/calendar/base/src/calSleepMonitor.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -26,18 +26,18 @@ calSleepMonitor.prototype = {</span>
<a href="#l79.4"></a><span id="l79.4">             cal.LOG(&quot;[calSleepMonitor] Sleep cycle detected, notifying observers.&quot;);</span>
<a href="#l79.5"></a><span id="l79.5">             Services.obs.notifyObservers(null, &quot;wake_notification&quot;);</span>
<a href="#l79.6"></a><span id="l79.6">         }</span>
<a href="#l79.7"></a><span id="l79.7">         this.expected = now + this.interval;</span>
<a href="#l79.8"></a><span id="l79.8">     },</span>
<a href="#l79.9"></a><span id="l79.9">     start: function() {</span>
<a href="#l79.10"></a><span id="l79.10">         this.stop();</span>
<a href="#l79.11"></a><span id="l79.11">         this.expected = Date.now() + this.interval;</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-        this.timer = Components.classes[&quot;@mozilla.org/timer;1&quot;].createInstance(Components.interfaces.nsITimer);</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineminus">-        this.timer.initWithCallback(this.callback.bind(this), this.interval, Components.interfaces.nsITimer.TYPE_REPEATING_PRECISE);</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+        this.timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+        this.timer.initWithCallback(this.callback.bind(this), this.interval, Ci.nsITimer.TYPE_REPEATING_PRECISE);</span>
<a href="#l79.16"></a><span id="l79.16">     },</span>
<a href="#l79.17"></a><span id="l79.17">     stop: function() {</span>
<a href="#l79.18"></a><span id="l79.18">         if (this.timer) {</span>
<a href="#l79.19"></a><span id="l79.19">             this.timer.cancel();</span>
<a href="#l79.20"></a><span id="l79.20">             this.timer = null;</span>
<a href="#l79.21"></a><span id="l79.21">         }</span>
<a href="#l79.22"></a><span id="l79.22">     },</span>
<a href="#l79.23"></a><span id="l79.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/calendar/base/src/calStartupService.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/calendar/base/src/calStartupService.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -49,51 +49,51 @@ calStartupService.prototype = {</span>
<a href="#l80.4"></a><span id="l80.4">     /**</span>
<a href="#l80.5"></a><span id="l80.5">      * Gets the startup order of services. This is an array of service objects</span>
<a href="#l80.6"></a><span id="l80.6">      * that should be called in order at startup.</span>
<a href="#l80.7"></a><span id="l80.7">      *</span>
<a href="#l80.8"></a><span id="l80.8">      * @return      The startup order as an array.</span>
<a href="#l80.9"></a><span id="l80.9">      */</span>
<a href="#l80.10"></a><span id="l80.10">     getStartupOrder: function() {</span>
<a href="#l80.11"></a><span id="l80.11">         let self = this;</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-        let tzService = Components.classes[&quot;@mozilla.org/calendar/timezone-service;1&quot;]</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineminus">-                                  .getService(Components.interfaces.calITimezoneService);</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineminus">-        let calMgr = Components.classes[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l80.15"></a><span id="l80.15" class="difflineminus">-                               .getService(Components.interfaces.calICalendarManager);</span>
<a href="#l80.16"></a><span id="l80.16" class="difflineplus">+        let tzService = Cc[&quot;@mozilla.org/calendar/timezone-service;1&quot;]</span>
<a href="#l80.17"></a><span id="l80.17" class="difflineplus">+                          .getService(Ci.calITimezoneService);</span>
<a href="#l80.18"></a><span id="l80.18" class="difflineplus">+        let calMgr = Cc[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l80.19"></a><span id="l80.19" class="difflineplus">+                       .getService(Ci.calICalendarManager);</span>
<a href="#l80.20"></a><span id="l80.20"> </span>
<a href="#l80.21"></a><span id="l80.21">         // Localization service</span>
<a href="#l80.22"></a><span id="l80.22">         let locales = {</span>
<a href="#l80.23"></a><span id="l80.23">             startup: function(aCompleteListener) {</span>
<a href="#l80.24"></a><span id="l80.24">                 let packaged = Services.locale.packagedLocales;</span>
<a href="#l80.25"></a><span id="l80.25">                 let fileSrc = new FileSource(</span>
<a href="#l80.26"></a><span id="l80.26">                     &quot;calendar&quot;, packaged,</span>
<a href="#l80.27"></a><span id="l80.27">                     &quot;resource://calendar/chrome/calendar-{locale}/locale/{locale}/&quot;</span>
<a href="#l80.28"></a><span id="l80.28">                 );</span>
<a href="#l80.29"></a><span id="l80.29">                 L10nRegistry.registerSource(fileSrc);</span>
<a href="#l80.30"></a><span id="l80.30" class="difflineminus">-                aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineplus">+                aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l80.32"></a><span id="l80.32">             },</span>
<a href="#l80.33"></a><span id="l80.33">             shutdown: function(aCompleteListener) {</span>
<a href="#l80.34"></a><span id="l80.34" class="difflineminus">-                aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l80.35"></a><span id="l80.35" class="difflineplus">+                aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l80.36"></a><span id="l80.36">             }</span>
<a href="#l80.37"></a><span id="l80.37">         };</span>
<a href="#l80.38"></a><span id="l80.38"> </span>
<a href="#l80.39"></a><span id="l80.39">         // Notification object</span>
<a href="#l80.40"></a><span id="l80.40">         let notify = {</span>
<a href="#l80.41"></a><span id="l80.41">             startup: function(aCompleteListener) {</span>
<a href="#l80.42"></a><span id="l80.42">                 self.started = true;</span>
<a href="#l80.43"></a><span id="l80.43">                 Services.obs.notifyObservers(null, &quot;calendar-startup-done&quot;);</span>
<a href="#l80.44"></a><span id="l80.44" class="difflineminus">-                aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l80.45"></a><span id="l80.45" class="difflineplus">+                aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l80.46"></a><span id="l80.46">             },</span>
<a href="#l80.47"></a><span id="l80.47">             shutdown: function(aCompleteListener) {</span>
<a href="#l80.48"></a><span id="l80.48">                 // Argh, it would have all been so pretty! Since we just reverse</span>
<a href="#l80.49"></a><span id="l80.49">                 // the array, the shutdown notification would happen before the</span>
<a href="#l80.50"></a><span id="l80.50">                 // other shutdown calls. For lack of pretty code, I'm</span>
<a href="#l80.51"></a><span id="l80.51">                 // leaving this out! Users can still listen to xpcom-shutdown.</span>
<a href="#l80.52"></a><span id="l80.52">                 self.started = false;</span>
<a href="#l80.53"></a><span id="l80.53" class="difflineminus">-                aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l80.54"></a><span id="l80.54" class="difflineplus">+                aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l80.55"></a><span id="l80.55">             }</span>
<a href="#l80.56"></a><span id="l80.56">         };</span>
<a href="#l80.57"></a><span id="l80.57"> </span>
<a href="#l80.58"></a><span id="l80.58">         // We need to spin up the timezone service before the calendar manager</span>
<a href="#l80.59"></a><span id="l80.59">         // to ensure we have the timezones initialized. Make sure &quot;notify&quot; is</span>
<a href="#l80.60"></a><span id="l80.60">         // last in this array!</span>
<a href="#l80.61"></a><span id="l80.61">         return [locales, tzService, calMgr, notify];</span>
<a href="#l80.62"></a><span id="l80.62">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -19,49 +19,49 @@ calStringEnumerator.prototype = {</span>
<a href="#l81.4"></a><span id="l81.4">     [Symbol.iterator]: function() {</span>
<a href="#l81.5"></a><span id="l81.5">         return this.mStringArray.values();</span>
<a href="#l81.6"></a><span id="l81.6">     },</span>
<a href="#l81.7"></a><span id="l81.7">     hasMore: function() {</span>
<a href="#l81.8"></a><span id="l81.8">         return (this.mIndex &lt; this.mStringArray.length);</span>
<a href="#l81.9"></a><span id="l81.9">     },</span>
<a href="#l81.10"></a><span id="l81.10">     getNext: function() {</span>
<a href="#l81.11"></a><span id="l81.11">         if (!this.hasMore()) {</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-            throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+            throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l81.14"></a><span id="l81.14">         }</span>
<a href="#l81.15"></a><span id="l81.15">         return this.mStringArray[this.mIndex++];</span>
<a href="#l81.16"></a><span id="l81.16">     }</span>
<a href="#l81.17"></a><span id="l81.17"> };</span>
<a href="#l81.18"></a><span id="l81.18"> </span>
<a href="#l81.19"></a><span id="l81.19"> function calTimezoneService() {</span>
<a href="#l81.20"></a><span id="l81.20">     this.wrappedJSObject = this;</span>
<a href="#l81.21"></a><span id="l81.21"> </span>
<a href="#l81.22"></a><span id="l81.22">     this.mZones = new Map();</span>
<a href="#l81.23"></a><span id="l81.23"> </span>
<a href="#l81.24"></a><span id="l81.24">     ICAL.TimezoneService = this.wrappedJSObject;</span>
<a href="#l81.25"></a><span id="l81.25"> }</span>
<a href="#l81.26"></a><span id="l81.26"> var calTimezoneServiceClassID = Components.ID(&quot;{e736f2bd-7640-4715-ab35-887dc866c587}&quot;);</span>
<a href="#l81.27"></a><span id="l81.27"> var calTimezoneServiceInterfaces = [</span>
<a href="#l81.28"></a><span id="l81.28" class="difflineminus">-    Components.interfaces.calITimezoneService,</span>
<a href="#l81.29"></a><span id="l81.29" class="difflineminus">-    Components.interfaces.calITimezoneProvider,</span>
<a href="#l81.30"></a><span id="l81.30" class="difflineminus">-    Components.interfaces.calIStartupService</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineplus">+    Ci.calITimezoneService,</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineplus">+    Ci.calITimezoneProvider,</span>
<a href="#l81.33"></a><span id="l81.33" class="difflineplus">+    Ci.calIStartupService</span>
<a href="#l81.34"></a><span id="l81.34"> ];</span>
<a href="#l81.35"></a><span id="l81.35"> calTimezoneService.prototype = {</span>
<a href="#l81.36"></a><span id="l81.36">     mDefaultTimezone: null,</span>
<a href="#l81.37"></a><span id="l81.37">     mHasSetupObservers: false,</span>
<a href="#l81.38"></a><span id="l81.38">     mVersion: null,</span>
<a href="#l81.39"></a><span id="l81.39">     mZones: null,</span>
<a href="#l81.40"></a><span id="l81.40"> </span>
<a href="#l81.41"></a><span id="l81.41">     classID: calTimezoneServiceClassID,</span>
<a href="#l81.42"></a><span id="l81.42">     QueryInterface: cal.generateQI(calTimezoneServiceInterfaces),</span>
<a href="#l81.43"></a><span id="l81.43">     classInfo: cal.generateCI({</span>
<a href="#l81.44"></a><span id="l81.44">         classID: calTimezoneServiceClassID,</span>
<a href="#l81.45"></a><span id="l81.45">         contractID: &quot;@mozilla.org/calendar/timezone-service;1&quot;,</span>
<a href="#l81.46"></a><span id="l81.46">         classDescription: &quot;Calendar Timezone Service&quot;,</span>
<a href="#l81.47"></a><span id="l81.47">         interfaces: calTimezoneServiceInterfaces,</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineminus">-        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineplus">+        flags: Ci.nsIClassInfo.SINGLETON</span>
<a href="#l81.50"></a><span id="l81.50">     }),</span>
<a href="#l81.51"></a><span id="l81.51"> </span>
<a href="#l81.52"></a><span id="l81.52">     // ical.js TimezoneService methods</span>
<a href="#l81.53"></a><span id="l81.53">     has: function(id) { return this.getTimezone(id) != null; },</span>
<a href="#l81.54"></a><span id="l81.54">     get: function(id) {</span>
<a href="#l81.55"></a><span id="l81.55">         return id ? unwrapSingle(ICAL.Timezone, this.getTimezone(id)) : null;</span>
<a href="#l81.56"></a><span id="l81.56">     },</span>
<a href="#l81.57"></a><span id="l81.57">     remove: function() {},</span>
<a href="#l81.58"></a><span id="l81.58" class="difflineat">@@ -73,18 +73,18 @@ calTimezoneService.prototype = {</span>
<a href="#l81.59"></a><span id="l81.59">             cal.LOG(&quot;[calTimezoneService] Loading &quot; + aURL);</span>
<a href="#l81.60"></a><span id="l81.60"> </span>
<a href="#l81.61"></a><span id="l81.61">             return new Promise((resolve, reject) =&gt; {</span>
<a href="#l81.62"></a><span id="l81.62">                 let uri = Services.io.newURI(aURL);</span>
<a href="#l81.63"></a><span id="l81.63">                 let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l81.64"></a><span id="l81.64">                                                              null,</span>
<a href="#l81.65"></a><span id="l81.65">                                                              Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l81.66"></a><span id="l81.66">                                                              null,</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineminus">-                                                             Components.interfaces.nsILoadInfo.SEC_REQUIRE_SAME_ORIGIN_DATA_INHERITS,</span>
<a href="#l81.68"></a><span id="l81.68" class="difflineminus">-                                                             Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l81.69"></a><span id="l81.69" class="difflineplus">+                                                             Ci.nsILoadInfo.SEC_REQUIRE_SAME_ORIGIN_DATA_INHERITS,</span>
<a href="#l81.70"></a><span id="l81.70" class="difflineplus">+                                                             Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l81.71"></a><span id="l81.71"> </span>
<a href="#l81.72"></a><span id="l81.72">                 NetUtil.asyncFetch(channel, (inputStream, status) =&gt; {</span>
<a href="#l81.73"></a><span id="l81.73">                     if (!Components.isSuccessCode(status)) {</span>
<a href="#l81.74"></a><span id="l81.74">                         reject(status);</span>
<a href="#l81.75"></a><span id="l81.75">                         return;</span>
<a href="#l81.76"></a><span id="l81.76">                     }</span>
<a href="#l81.77"></a><span id="l81.77"> </span>
<a href="#l81.78"></a><span id="l81.78">                     try {</span>
<a href="#l81.79"></a><span id="l81.79" class="difflineat">@@ -96,17 +96,17 @@ calTimezoneService.prototype = {</span>
<a href="#l81.80"></a><span id="l81.80">                     }</span>
<a href="#l81.81"></a><span id="l81.81">                 });</span>
<a href="#l81.82"></a><span id="l81.82">             });</span>
<a href="#l81.83"></a><span id="l81.83">         }</span>
<a href="#l81.84"></a><span id="l81.84"> </span>
<a href="#l81.85"></a><span id="l81.85">         let resNamespace = &quot;calendar&quot;;</span>
<a href="#l81.86"></a><span id="l81.86">         // Check for presence of the calendar timezones add-on.</span>
<a href="#l81.87"></a><span id="l81.87">         let resProtocol = Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l81.88"></a><span id="l81.88" class="difflineminus">-                                  .QueryInterface(Components.interfaces.nsIResProtocolHandler);</span>
<a href="#l81.89"></a><span id="l81.89" class="difflineplus">+                                  .QueryInterface(Ci.nsIResProtocolHandler);</span>
<a href="#l81.90"></a><span id="l81.90">         if (resProtocol.hasSubstitution(&quot;calendar-timezones&quot;)) {</span>
<a href="#l81.91"></a><span id="l81.91">             resNamespace = &quot;calendar-timezones&quot;;</span>
<a href="#l81.92"></a><span id="l81.92">         }</span>
<a href="#l81.93"></a><span id="l81.93"> </span>
<a href="#l81.94"></a><span id="l81.94">         fetchJSON(&quot;resource://&quot; + resNamespace + &quot;/timezones/zones.json&quot;).then((tzData) =&gt; {</span>
<a href="#l81.95"></a><span id="l81.95">             for (let tzid of Object.keys(tzData.aliases)) {</span>
<a href="#l81.96"></a><span id="l81.96">                 let data = tzData.aliases[tzid];</span>
<a href="#l81.97"></a><span id="l81.97">                 if (typeof data == &quot;object&quot; &amp;&amp; data !== null) {</span>
<a href="#l81.98"></a><span id="l81.98" class="difflineat">@@ -126,29 +126,29 @@ calTimezoneService.prototype = {</span>
<a href="#l81.99"></a><span id="l81.99">             let bundleURL = &quot;chrome://&quot; + resNamespace + &quot;/locale/timezones.properties&quot;;</span>
<a href="#l81.100"></a><span id="l81.100">             this.stringBundle = ICAL.Timezone.cal_tz_bundle = Services.strings.createBundle(bundleURL);</span>
<a href="#l81.101"></a><span id="l81.101"> </span>
<a href="#l81.102"></a><span id="l81.102">             // Make sure UTC and floating are cached by calling their getters</span>
<a href="#l81.103"></a><span id="l81.103">             this.UTC; // eslint-disable-line no-unused-expressions</span>
<a href="#l81.104"></a><span id="l81.104">             this.floating; // eslint-disable-line no-unused-expressions</span>
<a href="#l81.105"></a><span id="l81.105">         }).then(() =&gt; {</span>
<a href="#l81.106"></a><span id="l81.106">             if (aCompleteListener) {</span>
<a href="#l81.107"></a><span id="l81.107" class="difflineminus">-                aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l81.108"></a><span id="l81.108" class="difflineplus">+                aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l81.109"></a><span id="l81.109">             }</span>
<a href="#l81.110"></a><span id="l81.110">         }, (error) =&gt; {</span>
<a href="#l81.111"></a><span id="l81.111">             // We have to give up. Show an error and fail hard!</span>
<a href="#l81.112"></a><span id="l81.112">             let msg = cal.l10n.getCalString(&quot;missingCalendarTimezonesError&quot;);</span>
<a href="#l81.113"></a><span id="l81.113">             cal.ERROR(msg);</span>
<a href="#l81.114"></a><span id="l81.114">             cal.showError(msg);</span>
<a href="#l81.115"></a><span id="l81.115">         });</span>
<a href="#l81.116"></a><span id="l81.116">     },</span>
<a href="#l81.117"></a><span id="l81.117"> </span>
<a href="#l81.118"></a><span id="l81.118">     shutdown: function(aCompleteListener) {</span>
<a href="#l81.119"></a><span id="l81.119">         Services.prefs.removeObserver(&quot;calendar.timezone.local&quot;, this);</span>
<a href="#l81.120"></a><span id="l81.120" class="difflineminus">-        aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l81.121"></a><span id="l81.121" class="difflineplus">+        aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l81.122"></a><span id="l81.122">     },</span>
<a href="#l81.123"></a><span id="l81.123"> </span>
<a href="#l81.124"></a><span id="l81.124">     get UTC() {</span>
<a href="#l81.125"></a><span id="l81.125">         if (!this.mZones.has(&quot;UTC&quot;)) {</span>
<a href="#l81.126"></a><span id="l81.126">             let utc;</span>
<a href="#l81.127"></a><span id="l81.127">             if (Preferences.get(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l81.128"></a><span id="l81.128">                 utc = new calICALJSTimezone(ICAL.Timezone.utcTimezone);</span>
<a href="#l81.129"></a><span id="l81.129">             } else {</span>
<a href="#l81.130"></a><span id="l81.130" class="difflineat">@@ -501,72 +501,70 @@ function guessSystemTimezone() {</span>
<a href="#l81.131"></a><span id="l81.131">                 }</span>
<a href="#l81.132"></a><span id="l81.132">             }</span>
<a href="#l81.133"></a><span id="l81.133">         }</span>
<a href="#l81.134"></a><span id="l81.134">         // no such period found</span>
<a href="#l81.135"></a><span id="l81.135">         return null;</span>
<a href="#l81.136"></a><span id="l81.136">     }</span>
<a href="#l81.137"></a><span id="l81.137"> </span>
<a href="#l81.138"></a><span id="l81.138">     function environmentVariableValue(varName) {</span>
<a href="#l81.139"></a><span id="l81.139" class="difflineminus">-        let envSvc = Components.classes[&quot;@mozilla.org/process/environment;1&quot;]</span>
<a href="#l81.140"></a><span id="l81.140" class="difflineminus">-                                .getService(Components.interfaces.nsIEnvironment);</span>
<a href="#l81.141"></a><span id="l81.141" class="difflineplus">+        let envSvc = Cc[&quot;@mozilla.org/process/environment;1&quot;]</span>
<a href="#l81.142"></a><span id="l81.142" class="difflineplus">+                       .getService(Ci.nsIEnvironment);</span>
<a href="#l81.143"></a><span id="l81.143">         let value = envSvc.get(varName);</span>
<a href="#l81.144"></a><span id="l81.144">         if (!value || !value.match(tzRegex)) {</span>
<a href="#l81.145"></a><span id="l81.145">             return &quot;&quot;;</span>
<a href="#l81.146"></a><span id="l81.146">         }</span>
<a href="#l81.147"></a><span id="l81.147">         return varName + &quot;=&quot; + value;</span>
<a href="#l81.148"></a><span id="l81.148">     }</span>
<a href="#l81.149"></a><span id="l81.149"> </span>
<a href="#l81.150"></a><span id="l81.150">     function symbolicLinkTarget(filepath) {</span>
<a href="#l81.151"></a><span id="l81.151">         try {</span>
<a href="#l81.152"></a><span id="l81.152" class="difflineminus">-            let file = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l81.153"></a><span id="l81.153" class="difflineminus">-                                 .createInstance(Components.interfaces.nsIFile);</span>
<a href="#l81.154"></a><span id="l81.154" class="difflineplus">+            let file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l81.155"></a><span id="l81.155">             file.initWithPath(filepath);</span>
<a href="#l81.156"></a><span id="l81.156" class="difflineminus">-            file.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l81.157"></a><span id="l81.157" class="difflineplus">+            file.QueryInterface(Ci.nsIFile);</span>
<a href="#l81.158"></a><span id="l81.158">             if (!file.exists() || !file.isSymlink() || !file.target.match(tzRegex)) {</span>
<a href="#l81.159"></a><span id="l81.159">                 return &quot;&quot;;</span>
<a href="#l81.160"></a><span id="l81.160">             }</span>
<a href="#l81.161"></a><span id="l81.161"> </span>
<a href="#l81.162"></a><span id="l81.162">             return filepath + &quot; -&gt; &quot; + file.target;</span>
<a href="#l81.163"></a><span id="l81.163">         } catch (ex) {</span>
<a href="#l81.164"></a><span id="l81.164" class="difflineminus">-            Components.utils.reportError(filepath + &quot;: &quot; + ex);</span>
<a href="#l81.165"></a><span id="l81.165" class="difflineplus">+            Cu.reportError(filepath + &quot;: &quot; + ex);</span>
<a href="#l81.166"></a><span id="l81.166">             return &quot;&quot;;</span>
<a href="#l81.167"></a><span id="l81.167">         }</span>
<a href="#l81.168"></a><span id="l81.168">     }</span>
<a href="#l81.169"></a><span id="l81.169"> </span>
<a href="#l81.170"></a><span id="l81.170">     function fileFirstZoneLineString(filepath) {</span>
<a href="#l81.171"></a><span id="l81.171">         // return first line of file that matches tzRegex (ZoneInfo id),</span>
<a href="#l81.172"></a><span id="l81.172">         // or &quot;&quot; if no file or no matching line.</span>
<a href="#l81.173"></a><span id="l81.173">         try {</span>
<a href="#l81.174"></a><span id="l81.174" class="difflineminus">-            let file = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l81.175"></a><span id="l81.175" class="difflineminus">-                                 .createInstance(Components.interfaces.nsIFile);</span>
<a href="#l81.176"></a><span id="l81.176" class="difflineplus">+            let file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l81.177"></a><span id="l81.177">             file.initWithPath(filepath);</span>
<a href="#l81.178"></a><span id="l81.178" class="difflineminus">-            file.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l81.179"></a><span id="l81.179" class="difflineplus">+            file.QueryInterface(Ci.nsIFile);</span>
<a href="#l81.180"></a><span id="l81.180">             if (!file.exists()) {</span>
<a href="#l81.181"></a><span id="l81.181">                 return &quot;&quot;;</span>
<a href="#l81.182"></a><span id="l81.182">             }</span>
<a href="#l81.183"></a><span id="l81.183" class="difflineminus">-            let fileInstream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l81.184"></a><span id="l81.184" class="difflineminus">-                                         .createInstance(Components.interfaces.nsIFileInputStream);</span>
<a href="#l81.185"></a><span id="l81.185" class="difflineplus">+            let fileInstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l81.186"></a><span id="l81.186" class="difflineplus">+                                 .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l81.187"></a><span id="l81.187">             const PR_RDONLY = 0x1;</span>
<a href="#l81.188"></a><span id="l81.188">             fileInstream.init(file, PR_RDONLY, 0, 0);</span>
<a href="#l81.189"></a><span id="l81.189" class="difflineminus">-            fileInstream.QueryInterface(Components.interfaces.nsILineInputStream);</span>
<a href="#l81.190"></a><span id="l81.190" class="difflineplus">+            fileInstream.QueryInterface(Ci.nsILineInputStream);</span>
<a href="#l81.191"></a><span id="l81.191">             try {</span>
<a href="#l81.192"></a><span id="l81.192">                 let line = {}, hasMore = true, MAXLINES = 10;</span>
<a href="#l81.193"></a><span id="l81.193">                 for (let i = 0; hasMore &amp;&amp; i &lt; MAXLINES; i++) {</span>
<a href="#l81.194"></a><span id="l81.194">                     hasMore = fileInstream.readLine(line);</span>
<a href="#l81.195"></a><span id="l81.195">                     if (line.value &amp;&amp; line.value.match(tzRegex)) {</span>
<a href="#l81.196"></a><span id="l81.196">                         return filepath + &quot;: &quot; + line.value;</span>
<a href="#l81.197"></a><span id="l81.197">                     }</span>
<a href="#l81.198"></a><span id="l81.198">                 }</span>
<a href="#l81.199"></a><span id="l81.199">                 return &quot;&quot;; // not found</span>
<a href="#l81.200"></a><span id="l81.200">             } finally {</span>
<a href="#l81.201"></a><span id="l81.201">                 fileInstream.close();</span>
<a href="#l81.202"></a><span id="l81.202">             }</span>
<a href="#l81.203"></a><span id="l81.203">         } catch (ex) {</span>
<a href="#l81.204"></a><span id="l81.204" class="difflineminus">-            Components.utils.reportError(filepath + &quot;: &quot; + ex);</span>
<a href="#l81.205"></a><span id="l81.205" class="difflineplus">+            Cu.reportError(filepath + &quot;: &quot; + ex);</span>
<a href="#l81.206"></a><span id="l81.206">             return &quot;&quot;;</span>
<a href="#l81.207"></a><span id="l81.207">         }</span>
<a href="#l81.208"></a><span id="l81.208">     }</span>
<a href="#l81.209"></a><span id="l81.209"> </span>
<a href="#l81.210"></a><span id="l81.210">     function weekday(icsDate, timezone) {</span>
<a href="#l81.211"></a><span id="l81.211">         let calDate = cal.createDateTime(icsDate);</span>
<a href="#l81.212"></a><span id="l81.212">         calDate.timezone = timezone;</span>
<a href="#l81.213"></a><span id="l81.213">         return cal.dtz.dateTimeToJsDate(calDate).toLocaleString(undefined, { weekday: &quot;short&quot; });</span>
<a href="#l81.214"></a><span id="l81.214" class="difflineat">@@ -579,22 +577,22 @@ function guessSystemTimezone() {</span>
<a href="#l81.215"></a><span id="l81.215">     let probableTZSource = null;</span>
<a href="#l81.216"></a><span id="l81.216"> </span>
<a href="#l81.217"></a><span id="l81.217">     const calProperties = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l81.218"></a><span id="l81.218"> </span>
<a href="#l81.219"></a><span id="l81.219">     // First, try to detect operating system timezone.</span>
<a href="#l81.220"></a><span id="l81.220">     let zoneInfoIdFromOSUserTimeZone = null;</span>
<a href="#l81.221"></a><span id="l81.221">     let osUserTimeZone = null;</span>
<a href="#l81.222"></a><span id="l81.222">     try {</span>
<a href="#l81.223"></a><span id="l81.223" class="difflineminus">-        let handler = Components.classes[&quot;@mozilla.org/network/protocol;1?name=http&quot;]</span>
<a href="#l81.224"></a><span id="l81.224" class="difflineminus">-                                .getService(Components.interfaces.nsIHttpProtocolHandler);</span>
<a href="#l81.225"></a><span id="l81.225" class="difflineplus">+        let handler = Cc[&quot;@mozilla.org/network/protocol;1?name=http&quot;]</span>
<a href="#l81.226"></a><span id="l81.226" class="difflineplus">+                        .getService(Ci.nsIHttpProtocolHandler);</span>
<a href="#l81.227"></a><span id="l81.227"> </span>
<a href="#l81.228"></a><span id="l81.228">         if (handler.oscpu.match(/^Windows/)) {</span>
<a href="#l81.229"></a><span id="l81.229" class="difflineminus">-            let wrk = Components.classes[&quot;@mozilla.org/windows-registry-key;1&quot;]</span>
<a href="#l81.230"></a><span id="l81.230" class="difflineminus">-                                .createInstance(Components.interfaces.nsIWindowsRegKey);</span>
<a href="#l81.231"></a><span id="l81.231" class="difflineplus">+            let wrk = Cc[&quot;@mozilla.org/windows-registry-key;1&quot;]</span>
<a href="#l81.232"></a><span id="l81.232" class="difflineplus">+                        .createInstance(Ci.nsIWindowsRegKey);</span>
<a href="#l81.233"></a><span id="l81.233">             wrk.open(wrk.ROOT_KEY_LOCAL_MACHINE,</span>
<a href="#l81.234"></a><span id="l81.234">                      &quot;SYSTEM\\CurrentControlSet\\Control\\TimeZoneInformation&quot;,</span>
<a href="#l81.235"></a><span id="l81.235">                      wrk.ACCESS_READ);</span>
<a href="#l81.236"></a><span id="l81.236">             if (wrk.hasValue(&quot;TimeZoneKeyName&quot;)) {</span>
<a href="#l81.237"></a><span id="l81.237">                 // Windows Vista and later have this key.</span>
<a href="#l81.238"></a><span id="l81.238">                 // Clear trailing garbage on this key, see bug 1129712.</span>
<a href="#l81.239"></a><span id="l81.239">                 osUserTimeZone = wrk.readStringValue(&quot;TimeZoneKeyName&quot;).split(&quot;\0&quot;)[0];</span>
<a href="#l81.240"></a><span id="l81.240">             } else {</span>
<a href="#l81.241"></a><span id="l81.241" class="difflineat">@@ -689,17 +687,17 @@ function guessSystemTimezone() {</span>
<a href="#l81.242"></a><span id="l81.242">                     // exact match</span>
<a href="#l81.243"></a><span id="l81.243">                     return tzId;</span>
<a href="#l81.244"></a><span id="l81.244">             }</span>
<a href="#l81.245"></a><span id="l81.245">         }</span>
<a href="#l81.246"></a><span id="l81.246">     } catch (ex) {</span>
<a href="#l81.247"></a><span id="l81.247">         // zoneInfo id given was not recognized by our ZoneInfo database</span>
<a href="#l81.248"></a><span id="l81.248">         let errParams = [zoneInfoIdFromOSUserTimeZone || osUserTimeZone];</span>
<a href="#l81.249"></a><span id="l81.249">         let errMsg = calProperties.formatStringFromName(&quot;SkippingOSTimezone&quot;, errParams, 1);</span>
<a href="#l81.250"></a><span id="l81.250" class="difflineminus">-        Components.utils.reportError(errMsg + &quot; &quot; + ex);</span>
<a href="#l81.251"></a><span id="l81.251" class="difflineplus">+        Cu.reportError(errMsg + &quot; &quot; + ex);</span>
<a href="#l81.252"></a><span id="l81.252">     }</span>
<a href="#l81.253"></a><span id="l81.253"> </span>
<a href="#l81.254"></a><span id="l81.254">     // Second, give priority to &quot;likelyTimezone&quot;s if provided by locale.</span>
<a href="#l81.255"></a><span id="l81.255">     try {</span>
<a href="#l81.256"></a><span id="l81.256">         // The likelyTimezone property is a comma-separated list of</span>
<a href="#l81.257"></a><span id="l81.257">         // ZoneInfo timezone ids.</span>
<a href="#l81.258"></a><span id="l81.258">         const bundleTZString =</span>
<a href="#l81.259"></a><span id="l81.259">             calProperties.GetStringFromName(&quot;likelyTimezone&quot;);</span>
<a href="#l81.260"></a><span id="l81.260" class="difflineat">@@ -720,21 +718,21 @@ function guessSystemTimezone() {</span>
<a href="#l81.261"></a><span id="l81.261">                         }</span>
<a href="#l81.262"></a><span id="l81.262">                         break;</span>
<a href="#l81.263"></a><span id="l81.263">                     case 3:</span>
<a href="#l81.264"></a><span id="l81.264">                         return tzId;</span>
<a href="#l81.265"></a><span id="l81.265">                 }</span>
<a href="#l81.266"></a><span id="l81.266">             } catch (ex) {</span>
<a href="#l81.267"></a><span id="l81.267">                 let errMsg = calProperties.formatStringFromName(</span>
<a href="#l81.268"></a><span id="l81.268">                     &quot;SkippingLocaleTimezone&quot;, [bareTZId], 1);</span>
<a href="#l81.269"></a><span id="l81.269" class="difflineminus">-                Components.utils.reportError(errMsg + &quot; &quot; + ex);</span>
<a href="#l81.270"></a><span id="l81.270" class="difflineplus">+                Cu.reportError(errMsg + &quot; &quot; + ex);</span>
<a href="#l81.271"></a><span id="l81.271">             }</span>
<a href="#l81.272"></a><span id="l81.272">         }</span>
<a href="#l81.273"></a><span id="l81.273">     } catch (ex) { // Oh well, this didn't work, next option...</span>
<a href="#l81.274"></a><span id="l81.274" class="difflineminus">-        Components.utils.reportError(ex);</span>
<a href="#l81.275"></a><span id="l81.275" class="difflineplus">+        Cu.reportError(ex);</span>
<a href="#l81.276"></a><span id="l81.276">     }</span>
<a href="#l81.277"></a><span id="l81.277"> </span>
<a href="#l81.278"></a><span id="l81.278">     // Third, try all known timezones.</span>
<a href="#l81.279"></a><span id="l81.279">     const tzIDs = tzSvc.timezoneIds;</span>
<a href="#l81.280"></a><span id="l81.280">     while (tzIDs.hasMore()) {</span>
<a href="#l81.281"></a><span id="l81.281">         let tzId = tzIDs.getNext();</span>
<a href="#l81.282"></a><span id="l81.282">         try {</span>
<a href="#l81.283"></a><span id="l81.283">             let score = checkTZ(tzId);</span>
<a href="#l81.284"></a><span id="l81.284" class="difflineat">@@ -747,17 +745,17 @@ function guessSystemTimezone() {</span>
<a href="#l81.285"></a><span id="l81.285">                         probableTZSource = calProperties.GetStringFromName(&quot;TZFromKnownTimezones&quot;);</span>
<a href="#l81.286"></a><span id="l81.286">                     }</span>
<a href="#l81.287"></a><span id="l81.287">                     break;</span>
<a href="#l81.288"></a><span id="l81.288">                 case 3:</span>
<a href="#l81.289"></a><span id="l81.289">                     return tzId;</span>
<a href="#l81.290"></a><span id="l81.290">             }</span>
<a href="#l81.291"></a><span id="l81.291">         } catch (ex) { // bug if ics service doesn't recognize own tzid!</span>
<a href="#l81.292"></a><span id="l81.292">             let msg = &quot;ics-service doesn't recognize own tzid: &quot; + tzId + &quot;\n&quot; + ex;</span>
<a href="#l81.293"></a><span id="l81.293" class="difflineminus">-            Components.utils.reportError(msg);</span>
<a href="#l81.294"></a><span id="l81.294" class="difflineplus">+            Cu.reportError(msg);</span>
<a href="#l81.295"></a><span id="l81.295">         }</span>
<a href="#l81.296"></a><span id="l81.296">     }</span>
<a href="#l81.297"></a><span id="l81.297"> </span>
<a href="#l81.298"></a><span id="l81.298">     // If reach here, there were no score=3 matches, so Warn in console.</span>
<a href="#l81.299"></a><span id="l81.299">     try {</span>
<a href="#l81.300"></a><span id="l81.300">         switch (probableTZScore) {</span>
<a href="#l81.301"></a><span id="l81.301">             case 0: {</span>
<a href="#l81.302"></a><span id="l81.302">                 cal.WARN(calProperties.GetStringFromName(&quot;warningUsingFloatingTZNoMatch&quot;));</span>
<a href="#l81.303"></a><span id="l81.303" class="difflineat">@@ -800,17 +798,17 @@ function guessSystemTimezone() {</span>
<a href="#l81.304"></a><span id="l81.304">                                      (daylightTZOffset ? &quot;/&quot; + daylightTZOffset : &quot;&quot;);</span>
<a href="#l81.305"></a><span id="l81.305">                 let warningMsg = calProperties.formatStringFromName(&quot;WarningUsingGuessedTZ&quot;,</span>
<a href="#l81.306"></a><span id="l81.306">                                   [tzId, offsetString, warningDetail, probableTZSource], 4);</span>
<a href="#l81.307"></a><span id="l81.307">                 cal.WARN(warningMsg);</span>
<a href="#l81.308"></a><span id="l81.308">                 break;</span>
<a href="#l81.309"></a><span id="l81.309">             }</span>
<a href="#l81.310"></a><span id="l81.310">         }</span>
<a href="#l81.311"></a><span id="l81.311">     } catch (ex) { // don't abort if error occurs warning user</span>
<a href="#l81.312"></a><span id="l81.312" class="difflineminus">-        Components.utils.reportError(ex);</span>
<a href="#l81.313"></a><span id="l81.313" class="difflineplus">+        Cu.reportError(ex);</span>
<a href="#l81.314"></a><span id="l81.314">     }</span>
<a href="#l81.315"></a><span id="l81.315"> </span>
<a href="#l81.316"></a><span id="l81.316">     // return the guessed timezone</span>
<a href="#l81.317"></a><span id="l81.317">     return probableTZId;</span>
<a href="#l81.318"></a><span id="l81.318"> }</span>
<a href="#l81.319"></a><span id="l81.319"> </span>
<a href="#l81.320"></a><span id="l81.320"> this.NSGetFactory = (cid) =&gt; {</span>
<a href="#l81.321"></a><span id="l81.321">     Services.scriptloader.loadSubScript(&quot;resource://calendar/calendar-js/calTimezone.js&quot;, this);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -16,19 +16,19 @@ function calTodo() {</span>
<a href="#l82.4"></a><span id="l82.4">         DUE: true,</span>
<a href="#l82.5"></a><span id="l82.5">         COMPLETED: true,</span>
<a href="#l82.6"></a><span id="l82.6">         __proto__: this.itemBasePromotedProps</span>
<a href="#l82.7"></a><span id="l82.7">     };</span>
<a href="#l82.8"></a><span id="l82.8"> }</span>
<a href="#l82.9"></a><span id="l82.9"> </span>
<a href="#l82.10"></a><span id="l82.10"> var calTodoClassID = Components.ID(&quot;{7af51168-6abe-4a31-984d-6f8a3989212d}&quot;);</span>
<a href="#l82.11"></a><span id="l82.11"> var calTodoInterfaces = [</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-    Components.interfaces.calIItemBase,</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineminus">-    Components.interfaces.calITodo,</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineminus">-    Components.interfaces.calIInternalShallowCopy</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineplus">+    Ci.calIItemBase,</span>
<a href="#l82.16"></a><span id="l82.16" class="difflineplus">+    Ci.calITodo,</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineplus">+    Ci.calIInternalShallowCopy</span>
<a href="#l82.18"></a><span id="l82.18"> ];</span>
<a href="#l82.19"></a><span id="l82.19"> calTodo.prototype = {</span>
<a href="#l82.20"></a><span id="l82.20">     __proto__: calItemBase.prototype,</span>
<a href="#l82.21"></a><span id="l82.21"> </span>
<a href="#l82.22"></a><span id="l82.22">     classID: calTodoClassID,</span>
<a href="#l82.23"></a><span id="l82.23">     QueryInterface: cal.generateQI(calTodoInterfaces),</span>
<a href="#l82.24"></a><span id="l82.24">     classInfo: cal.generateCI({</span>
<a href="#l82.25"></a><span id="l82.25">         classID: calTodoClassID,</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineat">@@ -140,17 +140,17 @@ calTodo.prototype = {</span>
<a href="#l82.27"></a><span id="l82.27">                     let icalprop = icssvc.createIcalProperty(name);</span>
<a href="#l82.28"></a><span id="l82.28">                     icalprop.value = value;</span>
<a href="#l82.29"></a><span id="l82.29">                     let propBucket = this.mPropertyParams[name];</span>
<a href="#l82.30"></a><span id="l82.30">                     if (propBucket) {</span>
<a href="#l82.31"></a><span id="l82.31">                         for (let paramName in propBucket) {</span>
<a href="#l82.32"></a><span id="l82.32">                             try {</span>
<a href="#l82.33"></a><span id="l82.33">                                 icalprop.setParameter(paramName, propBucket[paramName]);</span>
<a href="#l82.34"></a><span id="l82.34">                             } catch (e) {</span>
<a href="#l82.35"></a><span id="l82.35" class="difflineminus">-                                if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l82.36"></a><span id="l82.36" class="difflineplus">+                                if (e.result == Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l82.37"></a><span id="l82.37">                                     // Illegal values should be ignored, but we could log them if</span>
<a href="#l82.38"></a><span id="l82.38">                                     // the user has enabled logging.</span>
<a href="#l82.39"></a><span id="l82.39">                                     cal.LOG(&quot;Warning: Invalid todo parameter value &quot; + paramName + &quot;=&quot; + propBucket[paramName]);</span>
<a href="#l82.40"></a><span id="l82.40">                                 } else {</span>
<a href="#l82.41"></a><span id="l82.41">                                     throw e;</span>
<a href="#l82.42"></a><span id="l82.42">                                 }</span>
<a href="#l82.43"></a><span id="l82.43">                             }</span>
<a href="#l82.44"></a><span id="l82.44">                         }</span>
<a href="#l82.45"></a><span id="l82.45" class="difflineat">@@ -166,17 +166,17 @@ calTodo.prototype = {</span>
<a href="#l82.46"></a><span id="l82.46"> </span>
<a href="#l82.47"></a><span id="l82.47">     todoPromotedProps: null,</span>
<a href="#l82.48"></a><span id="l82.48"> </span>
<a href="#l82.49"></a><span id="l82.49">     set icalComponent(todo) {</span>
<a href="#l82.50"></a><span id="l82.50">         this.modify();</span>
<a href="#l82.51"></a><span id="l82.51">         if (todo.componentType != &quot;VTODO&quot;) {</span>
<a href="#l82.52"></a><span id="l82.52">             todo = todo.getFirstSubcomponent(&quot;VTODO&quot;);</span>
<a href="#l82.53"></a><span id="l82.53">             if (!todo) {</span>
<a href="#l82.54"></a><span id="l82.54" class="difflineminus">-                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l82.55"></a><span id="l82.55" class="difflineplus">+                throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l82.56"></a><span id="l82.56">             }</span>
<a href="#l82.57"></a><span id="l82.57">         }</span>
<a href="#l82.58"></a><span id="l82.58"> </span>
<a href="#l82.59"></a><span id="l82.59">         this.mDueDate = undefined;</span>
<a href="#l82.60"></a><span id="l82.60">         this.setItemBaseFromICS(todo);</span>
<a href="#l82.61"></a><span id="l82.61">         this.mapPropsFromICS(todo, this.icsEventPropMap);</span>
<a href="#l82.62"></a><span id="l82.62"> </span>
<a href="#l82.63"></a><span id="l82.63">         this.importUnpromotedProperties(todo, this.todoPromotedProps);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -72,18 +72,18 @@ function calTransaction(aAction, aItem, </span>
<a href="#l83.4"></a><span id="l83.4">     this.mCalendar = aCalendar;</span>
<a href="#l83.5"></a><span id="l83.5">     this.mOldItem = aOldItem;</span>
<a href="#l83.6"></a><span id="l83.6">     this.mListener = aListener;</span>
<a href="#l83.7"></a><span id="l83.7">     this.mExtResponse = aExtResponse;</span>
<a href="#l83.8"></a><span id="l83.8"> }</span>
<a href="#l83.9"></a><span id="l83.9"> </span>
<a href="#l83.10"></a><span id="l83.10"> var calTransactionClassID = Components.ID(&quot;{fcb54c82-2fb9-42cb-bf44-1e197a55e520}&quot;);</span>
<a href="#l83.11"></a><span id="l83.11"> var calTransactionInterfaces = [</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-    Components.interfaces.nsITransaction,</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineminus">-    Components.interfaces.calIOperationListener</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineplus">+    Ci.nsITransaction,</span>
<a href="#l83.15"></a><span id="l83.15" class="difflineplus">+    Ci.calIOperationListener</span>
<a href="#l83.16"></a><span id="l83.16"> ];</span>
<a href="#l83.17"></a><span id="l83.17"> calTransaction.prototype = {</span>
<a href="#l83.18"></a><span id="l83.18">     classID: calTransactionClassID,</span>
<a href="#l83.19"></a><span id="l83.19">     QueryInterface: ChromeUtils.generateQI(calTransactionInterfaces),</span>
<a href="#l83.20"></a><span id="l83.20"> </span>
<a href="#l83.21"></a><span id="l83.21">     mAction: null,</span>
<a href="#l83.22"></a><span id="l83.22">     mCalendar: null,</span>
<a href="#l83.23"></a><span id="l83.23">     mItem: null,</span>
<a href="#l83.24"></a><span id="l83.24" class="difflineat">@@ -95,18 +95,18 @@ calTransaction.prototype = {</span>
<a href="#l83.25"></a><span id="l83.25"> </span>
<a href="#l83.26"></a><span id="l83.26">     onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l83.27"></a><span id="l83.27">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l83.28"></a><span id="l83.28">             cal.itip.checkAndSend(aOperationType,</span>
<a href="#l83.29"></a><span id="l83.29">                                   aDetail,</span>
<a href="#l83.30"></a><span id="l83.30">                                   this.mIsDoTransaction ? this.mOldItem : this.mItem,</span>
<a href="#l83.31"></a><span id="l83.31">                                   this.mExtResponse);</span>
<a href="#l83.32"></a><span id="l83.32"> </span>
<a href="#l83.33"></a><span id="l83.33" class="difflineminus">-            if (aOperationType == Components.interfaces.calIOperationListener.ADD ||</span>
<a href="#l83.34"></a><span id="l83.34" class="difflineminus">-                aOperationType == Components.interfaces.calIOperationListener.MODIFY) {</span>
<a href="#l83.35"></a><span id="l83.35" class="difflineplus">+            if (aOperationType == Ci.calIOperationListener.ADD ||</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineplus">+                aOperationType == Ci.calIOperationListener.MODIFY) {</span>
<a href="#l83.37"></a><span id="l83.37">                 if (this.mIsDoTransaction) {</span>
<a href="#l83.38"></a><span id="l83.38">                     this.mItem = aDetail;</span>
<a href="#l83.39"></a><span id="l83.39">                 } else {</span>
<a href="#l83.40"></a><span id="l83.40">                     this.mOldItem = aDetail;</span>
<a href="#l83.41"></a><span id="l83.41">                 }</span>
<a href="#l83.42"></a><span id="l83.42">             }</span>
<a href="#l83.43"></a><span id="l83.43">         }</span>
<a href="#l83.44"></a><span id="l83.44">         if (this.mListener) {</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineat">@@ -154,18 +154,17 @@ calTransaction.prototype = {</span>
<a href="#l83.46"></a><span id="l83.46">                     this.mOldCalendar = this.mOldItem.calendar;</span>
<a href="#l83.47"></a><span id="l83.47">                     this.mCalendar.addItem(this.mItem, addListener);</span>
<a href="#l83.48"></a><span id="l83.48">                 }</span>
<a href="#l83.49"></a><span id="l83.49">                 break;</span>
<a href="#l83.50"></a><span id="l83.50">             case &quot;delete&quot;:</span>
<a href="#l83.51"></a><span id="l83.51">                 this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l83.52"></a><span id="l83.52">                 break;</span>
<a href="#l83.53"></a><span id="l83.53">             default:</span>
<a href="#l83.54"></a><span id="l83.54" class="difflineminus">-                throw new Components.Exception(&quot;Invalid action specified&quot;,</span>
<a href="#l83.55"></a><span id="l83.55" class="difflineminus">-                                               Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l83.56"></a><span id="l83.56" class="difflineplus">+                throw new Components.Exception(&quot;Invalid action specified&quot;, Cr.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l83.57"></a><span id="l83.57">         }</span>
<a href="#l83.58"></a><span id="l83.58">     },</span>
<a href="#l83.59"></a><span id="l83.59"> </span>
<a href="#l83.60"></a><span id="l83.60">     undoTransaction: function() {</span>
<a href="#l83.61"></a><span id="l83.61">         this.mIsDoTransaction = false;</span>
<a href="#l83.62"></a><span id="l83.62">         switch (this.mAction) {</span>
<a href="#l83.63"></a><span id="l83.63">             case &quot;add&quot;:</span>
<a href="#l83.64"></a><span id="l83.64">                 this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l83.65"></a><span id="l83.65" class="difflineat">@@ -178,18 +177,17 @@ calTransaction.prototype = {</span>
<a href="#l83.66"></a><span id="l83.66">                     this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l83.67"></a><span id="l83.67">                     this.mOldCalendar.addItem(this.mOldItem, this);</span>
<a href="#l83.68"></a><span id="l83.68">                 }</span>
<a href="#l83.69"></a><span id="l83.69">                 break;</span>
<a href="#l83.70"></a><span id="l83.70">             case &quot;delete&quot;:</span>
<a href="#l83.71"></a><span id="l83.71">                 this.mCalendar.addItem(this.mItem, this);</span>
<a href="#l83.72"></a><span id="l83.72">                 break;</span>
<a href="#l83.73"></a><span id="l83.73">             default:</span>
<a href="#l83.74"></a><span id="l83.74" class="difflineminus">-                throw new Components.Exception(&quot;Invalid action specified&quot;,</span>
<a href="#l83.75"></a><span id="l83.75" class="difflineminus">-                                               Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l83.76"></a><span id="l83.76" class="difflineplus">+                throw new Components.Exception(&quot;Invalid action specified&quot;, Cr.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l83.77"></a><span id="l83.77">         }</span>
<a href="#l83.78"></a><span id="l83.78">     },</span>
<a href="#l83.79"></a><span id="l83.79"> </span>
<a href="#l83.80"></a><span id="l83.80">     redoTransaction: function() {</span>
<a href="#l83.81"></a><span id="l83.81">         this.doTransaction();</span>
<a href="#l83.82"></a><span id="l83.82">     },</span>
<a href="#l83.83"></a><span id="l83.83"> </span>
<a href="#l83.84"></a><span id="l83.84">     isTransient: false,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/calendar/import-export/calHtmlExport.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/calendar/import-export/calHtmlExport.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -93,14 +93,14 @@ calHtmlExporter.prototype = {</span>
<a href="#l84.4"></a><span id="l84.4"> </span>
<a href="#l84.5"></a><span id="l84.5">             itemContainer.appendChild(itemNode);</span>
<a href="#l84.6"></a><span id="l84.6">         }</span>
<a href="#l84.7"></a><span id="l84.7"> </span>
<a href="#l84.8"></a><span id="l84.8">         let templates = document.getElementById(&quot;templates&quot;);</span>
<a href="#l84.9"></a><span id="l84.9">         templates.remove();</span>
<a href="#l84.10"></a><span id="l84.10"> </span>
<a href="#l84.11"></a><span id="l84.11">         // Convert the javascript string to an array of bytes, using the utf8 encoder</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-        let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineplus">+        let convStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l84.15"></a><span id="l84.15" class="difflineplus">+                           .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l84.16"></a><span id="l84.16">         convStream.init(aStream, &quot;UTF-8&quot;);</span>
<a href="#l84.17"></a><span id="l84.17">         convStream.writeString(cal.xml.serializeDOM(document));</span>
<a href="#l84.18"></a><span id="l84.18">     }</span>
<a href="#l84.19"></a><span id="l84.19"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/calendar/import-export/calIcsImportExport.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/calendar/import-export/calIcsImportExport.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -26,18 +26,18 @@ function calIcsImporter() {</span>
<a href="#l85.4"></a><span id="l85.4"> </span>
<a href="#l85.5"></a><span id="l85.5"> calIcsImporter.prototype = {</span>
<a href="#l85.6"></a><span id="l85.6">     QueryInterface: ChromeUtils.generateQI([Ci.calIImporter]),</span>
<a href="#l85.7"></a><span id="l85.7">     classID: Components.ID(&quot;{1e3e33dc-445a-49de-b2b6-15b2a050bb9d}&quot;),</span>
<a href="#l85.8"></a><span id="l85.8"> </span>
<a href="#l85.9"></a><span id="l85.9">     getFileTypes: getIcsFileTypes,</span>
<a href="#l85.10"></a><span id="l85.10"> </span>
<a href="#l85.11"></a><span id="l85.11">     importFromStream: function(aStream, aCount) {</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineplus">+                       .createInstance(Ci.calIIcsParser);</span>
<a href="#l85.16"></a><span id="l85.16">         parser.parseFromStream(aStream, null);</span>
<a href="#l85.17"></a><span id="l85.17">         return parser.getItems(aCount);</span>
<a href="#l85.18"></a><span id="l85.18">     }</span>
<a href="#l85.19"></a><span id="l85.19"> };</span>
<a href="#l85.20"></a><span id="l85.20"> </span>
<a href="#l85.21"></a><span id="l85.21"> // Exporter</span>
<a href="#l85.22"></a><span id="l85.22"> function calIcsExporter() {</span>
<a href="#l85.23"></a><span id="l85.23">     this.wrappedJSObject = this;</span>
<a href="#l85.24"></a><span id="l85.24" class="difflineat">@@ -45,14 +45,14 @@ function calIcsExporter() {</span>
<a href="#l85.25"></a><span id="l85.25"> </span>
<a href="#l85.26"></a><span id="l85.26"> calIcsExporter.prototype = {</span>
<a href="#l85.27"></a><span id="l85.27">     QueryInterface: ChromeUtils.generateQI([Ci.calIExporter]),</span>
<a href="#l85.28"></a><span id="l85.28">     classID: Components.ID(&quot;{a6a524ce-adff-4a0f-bb7d-d1aaad4adc60}&quot;),</span>
<a href="#l85.29"></a><span id="l85.29"> </span>
<a href="#l85.30"></a><span id="l85.30">     getFileTypes: getIcsFileTypes,</span>
<a href="#l85.31"></a><span id="l85.31"> </span>
<a href="#l85.32"></a><span id="l85.32">     exportToStream: function(aStream, aCount, aItems) {</span>
<a href="#l85.33"></a><span id="l85.33" class="difflineminus">-        let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l85.34"></a><span id="l85.34" class="difflineminus">-                                   .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l85.35"></a><span id="l85.35" class="difflineplus">+        let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l85.36"></a><span id="l85.36" class="difflineplus">+                           .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l85.37"></a><span id="l85.37">         serializer.addItems(aItems, aItems.length);</span>
<a href="#l85.38"></a><span id="l85.38">         serializer.serializeToStream(aStream);</span>
<a href="#l85.39"></a><span id="l85.39">     }</span>
<a href="#l85.40"></a><span id="l85.40"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/calendar/import-export/calListFormatter.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/calendar/import-export/calListFormatter.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -13,13 +13,13 @@ function calListFormatter() {</span>
<a href="#l86.4"></a><span id="l86.4"> </span>
<a href="#l86.5"></a><span id="l86.5"> calListFormatter.prototype = {</span>
<a href="#l86.6"></a><span id="l86.6">     QueryInterface: ChromeUtils.generateQI([Ci.calIPrintFormatter]),</span>
<a href="#l86.7"></a><span id="l86.7">     classID: Components.ID(&quot;{9ae04413-fee3-45b9-8bbb-1eb39a4cbd1b}&quot;),</span>
<a href="#l86.8"></a><span id="l86.8"> </span>
<a href="#l86.9"></a><span id="l86.9">     get name() { return cal.l10n.getCalString(&quot;formatListName&quot;); },</span>
<a href="#l86.10"></a><span id="l86.10"> </span>
<a href="#l86.11"></a><span id="l86.11">     formatToHtml: function(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-        let htmlexporter = Components.classes[&quot;@mozilla.org/calendar/export;1?type=htmllist&quot;]</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineminus">-                                     .createInstance(Components.interfaces.calIExporter);</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineplus">+        let htmlexporter = Cc[&quot;@mozilla.org/calendar/export;1?type=htmllist&quot;]</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineplus">+                             .createInstance(Ci.calIExporter);</span>
<a href="#l86.16"></a><span id="l86.16">         htmlexporter.exportToStream(aStream, aCount, aItems, aTitle);</span>
<a href="#l86.17"></a><span id="l86.17">     }</span>
<a href="#l86.18"></a><span id="l86.18"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -83,18 +83,18 @@ calMonthPrinter.prototype = {</span>
<a href="#l87.4"></a><span id="l87.4">         }</span>
<a href="#l87.5"></a><span id="l87.5"> </span>
<a href="#l87.6"></a><span id="l87.6">         // Remove templates from HTML, no longer needed</span>
<a href="#l87.7"></a><span id="l87.7">         let templates = document.getElementById(&quot;templates&quot;);</span>
<a href="#l87.8"></a><span id="l87.8">         templates.remove();</span>
<a href="#l87.9"></a><span id="l87.9"> </span>
<a href="#l87.10"></a><span id="l87.10">         // Stream out the resulting HTML</span>
<a href="#l87.11"></a><span id="l87.11">         let html = cal.xml.serializeDOM(document);</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-        let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l87.14"></a><span id="l87.14" class="difflineplus">+        let convStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l87.15"></a><span id="l87.15" class="difflineplus">+                           .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l87.16"></a><span id="l87.16">         convStream.init(aStream, &quot;UTF-8&quot;);</span>
<a href="#l87.17"></a><span id="l87.17">         convStream.writeString(html);</span>
<a href="#l87.18"></a><span id="l87.18">     },</span>
<a href="#l87.19"></a><span id="l87.19"> </span>
<a href="#l87.20"></a><span id="l87.20">     normalizeStartDate: function(aStart) {</span>
<a href="#l87.21"></a><span id="l87.21">         // Make sure the start date is really a date.</span>
<a href="#l87.22"></a><span id="l87.22">         let startDate = aStart.clone();</span>
<a href="#l87.23"></a><span id="l87.23">         startDate.isDate = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -110,18 +110,18 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l88.4"></a><span id="l88.4">      *</span>
<a href="#l88.5"></a><span id="l88.5">      * The rest of the lines are events, one event per line, with fields in the</span>
<a href="#l88.6"></a><span id="l88.6">      * order descibed by the first line.   All non-empty values must be quoted.</span>
<a href="#l88.7"></a><span id="l88.7">      *</span>
<a href="#l88.8"></a><span id="l88.8">      * Returns: an array of parsed calendarEvents.</span>
<a href="#l88.9"></a><span id="l88.9">      *   If the parse is cancelled, a zero length array is returned.</span>
<a href="#l88.10"></a><span id="l88.10">      */</span>
<a href="#l88.11"></a><span id="l88.11">     importFromStream: function(aStream, aCount) {</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-        let scriptableInputStream = Components.classes[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineminus">-                                              .createInstance(Components.interfaces.nsIScriptableInputStream);</span>
<a href="#l88.14"></a><span id="l88.14" class="difflineplus">+        let scriptableInputStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l88.15"></a><span id="l88.15" class="difflineplus">+                                      .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l88.16"></a><span id="l88.16">         scriptableInputStream.init(aStream);</span>
<a href="#l88.17"></a><span id="l88.17">         let str = scriptableInputStream.read(-1);</span>
<a href="#l88.18"></a><span id="l88.18"> </span>
<a href="#l88.19"></a><span id="l88.19">         // parse header line of quoted comma separated column names.</span>
<a href="#l88.20"></a><span id="l88.20">         let trimEndQuotesRegExp = /^&quot;(.*)&quot;$/m;</span>
<a href="#l88.21"></a><span id="l88.21">         let trimResults = trimEndQuotesRegExp.exec(str);</span>
<a href="#l88.22"></a><span id="l88.22">         let header = trimResults &amp;&amp; trimResults[1].split(/&quot;,&quot;/);</span>
<a href="#l88.23"></a><span id="l88.23">         if (header == null) {</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineat">@@ -463,17 +463,17 @@ calOutlookCSVExporter.prototype = {</span>
<a href="#l88.25"></a><span id="l88.25">             line.push(txtString(cal.category.arrayToString(item.getCategories({})))); // xxx todo: what's the correct way to encode ',' in csv?, how are multi-values expressed?</span>
<a href="#l88.26"></a><span id="l88.26">             line.push(txtString(item.getProperty(&quot;DESCRIPTION&quot;)));</span>
<a href="#l88.27"></a><span id="l88.27">             line.push(txtString(item.getProperty(&quot;LOCATION&quot;)));</span>
<a href="#l88.28"></a><span id="l88.28">             line.push(item.privacy == &quot;PRIVATE&quot; ? localeEn.valueTrue : localeEn.valueFalse);</span>
<a href="#l88.29"></a><span id="l88.29"> </span>
<a href="#l88.30"></a><span id="l88.30">             line = line.map(value =&gt; `&quot;${String(value).replace(/&quot;/g, '&quot;&quot;')}&quot;`);</span>
<a href="#l88.31"></a><span id="l88.31">             str = line.join(&quot;,&quot;) + exportLineEnding;</span>
<a href="#l88.32"></a><span id="l88.32"> </span>
<a href="#l88.33"></a><span id="l88.33" class="difflineminus">-            let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l88.34"></a><span id="l88.34" class="difflineminus">-                                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l88.35"></a><span id="l88.35" class="difflineplus">+            let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l88.36"></a><span id="l88.36" class="difflineplus">+                              .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l88.37"></a><span id="l88.37">             converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l88.38"></a><span id="l88.38">             str = converter.ConvertFromUnicode(str);</span>
<a href="#l88.39"></a><span id="l88.39"> </span>
<a href="#l88.40"></a><span id="l88.40">             aStream.write(str, str.length);</span>
<a href="#l88.41"></a><span id="l88.41">         }</span>
<a href="#l88.42"></a><span id="l88.42">     }</span>
<a href="#l88.43"></a><span id="l88.43"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/calendar/import-export/calWeekPrinter.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/calendar/import-export/calWeekPrinter.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -70,18 +70,18 @@ calWeekPrinter.prototype = {</span>
<a href="#l89.4"></a><span id="l89.4">         }</span>
<a href="#l89.5"></a><span id="l89.5"> </span>
<a href="#l89.6"></a><span id="l89.6">         // Remove templates from HTML, no longer needed</span>
<a href="#l89.7"></a><span id="l89.7">         let templates = document.getElementById(&quot;templates&quot;);</span>
<a href="#l89.8"></a><span id="l89.8">         templates.remove();</span>
<a href="#l89.9"></a><span id="l89.9"> </span>
<a href="#l89.10"></a><span id="l89.10">         // Stream out the resulting HTML</span>
<a href="#l89.11"></a><span id="l89.11">         let html = cal.xml.serializeDOM(document);</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-        let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineplus">+        let convStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineplus">+                           .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l89.16"></a><span id="l89.16">         convStream.init(aStream, &quot;UTF-8&quot;);</span>
<a href="#l89.17"></a><span id="l89.17">         convStream.writeString(html);</span>
<a href="#l89.18"></a><span id="l89.18">     },</span>
<a href="#l89.19"></a><span id="l89.19"> </span>
<a href="#l89.20"></a><span id="l89.20">     setupWeek: function(document, startOfWeek, dayTable) {</span>
<a href="#l89.21"></a><span id="l89.21">         const weekdayMap = [&quot;sunday&quot;, &quot;monday&quot;, &quot;tuesday&quot;, &quot;wednesday&quot;, &quot;thursday&quot;, &quot;friday&quot;, &quot;saturday&quot;];</span>
<a href="#l89.22"></a><span id="l89.22"> </span>
<a href="#l89.23"></a><span id="l89.23">         let weekTemplate = document.getElementById(&quot;week-template&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -236,23 +236,23 @@ calItipEmailTransport.prototype = {</span>
<a href="#l90.4"></a><span id="l90.4">                 };</span>
<a href="#l90.5"></a><span id="l90.5">                 let toMap = aToList.map(cbEmail).filter(value =&gt; value.length);</span>
<a href="#l90.6"></a><span id="l90.6">                 if (toMap.length &lt; aToList.length) {</span>
<a href="#l90.7"></a><span id="l90.7">                     // at least one invalid recipient, so we skip sending for this message</span>
<a href="#l90.8"></a><span id="l90.8">                     return false;</span>
<a href="#l90.9"></a><span id="l90.9">                 }</span>
<a href="#l90.10"></a><span id="l90.10">                 let toList = toMap.join(&quot;, &quot;);</span>
<a href="#l90.11"></a><span id="l90.11">                 let composeUtils = Cc[&quot;@mozilla.org/messengercompose/computils;1&quot;]</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-                                   .createInstance(Ci.nsIMsgCompUtils);</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+                                     .createInstance(Ci.nsIMsgCompUtils);</span>
<a href="#l90.14"></a><span id="l90.14">                 let messageId = composeUtils.msgGenerateMessageId(identity);</span>
<a href="#l90.15"></a><span id="l90.15">                 let mailFile = this._createTempImipFile(toList, aSubject, aBody, aItipItem, identity, messageId);</span>
<a href="#l90.16"></a><span id="l90.16">                 if (mailFile) {</span>
<a href="#l90.17"></a><span id="l90.17">                     // compose fields for message: from/to etc need to be specified both here and in the file</span>
<a href="#l90.18"></a><span id="l90.18">                     let composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l90.19"></a><span id="l90.19" class="difflineminus">-                                        .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l90.20"></a><span id="l90.20" class="difflineplus">+                                          .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l90.21"></a><span id="l90.21">                     composeFields.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l90.22"></a><span id="l90.22">                     composeFields.to = toList;</span>
<a href="#l90.23"></a><span id="l90.23">                     let mailfrom = (identity.fullName.length ? identity.fullName + &quot; &lt;&quot; + identity.email + &quot;&gt;&quot; : identity.email);</span>
<a href="#l90.24"></a><span id="l90.24">                     composeFields.from = (cal.email.validateRecipientList(mailfrom) == mailfrom ? mailfrom : identity.email);</span>
<a href="#l90.25"></a><span id="l90.25">                     composeFields.replyTo = identity.replyTo;</span>
<a href="#l90.26"></a><span id="l90.26">                     composeFields.organization = identity.organization;</span>
<a href="#l90.27"></a><span id="l90.27">                     composeFields.messageId = messageId;</span>
<a href="#l90.28"></a><span id="l90.28">                     let validRecipients;</span>
<a href="#l90.29"></a><span id="l90.29" class="difflineat">@@ -269,18 +269,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l90.30"></a><span id="l90.30">                             composeFields.bcc = validRecipients;</span>
<a href="#l90.31"></a><span id="l90.31">                         }</span>
<a href="#l90.32"></a><span id="l90.32">                     }</span>
<a href="#l90.33"></a><span id="l90.33"> </span>
<a href="#l90.34"></a><span id="l90.34">                     // xxx todo: add send/progress UI, maybe recycle</span>
<a href="#l90.35"></a><span id="l90.35">                     //           &quot;@mozilla.org/messengercompose/composesendlistener;1&quot;</span>
<a href="#l90.36"></a><span id="l90.36">                     //           and/or &quot;chrome://messenger/content/messengercompose/sendProgress.xul&quot;</span>
<a href="#l90.37"></a><span id="l90.37">                     // i.e. bug 432662</span>
<a href="#l90.38"></a><span id="l90.38" class="difflineminus">-                    let msgSend = Cc[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l90.39"></a><span id="l90.39" class="difflineminus">-                                  .createInstance(Ci.nsIMsgSend);</span>
<a href="#l90.40"></a><span id="l90.40" class="difflineplus">+                    let msgSend = Cc[&quot;@mozilla.org/messengercompose/send;1&quot;].createInstance(Ci.nsIMsgSend);</span>
<a href="#l90.41"></a><span id="l90.41">                     msgSend.sendMessageFile(identity,</span>
<a href="#l90.42"></a><span id="l90.42">                                             account.key,</span>
<a href="#l90.43"></a><span id="l90.43">                                             composeFields,</span>
<a href="#l90.44"></a><span id="l90.44">                                             mailFile,</span>
<a href="#l90.45"></a><span id="l90.45">                                             true,  // deleteSendFileOnCompletion</span>
<a href="#l90.46"></a><span id="l90.46">                                             false, // digest_p</span>
<a href="#l90.47"></a><span id="l90.47">                                             (Services.io.offline ? Ci.nsIMsgSend.nsMsgQueueForLater</span>
<a href="#l90.48"></a><span id="l90.48">                                                     : Ci.nsIMsgSend.nsMsgDeliverNow),</span>
<a href="#l90.49"></a><span id="l90.49" class="difflineat">@@ -307,17 +306,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l90.50"></a><span id="l90.50">         }</span>
<a href="#l90.51"></a><span id="l90.51">         return false;</span>
<a href="#l90.52"></a><span id="l90.52">     },</span>
<a href="#l90.53"></a><span id="l90.53"> </span>
<a href="#l90.54"></a><span id="l90.54">     _createTempImipFile: function(aToList, aSubject, aBody, aItipItem, aIdentity, aMessageId) {</span>
<a href="#l90.55"></a><span id="l90.55">         try {</span>
<a href="#l90.56"></a><span id="l90.56">             let itemList = aItipItem.getItemList({});</span>
<a href="#l90.57"></a><span id="l90.57">             let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l90.58"></a><span id="l90.58" class="difflineminus">-                             .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l90.59"></a><span id="l90.59" class="difflineplus">+                               .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l90.60"></a><span id="l90.60">             serializer.addItems(itemList, itemList.length);</span>
<a href="#l90.61"></a><span id="l90.61">             let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l90.62"></a><span id="l90.62">             methodProp.value = aItipItem.responseMethod;</span>
<a href="#l90.63"></a><span id="l90.63">             serializer.addProperty(methodProp);</span>
<a href="#l90.64"></a><span id="l90.64">             let calText = serializer.serializeToString();</span>
<a href="#l90.65"></a><span id="l90.65">             let utf8CalText = ltn.invitation.encodeUTF8(calText);</span>
<a href="#l90.66"></a><span id="l90.66"> </span>
<a href="#l90.67"></a><span id="l90.67">             // Home-grown mail composition; I'd love to use nsIMimeEmitter, but it's not clear to me whether</span>
<a href="#l90.68"></a><span id="l90.68" class="difflineat">@@ -355,17 +354,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l90.69"></a><span id="l90.69">             cal.LOG(&quot;mail text:\n&quot; + mailText);</span>
<a href="#l90.70"></a><span id="l90.70"> </span>
<a href="#l90.71"></a><span id="l90.71">             let tempFile = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l90.72"></a><span id="l90.72">             tempFile.append(&quot;itipTemp&quot;);</span>
<a href="#l90.73"></a><span id="l90.73">             tempFile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l90.74"></a><span id="l90.74">                                   parseInt(&quot;0600&quot;, 8));</span>
<a href="#l90.75"></a><span id="l90.75"> </span>
<a href="#l90.76"></a><span id="l90.76">             let outputStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l90.77"></a><span id="l90.77" class="difflineminus">-                               .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l90.78"></a><span id="l90.78" class="difflineplus">+                                 .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l90.79"></a><span id="l90.79">             // Let's write the file - constants from file-utils.js</span>
<a href="#l90.80"></a><span id="l90.80">             const MODE_WRONLY = 0x02;</span>
<a href="#l90.81"></a><span id="l90.81">             const MODE_CREATE = 0x08;</span>
<a href="#l90.82"></a><span id="l90.82">             const MODE_TRUNCATE = 0x20;</span>
<a href="#l90.83"></a><span id="l90.83">             outputStream.init(tempFile,</span>
<a href="#l90.84"></a><span id="l90.84">                               MODE_WRONLY | MODE_CREATE | MODE_TRUNCATE,</span>
<a href="#l90.85"></a><span id="l90.85">                               parseInt(&quot;0600&quot;, 8),</span>
<a href="#l90.86"></a><span id="l90.86">                               0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/calendar/lightning/components/calItipProtocolHandler.js</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/calendar/lightning/components/calItipProtocolHandler.js</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -6,17 +6,17 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l91.4"></a><span id="l91.4"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l91.5"></a><span id="l91.5"> </span>
<a href="#l91.6"></a><span id="l91.6"> var ITIP_HANDLER_MIMETYPE = &quot;application/x-itip-internal&quot;;</span>
<a href="#l91.7"></a><span id="l91.7"> var ITIP_HANDLER_PROTOCOL = &quot;moz-cal-handle-itip&quot;;</span>
<a href="#l91.8"></a><span id="l91.8"> var NS_ERROR_WONT_HANDLE_CONTENT = 0x805d0001;</span>
<a href="#l91.9"></a><span id="l91.9"> </span>
<a href="#l91.10"></a><span id="l91.10"> </span>
<a href="#l91.11"></a><span id="l91.11"> function NYI() {</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-    throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l91.14"></a><span id="l91.14"> }</span>
<a href="#l91.15"></a><span id="l91.15"> </span>
<a href="#l91.16"></a><span id="l91.16"> function ItipChannel(URI) {</span>
<a href="#l91.17"></a><span id="l91.17">     this.wrappedJSObject = this;</span>
<a href="#l91.18"></a><span id="l91.18">     this.URI = this.originalURI = URI;</span>
<a href="#l91.19"></a><span id="l91.19"> }</span>
<a href="#l91.20"></a><span id="l91.20"> ItipChannel.prototype = {</span>
<a href="#l91.21"></a><span id="l91.21">     QueryInterface: ChromeUtils.generateQI([Ci.nsIChannel, Ci.nsIRequest]),</span>
<a href="#l91.22"></a><span id="l91.22" class="difflineat">@@ -34,17 +34,17 @@ ItipChannel.prototype = {</span>
<a href="#l91.23"></a><span id="l91.23">     asyncOpen: function(observer, ctxt) {</span>
<a href="#l91.24"></a><span id="l91.24">         observer.onStartRequest(this, ctxt);</span>
<a href="#l91.25"></a><span id="l91.25">     },</span>
<a href="#l91.26"></a><span id="l91.26">     asyncRead: function(listener, ctxt) {</span>
<a href="#l91.27"></a><span id="l91.27">         return listener.onStartRequest(this, ctxt);</span>
<a href="#l91.28"></a><span id="l91.28">     },</span>
<a href="#l91.29"></a><span id="l91.29"> </span>
<a href="#l91.30"></a><span id="l91.30">     isPending: function() { return true; },</span>
<a href="#l91.31"></a><span id="l91.31" class="difflineminus">-    status: Components.results.NS_OK,</span>
<a href="#l91.32"></a><span id="l91.32" class="difflineplus">+    status: Cr.NS_OK,</span>
<a href="#l91.33"></a><span id="l91.33">     cancel: function(status) { this.status = status; },</span>
<a href="#l91.34"></a><span id="l91.34">     suspend: NYI,</span>
<a href="#l91.35"></a><span id="l91.35">     resume: NYI,</span>
<a href="#l91.36"></a><span id="l91.36"> };</span>
<a href="#l91.37"></a><span id="l91.37"> </span>
<a href="#l91.38"></a><span id="l91.38"> function ItipProtocolHandler() {</span>
<a href="#l91.39"></a><span id="l91.39">     this.wrappedJSObject = this;</span>
<a href="#l91.40"></a><span id="l91.40"> }</span>
<a href="#l91.41"></a><span id="l91.41" class="difflineat">@@ -52,21 +52,20 @@ ItipProtocolHandler.prototype = {</span>
<a href="#l91.42"></a><span id="l91.42">     QueryInterface: ChromeUtils.generateQI([Ci.nsIProtocolHandler]),</span>
<a href="#l91.43"></a><span id="l91.43">     classID: Components.ID(&quot;{6e957006-b4ce-11d9-b053-001124736B74}&quot;),</span>
<a href="#l91.44"></a><span id="l91.44"> </span>
<a href="#l91.45"></a><span id="l91.45">     protocolFlags: Ci.nsIProtocolHandler.URI_NORELATIVE | Ci.nsIProtocolHandler.URI_DANGEROUS_TO_LOAD,</span>
<a href="#l91.46"></a><span id="l91.46">     allowPort: () =&gt; false,</span>
<a href="#l91.47"></a><span id="l91.47">     isSecure: false,</span>
<a href="#l91.48"></a><span id="l91.48">     newURI: function(spec, charSet, baseURI) {</span>
<a href="#l91.49"></a><span id="l91.49">         dump(&quot;Creating new URI for &quot; + spec + &quot;\n&quot;);</span>
<a href="#l91.50"></a><span id="l91.50" class="difflineminus">-        return Components.classes[&quot;@mozilla.org/network/standard-url-mutator;1&quot;]</span>
<a href="#l91.51"></a><span id="l91.51" class="difflineminus">-                         .createInstance(Ci.nsIStandardURLMutator)</span>
<a href="#l91.52"></a><span id="l91.52" class="difflineminus">-                         .init(Ci.nsIStandardURL.URLTYPE_STANDARD, 0,</span>
<a href="#l91.53"></a><span id="l91.53" class="difflineminus">-                               spec, charSet, baseURI)</span>
<a href="#l91.54"></a><span id="l91.54" class="difflineminus">-                         .finalize();</span>
<a href="#l91.55"></a><span id="l91.55" class="difflineplus">+        return Cc[&quot;@mozilla.org/network/standard-url-mutator;1&quot;]</span>
<a href="#l91.56"></a><span id="l91.56" class="difflineplus">+                 .createInstance(Ci.nsIStandardURLMutator)</span>
<a href="#l91.57"></a><span id="l91.57" class="difflineplus">+                 .init(Ci.nsIStandardURL.URLTYPE_STANDARD, 0, spec, charSet, baseURI)</span>
<a href="#l91.58"></a><span id="l91.58" class="difflineplus">+                 .finalize();</span>
<a href="#l91.59"></a><span id="l91.59">     },</span>
<a href="#l91.60"></a><span id="l91.60"> </span>
<a href="#l91.61"></a><span id="l91.61">     newChannel: function(URI) {</span>
<a href="#l91.62"></a><span id="l91.62">         return this.newChannel2(URI, null);</span>
<a href="#l91.63"></a><span id="l91.63">     },</span>
<a href="#l91.64"></a><span id="l91.64"> </span>
<a href="#l91.65"></a><span id="l91.65">     newChannel2: function(URI, aLoadInfo) {</span>
<a href="#l91.66"></a><span id="l91.66">         dump(&quot;Creating new ItipChannel for &quot; + URI + &quot;\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -13,18 +13,17 @@ function ltnMimeConverter() {</span>
<a href="#l92.4"></a><span id="l92.4"> </span>
<a href="#l92.5"></a><span id="l92.5"> ltnMimeConverter.prototype = {</span>
<a href="#l92.6"></a><span id="l92.6">     QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleMimeConverter]),</span>
<a href="#l92.7"></a><span id="l92.7">     classID: Components.ID(&quot;{c70acb08-464e-4e55-899d-b2c84c5409fa}&quot;),</span>
<a href="#l92.8"></a><span id="l92.8"> </span>
<a href="#l92.9"></a><span id="l92.9">     uri: null,</span>
<a href="#l92.10"></a><span id="l92.10"> </span>
<a href="#l92.11"></a><span id="l92.11">     convertToHTML: function(contentType, data) {</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l92.14"></a><span id="l92.14" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l92.15"></a><span id="l92.15">         parser.parseString(data);</span>
<a href="#l92.16"></a><span id="l92.16">         let event = null;</span>
<a href="#l92.17"></a><span id="l92.17">         for (let item of parser.getItems({})) {</span>
<a href="#l92.18"></a><span id="l92.18">             if (cal.item.isEvent(item)) {</span>
<a href="#l92.19"></a><span id="l92.19">                 if (item.hasProperty(&quot;X-MOZ-FAKED-MASTER&quot;)) {</span>
<a href="#l92.20"></a><span id="l92.20">                     // if it's a faked master, take any overridden item to get a real occurrence:</span>
<a href="#l92.21"></a><span id="l92.21">                     let exc = item.recurrenceInfo.getExceptionFor(item.startDate);</span>
<a href="#l92.22"></a><span id="l92.22">                     cal.ASSERT(exc, &quot;unexpected!&quot;);</span>
<a href="#l92.23"></a><span id="l92.23" class="difflineat">@@ -39,25 +38,24 @@ ltnMimeConverter.prototype = {</span>
<a href="#l92.24"></a><span id="l92.24">         if (!event) {</span>
<a href="#l92.25"></a><span id="l92.25">             return &quot;&quot;;</span>
<a href="#l92.26"></a><span id="l92.26">         }</span>
<a href="#l92.27"></a><span id="l92.27"> </span>
<a href="#l92.28"></a><span id="l92.28">         let itipItem = null;</span>
<a href="#l92.29"></a><span id="l92.29">         let msgOverlay = &quot;&quot;;</span>
<a href="#l92.30"></a><span id="l92.30">         let msgWindow = null;</span>
<a href="#l92.31"></a><span id="l92.31"> </span>
<a href="#l92.32"></a><span id="l92.32" class="difflineminus">-        itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l92.33"></a><span id="l92.33" class="difflineminus">-                             .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l92.34"></a><span id="l92.34" class="difflineplus">+        itipItem = Cc[&quot;@mozilla.org/calendar/itip-item;1&quot;].createInstance(Ci.calIItipItem);</span>
<a href="#l92.35"></a><span id="l92.35">         itipItem.init(data);</span>
<a href="#l92.36"></a><span id="l92.36"> </span>
<a href="#l92.37"></a><span id="l92.37">         // this.uri is the message URL that we are processing.</span>
<a href="#l92.38"></a><span id="l92.38">         // We use it to get the nsMsgHeaderSink to store the calItipItem.</span>
<a href="#l92.39"></a><span id="l92.39">         if (this.uri) {</span>
<a href="#l92.40"></a><span id="l92.40">             try {</span>
<a href="#l92.41"></a><span id="l92.41" class="difflineminus">-                let msgUrl = this.uri.QueryInterface(Components.interfaces.nsIMsgMailNewsUrl);</span>
<a href="#l92.42"></a><span id="l92.42" class="difflineplus">+                let msgUrl = this.uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l92.43"></a><span id="l92.43">                 msgWindow = msgUrl.msgWindow;</span>
<a href="#l92.44"></a><span id="l92.44">                 itipItem.sender = msgUrl.mimeHeaders.extractHeader(&quot;From&quot;, false);</span>
<a href="#l92.45"></a><span id="l92.45">             } catch (exc) {</span>
<a href="#l92.46"></a><span id="l92.46">                 // msgWindow is optional in some scenarios</span>
<a href="#l92.47"></a><span id="l92.47">                 // (e.g. gloda in action, throws NS_ERROR_INVALID_POINTER then)</span>
<a href="#l92.48"></a><span id="l92.48">             }</span>
<a href="#l92.49"></a><span id="l92.49">         }</span>
<a href="#l92.50"></a><span id="l92.50"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar.js</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar.js</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -82,18 +82,17 @@ var ltnImipBar = {</span>
<a href="#l93.4"></a><span id="l93.4">     observe: function(subject, topic, state) {</span>
<a href="#l93.5"></a><span id="l93.5">         if (topic == &quot;onItipItemCreation&quot;) {</span>
<a href="#l93.6"></a><span id="l93.6">             let itipItem = null;</span>
<a href="#l93.7"></a><span id="l93.7">             let msgOverlay = null;</span>
<a href="#l93.8"></a><span id="l93.8">             try {</span>
<a href="#l93.9"></a><span id="l93.9">                 if (!subject) {</span>
<a href="#l93.10"></a><span id="l93.10">                     let sinkProps = msgWindow.msgHeaderSink.properties;</span>
<a href="#l93.11"></a><span id="l93.11">                     // This property was set by lightningTextCalendarConverter.js</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-                    itipItem = sinkProps.getPropertyAsInterface(&quot;itipItem&quot;,</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineminus">-                                                                Components.interfaces.calIItipItem);</span>
<a href="#l93.14"></a><span id="l93.14" class="difflineplus">+                    itipItem = sinkProps.getPropertyAsInterface(&quot;itipItem&quot;, Ci.calIItipItem);</span>
<a href="#l93.15"></a><span id="l93.15">                     msgOverlay = sinkProps.getPropertyAsAUTF8String(&quot;msgOverlay&quot;);</span>
<a href="#l93.16"></a><span id="l93.16">                 }</span>
<a href="#l93.17"></a><span id="l93.17">             } catch (e) {</span>
<a href="#l93.18"></a><span id="l93.18">                 // This will throw on every message viewed that doesn't have the</span>
<a href="#l93.19"></a><span id="l93.19">                 // itipItem property set on it. So we eat the errors and move on.</span>
<a href="#l93.20"></a><span id="l93.20"> </span>
<a href="#l93.21"></a><span id="l93.21">                 // XXX TODO: Only swallow the errors we need to. Throw all others.</span>
<a href="#l93.22"></a><span id="l93.22">             }</span>
<a href="#l93.23"></a><span id="l93.23" class="difflineat">@@ -210,22 +209,20 @@ var ltnImipBar = {</span>
<a href="#l93.24"></a><span id="l93.24">         // We need this to determine whether this is an outgoing or incoming message because</span>
<a href="#l93.25"></a><span id="l93.25">         // Thunderbird doesn't provide a distinct flag on message level to do so. Relying on</span>
<a href="#l93.26"></a><span id="l93.26">         // folder flags only may lead to false positives.</span>
<a href="#l93.27"></a><span id="l93.27">         let isOutgoing = function(aMsgHdr) {</span>
<a href="#l93.28"></a><span id="l93.28">             if (!aMsgHdr) {</span>
<a href="#l93.29"></a><span id="l93.29">                 return false;</span>
<a href="#l93.30"></a><span id="l93.30">             }</span>
<a href="#l93.31"></a><span id="l93.31">             let author = aMsgHdr.mime2DecodedAuthor;</span>
<a href="#l93.32"></a><span id="l93.32" class="difflineminus">-            let isSentFolder = aMsgHdr.folder &amp;&amp; aMsgHdr.folder.flags &amp;</span>
<a href="#l93.33"></a><span id="l93.33" class="difflineminus">-                               Components.interfaces.nsMsgFolderFlags.SentMail;</span>
<a href="#l93.34"></a><span id="l93.34" class="difflineplus">+            let isSentFolder = aMsgHdr.folder &amp;&amp; aMsgHdr.folder.flags &amp; Ci.nsMsgFolderFlags.SentMail;</span>
<a href="#l93.35"></a><span id="l93.35">             if (author &amp;&amp; isSentFolder) {</span>
<a href="#l93.36"></a><span id="l93.36">                 let accounts = MailServices.accounts;</span>
<a href="#l93.37"></a><span id="l93.37" class="difflineminus">-                for (let identity of fixIterator(accounts.allIdentities,</span>
<a href="#l93.38"></a><span id="l93.38" class="difflineminus">-                                                 Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l93.39"></a><span id="l93.39" class="difflineplus">+                for (let identity of fixIterator(accounts.allIdentities, Ci.nsIMsgIdentity)) {</span>
<a href="#l93.40"></a><span id="l93.40">                     if (author.includes(identity.email) &amp;&amp; !identity.fccReplyFollowsParent) {</span>
<a href="#l93.41"></a><span id="l93.41">                         return true;</span>
<a href="#l93.42"></a><span id="l93.42">                     }</span>
<a href="#l93.43"></a><span id="l93.43">                 }</span>
<a href="#l93.44"></a><span id="l93.44">             }</span>
<a href="#l93.45"></a><span id="l93.45">             return false;</span>
<a href="#l93.46"></a><span id="l93.46">         };</span>
<a href="#l93.47"></a><span id="l93.47"> </span>
<a href="#l93.48"></a><span id="l93.48" class="difflineat">@@ -381,17 +378,17 @@ var ltnImipBar = {</span>
<a href="#l93.49"></a><span id="l93.49">                     },</span>
<a href="#l93.50"></a><span id="l93.50">                     onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l93.51"></a><span id="l93.51">                     }</span>
<a href="#l93.52"></a><span id="l93.52">                 };</span>
<a href="#l93.53"></a><span id="l93.53"> </span>
<a href="#l93.54"></a><span id="l93.54">                 try {</span>
<a href="#l93.55"></a><span id="l93.55">                     aActionFunc(opListener, aParticipantStatus, aExtResponse);</span>
<a href="#l93.56"></a><span id="l93.56">                 } catch (exc) {</span>
<a href="#l93.57"></a><span id="l93.57" class="difflineminus">-                    Components.utils.reportError(exc);</span>
<a href="#l93.58"></a><span id="l93.58" class="difflineplus">+                    Cu.reportError(exc);</span>
<a href="#l93.59"></a><span id="l93.59">                 }</span>
<a href="#l93.60"></a><span id="l93.60">                 return true;</span>
<a href="#l93.61"></a><span id="l93.61">             }</span>
<a href="#l93.62"></a><span id="l93.62">             return false;</span>
<a href="#l93.63"></a><span id="l93.63">         }</span>
<a href="#l93.64"></a><span id="l93.64"> </span>
<a href="#l93.65"></a><span id="l93.65">         if (aParticipantStatus == null) {</span>
<a href="#l93.66"></a><span id="l93.66">             aParticipantStatus = &quot;&quot;;</span>
<a href="#l93.67"></a><span id="l93.67" class="difflineat">@@ -454,25 +451,25 @@ var ltnImipBar = {</span>
<a href="#l93.68"></a><span id="l93.68">                     null,</span>
<a href="#l93.69"></a><span id="l93.69">                     counterProposal</span>
<a href="#l93.70"></a><span id="l93.70">                 );</span>
<a href="#l93.71"></a><span id="l93.71">             }</span>
<a href="#l93.72"></a><span id="l93.72">         } else {</span>
<a href="#l93.73"></a><span id="l93.73">             let response;</span>
<a href="#l93.74"></a><span id="l93.74">             if (aResponse) {</span>
<a href="#l93.75"></a><span id="l93.75">                 if (aResponse == &quot;AUTO&quot; || aResponse == &quot;NONE&quot; || aResponse == &quot;USER&quot;) {</span>
<a href="#l93.76"></a><span id="l93.76" class="difflineminus">-                    response = { responseMode: Components.interfaces.calIItipItem[aResponse] };</span>
<a href="#l93.77"></a><span id="l93.77" class="difflineplus">+                    response = { responseMode: Ci.calIItipItem[aResponse] };</span>
<a href="#l93.78"></a><span id="l93.78">                 }</span>
<a href="#l93.79"></a><span id="l93.79">                 // Open an extended response dialog to enable the user to add a comment, make a</span>
<a href="#l93.80"></a><span id="l93.80">                 // counterproposal, delegate the event or interact in another way.</span>
<a href="#l93.81"></a><span id="l93.81">                 // Instead of a dialog, this might be implemented as a separate container inside the</span>
<a href="#l93.82"></a><span id="l93.82">                 // imip-overlay as proposed in bug 458578</span>
<a href="#l93.83"></a><span id="l93.83">             }</span>
<a href="#l93.84"></a><span id="l93.84" class="difflineminus">-            let delmgr = Components.classes[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;]</span>
<a href="#l93.85"></a><span id="l93.85" class="difflineminus">-                                   .getService(Components.interfaces.calIDeletedItems);</span>
<a href="#l93.86"></a><span id="l93.86" class="difflineplus">+            let delmgr = Cc[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;]</span>
<a href="#l93.87"></a><span id="l93.87" class="difflineplus">+                           .getService(Ci.calIDeletedItems);</span>
<a href="#l93.88"></a><span id="l93.88">             let items = ltnImipBar.itipItem.getItemList({});</span>
<a href="#l93.89"></a><span id="l93.89">             if (items &amp;&amp; items.length) {</span>
<a href="#l93.90"></a><span id="l93.90">                 let delTime = delmgr.getDeletedDate(items[0].id);</span>
<a href="#l93.91"></a><span id="l93.91">                 let dialogText = cal.l10n.getLtnString(&quot;confirmProcessInvitation&quot;);</span>
<a href="#l93.92"></a><span id="l93.92">                 let dialogTitle = cal.l10n.getLtnString(&quot;confirmProcessInvitationTitle&quot;);</span>
<a href="#l93.93"></a><span id="l93.93">                 if (delTime &amp;&amp; !Services.prompt.confirm(window, dialogTitle, dialogText)) {</span>
<a href="#l93.94"></a><span id="l93.94">                     return false;</span>
<a href="#l93.95"></a><span id="l93.95">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -64,18 +64,17 @@ var gConfig = {</span>
<a href="#l94.4"></a><span id="l94.4"> //   - gTimezoneEnabled</span>
<a href="#l94.5"></a><span id="l94.5"> //   - gShowLink</span>
<a href="#l94.6"></a><span id="l94.6"> </span>
<a href="#l94.7"></a><span id="l94.7"> var eventDialogQuitObserver = {</span>
<a href="#l94.8"></a><span id="l94.8">     observe: function(aSubject, aTopic, aData) {</span>
<a href="#l94.9"></a><span id="l94.9">         // Check whether or not we want to veto the quit request (unless another</span>
<a href="#l94.10"></a><span id="l94.10">         // observer already did.</span>
<a href="#l94.11"></a><span id="l94.11">         if (aTopic == &quot;quit-application-requested&quot; &amp;&amp;</span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-            (aSubject instanceof Components.interfaces.nsISupportsPRBool) &amp;&amp;</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineminus">-            !aSubject.data) {</span>
<a href="#l94.14"></a><span id="l94.14" class="difflineplus">+            (aSubject instanceof Ci.nsISupportsPRBool) &amp;&amp; !aSubject.data) {</span>
<a href="#l94.15"></a><span id="l94.15">             aSubject.data = !onCancel();</span>
<a href="#l94.16"></a><span id="l94.16">         }</span>
<a href="#l94.17"></a><span id="l94.17">     }</span>
<a href="#l94.18"></a><span id="l94.18"> };</span>
<a href="#l94.19"></a><span id="l94.19"> </span>
<a href="#l94.20"></a><span id="l94.20"> var eventDialogCalendarObserver = {</span>
<a href="#l94.21"></a><span id="l94.21">     target: null,</span>
<a href="#l94.22"></a><span id="l94.22">     isObserving: false,</span>
<a href="#l94.23"></a><span id="l94.23" class="difflineat">@@ -83,17 +82,17 @@ var eventDialogCalendarObserver = {</span>
<a href="#l94.24"></a><span id="l94.24">     onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l94.25"></a><span id="l94.25">         if (this.isObserving &amp;&amp; &quot;calendarItem&quot; in window &amp;&amp;</span>
<a href="#l94.26"></a><span id="l94.26">             window.calendarItem &amp;&amp; window.calendarItem.id == aOldItem.id) {</span>
<a href="#l94.27"></a><span id="l94.27">             let doUpdate = true;</span>
<a href="#l94.28"></a><span id="l94.28"> </span>
<a href="#l94.29"></a><span id="l94.29">             // The item has been modified outside the dialog. We only need to</span>
<a href="#l94.30"></a><span id="l94.30">             // prompt if there have been local changes also.</span>
<a href="#l94.31"></a><span id="l94.31">             if (isItemChanged()) {</span>
<a href="#l94.32"></a><span id="l94.32" class="difflineminus">-                let promptService = Components.interfaces.nsIPromptService;</span>
<a href="#l94.33"></a><span id="l94.33" class="difflineplus">+                let promptService = Ci.nsIPromptService;</span>
<a href="#l94.34"></a><span id="l94.34">                 let promptTitle = cal.l10n.getCalString(&quot;modifyConflictPromptTitle&quot;);</span>
<a href="#l94.35"></a><span id="l94.35">                 let promptMessage = cal.l10n.getCalString(&quot;modifyConflictPromptMessage&quot;);</span>
<a href="#l94.36"></a><span id="l94.36">                 let promptButton1 = cal.l10n.getCalString(&quot;modifyConflictPromptButton1&quot;);</span>
<a href="#l94.37"></a><span id="l94.37">                 let promptButton2 = cal.l10n.getCalString(&quot;modifyConflictPromptButton2&quot;);</span>
<a href="#l94.38"></a><span id="l94.38">                 let flags = promptService.BUTTON_TITLE_IS_STRING *</span>
<a href="#l94.39"></a><span id="l94.39">                             promptService.BUTTON_POS_0 +</span>
<a href="#l94.40"></a><span id="l94.40">                             promptService.BUTTON_TITLE_IS_STRING *</span>
<a href="#l94.41"></a><span id="l94.41">                             promptService.BUTTON_POS_1;</span>
<a href="#l94.42"></a><span id="l94.42" class="difflineat">@@ -155,17 +154,17 @@ var eventDialogCalendarObserver = {</span>
<a href="#l94.43"></a><span id="l94.43">  * Checks if the given calendar supports notifying attendees. The item is needed</span>
<a href="#l94.44"></a><span id="l94.44">  * since calendars may support notifications for only some types of items.</span>
<a href="#l94.45"></a><span id="l94.45">  *</span>
<a href="#l94.46"></a><span id="l94.46">  * @param {calICalendar} aCalendar  The calendar to check</span>
<a href="#l94.47"></a><span id="l94.47">  * @param {calIItemBase} aItem      The item to check support for</span>
<a href="#l94.48"></a><span id="l94.48">  */</span>
<a href="#l94.49"></a><span id="l94.49"> function canNotifyAttendees(aCalendar, aItem) {</span>
<a href="#l94.50"></a><span id="l94.50">     try {</span>
<a href="#l94.51"></a><span id="l94.51" class="difflineminus">-        let calendar = aCalendar.QueryInterface(Components.interfaces.calISchedulingSupport);</span>
<a href="#l94.52"></a><span id="l94.52" class="difflineplus">+        let calendar = aCalendar.QueryInterface(Ci.calISchedulingSupport);</span>
<a href="#l94.53"></a><span id="l94.53">         return (calendar.canNotify(&quot;REQUEST&quot;, aItem) &amp;&amp; calendar.canNotify(&quot;CANCEL&quot;, aItem));</span>
<a href="#l94.54"></a><span id="l94.54">     } catch (exc) {</span>
<a href="#l94.55"></a><span id="l94.55">         return false;</span>
<a href="#l94.56"></a><span id="l94.56">     }</span>
<a href="#l94.57"></a><span id="l94.57"> }</span>
<a href="#l94.58"></a><span id="l94.58"> </span>
<a href="#l94.59"></a><span id="l94.59"> /**</span>
<a href="#l94.60"></a><span id="l94.60">  * Sends an asynchronous message to the parent context that contains the</span>
<a href="#l94.61"></a><span id="l94.61" class="difflineat">@@ -458,17 +457,17 @@ function onCommandCancel() {</span>
<a href="#l94.62"></a><span id="l94.62">         return true;</span>
<a href="#l94.63"></a><span id="l94.63">     }</span>
<a href="#l94.64"></a><span id="l94.64"> </span>
<a href="#l94.65"></a><span id="l94.65">     if (gInTab &amp;&amp; gTabInfoObject) {</span>
<a href="#l94.66"></a><span id="l94.66">         // Switch to the tab that the prompt refers to.</span>
<a href="#l94.67"></a><span id="l94.67">         gTabmail.switchToTab(gTabInfoObject);</span>
<a href="#l94.68"></a><span id="l94.68">     }</span>
<a href="#l94.69"></a><span id="l94.69"> </span>
<a href="#l94.70"></a><span id="l94.70" class="difflineminus">-    let promptService = Components.interfaces.nsIPromptService;</span>
<a href="#l94.71"></a><span id="l94.71" class="difflineplus">+    let promptService = Ci.nsIPromptService;</span>
<a href="#l94.72"></a><span id="l94.72"> </span>
<a href="#l94.73"></a><span id="l94.73">     let promptTitle = cal.l10n.getCalString(</span>
<a href="#l94.74"></a><span id="l94.74">         cal.item.isEvent(window.calendarItem) ? &quot;askSaveTitleEvent&quot; : &quot;askSaveTitleTask&quot;</span>
<a href="#l94.75"></a><span id="l94.75">     );</span>
<a href="#l94.76"></a><span id="l94.76">     let promptMessage = cal.l10n.getCalString(</span>
<a href="#l94.77"></a><span id="l94.77">         cal.item.isEvent(window.calendarItem) ? &quot;askSaveMessageEvent&quot; : &quot;askSaveMessageTask&quot;</span>
<a href="#l94.78"></a><span id="l94.78">     );</span>
<a href="#l94.79"></a><span id="l94.79"> </span>
<a href="#l94.80"></a><span id="l94.80" class="difflineat">@@ -1380,17 +1379,17 @@ function getRepeatTypeAndUntilDate(aItem</span>
<a href="#l94.81"></a><span id="l94.81">         for (let ritem of ritems) {</span>
<a href="#l94.82"></a><span id="l94.82">             if (ritem.isNegative) {</span>
<a href="#l94.83"></a><span id="l94.83">                 exceptions.push(ritem);</span>
<a href="#l94.84"></a><span id="l94.84">             } else {</span>
<a href="#l94.85"></a><span id="l94.85">                 rules.push(ritem);</span>
<a href="#l94.86"></a><span id="l94.86">             }</span>
<a href="#l94.87"></a><span id="l94.87">         }</span>
<a href="#l94.88"></a><span id="l94.88">         if (rules.length == 1) {</span>
<a href="#l94.89"></a><span id="l94.89" class="difflineminus">-            let rule = cal.wrapInstance(rules[0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l94.90"></a><span id="l94.90" class="difflineplus">+            let rule = cal.wrapInstance(rules[0], Ci.calIRecurrenceRule);</span>
<a href="#l94.91"></a><span id="l94.91">             if (rule) {</span>
<a href="#l94.92"></a><span id="l94.92">                 switch (rule.type) {</span>
<a href="#l94.93"></a><span id="l94.93">                     case &quot;DAILY&quot;: {</span>
<a href="#l94.94"></a><span id="l94.94">                         let byparts = [</span>
<a href="#l94.95"></a><span id="l94.95">                             &quot;BYSECOND&quot;, &quot;BYMINUTE&quot;, &quot;BYHOUR&quot;, &quot;BYMONTHDAY&quot;,</span>
<a href="#l94.96"></a><span id="l94.96">                             &quot;BYYEARDAY&quot;, &quot;BYWEEKNO&quot;, &quot;BYMONTH&quot;, &quot;BYSETPOS&quot;</span>
<a href="#l94.97"></a><span id="l94.97">                         ];</span>
<a href="#l94.98"></a><span id="l94.98">                         if (!checkRecurrenceRule(rule, byparts)) {</span>
<a href="#l94.99"></a><span id="l94.99" class="difflineat">@@ -1663,17 +1662,17 @@ function untilDateCompensation(aItem) {</span>
<a href="#l94.100"></a><span id="l94.100">  */</span>
<a href="#l94.101"></a><span id="l94.101"> function updateTitle() {</span>
<a href="#l94.102"></a><span id="l94.102">     let strName;</span>
<a href="#l94.103"></a><span id="l94.103">     if (cal.item.isEvent(window.calendarItem)) {</span>
<a href="#l94.104"></a><span id="l94.104">         strName = (window.mode == &quot;new&quot; ? &quot;newEventDialog&quot; : &quot;editEventDialog&quot;);</span>
<a href="#l94.105"></a><span id="l94.105">     } else if (cal.item.isToDo(window.calendarItem)) {</span>
<a href="#l94.106"></a><span id="l94.106">         strName = (window.mode == &quot;new&quot; ? &quot;newTaskDialog&quot; : &quot;editTaskDialog&quot;);</span>
<a href="#l94.107"></a><span id="l94.107">     } else {</span>
<a href="#l94.108"></a><span id="l94.108" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l94.109"></a><span id="l94.109" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l94.110"></a><span id="l94.110">     }</span>
<a href="#l94.111"></a><span id="l94.111">     let newTitle = cal.l10n.getCalString(strName) + &quot;: &quot; + getElementValue(&quot;item-title&quot;);</span>
<a href="#l94.112"></a><span id="l94.112">     sendMessage({ command: &quot;updateTitle&quot;, argument: newTitle });</span>
<a href="#l94.113"></a><span id="l94.113"> }</span>
<a href="#l94.114"></a><span id="l94.114"> </span>
<a href="#l94.115"></a><span id="l94.115"> /**</span>
<a href="#l94.116"></a><span id="l94.116">  * Update the disabled status of the accept button. The button is enabled if all</span>
<a href="#l94.117"></a><span id="l94.117">  * parts of the dialog have options selected that make sense.</span>
<a href="#l94.118"></a><span id="l94.118" class="difflineat">@@ -2125,41 +2124,39 @@ function attachFileByAccountKey(aAccount</span>
<a href="#l94.119"></a><span id="l94.119">  *</span>
<a href="#l94.120"></a><span id="l94.120">  * @param cloudProvider     If set, the cloud provider will be used for attaching</span>
<a href="#l94.121"></a><span id="l94.121">  */</span>
<a href="#l94.122"></a><span id="l94.122"> function attachFile(cloudProvider) {</span>
<a href="#l94.123"></a><span id="l94.123">     if (!cloudProvider) {</span>
<a href="#l94.124"></a><span id="l94.124">         cal.ERROR(&quot;[calendar-event-dialog] Could not attach file without cloud provider&quot; + cal.STACK(10));</span>
<a href="#l94.125"></a><span id="l94.125">     }</span>
<a href="#l94.126"></a><span id="l94.126"> </span>
<a href="#l94.127"></a><span id="l94.127" class="difflineminus">-    const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l94.128"></a><span id="l94.128" class="difflineminus">-    let filePicker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l94.129"></a><span id="l94.129" class="difflineminus">-                               .createInstance(nsIFilePicker);</span>
<a href="#l94.130"></a><span id="l94.130" class="difflineplus">+    let filePicker = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l94.131"></a><span id="l94.131">     filePicker.init(window,</span>
<a href="#l94.132"></a><span id="l94.132">                     cal.l10n.getString(&quot;calendar-event-dialog&quot;, &quot;selectAFile&quot;),</span>
<a href="#l94.133"></a><span id="l94.133" class="difflineminus">-                    nsIFilePicker.modeOpenMultiple);</span>
<a href="#l94.134"></a><span id="l94.134" class="difflineplus">+                    Ci.nsIFilePicker.modeOpenMultiple);</span>
<a href="#l94.135"></a><span id="l94.135"> </span>
<a href="#l94.136"></a><span id="l94.136">     // Check for the last directory</span>
<a href="#l94.137"></a><span id="l94.137">     let lastDir = lastDirectory();</span>
<a href="#l94.138"></a><span id="l94.138">     if (lastDir) {</span>
<a href="#l94.139"></a><span id="l94.139">         filePicker.displayDirectory = lastDir;</span>
<a href="#l94.140"></a><span id="l94.140">     }</span>
<a href="#l94.141"></a><span id="l94.141"> </span>
<a href="#l94.142"></a><span id="l94.142">     filePicker.open(rv =&gt; {</span>
<a href="#l94.143"></a><span id="l94.143" class="difflineminus">-        if (rv != nsIFilePicker.returnOK || !filePicker.files) {</span>
<a href="#l94.144"></a><span id="l94.144" class="difflineplus">+        if (rv != Ci.nsIFilePicker.returnOK || !filePicker.files) {</span>
<a href="#l94.145"></a><span id="l94.145">             return;</span>
<a href="#l94.146"></a><span id="l94.146">         }</span>
<a href="#l94.147"></a><span id="l94.147">         let files = filePicker.files;</span>
<a href="#l94.148"></a><span id="l94.148"> </span>
<a href="#l94.149"></a><span id="l94.149">         // Create the attachment</span>
<a href="#l94.150"></a><span id="l94.150">         while (files.hasMoreElements()) {</span>
<a href="#l94.151"></a><span id="l94.151" class="difflineminus">-            let file = files.getNext().QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l94.152"></a><span id="l94.152" class="difflineplus">+            let file = files.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l94.153"></a><span id="l94.153"> </span>
<a href="#l94.154"></a><span id="l94.154">             let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l94.155"></a><span id="l94.155" class="difflineminus">-                                         .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l94.156"></a><span id="l94.156" class="difflineplus">+                                         .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l94.157"></a><span id="l94.157">             let uriSpec = fileHandler.getURLSpecFromFile(file);</span>
<a href="#l94.158"></a><span id="l94.158"> </span>
<a href="#l94.159"></a><span id="l94.159">             if (!(uriSpec in gAttachMap)) {</span>
<a href="#l94.160"></a><span id="l94.160">                 // If the attachment hasn't been added, then set the last display</span>
<a href="#l94.161"></a><span id="l94.161">                 // directory.</span>
<a href="#l94.162"></a><span id="l94.162">                 lastDirectory(uriSpec);</span>
<a href="#l94.163"></a><span id="l94.163"> </span>
<a href="#l94.164"></a><span id="l94.164">                 // ... and add the attachment.</span>
<a href="#l94.165"></a><span id="l94.165" class="difflineat">@@ -2182,18 +2179,18 @@ function attachFile(cloudProvider) {</span>
<a href="#l94.166"></a><span id="l94.166">  *                                 returned. If null, the last chosen directory</span>
<a href="#l94.167"></a><span id="l94.167">  *                                 will be returned.</span>
<a href="#l94.168"></a><span id="l94.168">  * @return            The last directory that was set with this function.</span>
<a href="#l94.169"></a><span id="l94.169">  */</span>
<a href="#l94.170"></a><span id="l94.170"> function lastDirectory(aFileUri) {</span>
<a href="#l94.171"></a><span id="l94.171">     if (aFileUri) {</span>
<a href="#l94.172"></a><span id="l94.172">         // Act similar to a setter, save the passed uri.</span>
<a href="#l94.173"></a><span id="l94.173">         let uri = Services.io.newURI(aFileUri);</span>
<a href="#l94.174"></a><span id="l94.174" class="difflineminus">-        let file = uri.QueryInterface(Components.interfaces.nsIFileURL).file;</span>
<a href="#l94.175"></a><span id="l94.175" class="difflineminus">-        lastDirectory.mValue = file.parent.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l94.176"></a><span id="l94.176" class="difflineplus">+        let file = uri.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l94.177"></a><span id="l94.177" class="difflineplus">+        lastDirectory.mValue = file.parent.QueryInterface(Ci.nsIFile);</span>
<a href="#l94.178"></a><span id="l94.178">     }</span>
<a href="#l94.179"></a><span id="l94.179"> </span>
<a href="#l94.180"></a><span id="l94.180">     // In any case, return the value</span>
<a href="#l94.181"></a><span id="l94.181">     return (lastDirectory.mValue === undefined ? null : lastDirectory.mValue);</span>
<a href="#l94.182"></a><span id="l94.182"> }</span>
<a href="#l94.183"></a><span id="l94.183"> </span>
<a href="#l94.184"></a><span id="l94.184"> /**</span>
<a href="#l94.185"></a><span id="l94.185">  * Turns an url into a string that can be used in UI.</span>
<a href="#l94.186"></a><span id="l94.186" class="difflineat">@@ -2218,17 +2215,17 @@ function makePrettyName(aUri) {</span>
<a href="#l94.187"></a><span id="l94.187">  * Asynchronously uploads the given attachment to the cloud provider, updating</span>
<a href="#l94.188"></a><span id="l94.188">  * the passed listItem as things progress.</span>
<a href="#l94.189"></a><span id="l94.189">  *</span>
<a href="#l94.190"></a><span id="l94.190">  * @param attachment        A calIAttachment to upload</span>
<a href="#l94.191"></a><span id="l94.191">  * @param cloudProvider     The clould provider to upload to</span>
<a href="#l94.192"></a><span id="l94.192">  * @param listItem          The listitem in attachment-link listbox to update.</span>
<a href="#l94.193"></a><span id="l94.193">  */</span>
<a href="#l94.194"></a><span id="l94.194"> function uploadCloudAttachment(attachment, cloudProvider, listItem) {</span>
<a href="#l94.195"></a><span id="l94.195" class="difflineminus">-    let file = attachment.uri.QueryInterface(Components.interfaces.nsIFileURL).file;</span>
<a href="#l94.196"></a><span id="l94.196" class="difflineplus">+    let file = attachment.uri.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l94.197"></a><span id="l94.197">     listItem.attachLocalFile = file;</span>
<a href="#l94.198"></a><span id="l94.198">     listItem.attachCloudProvider = cloudProvider;</span>
<a href="#l94.199"></a><span id="l94.199">     cloudProvider.uploadFile(file, {</span>
<a href="#l94.200"></a><span id="l94.200">         onStartRequest: function() {</span>
<a href="#l94.201"></a><span id="l94.201">             listItem.setAttribute(&quot;image&quot;, &quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l94.202"></a><span id="l94.202">         },</span>
<a href="#l94.203"></a><span id="l94.203"> </span>
<a href="#l94.204"></a><span id="l94.204">         onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l94.205"></a><span id="l94.205" class="difflineat">@@ -2406,32 +2403,32 @@ function deleteAllAttachments() {</span>
<a href="#l94.206"></a><span id="l94.206">  * Opens the selected attachment using the external protocol service.</span>
<a href="#l94.207"></a><span id="l94.207">  * @see nsIExternalProtocolService</span>
<a href="#l94.208"></a><span id="l94.208">  */</span>
<a href="#l94.209"></a><span id="l94.209"> function openAttachment() {</span>
<a href="#l94.210"></a><span id="l94.210">     // Only one file has to be selected and we don't handle base64 files at all</span>
<a href="#l94.211"></a><span id="l94.211">     let documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l94.212"></a><span id="l94.212">     if (documentLink.selectedItem) {</span>
<a href="#l94.213"></a><span id="l94.213">         let attURI = documentLink.selectedItem.attachment.uri;</span>
<a href="#l94.214"></a><span id="l94.214" class="difflineminus">-        let externalLoader = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l94.215"></a><span id="l94.215" class="difflineminus">-                                       .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l94.216"></a><span id="l94.216" class="difflineplus">+        let externalLoader = Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l94.217"></a><span id="l94.217" class="difflineplus">+                               .getService(Ci.nsIExternalProtocolService);</span>
<a href="#l94.218"></a><span id="l94.218">         // TODO There should be a nicer dialog</span>
<a href="#l94.219"></a><span id="l94.219">         externalLoader.loadURI(attURI);</span>
<a href="#l94.220"></a><span id="l94.220">     }</span>
<a href="#l94.221"></a><span id="l94.221"> }</span>
<a href="#l94.222"></a><span id="l94.222"> </span>
<a href="#l94.223"></a><span id="l94.223"> /**</span>
<a href="#l94.224"></a><span id="l94.224">  * Copies the link location of the first selected attachment to the clipboard</span>
<a href="#l94.225"></a><span id="l94.225">  */</span>
<a href="#l94.226"></a><span id="l94.226"> function copyAttachment() {</span>
<a href="#l94.227"></a><span id="l94.227">     let documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l94.228"></a><span id="l94.228">     if (documentLink.selectedItem) {</span>
<a href="#l94.229"></a><span id="l94.229">         let attURI = documentLink.selectedItem.attachment.uri.spec;</span>
<a href="#l94.230"></a><span id="l94.230" class="difflineminus">-        let clipboard = Components.classes[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l94.231"></a><span id="l94.231" class="difflineminus">-                                  .getService(Components.interfaces.nsIClipboardHelper);</span>
<a href="#l94.232"></a><span id="l94.232" class="difflineplus">+        let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l94.233"></a><span id="l94.233" class="difflineplus">+                          .getService(Ci.nsIClipboardHelper);</span>
<a href="#l94.234"></a><span id="l94.234">         clipboard.copyString(attURI);</span>
<a href="#l94.235"></a><span id="l94.235">     }</span>
<a href="#l94.236"></a><span id="l94.236"> }</span>
<a href="#l94.237"></a><span id="l94.237"> </span>
<a href="#l94.238"></a><span id="l94.238"> /**</span>
<a href="#l94.239"></a><span id="l94.239">  * Handler function to handle pressing keys in the attachment listbox.</span>
<a href="#l94.240"></a><span id="l94.240">  *</span>
<a href="#l94.241"></a><span id="l94.241">  * @param aEvent     The DOM event caused by the key press.</span>
<a href="#l94.242"></a><span id="l94.242" class="difflineat">@@ -3166,18 +3163,18 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l94.243"></a><span id="l94.243">             // this triggers the update of the imipbar in case this is a rescheduling case</span>
<a href="#l94.244"></a><span id="l94.244">             if (window.counterProposal &amp;&amp; window.counterProposal.onReschedule) {</span>
<a href="#l94.245"></a><span id="l94.245">                 window.counterProposal.onReschedule();</span>
<a href="#l94.246"></a><span id="l94.246">             }</span>
<a href="#l94.247"></a><span id="l94.247">         },</span>
<a href="#l94.248"></a><span id="l94.248">         onGetResult: function() {}</span>
<a href="#l94.249"></a><span id="l94.249">     };</span>
<a href="#l94.250"></a><span id="l94.250">     let resp = document.getElementById(&quot;notify-attendees-checkbox&quot;).checked</span>
<a href="#l94.251"></a><span id="l94.251" class="difflineminus">-             ? Components.interfaces.calIItipItem.AUTO</span>
<a href="#l94.252"></a><span id="l94.252" class="difflineminus">-             : Components.interfaces.calIItipItem.NONE;</span>
<a href="#l94.253"></a><span id="l94.253" class="difflineplus">+             ? Ci.calIItipItem.AUTO</span>
<a href="#l94.254"></a><span id="l94.254" class="difflineplus">+             : Ci.calIItipItem.NONE;</span>
<a href="#l94.255"></a><span id="l94.255">     let extResponse = { responseMode: resp };</span>
<a href="#l94.256"></a><span id="l94.256">     window.onAcceptCallback(item, calendar, originalItem, listener, extResponse);</span>
<a href="#l94.257"></a><span id="l94.257"> }</span>
<a href="#l94.258"></a><span id="l94.258"> </span>
<a href="#l94.259"></a><span id="l94.259"> /**</span>
<a href="#l94.260"></a><span id="l94.260">  * This function is called when the user chooses to delete an Item</span>
<a href="#l94.261"></a><span id="l94.261">  * from the Event/Task dialog</span>
<a href="#l94.262"></a><span id="l94.262">  *</span>
<a href="#l94.263"></a><span id="l94.263" class="difflineat">@@ -3660,17 +3657,17 @@ function showOrHideItemURL(aShow, aUrl) </span>
<a href="#l94.264"></a><span id="l94.264">             handler = Services.io.getProtocolHandler(uri.scheme);</span>
<a href="#l94.265"></a><span id="l94.265">         } catch (e) {</span>
<a href="#l94.266"></a><span id="l94.266">             // No protocol handler for the given protocol, or invalid uri</span>
<a href="#l94.267"></a><span id="l94.267">             // hideOrShow(false);</span>
<a href="#l94.268"></a><span id="l94.268">             return false;</span>
<a href="#l94.269"></a><span id="l94.269">         }</span>
<a href="#l94.270"></a><span id="l94.270">         // Only show if its either an internal protcol handler, or its external</span>
<a href="#l94.271"></a><span id="l94.271">         // and there is an external app for the scheme</span>
<a href="#l94.272"></a><span id="l94.272" class="difflineminus">-        handler = cal.wrapInstance(handler, Components.interfaces.nsIExternalProtocolHandler);</span>
<a href="#l94.273"></a><span id="l94.273" class="difflineplus">+        handler = cal.wrapInstance(handler, Ci.nsIExternalProtocolHandler);</span>
<a href="#l94.274"></a><span id="l94.274">         return !handler || handler.externalAppExistsForScheme(uri.scheme);</span>
<a href="#l94.275"></a><span id="l94.275">     } else {</span>
<a href="#l94.276"></a><span id="l94.276">         // Hide if there is no url, or the menuitem was chosen so that the url</span>
<a href="#l94.277"></a><span id="l94.277">         // should be hidden.</span>
<a href="#l94.278"></a><span id="l94.278">         return false;</span>
<a href="#l94.279"></a><span id="l94.279">     }</span>
<a href="#l94.280"></a><span id="l94.280"> }</span>
<a href="#l94.281"></a><span id="l94.281"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-panel.js</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-panel.js</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -457,18 +457,18 @@ function openNewTask() {</span>
<a href="#l95.4"></a><span id="l95.4"> /**</span>
<a href="#l95.5"></a><span id="l95.5">  * Open a new Thunderbird compose window.</span>
<a href="#l95.6"></a><span id="l95.6">  */</span>
<a href="#l95.7"></a><span id="l95.7"> function openNewMessage() {</span>
<a href="#l95.8"></a><span id="l95.8">     MailServices.compose.OpenComposeWindow(</span>
<a href="#l95.9"></a><span id="l95.9">         null,</span>
<a href="#l95.10"></a><span id="l95.10">         null,</span>
<a href="#l95.11"></a><span id="l95.11">         null,</span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-        Components.interfaces.nsIMsgCompType.New,</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineminus">-        Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l95.14"></a><span id="l95.14" class="difflineplus">+        Ci.nsIMsgCompType.New,</span>
<a href="#l95.15"></a><span id="l95.15" class="difflineplus">+        Ci.nsIMsgCompFormat.Default,</span>
<a href="#l95.16"></a><span id="l95.16">         null,</span>
<a href="#l95.17"></a><span id="l95.17">         null</span>
<a href="#l95.18"></a><span id="l95.18">     );</span>
<a href="#l95.19"></a><span id="l95.19"> }</span>
<a href="#l95.20"></a><span id="l95.20"> </span>
<a href="#l95.21"></a><span id="l95.21"> /**</span>
<a href="#l95.22"></a><span id="l95.22">  * Open a new addressbook window</span>
<a href="#l95.23"></a><span id="l95.23">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/calendar/lightning/content/lightning-migration.xul</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-migration.xul</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -17,18 +17,17 @@</span>
<a href="#l96.4"></a><span id="l96.4"> [</span>
<a href="#l96.5"></a><span id="l96.5"> ]&gt;</span>
<a href="#l96.6"></a><span id="l96.6"> </span>
<a href="#l96.7"></a><span id="l96.7"> &lt;overlay id=&quot;ltnMigrationOverlay&quot;</span>
<a href="#l96.8"></a><span id="l96.8">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l96.9"></a><span id="l96.9">     &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-migration-dialog.js&quot;/&gt;</span>
<a href="#l96.10"></a><span id="l96.10">     &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l96.11"></a><span id="l96.11">         function checkOld() {</span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-            var calMgr = Components.classes[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineminus">-                                   .getService(Components.interfaces.calICalendarManager);</span>
<a href="#l96.14"></a><span id="l96.14" class="difflineplus">+            var calMgr = Cc[&quot;@mozilla.org/calendar/manager;1&quot;].getService(Ci.calICalendarManager);</span>
<a href="#l96.15"></a><span id="l96.15">             var cals = calMgr.getCalendars({});</span>
<a href="#l96.16"></a><span id="l96.16">             if (!cals.length) {</span>
<a href="#l96.17"></a><span id="l96.17">                 // There are no calendars, so we are running for the first time</span>
<a href="#l96.18"></a><span id="l96.18">                 gDataMigrator.checkAndMigrate();</span>
<a href="#l96.19"></a><span id="l96.19">             }</span>
<a href="#l96.20"></a><span id="l96.20">         }</span>
<a href="#l96.21"></a><span id="l96.21">         window.addEventListener(&quot;load&quot;, checkOld, { capture: false, once: true });</span>
<a href="#l96.22"></a><span id="l96.22">     ]]&gt;&lt;/script&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/calendar/lightning/content/lightning-utils.js</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-utils.js</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -44,23 +44,23 @@ function ltnInitMailIdentitiesRow() {</span>
<a href="#l97.4"></a><span id="l97.4"> </span>
<a href="#l97.5"></a><span id="l97.5">     addMenuItem(menuPopup, cal.l10n.getLtnString(&quot;imipNoIdentity&quot;), &quot;none&quot;);</span>
<a href="#l97.6"></a><span id="l97.6">     let identities;</span>
<a href="#l97.7"></a><span id="l97.7">     if (gCalendar &amp;&amp; gCalendar.aclEntry &amp;&amp; gCalendar.aclEntry.hasAccessControl) {</span>
<a href="#l97.8"></a><span id="l97.8">         identities = gCalendar.aclEntry.getOwnerIdentities({});</span>
<a href="#l97.9"></a><span id="l97.9">     } else {</span>
<a href="#l97.10"></a><span id="l97.10">         identities = MailServices.accounts.allIdentities;</span>
<a href="#l97.11"></a><span id="l97.11">     }</span>
<a href="#l97.12"></a><span id="l97.12" class="difflineminus">-    for (let identity of fixIterator(identities, Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineplus">+    for (let identity of fixIterator(identities, Ci.nsIMsgIdentity)) {</span>
<a href="#l97.14"></a><span id="l97.14">         addMenuItem(menuPopup, identity.identityName, identity.key);</span>
<a href="#l97.15"></a><span id="l97.15">     }</span>
<a href="#l97.16"></a><span id="l97.16">     try {</span>
<a href="#l97.17"></a><span id="l97.17">         let sel = gCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l97.18"></a><span id="l97.18">         if (sel) {</span>
<a href="#l97.19"></a><span id="l97.19" class="difflineminus">-            sel = sel.QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l97.20"></a><span id="l97.20" class="difflineplus">+            sel = sel.QueryInterface(Ci.nsIMsgIdentity);</span>
<a href="#l97.21"></a><span id="l97.21">         }</span>
<a href="#l97.22"></a><span id="l97.22">         menuListSelectItem(&quot;email-identity-menulist&quot;, sel ? sel.key : &quot;none&quot;);</span>
<a href="#l97.23"></a><span id="l97.23">     } catch (exc) {</span>
<a href="#l97.24"></a><span id="l97.24">         // Don't select anything if the identity can't be found</span>
<a href="#l97.25"></a><span id="l97.25">     }</span>
<a href="#l97.26"></a><span id="l97.26"> }</span>
<a href="#l97.27"></a><span id="l97.27"> </span>
<a href="#l97.28"></a><span id="l97.28"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -208,17 +208,17 @@ var calendarItemTabType = {</span>
<a href="#l98.4"></a><span id="l98.4"> </span>
<a href="#l98.5"></a><span id="l98.5">         // Generate and set the tab title.</span>
<a href="#l98.6"></a><span id="l98.6">         let strName;</span>
<a href="#l98.7"></a><span id="l98.7">         if (aTab.mode.type == &quot;calendarEvent&quot;) {</span>
<a href="#l98.8"></a><span id="l98.8">             strName = aArgs.calendarEvent.title ? &quot;editEventDialog&quot; : &quot;newEventDialog&quot;;</span>
<a href="#l98.9"></a><span id="l98.9">         } else if (aTab.mode.type == &quot;calendarTask&quot;) {</span>
<a href="#l98.10"></a><span id="l98.10">             strName = aArgs.calendarEvent.title ? &quot;editTaskDialog&quot; : &quot;newTaskDialog&quot;;</span>
<a href="#l98.11"></a><span id="l98.11">         } else {</span>
<a href="#l98.12"></a><span id="l98.12" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+            throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l98.14"></a><span id="l98.14">         }</span>
<a href="#l98.15"></a><span id="l98.15">         // name is &quot;New Event&quot;, &quot;Edit Task&quot;, etc.</span>
<a href="#l98.16"></a><span id="l98.16">         let name = cal.l10n.getCalString(strName);</span>
<a href="#l98.17"></a><span id="l98.17">         aTab.title = name + &quot;: &quot; + (aArgs.calendarEvent.title || name);</span>
<a href="#l98.18"></a><span id="l98.18"> </span>
<a href="#l98.19"></a><span id="l98.19">         // allowTabClose prevents the tab from being closed until we ask</span>
<a href="#l98.20"></a><span id="l98.20">         // the user if they want to save any unsaved changes.</span>
<a href="#l98.21"></a><span id="l98.21">         aTab.allowTabClose = false;</span>
<a href="#l98.22"></a><span id="l98.22" class="difflineat">@@ -774,17 +774,17 @@ function moveEventToolbox(aDestination) </span>
<a href="#l98.23"></a><span id="l98.23"> }</span>
<a href="#l98.24"></a><span id="l98.24"> </span>
<a href="#l98.25"></a><span id="l98.25"> /**</span>
<a href="#l98.26"></a><span id="l98.26">  * Checks if Lightning's binary component was successfully loaded.</span>
<a href="#l98.27"></a><span id="l98.27">  */</span>
<a href="#l98.28"></a><span id="l98.28"> function checkCalendarBinaryComponent() {</span>
<a href="#l98.29"></a><span id="l98.29">     // Don't even get started if we are running ical.js or the binary component</span>
<a href="#l98.30"></a><span id="l98.30">     // was successfully loaded.</span>
<a href="#l98.31"></a><span id="l98.31" class="difflineminus">-    if (&quot;@mozilla.org/calendar/datetime;1&quot; in Components.classes ||</span>
<a href="#l98.32"></a><span id="l98.32" class="difflineplus">+    if (&quot;@mozilla.org/calendar/datetime;1&quot; in Cc ||</span>
<a href="#l98.33"></a><span id="l98.33">         Preferences.get(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l98.34"></a><span id="l98.34">         return;</span>
<a href="#l98.35"></a><span id="l98.35">     }</span>
<a href="#l98.36"></a><span id="l98.36"> </span>
<a href="#l98.37"></a><span id="l98.37">     const THUNDERBIRD_GUID = &quot;{3550f703-e582-4d05-9a08-453d09bdfdc6}&quot;;</span>
<a href="#l98.38"></a><span id="l98.38">     const SEAMONKEY_GUID = &quot;{92650c4d-4b8e-4d2a-b7eb-24ecf4f6b63a}&quot;;</span>
<a href="#l98.39"></a><span id="l98.39">     const LIGHTNING_GUID = &quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;;</span>
<a href="#l98.40"></a><span id="l98.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1" class="difflineminus">--- a/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineplus">+++ b/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineat">@@ -81,43 +81,42 @@ ltn.invitation = {</span>
<a href="#l99.4"></a><span id="l99.4">      * @param  {calItipItem}  aItipItem  The itip item, which containes aEvent.</span>
<a href="#l99.5"></a><span id="l99.5">      * @return {DOM}                     The html representation of aEvent.</span>
<a href="#l99.6"></a><span id="l99.6">      */</span>
<a href="#l99.7"></a><span id="l99.7">     createInvitationOverlay: function(aEvent, aItipItem) {</span>
<a href="#l99.8"></a><span id="l99.8">         // Creates HTML using the Node strings in the properties file</span>
<a href="#l99.9"></a><span id="l99.9">         let doc = cal.xml.parseFile(&quot;chrome://lightning/content/lightning-invitation.xhtml&quot;);</span>
<a href="#l99.10"></a><span id="l99.10">         let formatter = cal.getDateFormatter();</span>
<a href="#l99.11"></a><span id="l99.11"> </span>
<a href="#l99.12"></a><span id="l99.12" class="difflineminus">-        let linkConverter = Components.classes[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineminus">-                                      .getService(Components.interfaces.mozITXTToHTMLConv);</span>
<a href="#l99.14"></a><span id="l99.14" class="difflineplus">+        let linkConverter = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l99.15"></a><span id="l99.15"> </span>
<a href="#l99.16"></a><span id="l99.16">         let field = function(aField, aContentText, aConvert) {</span>
<a href="#l99.17"></a><span id="l99.17">             let descr = doc.getElementById(&quot;imipHtml-&quot; + aField + &quot;-descr&quot;);</span>
<a href="#l99.18"></a><span id="l99.18">             if (descr) {</span>
<a href="#l99.19"></a><span id="l99.19">                 let labelText = cal.l10n.getLtnString(&quot;imipHtml.&quot; + aField);</span>
<a href="#l99.20"></a><span id="l99.20">                 descr.textContent = labelText;</span>
<a href="#l99.21"></a><span id="l99.21">             }</span>
<a href="#l99.22"></a><span id="l99.22"> </span>
<a href="#l99.23"></a><span id="l99.23">             if (aContentText) {</span>
<a href="#l99.24"></a><span id="l99.24">                 let content = doc.getElementById(&quot;imipHtml-&quot; + aField + &quot;-content&quot;);</span>
<a href="#l99.25"></a><span id="l99.25">                 doc.getElementById(&quot;imipHtml-&quot; + aField + &quot;-row&quot;).hidden = false;</span>
<a href="#l99.26"></a><span id="l99.26">                 if (aConvert) {</span>
<a href="#l99.27"></a><span id="l99.27">                     // we convert special characters first to not mix up html conversion</span>
<a href="#l99.28"></a><span id="l99.28" class="difflineminus">-                    let mode = Components.interfaces.mozITXTToHTMLConv.kEntities;</span>
<a href="#l99.29"></a><span id="l99.29" class="difflineplus">+                    let mode = Ci.mozITXTToHTMLConv.kEntities;</span>
<a href="#l99.30"></a><span id="l99.30">                     let contentText = linkConverter.scanTXT(aContentText, mode);</span>
<a href="#l99.31"></a><span id="l99.31">                     try {</span>
<a href="#l99.32"></a><span id="l99.32">                         // kGlyphSubstitution may lead to unexpected results when used in scanHTML</span>
<a href="#l99.33"></a><span id="l99.33" class="difflineminus">-                        mode = Components.interfaces.mozITXTToHTMLConv.kStructPhrase +</span>
<a href="#l99.34"></a><span id="l99.34" class="difflineminus">-                               Components.interfaces.mozITXTToHTMLConv.kGlyphSubstitution +</span>
<a href="#l99.35"></a><span id="l99.35" class="difflineminus">-                               Components.interfaces.mozITXTToHTMLConv.kURLs;</span>
<a href="#l99.36"></a><span id="l99.36" class="difflineplus">+                        mode = Ci.mozITXTToHTMLConv.kStructPhrase +</span>
<a href="#l99.37"></a><span id="l99.37" class="difflineplus">+                               Ci.mozITXTToHTMLConv.kGlyphSubstitution +</span>
<a href="#l99.38"></a><span id="l99.38" class="difflineplus">+                               Ci.mozITXTToHTMLConv.kURLs;</span>
<a href="#l99.39"></a><span id="l99.39">                         // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l99.40"></a><span id="l99.40">                         content.innerHTML = linkConverter.scanHTML(contentText, mode);</span>
<a href="#l99.41"></a><span id="l99.41">                     } catch (e) {</span>
<a href="#l99.42"></a><span id="l99.42" class="difflineminus">-                        mode = Components.interfaces.mozITXTToHTMLConv.kStructPhrase +</span>
<a href="#l99.43"></a><span id="l99.43" class="difflineminus">-                               Components.interfaces.mozITXTToHTMLConv.kURLs;</span>
<a href="#l99.44"></a><span id="l99.44" class="difflineplus">+                        mode = Ci.mozITXTToHTMLConv.kStructPhrase +</span>
<a href="#l99.45"></a><span id="l99.45" class="difflineplus">+                               Ci.mozITXTToHTMLConv.kURLs;</span>
<a href="#l99.46"></a><span id="l99.46">                         // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l99.47"></a><span id="l99.47">                         content.innerHTML = linkConverter.scanHTML(contentText, mode);</span>
<a href="#l99.48"></a><span id="l99.48">                     }</span>
<a href="#l99.49"></a><span id="l99.49">                 } else {</span>
<a href="#l99.50"></a><span id="l99.50">                     content.textContent = aContentText;</span>
<a href="#l99.51"></a><span id="l99.51">                 }</span>
<a href="#l99.52"></a><span id="l99.52">             }</span>
<a href="#l99.53"></a><span id="l99.53">         };</span>
<a href="#l99.54"></a><span id="l99.54" class="difflineat">@@ -149,17 +148,17 @@ ltn.invitation = {</span>
<a href="#l99.55"></a><span id="l99.55">             let modifiedOccurrences = [];</span>
<a href="#l99.56"></a><span id="l99.56"> </span>
<a href="#l99.57"></a><span id="l99.57">             let dateComptor = function(a, b) {</span>
<a href="#l99.58"></a><span id="l99.58">                 return a.startDate.compare(b.startDate);</span>
<a href="#l99.59"></a><span id="l99.59">             };</span>
<a href="#l99.60"></a><span id="l99.60"> </span>
<a href="#l99.61"></a><span id="l99.61">             // Show removed instances</span>
<a href="#l99.62"></a><span id="l99.62">             for (let exc of aEvent.recurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l99.63"></a><span id="l99.63" class="difflineminus">-                if (exc instanceof Components.interfaces.calIRecurrenceDate) {</span>
<a href="#l99.64"></a><span id="l99.64" class="difflineplus">+                if (exc instanceof Ci.calIRecurrenceDate) {</span>
<a href="#l99.65"></a><span id="l99.65">                     if (exc.isNegative) {</span>
<a href="#l99.66"></a><span id="l99.66">                         // This is an EXDATE</span>
<a href="#l99.67"></a><span id="l99.67">                         let excDate = exc.date.getInTimezone(kDefaultTimezone);</span>
<a href="#l99.68"></a><span id="l99.68">                         formattedExDates.push(formatter.formatDateTime(excDate));</span>
<a href="#l99.69"></a><span id="l99.69">                     } else {</span>
<a href="#l99.70"></a><span id="l99.70">                         // This is an RDATE, close enough to a modified occurrence</span>
<a href="#l99.71"></a><span id="l99.71">                         let excItem = aEvent.recurrenceInfo.getOccurrenceFor(exc.date);</span>
<a href="#l99.72"></a><span id="l99.72">                         cal.data.binaryInsert(modifiedOccurrences, excItem, dateComptor, true);</span>
<a href="#l99.73"></a><span id="l99.73" class="difflineat">@@ -491,18 +490,18 @@ ltn.invitation = {</span>
<a href="#l99.74"></a><span id="l99.74"> </span>
<a href="#l99.75"></a><span id="l99.75">     /**</span>
<a href="#l99.76"></a><span id="l99.76">      * Converts a given unicode text</span>
<a href="#l99.77"></a><span id="l99.77">      * @param  {String} aCharset   target character set</span>
<a href="#l99.78"></a><span id="l99.78">      * @param  {String} aSrc       unicode text to convert</span>
<a href="#l99.79"></a><span id="l99.79">      * @return {String}            the converted string</span>
<a href="#l99.80"></a><span id="l99.80">      */</span>
<a href="#l99.81"></a><span id="l99.81">     convertFromUnicode: function(aCharset, aSrc) {</span>
<a href="#l99.82"></a><span id="l99.82" class="difflineminus">-        let unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l99.83"></a><span id="l99.83" class="difflineminus">-                                         .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l99.84"></a><span id="l99.84" class="difflineplus">+        let unicodeConverter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l99.85"></a><span id="l99.85" class="difflineplus">+                                 .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l99.86"></a><span id="l99.86">         unicodeConverter.charset = aCharset;</span>
<a href="#l99.87"></a><span id="l99.87">         return unicodeConverter.ConvertFromUnicode(aSrc);</span>
<a href="#l99.88"></a><span id="l99.88">     },</span>
<a href="#l99.89"></a><span id="l99.89"> </span>
<a href="#l99.90"></a><span id="l99.90">     /**</span>
<a href="#l99.91"></a><span id="l99.91">      * Converts a header to a mime encoded header</span>
<a href="#l99.92"></a><span id="l99.92">      * @param  {String}  aHeader   a header to encode</span>
<a href="#l99.93"></a><span id="l99.93">      * @param  {boolean} aIsEmail  if enabled, only the CN but not the email address gets</span>
<a href="#l99.94"></a><span id="l99.94" class="difflineat">@@ -510,19 +509,17 @@ ltn.invitation = {</span>
<a href="#l99.95"></a><span id="l99.95">      * @return {String}            the encoded string</span>
<a href="#l99.96"></a><span id="l99.96">      */</span>
<a href="#l99.97"></a><span id="l99.97">     encodeMimeHeader: function(aHeader, aIsEmail = false) {</span>
<a href="#l99.98"></a><span id="l99.98">         let fieldNameLen = aHeader.indexOf(&quot;: &quot;) + 2;</span>
<a href="#l99.99"></a><span id="l99.99">         return MailServices.mimeConverter</span>
<a href="#l99.100"></a><span id="l99.100">                            .encodeMimePartIIStr_UTF8(aHeader,</span>
<a href="#l99.101"></a><span id="l99.101">                                                      aIsEmail,</span>
<a href="#l99.102"></a><span id="l99.102">                                                      fieldNameLen,</span>
<a href="#l99.103"></a><span id="l99.103" class="difflineminus">-                                                     Components.interfaces</span>
<a href="#l99.104"></a><span id="l99.104" class="difflineminus">-                                                               .nsIMimeConverter</span>
<a href="#l99.105"></a><span id="l99.105" class="difflineminus">-                                                               .MIME_ENCODED_WORD_SIZE);</span>
<a href="#l99.106"></a><span id="l99.106" class="difflineplus">+                                                     Ci.nsIMimeConverter.MIME_ENCODED_WORD_SIZE);</span>
<a href="#l99.107"></a><span id="l99.107">     },</span>
<a href="#l99.108"></a><span id="l99.108"> </span>
<a href="#l99.109"></a><span id="l99.109">     /**</span>
<a href="#l99.110"></a><span id="l99.110">      * Parses a counterproposal to extract differences to the existing event</span>
<a href="#l99.111"></a><span id="l99.111">      * @param  {calIEvent|calITodo} aProposedItem  The counterproposal</span>
<a href="#l99.112"></a><span id="l99.112">      * @param  {calIEvent|calITodo} aExistingItem  The item to compare with</span>
<a href="#l99.113"></a><span id="l99.113">      * @return {JSObject}                          Objcet of result and differences of parsing</span>
<a href="#l99.114"></a><span id="l99.114">      * @return {String} JsObject.result.type       Parsing result: OK|OLDVERSION|ERROR|NODIFF</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineat">@@ -18,17 +18,17 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l100.4"></a><span id="l100.4"> var xmlHeader = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l100.5"></a><span id="l100.5"> </span>
<a href="#l100.6"></a><span id="l100.6"> var davNS = &quot;DAV:&quot;;</span>
<a href="#l100.7"></a><span id="l100.7"> var caldavNS = &quot;urn:ietf:params:xml:ns:caldav&quot;;</span>
<a href="#l100.8"></a><span id="l100.8"> var calservNS = &quot;http://calendarserver.org/ns/&quot;;</span>
<a href="#l100.9"></a><span id="l100.9"> var MIME_TEXT_CALENDAR = &quot;text/calendar; charset=utf-8&quot;;</span>
<a href="#l100.10"></a><span id="l100.10"> var MIME_TEXT_XML = &quot;text/xml; charset=utf-8&quot;;</span>
<a href="#l100.11"></a><span id="l100.11"> </span>
<a href="#l100.12"></a><span id="l100.12" class="difflineminus">-var cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineplus">+var cIOL = Ci.calIOperationListener;</span>
<a href="#l100.14"></a><span id="l100.14"> </span>
<a href="#l100.15"></a><span id="l100.15"> function caldavNSResolver(prefix) {</span>
<a href="#l100.16"></a><span id="l100.16">     /* eslint-disable id-length */</span>
<a href="#l100.17"></a><span id="l100.17">     const namespaces = {</span>
<a href="#l100.18"></a><span id="l100.18">         D: davNS,</span>
<a href="#l100.19"></a><span id="l100.19">         C: caldavNS,</span>
<a href="#l100.20"></a><span id="l100.20">         CS: calservNS</span>
<a href="#l100.21"></a><span id="l100.21">     };</span>
<a href="#l100.22"></a><span id="l100.22" class="difflineat">@@ -67,42 +67,36 @@ function calDavCalendar() {</span>
<a href="#l100.23"></a><span id="l100.23">     this.mProposedCtag = null;</span>
<a href="#l100.24"></a><span id="l100.24"> </span>
<a href="#l100.25"></a><span id="l100.25">     // By default, support both events and todos.</span>
<a href="#l100.26"></a><span id="l100.26">     this.mGenerallySupportedItemTypes = [&quot;VEVENT&quot;, &quot;VTODO&quot;];</span>
<a href="#l100.27"></a><span id="l100.27">     this.mSupportedItemTypes = this.mGenerallySupportedItemTypes.slice(0);</span>
<a href="#l100.28"></a><span id="l100.28">     this.mACLProperties = {};</span>
<a href="#l100.29"></a><span id="l100.29"> }</span>
<a href="#l100.30"></a><span id="l100.30"> </span>
<a href="#l100.31"></a><span id="l100.31" class="difflineminus">-// some shorthand</span>
<a href="#l100.32"></a><span id="l100.32" class="difflineminus">-var calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l100.33"></a><span id="l100.33" class="difflineminus">-var calIErrors = Components.interfaces.calIErrors;</span>
<a href="#l100.34"></a><span id="l100.34" class="difflineminus">-var calIFreeBusyInterval = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l100.35"></a><span id="l100.35" class="difflineminus">-var calICalDavCalendar = Components.interfaces.calICalDavCalendar;</span>
<a href="#l100.36"></a><span id="l100.36" class="difflineminus">-</span>
<a href="#l100.37"></a><span id="l100.37"> // used in checking calendar URI for (Cal)DAV-ness</span>
<a href="#l100.38"></a><span id="l100.38"> var kDavResourceTypeNone = 0;</span>
<a href="#l100.39"></a><span id="l100.39"> var kDavResourceTypeCollection = 1;</span>
<a href="#l100.40"></a><span id="l100.40"> var kDavResourceTypeCalendar = 2;</span>
<a href="#l100.41"></a><span id="l100.41"> </span>
<a href="#l100.42"></a><span id="l100.42"> // used for etag checking</span>
<a href="#l100.43"></a><span id="l100.43"> var CALDAV_MODIFY_ITEM = &quot;modify&quot;;</span>
<a href="#l100.44"></a><span id="l100.44"> var CALDAV_DELETE_ITEM = &quot;delete&quot;;</span>
<a href="#l100.45"></a><span id="l100.45"> </span>
<a href="#l100.46"></a><span id="l100.46"> var calDavCalendarClassID = Components.ID(&quot;{a35fc6ea-3d92-11d9-89f9-00045ace3b8d}&quot;);</span>
<a href="#l100.47"></a><span id="l100.47"> var calDavCalendarInterfaces = [</span>
<a href="#l100.48"></a><span id="l100.48" class="difflineminus">-    Components.interfaces.calICalendarProvider,</span>
<a href="#l100.49"></a><span id="l100.49" class="difflineminus">-    Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l100.50"></a><span id="l100.50" class="difflineminus">-    Components.interfaces.calIFreeBusyProvider,</span>
<a href="#l100.51"></a><span id="l100.51" class="difflineminus">-    Components.interfaces.nsIChannelEventSink,</span>
<a href="#l100.52"></a><span id="l100.52" class="difflineminus">-    Components.interfaces.calIItipTransport,</span>
<a href="#l100.53"></a><span id="l100.53" class="difflineminus">-    Components.interfaces.calISchedulingSupport,</span>
<a href="#l100.54"></a><span id="l100.54" class="difflineminus">-    Components.interfaces.calICalendar,</span>
<a href="#l100.55"></a><span id="l100.55" class="difflineminus">-    Components.interfaces.calIChangeLog,</span>
<a href="#l100.56"></a><span id="l100.56" class="difflineminus">-    calICalDavCalendar,</span>
<a href="#l100.57"></a><span id="l100.57" class="difflineplus">+    Ci.calICalendarProvider,</span>
<a href="#l100.58"></a><span id="l100.58" class="difflineplus">+    Ci.nsIInterfaceRequestor,</span>
<a href="#l100.59"></a><span id="l100.59" class="difflineplus">+    Ci.calIFreeBusyProvider,</span>
<a href="#l100.60"></a><span id="l100.60" class="difflineplus">+    Ci.nsIChannelEventSink,</span>
<a href="#l100.61"></a><span id="l100.61" class="difflineplus">+    Ci.calIItipTransport,</span>
<a href="#l100.62"></a><span id="l100.62" class="difflineplus">+    Ci.calISchedulingSupport,</span>
<a href="#l100.63"></a><span id="l100.63" class="difflineplus">+    Ci.calICalendar,</span>
<a href="#l100.64"></a><span id="l100.64" class="difflineplus">+    Ci.calIChangeLog,</span>
<a href="#l100.65"></a><span id="l100.65" class="difflineplus">+    Ci.calICalDavCalendar,</span>
<a href="#l100.66"></a><span id="l100.66"> ];</span>
<a href="#l100.67"></a><span id="l100.67"> calDavCalendar.prototype = {</span>
<a href="#l100.68"></a><span id="l100.68">     __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l100.69"></a><span id="l100.69">     classID: calDavCalendarClassID,</span>
<a href="#l100.70"></a><span id="l100.70">     QueryInterface: cal.generateQI(calDavCalendarInterfaces),</span>
<a href="#l100.71"></a><span id="l100.71">     classInfo: cal.generateCI({</span>
<a href="#l100.72"></a><span id="l100.72">         classID: calDavCalendarClassID,</span>
<a href="#l100.73"></a><span id="l100.73">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=caldav&quot;,</span>
<a href="#l100.74"></a><span id="l100.74" class="difflineat">@@ -126,19 +120,18 @@ calDavCalendar.prototype = {</span>
<a href="#l100.75"></a><span id="l100.75"> </span>
<a href="#l100.76"></a><span id="l100.76">     mLastRedirectStatus: null,</span>
<a href="#l100.77"></a><span id="l100.77"> </span>
<a href="#l100.78"></a><span id="l100.78">     ensureTargetCalendar: function() {</span>
<a href="#l100.79"></a><span id="l100.79">         if (!this.isCached &amp;&amp; !this.mOfflineStorage) {</span>
<a href="#l100.80"></a><span id="l100.80">             // If this is a cached calendar, the actual cache is taken care of</span>
<a href="#l100.81"></a><span id="l100.81">             // by the calCachedCalendar facade. In any other case, we use a</span>
<a href="#l100.82"></a><span id="l100.82">             // memory calendar to cache things.</span>
<a href="#l100.83"></a><span id="l100.83" class="difflineminus">-            this.mOfflineStorage = Components</span>
<a href="#l100.84"></a><span id="l100.84" class="difflineminus">-                                   .classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l100.85"></a><span id="l100.85" class="difflineminus">-                                   .createInstance(Components.interfaces.calISyncWriteCalendar);</span>
<a href="#l100.86"></a><span id="l100.86" class="difflineplus">+            this.mOfflineStorage = Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l100.87"></a><span id="l100.87" class="difflineplus">+                                     .createInstance(Ci.calISyncWriteCalendar);</span>
<a href="#l100.88"></a><span id="l100.88"> </span>
<a href="#l100.89"></a><span id="l100.89">             this.mOfflineStorage.superCalendar = this;</span>
<a href="#l100.90"></a><span id="l100.90">             this.mObserver = new calDavObserver(this);</span>
<a href="#l100.91"></a><span id="l100.91">             this.mOfflineStorage.addObserver(this.mObserver);</span>
<a href="#l100.92"></a><span id="l100.92">             this.mOfflineStorage.setProperty(&quot;relaxedMode&quot;, true);</span>
<a href="#l100.93"></a><span id="l100.93">         }</span>
<a href="#l100.94"></a><span id="l100.94">     },</span>
<a href="#l100.95"></a><span id="l100.95"> </span>
<a href="#l100.96"></a><span id="l100.96" class="difflineat">@@ -282,17 +275,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.97"></a><span id="l100.97">                 if (refreshNeeded) {</span>
<a href="#l100.98"></a><span id="l100.98">                     // reseting the cached ctag forces an item refresh when</span>
<a href="#l100.99"></a><span id="l100.99">                     // safeRefresh is called later</span>
<a href="#l100.100"></a><span id="l100.100">                     self.mCtag = null;</span>
<a href="#l100.101"></a><span id="l100.101">                     self.mProposedCtag = null;</span>
<a href="#l100.102"></a><span id="l100.102">                 }</span>
<a href="#l100.103"></a><span id="l100.103">             }</span>
<a href="#l100.104"></a><span id="l100.104">         };</span>
<a href="#l100.105"></a><span id="l100.105" class="difflineminus">-        this.mOfflineStorage.getItems(calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l100.106"></a><span id="l100.106" class="difflineplus">+        this.mOfflineStorage.getItems(Ci.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l100.107"></a><span id="l100.107">                                       0, null, null, getMetaListener);</span>
<a href="#l100.108"></a><span id="l100.108">     },</span>
<a href="#l100.109"></a><span id="l100.109"> </span>
<a href="#l100.110"></a><span id="l100.110">     fetchCachedMetaData: function() {</span>
<a href="#l100.111"></a><span id="l100.111">         cal.LOG(&quot;CalDAV: Retrieving server info from cache for &quot; + this.name);</span>
<a href="#l100.112"></a><span id="l100.112">         let cacheIds = {};</span>
<a href="#l100.113"></a><span id="l100.113">         let cacheValues = {};</span>
<a href="#l100.114"></a><span id="l100.114">         this.mOfflineStorage.getAllMetaData({}, cacheIds, cacheValues);</span>
<a href="#l100.115"></a><span id="l100.115" class="difflineat">@@ -306,17 +299,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.116"></a><span id="l100.116">                 this.mCtag = itemData;</span>
<a href="#l100.117"></a><span id="l100.117">                 this.mProposedCtag = null;</span>
<a href="#l100.118"></a><span id="l100.118">                 this.mOfflineStorage.deleteMetaData(&quot;ctag&quot;);</span>
<a href="#l100.119"></a><span id="l100.119">             } else if (itemId == &quot;webdav-sync-token&quot;) {</span>
<a href="#l100.120"></a><span id="l100.120">                 this.mWebdavSyncToken = itemData;</span>
<a href="#l100.121"></a><span id="l100.121">                 this.mOfflineStorage.deleteMetaData(&quot;sync-token&quot;);</span>
<a href="#l100.122"></a><span id="l100.122">             } else if (itemId == &quot;calendar-properties&quot;) {</span>
<a href="#l100.123"></a><span id="l100.123">                 this.restoreCalendarProperties(itemData);</span>
<a href="#l100.124"></a><span id="l100.124" class="difflineminus">-                this.setProperty(&quot;currentStatus&quot;, Components.results.NS_OK);</span>
<a href="#l100.125"></a><span id="l100.125" class="difflineplus">+                this.setProperty(&quot;currentStatus&quot;, Cr.NS_OK);</span>
<a href="#l100.126"></a><span id="l100.126">                 if (this.mHaveScheduling || this.hasAutoScheduling || this.hasFreeBusy) {</span>
<a href="#l100.127"></a><span id="l100.127">                     cal.getFreeBusyService().addProvider(this);</span>
<a href="#l100.128"></a><span id="l100.128">                 }</span>
<a href="#l100.129"></a><span id="l100.129">             } else {</span>
<a href="#l100.130"></a><span id="l100.130">                 let itemDataArray = itemData.split(&quot;\u001A&quot;);</span>
<a href="#l100.131"></a><span id="l100.131">                 let etag = itemDataArray[0];</span>
<a href="#l100.132"></a><span id="l100.132">                 let resourcePath = itemDataArray[1];</span>
<a href="#l100.133"></a><span id="l100.133">                 let isInboxItem = itemDataArray[2];</span>
<a href="#l100.134"></a><span id="l100.134" class="difflineat">@@ -335,17 +328,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.135"></a><span id="l100.135">             }</span>
<a href="#l100.136"></a><span id="l100.136">         }</span>
<a href="#l100.137"></a><span id="l100.137"> </span>
<a href="#l100.138"></a><span id="l100.138">         this.ensureMetaData();</span>
<a href="#l100.139"></a><span id="l100.139">     },</span>
<a href="#l100.140"></a><span id="l100.140"> </span>
<a href="#l100.141"></a><span id="l100.141">     sendHttpRequest: function(aUri, aUploadData, aContentType, aExisting, aSetupChannelFunc, aFailureFunc, aUseStreamLoader=true) {</span>
<a href="#l100.142"></a><span id="l100.142">         function oauthCheck(nextMethod, loaderOrRequest /* either the nsIStreamLoader or nsIRequestObserver parameters */) {</span>
<a href="#l100.143"></a><span id="l100.143" class="difflineminus">-            let request = (loaderOrRequest.request || loaderOrRequest).QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.144"></a><span id="l100.144" class="difflineplus">+            let request = (loaderOrRequest.request || loaderOrRequest).QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.145"></a><span id="l100.145">             let error = false;</span>
<a href="#l100.146"></a><span id="l100.146">             try {</span>
<a href="#l100.147"></a><span id="l100.147">                 let wwwauth = request.getResponseHeader(&quot;WWW-Authenticate&quot;);</span>
<a href="#l100.148"></a><span id="l100.148">                 if (wwwauth.startsWith(&quot;Bearer&quot;) &amp;&amp; wwwauth.includes(&quot;error=&quot;)) {</span>
<a href="#l100.149"></a><span id="l100.149">                     // An OAuth error occurred, we need to reauthenticate.</span>
<a href="#l100.150"></a><span id="l100.150">                     error = true;</span>
<a href="#l100.151"></a><span id="l100.151">                 }</span>
<a href="#l100.152"></a><span id="l100.152">             } catch (e) {</span>
<a href="#l100.153"></a><span id="l100.153" class="difflineat">@@ -562,17 +555,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.154"></a><span id="l100.154">                 if (this.calendarUserAddress) {</span>
<a href="#l100.155"></a><span id="l100.155">                     return this.calendarUserAddress;</span>
<a href="#l100.156"></a><span id="l100.156">                 } // else use configured email identity</span>
<a href="#l100.157"></a><span id="l100.157">                 break;</span>
<a href="#l100.158"></a><span id="l100.158">             case &quot;organizerCN&quot;:</span>
<a href="#l100.159"></a><span id="l100.159">                 return null; // xxx todo</span>
<a href="#l100.160"></a><span id="l100.160">             case &quot;itip.transport&quot;:</span>
<a href="#l100.161"></a><span id="l100.161">                 if (this.hasAutoScheduling || this.hasScheduling) {</span>
<a href="#l100.162"></a><span id="l100.162" class="difflineminus">-                    return this.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l100.163"></a><span id="l100.163" class="difflineplus">+                    return this.QueryInterface(Ci.calIItipTransport);</span>
<a href="#l100.164"></a><span id="l100.164">                 } // else use outbound email-based iTIP (from cal.provider.BaseClass)</span>
<a href="#l100.165"></a><span id="l100.165">                 break;</span>
<a href="#l100.166"></a><span id="l100.166">             case &quot;capabilities.tasks.supported&quot;:</span>
<a href="#l100.167"></a><span id="l100.167">                 return this.supportedItemTypes.includes(&quot;VTODO&quot;);</span>
<a href="#l100.168"></a><span id="l100.168">             case &quot;capabilities.events.supported&quot;:</span>
<a href="#l100.169"></a><span id="l100.169">                 return this.supportedItemTypes.includes(&quot;VEVENT&quot;);</span>
<a href="#l100.170"></a><span id="l100.170">             case &quot;capabilities.autoschedule.supported&quot;:</span>
<a href="#l100.171"></a><span id="l100.171">                 return this.hasAutoScheduling;</span>
<a href="#l100.172"></a><span id="l100.172" class="difflineat">@@ -631,40 +624,40 @@ calDavCalendar.prototype = {</span>
<a href="#l100.173"></a><span id="l100.173">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l100.174"></a><span id="l100.174">             this[method](aListener, status, cIOL.ADD, aItem.id, detail);</span>
<a href="#l100.175"></a><span id="l100.175">         };</span>
<a href="#l100.176"></a><span id="l100.176">         if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l100.177"></a><span id="l100.177">             aItem.id = cal.getUUID();</span>
<a href="#l100.178"></a><span id="l100.178">         }</span>
<a href="#l100.179"></a><span id="l100.179"> </span>
<a href="#l100.180"></a><span id="l100.180">         if (aItem.id == null) {</span>
<a href="#l100.181"></a><span id="l100.181" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l100.182"></a><span id="l100.182" class="difflineplus">+            notifyListener(Cr.NS_ERROR_FAILURE,</span>
<a href="#l100.183"></a><span id="l100.183">                            &quot;Can't set ID on non-mutable item to addItem&quot;);</span>
<a href="#l100.184"></a><span id="l100.184">             return;</span>
<a href="#l100.185"></a><span id="l100.185">         }</span>
<a href="#l100.186"></a><span id="l100.186"> </span>
<a href="#l100.187"></a><span id="l100.187">         if (!cal.item.isItemSupported(aItem, this)) {</span>
<a href="#l100.188"></a><span id="l100.188" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l100.189"></a><span id="l100.189" class="difflineplus">+            notifyListener(Cr.NS_ERROR_FAILURE,</span>
<a href="#l100.190"></a><span id="l100.190">                            &quot;Server does not support item type&quot;);</span>
<a href="#l100.191"></a><span id="l100.191">             return;</span>
<a href="#l100.192"></a><span id="l100.192">         }</span>
<a href="#l100.193"></a><span id="l100.193"> </span>
<a href="#l100.194"></a><span id="l100.194">         let parentItem = aItem.parentItem;</span>
<a href="#l100.195"></a><span id="l100.195">         parentItem.calendar = this.superCalendar;</span>
<a href="#l100.196"></a><span id="l100.196"> </span>
<a href="#l100.197"></a><span id="l100.197">         let locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l100.198"></a><span id="l100.198">         let itemUri = this.makeUri(locationPath);</span>
<a href="#l100.199"></a><span id="l100.199">         cal.LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l100.200"></a><span id="l100.200"> </span>
<a href="#l100.201"></a><span id="l100.201">         let self = this;</span>
<a href="#l100.202"></a><span id="l100.202">         let serializedItem = this.getSerializedItem(aItem);</span>
<a href="#l100.203"></a><span id="l100.203">         let addListener = {</span>
<a href="#l100.204"></a><span id="l100.204">             onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.205"></a><span id="l100.205" class="difflineminus">-                let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.206"></a><span id="l100.206" class="difflineminus">-                let listenerStatus = Components.results.NS_OK;</span>
<a href="#l100.207"></a><span id="l100.207" class="difflineplus">+                let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.208"></a><span id="l100.208" class="difflineplus">+                let listenerStatus = Cr.NS_OK;</span>
<a href="#l100.209"></a><span id="l100.209">                 let listenerDetail = parentItem;</span>
<a href="#l100.210"></a><span id="l100.210">                 let responseStatus;</span>
<a href="#l100.211"></a><span id="l100.211">                 try {</span>
<a href="#l100.212"></a><span id="l100.212">                     responseStatus = request.responseStatus;</span>
<a href="#l100.213"></a><span id="l100.213"> </span>
<a href="#l100.214"></a><span id="l100.214">                     if (self.verboseLogging()) {</span>
<a href="#l100.215"></a><span id="l100.215">                         let str = new TextDecoder().decode(Uint8Array.from(aResult));</span>
<a href="#l100.216"></a><span id="l100.216">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l100.217"></a><span id="l100.217" class="difflineat">@@ -691,46 +684,46 @@ calDavCalendar.prototype = {</span>
<a href="#l100.218"></a><span id="l100.218"> </span>
<a href="#l100.219"></a><span id="l100.219">                     // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l100.220"></a><span id="l100.220">                     // for instance) so we'd best re-fetch in order to know</span>
<a href="#l100.221"></a><span id="l100.221">                     // the current state of the item</span>
<a href="#l100.222"></a><span id="l100.222">                     // Observers will be notified in getUpdatedItem()</span>
<a href="#l100.223"></a><span id="l100.223">                     self.getUpdatedItem(parentItem, aListener);</span>
<a href="#l100.224"></a><span id="l100.224">                     return;</span>
<a href="#l100.225"></a><span id="l100.225">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l100.226"></a><span id="l100.226" class="difflineminus">-                    listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l100.227"></a><span id="l100.227" class="difflineplus">+                    listenerStatus = Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l100.228"></a><span id="l100.228">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l100.229"></a><span id="l100.229">                 } else if (responseStatus) {</span>
<a href="#l100.230"></a><span id="l100.230">                     // There is a response status, but we haven't handled it yet. Any</span>
<a href="#l100.231"></a><span id="l100.231">                     // error occurring here should consider being handled!</span>
<a href="#l100.232"></a><span id="l100.232">                     cal.ERROR(&quot;CalDAV: Unexpected status adding item to &quot; +</span>
<a href="#l100.233"></a><span id="l100.233">                               self.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l100.234"></a><span id="l100.234">                               serializedItem);</span>
<a href="#l100.235"></a><span id="l100.235"> </span>
<a href="#l100.236"></a><span id="l100.236" class="difflineminus">-                    listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l100.237"></a><span id="l100.237" class="difflineplus">+                    listenerStatus = Cr.NS_ERROR_FAILURE;</span>
<a href="#l100.238"></a><span id="l100.238">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l100.239"></a><span id="l100.239">                 }</span>
<a href="#l100.240"></a><span id="l100.240"> </span>
<a href="#l100.241"></a><span id="l100.241">                 // Still need to visually notify for uncached calendars.</span>
<a href="#l100.242"></a><span id="l100.242">                 if (!self.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l100.243"></a><span id="l100.243" class="difflineminus">-                    self.reportDavError(calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l100.244"></a><span id="l100.244" class="difflineplus">+                    self.reportDavError(Ci.calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l100.245"></a><span id="l100.245">                 }</span>
<a href="#l100.246"></a><span id="l100.246"> </span>
<a href="#l100.247"></a><span id="l100.247">                 // Finally, notify listener.</span>
<a href="#l100.248"></a><span id="l100.248">                 notifyListener(listenerStatus, listenerDetail, true);</span>
<a href="#l100.249"></a><span id="l100.249">             }</span>
<a href="#l100.250"></a><span id="l100.250">         };</span>
<a href="#l100.251"></a><span id="l100.251"> </span>
<a href="#l100.252"></a><span id="l100.252">         this.sendHttpRequest(itemUri, serializedItem, MIME_TEXT_CALENDAR, null, (channel) =&gt; {</span>
<a href="#l100.253"></a><span id="l100.253">             if (!aIgnoreEtag) {</span>
<a href="#l100.254"></a><span id="l100.254">                 channel.setRequestHeader(&quot;If-None-Match&quot;, &quot;*&quot;, false);</span>
<a href="#l100.255"></a><span id="l100.255">             }</span>
<a href="#l100.256"></a><span id="l100.256">             return addListener;</span>
<a href="#l100.257"></a><span id="l100.257">         }, () =&gt; {</span>
<a href="#l100.258"></a><span id="l100.258" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.259"></a><span id="l100.259" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.260"></a><span id="l100.260">                            &quot;Error preparing http channel&quot;);</span>
<a href="#l100.261"></a><span id="l100.261">         });</span>
<a href="#l100.262"></a><span id="l100.262">     },</span>
<a href="#l100.263"></a><span id="l100.263"> </span>
<a href="#l100.264"></a><span id="l100.264">     /**</span>
<a href="#l100.265"></a><span id="l100.265">      * modifyItem(); required by calICalendar.idl</span>
<a href="#l100.266"></a><span id="l100.266">      * we actually use doModifyItem()</span>
<a href="#l100.267"></a><span id="l100.267">      *</span>
<a href="#l100.268"></a><span id="l100.268" class="difflineat">@@ -750,17 +743,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.269"></a><span id="l100.269">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l100.270"></a><span id="l100.270">      */</span>
<a href="#l100.271"></a><span id="l100.271">     doModifyItem: function(aNewItem, aOldItem, aListener, aIgnoreEtag) {</span>
<a href="#l100.272"></a><span id="l100.272">         let notifyListener = (status, detail, pure=false) =&gt; {</span>
<a href="#l100.273"></a><span id="l100.273">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l100.274"></a><span id="l100.274">             this[method](aListener, status, cIOL.MODIFY, aNewItem.id, detail);</span>
<a href="#l100.275"></a><span id="l100.275">         };</span>
<a href="#l100.276"></a><span id="l100.276">         if (aNewItem.id == null) {</span>
<a href="#l100.277"></a><span id="l100.277" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l100.278"></a><span id="l100.278" class="difflineplus">+            notifyListener(Cr.NS_ERROR_FAILURE,</span>
<a href="#l100.279"></a><span id="l100.279">                            &quot;ID for modifyItem doesn't exist or is null&quot;);</span>
<a href="#l100.280"></a><span id="l100.280">             return;</span>
<a href="#l100.281"></a><span id="l100.281">         }</span>
<a href="#l100.282"></a><span id="l100.282"> </span>
<a href="#l100.283"></a><span id="l100.283">         let wasInboxItem = this.mItemInfoCache[aNewItem.id].isInboxItem;</span>
<a href="#l100.284"></a><span id="l100.284"> </span>
<a href="#l100.285"></a><span id="l100.285">         let newItem_ = aNewItem;</span>
<a href="#l100.286"></a><span id="l100.286">         aNewItem = aNewItem.parentItem.clone();</span>
<a href="#l100.287"></a><span id="l100.287" class="difflineat">@@ -772,18 +765,18 @@ calDavCalendar.prototype = {</span>
<a href="#l100.288"></a><span id="l100.288">         let eventUri = this.makeUri(this.mItemInfoCache[aNewItem.id].locationPath);</span>
<a href="#l100.289"></a><span id="l100.289"> </span>
<a href="#l100.290"></a><span id="l100.290">         let self = this;</span>
<a href="#l100.291"></a><span id="l100.291"> </span>
<a href="#l100.292"></a><span id="l100.292">         let modifiedItemICS = this.getSerializedItem(aNewItem);</span>
<a href="#l100.293"></a><span id="l100.293"> </span>
<a href="#l100.294"></a><span id="l100.294">         let modListener = {</span>
<a href="#l100.295"></a><span id="l100.295">             onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.296"></a><span id="l100.296" class="difflineminus">-                let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.297"></a><span id="l100.297" class="difflineminus">-                let listenerStatus = Components.results.NS_OK;</span>
<a href="#l100.298"></a><span id="l100.298" class="difflineplus">+                let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.299"></a><span id="l100.299" class="difflineplus">+                let listenerStatus = Cr.NS_OK;</span>
<a href="#l100.300"></a><span id="l100.300">                 let listenerDetail = aNewItem;</span>
<a href="#l100.301"></a><span id="l100.301">                 let responseStatus;</span>
<a href="#l100.302"></a><span id="l100.302">                 try {</span>
<a href="#l100.303"></a><span id="l100.303">                     responseStatus = request.responseStatus;</span>
<a href="#l100.304"></a><span id="l100.304"> </span>
<a href="#l100.305"></a><span id="l100.305">                     if (self.verboseLogging()) {</span>
<a href="#l100.306"></a><span id="l100.306">                         let str = new TextDecoder().decode(Uint8Array.from(aResult));</span>
<a href="#l100.307"></a><span id="l100.307">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l100.308"></a><span id="l100.308" class="difflineat">@@ -813,47 +806,47 @@ calDavCalendar.prototype = {</span>
<a href="#l100.309"></a><span id="l100.309">                     }</span>
<a href="#l100.310"></a><span id="l100.310">                     return;</span>
<a href="#l100.311"></a><span id="l100.311">                 } else if (responseStatus == 412 || responseStatus == 409) {</span>
<a href="#l100.312"></a><span id="l100.312">                     // promptOverwrite will ask the user and then re-request</span>
<a href="#l100.313"></a><span id="l100.313">                     self.promptOverwrite(CALDAV_MODIFY_ITEM, aNewItem,</span>
<a href="#l100.314"></a><span id="l100.314">                                          aListener, aOldItem);</span>
<a href="#l100.315"></a><span id="l100.315">                     return;</span>
<a href="#l100.316"></a><span id="l100.316">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l100.317"></a><span id="l100.317" class="difflineminus">-                    listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l100.318"></a><span id="l100.318" class="difflineplus">+                    listenerStatus = Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l100.319"></a><span id="l100.319">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l100.320"></a><span id="l100.320">                 } else if (responseStatus) {</span>
<a href="#l100.321"></a><span id="l100.321">                     // There is a response status, but we haven't handled it yet. Any</span>
<a href="#l100.322"></a><span id="l100.322">                     // error occurring here should consider being handled!</span>
<a href="#l100.323"></a><span id="l100.323">                     cal.ERROR(&quot;CalDAV: Unexpected status modifying item to &quot; +</span>
<a href="#l100.324"></a><span id="l100.324">                               self.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l100.325"></a><span id="l100.325">                               modifiedItemICS);</span>
<a href="#l100.326"></a><span id="l100.326"> </span>
<a href="#l100.327"></a><span id="l100.327" class="difflineminus">-                    listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l100.328"></a><span id="l100.328" class="difflineplus">+                    listenerStatus = Cr.NS_ERROR_FAILURE;</span>
<a href="#l100.329"></a><span id="l100.329">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l100.330"></a><span id="l100.330">                 }</span>
<a href="#l100.331"></a><span id="l100.331"> </span>
<a href="#l100.332"></a><span id="l100.332">                 // Still need to visually notify for uncached calendars.</span>
<a href="#l100.333"></a><span id="l100.333">                 if (!self.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l100.334"></a><span id="l100.334" class="difflineminus">-                    self.reportDavError(calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l100.335"></a><span id="l100.335" class="difflineplus">+                    self.reportDavError(Ci.calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l100.336"></a><span id="l100.336">                 }</span>
<a href="#l100.337"></a><span id="l100.337"> </span>
<a href="#l100.338"></a><span id="l100.338">                 notifyListener(listenerStatus, listenerDetail, true);</span>
<a href="#l100.339"></a><span id="l100.339">             }</span>
<a href="#l100.340"></a><span id="l100.340">         };</span>
<a href="#l100.341"></a><span id="l100.341"> </span>
<a href="#l100.342"></a><span id="l100.342">         this.sendHttpRequest(eventUri, modifiedItemICS, MIME_TEXT_CALENDAR, null, (channel) =&gt; {</span>
<a href="#l100.343"></a><span id="l100.343">             if (!aIgnoreEtag) {</span>
<a href="#l100.344"></a><span id="l100.344">                 channel.setRequestHeader(&quot;If-Match&quot;,</span>
<a href="#l100.345"></a><span id="l100.345">                                          this.mItemInfoCache[aNewItem.id].etag,</span>
<a href="#l100.346"></a><span id="l100.346">                                          false);</span>
<a href="#l100.347"></a><span id="l100.347">             }</span>
<a href="#l100.348"></a><span id="l100.348">             return modListener;</span>
<a href="#l100.349"></a><span id="l100.349">         }, () =&gt; {</span>
<a href="#l100.350"></a><span id="l100.350" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.351"></a><span id="l100.351" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.352"></a><span id="l100.352">                            &quot;Error preparing http channel&quot;);</span>
<a href="#l100.353"></a><span id="l100.353">         });</span>
<a href="#l100.354"></a><span id="l100.354">     },</span>
<a href="#l100.355"></a><span id="l100.355"> </span>
<a href="#l100.356"></a><span id="l100.356">     /**</span>
<a href="#l100.357"></a><span id="l100.357">      * deleteItem(); required by calICalendar.idl</span>
<a href="#l100.358"></a><span id="l100.358">      * the actual deletion is done in doDeleteItem()</span>
<a href="#l100.359"></a><span id="l100.359">      *</span>
<a href="#l100.360"></a><span id="l100.360" class="difflineat">@@ -875,43 +868,43 @@ calDavCalendar.prototype = {</span>
<a href="#l100.361"></a><span id="l100.361">      * */</span>
<a href="#l100.362"></a><span id="l100.362">     doDeleteItem: function(aItem, aListener, aIgnoreEtag, aFromInbox, aUri) {</span>
<a href="#l100.363"></a><span id="l100.363">         let notifyListener = (status, detail, pure=false) =&gt; {</span>
<a href="#l100.364"></a><span id="l100.364">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l100.365"></a><span id="l100.365">             this[method](aListener, status, cIOL.DELETE, aItem.id, detail);</span>
<a href="#l100.366"></a><span id="l100.366">         };</span>
<a href="#l100.367"></a><span id="l100.367"> </span>
<a href="#l100.368"></a><span id="l100.368">         if (aItem.id == null) {</span>
<a href="#l100.369"></a><span id="l100.369" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l100.370"></a><span id="l100.370" class="difflineplus">+            notifyListener(Cr.NS_ERROR_FAILURE,</span>
<a href="#l100.371"></a><span id="l100.371">                            &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l100.372"></a><span id="l100.372">             return;</span>
<a href="#l100.373"></a><span id="l100.373">         }</span>
<a href="#l100.374"></a><span id="l100.374"> </span>
<a href="#l100.375"></a><span id="l100.375">         let eventUri;</span>
<a href="#l100.376"></a><span id="l100.376">         if (aUri) {</span>
<a href="#l100.377"></a><span id="l100.377">             eventUri = aUri;</span>
<a href="#l100.378"></a><span id="l100.378">         } else if (aFromInbox || this.mItemInfoCache[aItem.id].isInboxItem) {</span>
<a href="#l100.379"></a><span id="l100.379">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath, this.mInboxUrl);</span>
<a href="#l100.380"></a><span id="l100.380">         } else {</span>
<a href="#l100.381"></a><span id="l100.381">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath);</span>
<a href="#l100.382"></a><span id="l100.382">         }</span>
<a href="#l100.383"></a><span id="l100.383"> </span>
<a href="#l100.384"></a><span id="l100.384">         if (eventUri.pathQueryRef == this.calendarUri.pathQueryRef) {</span>
<a href="#l100.385"></a><span id="l100.385" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l100.386"></a><span id="l100.386" class="difflineplus">+            notifyListener(Cr.NS_ERROR_FAILURE,</span>
<a href="#l100.387"></a><span id="l100.387">                            &quot;eventUri and calendarUri paths are the same, &quot; +</span>
<a href="#l100.388"></a><span id="l100.388">                            &quot;will not go on to delete entire calendar&quot;);</span>
<a href="#l100.389"></a><span id="l100.389">             return;</span>
<a href="#l100.390"></a><span id="l100.390">         }</span>
<a href="#l100.391"></a><span id="l100.391"> </span>
<a href="#l100.392"></a><span id="l100.392">         let self = this;</span>
<a href="#l100.393"></a><span id="l100.393"> </span>
<a href="#l100.394"></a><span id="l100.394">         let delListener = {</span>
<a href="#l100.395"></a><span id="l100.395">             onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.396"></a><span id="l100.396" class="difflineminus">-                let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.397"></a><span id="l100.397" class="difflineminus">-                let listenerStatus = Components.results.NS_OK;</span>
<a href="#l100.398"></a><span id="l100.398" class="difflineplus">+                let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.399"></a><span id="l100.399" class="difflineplus">+                let listenerStatus = Cr.NS_OK;</span>
<a href="#l100.400"></a><span id="l100.400">                 let listenerDetail = aItem;</span>
<a href="#l100.401"></a><span id="l100.401">                 let responseStatus;</span>
<a href="#l100.402"></a><span id="l100.402">                 try {</span>
<a href="#l100.403"></a><span id="l100.403">                     responseStatus = request.responseStatus;</span>
<a href="#l100.404"></a><span id="l100.404"> </span>
<a href="#l100.405"></a><span id="l100.405">                     if (self.verboseLogging()) {</span>
<a href="#l100.406"></a><span id="l100.406">                         let str = new TextDecoder().decode(Uint8Array.from(aResult));</span>
<a href="#l100.407"></a><span id="l100.407">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l100.408"></a><span id="l100.408" class="difflineat">@@ -942,46 +935,46 @@ calDavCalendar.prototype = {</span>
<a href="#l100.409"></a><span id="l100.409">                     }</span>
<a href="#l100.410"></a><span id="l100.410">                 } else if (responseStatus == 412 || responseStatus == 409) {</span>
<a href="#l100.411"></a><span id="l100.411">                     // item has either been modified or deleted by someone else check to see which</span>
<a href="#l100.412"></a><span id="l100.412">                     cal.LOG(&quot;CalDAV: Item has been modified on server, checking if it has been deleted&quot;);</span>
<a href="#l100.413"></a><span id="l100.413">                     self.sendHttpRequest(eventUri, null, null, null, (channel) =&gt; {</span>
<a href="#l100.414"></a><span id="l100.414">                         channel.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l100.415"></a><span id="l100.415">                         return delListener2;</span>
<a href="#l100.416"></a><span id="l100.416">                     }, () =&gt; {</span>
<a href="#l100.417"></a><span id="l100.417" class="difflineminus">-                        notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.418"></a><span id="l100.418" class="difflineplus">+                        notifyListener(Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.419"></a><span id="l100.419">                                        &quot;Error preparing http channel&quot;);</span>
<a href="#l100.420"></a><span id="l100.420">                     });</span>
<a href="#l100.421"></a><span id="l100.421">                     return;</span>
<a href="#l100.422"></a><span id="l100.422">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l100.423"></a><span id="l100.423" class="difflineminus">-                    listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l100.424"></a><span id="l100.424" class="difflineplus">+                    listenerStatus = Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l100.425"></a><span id="l100.425">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l100.426"></a><span id="l100.426">                 } else if (responseStatus) {</span>
<a href="#l100.427"></a><span id="l100.427">                     cal.ERROR(&quot;CalDAV: Unexpected status deleting item from &quot; +</span>
<a href="#l100.428"></a><span id="l100.428">                               self.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l100.429"></a><span id="l100.429">                               &quot;uri: &quot; + eventUri.spec);</span>
<a href="#l100.430"></a><span id="l100.430"> </span>
<a href="#l100.431"></a><span id="l100.431" class="difflineminus">-                    listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l100.432"></a><span id="l100.432" class="difflineplus">+                    listenerStatus = Cr.NS_ERROR_FAILURE;</span>
<a href="#l100.433"></a><span id="l100.433">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l100.434"></a><span id="l100.434">                 }</span>
<a href="#l100.435"></a><span id="l100.435"> </span>
<a href="#l100.436"></a><span id="l100.436">                 // Still need to visually notify for uncached calendars.</span>
<a href="#l100.437"></a><span id="l100.437">                 if (!self.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l100.438"></a><span id="l100.438" class="difflineminus">-                    self.reportDavError(calIErrors.DAV_REMOVE_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l100.439"></a><span id="l100.439" class="difflineplus">+                    self.reportDavError(Ci.calIErrors.DAV_REMOVE_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l100.440"></a><span id="l100.440">                 }</span>
<a href="#l100.441"></a><span id="l100.441"> </span>
<a href="#l100.442"></a><span id="l100.442">                 // Finally, notify listener.</span>
<a href="#l100.443"></a><span id="l100.443">                 notifyListener(listenerStatus, listenerDetail);</span>
<a href="#l100.444"></a><span id="l100.444">             }</span>
<a href="#l100.445"></a><span id="l100.445">         };</span>
<a href="#l100.446"></a><span id="l100.446"> </span>
<a href="#l100.447"></a><span id="l100.447">         let delListener2 = {</span>
<a href="#l100.448"></a><span id="l100.448">             onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.449"></a><span id="l100.449" class="difflineminus">-                let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.450"></a><span id="l100.450" class="difflineminus">-                let listenerStatus = Components.results.NS_OK;</span>
<a href="#l100.451"></a><span id="l100.451" class="difflineplus">+                let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.452"></a><span id="l100.452" class="difflineplus">+                let listenerStatus = Cr.NS_OK;</span>
<a href="#l100.453"></a><span id="l100.453">                 let listenerDetail = aItem;</span>
<a href="#l100.454"></a><span id="l100.454">                 let responseStatus;</span>
<a href="#l100.455"></a><span id="l100.455">                 try {</span>
<a href="#l100.456"></a><span id="l100.456">                     responseStatus = request.responseStatus;</span>
<a href="#l100.457"></a><span id="l100.457"> </span>
<a href="#l100.458"></a><span id="l100.458">                     if (self.verboseLogging()) {</span>
<a href="#l100.459"></a><span id="l100.459">                         let str = new TextDecoder().decode(Uint8Array.from(aResult));</span>
<a href="#l100.460"></a><span id="l100.460">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l100.461"></a><span id="l100.461" class="difflineat">@@ -991,17 +984,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.462"></a><span id="l100.462">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l100.463"></a><span id="l100.463">                     cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l100.464"></a><span id="l100.464">                 }</span>
<a href="#l100.465"></a><span id="l100.465"> </span>
<a href="#l100.466"></a><span id="l100.466">                 if (responseStatus == 404) {</span>
<a href="#l100.467"></a><span id="l100.467">                     // Nothing to do (except notify the listener below)</span>
<a href="#l100.468"></a><span id="l100.468">                     // Someone else has already deleted it</span>
<a href="#l100.469"></a><span id="l100.469">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l100.470"></a><span id="l100.470" class="difflineminus">-                    listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l100.471"></a><span id="l100.471" class="difflineplus">+                    listenerStatus = Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l100.472"></a><span id="l100.472">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l100.473"></a><span id="l100.473">                 } else if (responseStatus) {</span>
<a href="#l100.474"></a><span id="l100.474">                     // The item still exists. We need to ask the user if he</span>
<a href="#l100.475"></a><span id="l100.475">                     // really wants to delete the item. Remember, we only</span>
<a href="#l100.476"></a><span id="l100.476">                     // made this request since the actual delete gave 409/412</span>
<a href="#l100.477"></a><span id="l100.477">                     self.promptOverwrite(CALDAV_DELETE_ITEM, aItem, aListener, null);</span>
<a href="#l100.478"></a><span id="l100.478">                     return;</span>
<a href="#l100.479"></a><span id="l100.479">                 }</span>
<a href="#l100.480"></a><span id="l100.480" class="difflineat">@@ -1019,32 +1012,32 @@ calDavCalendar.prototype = {</span>
<a href="#l100.481"></a><span id="l100.481">             if (!aIgnoreEtag) {</span>
<a href="#l100.482"></a><span id="l100.482">                 let etag = this.mItemInfoCache[aItem.id].etag;</span>
<a href="#l100.483"></a><span id="l100.483">                 cal.LOG(&quot;CalDAV: Will only delete if matches etag &quot; + etag);</span>
<a href="#l100.484"></a><span id="l100.484">                 channel.setRequestHeader(&quot;If-Match&quot;, etag, false);</span>
<a href="#l100.485"></a><span id="l100.485">             }</span>
<a href="#l100.486"></a><span id="l100.486">             channel.requestMethod = &quot;DELETE&quot;;</span>
<a href="#l100.487"></a><span id="l100.487">             return delListener;</span>
<a href="#l100.488"></a><span id="l100.488">         }, () =&gt; {</span>
<a href="#l100.489"></a><span id="l100.489" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.490"></a><span id="l100.490" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.491"></a><span id="l100.491">                            &quot;Error preparing http channel&quot;);</span>
<a href="#l100.492"></a><span id="l100.492">         });</span>
<a href="#l100.493"></a><span id="l100.493">     },</span>
<a href="#l100.494"></a><span id="l100.494"> </span>
<a href="#l100.495"></a><span id="l100.495">     /**</span>
<a href="#l100.496"></a><span id="l100.496">      * Add an item to the target calendar</span>
<a href="#l100.497"></a><span id="l100.497">      *</span>
<a href="#l100.498"></a><span id="l100.498">      * @param path      Item path MUST NOT BE ENCODED</span>
<a href="#l100.499"></a><span id="l100.499">      * @param calData   iCalendar string representation of the item</span>
<a href="#l100.500"></a><span id="l100.500">      * @param aUri      Base URI of the request</span>
<a href="#l100.501"></a><span id="l100.501">      * @param aListener Listener</span>
<a href="#l100.502"></a><span id="l100.502">      */</span>
<a href="#l100.503"></a><span id="l100.503">     addTargetCalendarItem: function(path, calData, aUri, etag, aListener) {</span>
<a href="#l100.504"></a><span id="l100.504" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l100.505"></a><span id="l100.505" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l100.506"></a><span id="l100.506" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l100.507"></a><span id="l100.507" class="difflineplus">+                       .createInstance(Ci.calIIcsParser);</span>
<a href="#l100.508"></a><span id="l100.508">         // aUri.pathQueryRef may contain double slashes whereas path does not</span>
<a href="#l100.509"></a><span id="l100.509">         // this confuses our counting, so remove multiple successive slashes</span>
<a href="#l100.510"></a><span id="l100.510">         let strippedUriPath = aUri.pathQueryRef.replace(/\/{2,}/g, &quot;/&quot;);</span>
<a href="#l100.511"></a><span id="l100.511">         let uriPathComponentLength = strippedUriPath.split(&quot;/&quot;).length;</span>
<a href="#l100.512"></a><span id="l100.512">         try {</span>
<a href="#l100.513"></a><span id="l100.513">             parser.parseString(calData);</span>
<a href="#l100.514"></a><span id="l100.514">         } catch (e) {</span>
<a href="#l100.515"></a><span id="l100.515">             // Warn and continue.</span>
<a href="#l100.516"></a><span id="l100.516" class="difflineat">@@ -1115,23 +1108,23 @@ calDavCalendar.prototype = {</span>
<a href="#l100.517"></a><span id="l100.517">             // If we have a listener, then the caller will take care of adding the item</span>
<a href="#l100.518"></a><span id="l100.518">             // Otherwise, we have to do it ourself</span>
<a href="#l100.519"></a><span id="l100.519">             // XXX This is quite fragile, but saves us a double modify/add</span>
<a href="#l100.520"></a><span id="l100.520"> </span>
<a href="#l100.521"></a><span id="l100.521">             if (aListener) {</span>
<a href="#l100.522"></a><span id="l100.522">                 // In the cached case, notifying operation complete will add the item to the cache</span>
<a href="#l100.523"></a><span id="l100.523">                 if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l100.524"></a><span id="l100.524">                     this.notifyOperationComplete(aListener,</span>
<a href="#l100.525"></a><span id="l100.525" class="difflineminus">-                                                 Components.results.NS_OK,</span>
<a href="#l100.526"></a><span id="l100.526" class="difflineplus">+                                                 Cr.NS_OK,</span>
<a href="#l100.527"></a><span id="l100.527">                                                  cIOL.ADD,</span>
<a href="#l100.528"></a><span id="l100.528">                                                  item.id,</span>
<a href="#l100.529"></a><span id="l100.529">                                                  item);</span>
<a href="#l100.530"></a><span id="l100.530">                 } else {</span>
<a href="#l100.531"></a><span id="l100.531">                     this.notifyOperationComplete(aListener,</span>
<a href="#l100.532"></a><span id="l100.532" class="difflineminus">-                                                 Components.results.NS_OK,</span>
<a href="#l100.533"></a><span id="l100.533" class="difflineplus">+                                                 Cr.NS_OK,</span>
<a href="#l100.534"></a><span id="l100.534">                                                  cIOL.MODIFY,</span>
<a href="#l100.535"></a><span id="l100.535">                                                  item.id,</span>
<a href="#l100.536"></a><span id="l100.536">                                                  item);</span>
<a href="#l100.537"></a><span id="l100.537">                 }</span>
<a href="#l100.538"></a><span id="l100.538">             } else {</span>
<a href="#l100.539"></a><span id="l100.539">                 // No listener, we'll have to add it ourselves</span>
<a href="#l100.540"></a><span id="l100.540">                 needsAddModify = true;</span>
<a href="#l100.541"></a><span id="l100.541">             }</span>
<a href="#l100.542"></a><span id="l100.542" class="difflineat">@@ -1182,18 +1175,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.543"></a><span id="l100.543">      */</span>
<a href="#l100.544"></a><span id="l100.544">     finalizeUpdatedItems: function(aChangeLogListener, calendarURI) {</span>
<a href="#l100.545"></a><span id="l100.545">         cal.LOG(&quot;aChangeLogListener=&quot; + aChangeLogListener + &quot;\n&quot; +</span>
<a href="#l100.546"></a><span id="l100.546">                 &quot;calendarURI=&quot; + (calendarURI ? calendarURI.spec : &quot;undefined&quot;) + &quot; \n&quot; +</span>
<a href="#l100.547"></a><span id="l100.547">                 &quot;iscached=&quot; + this.isCached + &quot;\n&quot; +</span>
<a href="#l100.548"></a><span id="l100.548">                 &quot;this.mQueuedQueries.length=&quot; + this.mQueuedQueries.length);</span>
<a href="#l100.549"></a><span id="l100.549">         if (this.isCached) {</span>
<a href="#l100.550"></a><span id="l100.550">             if (aChangeLogListener) {</span>
<a href="#l100.551"></a><span id="l100.551" class="difflineminus">-                aChangeLogListener.onResult({ status: Components.results.NS_OK },</span>
<a href="#l100.552"></a><span id="l100.552" class="difflineminus">-                                            Components.results.NS_OK);</span>
<a href="#l100.553"></a><span id="l100.553" class="difflineplus">+                aChangeLogListener.onResult({ status: Cr.NS_OK }, Cr.NS_OK);</span>
<a href="#l100.554"></a><span id="l100.554">             }</span>
<a href="#l100.555"></a><span id="l100.555">         } else {</span>
<a href="#l100.556"></a><span id="l100.556">             this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l100.557"></a><span id="l100.557">         }</span>
<a href="#l100.558"></a><span id="l100.558"> </span>
<a href="#l100.559"></a><span id="l100.559">         if (this.mProposedCtag) {</span>
<a href="#l100.560"></a><span id="l100.560">             this.mCtag = this.mProposedCtag;</span>
<a href="#l100.561"></a><span id="l100.561">             this.mProposedCtag = null;</span>
<a href="#l100.562"></a><span id="l100.562" class="difflineat">@@ -1217,33 +1209,32 @@ calDavCalendar.prototype = {</span>
<a href="#l100.563"></a><span id="l100.563">      * @param aListener          (optional) Listener of the request</span>
<a href="#l100.564"></a><span id="l100.564">      * @param aChangeLogListener (optional)Listener for cached calendars</span>
<a href="#l100.565"></a><span id="l100.565">      */</span>
<a href="#l100.566"></a><span id="l100.566">     notifyGetFailed: function(errorMsg, aListener, aChangeLogListener) {</span>
<a href="#l100.567"></a><span id="l100.567">         cal.WARN(&quot;CalDAV: Get failed: &quot; + errorMsg);</span>
<a href="#l100.568"></a><span id="l100.568"> </span>
<a href="#l100.569"></a><span id="l100.569">         // Notify changelog listener</span>
<a href="#l100.570"></a><span id="l100.570">         if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l100.571"></a><span id="l100.571" class="difflineminus">-            aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l100.572"></a><span id="l100.572" class="difflineminus">-                                        Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.573"></a><span id="l100.573" class="difflineplus">+            aChangeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.574"></a><span id="l100.574">         }</span>
<a href="#l100.575"></a><span id="l100.575"> </span>
<a href="#l100.576"></a><span id="l100.576">         // Notify operation listener</span>
<a href="#l100.577"></a><span id="l100.577">         this.notifyOperationComplete(aListener,</span>
<a href="#l100.578"></a><span id="l100.578" class="difflineminus">-                                     Components.results.NS_ERROR_FAILURE,</span>
<a href="#l100.579"></a><span id="l100.579" class="difflineplus">+                                     Cr.NS_ERROR_FAILURE,</span>
<a href="#l100.580"></a><span id="l100.580">                                      cIOL.GET,</span>
<a href="#l100.581"></a><span id="l100.581">                                      null,</span>
<a href="#l100.582"></a><span id="l100.582">                                      errorMsg);</span>
<a href="#l100.583"></a><span id="l100.583">         // If an error occurrs here, we also need to unqueue the</span>
<a href="#l100.584"></a><span id="l100.584">         // requests previously queued.</span>
<a href="#l100.585"></a><span id="l100.585">         while (this.mQueuedQueries.length) {</span>
<a href="#l100.586"></a><span id="l100.586">             let [, , , , listener] = this.mQueuedQueries.pop();</span>
<a href="#l100.587"></a><span id="l100.587">             try {</span>
<a href="#l100.588"></a><span id="l100.588">                 listener.onOperationComplete(this.superCalendar,</span>
<a href="#l100.589"></a><span id="l100.589" class="difflineminus">-                                             Components.results.NS_ERROR_FAILURE,</span>
<a href="#l100.590"></a><span id="l100.590" class="difflineplus">+                                             Cr.NS_ERROR_FAILURE,</span>
<a href="#l100.591"></a><span id="l100.591">                                              cIOL.GET,</span>
<a href="#l100.592"></a><span id="l100.592">                                              null,</span>
<a href="#l100.593"></a><span id="l100.593">                                              errorMsg);</span>
<a href="#l100.594"></a><span id="l100.594">             } catch (e) {</span>
<a href="#l100.595"></a><span id="l100.595">                 cal.ERROR(e);</span>
<a href="#l100.596"></a><span id="l100.596">             }</span>
<a href="#l100.597"></a><span id="l100.597">         }</span>
<a href="#l100.598"></a><span id="l100.598">     },</span>
<a href="#l100.599"></a><span id="l100.599" class="difflineat">@@ -1253,17 +1244,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.600"></a><span id="l100.600">      * Use when an outdated copy of the item is in hand.</span>
<a href="#l100.601"></a><span id="l100.601">      *</span>
<a href="#l100.602"></a><span id="l100.602">      * @param aItem       item to fetch</span>
<a href="#l100.603"></a><span id="l100.603">      * @param aListener   listener for method completion</span>
<a href="#l100.604"></a><span id="l100.604">      */</span>
<a href="#l100.605"></a><span id="l100.605">     getUpdatedItem: function(aItem, aListener, aChangeLogListener) {</span>
<a href="#l100.606"></a><span id="l100.606">         if (aItem == null) {</span>
<a href="#l100.607"></a><span id="l100.607">             this.notifyOperationComplete(aListener,</span>
<a href="#l100.608"></a><span id="l100.608" class="difflineminus">-                                         Components.results.NS_ERROR_FAILURE,</span>
<a href="#l100.609"></a><span id="l100.609" class="difflineplus">+                                         Cr.NS_ERROR_FAILURE,</span>
<a href="#l100.610"></a><span id="l100.610">                                          cIOL.GET,</span>
<a href="#l100.611"></a><span id="l100.611">                                          null,</span>
<a href="#l100.612"></a><span id="l100.612">                                          &quot;passed in null item&quot;);</span>
<a href="#l100.613"></a><span id="l100.613">             return;</span>
<a href="#l100.614"></a><span id="l100.614">         }</span>
<a href="#l100.615"></a><span id="l100.615"> </span>
<a href="#l100.616"></a><span id="l100.616">         let locationPath = this.getItemLocationPath(aItem);</span>
<a href="#l100.617"></a><span id="l100.617">         let itemUri = this.makeUri(locationPath);</span>
<a href="#l100.618"></a><span id="l100.618" class="difflineat">@@ -1287,17 +1278,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.619"></a><span id="l100.619">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l100.620"></a><span id="l100.620">     //                in calIOperationListener aListener );</span>
<a href="#l100.621"></a><span id="l100.621">     getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l100.622"></a><span id="l100.622">         if (this.isCached) {</span>
<a href="#l100.623"></a><span id="l100.623">             if (this.mOfflineStorage) {</span>
<a href="#l100.624"></a><span id="l100.624">                 this.mOfflineStorage.getItems(...arguments);</span>
<a href="#l100.625"></a><span id="l100.625">             } else {</span>
<a href="#l100.626"></a><span id="l100.626">                 this.notifyOperationComplete(aListener,</span>
<a href="#l100.627"></a><span id="l100.627" class="difflineminus">-                                             Components.results.NS_OK,</span>
<a href="#l100.628"></a><span id="l100.628" class="difflineplus">+                                             Cr.NS_OK,</span>
<a href="#l100.629"></a><span id="l100.629">                                              cIOL.GET,</span>
<a href="#l100.630"></a><span id="l100.630">                                              null,</span>
<a href="#l100.631"></a><span id="l100.631">                                              null);</span>
<a href="#l100.632"></a><span id="l100.632">             }</span>
<a href="#l100.633"></a><span id="l100.633">         } else if (this.checkedServerInfo ||</span>
<a href="#l100.634"></a><span id="l100.634">                    this.getProperty(&quot;currentStatus&quot;) == Ci.calIErrors.READ_FAILED) {</span>
<a href="#l100.635"></a><span id="l100.635">             this.mOfflineStorage.getItems(...arguments);</span>
<a href="#l100.636"></a><span id="l100.636">         } else {</span>
<a href="#l100.637"></a><span id="l100.637" class="difflineat">@@ -1352,24 +1343,24 @@ calDavCalendar.prototype = {</span>
<a href="#l100.638"></a><span id="l100.638">         if (this.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l100.639"></a><span id="l100.639">             // the auth could have timed out and be in need of renegotiation</span>
<a href="#l100.640"></a><span id="l100.640">             // we can't risk several calendars doing this simultaneously so</span>
<a href="#l100.641"></a><span id="l100.641">             // we'll force the renegotiation in a sync query, using OPTIONS to keep</span>
<a href="#l100.642"></a><span id="l100.642">             // it quick</span>
<a href="#l100.643"></a><span id="l100.643">             let headchannel = cal.provider.prepHttpChannel(this.makeUri(), null, null, this);</span>
<a href="#l100.644"></a><span id="l100.644">             headchannel.requestMethod = &quot;OPTIONS&quot;;</span>
<a href="#l100.645"></a><span id="l100.645">             headchannel.open();</span>
<a href="#l100.646"></a><span id="l100.646" class="difflineminus">-            headchannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.647"></a><span id="l100.647" class="difflineplus">+            headchannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.648"></a><span id="l100.648">             try {</span>
<a href="#l100.649"></a><span id="l100.649">                 if (headchannel.responseStatus != 200) {</span>
<a href="#l100.650"></a><span id="l100.650">                     throw &quot;OPTIONS returned unexpected status code: &quot; + headchannel.responseStatus;</span>
<a href="#l100.651"></a><span id="l100.651">                 }</span>
<a href="#l100.652"></a><span id="l100.652">             } catch (e) {</span>
<a href="#l100.653"></a><span id="l100.653">                 cal.WARN(&quot;CalDAV: Exception: &quot; + e);</span>
<a href="#l100.654"></a><span id="l100.654" class="difflineminus">-                notifyListener(Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.655"></a><span id="l100.655" class="difflineplus">+                notifyListener(Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.656"></a><span id="l100.656">             }</span>
<a href="#l100.657"></a><span id="l100.657">         }</span>
<a href="#l100.658"></a><span id="l100.658"> </span>
<a href="#l100.659"></a><span id="l100.659">         // Call getUpdatedItems right away if its the first refresh</span>
<a href="#l100.660"></a><span id="l100.660">         // *OR* if webdav Sync is enabled (It is redundant to send a request</span>
<a href="#l100.661"></a><span id="l100.661">         // to get the collection tag (getctag) on a calendar if it supports</span>
<a href="#l100.662"></a><span id="l100.662">         // webdav sync, the sync request will only return data if something</span>
<a href="#l100.663"></a><span id="l100.663">         // changed).</span>
<a href="#l100.664"></a><span id="l100.664" class="difflineat">@@ -1387,31 +1378,31 @@ calDavCalendar.prototype = {</span>
<a href="#l100.665"></a><span id="l100.665">             &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l100.666"></a><span id="l100.666"> </span>
<a href="#l100.667"></a><span id="l100.667">         if (this.verboseLogging()) {</span>
<a href="#l100.668"></a><span id="l100.668">             cal.LOG(&quot;CalDAV: send(&quot; + this.makeUri().spec + &quot;): &quot; + queryXml);</span>
<a href="#l100.669"></a><span id="l100.669">         }</span>
<a href="#l100.670"></a><span id="l100.670"> </span>
<a href="#l100.671"></a><span id="l100.671">         let streamListener = {};</span>
<a href="#l100.672"></a><span id="l100.672">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.673"></a><span id="l100.673" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.674"></a><span id="l100.674" class="difflineplus">+            let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.675"></a><span id="l100.675">             try {</span>
<a href="#l100.676"></a><span id="l100.676">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l100.677"></a><span id="l100.677">                         &quot; checking ctag for calendar &quot; + self.name);</span>
<a href="#l100.678"></a><span id="l100.678">             } catch (ex) {</span>
<a href="#l100.679"></a><span id="l100.679">                 cal.LOG(&quot;CalDAV: Error without status on checking ctag for calendar &quot; +</span>
<a href="#l100.680"></a><span id="l100.680">                         self.name);</span>
<a href="#l100.681"></a><span id="l100.681" class="difflineminus">-                notifyListener(Components.results.NS_OK);</span>
<a href="#l100.682"></a><span id="l100.682" class="difflineplus">+                notifyListener(Cr.NS_OK);</span>
<a href="#l100.683"></a><span id="l100.683">                 return;</span>
<a href="#l100.684"></a><span id="l100.684">             }</span>
<a href="#l100.685"></a><span id="l100.685"> </span>
<a href="#l100.686"></a><span id="l100.686">             if (request.responseStatus == 404) {</span>
<a href="#l100.687"></a><span id="l100.687">                 cal.LOG(&quot;CalDAV: Disabling calendar &quot; + self.name +</span>
<a href="#l100.688"></a><span id="l100.688">                         &quot; due to 404&quot;);</span>
<a href="#l100.689"></a><span id="l100.689" class="difflineminus">-                notifyListener(Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.690"></a><span id="l100.690" class="difflineplus">+                notifyListener(Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.691"></a><span id="l100.691">                 return;</span>
<a href="#l100.692"></a><span id="l100.692">             } else if (request.responseStatus == 207 &amp;&amp; self.mDisabled) {</span>
<a href="#l100.693"></a><span id="l100.693">                 // Looks like the calendar is there again, check its resource</span>
<a href="#l100.694"></a><span id="l100.694">                 // type first.</span>
<a href="#l100.695"></a><span id="l100.695">                 self.setupAuthentication(aChangeLogListener);</span>
<a href="#l100.696"></a><span id="l100.696">                 return;</span>
<a href="#l100.697"></a><span id="l100.697">             }</span>
<a href="#l100.698"></a><span id="l100.698"> </span>
<a href="#l100.699"></a><span id="l100.699" class="difflineat">@@ -1424,17 +1415,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.700"></a><span id="l100.700">             }</span>
<a href="#l100.701"></a><span id="l100.701"> </span>
<a href="#l100.702"></a><span id="l100.702">             let multistatus;</span>
<a href="#l100.703"></a><span id="l100.703">             try {</span>
<a href="#l100.704"></a><span id="l100.704">                 multistatus = cal.xml.parseString(str);</span>
<a href="#l100.705"></a><span id="l100.705">             } catch (ex) {</span>
<a href="#l100.706"></a><span id="l100.706">                 cal.LOG(&quot;CalDAV: Failed to get ctag from server for calendar &quot; +</span>
<a href="#l100.707"></a><span id="l100.707">                         self.name);</span>
<a href="#l100.708"></a><span id="l100.708" class="difflineminus">-                notifyListener(Components.results.NS_OK);</span>
<a href="#l100.709"></a><span id="l100.709" class="difflineplus">+                notifyListener(Cr.NS_OK);</span>
<a href="#l100.710"></a><span id="l100.710">                 return;</span>
<a href="#l100.711"></a><span id="l100.711">             }</span>
<a href="#l100.712"></a><span id="l100.712"> </span>
<a href="#l100.713"></a><span id="l100.713">             let ctag = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/CS:getctag/text()&quot;);</span>
<a href="#l100.714"></a><span id="l100.714">             if (!ctag || ctag != self.mCtag) {</span>
<a href="#l100.715"></a><span id="l100.715">                 // ctag mismatch, need to fetch calendar-data</span>
<a href="#l100.716"></a><span id="l100.716">                 self.mProposedCtag = ctag;</span>
<a href="#l100.717"></a><span id="l100.717">                 self.getUpdatedItems(self.calendarUri, aChangeLogListener);</span>
<a href="#l100.718"></a><span id="l100.718" class="difflineat">@@ -1444,31 +1435,31 @@ calDavCalendar.prototype = {</span>
<a href="#l100.719"></a><span id="l100.719">                 }</span>
<a href="#l100.720"></a><span id="l100.720">             } else {</span>
<a href="#l100.721"></a><span id="l100.721">                 if (self.verboseLogging()) {</span>
<a href="#l100.722"></a><span id="l100.722">                     cal.LOG(&quot;CalDAV: ctag matches, no need to fetch data for &quot; +</span>
<a href="#l100.723"></a><span id="l100.723">                             &quot;calendar &quot; + self.name);</span>
<a href="#l100.724"></a><span id="l100.724">                 }</span>
<a href="#l100.725"></a><span id="l100.725"> </span>
<a href="#l100.726"></a><span id="l100.726">                 // Notify the listener, but don't return just yet...</span>
<a href="#l100.727"></a><span id="l100.727" class="difflineminus">-                notifyListener(Components.results.NS_OK);</span>
<a href="#l100.728"></a><span id="l100.728" class="difflineplus">+                notifyListener(Cr.NS_OK);</span>
<a href="#l100.729"></a><span id="l100.729"> </span>
<a href="#l100.730"></a><span id="l100.730">                 // ...we may still need to poll the inbox</span>
<a href="#l100.731"></a><span id="l100.731">                 if (self.firstInRealm()) {</span>
<a href="#l100.732"></a><span id="l100.732">                     self.pollInbox();</span>
<a href="#l100.733"></a><span id="l100.733">                 }</span>
<a href="#l100.734"></a><span id="l100.734">             }</span>
<a href="#l100.735"></a><span id="l100.735">         };</span>
<a href="#l100.736"></a><span id="l100.736"> </span>
<a href="#l100.737"></a><span id="l100.737">         this.sendHttpRequest(this.makeUri(), queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l100.738"></a><span id="l100.738">             channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l100.739"></a><span id="l100.739">             channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l100.740"></a><span id="l100.740">             return streamListener;</span>
<a href="#l100.741"></a><span id="l100.741">         }, () =&gt; {</span>
<a href="#l100.742"></a><span id="l100.742" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l100.743"></a><span id="l100.743" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l100.744"></a><span id="l100.744">         });</span>
<a href="#l100.745"></a><span id="l100.745">     },</span>
<a href="#l100.746"></a><span id="l100.746"> </span>
<a href="#l100.747"></a><span id="l100.747">     refresh: function() {</span>
<a href="#l100.748"></a><span id="l100.748">         this.replayChangesOn(null);</span>
<a href="#l100.749"></a><span id="l100.749">     },</span>
<a href="#l100.750"></a><span id="l100.750"> </span>
<a href="#l100.751"></a><span id="l100.751">     firstInRealm: function() {</span>
<a href="#l100.752"></a><span id="l100.752" class="difflineat">@@ -1533,18 +1524,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.753"></a><span id="l100.753">         }</span>
<a href="#l100.754"></a><span id="l100.754"> </span>
<a href="#l100.755"></a><span id="l100.755">         this.sendHttpRequest(requestUri, queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l100.756"></a><span id="l100.756">             channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l100.757"></a><span id="l100.757">             channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l100.758"></a><span id="l100.758">             return new etagsHandler(this, aUri, aChangeLogListener);</span>
<a href="#l100.759"></a><span id="l100.759">         }, () =&gt; {</span>
<a href="#l100.760"></a><span id="l100.760">             if (aChangeLogListener &amp;&amp; this.isCached) {</span>
<a href="#l100.761"></a><span id="l100.761" class="difflineminus">-                aChangeLogListener.onResult({ status: Components.results.NS_ERROR_NOT_AVAILABLE },</span>
<a href="#l100.762"></a><span id="l100.762" class="difflineminus">-                                            Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l100.763"></a><span id="l100.763" class="difflineplus">+                aChangeLogListener.onResult({ status: Cr.NS_ERROR_NOT_AVAILABLE }, Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l100.764"></a><span id="l100.764">             }</span>
<a href="#l100.765"></a><span id="l100.765">         }, false);</span>
<a href="#l100.766"></a><span id="l100.766">     },</span>
<a href="#l100.767"></a><span id="l100.767"> </span>
<a href="#l100.768"></a><span id="l100.768">     /**</span>
<a href="#l100.769"></a><span id="l100.769">      * @see nsIInterfaceRequestor</span>
<a href="#l100.770"></a><span id="l100.770">      * @see calProviderUtils.jsm</span>
<a href="#l100.771"></a><span id="l100.771">      */</span>
<a href="#l100.772"></a><span id="l100.772" class="difflineat">@@ -1572,18 +1562,18 @@ calDavCalendar.prototype = {</span>
<a href="#l100.773"></a><span id="l100.773">                     if (callback) {</span>
<a href="#l100.774"></a><span id="l100.774">                         callback.onAuthResult(false);</span>
<a href="#l100.775"></a><span id="l100.775">                     }</span>
<a href="#l100.776"></a><span id="l100.776">                 }, true, aRefresh);</span>
<a href="#l100.777"></a><span id="l100.777">             },</span>
<a href="#l100.778"></a><span id="l100.778">             onPromptCanceled: authFailureCb,</span>
<a href="#l100.779"></a><span id="l100.779">             onPromptStart: function() {}</span>
<a href="#l100.780"></a><span id="l100.780">         };</span>
<a href="#l100.781"></a><span id="l100.781" class="difflineminus">-        let asyncprompter = Components.classes[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l100.782"></a><span id="l100.782" class="difflineminus">-                                      .getService(Components.interfaces.nsIMsgAsyncPrompter);</span>
<a href="#l100.783"></a><span id="l100.783" class="difflineplus">+        let asyncprompter = Cc[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l100.784"></a><span id="l100.784" class="difflineplus">+                              .getService(Ci.nsIMsgAsyncPrompter);</span>
<a href="#l100.785"></a><span id="l100.785">         asyncprompter.queueAsyncAuthPrompt(self.uri.spec, false, promptlistener);</span>
<a href="#l100.786"></a><span id="l100.786">     },</span>
<a href="#l100.787"></a><span id="l100.787"> </span>
<a href="#l100.788"></a><span id="l100.788">     /**</span>
<a href="#l100.789"></a><span id="l100.789">      * Sets up any needed prerequisites regarding authentication. This is the</span>
<a href="#l100.790"></a><span id="l100.790">      * beginning of a chain of asynchronous calls. This function will, when</span>
<a href="#l100.791"></a><span id="l100.791">      * done, call the next function related to checking resource type, server</span>
<a href="#l100.792"></a><span id="l100.792">      * capabilties, etc.</span>
<a href="#l100.793"></a><span id="l100.793" class="difflineat">@@ -1598,17 +1588,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.794"></a><span id="l100.794">     setupAuthentication: function(aChangeLogListener) {</span>
<a href="#l100.795"></a><span id="l100.795">         let self = this;</span>
<a href="#l100.796"></a><span id="l100.796">         function authSuccess() {</span>
<a href="#l100.797"></a><span id="l100.797">             self.checkDavResourceType(aChangeLogListener);</span>
<a href="#l100.798"></a><span id="l100.798">         }</span>
<a href="#l100.799"></a><span id="l100.799">         function authFailed() {</span>
<a href="#l100.800"></a><span id="l100.800">             self.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l100.801"></a><span id="l100.801">             self.setProperty(&quot;auto-enabled&quot;, &quot;true&quot;);</span>
<a href="#l100.802"></a><span id="l100.802" class="difflineminus">-            self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.803"></a><span id="l100.803" class="difflineplus">+            self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.804"></a><span id="l100.804">         }</span>
<a href="#l100.805"></a><span id="l100.805">         if (this.mUri.host == &quot;apidata.googleusercontent.com&quot;) {</span>
<a href="#l100.806"></a><span id="l100.806">             if (!this.oauth) {</span>
<a href="#l100.807"></a><span id="l100.807">                 let sessionId = this.id;</span>
<a href="#l100.808"></a><span id="l100.808">                 let pwMgrId = &quot;Google CalDAV v2&quot;;</span>
<a href="#l100.809"></a><span id="l100.809">                 let authTitle = cal.l10n.getAnyString(</span>
<a href="#l100.810"></a><span id="l100.810">                     &quot;global&quot;, &quot;commonDialogs&quot;, &quot;EnterUserPasswordFor2&quot;, [this.name]</span>
<a href="#l100.811"></a><span id="l100.811">                 );</span>
<a href="#l100.812"></a><span id="l100.812" class="difflineat">@@ -1621,17 +1611,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.813"></a><span id="l100.813">                     get: function() {</span>
<a href="#l100.814"></a><span id="l100.814">                         if (!this.mRefreshToken) {</span>
<a href="#l100.815"></a><span id="l100.815">                             let pass = { value: null };</span>
<a href="#l100.816"></a><span id="l100.816">                             try {</span>
<a href="#l100.817"></a><span id="l100.817">                                 let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l100.818"></a><span id="l100.818">                                 cal.auth.passwordManagerGet(sessionId, pass, origin, pwMgrId);</span>
<a href="#l100.819"></a><span id="l100.819">                             } catch (e) {</span>
<a href="#l100.820"></a><span id="l100.820">                                 // User might have cancelled the master password prompt, thats ok</span>
<a href="#l100.821"></a><span id="l100.821" class="difflineminus">-                                if (e.result != Components.results.NS_ERROR_ABORT) {</span>
<a href="#l100.822"></a><span id="l100.822" class="difflineplus">+                                if (e.result != Cr.NS_ERROR_ABORT) {</span>
<a href="#l100.823"></a><span id="l100.823">                                     throw e;</span>
<a href="#l100.824"></a><span id="l100.824">                                 }</span>
<a href="#l100.825"></a><span id="l100.825">                             }</span>
<a href="#l100.826"></a><span id="l100.826">                             this.mRefreshToken = pass.value;</span>
<a href="#l100.827"></a><span id="l100.827">                         }</span>
<a href="#l100.828"></a><span id="l100.828">                         return this.mRefreshToken;</span>
<a href="#l100.829"></a><span id="l100.829">                     },</span>
<a href="#l100.830"></a><span id="l100.830">                     set: function(val) {</span>
<a href="#l100.831"></a><span id="l100.831" class="difflineat">@@ -1640,18 +1630,18 @@ calDavCalendar.prototype = {</span>
<a href="#l100.832"></a><span id="l100.832">                             if (val) {</span>
<a href="#l100.833"></a><span id="l100.833">                                 cal.auth.passwordManagerSave(sessionId, val, origin, pwMgrId);</span>
<a href="#l100.834"></a><span id="l100.834">                             } else {</span>
<a href="#l100.835"></a><span id="l100.835">                                 cal.auth.passwordManagerRemove(sessionId, origin, pwMgrId);</span>
<a href="#l100.836"></a><span id="l100.836">                             }</span>
<a href="#l100.837"></a><span id="l100.837">                         } catch (e) {</span>
<a href="#l100.838"></a><span id="l100.838">                             // User might have cancelled the master password prompt, or password saving</span>
<a href="#l100.839"></a><span id="l100.839">                             // could be disabled. That is ok, throw for everything else.</span>
<a href="#l100.840"></a><span id="l100.840" class="difflineminus">-                            if (e.result != Components.results.NS_ERROR_ABORT &amp;&amp;</span>
<a href="#l100.841"></a><span id="l100.841" class="difflineminus">-                                e.result != Components.results.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l100.842"></a><span id="l100.842" class="difflineplus">+                            if (e.result != Cr.NS_ERROR_ABORT &amp;&amp;</span>
<a href="#l100.843"></a><span id="l100.843" class="difflineplus">+                                e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l100.844"></a><span id="l100.844">                                 throw e;</span>
<a href="#l100.845"></a><span id="l100.845">                             }</span>
<a href="#l100.846"></a><span id="l100.846">                         }</span>
<a href="#l100.847"></a><span id="l100.847">                         return (this.mRefreshToken = val);</span>
<a href="#l100.848"></a><span id="l100.848">                     },</span>
<a href="#l100.849"></a><span id="l100.849">                     enumerable: true</span>
<a href="#l100.850"></a><span id="l100.850">                 });</span>
<a href="#l100.851"></a><span id="l100.851">             }</span>
<a href="#l100.852"></a><span id="l100.852" class="difflineat">@@ -1707,36 +1697,35 @@ calDavCalendar.prototype = {</span>
<a href="#l100.853"></a><span id="l100.853">             &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l100.854"></a><span id="l100.854"> </span>
<a href="#l100.855"></a><span id="l100.855">         if (this.verboseLogging()) {</span>
<a href="#l100.856"></a><span id="l100.856">             cal.LOG(&quot;CalDAV: send: &quot; + queryXml);</span>
<a href="#l100.857"></a><span id="l100.857">         }</span>
<a href="#l100.858"></a><span id="l100.858">         let streamListener = {};</span>
<a href="#l100.859"></a><span id="l100.859"> </span>
<a href="#l100.860"></a><span id="l100.860">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.861"></a><span id="l100.861" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.862"></a><span id="l100.862" class="difflineplus">+            let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.863"></a><span id="l100.863">             try {</span>
<a href="#l100.864"></a><span id="l100.864">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l100.865"></a><span id="l100.865">                         &quot; on initial PROPFIND for calendar &quot; + self.name);</span>
<a href="#l100.866"></a><span id="l100.866">             } catch (ex) {</span>
<a href="#l100.867"></a><span id="l100.867">                 cal.LOG(&quot;CalDAV: Error without status on initial PROPFIND for calendar &quot; +</span>
<a href="#l100.868"></a><span id="l100.868">                         self.name);</span>
<a href="#l100.869"></a><span id="l100.869" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l100.870"></a><span id="l100.870" class="difflineminus">-                                             Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l100.871"></a><span id="l100.871" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Ci.calIErrors.DAV_NOT_DAV);</span>
<a href="#l100.872"></a><span id="l100.872">                 return;</span>
<a href="#l100.873"></a><span id="l100.873">             }</span>
<a href="#l100.874"></a><span id="l100.874"> </span>
<a href="#l100.875"></a><span id="l100.875">             let isText = true;</span>
<a href="#l100.876"></a><span id="l100.876"> </span>
<a href="#l100.877"></a><span id="l100.877">             if ((isText || request.URI.spec != request.originalURI.spec) &amp;&amp;</span>
<a href="#l100.878"></a><span id="l100.878">                 self.mLastRedirectStatus == 301) {</span>
<a href="#l100.879"></a><span id="l100.879">                 // The initial PROPFIND essentially goes against the calendar</span>
<a href="#l100.880"></a><span id="l100.880">                 // collection url. If a 301 Moved Permanently redirect occurred</span>
<a href="#l100.881"></a><span id="l100.881">                 // here, we want to modify the url we use in the future.</span>
<a href="#l100.882"></a><span id="l100.882" class="difflineminus">-                let nIPS = Components.interfaces.nsIPromptService;</span>
<a href="#l100.883"></a><span id="l100.883" class="difflineplus">+                let nIPS = Ci.nsIPromptService;</span>
<a href="#l100.884"></a><span id="l100.884"> </span>
<a href="#l100.885"></a><span id="l100.885">                 let promptTitle = cal.l10n.getCalString(&quot;caldavRedirectTitle&quot;, [self.name]);</span>
<a href="#l100.886"></a><span id="l100.886">                 let promptText = cal.l10n.getCalString(&quot;caldavRedirectText&quot;, [self.name]) +</span>
<a href="#l100.887"></a><span id="l100.887">                                  &quot;\n\n&quot; + request.URI.spec;</span>
<a href="#l100.888"></a><span id="l100.888">                 let button1Title = cal.l10n.getCalString(&quot;caldavRedirectDisableCalendar&quot;);</span>
<a href="#l100.889"></a><span id="l100.889">                 let flags = (nIPS.BUTTON_TITLE_YES * nIPS.BUTTON_POS_0) +</span>
<a href="#l100.890"></a><span id="l100.890">                             (nIPS.BUTTON_TITLE_IS_STRING * nIPS.BUTTON_POS_1);</span>
<a href="#l100.891"></a><span id="l100.891"> </span>
<a href="#l100.892"></a><span id="l100.892" class="difflineat">@@ -1748,39 +1737,39 @@ calDavCalendar.prototype = {</span>
<a href="#l100.893"></a><span id="l100.893">                 if (res == 0) { // YES</span>
<a href="#l100.894"></a><span id="l100.894">                     let newUri = request.URI;</span>
<a href="#l100.895"></a><span id="l100.895">                     cal.LOG(&quot;CalDAV: Migrating url due to redirect: &quot; +</span>
<a href="#l100.896"></a><span id="l100.896">                             self.mUri.spec + &quot; -&gt; &quot; + newUri.spec);</span>
<a href="#l100.897"></a><span id="l100.897">                     self.mUri = newUri;</span>
<a href="#l100.898"></a><span id="l100.898">                     self.setProperty(&quot;uri&quot;, newUri.spec);</span>
<a href="#l100.899"></a><span id="l100.899">                 } else if (res == 1) { // DISABLE CALENDAR</span>
<a href="#l100.900"></a><span id="l100.900">                     self.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l100.901"></a><span id="l100.901" class="difflineminus">-                    self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l100.902"></a><span id="l100.902" class="difflineplus">+                    self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_ABORT);</span>
<a href="#l100.903"></a><span id="l100.903">                     return;</span>
<a href="#l100.904"></a><span id="l100.904">                 }</span>
<a href="#l100.905"></a><span id="l100.905">             }</span>
<a href="#l100.906"></a><span id="l100.906"> </span>
<a href="#l100.907"></a><span id="l100.907">             let responseStatusCategory = Math.floor(request.responseStatus / 100);</span>
<a href="#l100.908"></a><span id="l100.908"> </span>
<a href="#l100.909"></a><span id="l100.909">             // 4xx codes, which is either an authentication failure or</span>
<a href="#l100.910"></a><span id="l100.910">             // something like method not allowed. This is a failure worth</span>
<a href="#l100.911"></a><span id="l100.911">             // disabling the calendar.</span>
<a href="#l100.912"></a><span id="l100.912">             if (responseStatusCategory == 4) {</span>
<a href="#l100.913"></a><span id="l100.913">                 self.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l100.914"></a><span id="l100.914">                 self.setProperty(&quot;auto-enabled&quot;, &quot;true&quot;);</span>
<a href="#l100.915"></a><span id="l100.915" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l100.916"></a><span id="l100.916" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_ABORT);</span>
<a href="#l100.917"></a><span id="l100.917">                 return;</span>
<a href="#l100.918"></a><span id="l100.918">             }</span>
<a href="#l100.919"></a><span id="l100.919"> </span>
<a href="#l100.920"></a><span id="l100.920">             // 5xx codes, a server error. This could be a temporary failure,</span>
<a href="#l100.921"></a><span id="l100.921">             // i.e a backend server being disabled.</span>
<a href="#l100.922"></a><span id="l100.922">             if (responseStatusCategory == 5) {</span>
<a href="#l100.923"></a><span id="l100.923">                 cal.LOG(&quot;CalDAV: Server not available &quot; + request.responseStatus +</span>
<a href="#l100.924"></a><span id="l100.924">                         &quot;, abort sync for calendar &quot; + self.name);</span>
<a href="#l100.925"></a><span id="l100.925" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l100.926"></a><span id="l100.926" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_ABORT);</span>
<a href="#l100.927"></a><span id="l100.927">                 return;</span>
<a href="#l100.928"></a><span id="l100.928">             }</span>
<a href="#l100.929"></a><span id="l100.929"> </span>
<a href="#l100.930"></a><span id="l100.930">             let wwwauth;</span>
<a href="#l100.931"></a><span id="l100.931">             try {</span>
<a href="#l100.932"></a><span id="l100.932">                 wwwauth = request.getRequestHeader(&quot;Authorization&quot;);</span>
<a href="#l100.933"></a><span id="l100.933">                 self.mAuthScheme = wwwauth.split(&quot; &quot;)[0];</span>
<a href="#l100.934"></a><span id="l100.934">             } catch (ex) {</span>
<a href="#l100.935"></a><span id="l100.935" class="difflineat">@@ -1801,31 +1790,29 @@ calDavCalendar.prototype = {</span>
<a href="#l100.936"></a><span id="l100.936">                 cal.LOG(&quot;CalDAV: realm &quot; + self.mAuthRealm);</span>
<a href="#l100.937"></a><span id="l100.937">             }</span>
<a href="#l100.938"></a><span id="l100.938"> </span>
<a href="#l100.939"></a><span id="l100.939">             let str = new TextDecoder().decode(Uint8Array.from(aResult));</span>
<a href="#l100.940"></a><span id="l100.940">             if (!str || request.responseStatus == 404) {</span>
<a href="#l100.941"></a><span id="l100.941">                 // No response, or the calendar no longer exists.</span>
<a href="#l100.942"></a><span id="l100.942">                 cal.LOG(&quot;CalDAV: Failed to determine resource type for&quot; +</span>
<a href="#l100.943"></a><span id="l100.943">                         self.name);</span>
<a href="#l100.944"></a><span id="l100.944" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l100.945"></a><span id="l100.945" class="difflineminus">-                                             Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l100.946"></a><span id="l100.946" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Ci.calIErrors.DAV_NOT_DAV);</span>
<a href="#l100.947"></a><span id="l100.947">                 return;</span>
<a href="#l100.948"></a><span id="l100.948">             } else if (self.verboseLogging()) {</span>
<a href="#l100.949"></a><span id="l100.949">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l100.950"></a><span id="l100.950">             }</span>
<a href="#l100.951"></a><span id="l100.951"> </span>
<a href="#l100.952"></a><span id="l100.952">             let multistatus;</span>
<a href="#l100.953"></a><span id="l100.953">             try {</span>
<a href="#l100.954"></a><span id="l100.954">                 multistatus = cal.xml.parseString(str);</span>
<a href="#l100.955"></a><span id="l100.955">             } catch (ex) {</span>
<a href="#l100.956"></a><span id="l100.956">                 cal.LOG(&quot;CalDAV: Failed to determine resource type for&quot; +</span>
<a href="#l100.957"></a><span id="l100.957">                         self.name + &quot;: &quot; + ex);</span>
<a href="#l100.958"></a><span id="l100.958" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l100.959"></a><span id="l100.959" class="difflineminus">-                                             Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l100.960"></a><span id="l100.960" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Ci.calIErrors.DAV_NOT_DAV);</span>
<a href="#l100.961"></a><span id="l100.961">                 return;</span>
<a href="#l100.962"></a><span id="l100.962">             }</span>
<a href="#l100.963"></a><span id="l100.963"> </span>
<a href="#l100.964"></a><span id="l100.964">             // check for webdav-sync capability</span>
<a href="#l100.965"></a><span id="l100.965">             // http://tools.ietf.org/html/draft-daboo-webdav-sync</span>
<a href="#l100.966"></a><span id="l100.966">             if (caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop&quot; +</span>
<a href="#l100.967"></a><span id="l100.967">                                  &quot;/D:supported-report-set/D:supported-report/D:report/D:sync-collection&quot;)) {</span>
<a href="#l100.968"></a><span id="l100.968">                 cal.LOG(&quot;CalDAV: Collection has webdav sync support&quot;);</span>
<a href="#l100.969"></a><span id="l100.969" class="difflineat">@@ -1880,50 +1867,48 @@ calDavCalendar.prototype = {</span>
<a href="#l100.970"></a><span id="l100.970">             } else if (caldavXPath(resourceTypeXml[0], &quot;C:calendar&quot;)) {</span>
<a href="#l100.971"></a><span id="l100.971">                 resourceType = kDavResourceTypeCalendar;</span>
<a href="#l100.972"></a><span id="l100.972">             } else if (caldavXPath(resourceTypeXml[0], &quot;D:collection&quot;)) {</span>
<a href="#l100.973"></a><span id="l100.973">                 resourceType = kDavResourceTypeCollection;</span>
<a href="#l100.974"></a><span id="l100.974">             }</span>
<a href="#l100.975"></a><span id="l100.975"> </span>
<a href="#l100.976"></a><span id="l100.976">             if (resourceType == kDavResourceTypeNone) {</span>
<a href="#l100.977"></a><span id="l100.977">                 cal.LOG(&quot;CalDAV: No resource type received, &quot; + self.name + &quot; doesn't seem to point to a DAV resource&quot;);</span>
<a href="#l100.978"></a><span id="l100.978" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l100.979"></a><span id="l100.979" class="difflineminus">-                                             Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l100.980"></a><span id="l100.980" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Ci.calIErrors.DAV_NOT_DAV);</span>
<a href="#l100.981"></a><span id="l100.981">                 return;</span>
<a href="#l100.982"></a><span id="l100.982">             }</span>
<a href="#l100.983"></a><span id="l100.983"> </span>
<a href="#l100.984"></a><span id="l100.984">             if (resourceType == kDavResourceTypeCollection) {</span>
<a href="#l100.985"></a><span id="l100.985">                 cal.LOG(&quot;CalDAV: &quot; + self.name + &quot; points to a DAV resource, but not a CalDAV calendar&quot;);</span>
<a href="#l100.986"></a><span id="l100.986" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l100.987"></a><span id="l100.987" class="difflineminus">-                                             Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV);</span>
<a href="#l100.988"></a><span id="l100.988" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Ci.calIErrors.DAV_DAV_NOT_CALDAV);</span>
<a href="#l100.989"></a><span id="l100.989">                 return;</span>
<a href="#l100.990"></a><span id="l100.990">             }</span>
<a href="#l100.991"></a><span id="l100.991"> </span>
<a href="#l100.992"></a><span id="l100.992">             if (resourceType == kDavResourceTypeCalendar) {</span>
<a href="#l100.993"></a><span id="l100.993">                 // If this calendar was previously offline we want to recover</span>
<a href="#l100.994"></a><span id="l100.994">                 if (self.mDisabled) {</span>
<a href="#l100.995"></a><span id="l100.995">                     self.mDisabled = false;</span>
<a href="#l100.996"></a><span id="l100.996">                     self.mReadOnly = false;</span>
<a href="#l100.997"></a><span id="l100.997">                 }</span>
<a href="#l100.998"></a><span id="l100.998">                 self.setCalHomeSet(true);</span>
<a href="#l100.999"></a><span id="l100.999">                 self.checkServerCaps(aChangeLogListener);</span>
<a href="#l100.1000"></a><span id="l100.1000">                 return;</span>
<a href="#l100.1001"></a><span id="l100.1001">             }</span>
<a href="#l100.1002"></a><span id="l100.1002"> </span>
<a href="#l100.1003"></a><span id="l100.1003">             // If we get here something must have gone wrong. Abort with a</span>
<a href="#l100.1004"></a><span id="l100.1004">             // general error to avoid an endless loop.</span>
<a href="#l100.1005"></a><span id="l100.1005" class="difflineminus">-            self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.1006"></a><span id="l100.1006" class="difflineplus">+            self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.1007"></a><span id="l100.1007">         };</span>
<a href="#l100.1008"></a><span id="l100.1008"> </span>
<a href="#l100.1009"></a><span id="l100.1009">         this.sendHttpRequest(this.makeUri(), queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l100.1010"></a><span id="l100.1010">             channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l100.1011"></a><span id="l100.1011">             channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l100.1012"></a><span id="l100.1012">             return streamListener;</span>
<a href="#l100.1013"></a><span id="l100.1013">         }, () =&gt; {</span>
<a href="#l100.1014"></a><span id="l100.1014" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.1015"></a><span id="l100.1015" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.1016"></a><span id="l100.1016">                            &quot;Error preparing http channel&quot;);</span>
<a href="#l100.1017"></a><span id="l100.1017">         });</span>
<a href="#l100.1018"></a><span id="l100.1018">     },</span>
<a href="#l100.1019"></a><span id="l100.1019"> </span>
<a href="#l100.1020"></a><span id="l100.1020">     /**</span>
<a href="#l100.1021"></a><span id="l100.1021">      * Checks server capabilities.</span>
<a href="#l100.1022"></a><span id="l100.1022">      *</span>
<a href="#l100.1023"></a><span id="l100.1023">      * setupAuthentication</span>
<a href="#l100.1024"></a><span id="l100.1024" class="difflineat">@@ -1938,28 +1923,28 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1025"></a><span id="l100.1025">         let self = this;</span>
<a href="#l100.1026"></a><span id="l100.1026"> </span>
<a href="#l100.1027"></a><span id="l100.1027">         if (this.verboseLogging()) {</span>
<a href="#l100.1028"></a><span id="l100.1028">             cal.LOG(&quot;CalDAV: send: OPTIONS &quot; + homeSet.spec);</span>
<a href="#l100.1029"></a><span id="l100.1029">         }</span>
<a href="#l100.1030"></a><span id="l100.1030"> </span>
<a href="#l100.1031"></a><span id="l100.1031">         let streamListener = {};</span>
<a href="#l100.1032"></a><span id="l100.1032">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.1033"></a><span id="l100.1033" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.1034"></a><span id="l100.1034" class="difflineplus">+            let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.1035"></a><span id="l100.1035">             if (request.responseStatus != 200 &amp;&amp; request.responseStatus != 204) {</span>
<a href="#l100.1036"></a><span id="l100.1036">                 if (!calHomeSetUrlRetry &amp;&amp; request.responseStatus == 404) {</span>
<a href="#l100.1037"></a><span id="l100.1037">                     // try again with calendar URL, see https://bugzilla.mozilla.org/show_bug.cgi?id=588799</span>
<a href="#l100.1038"></a><span id="l100.1038">                     cal.LOG(&quot;CalDAV: Calendar homeset was not found at parent url of calendar URL&quot; +</span>
<a href="#l100.1039"></a><span id="l100.1039">                             &quot; while querying options &quot; + self.name + &quot;, will try calendar URL itself now&quot;);</span>
<a href="#l100.1040"></a><span id="l100.1040">                     self.setCalHomeSet(false);</span>
<a href="#l100.1041"></a><span id="l100.1041">                     self.checkServerCaps(aChangeLogListener, true);</span>
<a href="#l100.1042"></a><span id="l100.1042">                 } else {</span>
<a href="#l100.1043"></a><span id="l100.1043">                     cal.LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l100.1044"></a><span id="l100.1044">                             &quot; while querying options &quot; + self.name);</span>
<a href="#l100.1045"></a><span id="l100.1045" class="difflineminus">-                    self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.1046"></a><span id="l100.1046" class="difflineplus">+                    self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.1047"></a><span id="l100.1047">                 }</span>
<a href="#l100.1048"></a><span id="l100.1048"> </span>
<a href="#l100.1049"></a><span id="l100.1049">                 // No further processing needed, we have called subsequent (async) functions above.</span>
<a href="#l100.1050"></a><span id="l100.1050">                 return;</span>
<a href="#l100.1051"></a><span id="l100.1051">             }</span>
<a href="#l100.1052"></a><span id="l100.1052"> </span>
<a href="#l100.1053"></a><span id="l100.1053">             let dav = null;</span>
<a href="#l100.1054"></a><span id="l100.1054">             try {</span>
<a href="#l100.1055"></a><span id="l100.1055" class="difflineat">@@ -2012,17 +1997,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1056"></a><span id="l100.1056">                 self.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l100.1057"></a><span id="l100.1057">             }</span>
<a href="#l100.1058"></a><span id="l100.1058">         };</span>
<a href="#l100.1059"></a><span id="l100.1059"> </span>
<a href="#l100.1060"></a><span id="l100.1060">         this.sendHttpRequest(homeSet, null, null, null, (channel) =&gt; {</span>
<a href="#l100.1061"></a><span id="l100.1061">             channel.requestMethod = &quot;OPTIONS&quot;;</span>
<a href="#l100.1062"></a><span id="l100.1062">             return streamListener;</span>
<a href="#l100.1063"></a><span id="l100.1063">         }, () =&gt; {</span>
<a href="#l100.1064"></a><span id="l100.1064" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.1065"></a><span id="l100.1065" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.1066"></a><span id="l100.1066">                            &quot;Error preparing http channel&quot;);</span>
<a href="#l100.1067"></a><span id="l100.1067">         });</span>
<a href="#l100.1068"></a><span id="l100.1068">     },</span>
<a href="#l100.1069"></a><span id="l100.1069"> </span>
<a href="#l100.1070"></a><span id="l100.1070">     /**</span>
<a href="#l100.1071"></a><span id="l100.1071">      * Locates the principal namespace. This function should soely be called</span>
<a href="#l100.1072"></a><span id="l100.1072">      * from checkServerCaps to find the principal namespace.</span>
<a href="#l100.1073"></a><span id="l100.1073">      *</span>
<a href="#l100.1074"></a><span id="l100.1074" class="difflineat">@@ -2052,42 +2037,39 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1075"></a><span id="l100.1075">               &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l100.1076"></a><span id="l100.1076">             &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l100.1077"></a><span id="l100.1077"> </span>
<a href="#l100.1078"></a><span id="l100.1078">         if (this.verboseLogging()) {</span>
<a href="#l100.1079"></a><span id="l100.1079">             cal.LOG(&quot;CalDAV: send: &quot; + homeSet.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l100.1080"></a><span id="l100.1080">         }</span>
<a href="#l100.1081"></a><span id="l100.1081">         let streamListener = {};</span>
<a href="#l100.1082"></a><span id="l100.1082">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.1083"></a><span id="l100.1083" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.1084"></a><span id="l100.1084" class="difflineplus">+            let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.1085"></a><span id="l100.1085">             if (request.responseStatus != 207) {</span>
<a href="#l100.1086"></a><span id="l100.1086">                 cal.LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l100.1087"></a><span id="l100.1087">                     &quot; while querying principal namespace for &quot; + self.name);</span>
<a href="#l100.1088"></a><span id="l100.1088" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l100.1089"></a><span id="l100.1089" class="difflineminus">-                                             Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.1090"></a><span id="l100.1090" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.1091"></a><span id="l100.1091">                 return;</span>
<a href="#l100.1092"></a><span id="l100.1092">             }</span>
<a href="#l100.1093"></a><span id="l100.1093"> </span>
<a href="#l100.1094"></a><span id="l100.1094">             let str = new TextDecoder().decode(Uint8Array.from(aResult));</span>
<a href="#l100.1095"></a><span id="l100.1095">             if (!str) {</span>
<a href="#l100.1096"></a><span id="l100.1096">                 cal.LOG(&quot;CalDAV: Failed to propstat principal namespace for &quot; + self.name);</span>
<a href="#l100.1097"></a><span id="l100.1097" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l100.1098"></a><span id="l100.1098" class="difflineminus">-                                             Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.1099"></a><span id="l100.1099" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.1100"></a><span id="l100.1100">                 return;</span>
<a href="#l100.1101"></a><span id="l100.1101">             } else if (self.verboseLogging()) {</span>
<a href="#l100.1102"></a><span id="l100.1102">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l100.1103"></a><span id="l100.1103">             }</span>
<a href="#l100.1104"></a><span id="l100.1104"> </span>
<a href="#l100.1105"></a><span id="l100.1105">             let multistatus;</span>
<a href="#l100.1106"></a><span id="l100.1106">             try {</span>
<a href="#l100.1107"></a><span id="l100.1107">                 multistatus = cal.xml.parseString(str);</span>
<a href="#l100.1108"></a><span id="l100.1108">             } catch (ex) {</span>
<a href="#l100.1109"></a><span id="l100.1109">                 cal.LOG(&quot;CalDAV: Failed to propstat principal namespace for &quot; + self.name);</span>
<a href="#l100.1110"></a><span id="l100.1110" class="difflineminus">-                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l100.1111"></a><span id="l100.1111" class="difflineminus">-                                             Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.1112"></a><span id="l100.1112" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.1113"></a><span id="l100.1113">                 return;</span>
<a href="#l100.1114"></a><span id="l100.1114">             }</span>
<a href="#l100.1115"></a><span id="l100.1115"> </span>
<a href="#l100.1116"></a><span id="l100.1116">             let pcs = caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/D:principal-collection-set/D:href/text()&quot;);</span>
<a href="#l100.1117"></a><span id="l100.1117">             let nsList = [];</span>
<a href="#l100.1118"></a><span id="l100.1118">             if (pcs) {</span>
<a href="#l100.1119"></a><span id="l100.1119">                 nsList = pcs.map(x =&gt; self.ensureDecodedPath(x));</span>
<a href="#l100.1120"></a><span id="l100.1120">             }</span>
<a href="#l100.1121"></a><span id="l100.1121" class="difflineat">@@ -2095,17 +2077,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1122"></a><span id="l100.1122">             self.checkPrincipalsNameSpace(nsList, aChangeLogListener);</span>
<a href="#l100.1123"></a><span id="l100.1123">         };</span>
<a href="#l100.1124"></a><span id="l100.1124"> </span>
<a href="#l100.1125"></a><span id="l100.1125">         this.sendHttpRequest(homeSet, queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l100.1126"></a><span id="l100.1126">             channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l100.1127"></a><span id="l100.1127">             channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l100.1128"></a><span id="l100.1128">             return streamListener;</span>
<a href="#l100.1129"></a><span id="l100.1129">         }, () =&gt; {</span>
<a href="#l100.1130"></a><span id="l100.1130" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l100.1131"></a><span id="l100.1131" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l100.1132"></a><span id="l100.1132">         });</span>
<a href="#l100.1133"></a><span id="l100.1133">     },</span>
<a href="#l100.1134"></a><span id="l100.1134"> </span>
<a href="#l100.1135"></a><span id="l100.1135">     /**</span>
<a href="#l100.1136"></a><span id="l100.1136">      * Checks the principals namespace for scheduling info. This function should</span>
<a href="#l100.1137"></a><span id="l100.1137">      * soely be called from findPrincipalNS</span>
<a href="#l100.1138"></a><span id="l100.1138">      *</span>
<a href="#l100.1139"></a><span id="l100.1139">      * setupAuthentication</span>
<a href="#l100.1140"></a><span id="l100.1140" class="difflineat">@@ -2177,17 +2159,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1141"></a><span id="l100.1141">         let requestUri = Services.io.newURI(this.calendarUri.prePath + this.ensureEncodedPath(nextNS));</span>
<a href="#l100.1142"></a><span id="l100.1142"> </span>
<a href="#l100.1143"></a><span id="l100.1143">         if (this.verboseLogging()) {</span>
<a href="#l100.1144"></a><span id="l100.1144">             cal.LOG(&quot;CalDAV: send: &quot; + queryMethod + &quot; &quot; + requestUri.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l100.1145"></a><span id="l100.1145">         }</span>
<a href="#l100.1146"></a><span id="l100.1146"> </span>
<a href="#l100.1147"></a><span id="l100.1147">         let streamListener = {};</span>
<a href="#l100.1148"></a><span id="l100.1148">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.1149"></a><span id="l100.1149" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.1150"></a><span id="l100.1150" class="difflineplus">+            let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.1151"></a><span id="l100.1151">             let str = new TextDecoder().decode(Uint8Array.from(aResult));</span>
<a href="#l100.1152"></a><span id="l100.1152">             if (!str) {</span>
<a href="#l100.1153"></a><span id="l100.1153">                 cal.LOG(&quot;CalDAV: Failed to report principals namespace for &quot; + self.name);</span>
<a href="#l100.1154"></a><span id="l100.1154">                 doesntSupportScheduling();</span>
<a href="#l100.1155"></a><span id="l100.1155">                 return;</span>
<a href="#l100.1156"></a><span id="l100.1156">             } else if (self.verboseLogging()) {</span>
<a href="#l100.1157"></a><span id="l100.1157">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l100.1158"></a><span id="l100.1158">             }</span>
<a href="#l100.1159"></a><span id="l100.1159" class="difflineat">@@ -2280,17 +2262,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1160"></a><span id="l100.1160">             if (queryDepth == 0) {</span>
<a href="#l100.1161"></a><span id="l100.1161">                 // Set header, doing this for Depth: 1 is not needed since thats the</span>
<a href="#l100.1162"></a><span id="l100.1162">                 // default.</span>
<a href="#l100.1163"></a><span id="l100.1163">                 channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l100.1164"></a><span id="l100.1164">             }</span>
<a href="#l100.1165"></a><span id="l100.1165">             channel.requestMethod = queryMethod;</span>
<a href="#l100.1166"></a><span id="l100.1166">             return streamListener;</span>
<a href="#l100.1167"></a><span id="l100.1167">         }, () =&gt; {</span>
<a href="#l100.1168"></a><span id="l100.1168" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l100.1169"></a><span id="l100.1169" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l100.1170"></a><span id="l100.1170">         });</span>
<a href="#l100.1171"></a><span id="l100.1171">     },</span>
<a href="#l100.1172"></a><span id="l100.1172"> </span>
<a href="#l100.1173"></a><span id="l100.1173">     /**</span>
<a href="#l100.1174"></a><span id="l100.1174">      * This is called to complete checking the server info. It should be the</span>
<a href="#l100.1175"></a><span id="l100.1175">      * final call when checking server options. This will either report the</span>
<a href="#l100.1176"></a><span id="l100.1176">      * error or if it is a success then refresh the calendar.</span>
<a href="#l100.1177"></a><span id="l100.1177">      *</span>
<a href="#l100.1178"></a><span id="l100.1178" class="difflineat">@@ -2301,66 +2283,65 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1179"></a><span id="l100.1179">      * checkPrincipalsNameSpace</span>
<a href="#l100.1180"></a><span id="l100.1180">      * completeCheckServerInfo                      * You are here</span>
<a href="#l100.1181"></a><span id="l100.1181">      */</span>
<a href="#l100.1182"></a><span id="l100.1182">     completeCheckServerInfo: function(aChangeLogListener, aError) {</span>
<a href="#l100.1183"></a><span id="l100.1183">         if (Components.isSuccessCode(aError)) {</span>
<a href="#l100.1184"></a><span id="l100.1184">             // &quot;undefined&quot; is a successcode, so all is good</span>
<a href="#l100.1185"></a><span id="l100.1185">             this.saveCalendarProperties();</span>
<a href="#l100.1186"></a><span id="l100.1186">             this.checkedServerInfo = true;</span>
<a href="#l100.1187"></a><span id="l100.1187" class="difflineminus">-            this.setProperty(&quot;currentStatus&quot;, Components.results.NS_OK);</span>
<a href="#l100.1188"></a><span id="l100.1188" class="difflineplus">+            this.setProperty(&quot;currentStatus&quot;, Cr.NS_OK);</span>
<a href="#l100.1189"></a><span id="l100.1189"> </span>
<a href="#l100.1190"></a><span id="l100.1190">             if (this.isCached) {</span>
<a href="#l100.1191"></a><span id="l100.1191">                 this.safeRefresh(aChangeLogListener);</span>
<a href="#l100.1192"></a><span id="l100.1192">             } else {</span>
<a href="#l100.1193"></a><span id="l100.1193">                 this.refresh();</span>
<a href="#l100.1194"></a><span id="l100.1194">             }</span>
<a href="#l100.1195"></a><span id="l100.1195">         } else {</span>
<a href="#l100.1196"></a><span id="l100.1196">             this.reportDavError(aError);</span>
<a href="#l100.1197"></a><span id="l100.1197">             if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l100.1198"></a><span id="l100.1198" class="difflineminus">-                aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l100.1199"></a><span id="l100.1199" class="difflineminus">-                                            Components.results.NS_ERROR_FAILURE);</span>
<a href="#l100.1200"></a><span id="l100.1200" class="difflineplus">+                aChangeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l100.1201"></a><span id="l100.1201">             }</span>
<a href="#l100.1202"></a><span id="l100.1202">         }</span>
<a href="#l100.1203"></a><span id="l100.1203">     },</span>
<a href="#l100.1204"></a><span id="l100.1204"> </span>
<a href="#l100.1205"></a><span id="l100.1205">     /**</span>
<a href="#l100.1206"></a><span id="l100.1206">      * Called to report a certain DAV error. Strings and modification type are</span>
<a href="#l100.1207"></a><span id="l100.1207">      * handled here.</span>
<a href="#l100.1208"></a><span id="l100.1208">      */</span>
<a href="#l100.1209"></a><span id="l100.1209">     reportDavError: function(aErrNo, status, extraInfo) {</span>
<a href="#l100.1210"></a><span id="l100.1210">         let mapError = {};</span>
<a href="#l100.1211"></a><span id="l100.1211" class="difflineminus">-        mapError[Components.interfaces.calIErrors.DAV_NOT_DAV] = &quot;dav_notDav&quot;;</span>
<a href="#l100.1212"></a><span id="l100.1212" class="difflineminus">-        mapError[Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV] = &quot;dav_davNotCaldav&quot;;</span>
<a href="#l100.1213"></a><span id="l100.1213" class="difflineminus">-        mapError[Components.interfaces.calIErrors.DAV_PUT_ERROR] = &quot;itemPutError&quot;;</span>
<a href="#l100.1214"></a><span id="l100.1214" class="difflineminus">-        mapError[Components.interfaces.calIErrors.DAV_REMOVE_ERROR] = &quot;itemDeleteError&quot;;</span>
<a href="#l100.1215"></a><span id="l100.1215" class="difflineminus">-        mapError[Components.interfaces.calIErrors.DAV_REPORT_ERROR] = &quot;disabledMode&quot;;</span>
<a href="#l100.1216"></a><span id="l100.1216" class="difflineplus">+        mapError[Ci.calIErrors.DAV_NOT_DAV] = &quot;dav_notDav&quot;;</span>
<a href="#l100.1217"></a><span id="l100.1217" class="difflineplus">+        mapError[Ci.calIErrors.DAV_DAV_NOT_CALDAV] = &quot;dav_davNotCaldav&quot;;</span>
<a href="#l100.1218"></a><span id="l100.1218" class="difflineplus">+        mapError[Ci.calIErrors.DAV_PUT_ERROR] = &quot;itemPutError&quot;;</span>
<a href="#l100.1219"></a><span id="l100.1219" class="difflineplus">+        mapError[Ci.calIErrors.DAV_REMOVE_ERROR] = &quot;itemDeleteError&quot;;</span>
<a href="#l100.1220"></a><span id="l100.1220" class="difflineplus">+        mapError[Ci.calIErrors.DAV_REPORT_ERROR] = &quot;disabledMode&quot;;</span>
<a href="#l100.1221"></a><span id="l100.1221"> </span>
<a href="#l100.1222"></a><span id="l100.1222">         let mapModification = {};</span>
<a href="#l100.1223"></a><span id="l100.1223" class="difflineminus">-        mapModification[Components.interfaces.calIErrors.DAV_NOT_DAV] = false;</span>
<a href="#l100.1224"></a><span id="l100.1224" class="difflineminus">-        mapModification[Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV] = false;</span>
<a href="#l100.1225"></a><span id="l100.1225" class="difflineminus">-        mapModification[Components.interfaces.calIErrors.DAV_PUT_ERROR] = true;</span>
<a href="#l100.1226"></a><span id="l100.1226" class="difflineminus">-        mapModification[Components.interfaces.calIErrors.DAV_REMOVE_ERROR] = true;</span>
<a href="#l100.1227"></a><span id="l100.1227" class="difflineminus">-        mapModification[Components.interfaces.calIErrors.DAV_REPORT_ERROR] = false;</span>
<a href="#l100.1228"></a><span id="l100.1228" class="difflineplus">+        mapModification[Ci.calIErrors.DAV_NOT_DAV] = false;</span>
<a href="#l100.1229"></a><span id="l100.1229" class="difflineplus">+        mapModification[Ci.calIErrors.DAV_DAV_NOT_CALDAV] = false;</span>
<a href="#l100.1230"></a><span id="l100.1230" class="difflineplus">+        mapModification[Ci.calIErrors.DAV_PUT_ERROR] = true;</span>
<a href="#l100.1231"></a><span id="l100.1231" class="difflineplus">+        mapModification[Ci.calIErrors.DAV_REMOVE_ERROR] = true;</span>
<a href="#l100.1232"></a><span id="l100.1232" class="difflineplus">+        mapModification[Ci.calIErrors.DAV_REPORT_ERROR] = false;</span>
<a href="#l100.1233"></a><span id="l100.1233"> </span>
<a href="#l100.1234"></a><span id="l100.1234">         let message = mapError[aErrNo];</span>
<a href="#l100.1235"></a><span id="l100.1235">         let localizedMessage;</span>
<a href="#l100.1236"></a><span id="l100.1236">         let modificationError = mapModification[aErrNo];</span>
<a href="#l100.1237"></a><span id="l100.1237"> </span>
<a href="#l100.1238"></a><span id="l100.1238">         if (!message) {</span>
<a href="#l100.1239"></a><span id="l100.1239">             // Only notify if there is a message for this error</span>
<a href="#l100.1240"></a><span id="l100.1240">             return;</span>
<a href="#l100.1241"></a><span id="l100.1241">         }</span>
<a href="#l100.1242"></a><span id="l100.1242">         localizedMessage = cal.l10n.getCalString(message, [this.mUri.spec]);</span>
<a href="#l100.1243"></a><span id="l100.1243">         this.mReadOnly = true;</span>
<a href="#l100.1244"></a><span id="l100.1244">         this.mDisabled = true;</span>
<a href="#l100.1245"></a><span id="l100.1245">         this.notifyError(aErrNo, localizedMessage);</span>
<a href="#l100.1246"></a><span id="l100.1246">         this.notifyError(modificationError</span>
<a href="#l100.1247"></a><span id="l100.1247" class="difflineminus">-                         ? Components.interfaces.calIErrors.MODIFICATION_FAILED</span>
<a href="#l100.1248"></a><span id="l100.1248" class="difflineminus">-                         : Components.interfaces.calIErrors.READ_FAILED,</span>
<a href="#l100.1249"></a><span id="l100.1249" class="difflineplus">+                         ? Ci.calIErrors.MODIFICATION_FAILED</span>
<a href="#l100.1250"></a><span id="l100.1250" class="difflineplus">+                         : Ci.calIErrors.READ_FAILED,</span>
<a href="#l100.1251"></a><span id="l100.1251">                          this.buildDetailedMessage(status, extraInfo));</span>
<a href="#l100.1252"></a><span id="l100.1252">     },</span>
<a href="#l100.1253"></a><span id="l100.1253"> </span>
<a href="#l100.1254"></a><span id="l100.1254">     buildDetailedMessage: function(status, extraInfo) {</span>
<a href="#l100.1255"></a><span id="l100.1255">         if (!status) {</span>
<a href="#l100.1256"></a><span id="l100.1256">             return &quot;&quot;;</span>
<a href="#l100.1257"></a><span id="l100.1257">         }</span>
<a href="#l100.1258"></a><span id="l100.1258"> </span>
<a href="#l100.1259"></a><span id="l100.1259" class="difflineat">@@ -2447,31 +2428,31 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1260"></a><span id="l100.1260">             cal.LOG(&quot;CalDAV: send (Originator=&quot; + organizer +</span>
<a href="#l100.1261"></a><span id="l100.1261">                     &quot;,Recipient=&quot; + mailto_aCalId + &quot;): &quot; + fbQuery);</span>
<a href="#l100.1262"></a><span id="l100.1262">         }</span>
<a href="#l100.1263"></a><span id="l100.1263"> </span>
<a href="#l100.1264"></a><span id="l100.1264">         let streamListener = {};</span>
<a href="#l100.1265"></a><span id="l100.1265"> </span>
<a href="#l100.1266"></a><span id="l100.1266">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus,</span>
<a href="#l100.1267"></a><span id="l100.1267">                                                    aResultLength, aResult) {</span>
<a href="#l100.1268"></a><span id="l100.1268" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.1269"></a><span id="l100.1269" class="difflineplus">+            let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.1270"></a><span id="l100.1270">             let str = new TextDecoder().decode(Uint8Array.from(aResult));</span>
<a href="#l100.1271"></a><span id="l100.1271">             if (!str) {</span>
<a href="#l100.1272"></a><span id="l100.1272">                 cal.LOG(&quot;CalDAV: Failed to parse freebusy response from &quot; + self.name);</span>
<a href="#l100.1273"></a><span id="l100.1273">             } else if (self.verboseLogging()) {</span>
<a href="#l100.1274"></a><span id="l100.1274">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l100.1275"></a><span id="l100.1275">             }</span>
<a href="#l100.1276"></a><span id="l100.1276"> </span>
<a href="#l100.1277"></a><span id="l100.1277">             if (request.responseStatus == 200) {</span>
<a href="#l100.1278"></a><span id="l100.1278">                 let periodsToReturn = [];</span>
<a href="#l100.1279"></a><span id="l100.1279">                 let fbTypeMap = {};</span>
<a href="#l100.1280"></a><span id="l100.1280" class="difflineminus">-                fbTypeMap.FREE = calIFreeBusyInterval.FREE;</span>
<a href="#l100.1281"></a><span id="l100.1281" class="difflineminus">-                fbTypeMap.BUSY = calIFreeBusyInterval.BUSY;</span>
<a href="#l100.1282"></a><span id="l100.1282" class="difflineminus">-                fbTypeMap[&quot;BUSY-UNAVAILABLE&quot;] = calIFreeBusyInterval.BUSY_UNAVAILABLE;</span>
<a href="#l100.1283"></a><span id="l100.1283" class="difflineminus">-                fbTypeMap[&quot;BUSY-TENTATIVE&quot;] = calIFreeBusyInterval.BUSY_TENTATIVE;</span>
<a href="#l100.1284"></a><span id="l100.1284" class="difflineplus">+                fbTypeMap.FREE = Ci.calIFreeBusyInterval.FREE;</span>
<a href="#l100.1285"></a><span id="l100.1285" class="difflineplus">+                fbTypeMap.BUSY = Ci.calIFreeBusyInterval.BUSY;</span>
<a href="#l100.1286"></a><span id="l100.1286" class="difflineplus">+                fbTypeMap[&quot;BUSY-UNAVAILABLE&quot;] = Ci.calIFreeBusyInterval.BUSY_UNAVAILABLE;</span>
<a href="#l100.1287"></a><span id="l100.1287" class="difflineplus">+                fbTypeMap[&quot;BUSY-TENTATIVE&quot;] = Ci.calIFreeBusyInterval.BUSY_TENTATIVE;</span>
<a href="#l100.1288"></a><span id="l100.1288"> </span>
<a href="#l100.1289"></a><span id="l100.1289">                 let fbResult;</span>
<a href="#l100.1290"></a><span id="l100.1290">                 try {</span>
<a href="#l100.1291"></a><span id="l100.1291">                     fbResult = cal.xml.parseString(str);</span>
<a href="#l100.1292"></a><span id="l100.1292">                 } catch (ex) {</span>
<a href="#l100.1293"></a><span id="l100.1293">                     cal.LOG(&quot;CalDAV: Could not parse freebusy response &quot; + ex);</span>
<a href="#l100.1294"></a><span id="l100.1294">                     aListener.onResult(null, null);</span>
<a href="#l100.1295"></a><span id="l100.1295">                     return;</span>
<a href="#l100.1296"></a><span id="l100.1296" class="difflineat">@@ -2493,36 +2474,36 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1297"></a><span id="l100.1297">                 try {</span>
<a href="#l100.1298"></a><span id="l100.1298">                     let calComp = cal.getIcsService().parseICS(caldata, null);</span>
<a href="#l100.1299"></a><span id="l100.1299">                     for (let calFbComp of cal.iterate.icalComponent(calComp)) {</span>
<a href="#l100.1300"></a><span id="l100.1300">                         let interval;</span>
<a href="#l100.1301"></a><span id="l100.1301"> </span>
<a href="#l100.1302"></a><span id="l100.1302">                         let replyRangeStart = calFbComp.startTime;</span>
<a href="#l100.1303"></a><span id="l100.1303">                         if (replyRangeStart &amp;&amp; (aRangeStart.compare(replyRangeStart) == -1)) {</span>
<a href="#l100.1304"></a><span id="l100.1304">                             interval = new cal.provider.FreeBusyInterval(aCalId,</span>
<a href="#l100.1305"></a><span id="l100.1305" class="difflineminus">-                                                                         calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l100.1306"></a><span id="l100.1306" class="difflineplus">+                                                                         Ci.calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l100.1307"></a><span id="l100.1307">                                                                          aRangeStart,</span>
<a href="#l100.1308"></a><span id="l100.1308">                                                                          replyRangeStart);</span>
<a href="#l100.1309"></a><span id="l100.1309">                             periodsToReturn.push(interval);</span>
<a href="#l100.1310"></a><span id="l100.1310">                         }</span>
<a href="#l100.1311"></a><span id="l100.1311">                         let replyRangeEnd = calFbComp.endTime;</span>
<a href="#l100.1312"></a><span id="l100.1312">                         if (replyRangeEnd &amp;&amp; (aRangeEnd.compare(replyRangeEnd) == 1)) {</span>
<a href="#l100.1313"></a><span id="l100.1313">                             interval = new cal.provider.FreeBusyInterval(aCalId,</span>
<a href="#l100.1314"></a><span id="l100.1314" class="difflineminus">-                                                                         calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l100.1315"></a><span id="l100.1315" class="difflineplus">+                                                                         Ci.calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l100.1316"></a><span id="l100.1316">                                                                          replyRangeEnd,</span>
<a href="#l100.1317"></a><span id="l100.1317">                                                                          aRangeEnd);</span>
<a href="#l100.1318"></a><span id="l100.1318">                             periodsToReturn.push(interval);</span>
<a href="#l100.1319"></a><span id="l100.1319">                         }</span>
<a href="#l100.1320"></a><span id="l100.1320"> </span>
<a href="#l100.1321"></a><span id="l100.1321">                         for (let fbProp of cal.iterate.icalProperty(calFbComp, &quot;FREEBUSY&quot;)) {</span>
<a href="#l100.1322"></a><span id="l100.1322">                             let fbType = fbProp.getParameter(&quot;FBTYPE&quot;);</span>
<a href="#l100.1323"></a><span id="l100.1323">                             if (fbType) {</span>
<a href="#l100.1324"></a><span id="l100.1324">                                 fbType = fbTypeMap[fbType];</span>
<a href="#l100.1325"></a><span id="l100.1325">                             } else {</span>
<a href="#l100.1326"></a><span id="l100.1326" class="difflineminus">-                                fbType = calIFreeBusyInterval.BUSY;</span>
<a href="#l100.1327"></a><span id="l100.1327" class="difflineplus">+                                fbType = Ci.calIFreeBusyInterval.BUSY;</span>
<a href="#l100.1328"></a><span id="l100.1328">                             }</span>
<a href="#l100.1329"></a><span id="l100.1329">                             let parts = fbProp.value.split(&quot;/&quot;);</span>
<a href="#l100.1330"></a><span id="l100.1330">                             let begin = cal.createDateTime(parts[0]);</span>
<a href="#l100.1331"></a><span id="l100.1331">                             let end;</span>
<a href="#l100.1332"></a><span id="l100.1332">                             if (parts[1].charAt(0) == &quot;P&quot;) { // this is a duration</span>
<a href="#l100.1333"></a><span id="l100.1333">                                 end = begin.clone();</span>
<a href="#l100.1334"></a><span id="l100.1334">                                 end.addDuration(cal.createDuration(parts[1]));</span>
<a href="#l100.1335"></a><span id="l100.1335">                             } else {</span>
<a href="#l100.1336"></a><span id="l100.1336" class="difflineat">@@ -2550,17 +2531,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1337"></a><span id="l100.1337"> </span>
<a href="#l100.1338"></a><span id="l100.1338">         let fbUri = this.makeUri(null, this.outboxUrl);</span>
<a href="#l100.1339"></a><span id="l100.1339">         this.sendHttpRequest(fbUri, fbQuery, MIME_TEXT_CALENDAR, null, (channel) =&gt; {</span>
<a href="#l100.1340"></a><span id="l100.1340">             channel.requestMethod = &quot;POST&quot;;</span>
<a href="#l100.1341"></a><span id="l100.1341">             channel.setRequestHeader(&quot;Originator&quot;, organizer, false);</span>
<a href="#l100.1342"></a><span id="l100.1342">             channel.setRequestHeader(&quot;Recipient&quot;, mailto_aCalId, false);</span>
<a href="#l100.1343"></a><span id="l100.1343">             return streamListener;</span>
<a href="#l100.1344"></a><span id="l100.1344">         }, () =&gt; {</span>
<a href="#l100.1345"></a><span id="l100.1345" class="difflineminus">-            notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.1346"></a><span id="l100.1346" class="difflineplus">+            notifyListener(Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.1347"></a><span id="l100.1347">                            &quot;Error preparing http channel&quot;);</span>
<a href="#l100.1348"></a><span id="l100.1348">         });</span>
<a href="#l100.1349"></a><span id="l100.1349">     },</span>
<a href="#l100.1350"></a><span id="l100.1350"> </span>
<a href="#l100.1351"></a><span id="l100.1351">     /**</span>
<a href="#l100.1352"></a><span id="l100.1352">      * Extract the path from the full spec, if the regexp failed, log</span>
<a href="#l100.1353"></a><span id="l100.1353">      * warning and return unaltered path.</span>
<a href="#l100.1354"></a><span id="l100.1354">      */</span>
<a href="#l100.1355"></a><span id="l100.1355" class="difflineat">@@ -2783,32 +2764,32 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1356"></a><span id="l100.1356">             if (!attendee) {</span>
<a href="#l100.1357"></a><span id="l100.1357">                 return false;</span>
<a href="#l100.1358"></a><span id="l100.1358">             }</span>
<a href="#l100.1359"></a><span id="l100.1359">             // work around BUG 351589, the below just removes RSVP:</span>
<a href="#l100.1360"></a><span id="l100.1360">             aItipItem.setAttendeeStatus(attendee.id, attendee.participationStatus);</span>
<a href="#l100.1361"></a><span id="l100.1361">         }</span>
<a href="#l100.1362"></a><span id="l100.1362"> </span>
<a href="#l100.1363"></a><span id="l100.1363">         for (let item of aItipItem.getItemList({})) {</span>
<a href="#l100.1364"></a><span id="l100.1364" class="difflineminus">-            let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l100.1365"></a><span id="l100.1365" class="difflineminus">-                                       .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l100.1366"></a><span id="l100.1366" class="difflineplus">+            let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l100.1367"></a><span id="l100.1367" class="difflineplus">+                               .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l100.1368"></a><span id="l100.1368">             serializer.addItems([item], 1);</span>
<a href="#l100.1369"></a><span id="l100.1369">             let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l100.1370"></a><span id="l100.1370">             methodProp.value = aItipItem.responseMethod;</span>
<a href="#l100.1371"></a><span id="l100.1371">             serializer.addProperty(methodProp);</span>
<a href="#l100.1372"></a><span id="l100.1372"> </span>
<a href="#l100.1373"></a><span id="l100.1373">             let self = this;</span>
<a href="#l100.1374"></a><span id="l100.1374">             let streamListener = {</span>
<a href="#l100.1375"></a><span id="l100.1375">                 onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l100.1376"></a><span id="l100.1376" class="difflineminus">-                    let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.1377"></a><span id="l100.1377" class="difflineplus">+                    let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.1378"></a><span id="l100.1378">                     let status;</span>
<a href="#l100.1379"></a><span id="l100.1379">                     try {</span>
<a href="#l100.1380"></a><span id="l100.1380">                         status = request.responseStatus;</span>
<a href="#l100.1381"></a><span id="l100.1381">                     } catch (ex) {</span>
<a href="#l100.1382"></a><span id="l100.1382" class="difflineminus">-                        status = Components.interfaces.calIErrors.DAV_POST_ERROR;</span>
<a href="#l100.1383"></a><span id="l100.1383" class="difflineplus">+                        status = Ci.calIErrors.DAV_POST_ERROR;</span>
<a href="#l100.1384"></a><span id="l100.1384">                         cal.LOG(&quot;CalDAV: no response status when sending iTIP for&quot; +</span>
<a href="#l100.1385"></a><span id="l100.1385">                                 self.name);</span>
<a href="#l100.1386"></a><span id="l100.1386">                     }</span>
<a href="#l100.1387"></a><span id="l100.1387"> </span>
<a href="#l100.1388"></a><span id="l100.1388">                     if (status != 200) {</span>
<a href="#l100.1389"></a><span id="l100.1389">                         cal.LOG(&quot;CalDAV: Sending iTIP failed with status &quot; + status +</span>
<a href="#l100.1390"></a><span id="l100.1390">                                 &quot; for &quot; + self.name);</span>
<a href="#l100.1391"></a><span id="l100.1391">                     }</span>
<a href="#l100.1392"></a><span id="l100.1392" class="difflineat">@@ -2884,77 +2865,77 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1393"></a><span id="l100.1393">             this.sendHttpRequest(requestUri, uploadData, MIME_TEXT_CALENDAR, null, (channel) =&gt; {</span>
<a href="#l100.1394"></a><span id="l100.1394">                 channel.requestMethod = &quot;POST&quot;;</span>
<a href="#l100.1395"></a><span id="l100.1395">                 channel.setRequestHeader(&quot;Originator&quot;, this.calendarUserAddress, false);</span>
<a href="#l100.1396"></a><span id="l100.1396">                 for (let recipient of aRecipients) {</span>
<a href="#l100.1397"></a><span id="l100.1397">                     channel.setRequestHeader(&quot;Recipient&quot;, recipient.id, true);</span>
<a href="#l100.1398"></a><span id="l100.1398">                 }</span>
<a href="#l100.1399"></a><span id="l100.1399">                 return streamListener;</span>
<a href="#l100.1400"></a><span id="l100.1400">             }, () =&gt; {</span>
<a href="#l100.1401"></a><span id="l100.1401" class="difflineminus">-                notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.1402"></a><span id="l100.1402" class="difflineplus">+                notifyListener(Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l100.1403"></a><span id="l100.1403">                                &quot;Error preparing http channel&quot;);</span>
<a href="#l100.1404"></a><span id="l100.1404">             });</span>
<a href="#l100.1405"></a><span id="l100.1405">         }</span>
<a href="#l100.1406"></a><span id="l100.1406">         return true;</span>
<a href="#l100.1407"></a><span id="l100.1407">     },</span>
<a href="#l100.1408"></a><span id="l100.1408"> </span>
<a href="#l100.1409"></a><span id="l100.1409">     mVerboseLogging: undefined,</span>
<a href="#l100.1410"></a><span id="l100.1410">     verboseLogging: function() {</span>
<a href="#l100.1411"></a><span id="l100.1411">         if (this.mVerboseLogging === undefined) {</span>
<a href="#l100.1412"></a><span id="l100.1412">             this.mVerboseLogging = Preferences.get(&quot;calendar.debug.log.verbose&quot;, false);</span>
<a href="#l100.1413"></a><span id="l100.1413">         }</span>
<a href="#l100.1414"></a><span id="l100.1414">         return this.mVerboseLogging;</span>
<a href="#l100.1415"></a><span id="l100.1415">     },</span>
<a href="#l100.1416"></a><span id="l100.1416"> </span>
<a href="#l100.1417"></a><span id="l100.1417">     getSerializedItem: function(aItem) {</span>
<a href="#l100.1418"></a><span id="l100.1418" class="difflineminus">-        let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l100.1419"></a><span id="l100.1419" class="difflineminus">-                                   .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l100.1420"></a><span id="l100.1420" class="difflineplus">+        let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l100.1421"></a><span id="l100.1421" class="difflineplus">+                           .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l100.1422"></a><span id="l100.1422">         serializer.addItems([aItem], 1);</span>
<a href="#l100.1423"></a><span id="l100.1423">         let serializedItem = serializer.serializeToString();</span>
<a href="#l100.1424"></a><span id="l100.1424">         if (this.verboseLogging()) {</span>
<a href="#l100.1425"></a><span id="l100.1425">             cal.LOG(&quot;CalDAV: send: &quot; + serializedItem);</span>
<a href="#l100.1426"></a><span id="l100.1426">         }</span>
<a href="#l100.1427"></a><span id="l100.1427">         return serializedItem;</span>
<a href="#l100.1428"></a><span id="l100.1428">     },</span>
<a href="#l100.1429"></a><span id="l100.1429"> </span>
<a href="#l100.1430"></a><span id="l100.1430">     // nsIChannelEventSink implementation</span>
<a href="#l100.1431"></a><span id="l100.1431">     asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l100.1432"></a><span id="l100.1432">         let uploadData;</span>
<a href="#l100.1433"></a><span id="l100.1433">         let uploadContent;</span>
<a href="#l100.1434"></a><span id="l100.1434" class="difflineminus">-        if (aOldChannel instanceof Components.interfaces.nsIUploadChannel &amp;&amp;</span>
<a href="#l100.1435"></a><span id="l100.1435" class="difflineminus">-            aOldChannel instanceof Components.interfaces.nsIHttpChannel &amp;&amp;</span>
<a href="#l100.1436"></a><span id="l100.1436" class="difflineplus">+        if (aOldChannel instanceof Ci.nsIUploadChannel &amp;&amp;</span>
<a href="#l100.1437"></a><span id="l100.1437" class="difflineplus">+            aOldChannel instanceof Ci.nsIHttpChannel &amp;&amp;</span>
<a href="#l100.1438"></a><span id="l100.1438">             aOldChannel.uploadStream) {</span>
<a href="#l100.1439"></a><span id="l100.1439">             uploadData = aOldChannel.uploadStream;</span>
<a href="#l100.1440"></a><span id="l100.1440">             uploadContent = aOldChannel.getRequestHeader(&quot;Content-Type&quot;);</span>
<a href="#l100.1441"></a><span id="l100.1441">         }</span>
<a href="#l100.1442"></a><span id="l100.1442"> </span>
<a href="#l100.1443"></a><span id="l100.1443">         cal.provider.prepHttpChannel(null,</span>
<a href="#l100.1444"></a><span id="l100.1444">                             uploadData,</span>
<a href="#l100.1445"></a><span id="l100.1445">                             uploadContent,</span>
<a href="#l100.1446"></a><span id="l100.1446">                             this,</span>
<a href="#l100.1447"></a><span id="l100.1447">                             aNewChannel);</span>
<a href="#l100.1448"></a><span id="l100.1448"> </span>
<a href="#l100.1449"></a><span id="l100.1449">         // Make sure we can get/set headers on both channels.</span>
<a href="#l100.1450"></a><span id="l100.1450" class="difflineminus">-        aNewChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.1451"></a><span id="l100.1451" class="difflineminus">-        aOldChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l100.1452"></a><span id="l100.1452" class="difflineplus">+        aNewChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.1453"></a><span id="l100.1453" class="difflineplus">+        aOldChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l100.1454"></a><span id="l100.1454"> </span>
<a href="#l100.1455"></a><span id="l100.1455">         try {</span>
<a href="#l100.1456"></a><span id="l100.1456">             this.mLastRedirectStatus = aOldChannel.responseStatus;</span>
<a href="#l100.1457"></a><span id="l100.1457">         } catch (e) {</span>
<a href="#l100.1458"></a><span id="l100.1458">             this.mLastRedirectStatus = null;</span>
<a href="#l100.1459"></a><span id="l100.1459">         }</span>
<a href="#l100.1460"></a><span id="l100.1460"> </span>
<a href="#l100.1461"></a><span id="l100.1461">         function copyHeader(aHdr) {</span>
<a href="#l100.1462"></a><span id="l100.1462">             try {</span>
<a href="#l100.1463"></a><span id="l100.1463">                 let hdrValue = aOldChannel.getRequestHeader(aHdr);</span>
<a href="#l100.1464"></a><span id="l100.1464">                 if (hdrValue) {</span>
<a href="#l100.1465"></a><span id="l100.1465">                     aNewChannel.setRequestHeader(aHdr, hdrValue, false);</span>
<a href="#l100.1466"></a><span id="l100.1466">                 }</span>
<a href="#l100.1467"></a><span id="l100.1467">             } catch (e) {</span>
<a href="#l100.1468"></a><span id="l100.1468" class="difflineminus">-                if (e.code != Components.results.NS_ERROR_NOT_AVAILIBLE) {</span>
<a href="#l100.1469"></a><span id="l100.1469" class="difflineplus">+                if (e.code != Cr.NS_ERROR_NOT_AVAILIBLE) {</span>
<a href="#l100.1470"></a><span id="l100.1470">                     // The header could possibly not be availible, ignore that</span>
<a href="#l100.1471"></a><span id="l100.1471">                     // case but throw otherwise</span>
<a href="#l100.1472"></a><span id="l100.1472">                     throw e;</span>
<a href="#l100.1473"></a><span id="l100.1473">                 }</span>
<a href="#l100.1474"></a><span id="l100.1474">             }</span>
<a href="#l100.1475"></a><span id="l100.1475">         }</span>
<a href="#l100.1476"></a><span id="l100.1476"> </span>
<a href="#l100.1477"></a><span id="l100.1477">         // If any other header is used, it should be added here. We might want</span>
<a href="#l100.1478"></a><span id="l100.1478" class="difflineat">@@ -2965,17 +2946,17 @@ calDavCalendar.prototype = {</span>
<a href="#l100.1479"></a><span id="l100.1479">         copyHeader(&quot;If-None-Match&quot;);</span>
<a href="#l100.1480"></a><span id="l100.1480">         copyHeader(&quot;If-Match&quot;);</span>
<a href="#l100.1481"></a><span id="l100.1481">         if (aNewChannel.URI.host == &quot;apidata.googleusercontent.com&quot;) {</span>
<a href="#l100.1482"></a><span id="l100.1482">             copyHeader(&quot;Authorization&quot;);</span>
<a href="#l100.1483"></a><span id="l100.1483">         }</span>
<a href="#l100.1484"></a><span id="l100.1484"> </span>
<a href="#l100.1485"></a><span id="l100.1485">         aNewChannel.requestMethod = aOldChannel.requestMethod;</span>
<a href="#l100.1486"></a><span id="l100.1486"> </span>
<a href="#l100.1487"></a><span id="l100.1487" class="difflineminus">-        aCallback.onRedirectVerifyCallback(Components.results.NS_OK);</span>
<a href="#l100.1488"></a><span id="l100.1488" class="difflineplus">+        aCallback.onRedirectVerifyCallback(Cr.NS_OK);</span>
<a href="#l100.1489"></a><span id="l100.1489">     }</span>
<a href="#l100.1490"></a><span id="l100.1490"> };</span>
<a href="#l100.1491"></a><span id="l100.1491"> </span>
<a href="#l100.1492"></a><span id="l100.1492"> function calDavObserver(aCalendar) {</span>
<a href="#l100.1493"></a><span id="l100.1493">     this.mCalendar = aCalendar;</span>
<a href="#l100.1494"></a><span id="l100.1494"> }</span>
<a href="#l100.1495"></a><span id="l100.1495"> </span>
<a href="#l100.1496"></a><span id="l100.1496"> // Before you spend time trying to find out what this means, please note that</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineat">@@ -18,18 +18,17 @@ var MIME_TEXT_XML = &quot;text/xml; charset=u</span>
<a href="#l101.4"></a><span id="l101.4">  * @param aBaseUri              The URI requested (i.e inbox or collection)</span>
<a href="#l101.5"></a><span id="l101.5">  * @param aChangeLogListener    (optional) for cached calendars, the listener to</span>
<a href="#l101.6"></a><span id="l101.6">  *                                notify.</span>
<a href="#l101.7"></a><span id="l101.7">  */</span>
<a href="#l101.8"></a><span id="l101.8"> function etagsHandler(aCalendar, aBaseUri, aChangeLogListener) {</span>
<a href="#l101.9"></a><span id="l101.9">     this.calendar = aCalendar;</span>
<a href="#l101.10"></a><span id="l101.10">     this.baseUri = aBaseUri;</span>
<a href="#l101.11"></a><span id="l101.11">     this.changeLogListener = aChangeLogListener;</span>
<a href="#l101.12"></a><span id="l101.12" class="difflineminus">-    this._reader = Components.classes[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l101.13"></a><span id="l101.13" class="difflineminus">-                             .createInstance(Components.interfaces.nsISAXXMLReader);</span>
<a href="#l101.14"></a><span id="l101.14" class="difflineplus">+    this._reader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l101.15"></a><span id="l101.15">     this._reader.contentHandler = this;</span>
<a href="#l101.16"></a><span id="l101.16">     this._reader.errorHandler = this;</span>
<a href="#l101.17"></a><span id="l101.17">     this._reader.parseAsync(null);</span>
<a href="#l101.18"></a><span id="l101.18"> </span>
<a href="#l101.19"></a><span id="l101.19">     this.itemsReported = {};</span>
<a href="#l101.20"></a><span id="l101.20">     this.itemsNeedFetching = [];</span>
<a href="#l101.21"></a><span id="l101.21"> }</span>
<a href="#l101.22"></a><span id="l101.22"> </span>
<a href="#l101.23"></a><span id="l101.23" class="difflineat">@@ -51,36 +50,35 @@ etagsHandler.prototype = {</span>
<a href="#l101.24"></a><span id="l101.24">         Ci.nsIRequestObserver,</span>
<a href="#l101.25"></a><span id="l101.25">         Ci.nsIStreamListener</span>
<a href="#l101.26"></a><span id="l101.26">     ]),</span>
<a href="#l101.27"></a><span id="l101.27"> </span>
<a href="#l101.28"></a><span id="l101.28">     /**</span>
<a href="#l101.29"></a><span id="l101.29">      * @see nsIStreamListener</span>
<a href="#l101.30"></a><span id="l101.30">      */</span>
<a href="#l101.31"></a><span id="l101.31">     onStartRequest: function(request, context) {</span>
<a href="#l101.32"></a><span id="l101.32" class="difflineminus">-        let httpchannel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l101.33"></a><span id="l101.33" class="difflineplus">+        let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l101.34"></a><span id="l101.34"> </span>
<a href="#l101.35"></a><span id="l101.35">         let responseStatus;</span>
<a href="#l101.36"></a><span id="l101.36">         try {</span>
<a href="#l101.37"></a><span id="l101.37">             responseStatus = httpchannel.responseStatus;</span>
<a href="#l101.38"></a><span id="l101.38">         } catch (ex) {</span>
<a href="#l101.39"></a><span id="l101.39">             cal.WARN(&quot;CalDAV: No response status getting etags for calendar &quot; + this.calendar.name);</span>
<a href="#l101.40"></a><span id="l101.40">         }</span>
<a href="#l101.41"></a><span id="l101.41"> </span>
<a href="#l101.42"></a><span id="l101.42">         if (responseStatus == 207) {</span>
<a href="#l101.43"></a><span id="l101.43">             // We only need to parse 207's, anything else is probably a</span>
<a href="#l101.44"></a><span id="l101.44">             // server error (i.e 50x).</span>
<a href="#l101.45"></a><span id="l101.45">             httpchannel.contentType = &quot;application/xml&quot;;</span>
<a href="#l101.46"></a><span id="l101.46">             this._reader.onStartRequest(request, context);</span>
<a href="#l101.47"></a><span id="l101.47">         } else {</span>
<a href="#l101.48"></a><span id="l101.48">             cal.LOG(&quot;CalDAV: Error fetching item etags&quot;);</span>
<a href="#l101.49"></a><span id="l101.49" class="difflineminus">-            this.calendar.reportDavError(Components.interfaces.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l101.50"></a><span id="l101.50" class="difflineplus">+            this.calendar.reportDavError(Ci.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l101.51"></a><span id="l101.51">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l101.52"></a><span id="l101.52" class="difflineminus">-                this.changeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l101.53"></a><span id="l101.53" class="difflineminus">-                                                Components.results.NS_ERROR_FAILURE);</span>
<a href="#l101.54"></a><span id="l101.54" class="difflineplus">+                this.changeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l101.55"></a><span id="l101.55">             }</span>
<a href="#l101.56"></a><span id="l101.56">             this._reader = null;</span>
<a href="#l101.57"></a><span id="l101.57">         }</span>
<a href="#l101.58"></a><span id="l101.58">     },</span>
<a href="#l101.59"></a><span id="l101.59"> </span>
<a href="#l101.60"></a><span id="l101.60">     onStopRequest: async function(request, context, statusCode) {</span>
<a href="#l101.61"></a><span id="l101.61">         if (this.calendar.verboseLogging()) {</span>
<a href="#l101.62"></a><span id="l101.62">             cal.LOG(&quot;CalDAV: recv: &quot; + this.logXML);</span>
<a href="#l101.63"></a><span id="l101.63" class="difflineat">@@ -139,18 +137,17 @@ etagsHandler.prototype = {</span>
<a href="#l101.64"></a><span id="l101.64">                                        this.baseUri,</span>
<a href="#l101.65"></a><span id="l101.65">                                        null,</span>
<a href="#l101.66"></a><span id="l101.66">                                        false,</span>
<a href="#l101.67"></a><span id="l101.67">                                        null,</span>
<a href="#l101.68"></a><span id="l101.68">                                        this.changeLogListener);</span>
<a href="#l101.69"></a><span id="l101.69">             multiget.doMultiGet();</span>
<a href="#l101.70"></a><span id="l101.70">         } else {</span>
<a href="#l101.71"></a><span id="l101.71">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l101.72"></a><span id="l101.72" class="difflineminus">-                this.changeLogListener.onResult({ status: Components.results.NS_OK },</span>
<a href="#l101.73"></a><span id="l101.73" class="difflineminus">-                                                Components.results.NS_OK);</span>
<a href="#l101.74"></a><span id="l101.74" class="difflineplus">+                this.changeLogListener.onResult({ status: Cr.NS_OK }, Cr.NS_OK);</span>
<a href="#l101.75"></a><span id="l101.75">             }</span>
<a href="#l101.76"></a><span id="l101.76"> </span>
<a href="#l101.77"></a><span id="l101.77">             if (needsRefresh) {</span>
<a href="#l101.78"></a><span id="l101.78">                 this.calendar.mObservers.notify(&quot;onLoad&quot;, [this.calendar]);</span>
<a href="#l101.79"></a><span id="l101.79">             }</span>
<a href="#l101.80"></a><span id="l101.80"> </span>
<a href="#l101.81"></a><span id="l101.81">             // but do poll the inbox</span>
<a href="#l101.82"></a><span id="l101.82">             if (this.calendar.mShouldPollInbox &amp;&amp;</span>
<a href="#l101.83"></a><span id="l101.83" class="difflineat">@@ -276,18 +273,17 @@ etagsHandler.prototype = {</span>
<a href="#l101.84"></a><span id="l101.84">  * @param aBaseUri              The URI requested (i.e inbox or collection)</span>
<a href="#l101.85"></a><span id="l101.85">  * @param aChangeLogListener    (optional) for cached calendars, the listener to</span>
<a href="#l101.86"></a><span id="l101.86">  *                                notify.</span>
<a href="#l101.87"></a><span id="l101.87">  */</span>
<a href="#l101.88"></a><span id="l101.88"> function webDavSyncHandler(aCalendar, aBaseUri, aChangeLogListener) {</span>
<a href="#l101.89"></a><span id="l101.89">     this.calendar = aCalendar;</span>
<a href="#l101.90"></a><span id="l101.90">     this.baseUri = aBaseUri;</span>
<a href="#l101.91"></a><span id="l101.91">     this.changeLogListener = aChangeLogListener;</span>
<a href="#l101.92"></a><span id="l101.92" class="difflineminus">-    this._reader = Components.classes[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l101.93"></a><span id="l101.93" class="difflineminus">-                             .createInstance(Components.interfaces.nsISAXXMLReader);</span>
<a href="#l101.94"></a><span id="l101.94" class="difflineplus">+    this._reader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l101.95"></a><span id="l101.95">     this._reader.contentHandler = this;</span>
<a href="#l101.96"></a><span id="l101.96">     this._reader.errorHandler = this;</span>
<a href="#l101.97"></a><span id="l101.97">     this._reader.parseAsync(null);</span>
<a href="#l101.98"></a><span id="l101.98"> </span>
<a href="#l101.99"></a><span id="l101.99">     this.itemsReported = {};</span>
<a href="#l101.100"></a><span id="l101.100">     this.itemsNeedFetching = [];</span>
<a href="#l101.101"></a><span id="l101.101"> }</span>
<a href="#l101.102"></a><span id="l101.102"> </span>
<a href="#l101.103"></a><span id="l101.103" class="difflineat">@@ -351,27 +347,26 @@ webDavSyncHandler.prototype = {</span>
<a href="#l101.104"></a><span id="l101.104">             // therefore we send both (yuck).</span>
<a href="#l101.105"></a><span id="l101.105">             channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l101.106"></a><span id="l101.106"> </span>
<a href="#l101.107"></a><span id="l101.107">             channel.requestMethod = &quot;REPORT&quot;;</span>
<a href="#l101.108"></a><span id="l101.108">             return this;</span>
<a href="#l101.109"></a><span id="l101.109">         }, () =&gt; {</span>
<a href="#l101.110"></a><span id="l101.110">             // Something went wrong with the OAuth token, notify failure</span>
<a href="#l101.111"></a><span id="l101.111">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l101.112"></a><span id="l101.112" class="difflineminus">-                this.changeLogListener.onResult({ status: Components.results.NS_ERROR_NOT_AVAILABLE },</span>
<a href="#l101.113"></a><span id="l101.113" class="difflineminus">-                                                Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l101.114"></a><span id="l101.114" class="difflineplus">+                this.changeLogListener.onResult({ status: Cr.NS_ERROR_NOT_AVAILABLE }, Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l101.115"></a><span id="l101.115">             }</span>
<a href="#l101.116"></a><span id="l101.116">         }, false);</span>
<a href="#l101.117"></a><span id="l101.117">     },</span>
<a href="#l101.118"></a><span id="l101.118"> </span>
<a href="#l101.119"></a><span id="l101.119">     /**</span>
<a href="#l101.120"></a><span id="l101.120">      * @see nsIStreamListener</span>
<a href="#l101.121"></a><span id="l101.121">      */</span>
<a href="#l101.122"></a><span id="l101.122">     onStartRequest: function(request, context) {</span>
<a href="#l101.123"></a><span id="l101.123" class="difflineminus">-        let httpchannel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l101.124"></a><span id="l101.124" class="difflineplus">+        let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l101.125"></a><span id="l101.125"> </span>
<a href="#l101.126"></a><span id="l101.126">         let responseStatus;</span>
<a href="#l101.127"></a><span id="l101.127">         try {</span>
<a href="#l101.128"></a><span id="l101.128">             responseStatus = httpchannel.responseStatus;</span>
<a href="#l101.129"></a><span id="l101.129">         } catch (ex) {</span>
<a href="#l101.130"></a><span id="l101.130">             cal.WARN(&quot;CalDAV: No response status doing webdav sync for calendar &quot; + this.calendar.name);</span>
<a href="#l101.131"></a><span id="l101.131">         }</span>
<a href="#l101.132"></a><span id="l101.132"> </span>
<a href="#l101.133"></a><span id="l101.133" class="difflineat">@@ -387,20 +382,19 @@ webDavSyncHandler.prototype = {</span>
<a href="#l101.134"></a><span id="l101.134">             // sync token has become invalid and do a refresh</span>
<a href="#l101.135"></a><span id="l101.135">             cal.LOG(&quot;CalDAV: Reseting sync token because server returned status code: &quot; + responseStatus);</span>
<a href="#l101.136"></a><span id="l101.136">             this._reader = null;</span>
<a href="#l101.137"></a><span id="l101.137">             this.calendar.mWebdavSyncToken = null;</span>
<a href="#l101.138"></a><span id="l101.138">             this.calendar.saveCalendarProperties();</span>
<a href="#l101.139"></a><span id="l101.139">             this.calendar.safeRefresh(this.changeLogListener);</span>
<a href="#l101.140"></a><span id="l101.140">         } else {</span>
<a href="#l101.141"></a><span id="l101.141">             cal.WARN(&quot;CalDAV: Error doing webdav sync: &quot; + responseStatus);</span>
<a href="#l101.142"></a><span id="l101.142" class="difflineminus">-            this.calendar.reportDavError(Components.interfaces.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l101.143"></a><span id="l101.143" class="difflineplus">+            this.calendar.reportDavError(Ci.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l101.144"></a><span id="l101.144">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l101.145"></a><span id="l101.145" class="difflineminus">-                this.changeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l101.146"></a><span id="l101.146" class="difflineminus">-                                                Components.results.NS_ERROR_FAILURE);</span>
<a href="#l101.147"></a><span id="l101.147" class="difflineplus">+                this.changeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l101.148"></a><span id="l101.148">             }</span>
<a href="#l101.149"></a><span id="l101.149">             this._reader = null;</span>
<a href="#l101.150"></a><span id="l101.150">         }</span>
<a href="#l101.151"></a><span id="l101.151">     },</span>
<a href="#l101.152"></a><span id="l101.152"> </span>
<a href="#l101.153"></a><span id="l101.153">     onStopRequest: function(request, context, statusCode) {</span>
<a href="#l101.154"></a><span id="l101.154">         if (this.calendar.verboseLogging()) {</span>
<a href="#l101.155"></a><span id="l101.155">             cal.LOG(&quot;CalDAV: recv: &quot; + this.logXML);</span>
<a href="#l101.156"></a><span id="l101.156" class="difflineat">@@ -448,20 +442,19 @@ webDavSyncHandler.prototype = {</span>
<a href="#l101.157"></a><span id="l101.157">         if (this.calendar.isCached) {</span>
<a href="#l101.158"></a><span id="l101.158">             this.calendar.superCalendar.startBatch();</span>
<a href="#l101.159"></a><span id="l101.159">         }</span>
<a href="#l101.160"></a><span id="l101.160">     },</span>
<a href="#l101.161"></a><span id="l101.161"> </span>
<a href="#l101.162"></a><span id="l101.162">     endDocument: function() {</span>
<a href="#l101.163"></a><span id="l101.163">         if (this.unhandledErrors) {</span>
<a href="#l101.164"></a><span id="l101.164">             this.calendar.superCalendar.endBatch();</span>
<a href="#l101.165"></a><span id="l101.165" class="difflineminus">-            this.calendar.reportDavError(Components.interfaces.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l101.166"></a><span id="l101.166" class="difflineplus">+            this.calendar.reportDavError(Ci.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l101.167"></a><span id="l101.167">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l101.168"></a><span id="l101.168" class="difflineminus">-                this.changeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l101.169"></a><span id="l101.169" class="difflineminus">-                                                Components.results.NS_ERROR_FAILURE);</span>
<a href="#l101.170"></a><span id="l101.170" class="difflineplus">+                this.changeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l101.171"></a><span id="l101.171">             }</span>
<a href="#l101.172"></a><span id="l101.172">             return;</span>
<a href="#l101.173"></a><span id="l101.173">         }</span>
<a href="#l101.174"></a><span id="l101.174"> </span>
<a href="#l101.175"></a><span id="l101.175">         if (this.calendar.mWebdavSyncToken == null) {</span>
<a href="#l101.176"></a><span id="l101.176">             // null token means reset or first refresh indicating we did</span>
<a href="#l101.177"></a><span id="l101.177">             // a full sync; remove local items that were not returned in this full</span>
<a href="#l101.178"></a><span id="l101.178">             // sync</span>
<a href="#l101.179"></a><span id="l101.179" class="difflineat">@@ -646,18 +639,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l101.180"></a><span id="l101.180">  *                                notify.</span>
<a href="#l101.181"></a><span id="l101.181">  */</span>
<a href="#l101.182"></a><span id="l101.182"> function multigetSyncHandler(aItemsNeedFetching, aCalendar, aBaseUri, aNewSyncToken, aAdditionalSyncNeeded, aListener, aChangeLogListener) {</span>
<a href="#l101.183"></a><span id="l101.183">     this.calendar = aCalendar;</span>
<a href="#l101.184"></a><span id="l101.184">     this.baseUri = aBaseUri;</span>
<a href="#l101.185"></a><span id="l101.185">     this.listener = aListener;</span>
<a href="#l101.186"></a><span id="l101.186">     this.newSyncToken = aNewSyncToken;</span>
<a href="#l101.187"></a><span id="l101.187">     this.changeLogListener = aChangeLogListener;</span>
<a href="#l101.188"></a><span id="l101.188" class="difflineminus">-    this._reader = Components.classes[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l101.189"></a><span id="l101.189" class="difflineminus">-                             .createInstance(Components.interfaces.nsISAXXMLReader);</span>
<a href="#l101.190"></a><span id="l101.190" class="difflineplus">+    this._reader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l101.191"></a><span id="l101.191">     this._reader.contentHandler = this;</span>
<a href="#l101.192"></a><span id="l101.192">     this._reader.errorHandler = this;</span>
<a href="#l101.193"></a><span id="l101.193">     this._reader.parseAsync(null);</span>
<a href="#l101.194"></a><span id="l101.194">     this.itemsNeedFetching = aItemsNeedFetching;</span>
<a href="#l101.195"></a><span id="l101.195">     this.additionalSyncNeeded = aAdditionalSyncNeeded;</span>
<a href="#l101.196"></a><span id="l101.196"> }</span>
<a href="#l101.197"></a><span id="l101.197"> multigetSyncHandler.prototype = {</span>
<a href="#l101.198"></a><span id="l101.198">     currentResponse: null,</span>
<a href="#l101.199"></a><span id="l101.199" class="difflineat">@@ -713,27 +705,26 @@ multigetSyncHandler.prototype = {</span>
<a href="#l101.200"></a><span id="l101.200">         }</span>
<a href="#l101.201"></a><span id="l101.201">         this.calendar.sendHttpRequest(requestUri, queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l101.202"></a><span id="l101.202">             channel.requestMethod = &quot;REPORT&quot;;</span>
<a href="#l101.203"></a><span id="l101.203">             channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l101.204"></a><span id="l101.204">             return this;</span>
<a href="#l101.205"></a><span id="l101.205">         }, () =&gt; {</span>
<a href="#l101.206"></a><span id="l101.206">             // Something went wrong with the OAuth token, notify failure</span>
<a href="#l101.207"></a><span id="l101.207">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l101.208"></a><span id="l101.208" class="difflineminus">-                this.changeLogListener.onResult({ status: Components.results.NS_ERROR_NOT_AVAILABLE },</span>
<a href="#l101.209"></a><span id="l101.209" class="difflineminus">-                                                Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l101.210"></a><span id="l101.210" class="difflineplus">+                this.changeLogListener.onResult({ status: Cr.NS_ERROR_NOT_AVAILABLE }, Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l101.211"></a><span id="l101.211">             }</span>
<a href="#l101.212"></a><span id="l101.212">         }, false);</span>
<a href="#l101.213"></a><span id="l101.213">     },</span>
<a href="#l101.214"></a><span id="l101.214"> </span>
<a href="#l101.215"></a><span id="l101.215">     /**</span>
<a href="#l101.216"></a><span id="l101.216">      * @see nsIStreamListener</span>
<a href="#l101.217"></a><span id="l101.217">      */</span>
<a href="#l101.218"></a><span id="l101.218">     onStartRequest: function(request, context) {</span>
<a href="#l101.219"></a><span id="l101.219" class="difflineminus">-        let httpchannel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l101.220"></a><span id="l101.220" class="difflineplus">+        let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l101.221"></a><span id="l101.221"> </span>
<a href="#l101.222"></a><span id="l101.222">         let responseStatus;</span>
<a href="#l101.223"></a><span id="l101.223">         try {</span>
<a href="#l101.224"></a><span id="l101.224">             responseStatus = httpchannel.responseStatus;</span>
<a href="#l101.225"></a><span id="l101.225">         } catch (ex) {</span>
<a href="#l101.226"></a><span id="l101.226">             cal.WARN(&quot;CalDAV: No response status doing multiget for calendar &quot; + this.calendar.name);</span>
<a href="#l101.227"></a><span id="l101.227">         }</span>
<a href="#l101.228"></a><span id="l101.228"> </span>
<a href="#l101.229"></a><span id="l101.229" class="difflineat">@@ -786,34 +777,32 @@ multigetSyncHandler.prototype = {</span>
<a href="#l101.230"></a><span id="l101.230">         }</span>
<a href="#l101.231"></a><span id="l101.231">         try {</span>
<a href="#l101.232"></a><span id="l101.232">             this._reader.onStopRequest(request, context, statusCode);</span>
<a href="#l101.233"></a><span id="l101.233">         } finally {</span>
<a href="#l101.234"></a><span id="l101.234">             this._reader = null;</span>
<a href="#l101.235"></a><span id="l101.235">         }</span>
<a href="#l101.236"></a><span id="l101.236">         if (this.itemsNeedFetching.length &gt; 0) {</span>
<a href="#l101.237"></a><span id="l101.237">             cal.LOG(&quot;CalDAV: Still need to fetch &quot; + this.itemsNeedFetching.length + &quot; elements.&quot;);</span>
<a href="#l101.238"></a><span id="l101.238" class="difflineminus">-            this._reader = Components.classes[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l101.239"></a><span id="l101.239" class="difflineminus">-                                     .createInstance(Components.interfaces.nsISAXXMLReader);</span>
<a href="#l101.240"></a><span id="l101.240" class="difflineplus">+            this._reader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l101.241"></a><span id="l101.241">             this._reader.contentHandler = this;</span>
<a href="#l101.242"></a><span id="l101.242">             this._reader.errorHandler = this;</span>
<a href="#l101.243"></a><span id="l101.243">             this._reader.parseAsync(null);</span>
<a href="#l101.244"></a><span id="l101.244">             let timerCallback = {</span>
<a href="#l101.245"></a><span id="l101.245">                 requestHandler: this,</span>
<a href="#l101.246"></a><span id="l101.246">                 notify: function(timer) {</span>
<a href="#l101.247"></a><span id="l101.247">                     // Call multiget again to get another batch</span>
<a href="#l101.248"></a><span id="l101.248">                     this.requestHandler.doMultiGet();</span>
<a href="#l101.249"></a><span id="l101.249">                 }</span>
<a href="#l101.250"></a><span id="l101.250">             };</span>
<a href="#l101.251"></a><span id="l101.251" class="difflineminus">-            this.timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l101.252"></a><span id="l101.252" class="difflineminus">-                                   .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l101.253"></a><span id="l101.253" class="difflineplus">+            this.timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l101.254"></a><span id="l101.254">             this.timer.initWithCallback(</span>
<a href="#l101.255"></a><span id="l101.255">                 timerCallback,</span>
<a href="#l101.256"></a><span id="l101.256">                 0,</span>
<a href="#l101.257"></a><span id="l101.257" class="difflineminus">-                Components.interfaces.nsITimer.TYPE_ONE_SHOT</span>
<a href="#l101.258"></a><span id="l101.258" class="difflineplus">+                Ci.nsITimer.TYPE_ONE_SHOT</span>
<a href="#l101.259"></a><span id="l101.259">             );</span>
<a href="#l101.260"></a><span id="l101.260">         }</span>
<a href="#l101.261"></a><span id="l101.261">     },</span>
<a href="#l101.262"></a><span id="l101.262"> </span>
<a href="#l101.263"></a><span id="l101.263">     onDataAvailable: function(request, context, inputStream, offset, count) {</span>
<a href="#l101.264"></a><span id="l101.264">         if (this._reader) {</span>
<a href="#l101.265"></a><span id="l101.265">             // No reader means request error</span>
<a href="#l101.266"></a><span id="l101.266">             this._reader.onDataAvailable(request, context, inputStream, offset, count);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1" class="difflineminus">--- a/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineplus">+++ b/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineat">@@ -7,17 +7,17 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l102.4"></a><span id="l102.4"> </span>
<a href="#l102.5"></a><span id="l102.5"> //</span>
<a href="#l102.6"></a><span id="l102.6"> // calCompositeCalendar.js</span>
<a href="#l102.7"></a><span id="l102.7"> //</span>
<a href="#l102.8"></a><span id="l102.8"> </span>
<a href="#l102.9"></a><span id="l102.9"> /**</span>
<a href="#l102.10"></a><span id="l102.10">  * Calendar specific utility functions</span>
<a href="#l102.11"></a><span id="l102.11">  */</span>
<a href="#l102.12"></a><span id="l102.12" class="difflineminus">-var calIOperationListener = Components.interfaces.calIOperationListener;</span>
<a href="#l102.13"></a><span id="l102.13" class="difflineplus">+var calIOperationListener = Ci.calIOperationListener;</span>
<a href="#l102.14"></a><span id="l102.14"> </span>
<a href="#l102.15"></a><span id="l102.15"> function calCompositeCalendarObserverHelper(compCalendar) {</span>
<a href="#l102.16"></a><span id="l102.16">     this.compCalendar = compCalendar;</span>
<a href="#l102.17"></a><span id="l102.17">     this.pendingLoads = {};</span>
<a href="#l102.18"></a><span id="l102.18"> }</span>
<a href="#l102.19"></a><span id="l102.19"> </span>
<a href="#l102.20"></a><span id="l102.20"> calCompositeCalendarObserverHelper.prototype = {</span>
<a href="#l102.21"></a><span id="l102.21">     pendingLoads: null,</span>
<a href="#l102.22"></a><span id="l102.22" class="difflineat">@@ -70,27 +70,27 @@ calCompositeCalendarObserverHelper.proto</span>
<a href="#l102.23"></a><span id="l102.23">     }</span>
<a href="#l102.24"></a><span id="l102.24"> };</span>
<a href="#l102.25"></a><span id="l102.25"> </span>
<a href="#l102.26"></a><span id="l102.26"> function calCompositeCalendar() {</span>
<a href="#l102.27"></a><span id="l102.27">     this.mObserverHelper = new calCompositeCalendarObserverHelper(this);</span>
<a href="#l102.28"></a><span id="l102.28">     this.wrappedJSObject = this;</span>
<a href="#l102.29"></a><span id="l102.29"> </span>
<a href="#l102.30"></a><span id="l102.30">     this.mCalendars = [];</span>
<a href="#l102.31"></a><span id="l102.31" class="difflineminus">-    this.mCompositeObservers = new cal.data.ObserverSet(Components.interfaces.calICompositeObserver);</span>
<a href="#l102.32"></a><span id="l102.32" class="difflineminus">-    this.mObservers = new cal.data.ObserverSet(Components.interfaces.calIObserver);</span>
<a href="#l102.33"></a><span id="l102.33" class="difflineplus">+    this.mCompositeObservers = new cal.data.ObserverSet(Ci.calICompositeObserver);</span>
<a href="#l102.34"></a><span id="l102.34" class="difflineplus">+    this.mObservers = new cal.data.ObserverSet(Ci.calIObserver);</span>
<a href="#l102.35"></a><span id="l102.35">     this.mDefaultCalendar = null;</span>
<a href="#l102.36"></a><span id="l102.36">     this.mStatusObserver = null;</span>
<a href="#l102.37"></a><span id="l102.37"> }</span>
<a href="#l102.38"></a><span id="l102.38"> </span>
<a href="#l102.39"></a><span id="l102.39"> var calCompositeCalendarClassID = Components.ID(&quot;{aeff788d-63b0-4996-91fb-40a7654c6224}&quot;);</span>
<a href="#l102.40"></a><span id="l102.40"> var calCompositeCalendarInterfaces = [</span>
<a href="#l102.41"></a><span id="l102.41" class="difflineminus">-    Components.interfaces.calICalendarProvider,</span>
<a href="#l102.42"></a><span id="l102.42" class="difflineminus">-    Components.interfaces.calICalendar,</span>
<a href="#l102.43"></a><span id="l102.43" class="difflineminus">-    Components.interfaces.calICompositeCalendar,</span>
<a href="#l102.44"></a><span id="l102.44" class="difflineplus">+    Ci.calICalendarProvider,</span>
<a href="#l102.45"></a><span id="l102.45" class="difflineplus">+    Ci.calICalendar,</span>
<a href="#l102.46"></a><span id="l102.46" class="difflineplus">+    Ci.calICompositeCalendar,</span>
<a href="#l102.47"></a><span id="l102.47"> ];</span>
<a href="#l102.48"></a><span id="l102.48"> calCompositeCalendar.prototype = {</span>
<a href="#l102.49"></a><span id="l102.49">     classID: calCompositeCalendarClassID,</span>
<a href="#l102.50"></a><span id="l102.50">     QueryInterface: ChromeUtils.generateQI(calCompositeCalendarInterfaces),</span>
<a href="#l102.51"></a><span id="l102.51"> </span>
<a href="#l102.52"></a><span id="l102.52">     //</span>
<a href="#l102.53"></a><span id="l102.53">     // calICalendarProvider interface</span>
<a href="#l102.54"></a><span id="l102.54">     //</span>
<a href="#l102.55"></a><span id="l102.55" class="difflineat">@@ -227,56 +227,56 @@ calCompositeCalendar.prototype = {</span>
<a href="#l102.56"></a><span id="l102.56">     // calICalendar interface</span>
<a href="#l102.57"></a><span id="l102.57">     //</span>
<a href="#l102.58"></a><span id="l102.58">     // Write operations here are forwarded to either the item's</span>
<a href="#l102.59"></a><span id="l102.59">     // parent calendar, or to the default calendar if one is set.</span>
<a href="#l102.60"></a><span id="l102.60">     // Get operations are sent to each calendar.</span>
<a href="#l102.61"></a><span id="l102.61">     //</span>
<a href="#l102.62"></a><span id="l102.62"> </span>
<a href="#l102.63"></a><span id="l102.63">     get id() {</span>
<a href="#l102.64"></a><span id="l102.64" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.65"></a><span id="l102.65" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.66"></a><span id="l102.66">     },</span>
<a href="#l102.67"></a><span id="l102.67">     set id(id) {</span>
<a href="#l102.68"></a><span id="l102.68" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.69"></a><span id="l102.69" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.70"></a><span id="l102.70">     },</span>
<a href="#l102.71"></a><span id="l102.71"> </span>
<a href="#l102.72"></a><span id="l102.72">     get superCalendar() {</span>
<a href="#l102.73"></a><span id="l102.73">         // There shouldn't be a superCalendar for the composite</span>
<a href="#l102.74"></a><span id="l102.74">         return this;</span>
<a href="#l102.75"></a><span id="l102.75">     },</span>
<a href="#l102.76"></a><span id="l102.76">     set superCalendar(val) {</span>
<a href="#l102.77"></a><span id="l102.77" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.78"></a><span id="l102.78" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.79"></a><span id="l102.79">     },</span>
<a href="#l102.80"></a><span id="l102.80"> </span>
<a href="#l102.81"></a><span id="l102.81">     // this could, at some point, return some kind of URI identifying</span>
<a href="#l102.82"></a><span id="l102.82">     // all the child calendars, thus letting us create nifty calendar</span>
<a href="#l102.83"></a><span id="l102.83">     // trees.</span>
<a href="#l102.84"></a><span id="l102.84">     get uri() {</span>
<a href="#l102.85"></a><span id="l102.85" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.86"></a><span id="l102.86" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.87"></a><span id="l102.87">     },</span>
<a href="#l102.88"></a><span id="l102.88">     set uri(val) {</span>
<a href="#l102.89"></a><span id="l102.89" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.90"></a><span id="l102.90" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.91"></a><span id="l102.91">     },</span>
<a href="#l102.92"></a><span id="l102.92"> </span>
<a href="#l102.93"></a><span id="l102.93">     get readOnly() {</span>
<a href="#l102.94"></a><span id="l102.94" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.95"></a><span id="l102.95" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.96"></a><span id="l102.96">     },</span>
<a href="#l102.97"></a><span id="l102.97">     set readOnly(bool) {</span>
<a href="#l102.98"></a><span id="l102.98" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.99"></a><span id="l102.99" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.100"></a><span id="l102.100">     },</span>
<a href="#l102.101"></a><span id="l102.101"> </span>
<a href="#l102.102"></a><span id="l102.102">     get canRefresh() {</span>
<a href="#l102.103"></a><span id="l102.103">         return true;</span>
<a href="#l102.104"></a><span id="l102.104">     },</span>
<a href="#l102.105"></a><span id="l102.105"> </span>
<a href="#l102.106"></a><span id="l102.106">     get name() {</span>
<a href="#l102.107"></a><span id="l102.107" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.108"></a><span id="l102.108" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.109"></a><span id="l102.109">     },</span>
<a href="#l102.110"></a><span id="l102.110">     set name(val) {</span>
<a href="#l102.111"></a><span id="l102.111" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.112"></a><span id="l102.112" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l102.113"></a><span id="l102.113">     },</span>
<a href="#l102.114"></a><span id="l102.114"> </span>
<a href="#l102.115"></a><span id="l102.115">     get type() {</span>
<a href="#l102.116"></a><span id="l102.116">         return &quot;composite&quot;;</span>
<a href="#l102.117"></a><span id="l102.117">     },</span>
<a href="#l102.118"></a><span id="l102.118"> </span>
<a href="#l102.119"></a><span id="l102.119">     getProperty: function(aName) {</span>
<a href="#l102.120"></a><span id="l102.120">         return this.mDefaultCalendar.getProperty(aName);</span>
<a href="#l102.121"></a><span id="l102.121" class="difflineat">@@ -289,35 +289,35 @@ calCompositeCalendar.prototype = {</span>
<a href="#l102.122"></a><span id="l102.122">     deleteProperty: function(aName) {</span>
<a href="#l102.123"></a><span id="l102.123">         return this.mDefaultCalendar.deleteProperty(aName);</span>
<a href="#l102.124"></a><span id="l102.124">     },</span>
<a href="#l102.125"></a><span id="l102.125"> </span>
<a href="#l102.126"></a><span id="l102.126">     // void addObserver( in calIObserver observer );</span>
<a href="#l102.127"></a><span id="l102.127">     mCompositeObservers: null,</span>
<a href="#l102.128"></a><span id="l102.128">     mObservers: null,</span>
<a href="#l102.129"></a><span id="l102.129">     addObserver: function(aObserver) {</span>
<a href="#l102.130"></a><span id="l102.130" class="difflineminus">-        let wrappedCObserver = cal.wrapInstance(aObserver, Components.interfaces.calICompositeObserver);</span>
<a href="#l102.131"></a><span id="l102.131" class="difflineplus">+        let wrappedCObserver = cal.wrapInstance(aObserver, Ci.calICompositeObserver);</span>
<a href="#l102.132"></a><span id="l102.132">         if (wrappedCObserver) {</span>
<a href="#l102.133"></a><span id="l102.133">             this.mCompositeObservers.add(wrappedCObserver);</span>
<a href="#l102.134"></a><span id="l102.134">         }</span>
<a href="#l102.135"></a><span id="l102.135">         this.mObservers.add(aObserver);</span>
<a href="#l102.136"></a><span id="l102.136">     },</span>
<a href="#l102.137"></a><span id="l102.137"> </span>
<a href="#l102.138"></a><span id="l102.138">     // void removeObserver( in calIObserver observer );</span>
<a href="#l102.139"></a><span id="l102.139">     removeObserver: function(aObserver) {</span>
<a href="#l102.140"></a><span id="l102.140" class="difflineminus">-        let wrappedCObserver = cal.wrapInstance(aObserver, Components.interfaces.calICompositeObserver);</span>
<a href="#l102.141"></a><span id="l102.141" class="difflineplus">+        let wrappedCObserver = cal.wrapInstance(aObserver, Ci.calICompositeObserver);</span>
<a href="#l102.142"></a><span id="l102.142">         if (wrappedCObserver) {</span>
<a href="#l102.143"></a><span id="l102.143">             this.mCompositeObservers.delete(wrappedCObserver);</span>
<a href="#l102.144"></a><span id="l102.144">         }</span>
<a href="#l102.145"></a><span id="l102.145">         this.mObservers.delete(aObserver);</span>
<a href="#l102.146"></a><span id="l102.146">     },</span>
<a href="#l102.147"></a><span id="l102.147"> </span>
<a href="#l102.148"></a><span id="l102.148">     refresh: function() {</span>
<a href="#l102.149"></a><span id="l102.149">         if (this.mStatusObserver) {</span>
<a href="#l102.150"></a><span id="l102.150" class="difflineminus">-            this.mStatusObserver.startMeteors(Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS, this.mCalendars.length);</span>
<a href="#l102.151"></a><span id="l102.151" class="difflineplus">+            this.mStatusObserver.startMeteors(Ci.calIStatusObserver.DETERMINED_PROGRESS, this.mCalendars.length);</span>
<a href="#l102.152"></a><span id="l102.152">         }</span>
<a href="#l102.153"></a><span id="l102.153">         for (let calendar of this.enabledCalendars) {</span>
<a href="#l102.154"></a><span id="l102.154">             try {</span>
<a href="#l102.155"></a><span id="l102.155">                 if (calendar.canRefresh) {</span>
<a href="#l102.156"></a><span id="l102.156">                     this.mObserverHelper.pendingLoads[calendar.id] = true;</span>
<a href="#l102.157"></a><span id="l102.157">                     calendar.refresh();</span>
<a href="#l102.158"></a><span id="l102.158">                 }</span>
<a href="#l102.159"></a><span id="l102.159">             } catch (e) {</span>
<a href="#l102.160"></a><span id="l102.160" class="difflineat">@@ -370,25 +370,25 @@ calCompositeCalendar.prototype = {</span>
<a href="#l102.161"></a><span id="l102.161">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l102.162"></a><span id="l102.162">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l102.163"></a><span id="l102.163">     //                in calIOperationListener aListener );</span>
<a href="#l102.164"></a><span id="l102.164">     getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l102.165"></a><span id="l102.165">         // If there are no calendars, then we just call onOperationComplete</span>
<a href="#l102.166"></a><span id="l102.166">         let enabledCalendars = this.enabledCalendars;</span>
<a href="#l102.167"></a><span id="l102.167">         if (enabledCalendars.length == 0) {</span>
<a href="#l102.168"></a><span id="l102.168">             aListener.onOperationComplete(this,</span>
<a href="#l102.169"></a><span id="l102.169" class="difflineminus">-                                          Components.results.NS_OK,</span>
<a href="#l102.170"></a><span id="l102.170" class="difflineplus">+                                          Cr.NS_OK,</span>
<a href="#l102.171"></a><span id="l102.171">                                           calIOperationListener.GET,</span>
<a href="#l102.172"></a><span id="l102.172">                                           null,</span>
<a href="#l102.173"></a><span id="l102.173">                                           null);</span>
<a href="#l102.174"></a><span id="l102.174">             return null;</span>
<a href="#l102.175"></a><span id="l102.175">         }</span>
<a href="#l102.176"></a><span id="l102.176">         if (this.mStatusObserver) {</span>
<a href="#l102.177"></a><span id="l102.177" class="difflineminus">-            if (this.mStatusObserver.spinning == Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l102.178"></a><span id="l102.178" class="difflineminus">-                this.mStatusObserver.startMeteors(Components.interfaces.calIStatusObserver.UNDETERMINED_PROGRESS, -1);</span>
<a href="#l102.179"></a><span id="l102.179" class="difflineplus">+            if (this.mStatusObserver.spinning == Ci.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l102.180"></a><span id="l102.180" class="difflineplus">+                this.mStatusObserver.startMeteors(Ci.calIStatusObserver.UNDETERMINED_PROGRESS, -1);</span>
<a href="#l102.181"></a><span id="l102.181">             }</span>
<a href="#l102.182"></a><span id="l102.182">         }</span>
<a href="#l102.183"></a><span id="l102.183">         let cmpListener = new calCompositeGetListenerHelper(this, aListener, aCount);</span>
<a href="#l102.184"></a><span id="l102.184"> </span>
<a href="#l102.185"></a><span id="l102.185">         for (let calendar of enabledCalendars) {</span>
<a href="#l102.186"></a><span id="l102.186">             try {</span>
<a href="#l102.187"></a><span id="l102.187">                 cmpListener.opGroup.add(calendar.getItems(aItemFilter,</span>
<a href="#l102.188"></a><span id="l102.188">                                                           aCount,</span>
<a href="#l102.189"></a><span id="l102.189" class="difflineat">@@ -406,17 +406,17 @@ calCompositeCalendar.prototype = {</span>
<a href="#l102.190"></a><span id="l102.190">         this.mCompositeObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l102.191"></a><span id="l102.191">     },</span>
<a href="#l102.192"></a><span id="l102.192">     endBatch: function() {</span>
<a href="#l102.193"></a><span id="l102.193">         this.mCompositeObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l102.194"></a><span id="l102.194">     },</span>
<a href="#l102.195"></a><span id="l102.195"> </span>
<a href="#l102.196"></a><span id="l102.196">     get statusDisplayed() {</span>
<a href="#l102.197"></a><span id="l102.197">         if (this.mStatusObserver) {</span>
<a href="#l102.198"></a><span id="l102.198" class="difflineminus">-            return this.mStatusObserver.spinning != Components.interfaces.calIStatusObserver.NO_PROGRESS;</span>
<a href="#l102.199"></a><span id="l102.199" class="difflineplus">+            return this.mStatusObserver.spinning != Ci.calIStatusObserver.NO_PROGRESS;</span>
<a href="#l102.200"></a><span id="l102.200">         } else {</span>
<a href="#l102.201"></a><span id="l102.201">             return false;</span>
<a href="#l102.202"></a><span id="l102.202">         }</span>
<a href="#l102.203"></a><span id="l102.203">     },</span>
<a href="#l102.204"></a><span id="l102.204"> </span>
<a href="#l102.205"></a><span id="l102.205">     setStatusObserver: function(aStatusObserver, aWindow) {</span>
<a href="#l102.206"></a><span id="l102.206">         this.mStatusObserver = aStatusObserver;</span>
<a href="#l102.207"></a><span id="l102.207">         if (this.mStatusObserver) {</span>
<a href="#l102.208"></a><span id="l102.208" class="difflineat">@@ -447,17 +447,17 @@ calCompositeGetListenerHelper.prototype </span>
<a href="#l102.209"></a><span id="l102.209"> </span>
<a href="#l102.210"></a><span id="l102.210">     get opGroup() {</span>
<a href="#l102.211"></a><span id="l102.211">         if (!this.mOpGroup) {</span>
<a href="#l102.212"></a><span id="l102.212">             this.mOpGroup = new cal.data.OperationGroup(() =&gt; {</span>
<a href="#l102.213"></a><span id="l102.213">                 let listener = this.mRealListener;</span>
<a href="#l102.214"></a><span id="l102.214">                 this.mRealListener = null;</span>
<a href="#l102.215"></a><span id="l102.215">                 if (listener) {</span>
<a href="#l102.216"></a><span id="l102.216">                     listener.onOperationComplete(</span>
<a href="#l102.217"></a><span id="l102.217" class="difflineminus">-                        this, Components.interfaces.calIErrors.OPERATION_CANCELLED,</span>
<a href="#l102.218"></a><span id="l102.218" class="difflineplus">+                        this, Ci.calIErrors.OPERATION_CANCELLED,</span>
<a href="#l102.219"></a><span id="l102.219">                         calIOperationListener.GET, null, null);</span>
<a href="#l102.220"></a><span id="l102.220">                     if (this.mCompositeCalendar.statusDisplayed) {</span>
<a href="#l102.221"></a><span id="l102.221">                         this.mCompositeCalendar.mStatusObserver.stopMeteors();</span>
<a href="#l102.222"></a><span id="l102.222">                     }</span>
<a href="#l102.223"></a><span id="l102.223">                 }</span>
<a href="#l102.224"></a><span id="l102.224">             });</span>
<a href="#l102.225"></a><span id="l102.225">         }</span>
<a href="#l102.226"></a><span id="l102.226">         return this.mOpGroup;</span>
<a href="#l102.227"></a><span id="l102.227" class="difflineat">@@ -475,17 +475,17 @@ calCompositeGetListenerHelper.prototype </span>
<a href="#l102.228"></a><span id="l102.228">         if (this.mCompositeCalendar.statusDisplayed) {</span>
<a href="#l102.229"></a><span id="l102.229">             this.mCompositeCalendar.mStatusObserver.calendarCompleted(aCalendar);</span>
<a href="#l102.230"></a><span id="l102.230">         }</span>
<a href="#l102.231"></a><span id="l102.231">         if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l102.232"></a><span id="l102.232">             // proxy this to a onGetResult</span>
<a href="#l102.233"></a><span id="l102.233">             // XXX - do we want to give the real calendar? or this?</span>
<a href="#l102.234"></a><span id="l102.234">             // XXX - get rid of iid param</span>
<a href="#l102.235"></a><span id="l102.235">             this.mRealListener.onGetResult(aCalendar, aStatus,</span>
<a href="#l102.236"></a><span id="l102.236" class="difflineminus">-                                           Components.interfaces.nsISupports,</span>
<a href="#l102.237"></a><span id="l102.237" class="difflineplus">+                                           Ci.nsISupports,</span>
<a href="#l102.238"></a><span id="l102.238">                                            aDetail, 0, []);</span>
<a href="#l102.239"></a><span id="l102.239">         }</span>
<a href="#l102.240"></a><span id="l102.240"> </span>
<a href="#l102.241"></a><span id="l102.241">         this.mReceivedCompletes++;</span>
<a href="#l102.242"></a><span id="l102.242">         if (this.mReceivedCompletes == this.mNumQueries) {</span>
<a href="#l102.243"></a><span id="l102.243">             if (this.mCompositeCalendar.statusDisplayed) {</span>
<a href="#l102.244"></a><span id="l102.244">                 this.mCompositeCalendar.mStatusObserver.stopMeteors();</span>
<a href="#l102.245"></a><span id="l102.245">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineat">@@ -1,16 +1,22 @@</span>
<a href="#l103.4"></a><span id="l103.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l103.5"></a><span id="l103.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l103.6"></a><span id="l103.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l103.7"></a><span id="l103.7"> </span>
<a href="#l103.8"></a><span id="l103.8"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l103.9"></a><span id="l103.9"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l103.10"></a><span id="l103.10"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l103.11"></a><span id="l103.11"> </span>
<a href="#l103.12"></a><span id="l103.12" class="difflineplus">+// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineplus">+if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l103.14"></a><span id="l103.14" class="difflineplus">+    // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l103.15"></a><span id="l103.15" class="difflineplus">+    const { classes: Cc, interfaces: Ci, results: Cr } = Components;</span>
<a href="#l103.16"></a><span id="l103.16" class="difflineplus">+}</span>
<a href="#l103.17"></a><span id="l103.17" class="difflineplus">+</span>
<a href="#l103.18"></a><span id="l103.18"> var { cal } = ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;, null);</span>
<a href="#l103.19"></a><span id="l103.19"> const { stringException } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;, null);</span>
<a href="#l103.20"></a><span id="l103.20"> const {</span>
<a href="#l103.21"></a><span id="l103.21">     calGoogleRequest,</span>
<a href="#l103.22"></a><span id="l103.22">     getCorrectedDate,</span>
<a href="#l103.23"></a><span id="l103.23">     API_BASE</span>
<a href="#l103.24"></a><span id="l103.24"> } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;, null);</span>
<a href="#l103.25"></a><span id="l103.25"> const { getGoogleSessionManager } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataSession.jsm&quot;, null);</span>
<a href="#l103.26"></a><span id="l103.26" class="difflineat">@@ -22,17 +28,17 @@ const {</span>
<a href="#l103.27"></a><span id="l103.27">     getGoogleId,</span>
<a href="#l103.28"></a><span id="l103.28">     getItemMetadata,</span>
<a href="#l103.29"></a><span id="l103.29">     saveItemMetadata,</span>
<a href="#l103.30"></a><span id="l103.30">     deleteItemMetadata,</span>
<a href="#l103.31"></a><span id="l103.31">     migrateItemMetadata,</span>
<a href="#l103.32"></a><span id="l103.32">     JSONToAlarm</span>
<a href="#l103.33"></a><span id="l103.33"> } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;, null);</span>
<a href="#l103.34"></a><span id="l103.34"> </span>
<a href="#l103.35"></a><span id="l103.35" class="difflineminus">-var cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l103.36"></a><span id="l103.36" class="difflineplus">+var cIOL = Ci.calIOperationListener;</span>
<a href="#l103.37"></a><span id="l103.37"> </span>
<a href="#l103.38"></a><span id="l103.38"> var MIN_REFRESH_INTERVAL = 30;</span>
<a href="#l103.39"></a><span id="l103.39"> </span>
<a href="#l103.40"></a><span id="l103.40"> /**</span>
<a href="#l103.41"></a><span id="l103.41">  * calGoogleCalendar</span>
<a href="#l103.42"></a><span id="l103.42">  * This Implements a calICalendar Object adapted to the Google Calendar</span>
<a href="#l103.43"></a><span id="l103.43">  * Provider.</span>
<a href="#l103.44"></a><span id="l103.44">  *</span>
<a href="#l103.45"></a><span id="l103.45" class="difflineat">@@ -41,19 +47,19 @@ var MIN_REFRESH_INTERVAL = 30;</span>
<a href="#l103.46"></a><span id="l103.46">  */</span>
<a href="#l103.47"></a><span id="l103.47"> function calGoogleCalendar() {</span>
<a href="#l103.48"></a><span id="l103.48">     this.initProviderBase();</span>
<a href="#l103.49"></a><span id="l103.49">     this.mThrottle = Object.create(null);</span>
<a href="#l103.50"></a><span id="l103.50"> }</span>
<a href="#l103.51"></a><span id="l103.51"> </span>
<a href="#l103.52"></a><span id="l103.52"> var calGoogleCalendarClassID = Components.ID(&quot;{d1a6e988-4b4d-45a5-ba46-43e501ea96e3}&quot;);</span>
<a href="#l103.53"></a><span id="l103.53"> var calGoogleCalendarInterfaces = [</span>
<a href="#l103.54"></a><span id="l103.54" class="difflineminus">-    Components.interfaces.calICalendar,</span>
<a href="#l103.55"></a><span id="l103.55" class="difflineminus">-    Components.interfaces.calISchedulingSupport,</span>
<a href="#l103.56"></a><span id="l103.56" class="difflineminus">-    Components.interfaces.calIChangeLog</span>
<a href="#l103.57"></a><span id="l103.57" class="difflineplus">+    Ci.calICalendar,</span>
<a href="#l103.58"></a><span id="l103.58" class="difflineplus">+    Ci.calISchedulingSupport,</span>
<a href="#l103.59"></a><span id="l103.59" class="difflineplus">+    Ci.calIChangeLog</span>
<a href="#l103.60"></a><span id="l103.60"> ];</span>
<a href="#l103.61"></a><span id="l103.61"> calGoogleCalendar.prototype = {</span>
<a href="#l103.62"></a><span id="l103.62">     __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l103.63"></a><span id="l103.63"> </span>
<a href="#l103.64"></a><span id="l103.64">     classID: calGoogleCalendarClassID,</span>
<a href="#l103.65"></a><span id="l103.65">     QueryInterface: cal.generateQI(calGoogleCalendarInterfaces),</span>
<a href="#l103.66"></a><span id="l103.66">     classInfo: cal.generateCI({</span>
<a href="#l103.67"></a><span id="l103.67">         classDescription: &quot;Google Calendar Provider&quot;,</span>
<a href="#l103.68"></a><span id="l103.68" class="difflineat">@@ -95,18 +101,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.69"></a><span id="l103.69">                 this.setProperty(&quot;refreshInterval&quot;, 2 * MIN_REFRESH_INTERVAL);</span>
<a href="#l103.70"></a><span id="l103.70">             }</span>
<a href="#l103.71"></a><span id="l103.71">         }</span>
<a href="#l103.72"></a><span id="l103.72">     },</span>
<a href="#l103.73"></a><span id="l103.73"> </span>
<a href="#l103.74"></a><span id="l103.74">     ensureWritable: function() {</span>
<a href="#l103.75"></a><span id="l103.75">         // Check if calendar is readonly</span>
<a href="#l103.76"></a><span id="l103.76">         if (this.readOnly) {</span>
<a href="#l103.77"></a><span id="l103.77" class="difflineminus">-            const cIE = Components.interfaces.calIErrors;</span>
<a href="#l103.78"></a><span id="l103.78" class="difflineminus">-            throw new Components.Exception(&quot;&quot;, cIE.CAL_IS_READONLY);</span>
<a href="#l103.79"></a><span id="l103.79" class="difflineplus">+            throw new Components.Exception(&quot;&quot;, Ci.calIErrors.CAL_IS_READONLY);</span>
<a href="#l103.80"></a><span id="l103.80">         }</span>
<a href="#l103.81"></a><span id="l103.81">     },</span>
<a href="#l103.82"></a><span id="l103.82"> </span>
<a href="#l103.83"></a><span id="l103.83">     get isDefaultCalendar() { return this.mCalendarName ? !this.mCalendarName.endsWith(&quot;@group.calendar.google.com&quot;) : false; },</span>
<a href="#l103.84"></a><span id="l103.84"> </span>
<a href="#l103.85"></a><span id="l103.85">     /*</span>
<a href="#l103.86"></a><span id="l103.86">      * implement calICalendar</span>
<a href="#l103.87"></a><span id="l103.87">      */</span>
<a href="#l103.88"></a><span id="l103.88" class="difflineat">@@ -386,17 +391,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.89"></a><span id="l103.89">                 cal.LOG(&quot;[calGoogleCalendar] Adding task &quot; + aItem.title);</span>
<a href="#l103.90"></a><span id="l103.90">                 request.uri = this.createTasksURI(&quot;tasks&quot;);</span>
<a href="#l103.91"></a><span id="l103.91">                 // Tasks sent with an id will cause a bad request</span>
<a href="#l103.92"></a><span id="l103.92">                 delete itemData.id;</span>
<a href="#l103.93"></a><span id="l103.93">             }</span>
<a href="#l103.94"></a><span id="l103.94"> </span>
<a href="#l103.95"></a><span id="l103.95">             if (!request.uri) {</span>
<a href="#l103.96"></a><span id="l103.96">                 throw Components.Exception(&quot;Item type not supported&quot;,</span>
<a href="#l103.97"></a><span id="l103.97" class="difflineminus">-                                           Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l103.98"></a><span id="l103.98" class="difflineplus">+                                           Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l103.99"></a><span id="l103.99">             }</span>
<a href="#l103.100"></a><span id="l103.100"> </span>
<a href="#l103.101"></a><span id="l103.101">             request.setUploadData(&quot;application/json; charset=UTF-8&quot;,</span>
<a href="#l103.102"></a><span id="l103.102">                                   JSON.stringify(itemData));</span>
<a href="#l103.103"></a><span id="l103.103">             let data = await this.session.asyncItemRequest(request);</span>
<a href="#l103.104"></a><span id="l103.104"> </span>
<a href="#l103.105"></a><span id="l103.105">             // All we need to do now is parse the item and complete the</span>
<a href="#l103.106"></a><span id="l103.106">             // operation. The cache layer will take care of adding the item</span>
<a href="#l103.107"></a><span id="l103.107" class="difflineat">@@ -416,20 +421,20 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.108"></a><span id="l103.108">                 // item. This will add the new item to the calendar.</span>
<a href="#l103.109"></a><span id="l103.109">                 let pcal = cal.async.promisifyCalendar(this.offlineStorage);</span>
<a href="#l103.110"></a><span id="l103.110">                 await pcal.deleteItem(aItem);</span>
<a href="#l103.111"></a><span id="l103.111">             }</span>
<a href="#l103.112"></a><span id="l103.112">             return item;</span>
<a href="#l103.113"></a><span id="l103.113">         })().then((item) =&gt; {</span>
<a href="#l103.114"></a><span id="l103.114">             cal.LOG(&quot;[calGoogleCalendar] Adding &quot; + item.title + &quot; succeeded&quot;);</span>
<a href="#l103.115"></a><span id="l103.115">             this.observers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l103.116"></a><span id="l103.116" class="difflineminus">-            this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l103.117"></a><span id="l103.117" class="difflineplus">+            this.notifyOperationComplete(aListener, Cr.NS_OK,</span>
<a href="#l103.118"></a><span id="l103.118">                                          cIOL.ADD, item.id, item);</span>
<a href="#l103.119"></a><span id="l103.119">         }, (e) =&gt; {</span>
<a href="#l103.120"></a><span id="l103.120" class="difflineminus">-            let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l103.121"></a><span id="l103.121" class="difflineplus">+            let code = e.result || Cr.NS_ERROR_FAILURE;</span>
<a href="#l103.122"></a><span id="l103.122">             cal.ERROR(&quot;[calGoogleCalendar] Adding Item &quot; + aItem.title +</span>
<a href="#l103.123"></a><span id="l103.123">                       &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l103.124"></a><span id="l103.124">             this.notifyPureOperationComplete(aListener, code, cIOL.ADD, aItem.id, e.message);</span>
<a href="#l103.125"></a><span id="l103.125">         });</span>
<a href="#l103.126"></a><span id="l103.126">         return request;</span>
<a href="#l103.127"></a><span id="l103.127">     },</span>
<a href="#l103.128"></a><span id="l103.128"> </span>
<a href="#l103.129"></a><span id="l103.129">     modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l103.130"></a><span id="l103.130" class="difflineat">@@ -457,17 +462,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.131"></a><span id="l103.131">                     request.addQueryParameter(&quot;sendNotifications&quot;, &quot;true&quot;);</span>
<a href="#l103.132"></a><span id="l103.132">                 }</span>
<a href="#l103.133"></a><span id="l103.133">             } else if (cal.item.isToDo(aNewItem)) {</span>
<a href="#l103.134"></a><span id="l103.134">                 request.uri = this.createTasksURI(&quot;tasks&quot;, aNewItem.id);</span>
<a href="#l103.135"></a><span id="l103.135">             }</span>
<a href="#l103.136"></a><span id="l103.136"> </span>
<a href="#l103.137"></a><span id="l103.137">             if (!request.uri) {</span>
<a href="#l103.138"></a><span id="l103.138">                 throw Components.Exception(&quot;Item type not supported&quot;,</span>
<a href="#l103.139"></a><span id="l103.139" class="difflineminus">-                                           Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l103.140"></a><span id="l103.140" class="difflineplus">+                                           Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l103.141"></a><span id="l103.141">             }</span>
<a href="#l103.142"></a><span id="l103.142"> </span>
<a href="#l103.143"></a><span id="l103.143">             request.setUploadData(&quot;application/json; charset=UTF-8&quot;,</span>
<a href="#l103.144"></a><span id="l103.144">                                   JSON.stringify(ItemToJSON(aNewItem, this.offlineStorage)));</span>
<a href="#l103.145"></a><span id="l103.145"> </span>
<a href="#l103.146"></a><span id="l103.146">             // Set up etag from storage so we don't overwrite any foreign changes</span>
<a href="#l103.147"></a><span id="l103.147">             let refItem = aOldItem || aNewItem;</span>
<a href="#l103.148"></a><span id="l103.148">             let meta = getItemMetadata(this.offlineStorage, refItem) ||</span>
<a href="#l103.149"></a><span id="l103.149" class="difflineat">@@ -516,21 +521,21 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.150"></a><span id="l103.150">                 }</span>
<a href="#l103.151"></a><span id="l103.151">                 item = modifiedItem;</span>
<a href="#l103.152"></a><span id="l103.152">             }</span>
<a href="#l103.153"></a><span id="l103.153"> </span>
<a href="#l103.154"></a><span id="l103.154">             return item;</span>
<a href="#l103.155"></a><span id="l103.155">         })().then((item) =&gt; {</span>
<a href="#l103.156"></a><span id="l103.156">             cal.LOG(&quot;[calGoogleCalendar] Modifying &quot; + aNewItem.title + &quot; succeeded&quot;);</span>
<a href="#l103.157"></a><span id="l103.157">             this.observers.notify(&quot;onModifyItem&quot;, [item, aOldItem]);</span>
<a href="#l103.158"></a><span id="l103.158" class="difflineminus">-            this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l103.159"></a><span id="l103.159" class="difflineplus">+            this.notifyOperationComplete(aListener, Cr.NS_OK,</span>
<a href="#l103.160"></a><span id="l103.160">                                          cIOL.MODIFY, item.id, item);</span>
<a href="#l103.161"></a><span id="l103.161">         }, (e) =&gt; {</span>
<a href="#l103.162"></a><span id="l103.162" class="difflineminus">-            let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l103.163"></a><span id="l103.163" class="difflineminus">-            if (code != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l103.164"></a><span id="l103.164" class="difflineplus">+            let code = e.result || Cr.NS_ERROR_FAILURE;</span>
<a href="#l103.165"></a><span id="l103.165" class="difflineplus">+            if (code != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l103.166"></a><span id="l103.166">                 cal.ERROR(&quot;[calGoogleCalendar] Modifying item &quot; + aNewItem.title +</span>
<a href="#l103.167"></a><span id="l103.167">                           &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l103.168"></a><span id="l103.168">             }</span>
<a href="#l103.169"></a><span id="l103.169">             this.notifyPureOperationComplete(aListener, code, cIOL.MODIFY, aNewItem.id, e.message);</span>
<a href="#l103.170"></a><span id="l103.170">         });</span>
<a href="#l103.171"></a><span id="l103.171">         return request;</span>
<a href="#l103.172"></a><span id="l103.172">     },</span>
<a href="#l103.173"></a><span id="l103.173"> </span>
<a href="#l103.174"></a><span id="l103.174" class="difflineat">@@ -547,17 +552,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.175"></a><span id="l103.175">                     request.addQueryParameter(&quot;sendNotifications&quot;, &quot;true&quot;);</span>
<a href="#l103.176"></a><span id="l103.176">                 }</span>
<a href="#l103.177"></a><span id="l103.177">             } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l103.178"></a><span id="l103.178">                 request.uri = this.createTasksURI(&quot;tasks&quot;, aItem.id);</span>
<a href="#l103.179"></a><span id="l103.179">             }</span>
<a href="#l103.180"></a><span id="l103.180"> </span>
<a href="#l103.181"></a><span id="l103.181">             if (!request.uri) {</span>
<a href="#l103.182"></a><span id="l103.182">                 throw Components.Exception(&quot;Item type not supported&quot;,</span>
<a href="#l103.183"></a><span id="l103.183" class="difflineminus">-                                           Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l103.184"></a><span id="l103.184" class="difflineplus">+                                           Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l103.185"></a><span id="l103.185">             }</span>
<a href="#l103.186"></a><span id="l103.186"> </span>
<a href="#l103.187"></a><span id="l103.187">             // Set up etag from storage so we don't overwrite any foreign changes</span>
<a href="#l103.188"></a><span id="l103.188">             let meta = getItemMetadata(this.offlineStorage, aItem) ||</span>
<a href="#l103.189"></a><span id="l103.189">                        getItemMetadata(this.offlineStorage, aItem.parentItem);</span>
<a href="#l103.190"></a><span id="l103.190">             if (meta &amp;&amp; meta.etag) {</span>
<a href="#l103.191"></a><span id="l103.191">                 request.addRequestHeader(&quot;If-Match&quot;, meta.etag);</span>
<a href="#l103.192"></a><span id="l103.192">             } else {</span>
<a href="#l103.193"></a><span id="l103.193" class="difflineat">@@ -576,21 +581,21 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.194"></a><span id="l103.194">             }</span>
<a href="#l103.195"></a><span id="l103.195"> </span>
<a href="#l103.196"></a><span id="l103.196">             deleteItemMetadata(this.offlineStorage, aItem);</span>
<a href="#l103.197"></a><span id="l103.197"> </span>
<a href="#l103.198"></a><span id="l103.198">             return aItem;</span>
<a href="#l103.199"></a><span id="l103.199">         })().then((item) =&gt; {</span>
<a href="#l103.200"></a><span id="l103.200">             cal.LOG(&quot;[calGoogleCalendar] Deleting &quot; + aItem.title + &quot; succeeded&quot;);</span>
<a href="#l103.201"></a><span id="l103.201">             this.observers.notify(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l103.202"></a><span id="l103.202" class="difflineminus">-            this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l103.203"></a><span id="l103.203" class="difflineplus">+            this.notifyOperationComplete(aListener, Cr.NS_OK,</span>
<a href="#l103.204"></a><span id="l103.204">                                          cIOL.DELETE, item.id, item);</span>
<a href="#l103.205"></a><span id="l103.205">         }, (e) =&gt; {</span>
<a href="#l103.206"></a><span id="l103.206" class="difflineminus">-            let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l103.207"></a><span id="l103.207" class="difflineminus">-            if (code != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l103.208"></a><span id="l103.208" class="difflineplus">+            let code = e.result || Cr.NS_ERROR_FAILURE;</span>
<a href="#l103.209"></a><span id="l103.209" class="difflineplus">+            if (code != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l103.210"></a><span id="l103.210">                 cal.ERROR(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title +</span>
<a href="#l103.211"></a><span id="l103.211">                           &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l103.212"></a><span id="l103.212">             }</span>
<a href="#l103.213"></a><span id="l103.213">             this.notifyPureOperationComplete(aListener, code, cIOL.DELETE, aItem.id, e.message);</span>
<a href="#l103.214"></a><span id="l103.214">         });</span>
<a href="#l103.215"></a><span id="l103.215">         return request;</span>
<a href="#l103.216"></a><span id="l103.216">     },</span>
<a href="#l103.217"></a><span id="l103.217"> </span>
<a href="#l103.218"></a><span id="l103.218" class="difflineat">@@ -671,31 +676,29 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.219"></a><span id="l103.219">                 onDeleteCalendar: function(aCalendar, aStatus, aDetail) {</span>
<a href="#l103.220"></a><span id="l103.220">                     if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l103.221"></a><span id="l103.221">                         resolve();</span>
<a href="#l103.222"></a><span id="l103.222">                     } else {</span>
<a href="#l103.223"></a><span id="l103.223">                         reject(aDetail);</span>
<a href="#l103.224"></a><span id="l103.224">                     }</span>
<a href="#l103.225"></a><span id="l103.225">                 }</span>
<a href="#l103.226"></a><span id="l103.226">             };</span>
<a href="#l103.227"></a><span id="l103.227" class="difflineminus">-            this.mOfflineStorage.QueryInterface(Components.interfaces.calICalendarProvider)</span>
<a href="#l103.228"></a><span id="l103.228" class="difflineplus">+            this.mOfflineStorage.QueryInterface(Ci.calICalendarProvider)</span>
<a href="#l103.229"></a><span id="l103.229">                                 .deleteCalendar(this.mOfflineStorage, listener);</span>
<a href="#l103.230"></a><span id="l103.230">         });</span>
<a href="#l103.231"></a><span id="l103.231">     },</span>
<a href="#l103.232"></a><span id="l103.232"> </span>
<a href="#l103.233"></a><span id="l103.233">     replayChangesOn: function(aListener) {</span>
<a href="#l103.234"></a><span id="l103.234">         // Figure out if the user is idle, no need to synchronize if so.</span>
<a href="#l103.235"></a><span id="l103.235" class="difflineminus">-        let idleTime = Components.classes[&quot;@mozilla.org/widget/idleservice;1&quot;]</span>
<a href="#l103.236"></a><span id="l103.236" class="difflineminus">-                                 .getService(Components.interfaces.nsIIdleService)</span>
<a href="#l103.237"></a><span id="l103.237" class="difflineminus">-                                 .idleTime;</span>
<a href="#l103.238"></a><span id="l103.238" class="difflineplus">+        let idleTime = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;].getService(Ci.nsIIdleService).idleTime;</span>
<a href="#l103.239"></a><span id="l103.239">         let maxIdleTime = Preferences.get(&quot;calendar.google.idleTime&quot;, 300) * 1000;</span>
<a href="#l103.240"></a><span id="l103.240"> </span>
<a href="#l103.241"></a><span id="l103.241">         if (maxIdleTime != 0 &amp;&amp; idleTime &gt; maxIdleTime) {</span>
<a href="#l103.242"></a><span id="l103.242">             cal.LOG(&quot;[calGoogleCalendar] Skipping refresh since user is idle&quot;);</span>
<a href="#l103.243"></a><span id="l103.243" class="difflineminus">-            aListener.onResult({ status: Components.results.NS_OK }, null);</span>
<a href="#l103.244"></a><span id="l103.244" class="difflineplus">+            aListener.onResult({ status: Cr.NS_OK }, null);</span>
<a href="#l103.245"></a><span id="l103.245">             return Promise.resolve();</span>
<a href="#l103.246"></a><span id="l103.246">         }</span>
<a href="#l103.247"></a><span id="l103.247"> </span>
<a href="#l103.248"></a><span id="l103.248">         // Now that we've determined we are not idle we can continue with the sync.</span>
<a href="#l103.249"></a><span id="l103.249">         let maxResults = Preferences.get(&quot;calendar.google.maxResultsPerRequest&quot;, null);</span>
<a href="#l103.250"></a><span id="l103.250"> </span>
<a href="#l103.251"></a><span id="l103.251">         // We are going to be making potentially lots of changes to the offline</span>
<a href="#l103.252"></a><span id="l103.252">         // storage, start a batch operation.</span>
<a href="#l103.253"></a><span id="l103.253" class="difflineat">@@ -785,20 +788,20 @@ calGoogleCalendar.prototype = {</span>
<a href="#l103.254"></a><span id="l103.254">                             &quot;(tasks) is now: &quot; + tasksRequest.requestDate.toString());</span>
<a href="#l103.255"></a><span id="l103.255">                     this.setProperty(&quot;newLastUpdated.tasks&quot;, newLastUpdated);</span>
<a href="#l103.256"></a><span id="l103.256">                 });</span>
<a href="#l103.257"></a><span id="l103.257">             });</span>
<a href="#l103.258"></a><span id="l103.258">         }</span>
<a href="#l103.259"></a><span id="l103.259"> </span>
<a href="#l103.260"></a><span id="l103.260">         return Promise.all([calendarPromise, eventsPromise, tasksPromise]).then(() =&gt; {</span>
<a href="#l103.261"></a><span id="l103.261">             this.mOfflineStorage.endBatch();</span>
<a href="#l103.262"></a><span id="l103.262" class="difflineminus">-            aListener.onResult({ status: Components.results.NS_OK }, null);</span>
<a href="#l103.263"></a><span id="l103.263" class="difflineplus">+            aListener.onResult({ status: Cr.NS_OK }, null);</span>
<a href="#l103.264"></a><span id="l103.264">         }, (e) =&gt; {</span>
<a href="#l103.265"></a><span id="l103.265">             this.mOfflineStorage.endBatch();</span>
<a href="#l103.266"></a><span id="l103.266" class="difflineminus">-            let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l103.267"></a><span id="l103.267" class="difflineplus">+            let code = e.result || Cr.NS_ERROR_FAILURE;</span>
<a href="#l103.268"></a><span id="l103.268">             if (code == calGoogleRequest.RESOURCE_GONE) {</span>
<a href="#l103.269"></a><span id="l103.269">                 cal.LOG(&quot;[calGoogleCalendar] Server did not accept &quot; +</span>
<a href="#l103.270"></a><span id="l103.270">                         &quot;incremental update, resetting calendar and &quot; +</span>
<a href="#l103.271"></a><span id="l103.271">                         &quot;starting over.&quot;);</span>
<a href="#l103.272"></a><span id="l103.272">                 this.resetSync().then(() =&gt; {</span>
<a href="#l103.273"></a><span id="l103.273">                     this.replayChangesOn(aListener);</span>
<a href="#l103.274"></a><span id="l103.274">                 }, (err) =&gt; {</span>
<a href="#l103.275"></a><span id="l103.275">                     cal.ERROR(&quot;[calGoogleCalendar] Error resetting calendar:\n&quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1" class="difflineminus">--- a/calendar/providers/gdata/content/browserRequest.js</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineplus">+++ b/calendar/providers/gdata/content/browserRequest.js</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineat">@@ -1,17 +1,23 @@</span>
<a href="#l104.4"></a><span id="l104.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l104.5"></a><span id="l104.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l104.6"></a><span id="l104.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l104.7"></a><span id="l104.7"> </span>
<a href="#l104.8"></a><span id="l104.8" class="difflineplus">+// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l104.9"></a><span id="l104.9" class="difflineplus">+if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l104.10"></a><span id="l104.10" class="difflineplus">+    // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l104.11"></a><span id="l104.11" class="difflineplus">+    const { interfaces: Ci } = Components;</span>
<a href="#l104.12"></a><span id="l104.12" class="difflineplus">+}</span>
<a href="#l104.13"></a><span id="l104.13" class="difflineplus">+</span>
<a href="#l104.14"></a><span id="l104.14"> var { cal } = ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;, null);</span>
<a href="#l104.15"></a><span id="l104.15"> </span>
<a href="#l104.16"></a><span id="l104.16"> /* exported cancelRequest, loadRequestedUrl, reportUserClosed */</span>
<a href="#l104.17"></a><span id="l104.17"> </span>
<a href="#l104.18"></a><span id="l104.18" class="difflineminus">-var wpl = Components.interfaces.nsIWebProgressListener;</span>
<a href="#l104.19"></a><span id="l104.19" class="difflineplus">+var wpl = Ci.nsIWebProgressListener;</span>
<a href="#l104.20"></a><span id="l104.20"> </span>
<a href="#l104.21"></a><span id="l104.21"> var reporterListener = {</span>
<a href="#l104.22"></a><span id="l104.22">     _isBusy: false,</span>
<a href="#l104.23"></a><span id="l104.23">     get securityButton() {</span>
<a href="#l104.24"></a><span id="l104.24">         delete this.securityButton;</span>
<a href="#l104.25"></a><span id="l104.25">         return (this.securityButton = document.getElementById(&quot;security-button&quot;));</span>
<a href="#l104.26"></a><span id="l104.26">     },</span>
<a href="#l104.27"></a><span id="l104.27"> </span>
<a href="#l104.28"></a><span id="l104.28" class="difflineat">@@ -80,18 +86,17 @@ function reportUserClosed() {</span>
<a href="#l104.29"></a><span id="l104.29"> function loadRequestedUrl() {</span>
<a href="#l104.30"></a><span id="l104.30">     let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l104.31"></a><span id="l104.31">     document.getElementById(&quot;headerMessage&quot;).textContent = request.promptText;</span>
<a href="#l104.32"></a><span id="l104.32">     if (request.iconURI != &quot;&quot;) {</span>
<a href="#l104.33"></a><span id="l104.33">         document.getElementById(&quot;headerImage&quot;).src = request.iconURI;</span>
<a href="#l104.34"></a><span id="l104.34">     }</span>
<a href="#l104.35"></a><span id="l104.35"> </span>
<a href="#l104.36"></a><span id="l104.36">     let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l104.37"></a><span id="l104.37" class="difflineminus">-    browser.addProgressListener(reporterListener,</span>
<a href="#l104.38"></a><span id="l104.38" class="difflineminus">-                                Components.interfaces.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l104.39"></a><span id="l104.39" class="difflineplus">+    browser.addProgressListener(reporterListener, Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l104.40"></a><span id="l104.40">     let url = request.url;</span>
<a href="#l104.41"></a><span id="l104.41">     if (url != &quot;&quot;) {</span>
<a href="#l104.42"></a><span id="l104.42">         browser.setAttribute(&quot;src&quot;, url);</span>
<a href="#l104.43"></a><span id="l104.43">         document.getElementById(&quot;headerMessage&quot;).textContent = url;</span>
<a href="#l104.44"></a><span id="l104.44">     }</span>
<a href="#l104.45"></a><span id="l104.45"> </span>
<a href="#l104.46"></a><span id="l104.46">     let dialogMessage = document.getElementById(&quot;dialogMessage&quot;);</span>
<a href="#l104.47"></a><span id="l104.47">     if (request.description) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-creation.js</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-creation.js</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineat">@@ -1,12 +1,18 @@</span>
<a href="#l105.4"></a><span id="l105.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l105.5"></a><span id="l105.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l105.6"></a><span id="l105.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l105.7"></a><span id="l105.7"> </span>
<a href="#l105.8"></a><span id="l105.8" class="difflineplus">+// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l105.9"></a><span id="l105.9" class="difflineplus">+if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l105.10"></a><span id="l105.10" class="difflineplus">+    // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l105.11"></a><span id="l105.11" class="difflineplus">+    const { utils: Cu } = Components;</span>
<a href="#l105.12"></a><span id="l105.12" class="difflineplus">+}</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineplus">+</span>
<a href="#l105.14"></a><span id="l105.14"> var { cal } = ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;, null);</span>
<a href="#l105.15"></a><span id="l105.15"> const { getGoogleSessionManager } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataSession.jsm&quot;, null);</span>
<a href="#l105.16"></a><span id="l105.16"> const { monkeyPatch } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;, null);</span>
<a href="#l105.17"></a><span id="l105.17"> </span>
<a href="#l105.18"></a><span id="l105.18"> (function() {</span>
<a href="#l105.19"></a><span id="l105.19">     function pageorder(anchor, ...pages) {</span>
<a href="#l105.20"></a><span id="l105.20">         let wizard = document.documentElement;</span>
<a href="#l105.21"></a><span id="l105.21">         let page = wizard.getPageById(anchor);</span>
<a href="#l105.22"></a><span id="l105.22" class="difflineat">@@ -16,17 +22,17 @@ const { monkeyPatch } = ChromeUtils.impo</span>
<a href="#l105.23"></a><span id="l105.23">         }</span>
<a href="#l105.24"></a><span id="l105.24">     }</span>
<a href="#l105.25"></a><span id="l105.25"> </span>
<a href="#l105.26"></a><span id="l105.26">     function trycatch(func) {</span>
<a href="#l105.27"></a><span id="l105.27">         return function() {</span>
<a href="#l105.28"></a><span id="l105.28">             try {</span>
<a href="#l105.29"></a><span id="l105.29">                 return func.apply(this, arguments);</span>
<a href="#l105.30"></a><span id="l105.30">             } catch (e) {</span>
<a href="#l105.31"></a><span id="l105.31" class="difflineminus">-                Components.utils.reportError(e);</span>
<a href="#l105.32"></a><span id="l105.32" class="difflineplus">+                Cu.reportError(e);</span>
<a href="#l105.33"></a><span id="l105.33">                 throw e;</span>
<a href="#l105.34"></a><span id="l105.34">             }</span>
<a href="#l105.35"></a><span id="l105.35">         };</span>
<a href="#l105.36"></a><span id="l105.36">     }</span>
<a href="#l105.37"></a><span id="l105.37"> </span>
<a href="#l105.38"></a><span id="l105.38">     let previousUriValue = null;</span>
<a href="#l105.39"></a><span id="l105.39">     function selectProvider(type) {</span>
<a href="#l105.40"></a><span id="l105.40">         let isGdata = (type == &quot;gdata&quot;);</span>
<a href="#l105.41"></a><span id="l105.41" class="difflineat">@@ -199,17 +205,17 @@ const { monkeyPatch } = ChromeUtils.impo</span>
<a href="#l105.42"></a><span id="l105.42"> </span>
<a href="#l105.43"></a><span id="l105.43">             let calendars = [calendarListWidget.mockCalendarHeader]</span>
<a href="#l105.44"></a><span id="l105.44">                             .concat(calcals)</span>
<a href="#l105.45"></a><span id="l105.45">                             .concat([calendarListWidget.mockTaskHeader])</span>
<a href="#l105.46"></a><span id="l105.46">                             .concat(taskcals);</span>
<a href="#l105.47"></a><span id="l105.47"> </span>
<a href="#l105.48"></a><span id="l105.48">             calendarListWidget.calendars = calendars;</span>
<a href="#l105.49"></a><span id="l105.49">         }, (e) =&gt; {</span>
<a href="#l105.50"></a><span id="l105.50" class="difflineminus">-            Components.utils.reportError(e);</span>
<a href="#l105.51"></a><span id="l105.51" class="difflineplus">+            Cu.reportError(e);</span>
<a href="#l105.52"></a><span id="l105.52">         });</span>
<a href="#l105.53"></a><span id="l105.53">     });</span>
<a href="#l105.54"></a><span id="l105.54"> </span>
<a href="#l105.55"></a><span id="l105.55">     this.gdataCalendarsAdvance = trycatch(() =&gt; {</span>
<a href="#l105.56"></a><span id="l105.56">         let calendarList = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l105.57"></a><span id="l105.57">         let calendars = calendarList.selectedCalendars.filter(calendar =&gt; !calendar.getProperty(&quot;disabled&quot;) &amp;&amp; !calendar.readOnly);</span>
<a href="#l105.58"></a><span id="l105.58">         let calMgr = cal.getCalendarManager();</span>
<a href="#l105.59"></a><span id="l105.59">         calendars.forEach(calMgr.registerCalendar, calMgr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1" class="difflineminus">--- a/calendar/providers/gdata/modules/OAuth2.jsm</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/OAuth2.jsm</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineat">@@ -2,16 +2,22 @@</span>
<a href="#l106.4"></a><span id="l106.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l106.5"></a><span id="l106.5">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l106.6"></a><span id="l106.6"> </span>
<a href="#l106.7"></a><span id="l106.7"> /**</span>
<a href="#l106.8"></a><span id="l106.8">  * Provides OAuth 2.0 authentication</span>
<a href="#l106.9"></a><span id="l106.9">  */</span>
<a href="#l106.10"></a><span id="l106.10"> var EXPORTED_SYMBOLS = [&quot;OAuth2&quot;]; /* exported OAuth2 */</span>
<a href="#l106.11"></a><span id="l106.11"> </span>
<a href="#l106.12"></a><span id="l106.12" class="difflineplus">+// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l106.13"></a><span id="l106.13" class="difflineplus">+if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l106.14"></a><span id="l106.14" class="difflineplus">+    // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l106.15"></a><span id="l106.15" class="difflineplus">+    const { interfaces: Ci, results: Cr } = Components;</span>
<a href="#l106.16"></a><span id="l106.16" class="difflineplus">+}</span>
<a href="#l106.17"></a><span id="l106.17" class="difflineplus">+</span>
<a href="#l106.18"></a><span id="l106.18"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l106.19"></a><span id="l106.19"> const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l106.20"></a><span id="l106.20"> const { httpRequest } = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;, null);</span>
<a href="#l106.21"></a><span id="l106.21"> </span>
<a href="#l106.22"></a><span id="l106.22"> const { cal } = ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;, null);</span>
<a href="#l106.23"></a><span id="l106.23"> </span>
<a href="#l106.24"></a><span id="l106.24"> function parseURLData(aData) {</span>
<a href="#l106.25"></a><span id="l106.25">     let result = {};</span>
<a href="#l106.26"></a><span id="l106.26" class="difflineat">@@ -100,17 +106,17 @@ OAuth2.prototype = {</span>
<a href="#l106.27"></a><span id="l106.27">             _active: true,</span>
<a href="#l106.28"></a><span id="l106.28">             iconURI: &quot;&quot;,</span>
<a href="#l106.29"></a><span id="l106.29">             cancelled: function() {</span>
<a href="#l106.30"></a><span id="l106.30">                 if (!this._active) {</span>
<a href="#l106.31"></a><span id="l106.31">                     return;</span>
<a href="#l106.32"></a><span id="l106.32">                 }</span>
<a href="#l106.33"></a><span id="l106.33"> </span>
<a href="#l106.34"></a><span id="l106.34">                 this.account.finishAuthorizationRequest();</span>
<a href="#l106.35"></a><span id="l106.35" class="difflineminus">-                this.account.onAuthorizationFailed(Components.results.NS_ERROR_ABORT, '{ &quot;error&quot;: &quot;cancelled&quot;}');</span>
<a href="#l106.36"></a><span id="l106.36" class="difflineplus">+                this.account.onAuthorizationFailed(Cr.NS_ERROR_ABORT, '{ &quot;error&quot;: &quot;cancelled&quot;}');</span>
<a href="#l106.37"></a><span id="l106.37">             },</span>
<a href="#l106.38"></a><span id="l106.38"> </span>
<a href="#l106.39"></a><span id="l106.39">             loaded: function(aWindow, aWebProgress) {</span>
<a href="#l106.40"></a><span id="l106.40">                 if (!this._active) {</span>
<a href="#l106.41"></a><span id="l106.41">                     return;</span>
<a href="#l106.42"></a><span id="l106.42">                 }</span>
<a href="#l106.43"></a><span id="l106.43"> </span>
<a href="#l106.44"></a><span id="l106.44">                 this._listener = {</span>
<a href="#l106.45"></a><span id="l106.45" class="difflineat">@@ -134,48 +140,47 @@ OAuth2.prototype = {</span>
<a href="#l106.46"></a><span id="l106.46">                             return;</span>
<a href="#l106.47"></a><span id="l106.47">                         }</span>
<a href="#l106.48"></a><span id="l106.48"> </span>
<a href="#l106.49"></a><span id="l106.49">                         this._parent.finishAuthorizationRequest();</span>
<a href="#l106.50"></a><span id="l106.50">                         this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l106.51"></a><span id="l106.51">                     },</span>
<a href="#l106.52"></a><span id="l106.52"> </span>
<a href="#l106.53"></a><span id="l106.53">                     onStateChange: function(aChangedWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l106.54"></a><span id="l106.54" class="difflineminus">-                        const wpl = Components.interfaces.nsIWebProgressListener;</span>
<a href="#l106.55"></a><span id="l106.55" class="difflineplus">+                        const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l106.56"></a><span id="l106.56">                         if (aStateFlags &amp; (wpl.STATE_STOP)) {</span>
<a href="#l106.57"></a><span id="l106.57">                             try {</span>
<a href="#l106.58"></a><span id="l106.58" class="difflineminus">-                                let httpchannel = aRequest.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l106.59"></a><span id="l106.59" class="difflineplus">+                                let httpchannel = aRequest.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l106.60"></a><span id="l106.60"> </span>
<a href="#l106.61"></a><span id="l106.61">                                 let responseCategory = Math.floor(httpchannel.responseStatus / 100);</span>
<a href="#l106.62"></a><span id="l106.62"> </span>
<a href="#l106.63"></a><span id="l106.63">                                 if (responseCategory != 2 &amp;&amp; responseCategory != 3) {</span>
<a href="#l106.64"></a><span id="l106.64">                                     this._parent.finishAuthorizationRequest();</span>
<a href="#l106.65"></a><span id="l106.65">                                     this._parent.onAuthorizationFailed(null, '{ &quot;error&quot;: &quot;http_' + httpchannel.responseStatus + '&quot; }');</span>
<a href="#l106.66"></a><span id="l106.66">                                 }</span>
<a href="#l106.67"></a><span id="l106.67">                             } catch (e) {</span>
<a href="#l106.68"></a><span id="l106.68">                                 // Throw the case where it's a http channel.</span>
<a href="#l106.69"></a><span id="l106.69" class="difflineminus">-                                if (e.result != Components.results.NS_ERROR_NO_INTERFACE) {</span>
<a href="#l106.70"></a><span id="l106.70" class="difflineplus">+                                if (e.result != Cr.NS_ERROR_NO_INTERFACE) {</span>
<a href="#l106.71"></a><span id="l106.71">                                     throw e;</span>
<a href="#l106.72"></a><span id="l106.72">                                 }</span>
<a href="#l106.73"></a><span id="l106.73">                             }</span>
<a href="#l106.74"></a><span id="l106.74">                         }</span>
<a href="#l106.75"></a><span id="l106.75"> </span>
<a href="#l106.76"></a><span id="l106.76">                         if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK)) {</span>
<a href="#l106.77"></a><span id="l106.77">                             this._checkForRedirect(aRequest.name);</span>
<a href="#l106.78"></a><span id="l106.78">                         }</span>
<a href="#l106.79"></a><span id="l106.79">                     },</span>
<a href="#l106.80"></a><span id="l106.80">                     onLocationChange: function(aChangedWebProgress, aRequest, aLocation) {</span>
<a href="#l106.81"></a><span id="l106.81">                         this._checkForRedirect(aLocation.spec);</span>
<a href="#l106.82"></a><span id="l106.82">                     },</span>
<a href="#l106.83"></a><span id="l106.83">                     onProgressChange: function() {},</span>
<a href="#l106.84"></a><span id="l106.84">                     onStatusChange: function() {},</span>
<a href="#l106.85"></a><span id="l106.85">                     onSecurityChange: function() {},</span>
<a href="#l106.86"></a><span id="l106.86">                 };</span>
<a href="#l106.87"></a><span id="l106.87" class="difflineminus">-                aWebProgress.addProgressListener(this._listener,</span>
<a href="#l106.88"></a><span id="l106.88" class="difflineminus">-                                                 Components.interfaces.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l106.89"></a><span id="l106.89" class="difflineplus">+                aWebProgress.addProgressListener(this._listener, Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l106.90"></a><span id="l106.90">                 aWindow.document.title = this.account.requestWindowTitle;</span>
<a href="#l106.91"></a><span id="l106.91">             }</span>
<a href="#l106.92"></a><span id="l106.92">         };</span>
<a href="#l106.93"></a><span id="l106.93"> </span>
<a href="#l106.94"></a><span id="l106.94">         this.wrappedJSObject = this._browserRequest;</span>
<a href="#l106.95"></a><span id="l106.95">         Services.ww.openWindow(null, this.requestWindowURI, null, this.requestWindowFeatures, this);</span>
<a href="#l106.96"></a><span id="l106.96">     },</span>
<a href="#l106.97"></a><span id="l106.97">     finishAuthorizationRequest: function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataLogging.jsm</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataLogging.jsm</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineat">@@ -1,14 +1,20 @@</span>
<a href="#l107.4"></a><span id="l107.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l107.5"></a><span id="l107.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l107.6"></a><span id="l107.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l107.7"></a><span id="l107.7"> </span>
<a href="#l107.8"></a><span id="l107.8"> var EXPORTED_SYMBOLS = [&quot;LOGitem&quot;, &quot;LOGverbose&quot;, &quot;LOGinterval&quot;, &quot;stringException&quot;];</span>
<a href="#l107.9"></a><span id="l107.9"> </span>
<a href="#l107.10"></a><span id="l107.10" class="difflineplus">+// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l107.11"></a><span id="l107.11" class="difflineplus">+if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l107.12"></a><span id="l107.12" class="difflineplus">+    // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineplus">+    const { interfaces: Ci } = Components;</span>
<a href="#l107.14"></a><span id="l107.14" class="difflineplus">+}</span>
<a href="#l107.15"></a><span id="l107.15" class="difflineplus">+</span>
<a href="#l107.16"></a><span id="l107.16"> const { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l107.17"></a><span id="l107.17"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l107.18"></a><span id="l107.18"> </span>
<a href="#l107.19"></a><span id="l107.19"> function LOGverbose(aStr) {</span>
<a href="#l107.20"></a><span id="l107.20">     if (Preferences.get(&quot;calendar.debug.log.verbose&quot;, false)) {</span>
<a href="#l107.21"></a><span id="l107.21">         cal.LOG(aStr);</span>
<a href="#l107.22"></a><span id="l107.22">     }</span>
<a href="#l107.23"></a><span id="l107.23"> }</span>
<a href="#l107.24"></a><span id="l107.24" class="difflineat">@@ -106,17 +112,17 @@ function LOGalarm(aAlarm) {</span>
<a href="#l107.25"></a><span id="l107.25">             &quot;\n\t\trepeatOffset: &quot; + (aAlarm.repeatOffset &amp;&amp; aAlarm.repeatOffset.toString()) +</span>
<a href="#l107.26"></a><span id="l107.26">             &quot;\n\t\trepeatDate: &quot; + (aAlarm.repeatDate &amp;&amp; aAlarm.repeatDate.toString()) +</span>
<a href="#l107.27"></a><span id="l107.27">             &quot;\n\t\tdescription: &quot; + aAlarm.description +</span>
<a href="#l107.28"></a><span id="l107.28">             &quot;\n\t\tsummary: &quot; + aAlarm.summary +</span>
<a href="#l107.29"></a><span id="l107.29">             &quot;\n\t\tproperties: &quot; + (xpropstr.length &gt; 0 ? &quot;yes:&quot; + xpropstr : &quot;no&quot;));</span>
<a href="#l107.30"></a><span id="l107.30"> }</span>
<a href="#l107.31"></a><span id="l107.31"> </span>
<a href="#l107.32"></a><span id="l107.32"> function LOGinterval(aInterval) {</span>
<a href="#l107.33"></a><span id="l107.33" class="difflineminus">-    const fbtypes = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l107.34"></a><span id="l107.34" class="difflineplus">+    const fbtypes = Ci.calIFreeBusyInterval;</span>
<a href="#l107.35"></a><span id="l107.35">     let type;</span>
<a href="#l107.36"></a><span id="l107.36">     if (aInterval.freeBusyType == fbtypes.FREE) {</span>
<a href="#l107.37"></a><span id="l107.37">         type = &quot;FREE&quot;;</span>
<a href="#l107.38"></a><span id="l107.38">     } else if (aInterval.freeBusyType == fbtypes.BUSY) {</span>
<a href="#l107.39"></a><span id="l107.39">         type = &quot;BUSY&quot;;</span>
<a href="#l107.40"></a><span id="l107.40">     } else {</span>
<a href="#l107.41"></a><span id="l107.41">         type = aInterval.freeBusyType + &quot; (UNKNOWN)&quot;;</span>
<a href="#l107.42"></a><span id="l107.42">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineat">@@ -1,20 +1,24 @@</span>
<a href="#l108.4"></a><span id="l108.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l108.5"></a><span id="l108.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l108.6"></a><span id="l108.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l108.7"></a><span id="l108.7"> </span>
<a href="#l108.8"></a><span id="l108.8" class="difflineplus">+// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l108.9"></a><span id="l108.9" class="difflineplus">+if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l108.10"></a><span id="l108.10" class="difflineplus">+    // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l108.11"></a><span id="l108.11" class="difflineplus">+    const { classes: Cc, interfaces: Ci, results: Cr } = Components;</span>
<a href="#l108.12"></a><span id="l108.12" class="difflineplus">+}</span>
<a href="#l108.13"></a><span id="l108.13" class="difflineplus">+</span>
<a href="#l108.14"></a><span id="l108.14"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l108.15"></a><span id="l108.15"> ChromeUtils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l108.16"></a><span id="l108.16"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l108.17"></a><span id="l108.17"> </span>
<a href="#l108.18"></a><span id="l108.18"> const { cal } = ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;, null);</span>
<a href="#l108.19"></a><span id="l108.19"> </span>
<a href="#l108.20"></a><span id="l108.20" class="difflineminus">-var cIE = Components.interfaces.calIErrors;</span>
<a href="#l108.21"></a><span id="l108.21" class="difflineminus">-</span>
<a href="#l108.22"></a><span id="l108.22"> var API_BASE = {</span>
<a href="#l108.23"></a><span id="l108.23">     EVENTS: &quot;https://www.googleapis.com/calendar/v3/&quot;,</span>
<a href="#l108.24"></a><span id="l108.24">     TASKS: &quot;https://www.googleapis.com/tasks/v1/&quot;</span>
<a href="#l108.25"></a><span id="l108.25"> };</span>
<a href="#l108.26"></a><span id="l108.26"> </span>
<a href="#l108.27"></a><span id="l108.27"> var EXPORTED_SYMBOLS = [&quot;calGoogleRequest&quot;, &quot;getCorrectedDate&quot;, &quot;API_BASE&quot;];</span>
<a href="#l108.28"></a><span id="l108.28"> </span>
<a href="#l108.29"></a><span id="l108.29"> /**</span>
<a href="#l108.30"></a><span id="l108.30" class="difflineat">@@ -44,17 +48,17 @@ function calGoogleRequest() {</span>
<a href="#l108.31"></a><span id="l108.31">     this.wrappedJSObject = this;</span>
<a href="#l108.32"></a><span id="l108.32"> }</span>
<a href="#l108.33"></a><span id="l108.33"> calGoogleRequest.ADD = &quot;POST&quot;;</span>
<a href="#l108.34"></a><span id="l108.34"> calGoogleRequest.MODIFY = &quot;PUT&quot;;</span>
<a href="#l108.35"></a><span id="l108.35"> calGoogleRequest.DELETE = &quot;DELETE&quot;;</span>
<a href="#l108.36"></a><span id="l108.36"> calGoogleRequest.GET = &quot;GET&quot;;</span>
<a href="#l108.37"></a><span id="l108.37"> calGoogleRequest.PATCH = &quot;PATCH&quot;;</span>
<a href="#l108.38"></a><span id="l108.38"> </span>
<a href="#l108.39"></a><span id="l108.39" class="difflineminus">-var GDATA_ERROR_BASE = Components.interfaces.calIErrors.ERROR_BASE + 0x400;</span>
<a href="#l108.40"></a><span id="l108.40" class="difflineplus">+var GDATA_ERROR_BASE = Ci.calIErrors.ERROR_BASE + 0x400;</span>
<a href="#l108.41"></a><span id="l108.41"> calGoogleRequest.LOGIN_FAILED = GDATA_ERROR_BASE + 1;</span>
<a href="#l108.42"></a><span id="l108.42"> calGoogleRequest.CONFLICT_DELETED = GDATA_ERROR_BASE + 2;</span>
<a href="#l108.43"></a><span id="l108.43"> calGoogleRequest.CONFLICT_MODIFY = GDATA_ERROR_BASE + 3;</span>
<a href="#l108.44"></a><span id="l108.44"> calGoogleRequest.NOT_MODIFIED = GDATA_ERROR_BASE + 4;</span>
<a href="#l108.45"></a><span id="l108.45"> calGoogleRequest.QUOTA_FAILURE = GDATA_ERROR_BASE + 5;</span>
<a href="#l108.46"></a><span id="l108.46"> calGoogleRequest.TOKEN_FAILURE = GDATA_ERROR_BASE + 6;</span>
<a href="#l108.47"></a><span id="l108.47"> calGoogleRequest.RESOURCE_GONE = GDATA_ERROR_BASE + 7;</span>
<a href="#l108.48"></a><span id="l108.48"> </span>
<a href="#l108.49"></a><span id="l108.49" class="difflineat">@@ -63,17 +67,17 @@ calGoogleRequest.prototype = {</span>
<a href="#l108.50"></a><span id="l108.50">     /* Members */</span>
<a href="#l108.51"></a><span id="l108.51">     mUploadContent: null,</span>
<a href="#l108.52"></a><span id="l108.52">     mUploadData: null,</span>
<a href="#l108.53"></a><span id="l108.53">     mSession: null,</span>
<a href="#l108.54"></a><span id="l108.54">     mQueryParameters: null,</span>
<a href="#l108.55"></a><span id="l108.55">     mType: null,</span>
<a href="#l108.56"></a><span id="l108.56">     mLoader: null,</span>
<a href="#l108.57"></a><span id="l108.57">     mDeferred: null,</span>
<a href="#l108.58"></a><span id="l108.58" class="difflineminus">-    mStatus: Components.results.NS_OK,</span>
<a href="#l108.59"></a><span id="l108.59" class="difflineplus">+    mStatus: Cr.NS_OK,</span>
<a href="#l108.60"></a><span id="l108.60"> </span>
<a href="#l108.61"></a><span id="l108.61">     /* Constants */</span>
<a href="#l108.62"></a><span id="l108.62">     ADD: calGoogleRequest.ADD,</span>
<a href="#l108.63"></a><span id="l108.63">     MODIFY: calGoogleRequest.MODIFY,</span>
<a href="#l108.64"></a><span id="l108.64">     DELETE: calGoogleRequest.DELETE,</span>
<a href="#l108.65"></a><span id="l108.65">     GET: calGoogleRequest.GET,</span>
<a href="#l108.66"></a><span id="l108.66">     PATCH: calGoogleRequest.PATCH,</span>
<a href="#l108.67"></a><span id="l108.67"> </span>
<a href="#l108.68"></a><span id="l108.68" class="difflineat">@@ -122,17 +126,17 @@ calGoogleRequest.prototype = {</span>
<a href="#l108.69"></a><span id="l108.69">      * GET, ADD, MODIFY, DELETE</span>
<a href="#l108.70"></a><span id="l108.70">      */</span>
<a href="#l108.71"></a><span id="l108.71">     get type() { return this.method; },</span>
<a href="#l108.72"></a><span id="l108.72"> </span>
<a href="#l108.73"></a><span id="l108.73">     set type(val) {</span>
<a href="#l108.74"></a><span id="l108.74">         let valid = [this.GET, this.ADD, this.MODIFY, this.PATCH, this.DELETE];</span>
<a href="#l108.75"></a><span id="l108.75">         if (!valid.includes(val)) {</span>
<a href="#l108.76"></a><span id="l108.76">             throw new Components.Exception(&quot;Invalid request type: &quot; + val,</span>
<a href="#l108.77"></a><span id="l108.77" class="difflineminus">-                                            Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l108.78"></a><span id="l108.78" class="difflineplus">+                                            Cr.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l108.79"></a><span id="l108.79">         }</span>
<a href="#l108.80"></a><span id="l108.80">         return (this.method = val);</span>
<a href="#l108.81"></a><span id="l108.81">     },</span>
<a href="#l108.82"></a><span id="l108.82"> </span>
<a href="#l108.83"></a><span id="l108.83">     /**</span>
<a href="#l108.84"></a><span id="l108.84">      * setUploadData</span>
<a href="#l108.85"></a><span id="l108.85">      * The HTTP body data for a POST or PUT request.</span>
<a href="#l108.86"></a><span id="l108.86">      *</span>
<a href="#l108.87"></a><span id="l108.87" class="difflineat">@@ -194,29 +198,29 @@ calGoogleRequest.prototype = {</span>
<a href="#l108.88"></a><span id="l108.88">             let uri = Services.io.newURI(uristring);</span>
<a href="#l108.89"></a><span id="l108.89">             let channel;</span>
<a href="#l108.90"></a><span id="l108.90">             if (&quot;newChannelFromURI2&quot; in Services.io) {</span>
<a href="#l108.91"></a><span id="l108.91">                 // Lightning 4.3+</span>
<a href="#l108.92"></a><span id="l108.92">                 channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l108.93"></a><span id="l108.93">                                                          null,</span>
<a href="#l108.94"></a><span id="l108.94">                                                          Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l108.95"></a><span id="l108.95">                                                          null,</span>
<a href="#l108.96"></a><span id="l108.96" class="difflineminus">-                                                         Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l108.97"></a><span id="l108.97" class="difflineminus">-                                                         Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l108.98"></a><span id="l108.98" class="difflineplus">+                                                         Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l108.99"></a><span id="l108.99" class="difflineplus">+                                                         Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l108.100"></a><span id="l108.100">             } else {</span>
<a href="#l108.101"></a><span id="l108.101">                 // Lightning 4.2 and older</span>
<a href="#l108.102"></a><span id="l108.102">                 channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l108.103"></a><span id="l108.103">             }</span>
<a href="#l108.104"></a><span id="l108.104"> </span>
<a href="#l108.105"></a><span id="l108.105">             cal.LOG(&quot;[calGoogleRequest] Requesting &quot; + this.method + &quot; &quot; +</span>
<a href="#l108.106"></a><span id="l108.106">                     channel.URI.spec);</span>
<a href="#l108.107"></a><span id="l108.107"> </span>
<a href="#l108.108"></a><span id="l108.108">             this.prepareChannel(channel);</span>
<a href="#l108.109"></a><span id="l108.109"> </span>
<a href="#l108.110"></a><span id="l108.110" class="difflineminus">-            channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l108.111"></a><span id="l108.111" class="difflineplus">+            channel = channel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l108.112"></a><span id="l108.112">             channel.redirectionLimit = 3;</span>
<a href="#l108.113"></a><span id="l108.113"> </span>
<a href="#l108.114"></a><span id="l108.114">             this.mLoader = cal.provider.createStreamLoader();</span>
<a href="#l108.115"></a><span id="l108.115">             channel.notificationCallbacks = this;</span>
<a href="#l108.116"></a><span id="l108.116">             cal.provider.sendHttpRequest(this.mLoader, channel, this);</span>
<a href="#l108.117"></a><span id="l108.117">         } catch (e) {</span>
<a href="#l108.118"></a><span id="l108.118">             // Let the response function handle the error that happens here</span>
<a href="#l108.119"></a><span id="l108.119">             this.fail(e.result, e.message);</span>
<a href="#l108.120"></a><span id="l108.120" class="difflineat">@@ -243,46 +247,46 @@ calGoogleRequest.prototype = {</span>
<a href="#l108.121"></a><span id="l108.121">     /**</span>
<a href="#l108.122"></a><span id="l108.122">      * succeed</span>
<a href="#l108.123"></a><span id="l108.123">      * Call this request's listener with a Success Code and the given Result.</span>
<a href="#l108.124"></a><span id="l108.124">      *</span>
<a href="#l108.125"></a><span id="l108.125">      * @param aResult   The result Text of this request.</span>
<a href="#l108.126"></a><span id="l108.126">      */</span>
<a href="#l108.127"></a><span id="l108.127">     succeed: function(aResult) {</span>
<a href="#l108.128"></a><span id="l108.128">         this.mLoader = null;</span>
<a href="#l108.129"></a><span id="l108.129" class="difflineminus">-        this.mStatus = Components.results.NS_OK;</span>
<a href="#l108.130"></a><span id="l108.130" class="difflineplus">+        this.mStatus = Cr.NS_OK;</span>
<a href="#l108.131"></a><span id="l108.131">         this.mDeferred.resolve(aResult);</span>
<a href="#l108.132"></a><span id="l108.132">         this.mDeferred = null;</span>
<a href="#l108.133"></a><span id="l108.133">     },</span>
<a href="#l108.134"></a><span id="l108.134"> </span>
<a href="#l108.135"></a><span id="l108.135">     /**</span>
<a href="#l108.136"></a><span id="l108.136">      * prepareChannel</span>
<a href="#l108.137"></a><span id="l108.137">      * Prepares the passed channel to match this objects properties</span>
<a href="#l108.138"></a><span id="l108.138">      *</span>
<a href="#l108.139"></a><span id="l108.139">      * @param aChannel    The Channel to be prepared.</span>
<a href="#l108.140"></a><span id="l108.140">      */</span>
<a href="#l108.141"></a><span id="l108.141">     prepareChannel: function(aChannel) {</span>
<a href="#l108.142"></a><span id="l108.142">         // No caching</span>
<a href="#l108.143"></a><span id="l108.143" class="difflineminus">-        aChannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l108.144"></a><span id="l108.144" class="difflineplus">+        aChannel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l108.145"></a><span id="l108.145"> </span>
<a href="#l108.146"></a><span id="l108.146">         // Set upload Data</span>
<a href="#l108.147"></a><span id="l108.147">         if (this.mUploadData) {</span>
<a href="#l108.148"></a><span id="l108.148" class="difflineminus">-            let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l108.149"></a><span id="l108.149" class="difflineminus">-                                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l108.150"></a><span id="l108.150" class="difflineplus">+            let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l108.151"></a><span id="l108.151" class="difflineplus">+                              .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l108.152"></a><span id="l108.152">             converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l108.153"></a><span id="l108.153"> </span>
<a href="#l108.154"></a><span id="l108.154">             let stream = converter.convertToInputStream(this.mUploadData);</span>
<a href="#l108.155"></a><span id="l108.155" class="difflineminus">-            aChannel = aChannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l108.156"></a><span id="l108.156" class="difflineplus">+            aChannel = aChannel.QueryInterface(Ci.nsIUploadChannel);</span>
<a href="#l108.157"></a><span id="l108.157">             aChannel.setUploadStream(stream, this.mUploadContent, -1);</span>
<a href="#l108.158"></a><span id="l108.158"> </span>
<a href="#l108.159"></a><span id="l108.159">             cal.LOG(&quot;[calGoogleCalendar] Setting Upload Data (&quot; +</span>
<a href="#l108.160"></a><span id="l108.160">                     this.mUploadContent + &quot;):\n&quot; + this.mUploadData);</span>
<a href="#l108.161"></a><span id="l108.161">         }</span>
<a href="#l108.162"></a><span id="l108.162"> </span>
<a href="#l108.163"></a><span id="l108.163" class="difflineminus">-        aChannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l108.164"></a><span id="l108.164" class="difflineplus">+        aChannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l108.165"></a><span id="l108.165"> </span>
<a href="#l108.166"></a><span id="l108.166">         // Depending on the preference, we will use X-HTTP-Method-Override to</span>
<a href="#l108.167"></a><span id="l108.167">         // get around some proxies. This will default to true.</span>
<a href="#l108.168"></a><span id="l108.168">         if (Preferences.get(&quot;calendar.google.useHTTPMethodOverride&quot;, true) &amp;&amp;</span>
<a href="#l108.169"></a><span id="l108.169">             (this.method == &quot;PUT&quot; || this.method == &quot;DELETE&quot;)) {</span>
<a href="#l108.170"></a><span id="l108.170">             aChannel.requestMethod = &quot;POST&quot;;</span>
<a href="#l108.171"></a><span id="l108.171">             aChannel.setRequestHeader(&quot;X-HTTP-Method-Override&quot;,</span>
<a href="#l108.172"></a><span id="l108.172">                                       this.method,</span>
<a href="#l108.173"></a><span id="l108.173" class="difflineat">@@ -327,49 +331,49 @@ calGoogleRequest.prototype = {</span>
<a href="#l108.174"></a><span id="l108.174">     getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l108.175"></a><span id="l108.175"> </span>
<a href="#l108.176"></a><span id="l108.176">     /**</span>
<a href="#l108.177"></a><span id="l108.177">      * @see nsIChannelEventSink</span>
<a href="#l108.178"></a><span id="l108.178">      */</span>
<a href="#l108.179"></a><span id="l108.179">     asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l108.180"></a><span id="l108.180">         // all we need to do to the new channel is the basic preparation</span>
<a href="#l108.181"></a><span id="l108.181">         this.prepareChannel(aNewChannel);</span>
<a href="#l108.182"></a><span id="l108.182" class="difflineminus">-        aCallback.onRedirectVerifyCallback(Components.results.NS_OK);</span>
<a href="#l108.183"></a><span id="l108.183" class="difflineplus">+        aCallback.onRedirectVerifyCallback(Cr.NS_OK);</span>
<a href="#l108.184"></a><span id="l108.184">     },</span>
<a href="#l108.185"></a><span id="l108.185"> </span>
<a href="#l108.186"></a><span id="l108.186">     /**</span>
<a href="#l108.187"></a><span id="l108.187">      * @see nsIStreamLoaderObserver</span>
<a href="#l108.188"></a><span id="l108.188">      */</span>
<a href="#l108.189"></a><span id="l108.189">     onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l108.190"></a><span id="l108.190">         if (!aResult || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l108.191"></a><span id="l108.191">             this.fail(aStatus, aResult);</span>
<a href="#l108.192"></a><span id="l108.192">             return;</span>
<a href="#l108.193"></a><span id="l108.193">         }</span>
<a href="#l108.194"></a><span id="l108.194"> </span>
<a href="#l108.195"></a><span id="l108.195" class="difflineminus">-        let httpChannel = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l108.196"></a><span id="l108.196" class="difflineplus">+        let httpChannel = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l108.197"></a><span id="l108.197"> </span>
<a href="#l108.198"></a><span id="l108.198">         // Convert the stream, falling back to utf-8 in case its not given.</span>
<a href="#l108.199"></a><span id="l108.199">         let result = new TextDecoder(httpChannel.contentCharset || &quot;utf-8&quot;).decode(Uint8Array.from(aResult));</span>
<a href="#l108.200"></a><span id="l108.200">         if (result === null) {</span>
<a href="#l108.201"></a><span id="l108.201" class="difflineminus">-            this.fail(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l108.202"></a><span id="l108.202" class="difflineplus">+            this.fail(Cr.NS_ERROR_FAILURE,</span>
<a href="#l108.203"></a><span id="l108.203">                       &quot;Could not convert bytestream to Unicode: &quot; + e);</span>
<a href="#l108.204"></a><span id="l108.204">             return;</span>
<a href="#l108.205"></a><span id="l108.205">         }</span>
<a href="#l108.206"></a><span id="l108.206"> </span>
<a href="#l108.207"></a><span id="l108.207">         let objData;</span>
<a href="#l108.208"></a><span id="l108.208">         try {</span>
<a href="#l108.209"></a><span id="l108.209">             if (result.length) {</span>
<a href="#l108.210"></a><span id="l108.210">                 objData = JSON.parse(result);</span>
<a href="#l108.211"></a><span id="l108.211">             } else {</span>
<a href="#l108.212"></a><span id="l108.212">                 objData = { status: &quot;No Content&quot; };</span>
<a href="#l108.213"></a><span id="l108.213">             }</span>
<a href="#l108.214"></a><span id="l108.214">         } catch (e) {</span>
<a href="#l108.215"></a><span id="l108.215">             cal.ERROR(&quot;[calGoogleCalendar] Could not parse API response as &quot; +</span>
<a href="#l108.216"></a><span id="l108.216">                       &quot;JSON: &quot; + result);</span>
<a href="#l108.217"></a><span id="l108.217" class="difflineminus">-            this.fail(Components.results.NS_ERROR_FAILURE, result);</span>
<a href="#l108.218"></a><span id="l108.218" class="difflineplus">+            this.fail(Cr.NS_ERROR_FAILURE, result);</span>
<a href="#l108.219"></a><span id="l108.219">         }</span>
<a href="#l108.220"></a><span id="l108.220"> </span>
<a href="#l108.221"></a><span id="l108.221">         // Calculate Google Clock Skew</span>
<a href="#l108.222"></a><span id="l108.222">         let serverDate = new Date(httpChannel.getResponseHeader(&quot;Date&quot;));</span>
<a href="#l108.223"></a><span id="l108.223">         let curDate = new Date();</span>
<a href="#l108.224"></a><span id="l108.224"> </span>
<a href="#l108.225"></a><span id="l108.225">         // The utility function getCorrectedDate in calGoogleUtils.js receives</span>
<a href="#l108.226"></a><span id="l108.226">         // its clock skew seconds from here. The clock skew is updated on each</span>
<a href="#l108.227"></a><span id="l108.227" class="difflineat">@@ -448,36 +452,36 @@ calGoogleRequest.prototype = {</span>
<a href="#l108.228"></a><span id="l108.228">                         if (this.calendar) {</span>
<a href="#l108.229"></a><span id="l108.229">                             this.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l108.230"></a><span id="l108.230">                             this.calendar.setProperty(&quot;currentStatus&quot;, calGoogleRequest.QUOTA_FAILURE);</span>
<a href="#l108.231"></a><span id="l108.231">                         }</span>
<a href="#l108.232"></a><span id="l108.232">                         this.fail(calGoogleRequest.QUOTA_FAILURE, reason);</span>
<a href="#l108.233"></a><span id="l108.233">                         break;</span>
<a href="#l108.234"></a><span id="l108.234">                     case &quot;insufficientPermissions&quot;:</span>
<a href="#l108.235"></a><span id="l108.235">                         if (this.type == this.MODIFY || this.type == this.DELETE || this.type == this.ADD) {</span>
<a href="#l108.236"></a><span id="l108.236" class="difflineminus">-                            this.fail(cIE.MODIFICATION_FAILED, objData);</span>
<a href="#l108.237"></a><span id="l108.237" class="difflineplus">+                            this.fail(Ci.calIErrors.MODIFICATION_FAILED, objData);</span>
<a href="#l108.238"></a><span id="l108.238">                         } else {</span>
<a href="#l108.239"></a><span id="l108.239" class="difflineminus">-                            this.fail(cIE.READ_FAILED, objData);</span>
<a href="#l108.240"></a><span id="l108.240" class="difflineplus">+                            this.fail(Ci.calIErrors.READ_FAILED, objData);</span>
<a href="#l108.241"></a><span id="l108.241">                         }</span>
<a href="#l108.242"></a><span id="l108.242">                         break;</span>
<a href="#l108.243"></a><span id="l108.243">                     case &quot;authError&quot;:</span>
<a href="#l108.244"></a><span id="l108.244">                     case &quot;invalidCredentials&quot;:</span>
<a href="#l108.245"></a><span id="l108.245">                         this.mSession.invalidate();</span>
<a href="#l108.246"></a><span id="l108.246">                         if (this.reauthenticate) {</span>
<a href="#l108.247"></a><span id="l108.247">                             this.reauthenticate = false;</span>
<a href="#l108.248"></a><span id="l108.248">                             this.mSession.asyncItemRequest(this);</span>
<a href="#l108.249"></a><span id="l108.249">                         } else {</span>
<a href="#l108.250"></a><span id="l108.250">                             this.fail(calGoogleRequest.LOGIN_FAILED, reason);</span>
<a href="#l108.251"></a><span id="l108.251">                         }</span>
<a href="#l108.252"></a><span id="l108.252">                         break;</span>
<a href="#l108.253"></a><span id="l108.253">                     default:</span>
<a href="#l108.254"></a><span id="l108.254">                         if (this.calendar) {</span>
<a href="#l108.255"></a><span id="l108.255" class="difflineminus">-                            this.calendar.setProperty(&quot;currentStatus&quot;, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l108.256"></a><span id="l108.256" class="difflineplus">+                            this.calendar.setProperty(&quot;currentStatus&quot;, Cr.NS_ERROR_FAILURE);</span>
<a href="#l108.257"></a><span id="l108.257">                         }</span>
<a href="#l108.258"></a><span id="l108.258" class="difflineminus">-                        this.fail(Components.results.NS_ERROR_FAILURE, result);</span>
<a href="#l108.259"></a><span id="l108.259" class="difflineplus">+                        this.fail(Cr.NS_ERROR_FAILURE, result);</span>
<a href="#l108.260"></a><span id="l108.260">                         break;</span>
<a href="#l108.261"></a><span id="l108.261">                 }</span>
<a href="#l108.262"></a><span id="l108.262"> </span>
<a href="#l108.263"></a><span id="l108.263">                 break;</span>
<a href="#l108.264"></a><span id="l108.264">             }</span>
<a href="#l108.265"></a><span id="l108.265">             case 404: /* The resource was not found on the server, which is</span>
<a href="#l108.266"></a><span id="l108.266">                          also a conflict */</span>
<a href="#l108.267"></a><span id="l108.267">                 //  404 NOT FOUND: Resource (such as a feed or entry) not found.</span>
<a href="#l108.268"></a><span id="l108.268" class="difflineat">@@ -513,14 +517,14 @@ calGoogleRequest.prototype = {</span>
<a href="#l108.269"></a><span id="l108.269"> </span>
<a href="#l108.270"></a><span id="l108.270">                 // Something else went wrong</span>
<a href="#l108.271"></a><span id="l108.271">                 let msg = &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l108.272"></a><span id="l108.272">                           httpChannel.responseStatus + &quot; &quot; +</span>
<a href="#l108.273"></a><span id="l108.273">                           httpChannel.responseStatusText + &quot; Body: &quot; +</span>
<a href="#l108.274"></a><span id="l108.274">                           result;</span>
<a href="#l108.275"></a><span id="l108.275">                 cal.LOG(&quot;[calGoogleCalendar] &quot; + msg);</span>
<a href="#l108.276"></a><span id="l108.276"> </span>
<a href="#l108.277"></a><span id="l108.277" class="difflineminus">-                this.fail(Components.results.NS_ERROR_NOT_AVAILABLE, msg);</span>
<a href="#l108.278"></a><span id="l108.278" class="difflineplus">+                this.fail(Cr.NS_ERROR_NOT_AVAILABLE, msg);</span>
<a href="#l108.279"></a><span id="l108.279">                 break;</span>
<a href="#l108.280"></a><span id="l108.280">             }</span>
<a href="#l108.281"></a><span id="l108.281">         }</span>
<a href="#l108.282"></a><span id="l108.282">     }</span>
<a href="#l108.283"></a><span id="l108.283"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineat">@@ -1,12 +1,18 @@</span>
<a href="#l109.4"></a><span id="l109.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l109.5"></a><span id="l109.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l109.6"></a><span id="l109.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l109.7"></a><span id="l109.7"> </span>
<a href="#l109.8"></a><span id="l109.8" class="difflineplus">+// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l109.9"></a><span id="l109.9" class="difflineplus">+if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l109.10"></a><span id="l109.10" class="difflineplus">+    // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l109.11"></a><span id="l109.11" class="difflineplus">+    const { classes: Cc, interfaces: Ci, results: Cr } = Components;</span>
<a href="#l109.12"></a><span id="l109.12" class="difflineplus">+}</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineplus">+</span>
<a href="#l109.14"></a><span id="l109.14"> ChromeUtils.import(&quot;resource://gdata-provider/modules/OAuth2.jsm&quot;);</span>
<a href="#l109.15"></a><span id="l109.15"> const { getProviderString } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;, null);</span>
<a href="#l109.16"></a><span id="l109.16"> const { LOGinterval } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;, null);</span>
<a href="#l109.17"></a><span id="l109.17"> const {</span>
<a href="#l109.18"></a><span id="l109.18">     calGoogleRequest,</span>
<a href="#l109.19"></a><span id="l109.19">     API_BASE</span>
<a href="#l109.20"></a><span id="l109.20"> } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;, null);</span>
<a href="#l109.21"></a><span id="l109.21"> </span>
<a href="#l109.22"></a><span id="l109.22" class="difflineat">@@ -14,18 +20,18 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l109.23"></a><span id="l109.23"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l109.24"></a><span id="l109.24"> ChromeUtils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l109.25"></a><span id="l109.25"> const { setTimeout } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;, null);</span>
<a href="#l109.26"></a><span id="l109.26"> </span>
<a href="#l109.27"></a><span id="l109.27"> const { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l109.28"></a><span id="l109.28"> </span>
<a href="#l109.29"></a><span id="l109.29"> const { cal } = ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;, null);</span>
<a href="#l109.30"></a><span id="l109.30"> </span>
<a href="#l109.31"></a><span id="l109.31" class="difflineminus">-var cIFBI = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l109.32"></a><span id="l109.32" class="difflineminus">-var nIPM = Components.interfaces.nsIPermissionManager;</span>
<a href="#l109.33"></a><span id="l109.33" class="difflineplus">+var cIFBI = Ci.calIFreeBusyInterval;</span>
<a href="#l109.34"></a><span id="l109.34" class="difflineplus">+var nIPM = Ci.nsIPermissionManager;</span>
<a href="#l109.35"></a><span id="l109.35"> </span>
<a href="#l109.36"></a><span id="l109.36"> var NOTIFY_TIMEOUT = 60 * 1000;</span>
<a href="#l109.37"></a><span id="l109.37"> </span>
<a href="#l109.38"></a><span id="l109.38"> var EXPORTED_SYMBOLS = [&quot;getGoogleSessionManager&quot;];</span>
<a href="#l109.39"></a><span id="l109.39"> </span>
<a href="#l109.40"></a><span id="l109.40"> var gdataSessionMap = new Map();</span>
<a href="#l109.41"></a><span id="l109.41"> var calGoogleSessionManager = {</span>
<a href="#l109.42"></a><span id="l109.42">     /**</span>
<a href="#l109.43"></a><span id="l109.43" class="difflineat">@@ -155,17 +161,17 @@ calGoogleSession.prototype = {</span>
<a href="#l109.44"></a><span id="l109.44">             get: function() {</span>
<a href="#l109.45"></a><span id="l109.45">                 if (!this.mRefreshToken) {</span>
<a href="#l109.46"></a><span id="l109.46">                     let pass = { value: null };</span>
<a href="#l109.47"></a><span id="l109.47">                     try {</span>
<a href="#l109.48"></a><span id="l109.48">                         let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l109.49"></a><span id="l109.49">                         cal.auth.passwordManagerGet(sessionId, pass, origin, pwMgrId);</span>
<a href="#l109.50"></a><span id="l109.50">                     } catch (e) {</span>
<a href="#l109.51"></a><span id="l109.51">                         // User might have cancelled the master password prompt, thats ok</span>
<a href="#l109.52"></a><span id="l109.52" class="difflineminus">-                        if (e.result != Components.results.NS_ERROR_ABORT) {</span>
<a href="#l109.53"></a><span id="l109.53" class="difflineplus">+                        if (e.result != Cr.NS_ERROR_ABORT) {</span>
<a href="#l109.54"></a><span id="l109.54">                             throw e;</span>
<a href="#l109.55"></a><span id="l109.55">                         }</span>
<a href="#l109.56"></a><span id="l109.56">                     }</span>
<a href="#l109.57"></a><span id="l109.57">                     this.mRefreshToken = pass.value;</span>
<a href="#l109.58"></a><span id="l109.58">                 }</span>
<a href="#l109.59"></a><span id="l109.59">                 return this.mRefreshToken;</span>
<a href="#l109.60"></a><span id="l109.60">             },</span>
<a href="#l109.61"></a><span id="l109.61">             set: function(val) {</span>
<a href="#l109.62"></a><span id="l109.62" class="difflineat">@@ -174,32 +180,32 @@ calGoogleSession.prototype = {</span>
<a href="#l109.63"></a><span id="l109.63">                     if (val) {</span>
<a href="#l109.64"></a><span id="l109.64">                         cal.auth.passwordManagerSave(sessionId, val, origin, pwMgrId);</span>
<a href="#l109.65"></a><span id="l109.65">                     } else {</span>
<a href="#l109.66"></a><span id="l109.66">                         cal.auth.passwordManagerRemove(sessionId, origin, pwMgrId);</span>
<a href="#l109.67"></a><span id="l109.67">                     }</span>
<a href="#l109.68"></a><span id="l109.68">                 } catch (e) {</span>
<a href="#l109.69"></a><span id="l109.69">                     // User might have cancelled the master password prompt, or password saving</span>
<a href="#l109.70"></a><span id="l109.70">                     // could be disabled. That is ok, throw for everything else.</span>
<a href="#l109.71"></a><span id="l109.71" class="difflineminus">-                    if (e.result != Components.results.NS_ERROR_ABORT &amp;&amp;</span>
<a href="#l109.72"></a><span id="l109.72" class="difflineminus">-                        e.result != Components.results.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l109.73"></a><span id="l109.73" class="difflineplus">+                    if (e.result != Cr.NS_ERROR_ABORT &amp;&amp;</span>
<a href="#l109.74"></a><span id="l109.74" class="difflineplus">+                        e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l109.75"></a><span id="l109.75">                         throw e;</span>
<a href="#l109.76"></a><span id="l109.76">                     }</span>
<a href="#l109.77"></a><span id="l109.77">                 }</span>
<a href="#l109.78"></a><span id="l109.78">                 return (this.mRefreshToken = val);</span>
<a href="#l109.79"></a><span id="l109.79">             },</span>
<a href="#l109.80"></a><span id="l109.80">             enumerable: true</span>
<a href="#l109.81"></a><span id="l109.81">         });</span>
<a href="#l109.82"></a><span id="l109.82"> </span>
<a href="#l109.83"></a><span id="l109.83">         // If the user has disabled cookies, we need to add an exception for</span>
<a href="#l109.84"></a><span id="l109.84">         // Google so authentication works. If the user has explicitly blocked</span>
<a href="#l109.85"></a><span id="l109.85">         // google.com then we won't overwrite the rule though.</span>
<a href="#l109.86"></a><span id="l109.86">         if (Preferences.get(&quot;network.cookie.cookieBehavior&quot;) == 2) {</span>
<a href="#l109.87"></a><span id="l109.87">             let found = null;</span>
<a href="#l109.88"></a><span id="l109.88" class="difflineminus">-            for (let perm of fixIterator(Services.perms.enumerator, Components.interfaces.nsIPermission)) {</span>
<a href="#l109.89"></a><span id="l109.89" class="difflineplus">+            for (let perm of fixIterator(Services.perms.enumerator, Ci.nsIPermission)) {</span>
<a href="#l109.90"></a><span id="l109.90">                 if (perm.type == &quot;cookie&quot; &amp;&amp; perm.host == &quot;google.com&quot;) {</span>
<a href="#l109.91"></a><span id="l109.91">                     found = perm;</span>
<a href="#l109.92"></a><span id="l109.92">                     break;</span>
<a href="#l109.93"></a><span id="l109.93">                 }</span>
<a href="#l109.94"></a><span id="l109.94">             }</span>
<a href="#l109.95"></a><span id="l109.95"> </span>
<a href="#l109.96"></a><span id="l109.96">             if (!found || found.capability != nIPM.DENY_ACTION) {</span>
<a href="#l109.97"></a><span id="l109.97">                 let uri = Services.io.newURI(&quot;http://google.com&quot;);</span>
<a href="#l109.98"></a><span id="l109.98" class="difflineat">@@ -295,18 +301,18 @@ calGoogleSession.prototype = {</span>
<a href="#l109.99"></a><span id="l109.99">                             if (callback) {</span>
<a href="#l109.100"></a><span id="l109.100">                                 callback.onAuthResult(false);</span>
<a href="#l109.101"></a><span id="l109.101">                             }</span>
<a href="#l109.102"></a><span id="l109.102">                         }, true);</span>
<a href="#l109.103"></a><span id="l109.103">                     },</span>
<a href="#l109.104"></a><span id="l109.104">                     onPromptCanceled: authFailed,</span>
<a href="#l109.105"></a><span id="l109.105">                     onPromptStart: function() {}</span>
<a href="#l109.106"></a><span id="l109.106">                 };</span>
<a href="#l109.107"></a><span id="l109.107" class="difflineminus">-                let asyncprompter = Components.classes[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l109.108"></a><span id="l109.108" class="difflineminus">-                                              .getService(Components.interfaces.nsIMsgAsyncPrompter);</span>
<a href="#l109.109"></a><span id="l109.109" class="difflineplus">+                let asyncprompter = Cc[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l109.110"></a><span id="l109.110" class="difflineplus">+                                      .getService(Ci.nsIMsgAsyncPrompter);</span>
<a href="#l109.111"></a><span id="l109.111">                 asyncprompter.queueAsyncAuthPrompt(&quot;googleapi://&quot; + this.id, false, promptlistener);</span>
<a href="#l109.112"></a><span id="l109.112">             }.bind(this);</span>
<a href="#l109.113"></a><span id="l109.113"> </span>
<a href="#l109.114"></a><span id="l109.114">             if (accessToken) {</span>
<a href="#l109.115"></a><span id="l109.115">                 deferred.resolve(accessToken);</span>
<a href="#l109.116"></a><span id="l109.116">             } else {</span>
<a href="#l109.117"></a><span id="l109.117">                 cal.LOG(&quot;[calGoogleCalendar] No access token for &quot; + this.mId +</span>
<a href="#l109.118"></a><span id="l109.118">                         &quot;, refreshing token&quot;);</span>
<a href="#l109.119"></a><span id="l109.119" class="difflineat">@@ -368,18 +374,17 @@ calGoogleSession.prototype = {</span>
<a href="#l109.120"></a><span id="l109.120">             return this.mLoginPromise.then(() =&gt; {</span>
<a href="#l109.121"></a><span id="l109.121">                 return aRequest.commit(this);</span>
<a href="#l109.122"></a><span id="l109.122">             }, (e) =&gt; {</span>
<a href="#l109.123"></a><span id="l109.123">                 // If the user cancelled the login dialog, then disable the</span>
<a href="#l109.124"></a><span id="l109.124">                 // calendar until the next startup or manual enable.</span>
<a href="#l109.125"></a><span id="l109.125">                 if (aRequest.calendar &amp;&amp; e.message == &quot;cancelled&quot;) {</span>
<a href="#l109.126"></a><span id="l109.126">                     aRequest.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l109.127"></a><span id="l109.127">                     aRequest.calendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l109.128"></a><span id="l109.128" class="difflineminus">-                    aRequest.calendar.setProperty(&quot;currentStatus&quot;,</span>
<a href="#l109.129"></a><span id="l109.129" class="difflineminus">-                                    Components.results.NS_ERROR_FAILURE);</span>
<a href="#l109.130"></a><span id="l109.130" class="difflineplus">+                    aRequest.calendar.setProperty(&quot;currentStatus&quot;, Cr.NS_ERROR_FAILURE);</span>
<a href="#l109.131"></a><span id="l109.131">                 }</span>
<a href="#l109.132"></a><span id="l109.132"> </span>
<a href="#l109.133"></a><span id="l109.133">                 throw e;</span>
<a href="#l109.134"></a><span id="l109.134">             });</span>
<a href="#l109.135"></a><span id="l109.135">         } else {</span>
<a href="#l109.136"></a><span id="l109.136">             // Not logging in and no token, get the login promise and retry.</span>
<a href="#l109.137"></a><span id="l109.137">             this.mLoginPromise = this.login();</span>
<a href="#l109.138"></a><span id="l109.138">             return this.asyncItemRequest(aRequest);</span>
<a href="#l109.139"></a><span id="l109.139" class="difflineat">@@ -412,32 +417,32 @@ calGoogleSession.prototype = {</span>
<a href="#l109.140"></a><span id="l109.140"> </span>
<a href="#l109.141"></a><span id="l109.141">     /**</span>
<a href="#l109.142"></a><span id="l109.142">      * calIFreeBusyProvider Implementation</span>
<a href="#l109.143"></a><span id="l109.143">      */</span>
<a href="#l109.144"></a><span id="l109.144">     getFreeBusyIntervals: function(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l109.145"></a><span id="l109.145">         let completeSync = (aIntervals) =&gt; {</span>
<a href="#l109.146"></a><span id="l109.146">             cal.LOG(&quot;[calGoogleCalendar] Freebusy query for &quot; + aCalId +</span>
<a href="#l109.147"></a><span id="l109.147">                     &quot;suceeded, returning &quot; + aIntervals.length + &quot; intervals&quot;);</span>
<a href="#l109.148"></a><span id="l109.148" class="difflineminus">-            aListener.onResult({ status: Components.results.NS_OK }, aIntervals);</span>
<a href="#l109.149"></a><span id="l109.149" class="difflineplus">+            aListener.onResult({ status: Cr.NS_OK }, aIntervals);</span>
<a href="#l109.150"></a><span id="l109.150">         };</span>
<a href="#l109.151"></a><span id="l109.151"> </span>
<a href="#l109.152"></a><span id="l109.152">         let failSync = (aStatus, aMessage) =&gt; {</span>
<a href="#l109.153"></a><span id="l109.153">             cal.LOG(&quot;[calGoogleCalendar] Freebusy query for &quot; + aCalId +</span>
<a href="#l109.154"></a><span id="l109.154">                     &quot; failed (&quot; + aStatus + &quot;): &quot; + aMessage);</span>
<a href="#l109.155"></a><span id="l109.155"> </span>
<a href="#l109.156"></a><span id="l109.156">             // Usually we would notify with a result, but this causes trouble</span>
<a href="#l109.157"></a><span id="l109.157">             // with Lightning 3.9 and older.</span>
<a href="#l109.158"></a><span id="l109.158">             aListener.onResult({ status: aStatus }, null);</span>
<a href="#l109.159"></a><span id="l109.159">         };</span>
<a href="#l109.160"></a><span id="l109.160"> </span>
<a href="#l109.161"></a><span id="l109.161">         if (!aCalId.includes(&quot;@&quot;) || !aCalId.includes(&quot;.&quot;) ||</span>
<a href="#l109.162"></a><span id="l109.162">             !aCalId.toLowerCase().startsWith(&quot;mailto:&quot;)) {</span>
<a href="#l109.163"></a><span id="l109.163">             // No valid email, screw it</span>
<a href="#l109.164"></a><span id="l109.164" class="difflineminus">-            return failSync(Components.results.NS_ERROR_FAILURE, null);</span>
<a href="#l109.165"></a><span id="l109.165" class="difflineplus">+            return failSync(Cr.NS_ERROR_FAILURE, null);</span>
<a href="#l109.166"></a><span id="l109.166">         }</span>
<a href="#l109.167"></a><span id="l109.167"> </span>
<a href="#l109.168"></a><span id="l109.168">         if (aRangeStart) {</span>
<a href="#l109.169"></a><span id="l109.169">             aRangeStart = aRangeStart.getInTimezone(cal.dtz.UTC);</span>
<a href="#l109.170"></a><span id="l109.170">         }</span>
<a href="#l109.171"></a><span id="l109.171">         if (aRangeEnd) {</span>
<a href="#l109.172"></a><span id="l109.172">             aRangeEnd = aRangeEnd.getInTimezone(cal.dtz.UTC);</span>
<a href="#l109.173"></a><span id="l109.173">         }</span>
<a href="#l109.174"></a><span id="l109.174" class="difflineat">@@ -463,32 +468,32 @@ calGoogleSession.prototype = {</span>
<a href="#l109.175"></a><span id="l109.175"> </span>
<a href="#l109.176"></a><span id="l109.176">         // Request Parameters</span>
<a href="#l109.177"></a><span id="l109.177">         this.asyncItemRequest(request).then((aData) =&gt; {</span>
<a href="#l109.178"></a><span id="l109.178">             if (&quot;calendars&quot; in aData &amp;&amp; strippedCalId in aData.calendars) {</span>
<a href="#l109.179"></a><span id="l109.179">                 let calData = aData.calendars[strippedCalId];</span>
<a href="#l109.180"></a><span id="l109.180">                 let reason = calData.errors &amp;&amp; calData.errors[0] &amp;&amp; calData.errors[0].reason;</span>
<a href="#l109.181"></a><span id="l109.181">                 if (reason) {</span>
<a href="#l109.182"></a><span id="l109.182">                     cal.LOG(&quot;[calGoogleCalendar] Could not request freebusy for &quot; + strippedCalId + &quot;: &quot; + reason);</span>
<a href="#l109.183"></a><span id="l109.183" class="difflineminus">-                    failSync(Components.results.NS_ERROR_FAILURE, reason);</span>
<a href="#l109.184"></a><span id="l109.184" class="difflineplus">+                    failSync(Cr.NS_ERROR_FAILURE, reason);</span>
<a href="#l109.185"></a><span id="l109.185">                 } else {</span>
<a href="#l109.186"></a><span id="l109.186">                     let utcZone = cal.dtz.UTC;</span>
<a href="#l109.187"></a><span id="l109.187">                     cal.LOG(&quot;[calGoogleCalendar] Found &quot; + calData.busy.length + &quot; busy slots within range for &quot; + strippedCalId);</span>
<a href="#l109.188"></a><span id="l109.188">                     let busyRanges = calData.busy.map((entry) =&gt; {</span>
<a href="#l109.189"></a><span id="l109.189">                         let start = cal.dtz.fromRFC3339(entry.start, utcZone);</span>
<a href="#l109.190"></a><span id="l109.190">                         let end = cal.dtz.fromRFC3339(entry.end, utcZone);</span>
<a href="#l109.191"></a><span id="l109.191">                         let interval = new cal.provider.FreeBusyInterval(aCalId, cIFBI.BUSY, start, end);</span>
<a href="#l109.192"></a><span id="l109.192">                         LOGinterval(interval);</span>
<a href="#l109.193"></a><span id="l109.193">                         return interval;</span>
<a href="#l109.194"></a><span id="l109.194">                     });</span>
<a href="#l109.195"></a><span id="l109.195">                     completeSync(busyRanges);</span>
<a href="#l109.196"></a><span id="l109.196">                 }</span>
<a href="#l109.197"></a><span id="l109.197">             } else {</span>
<a href="#l109.198"></a><span id="l109.198">                 cal.ERROR(&quot;[calGoogleCalendar] Invalid freebusy response: &quot; + aData.toSource());</span>
<a href="#l109.199"></a><span id="l109.199" class="difflineminus">-                failSync(Components.results.NS_ERROR_FAILURE, (aData &amp;&amp; aData.toSource()));</span>
<a href="#l109.200"></a><span id="l109.200" class="difflineplus">+                failSync(Cr.NS_ERROR_FAILURE, (aData &amp;&amp; aData.toSource()));</span>
<a href="#l109.201"></a><span id="l109.201">             }</span>
<a href="#l109.202"></a><span id="l109.202">         }, (e) =&gt; {</span>
<a href="#l109.203"></a><span id="l109.203">             cal.ERROR(&quot;[calGoogleCalendar] Failed freebusy request: &quot; + e);</span>
<a href="#l109.204"></a><span id="l109.204">             return failSync(request.status, null);</span>
<a href="#l109.205"></a><span id="l109.205">         });</span>
<a href="#l109.206"></a><span id="l109.206"> </span>
<a href="#l109.207"></a><span id="l109.207">         return request;</span>
<a href="#l109.208"></a><span id="l109.208">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineat">@@ -1,28 +1,32 @@</span>
<a href="#l110.4"></a><span id="l110.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l110.5"></a><span id="l110.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l110.6"></a><span id="l110.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l110.7"></a><span id="l110.7"> </span>
<a href="#l110.8"></a><span id="l110.8" class="difflineplus">+// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l110.9"></a><span id="l110.9" class="difflineplus">+if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l110.10"></a><span id="l110.10" class="difflineplus">+    // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l110.11"></a><span id="l110.11" class="difflineplus">+    const { classes: Cc, interfaces: Ci, results: Cr, utils: Cu } = Components;</span>
<a href="#l110.12"></a><span id="l110.12" class="difflineplus">+}</span>
<a href="#l110.13"></a><span id="l110.13" class="difflineplus">+</span>
<a href="#l110.14"></a><span id="l110.14"> const {</span>
<a href="#l110.15"></a><span id="l110.15">     LOGitem,</span>
<a href="#l110.16"></a><span id="l110.16">     LOGverbose,</span>
<a href="#l110.17"></a><span id="l110.17">     stringException</span>
<a href="#l110.18"></a><span id="l110.18"> } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;, null);</span>
<a href="#l110.19"></a><span id="l110.19"> const { calGoogleRequest } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;, null);</span>
<a href="#l110.20"></a><span id="l110.20"> const { windowsTimezoneMap } = ChromeUtils.import(&quot;resource://gdata-provider/modules/timezoneMap.jsm&quot;, null);</span>
<a href="#l110.21"></a><span id="l110.21"> </span>
<a href="#l110.22"></a><span id="l110.22"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l110.23"></a><span id="l110.23"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l110.24"></a><span id="l110.24"> ChromeUtils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l110.25"></a><span id="l110.25"> </span>
<a href="#l110.26"></a><span id="l110.26"> const { cal } = ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;, null);</span>
<a href="#l110.27"></a><span id="l110.27"> </span>
<a href="#l110.28"></a><span id="l110.28" class="difflineminus">-var cIE = Components.interfaces.calIErrors;</span>
<a href="#l110.29"></a><span id="l110.29" class="difflineminus">-</span>
<a href="#l110.30"></a><span id="l110.30"> var FOUR_WEEKS_IN_MINUTES = 40320;</span>
<a href="#l110.31"></a><span id="l110.31"> </span>
<a href="#l110.32"></a><span id="l110.32"> var EXPORTED_SYMBOLS = [</span>
<a href="#l110.33"></a><span id="l110.33">     &quot;ItemToJSON&quot;, &quot;JSONToItem&quot;, &quot;ItemSaver&quot;,</span>
<a href="#l110.34"></a><span id="l110.34">     &quot;checkResolveConflict&quot;, &quot;getGoogleId&quot;,</span>
<a href="#l110.35"></a><span id="l110.35">     &quot;getItemMetadata&quot;, &quot;saveItemMetadata&quot;,</span>
<a href="#l110.36"></a><span id="l110.36">     &quot;deleteItemMetadata&quot;, &quot;migrateItemMetadata&quot;,</span>
<a href="#l110.37"></a><span id="l110.37">     &quot;JSONToAlarm&quot;, &quot;dateToJSON&quot;, &quot;JSONToDate&quot;,</span>
<a href="#l110.38"></a><span id="l110.38" class="difflineat">@@ -324,17 +328,17 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l110.39"></a><span id="l110.39"> </span>
<a href="#l110.40"></a><span id="l110.40">     // eventStatus</span>
<a href="#l110.41"></a><span id="l110.41">     let status = aItem.status &amp;&amp; aItem.status.toLowerCase();</span>
<a href="#l110.42"></a><span id="l110.42">     if (status == &quot;cancelled&quot;) {</span>
<a href="#l110.43"></a><span id="l110.43">         // If the status is canceled, then the event will be deleted. Since the</span>
<a href="#l110.44"></a><span id="l110.44">         // user didn't choose to delete the event, we will protect him and not</span>
<a href="#l110.45"></a><span id="l110.45">         // allow this status to be set</span>
<a href="#l110.46"></a><span id="l110.46">         throw new Components.Exception(&quot;The status CANCELLED is reserved, delete the event instead!&quot;,</span>
<a href="#l110.47"></a><span id="l110.47" class="difflineminus">-                                       Components.results.NS_ERROR_LOSS_OF_SIGNIFICANT_DATA);</span>
<a href="#l110.48"></a><span id="l110.48" class="difflineplus">+                                       Cr.NS_ERROR_LOSS_OF_SIGNIFICANT_DATA);</span>
<a href="#l110.49"></a><span id="l110.49">     } else if (status == &quot;none&quot;) {</span>
<a href="#l110.50"></a><span id="l110.50">         status = null;</span>
<a href="#l110.51"></a><span id="l110.51">     }</span>
<a href="#l110.52"></a><span id="l110.52">     setIf(itemData, &quot;status&quot;, status);</span>
<a href="#l110.53"></a><span id="l110.53"> </span>
<a href="#l110.54"></a><span id="l110.54">     // Google does not support categories natively, but allows us to store data</span>
<a href="#l110.55"></a><span id="l110.55">     // as an &quot;extendedProperty&quot;, so we do here</span>
<a href="#l110.56"></a><span id="l110.56">     let categories = cal.category.arrayToString(aItem.getCategories({}));</span>
<a href="#l110.57"></a><span id="l110.57" class="difflineat">@@ -471,17 +475,17 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l110.58"></a><span id="l110.58">     addExtendedProperty(&quot;X-GOOGLE-SNOOZE-RECUR&quot;, snoozeValue, true);</span>
<a href="#l110.59"></a><span id="l110.59"> </span>
<a href="#l110.60"></a><span id="l110.60">     // recurrence information</span>
<a href="#l110.61"></a><span id="l110.61">     if (aItem.recurrenceInfo) {</span>
<a href="#l110.62"></a><span id="l110.62">         itemData.recurrence = [];</span>
<a href="#l110.63"></a><span id="l110.63">         let recurrenceItems = aItem.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l110.64"></a><span id="l110.64">         for (let ritem of recurrenceItems) {</span>
<a href="#l110.65"></a><span id="l110.65">             let prop = ritem.icalProperty;</span>
<a href="#l110.66"></a><span id="l110.66" class="difflineminus">-            if (ritem instanceof Components.interfaces.calIRecurrenceDate) {</span>
<a href="#l110.67"></a><span id="l110.67" class="difflineplus">+            if (ritem instanceof Ci.calIRecurrenceDate) {</span>
<a href="#l110.68"></a><span id="l110.68">                 // EXDATES require special casing, since they might contain</span>
<a href="#l110.69"></a><span id="l110.69">                 // a TZID. To avoid the need for conversion of TZID strings,</span>
<a href="#l110.70"></a><span id="l110.70">                 // convert to UTC before serialization.</span>
<a href="#l110.71"></a><span id="l110.71">                 prop.valueAsDatetime = ritem.date.getInTimezone(cal.dtz.UTC);</span>
<a href="#l110.72"></a><span id="l110.72">             }</span>
<a href="#l110.73"></a><span id="l110.73">             itemData.recurrence.push(prop.icalString.trim());</span>
<a href="#l110.74"></a><span id="l110.74">         }</span>
<a href="#l110.75"></a><span id="l110.75">     } else if (aItem.recurrenceId) {</span>
<a href="#l110.76"></a><span id="l110.76" class="difflineat">@@ -589,18 +593,18 @@ function setupRecurrence(aItem, aRecurre</span>
<a href="#l110.77"></a><span id="l110.77"> </span>
<a href="#l110.78"></a><span id="l110.78">     let hasRecurringRules = false;</span>
<a href="#l110.79"></a><span id="l110.79">     for (let prop = rootComp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l110.80"></a><span id="l110.80">          prop;</span>
<a href="#l110.81"></a><span id="l110.81">          prop = rootComp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l110.82"></a><span id="l110.82">         switch (prop.propertyName) {</span>
<a href="#l110.83"></a><span id="l110.83">             case &quot;RDATE&quot;:</span>
<a href="#l110.84"></a><span id="l110.84">             case &quot;EXDATE&quot;: {</span>
<a href="#l110.85"></a><span id="l110.85" class="difflineminus">-                let recItem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l110.86"></a><span id="l110.86" class="difflineminus">-                                        .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l110.87"></a><span id="l110.87" class="difflineplus">+                let recItem = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l110.88"></a><span id="l110.88" class="difflineplus">+                                .createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l110.89"></a><span id="l110.89">                 try {</span>
<a href="#l110.90"></a><span id="l110.90">                     recItem.icalProperty = prop;</span>
<a href="#l110.91"></a><span id="l110.91">                     aItem.recurrenceInfo.appendRecurrenceItem(recItem);</span>
<a href="#l110.92"></a><span id="l110.92">                     hasRecurringRules = true;</span>
<a href="#l110.93"></a><span id="l110.93">                 } catch (e) {</span>
<a href="#l110.94"></a><span id="l110.94">                     cal.ERROR(&quot;[calGoogleCalendar] Error parsing &quot; +</span>
<a href="#l110.95"></a><span id="l110.95">                               prop.propertyName + &quot; (&quot; +</span>
<a href="#l110.96"></a><span id="l110.96">                               prop.icalString + &quot;):&quot; + e);</span>
<a href="#l110.97"></a><span id="l110.97" class="difflineat">@@ -640,17 +644,17 @@ function JSONToAlarm(aEntry, aDefault) {</span>
<a href="#l110.98"></a><span id="l110.98">     const alarmActionMap = {</span>
<a href="#l110.99"></a><span id="l110.99">         email: &quot;EMAIL&quot;,</span>
<a href="#l110.100"></a><span id="l110.100">         popup: &quot;DISPLAY&quot;,</span>
<a href="#l110.101"></a><span id="l110.101">         sms: &quot;SMS&quot;</span>
<a href="#l110.102"></a><span id="l110.102">     };</span>
<a href="#l110.103"></a><span id="l110.103">     let alarm = cal.createAlarm();</span>
<a href="#l110.104"></a><span id="l110.104">     let alarmOffset = cal.createDuration();</span>
<a href="#l110.105"></a><span id="l110.105">     alarm.action = alarmActionMap[aEntry.method] || &quot;DISPLAY&quot;;</span>
<a href="#l110.106"></a><span id="l110.106" class="difflineminus">-    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l110.107"></a><span id="l110.107" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l110.108"></a><span id="l110.108">     alarmOffset.inSeconds = -aEntry.minutes * 60;</span>
<a href="#l110.109"></a><span id="l110.109">     alarmOffset.normalize();</span>
<a href="#l110.110"></a><span id="l110.110">     alarm.offset = alarmOffset;</span>
<a href="#l110.111"></a><span id="l110.111"> </span>
<a href="#l110.112"></a><span id="l110.112">     if (aDefault) {</span>
<a href="#l110.113"></a><span id="l110.113">         alarm.setProperty(&quot;X-DEFAULT-ALARM&quot;, &quot;TRUE&quot;);</span>
<a href="#l110.114"></a><span id="l110.114">     }</span>
<a href="#l110.115"></a><span id="l110.115">     return alarm;</span>
<a href="#l110.116"></a><span id="l110.116" class="difflineat">@@ -972,17 +976,17 @@ ItemSaver.prototype = {</span>
<a href="#l110.117"></a><span id="l110.117">         if (aData.kind == &quot;calendar#events&quot;) {</span>
<a href="#l110.118"></a><span id="l110.118">             this.activity.type = &quot;Event&quot;;</span>
<a href="#l110.119"></a><span id="l110.119">             return this.parseEventStream(aData);</span>
<a href="#l110.120"></a><span id="l110.120">         } else if (aData.kind == &quot;tasks#tasks&quot;) {</span>
<a href="#l110.121"></a><span id="l110.121">             this.activity.type = &quot;Task&quot;;</span>
<a href="#l110.122"></a><span id="l110.122">             return this.parseTaskStream(aData);</span>
<a href="#l110.123"></a><span id="l110.123">         } else {</span>
<a href="#l110.124"></a><span id="l110.124">             let message = &quot;Invalid Stream type: &quot; + (aData ? aData.kind || aData.toSource() : null);</span>
<a href="#l110.125"></a><span id="l110.125" class="difflineminus">-            throw new Components.Exception(message, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l110.126"></a><span id="l110.126" class="difflineplus">+            throw new Components.Exception(message, Cr.NS_ERROR_FAILURE);</span>
<a href="#l110.127"></a><span id="l110.127">         }</span>
<a href="#l110.128"></a><span id="l110.128">     },</span>
<a href="#l110.129"></a><span id="l110.129"> </span>
<a href="#l110.130"></a><span id="l110.130">     /**</span>
<a href="#l110.131"></a><span id="l110.131">      * Parse the response from Google's list command into tasks and modify the</span>
<a href="#l110.132"></a><span id="l110.132">      * calendar's offline storage to reflect those changes.</span>
<a href="#l110.133"></a><span id="l110.133">      *</span>
<a href="#l110.134"></a><span id="l110.134">      * @param aData         The JS Object from the list response.</span>
<a href="#l110.135"></a><span id="l110.135" class="difflineat">@@ -1192,56 +1196,54 @@ ItemSaver.prototype = {</span>
<a href="#l110.136"></a><span id="l110.136">                 parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;);</span>
<a href="#l110.137"></a><span id="l110.137">                 if (!parent.id) {</span>
<a href="#l110.138"></a><span id="l110.138">                     // Exceptions often don't have the iCalUID field set,</span>
<a href="#l110.139"></a><span id="l110.139">                     // we need to fake it from the google id.</span>
<a href="#l110.140"></a><span id="l110.140">                     let meta = this.metaData[exc.hashId];</span>
<a href="#l110.141"></a><span id="l110.141">                     parent.id = meta.path + &quot;@google.com&quot;;</span>
<a href="#l110.142"></a><span id="l110.142">                 }</span>
<a href="#l110.143"></a><span id="l110.143">                 parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l110.144"></a><span id="l110.144" class="difflineminus">-                let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l110.145"></a><span id="l110.145" class="difflineminus">-                    .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l110.146"></a><span id="l110.146" class="difflineplus">+                let rdate = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l110.147"></a><span id="l110.147" class="difflineplus">+                              .createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l110.148"></a><span id="l110.148">                 rdate.date = exc.recurrenceId;</span>
<a href="#l110.149"></a><span id="l110.149">                 parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l110.150"></a><span id="l110.150">                 await this.commitItem(parent);</span>
<a href="#l110.151"></a><span id="l110.151">             }</span>
<a href="#l110.152"></a><span id="l110.152">         }</span>
<a href="#l110.153"></a><span id="l110.153">     }</span>
<a href="#l110.154"></a><span id="l110.154"> };</span>
<a href="#l110.155"></a><span id="l110.155"> </span>
<a href="#l110.156"></a><span id="l110.156"> /**</span>
<a href="#l110.157"></a><span id="l110.157">  * A wrapper for nsIActivity to handle the synchronization process.</span>
<a href="#l110.158"></a><span id="l110.158">  *</span>
<a href="#l110.159"></a><span id="l110.159">  * @param aCalendar     The calendar for this activity.</span>
<a href="#l110.160"></a><span id="l110.160">  */</span>
<a href="#l110.161"></a><span id="l110.161"> function ActivityShell(aCalendar) {</span>
<a href="#l110.162"></a><span id="l110.162">     this.calendar = aCalendar;</span>
<a href="#l110.163"></a><span id="l110.163"> </span>
<a href="#l110.164"></a><span id="l110.164" class="difflineminus">-    if (&quot;@mozilla.org/activity-process;1&quot; in Components.classes) {</span>
<a href="#l110.165"></a><span id="l110.165" class="difflineplus">+    if (&quot;@mozilla.org/activity-process;1&quot; in Cc) {</span>
<a href="#l110.166"></a><span id="l110.166">         this.init();</span>
<a href="#l110.167"></a><span id="l110.167">     }</span>
<a href="#l110.168"></a><span id="l110.168"> }</span>
<a href="#l110.169"></a><span id="l110.169"> </span>
<a href="#l110.170"></a><span id="l110.170"> ActivityShell.prototype = {</span>
<a href="#l110.171"></a><span id="l110.171">     act: null,</span>
<a href="#l110.172"></a><span id="l110.172">     actMgr: null,</span>
<a href="#l110.173"></a><span id="l110.173">     calendar: null,</span>
<a href="#l110.174"></a><span id="l110.174">     type: null,</span>
<a href="#l110.175"></a><span id="l110.175"> </span>
<a href="#l110.176"></a><span id="l110.176">     init: function() {</span>
<a href="#l110.177"></a><span id="l110.177" class="difflineminus">-        this.actMgr = Components.classes[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l110.178"></a><span id="l110.178" class="difflineminus">-                                .getService(Components.interfaces.nsIActivityManager);</span>
<a href="#l110.179"></a><span id="l110.179" class="difflineminus">-        this.act = Components.classes[&quot;@mozilla.org/activity-process;1&quot;]</span>
<a href="#l110.180"></a><span id="l110.180" class="difflineminus">-                             .createInstance(Components.interfaces.nsIActivityProcess);</span>
<a href="#l110.181"></a><span id="l110.181" class="difflineplus">+        this.actMgr = Cc[&quot;@mozilla.org/activity-manager;1&quot;].getService(Ci.nsIActivityManager);</span>
<a href="#l110.182"></a><span id="l110.182" class="difflineplus">+        this.act = Cc[&quot;@mozilla.org/activity-process;1&quot;].createInstance(Ci.nsIActivityProcess);</span>
<a href="#l110.183"></a><span id="l110.183">         this.act.init(getProviderString(&quot;syncStatus&quot;, this.calendar.name), this);</span>
<a href="#l110.184"></a><span id="l110.184">         this.act.iconClass = &quot;syncMail&quot;;</span>
<a href="#l110.185"></a><span id="l110.185">         this.act.contextType = &quot;gdata-calendar&quot;;</span>
<a href="#l110.186"></a><span id="l110.186">         this.act.contextObj = this.calendar;</span>
<a href="#l110.187"></a><span id="l110.187">         this.act.contextDisplayText = this.calendar.name;</span>
<a href="#l110.188"></a><span id="l110.188" class="difflineminus">-        this.act.state = Components.interfaces.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l110.189"></a><span id="l110.189" class="difflineplus">+        this.act.state = Ci.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l110.190"></a><span id="l110.190"> </span>
<a href="#l110.191"></a><span id="l110.191">         this.actMgr.addActivity(this.act);</span>
<a href="#l110.192"></a><span id="l110.192">     },</span>
<a href="#l110.193"></a><span id="l110.193"> </span>
<a href="#l110.194"></a><span id="l110.194">     addProgress: function(units) {</span>
<a href="#l110.195"></a><span id="l110.195">         if (!this.act) {</span>
<a href="#l110.196"></a><span id="l110.196">             return;</span>
<a href="#l110.197"></a><span id="l110.197">         }</span>
<a href="#l110.198"></a><span id="l110.198" class="difflineat">@@ -1264,17 +1266,17 @@ ActivityShell.prototype = {</span>
<a href="#l110.199"></a><span id="l110.199">     },</span>
<a href="#l110.200"></a><span id="l110.200"> </span>
<a href="#l110.201"></a><span id="l110.201">     complete: function() {</span>
<a href="#l110.202"></a><span id="l110.202">         if (!this.act) {</span>
<a href="#l110.203"></a><span id="l110.203">             return;</span>
<a href="#l110.204"></a><span id="l110.204">         }</span>
<a href="#l110.205"></a><span id="l110.205">         let total = this.act.totalWorkUnits;</span>
<a href="#l110.206"></a><span id="l110.206">         this.act.setProgress(&quot;&quot;, total, total);</span>
<a href="#l110.207"></a><span id="l110.207" class="difflineminus">-        this.act.state = Components.interfaces.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l110.208"></a><span id="l110.208" class="difflineplus">+        this.act.state = Ci.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l110.209"></a><span id="l110.209">         this.actMgr.removeActivity(this.act.id);</span>
<a href="#l110.210"></a><span id="l110.210">     }</span>
<a href="#l110.211"></a><span id="l110.211"> };</span>
<a href="#l110.212"></a><span id="l110.212"> </span>
<a href="#l110.213"></a><span id="l110.213"> /**</span>
<a href="#l110.214"></a><span id="l110.214">  * Check if the response is a conflict and handle asking the user what to do</span>
<a href="#l110.215"></a><span id="l110.215">  * about it. Will resolve if there is no conflict or with new item data.</span>
<a href="#l110.216"></a><span id="l110.216">  * where status is a conflict status, see the end of this function.</span>
<a href="#l110.217"></a><span id="l110.217" class="difflineat">@@ -1306,17 +1308,17 @@ async function checkResolveConflict(aOpe</span>
<a href="#l110.218"></a><span id="l110.218">                 throw e;</span>
<a href="#l110.219"></a><span id="l110.219">             }</span>
<a href="#l110.220"></a><span id="l110.220">         }</span>
<a href="#l110.221"></a><span id="l110.221">     } else {</span>
<a href="#l110.222"></a><span id="l110.222">         // The user has decided to throw away changes, use our existing</span>
<a href="#l110.223"></a><span id="l110.223">         // means to update the item locally.</span>
<a href="#l110.224"></a><span id="l110.224">         cal.LOG(&quot;[calGoogleCalendar] Reload requested, cancelling change of &quot; + aItem.title);</span>
<a href="#l110.225"></a><span id="l110.225">         aCalendar.superCalendar.refresh();</span>
<a href="#l110.226"></a><span id="l110.226" class="difflineminus">-        throw Components.Exception(null, cIE.OPERATION_CANCELLED);</span>
<a href="#l110.227"></a><span id="l110.227" class="difflineplus">+        throw Components.Exception(null, Ci.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l110.228"></a><span id="l110.228">     }</span>
<a href="#l110.229"></a><span id="l110.229"> }</span>
<a href="#l110.230"></a><span id="l110.230"> </span>
<a href="#l110.231"></a><span id="l110.231"> /**</span>
<a href="#l110.232"></a><span id="l110.232">  * Get a string from the gdata properties file</span>
<a href="#l110.233"></a><span id="l110.233">  *</span>
<a href="#l110.234"></a><span id="l110.234">  * @param aStringName  The name of the string within the properties file</span>
<a href="#l110.235"></a><span id="l110.235">  * @param ...aParams   Optional parameters to format the string</span>
<a href="#l110.236"></a><span id="l110.236" class="difflineat">@@ -1339,17 +1341,17 @@ function monkeyPatch(obj, x, func) {</span>
<a href="#l110.237"></a><span id="l110.237">     let old = obj[x];</span>
<a href="#l110.238"></a><span id="l110.238">     obj[x] = function() {</span>
<a href="#l110.239"></a><span id="l110.239">         let parent = old.bind(obj);</span>
<a href="#l110.240"></a><span id="l110.240">         let args = Array.from(arguments);</span>
<a href="#l110.241"></a><span id="l110.241">         args.unshift(parent);</span>
<a href="#l110.242"></a><span id="l110.242">         try {</span>
<a href="#l110.243"></a><span id="l110.243">             return func.apply(obj, args);</span>
<a href="#l110.244"></a><span id="l110.244">         } catch (e) {</span>
<a href="#l110.245"></a><span id="l110.245" class="difflineminus">-            Components.utils.reportError(e);</span>
<a href="#l110.246"></a><span id="l110.246" class="difflineplus">+            Cu.reportError(e);</span>
<a href="#l110.247"></a><span id="l110.247">             throw e;</span>
<a href="#l110.248"></a><span id="l110.248">         }</span>
<a href="#l110.249"></a><span id="l110.249">     };</span>
<a href="#l110.250"></a><span id="l110.250"> }</span>
<a href="#l110.251"></a><span id="l110.251"> </span>
<a href="#l110.252"></a><span id="l110.252"> /**</span>
<a href="#l110.253"></a><span id="l110.253">  * Returns a promise that resolves after pending events have been processed.</span>
<a href="#l110.254"></a><span id="l110.254">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l111.2"></a><span id="l111.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineat">@@ -12,18 +12,18 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l111.4"></a><span id="l111.4"> // calICSCalendar.js</span>
<a href="#l111.5"></a><span id="l111.5"> //</span>
<a href="#l111.6"></a><span id="l111.6"> // This is a non-sync ics file. It reads the file pointer to by uri when set,</span>
<a href="#l111.7"></a><span id="l111.7"> // then writes it on updates. External changes to the file will be</span>
<a href="#l111.8"></a><span id="l111.8"> // ignored and overwritten.</span>
<a href="#l111.9"></a><span id="l111.9"> //</span>
<a href="#l111.10"></a><span id="l111.10"> // XXX Should do locks, so that external changes are not overwritten.</span>
<a href="#l111.11"></a><span id="l111.11"> </span>
<a href="#l111.12"></a><span id="l111.12" class="difflineminus">-var calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineminus">-var calIErrors = Components.interfaces.calIErrors;</span>
<a href="#l111.14"></a><span id="l111.14" class="difflineplus">+var calICalendar = Ci.calICalendar;</span>
<a href="#l111.15"></a><span id="l111.15" class="difflineplus">+var calIErrors = Ci.calIErrors;</span>
<a href="#l111.16"></a><span id="l111.16"> </span>
<a href="#l111.17"></a><span id="l111.17"> function icsNSResolver(prefix) {</span>
<a href="#l111.18"></a><span id="l111.18">     const ns = { D: &quot;DAV:&quot; }; // eslint-disable-line id-length</span>
<a href="#l111.19"></a><span id="l111.19">     return ns[prefix] || null;</span>
<a href="#l111.20"></a><span id="l111.20"> }</span>
<a href="#l111.21"></a><span id="l111.21"> </span>
<a href="#l111.22"></a><span id="l111.22"> function icsXPathFirst(aNode, aExpr, aType) {</span>
<a href="#l111.23"></a><span id="l111.23">     return cal.xml.evalXPathFirst(aNode, aExpr, icsNSResolver, aType);</span>
<a href="#l111.24"></a><span id="l111.24" class="difflineat">@@ -35,41 +35,41 @@ function calICSCalendar() {</span>
<a href="#l111.25"></a><span id="l111.25"> </span>
<a href="#l111.26"></a><span id="l111.26">     this.unmappedComponents = [];</span>
<a href="#l111.27"></a><span id="l111.27">     this.unmappedProperties = [];</span>
<a href="#l111.28"></a><span id="l111.28">     this.queue = [];</span>
<a href="#l111.29"></a><span id="l111.29">     this.mModificationActions = [];</span>
<a href="#l111.30"></a><span id="l111.30"> }</span>
<a href="#l111.31"></a><span id="l111.31"> var calICSCalendarClassID = Components.ID(&quot;{f8438bff-a3c9-4ed5-b23f-2663b5469abf}&quot;);</span>
<a href="#l111.32"></a><span id="l111.32"> var calICSCalendarInterfaces = [</span>
<a href="#l111.33"></a><span id="l111.33" class="difflineminus">-    Components.interfaces.calICalendarProvider,</span>
<a href="#l111.34"></a><span id="l111.34" class="difflineminus">-    Components.interfaces.calICalendar,</span>
<a href="#l111.35"></a><span id="l111.35" class="difflineminus">-    Components.interfaces.calISchedulingSupport,</span>
<a href="#l111.36"></a><span id="l111.36" class="difflineminus">-    Components.interfaces.nsIStreamListener,</span>
<a href="#l111.37"></a><span id="l111.37" class="difflineminus">-    Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l111.38"></a><span id="l111.38" class="difflineminus">-    Components.interfaces.nsIChannelEventSink,</span>
<a href="#l111.39"></a><span id="l111.39" class="difflineminus">-    Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l111.40"></a><span id="l111.40" class="difflineplus">+    Ci.calICalendarProvider,</span>
<a href="#l111.41"></a><span id="l111.41" class="difflineplus">+    Ci.calICalendar,</span>
<a href="#l111.42"></a><span id="l111.42" class="difflineplus">+    Ci.calISchedulingSupport,</span>
<a href="#l111.43"></a><span id="l111.43" class="difflineplus">+    Ci.nsIStreamListener,</span>
<a href="#l111.44"></a><span id="l111.44" class="difflineplus">+    Ci.nsIStreamLoaderObserver,</span>
<a href="#l111.45"></a><span id="l111.45" class="difflineplus">+    Ci.nsIChannelEventSink,</span>
<a href="#l111.46"></a><span id="l111.46" class="difflineplus">+    Ci.nsIInterfaceRequestor,</span>
<a href="#l111.47"></a><span id="l111.47"> ];</span>
<a href="#l111.48"></a><span id="l111.48"> calICSCalendar.prototype = {</span>
<a href="#l111.49"></a><span id="l111.49">     __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l111.50"></a><span id="l111.50">     classID: calICSCalendarClassID,</span>
<a href="#l111.51"></a><span id="l111.51">     QueryInterface: cal.generateQI(calICSCalendarInterfaces),</span>
<a href="#l111.52"></a><span id="l111.52">     classInfo: cal.generateCI({</span>
<a href="#l111.53"></a><span id="l111.53">         classID: calICSCalendarClassID,</span>
<a href="#l111.54"></a><span id="l111.54">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=ics&quot;,</span>
<a href="#l111.55"></a><span id="l111.55">         classDescription: &quot;Calendar ICS provider&quot;,</span>
<a href="#l111.56"></a><span id="l111.56">         interfaces: calICSCalendarInterfaces,</span>
<a href="#l111.57"></a><span id="l111.57">     }),</span>
<a href="#l111.58"></a><span id="l111.58"> </span>
<a href="#l111.59"></a><span id="l111.59">     mObserver: null,</span>
<a href="#l111.60"></a><span id="l111.60">     locked: false,</span>
<a href="#l111.61"></a><span id="l111.61"> </span>
<a href="#l111.62"></a><span id="l111.62">     initICSCalendar: function() {</span>
<a href="#l111.63"></a><span id="l111.63" class="difflineminus">-        this.mMemoryCalendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l111.64"></a><span id="l111.64" class="difflineminus">-                                         .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l111.65"></a><span id="l111.65" class="difflineplus">+        this.mMemoryCalendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l111.66"></a><span id="l111.66" class="difflineplus">+                                 .createInstance(Ci.calICalendar);</span>
<a href="#l111.67"></a><span id="l111.67"> </span>
<a href="#l111.68"></a><span id="l111.68">         this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l111.69"></a><span id="l111.69">         this.mObserver = new calICSObserver(this);</span>
<a href="#l111.70"></a><span id="l111.70">         this.mMemoryCalendar.addObserver(this.mObserver); // XXX Not removed</span>
<a href="#l111.71"></a><span id="l111.71">     },</span>
<a href="#l111.72"></a><span id="l111.72"> </span>
<a href="#l111.73"></a><span id="l111.73">     //</span>
<a href="#l111.74"></a><span id="l111.74">     // calICalendarProvider interface</span>
<a href="#l111.75"></a><span id="l111.75" class="difflineat">@@ -105,20 +105,20 @@ calICSCalendar.prototype = {</span>
<a href="#l111.76"></a><span id="l111.76">         this.mMemoryCalendar.uri = this.mUri;</span>
<a href="#l111.77"></a><span id="l111.77"> </span>
<a href="#l111.78"></a><span id="l111.78">         // Use the ioservice, to create a channel, which makes finding the</span>
<a href="#l111.79"></a><span id="l111.79">         // right hooks to use easier.</span>
<a href="#l111.80"></a><span id="l111.80">         let channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l111.81"></a><span id="l111.81">                                                      null,</span>
<a href="#l111.82"></a><span id="l111.82">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l111.83"></a><span id="l111.83">                                                      null,</span>
<a href="#l111.84"></a><span id="l111.84" class="difflineminus">-                                                     Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.85"></a><span id="l111.85" class="difflineminus">-                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.86"></a><span id="l111.86" class="difflineminus">-        let wHttpChannel = cal.wrapInstance(channel, Components.interfaces.nsIHttpChannel);</span>
<a href="#l111.87"></a><span id="l111.87" class="difflineminus">-        let wFileChannel = cal.wrapInstance(channel, Components.interfaces.nsIFileChannel);</span>
<a href="#l111.88"></a><span id="l111.88" class="difflineplus">+                                                     Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.89"></a><span id="l111.89" class="difflineplus">+                                                     Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.90"></a><span id="l111.90" class="difflineplus">+        let wHttpChannel = cal.wrapInstance(channel, Ci.nsIHttpChannel);</span>
<a href="#l111.91"></a><span id="l111.91" class="difflineplus">+        let wFileChannel = cal.wrapInstance(channel, Ci.nsIFileChannel);</span>
<a href="#l111.92"></a><span id="l111.92"> </span>
<a href="#l111.93"></a><span id="l111.93">         if (wHttpChannel) {</span>
<a href="#l111.94"></a><span id="l111.94">             this.mHooks = new httpHooks(this);</span>
<a href="#l111.95"></a><span id="l111.95">         } else if (wFileChannel) {</span>
<a href="#l111.96"></a><span id="l111.96">             this.mHooks = new fileHooks(this);</span>
<a href="#l111.97"></a><span id="l111.97">         } else {</span>
<a href="#l111.98"></a><span id="l111.98">             this.mHooks = new dummyHooks(this);</span>
<a href="#l111.99"></a><span id="l111.99">         }</span>
<a href="#l111.100"></a><span id="l111.100" class="difflineat">@@ -138,51 +138,51 @@ calICSCalendar.prototype = {</span>
<a href="#l111.101"></a><span id="l111.101">     },</span>
<a href="#l111.102"></a><span id="l111.102"> </span>
<a href="#l111.103"></a><span id="l111.103">     forceRefresh: function() {</span>
<a href="#l111.104"></a><span id="l111.104">         this.queue.push({ action: &quot;refresh&quot;, forceRefresh: true });</span>
<a href="#l111.105"></a><span id="l111.105">         this.processQueue();</span>
<a href="#l111.106"></a><span id="l111.106">     },</span>
<a href="#l111.107"></a><span id="l111.107"> </span>
<a href="#l111.108"></a><span id="l111.108">     prepareChannel: function(aChannel, aForceRefresh) {</span>
<a href="#l111.109"></a><span id="l111.109" class="difflineminus">-        aChannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l111.110"></a><span id="l111.110" class="difflineplus">+        aChannel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l111.111"></a><span id="l111.111">         aChannel.notificationCallbacks = this;</span>
<a href="#l111.112"></a><span id="l111.112"> </span>
<a href="#l111.113"></a><span id="l111.113">         // Allow the hook to do its work, like a performing a quick check to</span>
<a href="#l111.114"></a><span id="l111.114">         // see if the remote file really changed. Might save a lot of time</span>
<a href="#l111.115"></a><span id="l111.115">         this.mHooks.onBeforeGet(aChannel, aForceRefresh);</span>
<a href="#l111.116"></a><span id="l111.116">     },</span>
<a href="#l111.117"></a><span id="l111.117"> </span>
<a href="#l111.118"></a><span id="l111.118">     createMemoryCalendar: function() {</span>
<a href="#l111.119"></a><span id="l111.119">         // Create a new calendar, to get rid of all the old events</span>
<a href="#l111.120"></a><span id="l111.120">         // Don't forget to remove the observer</span>
<a href="#l111.121"></a><span id="l111.121">         if (this.mMemoryCalendar) {</span>
<a href="#l111.122"></a><span id="l111.122">             this.mMemoryCalendar.removeObserver(this.mObserver);</span>
<a href="#l111.123"></a><span id="l111.123">         }</span>
<a href="#l111.124"></a><span id="l111.124" class="difflineminus">-        this.mMemoryCalendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l111.125"></a><span id="l111.125" class="difflineminus">-                                         .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l111.126"></a><span id="l111.126" class="difflineplus">+        this.mMemoryCalendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l111.127"></a><span id="l111.127" class="difflineplus">+                                 .createInstance(Ci.calICalendar);</span>
<a href="#l111.128"></a><span id="l111.128">         this.mMemoryCalendar.uri = this.mUri;</span>
<a href="#l111.129"></a><span id="l111.129">         this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l111.130"></a><span id="l111.130">     },</span>
<a href="#l111.131"></a><span id="l111.131"> </span>
<a href="#l111.132"></a><span id="l111.132">     doRefresh: function(aForce) {</span>
<a href="#l111.133"></a><span id="l111.133" class="difflineminus">-        let prbForce = Components.classes[&quot;@mozilla.org/supports-PRBool;1&quot;]</span>
<a href="#l111.134"></a><span id="l111.134" class="difflineminus">-                                 .createInstance(Components.interfaces.nsISupportsPRBool);</span>
<a href="#l111.135"></a><span id="l111.135" class="difflineplus">+        let prbForce = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;]</span>
<a href="#l111.136"></a><span id="l111.136" class="difflineplus">+                         .createInstance(Ci.nsISupportsPRBool);</span>
<a href="#l111.137"></a><span id="l111.137">         prbForce.data = aForce;</span>
<a href="#l111.138"></a><span id="l111.138"> </span>
<a href="#l111.139"></a><span id="l111.139">         let channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l111.140"></a><span id="l111.140">                                                      null,</span>
<a href="#l111.141"></a><span id="l111.141">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l111.142"></a><span id="l111.142">                                                      null,</span>
<a href="#l111.143"></a><span id="l111.143" class="difflineminus">-                                                     Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.144"></a><span id="l111.144" class="difflineminus">-                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.145"></a><span id="l111.145" class="difflineplus">+                                                     Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.146"></a><span id="l111.146" class="difflineplus">+                                                     Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.147"></a><span id="l111.147">         this.prepareChannel(channel, aForce);</span>
<a href="#l111.148"></a><span id="l111.148"> </span>
<a href="#l111.149"></a><span id="l111.149" class="difflineminus">-        let streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l111.150"></a><span id="l111.150" class="difflineminus">-                                     .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l111.151"></a><span id="l111.151" class="difflineplus">+        let streamLoader = Cc[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l111.152"></a><span id="l111.152" class="difflineplus">+                             .createInstance(Ci.nsIStreamLoader);</span>
<a href="#l111.153"></a><span id="l111.153"> </span>
<a href="#l111.154"></a><span id="l111.154">         // Lock other changes to the item list.</span>
<a href="#l111.155"></a><span id="l111.155">         this.lock();</span>
<a href="#l111.156"></a><span id="l111.156"> </span>
<a href="#l111.157"></a><span id="l111.157">         try {</span>
<a href="#l111.158"></a><span id="l111.158">             streamLoader.init(this);</span>
<a href="#l111.159"></a><span id="l111.159">             channel.asyncOpen(streamLoader, prbForce);</span>
<a href="#l111.160"></a><span id="l111.160">         } catch (e) {</span>
<a href="#l111.161"></a><span id="l111.161" class="difflineat">@@ -190,24 +190,24 @@ calICSCalendar.prototype = {</span>
<a href="#l111.162"></a><span id="l111.162">             cal.LOG(&quot;[calICSCalendar] Error occurred opening channel: &quot; + e);</span>
<a href="#l111.163"></a><span id="l111.163">             this.unlock();</span>
<a href="#l111.164"></a><span id="l111.164">         }</span>
<a href="#l111.165"></a><span id="l111.165">     },</span>
<a href="#l111.166"></a><span id="l111.166"> </span>
<a href="#l111.167"></a><span id="l111.167">     // nsIChannelEventSink implementation</span>
<a href="#l111.168"></a><span id="l111.168">     asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l111.169"></a><span id="l111.169">         this.prepareChannel(aNewChannel, true);</span>
<a href="#l111.170"></a><span id="l111.170" class="difflineminus">-        aCallback.onRedirectVerifyCallback(Components.results.NS_OK);</span>
<a href="#l111.171"></a><span id="l111.171" class="difflineplus">+        aCallback.onRedirectVerifyCallback(Cr.NS_OK);</span>
<a href="#l111.172"></a><span id="l111.172">     },</span>
<a href="#l111.173"></a><span id="l111.173"> </span>
<a href="#l111.174"></a><span id="l111.174">     // nsIStreamLoaderObserver impl</span>
<a href="#l111.175"></a><span id="l111.175">     // Listener for download. Parse the downloaded file</span>
<a href="#l111.176"></a><span id="l111.176"> </span>
<a href="#l111.177"></a><span id="l111.177">     onStreamComplete: function(loader, ctxt, status, resultLength, result) {</span>
<a href="#l111.178"></a><span id="l111.178" class="difflineminus">-        let forceRefresh = ctxt.QueryInterface(Components.interfaces.nsISupportsPRBool).data;</span>
<a href="#l111.179"></a><span id="l111.179" class="difflineplus">+        let forceRefresh = ctxt.QueryInterface(Ci.nsISupportsPRBool).data;</span>
<a href="#l111.180"></a><span id="l111.180">         let cont = false;</span>
<a href="#l111.181"></a><span id="l111.181"> </span>
<a href="#l111.182"></a><span id="l111.182">         if (Components.isSuccessCode(status)) {</span>
<a href="#l111.183"></a><span id="l111.183">             // Allow the hook to get needed data (like an etag) of the channel</span>
<a href="#l111.184"></a><span id="l111.184">             cont = this.mHooks.onAfterGet(loader.request, forceRefresh);</span>
<a href="#l111.185"></a><span id="l111.185">             cal.LOG(&quot;[calICSCalendar] Loading ICS succeeded, needs further processing: &quot; + cont);</span>
<a href="#l111.186"></a><span id="l111.186">         } else {</span>
<a href="#l111.187"></a><span id="l111.187">             // Failure may be due to temporary connection issue, keep old data to</span>
<a href="#l111.188"></a><span id="l111.188" class="difflineat">@@ -248,18 +248,18 @@ calICSCalendar.prototype = {</span>
<a href="#l111.189"></a><span id="l111.189"> </span>
<a href="#l111.190"></a><span id="l111.190">         this.createMemoryCalendar();</span>
<a href="#l111.191"></a><span id="l111.191"> </span>
<a href="#l111.192"></a><span id="l111.192">         this.mObserver.onStartBatch();</span>
<a href="#l111.193"></a><span id="l111.193"> </span>
<a href="#l111.194"></a><span id="l111.194">         // Wrap parsing in a try block. Will ignore errors. That's a good thing</span>
<a href="#l111.195"></a><span id="l111.195">         // for non-existing or empty files, but not good for invalid files.</span>
<a href="#l111.196"></a><span id="l111.196">         // That's why we put them in readOnly mode</span>
<a href="#l111.197"></a><span id="l111.197" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l111.198"></a><span id="l111.198" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l111.199"></a><span id="l111.199" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l111.200"></a><span id="l111.200" class="difflineplus">+                       .createInstance(Ci.calIIcsParser);</span>
<a href="#l111.201"></a><span id="l111.201">         let self = this;</span>
<a href="#l111.202"></a><span id="l111.202">         let listener = { // calIIcsParsingListener</span>
<a href="#l111.203"></a><span id="l111.203">             onParsingComplete: function(rc, parser_) {</span>
<a href="#l111.204"></a><span id="l111.204">                 try {</span>
<a href="#l111.205"></a><span id="l111.205">                     for (let item of parser_.getItems({})) {</span>
<a href="#l111.206"></a><span id="l111.206">                         self.mMemoryCalendar.adoptItem(item, null);</span>
<a href="#l111.207"></a><span id="l111.207">                     }</span>
<a href="#l111.208"></a><span id="l111.208">                     self.unmappedComponents = parser_.getComponents({});</span>
<a href="#l111.209"></a><span id="l111.209" class="difflineat">@@ -284,17 +284,17 @@ calICSCalendar.prototype = {</span>
<a href="#l111.210"></a><span id="l111.210">         parser.parseString(str, null, listener);</span>
<a href="#l111.211"></a><span id="l111.211">     },</span>
<a href="#l111.212"></a><span id="l111.212"> </span>
<a href="#l111.213"></a><span id="l111.213">     writeICS: function() {</span>
<a href="#l111.214"></a><span id="l111.214">         cal.LOG(&quot;[calICSCalendar] Commencing write of ICS Calendar &quot; + this.name);</span>
<a href="#l111.215"></a><span id="l111.215">         this.lock();</span>
<a href="#l111.216"></a><span id="l111.216">         try {</span>
<a href="#l111.217"></a><span id="l111.217">             if (!this.mUri) {</span>
<a href="#l111.218"></a><span id="l111.218" class="difflineminus">-                throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l111.219"></a><span id="l111.219" class="difflineplus">+                throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l111.220"></a><span id="l111.220">             }</span>
<a href="#l111.221"></a><span id="l111.221">             // makeBackup will call doWriteICS</span>
<a href="#l111.222"></a><span id="l111.222">             this.makeBackup(this.doWriteICS);</span>
<a href="#l111.223"></a><span id="l111.223">         } catch (exc) {</span>
<a href="#l111.224"></a><span id="l111.224">             this.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l111.225"></a><span id="l111.225">             throw exc;</span>
<a href="#l111.226"></a><span id="l111.226">         }</span>
<a href="#l111.227"></a><span id="l111.227">     },</span>
<a href="#l111.228"></a><span id="l111.228" class="difflineat">@@ -310,26 +310,25 @@ calICSCalendar.prototype = {</span>
<a href="#l111.229"></a><span id="l111.229">                 try {</span>
<a href="#l111.230"></a><span id="l111.230">                     // All events are returned. Now set up a channel and a</span>
<a href="#l111.231"></a><span id="l111.231">                     // streamloader to upload.  onStopRequest will be called</span>
<a href="#l111.232"></a><span id="l111.232">                     // once the write has finished</span>
<a href="#l111.233"></a><span id="l111.233">                     let channel = Services.io.newChannelFromURI2(self.mUri,</span>
<a href="#l111.234"></a><span id="l111.234">                                                                  null,</span>
<a href="#l111.235"></a><span id="l111.235">                                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l111.236"></a><span id="l111.236">                                                                  null,</span>
<a href="#l111.237"></a><span id="l111.237" class="difflineminus">-                                                                 Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.238"></a><span id="l111.238" class="difflineminus">-                                                                 Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.239"></a><span id="l111.239" class="difflineplus">+                                                                 Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.240"></a><span id="l111.240" class="difflineplus">+                                                                 Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.241"></a><span id="l111.241"> </span>
<a href="#l111.242"></a><span id="l111.242">                     // Allow the hook to add things to the channel, like a</span>
<a href="#l111.243"></a><span id="l111.243">                     // header that checks etags</span>
<a href="#l111.244"></a><span id="l111.244">                     let notChanged = self.mHooks.onBeforePut(channel);</span>
<a href="#l111.245"></a><span id="l111.245">                     if (notChanged) {</span>
<a href="#l111.246"></a><span id="l111.246">                         channel.notificationCallbacks = self;</span>
<a href="#l111.247"></a><span id="l111.247" class="difflineminus">-                        let uploadChannel = channel.QueryInterface(</span>
<a href="#l111.248"></a><span id="l111.248" class="difflineminus">-                            Components.interfaces.nsIUploadChannel);</span>
<a href="#l111.249"></a><span id="l111.249" class="difflineplus">+                        let uploadChannel = channel.QueryInterface(Ci.nsIUploadChannel);</span>
<a href="#l111.250"></a><span id="l111.250"> </span>
<a href="#l111.251"></a><span id="l111.251">                         // Serialize</span>
<a href="#l111.252"></a><span id="l111.252">                         let icsStream = this.serializer.serializeToInputStream();</span>
<a href="#l111.253"></a><span id="l111.253"> </span>
<a href="#l111.254"></a><span id="l111.254">                         // Upload</span>
<a href="#l111.255"></a><span id="l111.255">                         uploadChannel.setUploadStream(icsStream,</span>
<a href="#l111.256"></a><span id="l111.256">                                                     &quot;text/calendar&quot;, -1);</span>
<a href="#l111.257"></a><span id="l111.257"> </span>
<a href="#l111.258"></a><span id="l111.258" class="difflineat">@@ -356,18 +355,18 @@ calICSCalendar.prototype = {</span>
<a href="#l111.259"></a><span id="l111.259">                     self.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l111.260"></a><span id="l111.260">                     self.forceRefresh();</span>
<a href="#l111.261"></a><span id="l111.261">                 }</span>
<a href="#l111.262"></a><span id="l111.262">             },</span>
<a href="#l111.263"></a><span id="l111.263">             onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l111.264"></a><span id="l111.264">                 this.serializer.addItems(aItems, aCount);</span>
<a href="#l111.265"></a><span id="l111.265">             }</span>
<a href="#l111.266"></a><span id="l111.266">         };</span>
<a href="#l111.267"></a><span id="l111.267" class="difflineminus">-        listener.serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l111.268"></a><span id="l111.268" class="difflineminus">-                                        .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l111.269"></a><span id="l111.269" class="difflineplus">+        listener.serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l111.270"></a><span id="l111.270" class="difflineplus">+                                .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l111.271"></a><span id="l111.271">         for (let comp of this.unmappedComponents) {</span>
<a href="#l111.272"></a><span id="l111.272">             listener.serializer.addComponent(comp);</span>
<a href="#l111.273"></a><span id="l111.273">         }</span>
<a href="#l111.274"></a><span id="l111.274">         for (let prop of this.unmappedProperties) {</span>
<a href="#l111.275"></a><span id="l111.275">             switch (prop.propertyName) {</span>
<a href="#l111.276"></a><span id="l111.276">                 // we always set the current name and timezone:</span>
<a href="#l111.277"></a><span id="l111.277">                 case &quot;X-WR-CALNAME&quot;:</span>
<a href="#l111.278"></a><span id="l111.278">                 case &quot;X-WR-TIMEZONE&quot;:</span>
<a href="#l111.279"></a><span id="l111.279" class="difflineat">@@ -390,28 +389,27 @@ calICSCalendar.prototype = {</span>
<a href="#l111.280"></a><span id="l111.280">     },</span>
<a href="#l111.281"></a><span id="l111.281"> </span>
<a href="#l111.282"></a><span id="l111.282">     // nsIStreamListener impl</span>
<a href="#l111.283"></a><span id="l111.283">     // For after publishing. Do error checks here</span>
<a href="#l111.284"></a><span id="l111.284">     onStartRequest: function(request, ctxt) {},</span>
<a href="#l111.285"></a><span id="l111.285">     onDataAvailable: function(request, ctxt, inStream, sourceOffset, count) {</span>
<a href="#l111.286"></a><span id="l111.286">         // All data must be consumed. For an upload channel, there is</span>
<a href="#l111.287"></a><span id="l111.287">         // no meaningfull data. So it gets read and then ignored</span>
<a href="#l111.288"></a><span id="l111.288" class="difflineminus">-        let scriptableInputStream =</span>
<a href="#l111.289"></a><span id="l111.289" class="difflineminus">-            Components.classes[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l111.290"></a><span id="l111.290" class="difflineminus">-                      .createInstance(Components.interfaces.nsIScriptableInputStream);</span>
<a href="#l111.291"></a><span id="l111.291" class="difflineplus">+        let scriptableInputStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l111.292"></a><span id="l111.292" class="difflineplus">+                                      .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l111.293"></a><span id="l111.293">         scriptableInputStream.init(inStream);</span>
<a href="#l111.294"></a><span id="l111.294">         scriptableInputStream.read(-1);</span>
<a href="#l111.295"></a><span id="l111.295">     },</span>
<a href="#l111.296"></a><span id="l111.296">     onStopRequest: function(request, ctxt, status, errorMsg) {</span>
<a href="#l111.297"></a><span id="l111.297">         ctxt = ctxt.wrappedJSObject;</span>
<a href="#l111.298"></a><span id="l111.298">         let httpChannel;</span>
<a href="#l111.299"></a><span id="l111.299">         let requestSucceeded = false;</span>
<a href="#l111.300"></a><span id="l111.300">         try {</span>
<a href="#l111.301"></a><span id="l111.301" class="difflineminus">-            httpChannel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l111.302"></a><span id="l111.302" class="difflineplus">+            httpChannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l111.303"></a><span id="l111.303">             requestSucceeded = httpChannel.requestSucceeded;</span>
<a href="#l111.304"></a><span id="l111.304">         } catch (e) {</span>
<a href="#l111.305"></a><span id="l111.305">             // This may fail if it was not a http channel, handled later on.</span>
<a href="#l111.306"></a><span id="l111.306">         }</span>
<a href="#l111.307"></a><span id="l111.307"> </span>
<a href="#l111.308"></a><span id="l111.308">         if (httpChannel) {</span>
<a href="#l111.309"></a><span id="l111.309">             cal.LOG(&quot;[calICSCalendar] channel.requestSucceeded: &quot; + requestSucceeded);</span>
<a href="#l111.310"></a><span id="l111.310">         }</span>
<a href="#l111.311"></a><span id="l111.311" class="difflineat">@@ -775,23 +773,23 @@ calICSCalendar.prototype = {</span>
<a href="#l111.312"></a><span id="l111.312"> </span>
<a href="#l111.313"></a><span id="l111.313">         purgeOldBackups();</span>
<a href="#l111.314"></a><span id="l111.314"> </span>
<a href="#l111.315"></a><span id="l111.315">         // Now go download the remote file, and store it somewhere local.</span>
<a href="#l111.316"></a><span id="l111.316">         let channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l111.317"></a><span id="l111.317">                                                      null,</span>
<a href="#l111.318"></a><span id="l111.318">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l111.319"></a><span id="l111.319">                                                      null,</span>
<a href="#l111.320"></a><span id="l111.320" class="difflineminus">-                                                     Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.321"></a><span id="l111.321" class="difflineminus">-                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.322"></a><span id="l111.322" class="difflineminus">-        channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l111.323"></a><span id="l111.323" class="difflineplus">+                                                     Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.324"></a><span id="l111.324" class="difflineplus">+                                                     Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.325"></a><span id="l111.325" class="difflineplus">+        channel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l111.326"></a><span id="l111.326">         channel.notificationCallbacks = this;</span>
<a href="#l111.327"></a><span id="l111.327"> </span>
<a href="#l111.328"></a><span id="l111.328" class="difflineminus">-        let downloader = Components.classes[&quot;@mozilla.org/network/downloader;1&quot;]</span>
<a href="#l111.329"></a><span id="l111.329" class="difflineminus">-                                   .createInstance(Ci.nsIDownloader);</span>
<a href="#l111.330"></a><span id="l111.330" class="difflineplus">+        let downloader = Cc[&quot;@mozilla.org/network/downloader;1&quot;]</span>
<a href="#l111.331"></a><span id="l111.331" class="difflineplus">+                           .createInstance(Ci.nsIDownloader);</span>
<a href="#l111.332"></a><span id="l111.332"> </span>
<a href="#l111.333"></a><span id="l111.333">         let self = this;</span>
<a href="#l111.334"></a><span id="l111.334">         let listener = {</span>
<a href="#l111.335"></a><span id="l111.335">             onDownloadComplete: function(opdownloader, request, ctxt, status, result) {</span>
<a href="#l111.336"></a><span id="l111.336">                 if (doInitialBackup) {</span>
<a href="#l111.337"></a><span id="l111.337">                     copyToOverwriting(result, backupDir, makeName(&quot;initial&quot;));</span>
<a href="#l111.338"></a><span id="l111.338">                 }</span>
<a href="#l111.339"></a><span id="l111.339">                 if (doDailyBackup) {</span>
<a href="#l111.340"></a><span id="l111.340" class="difflineat">@@ -900,33 +898,33 @@ dummyHooks.prototype = {</span>
<a href="#l111.341"></a><span id="l111.341"> };</span>
<a href="#l111.342"></a><span id="l111.342"> </span>
<a href="#l111.343"></a><span id="l111.343"> function httpHooks(calendar) {</span>
<a href="#l111.344"></a><span id="l111.344">     this.mCalendar = calendar;</span>
<a href="#l111.345"></a><span id="l111.345"> }</span>
<a href="#l111.346"></a><span id="l111.346"> </span>
<a href="#l111.347"></a><span id="l111.347"> httpHooks.prototype = {</span>
<a href="#l111.348"></a><span id="l111.348">     onBeforeGet: function(aChannel, aForceRefresh) {</span>
<a href="#l111.349"></a><span id="l111.349" class="difflineminus">-        let httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l111.350"></a><span id="l111.350" class="difflineplus">+        let httpchannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l111.351"></a><span id="l111.351">         httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/calendar,text/plain;q=0.8,*/*;q=0.5&quot;, false);</span>
<a href="#l111.352"></a><span id="l111.352"> </span>
<a href="#l111.353"></a><span id="l111.353">         if (this.mEtag &amp;&amp; !aForceRefresh) {</span>
<a href="#l111.354"></a><span id="l111.354">             // Somehow the webdav header 'If' doesn't work on apache when</span>
<a href="#l111.355"></a><span id="l111.355">             // passing in a Not, so use the http version here.</span>
<a href="#l111.356"></a><span id="l111.356">             httpchannel.setRequestHeader(&quot;If-None-Match&quot;, this.mEtag, false);</span>
<a href="#l111.357"></a><span id="l111.357">         } else if (!aForceRefresh &amp;&amp; this.mLastModified) {</span>
<a href="#l111.358"></a><span id="l111.358">             // Only send 'If-Modified-Since' if no ETag is available</span>
<a href="#l111.359"></a><span id="l111.359">             httpchannel.setRequestHeader(&quot;If-Modified-Since&quot;, this.mLastModified, false);</span>
<a href="#l111.360"></a><span id="l111.360">         }</span>
<a href="#l111.361"></a><span id="l111.361"> </span>
<a href="#l111.362"></a><span id="l111.362">         return true;</span>
<a href="#l111.363"></a><span id="l111.363">     },</span>
<a href="#l111.364"></a><span id="l111.364"> </span>
<a href="#l111.365"></a><span id="l111.365">     onAfterGet: function(aChannel, aForceRefresh) {</span>
<a href="#l111.366"></a><span id="l111.366" class="difflineminus">-        let httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l111.367"></a><span id="l111.367" class="difflineplus">+        let httpchannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l111.368"></a><span id="l111.368">         let responseStatus = 0;</span>
<a href="#l111.369"></a><span id="l111.369">         let responseStatusCategory = 0;</span>
<a href="#l111.370"></a><span id="l111.370"> </span>
<a href="#l111.371"></a><span id="l111.371">         try {</span>
<a href="#l111.372"></a><span id="l111.372">             responseStatus = httpchannel.responseStatus;</span>
<a href="#l111.373"></a><span id="l111.373">             responseStatusCategory = Math.floor(responseStatus / 100);</span>
<a href="#l111.374"></a><span id="l111.374">         } catch (e) {</span>
<a href="#l111.375"></a><span id="l111.375">             // Error might have been a temporary connection issue, keep old data to</span>
<a href="#l111.376"></a><span id="l111.376" class="difflineat">@@ -970,27 +968,27 @@ httpHooks.prototype = {</span>
<a href="#l111.377"></a><span id="l111.377">             this.mLastModified = null;</span>
<a href="#l111.378"></a><span id="l111.378">         }</span>
<a href="#l111.379"></a><span id="l111.379"> </span>
<a href="#l111.380"></a><span id="l111.380">         return true;</span>
<a href="#l111.381"></a><span id="l111.381">     },</span>
<a href="#l111.382"></a><span id="l111.382"> </span>
<a href="#l111.383"></a><span id="l111.383">     onBeforePut: function(aChannel) {</span>
<a href="#l111.384"></a><span id="l111.384">         if (this.mEtag) {</span>
<a href="#l111.385"></a><span id="l111.385" class="difflineminus">-            let httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l111.386"></a><span id="l111.386" class="difflineplus">+            let httpchannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l111.387"></a><span id="l111.387"> </span>
<a href="#l111.388"></a><span id="l111.388">             // Apache doesn't work correctly with if-match on a PUT method,</span>
<a href="#l111.389"></a><span id="l111.389">             // so use the webdav header</span>
<a href="#l111.390"></a><span id="l111.390">             httpchannel.setRequestHeader(&quot;If&quot;, &quot;([&quot; + this.mEtag + &quot;])&quot;, false);</span>
<a href="#l111.391"></a><span id="l111.391">         }</span>
<a href="#l111.392"></a><span id="l111.392">         return true;</span>
<a href="#l111.393"></a><span id="l111.393">     },</span>
<a href="#l111.394"></a><span id="l111.394"> </span>
<a href="#l111.395"></a><span id="l111.395">     onAfterPut: function(aChannel, aRespFunc) {</span>
<a href="#l111.396"></a><span id="l111.396" class="difflineminus">-        let httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l111.397"></a><span id="l111.397" class="difflineplus">+        let httpchannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l111.398"></a><span id="l111.398">         try {</span>
<a href="#l111.399"></a><span id="l111.399">             this.mEtag = httpchannel.getResponseHeader(&quot;ETag&quot;);</span>
<a href="#l111.400"></a><span id="l111.400">             aRespFunc();</span>
<a href="#l111.401"></a><span id="l111.401">         } catch (e) {</span>
<a href="#l111.402"></a><span id="l111.402">             // There was no ETag header on the response. This means that</span>
<a href="#l111.403"></a><span id="l111.403">             // putting is not atomic. This is bad. Race conditions can happen,</span>
<a href="#l111.404"></a><span id="l111.404">             // because there is a time in which we don't know the right</span>
<a href="#l111.405"></a><span id="l111.405">             // etag.</span>
<a href="#l111.406"></a><span id="l111.406" class="difflineat">@@ -1018,34 +1016,33 @@ httpHooks.prototype = {</span>
<a href="#l111.407"></a><span id="l111.407">                   &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l111.408"></a><span id="l111.408">                 &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l111.409"></a><span id="l111.409"> </span>
<a href="#l111.410"></a><span id="l111.410">             let etagChannel = cal.provider.prepHttpChannel(aChannel.URI, queryXml,</span>
<a href="#l111.411"></a><span id="l111.411">                                                            &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l111.412"></a><span id="l111.412">                                                            this);</span>
<a href="#l111.413"></a><span id="l111.413">             etagChannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l111.414"></a><span id="l111.414">             etagChannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l111.415"></a><span id="l111.415" class="difflineminus">-            let streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l111.416"></a><span id="l111.416" class="difflineminus">-                                         .createInstance(Components.interfaces</span>
<a href="#l111.417"></a><span id="l111.417" class="difflineminus">-                                         .nsIStreamLoader);</span>
<a href="#l111.418"></a><span id="l111.418" class="difflineplus">+            let streamLoader = Cc[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l111.419"></a><span id="l111.419" class="difflineplus">+                                 .createInstance(Ci.nsIStreamLoader);</span>
<a href="#l111.420"></a><span id="l111.420"> </span>
<a href="#l111.421"></a><span id="l111.421">             cal.provider.sendHttpRequest(streamLoader, etagChannel, etagListener);</span>
<a href="#l111.422"></a><span id="l111.422">         }</span>
<a href="#l111.423"></a><span id="l111.423">         return true;</span>
<a href="#l111.424"></a><span id="l111.424">     },</span>
<a href="#l111.425"></a><span id="l111.425"> </span>
<a href="#l111.426"></a><span id="l111.426">     // nsIProgressEventSink</span>
<a href="#l111.427"></a><span id="l111.427">     onProgress: function(aRequest, aContext, aProgress, aProgressMax) {},</span>
<a href="#l111.428"></a><span id="l111.428">     onStatus: function(aRequest, aContext, aStatus, aStatusArg) {},</span>
<a href="#l111.429"></a><span id="l111.429"> </span>
<a href="#l111.430"></a><span id="l111.430">     getInterface: function(aIid) {</span>
<a href="#l111.431"></a><span id="l111.431" class="difflineminus">-        if (aIid.equals(Components.interfaces.nsIProgressEventSink)) {</span>
<a href="#l111.432"></a><span id="l111.432" class="difflineplus">+        if (aIid.equals(Ci.nsIProgressEventSink)) {</span>
<a href="#l111.433"></a><span id="l111.433">             return this;</span>
<a href="#l111.434"></a><span id="l111.434">         } else {</span>
<a href="#l111.435"></a><span id="l111.435" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l111.436"></a><span id="l111.436" class="difflineplus">+            throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l111.437"></a><span id="l111.437">         }</span>
<a href="#l111.438"></a><span id="l111.438">     }</span>
<a href="#l111.439"></a><span id="l111.439"> };</span>
<a href="#l111.440"></a><span id="l111.440"> </span>
<a href="#l111.441"></a><span id="l111.441"> function fileHooks(calendar) {</span>
<a href="#l111.442"></a><span id="l111.442">     this.mCalendar = calendar;</span>
<a href="#l111.443"></a><span id="l111.443"> }</span>
<a href="#l111.444"></a><span id="l111.444"> </span>
<a href="#l111.445"></a><span id="l111.445" class="difflineat">@@ -1056,41 +1053,41 @@ fileHooks.prototype = {</span>
<a href="#l111.446"></a><span id="l111.446"> </span>
<a href="#l111.447"></a><span id="l111.447">     /**</span>
<a href="#l111.448"></a><span id="l111.448">      * @return</span>
<a href="#l111.449"></a><span id="l111.449">      *     a boolean, false if the previous data should be used (the datastore</span>
<a href="#l111.450"></a><span id="l111.450">      *     didn't change, there might be no data in this GET), true in all</span>
<a href="#l111.451"></a><span id="l111.451">      *     other cases</span>
<a href="#l111.452"></a><span id="l111.452">      */</span>
<a href="#l111.453"></a><span id="l111.453">     onAfterGet: function(aChannel, aForceRefresh) {</span>
<a href="#l111.454"></a><span id="l111.454" class="difflineminus">-        let filechannel = aChannel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l111.455"></a><span id="l111.455" class="difflineplus">+        let filechannel = aChannel.QueryInterface(Ci.nsIFileChannel);</span>
<a href="#l111.456"></a><span id="l111.456">         if (this.mtime) {</span>
<a href="#l111.457"></a><span id="l111.457">             let newMtime = filechannel.file.lastModifiedTime;</span>
<a href="#l111.458"></a><span id="l111.458">             if (this.mtime == newMtime &amp;&amp; !aForceRefresh) {</span>
<a href="#l111.459"></a><span id="l111.459">                 return false;</span>
<a href="#l111.460"></a><span id="l111.460">             } else {</span>
<a href="#l111.461"></a><span id="l111.461">                 this.mtime = newMtime;</span>
<a href="#l111.462"></a><span id="l111.462">                 return true;</span>
<a href="#l111.463"></a><span id="l111.463">             }</span>
<a href="#l111.464"></a><span id="l111.464">         } else {</span>
<a href="#l111.465"></a><span id="l111.465">             this.mtime = filechannel.file.lastModifiedTime;</span>
<a href="#l111.466"></a><span id="l111.466">             return true;</span>
<a href="#l111.467"></a><span id="l111.467">         }</span>
<a href="#l111.468"></a><span id="l111.468">     },</span>
<a href="#l111.469"></a><span id="l111.469"> </span>
<a href="#l111.470"></a><span id="l111.470">     onBeforePut: function(aChannel) {</span>
<a href="#l111.471"></a><span id="l111.471" class="difflineminus">-        let filechannel = aChannel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l111.472"></a><span id="l111.472" class="difflineplus">+        let filechannel = aChannel.QueryInterface(Ci.nsIFileChannel);</span>
<a href="#l111.473"></a><span id="l111.473">         if (this.mtime &amp;&amp; this.mtime != filechannel.file.lastModifiedTime) {</span>
<a href="#l111.474"></a><span id="l111.474">             return false;</span>
<a href="#l111.475"></a><span id="l111.475">         } else {</span>
<a href="#l111.476"></a><span id="l111.476">             return true;</span>
<a href="#l111.477"></a><span id="l111.477">         }</span>
<a href="#l111.478"></a><span id="l111.478">     },</span>
<a href="#l111.479"></a><span id="l111.479"> </span>
<a href="#l111.480"></a><span id="l111.480">     onAfterPut: function(aChannel, aRespFunc) {</span>
<a href="#l111.481"></a><span id="l111.481" class="difflineminus">-        let filechannel = aChannel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l111.482"></a><span id="l111.482" class="difflineplus">+        let filechannel = aChannel.QueryInterface(Ci.nsIFileChannel);</span>
<a href="#l111.483"></a><span id="l111.483">         this.mtime = filechannel.file.lastModifiedTime;</span>
<a href="#l111.484"></a><span id="l111.484">         aRespFunc();</span>
<a href="#l111.485"></a><span id="l111.485">         return true;</span>
<a href="#l111.486"></a><span id="l111.486">     }</span>
<a href="#l111.487"></a><span id="l111.487"> };</span>
<a href="#l111.488"></a><span id="l111.488"> </span>
<a href="#l111.489"></a><span id="l111.489"> this.NSGetFactory = XPCOMUtils.generateNSGetFactory([calICSCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l112.2"></a><span id="l112.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineat">@@ -5,29 +5,29 @@</span>
<a href="#l112.4"></a><span id="l112.4"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l112.5"></a><span id="l112.5"> </span>
<a href="#l112.6"></a><span id="l112.6"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l112.7"></a><span id="l112.7"> </span>
<a href="#l112.8"></a><span id="l112.8"> //</span>
<a href="#l112.9"></a><span id="l112.9"> // calMemoryCalendar.js</span>
<a href="#l112.10"></a><span id="l112.10"> //</span>
<a href="#l112.11"></a><span id="l112.11"> </span>
<a href="#l112.12"></a><span id="l112.12" class="difflineminus">-var cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l112.13"></a><span id="l112.13" class="difflineplus">+var cICL = Ci.calIChangeLog;</span>
<a href="#l112.14"></a><span id="l112.14"> </span>
<a href="#l112.15"></a><span id="l112.15"> function calMemoryCalendar() {</span>
<a href="#l112.16"></a><span id="l112.16">     this.initProviderBase();</span>
<a href="#l112.17"></a><span id="l112.17">     this.initMemoryCalendar();</span>
<a href="#l112.18"></a><span id="l112.18"> }</span>
<a href="#l112.19"></a><span id="l112.19"> var calMemoryCalendarClassID = Components.ID(&quot;{bda0dd7f-0a2f-4fcf-ba08-5517e6fbf133}&quot;);</span>
<a href="#l112.20"></a><span id="l112.20"> var calMemoryCalendarInterfaces = [</span>
<a href="#l112.21"></a><span id="l112.21" class="difflineminus">-    Components.interfaces.calICalendar,</span>
<a href="#l112.22"></a><span id="l112.22" class="difflineminus">-    Components.interfaces.calISchedulingSupport,</span>
<a href="#l112.23"></a><span id="l112.23" class="difflineminus">-    Components.interfaces.calIOfflineStorage,</span>
<a href="#l112.24"></a><span id="l112.24" class="difflineminus">-    Components.interfaces.calISyncWriteCalendar,</span>
<a href="#l112.25"></a><span id="l112.25" class="difflineminus">-    Components.interfaces.calICalendarProvider</span>
<a href="#l112.26"></a><span id="l112.26" class="difflineplus">+    Ci.calICalendar,</span>
<a href="#l112.27"></a><span id="l112.27" class="difflineplus">+    Ci.calISchedulingSupport,</span>
<a href="#l112.28"></a><span id="l112.28" class="difflineplus">+    Ci.calIOfflineStorage,</span>
<a href="#l112.29"></a><span id="l112.29" class="difflineplus">+    Ci.calISyncWriteCalendar,</span>
<a href="#l112.30"></a><span id="l112.30" class="difflineplus">+    Ci.calICalendarProvider</span>
<a href="#l112.31"></a><span id="l112.31"> ];</span>
<a href="#l112.32"></a><span id="l112.32"> calMemoryCalendar.prototype = {</span>
<a href="#l112.33"></a><span id="l112.33">     __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l112.34"></a><span id="l112.34">     classID: calMemoryCalendarClassID,</span>
<a href="#l112.35"></a><span id="l112.35">     QueryInterface: cal.generateQI(calMemoryCalendarInterfaces),</span>
<a href="#l112.36"></a><span id="l112.36">     classInfo: cal.generateCI({</span>
<a href="#l112.37"></a><span id="l112.37">         classID: calMemoryCalendarClassID,</span>
<a href="#l112.38"></a><span id="l112.38">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=memory&quot;,</span>
<a href="#l112.39"></a><span id="l112.39" class="difflineat">@@ -36,17 +36,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l112.40"></a><span id="l112.40">     }),</span>
<a href="#l112.41"></a><span id="l112.41"> </span>
<a href="#l112.42"></a><span id="l112.42">     mItems: null,</span>
<a href="#l112.43"></a><span id="l112.43">     mOfflineFlags: null,</span>
<a href="#l112.44"></a><span id="l112.44">     mObservers: null,</span>
<a href="#l112.45"></a><span id="l112.45">     mMetaData: null,</span>
<a href="#l112.46"></a><span id="l112.46"> </span>
<a href="#l112.47"></a><span id="l112.47">     initMemoryCalendar: function() {</span>
<a href="#l112.48"></a><span id="l112.48" class="difflineminus">-        this.mObservers = new cal.data.ObserverSet(Components.interfaces.calIObserver);</span>
<a href="#l112.49"></a><span id="l112.49" class="difflineplus">+        this.mObservers = new cal.data.ObserverSet(Ci.calIObserver);</span>
<a href="#l112.50"></a><span id="l112.50">         this.mItems = {};</span>
<a href="#l112.51"></a><span id="l112.51">         this.mOfflineFlags = {};</span>
<a href="#l112.52"></a><span id="l112.52">         this.mMetaData = new Map();</span>
<a href="#l112.53"></a><span id="l112.53">     },</span>
<a href="#l112.54"></a><span id="l112.54"> </span>
<a href="#l112.55"></a><span id="l112.55">     //</span>
<a href="#l112.56"></a><span id="l112.56">     // calICalendarProvider interface</span>
<a href="#l112.57"></a><span id="l112.57">     //</span>
<a href="#l112.58"></a><span id="l112.58" class="difflineat">@@ -63,17 +63,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l112.59"></a><span id="l112.59">     },</span>
<a href="#l112.60"></a><span id="l112.60"> </span>
<a href="#l112.61"></a><span id="l112.61">     deleteCalendar: function(calendar, listener) {</span>
<a href="#l112.62"></a><span id="l112.62">         calendar = calendar.wrappedJSObject;</span>
<a href="#l112.63"></a><span id="l112.63">         calendar.mItems = {};</span>
<a href="#l112.64"></a><span id="l112.64">         calendar.mMetaData = new Map();</span>
<a href="#l112.65"></a><span id="l112.65"> </span>
<a href="#l112.66"></a><span id="l112.66">         try {</span>
<a href="#l112.67"></a><span id="l112.67" class="difflineminus">-            listener.onDeleteCalendar(calendar, Components.results.NS_OK, null);</span>
<a href="#l112.68"></a><span id="l112.68" class="difflineplus">+            listener.onDeleteCalendar(calendar, Cr.NS_OK, null);</span>
<a href="#l112.69"></a><span id="l112.69">         } catch (ex) {</span>
<a href="#l112.70"></a><span id="l112.70">             // Don't bail out if the listener fails</span>
<a href="#l112.71"></a><span id="l112.71">         }</span>
<a href="#l112.72"></a><span id="l112.72">     },</span>
<a href="#l112.73"></a><span id="l112.73"> </span>
<a href="#l112.74"></a><span id="l112.74">     mRelaxedMode: undefined,</span>
<a href="#l112.75"></a><span id="l112.75">     get relaxedMode() {</span>
<a href="#l112.76"></a><span id="l112.76">         if (this.mRelaxedMode === undefined) {</span>
<a href="#l112.77"></a><span id="l112.77" class="difflineat">@@ -104,44 +104,44 @@ calMemoryCalendar.prototype = {</span>
<a href="#l112.78"></a><span id="l112.78">     addItem: function(aItem, aListener) {</span>
<a href="#l112.79"></a><span id="l112.79">         let newItem = aItem.clone();</span>
<a href="#l112.80"></a><span id="l112.80">         return this.adoptItem(newItem, aListener);</span>
<a href="#l112.81"></a><span id="l112.81">     },</span>
<a href="#l112.82"></a><span id="l112.82"> </span>
<a href="#l112.83"></a><span id="l112.83">     // void adoptItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l112.84"></a><span id="l112.84">     adoptItem: function(aItem, aListener) {</span>
<a href="#l112.85"></a><span id="l112.85">         if (this.readOnly) {</span>
<a href="#l112.86"></a><span id="l112.86" class="difflineminus">-            throw Components.interfaces.calIErrors.CAL_IS_READONLY;</span>
<a href="#l112.87"></a><span id="l112.87" class="difflineplus">+            throw Ci.calIErrors.CAL_IS_READONLY;</span>
<a href="#l112.88"></a><span id="l112.88">         }</span>
<a href="#l112.89"></a><span id="l112.89">         if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l112.90"></a><span id="l112.90">             aItem.id = cal.getUUID();</span>
<a href="#l112.91"></a><span id="l112.91">         }</span>
<a href="#l112.92"></a><span id="l112.92"> </span>
<a href="#l112.93"></a><span id="l112.93">         if (aItem.id == null) {</span>
<a href="#l112.94"></a><span id="l112.94">             this.notifyOperationComplete(aListener,</span>
<a href="#l112.95"></a><span id="l112.95" class="difflineminus">-                                         Components.results.NS_ERROR_FAILURE,</span>
<a href="#l112.96"></a><span id="l112.96" class="difflineminus">-                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l112.97"></a><span id="l112.97" class="difflineplus">+                                         Cr.NS_ERROR_FAILURE,</span>
<a href="#l112.98"></a><span id="l112.98" class="difflineplus">+                                         Ci.calIOperationListener.ADD,</span>
<a href="#l112.99"></a><span id="l112.99">                                          aItem.id,</span>
<a href="#l112.100"></a><span id="l112.100">                                          &quot;Can't set ID on non-mutable item to addItem&quot;);</span>
<a href="#l112.101"></a><span id="l112.101">             return;</span>
<a href="#l112.102"></a><span id="l112.102">         }</span>
<a href="#l112.103"></a><span id="l112.103"> </span>
<a href="#l112.104"></a><span id="l112.104">         // Lines below are commented because of the offline bug 380060, the</span>
<a href="#l112.105"></a><span id="l112.105">         // memory calendar cannot assume that a new item should not have an ID.</span>
<a href="#l112.106"></a><span id="l112.106">         // calCachedCalendar could send over an item with an id.</span>
<a href="#l112.107"></a><span id="l112.107"> </span>
<a href="#l112.108"></a><span id="l112.108">         /*</span>
<a href="#l112.109"></a><span id="l112.109">         if (this.mItems[aItem.id] != null) {</span>
<a href="#l112.110"></a><span id="l112.110">             if (this.relaxedMode) {</span>
<a href="#l112.111"></a><span id="l112.111">                 // we possibly want to interact with the user before deleting</span>
<a href="#l112.112"></a><span id="l112.112">                 delete this.mItems[aItem.id];</span>
<a href="#l112.113"></a><span id="l112.113">             } else {</span>
<a href="#l112.114"></a><span id="l112.114">                 this.notifyOperationComplete(aListener,</span>
<a href="#l112.115"></a><span id="l112.115" class="difflineminus">-                                             Components.interfaces.calIErrors.DUPLICATE_ID,</span>
<a href="#l112.116"></a><span id="l112.116" class="difflineminus">-                                             Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l112.117"></a><span id="l112.117" class="difflineplus">+                                             Ci.calIErrors.DUPLICATE_ID,</span>
<a href="#l112.118"></a><span id="l112.118" class="difflineplus">+                                             Ci.calIOperationListener.ADD,</span>
<a href="#l112.119"></a><span id="l112.119">                                              aItem.id,</span>
<a href="#l112.120"></a><span id="l112.120">                                              &quot;ID already exists for addItem&quot;);</span>
<a href="#l112.121"></a><span id="l112.121">                 return;</span>
<a href="#l112.122"></a><span id="l112.122">             }</span>
<a href="#l112.123"></a><span id="l112.123">         }</span>
<a href="#l112.124"></a><span id="l112.124">         */</span>
<a href="#l112.125"></a><span id="l112.125"> </span>
<a href="#l112.126"></a><span id="l112.126">         let parentItem = aItem.parentItem;</span>
<a href="#l112.127"></a><span id="l112.127" class="difflineat">@@ -151,38 +151,38 @@ calMemoryCalendar.prototype = {</span>
<a href="#l112.128"></a><span id="l112.128">         }</span>
<a href="#l112.129"></a><span id="l112.129">         parentItem.calendar = this.superCalendar;</span>
<a href="#l112.130"></a><span id="l112.130"> </span>
<a href="#l112.131"></a><span id="l112.131">         parentItem.makeImmutable();</span>
<a href="#l112.132"></a><span id="l112.132">         this.mItems[aItem.id] = parentItem;</span>
<a href="#l112.133"></a><span id="l112.133"> </span>
<a href="#l112.134"></a><span id="l112.134">         // notify the listener</span>
<a href="#l112.135"></a><span id="l112.135">         this.notifyOperationComplete(aListener,</span>
<a href="#l112.136"></a><span id="l112.136" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l112.137"></a><span id="l112.137" class="difflineminus">-                                     Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l112.138"></a><span id="l112.138" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l112.139"></a><span id="l112.139" class="difflineplus">+                                     Ci.calIOperationListener.ADD,</span>
<a href="#l112.140"></a><span id="l112.140">                                      aItem.id,</span>
<a href="#l112.141"></a><span id="l112.141">                                      aItem);</span>
<a href="#l112.142"></a><span id="l112.142">         // notify observers</span>
<a href="#l112.143"></a><span id="l112.143">         this.mObservers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l112.144"></a><span id="l112.144">     },</span>
<a href="#l112.145"></a><span id="l112.145"> </span>
<a href="#l112.146"></a><span id="l112.146">     // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l112.147"></a><span id="l112.147">     modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l112.148"></a><span id="l112.148">         if (this.readOnly) {</span>
<a href="#l112.149"></a><span id="l112.149" class="difflineminus">-            throw Components.interfaces.calIErrors.CAL_IS_READONLY;</span>
<a href="#l112.150"></a><span id="l112.150" class="difflineplus">+            throw Ci.calIErrors.CAL_IS_READONLY;</span>
<a href="#l112.151"></a><span id="l112.151">         }</span>
<a href="#l112.152"></a><span id="l112.152">         if (!aNewItem) {</span>
<a href="#l112.153"></a><span id="l112.153" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l112.154"></a><span id="l112.154" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l112.155"></a><span id="l112.155">         }</span>
<a href="#l112.156"></a><span id="l112.156"> </span>
<a href="#l112.157"></a><span id="l112.157">         let self = this;</span>
<a href="#l112.158"></a><span id="l112.158">         function reportError(errStr, errId) {</span>
<a href="#l112.159"></a><span id="l112.159">             self.notifyOperationComplete(aListener,</span>
<a href="#l112.160"></a><span id="l112.160" class="difflineminus">-                                         errId ? errId : Components.results.NS_ERROR_FAILURE,</span>
<a href="#l112.161"></a><span id="l112.161" class="difflineminus">-                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l112.162"></a><span id="l112.162" class="difflineplus">+                                         errId ? errId : Cr.NS_ERROR_FAILURE,</span>
<a href="#l112.163"></a><span id="l112.163" class="difflineplus">+                                         Ci.calIOperationListener.MODIFY,</span>
<a href="#l112.164"></a><span id="l112.164">                                          aNewItem.id,</span>
<a href="#l112.165"></a><span id="l112.165">                                          errStr);</span>
<a href="#l112.166"></a><span id="l112.166">             return null;</span>
<a href="#l112.167"></a><span id="l112.167">         }</span>
<a href="#l112.168"></a><span id="l112.168"> </span>
<a href="#l112.169"></a><span id="l112.169">         if (!aNewItem.id) {</span>
<a href="#l112.170"></a><span id="l112.170">             // this is definitely an error</span>
<a href="#l112.171"></a><span id="l112.171">             return reportError(null, &quot;ID for modifyItem item is null&quot;);</span>
<a href="#l112.172"></a><span id="l112.172" class="difflineat">@@ -238,113 +238,113 @@ calMemoryCalendar.prototype = {</span>
<a href="#l112.173"></a><span id="l112.173">                 modifiedItem.generation += 1;</span>
<a href="#l112.174"></a><span id="l112.174">             }</span>
<a href="#l112.175"></a><span id="l112.175">         }</span>
<a href="#l112.176"></a><span id="l112.176"> </span>
<a href="#l112.177"></a><span id="l112.177">         modifiedItem.makeImmutable();</span>
<a href="#l112.178"></a><span id="l112.178">         this.mItems[modifiedItem.id] = modifiedItem;</span>
<a href="#l112.179"></a><span id="l112.179"> </span>
<a href="#l112.180"></a><span id="l112.180">         this.notifyOperationComplete(aListener,</span>
<a href="#l112.181"></a><span id="l112.181" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l112.182"></a><span id="l112.182" class="difflineminus">-                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l112.183"></a><span id="l112.183" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l112.184"></a><span id="l112.184" class="difflineplus">+                                     Ci.calIOperationListener.MODIFY,</span>
<a href="#l112.185"></a><span id="l112.185">                                      modifiedItem.id,</span>
<a href="#l112.186"></a><span id="l112.186">                                      modifiedItem);</span>
<a href="#l112.187"></a><span id="l112.187"> </span>
<a href="#l112.188"></a><span id="l112.188">         // notify observers</span>
<a href="#l112.189"></a><span id="l112.189">         this.mObservers.notify(&quot;onModifyItem&quot;, [modifiedItem, aOldItem]);</span>
<a href="#l112.190"></a><span id="l112.190">         return null;</span>
<a href="#l112.191"></a><span id="l112.191">     },</span>
<a href="#l112.192"></a><span id="l112.192"> </span>
<a href="#l112.193"></a><span id="l112.193">     // void deleteItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l112.194"></a><span id="l112.194">     deleteItem: function(aItem, aListener) {</span>
<a href="#l112.195"></a><span id="l112.195">         if (this.readOnly) {</span>
<a href="#l112.196"></a><span id="l112.196">             this.notifyOperationComplete(aListener,</span>
<a href="#l112.197"></a><span id="l112.197" class="difflineminus">-                                         Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l112.198"></a><span id="l112.198" class="difflineminus">-                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l112.199"></a><span id="l112.199" class="difflineplus">+                                         Ci.calIErrors.CAL_IS_READONLY,</span>
<a href="#l112.200"></a><span id="l112.200" class="difflineplus">+                                         Ci.calIOperationListener.DELETE,</span>
<a href="#l112.201"></a><span id="l112.201">                                          aItem.id,</span>
<a href="#l112.202"></a><span id="l112.202">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l112.203"></a><span id="l112.203">             return;</span>
<a href="#l112.204"></a><span id="l112.204">         }</span>
<a href="#l112.205"></a><span id="l112.205">         if (aItem.id == null) {</span>
<a href="#l112.206"></a><span id="l112.206">             this.notifyOperationComplete(aListener,</span>
<a href="#l112.207"></a><span id="l112.207" class="difflineminus">-                                         Components.results.NS_ERROR_FAILURE,</span>
<a href="#l112.208"></a><span id="l112.208" class="difflineminus">-                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l112.209"></a><span id="l112.209" class="difflineplus">+                                         Cr.NS_ERROR_FAILURE,</span>
<a href="#l112.210"></a><span id="l112.210" class="difflineplus">+                                         Ci.calIOperationListener.DELETE,</span>
<a href="#l112.211"></a><span id="l112.211">                                          aItem.id,</span>
<a href="#l112.212"></a><span id="l112.212">                                          &quot;ID is null in deleteItem&quot;);</span>
<a href="#l112.213"></a><span id="l112.213">             return;</span>
<a href="#l112.214"></a><span id="l112.214">         }</span>
<a href="#l112.215"></a><span id="l112.215"> </span>
<a href="#l112.216"></a><span id="l112.216">         let oldItem;</span>
<a href="#l112.217"></a><span id="l112.217">         if (this.relaxedMode) {</span>
<a href="#l112.218"></a><span id="l112.218">             oldItem = aItem;</span>
<a href="#l112.219"></a><span id="l112.219">         } else {</span>
<a href="#l112.220"></a><span id="l112.220">             oldItem = this.mItems[aItem.id];</span>
<a href="#l112.221"></a><span id="l112.221">             if (oldItem.generation != aItem.generation) {</span>
<a href="#l112.222"></a><span id="l112.222">                 this.notifyOperationComplete(aListener,</span>
<a href="#l112.223"></a><span id="l112.223" class="difflineminus">-                                             Components.results.NS_ERROR_FAILURE,</span>
<a href="#l112.224"></a><span id="l112.224" class="difflineminus">-                                             Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l112.225"></a><span id="l112.225" class="difflineplus">+                                             Cr.NS_ERROR_FAILURE,</span>
<a href="#l112.226"></a><span id="l112.226" class="difflineplus">+                                             Ci.calIOperationListener.DELETE,</span>
<a href="#l112.227"></a><span id="l112.227">                                              aItem.id,</span>
<a href="#l112.228"></a><span id="l112.228">                                              &quot;generation mismatch in deleteItem&quot;);</span>
<a href="#l112.229"></a><span id="l112.229">                 return;</span>
<a href="#l112.230"></a><span id="l112.230">             }</span>
<a href="#l112.231"></a><span id="l112.231">         }</span>
<a href="#l112.232"></a><span id="l112.232"> </span>
<a href="#l112.233"></a><span id="l112.233"> </span>
<a href="#l112.234"></a><span id="l112.234">         delete this.mItems[aItem.id];</span>
<a href="#l112.235"></a><span id="l112.235">         this.mMetaData.delete(aItem.id);</span>
<a href="#l112.236"></a><span id="l112.236"> </span>
<a href="#l112.237"></a><span id="l112.237">         this.notifyOperationComplete(aListener,</span>
<a href="#l112.238"></a><span id="l112.238" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l112.239"></a><span id="l112.239" class="difflineminus">-                                     Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l112.240"></a><span id="l112.240" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l112.241"></a><span id="l112.241" class="difflineplus">+                                     Ci.calIOperationListener.DELETE,</span>
<a href="#l112.242"></a><span id="l112.242">                                      aItem.id,</span>
<a href="#l112.243"></a><span id="l112.243">                                      aItem);</span>
<a href="#l112.244"></a><span id="l112.244">         // notify observers</span>
<a href="#l112.245"></a><span id="l112.245">         this.mObservers.notify(&quot;onDeleteItem&quot;, [oldItem]);</span>
<a href="#l112.246"></a><span id="l112.246">     },</span>
<a href="#l112.247"></a><span id="l112.247"> </span>
<a href="#l112.248"></a><span id="l112.248">     // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l112.249"></a><span id="l112.249">     getItem: function(aId, aListener) {</span>
<a href="#l112.250"></a><span id="l112.250">         if (!aListener) {</span>
<a href="#l112.251"></a><span id="l112.251">             return;</span>
<a href="#l112.252"></a><span id="l112.252">         }</span>
<a href="#l112.253"></a><span id="l112.253"> </span>
<a href="#l112.254"></a><span id="l112.254">         if (aId == null || this.mItems[aId] == null) {</span>
<a href="#l112.255"></a><span id="l112.255">             // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l112.256"></a><span id="l112.256">             this.notifyOperationComplete(aListener,</span>
<a href="#l112.257"></a><span id="l112.257" class="difflineminus">-                                         Components.results.NS_OK,</span>
<a href="#l112.258"></a><span id="l112.258" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l112.259"></a><span id="l112.259" class="difflineplus">+                                         Cr.NS_OK,</span>
<a href="#l112.260"></a><span id="l112.260" class="difflineplus">+                                         Ci.calIOperationListener.GET,</span>
<a href="#l112.261"></a><span id="l112.261">                                          aId,</span>
<a href="#l112.262"></a><span id="l112.262">                                          null);</span>
<a href="#l112.263"></a><span id="l112.263">             return;</span>
<a href="#l112.264"></a><span id="l112.264">         }</span>
<a href="#l112.265"></a><span id="l112.265"> </span>
<a href="#l112.266"></a><span id="l112.266">         let item = this.mItems[aId];</span>
<a href="#l112.267"></a><span id="l112.267">         let iid = null;</span>
<a href="#l112.268"></a><span id="l112.268"> </span>
<a href="#l112.269"></a><span id="l112.269">         if (cal.item.isEvent(item)) {</span>
<a href="#l112.270"></a><span id="l112.270" class="difflineminus">-            iid = Components.interfaces.calIEvent;</span>
<a href="#l112.271"></a><span id="l112.271" class="difflineplus">+            iid = Ci.calIEvent;</span>
<a href="#l112.272"></a><span id="l112.272">         } else if (cal.item.isToDo(item)) {</span>
<a href="#l112.273"></a><span id="l112.273" class="difflineminus">-            iid = Components.interfaces.calITodo;</span>
<a href="#l112.274"></a><span id="l112.274" class="difflineplus">+            iid = Ci.calITodo;</span>
<a href="#l112.275"></a><span id="l112.275">         } else {</span>
<a href="#l112.276"></a><span id="l112.276">             this.notifyOperationComplete(aListener,</span>
<a href="#l112.277"></a><span id="l112.277" class="difflineminus">-                                         Components.results.NS_ERROR_FAILURE,</span>
<a href="#l112.278"></a><span id="l112.278" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l112.279"></a><span id="l112.279" class="difflineplus">+                                         Cr.NS_ERROR_FAILURE,</span>
<a href="#l112.280"></a><span id="l112.280" class="difflineplus">+                                         Ci.calIOperationListener.GET,</span>
<a href="#l112.281"></a><span id="l112.281">                                          aId,</span>
<a href="#l112.282"></a><span id="l112.282">                                          &quot;Can't deduce item type based on QI&quot;);</span>
<a href="#l112.283"></a><span id="l112.283">             return;</span>
<a href="#l112.284"></a><span id="l112.284">         }</span>
<a href="#l112.285"></a><span id="l112.285"> </span>
<a href="#l112.286"></a><span id="l112.286">         aListener.onGetResult(this.superCalendar,</span>
<a href="#l112.287"></a><span id="l112.287" class="difflineminus">-                              Components.results.NS_OK,</span>
<a href="#l112.288"></a><span id="l112.288" class="difflineplus">+                              Cr.NS_OK,</span>
<a href="#l112.289"></a><span id="l112.289">                               iid,</span>
<a href="#l112.290"></a><span id="l112.290">                               null, 1, [item]);</span>
<a href="#l112.291"></a><span id="l112.291"> </span>
<a href="#l112.292"></a><span id="l112.292">         this.notifyOperationComplete(aListener,</span>
<a href="#l112.293"></a><span id="l112.293" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l112.294"></a><span id="l112.294" class="difflineminus">-                                     Components.interfaces.calIOperationListener.GET,</span>
<a href="#l112.295"></a><span id="l112.295" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l112.296"></a><span id="l112.296" class="difflineplus">+                                     Ci.calIOperationListener.GET,</span>
<a href="#l112.297"></a><span id="l112.297">                                      aId,</span>
<a href="#l112.298"></a><span id="l112.298">                                      null);</span>
<a href="#l112.299"></a><span id="l112.299">     },</span>
<a href="#l112.300"></a><span id="l112.300"> </span>
<a href="#l112.301"></a><span id="l112.301">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l112.302"></a><span id="l112.302">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l112.303"></a><span id="l112.303">     //                in calIOperationListener aListener );</span>
<a href="#l112.304"></a><span id="l112.304">     getItems: function(aItemFilter, aCount,</span>
<a href="#l112.305"></a><span id="l112.305" class="difflineat">@@ -354,44 +354,44 @@ calMemoryCalendar.prototype = {</span>
<a href="#l112.306"></a><span id="l112.306">         });</span>
<a href="#l112.307"></a><span id="l112.307">     },</span>
<a href="#l112.308"></a><span id="l112.308">     getItems_: function(aItemFilter, aCount,</span>
<a href="#l112.309"></a><span id="l112.309">                          aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l112.310"></a><span id="l112.310">         if (!aListener) {</span>
<a href="#l112.311"></a><span id="l112.311">             return;</span>
<a href="#l112.312"></a><span id="l112.312">         }</span>
<a href="#l112.313"></a><span id="l112.313"> </span>
<a href="#l112.314"></a><span id="l112.314" class="difflineminus">-        const calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l112.315"></a><span id="l112.315" class="difflineplus">+        const calICalendar = Ci.calICalendar;</span>
<a href="#l112.316"></a><span id="l112.316"> </span>
<a href="#l112.317"></a><span id="l112.317">         let itemsFound = [];</span>
<a href="#l112.318"></a><span id="l112.318"> </span>
<a href="#l112.319"></a><span id="l112.319">         //</span>
<a href="#l112.320"></a><span id="l112.320">         // filters</span>
<a href="#l112.321"></a><span id="l112.321">         //</span>
<a href="#l112.322"></a><span id="l112.322"> </span>
<a href="#l112.323"></a><span id="l112.323">         let wantUnrespondedInvitations = ((aItemFilter &amp; calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION) != 0);</span>
<a href="#l112.324"></a><span id="l112.324">         let superCal;</span>
<a href="#l112.325"></a><span id="l112.325">         try {</span>
<a href="#l112.326"></a><span id="l112.326" class="difflineminus">-            superCal = this.superCalendar.QueryInterface(Components.interfaces.calISchedulingSupport);</span>
<a href="#l112.327"></a><span id="l112.327" class="difflineplus">+            superCal = this.superCalendar.QueryInterface(Ci.calISchedulingSupport);</span>
<a href="#l112.328"></a><span id="l112.328">         } catch (exc) {</span>
<a href="#l112.329"></a><span id="l112.329">             wantUnrespondedInvitations = false;</span>
<a href="#l112.330"></a><span id="l112.330">         }</span>
<a href="#l112.331"></a><span id="l112.331">         function checkUnrespondedInvitation(item) {</span>
<a href="#l112.332"></a><span id="l112.332">             let att = superCal.getInvitedAttendee(item);</span>
<a href="#l112.333"></a><span id="l112.333">             return att &amp;&amp; att.participationStatus == &quot;NEEDS-ACTION&quot;;</span>
<a href="#l112.334"></a><span id="l112.334">         }</span>
<a href="#l112.335"></a><span id="l112.335"> </span>
<a href="#l112.336"></a><span id="l112.336">         // item base type</span>
<a href="#l112.337"></a><span id="l112.337">         let wantEvents = ((aItemFilter &amp; calICalendar.ITEM_FILTER_TYPE_EVENT) != 0);</span>
<a href="#l112.338"></a><span id="l112.338">         let wantTodos = ((aItemFilter &amp; calICalendar.ITEM_FILTER_TYPE_TODO) != 0);</span>
<a href="#l112.339"></a><span id="l112.339">         if (!wantEvents &amp;&amp; !wantTodos) {</span>
<a href="#l112.340"></a><span id="l112.340">             // bail.</span>
<a href="#l112.341"></a><span id="l112.341">             this.notifyOperationComplete(aListener,</span>
<a href="#l112.342"></a><span id="l112.342" class="difflineminus">-                                         Components.results.NS_ERROR_FAILURE,</span>
<a href="#l112.343"></a><span id="l112.343" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l112.344"></a><span id="l112.344" class="difflineplus">+                                         Cr.NS_ERROR_FAILURE,</span>
<a href="#l112.345"></a><span id="l112.345" class="difflineplus">+                                         Ci.calIOperationListener.GET,</span>
<a href="#l112.346"></a><span id="l112.346">                                          null,</span>
<a href="#l112.347"></a><span id="l112.347">                                          &quot;Bad aItemFilter passed to getItems&quot;);</span>
<a href="#l112.348"></a><span id="l112.348">             return;</span>
<a href="#l112.349"></a><span id="l112.349">         }</span>
<a href="#l112.350"></a><span id="l112.350"> </span>
<a href="#l112.351"></a><span id="l112.351">         // completed?</span>
<a href="#l112.352"></a><span id="l112.352">         let itemCompletedFilter = ((aItemFilter &amp; calICalendar.ITEM_FILTER_COMPLETED_YES) != 0);</span>
<a href="#l112.353"></a><span id="l112.353">         let itemNotCompletedFilter = ((aItemFilter &amp; calICalendar.ITEM_FILTER_COMPLETED_NO) != 0);</span>
<a href="#l112.354"></a><span id="l112.354" class="difflineat">@@ -400,23 +400,23 @@ calMemoryCalendar.prototype = {</span>
<a href="#l112.355"></a><span id="l112.355">         }</span>
<a href="#l112.356"></a><span id="l112.356"> </span>
<a href="#l112.357"></a><span id="l112.357">         // return occurrences?</span>
<a href="#l112.358"></a><span id="l112.358">         let itemReturnOccurrences = ((aItemFilter &amp; calICalendar.ITEM_FILTER_CLASS_OCCURRENCES) != 0);</span>
<a href="#l112.359"></a><span id="l112.359"> </span>
<a href="#l112.360"></a><span id="l112.360">         // figure out the return interface type</span>
<a href="#l112.361"></a><span id="l112.361">         let typeIID = null;</span>
<a href="#l112.362"></a><span id="l112.362">         if (itemReturnOccurrences) {</span>
<a href="#l112.363"></a><span id="l112.363" class="difflineminus">-            typeIID = Components.interfaces.calIItemBase;</span>
<a href="#l112.364"></a><span id="l112.364" class="difflineplus">+            typeIID = Ci.calIItemBase;</span>
<a href="#l112.365"></a><span id="l112.365">         } else if (wantEvents &amp;&amp; wantTodos) {</span>
<a href="#l112.366"></a><span id="l112.366" class="difflineminus">-            typeIID = Components.interfaces.calIItemBase;</span>
<a href="#l112.367"></a><span id="l112.367" class="difflineplus">+            typeIID = Ci.calIItemBase;</span>
<a href="#l112.368"></a><span id="l112.368">         } else if (wantEvents) {</span>
<a href="#l112.369"></a><span id="l112.369" class="difflineminus">-            typeIID = Components.interfaces.calIEvent;</span>
<a href="#l112.370"></a><span id="l112.370" class="difflineplus">+            typeIID = Ci.calIEvent;</span>
<a href="#l112.371"></a><span id="l112.371">         } else if (wantTodos) {</span>
<a href="#l112.372"></a><span id="l112.372" class="difflineminus">-            typeIID = Components.interfaces.calITodo;</span>
<a href="#l112.373"></a><span id="l112.373" class="difflineplus">+            typeIID = Ci.calITodo;</span>
<a href="#l112.374"></a><span id="l112.374">         }</span>
<a href="#l112.375"></a><span id="l112.375"> </span>
<a href="#l112.376"></a><span id="l112.376">         aRangeStart = cal.dtz.ensureDateTime(aRangeStart);</span>
<a href="#l112.377"></a><span id="l112.377">         aRangeEnd = cal.dtz.ensureDateTime(aRangeEnd);</span>
<a href="#l112.378"></a><span id="l112.378"> </span>
<a href="#l112.379"></a><span id="l112.379">         let requestedFlag = 0;</span>
<a href="#l112.380"></a><span id="l112.380">         if ((aItemFilter &amp; calICalendar.ITEM_FILTER_OFFLINE_CREATED) != 0) {</span>
<a href="#l112.381"></a><span id="l112.381">             requestedFlag = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l112.382"></a><span id="l112.382" class="difflineat">@@ -482,84 +482,84 @@ calMemoryCalendar.prototype = {</span>
<a href="#l112.383"></a><span id="l112.383">                 itemsFound.push(item);</span>
<a href="#l112.384"></a><span id="l112.384">             }</span>
<a href="#l112.385"></a><span id="l112.385">             if (aCount &amp;&amp; itemsFound.length &gt;= aCount) {</span>
<a href="#l112.386"></a><span id="l112.386">                 return cal.iterate.forEach.BREAK;</span>
<a href="#l112.387"></a><span id="l112.387">             }</span>
<a href="#l112.388"></a><span id="l112.388">             return cal.iterate.forEach.CONTINUE;</span>
<a href="#l112.389"></a><span id="l112.389">         }, () =&gt; {</span>
<a href="#l112.390"></a><span id="l112.390">             aListener.onGetResult(this.superCalendar,</span>
<a href="#l112.391"></a><span id="l112.391" class="difflineminus">-                                  Components.results.NS_OK,</span>
<a href="#l112.392"></a><span id="l112.392" class="difflineplus">+                                  Cr.NS_OK,</span>
<a href="#l112.393"></a><span id="l112.393">                                   typeIID,</span>
<a href="#l112.394"></a><span id="l112.394">                                   null,</span>
<a href="#l112.395"></a><span id="l112.395">                                   itemsFound.length,</span>
<a href="#l112.396"></a><span id="l112.396">                                   itemsFound);</span>
<a href="#l112.397"></a><span id="l112.397">             this.notifyOperationComplete(aListener,</span>
<a href="#l112.398"></a><span id="l112.398" class="difflineminus">-                                         Components.results.NS_OK,</span>
<a href="#l112.399"></a><span id="l112.399" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l112.400"></a><span id="l112.400" class="difflineplus">+                                         Cr.NS_OK,</span>
<a href="#l112.401"></a><span id="l112.401" class="difflineplus">+                                         Ci.calIOperationListener.GET,</span>
<a href="#l112.402"></a><span id="l112.402">                                          null,</span>
<a href="#l112.403"></a><span id="l112.403">                                          null);</span>
<a href="#l112.404"></a><span id="l112.404">         });</span>
<a href="#l112.405"></a><span id="l112.405">     },</span>
<a href="#l112.406"></a><span id="l112.406"> </span>
<a href="#l112.407"></a><span id="l112.407">     //</span>
<a href="#l112.408"></a><span id="l112.408">     // calIOfflineStorage interface</span>
<a href="#l112.409"></a><span id="l112.409">     //</span>
<a href="#l112.410"></a><span id="l112.410">     addOfflineItem: function(aItem, aListener) {</span>
<a href="#l112.411"></a><span id="l112.411">         this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l112.412"></a><span id="l112.412">         this.notifyOperationComplete(aListener,</span>
<a href="#l112.413"></a><span id="l112.413" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l112.414"></a><span id="l112.414" class="difflineminus">-                                     Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l112.415"></a><span id="l112.415" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l112.416"></a><span id="l112.416" class="difflineplus">+                                     Ci.calIOperationListener.ADD,</span>
<a href="#l112.417"></a><span id="l112.417">                                      aItem.id,</span>
<a href="#l112.418"></a><span id="l112.418">                                      aItem);</span>
<a href="#l112.419"></a><span id="l112.419">     },</span>
<a href="#l112.420"></a><span id="l112.420"> </span>
<a href="#l112.421"></a><span id="l112.421">     modifyOfflineItem: function(aItem, aListener) {</span>
<a href="#l112.422"></a><span id="l112.422">         let oldFlag = this.mOfflineFlags[aItem.id];</span>
<a href="#l112.423"></a><span id="l112.423">         if (oldFlag != cICL.OFFLINE_FLAG_CREATED_RECORD &amp;&amp;</span>
<a href="#l112.424"></a><span id="l112.424">             oldFlag != cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l112.425"></a><span id="l112.425">             this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l112.426"></a><span id="l112.426">         }</span>
<a href="#l112.427"></a><span id="l112.427"> </span>
<a href="#l112.428"></a><span id="l112.428">         this.notifyOperationComplete(aListener,</span>
<a href="#l112.429"></a><span id="l112.429" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l112.430"></a><span id="l112.430" class="difflineminus">-                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l112.431"></a><span id="l112.431" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l112.432"></a><span id="l112.432" class="difflineplus">+                                     Ci.calIOperationListener.MODIFY,</span>
<a href="#l112.433"></a><span id="l112.433">                                      aItem.id,</span>
<a href="#l112.434"></a><span id="l112.434">                                      aItem);</span>
<a href="#l112.435"></a><span id="l112.435">     },</span>
<a href="#l112.436"></a><span id="l112.436"> </span>
<a href="#l112.437"></a><span id="l112.437">     deleteOfflineItem: function(aItem, aListener) {</span>
<a href="#l112.438"></a><span id="l112.438">         let oldFlag = this.mOfflineFlags[aItem.id];</span>
<a href="#l112.439"></a><span id="l112.439">         if (oldFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l112.440"></a><span id="l112.440">             delete this.mItems[aItem.id];</span>
<a href="#l112.441"></a><span id="l112.441">             delete this.mOfflineFlags[aItem.id];</span>
<a href="#l112.442"></a><span id="l112.442">         } else {</span>
<a href="#l112.443"></a><span id="l112.443">             this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l112.444"></a><span id="l112.444">         }</span>
<a href="#l112.445"></a><span id="l112.445"> </span>
<a href="#l112.446"></a><span id="l112.446">         this.notifyOperationComplete(aListener,</span>
<a href="#l112.447"></a><span id="l112.447" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l112.448"></a><span id="l112.448" class="difflineminus">-                                     Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l112.449"></a><span id="l112.449" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l112.450"></a><span id="l112.450" class="difflineplus">+                                     Ci.calIOperationListener.DELETE,</span>
<a href="#l112.451"></a><span id="l112.451">                                      aItem.id,</span>
<a href="#l112.452"></a><span id="l112.452">                                      aItem);</span>
<a href="#l112.453"></a><span id="l112.453">         // notify observers</span>
<a href="#l112.454"></a><span id="l112.454">         this.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l112.455"></a><span id="l112.455">     },</span>
<a href="#l112.456"></a><span id="l112.456"> </span>
<a href="#l112.457"></a><span id="l112.457">     getItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l112.458"></a><span id="l112.458">         let flag = (aItem &amp;&amp; aItem.id in this.mOfflineFlags ? this.mOfflineFlags[aItem.id] : null);</span>
<a href="#l112.459"></a><span id="l112.459" class="difflineminus">-        this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l112.460"></a><span id="l112.460" class="difflineminus">-                                     Components.interfaces.calIOperationListener.GET,</span>
<a href="#l112.461"></a><span id="l112.461" class="difflineplus">+        this.notifyOperationComplete(aListener, Cr.NS_OK,</span>
<a href="#l112.462"></a><span id="l112.462" class="difflineplus">+                                     Ci.calIOperationListener.GET,</span>
<a href="#l112.463"></a><span id="l112.463">                                      null, flag);</span>
<a href="#l112.464"></a><span id="l112.464">     },</span>
<a href="#l112.465"></a><span id="l112.465"> </span>
<a href="#l112.466"></a><span id="l112.466">     resetItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l112.467"></a><span id="l112.467">         delete this.mOfflineFlags[aItem.id];</span>
<a href="#l112.468"></a><span id="l112.468" class="difflineminus">-        this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l112.469"></a><span id="l112.469" class="difflineminus">-                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l112.470"></a><span id="l112.470" class="difflineplus">+        this.notifyOperationComplete(aListener, Cr.NS_OK,</span>
<a href="#l112.471"></a><span id="l112.471" class="difflineplus">+                                     Ci.calIOperationListener.MODIFY,</span>
<a href="#l112.472"></a><span id="l112.472">                                      aItem.id, aItem);</span>
<a href="#l112.473"></a><span id="l112.473">     },</span>
<a href="#l112.474"></a><span id="l112.474"> </span>
<a href="#l112.475"></a><span id="l112.475">     //</span>
<a href="#l112.476"></a><span id="l112.476">     // calISyncWriteCalendar interface</span>
<a href="#l112.477"></a><span id="l112.477">     //</span>
<a href="#l112.478"></a><span id="l112.478">     setMetaData: function(id, value) {</span>
<a href="#l112.479"></a><span id="l112.479">         this.mMetaData.set(id, value);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l113.1"></a><span id="l113.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l113.2"></a><span id="l113.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l113.3"></a><span id="l113.3" class="difflineat">@@ -9,36 +9,36 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l113.4"></a><span id="l113.4"> const {</span>
<a href="#l113.5"></a><span id="l113.5">     DB_SCHEMA_VERSION,</span>
<a href="#l113.6"></a><span id="l113.6">     getSqlTable,</span>
<a href="#l113.7"></a><span id="l113.7">     upgradeDB</span>
<a href="#l113.8"></a><span id="l113.8"> } = ChromeUtils.import(&quot;resource://calendar/modules/calStorageUpgrade.jsm&quot;, null);</span>
<a href="#l113.9"></a><span id="l113.9"> const { CAL_ITEM_FLAG, newDateTime } = ChromeUtils.import(&quot;resource://calendar/modules/calStorageHelpers.jsm&quot;, null);</span>
<a href="#l113.10"></a><span id="l113.10"> </span>
<a href="#l113.11"></a><span id="l113.11"> var USECS_PER_SECOND = 1000000;</span>
<a href="#l113.12"></a><span id="l113.12" class="difflineminus">-var kCalICalendar = Components.interfaces.calICalendar;</span>
<a href="#l113.13"></a><span id="l113.13" class="difflineminus">-var cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l113.14"></a><span id="l113.14" class="difflineplus">+var kCalICalendar = Ci.calICalendar;</span>
<a href="#l113.15"></a><span id="l113.15" class="difflineplus">+var cICL = Ci.calIChangeLog;</span>
<a href="#l113.16"></a><span id="l113.16"> </span>
<a href="#l113.17"></a><span id="l113.17"> //</span>
<a href="#l113.18"></a><span id="l113.18"> // calStorageCalendar</span>
<a href="#l113.19"></a><span id="l113.19"> //</span>
<a href="#l113.20"></a><span id="l113.20"> </span>
<a href="#l113.21"></a><span id="l113.21"> function calStorageCalendar() {</span>
<a href="#l113.22"></a><span id="l113.22">     this.initProviderBase();</span>
<a href="#l113.23"></a><span id="l113.23">     this.mItemCache = {};</span>
<a href="#l113.24"></a><span id="l113.24">     this.mRecEventCache = {};</span>
<a href="#l113.25"></a><span id="l113.25">     this.mRecTodoCache = {};</span>
<a href="#l113.26"></a><span id="l113.26"> }</span>
<a href="#l113.27"></a><span id="l113.27"> var calStorageCalendarClassID = Components.ID(&quot;{b3eaa1c4-5dfe-4c0a-b62a-b3a514218461}&quot;);</span>
<a href="#l113.28"></a><span id="l113.28"> var calStorageCalendarInterfaces = [</span>
<a href="#l113.29"></a><span id="l113.29" class="difflineminus">-    Components.interfaces.calICalendar,</span>
<a href="#l113.30"></a><span id="l113.30" class="difflineminus">-    Components.interfaces.calICalendarProvider,</span>
<a href="#l113.31"></a><span id="l113.31" class="difflineminus">-    Components.interfaces.calIOfflineStorage,</span>
<a href="#l113.32"></a><span id="l113.32" class="difflineminus">-    Components.interfaces.calISchedulingSupport,</span>
<a href="#l113.33"></a><span id="l113.33" class="difflineminus">-    Components.interfaces.calISyncWriteCalendar,</span>
<a href="#l113.34"></a><span id="l113.34" class="difflineplus">+    Ci.calICalendar,</span>
<a href="#l113.35"></a><span id="l113.35" class="difflineplus">+    Ci.calICalendarProvider,</span>
<a href="#l113.36"></a><span id="l113.36" class="difflineplus">+    Ci.calIOfflineStorage,</span>
<a href="#l113.37"></a><span id="l113.37" class="difflineplus">+    Ci.calISchedulingSupport,</span>
<a href="#l113.38"></a><span id="l113.38" class="difflineplus">+    Ci.calISyncWriteCalendar,</span>
<a href="#l113.39"></a><span id="l113.39"> ];</span>
<a href="#l113.40"></a><span id="l113.40"> calStorageCalendar.prototype = {</span>
<a href="#l113.41"></a><span id="l113.41">     __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l113.42"></a><span id="l113.42">     classID: calStorageCalendarClassID,</span>
<a href="#l113.43"></a><span id="l113.43">     QueryInterface: cal.generateQI(calStorageCalendarInterfaces),</span>
<a href="#l113.44"></a><span id="l113.44">     classInfo: cal.generateCI({</span>
<a href="#l113.45"></a><span id="l113.45">         classID: calStorageCalendarClassID,</span>
<a href="#l113.46"></a><span id="l113.46">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=storage&quot;,</span>
<a href="#l113.47"></a><span id="l113.47" class="difflineat">@@ -114,17 +114,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.48"></a><span id="l113.48">             this.prepareStatement(this.mDeleteAllMetaData);</span>
<a href="#l113.49"></a><span id="l113.49">             this.mDeleteAllMetaData.executeStep();</span>
<a href="#l113.50"></a><span id="l113.50">         } finally {</span>
<a href="#l113.51"></a><span id="l113.51">             this.mDeleteAllMetaData.reset();</span>
<a href="#l113.52"></a><span id="l113.52">         }</span>
<a href="#l113.53"></a><span id="l113.53"> </span>
<a href="#l113.54"></a><span id="l113.54">         try {</span>
<a href="#l113.55"></a><span id="l113.55">             if (listener) {</span>
<a href="#l113.56"></a><span id="l113.56" class="difflineminus">-                listener.onDeleteCalendar(aCalendar, Components.results.NS_OK, null);</span>
<a href="#l113.57"></a><span id="l113.57" class="difflineplus">+                listener.onDeleteCalendar(aCalendar, Cr.NS_OK, null);</span>
<a href="#l113.58"></a><span id="l113.58">             }</span>
<a href="#l113.59"></a><span id="l113.59">         } catch (ex) {</span>
<a href="#l113.60"></a><span id="l113.60">             this.logError(&quot;error calling listener.onDeleteCalendar&quot;, ex);</span>
<a href="#l113.61"></a><span id="l113.61">         }</span>
<a href="#l113.62"></a><span id="l113.62">     },</span>
<a href="#l113.63"></a><span id="l113.63"> </span>
<a href="#l113.64"></a><span id="l113.64">     mRelaxedMode: undefined,</span>
<a href="#l113.65"></a><span id="l113.65">     get relaxedMode() {</span>
<a href="#l113.66"></a><span id="l113.66" class="difflineat">@@ -169,17 +169,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.67"></a><span id="l113.67"> </span>
<a href="#l113.68"></a><span id="l113.68">     // attribute nsIURI uri;</span>
<a href="#l113.69"></a><span id="l113.69">     get uri() {</span>
<a href="#l113.70"></a><span id="l113.70">         return this.__proto__.__proto__.__lookupGetter__(&quot;uri&quot;).call(this);</span>
<a href="#l113.71"></a><span id="l113.71">     },</span>
<a href="#l113.72"></a><span id="l113.72">     set uri(aUri) {</span>
<a href="#l113.73"></a><span id="l113.73">         // We can only load once</span>
<a href="#l113.74"></a><span id="l113.74">         if (this.uri) {</span>
<a href="#l113.75"></a><span id="l113.75" class="difflineminus">-            throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l113.76"></a><span id="l113.76" class="difflineplus">+            throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l113.77"></a><span id="l113.77">         }</span>
<a href="#l113.78"></a><span id="l113.78"> </span>
<a href="#l113.79"></a><span id="l113.79">         let uri = this.__proto__.__proto__.__lookupSetter__(&quot;uri&quot;).call(this, aUri);</span>
<a href="#l113.80"></a><span id="l113.80"> </span>
<a href="#l113.81"></a><span id="l113.81">         if (!this.mDB &amp;&amp; this.uri &amp;&amp; this.id) {</span>
<a href="#l113.82"></a><span id="l113.82">             // Prepare the database as soon as we have an id and an uri.</span>
<a href="#l113.83"></a><span id="l113.83">             this.prepareInitDB();</span>
<a href="#l113.84"></a><span id="l113.84">         }</span>
<a href="#l113.85"></a><span id="l113.85" class="difflineat">@@ -188,39 +188,39 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.86"></a><span id="l113.86">     },</span>
<a href="#l113.87"></a><span id="l113.87"> </span>
<a href="#l113.88"></a><span id="l113.88">     /**</span>
<a href="#l113.89"></a><span id="l113.89">      * Initialize the Database. This should only be called from the uri or id</span>
<a href="#l113.90"></a><span id="l113.90">      * setter and requires those two attributes to be set.</span>
<a href="#l113.91"></a><span id="l113.91">      */</span>
<a href="#l113.92"></a><span id="l113.92">     prepareInitDB: function() {</span>
<a href="#l113.93"></a><span id="l113.93">         if (this.uri.schemeIs(&quot;file&quot;)) {</span>
<a href="#l113.94"></a><span id="l113.94" class="difflineminus">-            let fileURL = this.uri.QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l113.95"></a><span id="l113.95" class="difflineplus">+            let fileURL = this.uri.QueryInterface(Ci.nsIFileURL);</span>
<a href="#l113.96"></a><span id="l113.96">             if (!fileURL) {</span>
<a href="#l113.97"></a><span id="l113.97" class="difflineminus">-                throw new Components.Exception(&quot;Invalid file&quot;, Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l113.98"></a><span id="l113.98" class="difflineplus">+                throw new Components.Exception(&quot;Invalid file&quot;, Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l113.99"></a><span id="l113.99">             }</span>
<a href="#l113.100"></a><span id="l113.100">             // open the database</span>
<a href="#l113.101"></a><span id="l113.101">             this.mDB = Services.storage.openDatabase(fileURL.file);</span>
<a href="#l113.102"></a><span id="l113.102">             this.mDB.executeSimpleSQL(&quot;PRAGMA journal_mode=WAL&quot;);</span>
<a href="#l113.103"></a><span id="l113.103">             upgradeDB(this.mDB);</span>
<a href="#l113.104"></a><span id="l113.104">         } else if (this.uri.schemeIs(&quot;moz-profile-calendar&quot;)) {</span>
<a href="#l113.105"></a><span id="l113.105">             // This is an old-style moz-profile-calendar. It requires some</span>
<a href="#l113.106"></a><span id="l113.106">             // migration steps.</span>
<a href="#l113.107"></a><span id="l113.107"> </span>
<a href="#l113.108"></a><span id="l113.108">             let localDB = cal.provider.getCalendarDirectory();</span>
<a href="#l113.109"></a><span id="l113.109">             localDB.append(&quot;local.sqlite&quot;);</span>
<a href="#l113.110"></a><span id="l113.110">             localDB = Services.storage.openDatabase(localDB);</span>
<a href="#l113.111"></a><span id="l113.111" class="difflineminus">-            localDB.defaultTransactionType = Components.interfaces.mozIStorageConnection.TRANSACTION_EXCLUSIVE;</span>
<a href="#l113.112"></a><span id="l113.112" class="difflineplus">+            localDB.defaultTransactionType = Ci.mozIStorageConnection.TRANSACTION_EXCLUSIVE;</span>
<a href="#l113.113"></a><span id="l113.113"> </span>
<a href="#l113.114"></a><span id="l113.114">             // First, we need to check if this is from 0.9, i.e we need to</span>
<a href="#l113.115"></a><span id="l113.115">             // migrate from storage.sdb to local.sqlite.</span>
<a href="#l113.116"></a><span id="l113.116" class="difflineminus">-            let storageSdb = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l113.117"></a><span id="l113.117" class="difflineplus">+            let storageSdb = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l113.118"></a><span id="l113.118">             storageSdb.append(&quot;storage.sdb&quot;);</span>
<a href="#l113.119"></a><span id="l113.119">             this.mDB = Services.storage.openDatabase(storageSdb);</span>
<a href="#l113.120"></a><span id="l113.120" class="difflineminus">-            this.mDB.defaultTransactionType = Components.interfaces.mozIStorageConnection.TRANSACTION_EXCLUSIVE;</span>
<a href="#l113.121"></a><span id="l113.121" class="difflineplus">+            this.mDB.defaultTransactionType = Ci.mozIStorageConnection.TRANSACTION_EXCLUSIVE;</span>
<a href="#l113.122"></a><span id="l113.122">             if (this.mDB.tableExists(&quot;cal_events&quot;)) {</span>
<a href="#l113.123"></a><span id="l113.123">                 cal.LOG(&quot;[calStorageCalendar] Migrating storage.sdb -&gt; local.sqlite&quot;);</span>
<a href="#l113.124"></a><span id="l113.124">                 upgradeDB(this.mDB); // upgrade schema before migating data</span>
<a href="#l113.125"></a><span id="l113.125"> </span>
<a href="#l113.126"></a><span id="l113.126">                 let attachStatement;</span>
<a href="#l113.127"></a><span id="l113.127">                 try {</span>
<a href="#l113.128"></a><span id="l113.128">                     attachStatement = this.mDB.createStatement(&quot;ATTACH DATABASE :file_path AS local_sqlite&quot;);</span>
<a href="#l113.129"></a><span id="l113.129">                     attachStatement.params.file_path = localDB.databaseFile.path;</span>
<a href="#l113.130"></a><span id="l113.130" class="difflineat">@@ -415,36 +415,36 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.131"></a><span id="l113.131">         let newItem = aItem.clone();</span>
<a href="#l113.132"></a><span id="l113.132">         return this.adoptItem(newItem, aListener);</span>
<a href="#l113.133"></a><span id="l113.133">     },</span>
<a href="#l113.134"></a><span id="l113.134"> </span>
<a href="#l113.135"></a><span id="l113.135">     // void adoptItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l113.136"></a><span id="l113.136">     adoptItem: function(aItem, aListener) {</span>
<a href="#l113.137"></a><span id="l113.137">         if (this.readOnly) {</span>
<a href="#l113.138"></a><span id="l113.138">             this.notifyOperationComplete(aListener,</span>
<a href="#l113.139"></a><span id="l113.139" class="difflineminus">-                                         Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l113.140"></a><span id="l113.140" class="difflineminus">-                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l113.141"></a><span id="l113.141" class="difflineplus">+                                         Ci.calIErrors.CAL_IS_READONLY,</span>
<a href="#l113.142"></a><span id="l113.142" class="difflineplus">+                                         Ci.calIOperationListener.ADD,</span>
<a href="#l113.143"></a><span id="l113.143">                                          null,</span>
<a href="#l113.144"></a><span id="l113.144">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l113.145"></a><span id="l113.145">             return;</span>
<a href="#l113.146"></a><span id="l113.146">         }</span>
<a href="#l113.147"></a><span id="l113.147"> </span>
<a href="#l113.148"></a><span id="l113.148">         if (aItem.id == null) {</span>
<a href="#l113.149"></a><span id="l113.149">             // is this an error?  Or should we generate an IID?</span>
<a href="#l113.150"></a><span id="l113.150">             aItem.id = cal.getUUID();</span>
<a href="#l113.151"></a><span id="l113.151">         } else {</span>
<a href="#l113.152"></a><span id="l113.152">             let olditem = this.getItemById(aItem.id);</span>
<a href="#l113.153"></a><span id="l113.153">             if (olditem) {</span>
<a href="#l113.154"></a><span id="l113.154">                 if (this.relaxedMode) {</span>
<a href="#l113.155"></a><span id="l113.155">                     // we possibly want to interact with the user before deleting</span>
<a href="#l113.156"></a><span id="l113.156">                     this.deleteItemById(aItem.id, true);</span>
<a href="#l113.157"></a><span id="l113.157">                 } else {</span>
<a href="#l113.158"></a><span id="l113.158">                     this.notifyOperationComplete(aListener,</span>
<a href="#l113.159"></a><span id="l113.159" class="difflineminus">-                                                 Components.interfaces.calIErrors.DUPLICATE_ID,</span>
<a href="#l113.160"></a><span id="l113.160" class="difflineminus">-                                                 Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l113.161"></a><span id="l113.161" class="difflineplus">+                                                 Ci.calIErrors.DUPLICATE_ID,</span>
<a href="#l113.162"></a><span id="l113.162" class="difflineplus">+                                                 Ci.calIOperationListener.ADD,</span>
<a href="#l113.163"></a><span id="l113.163">                                                  aItem.id,</span>
<a href="#l113.164"></a><span id="l113.164">                                                  &quot;ID already exists for addItem&quot;);</span>
<a href="#l113.165"></a><span id="l113.165">                     return;</span>
<a href="#l113.166"></a><span id="l113.166">                 }</span>
<a href="#l113.167"></a><span id="l113.167">             }</span>
<a href="#l113.168"></a><span id="l113.168">         }</span>
<a href="#l113.169"></a><span id="l113.169"> </span>
<a href="#l113.170"></a><span id="l113.170">         let parentItem = aItem.parentItem;</span>
<a href="#l113.171"></a><span id="l113.171" class="difflineat">@@ -454,18 +454,18 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.172"></a><span id="l113.172">         }</span>
<a href="#l113.173"></a><span id="l113.173">         parentItem.calendar = this.superCalendar;</span>
<a href="#l113.174"></a><span id="l113.174">         parentItem.makeImmutable();</span>
<a href="#l113.175"></a><span id="l113.175"> </span>
<a href="#l113.176"></a><span id="l113.176">         this.flushItem(parentItem, null);</span>
<a href="#l113.177"></a><span id="l113.177"> </span>
<a href="#l113.178"></a><span id="l113.178">         // notify the listener</span>
<a href="#l113.179"></a><span id="l113.179">         this.notifyOperationComplete(aListener,</span>
<a href="#l113.180"></a><span id="l113.180" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l113.181"></a><span id="l113.181" class="difflineminus">-                                     Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l113.182"></a><span id="l113.182" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l113.183"></a><span id="l113.183" class="difflineplus">+                                     Ci.calIOperationListener.ADD,</span>
<a href="#l113.184"></a><span id="l113.184">                                      aItem.id,</span>
<a href="#l113.185"></a><span id="l113.185">                                      aItem);</span>
<a href="#l113.186"></a><span id="l113.186"> </span>
<a href="#l113.187"></a><span id="l113.187">         // notify observers</span>
<a href="#l113.188"></a><span id="l113.188">         this.observers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l113.189"></a><span id="l113.189">     },</span>
<a href="#l113.190"></a><span id="l113.190"> </span>
<a href="#l113.191"></a><span id="l113.191">     // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l113.192"></a><span id="l113.192" class="difflineat">@@ -484,31 +484,31 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.193"></a><span id="l113.193">         };</span>
<a href="#l113.194"></a><span id="l113.194">         this.getItemOfflineFlag(aOldItem, offlineJournalFlagListener);</span>
<a href="#l113.195"></a><span id="l113.195">     },</span>
<a href="#l113.196"></a><span id="l113.196"> </span>
<a href="#l113.197"></a><span id="l113.197">     doModifyItem: function(aNewItem, aOldItem, aListener, offlineFlag) {</span>
<a href="#l113.198"></a><span id="l113.198">         let oldOfflineFlag = offlineFlag;</span>
<a href="#l113.199"></a><span id="l113.199">         if (this.readOnly) {</span>
<a href="#l113.200"></a><span id="l113.200">             this.notifyOperationComplete(aListener,</span>
<a href="#l113.201"></a><span id="l113.201" class="difflineminus">-                                         Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l113.202"></a><span id="l113.202" class="difflineminus">-                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l113.203"></a><span id="l113.203" class="difflineplus">+                                         Ci.calIErrors.CAL_IS_READONLY,</span>
<a href="#l113.204"></a><span id="l113.204" class="difflineplus">+                                         Ci.calIOperationListener.MODIFY,</span>
<a href="#l113.205"></a><span id="l113.205">                                          null,</span>
<a href="#l113.206"></a><span id="l113.206">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l113.207"></a><span id="l113.207">             return null;</span>
<a href="#l113.208"></a><span id="l113.208">         }</span>
<a href="#l113.209"></a><span id="l113.209">         if (!aNewItem) {</span>
<a href="#l113.210"></a><span id="l113.210" class="difflineminus">-            throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l113.211"></a><span id="l113.211" class="difflineplus">+            throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l113.212"></a><span id="l113.212">         }</span>
<a href="#l113.213"></a><span id="l113.213"> </span>
<a href="#l113.214"></a><span id="l113.214">         let self = this;</span>
<a href="#l113.215"></a><span id="l113.215">         function reportError(errStr, errId) {</span>
<a href="#l113.216"></a><span id="l113.216">             self.notifyOperationComplete(aListener,</span>
<a href="#l113.217"></a><span id="l113.217" class="difflineminus">-                                         errId ? errId : Components.results.NS_ERROR_FAILURE,</span>
<a href="#l113.218"></a><span id="l113.218" class="difflineminus">-                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l113.219"></a><span id="l113.219" class="difflineplus">+                                         errId ? errId : Cr.NS_ERROR_FAILURE,</span>
<a href="#l113.220"></a><span id="l113.220" class="difflineplus">+                                         Ci.calIOperationListener.MODIFY,</span>
<a href="#l113.221"></a><span id="l113.221">                                          aNewItem.id,</span>
<a href="#l113.222"></a><span id="l113.222">                                          errStr);</span>
<a href="#l113.223"></a><span id="l113.223">             return null;</span>
<a href="#l113.224"></a><span id="l113.224">         }</span>
<a href="#l113.225"></a><span id="l113.225"> </span>
<a href="#l113.226"></a><span id="l113.226">         if (aNewItem.id == null) {</span>
<a href="#l113.227"></a><span id="l113.227">             // this is definitely an error</span>
<a href="#l113.228"></a><span id="l113.228">             return reportError(&quot;ID for modifyItem item is null&quot;);</span>
<a href="#l113.229"></a><span id="l113.229" class="difflineat">@@ -565,57 +565,57 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.230"></a><span id="l113.230">             }</span>
<a href="#l113.231"></a><span id="l113.231">         }</span>
<a href="#l113.232"></a><span id="l113.232"> </span>
<a href="#l113.233"></a><span id="l113.233">         modifiedItem.makeImmutable();</span>
<a href="#l113.234"></a><span id="l113.234">         this.flushItem(modifiedItem, aOldItem);</span>
<a href="#l113.235"></a><span id="l113.235">         this.setOfflineJournalFlag(aNewItem, oldOfflineFlag);</span>
<a href="#l113.236"></a><span id="l113.236"> </span>
<a href="#l113.237"></a><span id="l113.237">         this.notifyOperationComplete(aListener,</span>
<a href="#l113.238"></a><span id="l113.238" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l113.239"></a><span id="l113.239" class="difflineminus">-                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l113.240"></a><span id="l113.240" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l113.241"></a><span id="l113.241" class="difflineplus">+                                     Ci.calIOperationListener.MODIFY,</span>
<a href="#l113.242"></a><span id="l113.242">                                      modifiedItem.id,</span>
<a href="#l113.243"></a><span id="l113.243">                                      modifiedItem);</span>
<a href="#l113.244"></a><span id="l113.244"> </span>
<a href="#l113.245"></a><span id="l113.245">         // notify observers</span>
<a href="#l113.246"></a><span id="l113.246">         this.observers.notify(&quot;onModifyItem&quot;, [modifiedItem, aOldItem]);</span>
<a href="#l113.247"></a><span id="l113.247">         return null;</span>
<a href="#l113.248"></a><span id="l113.248">     },</span>
<a href="#l113.249"></a><span id="l113.249"> </span>
<a href="#l113.250"></a><span id="l113.250">     // void deleteItem( in string id, in calIOperationListener aListener );</span>
<a href="#l113.251"></a><span id="l113.251">     deleteItem: function(aItem, aListener) {</span>
<a href="#l113.252"></a><span id="l113.252">         if (this.readOnly) {</span>
<a href="#l113.253"></a><span id="l113.253">             this.notifyOperationComplete(aListener,</span>
<a href="#l113.254"></a><span id="l113.254" class="difflineminus">-                                         Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l113.255"></a><span id="l113.255" class="difflineminus">-                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l113.256"></a><span id="l113.256" class="difflineplus">+                                         Ci.calIErrors.CAL_IS_READONLY,</span>
<a href="#l113.257"></a><span id="l113.257" class="difflineplus">+                                         Ci.calIOperationListener.DELETE,</span>
<a href="#l113.258"></a><span id="l113.258">                                          null,</span>
<a href="#l113.259"></a><span id="l113.259">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l113.260"></a><span id="l113.260">             return;</span>
<a href="#l113.261"></a><span id="l113.261">         }</span>
<a href="#l113.262"></a><span id="l113.262">         if (aItem.parentItem != aItem) {</span>
<a href="#l113.263"></a><span id="l113.263">             aItem.parentItem.recurrenceInfo.removeExceptionFor(aItem.recurrenceId);</span>
<a href="#l113.264"></a><span id="l113.264">             // xxx todo: would we want to support this case? Removing an occurrence currently results</span>
<a href="#l113.265"></a><span id="l113.265">             //           in a modifyItem(parent)</span>
<a href="#l113.266"></a><span id="l113.266">             return;</span>
<a href="#l113.267"></a><span id="l113.267">         }</span>
<a href="#l113.268"></a><span id="l113.268"> </span>
<a href="#l113.269"></a><span id="l113.269">         if (aItem.id == null) {</span>
<a href="#l113.270"></a><span id="l113.270">             this.notifyOperationComplete(aListener,</span>
<a href="#l113.271"></a><span id="l113.271" class="difflineminus">-                                         Components.results.NS_ERROR_FAILURE,</span>
<a href="#l113.272"></a><span id="l113.272" class="difflineminus">-                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l113.273"></a><span id="l113.273" class="difflineplus">+                                         Cr.NS_ERROR_FAILURE,</span>
<a href="#l113.274"></a><span id="l113.274" class="difflineplus">+                                         Ci.calIOperationListener.DELETE,</span>
<a href="#l113.275"></a><span id="l113.275">                                          null,</span>
<a href="#l113.276"></a><span id="l113.276">                                          &quot;ID is null for deleteItem&quot;);</span>
<a href="#l113.277"></a><span id="l113.277">             return;</span>
<a href="#l113.278"></a><span id="l113.278">         }</span>
<a href="#l113.279"></a><span id="l113.279"> </span>
<a href="#l113.280"></a><span id="l113.280">         this.deleteItemById(aItem.id);</span>
<a href="#l113.281"></a><span id="l113.281"> </span>
<a href="#l113.282"></a><span id="l113.282">         this.notifyOperationComplete(aListener,</span>
<a href="#l113.283"></a><span id="l113.283" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l113.284"></a><span id="l113.284" class="difflineminus">-                                     Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l113.285"></a><span id="l113.285" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l113.286"></a><span id="l113.286" class="difflineplus">+                                     Ci.calIOperationListener.DELETE,</span>
<a href="#l113.287"></a><span id="l113.287">                                      aItem.id,</span>
<a href="#l113.288"></a><span id="l113.288">                                      aItem);</span>
<a href="#l113.289"></a><span id="l113.289"> </span>
<a href="#l113.290"></a><span id="l113.290">         // notify observers</span>
<a href="#l113.291"></a><span id="l113.291">         this.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l113.292"></a><span id="l113.292">     },</span>
<a href="#l113.293"></a><span id="l113.293"> </span>
<a href="#l113.294"></a><span id="l113.294">     // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l113.295"></a><span id="l113.295" class="difflineat">@@ -623,45 +623,45 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.296"></a><span id="l113.296">         if (!aListener) {</span>
<a href="#l113.297"></a><span id="l113.297">             return;</span>
<a href="#l113.298"></a><span id="l113.298">         }</span>
<a href="#l113.299"></a><span id="l113.299"> </span>
<a href="#l113.300"></a><span id="l113.300">         let item = this.getItemById(aId);</span>
<a href="#l113.301"></a><span id="l113.301">         if (!item) {</span>
<a href="#l113.302"></a><span id="l113.302">             // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l113.303"></a><span id="l113.303">             this.notifyOperationComplete(aListener,</span>
<a href="#l113.304"></a><span id="l113.304" class="difflineminus">-                                         Components.results.NS_OK,</span>
<a href="#l113.305"></a><span id="l113.305" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l113.306"></a><span id="l113.306" class="difflineplus">+                                         Cr.NS_OK,</span>
<a href="#l113.307"></a><span id="l113.307" class="difflineplus">+                                         Ci.calIOperationListener.GET,</span>
<a href="#l113.308"></a><span id="l113.308">                                          aId,</span>
<a href="#l113.309"></a><span id="l113.309">                                          null);</span>
<a href="#l113.310"></a><span id="l113.310">             return;</span>
<a href="#l113.311"></a><span id="l113.311">         }</span>
<a href="#l113.312"></a><span id="l113.312"> </span>
<a href="#l113.313"></a><span id="l113.313">         let item_iid = null;</span>
<a href="#l113.314"></a><span id="l113.314">         if (cal.item.isEvent(item)) {</span>
<a href="#l113.315"></a><span id="l113.315" class="difflineminus">-            item_iid = Components.interfaces.calIEvent;</span>
<a href="#l113.316"></a><span id="l113.316" class="difflineplus">+            item_iid = Ci.calIEvent;</span>
<a href="#l113.317"></a><span id="l113.317">         } else if (cal.item.isToDo(item)) {</span>
<a href="#l113.318"></a><span id="l113.318" class="difflineminus">-            item_iid = Components.interfaces.calITodo;</span>
<a href="#l113.319"></a><span id="l113.319" class="difflineplus">+            item_iid = Ci.calITodo;</span>
<a href="#l113.320"></a><span id="l113.320">         } else {</span>
<a href="#l113.321"></a><span id="l113.321">             this.notifyOperationComplete(aListener,</span>
<a href="#l113.322"></a><span id="l113.322" class="difflineminus">-                                         Components.results.NS_ERROR_FAILURE,</span>
<a href="#l113.323"></a><span id="l113.323" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l113.324"></a><span id="l113.324" class="difflineplus">+                                         Cr.NS_ERROR_FAILURE,</span>
<a href="#l113.325"></a><span id="l113.325" class="difflineplus">+                                         Ci.calIOperationListener.GET,</span>
<a href="#l113.326"></a><span id="l113.326">                                          aId,</span>
<a href="#l113.327"></a><span id="l113.327">                                          &quot;Can't deduce item type based on QI&quot;);</span>
<a href="#l113.328"></a><span id="l113.328">             return;</span>
<a href="#l113.329"></a><span id="l113.329">         }</span>
<a href="#l113.330"></a><span id="l113.330"> </span>
<a href="#l113.331"></a><span id="l113.331">         aListener.onGetResult(this.superCalendar,</span>
<a href="#l113.332"></a><span id="l113.332" class="difflineminus">-                              Components.results.NS_OK,</span>
<a href="#l113.333"></a><span id="l113.333" class="difflineplus">+                              Cr.NS_OK,</span>
<a href="#l113.334"></a><span id="l113.334">                               item_iid, null,</span>
<a href="#l113.335"></a><span id="l113.335">                               1, [item]);</span>
<a href="#l113.336"></a><span id="l113.336"> </span>
<a href="#l113.337"></a><span id="l113.337">         this.notifyOperationComplete(aListener,</span>
<a href="#l113.338"></a><span id="l113.338" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l113.339"></a><span id="l113.339" class="difflineminus">-                                     Components.interfaces.calIOperationListener.GET,</span>
<a href="#l113.340"></a><span id="l113.340" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l113.341"></a><span id="l113.341" class="difflineplus">+                                     Ci.calIOperationListener.GET,</span>
<a href="#l113.342"></a><span id="l113.342">                                      aId,</span>
<a href="#l113.343"></a><span id="l113.343">                                      null);</span>
<a href="#l113.344"></a><span id="l113.344">     },</span>
<a href="#l113.345"></a><span id="l113.345"> </span>
<a href="#l113.346"></a><span id="l113.346">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l113.347"></a><span id="l113.347">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l113.348"></a><span id="l113.348">     //                in calIOperationListener aListener );</span>
<a href="#l113.349"></a><span id="l113.349">     getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l113.350"></a><span id="l113.350" class="difflineat">@@ -685,17 +685,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.351"></a><span id="l113.351">         }</span>
<a href="#l113.352"></a><span id="l113.352">         if (aRangeEnd) {</span>
<a href="#l113.353"></a><span id="l113.353">             endTime = aRangeEnd.nativeTime;</span>
<a href="#l113.354"></a><span id="l113.354">         }</span>
<a href="#l113.355"></a><span id="l113.355"> </span>
<a href="#l113.356"></a><span id="l113.356">         let wantUnrespondedInvitations = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION) != 0);</span>
<a href="#l113.357"></a><span id="l113.357">         let superCal;</span>
<a href="#l113.358"></a><span id="l113.358">         try {</span>
<a href="#l113.359"></a><span id="l113.359" class="difflineminus">-            superCal = this.superCalendar.QueryInterface(Components.interfaces.calISchedulingSupport);</span>
<a href="#l113.360"></a><span id="l113.360" class="difflineplus">+            superCal = this.superCalendar.QueryInterface(Ci.calISchedulingSupport);</span>
<a href="#l113.361"></a><span id="l113.361">         } catch (exc) {</span>
<a href="#l113.362"></a><span id="l113.362">             wantUnrespondedInvitations = false;</span>
<a href="#l113.363"></a><span id="l113.363">         }</span>
<a href="#l113.364"></a><span id="l113.364">         function checkUnrespondedInvitation(item) {</span>
<a href="#l113.365"></a><span id="l113.365">             let att = superCal.getInvitedAttendee(item);</span>
<a href="#l113.366"></a><span id="l113.366">             return (att &amp;&amp; (att.participationStatus == &quot;NEEDS-ACTION&quot;));</span>
<a href="#l113.367"></a><span id="l113.367">         }</span>
<a href="#l113.368"></a><span id="l113.368"> </span>
<a href="#l113.369"></a><span id="l113.369" class="difflineat">@@ -704,18 +704,18 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.370"></a><span id="l113.370">         let asOccurrences = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_CLASS_OCCURRENCES) != 0);</span>
<a href="#l113.371"></a><span id="l113.371">         let wantOfflineDeletedItems = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_OFFLINE_DELETED) != 0);</span>
<a href="#l113.372"></a><span id="l113.372">         let wantOfflineCreatedItems = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_OFFLINE_CREATED) != 0);</span>
<a href="#l113.373"></a><span id="l113.373">         let wantOfflineModifiedItems = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_OFFLINE_MODIFIED) != 0);</span>
<a href="#l113.374"></a><span id="l113.374"> </span>
<a href="#l113.375"></a><span id="l113.375">         if (!wantEvents &amp;&amp; !wantTodos) {</span>
<a href="#l113.376"></a><span id="l113.376">             // nothing to do</span>
<a href="#l113.377"></a><span id="l113.377">             this.notifyOperationComplete(aListener,</span>
<a href="#l113.378"></a><span id="l113.378" class="difflineminus">-                                         Components.results.NS_OK,</span>
<a href="#l113.379"></a><span id="l113.379" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l113.380"></a><span id="l113.380" class="difflineplus">+                                         Cr.NS_OK,</span>
<a href="#l113.381"></a><span id="l113.381" class="difflineplus">+                                         Ci.calIOperationListener.GET,</span>
<a href="#l113.382"></a><span id="l113.382">                                          null,</span>
<a href="#l113.383"></a><span id="l113.383">                                          null);</span>
<a href="#l113.384"></a><span id="l113.384">             return;</span>
<a href="#l113.385"></a><span id="l113.385">         }</span>
<a href="#l113.386"></a><span id="l113.386"> </span>
<a href="#l113.387"></a><span id="l113.387">         // HACK because recurring offline events/todos objects dont have offline_journal information</span>
<a href="#l113.388"></a><span id="l113.388">         // Hence we need to update the mRecEventCacheOfflineFlags and  mRecTodoCacheOfflineFlags hash-tables</span>
<a href="#l113.389"></a><span id="l113.389">         // It can be an expensive operation but is only used in Online Reconciliation mode</span>
<a href="#l113.390"></a><span id="l113.390" class="difflineat">@@ -751,17 +751,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.391"></a><span id="l113.391">             }</span>
<a href="#l113.392"></a><span id="l113.392"> </span>
<a href="#l113.393"></a><span id="l113.393">             if (theItems) {</span>
<a href="#l113.394"></a><span id="l113.394">                 queuedItems = queuedItems.concat(theItems);</span>
<a href="#l113.395"></a><span id="l113.395">             }</span>
<a href="#l113.396"></a><span id="l113.396"> </span>
<a href="#l113.397"></a><span id="l113.397">             if (queuedItems.length != 0 &amp;&amp; (!theItems || queuedItems.length &gt; maxQueueSize)) {</span>
<a href="#l113.398"></a><span id="l113.398">                 aListener.onGetResult(self.superCalendar,</span>
<a href="#l113.399"></a><span id="l113.399" class="difflineminus">-                                      Components.results.NS_OK,</span>
<a href="#l113.400"></a><span id="l113.400" class="difflineplus">+                                      Cr.NS_OK,</span>
<a href="#l113.401"></a><span id="l113.401">                                       queuedItemsIID, null,</span>
<a href="#l113.402"></a><span id="l113.402">                                       queuedItems.length, queuedItems);</span>
<a href="#l113.403"></a><span id="l113.403">                 queuedItems = [];</span>
<a href="#l113.404"></a><span id="l113.404">             }</span>
<a href="#l113.405"></a><span id="l113.405">         }</span>
<a href="#l113.406"></a><span id="l113.406"> </span>
<a href="#l113.407"></a><span id="l113.407">         // helper function to handle converting a row to an item,</span>
<a href="#l113.408"></a><span id="l113.408">         // expanding occurrences, and queue the items for the listener</span>
<a href="#l113.409"></a><span id="l113.409" class="difflineat">@@ -793,18 +793,18 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.410"></a><span id="l113.410">         // check the count and send end if count is exceeded</span>
<a href="#l113.411"></a><span id="l113.411">         function checkCount() {</span>
<a href="#l113.412"></a><span id="l113.412">             if (aCount &amp;&amp; count &gt;= aCount) {</span>
<a href="#l113.413"></a><span id="l113.413">                 // flush queue</span>
<a href="#l113.414"></a><span id="l113.414">                 queueItems(null);</span>
<a href="#l113.415"></a><span id="l113.415"> </span>
<a href="#l113.416"></a><span id="l113.416">                 // send operation complete</span>
<a href="#l113.417"></a><span id="l113.417">                 self.notifyOperationComplete(aListener,</span>
<a href="#l113.418"></a><span id="l113.418" class="difflineminus">-                                             Components.results.NS_OK,</span>
<a href="#l113.419"></a><span id="l113.419" class="difflineminus">-                                             Components.interfaces.calIOperationListener.GET,</span>
<a href="#l113.420"></a><span id="l113.420" class="difflineplus">+                                             Cr.NS_OK,</span>
<a href="#l113.421"></a><span id="l113.421" class="difflineplus">+                                             Ci.calIOperationListener.GET,</span>
<a href="#l113.422"></a><span id="l113.422">                                              null,</span>
<a href="#l113.423"></a><span id="l113.423">                                              null);</span>
<a href="#l113.424"></a><span id="l113.424"> </span>
<a href="#l113.425"></a><span id="l113.425">                 // tell caller we're done</span>
<a href="#l113.426"></a><span id="l113.426">                 return true;</span>
<a href="#l113.427"></a><span id="l113.427">             }</span>
<a href="#l113.428"></a><span id="l113.428"> </span>
<a href="#l113.429"></a><span id="l113.429">             return false;</span>
<a href="#l113.430"></a><span id="l113.430" class="difflineat">@@ -842,31 +842,31 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.431"></a><span id="l113.431">             } catch (e) {</span>
<a href="#l113.432"></a><span id="l113.432">                 this.logError(&quot;Error selecting non recurring events by range!\n&quot;, e);</span>
<a href="#l113.433"></a><span id="l113.433">             } finally {</span>
<a href="#l113.434"></a><span id="l113.434">                 this.mSelectNonRecurringEventsByRange.reset();</span>
<a href="#l113.435"></a><span id="l113.435">             }</span>
<a href="#l113.436"></a><span id="l113.436"> </span>
<a href="#l113.437"></a><span id="l113.437">             // Process the non-recurring events:</span>
<a href="#l113.438"></a><span id="l113.438">             for (let evitem of resultItems) {</span>
<a href="#l113.439"></a><span id="l113.439" class="difflineminus">-                count += handleResultItem(evitem, Components.interfaces.calIEvent);</span>
<a href="#l113.440"></a><span id="l113.440" class="difflineplus">+                count += handleResultItem(evitem, Ci.calIEvent);</span>
<a href="#l113.441"></a><span id="l113.441">                 if (checkCount()) {</span>
<a href="#l113.442"></a><span id="l113.442">                     return;</span>
<a href="#l113.443"></a><span id="l113.443">                 }</span>
<a href="#l113.444"></a><span id="l113.444">             }</span>
<a href="#l113.445"></a><span id="l113.445"> </span>
<a href="#l113.446"></a><span id="l113.446">             // Process the recurring events from the cache</span>
<a href="#l113.447"></a><span id="l113.447">             for (let id in this.mRecEventCache) {</span>
<a href="#l113.448"></a><span id="l113.448">                 let evitem = this.mRecEventCache[id];</span>
<a href="#l113.449"></a><span id="l113.449">                 let cachedJournalFlag = this.mRecEventCacheOfflineFlags[evitem.id] || null;</span>
<a href="#l113.450"></a><span id="l113.450">                 // No need to return flagged unless asked i.e. requestedOfflineJournal == cachedJournalFlag</span>
<a href="#l113.451"></a><span id="l113.451">                 // Return created and modified offline records if requestedOfflineJournal is null alongwith events that have no flag</span>
<a href="#l113.452"></a><span id="l113.452">                 if ((requestedOfflineJournal == null &amp;&amp; cachedJournalFlag != cICL.OFFLINE_FLAG_DELETED_RECORD) ||</span>
<a href="#l113.453"></a><span id="l113.453">                     (requestedOfflineJournal != null &amp;&amp; cachedJournalFlag == requestedOfflineJournal)) {</span>
<a href="#l113.454"></a><span id="l113.454" class="difflineminus">-                    count += handleResultItem(evitem, Components.interfaces.calIEvent);</span>
<a href="#l113.455"></a><span id="l113.455" class="difflineplus">+                    count += handleResultItem(evitem, Ci.calIEvent);</span>
<a href="#l113.456"></a><span id="l113.456">                     if (checkCount()) {</span>
<a href="#l113.457"></a><span id="l113.457">                         return;</span>
<a href="#l113.458"></a><span id="l113.458">                     }</span>
<a href="#l113.459"></a><span id="l113.459">                 }</span>
<a href="#l113.460"></a><span id="l113.460">             }</span>
<a href="#l113.461"></a><span id="l113.461">         }</span>
<a href="#l113.462"></a><span id="l113.462"> </span>
<a href="#l113.463"></a><span id="l113.463">         // if todos are wanted, do them next</span>
<a href="#l113.464"></a><span id="l113.464" class="difflineat">@@ -900,17 +900,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.465"></a><span id="l113.465">             } catch (e) {</span>
<a href="#l113.466"></a><span id="l113.466">                 this.logError(&quot;Error selecting non recurring todos by range&quot;, e);</span>
<a href="#l113.467"></a><span id="l113.467">             } finally {</span>
<a href="#l113.468"></a><span id="l113.468">                 this.mSelectNonRecurringTodosByRange.reset();</span>
<a href="#l113.469"></a><span id="l113.469">             }</span>
<a href="#l113.470"></a><span id="l113.470"> </span>
<a href="#l113.471"></a><span id="l113.471">             // process the non-recurring todos:</span>
<a href="#l113.472"></a><span id="l113.472">             for (let todoitem of resultItems) {</span>
<a href="#l113.473"></a><span id="l113.473" class="difflineminus">-                count += handleResultItem(todoitem, Components.interfaces.calITodo, checkCompleted);</span>
<a href="#l113.474"></a><span id="l113.474" class="difflineplus">+                count += handleResultItem(todoitem, Ci.calITodo, checkCompleted);</span>
<a href="#l113.475"></a><span id="l113.475">                 if (checkCount()) {</span>
<a href="#l113.476"></a><span id="l113.476">                     return;</span>
<a href="#l113.477"></a><span id="l113.477">                 }</span>
<a href="#l113.478"></a><span id="l113.478">             }</span>
<a href="#l113.479"></a><span id="l113.479"> </span>
<a href="#l113.480"></a><span id="l113.480">             // Note: Reading the code, completed *occurrences* seems to be broken, because</span>
<a href="#l113.481"></a><span id="l113.481">             //       only the parent item has been filtered; I fixed that.</span>
<a href="#l113.482"></a><span id="l113.482">             //       Moreover item.todo_complete etc seems to be a leftover...</span>
<a href="#l113.483"></a><span id="l113.483" class="difflineat">@@ -921,69 +921,69 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.484"></a><span id="l113.484">                 let cachedJournalFlag = this.mRecTodoCacheOfflineFlags[todoitem.id] || null;</span>
<a href="#l113.485"></a><span id="l113.485">                 if ((requestedOfflineJournal == null &amp;&amp;</span>
<a href="#l113.486"></a><span id="l113.486">                      (cachedJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD ||</span>
<a href="#l113.487"></a><span id="l113.487">                       cachedJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l113.488"></a><span id="l113.488">                       cachedJournalFlag == null)) ||</span>
<a href="#l113.489"></a><span id="l113.489">                     (requestedOfflineJournal != null &amp;&amp;</span>
<a href="#l113.490"></a><span id="l113.490">                      (cachedJournalFlag == requestedOfflineJournal))) {</span>
<a href="#l113.491"></a><span id="l113.491">                     count += handleResultItem(todoitem,</span>
<a href="#l113.492"></a><span id="l113.492" class="difflineminus">-                                              Components.interfaces.calITodo,</span>
<a href="#l113.493"></a><span id="l113.493" class="difflineplus">+                                              Ci.calITodo,</span>
<a href="#l113.494"></a><span id="l113.494">                                               checkCompleted);</span>
<a href="#l113.495"></a><span id="l113.495">                     if (checkCount()) {</span>
<a href="#l113.496"></a><span id="l113.496">                         return;</span>
<a href="#l113.497"></a><span id="l113.497">                     }</span>
<a href="#l113.498"></a><span id="l113.498">                 }</span>
<a href="#l113.499"></a><span id="l113.499">             }</span>
<a href="#l113.500"></a><span id="l113.500">         }</span>
<a href="#l113.501"></a><span id="l113.501"> </span>
<a href="#l113.502"></a><span id="l113.502">         // flush the queue</span>
<a href="#l113.503"></a><span id="l113.503">         queueItems(null);</span>
<a href="#l113.504"></a><span id="l113.504"> </span>
<a href="#l113.505"></a><span id="l113.505">         // and finish</span>
<a href="#l113.506"></a><span id="l113.506">         this.notifyOperationComplete(aListener,</span>
<a href="#l113.507"></a><span id="l113.507" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l113.508"></a><span id="l113.508" class="difflineminus">-                                     Components.interfaces.calIOperationListener.GET,</span>
<a href="#l113.509"></a><span id="l113.509" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l113.510"></a><span id="l113.510" class="difflineplus">+                                     Ci.calIOperationListener.GET,</span>
<a href="#l113.511"></a><span id="l113.511">                                      null,</span>
<a href="#l113.512"></a><span id="l113.512">                                      null);</span>
<a href="#l113.513"></a><span id="l113.513">     },</span>
<a href="#l113.514"></a><span id="l113.514"> </span>
<a href="#l113.515"></a><span id="l113.515">     getItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l113.516"></a><span id="l113.516">         let flag = null;</span>
<a href="#l113.517"></a><span id="l113.517">         if (aItem) {</span>
<a href="#l113.518"></a><span id="l113.518">             let aID = aItem.id;</span>
<a href="#l113.519"></a><span id="l113.519">             let self = this;</span>
<a href="#l113.520"></a><span id="l113.520">             let listener = {</span>
<a href="#l113.521"></a><span id="l113.521">                 handleResult: function(aResultSet) {</span>
<a href="#l113.522"></a><span id="l113.522">                     let row = aResultSet.getNextRow();</span>
<a href="#l113.523"></a><span id="l113.523">                     flag = row.getResultByName(&quot;offline_journal&quot;) || null;</span>
<a href="#l113.524"></a><span id="l113.524">                 },</span>
<a href="#l113.525"></a><span id="l113.525">                 handleError: function(aError) {</span>
<a href="#l113.526"></a><span id="l113.526">                     self.logError(&quot;Error getting offline flag&quot;, aError);</span>
<a href="#l113.527"></a><span id="l113.527" class="difflineminus">-                    aListener.onOperationComplete(self, Components.results.NS_ERROR_FAILURE,</span>
<a href="#l113.528"></a><span id="l113.528" class="difflineminus">-                                                  Components.interfaces.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l113.529"></a><span id="l113.529" class="difflineplus">+                    aListener.onOperationComplete(self, Cr.NS_ERROR_FAILURE,</span>
<a href="#l113.530"></a><span id="l113.530" class="difflineplus">+                                                  Ci.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l113.531"></a><span id="l113.531">                 },</span>
<a href="#l113.532"></a><span id="l113.532">                 handleCompletion: function(aReason) {</span>
<a href="#l113.533"></a><span id="l113.533" class="difflineminus">-                    aListener.onOperationComplete(self, Components.results.NS_OK,</span>
<a href="#l113.534"></a><span id="l113.534" class="difflineminus">-                                                  Components.interfaces.calIOperationListener.GET, aItem.id, flag);</span>
<a href="#l113.535"></a><span id="l113.535" class="difflineplus">+                    aListener.onOperationComplete(self, Cr.NS_OK,</span>
<a href="#l113.536"></a><span id="l113.536" class="difflineplus">+                                                  Ci.calIOperationListener.GET, aItem.id, flag);</span>
<a href="#l113.537"></a><span id="l113.537">                 }</span>
<a href="#l113.538"></a><span id="l113.538">             };</span>
<a href="#l113.539"></a><span id="l113.539">             if (cal.item.isEvent(aItem)) {</span>
<a href="#l113.540"></a><span id="l113.540">                 this.prepareStatement(this.mSelectEvent);</span>
<a href="#l113.541"></a><span id="l113.541">                 this.mSelectEvent.params.id = aID;</span>
<a href="#l113.542"></a><span id="l113.542">                 this.mSelectEvent.executeAsync(listener);</span>
<a href="#l113.543"></a><span id="l113.543">             } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l113.544"></a><span id="l113.544">                 this.prepareStatement(this.mSelectTodo);</span>
<a href="#l113.545"></a><span id="l113.545">                 this.mSelectTodo.params.id = aID;</span>
<a href="#l113.546"></a><span id="l113.546">                 this.mSelectTodo.executeAsync(listener);</span>
<a href="#l113.547"></a><span id="l113.547">             }</span>
<a href="#l113.548"></a><span id="l113.548">         } else {</span>
<a href="#l113.549"></a><span id="l113.549">             // It is possible that aItem can be null, flag provided should be null in this case</span>
<a href="#l113.550"></a><span id="l113.550" class="difflineminus">-            aListener.onOperationComplete(this, Components.results.NS_OK,</span>
<a href="#l113.551"></a><span id="l113.551" class="difflineminus">-                                               Components.interfaces.calIOperationListener.GET, null, flag);</span>
<a href="#l113.552"></a><span id="l113.552" class="difflineplus">+            aListener.onOperationComplete(this, Cr.NS_OK,</span>
<a href="#l113.553"></a><span id="l113.553" class="difflineplus">+                                          Ci.calIOperationListener.GET, null, flag);</span>
<a href="#l113.554"></a><span id="l113.554">         }</span>
<a href="#l113.555"></a><span id="l113.555">     },</span>
<a href="#l113.556"></a><span id="l113.556"> </span>
<a href="#l113.557"></a><span id="l113.557">     setOfflineJournalFlag: function(aItem, flag) {</span>
<a href="#l113.558"></a><span id="l113.558">         let aID = aItem.id;</span>
<a href="#l113.559"></a><span id="l113.559">         if (cal.item.isEvent(aItem)) {</span>
<a href="#l113.560"></a><span id="l113.560">             this.prepareStatement(this.mEditEventOfflineFlag);</span>
<a href="#l113.561"></a><span id="l113.561">             this.mEditEventOfflineFlag.params.id = aID;</span>
<a href="#l113.562"></a><span id="l113.562" class="difflineat">@@ -1011,18 +1011,18 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.563"></a><span id="l113.563"> </span>
<a href="#l113.564"></a><span id="l113.564">     //</span>
<a href="#l113.565"></a><span id="l113.565">     // calIOfflineStorage interface</span>
<a href="#l113.566"></a><span id="l113.566">     //</span>
<a href="#l113.567"></a><span id="l113.567">     addOfflineItem: function(aItem, aListener) {</span>
<a href="#l113.568"></a><span id="l113.568">         let newOfflineJournalFlag = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l113.569"></a><span id="l113.569">         this.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l113.570"></a><span id="l113.570">         this.notifyOperationComplete(aListener,</span>
<a href="#l113.571"></a><span id="l113.571" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l113.572"></a><span id="l113.572" class="difflineminus">-                                     Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l113.573"></a><span id="l113.573" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l113.574"></a><span id="l113.574" class="difflineplus">+                                     Ci.calIOperationListener.ADD,</span>
<a href="#l113.575"></a><span id="l113.575">                                      aItem.id,</span>
<a href="#l113.576"></a><span id="l113.576">                                      aItem);</span>
<a href="#l113.577"></a><span id="l113.577">     },</span>
<a href="#l113.578"></a><span id="l113.578"> </span>
<a href="#l113.579"></a><span id="l113.579">     modifyOfflineItem: function(aItem, aListener) {</span>
<a href="#l113.580"></a><span id="l113.580">         let self = this;</span>
<a href="#l113.581"></a><span id="l113.581">         let opListener = {</span>
<a href="#l113.582"></a><span id="l113.582">             QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l113.583"></a><span id="l113.583" class="difflineat">@@ -1031,18 +1031,18 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.584"></a><span id="l113.584">             onOperationComplete: function(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l113.585"></a><span id="l113.585">                 let newOfflineJournalFlag = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l113.586"></a><span id="l113.586">                 if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD || oldOfflineJournalFlag == cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l113.587"></a><span id="l113.587">                     // Do nothing since a flag of &quot;created&quot; or &quot;deleted&quot; exists</span>
<a href="#l113.588"></a><span id="l113.588">                 } else {</span>
<a href="#l113.589"></a><span id="l113.589">                     self.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l113.590"></a><span id="l113.590">                 }</span>
<a href="#l113.591"></a><span id="l113.591">                 self.notifyOperationComplete(aListener,</span>
<a href="#l113.592"></a><span id="l113.592" class="difflineminus">-                                             Components.results.NS_OK,</span>
<a href="#l113.593"></a><span id="l113.593" class="difflineminus">-                                             Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l113.594"></a><span id="l113.594" class="difflineplus">+                                             Cr.NS_OK,</span>
<a href="#l113.595"></a><span id="l113.595" class="difflineplus">+                                             Ci.calIOperationListener.MODIFY,</span>
<a href="#l113.596"></a><span id="l113.596">                                              aItem.id,</span>
<a href="#l113.597"></a><span id="l113.597">                                              aItem);</span>
<a href="#l113.598"></a><span id="l113.598">             }</span>
<a href="#l113.599"></a><span id="l113.599">         };</span>
<a href="#l113.600"></a><span id="l113.600">         this.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l113.601"></a><span id="l113.601">     },</span>
<a href="#l113.602"></a><span id="l113.602"> </span>
<a href="#l113.603"></a><span id="l113.603">     deleteOfflineItem: function(aItem, aListener) {</span>
<a href="#l113.604"></a><span id="l113.604" class="difflineat">@@ -1060,32 +1060,32 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.605"></a><span id="l113.605">                     } else if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l113.606"></a><span id="l113.606">                         self.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l113.607"></a><span id="l113.607">                     }</span>
<a href="#l113.608"></a><span id="l113.608">                 } else {</span>
<a href="#l113.609"></a><span id="l113.609">                     self.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l113.610"></a><span id="l113.610">                 }</span>
<a href="#l113.611"></a><span id="l113.611"> </span>
<a href="#l113.612"></a><span id="l113.612">                 self.notifyOperationComplete(aListener,</span>
<a href="#l113.613"></a><span id="l113.613" class="difflineminus">-                                             Components.results.NS_OK,</span>
<a href="#l113.614"></a><span id="l113.614" class="difflineminus">-                                             Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l113.615"></a><span id="l113.615" class="difflineplus">+                                             Cr.NS_OK,</span>
<a href="#l113.616"></a><span id="l113.616" class="difflineplus">+                                             Ci.calIOperationListener.DELETE,</span>
<a href="#l113.617"></a><span id="l113.617">                                              aItem.id,</span>
<a href="#l113.618"></a><span id="l113.618">                                              aItem);</span>
<a href="#l113.619"></a><span id="l113.619">                 // notify observers</span>
<a href="#l113.620"></a><span id="l113.620">                 self.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l113.621"></a><span id="l113.621">             }</span>
<a href="#l113.622"></a><span id="l113.622">         };</span>
<a href="#l113.623"></a><span id="l113.623">         this.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l113.624"></a><span id="l113.624">     },</span>
<a href="#l113.625"></a><span id="l113.625"> </span>
<a href="#l113.626"></a><span id="l113.626">     resetItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l113.627"></a><span id="l113.627">         this.setOfflineJournalFlag(aItem, null);</span>
<a href="#l113.628"></a><span id="l113.628">         this.notifyOperationComplete(aListener,</span>
<a href="#l113.629"></a><span id="l113.629" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l113.630"></a><span id="l113.630" class="difflineminus">-                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l113.631"></a><span id="l113.631" class="difflineplus">+                                     Cr.NS_OK,</span>
<a href="#l113.632"></a><span id="l113.632" class="difflineplus">+                                     Ci.calIOperationListener.MODIFY,</span>
<a href="#l113.633"></a><span id="l113.633">                                      aItem.id,</span>
<a href="#l113.634"></a><span id="l113.634">                                      aItem);</span>
<a href="#l113.635"></a><span id="l113.635">     },</span>
<a href="#l113.636"></a><span id="l113.636"> </span>
<a href="#l113.637"></a><span id="l113.637">     //</span>
<a href="#l113.638"></a><span id="l113.638">     // database handling</span>
<a href="#l113.639"></a><span id="l113.639">     //</span>
<a href="#l113.640"></a><span id="l113.640"> </span>
<a href="#l113.641"></a><span id="l113.641" class="difflineat">@@ -1748,17 +1748,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.642"></a><span id="l113.642">                               item.title + &quot;' (&quot; + item.id + &quot;)!&quot;, e);</span>
<a href="#l113.643"></a><span id="l113.643">             } finally {</span>
<a href="#l113.644"></a><span id="l113.644">                 selectItem.reset();</span>
<a href="#l113.645"></a><span id="l113.645">             }</span>
<a href="#l113.646"></a><span id="l113.646">         }</span>
<a href="#l113.647"></a><span id="l113.647"> </span>
<a href="#l113.648"></a><span id="l113.648">         if (flags &amp; CAL_ITEM_FLAG.HAS_RECURRENCE) {</span>
<a href="#l113.649"></a><span id="l113.649">             if (item.recurrenceId) {</span>
<a href="#l113.650"></a><span id="l113.650" class="difflineminus">-                throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.651"></a><span id="l113.651" class="difflineplus">+                throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.652"></a><span id="l113.652">             }</span>
<a href="#l113.653"></a><span id="l113.653"> </span>
<a href="#l113.654"></a><span id="l113.654">             let recInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l113.655"></a><span id="l113.655">             item.recurrenceInfo = recInfo;</span>
<a href="#l113.656"></a><span id="l113.656"> </span>
<a href="#l113.657"></a><span id="l113.657">             try {</span>
<a href="#l113.658"></a><span id="l113.658">                 this.prepareStatement(this.mSelectRecurrenceForItem);</span>
<a href="#l113.659"></a><span id="l113.659">                 this.mSelectRecurrenceForItem.params.item_id = item.id;</span>
<a href="#l113.660"></a><span id="l113.660" class="difflineat">@@ -1775,17 +1775,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.661"></a><span id="l113.661">             }</span>
<a href="#l113.662"></a><span id="l113.662">         }</span>
<a href="#l113.663"></a><span id="l113.663"> </span>
<a href="#l113.664"></a><span id="l113.664">         if (flags &amp; CAL_ITEM_FLAG.HAS_EXCEPTIONS) {</span>
<a href="#l113.665"></a><span id="l113.665">             // it's safe that we don't run into this branch again for exceptions</span>
<a href="#l113.666"></a><span id="l113.666">             // (getAdditionalDataForItem-&gt;get[Event|Todo]FromRow-&gt;getAdditionalDataForItem):</span>
<a href="#l113.667"></a><span id="l113.667">             // every excepton has a recurrenceId and isn't flagged as CAL_ITEM_FLAG.HAS_EXCEPTIONS</span>
<a href="#l113.668"></a><span id="l113.668">             if (item.recurrenceId) {</span>
<a href="#l113.669"></a><span id="l113.669" class="difflineminus">-                throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.670"></a><span id="l113.670" class="difflineplus">+                throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.671"></a><span id="l113.671">             }</span>
<a href="#l113.672"></a><span id="l113.672"> </span>
<a href="#l113.673"></a><span id="l113.673">             let rec = item.recurrenceInfo;</span>
<a href="#l113.674"></a><span id="l113.674"> </span>
<a href="#l113.675"></a><span id="l113.675">             if (cal.item.isEvent(item)) {</span>
<a href="#l113.676"></a><span id="l113.676">                 this.mSelectEventExceptions.params.id = item.id;</span>
<a href="#l113.677"></a><span id="l113.677">                 this.prepareStatement(this.mSelectEventExceptions);</span>
<a href="#l113.678"></a><span id="l113.678">                 try {</span>
<a href="#l113.679"></a><span id="l113.679" class="difflineat">@@ -1811,17 +1811,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.680"></a><span id="l113.680">                     }</span>
<a href="#l113.681"></a><span id="l113.681">                 } catch (e) {</span>
<a href="#l113.682"></a><span id="l113.682">                     this.logError(&quot;Error getting exceptions for task '&quot; +</span>
<a href="#l113.683"></a><span id="l113.683">                                   item.title + &quot;' (&quot; + item.id + &quot;)!&quot;, e);</span>
<a href="#l113.684"></a><span id="l113.684">                 } finally {</span>
<a href="#l113.685"></a><span id="l113.685">                     this.mSelectTodoExceptions.reset();</span>
<a href="#l113.686"></a><span id="l113.686">                 }</span>
<a href="#l113.687"></a><span id="l113.687">             } else {</span>
<a href="#l113.688"></a><span id="l113.688" class="difflineminus">-                throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.689"></a><span id="l113.689" class="difflineplus">+                throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.690"></a><span id="l113.690">             }</span>
<a href="#l113.691"></a><span id="l113.691">         }</span>
<a href="#l113.692"></a><span id="l113.692"> </span>
<a href="#l113.693"></a><span id="l113.693">         if (flags &amp; CAL_ITEM_FLAG.HAS_ATTACHMENTS) {</span>
<a href="#l113.694"></a><span id="l113.694">             let selectAttachment = this.mSelectAttachmentsForItem;</span>
<a href="#l113.695"></a><span id="l113.695">             if (item.recurrenceId != null) {</span>
<a href="#l113.696"></a><span id="l113.696">                 selectAttachment = this.mSelectAttachmentsForItemWithRecurrenceId;</span>
<a href="#l113.697"></a><span id="l113.697">                 this.setDateParamHelper(selectAttachment.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l113.698"></a><span id="l113.698" class="difflineat">@@ -1888,18 +1888,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.699"></a><span id="l113.699">     },</span>
<a href="#l113.700"></a><span id="l113.700"> </span>
<a href="#l113.701"></a><span id="l113.701">     getRecurrenceItemFromRow: function(row, item) {</span>
<a href="#l113.702"></a><span id="l113.702">         let ritem;</span>
<a href="#l113.703"></a><span id="l113.703">         let prop = cal.getIcsService().createIcalPropertyFromString(row.icalString);</span>
<a href="#l113.704"></a><span id="l113.704">         switch (prop.propertyName) {</span>
<a href="#l113.705"></a><span id="l113.705">             case &quot;RDATE&quot;:</span>
<a href="#l113.706"></a><span id="l113.706">             case &quot;EXDATE&quot;:</span>
<a href="#l113.707"></a><span id="l113.707" class="difflineminus">-                ritem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l113.708"></a><span id="l113.708" class="difflineminus">-                                  .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l113.709"></a><span id="l113.709" class="difflineplus">+                ritem = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;].createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l113.710"></a><span id="l113.710">                 break;</span>
<a href="#l113.711"></a><span id="l113.711">             case &quot;RRULE&quot;:</span>
<a href="#l113.712"></a><span id="l113.712">             case &quot;EXRULE&quot;:</span>
<a href="#l113.713"></a><span id="l113.713">                 ritem = cal.createRecurrenceRule();</span>
<a href="#l113.714"></a><span id="l113.714">                 break;</span>
<a href="#l113.715"></a><span id="l113.715">             default:</span>
<a href="#l113.716"></a><span id="l113.716">                 throw &quot;Unknown recurrence item: &quot; + prop.propertyName;</span>
<a href="#l113.717"></a><span id="l113.717">         }</span>
<a href="#l113.718"></a><span id="l113.718" class="difflineat">@@ -2009,17 +2008,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.719"></a><span id="l113.719">         flags |= this.writeRelations(item, olditem);</span>
<a href="#l113.720"></a><span id="l113.720">         flags |= this.writeAlarms(item, olditem);</span>
<a href="#l113.721"></a><span id="l113.721"> </span>
<a href="#l113.722"></a><span id="l113.722">         if (cal.item.isEvent(item)) {</span>
<a href="#l113.723"></a><span id="l113.723">             this.writeEvent(item, olditem, flags);</span>
<a href="#l113.724"></a><span id="l113.724">         } else if (cal.item.isToDo(item)) {</span>
<a href="#l113.725"></a><span id="l113.725">             this.writeTodo(item, olditem, flags);</span>
<a href="#l113.726"></a><span id="l113.726">         } else {</span>
<a href="#l113.727"></a><span id="l113.727" class="difflineminus">-            throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.728"></a><span id="l113.728" class="difflineplus">+            throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.729"></a><span id="l113.729">         }</span>
<a href="#l113.730"></a><span id="l113.730">     },</span>
<a href="#l113.731"></a><span id="l113.731"> </span>
<a href="#l113.732"></a><span id="l113.732">     writeEvent: function(item, olditem, flags) {</span>
<a href="#l113.733"></a><span id="l113.733">         try {</span>
<a href="#l113.734"></a><span id="l113.734">             this.prepareStatement(this.mInsertEvent);</span>
<a href="#l113.735"></a><span id="l113.735">             let params = this.mInsertEvent.params;</span>
<a href="#l113.736"></a><span id="l113.736">             this.setupItemBaseParams(item, olditem, params);</span>
<a href="#l113.737"></a><span id="l113.737" class="difflineat">@@ -2125,27 +2124,27 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.738"></a><span id="l113.738">         return 0;</span>
<a href="#l113.739"></a><span id="l113.739">     },</span>
<a href="#l113.740"></a><span id="l113.740"> </span>
<a href="#l113.741"></a><span id="l113.741">     writeProperty: function(item, propName, propValue) {</span>
<a href="#l113.742"></a><span id="l113.742">         try {</span>
<a href="#l113.743"></a><span id="l113.743">             this.prepareStatement(this.mInsertProperty);</span>
<a href="#l113.744"></a><span id="l113.744">             let params = this.mInsertProperty.params;</span>
<a href="#l113.745"></a><span id="l113.745">             params.key = propName;</span>
<a href="#l113.746"></a><span id="l113.746" class="difflineminus">-            let wPropValue = cal.wrapInstance(propValue, Components.interfaces.calIDateTime);</span>
<a href="#l113.747"></a><span id="l113.747" class="difflineplus">+            let wPropValue = cal.wrapInstance(propValue, Ci.calIDateTime);</span>
<a href="#l113.748"></a><span id="l113.748">             if (wPropValue) {</span>
<a href="#l113.749"></a><span id="l113.749">                 params.value = wPropValue.nativeTime;</span>
<a href="#l113.750"></a><span id="l113.750">             } else {</span>
<a href="#l113.751"></a><span id="l113.751">                 try {</span>
<a href="#l113.752"></a><span id="l113.752">                     params.value = propValue;</span>
<a href="#l113.753"></a><span id="l113.753">                 } catch (e) {</span>
<a href="#l113.754"></a><span id="l113.754">                     // The storage service throws an NS_ERROR_ILLEGAL_VALUE in</span>
<a href="#l113.755"></a><span id="l113.755">                     // case pval is something complex (i.e not a string or</span>
<a href="#l113.756"></a><span id="l113.756">                     // number). Swallow this error, leaving the value empty.</span>
<a href="#l113.757"></a><span id="l113.757" class="difflineminus">-                    if (e.result != Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l113.758"></a><span id="l113.758" class="difflineplus">+                    if (e.result != Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l113.759"></a><span id="l113.759">                         throw e;</span>
<a href="#l113.760"></a><span id="l113.760">                     }</span>
<a href="#l113.761"></a><span id="l113.761">                 }</span>
<a href="#l113.762"></a><span id="l113.762">             }</span>
<a href="#l113.763"></a><span id="l113.763">             params.item_id = item.id;</span>
<a href="#l113.764"></a><span id="l113.764">             this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l113.765"></a><span id="l113.765">             this.mInsertProperty.executeStep();</span>
<a href="#l113.766"></a><span id="l113.766">         } finally {</span>
<a href="#l113.767"></a><span id="l113.767" class="difflineat">@@ -2196,17 +2195,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.768"></a><span id="l113.768">                 flags |= CAL_ITEM_FLAG.HAS_EXCEPTIONS;</span>
<a href="#l113.769"></a><span id="l113.769"> </span>
<a href="#l113.770"></a><span id="l113.770">                 // we need to serialize each exid as a separate</span>
<a href="#l113.771"></a><span id="l113.771">                 // event/todo; setupItemBase will handle</span>
<a href="#l113.772"></a><span id="l113.772">                 // writing the recurrenceId for us</span>
<a href="#l113.773"></a><span id="l113.773">                 for (let exid of exceptions) {</span>
<a href="#l113.774"></a><span id="l113.774">                     let ex = rec.getExceptionFor(exid);</span>
<a href="#l113.775"></a><span id="l113.775">                     if (!ex) {</span>
<a href="#l113.776"></a><span id="l113.776" class="difflineminus">-                        throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.777"></a><span id="l113.777" class="difflineplus">+                        throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l113.778"></a><span id="l113.778">                     }</span>
<a href="#l113.779"></a><span id="l113.779">                     this.writeItem(ex, null);</span>
<a href="#l113.780"></a><span id="l113.780">                 }</span>
<a href="#l113.781"></a><span id="l113.781">             }</span>
<a href="#l113.782"></a><span id="l113.782">         } else if (item.recurrenceId &amp;&amp; item.recurrenceId.isDate) {</span>
<a href="#l113.783"></a><span id="l113.783">             flags |= CAL_ITEM_FLAG.RECURRENCE_ID_ALLDAY;</span>
<a href="#l113.784"></a><span id="l113.784">         }</span>
<a href="#l113.785"></a><span id="l113.785"> </span>
<a href="#l113.786"></a><span id="l113.786" class="difflineat">@@ -2340,17 +2339,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l113.787"></a><span id="l113.787">         this.executeItemStatement(this.mDeleteMetaData, &quot;item_id&quot;, id);</span>
<a href="#l113.788"></a><span id="l113.788">         try {</span>
<a href="#l113.789"></a><span id="l113.789">             this.prepareStatement(this.mInsertMetaData);</span>
<a href="#l113.790"></a><span id="l113.790">             let params = this.mInsertMetaData.params;</span>
<a href="#l113.791"></a><span id="l113.791">             params.item_id = id;</span>
<a href="#l113.792"></a><span id="l113.792">             params.value = value;</span>
<a href="#l113.793"></a><span id="l113.793">             this.mInsertMetaData.executeStep();</span>
<a href="#l113.794"></a><span id="l113.794">         } catch (e) {</span>
<a href="#l113.795"></a><span id="l113.795" class="difflineminus">-            if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l113.796"></a><span id="l113.796" class="difflineplus">+            if (e.result == Cr.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l113.797"></a><span id="l113.797">                 this.logError(&quot;Unknown error!&quot;, e);</span>
<a href="#l113.798"></a><span id="l113.798">             } else {</span>
<a href="#l113.799"></a><span id="l113.799">                 // The storage service throws an NS_ERROR_ILLEGAL_VALUE in</span>
<a href="#l113.800"></a><span id="l113.800">                 // case pval is something complex (i.e not a string or</span>
<a href="#l113.801"></a><span id="l113.801">                 // number). Swallow this error, leaving the value empty.</span>
<a href="#l113.802"></a><span id="l113.802">                 this.logError(&quot;Error setting metadata for id &quot; + id + &quot;!&quot;, e);</span>
<a href="#l113.803"></a><span id="l113.803">             }</span>
<a href="#l113.804"></a><span id="l113.804">         } finally {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l114.1"></a><span id="l114.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l114.2"></a><span id="l114.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l114.3"></a><span id="l114.3" class="difflineat">@@ -187,17 +187,17 @@ function getVersion(db) {</span>
<a href="#l114.4"></a><span id="l114.4"> function backupDB(db, currentVersion) {</span>
<a href="#l114.5"></a><span id="l114.5">     cal.LOG(&quot;Storage: Backing up current database...&quot;);</span>
<a href="#l114.6"></a><span id="l114.6">     try {</span>
<a href="#l114.7"></a><span id="l114.7">         // Prepare filenames and path</span>
<a href="#l114.8"></a><span id="l114.8">         let backupFilename = &quot;local.v&quot; + currentVersion + &quot;.sqlite&quot;;</span>
<a href="#l114.9"></a><span id="l114.9">         let backupPath = cal.provider.getCalendarDirectory();</span>
<a href="#l114.10"></a><span id="l114.10">         backupPath.append(&quot;backup&quot;);</span>
<a href="#l114.11"></a><span id="l114.11">         if (!backupPath.exists()) {</span>
<a href="#l114.12"></a><span id="l114.12" class="difflineminus">-            backupPath.create(Components.interfaces.nsIFile.DIRECTORY_TYPE, parseInt(&quot;0755&quot;, 8));</span>
<a href="#l114.13"></a><span id="l114.13" class="difflineplus">+            backupPath.create(Ci.nsIFile.DIRECTORY_TYPE, parseInt(&quot;0755&quot;, 8));</span>
<a href="#l114.14"></a><span id="l114.14">         }</span>
<a href="#l114.15"></a><span id="l114.15"> </span>
<a href="#l114.16"></a><span id="l114.16">         // Create a backup file and notify the user via WARN, since LOG will not</span>
<a href="#l114.17"></a><span id="l114.17">         // be visible unless a pref is set.</span>
<a href="#l114.18"></a><span id="l114.18">         let file = Services.storage.backupDatabaseFile(db.databaseFile, backupFilename, backupPath);</span>
<a href="#l114.19"></a><span id="l114.19">         cal.WARN(&quot;Storage: Upgrading to v&quot; + DB_SCHEMA_VERSION + &quot;, a backup was written to: &quot; + file.path);</span>
<a href="#l114.20"></a><span id="l114.20">     } catch (e) {</span>
<a href="#l114.21"></a><span id="l114.21">         cal.ERROR(&quot;Storage: Error creating backup file: &quot; + e);</span>
<a href="#l114.22"></a><span id="l114.22" class="difflineat">@@ -217,17 +217,17 @@ function upgradeDB(db) {</span>
<a href="#l114.23"></a><span id="l114.23">             // First, create a backup</span>
<a href="#l114.24"></a><span id="l114.24">             backupDB(db, version);</span>
<a href="#l114.25"></a><span id="l114.25"> </span>
<a href="#l114.26"></a><span id="l114.26">             // Then start the latest upgrader</span>
<a href="#l114.27"></a><span id="l114.27">             cal.LOG(&quot;Storage: Preparing to upgrade v&quot; + version +</span>
<a href="#l114.28"></a><span id="l114.28">                     &quot; to v&quot; + DB_SCHEMA_VERSION);</span>
<a href="#l114.29"></a><span id="l114.29">             upgrade[&quot;v&quot; + DB_SCHEMA_VERSION](db, version);</span>
<a href="#l114.30"></a><span id="l114.30">         } else if (version &gt; DB_SCHEMA_VERSION) {</span>
<a href="#l114.31"></a><span id="l114.31" class="difflineminus">-            throw Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR;</span>
<a href="#l114.32"></a><span id="l114.32" class="difflineplus">+            throw Ci.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR;</span>
<a href="#l114.33"></a><span id="l114.33">         }</span>
<a href="#l114.34"></a><span id="l114.34">     } else {</span>
<a href="#l114.35"></a><span id="l114.35">         cal.LOG(&quot;Storage: Creating tables from scratch&quot;);</span>
<a href="#l114.36"></a><span id="l114.36">         beginTransaction(db);</span>
<a href="#l114.37"></a><span id="l114.37">         try {</span>
<a href="#l114.38"></a><span id="l114.38">             executeSimpleSQL(db, getAllSql());</span>
<a href="#l114.39"></a><span id="l114.39">             setDbVersionAndCommit(db, DB_SCHEMA_VERSION);</span>
<a href="#l114.40"></a><span id="l114.40">         } catch (e) {</span>
<a href="#l114.41"></a><span id="l114.41" class="difflineat">@@ -608,17 +608,17 @@ function migrateToIcalString(tblData, tb</span>
<a href="#l114.42"></a><span id="l114.42"> </span>
<a href="#l114.43"></a><span id="l114.43"> /**</span>
<a href="#l114.44"></a><span id="l114.44">  * Maps a mozIStorageValueArray to a JS array, converting types correctly.</span>
<a href="#l114.45"></a><span id="l114.45">  *</span>
<a href="#l114.46"></a><span id="l114.46">  * @param storArgs      The storage value array to convert</span>
<a href="#l114.47"></a><span id="l114.47">  * @return              An array with the arguments as js values.</span>
<a href="#l114.48"></a><span id="l114.48">  */</span>
<a href="#l114.49"></a><span id="l114.49"> function mapStorageArgs(storArgs) {</span>
<a href="#l114.50"></a><span id="l114.50" class="difflineminus">-    const mISVA = Components.interfaces.mozIStorageValueArray;</span>
<a href="#l114.51"></a><span id="l114.51" class="difflineplus">+    const mISVA = Ci.mozIStorageValueArray;</span>
<a href="#l114.52"></a><span id="l114.52">     let mappedArgs = [];</span>
<a href="#l114.53"></a><span id="l114.53">     for (let i = 0; i &lt; storArgs.numEntries; i++) {</span>
<a href="#l114.54"></a><span id="l114.54">         switch (storArgs.getTypeOfIndex(i)) {</span>
<a href="#l114.55"></a><span id="l114.55">             case mISVA.VALUE_TYPE_NULL: mappedArgs.push(null); break;</span>
<a href="#l114.56"></a><span id="l114.56">             case mISVA.VALUE_TYPE_INTEGER:</span>
<a href="#l114.57"></a><span id="l114.57">                 mappedArgs.push(storArgs.getInt64(i));</span>
<a href="#l114.58"></a><span id="l114.58">                 break;</span>
<a href="#l114.59"></a><span id="l114.59">             case mISVA.VALUE_TYPE_FLOAT:</span>
<a href="#l114.60"></a><span id="l114.60" class="difflineat">@@ -1116,17 +1116,17 @@ upgrade.v16 = function(db, version) {</span>
<a href="#l114.61"></a><span id="l114.61">                         mapStorageArgs(storArgs);</span>
<a href="#l114.62"></a><span id="l114.62"> </span>
<a href="#l114.63"></a><span id="l114.63">                     let alarm = cal.createAlarm();</span>
<a href="#l114.64"></a><span id="l114.64">                     if (aOffset) {</span>
<a href="#l114.65"></a><span id="l114.65">                         alarm.related = parseInt(aRelated, 10) + 1;</span>
<a href="#l114.66"></a><span id="l114.66">                         alarm.offset = cal.createDuration();</span>
<a href="#l114.67"></a><span id="l114.67">                         alarm.offset.inSeconds = aOffset;</span>
<a href="#l114.68"></a><span id="l114.68">                     } else if (aAlarmTime) {</span>
<a href="#l114.69"></a><span id="l114.69" class="difflineminus">-                        alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l114.70"></a><span id="l114.70" class="difflineplus">+                        alarm.related = Ci.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l114.71"></a><span id="l114.71">                         let alarmDate = cal.createDateTime();</span>
<a href="#l114.72"></a><span id="l114.72">                         alarmDate.nativeTime = aAlarmTime;</span>
<a href="#l114.73"></a><span id="l114.73">                         if (aTzId == &quot;floating&quot;) {</span>
<a href="#l114.74"></a><span id="l114.74">                             // The current calDateTime code assumes that if a</span>
<a href="#l114.75"></a><span id="l114.75">                             // date is floating then we can just assign the new</span>
<a href="#l114.76"></a><span id="l114.76">                             // timezone. I have the feeling this is wrong so I</span>
<a href="#l114.77"></a><span id="l114.77">                             // filed bug 520463. Since we want to release 1.0b1</span>
<a href="#l114.78"></a><span id="l114.78">                             // soon, I will just fix this on the &quot;client side&quot;</span>
<a href="#l114.79"></a><span id="l114.79" class="difflineat">@@ -1546,18 +1546,18 @@ upgrade.v22 = function(db, version) {</span>
<a href="#l114.80"></a><span id="l114.80">                     // eslint-disable-next-line no-unused-vars</span>
<a href="#l114.81"></a><span id="l114.81">                     let [aIndex, aType, aIsNegative, aDates, aCount,</span>
<a href="#l114.82"></a><span id="l114.82">                          aEndDate, aInterval, aSecond, aMinute, aHour,</span>
<a href="#l114.83"></a><span id="l114.83">                          aDay, aMonthday, aYearday, aWeekno, aMonth,</span>
<a href="#l114.84"></a><span id="l114.84">                          aSetPos, aTmpFlags] = mapStorageArgs(storArgs);</span>
<a href="#l114.85"></a><span id="l114.85"> </span>
<a href="#l114.86"></a><span id="l114.86">                     let ritem;</span>
<a href="#l114.87"></a><span id="l114.87">                     if (aType == &quot;x-date&quot;) {</span>
<a href="#l114.88"></a><span id="l114.88" class="difflineminus">-                        ritem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l114.89"></a><span id="l114.89" class="difflineminus">-                                          .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l114.90"></a><span id="l114.90" class="difflineplus">+                        ritem = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l114.91"></a><span id="l114.91" class="difflineplus">+                                  .createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l114.92"></a><span id="l114.92">                         ritem.date = textToDate(aDates);</span>
<a href="#l114.93"></a><span id="l114.93">                         ritem.isNegative = !!aIsNegative;</span>
<a href="#l114.94"></a><span id="l114.94">                     } else {</span>
<a href="#l114.95"></a><span id="l114.95">                         ritem = cal.createRecurrenceRule();</span>
<a href="#l114.96"></a><span id="l114.96">                         ritem.type = aType;</span>
<a href="#l114.97"></a><span id="l114.97">                         ritem.isNegative = !!aIsNegative;</span>
<a href="#l114.98"></a><span id="l114.98">                         if (aCount) {</span>
<a href="#l114.99"></a><span id="l114.99">                             try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l115.1"></a><span id="l115.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l115.2"></a><span id="l115.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l115.3"></a><span id="l115.3" class="difflineat">@@ -16,19 +16,19 @@ function calWcapCalendar(session, calPro</span>
<a href="#l115.4"></a><span id="l115.4">     this.initProviderBase();</span>
<a href="#l115.5"></a><span id="l115.5">     this.m_session = session;</span>
<a href="#l115.6"></a><span id="l115.6">     this.m_calProps = calProps;</span>
<a href="#l115.7"></a><span id="l115.7"> }</span>
<a href="#l115.8"></a><span id="l115.8"> var calWcapCalendarClassID = Components.ID(&quot;{cf4d93e5-af79-451a-95f3-109055b32ef0}&quot;);</span>
<a href="#l115.9"></a><span id="l115.9"> var calWcapCalendarInterfaces = [</span>
<a href="#l115.10"></a><span id="l115.10">     calIWcapCalendar,</span>
<a href="#l115.11"></a><span id="l115.11">     calICalendar,</span>
<a href="#l115.12"></a><span id="l115.12" class="difflineminus">-    Components.interfaces.calISchedulingSupport,</span>
<a href="#l115.13"></a><span id="l115.13" class="difflineminus">-    Components.interfaces.calIChangeLog,</span>
<a href="#l115.14"></a><span id="l115.14" class="difflineminus">-    Components.interfaces.calICalendarProvider,</span>
<a href="#l115.15"></a><span id="l115.15" class="difflineplus">+    Ci.calISchedulingSupport,</span>
<a href="#l115.16"></a><span id="l115.16" class="difflineplus">+    Ci.calIChangeLog,</span>
<a href="#l115.17"></a><span id="l115.17" class="difflineplus">+    Ci.calICalendarProvider,</span>
<a href="#l115.18"></a><span id="l115.18"> ];</span>
<a href="#l115.19"></a><span id="l115.19"> calWcapCalendar.prototype = {</span>
<a href="#l115.20"></a><span id="l115.20">     __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l115.21"></a><span id="l115.21">     classID: calWcapCalendarClassID,</span>
<a href="#l115.22"></a><span id="l115.22">     QueryInterface: cal.generateQI(calWcapCalendarInterfaces),</span>
<a href="#l115.23"></a><span id="l115.23">     classInfo: cal.generateCI({</span>
<a href="#l115.24"></a><span id="l115.24">         classID: calWcapCalendarClassID,</span>
<a href="#l115.25"></a><span id="l115.25">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=wcap&quot;,</span>
<a href="#l115.26"></a><span id="l115.26" class="difflineat">@@ -54,19 +54,19 @@ calWcapCalendar.prototype = {</span>
<a href="#l115.27"></a><span id="l115.27">                 return;</span>
<a href="#l115.28"></a><span id="l115.28">             default:</span>
<a href="#l115.29"></a><span id="l115.29">                 msg = errorToString(err);</span>
<a href="#l115.30"></a><span id="l115.30">                 log(&quot;error: &quot; + msg, context);</span>
<a href="#l115.31"></a><span id="l115.31">                 break;</span>
<a href="#l115.32"></a><span id="l115.32">         }</span>
<a href="#l115.33"></a><span id="l115.33">         this.__proto__.__proto__.notifyError.apply(</span>
<a href="#l115.34"></a><span id="l115.34">             this,</span>
<a href="#l115.35"></a><span id="l115.35" class="difflineminus">-            err instanceof Components.interfaces.nsIException</span>
<a href="#l115.36"></a><span id="l115.36" class="difflineplus">+            err instanceof Ci.nsIException</span>
<a href="#l115.37"></a><span id="l115.37">             ? [err.result, err.message]</span>
<a href="#l115.38"></a><span id="l115.38" class="difflineminus">-            : [isNaN(err) ? Components.results.NS_ERROR_FAILURE : err, msg]);</span>
<a href="#l115.39"></a><span id="l115.39" class="difflineplus">+            : [isNaN(err) ? Cr.NS_ERROR_FAILURE : err, msg]);</span>
<a href="#l115.40"></a><span id="l115.40">     },</span>
<a href="#l115.41"></a><span id="l115.41">     notifyError: function(err, msg) {</span>
<a href="#l115.42"></a><span id="l115.42">         this.notifyError_(err, msg, this);</span>
<a href="#l115.43"></a><span id="l115.43">     },</span>
<a href="#l115.44"></a><span id="l115.44"> </span>
<a href="#l115.45"></a><span id="l115.45">     // calICalendarProvider:</span>
<a href="#l115.46"></a><span id="l115.46">     get prefChromeOverlay() {</span>
<a href="#l115.47"></a><span id="l115.47">         return null;</span>
<a href="#l115.48"></a><span id="l115.48" class="difflineat">@@ -358,19 +358,19 @@ calWcapCalendar.prototype = {</span>
<a href="#l115.49"></a><span id="l115.49">             throw new Components.Exception(errorToString(calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR),</span>
<a href="#l115.50"></a><span id="l115.50">                                            calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR);</span>
<a href="#l115.51"></a><span id="l115.51">             // xxx todo: throwing different error here, no</span>
<a href="#l115.52"></a><span id="l115.52">             //           calIErrors.CAL_IS_READONLY anymore</span>
<a href="#l115.53"></a><span id="l115.53">         }</span>
<a href="#l115.54"></a><span id="l115.54">     },</span>
<a href="#l115.55"></a><span id="l115.55"> </span>
<a href="#l115.56"></a><span id="l115.56">     defineAccessControl: function(userId, accessControlBits) {</span>
<a href="#l115.57"></a><span id="l115.57" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l115.58"></a><span id="l115.58" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l115.59"></a><span id="l115.59">     },</span>
<a href="#l115.60"></a><span id="l115.60"> </span>
<a href="#l115.61"></a><span id="l115.61">     resetAccessControl: function(userId) {</span>
<a href="#l115.62"></a><span id="l115.62" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l115.63"></a><span id="l115.63" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l115.64"></a><span id="l115.64">     },</span>
<a href="#l115.65"></a><span id="l115.65"> </span>
<a href="#l115.66"></a><span id="l115.66">     getAccessControlDefinitions: function(out_count, out_users, out_accessControlBits) {</span>
<a href="#l115.67"></a><span id="l115.67" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l115.68"></a><span id="l115.68" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l115.69"></a><span id="l115.69">     }</span>
<a href="#l115.70"></a><span id="l115.70"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l116.1"></a><span id="l116.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l116.2"></a><span id="l116.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l116.3"></a><span id="l116.3" class="difflineat">@@ -35,18 +35,18 @@ calWcapCalendar.prototype.getRecurrenceP</span>
<a href="#l116.4"></a><span id="l116.4">     out_rrules.value = [];</span>
<a href="#l116.5"></a><span id="l116.5">     out_rdates.value = [];</span>
<a href="#l116.6"></a><span id="l116.6">     out_exrules.value = [];</span>
<a href="#l116.7"></a><span id="l116.7">     out_exdates.value = [];</span>
<a href="#l116.8"></a><span id="l116.8">     if (item.recurrenceInfo) {</span>
<a href="#l116.9"></a><span id="l116.9">         let rItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l116.10"></a><span id="l116.10">         for (let rItem of rItems) {</span>
<a href="#l116.11"></a><span id="l116.11">             let isNeg = rItem.isNegative;</span>
<a href="#l116.12"></a><span id="l116.12" class="difflineminus">-            let rRuleInstance = cal.wrapInstance(rItem, Components.interfaces.calIRecurrenceRule);</span>
<a href="#l116.13"></a><span id="l116.13" class="difflineminus">-            let rDateInstance = cal.wrapInstance(rItem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l116.14"></a><span id="l116.14" class="difflineplus">+            let rRuleInstance = cal.wrapInstance(rItem, Ci.calIRecurrenceRule);</span>
<a href="#l116.15"></a><span id="l116.15" class="difflineplus">+            let rDateInstance = cal.wrapInstance(rItem, Ci.calIRecurrenceDate);</span>
<a href="#l116.16"></a><span id="l116.16">             if (rRuleInstance) {</span>
<a href="#l116.17"></a><span id="l116.17">                 let rule = &quot;\&quot;&quot; + encodeURIComponent(rRuleInstance.icalProperty.valueAsIcalString) + &quot;\&quot;&quot;;</span>
<a href="#l116.18"></a><span id="l116.18">                 if (isNeg) {</span>
<a href="#l116.19"></a><span id="l116.19">                     out_exrules.value.push(rule);</span>
<a href="#l116.20"></a><span id="l116.20">                 } else {</span>
<a href="#l116.21"></a><span id="l116.21">                     out_rrules.value.push(rule);</span>
<a href="#l116.22"></a><span id="l116.22">                 }</span>
<a href="#l116.23"></a><span id="l116.23">             } else if (rDateInstance) {</span>
<a href="#l116.24"></a><span id="l116.24" class="difflineat">@@ -296,17 +296,17 @@ calWcapCalendar.prototype.storeItem = fu</span>
<a href="#l116.25"></a><span id="l116.25">     };</span>
<a href="#l116.26"></a><span id="l116.26"> </span>
<a href="#l116.27"></a><span id="l116.27">     let getAttachments = (attitem) =&gt; {</span>
<a href="#l116.28"></a><span id="l116.28">         let ret;</span>
<a href="#l116.29"></a><span id="l116.29">         let attachments = attitem.attachments;</span>
<a href="#l116.30"></a><span id="l116.30">         if (attachments) {</span>
<a href="#l116.31"></a><span id="l116.31">             let strings = [];</span>
<a href="#l116.32"></a><span id="l116.32">             for (let att of attachments) {</span>
<a href="#l116.33"></a><span id="l116.33" class="difflineminus">-                let wrappedAtt = cal.wrapInstance(att, Components.interfaces.calIAttachment);</span>
<a href="#l116.34"></a><span id="l116.34" class="difflineplus">+                let wrappedAtt = cal.wrapInstance(att, Ci.calIAttachment);</span>
<a href="#l116.35"></a><span id="l116.35">                 if (typeof att == &quot;string&quot;) {</span>
<a href="#l116.36"></a><span id="l116.36">                     strings.push(encodeURIComponent(att));</span>
<a href="#l116.37"></a><span id="l116.37">                 } else if (wrappedAtt &amp;&amp; wrappedAtt.uri) {</span>
<a href="#l116.38"></a><span id="l116.38">                     strings.push(encodeURIComponent(wrappedAtt.uri.spec));</span>
<a href="#l116.39"></a><span id="l116.39">                 } else { // xxx todo</span>
<a href="#l116.40"></a><span id="l116.40">                     logError(&quot;only URLs supported as attachment, not: &quot; + att, this);</span>
<a href="#l116.41"></a><span id="l116.41">                 }</span>
<a href="#l116.42"></a><span id="l116.42">             }</span>
<a href="#l116.43"></a><span id="l116.43" class="difflineat">@@ -916,18 +916,18 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l116.44"></a><span id="l116.44">             parent.setProperty(&quot;DTSTART&quot;, item.recurrenceId);</span>
<a href="#l116.45"></a><span id="l116.45">             parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;); // this tag might be useful in the future</span>
<a href="#l116.46"></a><span id="l116.46">             parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l116.47"></a><span id="l116.47">             fakedParents[item.id] = true;</span>
<a href="#l116.48"></a><span id="l116.48">             uid2parent[item.id] = parent;</span>
<a href="#l116.49"></a><span id="l116.49">             items.push(parent);</span>
<a href="#l116.50"></a><span id="l116.50">         }</span>
<a href="#l116.51"></a><span id="l116.51">         if (item.id in fakedParents) {</span>
<a href="#l116.52"></a><span id="l116.52" class="difflineminus">-            let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l116.53"></a><span id="l116.53" class="difflineminus">-                                  .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l116.54"></a><span id="l116.54" class="difflineplus">+            let rdate = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l116.55"></a><span id="l116.55" class="difflineplus">+                          .createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l116.56"></a><span id="l116.56">             rdate.date = item.recurrenceId;</span>
<a href="#l116.57"></a><span id="l116.57">             parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l116.58"></a><span id="l116.58">         }</span>
<a href="#l116.59"></a><span id="l116.59"> </span>
<a href="#l116.60"></a><span id="l116.60">         let recStartDate = parent.recurrenceStartDate;</span>
<a href="#l116.61"></a><span id="l116.61">         if (recStartDate &amp;&amp; recStartDate.isDate &amp;&amp; !item.recurrenceId.isDate) {</span>
<a href="#l116.62"></a><span id="l116.62">             // cs ought to return proper all-day RECURRENCE-ID!</span>
<a href="#l116.63"></a><span id="l116.63">             // get into startDate's timezone before cutting:</span>
<a href="#l116.64"></a><span id="l116.64" class="difflineat">@@ -947,18 +947,18 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l116.65"></a><span id="l116.65"> </span>
<a href="#l116.66"></a><span id="l116.66">             let recStartDate = item.recurrenceStartDate;</span>
<a href="#l116.67"></a><span id="l116.67">             if (recStartDate &amp;&amp; !recStartDate.isDate) {</span>
<a href="#l116.68"></a><span id="l116.68">                 recStartDate = null;</span>
<a href="#l116.69"></a><span id="l116.69">             }</span>
<a href="#l116.70"></a><span id="l116.70">             let recItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l116.71"></a><span id="l116.71">             for (let recItem of recItems) {</span>
<a href="#l116.72"></a><span id="l116.72">                 // cs bug: workaround missing COUNT</span>
<a href="#l116.73"></a><span id="l116.73" class="difflineminus">-                let rRuleInstance = cal.wrapInstance(recItem, Components.interfaces.calIRecurrenceRule);</span>
<a href="#l116.74"></a><span id="l116.74" class="difflineminus">-                let rDateInstance = cal.wrapInstance(recItem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l116.75"></a><span id="l116.75" class="difflineplus">+                let rRuleInstance = cal.wrapInstance(recItem, Ci.calIRecurrenceRule);</span>
<a href="#l116.76"></a><span id="l116.76" class="difflineplus">+                let rDateInstance = cal.wrapInstance(recItem, Ci.calIRecurrenceDate);</span>
<a href="#l116.77"></a><span id="l116.77">                 if (rRuleInstance) {</span>
<a href="#l116.78"></a><span id="l116.78">                     recItem = rRuleInstance;</span>
<a href="#l116.79"></a><span id="l116.79">                     if (!recItem.isFinite &amp;&amp; !recItem.isNegative) {</span>
<a href="#l116.80"></a><span id="l116.80">                         recItem.count = recurrenceBound;</span>
<a href="#l116.81"></a><span id="l116.81">                     }</span>
<a href="#l116.82"></a><span id="l116.82">                 } else if (recStartDate &amp;&amp;</span>
<a href="#l116.83"></a><span id="l116.83">                            rDateInstance) {</span>
<a href="#l116.84"></a><span id="l116.84">                     // cs bug: always uses DATE-TIME even though the master item is all-day DATE:</span>
<a href="#l116.85"></a><span id="l116.85" class="difflineat">@@ -1242,20 +1242,19 @@ calWcapCalendar.prototype.getItems = fun</span>
<a href="#l116.86"></a><span id="l116.86">                                     }</span>
<a href="#l116.87"></a><span id="l116.87">                                     this.m_cachedResults = entries;</span>
<a href="#l116.88"></a><span id="l116.88">                                 }.bind(this)</span>
<a href="#l116.89"></a><span id="l116.89">                             };</span>
<a href="#l116.90"></a><span id="l116.90">                             // sort out freq:</span>
<a href="#l116.91"></a><span id="l116.91">                             let freq = Math.min(20, // default: 20secs</span>
<a href="#l116.92"></a><span id="l116.92">                                                 Math.max(1, CACHE_LAST_RESULTS_INVALIDATE));</span>
<a href="#l116.93"></a><span id="l116.93">                             log(&quot;cached results sort out timer freq: &quot; + freq, this);</span>
<a href="#l116.94"></a><span id="l116.94" class="difflineminus">-                            this.m_cachedResultsTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l116.95"></a><span id="l116.95" class="difflineminus">-                                                                  .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l116.96"></a><span id="l116.96" class="difflineplus">+                            this.m_cachedResultsTimer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l116.97"></a><span id="l116.97">                             this.m_cachedResultsTimer.initWithCallback(callback, freq * 1000,</span>
<a href="#l116.98"></a><span id="l116.98" class="difflineminus">-                                                                       Components.interfaces.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l116.99"></a><span id="l116.99" class="difflineplus">+                                                                       Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l116.100"></a><span id="l116.100">                         }</span>
<a href="#l116.101"></a><span id="l116.101">                         if (!this.m_cachedResults) {</span>
<a href="#l116.102"></a><span id="l116.102">                             this.m_cachedResults = [];</span>
<a href="#l116.103"></a><span id="l116.103">                         }</span>
<a href="#l116.104"></a><span id="l116.104">                         let cacheEntry = {</span>
<a href="#l116.105"></a><span id="l116.105">                             stamp: (new Date()).getTime(),</span>
<a href="#l116.106"></a><span id="l116.106">                             itemFilter: itemFilter,</span>
<a href="#l116.107"></a><span id="l116.107">                             rangeStart: (rangeStart ? rangeStart.clone() : null),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l117.1"></a><span id="l117.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l117.2"></a><span id="l117.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l117.3"></a><span id="l117.3" class="difflineat">@@ -15,29 +15,29 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l117.4"></a><span id="l117.4"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l117.5"></a><span id="l117.5"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l117.6"></a><span id="l117.6"> </span>
<a href="#l117.7"></a><span id="l117.7"> //</span>
<a href="#l117.8"></a><span id="l117.8"> // init code for globals, prefs:</span>
<a href="#l117.9"></a><span id="l117.9"> //</span>
<a href="#l117.10"></a><span id="l117.10"> </span>
<a href="#l117.11"></a><span id="l117.11"> // constants:</span>
<a href="#l117.12"></a><span id="l117.12" class="difflineminus">-var NS_OK = Components.results.NS_OK;</span>
<a href="#l117.13"></a><span id="l117.13" class="difflineminus">-var NS_ERROR_UNEXPECTED = Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l117.14"></a><span id="l117.14" class="difflineminus">-var nsIException = Components.interfaces.nsIException;</span>
<a href="#l117.15"></a><span id="l117.15" class="difflineminus">-var calIWcapSession = Components.interfaces.calIWcapSession;</span>
<a href="#l117.16"></a><span id="l117.16" class="difflineminus">-var calIWcapCalendar = Components.interfaces.calIWcapCalendar;</span>
<a href="#l117.17"></a><span id="l117.17" class="difflineminus">-var calIWcapErrors = Components.interfaces.calIWcapErrors;</span>
<a href="#l117.18"></a><span id="l117.18" class="difflineminus">-var calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l117.19"></a><span id="l117.19" class="difflineminus">-var calIItemBase = Components.interfaces.calIItemBase;</span>
<a href="#l117.20"></a><span id="l117.20" class="difflineminus">-var calIOperationListener = Components.interfaces.calIOperationListener;</span>
<a href="#l117.21"></a><span id="l117.21" class="difflineminus">-var calIFreeBusyProvider = Components.interfaces.calIFreeBusyProvider;</span>
<a href="#l117.22"></a><span id="l117.22" class="difflineminus">-var calIFreeBusyInterval = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l117.23"></a><span id="l117.23" class="difflineminus">-var calICalendarSearchProvider = Components.interfaces.calICalendarSearchProvider;</span>
<a href="#l117.24"></a><span id="l117.24" class="difflineminus">-var calIErrors = Components.interfaces.calIErrors;</span>
<a href="#l117.25"></a><span id="l117.25" class="difflineplus">+var NS_OK = Cr.NS_OK;</span>
<a href="#l117.26"></a><span id="l117.26" class="difflineplus">+var NS_ERROR_UNEXPECTED = Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l117.27"></a><span id="l117.27" class="difflineplus">+var nsIException = Ci.nsIException;</span>
<a href="#l117.28"></a><span id="l117.28" class="difflineplus">+var calIWcapSession = Ci.calIWcapSession;</span>
<a href="#l117.29"></a><span id="l117.29" class="difflineplus">+var calIWcapCalendar = Ci.calIWcapCalendar;</span>
<a href="#l117.30"></a><span id="l117.30" class="difflineplus">+var calIWcapErrors = Ci.calIWcapErrors;</span>
<a href="#l117.31"></a><span id="l117.31" class="difflineplus">+var calICalendar = Ci.calICalendar;</span>
<a href="#l117.32"></a><span id="l117.32" class="difflineplus">+var calIItemBase = Ci.calIItemBase;</span>
<a href="#l117.33"></a><span id="l117.33" class="difflineplus">+var calIOperationListener = Ci.calIOperationListener;</span>
<a href="#l117.34"></a><span id="l117.34" class="difflineplus">+var calIFreeBusyProvider = Ci.calIFreeBusyProvider;</span>
<a href="#l117.35"></a><span id="l117.35" class="difflineplus">+var calIFreeBusyInterval = Ci.calIFreeBusyInterval;</span>
<a href="#l117.36"></a><span id="l117.36" class="difflineplus">+var calICalendarSearchProvider = Ci.calICalendarSearchProvider;</span>
<a href="#l117.37"></a><span id="l117.37" class="difflineplus">+var calIErrors = Ci.calIErrors;</span>
<a href="#l117.38"></a><span id="l117.38"> </span>
<a href="#l117.39"></a><span id="l117.39"> // some string resources:</span>
<a href="#l117.40"></a><span id="l117.40"> var g_privateItemTitle;</span>
<a href="#l117.41"></a><span id="l117.41"> var g_confidentialItemTitle;</span>
<a href="#l117.42"></a><span id="l117.42"> var g_busyItemTitle;</span>
<a href="#l117.43"></a><span id="l117.43"> var g_busyPhantomItemUuidPrefix;</span>
<a href="#l117.44"></a><span id="l117.44"> </span>
<a href="#l117.45"></a><span id="l117.45"> // global preferences:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l118.1"></a><span id="l118.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapErrors.js</span>
<a href="#l118.2"></a><span id="l118.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapErrors.js</span>
<a href="#l118.3"></a><span id="l118.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l118.4"></a><span id="l118.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l118.5"></a><span id="l118.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l118.6"></a><span id="l118.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l118.7"></a><span id="l118.7"> </span>
<a href="#l118.8"></a><span id="l118.8"> /* exported checkErrorCode, checkWcapXmlErrno, checkWcapIcalErrno,</span>
<a href="#l118.9"></a><span id="l118.9">  *          errorToString</span>
<a href="#l118.10"></a><span id="l118.10">  */</span>
<a href="#l118.11"></a><span id="l118.11"> </span>
<a href="#l118.12"></a><span id="l118.12" class="difflineminus">-var NS_ERROR_INVALID_ARG = Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l118.13"></a><span id="l118.13" class="difflineplus">+var NS_ERROR_INVALID_ARG = Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l118.14"></a><span id="l118.14"> </span>
<a href="#l118.15"></a><span id="l118.15"> //</span>
<a href="#l118.16"></a><span id="l118.16"> // Common netwerk errors:</span>
<a href="#l118.17"></a><span id="l118.17"> //</span>
<a href="#l118.18"></a><span id="l118.18"> var NS_ERROR_MODULE_BASE_OFFSET = 0x45;</span>
<a href="#l118.19"></a><span id="l118.19"> var NS_ERROR_MODULE_NETWORK = 6;</span>
<a href="#l118.20"></a><span id="l118.20"> </span>
<a href="#l118.21"></a><span id="l118.21"> function generateFailure(module, code) {</span>
<a href="#l118.22"></a><span id="l118.22" class="difflineat">@@ -23,17 +23,17 @@ function generateNetFailure(code) {</span>
<a href="#l118.23"></a><span id="l118.23">     return generateFailure(NS_ERROR_MODULE_NETWORK, code);</span>
<a href="#l118.24"></a><span id="l118.24"> }</span>
<a href="#l118.25"></a><span id="l118.25"> </span>
<a href="#l118.26"></a><span id="l118.26"> function getResultCode(err) {</span>
<a href="#l118.27"></a><span id="l118.27">     if (err === undefined || err === null) {</span>
<a href="#l118.28"></a><span id="l118.28">         return NS_OK;</span>
<a href="#l118.29"></a><span id="l118.29">     }</span>
<a href="#l118.30"></a><span id="l118.30">     if (isNaN(err)) {</span>
<a href="#l118.31"></a><span id="l118.31" class="difflineminus">-        return (err instanceof nsIException ? err.result : Components.results.NS_ERROR_FAILURE);</span>
<a href="#l118.32"></a><span id="l118.32" class="difflineplus">+        return (err instanceof nsIException ? err.result : Cr.NS_ERROR_FAILURE);</span>
<a href="#l118.33"></a><span id="l118.33">     }</span>
<a href="#l118.34"></a><span id="l118.34">     return err;</span>
<a href="#l118.35"></a><span id="l118.35"> }</span>
<a href="#l118.36"></a><span id="l118.36"> </span>
<a href="#l118.37"></a><span id="l118.37"> function getErrorModule(err) {</span>
<a href="#l118.38"></a><span id="l118.38">     let rc = getResultCode(err);</span>
<a href="#l118.39"></a><span id="l118.39">     return (((rc &gt;&gt;&gt; 16) &amp; 0x7fff) - NS_ERROR_MODULE_BASE_OFFSET);</span>
<a href="#l118.40"></a><span id="l118.40"> }</span>
<a href="#l118.41"></a><span id="l118.41" class="difflineat">@@ -334,39 +334,39 @@ function errorToString(err) {</span>
<a href="#l118.42"></a><span id="l118.42">     // numeric codes:</span>
<a href="#l118.43"></a><span id="l118.43">     switch (err) {</span>
<a href="#l118.44"></a><span id="l118.44">         case undefined:</span>
<a href="#l118.45"></a><span id="l118.45">         case null:</span>
<a href="#l118.46"></a><span id="l118.46">         case NS_OK:</span>
<a href="#l118.47"></a><span id="l118.47">             return &quot;NS_OK&quot;;</span>
<a href="#l118.48"></a><span id="l118.48">         case NS_ERROR_INVALID_ARG:</span>
<a href="#l118.49"></a><span id="l118.49">             return &quot;NS_ERROR_INVALID_ARG&quot;;</span>
<a href="#l118.50"></a><span id="l118.50" class="difflineminus">-        case Components.results.NS_ERROR_NO_INTERFACE:</span>
<a href="#l118.51"></a><span id="l118.51" class="difflineplus">+        case Cr.NS_ERROR_NO_INTERFACE:</span>
<a href="#l118.52"></a><span id="l118.52">             return &quot;NS_ERROR_NO_INTERFACE&quot;;</span>
<a href="#l118.53"></a><span id="l118.53" class="difflineminus">-        case Components.results.NS_ERROR_NOT_IMPLEMENTED:</span>
<a href="#l118.54"></a><span id="l118.54" class="difflineplus">+        case Cr.NS_ERROR_NOT_IMPLEMENTED:</span>
<a href="#l118.55"></a><span id="l118.55">             return &quot;NS_ERROR_NOT_IMPLEMENTED&quot;;</span>
<a href="#l118.56"></a><span id="l118.56" class="difflineminus">-        case Components.results.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l118.57"></a><span id="l118.57" class="difflineplus">+        case Cr.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l118.58"></a><span id="l118.58">             return &quot;NS_ERROR_NOT_AVAILABLE&quot;;</span>
<a href="#l118.59"></a><span id="l118.59" class="difflineminus">-        case Components.results.NS_ERROR_FAILURE:</span>
<a href="#l118.60"></a><span id="l118.60" class="difflineplus">+        case Cr.NS_ERROR_FAILURE:</span>
<a href="#l118.61"></a><span id="l118.61">             return &quot;NS_ERROR_FAILURE&quot;;</span>
<a href="#l118.62"></a><span id="l118.62" class="difflineminus">-        case Components.results.NS_ERROR_BASE:</span>
<a href="#l118.63"></a><span id="l118.63" class="difflineplus">+        case Cr.NS_ERROR_BASE:</span>
<a href="#l118.64"></a><span id="l118.64">             return &quot;NS_ERROR_BASE&quot;;</span>
<a href="#l118.65"></a><span id="l118.65" class="difflineminus">-        case Components.results.NS_ERROR_NOT_INITIALIZED:</span>
<a href="#l118.66"></a><span id="l118.66" class="difflineplus">+        case Cr.NS_ERROR_NOT_INITIALIZED:</span>
<a href="#l118.67"></a><span id="l118.67">             return &quot;NS_ERROR_NOT_INITIALIZED&quot;;</span>
<a href="#l118.68"></a><span id="l118.68" class="difflineminus">-        case Components.results.NS_ERROR_ALREADY_INITIALIZED:</span>
<a href="#l118.69"></a><span id="l118.69" class="difflineplus">+        case Cr.NS_ERROR_ALREADY_INITIALIZED:</span>
<a href="#l118.70"></a><span id="l118.70">             return &quot;NS_ERROR_ALREADY_INITIALIZED&quot;;</span>
<a href="#l118.71"></a><span id="l118.71" class="difflineminus">-        case Components.results.NS_ERROR_NULL_POINTER:</span>
<a href="#l118.72"></a><span id="l118.72" class="difflineplus">+        case Cr.NS_ERROR_NULL_POINTER:</span>
<a href="#l118.73"></a><span id="l118.73">             return &quot;NS_ERROR_NULL_POINTER&quot;;</span>
<a href="#l118.74"></a><span id="l118.74" class="difflineminus">-        case Components.results.NS_ERROR_ABORT:</span>
<a href="#l118.75"></a><span id="l118.75" class="difflineplus">+        case Cr.NS_ERROR_ABORT:</span>
<a href="#l118.76"></a><span id="l118.76">             return &quot;NS_ERROR_ABORT&quot;;</span>
<a href="#l118.77"></a><span id="l118.77" class="difflineminus">-        case Components.results.NS_ERROR_UNEXPECTED:</span>
<a href="#l118.78"></a><span id="l118.78" class="difflineplus">+        case Cr.NS_ERROR_UNEXPECTED:</span>
<a href="#l118.79"></a><span id="l118.79">             return &quot;NS_ERROR_UNEXPECTED&quot;;</span>
<a href="#l118.80"></a><span id="l118.80" class="difflineminus">-        case Components.results.NS_ERROR_OUT_OF_MEMORY:</span>
<a href="#l118.81"></a><span id="l118.81" class="difflineplus">+        case Cr.NS_ERROR_OUT_OF_MEMORY:</span>
<a href="#l118.82"></a><span id="l118.82">             return &quot;NS_ERROR_OUT_OF_MEMORY&quot;;</span>
<a href="#l118.83"></a><span id="l118.83" class="difflineminus">-        case Components.results.NS_ERROR_ILLEGAL_VALUE:</span>
<a href="#l118.84"></a><span id="l118.84" class="difflineplus">+        case Cr.NS_ERROR_ILLEGAL_VALUE:</span>
<a href="#l118.85"></a><span id="l118.85">             return &quot;NS_ERROR_ILLEGAL_VALUE&quot;;</span>
<a href="#l118.86"></a><span id="l118.86">         default:</span>
<a href="#l118.87"></a><span id="l118.87">             // probe for WCAP error:</span>
<a href="#l118.88"></a><span id="l118.88">             try {</span>
<a href="#l118.89"></a><span id="l118.89">                 return wcapErrorToString(err);</span>
<a href="#l118.90"></a><span id="l118.90">             } catch (exc) { // probe for netwerk error:</span>
<a href="#l118.91"></a><span id="l118.91">                 try {</span>
<a href="#l118.92"></a><span id="l118.92">                     return netErrorToString(err);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l119.1"></a><span id="l119.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l119.2"></a><span id="l119.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l119.3"></a><span id="l119.3" class="difflineat">@@ -188,19 +188,19 @@ function calWcapNetworkRequest(url, resp</span>
<a href="#l119.4"></a><span id="l119.4">     this.wrappedJSObject = this;</span>
<a href="#l119.5"></a><span id="l119.5">     this.m_id = generateRequestId();</span>
<a href="#l119.6"></a><span id="l119.6">     this.m_url = url;</span>
<a href="#l119.7"></a><span id="l119.7">     this.m_respFunc = respFunc;</span>
<a href="#l119.8"></a><span id="l119.8">     this.m_bLogging = (bLogging === undefined ? true : bLogging);</span>
<a href="#l119.9"></a><span id="l119.9"> }</span>
<a href="#l119.10"></a><span id="l119.10"> var calWcapNetworkRequestClassID = Components.ID(&quot;{e3c62b37-83cf-41ec-9872-0af9f952430a}&quot;);</span>
<a href="#l119.11"></a><span id="l119.11"> var calWcapNetworkRequestInterfaces = [</span>
<a href="#l119.12"></a><span id="l119.12" class="difflineminus">-    Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l119.13"></a><span id="l119.13" class="difflineminus">-    Components.interfaces.nsIChannelEventSink,</span>
<a href="#l119.14"></a><span id="l119.14" class="difflineminus">-    Components.interfaces.calIOperation,</span>
<a href="#l119.15"></a><span id="l119.15" class="difflineplus">+    Ci.nsIInterfaceRequestor,</span>
<a href="#l119.16"></a><span id="l119.16" class="difflineplus">+    Ci.nsIChannelEventSink,</span>
<a href="#l119.17"></a><span id="l119.17" class="difflineplus">+    Ci.calIOperation,</span>
<a href="#l119.18"></a><span id="l119.18"> ];</span>
<a href="#l119.19"></a><span id="l119.19"> calWcapNetworkRequest.prototype = {</span>
<a href="#l119.20"></a><span id="l119.20">     m_id: 0,</span>
<a href="#l119.21"></a><span id="l119.21">     m_url: null,</span>
<a href="#l119.22"></a><span id="l119.22">     m_loader: null,</span>
<a href="#l119.23"></a><span id="l119.23">     m_respFunc: null,</span>
<a href="#l119.24"></a><span id="l119.24">     m_bLogging: false,</span>
<a href="#l119.25"></a><span id="l119.25"> </span>
<a href="#l119.26"></a><span id="l119.26" class="difflineat">@@ -222,37 +222,37 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l119.27"></a><span id="l119.27">     /**</span>
<a href="#l119.28"></a><span id="l119.28">      * prepareChannel</span>
<a href="#l119.29"></a><span id="l119.29">      * Prepares the passed channel to match this objects properties</span>
<a href="#l119.30"></a><span id="l119.30">      *</span>
<a href="#l119.31"></a><span id="l119.31">      * @param aChannel    The Channel to be prepared</span>
<a href="#l119.32"></a><span id="l119.32">      */</span>
<a href="#l119.33"></a><span id="l119.33">     prepareChannel: function(aChannel) {</span>
<a href="#l119.34"></a><span id="l119.34">         // No caching</span>
<a href="#l119.35"></a><span id="l119.35" class="difflineminus">-        aChannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l119.36"></a><span id="l119.36" class="difflineminus">-        aChannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l119.37"></a><span id="l119.37" class="difflineplus">+        aChannel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l119.38"></a><span id="l119.38" class="difflineplus">+        aChannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l119.39"></a><span id="l119.39">         aChannel.requestMethod = &quot;GET&quot;;</span>
<a href="#l119.40"></a><span id="l119.40">     },</span>
<a href="#l119.41"></a><span id="l119.41"> </span>
<a href="#l119.42"></a><span id="l119.42">     /**</span>
<a href="#l119.43"></a><span id="l119.43">      * @see nsIChannelEventSink</span>
<a href="#l119.44"></a><span id="l119.44">      */</span>
<a href="#l119.45"></a><span id="l119.45">     asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l119.46"></a><span id="l119.46">         // all we need to do to the new channel is the basic preparation</span>
<a href="#l119.47"></a><span id="l119.47">         this.prepareChannel(aNewChannel);</span>
<a href="#l119.48"></a><span id="l119.48" class="difflineminus">-        aCallback.onRedirectVerifyCallback(Components.results.NS_OK);</span>
<a href="#l119.49"></a><span id="l119.49" class="difflineplus">+        aCallback.onRedirectVerifyCallback(Cr.NS_OK);</span>
<a href="#l119.50"></a><span id="l119.50">     },</span>
<a href="#l119.51"></a><span id="l119.51"> </span>
<a href="#l119.52"></a><span id="l119.52">     onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l119.53"></a><span id="l119.53">         this.m_loader = null;</span>
<a href="#l119.54"></a><span id="l119.54"> </span>
<a href="#l119.55"></a><span id="l119.55">         if (LOG_LEVEL &gt; 0 &amp;&amp; this.m_bLogging) {</span>
<a href="#l119.56"></a><span id="l119.56">             log(&quot;status: &quot; + errorToString(aStatus), this);</span>
<a href="#l119.57"></a><span id="l119.57">         }</span>
<a href="#l119.58"></a><span id="l119.58" class="difflineminus">-        if (aStatus != Components.results.NS_OK) {</span>
<a href="#l119.59"></a><span id="l119.59" class="difflineplus">+        if (aStatus != Cr.NS_OK) {</span>
<a href="#l119.60"></a><span id="l119.60">             this.execRespFunc(aStatus);</span>
<a href="#l119.61"></a><span id="l119.61">             return;</span>
<a href="#l119.62"></a><span id="l119.62">         }</span>
<a href="#l119.63"></a><span id="l119.63"> </span>
<a href="#l119.64"></a><span id="l119.64">         let httpChannel = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l119.65"></a><span id="l119.65">         let encoding = httpChannel.contentCharset || &quot;utf-8&quot;;</span>
<a href="#l119.66"></a><span id="l119.66">         let result = aResultLength</span>
<a href="#l119.67"></a><span id="l119.67">                    ? new TextDecoder(encoding).decode(Uint8Array.from(aResult))</span>
<a href="#l119.68"></a><span id="l119.68" class="difflineat">@@ -378,20 +378,20 @@ function issueNetworkRequest(parentReque</span>
<a href="#l119.69"></a><span id="l119.69">         parentRequest.attachSubRequest(netRequest);</span>
<a href="#l119.70"></a><span id="l119.70">     }</span>
<a href="#l119.71"></a><span id="l119.71">     try {</span>
<a href="#l119.72"></a><span id="l119.72">         let uri = Services.io.newURI(url);</span>
<a href="#l119.73"></a><span id="l119.73">         let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l119.74"></a><span id="l119.74">                                                      null,</span>
<a href="#l119.75"></a><span id="l119.75">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l119.76"></a><span id="l119.76">                                                      null,</span>
<a href="#l119.77"></a><span id="l119.77" class="difflineminus">-                                                     Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l119.78"></a><span id="l119.78" class="difflineminus">-                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l119.79"></a><span id="l119.79" class="difflineplus">+                                                     Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l119.80"></a><span id="l119.80" class="difflineplus">+                                                     Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l119.81"></a><span id="l119.81">         netRequest.prepareChannel(channel);</span>
<a href="#l119.82"></a><span id="l119.82" class="difflineminus">-        channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l119.83"></a><span id="l119.83" class="difflineplus">+        channel = channel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l119.84"></a><span id="l119.84">         channel.redirectionLimit = 3;</span>
<a href="#l119.85"></a><span id="l119.85">         channel.notificationCallbacks = netRequest;</span>
<a href="#l119.86"></a><span id="l119.86">         let loader = cal.provider.createStreamLoader();</span>
<a href="#l119.87"></a><span id="l119.87">         netRequest.m_loader = loader;</span>
<a href="#l119.88"></a><span id="l119.88"> </span>
<a href="#l119.89"></a><span id="l119.89">         log(&quot;opening channel.&quot;, netRequest);</span>
<a href="#l119.90"></a><span id="l119.90">         loader.init(netRequest);</span>
<a href="#l119.91"></a><span id="l119.91">         channel.asyncOpen(loader, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l120.1"></a><span id="l120.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l120.2"></a><span id="l120.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l120.3"></a><span id="l120.3" class="difflineat">@@ -103,18 +103,18 @@ function calWcapSession(contextId) {</span>
<a href="#l120.4"></a><span id="l120.4">     Services.obs.addObserver(this, &quot;quit-application&quot;);</span>
<a href="#l120.5"></a><span id="l120.5">     cal.getCalendarManager().addObserver(this);</span>
<a href="#l120.6"></a><span id="l120.6"> }</span>
<a href="#l120.7"></a><span id="l120.7"> var calWcapSessionClassID = Components.ID(&quot;{cbf803fd-4469-4999-ae39-367af1c7b077}&quot;);</span>
<a href="#l120.8"></a><span id="l120.8"> var calWcapSessionInterfaces = [</span>
<a href="#l120.9"></a><span id="l120.9">     calIWcapSession,</span>
<a href="#l120.10"></a><span id="l120.10">     calIFreeBusyProvider,</span>
<a href="#l120.11"></a><span id="l120.11">     calICalendarSearchProvider,</span>
<a href="#l120.12"></a><span id="l120.12" class="difflineminus">-    Components.interfaces.calITimezoneProvider,</span>
<a href="#l120.13"></a><span id="l120.13" class="difflineminus">-    Components.interfaces.calICalendarManagerObserver</span>
<a href="#l120.14"></a><span id="l120.14" class="difflineplus">+    Ci.calITimezoneProvider,</span>
<a href="#l120.15"></a><span id="l120.15" class="difflineplus">+    Ci.calICalendarManagerObserver</span>
<a href="#l120.16"></a><span id="l120.16"> ];</span>
<a href="#l120.17"></a><span id="l120.17"> calWcapSession.prototype = {</span>
<a href="#l120.18"></a><span id="l120.18">     classID: calWcapSessionClassID,</span>
<a href="#l120.19"></a><span id="l120.19">     QueryInterface: cal.generateQI(calWcapSessionInterfaces),</span>
<a href="#l120.20"></a><span id="l120.20">     classInfo: cal.generateCI({</span>
<a href="#l120.21"></a><span id="l120.21">         classID: calWcapSessionClassID,</span>
<a href="#l120.22"></a><span id="l120.22">         contractID: &quot;@mozilla.org/calendar/wcap/session;1&quot;,</span>
<a href="#l120.23"></a><span id="l120.23">         classDescription: &quot;Sun Java System Calendar Server WCAP Session&quot;,</span>
<a href="#l120.24"></a><span id="l120.24" class="difflineat">@@ -150,17 +150,17 @@ calWcapSession.prototype = {</span>
<a href="#l120.25"></a><span id="l120.25">         return { // nsIUTF8StringEnumerator:</span>
<a href="#l120.26"></a><span id="l120.26">             m_index: 0,</span>
<a href="#l120.27"></a><span id="l120.27">             [Symbol.iterator]: function() {</span>
<a href="#l120.28"></a><span id="l120.28">                 return tzids.values();</span>
<a href="#l120.29"></a><span id="l120.29">             },</span>
<a href="#l120.30"></a><span id="l120.30">             getNext: function() {</span>
<a href="#l120.31"></a><span id="l120.31">                 if (this.m_index &gt;= tzids) {</span>
<a href="#l120.32"></a><span id="l120.32">                     cal.ASSERT(false, &quot;calWcapSession::timezoneIds enumerator!&quot;);</span>
<a href="#l120.33"></a><span id="l120.33" class="difflineminus">-                    throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l120.34"></a><span id="l120.34" class="difflineplus">+                    throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l120.35"></a><span id="l120.35">                 }</span>
<a href="#l120.36"></a><span id="l120.36">                 return tzids[this.m_index++];</span>
<a href="#l120.37"></a><span id="l120.37">             },</span>
<a href="#l120.38"></a><span id="l120.38">             hasMore: function() {</span>
<a href="#l120.39"></a><span id="l120.39">                 return (this.m_index &lt; tzids.length);</span>
<a href="#l120.40"></a><span id="l120.40">             }</span>
<a href="#l120.41"></a><span id="l120.41">         };</span>
<a href="#l120.42"></a><span id="l120.42">     },</span>
<a href="#l120.43"></a><span id="l120.43" class="difflineat">@@ -177,17 +177,17 @@ calWcapSession.prototype = {</span>
<a href="#l120.44"></a><span id="l120.44">                 return null;</span>
<a href="#l120.45"></a><span id="l120.45">         }</span>
<a href="#l120.46"></a><span id="l120.46">     },</span>
<a href="#l120.47"></a><span id="l120.47"> </span>
<a href="#l120.48"></a><span id="l120.48">     m_serverTimeDiff: null,</span>
<a href="#l120.49"></a><span id="l120.49">     getServerTime: function(localTime) {</span>
<a href="#l120.50"></a><span id="l120.50">         if (this.m_serverTimeDiff === null) {</span>
<a href="#l120.51"></a><span id="l120.51">             throw new Components.Exception(&quot;early run into getServerTime()!&quot;,</span>
<a href="#l120.52"></a><span id="l120.52" class="difflineminus">-                                           Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l120.53"></a><span id="l120.53" class="difflineplus">+                                           Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l120.54"></a><span id="l120.54">         }</span>
<a href="#l120.55"></a><span id="l120.55">         let ret = (localTime ? localTime.clone() : getTime());</span>
<a href="#l120.56"></a><span id="l120.56">         ret.addDuration(this.m_serverTimeDiff);</span>
<a href="#l120.57"></a><span id="l120.57">         return ret;</span>
<a href="#l120.58"></a><span id="l120.58">     },</span>
<a href="#l120.59"></a><span id="l120.59"> </span>
<a href="#l120.60"></a><span id="l120.60">     m_sessionId: null,</span>
<a href="#l120.61"></a><span id="l120.61">     m_loginQueue: null,</span>
<a href="#l120.62"></a><span id="l120.62" class="difflineat">@@ -305,18 +305,18 @@ calWcapSession.prototype = {</span>
<a href="#l120.63"></a><span id="l120.63">                     } else {</span>
<a href="#l120.64"></a><span id="l120.64">                         if (outSavePW.value) {</span>
<a href="#l120.65"></a><span id="l120.65">                             // so try to remove old pw from db first:</span>
<a href="#l120.66"></a><span id="l120.66">                             try {</span>
<a href="#l120.67"></a><span id="l120.67">                                 cal.auth.passwordManagerSave(outUser.value, outPW.value, this.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l120.68"></a><span id="l120.68">                             } catch (e) {</span>
<a href="#l120.69"></a><span id="l120.69">                                 // User might have cancelled the master password prompt, or password saving</span>
<a href="#l120.70"></a><span id="l120.70">                                 // could be disabled. That is ok, throw for everything else.</span>
<a href="#l120.71"></a><span id="l120.71" class="difflineminus">-                                if (e.result != Components.results.NS_ERROR_ABORT &amp;&amp;</span>
<a href="#l120.72"></a><span id="l120.72" class="difflineminus">-                                    e.result != Components.results.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l120.73"></a><span id="l120.73" class="difflineplus">+                                if (e.result != Cr.NS_ERROR_ABORT &amp;&amp;</span>
<a href="#l120.74"></a><span id="l120.74" class="difflineplus">+                                    e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l120.75"></a><span id="l120.75">                                     throw e;</span>
<a href="#l120.76"></a><span id="l120.76">                                 }</span>
<a href="#l120.77"></a><span id="l120.77">                             }</span>
<a href="#l120.78"></a><span id="l120.78">                         }</span>
<a href="#l120.79"></a><span id="l120.79">                         this.credentials.userId = outUser.value;</span>
<a href="#l120.80"></a><span id="l120.80">                         this.credentials.pw = outPW.value; // eslint-disable-line id-length</span>
<a href="#l120.81"></a><span id="l120.81">                         this.setupSession(sessionId, request, (setuperr) =&gt; respFunc(setuperr, sessionId));</span>
<a href="#l120.82"></a><span id="l120.82">                     }</span>
<a href="#l120.83"></a><span id="l120.83" class="difflineat">@@ -613,17 +613,17 @@ calWcapSession.prototype = {</span>
<a href="#l120.84"></a><span id="l120.84">             if (!retrievedCals[calId]) {</span>
<a href="#l120.85"></a><span id="l120.85">                 let listener = {</span>
<a href="#l120.86"></a><span id="l120.86">                     onResult: function(oprequest, result) {</span>
<a href="#l120.87"></a><span id="l120.87">                         try {</span>
<a href="#l120.88"></a><span id="l120.88">                             if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l120.89"></a><span id="l120.89">                                 throw oprequest.status;</span>
<a href="#l120.90"></a><span id="l120.90">                             }</span>
<a href="#l120.91"></a><span id="l120.91">                             if (result.length &lt; 1) {</span>
<a href="#l120.92"></a><span id="l120.92" class="difflineminus">-                                throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l120.93"></a><span id="l120.93" class="difflineplus">+                                throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l120.94"></a><span id="l120.94">                             }</span>
<a href="#l120.95"></a><span id="l120.95">                             for (let calendar of result) {</span>
<a href="#l120.96"></a><span id="l120.96">                                 // user may have dangling users referred in his subscription list, so</span>
<a href="#l120.97"></a><span id="l120.97">                                 // retrieve each by each, don't break:</span>
<a href="#l120.98"></a><span id="l120.98">                                 try {</span>
<a href="#l120.99"></a><span id="l120.99">                                     let thisCalId = calendar.calId;</span>
<a href="#l120.100"></a><span id="l120.100">                                     if ((cals[thisCalId] !== undefined) &amp;&amp; !retrievedCals[thisCalId]) {</span>
<a href="#l120.101"></a><span id="l120.101">                                         retrievedCals[thisCalId] = calendar;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l121.1"></a><span id="l121.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l121.2"></a><span id="l121.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l121.3"></a><span id="l121.3" class="difflineat">@@ -29,22 +29,21 @@ function initLogging() {</span>
<a href="#l121.4"></a><span id="l121.4">         LOG_LEVEL = 1; // at least basic logging when calendar.debug.log is set</span>
<a href="#l121.5"></a><span id="l121.5">     }</span>
<a href="#l121.6"></a><span id="l121.6"> </span>
<a href="#l121.7"></a><span id="l121.7">     if (LOG_LEVEL &gt; 0) {</span>
<a href="#l121.8"></a><span id="l121.8">         let logFileName = getPref(&quot;calendar.wcap.log_file&quot;, null);</span>
<a href="#l121.9"></a><span id="l121.9">         if (logFileName) {</span>
<a href="#l121.10"></a><span id="l121.10">             try {</span>
<a href="#l121.11"></a><span id="l121.11">                 // set up file:</span>
<a href="#l121.12"></a><span id="l121.12" class="difflineminus">-                let logFile = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l121.13"></a><span id="l121.13" class="difflineminus">-                                        .createInstance(Components.interfaces.nsIFile);</span>
<a href="#l121.14"></a><span id="l121.14" class="difflineplus">+                let logFile = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l121.15"></a><span id="l121.15">                 logFile.initWithPath(logFileName);</span>
<a href="#l121.16"></a><span id="l121.16">                 // create output stream:</span>
<a href="#l121.17"></a><span id="l121.17" class="difflineminus">-                let logFileStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l121.18"></a><span id="l121.18" class="difflineminus">-                                              .createInstance(Components.interfaces.nsIFileOutputStream);</span>
<a href="#l121.19"></a><span id="l121.19" class="difflineplus">+                let logFileStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l121.20"></a><span id="l121.20" class="difflineplus">+                                      .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l121.21"></a><span id="l121.21">                 logFileStream.init(logFile,</span>
<a href="#l121.22"></a><span id="l121.22">                                    0x02 /* PR_WRONLY */ |</span>
<a href="#l121.23"></a><span id="l121.23">                                    0x08 /* PR_CREATE_FILE */ |</span>
<a href="#l121.24"></a><span id="l121.24">                                    (getPref(&quot;calendar.wcap.log_file_append&quot;, false)</span>
<a href="#l121.25"></a><span id="l121.25">                                     ? 0x10 /* PR_APPEND */ : 0x20 /* PR_TRUNCATE */),</span>
<a href="#l121.26"></a><span id="l121.26">                                    parseInt(&quot;0700&quot;, 8) /* read, write, execute/search by owner */,</span>
<a href="#l121.27"></a><span id="l121.27">                                    0 /* unused */);</span>
<a href="#l121.28"></a><span id="l121.28">                 initLogging.mLogFilestream = logFileStream;</span>
<a href="#l121.29"></a><span id="l121.29" class="difflineat">@@ -105,51 +104,50 @@ function log(msg, context, bForce) {</span>
<a href="#l121.30"></a><span id="l121.30">         dump(str);</span>
<a href="#l121.31"></a><span id="l121.31">         if (initLogging.mLogFilestream) {</span>
<a href="#l121.32"></a><span id="l121.32">             try {</span>
<a href="#l121.33"></a><span id="l121.33">                 // xxx todo?</span>
<a href="#l121.34"></a><span id="l121.34">                 // assuming ANSI chars here, for logging sufficient:</span>
<a href="#l121.35"></a><span id="l121.35">                 initLogging.mLogFilestream.write(str, str.length);</span>
<a href="#l121.36"></a><span id="l121.36">             } catch (exc) { // catching any io errors here:</span>
<a href="#l121.37"></a><span id="l121.37">                 let err = &quot;error writing log file: &quot; + errorToString(exc);</span>
<a href="#l121.38"></a><span id="l121.38" class="difflineminus">-                Components.utils.reportError(exc);</span>
<a href="#l121.39"></a><span id="l121.39" class="difflineplus">+                Cu.reportError(exc);</span>
<a href="#l121.40"></a><span id="l121.40">                 Services.console.logStringMessage(err);</span>
<a href="#l121.41"></a><span id="l121.41">                 dump(err + &quot;\n\n&quot;);</span>
<a href="#l121.42"></a><span id="l121.42">             }</span>
<a href="#l121.43"></a><span id="l121.43">         }</span>
<a href="#l121.44"></a><span id="l121.44">         return ret;</span>
<a href="#l121.45"></a><span id="l121.45">     } else {</span>
<a href="#l121.46"></a><span id="l121.46">         return msg;</span>
<a href="#l121.47"></a><span id="l121.47">     }</span>
<a href="#l121.48"></a><span id="l121.48"> }</span>
<a href="#l121.49"></a><span id="l121.49"> </span>
<a href="#l121.50"></a><span id="l121.50"> function logWarning(err, context) {</span>
<a href="#l121.51"></a><span id="l121.51">     let msg = errorToString(err);</span>
<a href="#l121.52"></a><span id="l121.52" class="difflineminus">-    let scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l121.53"></a><span id="l121.53" class="difflineminus">-                                .createInstance(Components.interfaces.nsIScriptError);</span>
<a href="#l121.54"></a><span id="l121.54" class="difflineplus">+    let scriptError = Cc[&quot;@mozilla.org/scripterror;1&quot;].createInstance(Ci.nsIScriptError);</span>
<a href="#l121.55"></a><span id="l121.55">     scriptError.init(log(&quot;warning: &quot; + msg, context, true),</span>
<a href="#l121.56"></a><span id="l121.56">                      null, null, 0, 0,</span>
<a href="#l121.57"></a><span id="l121.57" class="difflineminus">-                     Components.interfaces.nsIScriptError.warningFlag,</span>
<a href="#l121.58"></a><span id="l121.58" class="difflineplus">+                     Ci.nsIScriptError.warningFlag,</span>
<a href="#l121.59"></a><span id="l121.59">                      &quot;component javascript&quot;);</span>
<a href="#l121.60"></a><span id="l121.60">     Services.console.logMessage(scriptError);</span>
<a href="#l121.61"></a><span id="l121.61">     return msg;</span>
<a href="#l121.62"></a><span id="l121.62"> }</span>
<a href="#l121.63"></a><span id="l121.63"> </span>
<a href="#l121.64"></a><span id="l121.64"> function logError(err, context) {</span>
<a href="#l121.65"></a><span id="l121.65">     let msg = errorToString(err);</span>
<a href="#l121.66"></a><span id="l121.66" class="difflineminus">-    Components.utils.reportError(log(&quot;error: &quot; + msg + &quot;\nstack:\n&quot; + cal.STACK(10), context, true));</span>
<a href="#l121.67"></a><span id="l121.67" class="difflineplus">+    Cu.reportError(log(&quot;error: &quot; + msg + &quot;\nstack:\n&quot; + cal.STACK(10), context, true));</span>
<a href="#l121.68"></a><span id="l121.68">     return msg;</span>
<a href="#l121.69"></a><span id="l121.69"> }</span>
<a href="#l121.70"></a><span id="l121.70"> </span>
<a href="#l121.71"></a><span id="l121.71"> // late-inited service accessors:</span>
<a href="#l121.72"></a><span id="l121.72"> </span>
<a href="#l121.73"></a><span id="l121.73"> function getCalendarSearchService() {</span>
<a href="#l121.74"></a><span id="l121.74">     if (!getCalendarSearchService.m_obj) {</span>
<a href="#l121.75"></a><span id="l121.75" class="difflineminus">-        getCalendarSearchService.m_obj = Components.classes[&quot;@mozilla.org/calendar/calendarsearch-service;1&quot;]</span>
<a href="#l121.76"></a><span id="l121.76" class="difflineminus">-                                                   .getService(Components.interfaces.calICalendarSearchService);</span>
<a href="#l121.77"></a><span id="l121.77" class="difflineplus">+        getCalendarSearchService.m_obj = Cc[&quot;@mozilla.org/calendar/calendarsearch-service;1&quot;]</span>
<a href="#l121.78"></a><span id="l121.78" class="difflineplus">+                                           .getService(Ci.calICalendarSearchService);</span>
<a href="#l121.79"></a><span id="l121.79">     }</span>
<a href="#l121.80"></a><span id="l121.80">     return getCalendarSearchService.m_obj;</span>
<a href="#l121.81"></a><span id="l121.81"> }</span>
<a href="#l121.82"></a><span id="l121.82"> </span>
<a href="#l121.83"></a><span id="l121.83"> function getDomParser() {</span>
<a href="#l121.84"></a><span id="l121.84">     if (!getDomParser.m_obj) {</span>
<a href="#l121.85"></a><span id="l121.85">         getDomParser.m_obj = new DOMParser();</span>
<a href="#l121.86"></a><span id="l121.86">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l122.1"></a><span id="l122.1" class="difflineminus">--- a/calendar/providers/wcap/public/calIWcapCalendar.idl</span>
<a href="#l122.2"></a><span id="l122.2" class="difflineplus">+++ b/calendar/providers/wcap/public/calIWcapCalendar.idl</span>
<a href="#l122.3"></a><span id="l122.3" class="difflineat">@@ -247,22 +247,22 @@ interface calIWcapCalendar : calICalenda</span>
<a href="#l122.4"></a><span id="l122.4"> //      *                    xxx todo: change the above</span>
<a href="#l122.5"></a><span id="l122.5"> //      * @param accessControlBits access control bits (above AC_ definitions)</span>
<a href="#l122.6"></a><span id="l122.6"> //      * @param listener called when access control bits have been updated</span>
<a href="#l122.7"></a><span id="l122.7"> //      * @return optional object to track operation</span>
<a href="#l122.8"></a><span id="l122.8"> //      */</span>
<a href="#l122.9"></a><span id="l122.9"> //     calIOperation defineAccessControl(</span>
<a href="#l122.10"></a><span id="l122.10"> //         in string userId, in unsigned long accessControlBits,</span>
<a href="#l122.11"></a><span id="l122.11"> //         in calIGenericOperationListener listener);</span>
<a href="#l122.12"></a><span id="l122.12" class="difflineminus">-    </span>
<a href="#l122.13"></a><span id="l122.13" class="difflineplus">+</span>
<a href="#l122.14"></a><span id="l122.14"> //     /**</span>
<a href="#l122.15"></a><span id="l122.15"> //      * To reset a user's access control definition to the default ones</span>
<a href="#l122.16"></a><span id="l122.16"> //      * that everybody is granted.</span>
<a href="#l122.17"></a><span id="l122.17"> //      * In case the user has no specific access control definition,</span>
<a href="#l122.18"></a><span id="l122.18" class="difflineminus">-//      * Components.results.NS_ERROR_INVALID_ARG is thrown.</span>
<a href="#l122.19"></a><span id="l122.19" class="difflineplus">+//      * Cr.NS_ERROR_INVALID_ARG is thrown.</span>
<a href="#l122.20"></a><span id="l122.20"> //      *</span>
<a href="#l122.21"></a><span id="l122.21"> //      * @param userId user id</span>
<a href="#l122.22"></a><span id="l122.22"> //      * @param listener called when access control bits have been updated</span>
<a href="#l122.23"></a><span id="l122.23"> //      * @return optional object to track operation</span>
<a href="#l122.24"></a><span id="l122.24"> //      */</span>
<a href="#l122.25"></a><span id="l122.25"> //     calIOperation resetAccessControl(</span>
<a href="#l122.26"></a><span id="l122.26"> //         in string userId,</span>
<a href="#l122.27"></a><span id="l122.27"> //         in calIGenericOperationListener listener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l123.1"></a><span id="l123.1" class="difflineminus">--- a/calendar/resources/content/calendarCreation.js</span>
<a href="#l123.2"></a><span id="l123.2" class="difflineplus">+++ b/calendar/resources/content/calendarCreation.js</span>
<a href="#l123.3"></a><span id="l123.3" class="difflineat">@@ -73,18 +73,17 @@ function setNotification(aReason) {</span>
<a href="#l123.4"></a><span id="l123.4">  * the page is set up for the provider.</span>
<a href="#l123.5"></a><span id="l123.5">  *</span>
<a href="#l123.6"></a><span id="l123.6">  * @param type      The provider type selected</span>
<a href="#l123.7"></a><span id="l123.7">  */</span>
<a href="#l123.8"></a><span id="l123.8"> function onSelectProvider(type) {</span>
<a href="#l123.9"></a><span id="l123.9">     let cache = document.getElementById(&quot;cache&quot;);</span>
<a href="#l123.10"></a><span id="l123.10">     let tempCal;</span>
<a href="#l123.11"></a><span id="l123.11">     try {</span>
<a href="#l123.12"></a><span id="l123.12" class="difflineminus">-        tempCal = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]</span>
<a href="#l123.13"></a><span id="l123.13" class="difflineminus">-                            .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l123.14"></a><span id="l123.14" class="difflineplus">+        tempCal = Cc[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type].createInstance(Ci.calICalendar);</span>
<a href="#l123.15"></a><span id="l123.15">     } catch (e) {</span>
<a href="#l123.16"></a><span id="l123.16">         // keep tempCal undefined if the calendar can not be created</span>
<a href="#l123.17"></a><span id="l123.17">     }</span>
<a href="#l123.18"></a><span id="l123.18"> </span>
<a href="#l123.19"></a><span id="l123.19">     if (tempCal &amp;&amp; tempCal.getProperty(&quot;cache.always&quot;)) {</span>
<a href="#l123.20"></a><span id="l123.20">         cache.oldValue = cache.checked;</span>
<a href="#l123.21"></a><span id="l123.21">         cache.checked = true;</span>
<a href="#l123.22"></a><span id="l123.22">         cache.disabled = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l124.1"></a><span id="l124.1" class="difflineminus">--- a/calendar/resources/content/publish.js</span>
<a href="#l124.2"></a><span id="l124.2" class="difflineplus">+++ b/calendar/resources/content/publish.js</span>
<a href="#l124.3"></a><span id="l124.3" class="difflineat">@@ -106,66 +106,64 @@ function publishEntireCalendarDialogResp</span>
<a href="#l124.4"></a><span id="l124.4">                     let itemCopy = aItems[i].clone();</span>
<a href="#l124.5"></a><span id="l124.5">                     itemArray.push(itemCopy);</span>
<a href="#l124.6"></a><span id="l124.6">                 }</span>
<a href="#l124.7"></a><span id="l124.7">             }</span>
<a href="#l124.8"></a><span id="l124.8">         }</span>
<a href="#l124.9"></a><span id="l124.9">     };</span>
<a href="#l124.10"></a><span id="l124.10">     aProgressDialog.onStartUpload();</span>
<a href="#l124.11"></a><span id="l124.11">     let oldCalendar = CalendarPublishObject.calendar;</span>
<a href="#l124.12"></a><span id="l124.12" class="difflineminus">-    oldCalendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l124.13"></a><span id="l124.13" class="difflineplus">+    oldCalendar.getItems(Ci.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l124.14"></a><span id="l124.14">                          0, null, null, getListener);</span>
<a href="#l124.15"></a><span id="l124.15"> }</span>
<a href="#l124.16"></a><span id="l124.16"> </span>
<a href="#l124.17"></a><span id="l124.17"> function publishItemArray(aItemArray, aPath, aProgressDialog) {</span>
<a href="#l124.18"></a><span id="l124.18">     let outputStream;</span>
<a href="#l124.19"></a><span id="l124.19">     let inputStream;</span>
<a href="#l124.20"></a><span id="l124.20">     let storageStream;</span>
<a href="#l124.21"></a><span id="l124.21"> </span>
<a href="#l124.22"></a><span id="l124.22">     let icsURL = Services.io.newURI(aPath);</span>
<a href="#l124.23"></a><span id="l124.23"> </span>
<a href="#l124.24"></a><span id="l124.24">     let channel = Services.io.newChannelFromURI2(icsURL,</span>
<a href="#l124.25"></a><span id="l124.25">                                                  null,</span>
<a href="#l124.26"></a><span id="l124.26">                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l124.27"></a><span id="l124.27">                                                  null,</span>
<a href="#l124.28"></a><span id="l124.28" class="difflineminus">-                                                 Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l124.29"></a><span id="l124.29" class="difflineminus">-                                                 Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l124.30"></a><span id="l124.30" class="difflineplus">+                                                 Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l124.31"></a><span id="l124.31" class="difflineplus">+                                                 Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l124.32"></a><span id="l124.32">     if (icsURL.schemeIs(&quot;webcal&quot;)) {</span>
<a href="#l124.33"></a><span id="l124.33">         icsURL.scheme = &quot;http&quot;;</span>
<a href="#l124.34"></a><span id="l124.34">     }</span>
<a href="#l124.35"></a><span id="l124.35">     if (icsURL.schemeIs(&quot;webcals&quot;)) {</span>
<a href="#l124.36"></a><span id="l124.36">         icsURL.scheme = &quot;https&quot;;</span>
<a href="#l124.37"></a><span id="l124.37">     }</span>
<a href="#l124.38"></a><span id="l124.38"> </span>
<a href="#l124.39"></a><span id="l124.39">     switch (icsURL.scheme) {</span>
<a href="#l124.40"></a><span id="l124.40">         case &quot;http&quot;:</span>
<a href="#l124.41"></a><span id="l124.41">         case &quot;https&quot;:</span>
<a href="#l124.42"></a><span id="l124.42" class="difflineminus">-            channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l124.43"></a><span id="l124.43" class="difflineplus">+            channel = channel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l124.44"></a><span id="l124.44">             break;</span>
<a href="#l124.45"></a><span id="l124.45">         case &quot;ftp&quot;:</span>
<a href="#l124.46"></a><span id="l124.46" class="difflineminus">-            channel = channel.QueryInterface(Components.interfaces.nsIFTPChannel);</span>
<a href="#l124.47"></a><span id="l124.47" class="difflineplus">+            channel = channel.QueryInterface(Ci.nsIFTPChannel);</span>
<a href="#l124.48"></a><span id="l124.48">             break;</span>
<a href="#l124.49"></a><span id="l124.49">         case &quot;file&quot;:</span>
<a href="#l124.50"></a><span id="l124.50" class="difflineminus">-            channel = channel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l124.51"></a><span id="l124.51" class="difflineplus">+            channel = channel.QueryInterface(Ci.nsIFileChannel);</span>
<a href="#l124.52"></a><span id="l124.52">             break;</span>
<a href="#l124.53"></a><span id="l124.53">         default:</span>
<a href="#l124.54"></a><span id="l124.54">             dump(&quot;No such scheme\n&quot;);</span>
<a href="#l124.55"></a><span id="l124.55">             return;</span>
<a href="#l124.56"></a><span id="l124.56">     }</span>
<a href="#l124.57"></a><span id="l124.57"> </span>
<a href="#l124.58"></a><span id="l124.58" class="difflineminus">-    let uploadChannel = channel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l124.59"></a><span id="l124.59" class="difflineplus">+    let uploadChannel = channel.QueryInterface(Ci.nsIUploadChannel);</span>
<a href="#l124.60"></a><span id="l124.60">     uploadChannel.notificationCallbacks = notificationCallbacks;</span>
<a href="#l124.61"></a><span id="l124.61"> </span>
<a href="#l124.62"></a><span id="l124.62" class="difflineminus">-    storageStream = Components.classes[&quot;@mozilla.org/storagestream;1&quot;]</span>
<a href="#l124.63"></a><span id="l124.63" class="difflineminus">-                                  .createInstance(Components.interfaces.nsIStorageStream);</span>
<a href="#l124.64"></a><span id="l124.64" class="difflineplus">+    storageStream = Cc[&quot;@mozilla.org/storagestream;1&quot;].createInstance(Ci.nsIStorageStream);</span>
<a href="#l124.65"></a><span id="l124.65">     storageStream.init(32768, 0xffffffff, null);</span>
<a href="#l124.66"></a><span id="l124.66">     outputStream = storageStream.getOutputStream(0);</span>
<a href="#l124.67"></a><span id="l124.67"> </span>
<a href="#l124.68"></a><span id="l124.68" class="difflineminus">-    let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l124.69"></a><span id="l124.69" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l124.70"></a><span id="l124.70" class="difflineplus">+    let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;].createInstance(Ci.calIIcsSerializer);</span>
<a href="#l124.71"></a><span id="l124.71">     serializer.addItems(aItemArray, aItemArray.length);</span>
<a href="#l124.72"></a><span id="l124.72">     // Outlook requires METHOD:PUBLISH property:</span>
<a href="#l124.73"></a><span id="l124.73">     let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l124.74"></a><span id="l124.74">     methodProp.value = &quot;PUBLISH&quot;;</span>
<a href="#l124.75"></a><span id="l124.75">     serializer.addProperty(methodProp);</span>
<a href="#l124.76"></a><span id="l124.76">     serializer.serializeToStream(outputStream);</span>
<a href="#l124.77"></a><span id="l124.77">     outputStream.close();</span>
<a href="#l124.78"></a><span id="l124.78"> </span>
<a href="#l124.79"></a><span id="l124.79" class="difflineat">@@ -180,39 +178,39 @@ function publishItemArray(aItemArray, aP</span>
<a href="#l124.80"></a><span id="l124.80">                               cal.l10n.getCalString(&quot;otherPutError&quot;, [e.message]));</span>
<a href="#l124.81"></a><span id="l124.81">     }</span>
<a href="#l124.82"></a><span id="l124.82"> }</span>
<a href="#l124.83"></a><span id="l124.83"> </span>
<a href="#l124.84"></a><span id="l124.84"> </span>
<a href="#l124.85"></a><span id="l124.85"> var notificationCallbacks = {</span>
<a href="#l124.86"></a><span id="l124.86">     // nsIInterfaceRequestor interface</span>
<a href="#l124.87"></a><span id="l124.87">     getInterface: function(iid, instance) {</span>
<a href="#l124.88"></a><span id="l124.88" class="difflineminus">-        if (iid.equals(Components.interfaces.nsIAuthPrompt)) {</span>
<a href="#l124.89"></a><span id="l124.89" class="difflineplus">+        if (iid.equals(Ci.nsIAuthPrompt)) {</span>
<a href="#l124.90"></a><span id="l124.90">             // use the window watcher service to get a nsIAuthPrompt impl</span>
<a href="#l124.91"></a><span id="l124.91">             return Services.ww.getNewAuthPrompter(null);</span>
<a href="#l124.92"></a><span id="l124.92">         }</span>
<a href="#l124.93"></a><span id="l124.93"> </span>
<a href="#l124.94"></a><span id="l124.94" class="difflineminus">-        throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l124.95"></a><span id="l124.95" class="difflineplus">+        throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l124.96"></a><span id="l124.96">     }</span>
<a href="#l124.97"></a><span id="l124.97"> };</span>
<a href="#l124.98"></a><span id="l124.98"> </span>
<a href="#l124.99"></a><span id="l124.99"> </span>
<a href="#l124.100"></a><span id="l124.100"> var publishingListener = {</span>
<a href="#l124.101"></a><span id="l124.101">     QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l124.102"></a><span id="l124.102"> </span>
<a href="#l124.103"></a><span id="l124.103">     onStartRequest: function(request, ctxt) {</span>
<a href="#l124.104"></a><span id="l124.104">     },</span>
<a href="#l124.105"></a><span id="l124.105"> </span>
<a href="#l124.106"></a><span id="l124.106">     onStopRequest: function(request, ctxt, status, errorMsg) {</span>
<a href="#l124.107"></a><span id="l124.107">         ctxt.wrappedJSObject.onStopUpload();</span>
<a href="#l124.108"></a><span id="l124.108"> </span>
<a href="#l124.109"></a><span id="l124.109">         let channel;</span>
<a href="#l124.110"></a><span id="l124.110">         let requestSucceeded;</span>
<a href="#l124.111"></a><span id="l124.111">         try {</span>
<a href="#l124.112"></a><span id="l124.112" class="difflineminus">-            channel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l124.113"></a><span id="l124.113" class="difflineplus">+            channel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l124.114"></a><span id="l124.114">             requestSucceeded = channel.requestSucceeded;</span>
<a href="#l124.115"></a><span id="l124.115">         } catch (e) {</span>
<a href="#l124.116"></a><span id="l124.116">             // Don't fail if it is not a http channel, will be handled below</span>
<a href="#l124.117"></a><span id="l124.117">         }</span>
<a href="#l124.118"></a><span id="l124.118"> </span>
<a href="#l124.119"></a><span id="l124.119">         if (channel &amp;&amp; !requestSucceeded) {</span>
<a href="#l124.120"></a><span id="l124.120">             let body = cal.l10n.getCalString(&quot;httpPutError&quot;, [</span>
<a href="#l124.121"></a><span id="l124.121">                 channel.responseStatus, channel.responseStatusText</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l125.1"></a><span id="l125.1" class="difflineminus">--- a/calendar/test/mozmill/testLocalICS.js</span>
<a href="#l125.2"></a><span id="l125.2" class="difflineplus">+++ b/calendar/test/mozmill/testLocalICS.js</span>
<a href="#l125.3"></a><span id="l125.3" class="difflineat">@@ -63,20 +63,20 @@ function testLocalICS() {</span>
<a href="#l125.4"></a><span id="l125.4">     });</span>
<a href="#l125.5"></a><span id="l125.5"> </span>
<a href="#l125.6"></a><span id="l125.6">     // Assert presence in view.</span>
<a href="#l125.7"></a><span id="l125.7">     controller.waitForElement(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, `</span>
<a href="#l125.8"></a><span id="l125.8">         /{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${calendarName.toLowerCase()}&quot;}</span>
<a href="#l125.9"></a><span id="l125.9">     `));</span>
<a href="#l125.10"></a><span id="l125.10"> </span>
<a href="#l125.11"></a><span id="l125.11">     // Verify in file.</span>
<a href="#l125.12"></a><span id="l125.12" class="difflineminus">-    let fstream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l125.13"></a><span id="l125.13" class="difflineminus">-                            .createInstance(Components.interfaces.nsIFileInputStream);</span>
<a href="#l125.14"></a><span id="l125.14" class="difflineminus">-    let cstream = Components.classes[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l125.15"></a><span id="l125.15" class="difflineminus">-                            .createInstance(Components.interfaces.nsIConverterInputStream);</span>
<a href="#l125.16"></a><span id="l125.16" class="difflineplus">+    let fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l125.17"></a><span id="l125.17" class="difflineplus">+                    .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l125.18"></a><span id="l125.18" class="difflineplus">+    let cstream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l125.19"></a><span id="l125.19" class="difflineplus">+                    .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l125.20"></a><span id="l125.20"> </span>
<a href="#l125.21"></a><span id="l125.21">     // Wait a moment until file is written.</span>
<a href="#l125.22"></a><span id="l125.22">     controller.waitFor(() =&gt; calendarFile.exists());</span>
<a href="#l125.23"></a><span id="l125.23"> </span>
<a href="#l125.24"></a><span id="l125.24">     // Read the calendar file and check for the summary.</span>
<a href="#l125.25"></a><span id="l125.25">     fstream.init(calendarFile, -1, 0, 0);</span>
<a href="#l125.26"></a><span id="l125.26">     cstream.init(fstream, &quot;UTF-8&quot;, 0, 0);</span>
<a href="#l125.27"></a><span id="l125.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l126.1"></a><span id="l126.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l126.2"></a><span id="l126.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l126.3"></a><span id="l126.3" class="difflineat">@@ -17,17 +17,17 @@ ChromeUtils.import(&quot;resource://testing-c</span>
<a href="#l126.4"></a><span id="l126.4"> </span>
<a href="#l126.5"></a><span id="l126.5"> ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;, &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l126.6"></a><span id="l126.6"> </span>
<a href="#l126.7"></a><span id="l126.7"> updateAppInfo();</span>
<a href="#l126.8"></a><span id="l126.8"> </span>
<a href="#l126.9"></a><span id="l126.9"> (function() {</span>
<a href="#l126.10"></a><span id="l126.10">     let manager = Cc[&quot;@mozilla.org/component-manager-extra;1&quot;].getService(Ci.nsIComponentManagerExtra);</span>
<a href="#l126.11"></a><span id="l126.11"> </span>
<a href="#l126.12"></a><span id="l126.12" class="difflineminus">-    let bindir = Services.dirsvc.get(&quot;CurProcD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l126.13"></a><span id="l126.13" class="difflineplus">+    let bindir = Services.dirsvc.get(&quot;CurProcD&quot;, Ci.nsIFile);</span>
<a href="#l126.14"></a><span id="l126.14">     if (!AppConstants.NIGHTLY_BUILD) {</span>
<a href="#l126.15"></a><span id="l126.15">         bindir.append(&quot;distribution&quot;);</span>
<a href="#l126.16"></a><span id="l126.16">     }</span>
<a href="#l126.17"></a><span id="l126.17">     bindir.append(&quot;extensions&quot;);</span>
<a href="#l126.18"></a><span id="l126.18"> </span>
<a href="#l126.19"></a><span id="l126.19">     let xpiFile = bindir.clone();</span>
<a href="#l126.20"></a><span id="l126.20">     xpiFile.append(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}.xpi&quot;);</span>
<a href="#l126.21"></a><span id="l126.21"> </span>
<a href="#l126.22"></a><span id="l126.22" class="difflineat">@@ -39,80 +39,73 @@ updateAppInfo();</span>
<a href="#l126.23"></a><span id="l126.23">         // Use the unpacked version instead.</span>
<a href="#l126.24"></a><span id="l126.24">         bindir.append(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;);</span>
<a href="#l126.25"></a><span id="l126.25">         dump(&quot;Loading &quot; + bindir.path + &quot;\n&quot;);</span>
<a href="#l126.26"></a><span id="l126.26">         manager.addLegacyExtensionManifestLocation(bindir);</span>
<a href="#l126.27"></a><span id="l126.27">     }</span>
<a href="#l126.28"></a><span id="l126.28"> </span>
<a href="#l126.29"></a><span id="l126.29">     // Make sure to load the backend loader as early as possible, as xpcshell doesn't have the</span>
<a href="#l126.30"></a><span id="l126.30">     // normal app flow with profile-after-change et al.</span>
<a href="#l126.31"></a><span id="l126.31" class="difflineminus">-    Components.classes[&quot;@mozilla.org/calendar/backend-loader;1&quot;].getService();</span>
<a href="#l126.32"></a><span id="l126.32" class="difflineplus">+    Cc[&quot;@mozilla.org/calendar/backend-loader;1&quot;].getService();</span>
<a href="#l126.33"></a><span id="l126.33"> })();</span>
<a href="#l126.34"></a><span id="l126.34"> </span>
<a href="#l126.35"></a><span id="l126.35"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l126.36"></a><span id="l126.36"> </span>
<a href="#l126.37"></a><span id="l126.37"> function createDate(aYear, aMonth, aDay, aHasTime, aHour, aMinute, aSecond, aTimezone) {</span>
<a href="#l126.38"></a><span id="l126.38" class="difflineminus">-    let date = Cc[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l126.39"></a><span id="l126.39" class="difflineminus">-               .createInstance(Ci.calIDateTime);</span>
<a href="#l126.40"></a><span id="l126.40" class="difflineplus">+    let date = Cc[&quot;@mozilla.org/calendar/datetime;1&quot;].createInstance(Ci.calIDateTime);</span>
<a href="#l126.41"></a><span id="l126.41">     date.resetTo(aYear,</span>
<a href="#l126.42"></a><span id="l126.42">                aMonth,</span>
<a href="#l126.43"></a><span id="l126.43">                aDay,</span>
<a href="#l126.44"></a><span id="l126.44">                aHour || 0,</span>
<a href="#l126.45"></a><span id="l126.45">                aMinute || 0,</span>
<a href="#l126.46"></a><span id="l126.46">                aSecond || 0,</span>
<a href="#l126.47"></a><span id="l126.47">                aTimezone || cal.dtz.UTC);</span>
<a href="#l126.48"></a><span id="l126.48">     date.isDate = !aHasTime;</span>
<a href="#l126.49"></a><span id="l126.49">     return date;</span>
<a href="#l126.50"></a><span id="l126.50"> }</span>
<a href="#l126.51"></a><span id="l126.51"> </span>
<a href="#l126.52"></a><span id="l126.52"> function createEventFromIcalString(icalString) {</span>
<a href="#l126.53"></a><span id="l126.53">     if (/^BEGIN:VCALENDAR/.test(icalString)) {</span>
<a href="#l126.54"></a><span id="l126.54" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l126.55"></a><span id="l126.55" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l126.56"></a><span id="l126.56" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l126.57"></a><span id="l126.57">         parser.parseString(icalString);</span>
<a href="#l126.58"></a><span id="l126.58">         let items = parser.getItems({});</span>
<a href="#l126.59"></a><span id="l126.59">         cal.ASSERT(items.length == 1);</span>
<a href="#l126.60"></a><span id="l126.60">         return items[0];</span>
<a href="#l126.61"></a><span id="l126.61">     } else {</span>
<a href="#l126.62"></a><span id="l126.62">         let event = Cc[&quot;@mozilla.org/calendar/event;1&quot;].createInstance(Ci.calIEvent);</span>
<a href="#l126.63"></a><span id="l126.63">         event.icalString = icalString;</span>
<a href="#l126.64"></a><span id="l126.64">         return event;</span>
<a href="#l126.65"></a><span id="l126.65">     }</span>
<a href="#l126.66"></a><span id="l126.66"> }</span>
<a href="#l126.67"></a><span id="l126.67"> </span>
<a href="#l126.68"></a><span id="l126.68"> function createTodoFromIcalString(icalString) {</span>
<a href="#l126.69"></a><span id="l126.69" class="difflineminus">-    let todo = Cc[&quot;@mozilla.org/calendar/todo;1&quot;]</span>
<a href="#l126.70"></a><span id="l126.70" class="difflineminus">-               .createInstance(Ci.calITodo);</span>
<a href="#l126.71"></a><span id="l126.71" class="difflineplus">+    let todo = Cc[&quot;@mozilla.org/calendar/todo;1&quot;].createInstance(Ci.calITodo);</span>
<a href="#l126.72"></a><span id="l126.72">     todo.icalString = icalString;</span>
<a href="#l126.73"></a><span id="l126.73">     return todo;</span>
<a href="#l126.74"></a><span id="l126.74"> }</span>
<a href="#l126.75"></a><span id="l126.75"> </span>
<a href="#l126.76"></a><span id="l126.76"> function getMemoryCal() {</span>
<a href="#l126.77"></a><span id="l126.77" class="difflineminus">-    return Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l126.78"></a><span id="l126.78" class="difflineminus">-             .createInstance(Ci.calISyncWriteCalendar);</span>
<a href="#l126.79"></a><span id="l126.79" class="difflineplus">+    return Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;].createInstance(Ci.calISyncWriteCalendar);</span>
<a href="#l126.80"></a><span id="l126.80"> }</span>
<a href="#l126.81"></a><span id="l126.81"> </span>
<a href="#l126.82"></a><span id="l126.82"> function getStorageCal() {</span>
<a href="#l126.83"></a><span id="l126.83">     // Whenever we get the storage calendar we need to request a profile,</span>
<a href="#l126.84"></a><span id="l126.84">     // otherwise the cleanup functions will not run</span>
<a href="#l126.85"></a><span id="l126.85">     do_get_profile();</span>
<a href="#l126.86"></a><span id="l126.86"> </span>
<a href="#l126.87"></a><span id="l126.87">     // create URI</span>
<a href="#l126.88"></a><span id="l126.88">     let db = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l126.89"></a><span id="l126.89">     db.append(&quot;test_storage.sqlite&quot;);</span>
<a href="#l126.90"></a><span id="l126.90">     let uri = Services.io.newFileURI(db);</span>
<a href="#l126.91"></a><span id="l126.91"> </span>
<a href="#l126.92"></a><span id="l126.92">     // Make sure timezone service is initialized</span>
<a href="#l126.93"></a><span id="l126.93" class="difflineminus">-    Components.classes[&quot;@mozilla.org/calendar/timezone-service;1&quot;]</span>
<a href="#l126.94"></a><span id="l126.94" class="difflineminus">-              .getService(Components.interfaces.calIStartupService)</span>
<a href="#l126.95"></a><span id="l126.95" class="difflineminus">-              .startup(null);</span>
<a href="#l126.96"></a><span id="l126.96" class="difflineplus">+    Cc[&quot;@mozilla.org/calendar/timezone-service;1&quot;].getService(Ci.calIStartupService).startup(null);</span>
<a href="#l126.97"></a><span id="l126.97"> </span>
<a href="#l126.98"></a><span id="l126.98">     // create storage calendar</span>
<a href="#l126.99"></a><span id="l126.99" class="difflineminus">-    let stor = Cc[&quot;@mozilla.org/calendar/calendar;1?type=storage&quot;]</span>
<a href="#l126.100"></a><span id="l126.100" class="difflineminus">-              .createInstance(Ci.calISyncWriteCalendar);</span>
<a href="#l126.101"></a><span id="l126.101" class="difflineplus">+    let stor = Cc[&quot;@mozilla.org/calendar/calendar;1?type=storage&quot;].createInstance(Ci.calISyncWriteCalendar);</span>
<a href="#l126.102"></a><span id="l126.102">     stor.uri = uri;</span>
<a href="#l126.103"></a><span id="l126.103">     stor.id = cal.getUUID();</span>
<a href="#l126.104"></a><span id="l126.104">     return stor;</span>
<a href="#l126.105"></a><span id="l126.105"> }</span>
<a href="#l126.106"></a><span id="l126.106"> </span>
<a href="#l126.107"></a><span id="l126.107"> /**</span>
<a href="#l126.108"></a><span id="l126.108">  * Return an item property as string.</span>
<a href="#l126.109"></a><span id="l126.109">  * @param aItem</span>
<a href="#l126.110"></a><span id="l126.110" class="difflineat">@@ -287,18 +280,17 @@ function do_calendar_startup(callback) {</span>
<a href="#l126.111"></a><span id="l126.111">     let obs = {</span>
<a href="#l126.112"></a><span id="l126.112">         observe: function() {</span>
<a href="#l126.113"></a><span id="l126.113">             Services.obs.removeObserver(this, &quot;calendar-startup-done&quot;);</span>
<a href="#l126.114"></a><span id="l126.114">             do_test_finished();</span>
<a href="#l126.115"></a><span id="l126.115">             executeSoon(callback);</span>
<a href="#l126.116"></a><span id="l126.116">         }</span>
<a href="#l126.117"></a><span id="l126.117">     };</span>
<a href="#l126.118"></a><span id="l126.118"> </span>
<a href="#l126.119"></a><span id="l126.119" class="difflineminus">-    let startupService = Components.classes[&quot;@mozilla.org/calendar/startup-service;1&quot;]</span>
<a href="#l126.120"></a><span id="l126.120" class="difflineminus">-                                   .getService(Components.interfaces.nsISupports).wrappedJSObject;</span>
<a href="#l126.121"></a><span id="l126.121" class="difflineplus">+    let startupService = Cc[&quot;@mozilla.org/calendar/startup-service;1&quot;].getService(Ci.nsISupports).wrappedJSObject;</span>
<a href="#l126.122"></a><span id="l126.122"> </span>
<a href="#l126.123"></a><span id="l126.123">     if (startupService.started) {</span>
<a href="#l126.124"></a><span id="l126.124">         callback();</span>
<a href="#l126.125"></a><span id="l126.125">     } else {</span>
<a href="#l126.126"></a><span id="l126.126">         do_test_pending();</span>
<a href="#l126.127"></a><span id="l126.127">         Services.obs.addObserver(obs, &quot;calendar-startup-done&quot;);</span>
<a href="#l126.128"></a><span id="l126.128">         if (_profileInitialized) {</span>
<a href="#l126.129"></a><span id="l126.129">             Services.obs.notifyObservers(null, &quot;profile-after-change&quot;, &quot;xpcshell-do-get-profile&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l127.1"></a><span id="l127.1" class="difflineminus">--- a/calendar/test/unit/test_alarm.js</span>
<a href="#l127.2"></a><span id="l127.2" class="difflineplus">+++ b/calendar/test/unit/test_alarm.js</span>
<a href="#l127.3"></a><span id="l127.3" class="difflineat">@@ -84,17 +84,17 @@ function test_email_alarm() {</span>
<a href="#l127.4"></a><span id="l127.4">     alarm.description = &quot;description&quot;;</span>
<a href="#l127.5"></a><span id="l127.5">     equal(alarm.description, &quot;description&quot;);</span>
<a href="#l127.6"></a><span id="l127.6"> </span>
<a href="#l127.7"></a><span id="l127.7">     // Set a Summary, REQUIRED for ACTION:EMAIL</span>
<a href="#l127.8"></a><span id="l127.8">     alarm.summary = &quot;summary&quot;;</span>
<a href="#l127.9"></a><span id="l127.9">     equal(alarm.summary, &quot;summary&quot;);</span>
<a href="#l127.10"></a><span id="l127.10"> </span>
<a href="#l127.11"></a><span id="l127.11">     // Set an offset of some sort</span>
<a href="#l127.12"></a><span id="l127.12" class="difflineminus">-    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l127.13"></a><span id="l127.13" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l127.14"></a><span id="l127.14">     alarm.offset = cal.createDuration();</span>
<a href="#l127.15"></a><span id="l127.15"> </span>
<a href="#l127.16"></a><span id="l127.16">     // Check for at least one attendee</span>
<a href="#l127.17"></a><span id="l127.17">     let attendee1 = cal.createAttendee();</span>
<a href="#l127.18"></a><span id="l127.18">     attendee1.id = &quot;mailto:horst&quot;;</span>
<a href="#l127.19"></a><span id="l127.19">     let attendee2 = cal.createAttendee();</span>
<a href="#l127.20"></a><span id="l127.20">     attendee2.id = &quot;mailto:gustav&quot;;</span>
<a href="#l127.21"></a><span id="l127.21"> </span>
<a href="#l127.22"></a><span id="l127.22" class="difflineat">@@ -133,17 +133,17 @@ function test_email_alarm() {</span>
<a href="#l127.23"></a><span id="l127.23"> </span>
<a href="#l127.24"></a><span id="l127.24">     // TODO test attachments</span>
<a href="#l127.25"></a><span id="l127.25">     dump(&quot;Done\n&quot;);</span>
<a href="#l127.26"></a><span id="l127.26"> }</span>
<a href="#l127.27"></a><span id="l127.27"> </span>
<a href="#l127.28"></a><span id="l127.28"> function test_audio_alarm() {</span>
<a href="#l127.29"></a><span id="l127.29">     dump(&quot;Testing AUDIO alarms...&quot;);</span>
<a href="#l127.30"></a><span id="l127.30">     let alarm = cal.createAlarm();</span>
<a href="#l127.31"></a><span id="l127.31" class="difflineminus">-    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l127.32"></a><span id="l127.32" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l127.33"></a><span id="l127.33">     alarm.alarmDate = cal.createDateTime();</span>
<a href="#l127.34"></a><span id="l127.34">     // Set ACTION to AUDIO, make sure this was not rejected</span>
<a href="#l127.35"></a><span id="l127.35">     alarm.action = &quot;AUDIO&quot;;</span>
<a href="#l127.36"></a><span id="l127.36">     equal(alarm.action, &quot;AUDIO&quot;);</span>
<a href="#l127.37"></a><span id="l127.37"> </span>
<a href="#l127.38"></a><span id="l127.38">     // No Description for ACTION:AUDIO</span>
<a href="#l127.39"></a><span id="l127.39">     alarm.description = &quot;description&quot;;</span>
<a href="#l127.40"></a><span id="l127.40">     equal(alarm.description, null);</span>
<a href="#l127.41"></a><span id="l127.41" class="difflineat">@@ -305,17 +305,17 @@ function test_repeat() {</span>
<a href="#l127.42"></a><span id="l127.42">     }</span>
<a href="#l127.43"></a><span id="l127.43"> </span>
<a href="#l127.44"></a><span id="l127.44">     // Check unset value</span>
<a href="#l127.45"></a><span id="l127.45">     equal(alarm.repeat, 0);</span>
<a href="#l127.46"></a><span id="l127.46">     equal(alarm.repeatOffset, null);</span>
<a href="#l127.47"></a><span id="l127.47"> </span>
<a href="#l127.48"></a><span id="l127.48">     // Check repeatDate</span>
<a href="#l127.49"></a><span id="l127.49">     alarm = cal.createAlarm();</span>
<a href="#l127.50"></a><span id="l127.50" class="difflineminus">-    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l127.51"></a><span id="l127.51" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l127.52"></a><span id="l127.52">     alarm.alarmDate = cal.createDateTime();</span>
<a href="#l127.53"></a><span id="l127.53">     alarm.repeat = 1;</span>
<a href="#l127.54"></a><span id="l127.54">     alarm.repeatOffset = cal.createDuration();</span>
<a href="#l127.55"></a><span id="l127.55">     alarm.repeatOffset.inSeconds = 3600;</span>
<a href="#l127.56"></a><span id="l127.56"> </span>
<a href="#l127.57"></a><span id="l127.57">     let date = alarm.alarmDate.clone();</span>
<a href="#l127.58"></a><span id="l127.58">     date.second += 3600;</span>
<a href="#l127.59"></a><span id="l127.59">     equal(alarm.repeatDate.icalString, date.icalString);</span>
<a href="#l127.60"></a><span id="l127.60" class="difflineat">@@ -429,17 +429,17 @@ function test_immutable() {</span>
<a href="#l127.61"></a><span id="l127.61">     alarm.makeImmutable();</span>
<a href="#l127.62"></a><span id="l127.62">     ok(!alarm.isMutable);</span>
<a href="#l127.63"></a><span id="l127.63"> </span>
<a href="#l127.64"></a><span id="l127.64">     // Check each attribute</span>
<a href="#l127.65"></a><span id="l127.65">     for (let prop in propMap) {</span>
<a href="#l127.66"></a><span id="l127.66">         try {</span>
<a href="#l127.67"></a><span id="l127.67">             alarm[prop] = propMap[prop];</span>
<a href="#l127.68"></a><span id="l127.68">         } catch (e) {</span>
<a href="#l127.69"></a><span id="l127.69" class="difflineminus">-            equal(e.result, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l127.70"></a><span id="l127.70" class="difflineplus">+            equal(e.result, Cr.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l127.71"></a><span id="l127.71">             continue;</span>
<a href="#l127.72"></a><span id="l127.72">         }</span>
<a href="#l127.73"></a><span id="l127.73">         do_throw(&quot;Attribute &quot; + prop + &quot; was writable while item was immutable&quot;);</span>
<a href="#l127.74"></a><span id="l127.74">     }</span>
<a href="#l127.75"></a><span id="l127.75"> </span>
<a href="#l127.76"></a><span id="l127.76">     // Functions</span>
<a href="#l127.77"></a><span id="l127.77">     throws(() =&gt; {</span>
<a href="#l127.78"></a><span id="l127.78">         alarm.setProperty(&quot;X-FOO&quot;, &quot;changed&quot;);</span>
<a href="#l127.79"></a><span id="l127.79" class="difflineat">@@ -595,26 +595,26 @@ function test_serialize() {</span>
<a href="#l127.80"></a><span id="l127.80">     }, /Illegal value/, &quot;Invalid Argument&quot;);</span>
<a href="#l127.81"></a><span id="l127.81"> }</span>
<a href="#l127.82"></a><span id="l127.82"> </span>
<a href="#l127.83"></a><span id="l127.83"> function test_strings() {</span>
<a href="#l127.84"></a><span id="l127.84">     // Serializing the string shouldn't throw, but we don't really care about</span>
<a href="#l127.85"></a><span id="l127.85">     // the string itself.</span>
<a href="#l127.86"></a><span id="l127.86">     let alarm = cal.createAlarm();</span>
<a href="#l127.87"></a><span id="l127.87">     alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l127.88"></a><span id="l127.88" class="difflineminus">-    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l127.89"></a><span id="l127.89" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l127.90"></a><span id="l127.90">     alarm.alarmDate = cal.createDateTime();</span>
<a href="#l127.91"></a><span id="l127.91">     alarm.toString();</span>
<a href="#l127.92"></a><span id="l127.92"> </span>
<a href="#l127.93"></a><span id="l127.93" class="difflineminus">-    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l127.94"></a><span id="l127.94" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l127.95"></a><span id="l127.95">     alarm.offset = cal.createDuration();</span>
<a href="#l127.96"></a><span id="l127.96">     alarm.toString();</span>
<a href="#l127.97"></a><span id="l127.97">     alarm.toString(cal.createTodo());</span>
<a href="#l127.98"></a><span id="l127.98"> </span>
<a href="#l127.99"></a><span id="l127.99" class="difflineminus">-    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l127.100"></a><span id="l127.100" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l127.101"></a><span id="l127.101">     alarm.offset = cal.createDuration();</span>
<a href="#l127.102"></a><span id="l127.102">     alarm.toString();</span>
<a href="#l127.103"></a><span id="l127.103">     alarm.toString(cal.createTodo());</span>
<a href="#l127.104"></a><span id="l127.104"> </span>
<a href="#l127.105"></a><span id="l127.105">     alarm.offset = cal.createDuration(&quot;P1D&quot;);</span>
<a href="#l127.106"></a><span id="l127.106">     alarm.toString();</span>
<a href="#l127.107"></a><span id="l127.107"> </span>
<a href="#l127.108"></a><span id="l127.108">     alarm.offset = cal.createDuration(&quot;PT1H&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l128.1"></a><span id="l128.1" class="difflineminus">--- a/calendar/test/unit/test_alarmservice.js</span>
<a href="#l128.2"></a><span id="l128.2" class="difflineplus">+++ b/calendar/test/unit/test_alarmservice.js</span>
<a href="#l128.3"></a><span id="l128.3" class="difflineat">@@ -133,19 +133,17 @@ function run_test() {</span>
<a href="#l128.4"></a><span id="l128.4">     add_test(test_addItems);</span>
<a href="#l128.5"></a><span id="l128.5">     add_test(test_loadCalendar);</span>
<a href="#l128.6"></a><span id="l128.6">     add_test(test_modifyItems);</span>
<a href="#l128.7"></a><span id="l128.7"> </span>
<a href="#l128.8"></a><span id="l128.8">     run_next_test();</span>
<a href="#l128.9"></a><span id="l128.9"> }</span>
<a href="#l128.10"></a><span id="l128.10"> </span>
<a href="#l128.11"></a><span id="l128.11"> function initializeAlarmService() {</span>
<a href="#l128.12"></a><span id="l128.12" class="difflineminus">-    alarmObserver.service = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l128.13"></a><span id="l128.13" class="difflineminus">-                                       .getService(Components.interfaces.calIAlarmService)</span>
<a href="#l128.14"></a><span id="l128.14" class="difflineminus">-                                       .wrappedJSObject;</span>
<a href="#l128.15"></a><span id="l128.15" class="difflineplus">+    alarmObserver.service = Cc[&quot;@mozilla.org/calendar/alarm-service;1&quot;].getService(Ci.calIAlarmService).wrappedJSObject;</span>
<a href="#l128.16"></a><span id="l128.16">     ok(!alarmObserver.service.mStarted);</span>
<a href="#l128.17"></a><span id="l128.17">     alarmObserver.service.startup(null);</span>
<a href="#l128.18"></a><span id="l128.18">     ok(alarmObserver.service.mStarted);</span>
<a href="#l128.19"></a><span id="l128.19"> </span>
<a href="#l128.20"></a><span id="l128.20">     // we need to replace the existing observers with our observer</span>
<a href="#l128.21"></a><span id="l128.21">     for (let obs of alarmObserver.service.mObservers.values()) {</span>
<a href="#l128.22"></a><span id="l128.22">         alarmObserver.service.removeObserver(obs);</span>
<a href="#l128.23"></a><span id="l128.23">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l129.1"></a><span id="l129.1" class="difflineminus">--- a/calendar/test/unit/test_bug1199942.js</span>
<a href="#l129.2"></a><span id="l129.2" class="difflineplus">+++ b/calendar/test/unit/test_bug1199942.js</span>
<a href="#l129.3"></a><span id="l129.3" class="difflineat">@@ -54,16 +54,15 @@ function serializeEvent_test() {</span>
<a href="#l129.4"></a><span id="l129.4">     let attendees = event.getAttendees({});</span>
<a href="#l129.5"></a><span id="l129.5"> </span>
<a href="#l129.6"></a><span id="l129.6">     // check whether all attendees get returned with expected id</span>
<a href="#l129.7"></a><span id="l129.7">     for (let attendee of attendees) {</span>
<a href="#l129.8"></a><span id="l129.8">         ok(expectedIds.includes(attendee.id));</span>
<a href="#l129.9"></a><span id="l129.9">     }</span>
<a href="#l129.10"></a><span id="l129.10"> </span>
<a href="#l129.11"></a><span id="l129.11">     // serialize the event again and check whether the attendees still are in shape</span>
<a href="#l129.12"></a><span id="l129.12" class="difflineminus">-    let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l129.13"></a><span id="l129.13" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l129.14"></a><span id="l129.14" class="difflineplus">+    let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;].createInstance(Ci.calIIcsSerializer);</span>
<a href="#l129.15"></a><span id="l129.15">     serializer.addItems([event], [event].length);</span>
<a href="#l129.16"></a><span id="l129.16">     let serialized = ics_unfoldline(serializer.serializeToString());</span>
<a href="#l129.17"></a><span id="l129.17">     for (let id of expectedIds) {</span>
<a href="#l129.18"></a><span id="l129.18">         ok(serialized.search(id) != -1);</span>
<a href="#l129.19"></a><span id="l129.19">     }</span>
<a href="#l129.20"></a><span id="l129.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l130.1"></a><span id="l130.1" class="difflineminus">--- a/calendar/test/unit/test_bug350845.js</span>
<a href="#l130.2"></a><span id="l130.2" class="difflineplus">+++ b/calendar/test/unit/test_bug350845.js</span>
<a href="#l130.3"></a><span id="l130.3" class="difflineat">@@ -28,17 +28,17 @@ function run_test() {</span>
<a href="#l130.4"></a><span id="l130.4">     // Enumerator</span>
<a href="#l130.5"></a><span id="l130.5">     throws(() =&gt; {</span>
<a href="#l130.6"></a><span id="l130.6">         event.getParameterEnumerator(&quot;X-UNKNOWN&quot;);</span>
<a href="#l130.7"></a><span id="l130.7">     }, /Property X-UNKNOWN not set/);</span>
<a href="#l130.8"></a><span id="l130.8"> </span>
<a href="#l130.9"></a><span id="l130.9">     // More enumerator</span>
<a href="#l130.10"></a><span id="l130.10">     let enume = event.getParameterEnumerator(&quot;X-FOO&quot;);</span>
<a href="#l130.11"></a><span id="l130.11">     ok(enume.hasMoreElements());</span>
<a href="#l130.12"></a><span id="l130.12" class="difflineminus">-    let xbar = enume.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l130.13"></a><span id="l130.13" class="difflineplus">+    let xbar = enume.getNext().QueryInterface(Ci.nsIProperty);</span>
<a href="#l130.14"></a><span id="l130.14">     equal(xbar.name, &quot;X-BAR&quot;);</span>
<a href="#l130.15"></a><span id="l130.15">     equal(xbar.value, &quot;FNORD&quot;);</span>
<a href="#l130.16"></a><span id="l130.16">     ok(!enume.hasMoreElements());</span>
<a href="#l130.17"></a><span id="l130.17"> </span>
<a href="#l130.18"></a><span id="l130.18">     // Deletion of parameters when deleting properties</span>
<a href="#l130.19"></a><span id="l130.19">     event.deleteProperty(&quot;X-FOO&quot;);</span>
<a href="#l130.20"></a><span id="l130.20">     ok(!event.hasProperty(&quot;X-FOO&quot;));</span>
<a href="#l130.21"></a><span id="l130.21">     event.setProperty(&quot;X-FOO&quot;, &quot;SNORK&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l131.1"></a><span id="l131.1" class="difflineminus">--- a/calendar/test/unit/test_calmgr.js</span>
<a href="#l131.2"></a><span id="l131.2" class="difflineplus">+++ b/calendar/test/unit/test_calmgr.js</span>
<a href="#l131.3"></a><span id="l131.3" class="difflineat">@@ -32,34 +32,34 @@ add_test(function test_registration() {</span>
<a href="#l131.4"></a><span id="l131.4">     checkCalendarCount(0, 0, 0);</span>
<a href="#l131.5"></a><span id="l131.5"> </span>
<a href="#l131.6"></a><span id="l131.6">     // Create a local memory calendar, ths shouldn't register any calendars</span>
<a href="#l131.7"></a><span id="l131.7">     let memory = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-memory-calendar://&quot;));</span>
<a href="#l131.8"></a><span id="l131.8">     checkCalendarCount(0, 0, 0);</span>
<a href="#l131.9"></a><span id="l131.9"> </span>
<a href="#l131.10"></a><span id="l131.10">     // Register an observer to test it.</span>
<a href="#l131.11"></a><span id="l131.11">     let registered = false, unregistered = false, deleted = false, readOnly = false;</span>
<a href="#l131.12"></a><span id="l131.12" class="difflineminus">-    let mgrobs = cal.createAdapter(Components.interfaces.calICalendarManagerObserver, {</span>
<a href="#l131.13"></a><span id="l131.13" class="difflineplus">+    let mgrobs = cal.createAdapter(Ci.calICalendarManagerObserver, {</span>
<a href="#l131.14"></a><span id="l131.14">         onCalendarRegistered: function(aCalendar) {</span>
<a href="#l131.15"></a><span id="l131.15">             if (aCalendar.id == memory.id) {</span>
<a href="#l131.16"></a><span id="l131.16">                 registered = true;</span>
<a href="#l131.17"></a><span id="l131.17">             }</span>
<a href="#l131.18"></a><span id="l131.18">         },</span>
<a href="#l131.19"></a><span id="l131.19">         onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l131.20"></a><span id="l131.20">             if (aCalendar.id == memory.id) {</span>
<a href="#l131.21"></a><span id="l131.21">                 unregistered = true;</span>
<a href="#l131.22"></a><span id="l131.22">             }</span>
<a href="#l131.23"></a><span id="l131.23">         },</span>
<a href="#l131.24"></a><span id="l131.24">         onCalendarDeleting: function(aCalendar) {</span>
<a href="#l131.25"></a><span id="l131.25">             if (aCalendar.id == memory.id) {</span>
<a href="#l131.26"></a><span id="l131.26">                 deleted = true;</span>
<a href="#l131.27"></a><span id="l131.27">             }</span>
<a href="#l131.28"></a><span id="l131.28">         }</span>
<a href="#l131.29"></a><span id="l131.29">     });</span>
<a href="#l131.30"></a><span id="l131.30" class="difflineminus">-    let calobs = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l131.31"></a><span id="l131.31" class="difflineplus">+    let calobs = cal.createAdapter(Ci.calIObserver, {</span>
<a href="#l131.32"></a><span id="l131.32">         onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l131.33"></a><span id="l131.33">             equal(aCalendar.id, memory.id);</span>
<a href="#l131.34"></a><span id="l131.34">             equal(aName, &quot;readOnly&quot;);</span>
<a href="#l131.35"></a><span id="l131.35">             readOnly = aValue;</span>
<a href="#l131.36"></a><span id="l131.36">         }</span>
<a href="#l131.37"></a><span id="l131.37">     });</span>
<a href="#l131.38"></a><span id="l131.38">     memory.addObserver(calobs);</span>
<a href="#l131.39"></a><span id="l131.39">     calmgr.addObserver(mgrobs);</span>
<a href="#l131.40"></a><span id="l131.40" class="difflineat">@@ -127,22 +127,22 @@ add_test(function test_calobserver() {</span>
<a href="#l131.41"></a><span id="l131.41"> </span>
<a href="#l131.42"></a><span id="l131.42">     // First of all we need a local calendar to work on and some variables</span>
<a href="#l131.43"></a><span id="l131.43">     let calmgr = cal.getCalendarManager();</span>
<a href="#l131.44"></a><span id="l131.44">     let memory = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-memory-calendar://&quot;));</span>
<a href="#l131.45"></a><span id="l131.45">     let memory2 = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-memory-calendar://&quot;));</span>
<a href="#l131.46"></a><span id="l131.46">     let calcounter, allcounter;</span>
<a href="#l131.47"></a><span id="l131.47"> </span>
<a href="#l131.48"></a><span id="l131.48">     // These observers will end up counting calls which we will use later on</span>
<a href="#l131.49"></a><span id="l131.49" class="difflineminus">-    let calobs = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l131.50"></a><span id="l131.50" class="difflineplus">+    let calobs = cal.createAdapter(Ci.calIObserver, {</span>
<a href="#l131.51"></a><span id="l131.51">         onAddItem: () =&gt; calcounter.addItem++,</span>
<a href="#l131.52"></a><span id="l131.52">         onModifyItem: () =&gt; calcounter.modifyItem++,</span>
<a href="#l131.53"></a><span id="l131.53">         onDeleteItem: () =&gt; calcounter.deleteItem++</span>
<a href="#l131.54"></a><span id="l131.54">     });</span>
<a href="#l131.55"></a><span id="l131.55" class="difflineminus">-    let allobs = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l131.56"></a><span id="l131.56" class="difflineplus">+    let allobs = cal.createAdapter(Ci.calIObserver, {</span>
<a href="#l131.57"></a><span id="l131.57">         onAddItem: () =&gt; allcounter.addItem++,</span>
<a href="#l131.58"></a><span id="l131.58">         onModifyItem: () =&gt; allcounter.modifyItem++,</span>
<a href="#l131.59"></a><span id="l131.59">         onDeleteItem: () =&gt; allcounter.deleteItem++</span>
<a href="#l131.60"></a><span id="l131.60">     });</span>
<a href="#l131.61"></a><span id="l131.61"> </span>
<a href="#l131.62"></a><span id="l131.62">     // Set up counters and observers</span>
<a href="#l131.63"></a><span id="l131.63">     resetCounters();</span>
<a href="#l131.64"></a><span id="l131.64">     calmgr.registerCalendar(memory);</span>
<a href="#l131.65"></a><span id="l131.65" class="difflineat">@@ -218,30 +218,29 @@ add_test(function test_removeModes() {</span>
<a href="#l131.66"></a><span id="l131.66">         memory.wrappedJSObject.deleteCalendar = function(calendar, listener) {</span>
<a href="#l131.67"></a><span id="l131.67">             deleteCalled = true;</span>
<a href="#l131.68"></a><span id="l131.68">             return oldDeleteCalendar.apply(this, arguments);</span>
<a href="#l131.69"></a><span id="l131.69">         };</span>
<a href="#l131.70"></a><span id="l131.70">     }</span>
<a href="#l131.71"></a><span id="l131.71"> </span>
<a href="#l131.72"></a><span id="l131.72">     // For better readability</span>
<a href="#l131.73"></a><span id="l131.73">     const SHOULD_DELETE = true, SHOULD_NOT_DELETE = false;</span>
<a href="#l131.74"></a><span id="l131.74" class="difflineminus">-    const cICM = Components.interfaces.calICalendarManager;</span>
<a href="#l131.75"></a><span id="l131.75"> </span>
<a href="#l131.76"></a><span id="l131.76">     let calmgr = cal.getCalendarManager();</span>
<a href="#l131.77"></a><span id="l131.77">     let memory = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-memory-calendar://&quot;));</span>
<a href="#l131.78"></a><span id="l131.78">     let baseCalendarCount = calmgr.calendarCount;</span>
<a href="#l131.79"></a><span id="l131.79">     let removeModes = null;</span>
<a href="#l131.80"></a><span id="l131.80">     let deleteCalled = false;</span>
<a href="#l131.81"></a><span id="l131.81"> </span>
<a href="#l131.82"></a><span id="l131.82">     mockCalendar(memory);</span>
<a href="#l131.83"></a><span id="l131.83"> </span>
<a href="#l131.84"></a><span id="l131.84">     checkCounts([], SHOULD_NOT_DELETE, 1);</span>
<a href="#l131.85"></a><span id="l131.85">     checkCounts([&quot;unsubscribe&quot;], SHOULD_NOT_DELETE, 0);</span>
<a href="#l131.86"></a><span id="l131.86">     checkCounts([&quot;unsubscribe&quot;, &quot;delete&quot;], SHOULD_DELETE, 0);</span>
<a href="#l131.87"></a><span id="l131.87" class="difflineminus">-    checkCounts([&quot;unsubscribe&quot;, &quot;delete&quot;], SHOULD_NOT_DELETE, 0, cICM.REMOVE_NO_DELETE);</span>
<a href="#l131.88"></a><span id="l131.88" class="difflineplus">+    checkCounts([&quot;unsubscribe&quot;, &quot;delete&quot;], SHOULD_NOT_DELETE, 0, Ci.calICalendarManager.REMOVE_NO_DELETE);</span>
<a href="#l131.89"></a><span id="l131.89">     checkCounts([&quot;delete&quot;], SHOULD_DELETE, 0);</span>
<a href="#l131.90"></a><span id="l131.90"> </span>
<a href="#l131.91"></a><span id="l131.91">     run_next_test();</span>
<a href="#l131.92"></a><span id="l131.92"> });</span>
<a href="#l131.93"></a><span id="l131.93"> </span>
<a href="#l131.94"></a><span id="l131.94"> add_test(function test_calprefs() {</span>
<a href="#l131.95"></a><span id="l131.95">     let prop;</span>
<a href="#l131.96"></a><span id="l131.96">     let calmgr = cal.getCalendarManager();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l132.1"></a><span id="l132.1" class="difflineminus">--- a/calendar/test/unit/test_data_bags.js</span>
<a href="#l132.2"></a><span id="l132.2" class="difflineplus">+++ b/calendar/test/unit/test_data_bags.js</span>
<a href="#l132.3"></a><span id="l132.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l132.4"></a><span id="l132.4"> </span>
<a href="#l132.5"></a><span id="l132.5"> function run_test() {</span>
<a href="#l132.6"></a><span id="l132.6">     test_listener_set();</span>
<a href="#l132.7"></a><span id="l132.7">     test_observer_set();</span>
<a href="#l132.8"></a><span id="l132.8">     test_operation_group();</span>
<a href="#l132.9"></a><span id="l132.9"> }</span>
<a href="#l132.10"></a><span id="l132.10"> </span>
<a href="#l132.11"></a><span id="l132.11"> function test_listener_set() {</span>
<a href="#l132.12"></a><span id="l132.12" class="difflineminus">-    let set = new cal.data.ListenerSet(Components.interfaces.calIOperationListener);</span>
<a href="#l132.13"></a><span id="l132.13" class="difflineplus">+    let set = new cal.data.ListenerSet(Ci.calIOperationListener);</span>
<a href="#l132.14"></a><span id="l132.14">     let listener1Id = null;</span>
<a href="#l132.15"></a><span id="l132.15">     let listener2Id = null;</span>
<a href="#l132.16"></a><span id="l132.16"> </span>
<a href="#l132.17"></a><span id="l132.17">     let listener1 = cal.createAdapter(&quot;calIOperationListener&quot;, {</span>
<a href="#l132.18"></a><span id="l132.18">         onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l132.19"></a><span id="l132.19">             listener1Id = aId;</span>
<a href="#l132.20"></a><span id="l132.20">         }</span>
<a href="#l132.21"></a><span id="l132.21">     });</span>
<a href="#l132.22"></a><span id="l132.22" class="difflineat">@@ -50,17 +50,17 @@ function test_listener_set() {</span>
<a href="#l132.23"></a><span id="l132.23">     });</span>
<a href="#l132.24"></a><span id="l132.24"> </span>
<a href="#l132.25"></a><span id="l132.25">     set.add(listener3);</span>
<a href="#l132.26"></a><span id="l132.26">     set.notify(&quot;onOperationComplete&quot;, [null, null, null, &quot;test3&quot;, null]);</span>
<a href="#l132.27"></a><span id="l132.27">     equal(called, 1);</span>
<a href="#l132.28"></a><span id="l132.28"> }</span>
<a href="#l132.29"></a><span id="l132.29"> </span>
<a href="#l132.30"></a><span id="l132.30"> function test_observer_set() {</span>
<a href="#l132.31"></a><span id="l132.31" class="difflineminus">-    let set = new cal.data.ObserverSet(Components.interfaces.calIObserver);</span>
<a href="#l132.32"></a><span id="l132.32" class="difflineplus">+    let set = new cal.data.ObserverSet(Ci.calIObserver);</span>
<a href="#l132.33"></a><span id="l132.33">     let listenerCountBegin1 = 0;</span>
<a href="#l132.34"></a><span id="l132.34">     let listenerCountBegin2 = 0;</span>
<a href="#l132.35"></a><span id="l132.35">     let listenerCountEnd1 = 0;</span>
<a href="#l132.36"></a><span id="l132.36">     let listenerCountEnd2 = 0;</span>
<a href="#l132.37"></a><span id="l132.37"> </span>
<a href="#l132.38"></a><span id="l132.38">     let listener1 = cal.createAdapter(&quot;calIObserver&quot;, {</span>
<a href="#l132.39"></a><span id="l132.39">         onStartBatch: function() {</span>
<a href="#l132.40"></a><span id="l132.40">             listenerCountBegin1++;</span>
<a href="#l132.41"></a><span id="l132.41" class="difflineat">@@ -111,41 +111,41 @@ function test_observer_set() {</span>
<a href="#l132.42"></a><span id="l132.42"> }</span>
<a href="#l132.43"></a><span id="l132.43"> </span>
<a href="#l132.44"></a><span id="l132.44"> function test_operation_group() {</span>
<a href="#l132.45"></a><span id="l132.45">     let calledCancel = false;</span>
<a href="#l132.46"></a><span id="l132.46">     let calledOperationCancel = null;</span>
<a href="#l132.47"></a><span id="l132.47">     let group = new cal.data.OperationGroup();</span>
<a href="#l132.48"></a><span id="l132.48">     ok(group.id.endsWith(&quot;-0&quot;));</span>
<a href="#l132.49"></a><span id="l132.49">     ok(group.isPending);</span>
<a href="#l132.50"></a><span id="l132.50" class="difflineminus">-    equal(group.status, Components.results.NS_OK);</span>
<a href="#l132.51"></a><span id="l132.51" class="difflineplus">+    equal(group.status, Cr.NS_OK);</span>
<a href="#l132.52"></a><span id="l132.52">     ok(group.isEmpty);</span>
<a href="#l132.53"></a><span id="l132.53"> </span>
<a href="#l132.54"></a><span id="l132.54">     let operation = {</span>
<a href="#l132.55"></a><span id="l132.55">         id: 123,</span>
<a href="#l132.56"></a><span id="l132.56">         isPending: true,</span>
<a href="#l132.57"></a><span id="l132.57">         cancel: (status) =&gt; {</span>
<a href="#l132.58"></a><span id="l132.58">             calledOperationCancel = status;</span>
<a href="#l132.59"></a><span id="l132.59">         }</span>
<a href="#l132.60"></a><span id="l132.60">     };</span>
<a href="#l132.61"></a><span id="l132.61"> </span>
<a href="#l132.62"></a><span id="l132.62">     group.add(operation);</span>
<a href="#l132.63"></a><span id="l132.63">     ok(!group.isEmpty);</span>
<a href="#l132.64"></a><span id="l132.64"> </span>
<a href="#l132.65"></a><span id="l132.65" class="difflineminus">-    group.notifyCompleted(Components.results.NS_ERROR_FAILURE);</span>
<a href="#l132.66"></a><span id="l132.66" class="difflineplus">+    group.notifyCompleted(Cr.NS_ERROR_FAILURE);</span>
<a href="#l132.67"></a><span id="l132.67">     ok(!group.isPending);</span>
<a href="#l132.68"></a><span id="l132.68" class="difflineminus">-    equal(group.status, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l132.69"></a><span id="l132.69" class="difflineplus">+    equal(group.status, Cr.NS_ERROR_FAILURE);</span>
<a href="#l132.70"></a><span id="l132.70">     strictEqual(calledOperationCancel, null);</span>
<a href="#l132.71"></a><span id="l132.71"> </span>
<a href="#l132.72"></a><span id="l132.72">     group.remove(operation);</span>
<a href="#l132.73"></a><span id="l132.73">     ok(group.isEmpty);</span>
<a href="#l132.74"></a><span id="l132.74"> </span>
<a href="#l132.75"></a><span id="l132.75">     group = new cal.data.OperationGroup(() =&gt; {</span>
<a href="#l132.76"></a><span id="l132.76">         calledCancel = true;</span>
<a href="#l132.77"></a><span id="l132.77">     });</span>
<a href="#l132.78"></a><span id="l132.78">     ok(group.id.endsWith(&quot;-1&quot;));</span>
<a href="#l132.79"></a><span id="l132.79">     group.add(operation);</span>
<a href="#l132.80"></a><span id="l132.80"> </span>
<a href="#l132.81"></a><span id="l132.81">     group.cancel();</span>
<a href="#l132.82"></a><span id="l132.82" class="difflineminus">-    equal(group.status, Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l132.83"></a><span id="l132.83" class="difflineminus">-    equal(calledOperationCancel, Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l132.84"></a><span id="l132.84" class="difflineplus">+    equal(group.status, Ci.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l132.85"></a><span id="l132.85" class="difflineplus">+    equal(calledOperationCancel, Ci.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l132.86"></a><span id="l132.86">     ok(calledCancel);</span>
<a href="#l132.87"></a><span id="l132.87"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l133.1"></a><span id="l133.1" class="difflineminus">--- a/calendar/test/unit/test_datetimeformatter.js</span>
<a href="#l133.2"></a><span id="l133.2" class="difflineplus">+++ b/calendar/test/unit/test_datetimeformatter.js</span>
<a href="#l133.3"></a><span id="l133.3" class="difflineat">@@ -44,18 +44,17 @@ add_task(async function formatDate_test(</span>
<a href="#l133.4"></a><span id="l133.4"> </span>
<a href="#l133.5"></a><span id="l133.5">     let i = 0;</span>
<a href="#l133.6"></a><span id="l133.6">     for (let test of data) {</span>
<a href="#l133.7"></a><span id="l133.7">         i++;</span>
<a href="#l133.8"></a><span id="l133.8">         Preferences.set(&quot;calendar.date.format&quot;, test.input.dateformat);</span>
<a href="#l133.9"></a><span id="l133.9">         let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l133.10"></a><span id="l133.10">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l133.11"></a><span id="l133.11"> </span>
<a href="#l133.12"></a><span id="l133.12" class="difflineminus">-        let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l133.13"></a><span id="l133.13" class="difflineminus">-                                    .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l133.14"></a><span id="l133.14" class="difflineplus">+        let dtFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].getService(Ci.calIDateTimeFormatter);</span>
<a href="#l133.15"></a><span id="l133.15">         let formatted = dtFormatter.formatDate(date);</span>
<a href="#l133.16"></a><span id="l133.16">         ok(</span>
<a href="#l133.17"></a><span id="l133.17">             test.expected.includes(formatted),</span>
<a href="#l133.18"></a><span id="l133.18">             &quot;(test #&quot; + i + &quot;: result '&quot; + formatted + &quot;', expected '&quot; + test.expected + &quot;')&quot;</span>
<a href="#l133.19"></a><span id="l133.19">         );</span>
<a href="#l133.20"></a><span id="l133.20">     }</span>
<a href="#l133.21"></a><span id="l133.21">     // let's reset the preferences</span>
<a href="#l133.22"></a><span id="l133.22">     Preferences.set(&quot;calendar.timezone.local&quot;, tzlocal);</span>
<a href="#l133.23"></a><span id="l133.23" class="difflineat">@@ -128,18 +127,17 @@ add_task(async function formatDateShort_</span>
<a href="#l133.24"></a><span id="l133.24"> </span>
<a href="#l133.25"></a><span id="l133.25">     let i = 0;</span>
<a href="#l133.26"></a><span id="l133.26">     for (let test of data) {</span>
<a href="#l133.27"></a><span id="l133.27">         i++;</span>
<a href="#l133.28"></a><span id="l133.28"> </span>
<a href="#l133.29"></a><span id="l133.29">         let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l133.30"></a><span id="l133.30">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l133.31"></a><span id="l133.31"> </span>
<a href="#l133.32"></a><span id="l133.32" class="difflineminus">-        let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l133.33"></a><span id="l133.33" class="difflineminus">-                                    .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l133.34"></a><span id="l133.34" class="difflineplus">+        let dtFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].getService(Ci.calIDateTimeFormatter);</span>
<a href="#l133.35"></a><span id="l133.35"> </span>
<a href="#l133.36"></a><span id="l133.36">         let formatted = dtFormatter.formatDateShort(date);</span>
<a href="#l133.37"></a><span id="l133.37">         ok(</span>
<a href="#l133.38"></a><span id="l133.38">             test.expected.includes(formatted),</span>
<a href="#l133.39"></a><span id="l133.39">             &quot;(test #&quot; + i + &quot;: result '&quot; + formatted + &quot;', expected '&quot; + test.expected + &quot;')&quot;</span>
<a href="#l133.40"></a><span id="l133.40">         );</span>
<a href="#l133.41"></a><span id="l133.41">     }</span>
<a href="#l133.42"></a><span id="l133.42">     // let's reset the preferences</span>
<a href="#l133.43"></a><span id="l133.43" class="difflineat">@@ -213,18 +211,17 @@ add_task(async function formatDateLong_t</span>
<a href="#l133.44"></a><span id="l133.44"> </span>
<a href="#l133.45"></a><span id="l133.45">     let i = 0;</span>
<a href="#l133.46"></a><span id="l133.46">     for (let test of data) {</span>
<a href="#l133.47"></a><span id="l133.47">         i++;</span>
<a href="#l133.48"></a><span id="l133.48"> </span>
<a href="#l133.49"></a><span id="l133.49">         let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l133.50"></a><span id="l133.50">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l133.51"></a><span id="l133.51"> </span>
<a href="#l133.52"></a><span id="l133.52" class="difflineminus">-        let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l133.53"></a><span id="l133.53" class="difflineminus">-                                    .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l133.54"></a><span id="l133.54" class="difflineplus">+        let dtFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].getService(Ci.calIDateTimeFormatter);</span>
<a href="#l133.55"></a><span id="l133.55"> </span>
<a href="#l133.56"></a><span id="l133.56">         let formatted = dtFormatter.formatDateLong(date);</span>
<a href="#l133.57"></a><span id="l133.57">         ok(</span>
<a href="#l133.58"></a><span id="l133.58">             test.expected.includes(formatted),</span>
<a href="#l133.59"></a><span id="l133.59">             &quot;(test #&quot; + i + &quot;: result '&quot; + formatted + &quot;', expected '&quot; + test.expected + &quot;')&quot;</span>
<a href="#l133.60"></a><span id="l133.60">         );</span>
<a href="#l133.61"></a><span id="l133.61">     }</span>
<a href="#l133.62"></a><span id="l133.62">     // let's reset the preferences</span>
<a href="#l133.63"></a><span id="l133.63" class="difflineat">@@ -298,18 +295,17 @@ add_task(async function formatDateWithou</span>
<a href="#l133.64"></a><span id="l133.64"> </span>
<a href="#l133.65"></a><span id="l133.65">     let i = 0;</span>
<a href="#l133.66"></a><span id="l133.66">     for (let test of data) {</span>
<a href="#l133.67"></a><span id="l133.67">         i++;</span>
<a href="#l133.68"></a><span id="l133.68"> </span>
<a href="#l133.69"></a><span id="l133.69">         let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l133.70"></a><span id="l133.70">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l133.71"></a><span id="l133.71"> </span>
<a href="#l133.72"></a><span id="l133.72" class="difflineminus">-        let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l133.73"></a><span id="l133.73" class="difflineminus">-                                    .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l133.74"></a><span id="l133.74" class="difflineplus">+        let dtFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].getService(Ci.calIDateTimeFormatter);</span>
<a href="#l133.75"></a><span id="l133.75"> </span>
<a href="#l133.76"></a><span id="l133.76">         equal(dtFormatter.formatDateWithoutYear(date), test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l133.77"></a><span id="l133.77">     }</span>
<a href="#l133.78"></a><span id="l133.78">     // let's reset the preferences</span>
<a href="#l133.79"></a><span id="l133.79">     Preferences.set(&quot;calendar.timezone.local&quot;, tzlocal);</span>
<a href="#l133.80"></a><span id="l133.80">     Preferences.set(&quot;calendar.date.format&quot;, dateformat);</span>
<a href="#l133.81"></a><span id="l133.81">     Preferences.set(&quot;intl.regional_prefs.use_os_locales&quot;, useOsLocale);</span>
<a href="#l133.82"></a><span id="l133.82"> });</span>
<a href="#l133.83"></a><span id="l133.83" class="difflineat">@@ -358,18 +354,17 @@ add_task(async function formatTime_test(</span>
<a href="#l133.84"></a><span id="l133.84"> </span>
<a href="#l133.85"></a><span id="l133.85">     let i = 0;</span>
<a href="#l133.86"></a><span id="l133.86">     for (let test of data) {</span>
<a href="#l133.87"></a><span id="l133.87">         i++;</span>
<a href="#l133.88"></a><span id="l133.88"> </span>
<a href="#l133.89"></a><span id="l133.89">         let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l133.90"></a><span id="l133.90">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l133.91"></a><span id="l133.91"> </span>
<a href="#l133.92"></a><span id="l133.92" class="difflineminus">-        let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l133.93"></a><span id="l133.93" class="difflineminus">-                                    .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l133.94"></a><span id="l133.94" class="difflineplus">+        let dtFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].getService(Ci.calIDateTimeFormatter);</span>
<a href="#l133.95"></a><span id="l133.95"> </span>
<a href="#l133.96"></a><span id="l133.96">         let formatted = dtFormatter.formatTime(date);</span>
<a href="#l133.97"></a><span id="l133.97">         ok(</span>
<a href="#l133.98"></a><span id="l133.98">             test.expected.includes(formatted),</span>
<a href="#l133.99"></a><span id="l133.99">             &quot;(test #&quot; + i + &quot;: result '&quot; + formatted + &quot;', expected '&quot; + test.expected + &quot;')&quot;</span>
<a href="#l133.100"></a><span id="l133.100">         );</span>
<a href="#l133.101"></a><span id="l133.101">     }</span>
<a href="#l133.102"></a><span id="l133.102">     // let's reset the preferences</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l134.1"></a><span id="l134.1" class="difflineminus">--- a/calendar/test/unit/test_deleted_items.js</span>
<a href="#l134.2"></a><span id="l134.2" class="difflineplus">+++ b/calendar/test/unit/test_deleted_items.js</span>
<a href="#l134.3"></a><span id="l134.3" class="difflineat">@@ -2,35 +2,32 @@</span>
<a href="#l134.4"></a><span id="l134.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l134.5"></a><span id="l134.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l134.6"></a><span id="l134.6"> </span>
<a href="#l134.7"></a><span id="l134.7"> function run_test() {</span>
<a href="#l134.8"></a><span id="l134.8">     do_calendar_startup(run_next_test);</span>
<a href="#l134.9"></a><span id="l134.9"> }</span>
<a href="#l134.10"></a><span id="l134.10"> </span>
<a href="#l134.11"></a><span id="l134.11"> function check_delmgr_call(aFunc) {</span>
<a href="#l134.12"></a><span id="l134.12" class="difflineminus">-    const mISSC = Components.interfaces.mozIStorageStatementCallback;</span>
<a href="#l134.13"></a><span id="l134.13" class="difflineminus">-    let delmgr = Components.classes[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;]</span>
<a href="#l134.14"></a><span id="l134.14" class="difflineminus">-                           .getService(Components.interfaces.calIDeletedItems);</span>
<a href="#l134.15"></a><span id="l134.15" class="difflineplus">+    let delmgr = Cc[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;].getService(Ci.calIDeletedItems);</span>
<a href="#l134.16"></a><span id="l134.16">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l134.17"></a><span id="l134.17">         delmgr.wrappedJSObject.completedNotifier.handleCompletion = (aReason) =&gt; {</span>
<a href="#l134.18"></a><span id="l134.18" class="difflineminus">-            if (aReason == mISSC.REASON_FINISHED) {</span>
<a href="#l134.19"></a><span id="l134.19" class="difflineplus">+            if (aReason == Ci.mozIStorageStatementCallback.REASON_FINISHED) {</span>
<a href="#l134.20"></a><span id="l134.20">                 resolve();</span>
<a href="#l134.21"></a><span id="l134.21">             } else {</span>
<a href="#l134.22"></a><span id="l134.22">                 reject(aReason);</span>
<a href="#l134.23"></a><span id="l134.23">             }</span>
<a href="#l134.24"></a><span id="l134.24">         };</span>
<a href="#l134.25"></a><span id="l134.25">         aFunc();</span>
<a href="#l134.26"></a><span id="l134.26">     });</span>
<a href="#l134.27"></a><span id="l134.27"> }</span>
<a href="#l134.28"></a><span id="l134.28"> </span>
<a href="#l134.29"></a><span id="l134.29"> add_task(async function test_deleted_items() {</span>
<a href="#l134.30"></a><span id="l134.30">     let calmgr = cal.getCalendarManager();</span>
<a href="#l134.31"></a><span id="l134.31" class="difflineminus">-    let delmgr = Components.classes[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;]</span>
<a href="#l134.32"></a><span id="l134.32" class="difflineminus">-                           .getService(Components.interfaces.calIDeletedItems);</span>
<a href="#l134.33"></a><span id="l134.33" class="difflineplus">+    let delmgr = Cc[&quot;@mozilla.org/calendar/deleted-items-manager;1&quot;].getService(Ci.calIDeletedItems);</span>
<a href="#l134.34"></a><span id="l134.34">     // No items have been deleted, retrieving one should return null.</span>
<a href="#l134.35"></a><span id="l134.35">     equal(delmgr.getDeletedDate(&quot;random&quot;), null);</span>
<a href="#l134.36"></a><span id="l134.36">     equal(delmgr.getDeletedDate(&quot;random&quot;, &quot;random&quot;), null);</span>
<a href="#l134.37"></a><span id="l134.37"> </span>
<a href="#l134.38"></a><span id="l134.38">     // Make sure the cache is initially flushed and that this doesn't throw an</span>
<a href="#l134.39"></a><span id="l134.39">     // error.</span>
<a href="#l134.40"></a><span id="l134.40">     await check_delmgr_call(() =&gt; delmgr.flush());</span>
<a href="#l134.41"></a><span id="l134.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l135.1"></a><span id="l135.1" class="difflineminus">--- a/calendar/test/unit/test_freebusy.js</span>
<a href="#l135.2"></a><span id="l135.2" class="difflineplus">+++ b/calendar/test/unit/test_freebusy.js</span>
<a href="#l135.3"></a><span id="l135.3" class="difflineat">@@ -7,18 +7,17 @@ function run_test() {</span>
<a href="#l135.4"></a><span id="l135.4"> }</span>
<a href="#l135.5"></a><span id="l135.5"> </span>
<a href="#l135.6"></a><span id="l135.6"> function really_run_test() {</span>
<a href="#l135.7"></a><span id="l135.7">     test_freebusy();</span>
<a href="#l135.8"></a><span id="l135.8">     test_period();</span>
<a href="#l135.9"></a><span id="l135.9"> }</span>
<a href="#l135.10"></a><span id="l135.10"> </span>
<a href="#l135.11"></a><span id="l135.11"> function test_freebusy() {</span>
<a href="#l135.12"></a><span id="l135.12" class="difflineminus">-    let icsService = Components.classes[&quot;@mozilla.org/calendar/ics-service;1&quot;]</span>
<a href="#l135.13"></a><span id="l135.13" class="difflineminus">-                               .getService(Components.interfaces.calIICSService);</span>
<a href="#l135.14"></a><span id="l135.14" class="difflineplus">+    let icsService = Cc[&quot;@mozilla.org/calendar/ics-service;1&quot;].getService(Ci.calIICSService);</span>
<a href="#l135.15"></a><span id="l135.15"> </span>
<a href="#l135.16"></a><span id="l135.16">     // Bug 415987 - FREEBUSY decoding does not support comma-separated entries</span>
<a href="#l135.17"></a><span id="l135.17">     // (https://bugzilla.mozilla.org/show_bug.cgi?id=415987)</span>
<a href="#l135.18"></a><span id="l135.18">     let fbVal1 = &quot;20080206T160000Z/PT1H&quot;;</span>
<a href="#l135.19"></a><span id="l135.19">     let fbVal2 = &quot;20080206T180000Z/PT1H&quot;;</span>
<a href="#l135.20"></a><span id="l135.20">     let fbVal3 = &quot;20080206T220000Z/PT1H&quot;;</span>
<a href="#l135.21"></a><span id="l135.21">     let data =</span>
<a href="#l135.22"></a><span id="l135.22">         &quot;BEGIN:VCALENDAR\n&quot; +</span>
<a href="#l135.23"></a><span id="l135.23" class="difflineat">@@ -28,18 +27,17 @@ function test_freebusy() {</span>
<a href="#l135.24"></a><span id="l135.24">         &quot;END:VCALENDAR\n&quot;;</span>
<a href="#l135.25"></a><span id="l135.25">     let fbComp = icsService.parseICS(data, null).getFirstSubcomponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l135.26"></a><span id="l135.26">     equal(fbComp.getFirstProperty(&quot;FREEBUSY&quot;).value, fbVal1);</span>
<a href="#l135.27"></a><span id="l135.27">     equal(fbComp.getNextProperty(&quot;FREEBUSY&quot;).value, fbVal2);</span>
<a href="#l135.28"></a><span id="l135.28">     equal(fbComp.getNextProperty(&quot;FREEBUSY&quot;).value, fbVal3);</span>
<a href="#l135.29"></a><span id="l135.29"> }</span>
<a href="#l135.30"></a><span id="l135.30"> </span>
<a href="#l135.31"></a><span id="l135.31"> function test_period() {</span>
<a href="#l135.32"></a><span id="l135.32" class="difflineminus">-    let period = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l135.33"></a><span id="l135.33" class="difflineminus">-                           .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l135.34"></a><span id="l135.34" class="difflineplus">+    let period = Cc[&quot;@mozilla.org/calendar/period;1&quot;].createInstance(Ci.calIPeriod);</span>
<a href="#l135.35"></a><span id="l135.35"> </span>
<a href="#l135.36"></a><span id="l135.36">     period.start = cal.createDateTime(&quot;20120101T010101&quot;);</span>
<a href="#l135.37"></a><span id="l135.37">     period.end = cal.createDateTime(&quot;20120101T010102&quot;);</span>
<a href="#l135.38"></a><span id="l135.38"> </span>
<a href="#l135.39"></a><span id="l135.39">     equal(period.icalString, &quot;20120101T010101/20120101T010102&quot;);</span>
<a href="#l135.40"></a><span id="l135.40">     equal(period.duration.icalString, &quot;PT1S&quot;);</span>
<a href="#l135.41"></a><span id="l135.41"> </span>
<a href="#l135.42"></a><span id="l135.42">     period.icalString = &quot;20120101T010103/20120101T010104&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l136.1"></a><span id="l136.1" class="difflineminus">--- a/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l136.2"></a><span id="l136.2" class="difflineplus">+++ b/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l136.3"></a><span id="l136.3" class="difflineat">@@ -1,15 +1,13 @@</span>
<a href="#l136.4"></a><span id="l136.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l136.5"></a><span id="l136.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l136.6"></a><span id="l136.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l136.7"></a><span id="l136.7"> </span>
<a href="#l136.8"></a><span id="l136.8" class="difflineminus">-var cIFI = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l136.9"></a><span id="l136.9" class="difflineminus">-var freebusy = Components.classes[&quot;@mozilla.org/calendar/freebusy-service;1&quot;]</span>
<a href="#l136.10"></a><span id="l136.10" class="difflineminus">-                         .getService(Components.interfaces.calIFreeBusyService);</span>
<a href="#l136.11"></a><span id="l136.11" class="difflineplus">+var freebusy = Cc[&quot;@mozilla.org/calendar/freebusy-service;1&quot;].getService(Ci.calIFreeBusyService);</span>
<a href="#l136.12"></a><span id="l136.12"> </span>
<a href="#l136.13"></a><span id="l136.13"> function run_test() {</span>
<a href="#l136.14"></a><span id="l136.14">     do_calendar_startup(really_run_test);</span>
<a href="#l136.15"></a><span id="l136.15"> }</span>
<a href="#l136.16"></a><span id="l136.16"> </span>
<a href="#l136.17"></a><span id="l136.17"> function really_run_test() {</span>
<a href="#l136.18"></a><span id="l136.18">     test_found();</span>
<a href="#l136.19"></a><span id="l136.19">     test_failure();</span>
<a href="#l136.20"></a><span id="l136.20" class="difflineat">@@ -30,17 +28,17 @@ function test_found() {</span>
<a href="#l136.21"></a><span id="l136.21"> </span>
<a href="#l136.22"></a><span id="l136.22">     let provider2 = {</span>
<a href="#l136.23"></a><span id="l136.23">         id: 2,</span>
<a href="#l136.24"></a><span id="l136.24">         called: false,</span>
<a href="#l136.25"></a><span id="l136.25">         getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l136.26"></a><span id="l136.26">             ok(!this.called);</span>
<a href="#l136.27"></a><span id="l136.27">             this.called = true;</span>
<a href="#l136.28"></a><span id="l136.28"> </span>
<a href="#l136.29"></a><span id="l136.29" class="difflineminus">-            let interval = new cal.provider.FreeBusyInterval(aCalId, cIFI.BUSY, aStart, aEnd);</span>
<a href="#l136.30"></a><span id="l136.30" class="difflineplus">+            let interval = new cal.provider.FreeBusyInterval(aCalId, Ci.calIFreeBusyInterval.BUSY, aStart, aEnd);</span>
<a href="#l136.31"></a><span id="l136.31">             aListener.onResult(null, [interval]);</span>
<a href="#l136.32"></a><span id="l136.32">         }</span>
<a href="#l136.33"></a><span id="l136.33">     };</span>
<a href="#l136.34"></a><span id="l136.34">     provider2.wrappedJSObject = provider2;</span>
<a href="#l136.35"></a><span id="l136.35"> </span>
<a href="#l136.36"></a><span id="l136.36">     freebusy.addProvider(provider1);</span>
<a href="#l136.37"></a><span id="l136.37">     equal(_countProviders(), 1);</span>
<a href="#l136.38"></a><span id="l136.38">     freebusy.addProvider(provider2);</span>
<a href="#l136.39"></a><span id="l136.39" class="difflineat">@@ -50,40 +48,41 @@ function test_found() {</span>
<a href="#l136.40"></a><span id="l136.40">     equal(_getFirstProvider().id, 2);</span>
<a href="#l136.41"></a><span id="l136.41"> </span>
<a href="#l136.42"></a><span id="l136.42">     let listener = {</span>
<a href="#l136.43"></a><span id="l136.43">         called: false,</span>
<a href="#l136.44"></a><span id="l136.44">         onResult: function(request, result) {</span>
<a href="#l136.45"></a><span id="l136.45">             equal(result.length, 1);</span>
<a href="#l136.46"></a><span id="l136.46">             equal(result[0].interval.start.icalString, &quot;20120101T010101&quot;);</span>
<a href="#l136.47"></a><span id="l136.47">             equal(result[0].interval.end.icalString, &quot;20120102T010101&quot;);</span>
<a href="#l136.48"></a><span id="l136.48" class="difflineminus">-            equal(result[0].freeBusyType, cIFI.BUSY);</span>
<a href="#l136.49"></a><span id="l136.49" class="difflineplus">+            equal(result[0].freeBusyType, Ci.calIFreeBusyInterval.BUSY);</span>
<a href="#l136.50"></a><span id="l136.50"> </span>
<a href="#l136.51"></a><span id="l136.51">             equal(result.length, 1);</span>
<a href="#l136.52"></a><span id="l136.52">             ok(provider2.called);</span>
<a href="#l136.53"></a><span id="l136.53">             do_test_finished();</span>
<a href="#l136.54"></a><span id="l136.54">         }</span>
<a href="#l136.55"></a><span id="l136.55">     };</span>
<a href="#l136.56"></a><span id="l136.56"> </span>
<a href="#l136.57"></a><span id="l136.57">     do_test_pending();</span>
<a href="#l136.58"></a><span id="l136.58">     freebusy.getFreeBusyIntervals(&quot;email&quot;,</span>
<a href="#l136.59"></a><span id="l136.59">                                   cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l136.60"></a><span id="l136.60">                                   cal.createDateTime(&quot;20120102T010101&quot;),</span>
<a href="#l136.61"></a><span id="l136.61" class="difflineminus">-                                  cIFI.BUSY_ALL, listener);</span>
<a href="#l136.62"></a><span id="l136.62" class="difflineplus">+                                  Ci.calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l136.63"></a><span id="l136.63" class="difflineplus">+                                  listener);</span>
<a href="#l136.64"></a><span id="l136.64"> }</span>
<a href="#l136.65"></a><span id="l136.65"> </span>
<a href="#l136.66"></a><span id="l136.66"> function test_failure() {</span>
<a href="#l136.67"></a><span id="l136.67">     _clearProviders();</span>
<a href="#l136.68"></a><span id="l136.68"> </span>
<a href="#l136.69"></a><span id="l136.69">     let provider = {</span>
<a href="#l136.70"></a><span id="l136.70">         called: false,</span>
<a href="#l136.71"></a><span id="l136.71">         getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l136.72"></a><span id="l136.72">             ok(!this.called);</span>
<a href="#l136.73"></a><span id="l136.73">             this.called = true;</span>
<a href="#l136.74"></a><span id="l136.74" class="difflineminus">-            aListener.onResult({ status: Components.results.NS_ERROR_FAILURE }, &quot;notFound&quot;);</span>
<a href="#l136.75"></a><span id="l136.75" class="difflineplus">+            aListener.onResult({ status: Cr.NS_ERROR_FAILURE }, &quot;notFound&quot;);</span>
<a href="#l136.76"></a><span id="l136.76">         }</span>
<a href="#l136.77"></a><span id="l136.77">     };</span>
<a href="#l136.78"></a><span id="l136.78"> </span>
<a href="#l136.79"></a><span id="l136.79">     let listener = {</span>
<a href="#l136.80"></a><span id="l136.80">         onResult: function(request, result) {</span>
<a href="#l136.81"></a><span id="l136.81">             ok(!this.called);</span>
<a href="#l136.82"></a><span id="l136.82">             equal(result.length, 0);</span>
<a href="#l136.83"></a><span id="l136.83">             equal(request.status, 0);</span>
<a href="#l136.84"></a><span id="l136.84" class="difflineat">@@ -93,17 +92,17 @@ function test_failure() {</span>
<a href="#l136.85"></a><span id="l136.85">     };</span>
<a href="#l136.86"></a><span id="l136.86"> </span>
<a href="#l136.87"></a><span id="l136.87">     freebusy.addProvider(provider);</span>
<a href="#l136.88"></a><span id="l136.88"> </span>
<a href="#l136.89"></a><span id="l136.89">     do_test_pending();</span>
<a href="#l136.90"></a><span id="l136.90">     freebusy.getFreeBusyIntervals(&quot;email&quot;,</span>
<a href="#l136.91"></a><span id="l136.91">                                   cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l136.92"></a><span id="l136.92">                                   cal.createDateTime(&quot;20120102T010101&quot;),</span>
<a href="#l136.93"></a><span id="l136.93" class="difflineminus">-                                  cIFI.BUSY_ALL,</span>
<a href="#l136.94"></a><span id="l136.94" class="difflineplus">+                                  Ci.calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l136.95"></a><span id="l136.95">                                   listener);</span>
<a href="#l136.96"></a><span id="l136.96"> }</span>
<a href="#l136.97"></a><span id="l136.97"> </span>
<a href="#l136.98"></a><span id="l136.98"> function test_cancel() {</span>
<a href="#l136.99"></a><span id="l136.99">     _clearProviders();</span>
<a href="#l136.100"></a><span id="l136.100"> </span>
<a href="#l136.101"></a><span id="l136.101">     let provider = {</span>
<a href="#l136.102"></a><span id="l136.102">         QueryInterface: cal.generateQI([</span>
<a href="#l136.103"></a><span id="l136.103" class="difflineat">@@ -111,26 +110,26 @@ function test_cancel() {</span>
<a href="#l136.104"></a><span id="l136.104">             Ci.calIOperation</span>
<a href="#l136.105"></a><span id="l136.105">         ]),</span>
<a href="#l136.106"></a><span id="l136.106">         getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l136.107"></a><span id="l136.107">             Services.tm.currentThread.dispatch({</span>
<a href="#l136.108"></a><span id="l136.108">                 run: function() {</span>
<a href="#l136.109"></a><span id="l136.109">                     dump(&quot;Cancelling freebusy query...&quot;);</span>
<a href="#l136.110"></a><span id="l136.110">                     operation.cancel();</span>
<a href="#l136.111"></a><span id="l136.111">                 }</span>
<a href="#l136.112"></a><span id="l136.112" class="difflineminus">-            }, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l136.113"></a><span id="l136.113" class="difflineplus">+            }, Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l136.114"></a><span id="l136.114"> </span>
<a href="#l136.115"></a><span id="l136.115">             // No listener call, we emulate a long running search</span>
<a href="#l136.116"></a><span id="l136.116">             // Do return the operation though</span>
<a href="#l136.117"></a><span id="l136.117">             return this;</span>
<a href="#l136.118"></a><span id="l136.118">         },</span>
<a href="#l136.119"></a><span id="l136.119"> </span>
<a href="#l136.120"></a><span id="l136.120">         isPending: true,</span>
<a href="#l136.121"></a><span id="l136.121">         cancelCalled: false,</span>
<a href="#l136.122"></a><span id="l136.122" class="difflineminus">-        status: Components.results.NS_OK,</span>
<a href="#l136.123"></a><span id="l136.123" class="difflineplus">+        status: Cr.NS_OK,</span>
<a href="#l136.124"></a><span id="l136.124">         cancel: function() {</span>
<a href="#l136.125"></a><span id="l136.125">             this.cancelCalled = true;</span>
<a href="#l136.126"></a><span id="l136.126">         },</span>
<a href="#l136.127"></a><span id="l136.127">     };</span>
<a href="#l136.128"></a><span id="l136.128"> </span>
<a href="#l136.129"></a><span id="l136.129">     let listener = {</span>
<a href="#l136.130"></a><span id="l136.130">         called: false,</span>
<a href="#l136.131"></a><span id="l136.131">         onResult: function(request, result) {</span>
<a href="#l136.132"></a><span id="l136.132" class="difflineat">@@ -143,17 +142,17 @@ function test_cancel() {</span>
<a href="#l136.133"></a><span id="l136.133">     };</span>
<a href="#l136.134"></a><span id="l136.134"> </span>
<a href="#l136.135"></a><span id="l136.135">     freebusy.addProvider(provider);</span>
<a href="#l136.136"></a><span id="l136.136"> </span>
<a href="#l136.137"></a><span id="l136.137">     do_test_pending();</span>
<a href="#l136.138"></a><span id="l136.138">     let operation = freebusy.getFreeBusyIntervals(&quot;email&quot;,</span>
<a href="#l136.139"></a><span id="l136.139">                                                   cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l136.140"></a><span id="l136.140">                                                   cal.createDateTime(&quot;20120102T010101&quot;),</span>
<a href="#l136.141"></a><span id="l136.141" class="difflineminus">-                                                  cIFI.BUSY_ALL,</span>
<a href="#l136.142"></a><span id="l136.142" class="difflineplus">+                                                  Ci.calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l136.143"></a><span id="l136.143">                                                   listener);</span>
<a href="#l136.144"></a><span id="l136.144"> }</span>
<a href="#l136.145"></a><span id="l136.145"> </span>
<a href="#l136.146"></a><span id="l136.146"> // The following functions are not in the interface description and probably</span>
<a href="#l136.147"></a><span id="l136.147"> // don't need to be. Make assumptions about the implementation instead.</span>
<a href="#l136.148"></a><span id="l136.148"> </span>
<a href="#l136.149"></a><span id="l136.149"> function _clearProviders() {</span>
<a href="#l136.150"></a><span id="l136.150">     freebusy.wrappedJSObject.mProviders = new Set();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l137.1"></a><span id="l137.1" class="difflineminus">--- a/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l137.2"></a><span id="l137.2" class="difflineplus">+++ b/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l137.3"></a><span id="l137.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l137.4"></a><span id="l137.4">     Services.prefs.setBoolPref(&quot;calendar.debug.log.verbose&quot;, true);</span>
<a href="#l137.5"></a><span id="l137.5"> </span>
<a href="#l137.6"></a><span id="l137.6">     let xpiFile;</span>
<a href="#l137.7"></a><span id="l137.7">     let env = Cc[&quot;@mozilla.org/process/environment;1&quot;].getService(Ci.nsIEnvironment);</span>
<a href="#l137.8"></a><span id="l137.8">     if (env.exists(&quot;MOZ_FETCHES_DIR&quot;)) {</span>
<a href="#l137.9"></a><span id="l137.9">         xpiFile = new FileUtils.File(env.get(&quot;MOZ_FETCHES_DIR&quot;));</span>
<a href="#l137.10"></a><span id="l137.10">         xpiFile.append(&quot;gdata-provider.en-US.xpi&quot;);</span>
<a href="#l137.11"></a><span id="l137.11">     } else {</span>
<a href="#l137.12"></a><span id="l137.12" class="difflineminus">-        xpiFile = Services.dirsvc.get(&quot;CurProcD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l137.13"></a><span id="l137.13" class="difflineplus">+        xpiFile = Services.dirsvc.get(&quot;CurProcD&quot;, Ci.nsIFile);</span>
<a href="#l137.14"></a><span id="l137.14">         xpiFile.append(&quot;extensions&quot;);</span>
<a href="#l137.15"></a><span id="l137.15">         xpiFile.append(&quot;{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}&quot;);</span>
<a href="#l137.16"></a><span id="l137.16">     }</span>
<a href="#l137.17"></a><span id="l137.17"> </span>
<a href="#l137.18"></a><span id="l137.18">     dump(&quot;Loading &quot; + xpiFile.path + &quot;\n&quot;);</span>
<a href="#l137.19"></a><span id="l137.19">     let manager = Cc[&quot;@mozilla.org/component-manager-extra;1&quot;].getService(Ci.nsIComponentManagerExtra);</span>
<a href="#l137.20"></a><span id="l137.20">     manager.addLegacyExtensionManifestLocation(xpiFile);</span>
<a href="#l137.21"></a><span id="l137.21"> })();</span>
<a href="#l137.22"></a><span id="l137.22" class="difflineat">@@ -177,17 +177,17 @@ GDataServer.prototype = {</span>
<a href="#l137.23"></a><span id="l137.23">                     { type: &quot;eventCancellation&quot;, method: &quot;email&quot; }</span>
<a href="#l137.24"></a><span id="l137.24">                 ]</span>
<a href="#l137.25"></a><span id="l137.25">             }</span>
<a href="#l137.26"></a><span id="l137.26">         };</span>
<a href="#l137.27"></a><span id="l137.27">     },</span>
<a href="#l137.28"></a><span id="l137.28"> </span>
<a href="#l137.29"></a><span id="l137.29">     waitForLoad: function(aCalendar) {</span>
<a href="#l137.30"></a><span id="l137.30">         return new Promise((resolve, reject) =&gt; {</span>
<a href="#l137.31"></a><span id="l137.31" class="difflineminus">-            let observer = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l137.32"></a><span id="l137.32" class="difflineplus">+            let observer = cal.createAdapter(Ci.calIObserver, {</span>
<a href="#l137.33"></a><span id="l137.33">                 onLoad: function() {</span>
<a href="#l137.34"></a><span id="l137.34">                     let uncached = aCalendar.wrappedJSObject.mUncachedCalendar.wrappedJSObject;</span>
<a href="#l137.35"></a><span id="l137.35">                     aCalendar.removeObserver(observer);</span>
<a href="#l137.36"></a><span id="l137.36"> </span>
<a href="#l137.37"></a><span id="l137.37">                     if (Components.isSuccessCode(uncached._lastStatus)) {</span>
<a href="#l137.38"></a><span id="l137.38">                         resolve(aCalendar);</span>
<a href="#l137.39"></a><span id="l137.39">                     } else {</span>
<a href="#l137.40"></a><span id="l137.40">                         reject(uncached._lastMessage);</span>
<a href="#l137.41"></a><span id="l137.41" class="difflineat">@@ -606,18 +606,17 @@ add_task(async function test_dateToJSON(</span>
<a href="#l137.42"></a><span id="l137.42">             &quot;END:DAYLIGHT&quot;,</span>
<a href="#l137.43"></a><span id="l137.43">             &quot;END:VTIMEZONE&quot;,</span>
<a href="#l137.44"></a><span id="l137.44">             &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l137.45"></a><span id="l137.45">             &quot;UID:123&quot;,</span>
<a href="#l137.46"></a><span id="l137.46">             &quot;DTSTART;TZID=&quot; + tzid + &quot;:20150130T120000&quot;,</span>
<a href="#l137.47"></a><span id="l137.47">             &quot;END:VEVENT&quot;,</span>
<a href="#l137.48"></a><span id="l137.48">             &quot;END:VCALENDAR&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l137.49"></a><span id="l137.49"> </span>
<a href="#l137.50"></a><span id="l137.50" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l137.51"></a><span id="l137.51" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l137.52"></a><span id="l137.52" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l137.53"></a><span id="l137.53">         parser.parseString(ics);</span>
<a href="#l137.54"></a><span id="l137.54">         let items = parser.getItems({});</span>
<a href="#l137.55"></a><span id="l137.55">         return items[0].startDate;</span>
<a href="#l137.56"></a><span id="l137.56">     }</span>
<a href="#l137.57"></a><span id="l137.57"> </span>
<a href="#l137.58"></a><span id="l137.58">     let date;</span>
<a href="#l137.59"></a><span id="l137.59"> </span>
<a href="#l137.60"></a><span id="l137.60">     // no timezone</span>
<a href="#l137.61"></a><span id="l137.61" class="difflineat">@@ -1566,17 +1565,17 @@ add_task(async function test_conflict_mo</span>
<a href="#l137.62"></a><span id="l137.62">     MockConflictPrompt.overwrite = false;</span>
<a href="#l137.63"></a><span id="l137.63">     gServer.events[0].etag = '&quot;3&quot;';</span>
<a href="#l137.64"></a><span id="l137.64">     gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l137.65"></a><span id="l137.65">     try {</span>
<a href="#l137.66"></a><span id="l137.66">         modifiedItem = await pclient.modifyItem(newItem, item);</span>
<a href="#l137.67"></a><span id="l137.67">         do_throw(&quot;Expected modifyItem to be cancelled&quot;);</span>
<a href="#l137.68"></a><span id="l137.68">     } catch (e) {</span>
<a href="#l137.69"></a><span id="l137.69">         // Swallow cancelling the request</span>
<a href="#l137.70"></a><span id="l137.70" class="difflineminus">-        if (e != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l137.71"></a><span id="l137.71" class="difflineplus">+        if (e != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l137.72"></a><span id="l137.72">             throw e;</span>
<a href="#l137.73"></a><span id="l137.73">         }</span>
<a href="#l137.74"></a><span id="l137.74">     }</span>
<a href="#l137.75"></a><span id="l137.75"> </span>
<a href="#l137.76"></a><span id="l137.76">     await gServer.waitForLoad(client);</span>
<a href="#l137.77"></a><span id="l137.77"> </span>
<a href="#l137.78"></a><span id="l137.78">     item = (await pclient.getAllItems())[0];</span>
<a href="#l137.79"></a><span id="l137.79">     equal(gServer.events[0].summary, &quot;remote change&quot;);</span>
<a href="#l137.80"></a><span id="l137.80" class="difflineat">@@ -1587,17 +1586,17 @@ add_task(async function test_conflict_mo</span>
<a href="#l137.81"></a><span id="l137.81">     MockConflictPrompt.overwrite = false;</span>
<a href="#l137.82"></a><span id="l137.82">     gServer.events[0].etag = '&quot;4&quot;';</span>
<a href="#l137.83"></a><span id="l137.83">     gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l137.84"></a><span id="l137.84">     try {</span>
<a href="#l137.85"></a><span id="l137.85">         await pclient.deleteItem(item);</span>
<a href="#l137.86"></a><span id="l137.86">         do_throw(&quot;Expected deleteItem to be cancelled&quot;);</span>
<a href="#l137.87"></a><span id="l137.87">     } catch (e) {</span>
<a href="#l137.88"></a><span id="l137.88">         // Swallow cancelling the request</span>
<a href="#l137.89"></a><span id="l137.89" class="difflineminus">-        if (e != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l137.90"></a><span id="l137.90" class="difflineplus">+        if (e != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l137.91"></a><span id="l137.91">             throw e;</span>
<a href="#l137.92"></a><span id="l137.92">         }</span>
<a href="#l137.93"></a><span id="l137.93">     }</span>
<a href="#l137.94"></a><span id="l137.94"> </span>
<a href="#l137.95"></a><span id="l137.95">     await gServer.waitForLoad(client);</span>
<a href="#l137.96"></a><span id="l137.96"> </span>
<a href="#l137.97"></a><span id="l137.97">     item = (await pclient.getAllItems())[0];</span>
<a href="#l137.98"></a><span id="l137.98">     equal(gServer.events[0].summary, &quot;remote change&quot;);</span>
<a href="#l137.99"></a><span id="l137.99" class="difflineat">@@ -1655,17 +1654,17 @@ add_task(async function test_conflict_de</span>
<a href="#l137.100"></a><span id="l137.100">     // Case #2: Deleted on server, modify locally, don't overwrite conflict</span>
<a href="#l137.101"></a><span id="l137.101">     MockConflictPrompt.overwrite = false;</span>
<a href="#l137.102"></a><span id="l137.102">     gServer.events = [];</span>
<a href="#l137.103"></a><span id="l137.103">     try {</span>
<a href="#l137.104"></a><span id="l137.104">         modifiedItem = await pclient.modifyItem(newItem, item);</span>
<a href="#l137.105"></a><span id="l137.105">         do_throw(&quot;Expected modifyItem to be cancelled&quot;);</span>
<a href="#l137.106"></a><span id="l137.106">     } catch (e) {</span>
<a href="#l137.107"></a><span id="l137.107">         // Swallow cancelling the request</span>
<a href="#l137.108"></a><span id="l137.108" class="difflineminus">-        if (e != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l137.109"></a><span id="l137.109" class="difflineplus">+        if (e != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l137.110"></a><span id="l137.110">             throw e;</span>
<a href="#l137.111"></a><span id="l137.111">         }</span>
<a href="#l137.112"></a><span id="l137.112">     }</span>
<a href="#l137.113"></a><span id="l137.113">     // The next synchronize should cause the event to be deleted locally.</span>
<a href="#l137.114"></a><span id="l137.114">     coreEvent.status = &quot;cancelled&quot;;</span>
<a href="#l137.115"></a><span id="l137.115">     gServer.events = [coreEvent];</span>
<a href="#l137.116"></a><span id="l137.116"> </span>
<a href="#l137.117"></a><span id="l137.117">     await gServer.waitForLoad(client);</span>
<a href="#l137.118"></a><span id="l137.118" class="difflineat">@@ -1684,17 +1683,17 @@ add_task(async function test_conflict_de</span>
<a href="#l137.119"></a><span id="l137.119">     // Case #3: Deleted on server, delete locally, don't overwrite conflict</span>
<a href="#l137.120"></a><span id="l137.120">     MockConflictPrompt.overwrite = false;</span>
<a href="#l137.121"></a><span id="l137.121">     gServer.events = [];</span>
<a href="#l137.122"></a><span id="l137.122">     try {</span>
<a href="#l137.123"></a><span id="l137.123">         await pclient.deleteItem(item);</span>
<a href="#l137.124"></a><span id="l137.124">         do_throw(&quot;Expected deleteItem to be cancelled&quot;);</span>
<a href="#l137.125"></a><span id="l137.125">     } catch (e) {</span>
<a href="#l137.126"></a><span id="l137.126">         // Swallow cancelling the request</span>
<a href="#l137.127"></a><span id="l137.127" class="difflineminus">-        if (e != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l137.128"></a><span id="l137.128" class="difflineplus">+        if (e != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l137.129"></a><span id="l137.129">             throw e;</span>
<a href="#l137.130"></a><span id="l137.130">         }</span>
<a href="#l137.131"></a><span id="l137.131">     }</span>
<a href="#l137.132"></a><span id="l137.132">     // The next synchronize should cause the event to be deleted locally.</span>
<a href="#l137.133"></a><span id="l137.133">     coreEvent.status = &quot;cancelled&quot;;</span>
<a href="#l137.134"></a><span id="l137.134">     gServer.events = [coreEvent];</span>
<a href="#l137.135"></a><span id="l137.135">     await gServer.waitForLoad(client);</span>
<a href="#l137.136"></a><span id="l137.136"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l138.1"></a><span id="l138.1" class="difflineminus">--- a/calendar/test/unit/test_ics_parser.js</span>
<a href="#l138.2"></a><span id="l138.2" class="difflineplus">+++ b/calendar/test/unit/test_ics_parser.js</span>
<a href="#l138.3"></a><span id="l138.3" class="difflineat">@@ -13,18 +13,17 @@ function really_run_test() {</span>
<a href="#l138.4"></a><span id="l138.4">         test_failures();</span>
<a href="#l138.5"></a><span id="l138.5">     }</span>
<a href="#l138.6"></a><span id="l138.6">     test_fake_parent();</span>
<a href="#l138.7"></a><span id="l138.7">     test_props_comps();</span>
<a href="#l138.8"></a><span id="l138.8">     test_timezone();</span>
<a href="#l138.9"></a><span id="l138.9"> }</span>
<a href="#l138.10"></a><span id="l138.10"> </span>
<a href="#l138.11"></a><span id="l138.11"> function test_props_comps() {</span>
<a href="#l138.12"></a><span id="l138.12" class="difflineminus">-    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l138.13"></a><span id="l138.13" class="difflineminus">-                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l138.14"></a><span id="l138.14" class="difflineplus">+    let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l138.15"></a><span id="l138.15">     let str = [</span>
<a href="#l138.16"></a><span id="l138.16">         &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l138.17"></a><span id="l138.17">         &quot;X-WR-CALNAME:CALNAME&quot;,</span>
<a href="#l138.18"></a><span id="l138.18">         &quot;BEGIN:VJOURNAL&quot;,</span>
<a href="#l138.19"></a><span id="l138.19">         &quot;LOCATION:BEFORE TIME&quot;,</span>
<a href="#l138.20"></a><span id="l138.20">         &quot;END:VJOURNAL&quot;,</span>
<a href="#l138.21"></a><span id="l138.21">         &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l138.22"></a><span id="l138.22">         &quot;UID:123&quot;,</span>
<a href="#l138.23"></a><span id="l138.23" class="difflineat">@@ -39,46 +38,43 @@ function test_props_comps() {</span>
<a href="#l138.24"></a><span id="l138.24"> </span>
<a href="#l138.25"></a><span id="l138.25">     let comps = parser.getComponents({});</span>
<a href="#l138.26"></a><span id="l138.26">     equal(comps.length, 1);</span>
<a href="#l138.27"></a><span id="l138.27">     equal(comps[0].componentType, &quot;VJOURNAL&quot;);</span>
<a href="#l138.28"></a><span id="l138.28">     equal(comps[0].location, &quot;BEFORE TIME&quot;);</span>
<a href="#l138.29"></a><span id="l138.29"> }</span>
<a href="#l138.30"></a><span id="l138.30"> </span>
<a href="#l138.31"></a><span id="l138.31"> function test_failures() {</span>
<a href="#l138.32"></a><span id="l138.32" class="difflineminus">-    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l138.33"></a><span id="l138.33" class="difflineminus">-                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l138.34"></a><span id="l138.34" class="difflineplus">+    let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l138.35"></a><span id="l138.35"> </span>
<a href="#l138.36"></a><span id="l138.36">     do_test_pending();</span>
<a href="#l138.37"></a><span id="l138.37">     parser.parseString(&quot;BOGUS&quot;, null, {</span>
<a href="#l138.38"></a><span id="l138.38">         onParsingComplete: function(rc, opparser) {</span>
<a href="#l138.39"></a><span id="l138.39">             dump(&quot;Note: The previous error message is expected ^^\n&quot;);</span>
<a href="#l138.40"></a><span id="l138.40" class="difflineminus">-            equal(rc, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l138.41"></a><span id="l138.41" class="difflineplus">+            equal(rc, Cr.NS_ERROR_FAILURE);</span>
<a href="#l138.42"></a><span id="l138.42">             do_test_finished();</span>
<a href="#l138.43"></a><span id="l138.43">         }</span>
<a href="#l138.44"></a><span id="l138.44">     });</span>
<a href="#l138.45"></a><span id="l138.45"> </span>
<a href="#l138.46"></a><span id="l138.46">     // No real error here, but there is a message...</span>
<a href="#l138.47"></a><span id="l138.47" class="difflineminus">-    parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l138.48"></a><span id="l138.48" class="difflineminus">-                       .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l138.49"></a><span id="l138.49" class="difflineplus">+    parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l138.50"></a><span id="l138.50">     let str = [</span>
<a href="#l138.51"></a><span id="l138.51">         &quot;BEGIN:VWORLD&quot;,</span>
<a href="#l138.52"></a><span id="l138.52">         &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l138.53"></a><span id="l138.53">         &quot;UID:123&quot;,</span>
<a href="#l138.54"></a><span id="l138.54">         &quot;END:VEVENT&quot;,</span>
<a href="#l138.55"></a><span id="l138.55">         &quot;END:VWORLD&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l138.56"></a><span id="l138.56">     dump(&quot;Note: The following error message is expected:\n&quot;);</span>
<a href="#l138.57"></a><span id="l138.57">     parser.parseString(str);</span>
<a href="#l138.58"></a><span id="l138.58">     equal(parser.getComponents({}).length, 0);</span>
<a href="#l138.59"></a><span id="l138.59">     equal(parser.getItems({}).length, 0);</span>
<a href="#l138.60"></a><span id="l138.60"> }</span>
<a href="#l138.61"></a><span id="l138.61"> </span>
<a href="#l138.62"></a><span id="l138.62"> function test_fake_parent() {</span>
<a href="#l138.63"></a><span id="l138.63" class="difflineminus">-    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l138.64"></a><span id="l138.64" class="difflineminus">-                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l138.65"></a><span id="l138.65" class="difflineplus">+    let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l138.66"></a><span id="l138.66"> </span>
<a href="#l138.67"></a><span id="l138.67">     let str = [</span>
<a href="#l138.68"></a><span id="l138.68">         &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l138.69"></a><span id="l138.69">         &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l138.70"></a><span id="l138.70">         &quot;UID:123&quot;,</span>
<a href="#l138.71"></a><span id="l138.71">         &quot;RECURRENCE-ID:20120101T010101&quot;,</span>
<a href="#l138.72"></a><span id="l138.72">         &quot;DTSTART:20120101T010102&quot;,</span>
<a href="#l138.73"></a><span id="l138.73">         &quot;LOCATION:HELL&quot;,</span>
<a href="#l138.74"></a><span id="l138.74" class="difflineat">@@ -103,18 +99,17 @@ function test_fake_parent() {</span>
<a href="#l138.75"></a><span id="l138.75">     equal(excs.length, 1);</span>
<a href="#l138.76"></a><span id="l138.76">     let exc = excs[0];</span>
<a href="#l138.77"></a><span id="l138.77">     equal(exc.startDate.icalString, &quot;20120101T010102&quot;);</span>
<a href="#l138.78"></a><span id="l138.78"> </span>
<a href="#l138.79"></a><span id="l138.79">     equal(parser.getParentlessItems({})[0], exc);</span>
<a href="#l138.80"></a><span id="l138.80"> }</span>
<a href="#l138.81"></a><span id="l138.81"> </span>
<a href="#l138.82"></a><span id="l138.82"> function test_async() {</span>
<a href="#l138.83"></a><span id="l138.83" class="difflineminus">-    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l138.84"></a><span id="l138.84" class="difflineminus">-                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l138.85"></a><span id="l138.85" class="difflineplus">+    let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l138.86"></a><span id="l138.86">     let str = [</span>
<a href="#l138.87"></a><span id="l138.87">         &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l138.88"></a><span id="l138.88">         &quot;BEGIN:VTODO&quot;,</span>
<a href="#l138.89"></a><span id="l138.89">         &quot;UID:1&quot;,</span>
<a href="#l138.90"></a><span id="l138.90">         &quot;DTSTART:20120101T010101&quot;,</span>
<a href="#l138.91"></a><span id="l138.91">         &quot;DUE:20120101T010102&quot;,</span>
<a href="#l138.92"></a><span id="l138.92">         &quot;END:VTODO&quot;,</span>
<a href="#l138.93"></a><span id="l138.93">         &quot;BEGIN:VTODO&quot;,</span>
<a href="#l138.94"></a><span id="l138.94" class="difflineat">@@ -146,20 +141,18 @@ function test_async() {</span>
<a href="#l138.95"></a><span id="l138.95">     });</span>
<a href="#l138.96"></a><span id="l138.96"> }</span>
<a href="#l138.97"></a><span id="l138.97"> </span>
<a href="#l138.98"></a><span id="l138.98"> function test_timezone() {</span>
<a href="#l138.99"></a><span id="l138.99">     // TODO</span>
<a href="#l138.100"></a><span id="l138.100"> }</span>
<a href="#l138.101"></a><span id="l138.101"> </span>
<a href="#l138.102"></a><span id="l138.102"> function test_roundtrip() {</span>
<a href="#l138.103"></a><span id="l138.103" class="difflineminus">-    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l138.104"></a><span id="l138.104" class="difflineminus">-                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l138.105"></a><span id="l138.105" class="difflineminus">-    let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l138.106"></a><span id="l138.106" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l138.107"></a><span id="l138.107" class="difflineplus">+    let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l138.108"></a><span id="l138.108" class="difflineplus">+    let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;].createInstance(Ci.calIIcsSerializer);</span>
<a href="#l138.109"></a><span id="l138.109">     let str = [</span>
<a href="#l138.110"></a><span id="l138.110">         &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l138.111"></a><span id="l138.111">         &quot;PRODID:-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;,</span>
<a href="#l138.112"></a><span id="l138.112">         &quot;VERSION:2.0&quot;,</span>
<a href="#l138.113"></a><span id="l138.113">         &quot;X-PROP:VAL&quot;,</span>
<a href="#l138.114"></a><span id="l138.114">         &quot;BEGIN:VTODO&quot;,</span>
<a href="#l138.115"></a><span id="l138.115">         &quot;UID:1&quot;,</span>
<a href="#l138.116"></a><span id="l138.116">         &quot;DTSTART:20120101T010101&quot;,</span>
<a href="#l138.117"></a><span id="l138.117" class="difflineat">@@ -178,18 +171,17 @@ function test_roundtrip() {</span>
<a href="#l138.118"></a><span id="l138.118"> </span>
<a href="#l138.119"></a><span id="l138.119">     parser.getProperties({}).forEach(serializer.addProperty, serializer);</span>
<a href="#l138.120"></a><span id="l138.120">     parser.getComponents({}).forEach(serializer.addComponent, serializer);</span>
<a href="#l138.121"></a><span id="l138.121"> </span>
<a href="#l138.122"></a><span id="l138.122">     equal(serializer.serializeToString().split(&quot;\r\n&quot;).sort().join(&quot;\r\n&quot;),</span>
<a href="#l138.123"></a><span id="l138.123">                 str.split(&quot;\r\n&quot;).sort().join(&quot;\r\n&quot;));</span>
<a href="#l138.124"></a><span id="l138.124"> </span>
<a href="#l138.125"></a><span id="l138.125">     // Test parseFromStream</span>
<a href="#l138.126"></a><span id="l138.126" class="difflineminus">-    parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l138.127"></a><span id="l138.127" class="difflineminus">-                       .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l138.128"></a><span id="l138.128" class="difflineplus">+    parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l138.129"></a><span id="l138.129">     let stream = serializer.serializeToInputStream();</span>
<a href="#l138.130"></a><span id="l138.130"> </span>
<a href="#l138.131"></a><span id="l138.131">     parser.parseFromStream(stream);</span>
<a href="#l138.132"></a><span id="l138.132"> </span>
<a href="#l138.133"></a><span id="l138.133">     items = parser.getItems({});</span>
<a href="#l138.134"></a><span id="l138.134">     let comps = parser.getComponents({});</span>
<a href="#l138.135"></a><span id="l138.135">     let props = parser.getProperties({});</span>
<a href="#l138.136"></a><span id="l138.136">     equal(items.length, 1);</span>
<a href="#l138.137"></a><span id="l138.137" class="difflineat">@@ -198,20 +190,18 @@ function test_roundtrip() {</span>
<a href="#l138.138"></a><span id="l138.138"> </span>
<a href="#l138.139"></a><span id="l138.139">     let everything = items[0].icalString.split(&quot;\r\n&quot;).concat(comps[0].serializeToICS().split(&quot;\r\n&quot;));</span>
<a href="#l138.140"></a><span id="l138.140">     everything.push((props[0].icalString.split(&quot;\r\n&quot;))[0]);</span>
<a href="#l138.141"></a><span id="l138.141">     everything.sort();</span>
<a href="#l138.142"></a><span id="l138.142"> </span>
<a href="#l138.143"></a><span id="l138.143">     equal(everything.join(&quot;\r\n&quot;), str.split(&quot;\r\n&quot;).concat([&quot;&quot;]).sort().join(&quot;\r\n&quot;));</span>
<a href="#l138.144"></a><span id="l138.144"> </span>
<a href="#l138.145"></a><span id="l138.145">     // Test serializeToStream/parseFromStream</span>
<a href="#l138.146"></a><span id="l138.146" class="difflineminus">-    parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l138.147"></a><span id="l138.147" class="difflineminus">-                       .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l138.148"></a><span id="l138.148" class="difflineminus">-    let pipe = Components.classes[&quot;@mozilla.org/pipe;1&quot;]</span>
<a href="#l138.149"></a><span id="l138.149" class="difflineminus">-                         .createInstance(Components.interfaces.nsIPipe);</span>
<a href="#l138.150"></a><span id="l138.150" class="difflineplus">+    parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l138.151"></a><span id="l138.151" class="difflineplus">+    let pipe = Cc[&quot;@mozilla.org/pipe;1&quot;].createInstance(Ci.nsIPipe);</span>
<a href="#l138.152"></a><span id="l138.152">     pipe.init(true, true, 0, 0, null);</span>
<a href="#l138.153"></a><span id="l138.153"> </span>
<a href="#l138.154"></a><span id="l138.154">     serializer.serializeToStream(pipe.outputStream);</span>
<a href="#l138.155"></a><span id="l138.155">     parser.parseFromStream(pipe.inputStream);</span>
<a href="#l138.156"></a><span id="l138.156"> </span>
<a href="#l138.157"></a><span id="l138.157">     items = parser.getItems({});</span>
<a href="#l138.158"></a><span id="l138.158">     comps = parser.getComponents({});</span>
<a href="#l138.159"></a><span id="l138.159">     props = parser.getProperties({});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l139.1"></a><span id="l139.1" class="difflineminus">--- a/calendar/test/unit/test_imip.js</span>
<a href="#l139.2"></a><span id="l139.2" class="difflineplus">+++ b/calendar/test/unit/test_imip.js</span>
<a href="#l139.3"></a><span id="l139.3" class="difflineat">@@ -5,19 +5,17 @@</span>
<a href="#l139.4"></a><span id="l139.4"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l139.5"></a><span id="l139.5"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l139.6"></a><span id="l139.6"> var calItipEmailTransport = {};</span>
<a href="#l139.7"></a><span id="l139.7"> Services.scriptloader.loadSubScript(</span>
<a href="#l139.8"></a><span id="l139.8">     &quot;resource://calendar/components/calItipEmailTransport.js&quot;,</span>
<a href="#l139.9"></a><span id="l139.9">     calItipEmailTransport);</span>
<a href="#l139.10"></a><span id="l139.10"> </span>
<a href="#l139.11"></a><span id="l139.11"> function itipItemForTest(title, seq) {</span>
<a href="#l139.12"></a><span id="l139.12" class="difflineminus">-    let itipItem = Components</span>
<a href="#l139.13"></a><span id="l139.13" class="difflineminus">-            .classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l139.14"></a><span id="l139.14" class="difflineminus">-            .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l139.15"></a><span id="l139.15" class="difflineplus">+    let itipItem = Cc[&quot;@mozilla.org/calendar/itip-item;1&quot;].createInstance(Ci.calIItipItem);</span>
<a href="#l139.16"></a><span id="l139.16">     itipItem.init([</span>
<a href="#l139.17"></a><span id="l139.17">         &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l139.18"></a><span id="l139.18">         &quot;METHOD:REQUEST&quot;,</span>
<a href="#l139.19"></a><span id="l139.19">         &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l139.20"></a><span id="l139.20">         &quot;SUMMARY:&quot; + title,</span>
<a href="#l139.21"></a><span id="l139.21">         &quot;SEQUENCE:&quot; + (seq || 0),</span>
<a href="#l139.22"></a><span id="l139.22">         &quot;END:VEVENT&quot;,</span>
<a href="#l139.23"></a><span id="l139.23">         &quot;END:VCALENDAR&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l140.1"></a><span id="l140.1" class="difflineminus">--- a/calendar/test/unit/test_items.js</span>
<a href="#l140.2"></a><span id="l140.2" class="difflineplus">+++ b/calendar/test/unit/test_items.js</span>
<a href="#l140.3"></a><span id="l140.3" class="difflineat">@@ -157,17 +157,17 @@ function test_categories() {</span>
<a href="#l140.4"></a><span id="l140.4">     }</span>
<a href="#l140.5"></a><span id="l140.5"> }</span>
<a href="#l140.6"></a><span id="l140.6"> </span>
<a href="#l140.7"></a><span id="l140.7"> function test_alarm() {</span>
<a href="#l140.8"></a><span id="l140.8">     let e = cal.createEvent();</span>
<a href="#l140.9"></a><span id="l140.9">     let alarm = cal.createAlarm();</span>
<a href="#l140.10"></a><span id="l140.10"> </span>
<a href="#l140.11"></a><span id="l140.11">     alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l140.12"></a><span id="l140.12" class="difflineminus">-    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l140.13"></a><span id="l140.13" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l140.14"></a><span id="l140.14">     alarm.alarmDate = cal.createDateTime();</span>
<a href="#l140.15"></a><span id="l140.15"> </span>
<a href="#l140.16"></a><span id="l140.16">     e.addAlarm(alarm);</span>
<a href="#l140.17"></a><span id="l140.17">     let ecomp = e.icalComponent;</span>
<a href="#l140.18"></a><span id="l140.18">     let vcomp = ecomp.getFirstSubcomponent(&quot;VALARM&quot;);</span>
<a href="#l140.19"></a><span id="l140.19">     equal(vcomp.serializeToICS(), alarm.icalString);</span>
<a href="#l140.20"></a><span id="l140.20"> </span>
<a href="#l140.21"></a><span id="l140.21">     let alarm2 = alarm.clone();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l141.1"></a><span id="l141.1" class="difflineminus">--- a/calendar/test/unit/test_ltninvitationutils.js</span>
<a href="#l141.2"></a><span id="l141.2" class="difflineplus">+++ b/calendar/test/unit/test_ltninvitationutils.js</span>
<a href="#l141.3"></a><span id="l141.3" class="difflineat">@@ -131,18 +131,17 @@ add_task(async function getItipHeader_te</span>
<a href="#l141.4"></a><span id="l141.4">             method: &quot;&quot;,</span>
<a href="#l141.5"></a><span id="l141.5">             attendees: [&quot;&quot;]</span>
<a href="#l141.6"></a><span id="l141.6">         },</span>
<a href="#l141.7"></a><span id="l141.7">         expected: &quot;Event Invitation&quot;</span>
<a href="#l141.8"></a><span id="l141.8">     }];</span>
<a href="#l141.9"></a><span id="l141.9">     let i = 0;</span>
<a href="#l141.10"></a><span id="l141.10">     for (let test of data) {</span>
<a href="#l141.11"></a><span id="l141.11">         i++;</span>
<a href="#l141.12"></a><span id="l141.12" class="difflineminus">-        let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l141.13"></a><span id="l141.13" class="difflineminus">-                                 .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l141.14"></a><span id="l141.14" class="difflineplus">+        let itipItem = Cc[&quot;@mozilla.org/calendar/itip-item;1&quot;].createInstance(Ci.calIItipItem);</span>
<a href="#l141.15"></a><span id="l141.15">         let item = getIcs();</span>
<a href="#l141.16"></a><span id="l141.16">         let sender;</span>
<a href="#l141.17"></a><span id="l141.17">         if (test.input.method || test.input.method == &quot;&quot;) {</span>
<a href="#l141.18"></a><span id="l141.18">             item = item.replace(/METHOD:REQUEST\r\n/, test.input.method);</span>
<a href="#l141.19"></a><span id="l141.19">         }</span>
<a href="#l141.20"></a><span id="l141.20">         if (test.input.attendees.length) {</span>
<a href="#l141.21"></a><span id="l141.21">             let attendees = test.input.attendees.filter(aAtt =&gt; !!aAtt).join(&quot;\r\n&quot;);</span>
<a href="#l141.22"></a><span id="l141.22">             item = item.replace(/(ATTENDEE.+(?:\r\n))/, attendees + &quot;\r\n&quot;);</span>
<a href="#l141.23"></a><span id="l141.23" class="difflineat">@@ -364,21 +363,19 @@ add_task(async function createInvitation</span>
<a href="#l141.24"></a><span id="l141.24">                 case &quot;attach&quot;:</span>
<a href="#l141.25"></a><span id="l141.25">                     item = item.replace(/ATTACH:[^\r]+\r\n/, test.input.attach);</span>
<a href="#l141.26"></a><span id="l141.26">                     break;</span>
<a href="#l141.27"></a><span id="l141.27">                 case &quot;url&quot;:</span>
<a href="#l141.28"></a><span id="l141.28">                     item = item.replace(/URL:[^\r]+\r\n/, test.input.url);</span>
<a href="#l141.29"></a><span id="l141.29">                     break;</span>
<a href="#l141.30"></a><span id="l141.30">             }</span>
<a href="#l141.31"></a><span id="l141.31">         }</span>
<a href="#l141.32"></a><span id="l141.32" class="difflineminus">-        let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l141.33"></a><span id="l141.33" class="difflineminus">-                                 .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l141.34"></a><span id="l141.34" class="difflineplus">+        let itipItem = Cc[&quot;@mozilla.org/calendar/itip-item;1&quot;].createInstance(Ci.calIItipItem);</span>
<a href="#l141.35"></a><span id="l141.35">         itipItem.init(item);</span>
<a href="#l141.36"></a><span id="l141.36" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l141.37"></a><span id="l141.37" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l141.38"></a><span id="l141.38" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l141.39"></a><span id="l141.39">         parser.parseString(item);</span>
<a href="#l141.40"></a><span id="l141.40">         let dom = ltn.invitation.createInvitationOverlay(parser.getItems({})[0], itipItem);</span>
<a href="#l141.41"></a><span id="l141.41">         let observed = dom.getElementById(test.expected.node).innerHTML;</span>
<a href="#l141.42"></a><span id="l141.42">         // we remove line-breaks and leading white spaces here so we can keep expected test results</span>
<a href="#l141.43"></a><span id="l141.43">         // above more comprehensive</span>
<a href="#l141.44"></a><span id="l141.44">         if (test.expected.node.endsWith(&quot;-table&quot;)) {</span>
<a href="#l141.45"></a><span id="l141.45">             observed = observed.replace(/(?:\n|\r\n|\r)[ ]{2,}/g, &quot;&quot;);</span>
<a href="#l141.46"></a><span id="l141.46">         }</span>
<a href="#l141.47"></a><span id="l141.47" class="difflineat">@@ -395,21 +392,19 @@ add_task(async function compareInvitatio</span>
<a href="#l141.48"></a><span id="l141.48">         for (let prop of props) {</span>
<a href="#l141.49"></a><span id="l141.49">             if (Object.keys(aInput).includes(prop)) {</span>
<a href="#l141.50"></a><span id="l141.50">                 let regex = prop.toUpperCase() +</span>
<a href="#l141.51"></a><span id="l141.51">                             ([&quot;summary&quot;, &quot;location&quot;].includes(prop) ? &quot;:&quot; : &quot;;&quot;) +</span>
<a href="#l141.52"></a><span id="l141.52">                             &quot;[^\r]+\r\n&quot;;</span>
<a href="#l141.53"></a><span id="l141.53">                 item = item.replace(new RegExp(regex), aInput[prop]);</span>
<a href="#l141.54"></a><span id="l141.54">             }</span>
<a href="#l141.55"></a><span id="l141.55">         }</span>
<a href="#l141.56"></a><span id="l141.56" class="difflineminus">-        let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l141.57"></a><span id="l141.57" class="difflineminus">-                                 .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l141.58"></a><span id="l141.58" class="difflineplus">+        let itipItem = Cc[&quot;@mozilla.org/calendar/itip-item;1&quot;].createInstance(Ci.calIItipItem);</span>
<a href="#l141.59"></a><span id="l141.59">         itipItem.init(item);</span>
<a href="#l141.60"></a><span id="l141.60" class="difflineminus">-        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l141.61"></a><span id="l141.61" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l141.62"></a><span id="l141.62" class="difflineplus">+        let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l141.63"></a><span id="l141.63">         parser.parseString(item);</span>
<a href="#l141.64"></a><span id="l141.64">         let dom = ltn.invitation.createInvitationOverlay(parser.getItems({})[0], itipItem);</span>
<a href="#l141.65"></a><span id="l141.65">         return cal.xml.serializeDOM(dom);</span>
<a href="#l141.66"></a><span id="l141.66">     }</span>
<a href="#l141.67"></a><span id="l141.67">     let data = [{</span>
<a href="#l141.68"></a><span id="l141.68">         input: {</span>
<a href="#l141.69"></a><span id="l141.69">             previous: { location: &quot;LOCATION:This place\r\n&quot; },</span>
<a href="#l141.70"></a><span id="l141.70">             current: { location: &quot;LOCATION:Another location\r\n&quot; },</span>
<a href="#l141.71"></a><span id="l141.71" class="difflineat">@@ -640,18 +635,17 @@ add_task(async function getHeaderSection</span>
<a href="#l141.72"></a><span id="l141.72">         identity.fullName = test.input.identity.fullName || null;</span>
<a href="#l141.73"></a><span id="l141.73">         identity.replyTo = test.input.identity.replyTo || null;</span>
<a href="#l141.74"></a><span id="l141.74">         identity.organization = test.input.identity.organization || null;</span>
<a href="#l141.75"></a><span id="l141.75">         identity.doCc = test.input.identity.doCc || (test.input.identity.cc);</span>
<a href="#l141.76"></a><span id="l141.76">         identity.doCcList = test.input.identity.cc || null;</span>
<a href="#l141.77"></a><span id="l141.77">         identity.doBcc = test.input.identity.doBcc || (test.input.identity.bcc);</span>
<a href="#l141.78"></a><span id="l141.78">         identity.doBccList = test.input.identity.bcc || null;</span>
<a href="#l141.79"></a><span id="l141.79"> </span>
<a href="#l141.80"></a><span id="l141.80" class="difflineminus">-        let composeUtils = Components.classes[&quot;@mozilla.org/messengercompose/computils;1&quot;]</span>
<a href="#l141.81"></a><span id="l141.81" class="difflineminus">-                                     .createInstance(Components.interfaces.nsIMsgCompUtils);</span>
<a href="#l141.82"></a><span id="l141.82" class="difflineplus">+        let composeUtils = Cc[&quot;@mozilla.org/messengercompose/computils;1&quot;].createInstance(Ci.nsIMsgCompUtils);</span>
<a href="#l141.83"></a><span id="l141.83">         let messageId = composeUtils.msgGenerateMessageId(identity);</span>
<a href="#l141.84"></a><span id="l141.84"> </span>
<a href="#l141.85"></a><span id="l141.85">         let header = ltn.invitation.getHeaderSection(messageId, identity,</span>
<a href="#l141.86"></a><span id="l141.86">                                                      test.input.toList, test.input.subject);</span>
<a href="#l141.87"></a><span id="l141.87">         // we test Date and Message-ID headers separately to avoid false positives</span>
<a href="#l141.88"></a><span id="l141.88">         ok(!!header.match(/Date:.+(?:\n|\r\n|\r)/),</span>
<a href="#l141.89"></a><span id="l141.89">            &quot;(test #&quot; + i + &quot;): date&quot;);</span>
<a href="#l141.90"></a><span id="l141.90">         ok(!!header.match(/Message-ID:.+(?:\n|\r\n|\r)/),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l142.1"></a><span id="l142.1" class="difflineminus">--- a/calendar/test/unit/test_providers.js</span>
<a href="#l142.2"></a><span id="l142.2" class="difflineplus">+++ b/calendar/test/unit/test_providers.js</span>
<a href="#l142.3"></a><span id="l142.3" class="difflineat">@@ -1,14 +1,12 @@</span>
<a href="#l142.4"></a><span id="l142.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l142.5"></a><span id="l142.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l142.6"></a><span id="l142.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l142.7"></a><span id="l142.7"> </span>
<a href="#l142.8"></a><span id="l142.8" class="difflineminus">-const cIC = Components.interfaces.calICalendar;</span>
<a href="#l142.9"></a><span id="l142.9" class="difflineminus">-</span>
<a href="#l142.10"></a><span id="l142.10"> var icalStringArray = [</span>
<a href="#l142.11"></a><span id="l142.11">     // Comments refer to the range defined in testGetItems().</span>
<a href="#l142.12"></a><span id="l142.12">     // 1: one-hour event</span>
<a href="#l142.13"></a><span id="l142.13">     &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l142.14"></a><span id="l142.14">     &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l142.15"></a><span id="l142.15">     &quot;DTEND:20020402T124500Z\n&quot; +</span>
<a href="#l142.16"></a><span id="l142.16">     &quot;END:VEVENT\n&quot;,</span>
<a href="#l142.17"></a><span id="l142.17">     // 2: Test a zero-length event with DTSTART and DTEND</span>
<a href="#l142.18"></a><span id="l142.18" class="difflineat">@@ -439,17 +437,17 @@ async function testOfflineStorage(storag</span>
<a href="#l142.19"></a><span id="l142.19"> </span>
<a href="#l142.20"></a><span id="l142.20">     event1 = await pcal.addItem(event1);</span>
<a href="#l142.21"></a><span id="l142.21"> </span>
<a href="#l142.22"></a><span id="l142.22">     // Make sure the event is really in the calendar</span>
<a href="#l142.23"></a><span id="l142.23">     let result = await pcal.getAllItems();</span>
<a href="#l142.24"></a><span id="l142.24">     equal(result.length, 1);</span>
<a href="#l142.25"></a><span id="l142.25"> </span>
<a href="#l142.26"></a><span id="l142.26">     // When searching for offline added items, there are none</span>
<a href="#l142.27"></a><span id="l142.27" class="difflineminus">-    let filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l142.28"></a><span id="l142.28" class="difflineplus">+    let filter = Ci.calICalendar.ITEM_FILTER_ALL_ITEMS | Ci.calICalendar.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l142.29"></a><span id="l142.29">     result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l142.30"></a><span id="l142.30">     equal(result.length, 0);</span>
<a href="#l142.31"></a><span id="l142.31"> </span>
<a href="#l142.32"></a><span id="l142.32">     // Mark the item as offline added</span>
<a href="#l142.33"></a><span id="l142.33">     await pcal.addOfflineItem(event1);</span>
<a href="#l142.34"></a><span id="l142.34"> </span>
<a href="#l142.35"></a><span id="l142.35">     // Now there should be an offline item</span>
<a href="#l142.36"></a><span id="l142.36">     result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l142.37"></a><span id="l142.37" class="difflineat">@@ -458,45 +456,45 @@ async function testOfflineStorage(storag</span>
<a href="#l142.38"></a><span id="l142.38">     let event2 = event1.clone();</span>
<a href="#l142.39"></a><span id="l142.39">     event2.title = &quot;event2&quot;;</span>
<a href="#l142.40"></a><span id="l142.40"> </span>
<a href="#l142.41"></a><span id="l142.41">     event2 = await pcal.modifyItem(event2, event1);</span>
<a href="#l142.42"></a><span id="l142.42"> </span>
<a href="#l142.43"></a><span id="l142.43">     await pcal.modifyOfflineItem(event2);</span>
<a href="#l142.44"></a><span id="l142.44"> </span>
<a href="#l142.45"></a><span id="l142.45">     // The flag should still be offline added, as it was already marked as such</span>
<a href="#l142.46"></a><span id="l142.46" class="difflineminus">-    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l142.47"></a><span id="l142.47" class="difflineplus">+    filter = Ci.calICalendar.ITEM_FILTER_ALL_ITEMS | Ci.calICalendar.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l142.48"></a><span id="l142.48">     result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l142.49"></a><span id="l142.49">     equal(result.length, 1);</span>
<a href="#l142.50"></a><span id="l142.50"> </span>
<a href="#l142.51"></a><span id="l142.51">     // Reset the flag</span>
<a href="#l142.52"></a><span id="l142.52">     await pcal.resetItemOfflineFlag(event2);</span>
<a href="#l142.53"></a><span id="l142.53"> </span>
<a href="#l142.54"></a><span id="l142.54">     // No more offline items after resetting the flag</span>
<a href="#l142.55"></a><span id="l142.55" class="difflineminus">-    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l142.56"></a><span id="l142.56" class="difflineplus">+    filter = Ci.calICalendar.ITEM_FILTER_ALL_ITEMS | Ci.calICalendar.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l142.57"></a><span id="l142.57">     result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l142.58"></a><span id="l142.58">     equal(result.length, 0);</span>
<a href="#l142.59"></a><span id="l142.59"> </span>
<a href="#l142.60"></a><span id="l142.60">     // Setting modify flag without one set should actually set that flag</span>
<a href="#l142.61"></a><span id="l142.61">     await pcal.modifyOfflineItem(event2);</span>
<a href="#l142.62"></a><span id="l142.62" class="difflineminus">-    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l142.63"></a><span id="l142.63" class="difflineplus">+    filter = Ci.calICalendar.ITEM_FILTER_ALL_ITEMS | Ci.calICalendar.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l142.64"></a><span id="l142.64">     result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l142.65"></a><span id="l142.65">     equal(result.length, 0);</span>
<a href="#l142.66"></a><span id="l142.66"> </span>
<a href="#l142.67"></a><span id="l142.67" class="difflineminus">-    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_MODIFIED;</span>
<a href="#l142.68"></a><span id="l142.68" class="difflineplus">+    filter = Ci.calICalendar.ITEM_FILTER_ALL_ITEMS | Ci.calICalendar.ITEM_FILTER_OFFLINE_MODIFIED;</span>
<a href="#l142.69"></a><span id="l142.69">     result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l142.70"></a><span id="l142.70">     equal(result.length, 1);</span>
<a href="#l142.71"></a><span id="l142.71"> </span>
<a href="#l142.72"></a><span id="l142.72">     // Setting the delete flag should modify the flag accordingly</span>
<a href="#l142.73"></a><span id="l142.73">     await pcal.deleteOfflineItem(event2);</span>
<a href="#l142.74"></a><span id="l142.74" class="difflineminus">-    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_MODIFIED;</span>
<a href="#l142.75"></a><span id="l142.75" class="difflineplus">+    filter = Ci.calICalendar.ITEM_FILTER_ALL_ITEMS | Ci.calICalendar.ITEM_FILTER_OFFLINE_MODIFIED;</span>
<a href="#l142.76"></a><span id="l142.76">     result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l142.77"></a><span id="l142.77">     equal(result.length, 0);</span>
<a href="#l142.78"></a><span id="l142.78"> </span>
<a href="#l142.79"></a><span id="l142.79" class="difflineminus">-    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_DELETED;</span>
<a href="#l142.80"></a><span id="l142.80" class="difflineplus">+    filter = Ci.calICalendar.ITEM_FILTER_ALL_ITEMS | Ci.calICalendar.ITEM_FILTER_OFFLINE_DELETED;</span>
<a href="#l142.81"></a><span id="l142.81">     result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l142.82"></a><span id="l142.82">     equal(result.length, 1);</span>
<a href="#l142.83"></a><span id="l142.83"> </span>
<a href="#l142.84"></a><span id="l142.84">     // Setting the delete flag on an offline added item should remove it</span>
<a href="#l142.85"></a><span id="l142.85">     await pcal.resetItemOfflineFlag(event2);</span>
<a href="#l142.86"></a><span id="l142.86">     await pcal.addOfflineItem(event2);</span>
<a href="#l142.87"></a><span id="l142.87">     await pcal.deleteOfflineItem(event2);</span>
<a href="#l142.88"></a><span id="l142.88">     result = await pcal.getAllItems();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l143.1"></a><span id="l143.1" class="difflineminus">--- a/calendar/test/unit/test_recur.js</span>
<a href="#l143.2"></a><span id="l143.2" class="difflineplus">+++ b/calendar/test/unit/test_recur.js</span>
<a href="#l143.3"></a><span id="l143.3" class="difflineat">@@ -541,17 +541,17 @@ function test_clone(event) {</span>
<a href="#l143.4"></a><span id="l143.4"> function test_interface() {</span>
<a href="#l143.5"></a><span id="l143.5">     let item = makeEvent(&quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l143.6"></a><span id="l143.6">                          &quot;DTEND:20020402T124500Z\n&quot; +</span>
<a href="#l143.7"></a><span id="l143.7">                          &quot;RRULE:FREQ=WEEKLY;COUNT=6;BYDAY=TU,WE\r\n&quot; +</span>
<a href="#l143.8"></a><span id="l143.8">                          &quot;EXDATE:20020403T114500Z\r\n&quot; +</span>
<a href="#l143.9"></a><span id="l143.9">                          &quot;RDATE:20020401T114500Z\r\n&quot;);</span>
<a href="#l143.10"></a><span id="l143.10"> </span>
<a href="#l143.11"></a><span id="l143.11">     let rinfo = item.recurrenceInfo;</span>
<a href="#l143.12"></a><span id="l143.12" class="difflineminus">-    ok(cal.data.compareObjects(rinfo.item, item, Components.interfaces.calIEvent));</span>
<a href="#l143.13"></a><span id="l143.13" class="difflineplus">+    ok(cal.data.compareObjects(rinfo.item, item, Ci.calIEvent));</span>
<a href="#l143.14"></a><span id="l143.14"> </span>
<a href="#l143.15"></a><span id="l143.15">     // getRecurrenceItems</span>
<a href="#l143.16"></a><span id="l143.16">     let ritems = rinfo.getRecurrenceItems({});</span>
<a href="#l143.17"></a><span id="l143.17">     equal(ritems.length, 3);</span>
<a href="#l143.18"></a><span id="l143.18"> </span>
<a href="#l143.19"></a><span id="l143.19">     let checkritems = new Map(ritems.map(ritem =&gt; [ritem.icalProperty.propertyName, ritem.icalProperty]));</span>
<a href="#l143.20"></a><span id="l143.20">     let rparts = new Map(checkritems.get(&quot;RRULE&quot;).value.split(&quot;;&quot;).map(value =&gt; value.split(&quot;=&quot;, 2)));</span>
<a href="#l143.21"></a><span id="l143.21">     equal(rparts.size, 3);</span>
<a href="#l143.22"></a><span id="l143.22" class="difflineat">@@ -593,40 +593,40 @@ function test_interface() {</span>
<a href="#l143.23"></a><span id="l143.23"> </span>
<a href="#l143.24"></a><span id="l143.24">     // appendRecurrenceItems / getRecurrenceItemAt / insertRecurrenceItemAt</span>
<a href="#l143.25"></a><span id="l143.25">     rinfo.appendRecurrenceItem(ritems[0]);</span>
<a href="#l143.26"></a><span id="l143.26">     rinfo.appendRecurrenceItem(ritems[1]);</span>
<a href="#l143.27"></a><span id="l143.27">     rinfo.insertRecurrenceItemAt(ritems[2], 0);</span>
<a href="#l143.28"></a><span id="l143.28"> </span>
<a href="#l143.29"></a><span id="l143.29">     ok(cal.data.compareObjects(ritems[2],</span>
<a href="#l143.30"></a><span id="l143.30">                           rinfo.getRecurrenceItemAt(0),</span>
<a href="#l143.31"></a><span id="l143.31" class="difflineminus">-                          Components.interfaces.calIRecurrenceItem));</span>
<a href="#l143.32"></a><span id="l143.32" class="difflineplus">+                          Ci.calIRecurrenceItem));</span>
<a href="#l143.33"></a><span id="l143.33">     ok(cal.data.compareObjects(ritems[0],</span>
<a href="#l143.34"></a><span id="l143.34">                           rinfo.getRecurrenceItemAt(1),</span>
<a href="#l143.35"></a><span id="l143.35" class="difflineminus">-                          Components.interfaces.calIRecurrenceItem));</span>
<a href="#l143.36"></a><span id="l143.36" class="difflineplus">+                          Ci.calIRecurrenceItem));</span>
<a href="#l143.37"></a><span id="l143.37">     ok(cal.data.compareObjects(ritems[1],</span>
<a href="#l143.38"></a><span id="l143.38">                           rinfo.getRecurrenceItemAt(2),</span>
<a href="#l143.39"></a><span id="l143.39" class="difflineminus">-                          Components.interfaces.calIRecurrenceItem));</span>
<a href="#l143.40"></a><span id="l143.40" class="difflineplus">+                          Ci.calIRecurrenceItem));</span>
<a href="#l143.41"></a><span id="l143.41"> </span>
<a href="#l143.42"></a><span id="l143.42"> </span>
<a href="#l143.43"></a><span id="l143.43">     // deleteRecurrenceItem</span>
<a href="#l143.44"></a><span id="l143.44">     rinfo.deleteRecurrenceItem(ritems[0]);</span>
<a href="#l143.45"></a><span id="l143.45">     ok(!item.icalString.includes(&quot;RRULE&quot;));</span>
<a href="#l143.46"></a><span id="l143.46"> </span>
<a href="#l143.47"></a><span id="l143.47">     // deleteRecurrenceItemAt</span>
<a href="#l143.48"></a><span id="l143.48">     rinfo.deleteRecurrenceItemAt(1);</span>
<a href="#l143.49"></a><span id="l143.49">     itemString = item.icalString;</span>
<a href="#l143.50"></a><span id="l143.50">     ok(!itemString.includes(&quot;EXDATE&quot;));</span>
<a href="#l143.51"></a><span id="l143.51">     ok(itemString.includes(&quot;RDATE&quot;));</span>
<a href="#l143.52"></a><span id="l143.52"> </span>
<a href="#l143.53"></a><span id="l143.53">     // insertRecurrenceItemAt with exdate</span>
<a href="#l143.54"></a><span id="l143.54">     rinfo.insertRecurrenceItemAt(ritems[1], 1);</span>
<a href="#l143.55"></a><span id="l143.55">     ok(cal.data.compareObjects(ritems[1],</span>
<a href="#l143.56"></a><span id="l143.56">                           rinfo.getRecurrenceItemAt(1),</span>
<a href="#l143.57"></a><span id="l143.57" class="difflineminus">-                          Components.interfaces.calIRecurrenceItem));</span>
<a href="#l143.58"></a><span id="l143.58" class="difflineplus">+                          Ci.calIRecurrenceItem));</span>
<a href="#l143.59"></a><span id="l143.59">     rinfo.deleteRecurrenceItem(ritems[1]);</span>
<a href="#l143.60"></a><span id="l143.60"> </span>
<a href="#l143.61"></a><span id="l143.61">     // isFinite = true</span>
<a href="#l143.62"></a><span id="l143.62">     ok(rinfo.isFinite);</span>
<a href="#l143.63"></a><span id="l143.63">     rinfo.appendRecurrenceItem(ritems[0]);</span>
<a href="#l143.64"></a><span id="l143.64">     ok(rinfo.isFinite);</span>
<a href="#l143.65"></a><span id="l143.65"> </span>
<a href="#l143.66"></a><span id="l143.66">     // isFinite = false</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l144.1"></a><span id="l144.1" class="difflineminus">--- a/calendar/test/unit/test_search_service.js</span>
<a href="#l144.2"></a><span id="l144.2" class="difflineplus">+++ b/calendar/test/unit/test_search_service.js</span>
<a href="#l144.3"></a><span id="l144.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l144.4"></a><span id="l144.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l144.5"></a><span id="l144.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l144.6"></a><span id="l144.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l144.7"></a><span id="l144.7"> </span>
<a href="#l144.8"></a><span id="l144.8" class="difflineminus">-var HINT_EXACT_MATCH = Components.interfaces.calICalendarSearchProvider.HINT_EXACT_MATCH;</span>
<a href="#l144.9"></a><span id="l144.9" class="difflineminus">-var search = Components.classes[&quot;@mozilla.org/calendar/calendarsearch-service;1&quot;]</span>
<a href="#l144.10"></a><span id="l144.10" class="difflineminus">-                       .getService(Components.interfaces.calICalendarSearchService);</span>
<a href="#l144.11"></a><span id="l144.11" class="difflineplus">+var HINT_EXACT_MATCH = Ci.calICalendarSearchProvider.HINT_EXACT_MATCH;</span>
<a href="#l144.12"></a><span id="l144.12" class="difflineplus">+var search = Cc[&quot;@mozilla.org/calendar/calendarsearch-service;1&quot;].getService(Ci.calICalendarSearchService);</span>
<a href="#l144.13"></a><span id="l144.13"> </span>
<a href="#l144.14"></a><span id="l144.14"> function run_test() {</span>
<a href="#l144.15"></a><span id="l144.15">     test_found();</span>
<a href="#l144.16"></a><span id="l144.16">     test_failure();</span>
<a href="#l144.17"></a><span id="l144.17">     test_cancel();</span>
<a href="#l144.18"></a><span id="l144.18"> }</span>
<a href="#l144.19"></a><span id="l144.19"> </span>
<a href="#l144.20"></a><span id="l144.20"> function test_found() {</span>
<a href="#l144.21"></a><span id="l144.21" class="difflineat">@@ -97,26 +96,26 @@ function test_cancel() {</span>
<a href="#l144.22"></a><span id="l144.22">             Ci.calIOperation</span>
<a href="#l144.23"></a><span id="l144.23">         ]),</span>
<a href="#l144.24"></a><span id="l144.24">         searchForCalendars: function(aStr, aHint, aMax, aListener) {</span>
<a href="#l144.25"></a><span id="l144.25">             Services.tm.currentThread.dispatch({</span>
<a href="#l144.26"></a><span id="l144.26">                 run: function() {</span>
<a href="#l144.27"></a><span id="l144.27">                     dump(&quot;Cancelling search...&quot;);</span>
<a href="#l144.28"></a><span id="l144.28">                     operation.cancel();</span>
<a href="#l144.29"></a><span id="l144.29">                 }</span>
<a href="#l144.30"></a><span id="l144.30" class="difflineminus">-            }, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l144.31"></a><span id="l144.31" class="difflineplus">+            }, Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l144.32"></a><span id="l144.32"> </span>
<a href="#l144.33"></a><span id="l144.33">             // No listener call, we emulate a long running search</span>
<a href="#l144.34"></a><span id="l144.34">             // Do return the operation though</span>
<a href="#l144.35"></a><span id="l144.35">             return this;</span>
<a href="#l144.36"></a><span id="l144.36">         },</span>
<a href="#l144.37"></a><span id="l144.37"> </span>
<a href="#l144.38"></a><span id="l144.38">         isPending: true,</span>
<a href="#l144.39"></a><span id="l144.39">         cancelCalled: false,</span>
<a href="#l144.40"></a><span id="l144.40" class="difflineminus">-        status: Components.results.NS_OK,</span>
<a href="#l144.41"></a><span id="l144.41" class="difflineplus">+        status: Cr.NS_OK,</span>
<a href="#l144.42"></a><span id="l144.42">         cancel: function() {</span>
<a href="#l144.43"></a><span id="l144.43">             this.cancelCalled = true;</span>
<a href="#l144.44"></a><span id="l144.44">         },</span>
<a href="#l144.45"></a><span id="l144.45">     };</span>
<a href="#l144.46"></a><span id="l144.46"> </span>
<a href="#l144.47"></a><span id="l144.47">     let listener = {</span>
<a href="#l144.48"></a><span id="l144.48">         called: false,</span>
<a href="#l144.49"></a><span id="l144.49">         onResult: function(request, result) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l145.1"></a><span id="l145.1" class="difflineminus">--- a/calendar/test/unit/test_startup_service.js</span>
<a href="#l145.2"></a><span id="l145.2" class="difflineplus">+++ b/calendar/test/unit/test_startup_service.js</span>
<a href="#l145.3"></a><span id="l145.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l145.4"></a><span id="l145.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l145.5"></a><span id="l145.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l145.6"></a><span id="l145.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l145.7"></a><span id="l145.7"> </span>
<a href="#l145.8"></a><span id="l145.8"> function run_test() {</span>
<a href="#l145.9"></a><span id="l145.9" class="difflineminus">-    let ssvc = Components.classes[&quot;@mozilla.org/calendar/startup-service;1&quot;]</span>
<a href="#l145.10"></a><span id="l145.10" class="difflineminus">-                         .getService(Components.interfaces.nsIObserver);</span>
<a href="#l145.11"></a><span id="l145.11" class="difflineplus">+    let ssvc = Cc[&quot;@mozilla.org/calendar/startup-service;1&quot;].getService(Ci.nsIObserver);</span>
<a href="#l145.12"></a><span id="l145.12"> </span>
<a href="#l145.13"></a><span id="l145.13">     let first = {</span>
<a href="#l145.14"></a><span id="l145.14">         startup: function(aListener) {</span>
<a href="#l145.15"></a><span id="l145.15">             second.canStart = true;</span>
<a href="#l145.16"></a><span id="l145.16">             aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l145.17"></a><span id="l145.17">         },</span>
<a href="#l145.18"></a><span id="l145.18">         shutdown: function(aListener) {</span>
<a href="#l145.19"></a><span id="l145.19">             ok(this.canStop);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l146.1"></a><span id="l146.1" class="difflineminus">--- a/calendar/test/unit/test_storage.js</span>
<a href="#l146.2"></a><span id="l146.2" class="difflineplus">+++ b/calendar/test/unit/test_storage.js</span>
<a href="#l146.3"></a><span id="l146.3" class="difflineat">@@ -69,24 +69,24 @@ function testAttachRoundtrip() {</span>
<a href="#l146.4"></a><span id="l146.4">             let rel = relations[0];</span>
<a href="#l146.5"></a><span id="l146.5">             equal(relations.length, 1);</span>
<a href="#l146.6"></a><span id="l146.6">             equal(rel.relType, &quot;SIBLING&quot;);</span>
<a href="#l146.7"></a><span id="l146.7">             equal(rel.relId, &quot;VALUE&quot;);</span>
<a href="#l146.8"></a><span id="l146.8">             equal(rel.getParameter(&quot;FOO&quot;), &quot;BAR&quot;);</span>
<a href="#l146.9"></a><span id="l146.9"> </span>
<a href="#l146.10"></a><span id="l146.10">             // Check recurrence item</span>
<a href="#l146.11"></a><span id="l146.11">             for (let ritem of item.recurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l146.12"></a><span id="l146.12" class="difflineminus">-                if (ritem instanceof Components.interfaces.calIRecurrenceRule) {</span>
<a href="#l146.13"></a><span id="l146.13" class="difflineplus">+                if (ritem instanceof Ci.calIRecurrenceRule) {</span>
<a href="#l146.14"></a><span id="l146.14">                     equal(ritem.type, &quot;MONTHLY&quot;);</span>
<a href="#l146.15"></a><span id="l146.15">                     equal(ritem.interval, 2);</span>
<a href="#l146.16"></a><span id="l146.16">                     equal(ritem.count, 5);</span>
<a href="#l146.17"></a><span id="l146.17">                     equal(ritem.isByCount, true);</span>
<a href="#l146.18"></a><span id="l146.18">                     equal(ritem.getComponent(&quot;BYDAY&quot;, {}).toString(), [2].toString());</span>
<a href="#l146.19"></a><span id="l146.19">                     equal(ritem.isNegative, false);</span>
<a href="#l146.20"></a><span id="l146.20" class="difflineminus">-                } else if (ritem instanceof Components.interfaces.calIRecurrenceDate) {</span>
<a href="#l146.21"></a><span id="l146.21" class="difflineplus">+                } else if (ritem instanceof Ci.calIRecurrenceDate) {</span>
<a href="#l146.22"></a><span id="l146.22">                     if (ritem.isNegative) {</span>
<a href="#l146.23"></a><span id="l146.23">                         equal(ritem.date.compare(cal.createDateTime(&quot;20120301T010101Z&quot;)), 0);</span>
<a href="#l146.24"></a><span id="l146.24">                     } else {</span>
<a href="#l146.25"></a><span id="l146.25">                         equal(ritem.date.compare(cal.createDateTime(&quot;20120201T010101Z&quot;)), 0);</span>
<a href="#l146.26"></a><span id="l146.26">                     }</span>
<a href="#l146.27"></a><span id="l146.27">                 } else {</span>
<a href="#l146.28"></a><span id="l146.28">                     do_throw(&quot;Found unknown recurrence item &quot; + ritem);</span>
<a href="#l146.29"></a><span id="l146.29">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l147.1"></a><span id="l147.1" class="difflineminus">--- a/calendar/test/unit/test_utils.js</span>
<a href="#l147.2"></a><span id="l147.2" class="difflineplus">+++ b/calendar/test/unit/test_utils.js</span>
<a href="#l147.3"></a><span id="l147.3" class="difflineat">@@ -115,17 +115,17 @@ function test_OperationGroup() {</span>
<a href="#l147.4"></a><span id="l147.4">         cancelCalled = true;</span>
<a href="#l147.5"></a><span id="l147.5">         return true;</span>
<a href="#l147.6"></a><span id="l147.6">     }</span>
<a href="#l147.7"></a><span id="l147.7"> </span>
<a href="#l147.8"></a><span id="l147.8">     let group = new cal.data.OperationGroup(cancelFunc);</span>
<a href="#l147.9"></a><span id="l147.9"> </span>
<a href="#l147.10"></a><span id="l147.10">     ok(group.isEmpty);</span>
<a href="#l147.11"></a><span id="l147.11">     ok(group.id.endsWith(&quot;-0&quot;));</span>
<a href="#l147.12"></a><span id="l147.12" class="difflineminus">-    equal(group.status, Components.results.NS_OK);</span>
<a href="#l147.13"></a><span id="l147.13" class="difflineplus">+    equal(group.status, Cr.NS_OK);</span>
<a href="#l147.14"></a><span id="l147.14">     equal(group.isPending, true);</span>
<a href="#l147.15"></a><span id="l147.15"> </span>
<a href="#l147.16"></a><span id="l147.16">     let completedOp = { isPending: false };</span>
<a href="#l147.17"></a><span id="l147.17"> </span>
<a href="#l147.18"></a><span id="l147.18">     group.add(completedOp);</span>
<a href="#l147.19"></a><span id="l147.19">     ok(group.isEmpty);</span>
<a href="#l147.20"></a><span id="l147.20">     equal(group.isPending, true);</span>
<a href="#l147.21"></a><span id="l147.21"> </span>
<a href="#l147.22"></a><span id="l147.22" class="difflineat">@@ -147,17 +147,17 @@ function test_OperationGroup() {</span>
<a href="#l147.23"></a><span id="l147.23"> </span>
<a href="#l147.24"></a><span id="l147.24">     group.add(pendingOp2);</span>
<a href="#l147.25"></a><span id="l147.25">     group.remove(pendingOp1);</span>
<a href="#l147.26"></a><span id="l147.26">     ok(!group.isEmpty);</span>
<a href="#l147.27"></a><span id="l147.27">     equal(group.isPending, true);</span>
<a href="#l147.28"></a><span id="l147.28"> </span>
<a href="#l147.29"></a><span id="l147.29">     group.cancel();</span>
<a href="#l147.30"></a><span id="l147.30"> </span>
<a href="#l147.31"></a><span id="l147.31" class="difflineminus">-    equal(group.status, Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l147.32"></a><span id="l147.32" class="difflineplus">+    equal(group.status, Ci.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l147.33"></a><span id="l147.33">     ok(!group.isPending);</span>
<a href="#l147.34"></a><span id="l147.34">     ok(cancelCalled);</span>
<a href="#l147.35"></a><span id="l147.35">     ok(pendingOp2.cancelCalled);</span>
<a href="#l147.36"></a><span id="l147.36"> }</span>
<a href="#l147.37"></a><span id="l147.37"> </span>
<a href="#l147.38"></a><span id="l147.38"> function test_sameDay() {</span>
<a href="#l147.39"></a><span id="l147.39">     let createDate = cal.createDateTime.bind(cal);</span>
<a href="#l147.40"></a><span id="l147.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l148.1"></a><span id="l148.1" class="difflineminus">--- a/calendar/test/unit/test_webcal.js</span>
<a href="#l148.2"></a><span id="l148.2" class="difflineplus">+++ b/calendar/test/unit/test_webcal.js</span>
<a href="#l148.3"></a><span id="l148.3" class="difflineat">@@ -28,16 +28,16 @@ function run_test() {</span>
<a href="#l148.4"></a><span id="l148.4"> </span>
<a href="#l148.5"></a><span id="l148.5"> function check_webcal_uri(aUri) {</span>
<a href="#l148.6"></a><span id="l148.6">     let uri = Services.io.newURI(aUri);</span>
<a href="#l148.7"></a><span id="l148.7"> </span>
<a href="#l148.8"></a><span id="l148.8">     let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l148.9"></a><span id="l148.9">                                                  null,</span>
<a href="#l148.10"></a><span id="l148.10">                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l148.11"></a><span id="l148.11">                                                  null,</span>
<a href="#l148.12"></a><span id="l148.12" class="difflineminus">-                                                 Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l148.13"></a><span id="l148.13" class="difflineminus">-                                                 Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l148.14"></a><span id="l148.14" class="difflineplus">+                                                 Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l148.15"></a><span id="l148.15" class="difflineplus">+                                                 Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l148.16"></a><span id="l148.16"> </span>
<a href="#l148.17"></a><span id="l148.17">     NetUtil.asyncFetch(channel, (data, status, request) =&gt; {</span>
<a href="#l148.18"></a><span id="l148.18">         ok(Components.isSuccessCode(status));</span>
<a href="#l148.19"></a><span id="l148.19">         run_next_test();</span>
<a href="#l148.20"></a><span id="l148.20">     });</span>
<a href="#l148.21"></a><span id="l148.21"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

