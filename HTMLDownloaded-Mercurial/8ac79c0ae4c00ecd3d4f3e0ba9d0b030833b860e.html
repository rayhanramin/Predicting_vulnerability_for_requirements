<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 14502:8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e" />
<meta property="og:url" content="/comm-central/rev/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e" />
<meta property="og:description" content="Bug 953598 - Minimize the contacts window to the system tray instead of exiting the application (Windows and Linux)." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e">shortlog</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e">files</a> |
changeset |
<a href="/comm-central/raw-rev/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e">raw</a>  | <a href="/comm-central/archive/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953598">Bug 953598</a> - Minimize the contacts window to the system tray instead of exiting the application (Windows and Linux).
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#108;&#111;&#114;&#105;&#97;&#110;&#32;&#81;&#117;&#232;&#122;&#101;&#32;&#60;&#102;&#108;&#111;&#114;&#105;&#97;&#110;&#64;&#105;&#110;&#115;&#116;&#97;&#110;&#116;&#98;&#105;&#114;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 09 Apr 2011 01:38:00 +0200</td></tr>

<tr>
 <td>changeset 14502</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e">8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e</a></td>
</tr>



<tr>
<td>parent 14501</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/09dd8b5c50765c4af2ce7ec45f9c50cc67a0a699">09dd8b5c50765c4af2ce7ec45f9c50cc67a0a699</a>
</td>
</tr>

<tr>
<td>child 14503</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/36943035470df112841e926d596f102c76b338b0">36943035470df112841e926d596f102c76b338b0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953598">953598</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953598">Bug 953598</a> - Minimize the contacts window to the system tray instead of exiting the application (Windows and Linux).</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/app/profile/all-instantbird.js">im/app/profile/all-instantbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/app/profile/all-instantbird.js">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/app/profile/all-instantbird.js">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/app/profile/all-instantbird.js">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/app/profile/all-instantbird.js">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/app/profile/all-instantbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/Makefile.in">im/components/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/Makefile.in">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/Makefile.in">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/Makefile.in">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/Makefile.in">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/Makefile.in">im/components/mintrayr/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/Makefile.in">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/Makefile.in">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/Makefile.in">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/Makefile.in">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.js">im/components/mintrayr/content/mintrayr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.js">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.js">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.js">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.js">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.xul">im/components/mintrayr/content/mintrayr.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.xul">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.xul">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.xul">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.xul">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/content/mintrayr.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/jar.mn">im/components/mintrayr/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/jar.mn">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/jar.mn">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/jar.mn">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/jar.mn">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/resources.rc">im/components/mintrayr/resources.rc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/resources.rc">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/resources.rc">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/resources.rc">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/resources.rc">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/resources.rc">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayIToolkit.idl">im/components/mintrayr/trayIToolkit.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayIToolkit.idl">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayIToolkit.idl">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayIToolkit.idl">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayIToolkit.idl">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayIToolkit.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayModule.cpp">im/components/mintrayr/trayModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayModule.cpp">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayModule.cpp">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayModule.cpp">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayModule.cpp">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatform.h">im/components/mintrayr/trayPlatform.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatform.h">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatform.h">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatform.h">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatform.h">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatform.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.cpp">im/components/mintrayr/trayPlatformGtk2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.cpp">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.cpp">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.cpp">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.cpp">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.h">im/components/mintrayr/trayPlatformGtk2.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.h">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.h">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.h">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.h">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformGtk2.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.cpp">im/components/mintrayr/trayPlatformWin.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.cpp">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.cpp">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.cpp">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.cpp">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.h">im/components/mintrayr/trayPlatformWin.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.h">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.h">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.h">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.h">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayPlatformWin.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.cpp">im/components/mintrayr/trayToolkit.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.cpp">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.cpp">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.cpp">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.cpp">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.h">im/components/mintrayr/trayToolkit.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.h">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.h">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.h">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.h">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/components/mintrayr/trayToolkit.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/content/preferences/main.xul">im/content/preferences/main.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/content/preferences/main.xul">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/content/preferences/main.xul">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/content/preferences/main.xul">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/content/preferences/main.xul">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/content/preferences/main.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/installer/package-manifest.in">im/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/mintrayr.dtd">im/locales/en-US/chrome/instantbird/mintrayr.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/mintrayr.dtd">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/mintrayr.dtd">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/mintrayr.dtd">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/mintrayr.dtd">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/mintrayr.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/preferences/main.dtd">im/locales/en-US/chrome/instantbird/preferences/main.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/preferences/main.dtd">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/preferences/main.dtd">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/preferences/main.dtd">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/preferences/main.dtd">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/en-US/chrome/instantbird/preferences/main.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/jar.mn">im/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/makefiles.sh">im/makefiles.sh</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/makefiles.sh">file</a> |
<a href="/comm-central/annotate/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/makefiles.sh">annotate</a> |
<a href="/comm-central/diff/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/makefiles.sh">diff</a> |
<a href="/comm-central/comparison/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/makefiles.sh">comparison</a> |
<a href="/comm-central/log/8ac79c0ae4c00ecd3d4f3e0ba9d0b030833b860e/im/makefiles.sh">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/im/app/profile/all-instantbird.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/im/app/profile/all-instantbird.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -57,16 +57,18 @@ pref(&quot;messenger.conversations.textbox.au</span>
<a href="#l1.4"></a><span id="l1.4"> pref(&quot;messenger.conversations.textbox.defaultMaxLines&quot;, 5);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> pref(&quot;messenger.conversations.sendFormat&quot;, true);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> pref(&quot;messenger.options.getAttentionOnNewMessages&quot;, true);</span>
<a href="#l1.9"></a><span id="l1.9"> pref(&quot;messenger.options.notifyOfNewMessages&quot;, false);</span>
<a href="#l1.10"></a><span id="l1.10"> #ifdef XP_MACOSX</span>
<a href="#l1.11"></a><span id="l1.11"> pref(&quot;messenger.options.showUnreadCountInDock&quot;, true);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+#else</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+pref(&quot;extensions.mintrayr.minimizeon&quot;, 2);</span>
<a href="#l1.14"></a><span id="l1.14"> #endif</span>
<a href="#l1.15"></a><span id="l1.15"> pref(&quot;messenger.options.playSounds&quot;, true);</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> // this preference changes how we filter incoming messages</span>
<a href="#l1.18"></a><span id="l1.18"> // 0 = no formattings</span>
<a href="#l1.19"></a><span id="l1.19"> // 1 = basic formattings (bold, italic, underlined)</span>
<a href="#l1.20"></a><span id="l1.20"> // 2 = permissive mode (colors, font face, font size, ...)</span>
<a href="#l1.21"></a><span id="l1.21"> pref(&quot;messenger.options.filterMode&quot;, 2);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/im/components/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/im/components/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -36,16 +36,20 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> DEPTH		= ../..</span>
<a href="#l2.6"></a><span id="l2.6"> topsrcdir	= @top_srcdir@</span>
<a href="#l2.7"></a><span id="l2.7"> srcdir		= @srcdir@</span>
<a href="#l2.8"></a><span id="l2.8"> VPATH		= @srcdir@</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ifneq ($(MOZ_WIDGET_TOOLKIT),cocoa)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+DIRS = mintrayr</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+endif</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16"> MODULE		= instantbird</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> XPIDLSRCS	= ibILogger.idl</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> EXTRA_COMPONENTS = \</span>
<a href="#l2.21"></a><span id="l2.21"> 	ibCommandLineHandler.manifest \</span>
<a href="#l2.22"></a><span id="l2.22"> 	logger.manifest \</span>
<a href="#l2.23"></a><span id="l2.23"> 	smileProtocolHandler.js smileProtocolHandler.manifest \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/im/components/mintrayr/Makefile.in</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,85 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+#</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+# License.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+#</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+# The Original Code is the TrayToolkit</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+#</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+# Nils Maier</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+#</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+#   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+#</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+#</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+DEPTH		= ../../..</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+IS_COMPONENT = 1</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+MODULE = mintrayr</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+LIBRARY_NAME = trayToolkit</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+XPIDL_MODULE = trayToolkit</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+EXPORTS = \</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+		trayToolkit.h \</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+		$(NULL)</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+XPIDLSRCS = \</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+		trayIToolkit.idl \</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+		$(NULL)</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+CPPSRCS = trayModule.cpp trayToolkit.cpp</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+# Platform specific stuff</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+ifeq ($(MOZ_WIDGET_TOOLKIT),windows)</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+CPPSRCS += trayPlatformWin.cpp</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+OS_LIBS += shell32.lib</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+RCFILE = resources.rc</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+RESFILE = resources.res</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+else</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+ifeq ($(MOZ_WIDGET_TOOLKIT),gtk2)</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+CPPSRCS += trayPlatformGtk2.cpp</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+LOCAL_INCLUDES += $(MOZ_GTK2_CFLAGS)</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+OS_LIBS += $(TK_LIBS) $(XLIBS)</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+endif # gtk2</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+endif # windows</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+#USE_STATIC_LIBS = 1</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+EXTRA_DSO_LDOPTS += $(XPCOM_GLUE_LDOPTS) $(MOZ_COMPONENT_NSPR_LIBS)</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+#EXTRA_DSO_LDOPTS += \</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+		$(XPCOM_GLUE_LDOPTS) \</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+		$(NSPR_LIBS) \</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+		$(NULL)</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/im/components/mintrayr/content/mintrayr.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,79 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * The Original Code is MiniTrayR extension</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ *</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * Nils Maier.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *   Florian Queze &lt;florian@instantbird.org&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ *</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ *</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+var gMinTrayR = {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  load: function() {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    window.removeEventListener(&quot;load&quot;, gMinTrayR.load, true);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    gMinTrayR.init();</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  },</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  init: function() {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+    window.removeEventListener(&quot;load&quot;, gMinTrayR.init, true);</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    let node = document.getElementById(&quot;menu_FileQuitItem&quot;).cloneNode(true);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    node.setAttribute('id', 'MinTrayR_' + node.id);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+    this.menu.appendChild(node);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    window.addEventListener(&quot;TrayDblClick&quot;, this, true);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+    window.addEventListener(&quot;TrayClick&quot;, this, true);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    this.trayService =</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+      Components.classes['@tn123.ath.cx/trayservice;1']</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+                .getService(Components.interfaces.trayITrayService);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    this.trayService.watchMinimize(window);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  },</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  get menu() document.getElementById(&quot;MinTrayR_context&quot;),</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  handleEvent: function(aEvent) {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    if (aEvent.type == &quot;TrayClick&quot; &amp;&amp; aEvent.button == 2) {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      this.menu.showPopup(document.documentElement,</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+                          aEvent.screenX, aEvent.screenY,</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+                          &quot;context&quot;, &quot;&quot;, &quot;bottomleft&quot;);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    }</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    else if (aEvent.type == &quot;TrayDblClick&quot; &amp;&amp; aEvent.button == 0)</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+      this.restore();</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  },</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  minimize: function MinTrayR_minimize() {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    this.trayService.minimize(window, true);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  },</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  restore: function MinTrayR_restore() {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    this.trayService.restore(window);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  }</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+};</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+window.addEventListener(&quot;load&quot;, gMinTrayR.load, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/im/components/mintrayr/content/mintrayr.xul</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,75 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+   -</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+   - the License. You may obtain a copy of the License at</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+   - http://www.mozilla.org/MPL/</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+   -</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+   - for the specific language governing rights and limitations under the</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+   - License.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+   -</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+   - The Original Code is MiniTrayR extension</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+   -</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+   - The Initial Developer of the Original Code is</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+   - Nils Maier.</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+   - Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+   - the Initial Developer. All Rights Reserved.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+   -</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+   - Contributor(s):</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+   -   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+   -   Florian Queze &lt;florian@instantbird.org&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+   -</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   - and other provisions required by the LGPL or the GPL. If you do not delete</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+   -</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+&lt;!DOCTYPE overlay [</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  &lt;!ENTITY % mintrayrDTD SYSTEM &quot;chrome://instantbird/locale/mintrayr.dtd&quot;&gt;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  %mintrayrDTD;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+]&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+&lt;overlay id=&quot;MinTrayR_overlay&quot;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+  &lt;script type=&quot;text/javascript&quot; src=&quot;chrome://instantbird/content/mintrayr.js&quot;/&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  &lt;keyset id=&quot;mainkeyset&quot;&gt;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+    &lt;key id=&quot;MinTrayR_minimize_key&quot;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+         modifiers=&quot;&amp;mintrayr.keys.minimize.modifiers;&quot;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+         keycode=&quot;&amp;mintrayr.keys.minimize.keycode;&quot;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+         oncommand=&quot;gMinTrayR.minimize();&quot;/&gt;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+  &lt;/keyset&gt;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+  &lt;menupopup id=&quot;fileMenuPopup&quot;&gt;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+    &lt;menuitem id=&quot;MinTrayR_minimize&quot;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+              label=&quot;&amp;mintrayr.minimize;&quot;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+              tooltiptext=&quot;&amp;mintrayr.minimize.tip;&quot;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+              oncommand=&quot;gMinTrayR.minimize();&quot;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+              key=&quot;MinTrayR_minimize_key&quot;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+              insertbefore=&quot;menu_FileQuitItem&quot;/&gt;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  &lt;/menupopup&gt;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  &lt;popupset id=&quot;mainpopupset&quot;&gt;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    &lt;menupopup id=&quot;MinTrayR_context&quot;&gt;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+      &lt;menuseparator id=&quot;MinTrayR_sep-top&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+      &lt;menuitem id=&quot;MinTrayR_restore&quot;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+                label=&quot;&amp;mintrayr.restore;&quot;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+                oncommand=&quot;gMinTrayR.restore();&quot;/&gt;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+      &lt;menuseparator id=&quot;MinTrayR_sep-bottom&quot;/&gt;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+    &lt;/menupopup&gt;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  &lt;/popupset&gt;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/im/components/mintrayr/jar.mn</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+instantbird.jar:</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+% content instantbird %instantbird/</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+	instantbird/mintrayr.js   (content/mintrayr.js)</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+	instantbird/mintrayr.xul  (content/mintrayr.xul)</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+% overlay chrome://instantbird/content/blist.xul chrome://instantbird/content/mintrayr.xul</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/im/components/mintrayr/resources.rc</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,75 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+// ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+// Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+//</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+// The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+// 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+// the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+// http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+//</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+// Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+// WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+// for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+// License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+//</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+// The Original Code is the TrayToolkit</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+//</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+// The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+// Nils Maier</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+// Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+// the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+//</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+// Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+//   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+//</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+// Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+// either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+// the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+// in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+// of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+// under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+// use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+// decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+// and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+// the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+// the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+//</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+// ***** END LICENSE BLOCK *****</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+#include&lt;winver.h&gt;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+/////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+//</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+// Version</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+//</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+1 VERSIONINFO</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+ FILEVERSION 0,8,0,0</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+ PRODUCTVERSION 0,8,0,0</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+ FILEFLAGSMASK 0x17L</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+#ifdef _DEBUG</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+ FILEFLAGS 0x1L</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+#else</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+ FILEFLAGS 0x0L</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+#endif</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+ FILEOS 0x4L</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+ FILETYPE 0x2L</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+ FILESUBTYPE 0x0L</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+BEGIN</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+    BLOCK &quot;StringFileInfo&quot;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+    BEGIN</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+        BLOCK &quot;000004b0&quot;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+        BEGIN</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+            VALUE &quot;FileDescription&quot;, &quot;TrayToolkit XPCOM Components&quot;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+            VALUE &quot;FileVersion&quot;, &quot;0, 9, 0, 0&quot;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+            VALUE &quot;InternalName&quot;, &quot;TrayToolkit&quot;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+            VALUE &quot;LegalCopyright&quot;, &quot;Copyright (C) 2008-2011 Nils Maier. MPL-Tri licensed&quot;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+            VALUE &quot;OriginalFilename&quot;, &quot;trayToolkit.dll&quot;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+            VALUE &quot;ProductName&quot;, &quot;MinTrayR Mozilla extension&quot;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+            VALUE &quot;ProductVersion&quot;, &quot;0, 9, 0, 0&quot;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+        END</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+    END</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    BLOCK &quot;VarFileInfo&quot;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    BEGIN</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+        VALUE &quot;Translation&quot;, 0x0, 1200</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+    END</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+END</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/im/components/mintrayr/trayIToolkit.idl</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,112 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * The Original Code is MinimizeToTray Revived components.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * The Initial Developer of the Original Code is Nils Maier</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ *</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ *   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ *</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ *</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+interface nsIDOMWindow;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+[scriptable, uuid(e17d921c-4b3a-47b2-8283-cab425cc1a0c)]</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+interface trayITrayIcon : nsISupports {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  /**</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+   * Associated DOM window</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+   */</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  [readonly] attribute nsIDOMWindow window;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    /**</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+     * Window is minimized to tray</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+     */</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    [readonly] attribute boolean isMinimized;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  /**</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+     * Indicates whether icon will be closed if window is restored</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+   */</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  attribute boolean closeOnRestore;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  /**</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+   * Minimizes the window</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+   */</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  void minimize();</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  /**</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+   * Restores the window</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+   */</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+  void restore();</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+  /**</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+   * Closes the tray icon, restoring the window in the process</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+   */</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  void close();</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+};</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+[scriptable, uuid(8fbd1a20-7abf-11dd-ad8b-0800200c9a66)]</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+interface trayITrayService : nsISupports {</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  /**</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+   * Creates a tray icon for window</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+   */</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  trayITrayIcon createIcon(in nsIDOMWindow window,  [optional] in boolean aCloseOnRestore);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  /**</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+   * Restores all windows from the tray</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+   */</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  void restoreAll();</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  /**</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+   * Watch a window, and if minimized send to tray</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+   */</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+  void watchMinimize(in nsIDOMWindow window);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  /**</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+   * unwatch a window again</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+   */</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  void unwatchMinimize(in nsIDOMWindow window);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  /**</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+   * is the window watched</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+   */</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  PRBool isWatchedWindow(in nsIDOMWindow window);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  /**</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+   * minimizes a window to the tray</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+   */</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+  void minimize(in nsIDOMWindow aWindow, [optional] in boolean aCloseOnRestore);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+  /**</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+   * Restores a window from the tray</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+   */</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+  void restore(in nsIDOMWindow aWindow);</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/im/components/mintrayr/trayModule.cpp</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,68 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ *</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+ *</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ * License.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+ *</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+ * The Original Code is TrayToolkit</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+ *</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+ * Nils Maier</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+ *</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+ *   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+ *</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+ *</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+#include &quot;mozilla/ModuleUtils.h&quot;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+#include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+#include &quot;trayToolkit.h&quot;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+// Need to import TrayServiceImpl from mintrayr so that the macro works</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+using mintrayr::TrayServiceImpl;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+// Generic factory</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(TrayServiceImpl)</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+NS_DEFINE_NAMED_CID(TRAYITRAYSERVICE_IID);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+static const mozilla::Module::CIDEntry kTrayIIDs[] = {</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    { &amp;kTRAYITRAYSERVICE_IID, true, 0, TrayServiceImplConstructor },</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    { 0 }</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+};</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+static const mozilla::Module::ContractIDEntry kTrayContracts[] = {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    { TRAYSERVICE_CONTRACTID, &amp;kTRAYITRAYSERVICE_IID },</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    { 0 }</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+};</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+static const mozilla::Module::CategoryEntry kTrayCategories[] = {</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+    { 0 }</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+};</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+static const mozilla::Module kTrayModule = {</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+    mozilla::Module::kVersion,</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    kTrayIIDs,</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+    kTrayContracts,</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+    kTrayCategories</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+};</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+NSMODULE_DEFN(trayModule) = &amp;kTrayModule;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/im/components/mintrayr/trayPlatform.h</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,98 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ *</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * License.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ *</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+ * The Original Code is TrayToolkit</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ *</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+ * Nils Maier</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+ *</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ *   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ *</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ *</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+/**</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ * Platform specific stuff</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+ * Must be implemented for each platform</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+ */</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+#ifndef __TRAYPLATFORM_H</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+#define __TRAYPLATFORM_H</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+#include &quot;xpcom-config.h&quot;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+#include &quot;nsStringAPI.h&quot;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+#include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+namespace mintrayr {</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+class TrayIconImpl;</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+namespace platform {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+/**</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+ * Called when the service goes live</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+ */</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+void Init();</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+/**</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+ * Called when the service is destroyed</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+ */</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+void Destroy();</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+/**</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+ * Window should be watched</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+ */</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+NS_IMETHODIMP WatchWindow(nsIDOMWindow *aWindow);</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+/**</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+ * Window should be unwatched</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+ */</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+NS_IMETHODIMP UnwatchWindow(nsIDOMWindow *aWindow);</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+/**</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+ * Abstract helper class</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+ * Encapsulates the platform specific initialization code and message processing</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+ */</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+class Icon {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+public:</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+  virtual ~Icon() {}</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+  virtual void Minimize() = 0;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  virtual void Restore() = 0;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+};</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+/**</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+ * Factory</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+ */</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+Icon* CreateIcon(TrayIconImpl *aOwner, nsIDOMWindow* aWindow, const nsString&amp; aTitle);</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+} // namespace platform</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+} // namespace mintrayr</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/im/components/mintrayr/trayPlatformGtk2.cpp</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,226 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+#include &quot;trayToolkit.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+#include &quot;trayPlatformGtk2.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+namespace mintrayr {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+namespace platform {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+#define XATOM(atom) static const Atom atom = XInternAtom(xev-&gt;xany.display, #atom, false)</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+/**</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ * Helper: Gdk filter function to &quot;watch&quot; the window</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ */</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+static</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+GdkFilterReturn filterWindows(XEvent *xev, GdkEvent* event, nsIDOMWindow* window)</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+{</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+  XATOM(WM_DELETE_WINDOW);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  if (!xev) {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+    return GDK_FILTER_CONTINUE;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  }</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+  switch (xev-&gt;type) {</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+    case MapNotify:</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+      {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+        nsCOMPtr&lt;trayITrayService&gt; traySvc(do_GetService(TRAYSERVICE_CONTRACTID));</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+        traySvc-&gt;Restore(window);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+      }</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+      break;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+    case UnmapNotify:</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+      if (DoMinimizeWindow(window, kTrayOnMinimize)) {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+        return GDK_FILTER_REMOVE;</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+      }</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+      break;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+    case ClientMessage:</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      if (xev-&gt;xclient.data.l</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+          &amp;&amp; static_cast&lt;Atom&gt;(xev-&gt;xclient.data.l[0]) == WM_DELETE_WINDOW</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+          &amp;&amp; DoMinimizeWindow(window, kTrayOnClose)</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+      ) {</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+        return GDK_FILTER_REMOVE;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+      }</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+      break;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+    default:</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+      break;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  }</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+  return GDK_FILTER_CONTINUE;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+}</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+void Init() {}</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+void Destroy() {}</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+Icon* CreateIcon(TrayIconImpl *aOwner, nsIDOMWindow* aWindow, const nsString&amp; aTitle)</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+{</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+  return new gtk2::Icon(aOwner, aWindow, aTitle);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+}</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+NS_IMETHODIMP WatchWindow(nsIDOMWindow *aWindow)</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+{</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  nsresult rv;</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+  rv = GetBaseWindow(aWindow, getter_AddRefs(baseWindow));</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  nativeWindow native = 0;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  rv = baseWindow-&gt;GetParentNativeWindow(&amp;native);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  GdkWindow *gdkWindow = gdk_window_get_toplevel(reinterpret_cast&lt;GdkWindow*&gt;(native));</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  if (!gdkWindow) {</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+  }</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+  gdk_window_add_filter(gdkWindow, reinterpret_cast&lt;GdkFilterFunc&gt;(filterWindows), aWindow);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+}</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+NS_IMETHODIMP UnwatchWindow(nsIDOMWindow *aWindow)</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+{</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  nsresult rv;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+  rv = GetBaseWindow(aWindow, getter_AddRefs(baseWindow));</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  nativeWindow native = 0;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+  rv = baseWindow-&gt;GetParentNativeWindow(&amp;native);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+  GdkWindow *gdkWindow = gdk_window_get_toplevel(reinterpret_cast&lt;GdkWindow*&gt;(native));</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+  if (!gdkWindow) {</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+  }</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  gdk_window_remove_filter(gdkWindow, reinterpret_cast&lt;GdkFilterFunc&gt;(filterWindows), aWindow);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+}</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+namespace gtk2 {</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+Icon::Icon(TrayIconImpl *aIcon, nsIDOMWindow *aWindow, const nsString&amp; aTitle)</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  : mStatusIcon(0), mGtkWindow(0), mGdkWindow(0), mIcon(aIcon)</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+{</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+  Init(aWindow, aTitle);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+}</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+NS_IMETHODIMP Icon::Init(nsIDOMWindow *aWindow, const nsString&amp; aTitle)</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+{</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+  nsresult rv;</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+  rv = GetBaseWindow(aWindow, getter_AddRefs(baseWindow));</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+  nativeWindow native = 0;</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+  rv = baseWindow-&gt;GetParentNativeWindow(&amp;native);</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  // Get the window</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+  mGdkWindow = gdk_window_get_toplevel(reinterpret_cast&lt;GdkWindow*&gt;(native));</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+  if (!mGdkWindow) {</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+  }</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+  // Get the widget and gtk window</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+  GtkWidget *widget;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+  gdk_window_get_user_data(mGdkWindow, reinterpret_cast&lt;gpointer*&gt;(&amp;widget));</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+  widget = gtk_widget_get_toplevel(widget);</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  mGtkWindow = reinterpret_cast&lt;GtkWindow*&gt;(widget);</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+  // Set up tray icon</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+  mStatusIcon = gtk_status_icon_new();</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  // Get the window icon and set it</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+  GdkPixbuf *buf = gtk_window_get_icon(mGtkWindow);</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+  if (buf) {</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+    gtk_status_icon_set_from_pixbuf(mStatusIcon, buf);</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+  }</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+  // Get and set the title</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+  if (aTitle.IsEmpty()) {</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+    gtk_status_icon_set_tooltip_text(mStatusIcon, gtk_window_get_title(mGtkWindow));</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+    gtk_widget_add_events(widget, GDK_PROPERTY_CHANGE_MASK);</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+    propertyEventId = g_signal_connect(mGtkWindow, &quot;property-notify-event&quot;, G_CALLBACK(gtkPropertyEvent), this);</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+  }</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+  else {</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+    NS_ConvertUTF16toUTF8 titleUTF8(aTitle);</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+    gtk_status_icon_set_tooltip_text(mStatusIcon, reinterpret_cast&lt;const char*&gt;(titleUTF8.get()));</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+    propertyEventId = 0;</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+  }</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+  // Add signals</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+  g_signal_connect(G_OBJECT(mStatusIcon), &quot;button-press-event&quot;, G_CALLBACK(gtkButtonEvent), this);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+  g_signal_connect(G_OBJECT(mStatusIcon), &quot;button-release-event&quot;, G_CALLBACK(gtkButtonEvent), this);</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+  // Make visible</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+  gtk_status_icon_set_visible(mStatusIcon, 1);</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+}</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+Icon::~Icon()</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+{</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+  Restore();</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+  if (mStatusIcon) {</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+    gtk_status_icon_set_visible(mStatusIcon, 0);</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+    g_object_unref(mStatusIcon);</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+  }</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+  if (propertyEventId) {</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+    g_signal_handler_disconnect(mGtkWindow, propertyEventId);</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+  }</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+}</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+void Icon::Restore()</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+{</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+  gdk_window_show(mGdkWindow);</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+}</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+void Icon::Minimize() {</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+  // Hide the window</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+  gdk_window_hide(mGdkWindow);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+}</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+void Icon::buttonEvent(GdkEventButton *event)</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+{</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+  nsString eventName;</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+  switch (event-&gt;type) {</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+    case GDK_BUTTON_RELEASE: // use release, so that we don't duplicate events</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+      eventName = NS_LITERAL_STRING(&quot;TrayClick&quot;);</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+      break;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+    case GDK_2BUTTON_PRESS:</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+      eventName = NS_LITERAL_STRING(&quot;TrayDblClick&quot;);</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+      break;</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+    case GDK_3BUTTON_PRESS:</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+      eventName = NS_LITERAL_STRING(&quot;TrayTriClick&quot;);</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+      break;</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+    default:</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+      return;</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+  }</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+  nsPoint pt((nscoord)(event-&gt;x + event-&gt;x_root), (nscoord)(event-&gt;y + event-&gt;y_root));</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+  // Dispatch the event</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+#define HASSTATE(x) (event-&gt;state &amp; x ? PR_TRUE : PR_FALSE)</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+  mIcon-&gt;DispatchMouseEvent(</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+      eventName,</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+      event-&gt;button - 1,</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+      pt,</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+      HASSTATE(GDK_CONTROL_MASK),</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+      HASSTATE(GDK_MOD1_MASK),</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+      HASSTATE(GDK_SHIFT_MASK)</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+      );</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+#undef HASSTATE</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+}</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+gboolean Icon::propertyEvent()</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+{</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+  gtk_status_icon_set_tooltip_text(mStatusIcon, gtk_window_get_title(mGtkWindow));</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+  return FALSE;</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+}</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+} // namespace gtk2</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+}} // namespaces</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/im/components/mintrayr/trayPlatformGtk2.h</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,93 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ *</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ *</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ * License.</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ *</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ * The Original Code is TrayToolkit</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+ *</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ * Nils Maier</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ *</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+ *   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ *</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ *</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+#ifndef __TRAYPLATFORMWIN_H</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+#define __TRAYPLATFORMWIN_H</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+#include &lt;X11/Xlib.h&gt;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+#include &lt;X11/Xatom.h&gt;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+#include &lt;X11/Xutil.h&gt;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+#include &lt;gtk/gtk.h&gt;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+#include &lt;gdk/gdk.h&gt;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+#include &quot;trayPlatform.h&quot;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+#include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+namespace mintrayr {</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+namespace platform {</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+namespace gtk2 {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+/**</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+ * Helper class</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+ * Encapsulates the Gtk2 specific initialization code and message processing</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+ */</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+class Icon : public platform::Icon {</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+private:</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+public:</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+  GtkStatusIcon *mStatusIcon;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  GtkWindow *mGtkWindow;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+  GdkWindow *mGdkWindow;</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+  TrayIconImpl *mIcon;</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  Icon(TrayIconImpl *aOwner, nsIDOMWindow* aWindow, const nsString&amp; aTitle);</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+  virtual ~Icon();</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+  virtual void Minimize();</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  virtual void Restore();</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+private:</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  NS_IMETHOD Init(nsIDOMWindow *aWindow, const nsString&amp; aTitle);</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+  void buttonEvent(GdkEventButton *event);</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  static void gtkButtonEvent(GtkStatusIcon*, GdkEventButton *event, Icon *icon) {</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+    icon-&gt;buttonEvent(event);</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+  }</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  gboolean propertyEvent();</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  gulong propertyEventId;</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  static gboolean gtkPropertyEvent(GtkStatusIcon*, GdkEventProperty *event, Icon *icon) {</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+    return icon-&gt;propertyEvent();</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  }</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+};</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+}}} // namespaces</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/im/components/mintrayr/trayPlatformWin.cpp</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,440 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+#include &quot;trayToolkit.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+#include &quot;trayPlatformWin.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+namespace mintrayr {</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+namespace platform {</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+static const wchar_t kTrayMessage[]  = L&quot;_MINTRAYR_TrayMessageW&quot;;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+static const wchar_t kDOMWindow[]  = L&quot;_MINTRAYR_DOM&quot;;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+static const wchar_t kOldProc[] = L&quot;_MINTRAYR_WRAPPER_OLD_PROC&quot;;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+static const wchar_t kWatch[] = L&quot;_MINTRAYR_WATCH&quot;;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+static const wchar_t kIcon[] = L&quot;_MINTRAYR_ICON&quot;;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+static const wchar_t kPlatformIcon[] = L&quot;_MINTRAYR_PICON&quot;;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+typedef BOOL (WINAPI *pChangeWindowMessageFilter)(UINT message, DWORD dwFlag);</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+#ifndef MGSFLT_ADD</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  // Not a Vista SDK</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+  #	define MSGFLT_ADD 1</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+  #	define MSGFLT_REMOVE 2</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+#endif</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+static UINT WM_TASKBARCREATED = 0;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+static UINT WM_TRAYMESSAGE = 0;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+/**</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ * Helper function that will allow us to receive some broadcast messages on Vista</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * (We need to bypass that filter if we run as Administrator, but the orginating process</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * has less priviledges)</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ */</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+static void AdjustMessageFilters(UINT filter)</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+{</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  HMODULE user32 = LoadLibraryW(L&quot;user32.dll&quot;);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  if (user32 != 0) {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+    pChangeWindowMessageFilter changeWindowMessageFilter =</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+      reinterpret_cast&lt;pChangeWindowMessageFilter&gt;(GetProcAddress(</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+        user32,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+        &quot;ChangeWindowMessageFilter&quot;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+      ));</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+    if (changeWindowMessageFilter != 0) {</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+      changeWindowMessageFilter(WM_TASKBARCREATED, filter);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    }</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+    FreeLibrary(user32);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  }</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+}</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+/**</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+ * Helper class to get Windows Version information</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+ */</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+class OSVersionInfo : public OSVERSIONINFOEXW</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+{</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+public:</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  OSVersionInfo() {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+    dwOSVersionInfoSize = sizeof(OSVERSIONINFOEXW);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+    ::GetVersionExW(reinterpret_cast&lt;LPOSVERSIONINFOW&gt;(this));</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  }</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  bool isVistaOrLater() {</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    return dwMajorVersion &gt;= 6;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  }</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+};</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+/**</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+ * Helper: We need to get the DOMWindow from the hwnd</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+ */</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+static bool DoMinimizeWindowWin(HWND hwnd, eMinimizeActions action)</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+{</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+  nsIDOMWindow *window = reinterpret_cast&lt;nsIDOMWindow*&gt;(::GetPropW(hwnd, kDOMWindow));</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  if (window == 0) {</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+    return false;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  }</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+  if (::GetPropW(hwnd, kWatch) == (HANDLE)0x2) {</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+    return true;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  }</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  return DoMinimizeWindow(window, action);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+}</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+/**</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+ * Helper: Subclassed Windows WNDPROC</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+ */</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+static LRESULT CALLBACK WndProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+{</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  using win::Icon;</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+  if (::GetPropW(hwnd, kWatch) &gt; (HANDLE)0x0) {</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    // Watcher stuff</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+    switch (uMsg) {</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+    case WM_WINDOWPOSCHANGING: {</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+      /* XXX Fix this bit to something more reasonable</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+         The following code kinda replicates the way mozilla gets the window state.</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+         We intensionally &quot;hide&quot; the SW_SHOWMINIMIZED here.</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+         This indeed might cause some side effects, but if it didn't we couldn't open</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+         menus due to bugzilla #435848,.</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+         This might defeat said bugfix completely reverting to old behavior, but only when we're active, of course.</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+         */</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+      WINDOWPOS *wp = reinterpret_cast&lt;WINDOWPOS*&gt;(lParam);</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+      if (wp == 0) {</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+        goto WndProcEnd;</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+      }</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+      if (wp-&gt;flags &amp; SWP_FRAMECHANGED &amp;&amp; ::IsWindowVisible(hwnd)) {</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+        WINDOWPLACEMENT pl;</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+        pl.length = sizeof(WINDOWPLACEMENT);</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+        ::GetWindowPlacement(hwnd, &amp;pl);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+        if (pl.showCmd == SW_SHOWMINIMIZED) {</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+          return 0;</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+        }</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+      }</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+      break;</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+    }</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+    case WM_WINDOWPOSCHANGED: {</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+      /* XXX Fix this bit to something more reasonable</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+         The following code kinda replicates the way mozilla gets the window state.</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+         We intensionally &quot;hide&quot; the SW_SHOWMINIMIZED here.</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+         This indeed might cause some side effects, but if it didn't we couldn't open</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+         menus due to bugzilla #435848,.</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+         This might defeat said bugfix completely reverting to old behavior, but only when we're active, of course.</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+      */</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+      WINDOWPOS *wp = reinterpret_cast&lt;WINDOWPOS*&gt;(lParam);</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+      if (wp == 0) {</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+        goto WndProcEnd;</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+      }</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+      if (wp-&gt;flags &amp; SWP_SHOWWINDOW) {</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+        // Shown again, unexpectedly that is, so release</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+        Icon *me = reinterpret_cast&lt;Icon*&gt;(GetPropW(hwnd, kPlatformIcon));</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+        if (me == 0 || me-&gt;mOwnerIcon == 0 || me-&gt;mOwnerIcon-&gt;IsClosed()) {</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+          goto WndProcEnd;</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+        }</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+        me-&gt;mOwnerIcon-&gt;Restore();</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+      }</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+      else if (wp-&gt;flags &amp; SWP_FRAMECHANGED &amp;&amp; ::IsWindowVisible(hwnd)) {</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+        WINDOWPLACEMENT pl;</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+        pl.length = sizeof(WINDOWPLACEMENT);</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+        ::GetWindowPlacement(hwnd, &amp;pl);</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+        if (pl.showCmd == SW_SHOWMINIMIZED) {</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+          if (DoMinimizeWindowWin(hwnd, kTrayOnMinimize)) {</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+            // We're active, ignore</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+            return 0;</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+          }</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+        }</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+      }</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+      break;</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+    } // case WM_WINDOWPOSCHANGED</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+    case WM_NCLBUTTONDOWN:</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+    case WM_NCLBUTTONUP:</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+      // Frame button clicked</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+      if (wParam == HTCLOSE &amp;&amp; DoMinimizeWindowWin(hwnd, kTrayOnClose)) {</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+        return TRUE;</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+      }</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+      break;</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+    case WM_SYSCOMMAND:</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+      // Window menu</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+      if (wParam == SC_CLOSE &amp;&amp; DoMinimizeWindowWin(hwnd, kTrayOnClose)) {</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+        return 0;</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+      }</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+      break;</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+    }</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+  }</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+  if (::GetPropW(hwnd, kIcon) == (HANDLE)0x1) {</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+    // Icon stuff</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+    // This is a badly documented custom broadcast message by explorer</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+    if (uMsg == WM_TASKBARCREATED) {</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+      // Try to get the platform icon</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+      Icon *me = reinterpret_cast&lt;Icon*&gt;(GetPropW(hwnd, kPlatformIcon));</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+      if (me == 0 || me-&gt;mOwnerIcon == 0 || me-&gt;mOwnerIcon-&gt;IsClosed()) {</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+        goto WndProcEnd;</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+      }</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+      // The taskbar was (re)created. Add ourselves again.</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+      Shell_NotifyIconW(NIM_ADD, &amp;me-&gt;mIconData);</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+    }</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+    // We got clicked. How exciting, isn't it.</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+    else if (uMsg == WM_TRAYMESSAGE) {</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+      nsString eventName;</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+      PRUint16 button = 0;</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+      switch (LOWORD(lParam)) {</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+        case WM_LBUTTONUP:</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+        case WM_MBUTTONUP:</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+        case WM_RBUTTONUP:</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+        case WM_CONTEXTMENU:</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+        case NIN_KEYSELECT:</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+          eventName = NS_LITERAL_STRING(&quot;TrayClick&quot;);</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+          break;</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+        case WM_LBUTTONDBLCLK:</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+        case WM_MBUTTONDBLCLK:</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+        case WM_RBUTTONDBLCLK:</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+          eventName = NS_LITERAL_STRING(&quot;TrayDblClick&quot;);</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+          break;</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+      }</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+      switch (LOWORD(lParam)) {</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+        case WM_LBUTTONUP:</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+        case WM_LBUTTONDBLCLK:</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+          button = 0;</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+          break;</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+        case WM_MBUTTONUP:</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+        case WM_MBUTTONDBLCLK:</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+          button = 1;</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+          break;</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+        case WM_RBUTTONUP:</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+        case WM_RBUTTONDBLCLK:</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+        case WM_CONTEXTMENU:</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+        case NIN_KEYSELECT:</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+          button = 2;</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+          break;</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+      }</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+      if (eventName.IsEmpty() == PR_FALSE) {</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+        POINT wpt;</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+        if (GetCursorPos(&amp;wpt) == TRUE) {</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+          nsPoint pt((nscoord)wpt.x, (nscoord)wpt.y);</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+          PRBool ctrlKey = (::GetKeyState(VK_CONTROL) &amp; 0x8000) != 0;</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+          PRBool altKey = (::GetKeyState(VK_MENU) &amp; 0x8000) != 0;</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+          PRBool shiftKey = (::GetKeyState(VK_SHIFT) &amp; 0x8000) != 0;</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+          // SFW/PM is a win32 hack, so that the context menu is hidden when loosing focus.</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+          ::SetForegroundWindow(hwnd);</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+          // Try to get the platform icon</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+          Icon *me = reinterpret_cast&lt;Icon*&gt;(GetPropW(hwnd, kPlatformIcon));</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+          if (me != 0 &amp;&amp; me-&gt;mOwnerIcon != 0 &amp;&amp; !me-&gt;mOwnerIcon-&gt;IsClosed()) {</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+            me-&gt;mOwnerIcon-&gt;DispatchMouseEvent(eventName, button, pt, ctrlKey, altKey, shiftKey);</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+          }</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+          ::PostMessage(hwnd, WM_NULL, 0, 0L);</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+        }</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+      }</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+      return 0;</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+    }</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+    // Window title changed</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+    else if (uMsg == WM_SETTEXT) {</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+      // Try to get the platform icons</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+      Icon *me = reinterpret_cast&lt;Icon*&gt;(GetPropW(hwnd, kPlatformIcon));</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+      if (me == 0 || me-&gt;mOwnerIcon == 0 || me-&gt;mOwnerIcon-&gt;IsClosed()) {</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+        goto WndProcEnd;</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+      }</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+      // First, let the original wndproc process this message,</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+      // so that we may query the thing afterwards ;)</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+      // this is required because we cannot know the encoding of this message for sure ;)</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+      LRESULT rv;</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+      WNDPROC oldWindowProc = reinterpret_cast&lt;WNDPROC&gt;(::GetPropW(hwnd, kOldProc));</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+      if (oldWindowProc != 0) {</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+        rv = CallWindowProcW(oldWindowProc, hwnd, uMsg, wParam, lParam);</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+      }</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+      else {</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+        rv = DefWindowProcW(hwnd, uMsg, wParam, lParam);</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+      }</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+      if (::GetWindowTextW(hwnd, me-&gt;mIconData.szTip, 128) != 0) {</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+        me-&gt;mIconData.szTip[128] = '\0';</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+        Shell_NotifyIconW(NIM_MODIFY, &amp;me-&gt;mIconData);</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+      }</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+      return rv;</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+    }</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+  }</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+WndProcEnd:</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+  // Call the old WNDPROC or at lest DefWindowProc</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+  WNDPROC oldProc = reinterpret_cast&lt;WNDPROC&gt;(::GetPropW(hwnd, kOldProc));</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+  if (oldProc != 0) {</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+    return ::CallWindowProcW(oldProc, hwnd, uMsg, wParam, lParam);</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+  }</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+  return ::DefWindowProcW(hwnd, uMsg, wParam, lParam);</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+}</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+static void SetupWnd(HWND hwnd, nsIDOMWindow *aWindow)</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+{</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+  if (::GetPropW(hwnd, kOldProc) == 0) {</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+    ::SetPropW(hwnd, kDOMWindow, reinterpret_cast&lt;HANDLE&gt;(aWindow));</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+    WNDPROC oldProc = reinterpret_cast&lt;WNDPROC&gt;(::SetWindowLongPtrW(hwnd, GWLP_WNDPROC, reinterpret_cast&lt;LONG_PTR&gt;(WndProc)));</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+    ::SetPropW(hwnd, kOldProc, reinterpret_cast&lt;HANDLE&gt;(oldProc));</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+  }</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+}</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+void Init()</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+{</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+  // Get TaskbarCreated</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+  WM_TASKBARCREATED = RegisterWindowMessageW(L&quot;TaskbarCreated&quot;);</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+  // We register this as well, as we cannot know which WM_USER values are already taken</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+  WM_TRAYMESSAGE = RegisterWindowMessageW(kTrayMessage);</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+  // Vista (Administrator) needs some love, or else we won't receive anything due to UIPI</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+  if (OSVersionInfo().isVistaOrLater()) {</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineplus">+    AdjustMessageFilters(MSGFLT_ADD);</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+  }</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+}</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+void Destroy() {</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+  // Vista (Administrator) needs some unlove, see c'tor</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineplus">+  if (OSVersionInfo().isVistaOrLater()) {</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+    AdjustMessageFilters(MSGFLT_REMOVE);</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+  }</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+}</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+Icon* CreateIcon(TrayIconImpl *aOwner, nsIDOMWindow* aWindow, const nsString&amp; aTitle)</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+{</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+  return new win::Icon(aOwner, aWindow, aTitle);</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+}</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+NS_IMETHODIMP WatchWindow(nsIDOMWindow *aWindow)</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+{</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+  rv = GetBaseWindow(aWindow, getter_AddRefs(baseWindow));</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineplus">+</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineplus">+  nativeWindow native = 0;</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineplus">+  rv = baseWindow-&gt;GetParentNativeWindow(&amp;native);</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+  HWND hwnd = reinterpret_cast&lt;HWND&gt;(native);</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineplus">+  SetupWnd(hwnd, aWindow);</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+  ::SetPropW(hwnd, kWatch, reinterpret_cast&lt;HANDLE&gt;(0x1));</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+}</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+NS_IMETHODIMP UnwatchWindow(nsIDOMWindow *aWindow)</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+{</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+  rv = GetBaseWindow(aWindow, getter_AddRefs(baseWindow));</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+  nativeWindow native = 0;</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+  rv = baseWindow-&gt;GetParentNativeWindow(&amp;native);</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineplus">+  HWND hwnd = reinterpret_cast&lt;HWND&gt;(native);</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+  ::RemovePropW(hwnd, kWatch);</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+}</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+namespace win {</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+Icon::Icon(TrayIconImpl *aIcon, nsIDOMWindow *aWindow, const nsString&amp; aTitle)</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+  : mOwnerIcon(aIcon)</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+{</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+  Init(aWindow, aTitle);</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+}</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+NS_IMETHODIMP Icon::Init(nsIDOMWindow *aWindow, const nsString&amp; aTitle)</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineplus">+{</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+  rv = GetBaseWindow(aWindow, getter_AddRefs(baseWindow));</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+  nativeWindow native = 0;</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+  rv = baseWindow-&gt;GetParentNativeWindow(&amp;native);</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+  mWnd = reinterpret_cast&lt;HWND&gt;(native);</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+  SetupWnd(mWnd, aWindow);</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+  // Hook window</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+  ::SetPropW(mWnd, kIcon, reinterpret_cast&lt;HANDLE&gt;(0x1));</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+  // Init the icon data according to MSDN</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+  ZeroMemory(&amp;mIconData, sizeof(mIconData));</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+  mIconData.cbSize = sizeof(mIconData);</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+  // Copy the title</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+  lstrcpynW(mIconData.szTip, aTitle.get(), 127);</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+  mIconData.szTip[128] = '\0'; // Better be safe than sorry :p</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineplus">+</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineplus">+  // Get the window icon</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+  HICON icon = reinterpret_cast&lt;HICON&gt;(::SendMessageW(mWnd, WM_GETICON, ICON_SMALL, 0));</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineplus">+  if (icon == 0) {</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+    // Alternative method. Get from the window class</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+    icon = reinterpret_cast&lt;HICON&gt;(::GetClassLongPtrW(mWnd, GCLP_HICONSM));</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+  }</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineplus">+  // Alternative method: get the first icon from the main module (executable image of the process)</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineplus">+  if (icon == 0) {</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+    icon = ::LoadIcon(GetModuleHandleW(0), MAKEINTRESOURCE(0));</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+  }</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+  // Alternative method. Use OS default icon</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+  if (icon == 0) {</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+    icon = ::LoadIcon(0, IDI_APPLICATION);</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+  }</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineplus">+  mIconData.hIcon = icon;</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+  // Set the rest of the members</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+  mIconData.hWnd = mWnd;</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+  mIconData.uCallbackMessage = WM_TRAYMESSAGE;</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+  mIconData.uFlags = NIF_ICON | NIF_MESSAGE | NIF_TIP;</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+  mIconData.uVersion = 5;</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+  // Install the icon</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+  ::Shell_NotifyIconW(NIM_ADD, &amp;mIconData);</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+  ::Shell_NotifyIconW(NIM_SETVERSION, &amp;mIconData);</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+  ::SetPropW(mWnd, kIcon, reinterpret_cast&lt;HANDLE&gt;(0x1));</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+  ::SetPropW(mWnd, kPlatformIcon, reinterpret_cast&lt;HANDLE&gt;(this));</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineplus">+}</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineplus">+</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+Icon::~Icon()</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+{</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+  Restore();</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+  // Disable message handling</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+  ::RemovePropW(mWnd, kIcon);</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+  // Remove the icon</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+  ::Shell_NotifyIconW(NIM_DELETE, &amp;mIconData);</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+  mOwnerIcon = 0;</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+}</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineplus">+void Icon::Restore()</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+{</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+  // Show the window again</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineplus">+  ::ShowWindow(mWnd, SW_SHOW);</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineplus">+  // If it was minimized then restore it as well</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineplus">+  if (::IsIconic(mWnd)) {</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineplus">+    ::ShowWindow(mWnd, SW_RESTORE);</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineplus">+    // Try to grab focus</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineplus">+    ::SetForegroundWindow(mWnd);</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineplus">+  }</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineplus">+}</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineplus">+void Icon::Minimize() {</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineplus">+  // We need to get a minimize through.</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+  // Otherwise the SFW/PM hack won't work</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineplus">+  // However we need to protect against the watcher watching this</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineplus">+  HANDLE watch = ::GetPropW(mWnd, kWatch);</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineplus">+  ::SetPropW(mWnd, kWatch, (HANDLE)(0x2));</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+  ::ShowWindow(mWnd, SW_MINIMIZE);</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+  ::SetPropW(mWnd, kWatch, watch);</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+  ::ShowWindow(mWnd, SW_HIDE);</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineplus">+}</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineplus">+</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+} // namespace win</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineplus">+</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineplus">+}} // namespaces</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/im/components/mintrayr/trayPlatformWin.h</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,84 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+ *</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ * License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ *</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+ * The Original Code is TrayToolkit</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+ *</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+ * Nils Maier</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ *   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ *</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ *</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+#ifndef __TRAYPLATFORMWIN_H</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+#define __TRAYPLATFORMWIN_H</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+/**</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+ * Windows specific implementation</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+ */</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+#ifdef _WIN32_IE</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+#	undef _WIN32_IE</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+#endif</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+#define _WIN32_IE 0x0600 // We want more features</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+#include &lt;windows.h&gt;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+#include &lt;shellapi.h&gt;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+#include &quot;trayPlatform.h&quot;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+#include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+namespace mintrayr {</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+namespace platform {</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+namespace win {</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+/**</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+ * Helper class</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+ * Encapsulates the Windows specific initialization code and message processing</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+ */</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+class Icon : public platform::Icon {</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+private:</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+public:</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  HWND mWnd;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  NOTIFYICONDATAW mIconData;</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  TrayIconImpl *mOwnerIcon;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  Icon(TrayIconImpl *aOwner, nsIDOMWindow* aWindow, const nsString&amp; aTitle);</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  virtual ~Icon();</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  virtual void Minimize();</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  virtual void Restore();</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+private:</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  NS_IMETHOD Init(nsIDOMWindow *aWindow, const nsString&amp; aTitle);</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+};</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+}}} // namespaces</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/im/components/mintrayr/trayToolkit.cpp</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,498 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ *</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+ *</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ * License.</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ *</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * The Original Code is TrayToolkit</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ *</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+ * Nils Maier</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+ *</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+ *   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+ *</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ *</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+#include &quot;trayToolkit.h&quot;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+#include &quot;trayPlatform.h&quot;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+#include &quot;nsStringAPI.h&quot;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+#include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+#include &quot;nsIDOMDocument.h&quot;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+#include &quot;nsIDOMDocumentView.h&quot;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+#include &quot;nsIDOMAbstractView.h&quot;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+#include &quot;nsIDOMDocumentEvent.h&quot;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+#include &quot;nsIDOMEvent.h&quot;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+#include &quot;nsIDOMEventTarget.h&quot;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+#include &quot;nsIPrivateDOMEvent.h&quot;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+#include &quot;nsIDOMMouseEvent.h&quot;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+#include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+#include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+#include &quot;nsIObserverService.h&quot;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+#include &quot;nsIPrefService.h&quot;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+#include &quot;nsIPrefBranch2.h&quot;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+#ifdef WIN32</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+#define strcasecmp stricmp</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+#endif</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+namespace mintrayr {</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+bool DoMinimizeWindow(nsIDOMWindow *window, eMinimizeActions action)</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+{</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  if (window == 0) {</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+    return false;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  }</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch2&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+  if (prefs) {</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+    PRInt32 whenToMinimize = 0;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+    prefs-&gt;GetIntPref(&quot;extensions.mintrayr.minimizeon&quot;, &amp;whenToMinimize);</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+    if ((whenToMinimize &amp; action) == 0) {</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+      return false;</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+    }</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+  }</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+  nsCOMPtr&lt;trayITrayService&gt; traySvc(do_GetService(TRAYSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+    traySvc-&gt;Minimize(window, PR_TRUE);</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+  }</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  return NS_SUCCEEDED(rv);</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+}</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+/**</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+ * Helper: Get the base window for a DOM window</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+ */</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+NS_IMETHODIMP GetBaseWindow(nsIDOMWindow *aWindow, nsIBaseWindow **aBaseWindow)</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+{</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aBaseWindow);</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+  nsCOMPtr&lt;nsIWebNavigation&gt; webNav = do_GetInterface(aWindow, &amp;rv);</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow = do_QueryInterface(webNav, &amp;rv);</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+  *aBaseWindow = baseWindow;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+  NS_IF_ADDREF(*aBaseWindow);</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+}</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+/**</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+ * Helper: Dispatch a trusted general event</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+ */</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+NS_IMETHODIMP DispatchTrustedEvent(nsIDOMWindow *aWindow, const nsAString&amp; aEventName)</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+{</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+  nsCOMPtr&lt;nsIDOMDocument&gt; domDocument;</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  rv = aWindow-&gt;GetDocument(getter_AddRefs(domDocument));</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+  nsCOMPtr&lt;nsIDOMDocumentEvent&gt; docEvent(do_QueryInterface(domDocument));</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  nsCOMPtr&lt;nsIDOMEventTarget&gt; target(do_QueryInterface(domDocument));</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+  NS_ENSURE_TRUE(docEvent &amp;&amp; target, NS_ERROR_INVALID_ARG);</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+  nsCOMPtr&lt;nsIDOMEvent&gt; event;</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+  rv = docEvent-&gt;CreateEvent(NS_LITERAL_STRING(&quot;Events&quot;), getter_AddRefs(event));</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+  nsCOMPtr&lt;nsIPrivateDOMEvent&gt; privateEvent(do_QueryInterface(event, &amp;rv));</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+  rv = event-&gt;InitEvent(aEventName, PR_FALSE, PR_TRUE);</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+  rv = privateEvent-&gt;SetTrusted(PR_TRUE);</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+  PRBool dummy;</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+  return target-&gt;DispatchEvent(event, &amp;dummy);</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+}</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+/* TrayIconImpl */</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+NS_IMPL_ISUPPORTS2(TrayIconImpl, trayITrayIcon, nsIDOMEventListener)</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::GetWindow(nsIDOMWindow **aWindow)</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+{</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+  *aWindow = mWindow;</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+  NS_ADDREF(*aWindow);</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+}</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::SetWindow(nsIDOMWindow *) {</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+}</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::GetIsMinimized(PRBool *aIsMinimized)</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+{</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aIsMinimized);</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+  *aIsMinimized = mIsMinimized;</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+}</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::SetIsMinimized(PRBool)</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+{</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+}</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::GetCloseOnRestore(PRBool *aCloseOnRestore)</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+{</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCloseOnRestore);</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+  *aCloseOnRestore = mCloseOnRestore;</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+}</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::SetCloseOnRestore(PRBool aCloseOnRestore)</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+{</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+  mCloseOnRestore = aCloseOnRestore;</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+}</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::Minimize()</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+{</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+  if (mClosed) {</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+  }</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineplus">+  if (mIsMinimized) {</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+    // Already minimized</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+  }</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+  mPlatformIcon-&gt;Minimize();</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+  mIsMinimized = PR_TRUE;</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+}</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::Restore()</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+{</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+  if (mClosed) {</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineplus">+  }</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineplus">+  if (!mIsMinimized) {</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+    // Not minimized</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+  }</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+  if (mCloseOnRestore) {</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+    Close();</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineplus">+  }</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+  else {</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineplus">+    mPlatformIcon-&gt;Restore();</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineplus">+  }</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineplus">+  mIsMinimized = PR_FALSE;</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineplus">+</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineplus">+}</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::Close()</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineplus">+{</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineplus">+  if (mClosed) {</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+  }</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+  mClosed = true;</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineplus">+  delete mPlatformIcon.forget();</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineplus">+  mService-&gt;CloseIcon(this);</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+  mIsMinimized = PR_FALSE;</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+  nsCOMPtr&lt;nsIDOMEventTarget&gt; target = do_QueryInterface(mWindow, &amp;rv);</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineplus">+  target-&gt;RemoveEventListener(NS_LITERAL_STRING(&quot;unload&quot;), this, PR_FALSE);</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+}</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::HandleEvent(nsIDOMEvent *aEvent)</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+{</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aEvent);</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+  Close();</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+}</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineplus">+</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::Init(nsIDOMWindow *aWindow, PRBool aCloseOnRestore)</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+{</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineplus">+</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineplus">+</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineplus">+  mCloseOnRestore = aCloseOnRestore;</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineplus">+</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineplus">+  nsCOMPtr&lt;nsIDOMEventTarget&gt; target = do_QueryInterface(aWindow, &amp;rv);</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineplus">+  rv = target-&gt;AddEventListener(NS_LITERAL_STRING(&quot;unload&quot;), this, PR_FALSE);</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineplus">+  rv = GetBaseWindow(aWindow, getter_AddRefs(baseWindow));</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+  nativeWindow native = 0;</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+  rv = baseWindow-&gt;GetParentNativeWindow(&amp;native);</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+  nsString title;</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineplus">+  baseWindow-&gt;GetTitle(getter_Copies(title));</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineplus">+  mPlatformIcon = platform::CreateIcon(this, aWindow, title);</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+  mWindow = aWindow;</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+}</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineplus">+</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+NS_IMETHODIMP TrayIconImpl::DispatchMouseEvent(const nsAString&amp; aEventName, PRUint16 aButton, nsPoint&amp; pt, PRBool aCtrlKey, PRBool aAltKey, PRBool aShiftKey)</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineplus">+{</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+  nsCOMPtr&lt;nsIDOMDocument&gt; domDocument;</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineplus">+  rv = mWindow-&gt;GetDocument(getter_AddRefs(domDocument));</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+  nsCOMPtr&lt;nsIDOMDocumentEvent&gt; docEvent(do_QueryInterface(domDocument));</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineplus">+  nsCOMPtr&lt;nsIDOMEventTarget&gt; target(do_QueryInterface(domDocument));</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+  NS_ENSURE_TRUE(docEvent &amp;&amp; target, NS_ERROR_INVALID_ARG);</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineplus">+</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineplus">+  nsCOMPtr&lt;nsIDOMDocumentView&gt; docView(do_QueryInterface(domDocument, &amp;rv));</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineplus">+</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineplus">+  nsCOMPtr&lt;nsIDOMAbstractView&gt; abstractView;</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineplus">+  rv = docView-&gt;GetDefaultView(getter_AddRefs(abstractView));</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineplus">+</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineplus">+  nsCOMPtr&lt;nsIDOMEvent&gt; event;</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineplus">+  rv = docEvent-&gt;CreateEvent(NS_LITERAL_STRING(&quot;MouseEvents&quot;), getter_AddRefs(event));</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineplus">+</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineplus">+  nsCOMPtr&lt;nsIDOMMouseEvent&gt; mouseEvent(do_QueryInterface(event, &amp;rv));</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineplus">+  rv = mouseEvent-&gt;InitMouseEvent(</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineplus">+    aEventName,</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineplus">+    PR_FALSE,</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineplus">+    PR_TRUE,</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineplus">+    abstractView,</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+    0,</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+    pt.x,</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+    pt.y,</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+    0,</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+    0,</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineplus">+    aCtrlKey,</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineplus">+    aAltKey,</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineplus">+    aShiftKey,</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineplus">+    PR_FALSE,</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineplus">+    aButton,</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+    target</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+    );</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineplus">+</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineplus">+  PRBool dummy;</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineplus">+  return target-&gt;DispatchEvent(mouseEvent, &amp;dummy);</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineplus">+}</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineplus">+</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineplus">+/* TrayServiceImpl */</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineplus">+</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineplus">+NS_IMPL_ISUPPORTS2(TrayServiceImpl, trayITrayService, nsIObserver)</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineplus">+</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineplus">+TrayServiceImpl::TrayServiceImpl()</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+{</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineplus">+  platform::Init();</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineplus">+</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineplus">+  // Observe when the app is going down.</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineplus">+  // Else we might not properly clean up</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineplus">+  // And leave some tray icons behind</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+  nsCOMPtr&lt;nsIObserverService&gt; obs(do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv));</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineplus">+    obs-&gt;AddObserver(static_cast&lt;nsIObserver*&gt;(this), &quot;xpcom-shutdown&quot;, PR_FALSE);</span>
<a href="#l15.342"></a><span id="l15.342" class="difflineplus">+  }</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineplus">+</span>
<a href="#l15.344"></a><span id="l15.344" class="difflineplus">+}</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineplus">+TrayServiceImpl::~TrayServiceImpl()</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineplus">+{</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineplus">+  Destroy();</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineplus">+  platform::Destroy();</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineplus">+}</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineplus">+void TrayServiceImpl::Destroy() {</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineplus">+  UnwatchAll();</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineplus">+  RestoreAll();</span>
<a href="#l15.353"></a><span id="l15.353" class="difflineplus">+</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineplus">+  // Better be safe :p</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineplus">+  mIcons.Clear();</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineplus">+  mWatches.Clear();</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineplus">+}</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineplus">+</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineplus">+NS_IMETHODIMP TrayServiceImpl::CreateIcon(nsIDOMWindow *aWindow, PRBool aCloseOnRestore, trayITrayIcon **aResult)</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineplus">+{</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineplus">+  const PRInt32 count = mIcons.Count();</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineplus">+</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineplus">+  for (PRInt32 i = 0; i &lt; count; ++i) {</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineplus">+    nsCOMPtr&lt;nsIDOMWindow&gt; domWindow;</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineplus">+    rv = mIcons[i]-&gt;GetWindow(getter_AddRefs(domWindow));</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineplus">+      continue;</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineplus">+    }</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineplus">+    if (domWindow != aWindow) {</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineplus">+      continue;</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineplus">+    }</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineplus">+    *aResult = mIcons[i];</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineplus">+    NS_ADDREF(*aResult);</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineplus">+  }</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineplus">+</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineplus">+  TrayIconImpl *icon = new TrayIconImpl(this);</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineplus">+  rv = icon-&gt;Init(aWindow, aCloseOnRestore);</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+    delete icon;</span>
<a href="#l15.384"></a><span id="l15.384" class="difflineplus">+  }</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineplus">+  else {</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineplus">+    mIcons.AppendObject(icon);</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+    if (aResult) {</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineplus">+      *aResult = icon;</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+      NS_ADDREF(*aResult);</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineplus">+    }</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineplus">+  }</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineplus">+  return rv;</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineplus">+}</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineplus">+</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineplus">+NS_IMETHODIMP TrayServiceImpl::RestoreAll()</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineplus">+{</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineplus">+  const PRInt32 count = mIcons.Count();</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineplus">+  for (PRInt32 i = count - 1; i &gt; -1; --i) {</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineplus">+    mIcons[i]-&gt;Restore();</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineplus">+  }</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineplus">+}</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineplus">+NS_IMETHODIMP TrayServiceImpl::WatchMinimize(nsIDOMWindow *aWindow)</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+{</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.407"></a><span id="l15.407" class="difflineplus">+</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineplus">+  const PRInt32 index = mWatches.IndexOf(aWindow);</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineplus">+  if (index != -1) {</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineplus">+  }</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineplus">+</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineplus">+  if (!NS_SUCCEEDED(platform::WatchWindow(aWindow))) {</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineplus">+  }</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+  mWatches.AppendObject(aWindow);</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.418"></a><span id="l15.418" class="difflineplus">+}</span>
<a href="#l15.419"></a><span id="l15.419" class="difflineplus">+</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineplus">+NS_IMETHODIMP TrayServiceImpl::UnwatchMinimize(nsIDOMWindow *aWindow)</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineplus">+{</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineplus">+</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineplus">+  if (NS_SUCCEEDED(platform::UnwatchWindow(aWindow))) {</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineplus">+  }</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineplus">+  mWatches.RemoveObject(aWindow);</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineplus">+}</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineplus">+</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineplus">+NS_IMETHODIMP TrayServiceImpl::Minimize(nsIDOMWindow *aWindow, PRBool aCloseOnRestore)</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineplus">+{</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.434"></a><span id="l15.434" class="difflineplus">+</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.436"></a><span id="l15.436" class="difflineplus">+</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineplus">+  nsCOMPtr&lt;trayITrayIcon&gt; icon;</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineplus">+  rv = CreateIcon(aWindow, aCloseOnRestore, getter_AddRefs(icon));</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineplus">+</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineplus">+  rv = icon-&gt;Minimize();</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineplus">+  return rv;</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineplus">+}</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineplus">+</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineplus">+NS_IMETHODIMP TrayServiceImpl::Restore(nsIDOMWindow *aWindow)</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineplus">+{</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineplus">+</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineplus">+  const PRInt32 count = mIcons.Count();</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineplus">+</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineplus">+  for (PRInt32 i = 0; i &lt; count; ++i) {</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineplus">+    nsCOMPtr&lt;nsIDOMWindow&gt; domWindow;</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineplus">+    rv = mIcons[i]-&gt;GetWindow(getter_AddRefs(domWindow));</span>
<a href="#l15.455"></a><span id="l15.455" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l15.456"></a><span id="l15.456" class="difflineplus">+      continue;</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineplus">+    }</span>
<a href="#l15.458"></a><span id="l15.458" class="difflineplus">+    if (domWindow != aWindow) {</span>
<a href="#l15.459"></a><span id="l15.459" class="difflineplus">+      continue;</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineplus">+    }</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineplus">+    return mIcons[i]-&gt;Restore();</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineplus">+  }</span>
<a href="#l15.463"></a><span id="l15.463" class="difflineplus">+  return NS_ERROR_INVALID_ARG;</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineplus">+}</span>
<a href="#l15.465"></a><span id="l15.465" class="difflineplus">+</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineplus">+NS_IMETHODIMP TrayServiceImpl::IsWatchedWindow(nsIDOMWindow *aWindow, PRBool *aResult)</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineplus">+{</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l15.469"></a><span id="l15.469" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineplus">+</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineplus">+  *aResult = mWatches.IndexOfObject(aWindow) != -1 ? PR_TRUE : PR_FALSE;</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineplus">+}</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineplus">+</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineplus">+void TrayServiceImpl::UnwatchAll() {</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineplus">+  const PRInt32 count = mWatches.Count();</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineplus">+  for (PRInt32 i = 0; i &lt; count; ++i) {</span>
<a href="#l15.478"></a><span id="l15.478" class="difflineplus">+    platform::UnwatchWindow(mWatches[i]);</span>
<a href="#l15.479"></a><span id="l15.479" class="difflineplus">+  }</span>
<a href="#l15.480"></a><span id="l15.480" class="difflineplus">+  mWatches.Clear();</span>
<a href="#l15.481"></a><span id="l15.481" class="difflineplus">+}</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineplus">+</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineplus">+void TrayServiceImpl::CloseIcon(trayITrayIcon *aIcon)</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineplus">+{</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineplus">+  mIcons.RemoveObject(aIcon);</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineplus">+}</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineplus">+</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineplus">+NS_IMETHODIMP TrayServiceImpl::Observe(nsISupports *, const char *aTopic, const PRUnichar *)</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineplus">+{</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineplus">+  if (strcasecmp(aTopic, &quot;xpcom-shutdown&quot;) == 0) {</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineplus">+    Destroy();</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineplus">+</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineplus">+    nsresult rv;</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; obs(do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv));</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.496"></a><span id="l15.496" class="difflineplus">+      obs-&gt;RemoveObserver(static_cast&lt;nsIObserver*&gt;(this), &quot;xpcom-shutdown&quot;);</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineplus">+    }</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineplus">+  }</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineplus">+}</span>
<a href="#l15.501"></a><span id="l15.501" class="difflineplus">+</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineplus">+} // namespace mintrayr</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/im/components/mintrayr/trayToolkit.h</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,155 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ *</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ *</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ * License.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+ *</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+ * The Original Code is TrayToolkit</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+ *</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+ * Nils Maier</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+ *</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+ *   Nils Maier &lt;MaierMan@web.de&gt;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+ *</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+ *</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+#ifndef __TRAYTOOLKIT_IMPL_H</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+#define __TRAYTOOLKIT_IMPL_H</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+#include &quot;xpcom-config.h&quot;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+#include &quot;nsPoint.h&quot;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+#include &quot;nsIDOMEventListener.h&quot;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+#include &quot;nsIBaseWindow.h&quot;</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+#include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+#include &quot;trayIToolkit.h&quot;</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+#include &quot;nsXPCOMStrings.h&quot;</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+#include &quot;nsIObserver.h&quot;</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+#define TRAYSERVICE_CONTRACTID &quot;@tn123.ath.cx/trayservice;1&quot;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+#define TRAYSERVICE_CLASSNAME  &quot;TrayServiceImpl&quot;</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+namespace mintrayr {</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+/**</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+ * Minimize on what actions</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+ */</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+typedef enum _eMinimizeActions {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+  kTrayOnMinimize = (1 &lt;&lt; 0),</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+  kTrayOnClose = (1 &lt;&lt; 1)</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+} eMinimizeActions;</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+/**</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+ * Need this to hold a pointer to</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+ * The implementation will be platform specific</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+ */</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+namespace platform {</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  class Icon;</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+}</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+/**</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+ * Helper for watch: Minimize a window if a configured for the action</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+ */</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+bool DoMinimizeWindow(nsIDOMWindow *window, eMinimizeActions action);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+/**</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+ * Helper: Gets the base window</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+ */</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+NS_IMETHODIMP GetBaseWindow(nsIDOMWindow *aWindow, nsIBaseWindow **aBaseWindow);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+/**</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+ * Helper: Dispatches a trusted event (i.e. chrome only)</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+ */</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+NS_IMETHODIMP DispatchTrustedEvent(nsIDOMWindow *aWindow, const nsAString&amp; aEventName);</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+class TrayServiceImpl;</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+/**</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+ * The implementation for trayITrayIcon</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+ */</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+class TrayIconImpl : public trayITrayIcon, nsIDOMEventListener {</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+  friend class platform::Icon;</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+private:</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  PRBool mIsMinimized;</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+  nsCOMPtr&lt;nsIDOMWindow&gt; mWindow;</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+  PRBool mCloseOnRestore;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+  bool mClosed;</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+  TrayServiceImpl *mService;</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+  nsAutoPtr&lt;platform::Icon&gt; mPlatformIcon;</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+public:</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+  NS_DECL_NSIDOMEVENTLISTENER</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+  NS_DECL_TRAYITRAYICON</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  TrayIconImpl(TrayServiceImpl *aService)</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+    : mIsMinimized(PR_FALSE),</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+    mCloseOnRestore(PR_FALSE),</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+    mClosed(false),</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+    mService(aService)</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+    {}</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+  NS_IMETHOD Init(nsIDOMWindow *aWindow, PRBool aCloseOnRestore);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+  NS_IMETHOD DispatchMouseEvent(const nsAString&amp; aEventName, PRUint16 aButton, nsPoint&amp; pt, PRBool aCtrlKey, PRBool aAltKey, PRBool aShiftKey);</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+  inline bool IsClosed() const { return mClosed; }</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+};</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+/**</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+ * The implementation for trayITrayService</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+ */</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+class TrayServiceImpl : public trayITrayService, nsIObserver {</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+  friend class TrayIconImpl;</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+public:</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  NS_DECL_NSIOBSERVER</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+  NS_DECL_TRAYITRAYSERVICE</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+  TrayServiceImpl();</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+private:</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+  nsCOMArray&lt;trayITrayIcon&gt; mIcons;</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+  nsCOMArray&lt;nsIDOMWindow&gt; mWatches;</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+private:</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+  ~TrayServiceImpl();</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+  void Destroy();</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+  void UnwatchAll();</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+  void CloseIcon(trayITrayIcon *aIcon);</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+};</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+} // namespace</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/im/content/preferences/main.xul</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/im/content/preferences/main.xul</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -55,16 +55,18 @@</span>
<a href="#l17.4"></a><span id="l17.4">     &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://instantbird/content/preferences/main.js&quot;/&gt;</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6">     &lt;preferences id=&quot;mainPreferences&quot;&gt;</span>
<a href="#l17.7"></a><span id="l17.7">       &lt;preference id=&quot;messenger.startup.action&quot;     name=&quot;messenger.startup.action&quot;     type=&quot;int&quot;/&gt;</span>
<a href="#l17.8"></a><span id="l17.8">       &lt;preference id=&quot;messenger.options.playSounds&quot; name=&quot;messenger.options.playSounds&quot; type=&quot;bool&quot;/&gt;</span>
<a href="#l17.9"></a><span id="l17.9">       &lt;preference id=&quot;messenger.options.getAttentionOnNewMessages&quot; name=&quot;messenger.options.getAttentionOnNewMessages&quot; type=&quot;bool&quot;/&gt;</span>
<a href="#l17.10"></a><span id="l17.10"> #ifdef XP_MACOSX</span>
<a href="#l17.11"></a><span id="l17.11">       &lt;preference id=&quot;messenger.options.showUnreadCountInDock&quot; name=&quot;messenger.options.showUnreadCountInDock&quot; type=&quot;bool&quot;/&gt;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+#else</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+      &lt;preference id=&quot;extensions.mintrayr.minimizeon&quot; name=&quot;extensions.mintrayr.minimizeon&quot; type=&quot;int&quot;/&gt;</span>
<a href="#l17.14"></a><span id="l17.14"> #endif</span>
<a href="#l17.15"></a><span id="l17.15">       &lt;preference id=&quot;messenger.options.notifyOfNewMessages&quot; name=&quot;messenger.options.notifyOfNewMessages&quot; type=&quot;bool&quot;/&gt;</span>
<a href="#l17.16"></a><span id="l17.16">     &lt;/preferences&gt;</span>
<a href="#l17.17"></a><span id="l17.17">     </span>
<a href="#l17.18"></a><span id="l17.18">     &lt;!-- Startup --&gt;</span>
<a href="#l17.19"></a><span id="l17.19">     &lt;groupbox id=&quot;startupGroup&quot;&gt;</span>
<a href="#l17.20"></a><span id="l17.20">       &lt;caption label=&quot;&amp;startup.label;&quot;/&gt;</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -120,16 +122,36 @@</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">     &lt;groupbox id=&quot;soundsGroup&quot;&gt;</span>
<a href="#l17.25"></a><span id="l17.25">       &lt;caption label=&quot;&amp;sounds.label;&quot;/&gt;</span>
<a href="#l17.26"></a><span id="l17.26">       &lt;checkbox id=&quot;playSounds&quot; label=&quot;&amp;playSounds.label;&quot;</span>
<a href="#l17.27"></a><span id="l17.27">                 accesskey=&quot;&amp;playSounds.accesskey;&quot;</span>
<a href="#l17.28"></a><span id="l17.28">                 preference=&quot;messenger.options.playSounds&quot;/&gt;</span>
<a href="#l17.29"></a><span id="l17.29">     &lt;/groupbox&gt;</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+#ifndef XP_MACOSX</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+    &lt;groupbox id=&quot;systrayGroup&quot;&gt;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+      &lt;caption label=&quot;&amp;systray.label;&quot;/&gt;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+        &lt;label value=&quot;&amp;minimizeToTray.label;&quot;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+               accesskey=&quot;&amp;minimizeToTray.accesskey;&quot;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+               control=&quot;minimizeOn&quot;/&gt;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+        &lt;menulist id=&quot;minimizeOn&quot; preference=&quot;extensions.mintrayr.minimizeon&quot;&gt;</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+          &lt;menupopup&gt;</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+            &lt;menuitem label=&quot;&amp;minimizeOn.never.label;&quot;    value=&quot;0&quot;/&gt;</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+            &lt;menuitem label=&quot;&amp;minimizeOn.minimize.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+            &lt;menuitem label=&quot;&amp;minimizeOn.close.label;&quot;    value=&quot;2&quot;/&gt;</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+            &lt;menuitem label=&quot;&amp;minimizeOn.both.label;&quot;     value=&quot;3&quot;/&gt;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+          &lt;/menupopup&gt;</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+        &lt;/menulist&gt;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+    &lt;/groupbox&gt;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+#endif</span>
<a href="#l17.51"></a><span id="l17.51">     &lt;hbox class=&quot;bottomBox&quot;&gt;</span>
<a href="#l17.52"></a><span id="l17.52">       &lt;groupbox id=&quot;addonsMgrGroup&quot; orient=&quot;horizontal&quot; align=&quot;center&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l17.53"></a><span id="l17.53">         &lt;caption label=&quot;&amp;addonsMgr.label;&quot;/&gt;</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55">         &lt;description control=&quot;manageAddons&quot;</span>
<a href="#l17.56"></a><span id="l17.56"> #ifdef XP_WIN</span>
<a href="#l17.57"></a><span id="l17.57">                      flex=&quot;1&quot;&gt;&amp;manageAddonsDescWin.label;&lt;/description&gt;</span>
<a href="#l17.58"></a><span id="l17.58"> #else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/im/installer/package-manifest.in</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/im/installer/package-manifest.in</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -408,16 +408,18 @@</span>
<a href="#l18.4"></a><span id="l18.4"> @BINPATH@/components/imContacts.manifest</span>
<a href="#l18.5"></a><span id="l18.5"> @BINPATH@/components/imConversations.js</span>
<a href="#l18.6"></a><span id="l18.6"> @BINPATH@/components/imConversations.manifest</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> #ifdef XP_MACOSX</span>
<a href="#l18.9"></a><span id="l18.9"> @BINPATH@/components/ibDockBadge.js</span>
<a href="#l18.10"></a><span id="l18.10"> @BINPATH@/components/ibDockBadge.manifest</span>
<a href="#l18.11"></a><span id="l18.11"> #else</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+@BINPATH@/components/@DLL_PREFIX@trayToolkit@DLL_SUFFIX@</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+@BINPATH@/components/trayToolkit.xpt</span>
<a href="#l18.14"></a><span id="l18.14"> @BINPATH@/components/profileMigrator.js</span>
<a href="#l18.15"></a><span id="l18.15"> @BINPATH@/components/profileMigrator.manifest</span>
<a href="#l18.16"></a><span id="l18.16"> #endif</span>
<a href="#l18.17"></a><span id="l18.17"> @BINPATH@/components/ibCommandLineHandler.js</span>
<a href="#l18.18"></a><span id="l18.18"> @BINPATH@/components/ibCommandLineHandler.manifest</span>
<a href="#l18.19"></a><span id="l18.19"> @BINPATH@/components/facebookOverrideProtocol.js</span>
<a href="#l18.20"></a><span id="l18.20"> @BINPATH@/components/gtalkOverrideProtocol.js</span>
<a href="#l18.21"></a><span id="l18.21"> @BINPATH@/components/overrideProtocols.manifest</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/im/locales/en-US/chrome/instantbird/mintrayr.dtd</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+&lt;!ENTITY mintrayr.minimize &quot;Minimize to Tray&quot;&gt;</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+&lt;!ENTITY mintrayr.minimize.tip &quot;Minimizes the current window to the system tray&quot;&gt;</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+&lt;!ENTITY mintrayr.restore &quot;Restore&quot;&gt;</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+&lt;!ENTITY mintrayr.keys.minimize.keycode &quot;VK_F9&quot;&gt;</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+&lt;!ENTITY mintrayr.keys.minimize.modifiers &quot;&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/im/locales/en-US/chrome/instantbird/preferences/main.dtd</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/im/locales/en-US/chrome/instantbird/preferences/main.dtd</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -19,13 +19,21 @@</span>
<a href="#l20.4"></a><span id="l20.4"> &lt;!ENTITY unreadCountInDock.accesskey   &quot;u&quot;&gt;</span>
<a href="#l20.5"></a><span id="l20.5"> &lt;!ENTITY notifyOfNewMessages.label     &quot;Notify of messages received in inactive windows&quot;&gt;</span>
<a href="#l20.6"></a><span id="l20.6"> &lt;!ENTITY notifyOfNewMessages.accesskey &quot;N&quot;&gt;</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> &lt;!ENTITY sounds.label                  &quot;Sounds&quot;&gt;</span>
<a href="#l20.9"></a><span id="l20.9"> &lt;!ENTITY playSounds.label              &quot;Play sounds on messaging or buddy list events&quot;&gt;</span>
<a href="#l20.10"></a><span id="l20.10"> &lt;!ENTITY playSounds.accesskey          &quot;P&quot;&gt;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+&lt;!ENTITY systray.label                 &quot;System Tray Icon&quot;&gt;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+&lt;!ENTITY minimizeToTray.label          &quot;Minimize Contacts window to Tray:&quot;&gt;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+&lt;!ENTITY minimizeToTray.accesskey      &quot;t&quot;&gt;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+&lt;!ENTITY minimizeOn.never.label        &quot;Never (only from the menu)&quot;&gt;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+&lt;!ENTITY minimizeOn.minimize.label     &quot;When Minimizing&quot;&gt;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+&lt;!ENTITY minimizeOn.close.label        &quot;Instead of Closing&quot;&gt;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+&lt;!ENTITY minimizeOn.both.label         &quot;Instead of Closing and when Minimizing&quot;&gt;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+</span>
<a href="#l20.20"></a><span id="l20.20"> &lt;!ENTITY addonsMgr.label               &quot;Add-ons&quot;&gt;</span>
<a href="#l20.21"></a><span id="l20.21"> &lt;!ENTITY manageAddonsDescWin.label     &quot;Change options for your add-ons&quot;&gt;</span>
<a href="#l20.22"></a><span id="l20.22"> &lt;!ENTITY manageAddonsDescUnix2.label   &quot;Change preferences for your add-ons&quot;&gt;</span>
<a href="#l20.23"></a><span id="l20.23"> &lt;!ENTITY manageAddons.label            &quot;Manage Add-ons&quot;&gt;</span>
<a href="#l20.24"></a><span id="l20.24"> &lt;!ENTITY manageAddons.accesskey        &quot;M&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/im/locales/jar.mn</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/im/locales/jar.mn</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -11,16 +11,17 @@</span>
<a href="#l21.4"></a><span id="l21.4"> 	locale/@AB_CD@/instantbird/buddytooltip.properties (%chrome/instantbird/buddytooltip.properties)</span>
<a href="#l21.5"></a><span id="l21.5"> 	locale/@AB_CD@/instantbird/core.properties	(%chrome/instantbird/core.properties)</span>
<a href="#l21.6"></a><span id="l21.6"> 	locale/@AB_CD@/instantbird/credits.dtd		(%chrome/instantbird/credits.dtd)</span>
<a href="#l21.7"></a><span id="l21.7"> 	locale/@AB_CD@/instantbird/engineManager.dtd	(%chrome/instantbird/engineManager.dtd)</span>
<a href="#l21.8"></a><span id="l21.8"> 	locale/@AB_CD@/instantbird/engineManager.properties (%chrome/instantbird/engineManager.properties)</span>
<a href="#l21.9"></a><span id="l21.9"> 	locale/@AB_CD@/instantbird/instantbird.dtd	(%chrome/instantbird/instantbird.dtd)</span>
<a href="#l21.10"></a><span id="l21.10"> 	locale/@AB_CD@/instantbird/instantbird.properties (%chrome/instantbird/instantbird.properties)</span>
<a href="#l21.11"></a><span id="l21.11"> 	locale/@AB_CD@/instantbird/joinChat.dtd		(%chrome/instantbird/joinChat.dtd)</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+	locale/@AB_CD@/instantbird/mintrayr.dtd		(%chrome/instantbird/mintrayr.dtd)</span>
<a href="#l21.13"></a><span id="l21.13"> 	locale/@AB_CD@/instantbird/proxies.dtd		(%chrome/instantbird/proxies.dtd)</span>
<a href="#l21.14"></a><span id="l21.14"> 	locale/@AB_CD@/instantbird/proxies.properties	(%chrome/instantbird/proxies.properties)</span>
<a href="#l21.15"></a><span id="l21.15"> 	locale/@AB_CD@/instantbird/region.properties	(%chrome/instantbird/region.properties)</span>
<a href="#l21.16"></a><span id="l21.16"> 	locale/@AB_CD@/instantbird/tabbrowser.dtd	(%chrome/instantbird/tabbrowser.dtd)</span>
<a href="#l21.17"></a><span id="l21.17"> 	locale/@AB_CD@/instantbird/tabbrowser.properties	(%chrome/instantbird/tabbrowser.properties)</span>
<a href="#l21.18"></a><span id="l21.18"> 	locale/@AB_CD@/instantbird/updates.properties	(%chrome/instantbird/updates.properties)</span>
<a href="#l21.19"></a><span id="l21.19"> 	locale/@AB_CD@/instantbird/quitDialog.properties	(%chrome/instantbird/quitDialog.properties)</span>
<a href="#l21.20"></a><span id="l21.20"> 	locale/@AB_CD@/instantbird/preferences/advanced.dtd     (%chrome/instantbird/preferences/advanced.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/im/makefiles.sh</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/im/makefiles.sh</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -43,15 +43,16 @@ instantbird/app/profile/extensions/Makef</span>
<a href="#l22.4"></a><span id="l22.4"> instantbird/branding/nightly/Makefile</span>
<a href="#l22.5"></a><span id="l22.5"> instantbird/branding/nightly/locales/Makefile</span>
<a href="#l22.6"></a><span id="l22.6"> instantbird/branding/halloween/Makefile</span>
<a href="#l22.7"></a><span id="l22.7"> instantbird/branding/halloween/locales/Makefile</span>
<a href="#l22.8"></a><span id="l22.8"> instantbird/branding/release/Makefile</span>
<a href="#l22.9"></a><span id="l22.9"> instantbird/branding/release/locales/Makefile</span>
<a href="#l22.10"></a><span id="l22.10"> instantbird/content/Makefile</span>
<a href="#l22.11"></a><span id="l22.11"> instantbird/components/Makefile</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+instantbird/components/mintrayr/Makefile</span>
<a href="#l22.13"></a><span id="l22.13"> instantbird/locales/Makefile</span>
<a href="#l22.14"></a><span id="l22.14"> instantbird/modules/Makefile</span>
<a href="#l22.15"></a><span id="l22.15"> instantbird/themes/Makefile</span>
<a href="#l22.16"></a><span id="l22.16"> instantbird/installer/Makefile</span>
<a href="#l22.17"></a><span id="l22.17"> instantbird/installer/windows/Makefile</span>
<a href="#l22.18"></a><span id="l22.18"> &quot;</span>
<a href="#l22.19"></a><span id="l22.19"> fi</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

