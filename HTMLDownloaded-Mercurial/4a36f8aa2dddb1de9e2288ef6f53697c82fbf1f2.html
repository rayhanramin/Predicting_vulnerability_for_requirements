<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28619:4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2" />
<meta property="og:url" content="/comm-central/rev/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2" />
<meta property="og:description" content="Bug 1538409 - implement oAuth  authentication for POP accounts. r=benc" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2">shortlog</a> |
<a href="/comm-central/log/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2">files</a> |
changeset |
<a href="/comm-central/raw-rev/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2">raw</a>  | <a href="/comm-central/archive/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1538409">Bug 1538409</a> - implement oAuth  authentication for POP accounts. r=benc
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#103;&#110;&#117;&#115;&#32;&#77;&#101;&#108;&#105;&#110;&#32;&#60;&#109;&#107;&#109;&#101;&#108;&#105;&#110;&#43;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#105;&#107;&#105;&#46;&#102;&#105;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 30 Jan 2020 11:05:48 +0200</td></tr>

<tr>
 <td>changeset 28619</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2">4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2</a></td>
</tr>



<tr>
<td>parent 28618</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/91f77a3708ffa978462e80a87764ca364ad669f6">91f77a3708ffa978462e80a87764ca364ad669f6</a>
</td>
</tr>

<tr>
<td>child 28620</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/36e93a246513596dae40e4ad394e3095f90fdcc7">36e93a246513596dae40e4ad394e3095f90fdcc7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2">16963</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 30 Jan 2020 10:50:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@eca9d62cfb2c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=eca9d62cfb2ca1c44e6bae3d66776ef5613b9c28">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=eca9d62cfb2ca1c44e6bae3d66776ef5613b9c28&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eca9d62cfb2ca1c44e6bae3d66776ef5613b9c28&newProject=comm-central&newRevision=4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eca9d62cfb2ca1c44e6bae3d66776ef5613b9c28&newProject=comm-central&newRevision=4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eca9d62cfb2ca1c44e6bae3d66776ef5613b9c28&newProject=comm-central&newRevision=4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28benc%29&revcount=50">benc</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1538409">1538409</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1538409">Bug 1538409</a> - implement oAuth  authentication for POP accounts. r=benc</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mail/components/accountcreation/content/emailWizard.js">mail/components/accountcreation/content/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mail/components/accountcreation/content/emailWizard.js">file</a> |
<a href="/comm-central/annotate/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mail/components/accountcreation/content/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mail/components/accountcreation/content/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mail/components/accountcreation/content/emailWizard.js">comparison</a> |
<a href="/comm-central/log/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mail/components/accountcreation/content/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-server.js">mailnews/base/prefs/content/am-server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-server.js">file</a> |
<a href="/comm-central/annotate/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-server.js">annotate</a> |
<a href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-server.js">diff</a> |
<a href="/comm-central/comparison/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-server.js">comparison</a> |
<a href="/comm-central/log/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-smtp.js">mailnews/base/prefs/content/am-smtp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-smtp.js">file</a> |
<a href="/comm-central/annotate/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-smtp.js">annotate</a> |
<a href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-smtp.js">diff</a> |
<a href="/comm-central/comparison/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-smtp.js">comparison</a> |
<a href="/comm-central/log/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/prefs/content/am-smtp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/util/OAuth2Providers.jsm">mailnews/base/util/OAuth2Providers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/util/OAuth2Providers.jsm">file</a> |
<a href="/comm-central/annotate/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/util/OAuth2Providers.jsm">annotate</a> |
<a href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/util/OAuth2Providers.jsm">diff</a> |
<a href="/comm-central/comparison/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/util/OAuth2Providers.jsm">comparison</a> |
<a href="/comm-central/log/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/base/util/OAuth2Providers.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.h">mailnews/local/src/nsPop3Protocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.h">file</a> |
<a href="/comm-central/annotate/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.h">annotate</a> |
<a href="/comm-central/diff/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.h">diff</a> |
<a href="/comm-central/comparison/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.h">comparison</a> |
<a href="/comm-central/log/4a36f8aa2dddb1de9e2288ef6f53697c82fbf1f2/mailnews/local/src/nsPop3Protocol.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1461,35 +1461,33 @@ EmailConfigWizard.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">     e(&quot;incoming_username&quot;).value = config.incoming.username;</span>
<a href="#l1.5"></a><span id="l1.5">     if (config.incoming.port) {</span>
<a href="#l1.6"></a><span id="l1.6">       e(&quot;incoming_port&quot;).value = config.incoming.port;</span>
<a href="#l1.7"></a><span id="l1.7">     } else {</span>
<a href="#l1.8"></a><span id="l1.8">       this.adjustIncomingPortToSSLAndProtocol(config);</span>
<a href="#l1.9"></a><span id="l1.9">     }</span>
<a href="#l1.10"></a><span id="l1.10">     this.fillPortDropdown(config.incoming.type);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    // If the hostname supports OAuth2 and imap is enabled, enable OAuth2.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    // If the incoming server hostname supports OAuth2, enable OAuth2 for it.</span>
<a href="#l1.14"></a><span id="l1.14">     let iDetails = OAuth2Providers.getHostnameDetails(config.incoming.hostname);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    e(&quot;in-authMethod-oauth2&quot;).hidden = !iDetails;</span>
<a href="#l1.16"></a><span id="l1.16">     if (iDetails) {</span>
<a href="#l1.17"></a><span id="l1.17">       gEmailWizardLogger.info(</span>
<a href="#l1.18"></a><span id="l1.18">         &quot;OAuth2 details for incoming server &quot; +</span>
<a href="#l1.19"></a><span id="l1.19">           config.incoming.hostname +</span>
<a href="#l1.20"></a><span id="l1.20">           &quot; is &quot; +</span>
<a href="#l1.21"></a><span id="l1.21">           iDetails</span>
<a href="#l1.22"></a><span id="l1.22">       );</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-    }</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-    e(&quot;in-authMethod-oauth2&quot;).hidden = !(</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-      iDetails &amp;&amp; e(&quot;incoming_protocol&quot;).value == 1</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    );</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    if (!e(&quot;in-authMethod-oauth2&quot;).hidden) {</span>
<a href="#l1.28"></a><span id="l1.28">       config.oauthSettings = {};</span>
<a href="#l1.29"></a><span id="l1.29">       [config.oauthSettings.issuer, config.oauthSettings.scope] = iDetails;</span>
<a href="#l1.30"></a><span id="l1.30">       // oauthsettings are not stored nor changeable in the user interface, so just</span>
<a href="#l1.31"></a><span id="l1.31">       // store them in the base configuration.</span>
<a href="#l1.32"></a><span id="l1.32">       this._currentConfig.oauthSettings = config.oauthSettings;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    } else {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      e(&quot;incoming_authMethod&quot;).value = 0; // Set to autodetect.</span>
<a href="#l1.35"></a><span id="l1.35">     }</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">     // outgoing server</span>
<a href="#l1.38"></a><span id="l1.38">     e(&quot;outgoing_hostname&quot;).value = config.outgoing.hostname;</span>
<a href="#l1.39"></a><span id="l1.39">     e(&quot;outgoing_username&quot;).value = config.outgoing.username;</span>
<a href="#l1.40"></a><span id="l1.40">     // While sameInOutUsernames is true we synchronize values of incoming</span>
<a href="#l1.41"></a><span id="l1.41">     // and outgoing username.</span>
<a href="#l1.42"></a><span id="l1.42">     this.sameInOutUsernames = true;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineat">@@ -1504,33 +1502,33 @@ EmailConfigWizard.prototype = {</span>
<a href="#l1.44"></a><span id="l1.44">       0</span>
<a href="#l1.45"></a><span id="l1.45">     );</span>
<a href="#l1.46"></a><span id="l1.46">     if (config.outgoing.port) {</span>
<a href="#l1.47"></a><span id="l1.47">       e(&quot;outgoing_port&quot;).value = config.outgoing.port;</span>
<a href="#l1.48"></a><span id="l1.48">     } else {</span>
<a href="#l1.49"></a><span id="l1.49">       this.adjustOutgoingPortToSSLAndProtocol(config);</span>
<a href="#l1.50"></a><span id="l1.50">     }</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-    // If the hostname supports OAuth2 and imap is enabled, enable OAuth2.</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    // If the smtp hostname supports OAuth2, enable OAuth2 for it.</span>
<a href="#l1.54"></a><span id="l1.54">     let oDetails = OAuth2Providers.getHostnameDetails(config.outgoing.hostname);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+    e(&quot;out-authMethod-oauth2&quot;).hidden = !oDetails;</span>
<a href="#l1.56"></a><span id="l1.56">     if (oDetails) {</span>
<a href="#l1.57"></a><span id="l1.57">       gEmailWizardLogger.info(</span>
<a href="#l1.58"></a><span id="l1.58">         &quot;OAuth2 details for outgoing server &quot; +</span>
<a href="#l1.59"></a><span id="l1.59">           config.outgoing.hostname +</span>
<a href="#l1.60"></a><span id="l1.60">           &quot; is &quot; +</span>
<a href="#l1.61"></a><span id="l1.61">           oDetails</span>
<a href="#l1.62"></a><span id="l1.62">       );</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-    }</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-    e(&quot;out-authMethod-oauth2&quot;).hidden = !oDetails;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-    if (!e(&quot;out-authMethod-oauth2&quot;).hidden) {</span>
<a href="#l1.66"></a><span id="l1.66">       config.oauthSettings = {};</span>
<a href="#l1.67"></a><span id="l1.67">       [config.oauthSettings.issuer, config.oauthSettings.scope] = oDetails;</span>
<a href="#l1.68"></a><span id="l1.68">       // oauthsettings are not stored nor changeable in the user interface, so just</span>
<a href="#l1.69"></a><span id="l1.69">       // store them in the base configuration.</span>
<a href="#l1.70"></a><span id="l1.70">       this._currentConfig.oauthSettings = config.oauthSettings;</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+    } else {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+      e(&quot;outgoing_authMethod&quot;).value = 0; // Set to autodetect.</span>
<a href="#l1.73"></a><span id="l1.73">     }</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75">     // populate fields even if existingServerKey, in case user changes back</span>
<a href="#l1.76"></a><span id="l1.76">     if (config.outgoing.existingServerKey) {</span>
<a href="#l1.77"></a><span id="l1.77">       let menulist = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l1.78"></a><span id="l1.78">       // We can't use menulist.value = config.outgoing.existingServerKey</span>
<a href="#l1.79"></a><span id="l1.79">       // because would overwrite the text field, so have to do it manually:</span>
<a href="#l1.80"></a><span id="l1.80">       let menuitems = menulist.menupopup.children;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -92,18 +92,20 @@ function onInit(aPageId, aServerId) {</span>
<a href="#l2.4"></a><span id="l2.4">   onCheckItem(&quot;nntp.maxArticles&quot;, [&quot;nntp.notifyOn&quot;]);</span>
<a href="#l2.5"></a><span id="l2.5">   setupMailOnServerUI();</span>
<a href="#l2.6"></a><span id="l2.6">   setupFixedUI();</span>
<a href="#l2.7"></a><span id="l2.7">   let serverType = document.getElementById(&quot;server.type&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l2.8"></a><span id="l2.8">   if (serverType == &quot;imap&quot;) {</span>
<a href="#l2.9"></a><span id="l2.9">     setupImapDeleteUI(aServerId);</span>
<a href="#l2.10"></a><span id="l2.10">   }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  // TLS Cert (External) and OAuth2 are only supported on IMAP.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  document.getElementById(&quot;authMethod-oauth2&quot;).hidden = serverType != &quot;imap&quot;;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  // OAuth2 are only supported on IMAP and POP.</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  document.getElementById(&quot;authMethod-oauth2&quot;).hidden =</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    serverType != &quot;imap&quot; &amp;&amp; serverType != &quot;pop3&quot;;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  // TLS Cert (External) only supported on IMAP.</span>
<a href="#l2.18"></a><span id="l2.18">   document.getElementById(&quot;authMethod-external&quot;).hidden = serverType != &quot;imap&quot;;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   // &quot;STARTTLS, if available&quot; is vulnerable to MITM attacks so we shouldn't</span>
<a href="#l2.21"></a><span id="l2.21">   // allow users to choose it anymore. Hide the option unless the user already</span>
<a href="#l2.22"></a><span id="l2.22">   // has it set.</span>
<a href="#l2.23"></a><span id="l2.23">   hideUnlessSelected(document.getElementById(&quot;connectionSecurityType-1&quot;));</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   // UI for account store type.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-smtp.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-smtp.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -5,16 +5,20 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> /* import-globals-from amUtils.js */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.8"></a><span id="l3.8"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l3.9"></a><span id="l3.9">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> );</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+var { OAuth2Providers } = ChromeUtils.import(</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  &quot;resource:///modules/OAuth2Providers.jsm&quot;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+</span>
<a href="#l3.16"></a><span id="l3.16"> var gSmtpServerListWindow = {</span>
<a href="#l3.17"></a><span id="l3.17">   mBundle: null,</span>
<a href="#l3.18"></a><span id="l3.18">   mServerList: null,</span>
<a href="#l3.19"></a><span id="l3.19">   mAddButton: null,</span>
<a href="#l3.20"></a><span id="l3.20">   mEditButton: null,</span>
<a href="#l3.21"></a><span id="l3.21">   mDeleteButton: null,</span>
<a href="#l3.22"></a><span id="l3.22">   mSetDefaultServerButton: null,</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -169,16 +173,23 @@ var gSmtpServerListWindow = {</span>
<a href="#l3.25"></a><span id="l3.25">       default:</span>
<a href="#l3.26"></a><span id="l3.26">         // leave empty</span>
<a href="#l3.27"></a><span id="l3.27">         Cu.reportError(</span>
<a href="#l3.28"></a><span id="l3.28">           &quot;Warning: unknown value for smtpserver... authMethod: &quot; +</span>
<a href="#l3.29"></a><span id="l3.29">             aServer.authMethod</span>
<a href="#l3.30"></a><span id="l3.30">         );</span>
<a href="#l3.31"></a><span id="l3.31">     }</span>
<a href="#l3.32"></a><span id="l3.32">     if (authStr) {</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+      let details = OAuth2Providers.getHostnameDetails(aServer.hostname);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+      if (!details) {</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        document</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+          .getElementById(&quot;authMethod-oauth2&quot;)</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+          .toggleAttribute(&quot;disabled&quot;, true);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+      }</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+</span>
<a href="#l3.40"></a><span id="l3.40">       document.getElementById(&quot;authMethodValue&quot;).value = this.mBundle.getString(</span>
<a href="#l3.41"></a><span id="l3.41">         authStr</span>
<a href="#l3.42"></a><span id="l3.42">       );</span>
<a href="#l3.43"></a><span id="l3.43">     }</span>
<a href="#l3.44"></a><span id="l3.44">   },</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46">   refreshServerList(aServerKeyToSelect, aFocusList) {</span>
<a href="#l3.47"></a><span id="l3.47">     // remove all children</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/OAuth2Providers.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/OAuth2Providers.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -6,29 +6,33 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * Details of supported OAuth2 Providers.</span>
<a href="#l4.5"></a><span id="l4.5">  */</span>
<a href="#l4.6"></a><span id="l4.6"> var EXPORTED_SYMBOLS = [&quot;OAuth2Providers&quot;];</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> // map of hostnames to [issuer, scope]</span>
<a href="#l4.9"></a><span id="l4.9"> var kHostnames = new Map([</span>
<a href="#l4.10"></a><span id="l4.10">   [&quot;imap.googlemail.com&quot;, [&quot;accounts.google.com&quot;, &quot;https://mail.google.com/&quot;]],</span>
<a href="#l4.11"></a><span id="l4.11">   [&quot;smtp.googlemail.com&quot;, [&quot;accounts.google.com&quot;, &quot;https://mail.google.com/&quot;]],</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  [&quot;pop.googlemail.com&quot;, [&quot;accounts.google.com&quot;, &quot;https://mail.google.com/&quot;]],</span>
<a href="#l4.13"></a><span id="l4.13">   [&quot;imap.gmail.com&quot;, [&quot;accounts.google.com&quot;, &quot;https://mail.google.com/&quot;]],</span>
<a href="#l4.14"></a><span id="l4.14">   [&quot;smtp.gmail.com&quot;, [&quot;accounts.google.com&quot;, &quot;https://mail.google.com/&quot;]],</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  [&quot;pop.gmail.com&quot;, [&quot;accounts.google.com&quot;, &quot;https://mail.google.com/&quot;]],</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">   [&quot;imap.mail.ru&quot;, [&quot;o2.mail.ru&quot;, &quot;mail.imap&quot;]],</span>
<a href="#l4.18"></a><span id="l4.18">   [&quot;smtp.mail.ru&quot;, [&quot;o2.mail.ru&quot;, &quot;mail.imap&quot;]],</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">   [&quot;imap.yandex.com&quot;, [&quot;oauth.yandex.com&quot;, &quot;mail:imap_full&quot;]],</span>
<a href="#l4.21"></a><span id="l4.21">   [&quot;smtp.yandex.com&quot;, [&quot;oauth.yandex.com&quot;, &quot;mail:smtp&quot;]],</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">   [&quot;imap.mail.yahoo.com&quot;, [&quot;login.yahoo.com&quot;, &quot;mail-w&quot;]],</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  [&quot;pop.mail.yahoo.com&quot;, [&quot;login.yahoo.com&quot;, &quot;mail-w&quot;]],</span>
<a href="#l4.25"></a><span id="l4.25">   [&quot;smtp.mail.yahoo.com&quot;, [&quot;login.yahoo.com&quot;, &quot;mail-w&quot;]],</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">   [&quot;imap.aol.com&quot;, [&quot;login.aol.com&quot;, &quot;mail-w&quot;]],</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  [&quot;pop.aol.com&quot;, [&quot;login.aol.com&quot;, &quot;mail-w&quot;]],</span>
<a href="#l4.29"></a><span id="l4.29">   [&quot;smtp.aol.com&quot;, [&quot;login.aol.com&quot;, &quot;mail-w&quot;]],</span>
<a href="#l4.30"></a><span id="l4.30"> ]);</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32"> // map of issuers to appKey, appSecret, authURI, tokenURI</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> // For the moment, these details are hard-coded, since Google does not</span>
<a href="#l4.35"></a><span id="l4.35"> // provide dynamic client registration. Don't copy these values for your</span>
<a href="#l4.36"></a><span id="l4.36"> // own application--register it yourself. This code (and possibly even the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -5434,45 +5434,44 @@ void nsImapProtocol::InitPrefAuthMethods</span>
<a href="#l5.4"></a><span id="l5.4">       break;</span>
<a href="#l5.5"></a><span id="l5.5">     case nsMsgAuthMethod::External:</span>
<a href="#l5.6"></a><span id="l5.6">       m_prefAuthMethods = kHasAuthExternalCapability;</span>
<a href="#l5.7"></a><span id="l5.7">       break;</span>
<a href="#l5.8"></a><span id="l5.8">     case nsMsgAuthMethod::secure:</span>
<a href="#l5.9"></a><span id="l5.9">       m_prefAuthMethods = kHasCRAMCapability | kHasAuthGssApiCapability |</span>
<a href="#l5.10"></a><span id="l5.10">                           kHasAuthNTLMCapability | kHasAuthMSNCapability;</span>
<a href="#l5.11"></a><span id="l5.11">       break;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    case nsMsgAuthMethod::OAuth2:</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+      m_prefAuthMethods = kHasXOAuth2Capability;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+      break;</span>
<a href="#l5.15"></a><span id="l5.15">     default:</span>
<a href="#l5.16"></a><span id="l5.16">       NS_ASSERTION(false, &quot;IMAP: authMethod pref invalid&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-      // TODO log to error console</span>
<a href="#l5.18"></a><span id="l5.18">       MOZ_LOG(IMAP, LogLevel::Error,</span>
<a href="#l5.19"></a><span id="l5.19">               (&quot;IMAP: bad pref authMethod = %d&quot;, authMethodPrefValue));</span>
<a href="#l5.20"></a><span id="l5.20">       // fall to any</span>
<a href="#l5.21"></a><span id="l5.21">       [[fallthrough]];</span>
<a href="#l5.22"></a><span id="l5.22">     case nsMsgAuthMethod::anything:</span>
<a href="#l5.23"></a><span id="l5.23">       m_prefAuthMethods = kHasAuthOldLoginCapability | kHasAuthLoginCapability |</span>
<a href="#l5.24"></a><span id="l5.24">                           kHasAuthPlainCapability | kHasCRAMCapability |</span>
<a href="#l5.25"></a><span id="l5.25">                           kHasAuthGssApiCapability | kHasAuthNTLMCapability |</span>
<a href="#l5.26"></a><span id="l5.26">                           kHasAuthMSNCapability | kHasAuthExternalCapability |</span>
<a href="#l5.27"></a><span id="l5.27">                           kHasXOAuth2Capability;</span>
<a href="#l5.28"></a><span id="l5.28">       break;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-    case nsMsgAuthMethod::OAuth2:</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-      m_prefAuthMethods = kHasXOAuth2Capability;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-      break;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  }</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  if (m_prefAuthMethods &amp; kHasXOAuth2Capability)</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  }</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  if (m_prefAuthMethods &amp; kHasXOAuth2Capability) {</span>
<a href="#l5.38"></a><span id="l5.38">     mOAuth2Support = new mozilla::mailnews::OAuth2ThreadHelper(aServer);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  // Disable OAuth2 support if we don't have the prefs installed.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-  if (m_prefAuthMethods &amp; kHasXOAuth2Capability &amp;&amp;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-      (!mOAuth2Support || !mOAuth2Support-&gt;SupportsOAuth2()))</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    m_prefAuthMethods &amp;= ~kHasXOAuth2Capability;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-  NS_ASSERTION(m_prefAuthMethods != kCapabilityUndefined,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-               &quot;IMAP: InitPrefAuthMethods() didn't work&quot;);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+    if (!mOAuth2Support || !mOAuth2Support-&gt;SupportsOAuth2()) {</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+      // Disable OAuth2 support if we don't have the prefs installed.</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+      m_prefAuthMethods &amp;= ~kHasXOAuth2Capability;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+      mOAuth2Support = nullptr;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+      MOZ_LOG(IMAP, LogLevel::Warning,</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+              (&quot;IMAP: no OAuth2 support for this server.&quot;));</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+    }</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  }</span>
<a href="#l5.55"></a><span id="l5.55"> }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57"> /**</span>
<a href="#l5.58"></a><span id="l5.58">  * Changes m_currentAuthMethod to pick the best remaining one</span>
<a href="#l5.59"></a><span id="l5.59">  * which is allowed by server and prefs and not marked failed.</span>
<a href="#l5.60"></a><span id="l5.60">  * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l5.61"></a><span id="l5.61">  */</span>
<a href="#l5.62"></a><span id="l5.62"> nsresult nsImapProtocol::ChooseAuthMethod() {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineat">@@ -5510,29 +5509,29 @@ nsresult nsImapProtocol::ChooseAuthMetho</span>
<a href="#l5.64"></a><span id="l5.64">     m_currentAuthMethod = kHasXOAuth2Capability;</span>
<a href="#l5.65"></a><span id="l5.65">   else if (kHasAuthPlainCapability &amp; availCaps)</span>
<a href="#l5.66"></a><span id="l5.66">     m_currentAuthMethod = kHasAuthPlainCapability;</span>
<a href="#l5.67"></a><span id="l5.67">   else if (kHasAuthLoginCapability &amp; availCaps)</span>
<a href="#l5.68"></a><span id="l5.68">     m_currentAuthMethod = kHasAuthLoginCapability;</span>
<a href="#l5.69"></a><span id="l5.69">   else if (kHasAuthOldLoginCapability &amp; availCaps)</span>
<a href="#l5.70"></a><span id="l5.70">     m_currentAuthMethod = kHasAuthOldLoginCapability;</span>
<a href="#l5.71"></a><span id="l5.71">   else {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;no remaining auth method&quot;));</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;No remaining auth method&quot;));</span>
<a href="#l5.74"></a><span id="l5.74">     m_currentAuthMethod = kCapabilityUndefined;</span>
<a href="#l5.75"></a><span id="l5.75">     return NS_ERROR_FAILURE;</span>
<a href="#l5.76"></a><span id="l5.76">   }</span>
<a href="#l5.77"></a><span id="l5.77">   MOZ_LOG(IMAP, LogLevel::Debug,</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-          (&quot;trying auth method 0x%&quot; PRIx64, m_currentAuthMethod));</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+          (&quot;Trying auth method 0x%&quot; PRIx64, m_currentAuthMethod));</span>
<a href="#l5.80"></a><span id="l5.80">   return NS_OK;</span>
<a href="#l5.81"></a><span id="l5.81"> }</span>
<a href="#l5.82"></a><span id="l5.82"> </span>
<a href="#l5.83"></a><span id="l5.83"> void nsImapProtocol::MarkAuthMethodAsFailed(</span>
<a href="#l5.84"></a><span id="l5.84">     eIMAPCapabilityFlags failedAuthMethod) {</span>
<a href="#l5.85"></a><span id="l5.85">   MOZ_LOG(IMAP, LogLevel::Debug,</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-          (&quot;marking auth method 0x%&quot; PRIx64 &quot; failed&quot;, failedAuthMethod));</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+          (&quot;Marking auth method 0x%&quot; PRIx64 &quot; failed&quot;, failedAuthMethod));</span>
<a href="#l5.88"></a><span id="l5.88">   m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l5.89"></a><span id="l5.89"> }</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91"> /**</span>
<a href="#l5.92"></a><span id="l5.92">  * Start over, trying all auth methods again</span>
<a href="#l5.93"></a><span id="l5.93">  */</span>
<a href="#l5.94"></a><span id="l5.94"> void nsImapProtocol::ResetAuthMethods() {</span>
<a href="#l5.95"></a><span id="l5.95">   MOZ_LOG(IMAP, LogLevel::Debug, (&quot;resetting (failed) auth methods&quot;));</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineat">@@ -8084,17 +8083,17 @@ nsImapProtocol::OnPromptCanceled() {</span>
<a href="#l5.97"></a><span id="l5.97">   // A prompt was cancelled, so notify the imap thread.</span>
<a href="#l5.98"></a><span id="l5.98">   m_passwordStatus = NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l5.99"></a><span id="l5.99">   ReentrantMonitorAutoEnter passwordMon(m_passwordReadyMonitor);</span>
<a href="#l5.100"></a><span id="l5.100">   passwordMon.Notify();</span>
<a href="#l5.101"></a><span id="l5.101">   return NS_OK;</span>
<a href="#l5.102"></a><span id="l5.102"> }</span>
<a href="#l5.103"></a><span id="l5.103"> </span>
<a href="#l5.104"></a><span id="l5.104"> bool nsImapProtocol::TryToLogon() {</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;try to log in&quot;));</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;Try to log in&quot;));</span>
<a href="#l5.107"></a><span id="l5.107">   NS_ENSURE_TRUE(m_imapServerSink, false);</span>
<a href="#l5.108"></a><span id="l5.108">   bool loginSucceeded = false;</span>
<a href="#l5.109"></a><span id="l5.109">   bool skipLoop = false;</span>
<a href="#l5.110"></a><span id="l5.110">   nsAutoString password;</span>
<a href="#l5.111"></a><span id="l5.111">   nsAutoCString userName;</span>
<a href="#l5.112"></a><span id="l5.112"> </span>
<a href="#l5.113"></a><span id="l5.113">   nsresult rv = ChooseAuthMethod();</span>
<a href="#l5.114"></a><span id="l5.114">   if (NS_FAILED(rv))  // all methods failed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -371,27 +371,21 @@ nsresult nsPop3Protocol::MarkMsgForHost(</span>
<a href="#l6.4"></a><span id="l6.4">     MarkMsgInHashTable(uidlHost-&gt;hash, UIDLArray[i], &amp;changed);</span>
<a href="#l6.5"></a><span id="l6.5">   }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   if (changed) net_pop3_write_state(uidlHost, mailDirectory);</span>
<a href="#l6.8"></a><span id="l6.8">   net_pop3_free_state(uidlHost);</span>
<a href="#l6.9"></a><span id="l6.9">   return NS_OK;</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-NS_IMPL_ADDREF_INHERITED(nsPop3Protocol, nsMsgProtocol)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-NS_IMPL_RELEASE_INHERITED(nsPop3Protocol, nsMsgProtocol)</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-NS_INTERFACE_MAP_BEGIN(nsPop3Protocol)</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  NS_INTERFACE_MAP_ENTRY(nsIPop3Protocol)</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  NS_INTERFACE_MAP_ENTRY(nsIMsgAsyncPromptListener)</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  NS_INTERFACE_MAP_ENTRY(nsIProtocolProxyCallback)</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-NS_INTERFACE_MAP_END_INHERITING(nsMsgProtocol)</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-</span>
<a href="#l6.21"></a><span id="l6.21"> // nsPop3Protocol class implementation</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsPop3Protocol, nsMsgProtocol,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+                            msgIOAuth2ModuleListener, nsIProtocolProxyCallback)</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+</span>
<a href="#l6.26"></a><span id="l6.26"> nsPop3Protocol::nsPop3Protocol(nsIURI *aURL)</span>
<a href="#l6.27"></a><span id="l6.27">     : nsMsgProtocol(aURL),</span>
<a href="#l6.28"></a><span id="l6.28">       m_bytesInMsgReceived(0),</span>
<a href="#l6.29"></a><span id="l6.29">       m_totalFolderSize(0),</span>
<a href="#l6.30"></a><span id="l6.30">       m_totalDownloadSize(0),</span>
<a href="#l6.31"></a><span id="l6.31">       m_totalBytesReceived(0),</span>
<a href="#l6.32"></a><span id="l6.32">       m_pop3ConData(nullptr) {}</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineat">@@ -446,28 +440,37 @@ nsPop3Protocol::OnProxyAvailable(nsICanc</span>
<a href="#l6.35"></a><span id="l6.35">     Cancel(rv);</span>
<a href="#l6.36"></a><span id="l6.36">   }</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   return rv;</span>
<a href="#l6.39"></a><span id="l6.39"> }</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41"> nsresult nsPop3Protocol::InitializeInternal(nsIProxyInfo *aProxyInfo) {</span>
<a href="#l6.42"></a><span id="l6.42">   nsresult rv;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-</span>
<a href="#l6.44"></a><span id="l6.44">   m_proxyRequest = nullptr;</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">   NS_ENSURE_TRUE(m_url, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">   // extract out message feedback if there is any.</span>
<a href="#l6.49"></a><span id="l6.49">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url);</span>
<a href="#l6.50"></a><span id="l6.50">   if (mailnewsUrl) {</span>
<a href="#l6.51"></a><span id="l6.51">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.52"></a><span id="l6.52">     mailnewsUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.53"></a><span id="l6.53">     NS_ENSURE_TRUE(server, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+    // Query for OAuth2 support. If the POP server preferences don't allow</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    // for OAuth2, then don't carry around the OAuth2 module any longer</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    // since we won't need it.</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    mOAuth2Support = do_CreateInstance(MSGIOAUTH2MODULE_CONTRACTID);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+    if (mOAuth2Support) {</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+      bool supportsOAuth = false;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+      mOAuth2Support-&gt;InitFromMail(server, &amp;supportsOAuth);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+      if (!supportsOAuth) mOAuth2Support = nullptr;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    }</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+</span>
<a href="#l6.65"></a><span id="l6.65">     rv = server-&gt;GetSocketType(&amp;m_socketType);</span>
<a href="#l6.66"></a><span id="l6.66">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">     int32_t authMethod = 0;</span>
<a href="#l6.69"></a><span id="l6.69">     rv = server-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l6.70"></a><span id="l6.70">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.71"></a><span id="l6.71">     InitPrefAuthMethods(authMethod);</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73" class="difflineat">@@ -1265,20 +1268,19 @@ int32_t nsPop3Protocol::Pop3SendData(con</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75">   m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l6.76"></a><span id="l6.76">   MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l6.77"></a><span id="l6.77">           (POP3LOG(&quot;Pop3SendData failed: %&quot; PRIx32),</span>
<a href="#l6.78"></a><span id="l6.78">            static_cast&lt;uint32_t&gt;(result)));</span>
<a href="#l6.79"></a><span id="l6.79">   return -1;</span>
<a href="#l6.80"></a><span id="l6.80"> }</span>
<a href="#l6.81"></a><span id="l6.81"> </span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-/*</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+/**</span>
<a href="#l6.84"></a><span id="l6.84">  * POP3 AUTH extension</span>
<a href="#l6.85"></a><span id="l6.85">  */</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-</span>
<a href="#l6.87"></a><span id="l6.87"> int32_t nsPop3Protocol::SendAuth() {</span>
<a href="#l6.88"></a><span id="l6.88">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;SendAuth()&quot;)));</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">   if (!m_pop3ConData-&gt;command_succeeded) return Error(&quot;pop3ServerError&quot;);</span>
<a href="#l6.91"></a><span id="l6.91"> </span>
<a href="#l6.92"></a><span id="l6.92">   nsAutoCString command(&quot;AUTH&quot; CRLF);</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94">   m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_RESPONSE;</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineat">@@ -1332,16 +1334,18 @@ int32_t nsPop3Protocol::AuthResponse(nsI</span>
<a href="#l6.96"></a><span id="l6.96">   else if (!PL_strcasecmp(line, &quot;MSN&quot;))</span>
<a href="#l6.97"></a><span id="l6.97">     SetCapFlag(POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN);</span>
<a href="#l6.98"></a><span id="l6.98">   else if (!PL_strcasecmp(line, &quot;GSSAPI&quot;))</span>
<a href="#l6.99"></a><span id="l6.99">     SetCapFlag(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l6.100"></a><span id="l6.100">   else if (!PL_strcasecmp(line, &quot;PLAIN&quot;))</span>
<a href="#l6.101"></a><span id="l6.101">     SetCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l6.102"></a><span id="l6.102">   else if (!PL_strcasecmp(line, &quot;LOGIN&quot;))</span>
<a href="#l6.103"></a><span id="l6.103">     SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  else if (!PL_strcasecmp(line, &quot;XOAUTH2&quot;))</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+    SetCapFlag(POP3_HAS_AUTH_XOAUTH2);</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107">   PR_Free(line);</span>
<a href="#l6.108"></a><span id="l6.108">   return 0;</span>
<a href="#l6.109"></a><span id="l6.109"> }</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111"> /*</span>
<a href="#l6.112"></a><span id="l6.112">  * POP3 CAPA extension, see RFC 2449, chapter 5</span>
<a href="#l6.113"></a><span id="l6.113">  */</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineat">@@ -1385,34 +1389,30 @@ int32_t nsPop3Protocol::CapaResponse(nsI</span>
<a href="#l6.115"></a><span id="l6.115"> </span>
<a href="#l6.116"></a><span id="l6.116">   if (!PL_strcmp(line, &quot;.&quot;)) {</span>
<a href="#l6.117"></a><span id="l6.117">     // now that we've read all the CAPA responses, go for it</span>
<a href="#l6.118"></a><span id="l6.118">     m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l6.119"></a><span id="l6.119">     m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l6.120"></a><span id="l6.120">   } else if (!PL_strcasecmp(line, &quot;XSENDER&quot;)) {</span>
<a href="#l6.121"></a><span id="l6.121">     SetCapFlag(POP3_HAS_XSENDER);</span>
<a href="#l6.122"></a><span id="l6.122">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-  } else</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-      // see RFC 2449, chapter 6.4</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-      if (!PL_strcasecmp(line, &quot;RESP-CODES&quot;)) {</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+  } else if (!PL_strcasecmp(line, &quot;RESP-CODES&quot;)) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+    // see RFC 2449, chapter 6.4</span>
<a href="#l6.128"></a><span id="l6.128">     SetCapFlag(POP3_HAS_RESP_CODES);</span>
<a href="#l6.129"></a><span id="l6.129">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-  } else</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-      // see RFC 3206, chapter 6</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-      if (!PL_strcasecmp(line, &quot;AUTH-RESP-CODE&quot;)) {</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+  } else if (!PL_strcasecmp(line, &quot;AUTH-RESP-CODE&quot;)) {</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+    // see RFC 3206, chapter 6</span>
<a href="#l6.135"></a><span id="l6.135">     SetCapFlag(POP3_HAS_AUTH_RESP_CODE);</span>
<a href="#l6.136"></a><span id="l6.136">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-  } else</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-      // see RFC 2595, chapter 4</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-      if (!PL_strcasecmp(line, &quot;STLS&quot;)) {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+  } else if (!PL_strcasecmp(line, &quot;STLS&quot;)) {</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+    // see RFC 2595, chapter 4</span>
<a href="#l6.142"></a><span id="l6.142">     SetCapFlag(POP3_HAS_STLS);</span>
<a href="#l6.143"></a><span id="l6.143">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-  } else</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-      // see RFC 2449, chapter 6.3</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-      if (!PL_strncasecmp(line, &quot;SASL&quot;, 4) &amp;&amp; strlen(line) &gt; 6) {</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+  } else if (!PL_strncasecmp(line, &quot;SASL&quot;, 4) &amp;&amp; strlen(line) &gt; 6) {</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+    // see RFC 2449, chapter 6.3</span>
<a href="#l6.149"></a><span id="l6.149">     nsAutoCString responseLine;</span>
<a href="#l6.150"></a><span id="l6.150">     responseLine.Assign(line + 5);</span>
<a href="#l6.151"></a><span id="l6.151"> </span>
<a href="#l6.152"></a><span id="l6.152">     if (responseLine.Find(&quot;PLAIN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l6.153"></a><span id="l6.153">       SetCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l6.154"></a><span id="l6.154"> </span>
<a href="#l6.155"></a><span id="l6.155">     if (responseLine.Find(&quot;LOGIN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l6.156"></a><span id="l6.156">       SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineat">@@ -1424,16 +1424,19 @@ int32_t nsPop3Protocol::CapaResponse(nsI</span>
<a href="#l6.158"></a><span id="l6.158">       SetCapFlag(POP3_HAS_AUTH_CRAM_MD5);</span>
<a href="#l6.159"></a><span id="l6.159"> </span>
<a href="#l6.160"></a><span id="l6.160">     if (responseLine.Find(&quot;NTLM&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l6.161"></a><span id="l6.161">       SetCapFlag(POP3_HAS_AUTH_NTLM);</span>
<a href="#l6.162"></a><span id="l6.162"> </span>
<a href="#l6.163"></a><span id="l6.163">     if (responseLine.Find(&quot;MSN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l6.164"></a><span id="l6.164">       SetCapFlag(POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN);</span>
<a href="#l6.165"></a><span id="l6.165"> </span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+    if (responseLine.Find(&quot;XOAUTH2&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+      SetCapFlag(POP3_HAS_AUTH_XOAUTH2);</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+</span>
<a href="#l6.169"></a><span id="l6.169">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l6.170"></a><span id="l6.170">   }</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172">   PR_Free(line);</span>
<a href="#l6.173"></a><span id="l6.173">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l6.174"></a><span id="l6.174">           (POP3LOG(&quot;Capability entry processed&quot;)));</span>
<a href="#l6.175"></a><span id="l6.175">   return 0;</span>
<a href="#l6.176"></a><span id="l6.176"> }</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineat">@@ -1497,60 +1500,81 @@ void nsPop3Protocol::InitPrefAuthMethods</span>
<a href="#l6.178"></a><span id="l6.178">       m_prefAuthMethods = POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP;</span>
<a href="#l6.179"></a><span id="l6.179">       break;</span>
<a href="#l6.180"></a><span id="l6.180">     case nsMsgAuthMethod::NTLM:</span>
<a href="#l6.181"></a><span id="l6.181">       m_prefAuthMethods = POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l6.182"></a><span id="l6.182">       break;</span>
<a href="#l6.183"></a><span id="l6.183">     case nsMsgAuthMethod::GSSAPI:</span>
<a href="#l6.184"></a><span id="l6.184">       m_prefAuthMethods = POP3_HAS_AUTH_GSSAPI;</span>
<a href="#l6.185"></a><span id="l6.185">       break;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+    case nsMsgAuthMethod::OAuth2:</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_XOAUTH2;</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+      break;</span>
<a href="#l6.189"></a><span id="l6.189">     case nsMsgAuthMethod::secure:</span>
<a href="#l6.190"></a><span id="l6.190">       m_prefAuthMethods = POP3_HAS_AUTH_APOP | POP3_HAS_AUTH_CRAM_MD5 |</span>
<a href="#l6.191"></a><span id="l6.191">                           POP3_HAS_AUTH_GSSAPI | POP3_HAS_AUTH_NTLM |</span>
<a href="#l6.192"></a><span id="l6.192">                           POP3_HAS_AUTH_MSN;</span>
<a href="#l6.193"></a><span id="l6.193">       break;</span>
<a href="#l6.194"></a><span id="l6.194">     default:</span>
<a href="#l6.195"></a><span id="l6.195">       NS_ASSERTION(false, &quot;POP: authMethod pref invalid&quot;);</span>
<a href="#l6.196"></a><span id="l6.196">       // TODO log to error console</span>
<a href="#l6.197"></a><span id="l6.197">       MOZ_LOG(</span>
<a href="#l6.198"></a><span id="l6.198">           POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l6.199"></a><span id="l6.199">           (POP3LOG(&quot;POP: bad pref authMethod = %d\n&quot;), authMethodPrefValue));</span>
<a href="#l6.200"></a><span id="l6.200">       // fall to any</span>
<a href="#l6.201"></a><span id="l6.201">       [[fallthrough]];</span>
<a href="#l6.202"></a><span id="l6.202">     case nsMsgAuthMethod::anything:</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-      m_prefAuthMethods = POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN |</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-                          POP3_HAS_AUTH_PLAIN | POP3_HAS_AUTH_CRAM_MD5 |</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-                          POP3_HAS_AUTH_APOP | POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-                          POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+      m_prefAuthMethods =</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+          POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN | POP3_HAS_AUTH_PLAIN |</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+          POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP | POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+          POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN | POP3_HAS_AUTH_XOAUTH2;</span>
<a href="#l6.211"></a><span id="l6.211">       // TODO needed?</span>
<a href="#l6.212"></a><span id="l6.212">       break;</span>
<a href="#l6.213"></a><span id="l6.213">   }</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+  // Only enable OAuth2 support if we can do the lookup.</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+  if ((m_prefAuthMethods &amp; POP3_HAS_AUTH_XOAUTH2) &amp;&amp; !mOAuth2Support) {</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+    m_prefAuthMethods &amp;= ~POP3_HAS_AUTH_XOAUTH2;  // disable it</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+  }</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+</span>
<a href="#l6.220"></a><span id="l6.220">   NS_ASSERTION(m_prefAuthMethods != POP3_AUTH_MECH_UNDEFINED,</span>
<a href="#l6.221"></a><span id="l6.221">                &quot;POP: InitPrefAuthMethods() didn't work&quot;);</span>
<a href="#l6.222"></a><span id="l6.222"> }</span>
<a href="#l6.223"></a><span id="l6.223"> </span>
<a href="#l6.224"></a><span id="l6.224"> /**</span>
<a href="#l6.225"></a><span id="l6.225">  * Changes m_currentAuthMethod to pick the best one</span>
<a href="#l6.226"></a><span id="l6.226">  * which is allowed by server and prefs and not marked failed.</span>
<a href="#l6.227"></a><span id="l6.227">  * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l6.228"></a><span id="l6.228">  */</span>
<a href="#l6.229"></a><span id="l6.229"> nsresult nsPop3Protocol::ChooseAuthMethod() {</span>
<a href="#l6.230"></a><span id="l6.230">   int32_t availCaps = GetCapFlags() &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l6.231"></a><span id="l6.231"> </span>
<a href="#l6.232"></a><span id="l6.232">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l6.233"></a><span id="l6.233">           (POP3LOG(&quot;POP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail &quot;</span>
<a href="#l6.234"></a><span id="l6.234">                    &quot;caps 0x%X&quot;),</span>
<a href="#l6.235"></a><span id="l6.235">            GetCapFlags(), m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+          (POP3LOG(&quot;(GSSAPI = 0x%X, CRAM = 0x%X, APOP = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+                   &quot;MSN = 0x%X, PLAIN = 0x%X, LOGIN = 0x%X, USER/PASS = 0x%X, &quot;</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+                   &quot;XOAUTH2 = 0x%X)&quot;),</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+           POP3_HAS_AUTH_GSSAPI, POP3_HAS_AUTH_CRAM_MD5, POP3_HAS_AUTH_APOP,</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+           POP3_HAS_AUTH_NTLM, POP3_HAS_AUTH_MSN, POP3_HAS_AUTH_PLAIN,</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+           POP3_HAS_AUTH_LOGIN, POP3_HAS_AUTH_USER, POP3_HAS_AUTH_XOAUTH2));</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+</span>
<a href="#l6.244"></a><span id="l6.244">   MOZ_LOG(</span>
<a href="#l6.245"></a><span id="l6.245">       POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-      (POP3LOG(&quot;(GSSAPI = 0x%X, CRAM = 0x%X, APOP = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-               &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, USER/PASS = 0x%X)&quot;),</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-       POP3_HAS_AUTH_GSSAPI, POP3_HAS_AUTH_CRAM_MD5, POP3_HAS_AUTH_APOP,</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-       POP3_HAS_AUTH_NTLM, POP3_HAS_AUTH_MSN, POP3_HAS_AUTH_PLAIN,</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-       POP3_HAS_AUTH_LOGIN, POP3_HAS_AUTH_USER));</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+      (POP3LOG(&quot;(Ehabled - GSSAPI=%d, CRAM=%d, APOP=%d, NTLM=%d, &quot;</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+               &quot;MSN=%d, PLAIN=%d, LOGIN=%d, USER/PASS=%d, &quot;</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+               &quot;XOAUTH2=%d)&quot;),</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+       !!(POP3_HAS_AUTH_GSSAPI &amp; availCaps),</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+       !!(POP3_HAS_AUTH_CRAM_MD5 &amp; availCaps),</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+       !!(POP3_HAS_AUTH_APOP &amp; availCaps), !!(POP3_HAS_AUTH_NTLM &amp; availCaps),</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+       !!(POP3_HAS_AUTH_MSN &amp; availCaps), !!(POP3_HAS_AUTH_PLAIN &amp; availCaps),</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+       !!(POP3_HAS_AUTH_LOGIN &amp; availCaps), !!(POP3_HAS_AUTH_USER &amp; availCaps),</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+       !!(POP3_HAS_AUTH_XOAUTH2 &amp; availCaps)));</span>
<a href="#l6.260"></a><span id="l6.260"> </span>
<a href="#l6.261"></a><span id="l6.261">   if (POP3_HAS_AUTH_GSSAPI &amp; availCaps)</span>
<a href="#l6.262"></a><span id="l6.262">     m_currentAuthMethod = POP3_HAS_AUTH_GSSAPI;</span>
<a href="#l6.263"></a><span id="l6.263">   else if (POP3_HAS_AUTH_CRAM_MD5 &amp; availCaps)</span>
<a href="#l6.264"></a><span id="l6.264">     m_currentAuthMethod = POP3_HAS_AUTH_CRAM_MD5;</span>
<a href="#l6.265"></a><span id="l6.265">   else if (POP3_HAS_AUTH_APOP &amp; availCaps)</span>
<a href="#l6.266"></a><span id="l6.266">     m_currentAuthMethod = POP3_HAS_AUTH_APOP;</span>
<a href="#l6.267"></a><span id="l6.267">   else if (POP3_HAS_AUTH_NTLM &amp; availCaps)</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineat">@@ -1558,40 +1582,43 @@ nsresult nsPop3Protocol::ChooseAuthMetho</span>
<a href="#l6.269"></a><span id="l6.269">   else if (POP3_HAS_AUTH_MSN &amp; availCaps)</span>
<a href="#l6.270"></a><span id="l6.270">     m_currentAuthMethod = POP3_HAS_AUTH_MSN;</span>
<a href="#l6.271"></a><span id="l6.271">   else if (POP3_HAS_AUTH_PLAIN &amp; availCaps)</span>
<a href="#l6.272"></a><span id="l6.272">     m_currentAuthMethod = POP3_HAS_AUTH_PLAIN;</span>
<a href="#l6.273"></a><span id="l6.273">   else if (POP3_HAS_AUTH_LOGIN &amp; availCaps)</span>
<a href="#l6.274"></a><span id="l6.274">     m_currentAuthMethod = POP3_HAS_AUTH_LOGIN;</span>
<a href="#l6.275"></a><span id="l6.275">   else if (POP3_HAS_AUTH_USER &amp; availCaps)</span>
<a href="#l6.276"></a><span id="l6.276">     m_currentAuthMethod = POP3_HAS_AUTH_USER;</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+  else if (POP3_HAS_AUTH_XOAUTH2 &amp; availCaps)</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_XOAUTH2;</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+</span>
<a href="#l6.280"></a><span id="l6.280">   else {</span>
<a href="#l6.281"></a><span id="l6.281">     // there are no matching login schemes at all, per server and prefs</span>
<a href="#l6.282"></a><span id="l6.282">     m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l6.283"></a><span id="l6.283">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-            (POP3LOG(&quot;no auth method remaining&quot;)));</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+            (POP3LOG(&quot;No auth method remaining&quot;)));</span>
<a href="#l6.286"></a><span id="l6.286">     return NS_ERROR_FAILURE;</span>
<a href="#l6.287"></a><span id="l6.287">   }</span>
<a href="#l6.288"></a><span id="l6.288">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-          (POP3LOG(&quot;trying auth method 0x%X&quot;), m_currentAuthMethod));</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+          (POP3LOG(&quot;Trying auth method 0x%X&quot;), m_currentAuthMethod));</span>
<a href="#l6.291"></a><span id="l6.291">   return NS_OK;</span>
<a href="#l6.292"></a><span id="l6.292"> }</span>
<a href="#l6.293"></a><span id="l6.293"> </span>
<a href="#l6.294"></a><span id="l6.294"> void nsPop3Protocol::MarkAuthMethodAsFailed(int32_t failedAuthMethod) {</span>
<a href="#l6.295"></a><span id="l6.295">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-          (POP3LOG(&quot;marking auth method 0x%X failed&quot;), failedAuthMethod));</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+          (POP3LOG(&quot;Marking auth method 0x%X failed&quot;), failedAuthMethod));</span>
<a href="#l6.298"></a><span id="l6.298">   m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l6.299"></a><span id="l6.299"> }</span>
<a href="#l6.300"></a><span id="l6.300"> </span>
<a href="#l6.301"></a><span id="l6.301"> /**</span>
<a href="#l6.302"></a><span id="l6.302">  * Start over, trying all auth methods again</span>
<a href="#l6.303"></a><span id="l6.303">  */</span>
<a href="#l6.304"></a><span id="l6.304"> void nsPop3Protocol::ResetAuthMethods() {</span>
<a href="#l6.305"></a><span id="l6.305">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-          (POP3LOG(&quot;resetting (failed) auth methods&quot;)));</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+          (POP3LOG(&quot;Resetting (failed) auth methods&quot;)));</span>
<a href="#l6.308"></a><span id="l6.308">   m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l6.309"></a><span id="l6.309">   m_failedAuthMethods = 0;</span>
<a href="#l6.310"></a><span id="l6.310"> }</span>
<a href="#l6.311"></a><span id="l6.311"> </span>
<a href="#l6.312"></a><span id="l6.312"> /**</span>
<a href="#l6.313"></a><span id="l6.313">  * state POP3_PROCESS_AUTH</span>
<a href="#l6.314"></a><span id="l6.314">  * Called when we should try to authenticate to the server.</span>
<a href="#l6.315"></a><span id="l6.315">  * Also called when one auth method fails and we want to try and start</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineat">@@ -1680,39 +1707,87 @@ int32_t nsPop3Protocol::ProcessAuth() {</span>
<a href="#l6.317"></a><span id="l6.317">       MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP NTLM&quot;)));</span>
<a href="#l6.318"></a><span id="l6.318">       m_pop3ConData-&gt;next_state = POP3_AUTH_NTLM;</span>
<a href="#l6.319"></a><span id="l6.319">       break;</span>
<a href="#l6.320"></a><span id="l6.320">     case POP3_HAS_AUTH_NONE:</span>
<a href="#l6.321"></a><span id="l6.321">       MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP no auth&quot;)));</span>
<a href="#l6.322"></a><span id="l6.322">       m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l6.323"></a><span id="l6.323">       m_pop3ConData-&gt;next_state = POP3_NEXT_AUTH_STEP;</span>
<a href="#l6.324"></a><span id="l6.324">       break;</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+    case POP3_HAS_AUTH_XOAUTH2:</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP XOAUTH2&quot;)));</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+      m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_AUTH_OAUTH2_RESPONSE;</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+      break;</span>
<a href="#l6.330"></a><span id="l6.330">     default:</span>
<a href="#l6.331"></a><span id="l6.331">       MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l6.332"></a><span id="l6.332">               (POP3LOG(&quot;POP: m_currentAuthMethod has unknown value&quot;)));</span>
<a href="#l6.333"></a><span id="l6.333">       return Error(&quot;pop3AuthMechNotSupported&quot;);</span>
<a href="#l6.334"></a><span id="l6.334">   }</span>
<a href="#l6.335"></a><span id="l6.335"> </span>
<a href="#l6.336"></a><span id="l6.336">   m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+  return 0;</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+}</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+int32_t nsPop3Protocol::AuthOAuth2Response() {</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+  if (!mOAuth2Support) {</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+    return Error(&quot;pop3AuthMechNotSupported&quot;);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+  }</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+  nsresult rv = mOAuth2Support-&gt;Connect(true, this);</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+            (POP3LOG(&quot;OAuth2 authorizattion failed&quot;)));</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+    return -1;</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+  }</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.352"></a><span id="l6.352">   return 0;</span>
<a href="#l6.353"></a><span id="l6.353"> }</span>
<a href="#l6.354"></a><span id="l6.354"> </span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+/** msgIOAuth2ModuleListener implementation */</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+nsresult nsPop3Protocol::OnSuccess(const nsACString &amp;aOAuth2String) {</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+  MOZ_ASSERT(mOAuth2Support, &quot;Can't do anything without OAuth2 support&quot;);</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+  // Send the AUTH XOAUTH2 command, and then siphon us back to the regular</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+  // authentication login stream.</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+  nsAutoCString cmd;</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+  cmd.AppendLiteral(&quot;AUTH XOAUTH2 &quot;);</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+  cmd += aOAuth2String;</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+  cmd += CRLF;</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+  m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_RESPONSE;</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+  m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+  m_password_already_sent = true;</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+  if (Pop3SendData(cmd.get(), true)) {</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+            (POP3LOG(&quot;POP: XOAUTH2 authentication failed&quot;)));</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+  }</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+  ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+}</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+/** msgIOAuth2ModuleListener implementation */</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+nsresult nsPop3Protocol::OnFailure(nsresult aError) {</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug,</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+          (&quot;OAuth2 login error %08x&quot;, (uint32_t)aError));</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+  m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+  return ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+}</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+</span>
<a href="#l6.385"></a><span id="l6.385"> /**</span>
<a href="#l6.386"></a><span id="l6.386">  * state POP3_NEXT_AUTH_STEP</span>
<a href="#l6.387"></a><span id="l6.387">  * This is called when we finished one auth step (e.g. sending username</span>
<a href="#l6.388"></a><span id="l6.388">  * or password are separate steps, similarly for AUTH LOGIN, NTLM etc.)</span>
<a href="#l6.389"></a><span id="l6.389">  * and want to proceed to the next one.</span>
<a href="#l6.390"></a><span id="l6.390">  */</span>
<a href="#l6.391"></a><span id="l6.391"> int32_t nsPop3Protocol::NextAuthStep() {</span>
<a href="#l6.392"></a><span id="l6.392">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;NextAuthStep()&quot;)));</span>
<a href="#l6.393"></a><span id="l6.393">   if (m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l6.394"></a><span id="l6.394">     if (m_password_already_sent ||  // (also true for GSSAPI)</span>
<a href="#l6.395"></a><span id="l6.395">         m_currentAuthMethod == POP3_HAS_AUTH_NONE) {</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;login succeeded&quot;)));</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;Login succeeded&quot;)));</span>
<a href="#l6.398"></a><span id="l6.398">       m_nsIPop3Sink-&gt;SetUserAuthenticated(true);</span>
<a href="#l6.399"></a><span id="l6.399">       ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l6.400"></a><span id="l6.400">       if (m_pop3ConData-&gt;verify_logon)</span>
<a href="#l6.401"></a><span id="l6.401">         m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l6.402"></a><span id="l6.402">       else</span>
<a href="#l6.403"></a><span id="l6.403">         m_pop3ConData-&gt;next_state =</span>
<a href="#l6.404"></a><span id="l6.404">             (m_pop3ConData-&gt;get_url) ? POP3_SEND_GURL : POP3_SEND_STAT;</span>
<a href="#l6.405"></a><span id="l6.405">     } else</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineat">@@ -3516,16 +3591,20 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l6.407"></a><span id="l6.407">         UpdateStatus(&quot;hostContact&quot;);</span>
<a href="#l6.408"></a><span id="l6.408">         status = AuthGSSAPIResponse(true);</span>
<a href="#l6.409"></a><span id="l6.409">         break;</span>
<a href="#l6.410"></a><span id="l6.410"> </span>
<a href="#l6.411"></a><span id="l6.411">       case POP3_AUTH_GSSAPI_STEP:</span>
<a href="#l6.412"></a><span id="l6.412">         status = AuthGSSAPIResponse(false);</span>
<a href="#l6.413"></a><span id="l6.413">         break;</span>
<a href="#l6.414"></a><span id="l6.414"> </span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+      case POP3_AUTH_OAUTH2_RESPONSE:</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+        status = AuthOAuth2Response();</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+        break;</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+</span>
<a href="#l6.419"></a><span id="l6.419">       case POP3_SEND_USERNAME:</span>
<a href="#l6.420"></a><span id="l6.420">         if (NS_FAILED(</span>
<a href="#l6.421"></a><span id="l6.421">                 StartGetAsyncPassword(POP3_OBTAIN_PASSWORD_BEFORE_USERNAME)))</span>
<a href="#l6.422"></a><span id="l6.422">           status = -1;</span>
<a href="#l6.423"></a><span id="l6.423">         break;</span>
<a href="#l6.424"></a><span id="l6.424"> </span>
<a href="#l6.425"></a><span id="l6.425">       case POP3_OBTAIN_PASSWORD_BEFORE_USERNAME:</span>
<a href="#l6.426"></a><span id="l6.426">         status = -1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -12,16 +12,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIPop3Protocol.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIMsgFolder.h&quot;  // TO include biffState enum. Change to bool later...</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsIMsgAsyncPrompter.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIProtocolProxyCallback.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;msgIOAuth2Module.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;prerror.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;plhash.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> /* A more guaranteed way of making sure that we never get duplicate messages</span>
<a href="#l7.19"></a><span id="l7.19">    is to always get each message's UIDL (if the server supports it)</span>
<a href="#l7.20"></a><span id="l7.20">    and use these for storing up deletes which were not committed on the</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -45,21 +46,16 @@</span>
<a href="#l7.22"></a><span id="l7.22"> #define MK_OUT_OF_MEMORY -207</span>
<a href="#l7.23"></a><span id="l7.23"> #define MK_POP3_PASSWORD_UNDEFINED -313</span>
<a href="#l7.24"></a><span id="l7.24"> #define XP_NO_ANSWER 14401</span>
<a href="#l7.25"></a><span id="l7.25"> #define XP_THE_PREVIOUSLY_ENTERED_PASSWORD_IS_INVALID_ETC 14405</span>
<a href="#l7.26"></a><span id="l7.26"> #define XP_PASSWORD_FOR_POP3_USER 14590</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28"> #define OUTPUT_BUFFER_SIZE 8192  // maximum size of command string</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-/* structure to hold data pertaining to the active state of</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">- * a transfer in progress.</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">- *</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">- */</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-</span>
<a href="#l7.35"></a><span id="l7.35"> enum Pop3CapabilityEnum {</span>
<a href="#l7.36"></a><span id="l7.36">   POP3_CAPABILITY_UNDEFINED = 0x00000000,</span>
<a href="#l7.37"></a><span id="l7.37">   POP3_HAS_XSENDER = 0x00000001,</span>
<a href="#l7.38"></a><span id="l7.38">   POP3_GURL_UNDEFINED = 0x00000002,</span>
<a href="#l7.39"></a><span id="l7.39">   POP3_HAS_GURL = 0x00000004,</span>
<a href="#l7.40"></a><span id="l7.40">   POP3_UIDL_UNDEFINED = 0x00000008,</span>
<a href="#l7.41"></a><span id="l7.41">   POP3_HAS_UIDL = 0x00000010,</span>
<a href="#l7.42"></a><span id="l7.42">   POP3_XTND_XLST_UNDEFINED = 0x00000020,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineat">@@ -72,24 +68,29 @@ enum Pop3CapabilityEnum {</span>
<a href="#l7.44"></a><span id="l7.44">   POP3_HAS_AUTH_PLAIN = 0x00001000,</span>
<a href="#l7.45"></a><span id="l7.45">   POP3_HAS_AUTH_CRAM_MD5 = 0x00002000,</span>
<a href="#l7.46"></a><span id="l7.46">   POP3_HAS_AUTH_APOP = 0x00004000,</span>
<a href="#l7.47"></a><span id="l7.47">   POP3_HAS_AUTH_NTLM = 0x00008000,</span>
<a href="#l7.48"></a><span id="l7.48">   POP3_HAS_AUTH_MSN = 0x00010000,</span>
<a href="#l7.49"></a><span id="l7.49">   POP3_HAS_RESP_CODES = 0x00020000,</span>
<a href="#l7.50"></a><span id="l7.50">   POP3_HAS_AUTH_RESP_CODE = 0x00040000,</span>
<a href="#l7.51"></a><span id="l7.51">   POP3_HAS_STLS = 0x00080000,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  POP3_HAS_AUTH_GSSAPI = 0x00100000</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  POP3_HAS_AUTH_GSSAPI = 0x00100000,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  POP3_HAS_AUTH_XOAUTH2 = 0x00200000</span>
<a href="#l7.55"></a><span id="l7.55"> };</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57"> // TODO use value &gt; 0?</span>
<a href="#l7.58"></a><span id="l7.58"> #define POP3_HAS_AUTH_NONE 0</span>
<a href="#l7.59"></a><span id="l7.59"> #define POP3_HAS_AUTH_ANY 0x00001C00</span>
<a href="#l7.60"></a><span id="l7.60"> #define POP3_HAS_AUTH_ANY_SEC 0x0011E000</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+/**</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+ * Structure to hold data pertaining to the active state of a transfer in</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+ * progress.</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+ */</span>
<a href="#l7.66"></a><span id="l7.66"> enum Pop3StatesEnum {</span>
<a href="#l7.67"></a><span id="l7.67">   POP3_READ_PASSWORD,                          // 0</span>
<a href="#l7.68"></a><span id="l7.68">   POP3_START_CONNECT,                          // 1</span>
<a href="#l7.69"></a><span id="l7.69">   POP3_FINISH_CONNECT,                         // 2</span>
<a href="#l7.70"></a><span id="l7.70">   POP3_WAIT_FOR_RESPONSE,                      // 3</span>
<a href="#l7.71"></a><span id="l7.71">   POP3_WAIT_FOR_START_OF_CONNECTION_RESPONSE,  // 4</span>
<a href="#l7.72"></a><span id="l7.72">   POP3_SEND_USERNAME,                          // 5</span>
<a href="#l7.73"></a><span id="l7.73">   POP3_SEND_PASSWORD,                          // 6</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineat">@@ -137,17 +138,19 @@ enum Pop3StatesEnum {</span>
<a href="#l7.75"></a><span id="l7.75">    * The *PREOBTAIN* states are used for where we try and get the password</span>
<a href="#l7.76"></a><span id="l7.76">    * before we've initiated a connection to the server.</span>
<a href="#l7.77"></a><span id="l7.77">    */</span>
<a href="#l7.78"></a><span id="l7.78">   POP3_OBTAIN_PASSWORD_EARLY,                   // 45</span>
<a href="#l7.79"></a><span id="l7.79">   POP3_FINISH_OBTAIN_PASSWORD_EARLY,            // 46</span>
<a href="#l7.80"></a><span id="l7.80">   POP3_OBTAIN_PASSWORD_BEFORE_USERNAME,         // 47</span>
<a href="#l7.81"></a><span id="l7.81">   POP3_FINISH_OBTAIN_PASSWORD_BEFORE_USERNAME,  // 48</span>
<a href="#l7.82"></a><span id="l7.82">   POP3_OBTAIN_PASSWORD_BEFORE_PASSWORD,         // 49</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-  POP3_FINISH_OBTAIN_PASSWORD_BEFORE_PASSWORD   // 50</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  POP3_FINISH_OBTAIN_PASSWORD_BEFORE_PASSWORD,  // 50</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  POP3_AUTH_OAUTH2_RESPONSE,  // 51</span>
<a href="#l7.87"></a><span id="l7.87"> };</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89"> #define KEEP 'k'        /* If we want to keep this item on server. */</span>
<a href="#l7.90"></a><span id="l7.90"> #define DELETE_CHAR 'd' /* If we want to delete this item. */</span>
<a href="#l7.91"></a><span id="l7.91"> #define TOO_BIG 'b'     /* item left on server because it was too big */</span>
<a href="#l7.92"></a><span id="l7.92"> #define FETCH_BODY 'f'  /* Fetch full body of a partial msg */</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94"> typedef struct Pop3UidlEntry { /* information about this message */</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineat">@@ -234,21 +237,23 @@ typedef struct _Pop3ConData {</span>
<a href="#l7.96"></a><span id="l7.96"> #define POP3_PASSWORD_FAILED 0x00000002</span>
<a href="#l7.97"></a><span id="l7.97"> #define POP3_STOPLOGIN 0x00000004 /* error logging in, so stop here */</span>
<a href="#l7.98"></a><span id="l7.98"> #define POP3_AUTH_FAILURE \</span>
<a href="#l7.99"></a><span id="l7.99">   0x00000008 /* extended code said authentication failed */</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101"> class nsPop3Protocol : public nsMsgProtocol,</span>
<a href="#l7.102"></a><span id="l7.102">                        public nsIPop3Protocol,</span>
<a href="#l7.103"></a><span id="l7.103">                        public nsIMsgAsyncPromptListener,</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+                       public msgIOAuth2ModuleListener,</span>
<a href="#l7.105"></a><span id="l7.105">                        public nsIProtocolProxyCallback {</span>
<a href="#l7.106"></a><span id="l7.106">  public:</span>
<a href="#l7.107"></a><span id="l7.107">   explicit nsPop3Protocol(nsIURI* aURL);</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+  NS_DECL_MSGIOAUTH2MODULELISTENER</span>
<a href="#l7.111"></a><span id="l7.111">   NS_DECL_NSIPOP3PROTOCOL</span>
<a href="#l7.112"></a><span id="l7.112">   NS_DECL_NSIMSGASYNCPROMPTLISTENER</span>
<a href="#l7.113"></a><span id="l7.113">   NS_DECL_NSIPROTOCOLPROXYCALLBACK</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115">   nsresult Initialize(nsIURI* aURL);</span>
<a href="#l7.116"></a><span id="l7.116">   nsresult InitializeInternal(nsIProxyInfo* proxyInfo);</span>
<a href="#l7.117"></a><span id="l7.117">   virtual nsresult LoadUrl(nsIURI* aURL,</span>
<a href="#l7.118"></a><span id="l7.118">                            nsISupports* aConsumer = nullptr) override;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineat">@@ -354,16 +359,17 @@ class nsPop3Protocol : public nsMsgProto</span>
<a href="#l7.120"></a><span id="l7.120">   int32_t AuthResponse(nsIInputStream* inputStream, uint32_t length);</span>
<a href="#l7.121"></a><span id="l7.121">   int32_t SendCapa();</span>
<a href="#l7.122"></a><span id="l7.122">   int32_t CapaResponse(nsIInputStream* inputStream, uint32_t length);</span>
<a href="#l7.123"></a><span id="l7.123">   int32_t SendTLSResponse();</span>
<a href="#l7.124"></a><span id="l7.124">   int32_t ProcessAuth();</span>
<a href="#l7.125"></a><span id="l7.125">   int32_t NextAuthStep();</span>
<a href="#l7.126"></a><span id="l7.126">   int32_t AuthLogin();</span>
<a href="#l7.127"></a><span id="l7.127">   int32_t AuthLoginResponse();</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+  int32_t AuthOAuth2Response();</span>
<a href="#l7.129"></a><span id="l7.129">   int32_t AuthNtlm();</span>
<a href="#l7.130"></a><span id="l7.130">   int32_t AuthNtlmResponse();</span>
<a href="#l7.131"></a><span id="l7.131">   int32_t AuthGSSAPI();</span>
<a href="#l7.132"></a><span id="l7.132">   int32_t AuthGSSAPIResponse(bool first);</span>
<a href="#l7.133"></a><span id="l7.133">   int32_t SendUsername();</span>
<a href="#l7.134"></a><span id="l7.134">   int32_t SendPassword();</span>
<a href="#l7.135"></a><span id="l7.135">   int32_t SendStatOrGurl(bool sendStat);</span>
<a href="#l7.136"></a><span id="l7.136">   int32_t SendStat();</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineat">@@ -386,11 +392,15 @@ class nsPop3Protocol : public nsMsgProto</span>
<a href="#l7.138"></a><span id="l7.138">   int32_t RetrResponse(nsIInputStream* inputStream, uint32_t length);</span>
<a href="#l7.139"></a><span id="l7.139">   int32_t TopResponse(nsIInputStream* inputStream, uint32_t length);</span>
<a href="#l7.140"></a><span id="l7.140">   int32_t SendDele();</span>
<a href="#l7.141"></a><span id="l7.141">   int32_t DeleResponse();</span>
<a href="#l7.142"></a><span id="l7.142">   int32_t CommitState(bool remove_last_entry);</span>
<a href="#l7.143"></a><span id="l7.143"> </span>
<a href="#l7.144"></a><span id="l7.144">   Pop3StatesEnum GetNextPasswordObtainState();</span>
<a href="#l7.145"></a><span id="l7.145">   nsresult RerunUrl();</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  // The support module for OAuth2 logon, only present if OAuth2 is enabled</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+  // and working.</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+  nsCOMPtr&lt;msgIOAuth2Module&gt; mOAuth2Support;</span>
<a href="#l7.150"></a><span id="l7.150"> };</span>
<a href="#l7.151"></a><span id="l7.151"> </span>
<a href="#l7.152"></a><span id="l7.152"> #endif /* nsPop3Protocol_h__ */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

