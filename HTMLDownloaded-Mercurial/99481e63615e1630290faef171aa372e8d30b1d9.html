<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11701:99481e63615e1630290faef171aa372e8d30b1d9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 99481e63615e1630290faef171aa372e8d30b1d9" />
<meta property="og:url" content="/comm-central/rev/99481e63615e1630290faef171aa372e8d30b1d9" />
<meta property="og:description" content="Bug 794909 - Switch to Services.jsm: Compose code. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 99481e63615e1630290faef171aa372e8d30b1d9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/99481e63615e1630290faef171aa372e8d30b1d9">shortlog</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/99481e63615e1630290faef171aa372e8d30b1d9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9">files</a> |
changeset |
<a href="/comm-central/raw-rev/99481e63615e1630290faef171aa372e8d30b1d9">raw</a>  | <a href="/comm-central/archive/99481e63615e1630290faef171aa372e8d30b1d9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=794909">Bug 794909</a> - Switch to Services.jsm: Compose code. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 13 Dec 2012 21:19:27 +0100</td></tr>

<tr>
 <td>changeset 11701</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/99481e63615e1630290faef171aa372e8d30b1d9">99481e63615e1630290faef171aa372e8d30b1d9</a></td>
</tr>



<tr>
<td>parent 11700</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/79a73f336716eb9b780cbe4627d9f6fc981b48f9">79a73f336716eb9b780cbe4627d9f6fc981b48f9</a>
</td>
</tr>

<tr>
<td>child 11702</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4379140e4ffc8578ab682619493561765e02f230">4379140e4ffc8578ab682619493561765e02f230</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=99481e63615e1630290faef171aa372e8d30b1d9">8716</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 17 Dec 2012 00:04:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a6e24ded8c28 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a6e24ded8c28130c9659f47a74bc193478e756af">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a6e24ded8c28130c9659f47a74bc193478e756af&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=794909">794909</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=794909">Bug 794909</a> - Switch to Services.jsm: Compose code. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mail/test/mozmill/shared-modules/test-prompt-helpers.js">mail/test/mozmill/shared-modules/test-prompt-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mail/test/mozmill/shared-modules/test-prompt-helpers.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mail/test/mozmill/shared-modules/test-prompt-helpers.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mail/test/mozmill/shared-modules/test-prompt-helpers.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mail/test/mozmill/shared-modules/test-prompt-helpers.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mail/test/mozmill/shared-modules/test-prompt-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/content/mailComposeEditorOverlay.xul">mailnews/compose/content/mailComposeEditorOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/content/mailComposeEditorOverlay.xul">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/content/mailComposeEditorOverlay.xul">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/content/mailComposeEditorOverlay.xul">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/content/mailComposeEditorOverlay.xul">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/content/mailComposeEditorOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_bug235432.js">mailnews/compose/test/unit/test_bug235432.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_bug235432.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_bug235432.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_bug235432.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_bug235432.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_bug235432.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPassword2.js">mailnews/compose/test/unit/test_smtpPassword2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPassword2.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPassword2.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPassword2.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPassword2.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPassword2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">mailnews/compose/test/unit/test_smtpPasswordFailure1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">mailnews/compose/test/unit/test_smtpPasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">mailnews/compose/test/unit/test_smtpPasswordFailure3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">mailnews/compose/test/unit/test_temporaryFilesRemoved.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">file</a> |
<a href="/comm-central/annotate/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">annotate</a> |
<a href="/comm-central/diff/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">diff</a> |
<a href="/comm-central/comparison/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">comparison</a> |
<a href="/comm-central/log/99481e63615e1630290faef171aa372e8d30b1d9/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -49,26 +49,23 @@ var gMessenger = Components.classes[&quot;@mo</span>
<a href="#l1.4"></a><span id="l1.4"> var gSpellChecker = new InlineSpellChecker();</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> /**</span>
<a href="#l1.7"></a><span id="l1.7">  * Global variables, need to be re-initialized every time mostly because we need to release them when the window close</span>
<a href="#l1.8"></a><span id="l1.8">  */</span>
<a href="#l1.9"></a><span id="l1.9"> var gHideMenus;</span>
<a href="#l1.10"></a><span id="l1.10"> var gMsgCompose;</span>
<a href="#l1.11"></a><span id="l1.11"> var gAccountManager;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var gIOService;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-var gPromptService;</span>
<a href="#l1.14"></a><span id="l1.14"> var gWindowLocked;</span>
<a href="#l1.15"></a><span id="l1.15"> var gContentChanged;</span>
<a href="#l1.16"></a><span id="l1.16"> var gAutoSaving;</span>
<a href="#l1.17"></a><span id="l1.17"> var gCurrentIdentity;</span>
<a href="#l1.18"></a><span id="l1.18"> var defaultSaveOperation;</span>
<a href="#l1.19"></a><span id="l1.19"> var gSendOrSaveOperationInProgress;</span>
<a href="#l1.20"></a><span id="l1.20"> var gCloseWindowAfterSave;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-var gIsOffline;</span>
<a href="#l1.22"></a><span id="l1.22"> var gSessionAdded;</span>
<a href="#l1.23"></a><span id="l1.23"> var gCurrentAutocompleteDirectory;</span>
<a href="#l1.24"></a><span id="l1.24"> var gSetupLdapAutocomplete;</span>
<a href="#l1.25"></a><span id="l1.25"> var gLDAPSession;</span>
<a href="#l1.26"></a><span id="l1.26"> var gSavedSendNowKey;</span>
<a href="#l1.27"></a><span id="l1.27"> var gSendFormat;</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> var gMsgIdentityElement;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineat">@@ -110,28 +107,25 @@ var gEditingDraft;</span>
<a href="#l1.31"></a><span id="l1.31"> var gAttachmentsSize;</span>
<a href="#l1.32"></a><span id="l1.32"> var gNumUploadingAttachments;</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34"> const kComposeAttachDirPrefName = &quot;mail.compose.attach.dir&quot;;</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36"> function InitializeGlobalVariables()</span>
<a href="#l1.37"></a><span id="l1.37"> {</span>
<a href="#l1.38"></a><span id="l1.38">   gAccountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-  gIOService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-  gPromptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService(Components.interfaces.nsIPromptService);</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">   gMsgCompose = null;</span>
<a href="#l1.43"></a><span id="l1.43">   gWindowLocked = false;</span>
<a href="#l1.44"></a><span id="l1.44">   gContentChanged = false;</span>
<a href="#l1.45"></a><span id="l1.45">   gCurrentIdentity = null;</span>
<a href="#l1.46"></a><span id="l1.46">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l1.47"></a><span id="l1.47">   gSendOrSaveOperationInProgress = false;</span>
<a href="#l1.48"></a><span id="l1.48">   gAutoSaving = false;</span>
<a href="#l1.49"></a><span id="l1.49">   gCloseWindowAfterSave = false;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-  gIsOffline = gIOService.offline;</span>
<a href="#l1.51"></a><span id="l1.51">   gSessionAdded = false;</span>
<a href="#l1.52"></a><span id="l1.52">   gCurrentAutocompleteDirectory = null;</span>
<a href="#l1.53"></a><span id="l1.53">   gSetupLdapAutocomplete = false;</span>
<a href="#l1.54"></a><span id="l1.54">   gLDAPSession = null;</span>
<a href="#l1.55"></a><span id="l1.55">   gSavedSendNowKey = null;</span>
<a href="#l1.56"></a><span id="l1.56">   gSendFormat = nsIMsgCompSendFormat.AskUser;</span>
<a href="#l1.57"></a><span id="l1.57">   gSendDefaultCharset = null;</span>
<a href="#l1.58"></a><span id="l1.58">   gCharsetTitle = null;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineat">@@ -147,18 +141,16 @@ function InitializeGlobalVariables()</span>
<a href="#l1.60"></a><span id="l1.60">   gAttachmentsSize = 0;</span>
<a href="#l1.61"></a><span id="l1.61">   gNumUploadingAttachments = 0;</span>
<a href="#l1.62"></a><span id="l1.62"> }</span>
<a href="#l1.63"></a><span id="l1.63"> InitializeGlobalVariables();</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65"> function ReleaseGlobalVariables()</span>
<a href="#l1.66"></a><span id="l1.66"> {</span>
<a href="#l1.67"></a><span id="l1.67">   gAccountManager = null;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-  gIOService = null;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-  gPromptService = null;</span>
<a href="#l1.70"></a><span id="l1.70">   gCurrentIdentity = null;</span>
<a href="#l1.71"></a><span id="l1.71">   gCurrentAutocompleteDirectory = null;</span>
<a href="#l1.72"></a><span id="l1.72">   if (gLDAPSession) {</span>
<a href="#l1.73"></a><span id="l1.73">     gLDAPSession = null;</span>
<a href="#l1.74"></a><span id="l1.74">     Components.utils.forceGC();</span>
<a href="#l1.75"></a><span id="l1.75">   }</span>
<a href="#l1.76"></a><span id="l1.76">   gCharsetConvertManager = null;</span>
<a href="#l1.77"></a><span id="l1.77">   gMsgCompose = null;</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineat">@@ -476,26 +468,27 @@ var defaultController = {</span>
<a href="#l1.79"></a><span id="l1.79">       }</span>
<a href="#l1.80"></a><span id="l1.80">     },</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">     cmd_sendButton: {</span>
<a href="#l1.83"></a><span id="l1.83">       isEnabled: function() {</span>
<a href="#l1.84"></a><span id="l1.84">         return !gWindowLocked &amp;&amp; !gNumUploadingAttachments;</span>
<a href="#l1.85"></a><span id="l1.85">       },</span>
<a href="#l1.86"></a><span id="l1.86">       doCommand: function() {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-        if (gIOService &amp;&amp; gIOService.offline)</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+        if (Services.io.offline)</span>
<a href="#l1.89"></a><span id="l1.89">           SendMessageLater();</span>
<a href="#l1.90"></a><span id="l1.90">         else</span>
<a href="#l1.91"></a><span id="l1.91">           SendMessage();</span>
<a href="#l1.92"></a><span id="l1.92">       }</span>
<a href="#l1.93"></a><span id="l1.93">     },</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95">     cmd_sendNow: {</span>
<a href="#l1.96"></a><span id="l1.96">       isEnabled: function() {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-        return !gWindowLocked &amp;&amp; !gIsOffline &amp;&amp; !gNumUploadingAttachments;</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+        return !gWindowLocked &amp;&amp; !Services.io.offline &amp;&amp;</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+               !gNumUploadingAttachments;</span>
<a href="#l1.100"></a><span id="l1.100">       },</span>
<a href="#l1.101"></a><span id="l1.101">       doCommand: function() {</span>
<a href="#l1.102"></a><span id="l1.102">         SendMessage();</span>
<a href="#l1.103"></a><span id="l1.103">       }</span>
<a href="#l1.104"></a><span id="l1.104">     },</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">     cmd_sendLater: {</span>
<a href="#l1.107"></a><span id="l1.107">       isEnabled: function() {</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineat">@@ -1154,24 +1147,23 @@ uploadListener.prototype = {</span>
<a href="#l1.109"></a><span id="l1.109">         title = bundle.getString(&quot;errorCloudFileOther.title&quot;);</span>
<a href="#l1.110"></a><span id="l1.110">         msg = bundle.getFormattedString(&quot;errorCloudFileOther.message&quot;,</span>
<a href="#l1.111"></a><span id="l1.111">                                         [displayName]);</span>
<a href="#l1.112"></a><span id="l1.112">         break;</span>
<a href="#l1.113"></a><span id="l1.113">       }</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115">       // TODO: support actions other than &quot;Upgrade&quot;</span>
<a href="#l1.116"></a><span id="l1.116">       if (displayError) {</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-        const prompt = Services.prompt;</span>
<a href="#l1.118"></a><span id="l1.118">         let url = this.cloudProvider.providerUrlForError(aStatusCode);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-        let flags = prompt.BUTTON_POS_0 * prompt.BUTTON_TITLE_OK;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+        let flags = Services.prompt.BUTTON_POS_0 * Services.prompt.BUTTON_TITLE_OK;</span>
<a href="#l1.121"></a><span id="l1.121">         if (url)</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-          flags += prompt.BUTTON_POS_1 * prompt.BUTTON_TITLE_IS_STRING;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-        if (prompt.confirmEx(window, title, msg, flags, null,</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-                             bundle.getString(&quot;errorCloudFileUpgrade.label&quot;),</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-                             null, null, {})) {</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+          flags += Services.prompt.BUTTON_POS_1 * Services.prompt.BUTTON_TITLE_IS_STRING;</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+        if (Services.prompt.confirmEx(window, title, msg, flags, null,</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+                                      bundle.getString(&quot;errorCloudFileUpgrade.label&quot;),</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+                                      null, null, {})) {</span>
<a href="#l1.130"></a><span id="l1.130">           openLinkExternally(url);</span>
<a href="#l1.131"></a><span id="l1.131">         }</span>
<a href="#l1.132"></a><span id="l1.132">       }</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134">       if (attachmentItem) {</span>
<a href="#l1.135"></a><span id="l1.135">         // Remove the loading throbber.</span>
<a href="#l1.136"></a><span id="l1.136">         attachmentItem.image = null;</span>
<a href="#l1.137"></a><span id="l1.137">         attachmentItem.setAttribute(&quot;tooltiptext&quot;, attachmentItem.attachment.url);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineat">@@ -1439,18 +1431,17 @@ function updateOptionItems()</span>
<a href="#l1.139"></a><span id="l1.139">  */</span>
<a href="#l1.140"></a><span id="l1.140"> var messageComposeOfflineQuitObserver =</span>
<a href="#l1.141"></a><span id="l1.141"> {</span>
<a href="#l1.142"></a><span id="l1.142">   observe: function(aSubject, aTopic, aData)</span>
<a href="#l1.143"></a><span id="l1.143">   {</span>
<a href="#l1.144"></a><span id="l1.144">     // sanity checks</span>
<a href="#l1.145"></a><span id="l1.145">     if (aTopic == &quot;network:offline-status-changed&quot;)</span>
<a href="#l1.146"></a><span id="l1.146">     {</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-      gIsOffline = aData == &quot;offline&quot;;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-      MessageComposeOfflineStateChanged(gIsOffline);</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+      MessageComposeOfflineStateChanged(Services.io.offline);</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151">       try {</span>
<a href="#l1.152"></a><span id="l1.152">         setupLdapAutocompleteSession();</span>
<a href="#l1.153"></a><span id="l1.153">       } catch (ex) {</span>
<a href="#l1.154"></a><span id="l1.154">         // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l1.155"></a><span id="l1.155">         // fails, the entire compose window stuff doesn't get aborted</span>
<a href="#l1.156"></a><span id="l1.156">       }</span>
<a href="#l1.157"></a><span id="l1.157">     }</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineat">@@ -1465,19 +1456,18 @@ var messageComposeOfflineQuitObserver =</span>
<a href="#l1.159"></a><span id="l1.159"> </span>
<a href="#l1.160"></a><span id="l1.160"> function AddMessageComposeOfflineQuitObserver()</span>
<a href="#l1.161"></a><span id="l1.161"> {</span>
<a href="#l1.162"></a><span id="l1.162">   Services.obs.addObserver(messageComposeOfflineQuitObserver,</span>
<a href="#l1.163"></a><span id="l1.163">                            &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l1.164"></a><span id="l1.164">   Services.obs.addObserver(messageComposeOfflineQuitObserver,</span>
<a href="#l1.165"></a><span id="l1.165">                            &quot;quit-application-requested&quot;, false);</span>
<a href="#l1.166"></a><span id="l1.166"> </span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-  gIsOffline = gIOService.offline;</span>
<a href="#l1.168"></a><span id="l1.168">   // set the initial state of the send button</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-  MessageComposeOfflineStateChanged(gIsOffline);</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+  MessageComposeOfflineStateChanged(Services.io.offline);</span>
<a href="#l1.171"></a><span id="l1.171"> }</span>
<a href="#l1.172"></a><span id="l1.172"> </span>
<a href="#l1.173"></a><span id="l1.173"> function RemoveMessageComposeOfflineQuitObserver()</span>
<a href="#l1.174"></a><span id="l1.174"> {</span>
<a href="#l1.175"></a><span id="l1.175">   Services.obs.removeObserver(messageComposeOfflineQuitObserver,</span>
<a href="#l1.176"></a><span id="l1.176">                               &quot;network:offline-status-changed&quot;);</span>
<a href="#l1.177"></a><span id="l1.177">   Services.obs.removeObserver(messageComposeOfflineQuitObserver,</span>
<a href="#l1.178"></a><span id="l1.178">                               &quot;quit-application-requested&quot;);</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineat">@@ -1521,65 +1511,57 @@ var directoryServerObserver = {</span>
<a href="#l1.180"></a><span id="l1.180">       } catch (ex) {</span>
<a href="#l1.181"></a><span id="l1.181">           // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l1.182"></a><span id="l1.182">           // fails, the entire compose window doesn't get horked</span>
<a href="#l1.183"></a><span id="l1.183">       }</span>
<a href="#l1.184"></a><span id="l1.184">   }</span>
<a href="#l1.185"></a><span id="l1.185"> }</span>
<a href="#l1.186"></a><span id="l1.186"> </span>
<a href="#l1.187"></a><span id="l1.187"> function AddDirectoryServerObserver(flag) {</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-                         .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.190"></a><span id="l1.190">   if (flag) {</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-    branch.addObserver(&quot;ldap_2.autoComplete.useDirectory&quot;,</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-                       directoryServerObserver, false);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-    branch.addObserver(&quot;ldap_2.autoComplete.directoryServer&quot;,</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-                       directoryServerObserver, false);</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+    Services.prefs.addObserver(&quot;ldap_2.autoComplete.useDirectory&quot;,</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+                               directoryServerObserver, false);</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+    Services.prefs.addObserver(&quot;ldap_2.autoComplete.directoryServer&quot;,</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+                               directoryServerObserver, false);</span>
<a href="#l1.199"></a><span id="l1.199">   }</span>
<a href="#l1.200"></a><span id="l1.200">   else</span>
<a href="#l1.201"></a><span id="l1.201">   {</span>
<a href="#l1.202"></a><span id="l1.202">     var prefstring = &quot;mail.identity.&quot; + gCurrentIdentity.key + &quot;.overrideGlobal_Pref&quot;;</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-    branch.addObserver(prefstring, directoryServerObserver, false);</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+    Services.prefs.addObserver(prefstring, directoryServerObserver, false);</span>
<a href="#l1.205"></a><span id="l1.205">     prefstring = &quot;mail.identity.&quot; + gCurrentIdentity.key + &quot;.directoryServer&quot;;</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-    branch.addObserver(prefstring, directoryServerObserver, false);</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+    Services.prefs.addObserver(prefstring, directoryServerObserver, false);</span>
<a href="#l1.208"></a><span id="l1.208">   }</span>
<a href="#l1.209"></a><span id="l1.209"> }</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211"> function RemoveDirectoryServerObserver(prefstring)</span>
<a href="#l1.212"></a><span id="l1.212"> {</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-  var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-                         .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.215"></a><span id="l1.215">   if (!prefstring) {</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-    branch.removeObserver(&quot;ldap_2.autoComplete.useDirectory&quot;,</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-                          directoryServerObserver);</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-    branch.removeObserver(&quot;ldap_2.autoComplete.directoryServer&quot;,</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-                          directoryServerObserver);</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+    Services.prefs.removeObserver(&quot;ldap_2.autoComplete.useDirectory&quot;,</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+                                  directoryServerObserver);</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+    Services.prefs.removeObserver(&quot;ldap_2.autoComplete.directoryServer&quot;,</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+                                  directoryServerObserver);</span>
<a href="#l1.224"></a><span id="l1.224">   }</span>
<a href="#l1.225"></a><span id="l1.225">   else</span>
<a href="#l1.226"></a><span id="l1.226">   {</span>
<a href="#l1.227"></a><span id="l1.227">     var str = prefstring + &quot;.overrideGlobal_Pref&quot;;</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-    branch.removeObserver(str, directoryServerObserver);</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+    Services.prefs.removeObserver(str, directoryServerObserver);</span>
<a href="#l1.230"></a><span id="l1.230">     str = prefstring + &quot;.directoryServer&quot;;</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-    branch.removeObserver(str, directoryServerObserver);</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+    Services.prefs.removeObserver(str, directoryServerObserver);</span>
<a href="#l1.233"></a><span id="l1.233">   }</span>
<a href="#l1.234"></a><span id="l1.234"> }</span>
<a href="#l1.235"></a><span id="l1.235"> </span>
<a href="#l1.236"></a><span id="l1.236"> function AddDirectorySettingsObserver()</span>
<a href="#l1.237"></a><span id="l1.237"> {</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-  var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-                         .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-  branch.addObserver(gCurrentAutocompleteDirectory, directoryServerObserver,</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-                     false);</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+  Services.prefs.addObserver(gCurrentAutocompleteDirectory, directoryServerObserver,</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+                             false);</span>
<a href="#l1.244"></a><span id="l1.244"> }</span>
<a href="#l1.245"></a><span id="l1.245"> </span>
<a href="#l1.246"></a><span id="l1.246"> function RemoveDirectorySettingsObserver(prefstring)</span>
<a href="#l1.247"></a><span id="l1.247"> {</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-  var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-                         .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-  branch.removeObserver(prefstring, directoryServerObserver);</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+  Services.prefs.removeObserver(prefstring, directoryServerObserver);</span>
<a href="#l1.252"></a><span id="l1.252"> }</span>
<a href="#l1.253"></a><span id="l1.253"> </span>
<a href="#l1.254"></a><span id="l1.254"> function setupLdapAutocompleteSession()</span>
<a href="#l1.255"></a><span id="l1.255"> {</span>
<a href="#l1.256"></a><span id="l1.256">     var autocompleteLdap = false;</span>
<a href="#l1.257"></a><span id="l1.257">     var autocompleteDirectory = null;</span>
<a href="#l1.258"></a><span id="l1.258">     var prevAutocompleteDirectory = gCurrentAutocompleteDirectory;</span>
<a href="#l1.259"></a><span id="l1.259"> </span>
<a href="#l1.260"></a><span id="l1.260" class="difflineat">@@ -1605,17 +1587,17 @@ function setupLdapAutocompleteSession()</span>
<a href="#l1.261"></a><span id="l1.261">         if (LDAPSession) {</span>
<a href="#l1.262"></a><span id="l1.262">           try {</span>
<a href="#l1.263"></a><span id="l1.263">             LDAPSession = LDAPSession.createInstance()</span>
<a href="#l1.264"></a><span id="l1.264">                 .QueryInterface(Components.interfaces.nsILDAPAutoCompleteSession);</span>
<a href="#l1.265"></a><span id="l1.265">           } catch (ex) {dump (&quot;ERROR: Cannot get the LDAP autocomplete session\n&quot; + ex + &quot;\n&quot;);}</span>
<a href="#l1.266"></a><span id="l1.266">         }</span>
<a href="#l1.267"></a><span id="l1.267">     }</span>
<a href="#l1.268"></a><span id="l1.268"> </span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-    if (autocompleteDirectory &amp;&amp; !gIsOffline) {</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+    if (autocompleteDirectory &amp;&amp; !Services.io.offline) {</span>
<a href="#l1.271"></a><span id="l1.271">         // Add observer on the directory server we are autocompleting against</span>
<a href="#l1.272"></a><span id="l1.272">         // only if current server is different from previous.</span>
<a href="#l1.273"></a><span id="l1.273">         // Remove observer if current server is different from previous</span>
<a href="#l1.274"></a><span id="l1.274">         gCurrentAutocompleteDirectory = autocompleteDirectory;</span>
<a href="#l1.275"></a><span id="l1.275">         if (prevAutocompleteDirectory) {</span>
<a href="#l1.276"></a><span id="l1.276">           if (prevAutocompleteDirectory != gCurrentAutocompleteDirectory) {</span>
<a href="#l1.277"></a><span id="l1.277">             RemoveDirectorySettingsObserver(prevAutocompleteDirectory);</span>
<a href="#l1.278"></a><span id="l1.278">             AddDirectorySettingsObserver();</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineat">@@ -1624,33 +1606,31 @@ function setupLdapAutocompleteSession()</span>
<a href="#l1.280"></a><span id="l1.280">         else</span>
<a href="#l1.281"></a><span id="l1.281">           AddDirectorySettingsObserver();</span>
<a href="#l1.282"></a><span id="l1.282"> </span>
<a href="#l1.283"></a><span id="l1.283">         // fill in the session params if there is a session</span>
<a href="#l1.284"></a><span id="l1.284">         //</span>
<a href="#l1.285"></a><span id="l1.285">         if (LDAPSession) {</span>
<a href="#l1.286"></a><span id="l1.286">             let url = getPref(autocompleteDirectory + &quot;.uri&quot;, true);</span>
<a href="#l1.287"></a><span id="l1.287"> </span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-            LDAPSession.serverURL =</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-              Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-                        .getService(Components.interfaces.nsIIOService)</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-                        .newURI(url, null, null)</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-                        .QueryInterface(Components.interfaces.nsILDAPURL);</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+            LDAPSession.serverURL = Services.io</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+                                            .newURI(url, null, null)</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+                                            .QueryInterface(Components.interfaces.nsILDAPURL);</span>
<a href="#l1.296"></a><span id="l1.296"> </span>
<a href="#l1.297"></a><span id="l1.297">             // get the login to authenticate as, if there is one</span>
<a href="#l1.298"></a><span id="l1.298">             //</span>
<a href="#l1.299"></a><span id="l1.299">             try {</span>
<a href="#l1.300"></a><span id="l1.300">                 LDAPSession.login = getPref(autocompleteDirectory + &quot;.auth.dn&quot;, true);</span>
<a href="#l1.301"></a><span id="l1.301">             } catch (ex) {</span>
<a href="#l1.302"></a><span id="l1.302">                 // if we don't have this pref, no big deal</span>
<a href="#l1.303"></a><span id="l1.303">             }</span>
<a href="#l1.304"></a><span id="l1.304"> </span>
<a href="#l1.305"></a><span id="l1.305">             try {</span>
<a href="#l1.306"></a><span id="l1.306">                  LDAPSession.saslMechanism = getPref(autocompleteDirectory +</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-		    &quot;.auth.saslmech&quot;, true);</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+                                                     &quot;.auth.saslmech&quot;, true);</span>
<a href="#l1.309"></a><span id="l1.309">             } catch (ex) {</span>
<a href="#l1.310"></a><span id="l1.310">                 // don't care if we don't have this pref</span>
<a href="#l1.311"></a><span id="l1.311">             }</span>
<a href="#l1.312"></a><span id="l1.312"> </span>
<a href="#l1.313"></a><span id="l1.313">             // set the LDAP protocol version correctly</span>
<a href="#l1.314"></a><span id="l1.314">             var protocolVersion;</span>
<a href="#l1.315"></a><span id="l1.315">             try {</span>
<a href="#l1.316"></a><span id="l1.316">                 protocolVersion = getPref(autocompleteDirectory +</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineat">@@ -1958,20 +1938,20 @@ function ComposeFieldsReady()</span>
<a href="#l1.318"></a><span id="l1.318">   updateEditableFields(false);</span>
<a href="#l1.319"></a><span id="l1.319"> }</span>
<a href="#l1.320"></a><span id="l1.320"> </span>
<a href="#l1.321"></a><span id="l1.321"> // checks if the passed in string is a mailto url, if it is, generates nsIMsgComposeParams</span>
<a href="#l1.322"></a><span id="l1.322"> // for the url and returns them.</span>
<a href="#l1.323"></a><span id="l1.323"> function handleMailtoArgs(mailtoUrl)</span>
<a href="#l1.324"></a><span id="l1.324"> {</span>
<a href="#l1.325"></a><span id="l1.325">   // see if the string is a mailto url....do this by checking the first 7 characters of the string</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-  if (/^mailto:/i.test(mailtoUrl))</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+  if (mailtoUrl.startsWith(&quot;mailto:&quot;))</span>
<a href="#l1.328"></a><span id="l1.328">   {</span>
<a href="#l1.329"></a><span id="l1.329">     // if it is a mailto url, turn the mailto url into a MsgComposeParams object....</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-    var uri = gIOService.newURI(mailtoUrl, null, null);</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+    let uri = Services.io.newURI(mailtoUrl, null, null);</span>
<a href="#l1.332"></a><span id="l1.332"> </span>
<a href="#l1.333"></a><span id="l1.333">     if (uri) {</span>
<a href="#l1.334"></a><span id="l1.334">       var composeSvc = Components.classes[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l1.335"></a><span id="l1.335">                                  .getService(Components.interfaces.nsIMsgComposeService);</span>
<a href="#l1.336"></a><span id="l1.336">       return composeSvc.getParamsForMailto(uri);</span>
<a href="#l1.337"></a><span id="l1.337">     }</span>
<a href="#l1.338"></a><span id="l1.338">   }</span>
<a href="#l1.339"></a><span id="l1.339"> </span>
<a href="#l1.340"></a><span id="l1.340" class="difflineat">@@ -2272,17 +2252,17 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l1.341"></a><span id="l1.341">             attachment.url = uri.spec;</span>
<a href="#l1.342"></a><span id="l1.342">             composeFields.addAttachment(attachment);</span>
<a href="#l1.343"></a><span id="l1.343">           }</span>
<a href="#l1.344"></a><span id="l1.344">           else</span>
<a href="#l1.345"></a><span id="l1.345">           {</span>
<a href="#l1.346"></a><span id="l1.346">             let title = getComposeBundle().getString(&quot;errorFileAttachTitle&quot;);</span>
<a href="#l1.347"></a><span id="l1.347">             let msg = getComposeBundle().getFormattedString(&quot;errorFileAttachMessage&quot;,</span>
<a href="#l1.348"></a><span id="l1.348">                                                         [attachmentName]);</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-            gPromptService.alert(window, title, msg);</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+            Services.prompt.alert(window, title, msg);</span>
<a href="#l1.351"></a><span id="l1.351">           }</span>
<a href="#l1.352"></a><span id="l1.352">         }</span>
<a href="#l1.353"></a><span id="l1.353">       }</span>
<a href="#l1.354"></a><span id="l1.354">       if (args.newshost)</span>
<a href="#l1.355"></a><span id="l1.355">         composeFields.newshost = args.newshost;</span>
<a href="#l1.356"></a><span id="l1.356">       if (args.body)</span>
<a href="#l1.357"></a><span id="l1.357">          composeFields.body = args.body;</span>
<a href="#l1.358"></a><span id="l1.358">     }</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineat">@@ -2514,18 +2494,18 @@ function ComposeLoad()</span>
<a href="#l1.360"></a><span id="l1.360">       for (let i = 0; i &lt; other_headers_Array.length; i++)</span>
<a href="#l1.361"></a><span id="l1.361">         selectNode.appendItem(other_headers_Array[i] + &quot;:&quot;, &quot;addr_other&quot;);</span>
<a href="#l1.362"></a><span id="l1.362">     }</span>
<a href="#l1.363"></a><span id="l1.363">     if (state)</span>
<a href="#l1.364"></a><span id="l1.364">       ComposeStartup(false, null);</span>
<a href="#l1.365"></a><span id="l1.365">   }</span>
<a href="#l1.366"></a><span id="l1.366">   catch (ex) {</span>
<a href="#l1.367"></a><span id="l1.367">     Components.utils.reportError(ex);</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-    gPromptService.alert(window, getComposeBundle().getString(&quot;initErrorDlogTitle&quot;),</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-                         getComposeBundle().getString(&quot;initErrorDlgMessage&quot;));</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+    Services.prompt.alert(window, getComposeBundle().getString(&quot;initErrorDlogTitle&quot;),</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+                          getComposeBundle().getString(&quot;initErrorDlgMessage&quot;));</span>
<a href="#l1.372"></a><span id="l1.372"> </span>
<a href="#l1.373"></a><span id="l1.373">     MsgComposeCloseWindow(false); // Don't try to recycle a bogus window</span>
<a href="#l1.374"></a><span id="l1.374">     return;</span>
<a href="#l1.375"></a><span id="l1.375">   }</span>
<a href="#l1.376"></a><span id="l1.376"> </span>
<a href="#l1.377"></a><span id="l1.377">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l1.378"></a><span id="l1.378">   var toolbox = document.getElementById(&quot;compose-toolbox&quot;);</span>
<a href="#l1.379"></a><span id="l1.379">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeComposeToolbar&quot;); };</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineat">@@ -2709,41 +2689,41 @@ function GenericSendMessage(msgType)</span>
<a href="#l1.381"></a><span id="l1.381">       subject = fixedSubject;</span>
<a href="#l1.382"></a><span id="l1.382">       msgCompFields.subject = fixedSubject;</span>
<a href="#l1.383"></a><span id="l1.383">       GetMsgSubjectElement().value = fixedSubject;</span>
<a href="#l1.384"></a><span id="l1.384">     }</span>
<a href="#l1.385"></a><span id="l1.385"> </span>
<a href="#l1.386"></a><span id="l1.386">     // Remind the person if there isn't a subject</span>
<a href="#l1.387"></a><span id="l1.387">     if (subject == &quot;&quot;)</span>
<a href="#l1.388"></a><span id="l1.388">     {</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-      if (gPromptService.confirmEx(</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+      if (Services.prompt.confirmEx(</span>
<a href="#l1.391"></a><span id="l1.391">             window,</span>
<a href="#l1.392"></a><span id="l1.392">             getComposeBundle().getString(&quot;subjectEmptyTitle&quot;),</span>
<a href="#l1.393"></a><span id="l1.393">             getComposeBundle().getString(&quot;subjectEmptyMessage&quot;),</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-            (gPromptService.BUTTON_TITLE_IS_STRING * gPromptService.BUTTON_POS_0) +</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-            (gPromptService.BUTTON_TITLE_IS_STRING * gPromptService.BUTTON_POS_1),</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+            (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineplus">+            (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l1.398"></a><span id="l1.398">             getComposeBundle().getString(&quot;sendWithEmptySubjectButton&quot;),</span>
<a href="#l1.399"></a><span id="l1.399">             getComposeBundle().getString(&quot;cancelSendingButton&quot;),</span>
<a href="#l1.400"></a><span id="l1.400">             null, null, {value:0}) == 1)</span>
<a href="#l1.401"></a><span id="l1.401">       {</span>
<a href="#l1.402"></a><span id="l1.402">         GetMsgSubjectElement().focus();</span>
<a href="#l1.403"></a><span id="l1.403">         return;</span>
<a href="#l1.404"></a><span id="l1.404">       }</span>
<a href="#l1.405"></a><span id="l1.405">     }</span>
<a href="#l1.406"></a><span id="l1.406"> </span>
<a href="#l1.407"></a><span id="l1.407">     // Alert the user if</span>
<a href="#l1.408"></a><span id="l1.408">     //  - the button to remind about attachments was clicked, or</span>
<a href="#l1.409"></a><span id="l1.409">     //  - the aggressive pref is set and the notification was not dismissed</span>
<a href="#l1.410"></a><span id="l1.410">     // and the message (still) contains attachment keywords.</span>
<a href="#l1.411"></a><span id="l1.411">     if ((gRemindLater || (getPref(&quot;mail.compose.attachment_reminder_aggressive&quot;) &amp;&amp;</span>
<a href="#l1.412"></a><span id="l1.412">           document.getElementById(&quot;attachmentNotificationBox&quot;).currentNotification)) &amp;&amp;</span>
<a href="#l1.413"></a><span id="l1.413">         ShouldShowAttachmentNotification(false)) {</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-      var flags = gPromptService.BUTTON_POS_0 * gPromptService.BUTTON_TITLE_IS_STRING +</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-                  gPromptService.BUTTON_POS_1 * gPromptService.BUTTON_TITLE_IS_STRING;</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-      var hadForgotten = gPromptService.confirmEx(window,</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+      let flags = Services.prompt.BUTTON_POS_0 * Services.prompt.BUTTON_TITLE_IS_STRING +</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineplus">+                  Services.prompt.BUTTON_POS_1 * Services.prompt.BUTTON_TITLE_IS_STRING;</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+      let hadForgotten = Services.prompt.confirmEx(window,</span>
<a href="#l1.420"></a><span id="l1.420">                             getComposeBundle().getString(&quot;attachmentReminderTitle&quot;),</span>
<a href="#l1.421"></a><span id="l1.421">                             getComposeBundle().getString(&quot;attachmentReminderMsg&quot;),</span>
<a href="#l1.422"></a><span id="l1.422">                             flags,</span>
<a href="#l1.423"></a><span id="l1.423">                             getComposeBundle().getString(&quot;attachmentReminderFalseAlarm&quot;),</span>
<a href="#l1.424"></a><span id="l1.424">                             getComposeBundle().getString(&quot;attachmentReminderYesIForgot&quot;),</span>
<a href="#l1.425"></a><span id="l1.425">                             null, null, {value:0});</span>
<a href="#l1.426"></a><span id="l1.426">       if (hadForgotten)</span>
<a href="#l1.427"></a><span id="l1.427">         return;</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineat">@@ -2757,34 +2737,31 @@ function GenericSendMessage(msgType)</span>
<a href="#l1.429"></a><span id="l1.429">     {</span>
<a href="#l1.430"></a><span id="l1.430">       throw new Error(&quot;currentAccountKey '&quot; + currentAccountKey +</span>
<a href="#l1.431"></a><span id="l1.431">                       &quot;' has no matching account!&quot;);</span>
<a href="#l1.432"></a><span id="l1.432">     }</span>
<a href="#l1.433"></a><span id="l1.433">     if (account.incomingServer.type != &quot;nntp&quot; &amp;&amp; msgCompFields.newsgroups != &quot;&quot;)</span>
<a href="#l1.434"></a><span id="l1.434">     {</span>
<a href="#l1.435"></a><span id="l1.435">       const kDontAskAgainPref = &quot;mail.compose.dontWarnMail2Newsgroup&quot;;</span>
<a href="#l1.436"></a><span id="l1.436">       // default to ask user if the pref is not set</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-      var dontAskAgain = getPref(kDontAskAgainPref);</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+      let dontAskAgain = getPref(kDontAskAgainPref);</span>
<a href="#l1.439"></a><span id="l1.439">       if (!dontAskAgain)</span>
<a href="#l1.440"></a><span id="l1.440">       {</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-        var checkbox = {value:false};</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">-        var okToProceed = gPromptService.confirmCheck(</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineplus">+        let checkbox = {value:false};</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+        let okToProceed = Services.prompt.confirmCheck(</span>
<a href="#l1.445"></a><span id="l1.445">                               window,</span>
<a href="#l1.446"></a><span id="l1.446">                               getComposeBundle().getString(&quot;noNewsgroupSupportTitle&quot;),</span>
<a href="#l1.447"></a><span id="l1.447">                               getComposeBundle().getString(&quot;recipientDlogMessage&quot;),</span>
<a href="#l1.448"></a><span id="l1.448">                               getComposeBundle().getString(&quot;CheckMsg&quot;),</span>
<a href="#l1.449"></a><span id="l1.449">                               checkbox);</span>
<a href="#l1.450"></a><span id="l1.450">         if (!okToProceed)</span>
<a href="#l1.451"></a><span id="l1.451">           return;</span>
<a href="#l1.452"></a><span id="l1.452"> </span>
<a href="#l1.453"></a><span id="l1.453">         if (checkbox.value) {</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-          var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-                                  .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineminus">-          branch.setBoolPref(kDontAskAgainPref, true);</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+          Services.prefs.setBoolPref(kDontAskAgainPref, true);</span>
<a href="#l1.459"></a><span id="l1.459">         }</span>
<a href="#l1.460"></a><span id="l1.460">       }</span>
<a href="#l1.461"></a><span id="l1.461"> </span>
<a href="#l1.462"></a><span id="l1.462">       // remove newsgroups to prevent news_p to be set</span>
<a href="#l1.463"></a><span id="l1.463">       // in nsMsgComposeAndSend::DeliverMessage()</span>
<a href="#l1.464"></a><span id="l1.464">       msgCompFields.newsgroups = &quot;&quot;;</span>
<a href="#l1.465"></a><span id="l1.465">     }</span>
<a href="#l1.466"></a><span id="l1.466"> </span>
<a href="#l1.467"></a><span id="l1.467" class="difflineat">@@ -2924,20 +2901,19 @@ function CheckValidEmailAddress(to, cc, </span>
<a href="#l1.468"></a><span id="l1.468">   if (to.length &gt; 0 &amp;&amp; (to.indexOf(&quot;@&quot;) &lt;= 0 &amp;&amp; to.toLowerCase() != &quot;postmaster&quot; || to.indexOf(&quot;@&quot;) == to.length - 1))</span>
<a href="#l1.469"></a><span id="l1.469">     invalidStr = to;</span>
<a href="#l1.470"></a><span id="l1.470">   else if (cc.length &gt; 0 &amp;&amp; (cc.indexOf(&quot;@&quot;) &lt;= 0 &amp;&amp; cc.toLowerCase() != &quot;postmaster&quot; || cc.indexOf(&quot;@&quot;) == cc.length - 1))</span>
<a href="#l1.471"></a><span id="l1.471">     invalidStr = cc;</span>
<a href="#l1.472"></a><span id="l1.472">   else if (bcc.length &gt; 0 &amp;&amp; (bcc.indexOf(&quot;@&quot;) &lt;= 0 &amp;&amp; bcc.toLowerCase() != &quot;postmaster&quot; || bcc.indexOf(&quot;@&quot;) == bcc.length - 1))</span>
<a href="#l1.473"></a><span id="l1.473">     invalidStr = bcc;</span>
<a href="#l1.474"></a><span id="l1.474">   if (invalidStr)</span>
<a href="#l1.475"></a><span id="l1.475">   {</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-    if (gPromptService)</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-      gPromptService.alert(window, getComposeBundle().getString(&quot;addressInvalidTitle&quot;),</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-                           getComposeBundle().getFormattedString(&quot;addressInvalid&quot;,</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-                                                     [invalidStr], 1));</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+    Services.prompt.alert(window, getComposeBundle().getString(&quot;addressInvalidTitle&quot;),</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineplus">+                          getComposeBundle().getFormattedString(&quot;addressInvalid&quot;,</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineplus">+                          [invalidStr], 1));</span>
<a href="#l1.483"></a><span id="l1.483">     return false;</span>
<a href="#l1.484"></a><span id="l1.484">   }</span>
<a href="#l1.485"></a><span id="l1.485">   return true;</span>
<a href="#l1.486"></a><span id="l1.486"> }</span>
<a href="#l1.487"></a><span id="l1.487"> </span>
<a href="#l1.488"></a><span id="l1.488"> function SendMessage()</span>
<a href="#l1.489"></a><span id="l1.489"> {</span>
<a href="#l1.490"></a><span id="l1.490">   let sendInBackground =</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineat">@@ -2958,43 +2934,37 @@ function SendMessage()</span>
<a href="#l1.492"></a><span id="l1.492">                      nsIMsgCompDeliverMode.Now);</span>
<a href="#l1.493"></a><span id="l1.493"> }</span>
<a href="#l1.494"></a><span id="l1.494"> </span>
<a href="#l1.495"></a><span id="l1.495"> function SendMessageWithCheck()</span>
<a href="#l1.496"></a><span id="l1.496"> {</span>
<a href="#l1.497"></a><span id="l1.497">     var warn = getPref(&quot;mail.warn_on_send_accel_key&quot;);</span>
<a href="#l1.498"></a><span id="l1.498"> </span>
<a href="#l1.499"></a><span id="l1.499">     if (warn) {</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-        var checkValue = {value:false};</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-        var buttonPressed = gPromptService.confirmEx(window,</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+        let checkValue = {value:false};</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineplus">+        let buttonPressed = Services.prompt.confirmEx(window,</span>
<a href="#l1.504"></a><span id="l1.504">               getComposeBundle().getString('sendMessageCheckWindowTitle'),</span>
<a href="#l1.505"></a><span id="l1.505">               getComposeBundle().getString('sendMessageCheckLabel'),</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-              (gPromptService.BUTTON_TITLE_IS_STRING * gPromptService.BUTTON_POS_0) +</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-              (gPromptService.BUTTON_TITLE_CANCEL * gPromptService.BUTTON_POS_1),</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+              (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineplus">+              (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1),</span>
<a href="#l1.510"></a><span id="l1.510">               getComposeBundle().getString('sendMessageCheckSendButtonLabel'),</span>
<a href="#l1.511"></a><span id="l1.511">               null, null,</span>
<a href="#l1.512"></a><span id="l1.512">               getComposeBundle().getString('CheckMsg'),</span>
<a href="#l1.513"></a><span id="l1.513">               checkValue);</span>
<a href="#l1.514"></a><span id="l1.514">         if (buttonPressed != 0) {</span>
<a href="#l1.515"></a><span id="l1.515">             return;</span>
<a href="#l1.516"></a><span id="l1.516">         }</span>
<a href="#l1.517"></a><span id="l1.517">         if (checkValue.value) {</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineminus">-            var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineminus">-                                   .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineminus">-            branch.setBoolPref(&quot;mail.warn_on_send_accel_key&quot;, false);</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+            Services.prefs.setBoolPref(&quot;mail.warn_on_send_accel_key&quot;, false);</span>
<a href="#l1.523"></a><span id="l1.523">         }</span>
<a href="#l1.524"></a><span id="l1.524">     }</span>
<a href="#l1.525"></a><span id="l1.525"> </span>
<a href="#l1.526"></a><span id="l1.526" class="difflineminus">-  let sendInBackground =</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineminus">-              .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineminus">-              .getBoolPref(&quot;mailnews.sendInBackground&quot;);</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-  GenericSendMessage(gIsOffline ? nsIMsgCompDeliverMode.Later :</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineplus">+  let sendInBackground = Services.prefs.getBoolPref(&quot;mailnews.sendInBackground&quot;);</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineplus">+</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineplus">+  GenericSendMessage(Services.io.offline ? nsIMsgCompDeliverMode.Later :</span>
<a href="#l1.535"></a><span id="l1.535">                      (sendInBackground ?</span>
<a href="#l1.536"></a><span id="l1.536">                       nsIMsgCompDeliverMode.Background :</span>
<a href="#l1.537"></a><span id="l1.537">                       nsIMsgCompDeliverMode.Now));</span>
<a href="#l1.538"></a><span id="l1.538"> }</span>
<a href="#l1.539"></a><span id="l1.539"> </span>
<a href="#l1.540"></a><span id="l1.540"> function SendMessageLater()</span>
<a href="#l1.541"></a><span id="l1.541"> {</span>
<a href="#l1.542"></a><span id="l1.542">   GenericSendMessage(nsIMsgCompDeliverMode.Later);</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineat">@@ -3403,87 +3373,82 @@ function SetComposeWindowTitle()</span>
<a href="#l1.544"></a><span id="l1.544"> // This is hooked up to the OS's window close widget (e.g., &quot;X&quot; for Windows)</span>
<a href="#l1.545"></a><span id="l1.545"> function ComposeCanClose()</span>
<a href="#l1.546"></a><span id="l1.546"> {</span>
<a href="#l1.547"></a><span id="l1.547">   // Do this early, so ldap sessions have a better chance to</span>
<a href="#l1.548"></a><span id="l1.548">   // cleanup after themselves.</span>
<a href="#l1.549"></a><span id="l1.549">   ReleaseAutoCompleteState();</span>
<a href="#l1.550"></a><span id="l1.550">   if (gSendOrSaveOperationInProgress)</span>
<a href="#l1.551"></a><span id="l1.551">   {</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineminus">-    var result;</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-    if (gPromptService)</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+    let result;</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineplus">+</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineplus">+    let brandBundle = document.getElementById(&quot;brandBundle&quot;);</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+    let brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+    let promptTitle = getComposeBundle().getString(&quot;quitComposeWindowTitle&quot;);</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+    let promptMsg = getComposeBundle().getFormattedString(&quot;quitComposeWindowMessage2&quot;,</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineplus">+        [brandShortName], 1);</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineplus">+    let quitButtonLabel = getComposeBundle().getString(&quot;quitComposeWindowQuitButtonLabel2&quot;);</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+    let waitButtonLabel = getComposeBundle().getString(&quot;quitComposeWindowWaitButtonLabel2&quot;);</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineplus">+</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineplus">+    result = Services.prompt.confirmEx(window, promptTitle, promptMsg,</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineplus">+        (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+        (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineplus">+        waitButtonLabel, quitButtonLabel, null, null, {value:0});</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineplus">+    if (result == 1)</span>
<a href="#l1.571"></a><span id="l1.571">     {</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineminus">-      var brandBundle = document.getElementById(&quot;brandBundle&quot;);</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-      var brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-      var promptTitle = getComposeBundle().getString(&quot;quitComposeWindowTitle&quot;);</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-      var promptMsg = getComposeBundle().getFormattedString(&quot;quitComposeWindowMessage2&quot;,</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineminus">-                                                [brandShortName], 1);</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-      var quitButtonLabel = getComposeBundle().getString(&quot;quitComposeWindowQuitButtonLabel2&quot;);</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-      var waitButtonLabel = getComposeBundle().getString(&quot;quitComposeWindowWaitButtonLabel2&quot;);</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-      result = gPromptService.confirmEx(window, promptTitle, promptMsg,</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineminus">-          (gPromptService.BUTTON_TITLE_IS_STRING*gPromptService.BUTTON_POS_0) +</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-          (gPromptService.BUTTON_TITLE_IS_STRING*gPromptService.BUTTON_POS_1),</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-          waitButtonLabel, quitButtonLabel, null, null, {value:0});</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineminus">-      if (result == 1)</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-      {</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-        gMsgCompose.abort();</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-        return true;</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-      }</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineminus">-      return false;</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineplus">+      gMsgCompose.abort();</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineplus">+      return true;</span>
<a href="#l1.593"></a><span id="l1.593">     }</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineplus">+    return false;</span>
<a href="#l1.595"></a><span id="l1.595">   }</span>
<a href="#l1.596"></a><span id="l1.596"> </span>
<a href="#l1.597"></a><span id="l1.597">   // Returns FALSE only if user cancels save action</span>
<a href="#l1.598"></a><span id="l1.598">   if (gContentChanged || gMsgCompose.bodyModified || gAutoSaveKickedIn)</span>
<a href="#l1.599"></a><span id="l1.599">   {</span>
<a href="#l1.600"></a><span id="l1.600">     // call window.focus, since we need to pop up a dialog</span>
<a href="#l1.601"></a><span id="l1.601">     // and therefore need to be visible (to prevent user confusion)</span>
<a href="#l1.602"></a><span id="l1.602">     window.focus();</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-    if (gPromptService)</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+    let result = Services.prompt</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineplus">+                         .confirmEx(window,</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineplus">+                                    getComposeBundle().getString(&quot;saveDlogTitle&quot;),</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineplus">+                                    getComposeBundle().getString(&quot;saveDlogMessage&quot;),</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineplus">+                                    (Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineplus">+                                    (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1) +</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineplus">+                                    (Services.prompt.BUTTON_TITLE_DONT_SAVE * Services.prompt.BUTTON_POS_2),</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineplus">+                                    null, null, null,</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineplus">+                                    null, {value:0});</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineplus">+    switch (result)</span>
<a href="#l1.614"></a><span id="l1.614">     {</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-      result = gPromptService.confirmEx(window,</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineminus">-                              getComposeBundle().getString(&quot;saveDlogTitle&quot;),</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-                              getComposeBundle().getString(&quot;saveDlogMessage&quot;),</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-                              (gPromptService.BUTTON_TITLE_SAVE * gPromptService.BUTTON_POS_0) +</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineminus">-                              (gPromptService.BUTTON_TITLE_CANCEL * gPromptService.BUTTON_POS_1) +</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-                              (gPromptService.BUTTON_TITLE_DONT_SAVE * gPromptService.BUTTON_POS_2),</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-                              null, null, null,</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-                              null, {value:0});</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-      switch (result)</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-      {</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-        case 0: //Save</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-          // Since we're going to save the message, we tell toolkit that</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-          // the close command failed, by returning false, and then</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-          // we close the window ourselves after the save is done.</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-          gCloseWindowAfterSave = true;</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-          // We catch the exception because we need to tell toolkit that it</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-          // shouldn't close the window, because we're going to close it</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-          // ourselves. If we don't tell toolkit that, and then close the window</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-          // ourselves, the toolkit code that keeps track of the open windows</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-          // gets off by one and the app can close unexpectedly on os's that</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-          // shutdown the app when the last window is closed.</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-          try {</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-            GenericSendMessage(nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-          }</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-          catch (ex) {</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-            Components.utils.reportError(ex);</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-          }</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-          return false;</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-        case 1: //Cancel</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-          return false;</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-        case 2: //Don't Save</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-          // don't delete the draft if we didn't start off editing a draft</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-          // and the user hasn't explicitly saved it.</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-          if (!gEditingDraft &amp;&amp; gAutoSaveKickedIn)</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-            RemoveDraft();</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-          break;</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-      }</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineplus">+      case 0: //Save</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineplus">+        // Since we're going to save the message, we tell toolkit that</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+        // the close command failed, by returning false, and then</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineplus">+        // we close the window ourselves after the save is done.</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineplus">+        gCloseWindowAfterSave = true;</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineplus">+        // We catch the exception because we need to tell toolkit that it</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineplus">+        // shouldn't close the window, because we're going to close it</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineplus">+        // ourselves. If we don't tell toolkit that, and then close the window</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineplus">+        // ourselves, the toolkit code that keeps track of the open windows</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineplus">+        // gets off by one and the app can close unexpectedly on os's that</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineplus">+        // shutdown the app when the last window is closed.</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineplus">+        try {</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineplus">+          GenericSendMessage(nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineplus">+        }</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+        catch (ex) {</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineplus">+          Components.utils.reportError(ex);</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineplus">+        }</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineplus">+        return false;</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineplus">+      case 1: //Cancel</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineplus">+        return false;</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineplus">+      case 2: //Don't Save</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineplus">+        // don't delete the draft if we didn't start off editing a draft</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineplus">+        // and the user hasn't explicitly saved it.</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineplus">+        if (!gEditingDraft &amp;&amp; gAutoSaveKickedIn)</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineplus">+          RemoveDraft();</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineplus">+        break;</span>
<a href="#l1.678"></a><span id="l1.678">     }</span>
<a href="#l1.679"></a><span id="l1.679">   }</span>
<a href="#l1.680"></a><span id="l1.680"> </span>
<a href="#l1.681"></a><span id="l1.681">   return true;</span>
<a href="#l1.682"></a><span id="l1.682"> }</span>
<a href="#l1.683"></a><span id="l1.683"> </span>
<a href="#l1.684"></a><span id="l1.684"> function RemoveDraft()</span>
<a href="#l1.685"></a><span id="l1.685"> {</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineat">@@ -3548,39 +3513,38 @@ function MsgComposeCloseWindow(recycleIt</span>
<a href="#l1.687"></a><span id="l1.687">     window.close();</span>
<a href="#l1.688"></a><span id="l1.688"> }</span>
<a href="#l1.689"></a><span id="l1.689"> </span>
<a href="#l1.690"></a><span id="l1.690"> function GetLastAttachDirectory()</span>
<a href="#l1.691"></a><span id="l1.691"> {</span>
<a href="#l1.692"></a><span id="l1.692">   var lastDirectory;</span>
<a href="#l1.693"></a><span id="l1.693"> </span>
<a href="#l1.694"></a><span id="l1.694">   try {</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-    var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineminus">-                           .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineminus">-    lastDirectory = branch.getComplexValue(kComposeAttachDirPrefName, Components.interfaces.nsILocalFile);</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineplus">+    lastDirectory = Services.prefs</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineplus">+                            .getComplexValue(kComposeAttachDirPrefName,</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineplus">+                                             Components.interfaces.nsIFile);</span>
<a href="#l1.701"></a><span id="l1.701">   }</span>
<a href="#l1.702"></a><span id="l1.702">   catch (ex) {</span>
<a href="#l1.703"></a><span id="l1.703">     // this will fail the first time we attach a file</span>
<a href="#l1.704"></a><span id="l1.704">     // as we won't have a pref value.</span>
<a href="#l1.705"></a><span id="l1.705">     lastDirectory = null;</span>
<a href="#l1.706"></a><span id="l1.706">   }</span>
<a href="#l1.707"></a><span id="l1.707"> </span>
<a href="#l1.708"></a><span id="l1.708">   return lastDirectory;</span>
<a href="#l1.709"></a><span id="l1.709"> }</span>
<a href="#l1.710"></a><span id="l1.710"> </span>
<a href="#l1.711"></a><span id="l1.711"> // attachedLocalFile must be a nsILocalFile</span>
<a href="#l1.712"></a><span id="l1.712"> function SetLastAttachDirectory(attachedLocalFile)</span>
<a href="#l1.713"></a><span id="l1.713"> {</span>
<a href="#l1.714"></a><span id="l1.714">   try {</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-    var file = attachedLocalFile.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-    var parent = file.parent.QueryInterface(Components.interfaces.nsILocalFile);</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineminus">-</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-    var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineminus">-                           .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineminus">-    branch.setComplexValue(kComposeAttachDirPrefName, Components.interfaces.nsILocalFile, parent);</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineplus">+    let file = attachedLocalFile.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineplus">+    let parent = file.parent.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineplus">+</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineplus">+    Services.prefs.setComplexValue(kComposeAttachDirPrefName,</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineplus">+                                   Components.interfaces.nsIFile, parent);</span>
<a href="#l1.726"></a><span id="l1.726">   }</span>
<a href="#l1.727"></a><span id="l1.727">   catch (ex) {</span>
<a href="#l1.728"></a><span id="l1.728">     dump(&quot;error: SetLastAttachDirectory failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.729"></a><span id="l1.729">   }</span>
<a href="#l1.730"></a><span id="l1.730"> }</span>
<a href="#l1.731"></a><span id="l1.731"> </span>
<a href="#l1.732"></a><span id="l1.732"> function AttachFile()</span>
<a href="#l1.733"></a><span id="l1.733"> {</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineat">@@ -3688,17 +3652,17 @@ function AddAttachments(aAttachments, aC</span>
<a href="#l1.735"></a><span id="l1.735">     else {</span>
<a href="#l1.736"></a><span id="l1.736">       // For local file urls, we are better off using the full file url because</span>
<a href="#l1.737"></a><span id="l1.737">       // moz-icon will actually resolve the file url and get the right icon from</span>
<a href="#l1.738"></a><span id="l1.738">       // the file url. All other urls, we should try to extract the file name from</span>
<a href="#l1.739"></a><span id="l1.739">       // them. This fixes issues where an icon wasn't showing up if you dragged a</span>
<a href="#l1.740"></a><span id="l1.740">       // web url that had a query or reference string after the file name and for</span>
<a href="#l1.741"></a><span id="l1.741">       // mailnews urls where the filename is hidden in the url as a &amp;filename=</span>
<a href="#l1.742"></a><span id="l1.742">       // part.</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-      var url = gIOService.newURI(attachment.url, null, null);</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineplus">+      let url = Services.io.newURI(attachment.url, null, null);</span>
<a href="#l1.745"></a><span id="l1.745">       if (url instanceof Components.interfaces.nsIURL &amp;&amp;</span>
<a href="#l1.746"></a><span id="l1.746">           url.fileName &amp;&amp; !url.schemeIs(&quot;file&quot;))</span>
<a href="#l1.747"></a><span id="l1.747">         item.image = &quot;moz-icon://&quot; + url.fileName;</span>
<a href="#l1.748"></a><span id="l1.748">       else</span>
<a href="#l1.749"></a><span id="l1.749">         item.image = &quot;moz-icon:&quot; + attachment.url;</span>
<a href="#l1.750"></a><span id="l1.750">       }</span>
<a href="#l1.751"></a><span id="l1.751"> </span>
<a href="#l1.752"></a><span id="l1.752">     items.push(item);</span>
<a href="#l1.753"></a><span id="l1.753" class="difflineat">@@ -3745,32 +3709,30 @@ function AddUrlAttachment(attachment)</span>
<a href="#l1.754"></a><span id="l1.754"> function MessageGetNumSelectedAttachments()</span>
<a href="#l1.755"></a><span id="l1.755"> {</span>
<a href="#l1.756"></a><span id="l1.756">   var bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l1.757"></a><span id="l1.757">   return (bucketList) ? bucketList.selectedCount : 0;</span>
<a href="#l1.758"></a><span id="l1.758"> }</span>
<a href="#l1.759"></a><span id="l1.759"> </span>
<a href="#l1.760"></a><span id="l1.760"> function AttachPage()</span>
<a href="#l1.761"></a><span id="l1.761"> {</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-   if (gPromptService)</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-   {</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineminus">-      var result = {value:&quot;http://&quot;};</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineminus">-      if (gPromptService.prompt(window,</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineminus">-                                getComposeBundle().getString(&quot;attachPageDlogTitle&quot;),</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineminus">-                                getComposeBundle().getString(&quot;attachPageDlogMessage&quot;),</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineminus">-                                result,</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineminus">-                                null,</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineminus">-                                {value:0}))</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineminus">-      {</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-        var attachment = Components.classes[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-                                   .createInstance(Components.interfaces.nsIMsgAttachment);</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineminus">-        attachment.url = result.value;</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineminus">-        AddAttachments([attachment]);</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineminus">-      }</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-   }</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineplus">+  let result = {value:&quot;http://&quot;};</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineplus">+  if (Services.prompt</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineplus">+              .prompt(window,</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineplus">+                      getComposeBundle().getString(&quot;attachPageDlogTitle&quot;),</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineplus">+                      getComposeBundle().getString(&quot;attachPageDlogMessage&quot;),</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineplus">+                      result,</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineplus">+                      null,</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineplus">+                      {value:0}))</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineplus">+  {</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineplus">+    let attachment = Components.classes[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineplus">+                               .createInstance(Components.interfaces.nsIMsgAttachment);</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineplus">+    attachment.url = result.value;</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineplus">+    AddAttachments([attachment]);</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineplus">+  }</span>
<a href="#l1.792"></a><span id="l1.792"> }</span>
<a href="#l1.793"></a><span id="l1.793"> </span>
<a href="#l1.794"></a><span id="l1.794"> /**</span>
<a href="#l1.795"></a><span id="l1.795">  * Check if the given fileURL already exists in the attachment bucket.</span>
<a href="#l1.796"></a><span id="l1.796">  * @param fileURL the URL (as a String) of the file to check</span>
<a href="#l1.797"></a><span id="l1.797">  * @return true if the fileURL is already attached</span>
<a href="#l1.798"></a><span id="l1.798">  */</span>
<a href="#l1.799"></a><span id="l1.799"> function DuplicateFileAlreadyAttached(fileURL)</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineat">@@ -3877,29 +3839,29 @@ function RemoveSelectedAttachment()</span>
<a href="#l1.801"></a><span id="l1.801">     gContentChanged = true;</span>
<a href="#l1.802"></a><span id="l1.802">     dispatchAttachmentBucketEvent(&quot;attachments-removed&quot;, removedAttachments);</span>
<a href="#l1.803"></a><span id="l1.803">   }</span>
<a href="#l1.804"></a><span id="l1.804">   CheckForAttachmentNotification(null);</span>
<a href="#l1.805"></a><span id="l1.805"> }</span>
<a href="#l1.806"></a><span id="l1.806"> </span>
<a href="#l1.807"></a><span id="l1.807"> function RenameSelectedAttachment()</span>
<a href="#l1.808"></a><span id="l1.808"> {</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-  var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineplus">+  let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l1.811"></a><span id="l1.811">   if (bucket.selectedItems.length != 1)</span>
<a href="#l1.812"></a><span id="l1.812">     return; // not one attachment selected</span>
<a href="#l1.813"></a><span id="l1.813"> </span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-  var item = bucket.getSelectedItem(0);</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">-  var attachmentName = {value: item.attachment.name};</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-  if (gPromptService.prompt(</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineminus">-                     window,</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineminus">-                     getComposeBundle().getString(&quot;renameAttachmentTitle&quot;),</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineminus">-                     getComposeBundle().getString(&quot;renameAttachmentMessage&quot;),</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-                     attachmentName,</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineminus">-                     null,</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-                     {value: 0}))</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineplus">+  let item = bucket.getSelectedItem(0);</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineplus">+  let attachmentName = {value: item.attachment.name};</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineplus">+  if (Services.prompt</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineplus">+              .prompt(window,</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineplus">+                      getComposeBundle().getString(&quot;renameAttachmentTitle&quot;),</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineplus">+                      getComposeBundle().getString(&quot;renameAttachmentMessage&quot;),</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineplus">+                      attachmentName,</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineplus">+                      null,</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineplus">+                      {value: 0}))</span>
<a href="#l1.832"></a><span id="l1.832">   {</span>
<a href="#l1.833"></a><span id="l1.833">     if (attachmentName.value == &quot;&quot;)</span>
<a href="#l1.834"></a><span id="l1.834">       return; // name was not filled, bail out</span>
<a href="#l1.835"></a><span id="l1.835"> </span>
<a href="#l1.836"></a><span id="l1.836">     let originalName = item.attachment.name;</span>
<a href="#l1.837"></a><span id="l1.837">     item.attachment.name = attachmentName.value;</span>
<a href="#l1.838"></a><span id="l1.838">     item.setAttribute(&quot;name&quot;, attachmentName.value);</span>
<a href="#l1.839"></a><span id="l1.839"> </span>
<a href="#l1.840"></a><span id="l1.840" class="difflineat">@@ -3914,43 +3876,43 @@ function RenameSelectedAttachment()</span>
<a href="#l1.841"></a><span id="l1.841"> function AttachmentElementHasItems()</span>
<a href="#l1.842"></a><span id="l1.842"> {</span>
<a href="#l1.843"></a><span id="l1.843">   var element = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l1.844"></a><span id="l1.844">   return element ? element.getRowCount() : 0;</span>
<a href="#l1.845"></a><span id="l1.845"> }</span>
<a href="#l1.846"></a><span id="l1.846"> </span>
<a href="#l1.847"></a><span id="l1.847"> function OpenSelectedAttachment()</span>
<a href="#l1.848"></a><span id="l1.848"> {</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineminus">-  var child;</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineminus">-  var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineplus">+  let child;</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineplus">+  let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l1.853"></a><span id="l1.853">   if (bucket.selectedItems.length == 1)</span>
<a href="#l1.854"></a><span id="l1.854">   {</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineminus">-    var attachmentUrl = bucket.getSelectedItem(0).attachment.url;</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineminus">-</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineminus">-    var messagePrefix = /^mailbox-message:|^imap-message:|^news-message:/i;</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineplus">+    let attachmentUrl = bucket.getSelectedItem(0).attachment.url;</span>
<a href="#l1.859"></a><span id="l1.859" class="difflineplus">+</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineplus">+    let messagePrefix = /^mailbox-message:|^imap-message:|^news-message:/i;</span>
<a href="#l1.861"></a><span id="l1.861">     if (messagePrefix.test(attachmentUrl))</span>
<a href="#l1.862"></a><span id="l1.862">     {</span>
<a href="#l1.863"></a><span id="l1.863">       // we must be dealing with a forwarded attachment, treat this special</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-      var msgHdr = gMessenger.messageServiceFromURI(attachmentUrl).messageURIToMsgHdr(attachmentUrl);</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineplus">+      let msgHdr = gMessenger.messageServiceFromURI(attachmentUrl).messageURIToMsgHdr(attachmentUrl);</span>
<a href="#l1.866"></a><span id="l1.866">       if (msgHdr)</span>
<a href="#l1.867"></a><span id="l1.867">         MailUtils.openMessageInNewWindow(msgHdr);</span>
<a href="#l1.868"></a><span id="l1.868">     }</span>
<a href="#l1.869"></a><span id="l1.869">     else</span>
<a href="#l1.870"></a><span id="l1.870">     {</span>
<a href="#l1.871"></a><span id="l1.871">       // turn the url into a nsIURL object then open it</span>
<a href="#l1.872"></a><span id="l1.872"> </span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-      var url = gIOService.newURI(attachmentUrl, null, null);</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineplus">+      let url = Services.io.newURI(attachmentUrl, null, null);</span>
<a href="#l1.875"></a><span id="l1.875">       url = url.QueryInterface( Components.interfaces.nsIURL );</span>
<a href="#l1.876"></a><span id="l1.876"> </span>
<a href="#l1.877"></a><span id="l1.877">       if (url)</span>
<a href="#l1.878"></a><span id="l1.878">       {</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineminus">-        var channel = gIOService.newChannelFromURI(url);</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineplus">+        let channel = Services.io.newChannelFromURI(url);</span>
<a href="#l1.881"></a><span id="l1.881">         if (channel)</span>
<a href="#l1.882"></a><span id="l1.882">         {</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-          var uriLoader = Components.classes[&quot;@mozilla.org/uriloader;1&quot;].getService(Components.interfaces.nsIURILoader);</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineplus">+          let uriLoader = Components.classes[&quot;@mozilla.org/uriloader;1&quot;].getService(Components.interfaces.nsIURILoader);</span>
<a href="#l1.885"></a><span id="l1.885">           uriLoader.openURI(channel, true, new nsAttachmentOpener());</span>
<a href="#l1.886"></a><span id="l1.886">         } // if channel</span>
<a href="#l1.887"></a><span id="l1.887">       } // if url</span>
<a href="#l1.888"></a><span id="l1.888">     }</span>
<a href="#l1.889"></a><span id="l1.889">   } // if one attachment selected</span>
<a href="#l1.890"></a><span id="l1.890"> }</span>
<a href="#l1.891"></a><span id="l1.891"> </span>
<a href="#l1.892"></a><span id="l1.892"> function nsAttachmentOpener()</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineat">@@ -4330,17 +4292,17 @@ var envelopeDragObserver = {</span>
<a href="#l1.894"></a><span id="l1.894">             // if this is a url (or selected text)</span>
<a href="#l1.895"></a><span id="l1.895">             // see if it's a valid url by checking</span>
<a href="#l1.896"></a><span id="l1.896">             // if we can extract a scheme</span>
<a href="#l1.897"></a><span id="l1.897">             // using the ioservice</span>
<a href="#l1.898"></a><span id="l1.898">             //</span>
<a href="#l1.899"></a><span id="l1.899">             // also skip mailto:, since it doesn't make sense</span>
<a href="#l1.900"></a><span id="l1.900">             // to attach and send mailto urls</span>
<a href="#l1.901"></a><span id="l1.901">             try {</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-              var scheme = gIOService.extractScheme(rawData);</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineplus">+              let scheme = Services.io.extractScheme(rawData);</span>
<a href="#l1.904"></a><span id="l1.904">               // don't attach mailto: urls</span>
<a href="#l1.905"></a><span id="l1.905">               if (scheme == &quot;mailto&quot;)</span>
<a href="#l1.906"></a><span id="l1.906">                 isValid = false;</span>
<a href="#l1.907"></a><span id="l1.907">             }</span>
<a href="#l1.908"></a><span id="l1.908">             catch (ex) {</span>
<a href="#l1.909"></a><span id="l1.909">               isValid = false;</span>
<a href="#l1.910"></a><span id="l1.910">             }</span>
<a href="#l1.911"></a><span id="l1.911">           }</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineat">@@ -4415,28 +4377,29 @@ function DisplaySaveFolderDlg(folderURI)</span>
<a href="#l1.913"></a><span id="l1.913">     var showDialog = gCurrentIdentity.showSaveMsgDlg;</span>
<a href="#l1.914"></a><span id="l1.914">   }</span>
<a href="#l1.915"></a><span id="l1.915">   catch (e)</span>
<a href="#l1.916"></a><span id="l1.916">   {</span>
<a href="#l1.917"></a><span id="l1.917">     return;</span>
<a href="#l1.918"></a><span id="l1.918">   }</span>
<a href="#l1.919"></a><span id="l1.919"> </span>
<a href="#l1.920"></a><span id="l1.920">   if (showDialog){</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-    var msgfolder = GetMsgFolderFromUri(folderURI, true);</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineplus">+    let msgfolder = GetMsgFolderFromUri(folderURI, true);</span>
<a href="#l1.923"></a><span id="l1.923">     if (!msgfolder)</span>
<a href="#l1.924"></a><span id="l1.924">       return;</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-    var checkbox = {value:0};</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineminus">-    var SaveDlgTitle = getComposeBundle().getString(&quot;SaveDialogTitle&quot;);</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineminus">-    var dlgMsg = bundle.getFormattedString(&quot;SaveDialogMsg&quot;,</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineplus">+    let checkbox = {value:0};</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineplus">+    let SaveDlgTitle = getComposeBundle().getString(&quot;SaveDialogTitle&quot;);</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineplus">+    let dlgMsg = bundle.getFormattedString(&quot;SaveDialogMsg&quot;,</span>
<a href="#l1.931"></a><span id="l1.931">                                            [msgfolder.name,</span>
<a href="#l1.932"></a><span id="l1.932">                                             msgfolder.server.prettyName]);</span>
<a href="#l1.933"></a><span id="l1.933"> </span>
<a href="#l1.934"></a><span id="l1.934" class="difflineminus">-    var CheckMsg = bundle.getString(&quot;CheckMsg&quot;);</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineminus">-    gPromptService.alertCheck(window, SaveDlgTitle, dlgMsg,</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineminus">-                              getComposeBundle().getString(&quot;CheckMsg&quot;), checkbox);</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineplus">+    let CheckMsg = bundle.getString(&quot;CheckMsg&quot;);</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineplus">+    Services.prompt</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineplus">+            .alertCheck(window, SaveDlgTitle, dlgMsg,</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineplus">+                        getComposeBundle().getString(&quot;CheckMsg&quot;), checkbox);</span>
<a href="#l1.941"></a><span id="l1.941">     try {</span>
<a href="#l1.942"></a><span id="l1.942">           gCurrentIdentity.showSaveMsgDlg = !checkbox.value;</span>
<a href="#l1.943"></a><span id="l1.943">     }//try</span>
<a href="#l1.944"></a><span id="l1.944">     catch (e) {</span>
<a href="#l1.945"></a><span id="l1.945">     return;</span>
<a href="#l1.946"></a><span id="l1.946">     }//catch</span>
<a href="#l1.947"></a><span id="l1.947"> </span>
<a href="#l1.948"></a><span id="l1.948">   }//if</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineat">@@ -4774,28 +4737,27 @@ function enableInlineSpellCheck(aEnableI</span>
<a href="#l1.950"></a><span id="l1.950"> </span>
<a href="#l1.951"></a><span id="l1.951"> function getMailToolbox()</span>
<a href="#l1.952"></a><span id="l1.952"> {</span>
<a href="#l1.953"></a><span id="l1.953">   return document.getElementById(&quot;compose-toolbox&quot;);</span>
<a href="#l1.954"></a><span id="l1.954"> }</span>
<a href="#l1.955"></a><span id="l1.955"> </span>
<a href="#l1.956"></a><span id="l1.956"> function getPref(aPrefName, aIsComplex) {</span>
<a href="#l1.957"></a><span id="l1.957">   const Ci = Components.interfaces;</span>
<a href="#l1.958"></a><span id="l1.958" class="difflineminus">-  const prefB = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineminus">-                          .getService(Ci.nsIPrefBranch);</span>
<a href="#l1.960"></a><span id="l1.960">   if (aIsComplex) {</span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-      return prefB.getComplexValue(aPrefName, Ci.nsISupportsString).data;</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineplus">+    return Services.prefs</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineplus">+                   .getComplexValue(aPrefName, Ci.nsISupportsString).data;</span>
<a href="#l1.964"></a><span id="l1.964">   }</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineminus">-  switch (prefB.getPrefType(aPrefName)) {</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineplus">+  switch (Services.prefs.getPrefType(aPrefName)) {</span>
<a href="#l1.967"></a><span id="l1.967">     case Ci.nsIPrefBranch.PREF_BOOL:</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineminus">-      return prefB.getBoolPref(aPrefName);</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineplus">+      return Services.prefs.getBoolPref(aPrefName);</span>
<a href="#l1.970"></a><span id="l1.970">     case Ci.nsIPrefBranch.PREF_INT:</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-      return prefB.getIntPref(aPrefName);</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineplus">+      return Services.prefs.getIntPref(aPrefName);</span>
<a href="#l1.973"></a><span id="l1.973">     case Ci.nsIPrefBranch.PREF_STRING:</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineminus">-      return prefB.getCharPref(aPrefName);</span>
<a href="#l1.975"></a><span id="l1.975" class="difflineplus">+      return Services.prefs.getCharPref(aPrefName);</span>
<a href="#l1.976"></a><span id="l1.976">     default: // includes nsIPrefBranch.PREF_INVALID</span>
<a href="#l1.977"></a><span id="l1.977">       return null;</span>
<a href="#l1.978"></a><span id="l1.978">   }</span>
<a href="#l1.979"></a><span id="l1.979"> }</span>
<a href="#l1.980"></a><span id="l1.980"> </span>
<a href="#l1.981"></a><span id="l1.981"> /**</span>
<a href="#l1.982"></a><span id="l1.982">  * Helper function to dispatch a CustomEvent to the attachmentbucket.</span>
<a href="#l1.983"></a><span id="l1.983">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-prompt-helpers.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-prompt-helpers.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,16 +2,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> var Ci = Components.interfaces;</span>
<a href="#l2.8"></a><span id="l2.8"> var Cc = Components.classes;</span>
<a href="#l2.9"></a><span id="l2.9"> var Cu = Components.utils;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> const MODULE_NAME = 'prompt-helpers';</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> // we need this for the main controller</span>
<a href="#l2.19"></a><span id="l2.19"> const MODULE_REQUIRES = ['mock-object-helpers'];</span>
<a href="#l2.20"></a><span id="l2.20"> const kMockPromptServiceName = &quot;Mock Prompt Service&quot;;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -194,16 +195,18 @@ var gMockPromptService = {</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">     registrar.unregisterFactory(Components.ID(this.CID),</span>
<a href="#l2.24"></a><span id="l2.24">                                 this._origFactory);</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">     registrar.registerFactory(Components.ID(this.CID),</span>
<a href="#l2.27"></a><span id="l2.27">                               kMockPromptServiceName,</span>
<a href="#l2.28"></a><span id="l2.28">                               kPromptServiceContractID,</span>
<a href="#l2.29"></a><span id="l2.29">                               gMockPromptServiceFactory);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    this._resetServicesPrompt();</span>
<a href="#l2.32"></a><span id="l2.32">     this._registered = true;</span>
<a href="#l2.33"></a><span id="l2.33">   },</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">   /* Unregisters the Mock Prompt Service, and re-registers the original</span>
<a href="#l2.36"></a><span id="l2.36">    * Prompt Service.</span>
<a href="#l2.37"></a><span id="l2.37">    */</span>
<a href="#l2.38"></a><span id="l2.38">   unregister: function() {</span>
<a href="#l2.39"></a><span id="l2.39">     if (!this._registered)</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -216,18 +219,25 @@ var gMockPromptService = {</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">     registrar.registerFactory(Components.ID(this.CID),</span>
<a href="#l2.43"></a><span id="l2.43">                               kPromptServiceName,</span>
<a href="#l2.44"></a><span id="l2.44">                               kPromptServiceContractID,</span>
<a href="#l2.45"></a><span id="l2.45">                               this._origFactory);</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">     delete this._origFactory;</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    this._resetServicesPrompt();</span>
<a href="#l2.50"></a><span id="l2.50">     this._registered = false;</span>
<a href="#l2.51"></a><span id="l2.51">   },</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  _resetServicesPrompt: function() {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    XPCOMUtils.defineLazyServiceGetter(Services, &quot;prompt&quot;,</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+                                       kPromptServiceContractID,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+                                       &quot;nsIPromptService&quot;);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  },</span>
<a href="#l2.58"></a><span id="l2.58"> };</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60"> var gMockPromptServiceFactory = {</span>
<a href="#l2.61"></a><span id="l2.61">   createInstance: function(aOuter, aIID) {</span>
<a href="#l2.62"></a><span id="l2.62">     if (aOuter != null)</span>
<a href="#l2.63"></a><span id="l2.63">       throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">     if (!aIID.equals(Ci.nsIPromptService))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/content/mailComposeEditorOverlay.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/content/mailComposeEditorOverlay.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -5,24 +5,24 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> &lt;!DOCTYPE window SYSTEM &quot;chrome://messenger/locale/messengercompose/mailComposeEditorOverlay.dtd&quot; &gt;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> &lt;overlay id=&quot;mailComposeEditorOverlay&quot;</span>
<a href="#l3.8"></a><span id="l3.8">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">   &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l3.11"></a><span id="l3.11">   &lt;![CDATA[</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14">     var gMsgCompProcessLink = false;</span>
<a href="#l3.15"></a><span id="l3.15">     var gMsgCompInputElement = null;</span>
<a href="#l3.16"></a><span id="l3.16">     var gMsgCompPrevInputValue = null;</span>
<a href="#l3.17"></a><span id="l3.17">     var gMsgCompPrevMozDoNotSendAttribute;</span>
<a href="#l3.18"></a><span id="l3.18">     var gMsgCompAttachSourceElement = null;</span>
<a href="#l3.19"></a><span id="l3.19">     var gMOZDONOTSEND = &quot;moz-do-not-send&quot;;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    var gMsgCompPrefs = null;</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">     function OnLoadOverlay()</span>
<a href="#l3.23"></a><span id="l3.23">     {</span>
<a href="#l3.24"></a><span id="l3.24">       gMsgCompAttachSourceElement = document.getElementById(&quot;AttachSourceToMail&quot;);</span>
<a href="#l3.25"></a><span id="l3.25">       var editor = GetCurrentEditor();</span>
<a href="#l3.26"></a><span id="l3.26">       if (gMsgCompAttachSourceElement &amp;&amp; editor &amp;&amp;</span>
<a href="#l3.27"></a><span id="l3.27">           (editor.flags &amp; Components.interfaces.nsIPlaintextEditor.eEditorMailMask))</span>
<a href="#l3.28"></a><span id="l3.28">       {</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineat">@@ -83,23 +83,19 @@</span>
<a href="#l3.30"></a><span id="l3.30">           // the rule should be in sync with to the one in nsMsgComposeAndSend::GetEmbeddedObjectInfo</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">           if (gMsgCompProcessLink)</span>
<a href="#l3.33"></a><span id="l3.33">           {</span>
<a href="#l3.34"></a><span id="l3.34">             //is it a Windows remote file?</span>
<a href="#l3.35"></a><span id="l3.35">             if (/^\s*file:\/\/\/\/\//i.test(gMsgCompInputElement.value))</span>
<a href="#l3.36"></a><span id="l3.36">             {</span>
<a href="#l3.37"></a><span id="l3.37">               try {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-                if (!gMsgCompPrefs)</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-                {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-                  var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-                                              .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-                  gMsgCompPrefs = prefService.getBranch(null);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-                }</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-                if (gMsgCompPrefs &amp;&amp; gMsgCompPrefs.getBoolPref(&quot;mail.compose.dont_attach_source_of_local_network_links&quot;))</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+                let dontAttachPref =</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+                  &quot;mail.compose.dont_attach_source_of_local_network_links&quot;;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+                if (Services.prefs.getBoolPref(dontAttachPref))</span>
<a href="#l3.48"></a><span id="l3.48">                   attach = false;</span>
<a href="#l3.49"></a><span id="l3.49">               } catch(ex) {};</span>
<a href="#l3.50"></a><span id="l3.50">             }</span>
<a href="#l3.51"></a><span id="l3.51">             //is it not a file: location at all?</span>
<a href="#l3.52"></a><span id="l3.52">             else if (!/^\s*file:\/\//i.test(gMsgCompInputElement.value))</span>
<a href="#l3.53"></a><span id="l3.53">               attach = false;</span>
<a href="#l3.54"></a><span id="l3.54">           }</span>
<a href="#l3.55"></a><span id="l3.55">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug235432.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug235432.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,12 +1,15 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /**</span>
<a href="#l4.6"></a><span id="l4.6">  * Test for bug 235432</span>
<a href="#l4.7"></a><span id="l4.7">  */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+</span>
<a href="#l4.11"></a><span id="l4.11"> var testmail = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l4.12"></a><span id="l4.12"> var expectedTemporaryFile;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l4.15"></a><span id="l4.15"> const kTo = &quot;to@invalid.com&quot;;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> var msgSend = Cc[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l4.18"></a><span id="l4.18">                 .createInstance(Ci.nsIMsgSend);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineat">@@ -68,19 +71,17 @@ function copyFileMessageInLocalFolder(aM</span>
<a href="#l4.20"></a><span id="l4.20">                      gCopyListener,</span>
<a href="#l4.21"></a><span id="l4.21">                      aMessageWindow);</span>
<a href="#l4.22"></a><span id="l4.22"> }</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> // The attatchment file can not be obtained from js test,</span>
<a href="#l4.25"></a><span id="l4.25"> // so we have to generate the file name here.</span>
<a href="#l4.26"></a><span id="l4.26"> function createExpectedTemporaryFile() {</span>
<a href="#l4.27"></a><span id="l4.27">   function createTemporaryFile() {</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-    let file = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-                 .getService(Ci.nsIProperties)</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-                 .get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    let file = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l4.32"></a><span id="l4.32">     file.append(&quot;nsmail.tmp&quot;);</span>
<a href="#l4.33"></a><span id="l4.33">     file.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0600);</span>
<a href="#l4.34"></a><span id="l4.34">     return file;</span>
<a href="#l4.35"></a><span id="l4.35">   }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   let dummyFile = createTemporaryFile();</span>
<a href="#l4.38"></a><span id="l4.38">   do_register_cleanup(function() {</span>
<a href="#l4.39"></a><span id="l4.39">     dummyFile.remove(false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword2.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword2.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,24 +1,23 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /**</span>
<a href="#l5.6"></a><span id="l5.6">  * Extra tests for SMTP passwords (forgetPassword)</span>
<a href="#l5.7"></a><span id="l5.7">  */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11"> const kUser1 = &quot;testsmtp&quot;;</span>
<a href="#l5.12"></a><span id="l5.12"> const kUser2 = &quot;testsmtpa&quot;;</span>
<a href="#l5.13"></a><span id="l5.13"> const kProtocol = &quot;smtp&quot;;</span>
<a href="#l5.14"></a><span id="l5.14"> const kHostname = &quot;localhost&quot;;</span>
<a href="#l5.15"></a><span id="l5.15"> const kServerUrl = kProtocol + &quot;://&quot; + kHostname;</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> function run_test()</span>
<a href="#l5.18"></a><span id="l5.18"> {</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-  // Login Manager</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-  var loginMgr = Cc[&quot;@mozilla.org/login-manager;1&quot;].getService(Ci.nsILoginManager);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-</span>
<a href="#l5.22"></a><span id="l5.22">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l5.23"></a><span id="l5.23">   var signons = do_get_file(&quot;../../../data/signons-mailnews1.8-multiple.txt&quot;);</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   // Copy the file to the profile directory for a PAB</span>
<a href="#l5.26"></a><span id="l5.26">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   // Set up the basic accounts and folders.</span>
<a href="#l5.29"></a><span id="l5.29">   loadLocalMailAccount();</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineat">@@ -30,38 +29,38 @@ function run_test()</span>
<a href="#l5.31"></a><span id="l5.31">   smtpServer1.username = kUser1;</span>
<a href="#l5.32"></a><span id="l5.32">   smtpServer2.authMethod = 3;</span>
<a href="#l5.33"></a><span id="l5.33">   smtpServer2.username = kUser2;</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">   var i;</span>
<a href="#l5.36"></a><span id="l5.36">   var count = {};</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">   // Test - Check there are two logins to begin with.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  var logins = loginMgr.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  let logins = Services.logins.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">   do_check_eq(count.value, 2);</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">   // These will either be one way around or the other.</span>
<a href="#l5.45"></a><span id="l5.45">   if (logins[0].username == kUser1) {</span>
<a href="#l5.46"></a><span id="l5.46">     do_check_eq(logins[1].username, kUser2);</span>
<a href="#l5.47"></a><span id="l5.47">   } else {</span>
<a href="#l5.48"></a><span id="l5.48">     do_check_eq(logins[0].username, kUser2);</span>
<a href="#l5.49"></a><span id="l5.49">     do_check_eq(logins[1].username, kUser1);</span>
<a href="#l5.50"></a><span id="l5.50">   }</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">   // Test - Remove a login via the incoming server</span>
<a href="#l5.53"></a><span id="l5.53">   smtpServer1.forgetPassword();</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-  logins = logins = loginMgr.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+  logins = Services.logins.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58">   // should be one login left for kUser2</span>
<a href="#l5.59"></a><span id="l5.59">   do_check_eq(count.value, 1);</span>
<a href="#l5.60"></a><span id="l5.60">   do_check_eq(logins[0].username, kUser2);</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">   // Test - Remove the other login via the incoming server</span>
<a href="#l5.63"></a><span id="l5.63">   smtpServer2.forgetPassword();</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-  logins = logins = loginMgr.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  logins = Services.logins.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">   // should be one login left for kUser2</span>
<a href="#l5.69"></a><span id="l5.69">   do_check_eq(count.value, 0);</span>
<a href="#l5.70"></a><span id="l5.70">   do_check_eq(logins.length, 0);</span>
<a href="#l5.71"></a><span id="l5.71"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -5,16 +5,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  *   - Check we get a prompt asking what to do.</span>
<a href="#l6.5"></a><span id="l6.5">  *   - Check retry does what it should do.</span>
<a href="#l6.6"></a><span id="l6.6">  *   - Check cancel does what it should do.</span>
<a href="#l6.7"></a><span id="l6.7">  *</span>
<a href="#l6.8"></a><span id="l6.8">  * XXX Due to problems with the fakeserver + smtp not using one connection for</span>
<a href="#l6.9"></a><span id="l6.9">  * multiple sends, the rest of this test is in test_smtpPasswordFailure2.js.</span>
<a href="#l6.10"></a><span id="l6.10">  */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> var server;</span>
<a href="#l6.18"></a><span id="l6.18"> var attempt = 0;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -104,20 +105,19 @@ function run_test() {</span>
<a href="#l6.22"></a><span id="l6.22">     server.performTest();</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">     dump(&quot;End Send\n&quot;);</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">     do_check_eq(attempt, 2);</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28">     // Check that we haven't forgetton the login even though we've retried and</span>
<a href="#l6.29"></a><span id="l6.29">     // canceled.</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-    let loginMgr = Cc[&quot;@mozilla.org/login-manager;1&quot;].getService(Ci.nsILoginManager);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-</span>
<a href="#l6.32"></a><span id="l6.32">     let count = {};</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    let logins = loginMgr.findLogins(count, &quot;smtp://localhost&quot;, null,</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    let logins = Services.logins</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+                         .findLogins(count, &quot;smtp://localhost&quot;, null,</span>
<a href="#l6.36"></a><span id="l6.36">                                      &quot;smtp://localhost&quot;);</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">     do_check_eq(count.value, 1);</span>
<a href="#l6.39"></a><span id="l6.39">     do_check_eq(logins[0].username, kUsername);</span>
<a href="#l6.40"></a><span id="l6.40">     do_check_eq(logins[0].password, kInvalidPassword);</span>
<a href="#l6.41"></a><span id="l6.41">   } catch (e) {</span>
<a href="#l6.42"></a><span id="l6.42">     do_throw(e);</span>
<a href="#l6.43"></a><span id="l6.43">   } finally {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -5,16 +5,17 @@</span>
<a href="#l7.4"></a><span id="l7.4">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l7.5"></a><span id="l7.5">  *     we get a new password prompt and can enter the password.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * XXX Due to problems with the fakeserver + smtp not using one connection for</span>
<a href="#l7.8"></a><span id="l7.8">  * multiple sends, the first part of this test is in</span>
<a href="#l7.9"></a><span id="l7.9">  * test_smtpPasswordFailure2.js.</span>
<a href="#l7.10"></a><span id="l7.10">  */</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.13"></a><span id="l7.13"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> var server;</span>
<a href="#l7.18"></a><span id="l7.18"> var attempt = 0;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -129,21 +130,20 @@ function run_test() {</span>
<a href="#l7.22"></a><span id="l7.22">                                        // then we enter the correct password</span>
<a href="#l7.23"></a><span id="l7.23">                                        &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kValidPassword),</span>
<a href="#l7.24"></a><span id="l7.24">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;,</span>
<a href="#l7.25"></a><span id="l7.25">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l7.26"></a><span id="l7.26">                                        &quot;DATA&quot;]);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">       // Now check the new one has been saved.</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-      let loginMgr = Cc[&quot;@mozilla.org/login-manager;1&quot;].getService(Ci.nsILoginManager);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-</span>
<a href="#l7.32"></a><span id="l7.32">       let count = {};</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-      let logins = loginMgr.findLogins(count, &quot;smtp://localhost&quot;, null,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                                     &quot;smtp://localhost&quot;);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+      let logins = Services.logins</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+                           .findLogins(count, &quot;smtp://localhost&quot;, null,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+                                       &quot;smtp://localhost&quot;);</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">     do_check_eq(count.value, 1);</span>
<a href="#l7.40"></a><span id="l7.40">     do_check_eq(logins[0].username, kUsername);</span>
<a href="#l7.41"></a><span id="l7.41">     do_check_eq(logins[0].password, kValidPassword);</span>
<a href="#l7.42"></a><span id="l7.42">     do_test_finished();</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">   } catch (e) {</span>
<a href="#l7.45"></a><span id="l7.45">     do_throw(e);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,16 +3,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * when the server drops the connection on an authentication error.</span>
<a href="#l8.5"></a><span id="l8.5">  * The steps are:</span>
<a href="#l8.6"></a><span id="l8.6">  *   - Have an invalid password in the password database.</span>
<a href="#l8.7"></a><span id="l8.7">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l8.8"></a><span id="l8.8">  *     we get a new password prompt and can enter the password.</span>
<a href="#l8.9"></a><span id="l8.9">  *</span>
<a href="#l8.10"></a><span id="l8.10">  */</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> var server;</span>
<a href="#l8.18"></a><span id="l8.18"> var attempt = 0;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -113,21 +114,20 @@ function run_test() {</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23"> var URLListener = {</span>
<a href="#l8.24"></a><span id="l8.24">   OnStartRunningUrl: function(url) { },</span>
<a href="#l8.25"></a><span id="l8.25">   OnStopRunningUrl: function(url, rc)</span>
<a href="#l8.26"></a><span id="l8.26">   {</span>
<a href="#l8.27"></a><span id="l8.27">     // Check for ok status.</span>
<a href="#l8.28"></a><span id="l8.28">     do_check_eq(rc, 0);</span>
<a href="#l8.29"></a><span id="l8.29">     // Now check the new password has been saved.</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-    let loginMgr = Cc[&quot;@mozilla.org/login-manager;1&quot;].getService(Ci.nsILoginManager);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-</span>
<a href="#l8.32"></a><span id="l8.32">     let count = {};</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-    let logins = loginMgr.findLogins(count, &quot;smtp://localhost&quot;, null,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-                                   &quot;smtp://localhost&quot;);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+    let logins = Services.logins</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+                         .findLogins(count, &quot;smtp://localhost&quot;, null,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+                                     &quot;smtp://localhost&quot;);</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">     do_check_eq(count.value, 1);</span>
<a href="#l8.40"></a><span id="l8.40">     do_check_eq(logins[0].username, kUsername);</span>
<a href="#l8.41"></a><span id="l8.41">     do_check_eq(logins[0].password, kValidPassword);</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43">     server.stop();</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">     var thread = gThreadManager.currentThread;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -2,22 +2,22 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l9.5"></a><span id="l9.5">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> /*</span>
<a href="#l9.8"></a><span id="l9.8">  * Test that stale temporary files are cleaned up when the msg compose service</span>
<a href="#l9.9"></a><span id="l9.9">  * is initialized.</span>
<a href="#l9.10"></a><span id="l9.10">  */</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14"> var gExpectedFiles;</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> function create_temporary_files_for(name) {</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-  let file = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-               .getService(Ci.nsIProperties)</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-               .get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  let file = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l9.21"></a><span id="l9.21">   file.append(name);</span>
<a href="#l9.22"></a><span id="l9.22">   file.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0600);</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">   return file;</span>
<a href="#l9.25"></a><span id="l9.25"> }</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> function collect_expected_temporary_files() {</span>
<a href="#l9.28"></a><span id="l9.28">   let files = [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_temporaryFilesRemoved.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_temporaryFilesRemoved.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.6"></a><span id="l10.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> /*</span>
<a href="#l10.9"></a><span id="l10.9">  * Test that temporary files for draft are surely removed.</span>
<a href="#l10.10"></a><span id="l10.10">  */</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14"> var gMsgCompose;</span>
<a href="#l10.15"></a><span id="l10.15"> var gExpectedFiles;</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> var progressListener = {</span>
<a href="#l10.18"></a><span id="l10.18">   onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l10.19"></a><span id="l10.19">     if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP)</span>
<a href="#l10.20"></a><span id="l10.20">       do_timeout(0, check_result);</span>
<a href="#l10.21"></a><span id="l10.21">   },</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -26,19 +28,17 @@ var progressListener = {</span>
<a href="#l10.23"></a><span id="l10.23">         iid.equals(Ci.nsISupports))</span>
<a href="#l10.24"></a><span id="l10.24">       return this;</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">     throw Components.results.NS_NOINTERFACE;</span>
<a href="#l10.27"></a><span id="l10.27">   }</span>
<a href="#l10.28"></a><span id="l10.28"> };</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30"> function get_temporary_files_for(name) {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  let file = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-               .getService(Ci.nsIProperties)</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-               .get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  let file = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l10.35"></a><span id="l10.35">   file.append(name);</span>
<a href="#l10.36"></a><span id="l10.36">   file.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0600);</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38">   file.remove(false);</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40">   return file;</span>
<a href="#l10.41"></a><span id="l10.41"> }</span>
<a href="#l10.42"></a><span id="l10.42"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

