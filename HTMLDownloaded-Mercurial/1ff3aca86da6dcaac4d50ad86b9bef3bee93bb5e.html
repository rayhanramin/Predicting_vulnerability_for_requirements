<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1584:1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e" />
<meta property="og:url" content="/comm-central/rev/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e" />
<meta property="og:description" content="Fix bug 439620 - Calendars without proper provider deployment should be marked as &quot;disabled&quot;. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e">shortlog</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e">files</a> |
changeset |
<a href="/comm-central/raw-rev/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e">raw</a>  | <a href="/comm-central/archive/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=439620">bug 439620</a> - Calendars without proper provider deployment should be marked as &quot;disabled&quot;. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#110;&#105;&#101;&#108;&#32;&#66;&#111;&#101;&#108;&#122;&#108;&#101;&#32;&#91;&#58;&#100;&#98;&#111;&#93;&#32;&#60;&#100;&#97;&#110;&#105;&#101;&#108;&#46;&#98;&#111;&#101;&#108;&#122;&#108;&#101;&#64;&#115;&#117;&#110;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 08 Jan 2009 23:22:02 +0100</td></tr>

<tr>
 <td>changeset 1584</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e">1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e</a></td>
</tr>



<tr>
<td>parent 1583</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6cf9e90978b146084075dd9c6a5e3e68a35512df">6cf9e90978b146084075dd9c6a5e3e68a35512df</a>
</td>
</tr>

<tr>
<td>child 1585</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/05d7c1308855b243d04372f3449a8ef9e72fbf12">05d7c1308855b243d04372f3449a8ef9e72fbf12</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e">1265</a></td></tr>
<tr><td>push user</td><td>daniel.boelzle@sun.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 08 Jan 2009 22:24:09 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1ff3aca86da6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e&newProject=comm-central&newRevision=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e&newProject=comm-central&newRevision=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e&newProject=comm-central&newRevision=1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=439620">439620</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=439620">bug 439620</a> - Calendars without proper provider deployment should be marked as &quot;disabled&quot;. r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/content/calendar-properties-dialog.js">calendar/base/content/calendar-properties-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/content/calendar-properties-dialog.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/content/calendar-properties-dialog.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/content/calendar-properties-dialog.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/content/calendar-properties-dialog.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/content/calendar-properties-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/Makefile.in">calendar/base/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calAuthUtils.jsm">calendar/base/modules/calAuthUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calAuthUtils.jsm">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calAuthUtils.jsm">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calAuthUtils.jsm">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calAuthUtils.jsm">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calAuthUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/public/calICalendar.idl">calendar/base/public/calICalendar.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/public/calICalendar.idl">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/public/calICalendar.idl">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/public/calICalendar.idl">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/public/calICalendar.idl">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/public/calICalendar.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/Makefile.in">calendar/base/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calAuthUtils.js">calendar/base/src/calAuthUtils.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calAuthUtils.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calAuthUtils.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calAuthUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calProviderUtils.js">calendar/base/src/calProviderUtils.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calProviderUtils.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calProviderUtils.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/base/src/calProviderUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/removed-files.in">calendar/installer/removed-files.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/removed-files.in">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/removed-files.in">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/removed-files.in">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/removed-files.in">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/removed-files.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/windows/packages-static">calendar/installer/windows/packages-static</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/windows/packages-static">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/windows/packages-static">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/windows/packages-static">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/windows/packages-static">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/installer/windows/packages-static">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/Makefile.in">calendar/providers/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/Makefile.in">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/Makefile.in">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/Makefile.in">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/Makefile.in">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/base/Makefile.in">calendar/providers/base/Makefile.in</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/base/Makefile.in">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/base/Makefile.in">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/base/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/base/calProviderBase.js">calendar/providers/base/calProviderBase.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/base/calProviderBase.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/base/calProviderBase.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/base/calProviderBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendarModule.js">calendar/providers/caldav/calDavCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendarModule.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendarModule.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/caldav/calDavCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendarModule.js">calendar/providers/gdata/components/calGoogleCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendarModule.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendarModule.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleRequest.js">calendar/providers/gdata/components/calGoogleRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleRequest.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleRequest.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleRequest.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleRequest.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleSession.js">calendar/providers/gdata/components/calGoogleSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleSession.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleSession.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleSession.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleSession.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleSession.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleUtils.js">calendar/providers/gdata/components/calGoogleUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleUtils.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleUtils.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleUtils.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleUtils.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/gdata/components/calGoogleUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendarModule.js">calendar/providers/ics/calICSCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendarModule.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendarModule.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/ics/calICSCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendarModule.js">calendar/providers/memory/calMemoryCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendarModule.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendarModule.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/memory/calMemoryCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendarModule.js">calendar/providers/storage/calStorageCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendarModule.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendarModule.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/storage/calStorageCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendarModule.js">calendar/providers/wcap/calWcapCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendarModule.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendarModule.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/1ff3aca86da6dcaac4d50ad86b9bef3bee93bb5e/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-properties-dialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-properties-dialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -70,18 +70,23 @@ function onLoad() {</span>
<a href="#l1.4"></a><span id="l1.4">     var suppressAlarmsRow = document.getElementById(&quot;calendar-suppressAlarms-row&quot;);</span>
<a href="#l1.5"></a><span id="l1.5">     var suppressAlarms = gCalendar.getProperty('suppressAlarms');</span>
<a href="#l1.6"></a><span id="l1.6">     document.getElementById(&quot;fire-alarms&quot;).checked = !suppressAlarms;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">     suppressAlarmsRow.hidden =</span>
<a href="#l1.9"></a><span id="l1.9">         (gCalendar.getProperty(&quot;capabilities.alarms.popup.supported&quot;) === false);</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     // Set up the disabled checkbox</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    var calendarDisabled = gCalendar.getProperty(&quot;disabled&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    document.getElementById(&quot;calendar-enabled-checkbox&quot;).checked = !calendarDisabled;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    let calendarDisabled = false;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    if (gCalendar.getProperty(&quot;force-disabled&quot;)) {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+        document.getElementById(&quot;calendar-enabled-checkbox&quot;).disabled = true;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    } else {</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        calendarDisabled = gCalendar.getProperty(&quot;disabled&quot;);</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+        document.getElementById(&quot;calendar-enabled-checkbox&quot;).checked = !calendarDisabled;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    }</span>
<a href="#l1.21"></a><span id="l1.21">     setupEnabledCheckbox();</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">     // start focus on title, unless we are disabled</span>
<a href="#l1.24"></a><span id="l1.24">     if (!calendarDisabled) {</span>
<a href="#l1.25"></a><span id="l1.25">         document.getElementById(&quot;calendar-name&quot;).focus();</span>
<a href="#l1.26"></a><span id="l1.26">     }</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">     sizeToContent();</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineat">@@ -101,19 +106,21 @@ function onAcceptDialog() {</span>
<a href="#l1.30"></a><span id="l1.30">     gCalendar.readOnly = document.getElementById(&quot;read-only&quot;).checked;</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">     // Save supressAlarms</span>
<a href="#l1.33"></a><span id="l1.33">     gCalendar.setProperty(&quot;suppressAlarms&quot;, !document.getElementById(&quot;fire-alarms&quot;).checked);</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">     // Save cache options</span>
<a href="#l1.36"></a><span id="l1.36">     gCalendar.setProperty(&quot;cache.enabled&quot;, document.getElementById(&quot;cache&quot;).checked);</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    // Save disabled option (should do this last), remove auto-enabled</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    gCalendar.setProperty(&quot;disabled&quot;, !document.getElementById(&quot;calendar-enabled-checkbox&quot;).checked);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-    gCalendar.deleteProperty(&quot;auto-enabled&quot;);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    if (!gCalendar.getProperty(&quot;force-disabled&quot;)) {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+        // Save disabled option (should do this last), remove auto-enabled</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+        gCalendar.setProperty(&quot;disabled&quot;, !document.getElementById(&quot;calendar-enabled-checkbox&quot;).checked);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+        gCalendar.deleteProperty(&quot;auto-enabled&quot;);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+    }</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">     // tell standard dialog stuff to close the dialog</span>
<a href="#l1.48"></a><span id="l1.48">     return true;</span>
<a href="#l1.49"></a><span id="l1.49"> }</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51"> /**</span>
<a href="#l1.52"></a><span id="l1.52">  * When the calendar is disabled, we need to disable a number of other elements</span>
<a href="#l1.53"></a><span id="l1.53">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> # Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.5"></a><span id="l2.5"> # WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.6"></a><span id="l2.6"> # for the specific language governing rights and limitations under the</span>
<a href="#l2.7"></a><span id="l2.7"> # License.</span>
<a href="#l2.8"></a><span id="l2.8"> #</span>
<a href="#l2.9"></a><span id="l2.9"> # The Original Code is Sun Microsystems code.</span>
<a href="#l2.10"></a><span id="l2.10"> #</span>
<a href="#l2.11"></a><span id="l2.11"> # The Initial Developer of the Original Code is</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-# Sun Microsystems, Inc.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#   Sun Microsystems, Inc.</span>
<a href="#l2.14"></a><span id="l2.14"> # Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l2.15"></a><span id="l2.15"> # the Initial Developer. All Rights Reserved.</span>
<a href="#l2.16"></a><span id="l2.16"> #</span>
<a href="#l2.17"></a><span id="l2.17"> # Contributor(s):</span>
<a href="#l2.18"></a><span id="l2.18"> #   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l2.19"></a><span id="l2.19"> #</span>
<a href="#l2.20"></a><span id="l2.20"> # Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.21"></a><span id="l2.21"> # either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -43,11 +43,13 @@ VPATH     = @srcdir@</span>
<a href="#l2.23"></a><span id="l2.23"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> MODULE = calbase</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> EXTRA_JS_MODULES = \</span>
<a href="#l2.28"></a><span id="l2.28">     calUtils.jsm \</span>
<a href="#l2.29"></a><span id="l2.29">     calIteratorUtils.jsm \</span>
<a href="#l2.30"></a><span id="l2.30">     calItipUtils.jsm \</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    calProviderUtils.jsm \</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    calAuthUtils.jsm \</span>
<a href="#l2.33"></a><span id="l2.33">     $(NULL)</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,378 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ *</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * License.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ *</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ * The Original Code is Calendar component utils.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ *</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ *</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ *</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ *</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+/*</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ * Authentication helper code</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ */</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+cal.auth = {</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    /**</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+     * Auth prompt implementation - Uses password manager if at all possible.</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+     */</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    Prompt: function calPrompt() {</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+        // use the window watcher service to get a nsIAuthPrompt impl</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+        this.mPrompter = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+                                   .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+                                   .getNewAuthPrompter(null);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+        this.mTriedStoredPassword = false;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    },</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    /**</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+     * Tries to get the username/password combination of a specific calendar name</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+     * from the password manager or asks the user.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+     *</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+     * @param   in aTitle           The dialog title.</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+     * @param   in aCalendarName    The calendar name or url to look up. Can be null.</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+     * @param   inout aUsername     The username that belongs to the calendar.</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+     * @param   inout aPassword     The password that belongs to the calendar.</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+     * @param   inout aSavePassword Should the password be saved?</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+     * @param   in aFixedUsername   Whether the user name is fixed or editable</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+     * @return  Could a password be retrieved?</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+     */</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    getCredentials: function calGetCredentials(aTitle,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+                                               aCalendarName,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+                                               aUsername,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+                                               aPassword,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+                                               aSavePassword,</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+                                               aFixedUsername) {</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+        if (typeof aUsername != &quot;object&quot; ||</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+            typeof aPassword != &quot;object&quot; ||</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+            typeof aSavePassword != &quot;object&quot;) {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+            throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+        }</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+        let watcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+                                .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+        let prompter = watcher.getNewPrompter(null);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+        // Only show the save password box if we are supposed to.</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+        let savepassword = null;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+        if (cal.getPrefSafe(&quot;signon.rememberSignons&quot;, true)) {</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+            savepassword = cal.calGetString(&quot;passwordmgr&quot;, &quot;rememberPassword&quot;, null, &quot;passwordmgr&quot;);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+        }</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+        let aText;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+        if (aFixedUsername) {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+            aText = cal.calGetString(&quot;prompts&quot;, &quot;EnterPasswordFor&quot;, [aUsername.value, aCalendarName], &quot;global&quot;);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+            return prompter.promptPassword(aTitle,</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+                                           aText,</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+                                           aPassword,</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+                                           savepassword,</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+                                           aSavePassword);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+        } else {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+            aText = cal.calGetString(&quot;prompts&quot;, &quot;EnterUserPasswordFor&quot;, [aCalendarName], &quot;global&quot;);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+            return prompter.promptUsernameAndPassword(aTitle,</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+                                                      aText,</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+                                                      aUsername,</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+                                                      aPassword,</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+                                                      savepassword,</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+                                                      aSavePassword);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+        }</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+    },</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    /**</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+     * Helper to insert/update an entry to the password manager.</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+     *</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+     * @param aUserName     The username</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+     * @param aPassword     The corresponding password</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+     * @param aHostName     The corresponding hostname</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+     * @param aRealm        The password realm (unused on branch)</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+     */</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+    passwordManagerSave: function calPasswordManagerSave(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+        cal.ASSERT(aUsername);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+        cal.ASSERT(aPassword);</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+        try {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+            if (Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]) {</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+                cal.auth.passwordManagerRemove(aUsername, aHostName, aRealm);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+                let passwordManager = Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+                                                .getService(Components.interfaces.nsIPasswordManager);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+                if (aHostName &amp;&amp; aHostName[aHostName.length - 1] == '/') {</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+                    // strip trailing slash on branch:</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+                    aHostName = aHostName.substr(0, aHostName.length - 1);</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+                }</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+                passwordManager.addUser(aHostName, aUsername, aPassword);</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+            } else if (Components.classes[&quot;@mozilla.org/login-manager;1&quot;]) {</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+                // Trunk uses LoginManager</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+                let loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+                                             .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+                let logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+                if (logins.length &gt; 0) {</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+                    let loginInfo = logins[0].clone();</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+                    loginInfo.password = aPassword;</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+                    loginManager.modifyLogin(logins[0], loginInfo);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+                } else {</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+                    let loginInfo = Components.classes[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+                                              .createInstance(Components.interfaces.nsILoginInfo);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+                    loginInfo.init(aHostName,</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+                                   null, aRealm,</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+                                   aUsername, aPassword,</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+                                   null, null);</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+                    loginManager.addLogin(loginInfo);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+                }</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+            }</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+        } catch (exc) {</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+            cal.ASSERT(false, exc);</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+        }</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+    },</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+    /**</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+     * Helper to retrieve an entry from the password manager.</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+     *</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+     * @param in  aUsername     The username to search</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+     * @param out aPassword     The corresponding password</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+     * @param aHostName         The corresponding hostname</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+     * @param aRealm            The password realm (unused on branch)</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+     * @return                  Does an entry exist in the password manager</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+     */</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+    passwordManagerGet: function calPasswordManagerGet(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+        cal.ASSERT(aUsername);</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+        if (typeof aPassword != &quot;object&quot;) {</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+            throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+        }</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+        try {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+            if (Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]) {</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+                // Branch uses PasswordManager</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+                let passwordManager = Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+                                                .getService(Components.interfaces.nsIPasswordManager);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+                if (aHostName &amp;&amp; aHostName[aHostName.length - 1] == '/') {</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+                    // strip trailing slash on branch:</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+                    aHostName = aHostName.substr(0, aHostName.length - 1);</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+                }</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+                let enumerator = passwordManager.enumerator;</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+                while (enumerator.hasMoreElements()) {</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+                    let entry = enumerator.getNext().QueryInterface(Components.interfaces.nsIPassword);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+                    if ((entry.host == aHostName) &amp;&amp;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+                        (entry.user == aUsername)) {</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+                        aPassword.value = entry.password;</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+                        return true;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+                    }</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+                }</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+            } else if (Components.classes[&quot;@mozilla.org/login-manager;1&quot;]) {</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+                // Trunk uses LoginManager</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+                let loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+                                             .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+                if (!loginManager.getLoginSavingEnabled(aUsername)) {</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+                    return false;</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+                }</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+                let logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+                for each (let loginInfo in logins) {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+                    if (loginInfo.username == aUsername) {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+                        aPassword.value = loginInfo.password;</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+                        return true;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+                    }</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+                }</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+            }</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+        } catch (exc) {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+            cal.ASSERT(false, exc);</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+        }</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+        return false;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+    },</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+    /**</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+     * Helper to remove an entry from the password manager</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+     *</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+     * @param aUsername     The username to remove.</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+     * @param aHostName     The corresponding hostname</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+     * @param aRealm        The password realm (unused on branch)</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+     * @return              Could the user be removed?</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+     */</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+    passwordManagerRemove: function calPasswordManagerRemove(aUsername, aHostName, aRealm) {</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+        cal.ASSERT(aUsername);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+        try {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+            if (Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]) {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+                // Branch uses PasswordManager</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+                let passwordManager = Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+                                                .getService(Components.interfaces.nsIPasswordManager);</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+                if (aHostName &amp;&amp; aHostName[aHostName.length - 1] == '/') {</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+                    // strip trailing slash on branch:</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+                    aHostName = aHostName.substr(0, aHostName.length - 1);</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+                }</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+                passwordManager.removeUser(aHostName, aUsername);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+                return true;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+            } else if (Components.classes[&quot;@mozilla.org/login-manager;1&quot;]) {</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+                // Trunk uses LoginManager</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+                let loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+                                             .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+                let logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+                for each (let loginInfo in logins) {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+                    if (loginInfo.username == aUsername) {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+                        loginManager.removeLogin(loginInfo);</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+                        return true;</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+                    }</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+                }</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+            }</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+        } catch (exc) {</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+        }</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+        return false;</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+    }</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+};</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+cal.auth.Prompt.prototype = {</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+    prompt: function capP(aDialogTitle, aText, aPasswordRealm, aSavePassword, aDefaultText, aResult) {</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+        return this.mPrompter.prompt(aDialogTitle,</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+                                     aText,</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+                                     aPasswordRealm,</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+                                     aSavePassword,</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+                                     aDefaultText,</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+                                     aResult);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+    },</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+    getPasswordInfo: function capGPI(aPasswordRealm) {</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+        let username;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+        let password;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+        let found = false;</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+        if (&quot;@mozilla.org/passwordmanager;1&quot; in Components.classes) {</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+            let passwordManager = Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+                                            .getService(Components.interfaces.nsIPasswordManager);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+            let passwordRealm = aPasswordRealm.passwordRealm || aPasswordRealm;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+            let pwenum = passwordManager.enumerator;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+            // step through each password in the password manager until we find the one we want:</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+            while (pwenum.hasMoreElements()) {</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+                try {</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+                    let pass = pwenum.getNext().QueryInterface(Components.interfaces.nsIPassword);</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+                    if (pass.host == passwordRealm) {</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+                         // found it!</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+                         username = pass.user;</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+                         password = pass.password;</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+                         found = true;</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+                    }</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+                } catch (ex) {</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+                    // don't do anything here, ignore the password that could not be read</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+                }</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+            }</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+        } else {</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+            let loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+                                         .getService(Components.interfaces</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+                                         .nsILoginManager);</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+            let logins = loginManager.findLogins({}, aPasswordRealm.prePath, null,</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+                                                 aPasswordRealm.realm);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+            if (logins.length) {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+                username = logins[0].username;</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+                password = logins[0].password;</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+                found = true;</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+            }</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+        }</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+        return {found: found, username: username, password: password};</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+    },</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+    promptUsernameAndPassword: function capPUAP(aDialogTitle, aText,</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+                                                aPasswordRealm, aSavePassword,</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+                                                aUser, aPwd) {</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+        let pw;</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+        if (!this.mTriedStoredPassword) {</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+            pw = this.getPasswordInfo(aPasswordRealm);</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+        }</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+        if (pw &amp;&amp; pw.found) {</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+            this.mTriedStoredPassword = true;</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+            aUser.value = pw.username;</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+            aPwd.value = pw.password;</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+            return true;</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+        } else {</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+            return this.mPrompter.promptUsernameAndPassword(aDialogTitle,</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+                                                            aText,</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+                                                            aPasswordRealm,</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+                                                            aSavePassword,</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+                                                            aUser,</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+                                                            aPwd);</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+        }</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+    },</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+    // promptAuth is needed/used on trunk only</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+    promptAuth: function capPA(aChannel, aLevel, aAuthInfo) {</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+        let hostRealm = {};</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+        hostRealm.prePath = aChannel.URI.prePath;</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+        hostRealm.realm = aAuthInfo.realm;</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+        let port = aChannel.URI.port;</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+        if (port == -1) {</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+            let handler = cal.getIOService().getProtocolHandler(aChannel.URI.scheme)</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+                                            .QueryInterface(Components.interfaces.nsIProtocolHandler);</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+            port = handler.defaultPort;</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+        }</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+        hostRealm.passwordRealm = aChannel.URI.host + &quot;:&quot; + port + &quot; (&quot; + aAuthInfo.realm + &quot;)&quot;;</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+        let pw;</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+        if (!this.mTriedStoredPassword) {</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+            pw = this.getPasswordInfo(hostRealm);</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+        }</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+        if (pw &amp;&amp; pw.found) {</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+            this.mTriedStoredPassword = true;</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+            aAuthInfo.username = pw.username;</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+            aAuthInfo.password = pw.password;</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+            return true;</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+        } else {</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+            let prompter2 = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+                                      .getService(Components.interfaces.nsIPromptFactory)</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+                                      .getPrompt(null, Components.interfaces.nsIAuthPrompt2);</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+            return prompter2.promptAuth(aChannel, aLevel, aAuthInfo);</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+        }</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+    },</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+    promptPassword: function capPP(aDialogTitle, aText, aPasswordRealm,</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+                             aSavePassword, aPwd) {</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+        let found = false;</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+        let pw;</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+        if (!this.mTriedStoredPassword) {</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+            pw = this.getPasswordInfo(aPasswordRealm);</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+        }</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+        if (pw &amp;&amp; pw.found) {</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+            this.mTriedStoredPassword = true;</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+            aPwd.value = pw.password;</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+            return true;</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+        } else {</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+            return this.mPrompter.promptPassword(aDialogTitle,</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+                                                 aText,</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+                                                 aPasswordRealm,</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+                                                 aSavePassword,</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+                                                 aPwd);</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+        }</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+    }</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,601 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * The Original Code is Sun Microsystems code.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ *</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ *   Sun Microsystems, Inc.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ *   Bruno Browning &lt;browning@uwalumni.com&gt;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ *</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ *</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+/*</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+ * Provider helper code</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+ */</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+/**</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+ * Prepare HTTP channel with standard request headers and upload</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+ * data/content-type if needed</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+ *</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+ * @param arUri                      Channel Uri, will only be used for a new</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+ *                                     channel.</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+ * @param aUploadData                Data to be uploaded, if any. This may be a</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+ *                                     nsIInputStream or string data. In the</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+ *                                     latter case the string will be converted</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+ *                                     to an input stream.</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+ * @param aContentType               Value for Content-Type header, if any</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+ * @param aNotificationCallbacks     Calendar using channel</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+ * @param aExisting                  An existing channel to modify (optional)</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+ */</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+cal.prepHttpChannel = function calPrepHttpChannel(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting) {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    let channel = aExisting || cal.getIOService().newChannelFromURI(aUri);</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/xml&quot;, false);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+    httpchannel.setRequestHeader(&quot;Accept-Charset&quot;, &quot;utf-8,*;q=0.1&quot;, false);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    httpchannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+    httpchannel.notificationCallbacks = aNotificationCallbacks;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    if (aUploadData) {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+        httpchannel = httpchannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+        let stream;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+        if (aUploadData instanceof Components.interfaces.nsIInputStream) {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+            // Make sure the stream is reset</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+            stream = aUploadData.QueryInterface(Components.interfaces.nsISeekableStream);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+            stream.seek(Components.interfaces.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+        } else {</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+            // Otherwise its something that should be a string, convert it.</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+            let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+                                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+            converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+            stream = converter.convertToInputStream(aUploadData.toString());</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+        }</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+        httpchannel.setUploadStream(stream, aContentType, -1);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+    }</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+    return httpchannel;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+};</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+/**</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+ * calSendHttpRequest; send prepared HTTP request</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+ *</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+ * @param aStreamLoader     streamLoader for request</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+ * @param aChannel          channel for request</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+ * @param aListener         listener for method completion</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+ */</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+cal.sendHttpRequest = function calSendHttpRequest(aStreamLoader, aChannel, aListener) {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    aStreamLoader.init(aListener);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    aChannel.asyncOpen(aStreamLoader, aChannel);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+};</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+cal.createStreamLoader = function calCreateStreamLoader() {</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    return Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+                     .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+};</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+cal.convertByteArray = function calConvertByteArray(aResult, aResultLength, aCharset, aThrow) {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    try {</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+        let resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+                                        .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+        resultConverter.charset = aCharset || &quot;UTF-8&quot;;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+        return resultConverter.convertFromByteArray(aResult, aResultLength);</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+        if (aThrow) {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+            throw e;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+        }</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    }</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+    return null;</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+};</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+cal.safeNewXML = function calSafeNewXML(aStr) {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+    // Strip &lt;?xml and surrounding whitespaces</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+    return new XML(aStr.replace(/(^\s*(&lt;\?xml[^&gt;]*&gt;)?\s*|\s+$)/g, &quot;&quot;));</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+};</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    </span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+/**</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+ * getInterface method for providers. This should be called in the context of</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+ * the respective provider, i.e</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+ *</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+ * return cal.InterfaceRequestor_getInterface.apply(this, arguments);</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+ *</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+ * or</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+ * ...</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+ * getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+ * ...</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+ *</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+ * @param aIID      The interface ID to return</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+ */</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+cal.InterfaceRequestor_getInterface = function calInterfaceRequestor_getInterface(aIID) {</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    // Support Auth Prompt Interfaces</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+    if (aIID.equals(Components.interfaces.nsIAuthPrompt) ||</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+        (Components.interfaces.nsIAuthPrompt2 &amp;&amp;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+         aIID.equals(Components.interfaces.nsIAuthPrompt2))) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+        return new cal.auth.Prompt();</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+    } else if (aIID.equals(Components.interfaces.nsIAuthPromptProvider) ||</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+               aIID.equals(Components.interfaces.nsIPrompt)) {</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+        return Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+                         .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+                         .getNewPrompter(null);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+    }</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+    try {</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+        // Try to query the this object for the requested interface but don't</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+        // throw if it fails since that borks the network code.</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+        return this.QueryInterface(aIID);</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+        Components.returnCode = e;</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+    }</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+    return null;</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+};</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+/**</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+ * Freebusy interval implementation. All parameters are optional.</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+ *</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+ * @param aCalId         The calendar id to set up with.</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+ * @param aFreeBusyType  The type from calIFreeBusyInterval.</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+ * @param aStart         The start of the interval.</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+ * @param aEnd           The end of the interval.</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+ * @return               The fresh calIFreeBusyInterval.</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+ */</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+cal.FreeBusyInterval = function calFreeBusyInterval(aCalId, aFreeBusyType, aStart, aEnd) {</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+    this.calId = aCalId</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    this.interval = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+                              .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+    this.interval.start = aStart;</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+    this.interval.end = aEnd;</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+    this.freeBusyType = aFreeBusyType || Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+};</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+cal.FreeBusyInterval.prototype = {</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+    QueryInterface: function cFBI_QueryInterface(aIID) {</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+        return doQueryInterface(this,</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+                                cal.FreeBusyInterval.prototype,</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+                                aIID,</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+                                [Components.interfaces.calIFreeBusyInterval]);</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+    },</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+    calId: null,</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+    interval: null,</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+    freeBusyType: Components.interfaces.calIFreeBusyInterval.UNKNOWN</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+};</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+/**</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+ * Gets the iTIP/iMIP transport if the passed calendar has configured email.</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+ */</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+cal.getImipTransport = function calGetImipTransport(aCalendar) {</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+    // assure an identity is configured for the calendar</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+    return (aCalendar.getProperty(&quot;imip.identity&quot;)</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+            ? Components.classes[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;]</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+                        .getService(Components.interfaces.calIItipTransport)</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+            : null);</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+};</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+/**</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+ * Gets the configured identity and account of a particular calendar instance, or null.</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+ *</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+ * @param aCalendar     Calendar instance</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+ * @param outAccount    Optional out value for account</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+ * @return              The configured identity</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+ */</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+cal.getEmailIdentityOfCalendar = function calGetEmailIdentityOfCalendar(aCalendar, outAccount) {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+    cal.ASSERT(aCalendar, &quot;no calendar!&quot;, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+    if (cal.isSunbird()) {</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+        return null;</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+    }</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+    let key = aCalendar.getProperty(&quot;imip.identity.key&quot;);</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+    if (key !== null) {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+        if (key.length == 0) { // i.e. &quot;None&quot;</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+            return null;</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+        }</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+        let identity = null;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+        cal.calIterateEmailIdentities(</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+            function(identity_, account) {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+                if (identity_.key == key) {</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+                    identity = identity_;</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+                    if (outAccount) {</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+                        outAccount.value = account;</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+                    }</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+                }</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+                return (identity_.key != key);</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+            });</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+        if (!identity) {</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+            // dangling identity:</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+            cal.WARN(&quot;Calendar &quot; + (aCalendar.uri ? aCalendar.uri.spec : aCalendar.id) +</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+                     &quot; has a dangling E-Mail identity configured.&quot;);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+        }</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+        return identity;</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+    } else { // take default account/identity:</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+        let accounts = cal.getAccountManager().accounts;</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+        let account = null;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+        let identity = null;</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+        try {</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+            account = cal.getAccountManager().defaultAccount;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+        } catch (exc) {}</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+        for (let i = 0; accounts &amp;&amp; (i &lt; accounts.Count()) &amp;&amp; (!account || !identity); ++i) {</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+            if (!account) { // Pick an account only if none was set (i.e there is no default account)</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+                account = accounts.GetElementAt(i);</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+                try {</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+                    account = account.QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+                } catch (exc) {</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+                    account = null;</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+                }</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+            }</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+            if (account &amp;&amp; account.identities.Count()) { // Pick an identity</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+                identity = account.defaultIdentity;</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+                if (!identity) { // there is no default identity, use the first</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+                    identity = account.identities.GetElementAt(0)</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+                                                 .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+                }</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+            } else { // If this account has no identities, continue to the next account.</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+                account = null;</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+            }</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+        }</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+        if (identity) {</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+            // If an identity was set above, set the account out parameter</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+            // and return the identity</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+            if (outAccount) {</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+                outAccount.value = account;</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+            }</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+            return identity;</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+        }</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+        return null;</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+    }</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+};</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+/**</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+ * Base prototype to be used implementing a provider.</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+ *</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+ * @see e.g. providers/gdata</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+ */</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+cal.ProviderBase = function calProviderBase() {</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+    cal.ASSERT(&quot;This prototype should only be inherited!&quot;);</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+};</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+cal.ProviderBase.mTransientProperties = {</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+    &quot;cache.uncachedCalendar&quot;: true,</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+    &quot;currentStatus&quot;: true,</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+    &quot;itip.transport&quot;: true,</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+    &quot;imip.identity&quot;: true,</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+    &quot;imip.account&quot;: true,</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    &quot;imip.identity.disabled&quot;: true,</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+    &quot;organizerId&quot;: true,</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+    &quot;organizerCN&quot;: true</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+};</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+cal.ProviderBase.prototype = {</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+    QueryInterface: function cPB_QueryInterface(aIID) {</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+        return cal.doQueryInterface(this, cal.ProviderBase.prototype, aIID,</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+                                    [Components.interfaces.nsISupports,</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+                                     Components.interfaces.calICalendar,</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+                                     Components.interfaces.calISchedulingSupport]);</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+    },</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+    mID: null,</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+    mUri: null,</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+    mObservers: null,</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+    mProperties: null,</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+    initProviderBase: function cPB_initProviderBase() {</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+        this.wrappedJSObject = this;</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+        this.mObservers = new cal.calListenerBag(Components.interfaces.calIObserver);</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+        this.mProperties = {};</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+        this.mProperties.currentStatus = Components.results.NS_OK;</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+    },</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+    get observers cPB_observers_get() {</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+        return this.mObservers;</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+    },</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+    // attribute AUTF8String id;</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+    get id cPB_id_get() {</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+        return this.mID;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+    },</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+    set id cPB_id_set(aValue) {</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+        if (this.mID) {</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+            throw Components.results.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+        }</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+        this.mID = aValue;</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+//         cal.ASSERT(this.mProperties.toSource() == &quot;({})&quot;, &quot;setProperty calls before id has been set!&quot;);</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+        let calMgr = cal.getCalendarManager();</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+        let this_ = this;</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+        function takeOverIfNotPresent(oldPref, newPref, dontDeleteOldPref) {</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+            let val = calMgr.getCalendarPref_(this_, oldPref);</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+            if (val !== null) {</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+                if (!dontDeleteOldPref) {</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+                    calMgr.deleteCalendarPref_(this_, oldPref);</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+                }</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+                if (calMgr.getCalendarPref_(this_, newPref) === null) {</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+                    calMgr.setCalendarPref_(this_, newPref, val);</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+                }</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+            }</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+        }</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+        // takeover lightning calendar visibility from 0.5:</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+        takeOverIfNotPresent(&quot;lightning-main-in-composite&quot;, &quot;calendar-main-in-composite&quot;);</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+        takeOverIfNotPresent(&quot;lightning-main-default&quot;, &quot;calendar-main-default&quot;);</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+        return aValue;</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+    },</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+    // attribute AUTF8String name;</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+    get name cPB_name_get() {</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+        return this.getProperty(&quot;name&quot;);</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+    },</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+    set name cPB_name_set(aValue) {</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+        return this.setProperty(&quot;name&quot;, aValue);</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+    },</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+    // attribute calICalendar superCalendar;</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+    get superCalendar cPB_superCalendar_get() {</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+        // If we have a superCalendar, check this calendar for a superCalendar.</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+        // This will make sure the topmost calendar is returned</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+        return (this.mSuperCalendar ? this.mSuperCalendar.superCalendar : this);</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+    },</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+    set superCalendar cPB_superCalendar_set(val) {</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+        return (this.mSuperCalendar = val);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+    },</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+    // attribute nsIURI uri;</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+    get uri cPB_uri_get() {</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+        return this.mUri;</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+    },</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+    set uri cPB_uri_set(aValue) {</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+        return (this.mUri = aValue);</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+    },</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+    // attribute boolean readOnly;</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+    get readOnly cPB_readOnly_get() {</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+        return this.getProperty(&quot;readOnly&quot;);</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+    },</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+    set readOnly cPB_readOnly_set(aValue) {</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+        return this.setProperty(&quot;readOnly&quot;, aValue);</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+    },</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+    // readonly attribute boolean canRefresh;</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+    get canRefresh cPB_canRefresh_get() {</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+        return false;</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+    },</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+    // void startBatch();</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+    mBatchCount: 0,</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+    startBatch: function cPB_startBatch() {</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+        if (this.mBatchCount++ == 0) {</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+            this.mObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+        }</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+    },</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+    endBatch: function cPB_endBatch() {</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+        if (this.mBatchCount &gt; 0) {</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+            if (--this.mBatchCount == 0) {</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+                this.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+            }</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+        } else {</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+            cal.ASSERT(this.mBatchCount &gt; 0, &quot;unexepcted endBatch!&quot;);</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+        }</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+    },</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+    notifyOperationComplete: function cPB_notifyOperationComplete(aListener,</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+                                                                  aStatus,</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+                                                                  aOperationType,</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+                                                                  aId,</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+                                                                  aDetail) {</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+        if (aListener) {</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+            try {</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+                aListener.onOperationComplete(this.superCalendar, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+            } catch (exc) {</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+                cal.ERROR(exc);</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+            }</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+        }</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+        if (aStatus == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+            return; // cancellation doesn't change current status, no notification</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+        }</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+        if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+            this.setProperty(&quot;currentStatus&quot;, aStatus);</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+        } else {</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+            if (aDetail instanceof Components.interfaces.nsIException) {</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+                this.notifyError(aDetail); // will set currentStatus</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+            } else {</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+                this.notifyError(aStatus, aDetail); // will set currentStatus</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+            }</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+            this.notifyError(aOperationType == Components.interfaces.calIOperationListener.GET</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+                             ? Components.interfaces.calIErrors.READ_FAILED</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+                             : Components.interfaces.calIErrors.MODIFICATION_FAILED,</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+                             &quot;&quot;);</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+        }</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+    },</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+    // for convenience also callable with just an exception</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+    notifyError: function cPB_notifyError(aErrNo, aMessage) {</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+        if (aErrNo == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+            return; // cancellation doesn't change current status, no notification</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+        }</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+        if (aErrNo instanceof Components.interfaces.nsIException) {</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+            if (!aMessage) {</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+                aMessage = aErrNo.message;</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+            }</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+            aErrNo = aErrNo.result;</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+        }</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+        this.setProperty(&quot;currentStatus&quot;, aErrNo);</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+        this.observers.notify(&quot;onError&quot;, [this.superCalendar, aErrNo, aMessage]);</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+    },</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+    mTransientPropertiesMode: false,</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+    get transientProperties cPB_transientProperties() {</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+        return this.mTransientPropertiesMode;</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+    },</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+    set transientProperties cPB_transientProperties(value) {</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+        return (this.mTransientPropertiesMode = value);</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+    },</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+    // nsIVariant getProperty(in AUTF8String aName);</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+    getProperty: function cPB_getProperty(aName) {</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+        switch (aName) {</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+            case &quot;itip.transport&quot;: // iTIP/iMIP default:</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+                return cal.getImipTransport(this);</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+            case &quot;itip.notify-replies&quot;: // iTIP/iMIP default:</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+                 return cal.getPrefSafe(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+            // temporary hack to get the uncached calendar instance:</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+            case &quot;cache.uncachedCalendar&quot;:</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+                return this;</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+        }</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+        let ret = this.mProperties[aName];</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+        if (ret === undefined) {</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+            ret = null;</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+            switch (aName) {</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+                case &quot;imip.identity&quot;: // we want to cache the identity object a little, because</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+                                      // it is heavily used by the invitation checks</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+                    ret = cal.getEmailIdentityOfCalendar(this);</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+                    break;</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+                case &quot;imip.account&quot;: {</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+                    let outAccount = {};</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+                    if (cal.getEmailIdentityOfCalendar(this, outAccount)) {</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+                        ret = outAccount.value;</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+                    }</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+                    break;</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+                }</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+                case &quot;organizerId&quot;: { // itip/imip default: derived out of imip.identity</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+                    let identity = this.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+                    ret = (identity</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+                           ? (&quot;mailto:&quot; + identity.QueryInterface(Components.interfaces.nsIMsgIdentity).email)</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+                           : null);</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+                    break;</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+                }</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+                case &quot;organizerCN&quot;: { // itip/imip default: derived out of imip.identity</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+                    let identity = this.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+                    ret = (identity</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+                           ? identity.QueryInterface(Components.interfaces.nsIMsgIdentity).fullName</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+                           : null);</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+                    break;</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+                }</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+            }</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+            if ((ret === null) &amp;&amp;</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+                !cal.ProviderBase.mTransientProperties[aName] &amp;&amp;</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+                !this.transientProperties) {</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+                if (this.id) {</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+                    ret = cal.getCalendarManager().getCalendarPref_(this, aName);</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+                }</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+                if (ret !== null) {</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+                    switch (aName) {</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+                        case &quot;suppressAlarms&quot;:</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+                            if (this.getProperty(&quot;capabilities.alarms.popup.supported&quot;) === false) {</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+                                // If popup alarms are not supported,</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineplus">+                                // automatically suppress alarms</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+                                ret = true;</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+                            }</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+                            break;</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+                    }</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineplus">+                }</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+            }</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+            this.mProperties[aName] = ret;</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+        }</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineplus">+//         cal.LOG(&quot;getProperty(\&quot;&quot; + aName + &quot;\&quot;): &quot; + ret);</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+        return ret;</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+    },</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+    // void setProperty(in AUTF8String aName, in nsIVariant aValue);</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+    setProperty: function cPB_setProperty(aName, aValue) {</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+        let oldValue = this.getProperty(aName);</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+        if (oldValue != aValue) {</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+            this.mProperties[aName] = aValue;</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+            switch (aName) {</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+                case &quot;imip.identity.key&quot;: // invalidate identity and account object if key is set:</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+                    delete this.mProperties[&quot;imip.identity&quot;];</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+                    delete this.mProperties[&quot;imip.account&quot;];</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+                    delete this.mProperties[&quot;organizerId&quot;];</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+                    delete this.mProperties[&quot;organizerCN&quot;];</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+                    break;</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+            }</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+            if (!this.transientProperties &amp;&amp;</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+                !cal.ProviderBase.mTransientProperties[aName] &amp;&amp;</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+                this.id) {</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+                cal.getCalendarManager().setCalendarPref_(this, aName, aValue);</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+            }</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineplus">+            this.mObservers.notify(&quot;onPropertyChanged&quot;,</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+                                   [this.superCalendar, aName, aValue, oldValue]);</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+        }</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+        return aValue;</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+    },</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+    // void deleteProperty(in AUTF8String aName);</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineplus">+    deleteProperty: function cPB_deleteProperty(aName) {</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+        this.mObservers.notify(&quot;onPropertyDeleting&quot;, [this.superCalendar, aName]);</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+        delete this.mProperties[aName];</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+        cal.getCalendarManager().deleteCalendarPref_(this, aName);</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+    },</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+    // calIOperation refresh</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+    refresh: function cPB_refresh() {</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+        return null;</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+    },</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+    // void addObserver( in calIObserver observer );</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+    addObserver: function cPB_addObserver(aObserver) {</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+        this.mObservers.add(aObserver);</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+    },</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+    // void removeObserver( in calIObserver observer );</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+    removeObserver: function cPB_removeObserver(aObserver) {</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+        this.mObservers.remove(aObserver);</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+    },</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+    // calISchedulingSupport: Implementation corresponding to our iTIP/iMIP support</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+    isInvitation: function cPB_isInvitation(aItem) {</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+        let id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+        if (id) {</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+            let org = aItem.organizer;</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+            if (!org || (org.id.toLowerCase() == id.toLowerCase())) {</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+                return false;</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+            }</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+            return (aItem.getAttendeeById(id) != null);</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+        }</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+        return false;</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+    },</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+    getInvitedAttendee: function cPB_getInvitedAttendee(aItem) {</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+        let id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+        return (id ? aItem.getAttendeeById(id) : null);</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+    },</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+    canNotify: function cPB_canNotify(aMethod, aItem) {</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+        return false; // use outbound iTIP for all</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+    }</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/public/calICalendar.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/public/calICalendar.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -124,16 +124,17 @@ interface calICalendar : nsISupports</span>
<a href="#l5.4"></a><span id="l5.4">    * callers should use a sensible default in that case.</span>
<a href="#l5.5"></a><span id="l5.5">    *</span>
<a href="#l5.6"></a><span id="l5.6">    * It's up to the provider where to store properties,</span>
<a href="#l5.7"></a><span id="l5.7">    * e.g. on the server or in local prefs.</span>
<a href="#l5.8"></a><span id="l5.8">    *</span>
<a href="#l5.9"></a><span id="l5.9">    * Currently known properties are:</span>
<a href="#l5.10"></a><span id="l5.10">    *   [boolean]  disabled</span>
<a href="#l5.11"></a><span id="l5.11">    *   [boolean]  auto-enabled       If true, the calendar will be enabled on next startup.</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+   *   [boolean]  force-disabled     If true, the calendar cannot be enabled (transient).</span>
<a href="#l5.13"></a><span id="l5.13">    *   [boolean]  calendar-main-in-composite</span>
<a href="#l5.14"></a><span id="l5.14">    *   [string]   name</span>
<a href="#l5.15"></a><span id="l5.15">    *   [boolean]  readOnly</span>
<a href="#l5.16"></a><span id="l5.16">    *   [boolean]  requiresNetwork    If false, the calendar does not require</span>
<a href="#l5.17"></a><span id="l5.17">    *                                   network access at all. This is mainy used</span>
<a href="#l5.18"></a><span id="l5.18">    *                                   as a UI hint.</span>
<a href="#l5.19"></a><span id="l5.19">    *   [boolean]  suppressAlarms     If true, alarms of this calendar are not minded.</span>
<a href="#l5.20"></a><span id="l5.20">    *   [boolean]  cache.supported    If true, the calendar should to be cached,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/src/Makefile.in</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/src/Makefile.in</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -94,18 +94,16 @@ EXTRA_SCRIPTS = \</span>
<a href="#l6.4"></a><span id="l6.4">     calIcsSerializer.js \</span>
<a href="#l6.5"></a><span id="l6.5">     calItemBase.js \</span>
<a href="#l6.6"></a><span id="l6.6">     calItipItem.js \</span>
<a href="#l6.7"></a><span id="l6.7">     calProtocolHandler.js \</span>
<a href="#l6.8"></a><span id="l6.8">     calRecurrenceInfo.js \</span>
<a href="#l6.9"></a><span id="l6.9">     calRelation.js \</span>
<a href="#l6.10"></a><span id="l6.10">     calTodo.js \</span>
<a href="#l6.11"></a><span id="l6.11">     calUtils.js \</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    calAuthUtils.js \</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    calProviderUtils.js \</span>
<a href="#l6.14"></a><span id="l6.14">     calWeekInfoService.js \</span>
<a href="#l6.15"></a><span id="l6.15">     calTransactionManager.js \</span>
<a href="#l6.16"></a><span id="l6.16">     calFreeBusyService.js \</span>
<a href="#l6.17"></a><span id="l6.17">     calCalendarSearchService.js \</span>
<a href="#l6.18"></a><span id="l6.18">     calTimezoneService.js \</span>
<a href="#l6.19"></a><span id="l6.19">     $(NULL)</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> # Use NSINSTALL to make the directory, as there's no mtime to preserve.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/calendar/base/src/calAuthUtils.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,373 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">- *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">- * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">- *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">- * The Original Code is Calendar component utils.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">- *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">- *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">- *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">- *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">- *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">- *</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">- *</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-/**</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">- * Auth prompt implementation - Uses password manager if at all possible.</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">- */</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-function calAuthPrompt() {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    // use the window watcher service to get a nsIAuthPrompt impl</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-    this.mPrompter = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-                               .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-                               .getNewAuthPrompter(null);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    this.mTriedStoredPassword = false;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-}</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-calAuthPrompt.prototype = {</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    prompt: function capP(aDialogTitle, aText, aPasswordRealm, aSavePassword,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-                          aDefaultText, aResult) {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-        return this.mPrompter.prompt(aDialogTitle,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-                                     aText,</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-                                     aPasswordRealm,</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-                                     aSavePassword,</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-                                     aDefaultText,</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-                                     aResult);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    },</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    getPasswordInfo: function capGPI(aPasswordRealm) {</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-        var username;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-        var password;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-        var found = false;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-        if (&quot;@mozilla.org/passwordmanager;1&quot; in Components.classes) {</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-            var passwordManager = Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-                                            .getService(Components.interfaces.nsIPasswordManager);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-            var passwordRealm = aPasswordRealm.passwordRealm || aPasswordRealm;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-            var pwenum = passwordManager.enumerator;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-            // step through each password in the password manager until we find the one we want:</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-            while (pwenum.hasMoreElements()) {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-                try {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-                    var pass = pwenum.getNext().QueryInterface(Components.interfaces.nsIPassword);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-                    if (pass.host == passwordRealm) {</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-                         // found it!</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-                         username = pass.user;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-                         password = pass.password;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-                         found = true;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-                    }</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-                } catch (ex) {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-                    // don't do anything here, ignore the password that could not be read</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-                }</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-            }</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-        } else {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-            var loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-                                         .getService(Components.interfaces</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-                                         .nsILoginManager);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-            var logins = loginManager.findLogins({}, aPasswordRealm.prePath, null,</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-                                                 aPasswordRealm.realm);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-            if (logins.length) {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-                username = logins[0].username;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-                password = logins[0].password;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-                found = true;</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-            }</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-        }</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-        return {found: found, username: username, password: password};</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-    },</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-    promptUsernameAndPassword: function capPUAP(aDialogTitle, aText,</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-                                                aPasswordRealm, aSavePassword,</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-                                                aUser, aPwd) {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-        var pw;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-        if (!this.mTriedStoredPassword) {</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-            pw = this.getPasswordInfo(aPasswordRealm);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-        }</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-        if (pw &amp;&amp; pw.found) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-            this.mTriedStoredPassword = true;</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-            aUser.value = pw.username;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-            aPwd.value = pw.password;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-            return true;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-        } else {</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-            return this.mPrompter.promptUsernameAndPassword(aDialogTitle,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-                                                            aText,</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-                                                            aPasswordRealm,</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-                                                            aSavePassword,</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-                                                            aUser,</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-                                                            aPwd);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-        }</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-    },</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-    // promptAuth is needed/used on trunk only</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    promptAuth: function capPA(aChannel, aLevel, aAuthInfo) {</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-        let hostRealm = {};</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-        hostRealm.prePath = aChannel.URI.prePath;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-        hostRealm.realm = aAuthInfo.realm;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-        let port = aChannel.URI.port;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-        if (port == -1) {</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-            let handler = cal.getIOService().getProtocolHandler(aChannel.URI.scheme)</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-                                        .QueryInterface(Components.interfaces.nsIProtocolHandler);</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-            port = handler.defaultPort;</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-        }</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-        hostRealm.passwordRealm = aChannel.URI.host + &quot;:&quot; + port +</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-                                  &quot; (&quot; + aAuthInfo.realm + &quot;)&quot;;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-        let pw;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-        if (!this.mTriedStoredPassword) {</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-            pw = this.getPasswordInfo(hostRealm);</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-        }</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-        if (pw &amp;&amp; pw.found) {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-            this.mTriedStoredPassword = true;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-            aAuthInfo.username = pw.username;</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-            aAuthInfo.password = pw.password;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-            return true;</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-        } else {</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-            let prompter2 = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptFactory)</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-                                      .getPrompt(null, Components.interfaces.nsIAuthPrompt2);</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-            return prompter2.promptAuth(aChannel, aLevel, aAuthInfo);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-        }</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-    },</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-    promptPassword: function capPP(aDialogTitle, aText, aPasswordRealm,</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-                             aSavePassword, aPwd) {</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-        var found = false;</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-        var pw;</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-        if (!this.mTriedStoredPassword) {</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-            pw = this.getPasswordInfo(aPasswordRealm);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-        }</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-        if (pw &amp;&amp; pw.found) {</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-            this.mTriedStoredPassword = true;</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-            aPwd.value = pw.password;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-            return true;</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-        } else {</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-            return this.mPrompter.promptPassword(aDialogTitle,</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-                                                 aText,</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-                                                 aPasswordRealm,</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-                                                 aSavePassword,</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-                                                 aPwd);</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-        }</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-    }</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-};</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-/**</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">- * Tries to get the username/password combination of a specific calendar name</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">- * from the password manager or asks the user.</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">- *</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">- * @param   in aTitle           The dialog title.</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">- * @param   in aCalendarName    The calendar name or url to look up. Can be null.</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">- * @param   inout aUsername     The username that belongs to the calendar.</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">- * @param   inout aPassword     The password that belongs to the calendar.</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">- * @param   inout aSavePassword Should the password be saved?</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">- * @param   in aFixedUsername   Whether the user name is fixed or editable</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">- * @return  Could a password be retrieved?</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">- */</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-function calGetCredentials(aTitle,</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-                           aCalendarName,</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-                           aUsername,</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-                           aPassword,</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-                           aSavePassword,</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-                           aFixedUsername) {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-    if (typeof aUsername != &quot;object&quot; ||</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-        typeof aPassword != &quot;object&quot; ||</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-        typeof aSavePassword != &quot;object&quot;) {</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-        throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-    }</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-    var watcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-                            .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-    var prompter = watcher.getNewPrompter(null);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-    // Only show the save password box if we are supposed to.</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-    var savepassword = null;</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    if (getPrefSafe(&quot;signon.rememberSignons&quot;, true)) {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-        savepassword = calGetString(&quot;passwordmgr&quot;, &quot;rememberPassword&quot;, null, &quot;passwordmgr&quot;);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-    }</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-    var aText;</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-    if (aFixedUsername) {</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-        aText = calGetString(&quot;prompts&quot;, &quot;EnterPasswordFor&quot;, [aUsername.value, aCalendarName], &quot;global&quot;);</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-        return prompter.promptPassword(aTitle,</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-                                       aText,</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-                                       aPassword,</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-                                       savepassword,</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-                                       aSavePassword);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-    } else {</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-        aText = calGetString(&quot;prompts&quot;, &quot;EnterUserPasswordFor&quot;, [aCalendarName], &quot;global&quot;);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-        return prompter.promptUsernameAndPassword(aTitle,</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-                                                  aText,</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-                                                  aUsername,</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-                                                  aPassword,</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-                                                  savepassword,</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-                                                  aSavePassword);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-    }</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-}</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-/**</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">- * Helper to insert/update an entry to the password manager.</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">- *</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">- * @param aUserName     The username</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">- * @param aPassword     The corresponding password</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">- * @param aHostName     The corresponding hostname</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">- * @param aRealm        The password realm (unused on branch)</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">- */</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-function calPasswordManagerSave(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-    ASSERT(aUsername);</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-    ASSERT(aPassword);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-    try {</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-        if (Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]) {</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-            calPasswordManagerRemove(aUsername, aHostName, aRealm);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-            var passwordManager = Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-                                            .getService(Components.interfaces.nsIPasswordManager);</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-            if (aHostName &amp;&amp; aHostName[aHostName.length - 1] == '/') {</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-                // strip trailing slash on branch:</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-                aHostName = aHostName.substr(0, aHostName.length - 1);</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-            }</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-            passwordManager.addUser(aHostName, aUsername, aPassword);</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-        } else if (Components.classes[&quot;@mozilla.org/login-manager;1&quot;]) {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-            // Trunk uses LoginManager</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-            var loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-                                         .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-            var logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-            if (logins.length &gt; 0) {</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-                var loginInfo = logins[0].clone();</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-                loginInfo.password = aPassword;</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-                loginManager.modifyLogin(logins[0], loginInfo);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-            } else {</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-                var loginInfo = Components.classes[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-                                          .createInstance(Components.interfaces.nsILoginInfo);</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-                loginInfo.init(aHostName,</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-                               null, aRealm,</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-                               aUsername, aPassword,</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-                               null, null);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-                loginManager.addLogin(loginInfo);</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-            }</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-        }</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-    } catch (exc) {</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-        ASSERT(false, exc);</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-    }</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-}</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-/**</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">- * Helper to retrieve an entry from the password manager.</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">- *</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineminus">- * @param in  aUsername     The username to search</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">- * @param out aPassword     The corresponding password</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">- * @param aHostName         The corresponding hostname</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineminus">- * @param aRealm            The password realm (unused on branch)</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">- * @return                  Does an entry exist in the password manager</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">- */</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-function calPasswordManagerGet(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-    ASSERT(aUsername);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-    if (typeof aPassword != &quot;object&quot;) {</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-        throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-    }</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-    try {</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-        if (Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]) {</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-            // Branch uses PasswordManager</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-            var passwordManager = Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-                                            .getService(Components.interfaces.nsIPasswordManager);</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-            if (aHostName &amp;&amp; aHostName[aHostName.length - 1] == '/') {</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-                // strip trailing slash on branch:</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-                aHostName = aHostName.substr(0, aHostName.length - 1);</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-            }</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-            var enumerator = passwordManager.enumerator;</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-            while (enumerator.hasMoreElements()) {</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-                var entry = enumerator.getNext().QueryInterface(Components.interfaces.nsIPassword);</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-                if ((entry.host == aHostName) &amp;&amp;</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-                    (entry.user == aUsername)) {</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-                    aPassword.value = entry.password;</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-                    return true;</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-                }</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-            }</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-        } else if (Components.classes[&quot;@mozilla.org/login-manager;1&quot;]) {</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-            // Trunk uses LoginManager</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-            var loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-                                         .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-            if (!loginManager.getLoginSavingEnabled(aUsername)) {</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-                return false;</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-            }</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-            var logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-            for each (var loginInfo in logins) {</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-                if (loginInfo.username == aUsername) {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-                    aPassword.value = loginInfo.password;</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-                    return true;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-                }</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-            }</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-        }</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-    } catch (exc) {</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-        ASSERT(false, exc);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-    }</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-    return false;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-}</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-/**</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">- * Helper to remove an entry from the password manager</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">- *</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">- * @param aUsername     The username to remove.</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">- * @param aHostName     The corresponding hostname</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">- * @param aRealm        The password realm (unused on branch)</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">- * @return              Could the user be removed?</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">- */</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-function calPasswordManagerRemove(aUsername, aHostName, aRealm) {</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-    ASSERT(aUsername);</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-    try {</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-        if (Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]) {</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-            // Branch uses PasswordManager</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-            var passwordManager = Components.classes[&quot;@mozilla.org/passwordmanager;1&quot;]</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-                                            .getService(Components.interfaces.nsIPasswordManager);</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-            if (aHostName &amp;&amp; aHostName[aHostName.length - 1] == '/') {</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-                // strip trailing slash on branch:</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-                aHostName = aHostName.substr(0, aHostName.length - 1);</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-            }</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-            passwordManager.removeUser(aHostName, aUsername);</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-            return true;</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-        } else if (Components.classes[&quot;@mozilla.org/login-manager;1&quot;]) {</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-            // Trunk uses LoginManager</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-            var loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-                                         .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-            var logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-            for each (var loginInfo in logins) {</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-                if (loginInfo.username == aUsername) {</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-                    loginManager.removeLogin(loginInfo);</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-                    return true;</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-                }</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-            }</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-        }</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-    } catch (exc) {</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-    }</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-    return false;</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -35,16 +35,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.5"></a><span id="l8.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.6"></a><span id="l8.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.7"></a><span id="l8.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.8"></a><span id="l8.8">  *</span>
<a href="#l8.9"></a><span id="l8.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> const REGISTRY_BRANCH = &quot;calendar.registry.&quot;;</span>
<a href="#l8.15"></a><span id="l8.15"> const DB_SCHEMA_VERSION = 10;</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> function getPrefBranchFor(id) {</span>
<a href="#l8.18"></a><span id="l8.18">     return (REGISTRY_BRANCH + id + &quot;.&quot;);</span>
<a href="#l8.19"></a><span id="l8.19"> }</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -515,20 +516,16 @@ calCalendarManager.prototype = {</span>
<a href="#l8.22"></a><span id="l8.22">      */</span>
<a href="#l8.23"></a><span id="l8.23">     createCalendar: function cmgr_createCalendar(type, uri) {</span>
<a href="#l8.24"></a><span id="l8.24">         try {</span>
<a href="#l8.25"></a><span id="l8.25">             var calendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]</span>
<a href="#l8.26"></a><span id="l8.26">                                      .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l8.27"></a><span id="l8.27">             calendar.uri = uri;</span>
<a href="#l8.28"></a><span id="l8.28">             return calendar;</span>
<a href="#l8.29"></a><span id="l8.29">         } catch (ex) {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-            // XXX todo: bug 439620</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-            // In general, we might consider to keep calendars disabled in case they couldn't</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-            // be created instead of filtering them out. This leaves the chance to clean up</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-            // calendar registration, getting rid of error boxes.</span>
<a href="#l8.34"></a><span id="l8.34">             var rc = ex;</span>
<a href="#l8.35"></a><span id="l8.35">             var message = ex;</span>
<a href="#l8.36"></a><span id="l8.36">             if (ex instanceof Components.interfaces.nsIException) {</span>
<a href="#l8.37"></a><span id="l8.37">                 rc = ex.result;</span>
<a href="#l8.38"></a><span id="l8.38">                 message = ex.message;</span>
<a href="#l8.39"></a><span id="l8.39">             }</span>
<a href="#l8.40"></a><span id="l8.40">             switch (rc) {</span>
<a href="#l8.41"></a><span id="l8.41">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR:</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineat">@@ -671,31 +668,40 @@ calCalendarManager.prototype = {</span>
<a href="#l8.43"></a><span id="l8.43">             }</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">             for (let calBranch in allCals) {</span>
<a href="#l8.46"></a><span id="l8.46">                 let id = calBranch.substring(REGISTRY_BRANCH.length);</span>
<a href="#l8.47"></a><span id="l8.47">                 let ctype = cal.getPrefSafe(calBranch + &quot;.type&quot;, null);</span>
<a href="#l8.48"></a><span id="l8.48">                 let curi = cal.getPrefSafe(calBranch + &quot;.uri&quot;, null);</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">                 try {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-                    let calendar = this.createCalendar(ctype, cal.makeURL(curi));</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-                    if (!calendar) {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-                        continue;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-                    }</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-                    calendar.id = id;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-                    if (calendar.getProperty(&quot;auto-enabled&quot;) === true) {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-                        calendar.deleteProperty(&quot;disabled&quot;);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-                        calendar.deleteProperty(&quot;auto-enabled&quot;);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-                    }</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-                    if ((calendar.getProperty(&quot;cache.supported&quot;) !== false) &amp;&amp; calendar.getProperty(&quot;cache.enabled&quot;)) {</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-                        calendar = new calCachedCalendar(calendar);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-                    }</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+                    let uri = cal.makeURL(curi);</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+                    let calendar = this.createCalendar(ctype, uri);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+                    if (calendar) {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+                        calendar.id = id;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+                        if (calendar.getProperty(&quot;auto-enabled&quot;)) {</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+                            calendar.deleteProperty(&quot;disabled&quot;);</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+                            calendar.deleteProperty(&quot;auto-enabled&quot;);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+                        }</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+ </span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+                        if ((calendar.getProperty(&quot;cache.supported&quot;) !== false) &amp;&amp;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+                            calendar.getProperty(&quot;cache.enabled&quot;)) {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+                            calendar = new calCachedCalendar(calendar);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+                        }</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+                    } else { // create dummy calendar that stays disabled for this run:</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+                        calendar = new calDummyCalendar(ctype);</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+                        calendar.id = id;</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+                        calendar.uri = uri;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+                        // try to enable on next startup if calendar has been enabled:</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+                        if (!calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+                            calendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                        }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+                        calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+                     }</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+ </span>
<a href="#l8.90"></a><span id="l8.90">                     this.setupCalendar(calendar);</span>
<a href="#l8.91"></a><span id="l8.91">                 } catch (exc) {</span>
<a href="#l8.92"></a><span id="l8.92">                     cal.ERROR(&quot;Can't create calendar for &quot; + id + &quot; (&quot; + ctype + &quot;, &quot; + curi + &quot;): &quot; + exc);</span>
<a href="#l8.93"></a><span id="l8.93">                 }</span>
<a href="#l8.94"></a><span id="l8.94">             }</span>
<a href="#l8.95"></a><span id="l8.95"> </span>
<a href="#l8.96"></a><span id="l8.96">             // do refreshing in a second step, when *all* calendars are already available</span>
<a href="#l8.97"></a><span id="l8.97">             // via getCalendars():</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineat">@@ -931,9 +937,26 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l8.99"></a><span id="l8.99">                 }</span>
<a href="#l8.100"></a><span id="l8.100">                 // #3 add unload listener (wait for user to close promptWindow)</span>
<a href="#l8.101"></a><span id="l8.101">                 promptWindow.addEventListener(&quot;unload&quot;, awaitUnload, false);</span>
<a href="#l8.102"></a><span id="l8.102">             }</span>
<a href="#l8.103"></a><span id="l8.103">             // #1 add load listener</span>
<a href="#l8.104"></a><span id="l8.104">             promptWindow.addEventListener(&quot;load&quot;, awaitLoad, false);</span>
<a href="#l8.105"></a><span id="l8.105">         }</span>
<a href="#l8.106"></a><span id="l8.106">     }</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+};</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+function calDummyCalendar(type) {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+    this.initProviderBase();</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+    this.type = type;</span>
<a href="#l8.112"></a><span id="l8.112"> }</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+calDummyCalendar.prototype = {</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    getProperty: function calDummyCalendar_getProperty(aName) {</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+        switch (aName) {</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+            case &quot;force-disabled&quot;:</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+                return true;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+            default:</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+                return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+        }</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    }</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/calendar/base/src/calProviderUtils.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,204 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- *</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- *</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">- * License.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">- *</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">- * The Original Code is Calendar code.</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">- *</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">- *   Bruno Browning &lt;browning@uwalumni.com&gt;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">- *</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">- *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">- *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">- *</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">- *</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-/*</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">- * Using this file requires calUtils.js to be loaded</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">- */</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-/**</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">- * Prepare HTTP channel with standard request headers and upload</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">- * data/content-type if needed</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">- *</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">- * @param arUri                      Channel Uri, will only be used for a new</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">- *                                     channel.</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">- * @param aUploadData                Data to be uploaded, if any. This may be a</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">- *                                     nsIInputStream or string data. In the</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">- *                                     latter case the string will be converted</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">- *                                     to an input stream.</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">- * @param aContentType               Value for Content-Type header, if any</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">- * @param aNotificationCallbacks     Calendar using channel</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">- * @param aExisting                  An existing channel to modify (optional)</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">- */</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-function calPrepHttpChannel(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting) {</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    let ioService = getIOService();</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    let channel = aExisting || ioService.newChannelFromURI(aUri);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-    let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/xml&quot;, false);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-    httpchannel.setRequestHeader(&quot;Accept-Charset&quot;, &quot;utf-8,*;q=0.1&quot;, false);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-    httpchannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    httpchannel.notificationCallbacks = aNotificationCallbacks;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    if (aUploadData) {</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-        httpchannel = httpchannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-        let stream;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-        if (aUploadData instanceof Components.interfaces.nsIInputStream) {</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-            // Make sure the stream is reset</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-            stream = aUploadData.QueryInterface(Components.interfaces.nsISeekableStream);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-            stream.seek(Components.interfaces.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-        } else {</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-            // Otherwise its something that should be a string, convert it.</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-            let converter =</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-                Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-                          .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-            converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-            stream = converter.convertToInputStream(aUploadData.toString());</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-        }</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-        httpchannel.setUploadStream(stream, aContentType, -1);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-    }</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    return httpchannel;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-}</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-/**</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">- * calSendHttpRequest; send prepared HTTP request</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">- *</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">- * @param aStreamLoader     streamLoader for request</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">- * @param aChannel          channel for request</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">- * @param aListener         listener for method completion</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">- */</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-function calSendHttpRequest(aStreamLoader, aChannel, aListener) {</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-    aStreamLoader.init(aListener);</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-    aChannel.asyncOpen(aStreamLoader, aChannel);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-}</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-function createStreamLoader() {</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-                     .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-}</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-function convertByteArray(aResult, aResultLength, aCharset, aThrow) {</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    try {</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-        var resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-                                    .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-        resultConverter.charset = aCharset || &quot;UTF-8&quot;;</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-        return resultConverter.convertFromByteArray(aResult, aResultLength);</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-    } catch (e) {</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-        if (aThrow) {</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-            throw e;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-        }</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-    }</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-    return null;</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-}</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-function safeNewXML(aStr) {</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-    // Strip &lt;?xml and surrounding whitespaces</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-    return new XML(aStr.replace(/(^\s*(&lt;\?xml[^&gt;]*&gt;)?\s*|\s+$)/g, &quot;&quot;));</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-}</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-    </span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-/**</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">- * getInterface method for providers. This should be called in the context of</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">- * the respective provider, i.e</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">- *</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">- * return calInterfaceRequestor_getInterface.apply(this, arguments);</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">- *</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">- * or</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">- * ...</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">- * getInterface: calInterfaceRequestor_getInterface,</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">- * ...</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">- *</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">- * @param aIID      The interface ID to return</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">- */</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-function calInterfaceRequestor_getInterface(aIID) {</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-    // Support Auth Prompt Interfaces</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-    if (aIID.equals(Components.interfaces.nsIAuthPrompt) ||</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-        (Components.interfaces.nsIAuthPrompt2 &amp;&amp;</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-         aIID.equals(Components.interfaces.nsIAuthPrompt2))) {</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-        return new calAuthPrompt();</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-    } else if (aIID.equals(Components.interfaces.nsIAuthPromptProvider) ||</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-               aIID.equals(Components.interfaces.nsIPrompt)) {</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-        return Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-                         .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-                         .getNewPrompter(null);</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-    }</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    try {</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-        // Try to query the this object for the requested interface but don't</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-        // throw if it fails since that borks the network code.</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-        return this.QueryInterface(aIID);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-    } catch (e) {</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-        Components.returnCode = e;</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-    }</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-    return null;</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-}</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-/**</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">- * Freebusy interval implementation. All parameters are optional.</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">- *</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">- * @param aCalId         The calendar id to set up with.</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">- * @param aFreeBusyType  The type from calIFreeBusyInterval.</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">- * @param aStart         The start of the interval.</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">- * @param aEnd           The end of the interval.</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">- * @return               The fresh calIFreeBusyInterval.</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">- */</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-function calFreeBusyInterval(aCalId, aFreeBusyType, aStart, aEnd) {</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-    this.calId = aCalId</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-    this.interval = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-                              .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-    this.interval.start = aStart;</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-    this.interval.end = aEnd;</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-    this.freeBusyType = aFreeBusyType ||</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-        Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-}</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-calFreeBusyInterval.prototype = {</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-    QueryInterface: function cFBI_QueryInterface(aIID) {</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-        return doQueryInterface(this,</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-                                calFreeBusyInterval.prototype,</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-                                aIID,</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-                                [Components.interfaces.calIFreeBusyInterval]);</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-    },</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-    calId: null,</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-    interval: null,</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-    freeBusyType: Components.interfaces.calIFreeBusyInterval.UNKNOWN</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-};</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-/**</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">- * Gets the iTIP/iMIP transport if the passed calendar has configured email.</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">- */</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-function calGetImipTransport(aCalendar) {</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-    // assure an identity is configured for the calendar</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-    return (aCalendar.getProperty(&quot;imip.identity&quot;)</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-            ? Components.classes[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;]</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-                        .getService(Components.interfaces.calIItipTransport)</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-            : null);</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/installer/removed-files.in</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/installer/removed-files.in</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -424,8 +424,13 @@ js/calWcapErrors.js</span>
<a href="#l10.4"></a><span id="l10.4"> js/calWcapRequest.js</span>
<a href="#l10.5"></a><span id="l10.5"> js/calWcapSession.js</span>
<a href="#l10.6"></a><span id="l10.6"> js/calWcapUtils.js</span>
<a href="#l10.7"></a><span id="l10.7"> js/calWeekInfoService.js</span>
<a href="#l10.8"></a><span id="l10.8"> js/calWeekPrinter.js</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> # Bug 462773 drop JSON.jsm</span>
<a href="#l10.11"></a><span id="l10.11"> modules/JSON.jsm</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+# Bug 439620</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+calendar-js/calProviderBase.js</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+calendar-js/calProviderUtils.js</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+calendar-js/calAuthUtils.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/installer/windows/packages-static</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/installer/windows/packages-static</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -217,17 +217,16 @@ bin\components\pluginGlue.js</span>
<a href="#l11.4"></a><span id="l11.4"> bin\components\storage-Legacy.js</span>
<a href="#l11.5"></a><span id="l11.5"> bin\components\storage-mozStorage.js</span>
<a href="#l11.6"></a><span id="l11.6"> bin\components\txEXSLTRegExFunctions.js</span>
<a href="#l11.7"></a><span id="l11.7"> bin\calendar-js\calAlarm.js</span>
<a href="#l11.8"></a><span id="l11.8"> bin\calendar-js\calAlarmMonitor.js</span>
<a href="#l11.9"></a><span id="l11.9"> bin\calendar-js\calAlarmService.js</span>
<a href="#l11.10"></a><span id="l11.10"> bin\calendar-js\calAttachment.js</span>
<a href="#l11.11"></a><span id="l11.11"> bin\calendar-js\calAttendee.js</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-bin\calendar-js\calAuthUtils.js</span>
<a href="#l11.13"></a><span id="l11.13"> bin\calendar-js\calCachedCalendar.js</span>
<a href="#l11.14"></a><span id="l11.14"> bin\calendar-js\calCalendarManager.js</span>
<a href="#l11.15"></a><span id="l11.15"> bin\calendar-js\calCalendarSearchService.js</span>
<a href="#l11.16"></a><span id="l11.16"> bin\calendar-js\calDateTimeFormatter.js</span>
<a href="#l11.17"></a><span id="l11.17"> bin\calendar-js\calDavCalendar.js</span>
<a href="#l11.18"></a><span id="l11.18"> bin\calendar-js\calEvent.js</span>
<a href="#l11.19"></a><span id="l11.19"> bin\calendar-js\calFilter.js</span>
<a href="#l11.20"></a><span id="l11.20"> bin\calendar-js\calFreeBusyService.js</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -238,18 +237,16 @@ bin\calendar-js\calIcsParser.js</span>
<a href="#l11.22"></a><span id="l11.22"> bin\calendar-js\calIcsSerializer.js</span>
<a href="#l11.23"></a><span id="l11.23"> bin\calendar-js\calItemBase.js</span>
<a href="#l11.24"></a><span id="l11.24"> bin\calendar-js\calItipItem.js</span>
<a href="#l11.25"></a><span id="l11.25"> bin\calendar-js\calListFormatter.js</span>
<a href="#l11.26"></a><span id="l11.26"> bin\calendar-js\calMemoryCalendar.js</span>
<a href="#l11.27"></a><span id="l11.27"> bin\calendar-js\calMonthGridPrinter.js</span>
<a href="#l11.28"></a><span id="l11.28"> bin\calendar-js\calOutlookCSVImportExport.js</span>
<a href="#l11.29"></a><span id="l11.29"> bin\calendar-js\calProtocolHandler.js</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-bin\calendar-js\calProviderBase.js</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-bin\calendar-js\calProviderUtils.js</span>
<a href="#l11.32"></a><span id="l11.32"> bin\calendar-js\calRecurrenceInfo.js</span>
<a href="#l11.33"></a><span id="l11.33"> bin\calendar-js\calRelation.js</span>
<a href="#l11.34"></a><span id="l11.34"> bin\calendar-js\calStorageCalendar.js</span>
<a href="#l11.35"></a><span id="l11.35"> bin\calendar-js\calTimezoneService.js</span>
<a href="#l11.36"></a><span id="l11.36"> bin\calendar-js\calTodo.js</span>
<a href="#l11.37"></a><span id="l11.37"> bin\calendar-js\calTransactionManager.js</span>
<a href="#l11.38"></a><span id="l11.38"> bin\calendar-js\calUtils.js</span>
<a href="#l11.39"></a><span id="l11.39"> bin\calendar-js\calWcapCalendar.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/providers/Makefile.in</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/providers/Makefile.in</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -41,18 +41,17 @@ topsrcdir	= @top_srcdir@</span>
<a href="#l12.4"></a><span id="l12.4"> srcdir		= @srcdir@</span>
<a href="#l12.5"></a><span id="l12.5"> VPATH		= @srcdir@</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> MODULE = calprovs</span>
<a href="#l12.10"></a><span id="l12.10"> MODULE_NAME = calProviderModule</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-DIRS = base \</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-       caldav \</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+DIRS = caldav \</span>
<a href="#l12.15"></a><span id="l12.15">        composite \</span>
<a href="#l12.16"></a><span id="l12.16">        gdata \</span>
<a href="#l12.17"></a><span id="l12.17">        ics \</span>
<a href="#l12.18"></a><span id="l12.18">        memory \</span>
<a href="#l12.19"></a><span id="l12.19">        storage \</span>
<a href="#l12.20"></a><span id="l12.20">        wcap \</span>
<a href="#l12.21"></a><span id="l12.21"> 	   $(NULL)</span>
<a href="#l12.22"></a><span id="l12.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/calendar/providers/base/Makefile.in</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,54 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-#</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-# License.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-#</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-# The Original Code is Sun Microsystems code.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-#</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-#   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-#</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-#</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-#</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-DEPTH		= ../../..</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-topsrcdir	= @top_srcdir@</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-srcdir		= @srcdir@</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-VPATH		= @srcdir@</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-include $(DEPTH)/config/autoconf.mk</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-EXTRA_SCRIPTS = calProviderBase.js</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-libs:: $(EXTRA_SCRIPTS)</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-	if test ! -d $(FINAL_TARGET)/calendar-js; then $(NSINSTALL) -D $(FINAL_TARGET)/calendar-js; fi</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-	$(INSTALL) $^ $(FINAL_TARGET)/calendar-js</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-# The install target must use SYSINSTALL, which is NSINSTALL in copy mode.</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-install:: $(EXTRA_SCRIPTS)</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(mozappdir)/calendar-js</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/calendar/providers/base/calProviderBase.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,426 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">- *</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">- * License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">- *</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">- * The Original Code is Sun Microsystems code.</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">- *</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">- *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">- *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">- *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">- *</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">- *</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-/**</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">- * Gets the configured identity and account of a particular calendar instance, or null.</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">- *</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">- * @param aCalendar     Calendar instance</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">- * @param outAccount    Optional out value for account</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">- * @return              The configured identity</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">- */</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-function calGetEmailIdentityOfCalendar(aCalendar, outAccount) {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-    ASSERT(aCalendar, &quot;no calendar!&quot;, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-    if (isSunbird()) {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-        return null;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-    }</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-    var key = aCalendar.getProperty(&quot;imip.identity.key&quot;);</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-    if (key !== null) {</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-        if (key.length == 0) { // i.e. &quot;None&quot;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-            return null;</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-        }</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-        var identity = null;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-        calIterateEmailIdentities(</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-            function(identity_, account) {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-                if (identity_.key == key) {</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-                    identity = identity_;</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-                    if (outAccount) {</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-                        outAccount.value = account;</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-                    }</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-                }</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-                return (identity_.key != key);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-            });</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-        if (!identity) {</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-            // dangling identity:</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-            WARN(&quot;Calendar &quot; + (aCalendar.uri ? aCalendar.uri.spec : aCalendar.id) +</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-                 &quot; has a dangling E-Mail identity configured.&quot;);</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-        }</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-        return identity;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-    } else { // take default account/identity:</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-        var accounts = getAccountManager().accounts;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-        var account = null;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-        var identity = null;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-        try {</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-            account = getAccountManager().defaultAccount;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-        } catch (exc) {}</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-        for (var i = 0; accounts &amp;&amp; (i &lt; accounts.Count()) &amp;&amp; (!account || !identity); ++i) {</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-            if (!account) { // Pick an account only if none was set (i.e there is no default account)</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-                account = accounts.GetElementAt(i);</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-                try {</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-                    account = account.QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-                } catch (exc) {</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-                    account = null;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-                }</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-            }</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-            if (account &amp;&amp; account.identities.Count()) { // Pick an identity</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-                identity = account.defaultIdentity;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-                if (!identity) { // there is no default identity, use the first</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-                    identity = account.identities.GetElementAt(0)</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-                                                 .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-                }</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-            } else { // If this account has no identities, continue to the next account.</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-                account = null;</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-            }</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-        }</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-        if (identity) {</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-            // If an identity was set above, set the account out parameter</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-            // and return the identity</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-            if (outAccount) {</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-                outAccount.value = account;</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-            }</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-            return identity;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-        }</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-        return null;</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-    }</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-}</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-function calProviderBase() {</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-    ASSERT(&quot;This prototype should only be inherited!&quot;);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-}</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-calProviderBase.mTransientProperties = {};</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-[&quot;cache.uncachedCalendar&quot;, &quot;currentStatus&quot;,</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">- &quot;itip.transport&quot;, &quot;imip.identity&quot;, &quot;imip.account&quot;,</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">- &quot;imip.identity.disabled&quot;, &quot;organizerId&quot;, &quot;organizerCN&quot;].forEach(</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-    function(prop) {</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-        calProviderBase.mTransientProperties[prop] = true;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-    });</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-calProviderBase.prototype = {</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-    QueryInterface: function cPB_QueryInterface(aIID) {</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-        return doQueryInterface(this, calProviderBase.prototype, aIID,</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-                                [Components.interfaces.nsISupports,</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-                                 Components.interfaces.calICalendar,</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-                                 Components.interfaces.calISchedulingSupport]);</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-    },</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-    mID: null,</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-    mUri: null,</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineminus">-    mObservers: null,</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-    mProperties: null,</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-    initProviderBase: function cPB_initProviderBase() {</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-        this.wrappedJSObject = this;</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-        this.mObservers = new calListenerBag(Components.interfaces.calIObserver);</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-        this.mProperties = {};</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-        this.mProperties.currentStatus = Components.results.NS_OK;</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-    },</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-    get observers() {</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-        return this.mObservers;</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-    },</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-    // attribute AUTF8String id;</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-    get id() {</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineminus">-        return this.mID;</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-    },</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-    set id(aValue) {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-        if (this.mID) {</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-            throw Components.results.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-        }</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-        this.mID = aValue;</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-//         ASSERT(this.mProperties.toSource() == &quot;({})&quot;, &quot;setProperty calls before id has been set!&quot;);</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-        // xxx todo: move this code hack when migrating storage prefs to moz prefs,</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-        //           presumably with bug 378754</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-        var calMgr = getCalendarManager();</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-        var this_ = this;</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-        function takeOverIfNotPresent(oldPref, newPref, dontDeleteOldPref) {</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-            var val = calMgr.getCalendarPref_(this_, oldPref);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-            if (val !== null) {</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-                if (!dontDeleteOldPref) {</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-                    calMgr.deleteCalendarPref_(this_, oldPref);</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-                }</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-                if (calMgr.getCalendarPref_(this_, newPref) === null) {</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-                    calMgr.setCalendarPref_(this_, newPref, val);</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-                }</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-            }</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-        }</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineminus">-        // takeover lightning calendar visibility from 0.5:</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-        takeOverIfNotPresent(&quot;lightning-main-in-composite&quot;, &quot;calendar-main-in-composite&quot;);</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-        takeOverIfNotPresent(&quot;lightning-main-default&quot;, &quot;calendar-main-default&quot;);</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineminus">-        return aValue;</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineminus">-    },</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineminus">-</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-    // attribute AUTF8String name;</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-    get name() {</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-        return this.getProperty(&quot;name&quot;);</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-    },</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">-    set name(aValue) {</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-        return this.setProperty(&quot;name&quot;, aValue);</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-    },</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-    // attribute calICalendar superCalendar;</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-    get superCalendar() {</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-        // If we have a superCalendar, check this calendar for a superCalendar.</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-        // This will make sure the topmost calendar is returned</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-        return (this.mSuperCalendar ? this.mSuperCalendar.superCalendar : this);</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-    },</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-    set superCalendar(val) {</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineminus">-        return (this.mSuperCalendar = val);</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-    },</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-    // attribute nsIURI uri;</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineminus">-    get uri() {</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-        return this.mUri;</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-    },</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-    set uri(aValue) {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-        return (this.mUri = aValue);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-    },</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-    // attribute boolean readOnly;</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-    get readOnly() {</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-        return this.getProperty(&quot;readOnly&quot;);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-    },</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-    set readOnly(aValue) {</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-        return this.setProperty(&quot;readOnly&quot;, aValue);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-    },</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-    // readonly attribute boolean canRefresh;</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-    get canRefresh() {</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineminus">-        return false;</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-    },</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineminus">-</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineminus">-    // void startBatch();</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">-    mBatchCount: 0,</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineminus">-    startBatch: function cPB_startBatch() {</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-        if (this.mBatchCount++ == 0) {</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-            this.mObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-        }</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-    },</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-    endBatch: function cPB_endBatch() {</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-        if (this.mBatchCount &gt; 0) {</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-            if (--this.mBatchCount == 0) {</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-                this.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-            }</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-        } else {</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-            ASSERT(this.mBatchCount &gt; 0, &quot;unexepcted endBatch!&quot;);</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-        }</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-    },</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-    notifyOperationComplete: function cPB_notifyOperationComplete(aListener,</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-                                                                  aStatus,</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-                                                                  aOperationType,</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-                                                                  aId,</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-                                                                  aDetail) {</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-        if (aListener) {</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-            try {</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-                aListener.onOperationComplete(this.superCalendar, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-            } catch (exc) {</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-                ERROR(exc);</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-            }</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-        }</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-        if (aStatus == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-            return; // cancellation doesn't change current status, no notification</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-        }</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-        if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-            this.setProperty(&quot;currentStatus&quot;, aStatus);</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-        } else {</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-            if (aDetail instanceof Components.interfaces.nsIException) {</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-                this.notifyError(aDetail); // will set currentStatus</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-            } else {</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">-                this.notifyError(aStatus, aDetail); // will set currentStatus</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-            }</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-            this.notifyError(aOperationType == Components.interfaces.calIOperationListener.GET</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-                             ? Components.interfaces.calIErrors.READ_FAILED</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-                             : Components.interfaces.calIErrors.MODIFICATION_FAILED,</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-                             &quot;&quot;);</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-        }</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-    },</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineminus">-</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineminus">-    // for convenience also callable with just an exception</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-    notifyError: function cPB_notifyError(aErrNo, aMessage) {</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-        if (aErrNo == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-            return; // cancellation doesn't change current status, no notification</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineminus">-        }</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineminus">-        if (aErrNo instanceof Components.interfaces.nsIException) {</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineminus">-            if (!aMessage) {</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineminus">-                aMessage = aErrNo.message;</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineminus">-            }</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineminus">-            aErrNo = aErrNo.result;</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineminus">-        }</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-        this.setProperty(&quot;currentStatus&quot;, aErrNo);</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-        this.observers.notify(&quot;onError&quot;, [this.superCalendar, aErrNo, aMessage]);</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineminus">-    },</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-    mTransientPropertiesMode: false,</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineminus">-    get transientProperties cPB_transientProperties() {</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineminus">-        return this.mTransientPropertiesMode;</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineminus">-    },</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineminus">-    set transientProperties cPB_transientProperties(value) {</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineminus">-        return (this.mTransientPropertiesMode = value);</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineminus">-    },</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineminus">-</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-    // nsIVariant getProperty(in AUTF8String aName);</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-    getProperty: function cPB_getProperty(aName) {</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-        switch (aName) {</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineminus">-            case &quot;itip.transport&quot;: // iTIP/iMIP default:</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-                return calGetImipTransport(this);</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-            case &quot;itip.notify-replies&quot;: // iTIP/iMIP default:</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineminus">-                 return getPrefSafe(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineminus">-            // temporary hack to get the uncached calendar instance:</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-            case &quot;cache.uncachedCalendar&quot;:</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-                return this;</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-        }</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-        var ret = this.mProperties[aName];</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineminus">-        if (ret === undefined) {</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineminus">-            ret = null;</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-            switch (aName) {</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-                case &quot;imip.identity&quot;: // we want to cache the identity object a little, because</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-                                      // it is heavily used by the invitation checks</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineminus">-                    ret = calGetEmailIdentityOfCalendar(this);</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineminus">-                    break;</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineminus">-                case &quot;imip.account&quot;: {</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-                    var outAccount = {};</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-                    if (calGetEmailIdentityOfCalendar(this, outAccount)) {</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-                        ret = outAccount.value;</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-                    }</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-                    break;</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineminus">-                }</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineminus">-                case &quot;organizerId&quot;: { // itip/imip default: derived out of imip.identity</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineminus">-                    var identity = this.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineminus">-                    ret = (identity</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineminus">-                           ? (&quot;mailto:&quot; + identity.QueryInterface(Components.interfaces.nsIMsgIdentity).email)</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineminus">-                           : null);</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineminus">-                    break;</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-                }</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-                case &quot;organizerCN&quot;: { // itip/imip default: derived out of imip.identity</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineminus">-                    var identity = this.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineminus">-                    ret = (identity</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineminus">-                           ? identity.QueryInterface(Components.interfaces.nsIMsgIdentity).fullName</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineminus">-                           : null);</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineminus">-                    break;</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineminus">-                }</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineminus">-            }</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-            if ((ret === null) &amp;&amp;</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-                !calProviderBase.mTransientProperties[aName] &amp;&amp;</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-                !this.transientProperties) {</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineminus">-                if (this.id) {</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineminus">-                    ret = getCalendarManager().getCalendarPref_(this, aName);</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineminus">-                }</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-                if (ret !== null) {</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-                    switch (aName) {</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineminus">-                        case &quot;suppressAlarms&quot;:</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineminus">-                            if (this.getProperty(&quot;capabilities.alarms.popup.supported&quot;) === false) {</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineminus">-                                // If popup alarms are not supported,</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineminus">-                                // automatically suppress alarms</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineminus">-                                ret = true;</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineminus">-                            }</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineminus">-                            break;</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineminus">-                    }</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineminus">-                }</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineminus">-            }</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineminus">-            this.mProperties[aName] = ret;</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineminus">-        }</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineminus">-//         LOG(&quot;getProperty(\&quot;&quot; + aName + &quot;\&quot;): &quot; + ret);</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineminus">-        return ret;</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineminus">-    },</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineminus">-</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineminus">-    // void setProperty(in AUTF8String aName, in nsIVariant aValue);</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineminus">-    setProperty: function cPB_setProperty(aName, aValue) {</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineminus">-        var oldValue = this.getProperty(aName);</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineminus">-        if (oldValue != aValue) {</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineminus">-            this.mProperties[aName] = aValue;</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineminus">-            switch (aName) {</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineminus">-                case &quot;imip.identity.key&quot;: // invalidate identity and account object if key is set:</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineminus">-                    delete this.mProperties[&quot;imip.identity&quot;];</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineminus">-                    delete this.mProperties[&quot;imip.account&quot;];</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineminus">-                    delete this.mProperties[&quot;organizerId&quot;];</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineminus">-                    delete this.mProperties[&quot;organizerCN&quot;];</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineminus">-                    break;</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineminus">-            }</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineminus">-            if (!this.transientProperties &amp;&amp;</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineminus">-                !calProviderBase.mTransientProperties[aName] &amp;&amp;</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineminus">-                this.id) {</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineminus">-                getCalendarManager().setCalendarPref_(this, aName, aValue);</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineminus">-            }</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-            this.mObservers.notify(&quot;onPropertyChanged&quot;,</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-                                   [this.superCalendar, aName, aValue, oldValue]);</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineminus">-        }</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineminus">-        return aValue;</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineminus">-    },</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineminus">-</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineminus">-    // void deleteProperty(in AUTF8String aName);</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineminus">-    deleteProperty: function cPB_deleteProperty(aName) {</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineminus">-        this.mObservers.notify(&quot;onPropertyDeleting&quot;, [this.superCalendar, aName]);</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineminus">-        delete this.mProperties[aName];</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineminus">-        getCalendarManager().deleteCalendarPref_(this, aName);</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineminus">-    },</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineminus">-</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineminus">-    // calIOperation refresh</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineminus">-    refresh: function cPB_refresh() {</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineminus">-        return null;</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-    },</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineminus">-    // void addObserver( in calIObserver observer );</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineminus">-    addObserver: function cPB_addObserver(aObserver) {</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineminus">-        this.mObservers.add(aObserver);</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineminus">-    },</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineminus">-</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineminus">-    // void removeObserver( in calIObserver observer );</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineminus">-    removeObserver: function cPB_removeObserver(aObserver) {</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineminus">-        this.mObservers.remove(aObserver);</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineminus">-    },</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineminus">-</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineminus">-    // calISchedulingSupport: Implementation corresponding to our iTIP/iMIP support</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineminus">-    isInvitation: function cPB_isInvitation(aItem) {</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineminus">-        var id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineminus">-        if (id) {</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineminus">-            var org = aItem.organizer;</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineminus">-            if (!org || (org.id.toLowerCase() == id.toLowerCase())) {</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineminus">-                return false;</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineminus">-            }</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineminus">-            return (aItem.getAttendeeById(id) != null);</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineminus">-        }</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineminus">-        return false;</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-    },</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineminus">-</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineminus">-    getInvitedAttendee: function cPB_getInvitedAttendee(aItem) {</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">-        var id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineminus">-        return (id ? aItem.getAttendeeById(id) : null);</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineminus">-    },</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineminus">-</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineminus">-    canNotify: function cPB_canNotify(aMethod, aItem) {</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineminus">-        return false; // use outbound iTIP for all</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineminus">-    }</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -40,16 +40,18 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.5"></a><span id="l15.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.6"></a><span id="l15.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.7"></a><span id="l15.7">  *</span>
<a href="#l15.8"></a><span id="l15.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> //</span>
<a href="#l15.16"></a><span id="l15.16"> // calDavCalendar.js</span>
<a href="#l15.17"></a><span id="l15.17"> //</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19"> const xmlHeader = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21"> function calDavCalendar() {</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -89,17 +91,17 @@ const kDavResourceTypeCollection = 1;</span>
<a href="#l15.23"></a><span id="l15.23"> const kDavResourceTypeCalendar = 2;</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25"> // used for etag checking</span>
<a href="#l15.26"></a><span id="l15.26"> const CALDAV_ADOPT_ITEM = 1;</span>
<a href="#l15.27"></a><span id="l15.27"> const CALDAV_MODIFY_ITEM = 2;</span>
<a href="#l15.28"></a><span id="l15.28"> const CALDAV_DELETE_ITEM = 3;</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30"> calDavCalendar.prototype = {</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    __proto__: calProviderBase.prototype,</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">     //</span>
<a href="#l15.35"></a><span id="l15.35">     // nsISupports interface</span>
<a href="#l15.36"></a><span id="l15.36">     //</span>
<a href="#l15.37"></a><span id="l15.37">     QueryInterface: function caldav_QueryInterface(aIID) {</span>
<a href="#l15.38"></a><span id="l15.38">         return doQueryInterface(this, calDavCalendar.prototype, aIID,</span>
<a href="#l15.39"></a><span id="l15.39">                                 [Components.interfaces.calICalendarProvider,</span>
<a href="#l15.40"></a><span id="l15.40">                                  Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineat">@@ -357,17 +359,17 @@ calDavCalendar.prototype = {</span>
<a href="#l15.42"></a><span id="l15.42">                 break;</span>
<a href="#l15.43"></a><span id="l15.43">             case &quot;organizerCN&quot;:</span>
<a href="#l15.44"></a><span id="l15.44">                 return null; // xxx todo</span>
<a href="#l15.45"></a><span id="l15.45">             case &quot;itip.transport&quot;:</span>
<a href="#l15.46"></a><span id="l15.46">                 if (this.hasAutoScheduling) {</span>
<a href="#l15.47"></a><span id="l15.47">                     return null;</span>
<a href="#l15.48"></a><span id="l15.48">                 } else if (this.hasScheduling) {</span>
<a href="#l15.49"></a><span id="l15.49">                     return this.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-                } // else use outbound email-based iTIP (from calProviderBase.js)</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+                } // else use outbound email-based iTIP (from cal.ProviderBase)</span>
<a href="#l15.52"></a><span id="l15.52">                 break;</span>
<a href="#l15.53"></a><span id="l15.53">             case &quot;capabilities.tasks.supported&quot;:</span>
<a href="#l15.54"></a><span id="l15.54">                 return (this.supportedItemTypes.indexOf(&quot;VTODO&quot;) &gt; -1);</span>
<a href="#l15.55"></a><span id="l15.55">             case &quot;capabilities.events.supported&quot;:</span>
<a href="#l15.56"></a><span id="l15.56">                 return (this.supportedItemTypes.indexOf(&quot;VEVENT&quot;) &gt; -1);</span>
<a href="#l15.57"></a><span id="l15.57">         }</span>
<a href="#l15.58"></a><span id="l15.58">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l15.59"></a><span id="l15.59">     },</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineat">@@ -472,17 +474,17 @@ calDavCalendar.prototype = {</span>
<a href="#l15.61"></a><span id="l15.61">             let request = aLoader.request;</span>
<a href="#l15.62"></a><span id="l15.62">             let status;</span>
<a href="#l15.63"></a><span id="l15.63">             try {</span>
<a href="#l15.64"></a><span id="l15.64">                 status = request.responseStatus;</span>
<a href="#l15.65"></a><span id="l15.65">             } catch (ex) {</span>
<a href="#l15.66"></a><span id="l15.66">                 status = Components.interfaces.calIErrors.DAV_PUT_ERROR;</span>
<a href="#l15.67"></a><span id="l15.67">             }</span>
<a href="#l15.68"></a><span id="l15.68">             if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-                var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+                let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l15.71"></a><span id="l15.71">                 LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l15.72"></a><span id="l15.72">             }</span>
<a href="#l15.73"></a><span id="l15.73">             // 201 = HTTP &quot;Created&quot;</span>
<a href="#l15.74"></a><span id="l15.74">             // 204 = HTTP &quot;No Content&quot;</span>
<a href="#l15.75"></a><span id="l15.75">             //</span>
<a href="#l15.76"></a><span id="l15.76">             if (status == 201 || status == 204) {</span>
<a href="#l15.77"></a><span id="l15.77">                 LOG(&quot;CalDAV: Item added successfully&quot;);</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79" class="difflineat">@@ -497,28 +499,27 @@ calDavCalendar.prototype = {</span>
<a href="#l15.80"></a><span id="l15.80">                 }</span>
<a href="#l15.81"></a><span id="l15.81">                 LOG(&quot;CalDAV: Unexpected status adding item: &quot; + status);</span>
<a href="#l15.82"></a><span id="l15.82">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_PUT_ERROR);</span>
<a href="#l15.83"></a><span id="l15.83">             }</span>
<a href="#l15.84"></a><span id="l15.84">         };</span>
<a href="#l15.85"></a><span id="l15.85"> </span>
<a href="#l15.86"></a><span id="l15.86">         parentItem.calendar = this.superCalendar;</span>
<a href="#l15.87"></a><span id="l15.87"> </span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-        var httpchannel = calPrepHttpChannel(itemUri,</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-                                             this.getSerializedItem(aItem),</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-                                             &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-                                             this);</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(itemUri,</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+                                              this.getSerializedItem(aItem),</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+                                              &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+                                              this);</span>
<a href="#l15.96"></a><span id="l15.96"> </span>
<a href="#l15.97"></a><span id="l15.97"> </span>
<a href="#l15.98"></a><span id="l15.98">         if (!aIgnoreEtag) {</span>
<a href="#l15.99"></a><span id="l15.99">             httpchannel.setRequestHeader(&quot;If-None-Match&quot;, &quot;*&quot;, false);</span>
<a href="#l15.100"></a><span id="l15.100">         }</span>
<a href="#l15.101"></a><span id="l15.101"> </span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, addListener);</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, addListener);</span>
<a href="#l15.105"></a><span id="l15.105">     },</span>
<a href="#l15.106"></a><span id="l15.106"> </span>
<a href="#l15.107"></a><span id="l15.107">     /**</span>
<a href="#l15.108"></a><span id="l15.108">      * modifyItem(); required by calICalendar.idl</span>
<a href="#l15.109"></a><span id="l15.109">      * we actually use doModifyItem()</span>
<a href="#l15.110"></a><span id="l15.110">      *</span>
<a href="#l15.111"></a><span id="l15.111">      * @param aItem       item to check</span>
<a href="#l15.112"></a><span id="l15.112">      * @param aListener   listener for method completion</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineat">@@ -602,29 +603,28 @@ calDavCalendar.prototype = {</span>
<a href="#l15.114"></a><span id="l15.114">                 if (status &gt; 999) {</span>
<a href="#l15.115"></a><span id="l15.115">                     status = &quot;0x &quot; + status.toString(16);</span>
<a href="#l15.116"></a><span id="l15.116">                 }</span>
<a href="#l15.117"></a><span id="l15.117">                 LOG(&quot;CalDAV: Unexpected status on modifying item: &quot; + status);</span>
<a href="#l15.118"></a><span id="l15.118">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_PUT_ERROR);</span>
<a href="#l15.119"></a><span id="l15.119">             }</span>
<a href="#l15.120"></a><span id="l15.120">         };</span>
<a href="#l15.121"></a><span id="l15.121"> </span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-        var httpchannel = calPrepHttpChannel(eventUri,</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-                                             modifiedItemICS,</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-                                             &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-                                             this);</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(eventUri,</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+                                              modifiedItemICS,</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+                                              &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+                                              this);</span>
<a href="#l15.130"></a><span id="l15.130"> </span>
<a href="#l15.131"></a><span id="l15.131">         if (!aIgnoreEtag) {</span>
<a href="#l15.132"></a><span id="l15.132">             httpchannel.setRequestHeader(&quot;If-Match&quot;,</span>
<a href="#l15.133"></a><span id="l15.133">                                          this.mItemInfoCache[aNewItem.id].etag,</span>
<a href="#l15.134"></a><span id="l15.134">                                          false);</span>
<a href="#l15.135"></a><span id="l15.135">         }</span>
<a href="#l15.136"></a><span id="l15.136"> </span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, modListener);</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, modListener);</span>
<a href="#l15.140"></a><span id="l15.140">     },</span>
<a href="#l15.141"></a><span id="l15.141"> </span>
<a href="#l15.142"></a><span id="l15.142">     /**</span>
<a href="#l15.143"></a><span id="l15.143">      * deleteItem(); required by calICalendar.idl</span>
<a href="#l15.144"></a><span id="l15.144">      * the actual deletion is done in doDeleteItem()</span>
<a href="#l15.145"></a><span id="l15.145">      *</span>
<a href="#l15.146"></a><span id="l15.146">      * @param aItem       item to delete</span>
<a href="#l15.147"></a><span id="l15.147">      * @param aListener   listener for method completion</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineat">@@ -691,23 +691,22 @@ calDavCalendar.prototype = {</span>
<a href="#l15.149"></a><span id="l15.149">                     delete thisCalendar.mHrefIndex[eventUri.path];</span>
<a href="#l15.150"></a><span id="l15.150">                     delete thisCalendar.mItemInfoCache[aItem.id];</span>
<a href="#l15.151"></a><span id="l15.151">                     LOG(&quot;CalDAV: Item deleted successfully.&quot;);</span>
<a href="#l15.152"></a><span id="l15.152">                 }</span>
<a href="#l15.153"></a><span id="l15.153">             } else if (status == 412) {</span>
<a href="#l15.154"></a><span id="l15.154">                 // item has either been modified or deleted by someone else</span>
<a href="#l15.155"></a><span id="l15.155">                 // check to see which</span>
<a href="#l15.156"></a><span id="l15.156"> </span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-                var httpchannel2 = calPrepHttpChannel(eventUri,</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-                                                      null,</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-                                                      null,</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-                                                      thisCalendar);</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+                let httpchannel2 = cal.prepHttpChannel(eventUri,</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+                                                       null,</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+                                                       null,</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+                                                       thisCalendar);</span>
<a href="#l15.165"></a><span id="l15.165">                 httpchannel2.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-                var streamLoader2 = createStreamLoader();</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-                calSendHttpRequest(streamLoader2, httpchannel2, delListener2);</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+                cal.sendHttpRequest(cal.createStreamLoader(), httpchannel2, delListener2);</span>
<a href="#l15.169"></a><span id="l15.169">             } else {</span>
<a href="#l15.170"></a><span id="l15.170">                 LOG(&quot;CalDAV: Unexpected status deleting item: &quot; + status);</span>
<a href="#l15.171"></a><span id="l15.171">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_REMOVE_ERROR);</span>
<a href="#l15.172"></a><span id="l15.172">             }</span>
<a href="#l15.173"></a><span id="l15.173">         };</span>
<a href="#l15.174"></a><span id="l15.174">         var delListener2 = {};</span>
<a href="#l15.175"></a><span id="l15.175">         delListener2.onStreamComplete =</span>
<a href="#l15.176"></a><span id="l15.176">         function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineat">@@ -717,26 +716,25 @@ calDavCalendar.prototype = {</span>
<a href="#l15.178"></a><span id="l15.178">                 // someone else already deleted it</span>
<a href="#l15.179"></a><span id="l15.179">                 return;</span>
<a href="#l15.180"></a><span id="l15.180">             } else {</span>
<a href="#l15.181"></a><span id="l15.181">                 thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem,</span>
<a href="#l15.182"></a><span id="l15.182">                                              realListener, null);</span>
<a href="#l15.183"></a><span id="l15.183">             }</span>
<a href="#l15.184"></a><span id="l15.184">         };</span>
<a href="#l15.185"></a><span id="l15.185"> </span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-        var httpchannel = calPrepHttpChannel(eventUri, null, null, this);</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(eventUri, null, null, this);</span>
<a href="#l15.188"></a><span id="l15.188">         if (!aIgnoreEtag) {</span>
<a href="#l15.189"></a><span id="l15.189">             httpchannel.setRequestHeader(&quot;If-Match&quot;,</span>
<a href="#l15.190"></a><span id="l15.190">                                          this.mItemInfoCache[aItem.id].etag,</span>
<a href="#l15.191"></a><span id="l15.191">                                          false);</span>
<a href="#l15.192"></a><span id="l15.192">         }</span>
<a href="#l15.193"></a><span id="l15.193">         httpchannel.requestMethod = &quot;DELETE&quot;;</span>
<a href="#l15.194"></a><span id="l15.194"> </span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, delListener);</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, delListener);</span>
<a href="#l15.198"></a><span id="l15.198">     },</span>
<a href="#l15.199"></a><span id="l15.199"> </span>
<a href="#l15.200"></a><span id="l15.200">     /**</span>
<a href="#l15.201"></a><span id="l15.201">      * Retrieves a specific item from the CalDAV store.</span>
<a href="#l15.202"></a><span id="l15.202">      * Use when an outdated copy of the item is in hand.</span>
<a href="#l15.203"></a><span id="l15.203">      *</span>
<a href="#l15.204"></a><span id="l15.204">      * @param aItem       item to fetch</span>
<a href="#l15.205"></a><span id="l15.205">      * @param aListener   listener for method completion</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineat">@@ -810,18 +808,17 @@ calDavCalendar.prototype = {</span>
<a href="#l15.207"></a><span id="l15.207">     safeRefresh: function caldav_safeRefresh(aChangeLogListener) {</span>
<a href="#l15.208"></a><span id="l15.208">         this.ensureTargetCalendar();</span>
<a href="#l15.209"></a><span id="l15.209"> </span>
<a href="#l15.210"></a><span id="l15.210">         if (this.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l15.211"></a><span id="l15.211">             // the auth could have timed out and be in need of renegotiation</span>
<a href="#l15.212"></a><span id="l15.212">             // we can't risk several calendars doing this simultaneously so</span>
<a href="#l15.213"></a><span id="l15.213">             // we'll force the renegotiation in a sync query, using HEAD to keep</span>
<a href="#l15.214"></a><span id="l15.214">             // it quick</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-            var headchannel = calPrepHttpChannel(this.calendarUri, null, null,</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineminus">-                                                 this);</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineplus">+            let headchannel = cal.prepHttpChannel(this.calendarUri, null, null, this);</span>
<a href="#l15.218"></a><span id="l15.218">             headchannel.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l15.219"></a><span id="l15.219">             headchannel.open();</span>
<a href="#l15.220"></a><span id="l15.220">         }</span>
<a href="#l15.221"></a><span id="l15.221"> </span>
<a href="#l15.222"></a><span id="l15.222">         if (!this.mCtag || !this.mFirstRefreshDone) {</span>
<a href="#l15.223"></a><span id="l15.223">             this.getUpdatedItems(this.calendarUri, aChangeLogListener);</span>
<a href="#l15.224"></a><span id="l15.224">             return;</span>
<a href="#l15.225"></a><span id="l15.225">         }</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineat">@@ -832,44 +829,44 @@ calDavCalendar.prototype = {</span>
<a href="#l15.227"></a><span id="l15.227">         var queryXml = &lt;D:propfind xmlns:D={D} xmlns:CS={CS}&gt;</span>
<a href="#l15.228"></a><span id="l15.228">                         &lt;D:prop&gt;</span>
<a href="#l15.229"></a><span id="l15.229">                             &lt;CS:getctag/&gt;</span>
<a href="#l15.230"></a><span id="l15.230">                         &lt;/D:prop&gt;</span>
<a href="#l15.231"></a><span id="l15.231">                         &lt;/D:propfind&gt;;</span>
<a href="#l15.232"></a><span id="l15.232">         if (this.verboseLogging()) {</span>
<a href="#l15.233"></a><span id="l15.233">             LOG(&quot;CalDAV: send: &quot; + queryXml);</span>
<a href="#l15.234"></a><span id="l15.234">         }</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-        var httpchannel = calPrepHttpChannel(this.calendarUri,</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-                                             queryXml,</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-                                             &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineminus">-                                             this);</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(this.calendarUri,</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+                                              queryXml,</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+                                              &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+                                              this);</span>
<a href="#l15.243"></a><span id="l15.243">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l15.244"></a><span id="l15.244">         httpchannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l15.245"></a><span id="l15.245"> </span>
<a href="#l15.246"></a><span id="l15.246">         var streamListener = {};</span>
<a href="#l15.247"></a><span id="l15.247">         streamListener.onStreamComplete =</span>
<a href="#l15.248"></a><span id="l15.248">             function safeRefresh_safeRefresh_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l15.249"></a><span id="l15.249">             let request = aLoader.request;</span>
<a href="#l15.250"></a><span id="l15.250">             try {</span>
<a href="#l15.251"></a><span id="l15.251">                 LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l15.252"></a><span id="l15.252">                     &quot; checking ctag for calendar &quot; + thisCalendar.name);</span>
<a href="#l15.253"></a><span id="l15.253">             } catch (ex) {</span>
<a href="#l15.254"></a><span id="l15.254">                 LOG(&quot;CalDAV: Error without status on checking ctag for calendar &quot; +</span>
<a href="#l15.255"></a><span id="l15.255">                     thisCalendar.name);</span>
<a href="#l15.256"></a><span id="l15.256">             }</span>
<a href="#l15.257"></a><span id="l15.257"> </span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-            var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineplus">+            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l15.260"></a><span id="l15.260">             if (!str) {</span>
<a href="#l15.261"></a><span id="l15.261">                 LOG(&quot;CalDAV: Failed to get ctag from server&quot;);</span>
<a href="#l15.262"></a><span id="l15.262">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.263"></a><span id="l15.263">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l15.264"></a><span id="l15.264">             }</span>
<a href="#l15.265"></a><span id="l15.265"> </span>
<a href="#l15.266"></a><span id="l15.266">             try {</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-                var multistatus = safeNewXML(str);</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+                var multistatus = cal.safeNewXML(str);</span>
<a href="#l15.269"></a><span id="l15.269">             } catch (ex) {</span>
<a href="#l15.270"></a><span id="l15.270">                 LOG(&quot;CalDAV: Failed to get ctag from server&quot;);</span>
<a href="#l15.271"></a><span id="l15.271">                 return;</span>
<a href="#l15.272"></a><span id="l15.272">             }</span>
<a href="#l15.273"></a><span id="l15.273"> </span>
<a href="#l15.274"></a><span id="l15.274">             var ctag = multistatus..CS::getctag.toString();</span>
<a href="#l15.275"></a><span id="l15.275">             if (!ctag.length || ctag != thisCalendar.mCtag) {</span>
<a href="#l15.276"></a><span id="l15.276">                 // ctag mismatch, need to fetch calendar-data</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineat">@@ -886,18 +883,17 @@ calDavCalendar.prototype = {</span>
<a href="#l15.278"></a><span id="l15.278">                         + thisCalendar.name);</span>
<a href="#l15.279"></a><span id="l15.279">                 }</span>
<a href="#l15.280"></a><span id="l15.280">                 // we may still need to poll the inbox</span>
<a href="#l15.281"></a><span id="l15.281">                 if (thisCalendar.firstInRealm()) {</span>
<a href="#l15.282"></a><span id="l15.282">                     thisCalendar.pollInbox();</span>
<a href="#l15.283"></a><span id="l15.283">                 }</span>
<a href="#l15.284"></a><span id="l15.284">             }</span>
<a href="#l15.285"></a><span id="l15.285">         };</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, streamListener);</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l15.289"></a><span id="l15.289">     },</span>
<a href="#l15.290"></a><span id="l15.290"> </span>
<a href="#l15.291"></a><span id="l15.291">     refresh: function caldav_refresh() {</span>
<a href="#l15.292"></a><span id="l15.292">         if (!this.mCheckedServerInfo) {</span>
<a href="#l15.293"></a><span id="l15.293">             // If we haven't refreshed yet, then we should check the resource</span>
<a href="#l15.294"></a><span id="l15.294">             // type first. This will call refresh() again afterwards.</span>
<a href="#l15.295"></a><span id="l15.295">             this.checkDavResourceType(null);</span>
<a href="#l15.296"></a><span id="l15.296">         } else {</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineat">@@ -977,24 +973,24 @@ calDavCalendar.prototype = {</span>
<a href="#l15.298"></a><span id="l15.298">                 LOG(&quot;CalDAV: Error without status on getetag for calendar &quot; +</span>
<a href="#l15.299"></a><span id="l15.299">                     thisCalendar.name);</span>
<a href="#l15.300"></a><span id="l15.300">                 responseStatus = &quot;none&quot;;</span>
<a href="#l15.301"></a><span id="l15.301">             }</span>
<a href="#l15.302"></a><span id="l15.302"> </span>
<a href="#l15.303"></a><span id="l15.303">             if (responseStatus == 207) {</span>
<a href="#l15.304"></a><span id="l15.304">                 // We only need to parse 207's, anything else is probably a</span>
<a href="#l15.305"></a><span id="l15.305">                 // server error (i.e 50x).</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-                var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineplus">+                let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l15.308"></a><span id="l15.308">                 if (!str) {</span>
<a href="#l15.309"></a><span id="l15.309">                     LOG(&quot;CAlDAV: Failed to parse getetag PROPFIND&quot;);</span>
<a href="#l15.310"></a><span id="l15.310">                 } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.311"></a><span id="l15.311">                     LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l15.312"></a><span id="l15.312">                 }</span>
<a href="#l15.313"></a><span id="l15.313"> </span>
<a href="#l15.314"></a><span id="l15.314" class="difflineminus">-                var multistatus = safeNewXML(str);</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineplus">+                let multistatus = cal.safeNewXML(str);</span>
<a href="#l15.316"></a><span id="l15.316">                 for each (let response in multistatus.*::response) {</span>
<a href="#l15.317"></a><span id="l15.317">                     var etag = response..D::[&quot;getetag&quot;];</span>
<a href="#l15.318"></a><span id="l15.318">                     if (etag.length() == 0) {</span>
<a href="#l15.319"></a><span id="l15.319">                         continue;</span>
<a href="#l15.320"></a><span id="l15.320">                     }</span>
<a href="#l15.321"></a><span id="l15.321">                     var contenttype = null;</span>
<a href="#l15.322"></a><span id="l15.322">                     contenttype = response..D::[&quot;getcontenttype&quot;];</span>
<a href="#l15.323"></a><span id="l15.323">                     // workaround for a Scalix bug which causes incorrect</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineat">@@ -1117,24 +1113,23 @@ calDavCalendar.prototype = {</span>
<a href="#l15.325"></a><span id="l15.325">                                          null,</span>
<a href="#l15.326"></a><span id="l15.326">                                          aChangeLogListener);</span>
<a href="#l15.327"></a><span id="l15.327">         };</span>
<a href="#l15.328"></a><span id="l15.328"> </span>
<a href="#l15.329"></a><span id="l15.329">         if (this.verboseLogging()) {</span>
<a href="#l15.330"></a><span id="l15.330">             LOG(&quot;CalDAV: send(&quot; + aUri.spec + &quot;): &quot; + queryString);</span>
<a href="#l15.331"></a><span id="l15.331">         }</span>
<a href="#l15.332"></a><span id="l15.332"> </span>
<a href="#l15.333"></a><span id="l15.333" class="difflineminus">-        var httpchannel = calPrepHttpChannel(aUri,</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineminus">-                                             queryString,</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-                                             &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-                                             this);</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(aUri,</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+                                              queryString,</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+                                              &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineplus">+                                              this);</span>
<a href="#l15.341"></a><span id="l15.341">         httpchannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l15.342"></a><span id="l15.342">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.344"></a><span id="l15.344" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, etagListener);</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, etagListener);</span>
<a href="#l15.346"></a><span id="l15.346">     },</span>
<a href="#l15.347"></a><span id="l15.347"> </span>
<a href="#l15.348"></a><span id="l15.348">     getCalendarData: function caldav_getCalendarData(aUri, aQuery, aItem, aListener, aChangeLogListener) {</span>
<a href="#l15.349"></a><span id="l15.349">         this.ensureTargetCalendar();</span>
<a href="#l15.350"></a><span id="l15.350"> </span>
<a href="#l15.351"></a><span id="l15.351">         var thisCalendar = this;</span>
<a href="#l15.352"></a><span id="l15.352">         var caldataListener = {};</span>
<a href="#l15.353"></a><span id="l15.353">         var C = new Namespace(&quot;C&quot;, &quot;urn:ietf:params:xml:ns:caldav&quot;);</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineat">@@ -1156,32 +1151,32 @@ calDavCalendar.prototype = {</span>
<a href="#l15.355"></a><span id="l15.355">             }</span>
<a href="#l15.356"></a><span id="l15.356">             if (responseStatus != 207) {</span>
<a href="#l15.357"></a><span id="l15.357">                 LOG(&quot;error: got status &quot; + responseStatus + &quot; fetching calendar data&quot;);</span>
<a href="#l15.358"></a><span id="l15.358">                 if (thisCalendar.isCached &amp;&amp; aChangeLogListener)</span>
<a href="#l15.359"></a><span id="l15.359">                     aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l15.360"></a><span id="l15.360">                                                 Components.results.NS_ERROR_FAILURE);</span>
<a href="#l15.361"></a><span id="l15.361">                 return;</span>
<a href="#l15.362"></a><span id="l15.362">             }</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineminus">-            var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineplus">+            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l15.365"></a><span id="l15.365">             if (!str) {</span>
<a href="#l15.366"></a><span id="l15.366">                 LOG(&quot;CalDAV: Failed to parse getCalendarData REPORT&quot;);</span>
<a href="#l15.367"></a><span id="l15.367">                 if (thisCalendar.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l15.368"></a><span id="l15.368">                     aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l15.369"></a><span id="l15.369">                                                 Components.results.NS_ERROR_FAILURE);</span>
<a href="#l15.370"></a><span id="l15.370">                 }</span>
<a href="#l15.371"></a><span id="l15.371">                 return;</span>
<a href="#l15.372"></a><span id="l15.372">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.373"></a><span id="l15.373">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l15.374"></a><span id="l15.374">             }</span>
<a href="#l15.375"></a><span id="l15.375">             if (thisCalendar.isCached) {</span>
<a href="#l15.376"></a><span id="l15.376">                 thisCalendar.superCalendar.startBatch();</span>
<a href="#l15.377"></a><span id="l15.377">             }</span>
<a href="#l15.378"></a><span id="l15.378">             try {</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineminus">-                var multistatus = safeNewXML(str);</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineplus">+                let multistatus = cal.safeNewXML(str);</span>
<a href="#l15.381"></a><span id="l15.381">                 for each (let response in multistatus.*::response) {</span>
<a href="#l15.382"></a><span id="l15.382"> </span>
<a href="#l15.383"></a><span id="l15.383">                     var hasNon200 = false;</span>
<a href="#l15.384"></a><span id="l15.384">                     var non200Statuses = [];</span>
<a href="#l15.385"></a><span id="l15.385">                     for each (let itemStatus in response..D::[&quot;status&quot;]) {</span>
<a href="#l15.386"></a><span id="l15.386">                       var status = itemStatus.toString().split(&quot; &quot;)[1];</span>
<a href="#l15.387"></a><span id="l15.387">                       if (status != 200) {</span>
<a href="#l15.388"></a><span id="l15.388">                           hasNon200 = true;</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineat">@@ -1283,31 +1278,30 @@ calDavCalendar.prototype = {</span>
<a href="#l15.390"></a><span id="l15.390">                 thisCalendar.pollInbox();</span>
<a href="#l15.391"></a><span id="l15.391">             }</span>
<a href="#l15.392"></a><span id="l15.392">         };</span>
<a href="#l15.393"></a><span id="l15.393"> </span>
<a href="#l15.394"></a><span id="l15.394">         if (this.verboseLogging()) {</span>
<a href="#l15.395"></a><span id="l15.395">             LOG(&quot;CalDAV: send: &quot; + aQuery);</span>
<a href="#l15.396"></a><span id="l15.396">         }</span>
<a href="#l15.397"></a><span id="l15.397"> </span>
<a href="#l15.398"></a><span id="l15.398" class="difflineminus">-        var httpchannel = calPrepHttpChannel(aUri,</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineminus">-                                             aQuery,</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineminus">-                                             &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineminus">-                                             this);</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(aUri,</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+                                              aQuery,</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineplus">+                                              &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+                                              this);</span>
<a href="#l15.406"></a><span id="l15.406">         httpchannel.requestMethod = &quot;REPORT&quot;;</span>
<a href="#l15.407"></a><span id="l15.407">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, caldataListener);</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, caldataListener);</span>
<a href="#l15.411"></a><span id="l15.411">     },</span>
<a href="#l15.412"></a><span id="l15.412"> </span>
<a href="#l15.413"></a><span id="l15.413">     /**</span>
<a href="#l15.414"></a><span id="l15.414">      * @see nsIInterfaceRequestor</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineminus">-     * @see calProviderUtils.js</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+     * @see calProviderUtils.jsm</span>
<a href="#l15.417"></a><span id="l15.417">      */</span>
<a href="#l15.418"></a><span id="l15.418" class="difflineminus">-    getInterface: calInterfaceRequestor_getInterface,</span>
<a href="#l15.419"></a><span id="l15.419" class="difflineplus">+    getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l15.420"></a><span id="l15.420"> </span>
<a href="#l15.421"></a><span id="l15.421">     //</span>
<a href="#l15.422"></a><span id="l15.422">     // Helper functions</span>
<a href="#l15.423"></a><span id="l15.423">     //</span>
<a href="#l15.424"></a><span id="l15.424"> </span>
<a href="#l15.425"></a><span id="l15.425">     /**</span>
<a href="#l15.426"></a><span id="l15.426">      * Checks that the calendar URI exists and is a CalDAV calendar. This is the</span>
<a href="#l15.427"></a><span id="l15.427">      * beginning of a chain of asynchronous calls. This function will, when</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineat">@@ -1334,20 +1328,20 @@ calDavCalendar.prototype = {</span>
<a href="#l15.429"></a><span id="l15.429">                             &lt;D:resourcetype/&gt;</span>
<a href="#l15.430"></a><span id="l15.430">                             &lt;D:owner/&gt;</span>
<a href="#l15.431"></a><span id="l15.431">                             &lt;CS:getctag/&gt;</span>
<a href="#l15.432"></a><span id="l15.432">                         &lt;/D:prop&gt;</span>
<a href="#l15.433"></a><span id="l15.433">                         &lt;/D:propfind&gt;;</span>
<a href="#l15.434"></a><span id="l15.434">         if (this.verboseLogging()) {</span>
<a href="#l15.435"></a><span id="l15.435">             LOG(&quot;CalDAV: send: &quot; + queryXml);</span>
<a href="#l15.436"></a><span id="l15.436">         }</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineminus">-        var httpchannel = calPrepHttpChannel(this.calendarUri,</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineminus">-                                             queryXml,</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineminus">-                                             &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineminus">-                                             this);</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(this.calendarUri,</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineplus">+                                              queryXml,</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineplus">+                                              &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineplus">+                                              this);</span>
<a href="#l15.445"></a><span id="l15.445">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l15.446"></a><span id="l15.446">         httpchannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l15.447"></a><span id="l15.447"> </span>
<a href="#l15.448"></a><span id="l15.448">         var streamListener = {};</span>
<a href="#l15.449"></a><span id="l15.449"> </span>
<a href="#l15.450"></a><span id="l15.450">         streamListener.onStreamComplete =</span>
<a href="#l15.451"></a><span id="l15.451">             function checkDavResourceType_oSC(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l15.452"></a><span id="l15.452">             let request = aLoader.request;</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineat">@@ -1374,28 +1368,28 @@ calDavCalendar.prototype = {</span>
<a href="#l15.454"></a><span id="l15.454">             // we only really need the authrealm for Digest auth</span>
<a href="#l15.455"></a><span id="l15.455">             // since only Digest is going to time out on us</span>
<a href="#l15.456"></a><span id="l15.456">             if (thisCalendar.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l15.457"></a><span id="l15.457">                 var realmChop = wwwauth.split(&quot;realm=\&quot;&quot;)[1];</span>
<a href="#l15.458"></a><span id="l15.458">                 thisCalendar.mAuthRealm = realmChop.split(&quot;\&quot;, &quot;)[0];</span>
<a href="#l15.459"></a><span id="l15.459">                 LOG(&quot;CalDAV: realm &quot; + thisCalendar.mAuthRealm);</span>
<a href="#l15.460"></a><span id="l15.460">             }</span>
<a href="#l15.461"></a><span id="l15.461"> </span>
<a href="#l15.462"></a><span id="l15.462" class="difflineminus">-            var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l15.463"></a><span id="l15.463" class="difflineplus">+            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l15.464"></a><span id="l15.464">             if (!str) {</span>
<a href="#l15.465"></a><span id="l15.465">                 LOG(&quot;CalDAV: Failed to determine resource type&quot;);</span>
<a href="#l15.466"></a><span id="l15.466">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l15.467"></a><span id="l15.467">                                                      Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l15.468"></a><span id="l15.468">                 return;</span>
<a href="#l15.469"></a><span id="l15.469">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.470"></a><span id="l15.470">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l15.471"></a><span id="l15.471">             }</span>
<a href="#l15.472"></a><span id="l15.472"> </span>
<a href="#l15.473"></a><span id="l15.473">             try {</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineminus">-                var multistatus = safeNewXML(str);</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineplus">+                var multistatus = cal.safeNewXML(str);</span>
<a href="#l15.476"></a><span id="l15.476">             } catch (ex) {</span>
<a href="#l15.477"></a><span id="l15.477">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l15.478"></a><span id="l15.478">                                                      Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l15.479"></a><span id="l15.479">                 return;</span>
<a href="#l15.480"></a><span id="l15.480">             }</span>
<a href="#l15.481"></a><span id="l15.481"> </span>
<a href="#l15.482"></a><span id="l15.482">             // check for server-side ctag support</span>
<a href="#l15.483"></a><span id="l15.483">             var ctag = multistatus..CS::[&quot;getctag&quot;].toString();</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineat">@@ -1445,34 +1439,33 @@ calDavCalendar.prototype = {</span>
<a href="#l15.485"></a><span id="l15.485">                 thisCalendar.mDisabled) {</span>
<a href="#l15.486"></a><span id="l15.486">                 thisCalendar.mDisabled = false;</span>
<a href="#l15.487"></a><span id="l15.487">                 thisCalendar.mReadOnly = false;</span>
<a href="#l15.488"></a><span id="l15.488">             }</span>
<a href="#l15.489"></a><span id="l15.489"> </span>
<a href="#l15.490"></a><span id="l15.490">             thisCalendar.setCalHomeSet();</span>
<a href="#l15.491"></a><span id="l15.491">             thisCalendar.checkServerCaps(aChangeLogListener);</span>
<a href="#l15.492"></a><span id="l15.492">         };</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, streamListener);</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l15.496"></a><span id="l15.496">     },</span>
<a href="#l15.497"></a><span id="l15.497"> </span>
<a href="#l15.498"></a><span id="l15.498">     /**</span>
<a href="#l15.499"></a><span id="l15.499">      * Checks server capabilities.</span>
<a href="#l15.500"></a><span id="l15.500">      *</span>
<a href="#l15.501"></a><span id="l15.501">      * checkDavResourceType</span>
<a href="#l15.502"></a><span id="l15.502">      * checkServerCaps                              * You are here</span>
<a href="#l15.503"></a><span id="l15.503">      * findPrincipalNS</span>
<a href="#l15.504"></a><span id="l15.504">      * checkPrincipalsNameSpace</span>
<a href="#l15.505"></a><span id="l15.505">      * completeCheckServerInfo</span>
<a href="#l15.506"></a><span id="l15.506">      */</span>
<a href="#l15.507"></a><span id="l15.507">     checkServerCaps: function caldav_checkServerCaps(aChangeLogListener) {</span>
<a href="#l15.508"></a><span id="l15.508">         var homeSet = this.mCalHomeSet.clone();</span>
<a href="#l15.509"></a><span id="l15.509">         var thisCalendar = this;</span>
<a href="#l15.510"></a><span id="l15.510"> </span>
<a href="#l15.511"></a><span id="l15.511" class="difflineminus">-        var httpchannel = calPrepHttpChannel(homeSet, null, null, this);</span>
<a href="#l15.512"></a><span id="l15.512" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(homeSet, null, null, this);</span>
<a href="#l15.513"></a><span id="l15.513"> </span>
<a href="#l15.514"></a><span id="l15.514">         httpchannel.requestMethod = &quot;OPTIONS&quot;;</span>
<a href="#l15.515"></a><span id="l15.515">         if (this.verboseLogging()) {</span>
<a href="#l15.516"></a><span id="l15.516">             LOG(&quot;CalDAV: send: OPTIONS&quot;);</span>
<a href="#l15.517"></a><span id="l15.517">         }</span>
<a href="#l15.518"></a><span id="l15.518"> </span>
<a href="#l15.519"></a><span id="l15.519">         var streamListener = {};</span>
<a href="#l15.520"></a><span id="l15.520">         streamListener.onStreamComplete =</span>
<a href="#l15.521"></a><span id="l15.521" class="difflineat">@@ -1482,17 +1475,17 @@ calDavCalendar.prototype = {</span>
<a href="#l15.522"></a><span id="l15.522">             let dav = null;</span>
<a href="#l15.523"></a><span id="l15.523">             try {</span>
<a href="#l15.524"></a><span id="l15.524">                 dav = request.getResponseHeader(&quot;DAV&quot;);</span>
<a href="#l15.525"></a><span id="l15.525">                 if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.526"></a><span id="l15.526">                     LOG(&quot;CalDAV: DAV header: &quot; + dav);</span>
<a href="#l15.527"></a><span id="l15.527">                 }</span>
<a href="#l15.528"></a><span id="l15.528">             } catch (ex) {</span>
<a href="#l15.529"></a><span id="l15.529">                 LOG(&quot;CalDAV: Error getting DAV header, status &quot; + request.responseStatus +</span>
<a href="#l15.530"></a><span id="l15.530" class="difflineminus">-                    &quot;, data: &quot; + convertByteArray(aResult, aResultLength));</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineplus">+                    &quot;, data: &quot; + cal.convertByteArray(aResult, aResultLength));</span>
<a href="#l15.532"></a><span id="l15.532">             </span>
<a href="#l15.533"></a><span id="l15.533">             }</span>
<a href="#l15.534"></a><span id="l15.534">             // Google does not yet support OPTIONS but does support scheduling</span>
<a href="#l15.535"></a><span id="l15.535">             // so we'll spoof the DAV header until Google gets fixed</span>
<a href="#l15.536"></a><span id="l15.536">             if (thisCalendar.calendarUri.host == &quot;www.google.com&quot;) {</span>
<a href="#l15.537"></a><span id="l15.537">                 dav = &quot;calendar-schedule&quot;;</span>
<a href="#l15.538"></a><span id="l15.538">                 // Google also reports an inbox URL distinct from the calendar</span>
<a href="#l15.539"></a><span id="l15.539">                 // URL but a) doesn't use it and b) 405s on etag queries to it</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineat">@@ -1519,18 +1512,17 @@ calDavCalendar.prototype = {</span>
<a href="#l15.541"></a><span id="l15.541">                 getFreeBusyService().addProvider(thisCalendar);</span>
<a href="#l15.542"></a><span id="l15.542">                 thisCalendar.findPrincipalNS(aChangeLogListener);</span>
<a href="#l15.543"></a><span id="l15.543">             } else {</span>
<a href="#l15.544"></a><span id="l15.544">                 LOG(&quot;CalDAV: Server does not support CalDAV scheduling.&quot;);</span>
<a href="#l15.545"></a><span id="l15.545">                 thisCalendar.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l15.546"></a><span id="l15.546">             }</span>
<a href="#l15.547"></a><span id="l15.547">         };</span>
<a href="#l15.548"></a><span id="l15.548"> </span>
<a href="#l15.549"></a><span id="l15.549" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.550"></a><span id="l15.550" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, streamListener);</span>
<a href="#l15.551"></a><span id="l15.551" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l15.552"></a><span id="l15.552">     },</span>
<a href="#l15.553"></a><span id="l15.553"> </span>
<a href="#l15.554"></a><span id="l15.554">     /**</span>
<a href="#l15.555"></a><span id="l15.555">      * Locates the principal namespace. This function should soely be called</span>
<a href="#l15.556"></a><span id="l15.556">      * from checkServerCaps to find the principal namespace.</span>
<a href="#l15.557"></a><span id="l15.557">      *</span>
<a href="#l15.558"></a><span id="l15.558">      * checkDavResourceType</span>
<a href="#l15.559"></a><span id="l15.559">      * checkServerCaps</span>
<a href="#l15.560"></a><span id="l15.560" class="difflineat">@@ -1555,20 +1547,20 @@ calDavCalendar.prototype = {</span>
<a href="#l15.561"></a><span id="l15.561">                 &lt;D:prop&gt;</span>
<a href="#l15.562"></a><span id="l15.562">                     &lt;D:principal-collection-set/&gt;</span>
<a href="#l15.563"></a><span id="l15.563">                 &lt;/D:prop&gt;</span>
<a href="#l15.564"></a><span id="l15.564">             &lt;/D:propfind&gt;;</span>
<a href="#l15.565"></a><span id="l15.565"> </span>
<a href="#l15.566"></a><span id="l15.566">         if (this.verboseLogging()) {</span>
<a href="#l15.567"></a><span id="l15.567">             LOG(&quot;CalDAV: send: &quot; + homeSet.spec + &quot;\n&quot;  + queryXml);</span>
<a href="#l15.568"></a><span id="l15.568">         }</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineminus">-        var httpchannel = calPrepHttpChannel(homeSet,</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineminus">-                                             queryXml,</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineminus">-                                             &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineminus">-                                             this);</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(homeSet,</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineplus">+                                              queryXml,</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineplus">+                                              &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.576"></a><span id="l15.576" class="difflineplus">+                                              this);</span>
<a href="#l15.577"></a><span id="l15.577"> </span>
<a href="#l15.578"></a><span id="l15.578">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l15.579"></a><span id="l15.579">         httpchannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l15.580"></a><span id="l15.580"> </span>
<a href="#l15.581"></a><span id="l15.581">         var streamListener = {};</span>
<a href="#l15.582"></a><span id="l15.582">         streamListener.onStreamComplete =</span>
<a href="#l15.583"></a><span id="l15.583">             function findInOutboxes_oSC(aLoader, aContext, aStatus,</span>
<a href="#l15.584"></a><span id="l15.584">                                          aResultLength, aResult) {</span>
<a href="#l15.585"></a><span id="l15.585" class="difflineat">@@ -1576,40 +1568,39 @@ calDavCalendar.prototype = {</span>
<a href="#l15.586"></a><span id="l15.586">             if (request.responseStatus != 207) {</span>
<a href="#l15.587"></a><span id="l15.587">                 LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l15.588"></a><span id="l15.588">                     &quot; while querying principal namespace&quot;);</span>
<a href="#l15.589"></a><span id="l15.589">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l15.590"></a><span id="l15.590">                                                      Components.results.NS_ERROR_FAILURE);</span>
<a href="#l15.591"></a><span id="l15.591">                 return;</span>
<a href="#l15.592"></a><span id="l15.592">             }</span>
<a href="#l15.593"></a><span id="l15.593"> </span>
<a href="#l15.594"></a><span id="l15.594" class="difflineminus">-            var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l15.595"></a><span id="l15.595" class="difflineplus">+            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l15.596"></a><span id="l15.596">             if (!str) {</span>
<a href="#l15.597"></a><span id="l15.597">                 LOG(&quot;CalDAV: Failed to propstat principal namespace&quot;);</span>
<a href="#l15.598"></a><span id="l15.598">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l15.599"></a><span id="l15.599">                                                      Components.results.NS_ERROR_FAILURE);</span>
<a href="#l15.600"></a><span id="l15.600">                 return;</span>
<a href="#l15.601"></a><span id="l15.601">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.602"></a><span id="l15.602">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l15.603"></a><span id="l15.603">             }</span>
<a href="#l15.604"></a><span id="l15.604"> </span>
<a href="#l15.605"></a><span id="l15.605" class="difflineminus">-            var multistatus = safeNewXML(str);</span>
<a href="#l15.606"></a><span id="l15.606" class="difflineplus">+            let multistatus = cal.safeNewXML(str);</span>
<a href="#l15.607"></a><span id="l15.607">             var pcs = multistatus..D::[&quot;principal-collection-set&quot;]..D::href;</span>
<a href="#l15.608"></a><span id="l15.608">             var nsList = [];</span>
<a href="#l15.609"></a><span id="l15.609">             for (var ns in pcs) {</span>
<a href="#l15.610"></a><span id="l15.610">                 var nsString = pcs[ns].toString();</span>
<a href="#l15.611"></a><span id="l15.611">                 var nsPath = thisCalendar.ensurePath(nsString);</span>
<a href="#l15.612"></a><span id="l15.612">                 nsList.push(nsPath);</span>
<a href="#l15.613"></a><span id="l15.613">             }</span>
<a href="#l15.614"></a><span id="l15.614"> </span>
<a href="#l15.615"></a><span id="l15.615">             thisCalendar.checkPrincipalsNameSpace(nsList, aChangeLogListener);</span>
<a href="#l15.616"></a><span id="l15.616">         };</span>
<a href="#l15.617"></a><span id="l15.617"> </span>
<a href="#l15.618"></a><span id="l15.618" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.619"></a><span id="l15.619" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, streamListener);</span>
<a href="#l15.620"></a><span id="l15.620" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l15.621"></a><span id="l15.621">     },</span>
<a href="#l15.622"></a><span id="l15.622"> </span>
<a href="#l15.623"></a><span id="l15.623">     /**</span>
<a href="#l15.624"></a><span id="l15.624">      * Checks the principals namespace for scheduling info. This function should</span>
<a href="#l15.625"></a><span id="l15.625">      * soely be called from findPrincipalNS</span>
<a href="#l15.626"></a><span id="l15.626">      *</span>
<a href="#l15.627"></a><span id="l15.627">      * checkDavResourceType</span>
<a href="#l15.628"></a><span id="l15.628">      * checkServerCaps</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineat">@@ -1681,50 +1672,50 @@ calDavCalendar.prototype = {</span>
<a href="#l15.630"></a><span id="l15.630">         // We want a trailing slash, ensure it.</span>
<a href="#l15.631"></a><span id="l15.631">         var nsUri = this.calendarUri.clone();</span>
<a href="#l15.632"></a><span id="l15.632">         nsUri.path = aNameSpaceList.pop().replace(/([^\/])$/, &quot;$1/&quot;);</span>
<a href="#l15.633"></a><span id="l15.633"> </span>
<a href="#l15.634"></a><span id="l15.634">         if (this.verboseLogging()) {</span>
<a href="#l15.635"></a><span id="l15.635">             LOG(&quot;CalDAV: send: &quot; + queryMethod + &quot; &quot; + nsUri.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l15.636"></a><span id="l15.636">         }</span>
<a href="#l15.637"></a><span id="l15.637"> </span>
<a href="#l15.638"></a><span id="l15.638" class="difflineminus">-        var httpchannel = calPrepHttpChannel(nsUri,</span>
<a href="#l15.639"></a><span id="l15.639" class="difflineminus">-                                             queryXml,</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineminus">-                                             &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.641"></a><span id="l15.641" class="difflineminus">-                                             this);</span>
<a href="#l15.642"></a><span id="l15.642" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(nsUri,</span>
<a href="#l15.643"></a><span id="l15.643" class="difflineplus">+                                              queryXml,</span>
<a href="#l15.644"></a><span id="l15.644" class="difflineplus">+                                              &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineplus">+                                              this);</span>
<a href="#l15.646"></a><span id="l15.646"> </span>
<a href="#l15.647"></a><span id="l15.647">         httpchannel.requestMethod = queryMethod;</span>
<a href="#l15.648"></a><span id="l15.648">         if (queryDepth == 0) {</span>
<a href="#l15.649"></a><span id="l15.649">             // Set header, doing this for Depth: 1 is not needed since thats the</span>
<a href="#l15.650"></a><span id="l15.650">             // default.</span>
<a href="#l15.651"></a><span id="l15.651">             httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l15.652"></a><span id="l15.652">         }</span>
<a href="#l15.653"></a><span id="l15.653"> </span>
<a href="#l15.654"></a><span id="l15.654">         var streamListener = {};</span>
<a href="#l15.655"></a><span id="l15.655">         streamListener.onStreamComplete =</span>
<a href="#l15.656"></a><span id="l15.656">             function caldav_cPNS_oSC(aLoader, aContext, aStatus,</span>
<a href="#l15.657"></a><span id="l15.657">                                          aResultLength, aResult) {</span>
<a href="#l15.658"></a><span id="l15.658" class="difflineminus">-            var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l15.659"></a><span id="l15.659" class="difflineplus">+            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l15.660"></a><span id="l15.660">             if (!str) {</span>
<a href="#l15.661"></a><span id="l15.661">                 LOG(&quot;CalDAV: Failed to report principals namespace&quot;);</span>
<a href="#l15.662"></a><span id="l15.662">                 doesntSupportScheduling();</span>
<a href="#l15.663"></a><span id="l15.663">                 return;</span>
<a href="#l15.664"></a><span id="l15.664">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.665"></a><span id="l15.665">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l15.666"></a><span id="l15.666">             }</span>
<a href="#l15.667"></a><span id="l15.667"> </span>
<a href="#l15.668"></a><span id="l15.668">             if (aLoader.request.responseStatus != 207) {</span>
<a href="#l15.669"></a><span id="l15.669">                 LOG(&quot;CalDAV: Bad response to in/outbox query, status &quot; +</span>
<a href="#l15.670"></a><span id="l15.670">                     aLoader.request.responseStatus);</span>
<a href="#l15.671"></a><span id="l15.671">                 doesntSupportScheduling();</span>
<a href="#l15.672"></a><span id="l15.672">                 return;</span>
<a href="#l15.673"></a><span id="l15.673">             }</span>
<a href="#l15.674"></a><span id="l15.674"> </span>
<a href="#l15.675"></a><span id="l15.675" class="difflineminus">-            var multistatus = safeNewXML(str);</span>
<a href="#l15.676"></a><span id="l15.676" class="difflineminus">-            var multistatusLength = multistatus.*::response.length();</span>
<a href="#l15.677"></a><span id="l15.677" class="difflineplus">+            let multistatus = cal.safeNewXML(str);</span>
<a href="#l15.678"></a><span id="l15.678" class="difflineplus">+            let multistatusLength = multistatus.*::response.length();</span>
<a href="#l15.679"></a><span id="l15.679"> </span>
<a href="#l15.680"></a><span id="l15.680">             for each (let response in multistatus.*::response) {</span>
<a href="#l15.681"></a><span id="l15.681">                 let responseCHS = null;</span>
<a href="#l15.682"></a><span id="l15.682">                 try {</span>
<a href="#l15.683"></a><span id="l15.683">                     responseCHS = response..*::[&quot;calendar-home-set&quot;]..*::href[0].toString().replace(/([^/])$/, &quot;$1/&quot;);</span>
<a href="#l15.684"></a><span id="l15.684">                 } catch (ex) {}</span>
<a href="#l15.685"></a><span id="l15.685"> </span>
<a href="#l15.686"></a><span id="l15.686">                 if (multistatusLength &gt; 1 &amp;&amp;</span>
<a href="#l15.687"></a><span id="l15.687" class="difflineat">@@ -1767,18 +1758,17 @@ calDavCalendar.prototype = {</span>
<a href="#l15.688"></a><span id="l15.688">                     doesntSupportScheduling();</span>
<a href="#l15.689"></a><span id="l15.689">                 }</span>
<a href="#l15.690"></a><span id="l15.690">             } else {</span>
<a href="#l15.691"></a><span id="l15.691">                 // We have everything, complete.</span>
<a href="#l15.692"></a><span id="l15.692">                 thisCalendar.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l15.693"></a><span id="l15.693">             }</span>
<a href="#l15.694"></a><span id="l15.694">         };</span>
<a href="#l15.695"></a><span id="l15.695"> </span>
<a href="#l15.696"></a><span id="l15.696" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.697"></a><span id="l15.697" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, streamListener);</span>
<a href="#l15.698"></a><span id="l15.698" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l15.699"></a><span id="l15.699">     },</span>
<a href="#l15.700"></a><span id="l15.700"> </span>
<a href="#l15.701"></a><span id="l15.701">     /**</span>
<a href="#l15.702"></a><span id="l15.702">      * This is called to complete checking the server info. It should be the</span>
<a href="#l15.703"></a><span id="l15.703">      * final call when checking server options. This will either report the</span>
<a href="#l15.704"></a><span id="l15.704">      * error or if it is a success then refresh the calendar.</span>
<a href="#l15.705"></a><span id="l15.705">      *</span>
<a href="#l15.706"></a><span id="l15.706">      * checkDavResourceType</span>
<a href="#l15.707"></a><span id="l15.707" class="difflineat">@@ -1911,31 +1901,31 @@ calDavCalendar.prototype = {</span>
<a href="#l15.708"></a><span id="l15.708">         fbComp.addProperty(prop);</span>
<a href="#l15.709"></a><span id="l15.709">         fbQuery.addSubcomponent(fbComp);</span>
<a href="#l15.710"></a><span id="l15.710">         fbQuery = fbQuery.serializeToICS();</span>
<a href="#l15.711"></a><span id="l15.711">         if (this.verboseLogging()) {</span>
<a href="#l15.712"></a><span id="l15.712">             LOG(&quot;CalDAV: send (Originator=&quot; + organizer +</span>
<a href="#l15.713"></a><span id="l15.713">                     &quot;,Recipient=&quot; + mailto_aCalId + &quot;): &quot; + fbQuery);</span>
<a href="#l15.714"></a><span id="l15.714">         }</span>
<a href="#l15.715"></a><span id="l15.715"> </span>
<a href="#l15.716"></a><span id="l15.716" class="difflineminus">-        var httpchannel = calPrepHttpChannel(this.outboxUrl,</span>
<a href="#l15.717"></a><span id="l15.717" class="difflineminus">-                                             fbQuery,</span>
<a href="#l15.718"></a><span id="l15.718" class="difflineminus">-                                             &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l15.719"></a><span id="l15.719" class="difflineminus">-                                             this);</span>
<a href="#l15.720"></a><span id="l15.720" class="difflineplus">+        let httpchannel = cal.prepHttpChannel(this.outboxUrl,</span>
<a href="#l15.721"></a><span id="l15.721" class="difflineplus">+                                              fbQuery,</span>
<a href="#l15.722"></a><span id="l15.722" class="difflineplus">+                                              &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l15.723"></a><span id="l15.723" class="difflineplus">+                                              this);</span>
<a href="#l15.724"></a><span id="l15.724">         httpchannel.requestMethod = &quot;POST&quot;;</span>
<a href="#l15.725"></a><span id="l15.725">         httpchannel.setRequestHeader(&quot;Originator&quot;, organizer, false);</span>
<a href="#l15.726"></a><span id="l15.726">         httpchannel.setRequestHeader(&quot;Recipient&quot;, mailto_aCalId, false);</span>
<a href="#l15.727"></a><span id="l15.727"> </span>
<a href="#l15.728"></a><span id="l15.728">         var streamListener = {};</span>
<a href="#l15.729"></a><span id="l15.729"> </span>
<a href="#l15.730"></a><span id="l15.730">         streamListener.onStreamComplete =</span>
<a href="#l15.731"></a><span id="l15.731">             function caldav_GFBI_oSC(aLoader, aContext, aStatus,</span>
<a href="#l15.732"></a><span id="l15.732">                                          aResultLength, aResult) {</span>
<a href="#l15.733"></a><span id="l15.733">             let request = aLoader.request;</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineminus">-            let str = convertByteArray(aResult, aResultLength);</span>
<a href="#l15.735"></a><span id="l15.735" class="difflineplus">+            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l15.736"></a><span id="l15.736">             if (!str) {</span>
<a href="#l15.737"></a><span id="l15.737">                 LOG(&quot;CalDAV: Failed to parse freebusy response&quot;);</span>
<a href="#l15.738"></a><span id="l15.738">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.739"></a><span id="l15.739">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l15.740"></a><span id="l15.740">             }</span>
<a href="#l15.741"></a><span id="l15.741"> </span>
<a href="#l15.742"></a><span id="l15.742">             if (request.responseStatus == 200) {</span>
<a href="#l15.743"></a><span id="l15.743">                 var periodsToReturn = [];</span>
<a href="#l15.744"></a><span id="l15.744" class="difflineat">@@ -1944,18 +1934,18 @@ calDavCalendar.prototype = {</span>
<a href="#l15.745"></a><span id="l15.745">                 var fbTypeMap = {};</span>
<a href="#l15.746"></a><span id="l15.746">                 fbTypeMap[&quot;FREE&quot;] = calIFreeBusyInterval.FREE;</span>
<a href="#l15.747"></a><span id="l15.747">                 fbTypeMap[&quot;BUSY&quot;] = calIFreeBusyInterval.BUSY;</span>
<a href="#l15.748"></a><span id="l15.748">                 fbTypeMap[&quot;BUSY-UNAVAILABLE&quot;] = calIFreeBusyInterval.BUSY_UNAVAILABLE;</span>
<a href="#l15.749"></a><span id="l15.749">                 fbTypeMap[&quot;BUSY-TENTATIVE&quot;] = calIFreeBusyInterval.BUSY_TENTATIVE;</span>
<a href="#l15.750"></a><span id="l15.750">                 var C = new Namespace(&quot;C&quot;, &quot;urn:ietf:params:xml:ns:caldav&quot;);</span>
<a href="#l15.751"></a><span id="l15.751">                 var D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l15.752"></a><span id="l15.752"> </span>
<a href="#l15.753"></a><span id="l15.753" class="difflineminus">-                var response = safeNewXML(str);</span>
<a href="#l15.754"></a><span id="l15.754" class="difflineminus">-                var status = response..C::response..C::[&quot;request-status&quot;];</span>
<a href="#l15.755"></a><span id="l15.755" class="difflineplus">+                let response = cal.safeNewXML(str);</span>
<a href="#l15.756"></a><span id="l15.756" class="difflineplus">+                let status = response..C::response..C::[&quot;request-status&quot;];</span>
<a href="#l15.757"></a><span id="l15.757">                 if (status.substr(0,1) != 2) {</span>
<a href="#l15.758"></a><span id="l15.758">                     LOG(&quot;CalDAV: Got status &quot; + status + &quot; in response to freebusy query&quot;);</span>
<a href="#l15.759"></a><span id="l15.759">                     aListener.onResult(null, null);</span>
<a href="#l15.760"></a><span id="l15.760">                     return;</span>
<a href="#l15.761"></a><span id="l15.761">                 }</span>
<a href="#l15.762"></a><span id="l15.762">                 if (status.substr(0,3) != &quot;2.0&quot;) {</span>
<a href="#l15.763"></a><span id="l15.763">                     LOG(&quot;CalDAV: Got status &quot; + status + &quot; in response to freebusy query&quot;);</span>
<a href="#l15.764"></a><span id="l15.764">                 }</span>
<a href="#l15.765"></a><span id="l15.765" class="difflineat">@@ -1963,28 +1953,28 @@ calDavCalendar.prototype = {</span>
<a href="#l15.766"></a><span id="l15.766">                 var caldata = response..C::response..C::[&quot;calendar-data&quot;];</span>
<a href="#l15.767"></a><span id="l15.767">                 try {</span>
<a href="#l15.768"></a><span id="l15.768">                     let calComp = getIcsService().parseICS(caldata, null);</span>
<a href="#l15.769"></a><span id="l15.769">                     for (let fbComp in cal.ical.calendarComponentIterator(calComp)) {</span>
<a href="#l15.770"></a><span id="l15.770">                         let interval;</span>
<a href="#l15.771"></a><span id="l15.771"> </span>
<a href="#l15.772"></a><span id="l15.772">                         let replyRangeStart = fbComp.startTime;</span>
<a href="#l15.773"></a><span id="l15.773">                         if (replyRangeStart &amp;&amp; (aRangeStart.compare(replyRangeStart) == -1)) {</span>
<a href="#l15.774"></a><span id="l15.774" class="difflineminus">-                            interval = new calFreeBusyInterval(aCalId,</span>
<a href="#l15.775"></a><span id="l15.775" class="difflineminus">-                                                               calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l15.776"></a><span id="l15.776" class="difflineminus">-                                                               aRangeStart,</span>
<a href="#l15.777"></a><span id="l15.777" class="difflineminus">-                                                               replyRangeStart);</span>
<a href="#l15.778"></a><span id="l15.778" class="difflineplus">+                            interval = new cal.FreeBusyInterval(aCalId,</span>
<a href="#l15.779"></a><span id="l15.779" class="difflineplus">+                                                                calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l15.780"></a><span id="l15.780" class="difflineplus">+                                                                aRangeStart,</span>
<a href="#l15.781"></a><span id="l15.781" class="difflineplus">+                                                                replyRangeStart);</span>
<a href="#l15.782"></a><span id="l15.782">                             periodsToReturn.push(interval);</span>
<a href="#l15.783"></a><span id="l15.783">                         }</span>
<a href="#l15.784"></a><span id="l15.784">                         let replyRangeEnd = fbComp.endTime;</span>
<a href="#l15.785"></a><span id="l15.785">                         if (replyRangeEnd &amp;&amp; (aRangeEnd.compare(replyRangeEnd) == 1)) {</span>
<a href="#l15.786"></a><span id="l15.786" class="difflineminus">-                            interval = new calFreeBusyInterval(aCalId,</span>
<a href="#l15.787"></a><span id="l15.787" class="difflineminus">-                                                               calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l15.788"></a><span id="l15.788" class="difflineminus">-                                                               replyRangeEnd,</span>
<a href="#l15.789"></a><span id="l15.789" class="difflineminus">-                                                               aRangeEnd);</span>
<a href="#l15.790"></a><span id="l15.790" class="difflineplus">+                            interval = new cal.FreeBusyInterval(aCalId,</span>
<a href="#l15.791"></a><span id="l15.791" class="difflineplus">+                                                                calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l15.792"></a><span id="l15.792" class="difflineplus">+                                                                replyRangeEnd,</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineplus">+                                                                aRangeEnd);</span>
<a href="#l15.794"></a><span id="l15.794">                             periodsToReturn.push(interval);</span>
<a href="#l15.795"></a><span id="l15.795">                         }</span>
<a href="#l15.796"></a><span id="l15.796"> </span>
<a href="#l15.797"></a><span id="l15.797">                         for (let fbProp in cal.ical.propertyIterator(fbComp, &quot;FREEBUSY&quot;)) {</span>
<a href="#l15.798"></a><span id="l15.798">                             let fbType = fbProp.getParameter(&quot;FBTYPE&quot;);</span>
<a href="#l15.799"></a><span id="l15.799">                             if (fbType) {</span>
<a href="#l15.800"></a><span id="l15.800">                                 fbType = fbTypeMap[fbType];</span>
<a href="#l15.801"></a><span id="l15.801">                             } else {</span>
<a href="#l15.802"></a><span id="l15.802" class="difflineat">@@ -1995,36 +1985,35 @@ calDavCalendar.prototype = {</span>
<a href="#l15.803"></a><span id="l15.803">                             let end;</span>
<a href="#l15.804"></a><span id="l15.804">                             if (parts[1].charAt(0) == &quot;P&quot;) { // this is a duration</span>
<a href="#l15.805"></a><span id="l15.805">                                 end = begin.clone();</span>
<a href="#l15.806"></a><span id="l15.806">                                 end.addDuration(cal.createDuration(parts[1]))</span>
<a href="#l15.807"></a><span id="l15.807">                             } else {</span>
<a href="#l15.808"></a><span id="l15.808">                                 // This is a date string</span>
<a href="#l15.809"></a><span id="l15.809">                                 end = cal.createDateTime(parts[1]);</span>
<a href="#l15.810"></a><span id="l15.810">                             }</span>
<a href="#l15.811"></a><span id="l15.811" class="difflineminus">-                            interval = new calFreeBusyInterval(aCalId,</span>
<a href="#l15.812"></a><span id="l15.812" class="difflineminus">-                                                               fbType,</span>
<a href="#l15.813"></a><span id="l15.813" class="difflineminus">-                                                               begin,</span>
<a href="#l15.814"></a><span id="l15.814" class="difflineminus">-                                                               end);</span>
<a href="#l15.815"></a><span id="l15.815" class="difflineplus">+                            interval = new cal.FreeBusyInterval(aCalId,</span>
<a href="#l15.816"></a><span id="l15.816" class="difflineplus">+                                                                fbType,</span>
<a href="#l15.817"></a><span id="l15.817" class="difflineplus">+                                                                begin,</span>
<a href="#l15.818"></a><span id="l15.818" class="difflineplus">+                                                                end);</span>
<a href="#l15.819"></a><span id="l15.819">                             periodsToReturn.push(interval);</span>
<a href="#l15.820"></a><span id="l15.820">                         }</span>
<a href="#l15.821"></a><span id="l15.821">                     }</span>
<a href="#l15.822"></a><span id="l15.822">                 } catch (exc) {</span>
<a href="#l15.823"></a><span id="l15.823">                     LOG(&quot;Error parsing free-busy info.&quot;);</span>
<a href="#l15.824"></a><span id="l15.824">                 }</span>
<a href="#l15.825"></a><span id="l15.825"> </span>
<a href="#l15.826"></a><span id="l15.826">                 aListener.onResult(null, periodsToReturn);</span>
<a href="#l15.827"></a><span id="l15.827">             } else {</span>
<a href="#l15.828"></a><span id="l15.828">                 LOG(&quot;CalDAV: Received status &quot; + request.responseStatus + &quot; from freebusy query&quot;);</span>
<a href="#l15.829"></a><span id="l15.829">                 aListener.onResult(null, null);</span>
<a href="#l15.830"></a><span id="l15.830">             }</span>
<a href="#l15.831"></a><span id="l15.831">         };</span>
<a href="#l15.832"></a><span id="l15.832"> </span>
<a href="#l15.833"></a><span id="l15.833" class="difflineminus">-        var streamLoader = createStreamLoader();</span>
<a href="#l15.834"></a><span id="l15.834" class="difflineminus">-        calSendHttpRequest(streamLoader, httpchannel, streamListener);</span>
<a href="#l15.835"></a><span id="l15.835" class="difflineplus">+        cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l15.836"></a><span id="l15.836">     },</span>
<a href="#l15.837"></a><span id="l15.837"> </span>
<a href="#l15.838"></a><span id="l15.838">     ensurePath: function caldav_ensurePath(aString) {</span>
<a href="#l15.839"></a><span id="l15.839">         if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l15.840"></a><span id="l15.840">             var bogusUri = makeURL(aString);</span>
<a href="#l15.841"></a><span id="l15.841">             return bogusUri.path;</span>
<a href="#l15.842"></a><span id="l15.842">         }</span>
<a href="#l15.843"></a><span id="l15.843">         return aString;</span>
<a href="#l15.844"></a><span id="l15.844" class="difflineat">@@ -2046,17 +2035,17 @@ calDavCalendar.prototype = {</span>
<a href="#l15.845"></a><span id="l15.845">         if (!this.hasScheduling || !this.mShouldPollInbox || !this.firstInRealm()) {</span>
<a href="#l15.846"></a><span id="l15.846">             return;</span>
<a href="#l15.847"></a><span id="l15.847">         }</span>
<a href="#l15.848"></a><span id="l15.848"> </span>
<a href="#l15.849"></a><span id="l15.849">         this.getUpdatedItems(this.mInboxUrl, null);</span>
<a href="#l15.850"></a><span id="l15.850">     },</span>
<a href="#l15.851"></a><span id="l15.851"> </span>
<a href="#l15.852"></a><span id="l15.852">     //</span>
<a href="#l15.853"></a><span id="l15.853" class="difflineminus">-    // take calISchedulingSupport interface base implementation (calProviderBase.js)</span>
<a href="#l15.854"></a><span id="l15.854" class="difflineplus">+    // take calISchedulingSupport interface base implementation (cal.ProviderBase)</span>
<a href="#l15.855"></a><span id="l15.855">     //</span>
<a href="#l15.856"></a><span id="l15.856"> </span>
<a href="#l15.857"></a><span id="l15.857">     processItipReply: function caldav_processItipReply(aItem, aPath) {</span>
<a href="#l15.858"></a><span id="l15.858">         // modify partstat for in-calendar item</span>
<a href="#l15.859"></a><span id="l15.859">         // delete item from inbox</span>
<a href="#l15.860"></a><span id="l15.860">         var thisCalendar = this;</span>
<a href="#l15.861"></a><span id="l15.861"> </span>
<a href="#l15.862"></a><span id="l15.862">         var getItemListener = {};</span>
<a href="#l15.863"></a><span id="l15.863" class="difflineat">@@ -2154,20 +2143,20 @@ calDavCalendar.prototype = {</span>
<a href="#l15.864"></a><span id="l15.864">             var serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l15.865"></a><span id="l15.865">                                        .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l15.866"></a><span id="l15.866">             serializer.addItems([item], 1);</span>
<a href="#l15.867"></a><span id="l15.867">             var methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l15.868"></a><span id="l15.868">             methodProp.value = aItipItem.responseMethod;</span>
<a href="#l15.869"></a><span id="l15.869">             serializer.addProperty(methodProp);</span>
<a href="#l15.870"></a><span id="l15.870">             var uploadData = serializer.serializeToString();</span>
<a href="#l15.871"></a><span id="l15.871"> </span>
<a href="#l15.872"></a><span id="l15.872" class="difflineminus">-            var httpchannel = calPrepHttpChannel(this.outboxUrl,</span>
<a href="#l15.873"></a><span id="l15.873" class="difflineminus">-                                                 uploadData,</span>
<a href="#l15.874"></a><span id="l15.874" class="difflineminus">-                                                 &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l15.875"></a><span id="l15.875" class="difflineminus">-                                                 this);</span>
<a href="#l15.876"></a><span id="l15.876" class="difflineplus">+            let httpchannel = cal.prepHttpChannel(this.outboxUrl,</span>
<a href="#l15.877"></a><span id="l15.877" class="difflineplus">+                                                  uploadData,</span>
<a href="#l15.878"></a><span id="l15.878" class="difflineplus">+                                                  &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l15.879"></a><span id="l15.879" class="difflineplus">+                                                  this);</span>
<a href="#l15.880"></a><span id="l15.880">             httpchannel.requestMethod = &quot;POST&quot;;</span>
<a href="#l15.881"></a><span id="l15.881">             httpchannel.setRequestHeader(&quot;Originator&quot;, this.calendarUserAddress, false);</span>
<a href="#l15.882"></a><span id="l15.882">             for each (var recipient in aRecipients) {</span>
<a href="#l15.883"></a><span id="l15.883">                 httpchannel.setRequestHeader(&quot;Recipient&quot;, recipient.id, true);</span>
<a href="#l15.884"></a><span id="l15.884">             }</span>
<a href="#l15.885"></a><span id="l15.885"> </span>
<a href="#l15.886"></a><span id="l15.886">             var thisCalendar = this;</span>
<a href="#l15.887"></a><span id="l15.887">             var streamListener = {</span>
<a href="#l15.888"></a><span id="l15.888" class="difflineat">@@ -2181,28 +2170,28 @@ calDavCalendar.prototype = {</span>
<a href="#l15.889"></a><span id="l15.889">                         status = Components.interfaces.calIErrors.DAV_POST_ERROR;</span>
<a href="#l15.890"></a><span id="l15.890">                         LOG(&quot;CalDAV: no response status when sending iTIP.&quot;);</span>
<a href="#l15.891"></a><span id="l15.891">                     }</span>
<a href="#l15.892"></a><span id="l15.892"> </span>
<a href="#l15.893"></a><span id="l15.893">                     if (status != 200) {</span>
<a href="#l15.894"></a><span id="l15.894">                         LOG(&quot;Sending iITIP failed with status &quot; + status);</span>
<a href="#l15.895"></a><span id="l15.895">                     }</span>
<a href="#l15.896"></a><span id="l15.896"> </span>
<a href="#l15.897"></a><span id="l15.897" class="difflineminus">-                    var str = convertByteArray(aResult, aResultLength, &quot;UTF-8&quot;, false);</span>
<a href="#l15.898"></a><span id="l15.898" class="difflineplus">+                    let str = cal.convertByteArray(aResult, aResultLength, &quot;UTF-8&quot;, false);</span>
<a href="#l15.899"></a><span id="l15.899">                     if (str) {</span>
<a href="#l15.900"></a><span id="l15.900">                         if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.901"></a><span id="l15.901">                             LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l15.902"></a><span id="l15.902">                         }</span>
<a href="#l15.903"></a><span id="l15.903">                     } else {</span>
<a href="#l15.904"></a><span id="l15.904">                         LOG(&quot;CalDAV: Failed to parse iTIP response.&quot;);</span>
<a href="#l15.905"></a><span id="l15.905">                     }</span>
<a href="#l15.906"></a><span id="l15.906"> </span>
<a href="#l15.907"></a><span id="l15.907">                     var C = new Namespace(&quot;C&quot;, &quot;urn:ietf:params:xml:ns:caldav&quot;);</span>
<a href="#l15.908"></a><span id="l15.908">                     var D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l15.909"></a><span id="l15.909" class="difflineminus">-                    var responseXML = safeNewXML(str);</span>
<a href="#l15.910"></a><span id="l15.910" class="difflineplus">+                    let responseXML = cal.safeNewXML(str);</span>
<a href="#l15.911"></a><span id="l15.911"> </span>
<a href="#l15.912"></a><span id="l15.912">                     var remainingAttendees = [];</span>
<a href="#l15.913"></a><span id="l15.913">                     for each (let response in responseXML.*::response) {</span>
<a href="#l15.914"></a><span id="l15.914">                         var recip = response..C::recipient..D::href;</span>
<a href="#l15.915"></a><span id="l15.915">                         var status = response..C::[&quot;request-status&quot;];</span>
<a href="#l15.916"></a><span id="l15.916">                         if (status.substr(0, 1) != &quot;2&quot;) {</span>
<a href="#l15.917"></a><span id="l15.917">                             if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.918"></a><span id="l15.918">                                 LOG(&quot;CalDAV: failed delivery to &quot; + recip);</span>
<a href="#l15.919"></a><span id="l15.919" class="difflineat">@@ -2214,34 +2203,33 @@ calDavCalendar.prototype = {</span>
<a href="#l15.920"></a><span id="l15.920">                                 }</span>
<a href="#l15.921"></a><span id="l15.921">                             }</span>
<a href="#l15.922"></a><span id="l15.922">                         }</span>
<a href="#l15.923"></a><span id="l15.923">                     }</span>
<a href="#l15.924"></a><span id="l15.924"> </span>
<a href="#l15.925"></a><span id="l15.925">                     if (remainingAttendees.length) {</span>
<a href="#l15.926"></a><span id="l15.926">                         // try to fall back to email delivery if CalDAV-sched</span>
<a href="#l15.927"></a><span id="l15.927">                         // didn't work</span>
<a href="#l15.928"></a><span id="l15.928" class="difflineminus">-                        var imipTransport = calGetImipTransport(thisCalendar);</span>
<a href="#l15.929"></a><span id="l15.929" class="difflineplus">+                        var imipTransport = cal.getImipTransport(thisCalendar);</span>
<a href="#l15.930"></a><span id="l15.930">                         if (imipTransport) {</span>
<a href="#l15.931"></a><span id="l15.931">                             if (thisCalendar.verboseLogging()) {</span>
<a href="#l15.932"></a><span id="l15.932">                                 LOG(&quot;CalDAV: sending email to &quot; + remainingAttendees.length + &quot; recipients&quot;);</span>
<a href="#l15.933"></a><span id="l15.933">                             }</span>
<a href="#l15.934"></a><span id="l15.934">                             imipTransport.sendItems(remainingAttendees.length, remainingAttendees, aItipItem);</span>
<a href="#l15.935"></a><span id="l15.935">                         } else {</span>
<a href="#l15.936"></a><span id="l15.936">                             LOG(&quot;CalDAV: no fallback to iTIP/iMIP transport.&quot;);</span>
<a href="#l15.937"></a><span id="l15.937">                         }</span>
<a href="#l15.938"></a><span id="l15.938">                     }</span>
<a href="#l15.939"></a><span id="l15.939">                 }</span>
<a href="#l15.940"></a><span id="l15.940">             };</span>
<a href="#l15.941"></a><span id="l15.941"> </span>
<a href="#l15.942"></a><span id="l15.942">             if (this.verboseLogging()) {</span>
<a href="#l15.943"></a><span id="l15.943">                 LOG(&quot;CalDAV: send: &quot; + uploadData);</span>
<a href="#l15.944"></a><span id="l15.944">             }</span>
<a href="#l15.945"></a><span id="l15.945" class="difflineminus">-            var streamLoader = createStreamLoader();</span>
<a href="#l15.946"></a><span id="l15.946" class="difflineminus">-            calSendHttpRequest(streamLoader, httpchannel, streamListener);</span>
<a href="#l15.947"></a><span id="l15.947" class="difflineplus">+            cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l15.948"></a><span id="l15.948">         }</span>
<a href="#l15.949"></a><span id="l15.949">     },</span>
<a href="#l15.950"></a><span id="l15.950"> </span>
<a href="#l15.951"></a><span id="l15.951">     mVerboseLogging: undefined,</span>
<a href="#l15.952"></a><span id="l15.952">     verboseLogging: function caldav_verboseLogging() {</span>
<a href="#l15.953"></a><span id="l15.953">         if (this.mVerboseLogging === undefined) {</span>
<a href="#l15.954"></a><span id="l15.954">             this.mVerboseLogging = getPrefSafe(&quot;calendar.debug.log.verbose&quot;, false);</span>
<a href="#l15.955"></a><span id="l15.955">         }</span>
<a href="#l15.956"></a><span id="l15.956" class="difflineat">@@ -2265,21 +2253,21 @@ calDavCalendar.prototype = {</span>
<a href="#l15.957"></a><span id="l15.957">         let uploadData;</span>
<a href="#l15.958"></a><span id="l15.958">         let uploadContent;</span>
<a href="#l15.959"></a><span id="l15.959">         if (aOldChannel instanceof Components.interfaces.nsIUploadChannel &amp;&amp;</span>
<a href="#l15.960"></a><span id="l15.960">             aOldChannel.uploadStream) {</span>
<a href="#l15.961"></a><span id="l15.961">             uploadData = aOldChannel.uploadStream;</span>
<a href="#l15.962"></a><span id="l15.962">             uploadContent = aOldChannel.getRequestHeader(&quot;Content-Type&quot;);</span>
<a href="#l15.963"></a><span id="l15.963">         }</span>
<a href="#l15.964"></a><span id="l15.964"> </span>
<a href="#l15.965"></a><span id="l15.965" class="difflineminus">-        calPrepHttpChannel(null,</span>
<a href="#l15.966"></a><span id="l15.966" class="difflineminus">-                           uploadData,</span>
<a href="#l15.967"></a><span id="l15.967" class="difflineminus">-                           uploadContent,</span>
<a href="#l15.968"></a><span id="l15.968" class="difflineminus">-                           this,</span>
<a href="#l15.969"></a><span id="l15.969" class="difflineminus">-                           aNewChannel);</span>
<a href="#l15.970"></a><span id="l15.970" class="difflineplus">+        cal.prepHttpChannel(null,</span>
<a href="#l15.971"></a><span id="l15.971" class="difflineplus">+                            uploadData,</span>
<a href="#l15.972"></a><span id="l15.972" class="difflineplus">+                            uploadContent,</span>
<a href="#l15.973"></a><span id="l15.973" class="difflineplus">+                            this,</span>
<a href="#l15.974"></a><span id="l15.974" class="difflineplus">+                            aNewChannel);</span>
<a href="#l15.975"></a><span id="l15.975"> </span>
<a href="#l15.976"></a><span id="l15.976">         // Make sure we can get/set headers on both channels.</span>
<a href="#l15.977"></a><span id="l15.977">         aNewChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l15.978"></a><span id="l15.978">         aOldChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l15.979"></a><span id="l15.979"> </span>
<a href="#l15.980"></a><span id="l15.980"> </span>
<a href="#l15.981"></a><span id="l15.981">         function copyHeader(aHdr) {</span>
<a href="#l15.982"></a><span id="l15.982">             try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendarModule.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendarModule.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -69,19 +69,17 @@ var calDavCalendarModule = {</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">     mUtilsLoaded: false,</span>
<a href="#l16.6"></a><span id="l16.6">     loadUtils: function cDCM_loadUtils() {</span>
<a href="#l16.7"></a><span id="l16.7">         if (this.mUtilsLoaded) {</span>
<a href="#l16.8"></a><span id="l16.8">             return;</span>
<a href="#l16.9"></a><span id="l16.9">         }</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calAuthUtils.js&quot;, &quot;calProviderBase.js&quot;,</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-                         &quot;calProviderUtils.js&quot;, &quot;calDavCalendar.js&quot; ],</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-                        this.__parent__);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calDavCalendar.js&quot; ], this.__parent__);</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17">         this.mUtilsLoaded = true;</span>
<a href="#l16.18"></a><span id="l16.18">     },</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">     registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l16.21"></a><span id="l16.21">         compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l16.22"></a><span id="l16.22">         compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l16.23"></a><span id="l16.23">                                         &quot;Calendar CalDAV back-end&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -44,17 +44,17 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * @class</span>
<a href="#l17.5"></a><span id="l17.5">  * @constructor</span>
<a href="#l17.6"></a><span id="l17.6">  */</span>
<a href="#l17.7"></a><span id="l17.7"> function calGoogleCalendar() {</span>
<a href="#l17.8"></a><span id="l17.8">     this.initProviderBase();</span>
<a href="#l17.9"></a><span id="l17.9"> }</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> calGoogleCalendar.prototype = {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    __proto__: calProviderBase.prototype,</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15">     QueryInterface: function cGS_QueryInterface(aIID) {</span>
<a href="#l17.16"></a><span id="l17.16">         return doQueryInterface(this,</span>
<a href="#l17.17"></a><span id="l17.17">                                 calGoogleCalendar.prototype,</span>
<a href="#l17.18"></a><span id="l17.18">                                 aIID,</span>
<a href="#l17.19"></a><span id="l17.19">                                 null,</span>
<a href="#l17.20"></a><span id="l17.20">                                 g_classInfo[&quot;calGoogleCalendar&quot;]);</span>
<a href="#l17.21"></a><span id="l17.21">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendarModule.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendarModule.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -142,19 +142,19 @@ var calGoogleCalendarModule = {</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">     mUtilsLoaded: false,</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7">     loadUtils: function cGCM_loadUtils() {</span>
<a href="#l18.8"></a><span id="l18.8">         if (this.mUtilsLoaded)</span>
<a href="#l18.9"></a><span id="l18.9">             return;</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calAuthUtils.js&quot;,</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-                         &quot;calProviderBase.js&quot;, &quot;calProviderUtils.js&quot;],</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-                        this.__parent__);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+        cal.loadScripts([&quot;calUtils.js&quot;], this.__parent__);</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">         // Now load gdata extension scripts. Note that unintuitively,</span>
<a href="#l18.20"></a><span id="l18.20">         // __LOCATION__.parent == . We expect to find the subscripts in ./../js</span>
<a href="#l18.21"></a><span id="l18.21">         let thisDir = __LOCATION__.parent.parent.clone();</span>
<a href="#l18.22"></a><span id="l18.22">         thisDir.append(&quot;js&quot;);</span>
<a href="#l18.23"></a><span id="l18.23">         cal.loadScripts([&quot;calGoogleCalendar.js&quot;, &quot;calGoogleSession.js&quot;,</span>
<a href="#l18.24"></a><span id="l18.24">                          &quot;calGoogleRequest.js&quot;, &quot;calGoogleUtils.js&quot;],</span>
<a href="#l18.25"></a><span id="l18.25">                         this.__parent__,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -213,24 +213,24 @@ calGoogleRequest.prototype = {</span>
<a href="#l19.4"></a><span id="l19.4">             var uri = ioService.newURI(uristring, null, null);</span>
<a href="#l19.5"></a><span id="l19.5">             var channel = ioService.newChannelFromURI(uri);</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7">             this.prepareChannel(channel);</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9">             channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l19.10"></a><span id="l19.10">             channel.redirectionLimit = 3;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-            this.mLoader = createStreamLoader();</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+            this.mLoader = cal.createStreamLoader();</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15">             LOG(&quot;calGoogleRequest: Requesting &quot; + this.method + &quot; &quot; +</span>
<a href="#l19.16"></a><span id="l19.16">                 channel.URI.spec);</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18">             channel.notificationCallbacks = this;</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-            calSendHttpRequest(this.mLoader, channel, this);</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+            cal.sendHttpRequest(this.mLoader, channel, this);</span>
<a href="#l19.22"></a><span id="l19.22">         } catch (e) {</span>
<a href="#l19.23"></a><span id="l19.23">             // Let the response function handle the error that happens here</span>
<a href="#l19.24"></a><span id="l19.24">             this.fail(e.result, e.message);</span>
<a href="#l19.25"></a><span id="l19.25">         }</span>
<a href="#l19.26"></a><span id="l19.26">     },</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28">     /**</span>
<a href="#l19.29"></a><span id="l19.29">      * fail</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineat">@@ -309,19 +309,19 @@ calGoogleRequest.prototype = {</span>
<a href="#l19.31"></a><span id="l19.31">                                       &quot;GoogleLogin auth=&quot;</span>
<a href="#l19.32"></a><span id="l19.32">                                       +  this.mSession.authToken,</span>
<a href="#l19.33"></a><span id="l19.33">                                       false);</span>
<a href="#l19.34"></a><span id="l19.34">         }</span>
<a href="#l19.35"></a><span id="l19.35">     },</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37">     /**</span>
<a href="#l19.38"></a><span id="l19.38">      * @see nsIInterfaceRequestor</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-     * @see calProviderUtils.js</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+     * @see calProviderUtils.jsm</span>
<a href="#l19.41"></a><span id="l19.41">      */</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-    getInterface: calInterfaceRequestor_getInterface,</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+    getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">     /**</span>
<a href="#l19.46"></a><span id="l19.46">      * @see nsIChannelEventSink</span>
<a href="#l19.47"></a><span id="l19.47">      */</span>
<a href="#l19.48"></a><span id="l19.48">     onChannelRedirect: function cGR_onChannelRedirect(aOldChannel,</span>
<a href="#l19.49"></a><span id="l19.49">                                                       aNewChannel,</span>
<a href="#l19.50"></a><span id="l19.50">                                                       aFlags) {</span>
<a href="#l19.51"></a><span id="l19.51">         // all we need to do to the new channel is the basic preparation</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineat">@@ -339,17 +339,17 @@ calGoogleRequest.prototype = {</span>
<a href="#l19.53"></a><span id="l19.53">         if (!aResult || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l19.54"></a><span id="l19.54">             this.fail(aStatus, aResult);</span>
<a href="#l19.55"></a><span id="l19.55">             return;</span>
<a href="#l19.56"></a><span id="l19.56">         }</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58">         var httpChannel = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l19.59"></a><span id="l19.59"> </span>
<a href="#l19.60"></a><span id="l19.60">         // Convert the stream, falling back to utf-8 in case its not given.</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-        var result = convertByteArray(aResult, aResultLength, httpChannel.contentCharset);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+        let result = cal.convertByteArray(aResult, aResultLength, httpChannel.contentCharset);</span>
<a href="#l19.63"></a><span id="l19.63">         if (result === null) {</span>
<a href="#l19.64"></a><span id="l19.64">             this.fail(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l19.65"></a><span id="l19.65">                       &quot;Could not convert bytestream to Unicode: &quot; + e);</span>
<a href="#l19.66"></a><span id="l19.66">             return;</span>
<a href="#l19.67"></a><span id="l19.67">         }</span>
<a href="#l19.68"></a><span id="l19.68"> </span>
<a href="#l19.69"></a><span id="l19.69">         // Calculate Google Clock Skew</span>
<a href="#l19.70"></a><span id="l19.70">         var serverDate = new Date(httpChannel.getResponseHeader(&quot;Date&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -585,18 +585,18 @@ calGoogleSession.prototype = {</span>
<a href="#l20.4"></a><span id="l20.4">         // This line is needed, otherwise the for each () block will never</span>
<a href="#l20.5"></a><span id="l20.5">         // be entered. It may seem strange, but if you don't believe me, try</span>
<a href="#l20.6"></a><span id="l20.6">         // it!</span>
<a href="#l20.7"></a><span id="l20.7">         xml.link.(@rel);</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9">         var intervals = [];</span>
<a href="#l20.10"></a><span id="l20.10">         const fbtypes = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l20.11"></a><span id="l20.11">         for each (var entry in xml.entry) {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-            var start =  fromRFC3339(entry.gd::when.@startTime.toString(), timezone);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-            var end = fromRFC3339(entry.gd::when.@endTime.toString(), timezone);</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-            var interval = new calFreeBusyInterval(aCalId, fbtypes.BUSY, start, end);</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+            let start =  fromRFC3339(entry.gd::when.@startTime.toString(), timezone);</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+            let end = fromRFC3339(entry.gd::when.@endTime.toString(), timezone);</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+            let interval = new cal.FreeBusyInterval(aCalId, fbtypes.BUSY, start, end);</span>
<a href="#l20.18"></a><span id="l20.18">             LOGinterval(interval);</span>
<a href="#l20.19"></a><span id="l20.19">             intervals.push(interval);</span>
<a href="#l20.20"></a><span id="l20.20">         }</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22">         aOperation.operationListener.onResult(aOperation, intervals);</span>
<a href="#l20.23"></a><span id="l20.23">     }</span>
<a href="#l20.24"></a><span id="l20.24"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -118,21 +118,21 @@ function getFormattedString(aBundleName,</span>
<a href="#l21.4"></a><span id="l21.4">  * @param   out aPassword       The password that belongs to the calendar.</span>
<a href="#l21.5"></a><span id="l21.5">  * @param   out aSavePassword   Should the password be saved?</span>
<a href="#l21.6"></a><span id="l21.6">  * @return  Could a password be retrieved?</span>
<a href="#l21.7"></a><span id="l21.7">  */</span>
<a href="#l21.8"></a><span id="l21.8"> function getCalendarCredentials(aCalendarName,</span>
<a href="#l21.9"></a><span id="l21.9">                                 aUsername,</span>
<a href="#l21.10"></a><span id="l21.10">                                 aPassword,</span>
<a href="#l21.11"></a><span id="l21.11">                                 aSavePassword) {</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    return calGetCredentials(getFormattedString(&quot;gdata&quot;, &quot;loginDialogTitle&quot;),</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-                             aCalendarName,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-                             aUsername,</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-                             aPassword,</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-                             aSavePassword);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+    return cal.auth.getCredentials(getFormattedString(&quot;gdata&quot;, &quot;loginDialogTitle&quot;),</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+                                   aCalendarName,</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+                                   aUsername,</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+                                   aPassword,</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+                                   aSavePassword);</span>
<a href="#l21.22"></a><span id="l21.22"> }</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24"> /**</span>
<a href="#l21.25"></a><span id="l21.25">  * Gets the date and time that Google's http server last sent us. Note the</span>
<a href="#l21.26"></a><span id="l21.26">  * passed argument is modified. This might not be the exact server time (i.e it</span>
<a href="#l21.27"></a><span id="l21.27">  * may be off by network latency), but it does give a good guess when syncing.</span>
<a href="#l21.28"></a><span id="l21.28">  *</span>
<a href="#l21.29"></a><span id="l21.29">  * @param aDate     The date to modify</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineat">@@ -319,40 +319,40 @@ function toRFC3339(aDateTime) {</span>
<a href="#l21.31"></a><span id="l21.31"> /**</span>
<a href="#l21.32"></a><span id="l21.32">  * passwordManagerSave</span>
<a href="#l21.33"></a><span id="l21.33">  * Helper to insert an entry to the password manager.</span>
<a href="#l21.34"></a><span id="l21.34">  *</span>
<a href="#l21.35"></a><span id="l21.35">  * @param aUserName     The username to search</span>
<a href="#l21.36"></a><span id="l21.36">  * @param aPassword     The corresponding password</span>
<a href="#l21.37"></a><span id="l21.37">  */</span>
<a href="#l21.38"></a><span id="l21.38"> function passwordManagerSave(aUsername, aPassword) {</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-    calPasswordManagerSave(aUsername, aPassword, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+    cal.auth.passwordManagerSave(aUsername, aPassword, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l21.41"></a><span id="l21.41"> }</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43"> /**</span>
<a href="#l21.44"></a><span id="l21.44">  * passwordManagerGet</span>
<a href="#l21.45"></a><span id="l21.45">  * Helper to retrieve an entry from the password manager</span>
<a href="#l21.46"></a><span id="l21.46">  *</span>
<a href="#l21.47"></a><span id="l21.47">  * @param in  aUsername     The username to search</span>
<a href="#l21.48"></a><span id="l21.48">  * @param out aPassword     The corresponding password</span>
<a href="#l21.49"></a><span id="l21.49">  * @return                  Does an entry exist in the password manager</span>
<a href="#l21.50"></a><span id="l21.50">  */</span>
<a href="#l21.51"></a><span id="l21.51"> function passwordManagerGet(aUsername, aPassword) {</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-    return calPasswordManagerGet(aUsername, aPassword, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+    return cal.auth.passwordManagerGet(aUsername, aPassword, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l21.54"></a><span id="l21.54"> }</span>
<a href="#l21.55"></a><span id="l21.55"> </span>
<a href="#l21.56"></a><span id="l21.56"> /**</span>
<a href="#l21.57"></a><span id="l21.57">  * passwordManagerRemove</span>
<a href="#l21.58"></a><span id="l21.58">  * Helper to remove an entry from the password manager</span>
<a href="#l21.59"></a><span id="l21.59">  *</span>
<a href="#l21.60"></a><span id="l21.60">  * @param aUsername     The username to remove.</span>
<a href="#l21.61"></a><span id="l21.61">  * @return              Could the user be removed?</span>
<a href="#l21.62"></a><span id="l21.62">  */</span>
<a href="#l21.63"></a><span id="l21.63"> function passwordManagerRemove(aUsername) {</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-    return calPasswordManagerRemove(aUsername, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+    return cal.auth.passwordManagerRemove(aUsername, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l21.66"></a><span id="l21.66"> }</span>
<a href="#l21.67"></a><span id="l21.67"> </span>
<a href="#l21.68"></a><span id="l21.68"> /**</span>
<a href="#l21.69"></a><span id="l21.69">  * ItemToXMLEntry</span>
<a href="#l21.70"></a><span id="l21.70">  * Converts a calIEvent to a string of xml data.</span>
<a href="#l21.71"></a><span id="l21.71">  *</span>
<a href="#l21.72"></a><span id="l21.72">  * @param aItem         The item to convert</span>
<a href="#l21.73"></a><span id="l21.73">  * @param aAuthorEmail  The email of the author of the event</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -34,16 +34,18 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l22.5"></a><span id="l22.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l22.6"></a><span id="l22.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l22.7"></a><span id="l22.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l22.8"></a><span id="l22.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l22.9"></a><span id="l22.9">  *</span>
<a href="#l22.10"></a><span id="l22.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+</span>
<a href="#l22.14"></a><span id="l22.14"> //</span>
<a href="#l22.15"></a><span id="l22.15"> // calICSCalendar.js</span>
<a href="#l22.16"></a><span id="l22.16"> //</span>
<a href="#l22.17"></a><span id="l22.17"> // This is a non-sync ics file. It reads the file pointer to by uri when set,</span>
<a href="#l22.18"></a><span id="l22.18"> // then writes it on updates. External changes to the file will be</span>
<a href="#l22.19"></a><span id="l22.19"> // ignored and overwritten.</span>
<a href="#l22.20"></a><span id="l22.20"> //</span>
<a href="#l22.21"></a><span id="l22.21"> // XXX Should do locks, so that external changes are not overwritten.</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -59,17 +61,17 @@ function calICSCalendar() {</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24">     this.unmappedComponents = [];</span>
<a href="#l22.25"></a><span id="l22.25">     this.unmappedProperties = [];</span>
<a href="#l22.26"></a><span id="l22.26">     this.queue = new Array();</span>
<a href="#l22.27"></a><span id="l22.27">     this.mModificationActions = [];</span>
<a href="#l22.28"></a><span id="l22.28"> }</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30"> calICSCalendar.prototype = {</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-    __proto__: calProviderBase.prototype,</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l22.33"></a><span id="l22.33"> </span>
<a href="#l22.34"></a><span id="l22.34">     mObserver: null,</span>
<a href="#l22.35"></a><span id="l22.35">     locked: false,</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37">     QueryInterface: function (aIID) {</span>
<a href="#l22.38"></a><span id="l22.38">         return doQueryInterface(this, calICSCalendar.prototype, aIID,</span>
<a href="#l22.39"></a><span id="l22.39">                                 [Components.interfaces.calICalendarProvider,</span>
<a href="#l22.40"></a><span id="l22.40">                                  Components.interfaces.nsIStreamListener,</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineat">@@ -540,19 +542,19 @@ calICSCalendar.prototype = {</span>
<a href="#l22.42"></a><span id="l22.42">     },</span>
<a href="#l22.43"></a><span id="l22.43">     endBatch: function ()</span>
<a href="#l22.44"></a><span id="l22.44">     {</span>
<a href="#l22.45"></a><span id="l22.45">         this.mObserver.onEndBatch();</span>
<a href="#l22.46"></a><span id="l22.46">     },</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48">     /**</span>
<a href="#l22.49"></a><span id="l22.49">      * @see nsIInterfaceRequestor</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-     * @see calProviderUtils.js</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+     * @see calProviderUtils.jsm</span>
<a href="#l22.52"></a><span id="l22.52">      */</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-    getInterface: calInterfaceRequestor_getInterface,</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+    getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">     /**</span>
<a href="#l22.57"></a><span id="l22.57">      * Make a backup of the (remote) calendar</span>
<a href="#l22.58"></a><span id="l22.58">      *</span>
<a href="#l22.59"></a><span id="l22.59">      * This will download the remote file into the profile dir.</span>
<a href="#l22.60"></a><span id="l22.60">      * It should be called before every upload, so every change can be</span>
<a href="#l22.61"></a><span id="l22.61">      * restored. By default, it will keep 3 backups. It also keeps one</span>
<a href="#l22.62"></a><span id="l22.62">      * file each day, for 3 days. That way, even if the user doesn't notice</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineat">@@ -932,26 +934,26 @@ httpHooks.prototype = {</span>
<a href="#l22.64"></a><span id="l22.64">             var D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l22.65"></a><span id="l22.65">             default xml namespace = D;</span>
<a href="#l22.66"></a><span id="l22.66">             var queryXml = &lt;D:propfind xmlns:D=&quot;DAV:&quot;&gt;</span>
<a href="#l22.67"></a><span id="l22.67">                     &lt;D:prop&gt;</span>
<a href="#l22.68"></a><span id="l22.68">                       &lt;D:getetag/&gt;</span>
<a href="#l22.69"></a><span id="l22.69">                     &lt;/D:prop&gt;</span>
<a href="#l22.70"></a><span id="l22.70">                   &lt;/D:propfind&gt;;</span>
<a href="#l22.71"></a><span id="l22.71"> </span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-            var etagChannel = calPrepHttpChannel(aChannel.URI, queryXml,</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-                                                 &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-                                                 this);</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+            let etagChannel = cal.prepHttpChannel(aChannel.URI, queryXml,</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+                                                  &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+                                                  this);</span>
<a href="#l22.78"></a><span id="l22.78">             etagChannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l22.79"></a><span id="l22.79">             etagChannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l22.80"></a><span id="l22.80">             var streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l22.81"></a><span id="l22.81">                                          .createInstance(Components.interfaces</span>
<a href="#l22.82"></a><span id="l22.82">                                          .nsIStreamLoader);</span>
<a href="#l22.83"></a><span id="l22.83"> </span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-            calSendHttpRequest(streamLoader, etagChannel, etagListener);</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+            cal.sendHttpRequest(streamLoader, etagChannel, etagListener);</span>
<a href="#l22.86"></a><span id="l22.86">         }</span>
<a href="#l22.87"></a><span id="l22.87">         return true;</span>
<a href="#l22.88"></a><span id="l22.88">     },</span>
<a href="#l22.89"></a><span id="l22.89"> </span>
<a href="#l22.90"></a><span id="l22.90">     // nsIProgressEventSink</span>
<a href="#l22.91"></a><span id="l22.91">     onProgress: function onProgress(aRequest, aContext, aProgress, aProgressMax) {},</span>
<a href="#l22.92"></a><span id="l22.92">     onStatus: function onStatus(aRequest, aContext, aStatus, aStatusArg) {},</span>
<a href="#l22.93"></a><span id="l22.93"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendarModule.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendarModule.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -66,19 +66,17 @@ var calICSCalendarModule = {</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5">     mUtilsLoaded: false,</span>
<a href="#l23.6"></a><span id="l23.6">     loadUtils: function cICM_loadUtils() {</span>
<a href="#l23.7"></a><span id="l23.7">         if (this.mUtilsLoaded) {</span>
<a href="#l23.8"></a><span id="l23.8">             return;</span>
<a href="#l23.9"></a><span id="l23.9">         }</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calAuthUtils.js&quot;, &quot;calProviderBase.js&quot;,</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-                         &quot;calProviderUtils.js&quot;, &quot;calICSCalendar.js&quot;],</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-                        this.__parent__);</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calICSCalendar.js&quot;], this.__parent__);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17">         this.mUtilsLoaded = true;</span>
<a href="#l23.18"></a><span id="l23.18">     },</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20">     registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l23.21"></a><span id="l23.21">         compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l23.22"></a><span id="l23.22">         compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l23.23"></a><span id="l23.23">                                         &quot;Calendar ICS provider&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -32,30 +32,32 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l24.5"></a><span id="l24.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l24.6"></a><span id="l24.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l24.7"></a><span id="l24.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l24.8"></a><span id="l24.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l24.9"></a><span id="l24.9">  *</span>
<a href="#l24.10"></a><span id="l24.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+</span>
<a href="#l24.14"></a><span id="l24.14"> //</span>
<a href="#l24.15"></a><span id="l24.15"> // calMemoryCalendar.js</span>
<a href="#l24.16"></a><span id="l24.16"> //</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> const calCalendarManagerContractID = &quot;@mozilla.org/calendar/manager;1&quot;;</span>
<a href="#l24.19"></a><span id="l24.19"> const calICalendarManager = Components.interfaces.calICalendarManager;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21"> function calMemoryCalendar() {</span>
<a href="#l24.22"></a><span id="l24.22">     this.initProviderBase();</span>
<a href="#l24.23"></a><span id="l24.23">     this.initMemoryCalendar();</span>
<a href="#l24.24"></a><span id="l24.24"> }</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26"> calMemoryCalendar.prototype = {</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-    __proto__: calProviderBase.prototype,</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30">     //</span>
<a href="#l24.31"></a><span id="l24.31">     // nsISupports interface</span>
<a href="#l24.32"></a><span id="l24.32">     // </span>
<a href="#l24.33"></a><span id="l24.33">     QueryInterface: function (aIID) {</span>
<a href="#l24.34"></a><span id="l24.34">         return doQueryInterface(this, calMemoryCalendar.prototype, aIID,</span>
<a href="#l24.35"></a><span id="l24.35">                                 [Components.interfaces.calISyncCalendar,</span>
<a href="#l24.36"></a><span id="l24.36">                                  Components.interfaces.calICalendarProvider]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendarModule.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendarModule.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -63,18 +63,17 @@ var calMemoryCalendarModule = {</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5">     mUtilsLoaded: false,</span>
<a href="#l25.6"></a><span id="l25.6">     loadUtils: function cMCM_loadUtils() {</span>
<a href="#l25.7"></a><span id="l25.7">         if (this.mUtilsLoaded) {</span>
<a href="#l25.8"></a><span id="l25.8">             return;</span>
<a href="#l25.9"></a><span id="l25.9">         }</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calProviderBase.js&quot;, &quot;calProviderUtils.js&quot;,</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-                         &quot;calMemoryCalendar.js&quot;],</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calMemoryCalendar.js&quot;],</span>
<a href="#l25.15"></a><span id="l25.15">                         this.__parent__);</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17">         this.mUtilsLoaded = true;</span>
<a href="#l25.18"></a><span id="l25.18">     },</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20">     registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l25.21"></a><span id="l25.21">         compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l25.22"></a><span id="l25.22">         compMgr.registerFactoryLocation(this.mCID,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -38,16 +38,18 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l26.5"></a><span id="l26.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l26.6"></a><span id="l26.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l26.7"></a><span id="l26.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l26.8"></a><span id="l26.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l26.9"></a><span id="l26.9">  *</span>
<a href="#l26.10"></a><span id="l26.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+</span>
<a href="#l26.14"></a><span id="l26.14"> const kStorageServiceContractID = &quot;@mozilla.org/storage/service;1&quot;;</span>
<a href="#l26.15"></a><span id="l26.15"> const kStorageServiceIID = Components.interfaces.mozIStorageService;</span>
<a href="#l26.16"></a><span id="l26.16"> </span>
<a href="#l26.17"></a><span id="l26.17"> const kCalICalendar = Components.interfaces.calICalendar;</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> const kCalAttendeeContractID = &quot;@mozilla.org/calendar/attendee;1&quot;;</span>
<a href="#l26.20"></a><span id="l26.20"> const kCalIAttendee = Components.interfaces.calIAttendee;</span>
<a href="#l26.21"></a><span id="l26.21"> var CalAttendee;</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -255,17 +257,17 @@ function newDateTime(aNativeTime, aTimez</span>
<a href="#l26.23"></a><span id="l26.23"> function calStorageCalendar() {</span>
<a href="#l26.24"></a><span id="l26.24">     this.initProviderBase();</span>
<a href="#l26.25"></a><span id="l26.25">     this.mItemCache = {};</span>
<a href="#l26.26"></a><span id="l26.26">     this.mRecEventCache = {};</span>
<a href="#l26.27"></a><span id="l26.27">     this.mRecTodoCache = {};</span>
<a href="#l26.28"></a><span id="l26.28"> }</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30"> calStorageCalendar.prototype = {</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-    __proto__: calProviderBase.prototype,</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l26.33"></a><span id="l26.33">     //</span>
<a href="#l26.34"></a><span id="l26.34">     // private members</span>
<a href="#l26.35"></a><span id="l26.35">     //</span>
<a href="#l26.36"></a><span id="l26.36">     mDB: null,</span>
<a href="#l26.37"></a><span id="l26.37">     mCalId: 0,</span>
<a href="#l26.38"></a><span id="l26.38">     mItemCache: null,</span>
<a href="#l26.39"></a><span id="l26.39">     mRecItemCacheInited: false,</span>
<a href="#l26.40"></a><span id="l26.40">     mRecEventCache: null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendarModule.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendarModule.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -66,18 +66,17 @@ var calStorageCalendarModule = {</span>
<a href="#l27.4"></a><span id="l27.4">     mContractID: &quot;@mozilla.org/calendar/calendar;1?type=storage&quot;,</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6">     mUtilsLoaded: false,</span>
<a href="#l27.7"></a><span id="l27.7">     loadUtils: function storageLoadUtils() {</span>
<a href="#l27.8"></a><span id="l27.8">         if (this.mUtilsLoaded)</span>
<a href="#l27.9"></a><span id="l27.9">             return;</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calProviderBase.js&quot;, &quot;calProviderUtils.js&quot;,</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-                         &quot;calStorageCalendar.js&quot;],</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calStorageCalendar.js&quot;],</span>
<a href="#l27.15"></a><span id="l27.15">                         this.__parent__);</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17">         initCalStorageCalendarComponent();</span>
<a href="#l27.18"></a><span id="l27.18">         this.mUtilsLoaded = true;</span>
<a href="#l27.19"></a><span id="l27.19">     },</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21">     registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l27.22"></a><span id="l27.22">         compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -37,17 +37,17 @@</span>
<a href="#l28.4"></a><span id="l28.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> function calWcapCalendar(/*optional*/session, /*optional*/calProps) {</span>
<a href="#l28.7"></a><span id="l28.7">     this.initProviderBase();</span>
<a href="#l28.8"></a><span id="l28.8">     this.m_session = session;</span>
<a href="#l28.9"></a><span id="l28.9">     this.m_calProps = calProps;</span>
<a href="#l28.10"></a><span id="l28.10"> }</span>
<a href="#l28.11"></a><span id="l28.11"> calWcapCalendar.prototype = {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    __proto__: calProviderBase.prototype,</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l28.14"></a><span id="l28.14"> </span>
<a href="#l28.15"></a><span id="l28.15">     // nsISupports:</span>
<a href="#l28.16"></a><span id="l28.16">     QueryInterface: function calWcapCalendar_QueryInterface(iid) {</span>
<a href="#l28.17"></a><span id="l28.17">         return doQueryInterface(this, calWcapCalendar.prototype, iid, null, g_classInfo.wcapCalendar);</span>
<a href="#l28.18"></a><span id="l28.18">     },</span>
<a href="#l28.19"></a><span id="l28.19"> </span>
<a href="#l28.20"></a><span id="l28.20">     toString: function calWcapCalendar_toString() {</span>
<a href="#l28.21"></a><span id="l28.21">         var str = this.session.toString();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -203,18 +203,19 @@ var calWcapCalendarModule = { // nsIModu</span>
<a href="#l29.4"></a><span id="l29.4">         compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l29.5"></a><span id="l29.5">         compMgr.unregisterFactoryLocation(g_classInfo.wcapCalendar.classID, fileSpec);</span>
<a href="#l29.6"></a><span id="l29.6">     },</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8">     m_scriptsLoaded: false,</span>
<a href="#l29.9"></a><span id="l29.9">     getClassObject: function calWcapCalendarModule_getClassObject(compMgr, cid, iid) {</span>
<a href="#l29.10"></a><span id="l29.10">         if (!this.m_scriptsLoaded) {</span>
<a href="#l29.11"></a><span id="l29.11">             Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-            cal.loadScripts([&quot;calUtils.js&quot;, &quot;calAuthUtils.js&quot;,</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-                             &quot;calProviderUtils.js&quot;, &quot;calProviderBase.js&quot;, &quot;calProviderUtils.js&quot;,</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+            Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+            Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+            cal.loadScripts([&quot;calUtils.js&quot;,</span>
<a href="#l29.17"></a><span id="l29.17">                              &quot;calWcapUtils.js&quot;, &quot;calWcapErrors.js&quot;,</span>
<a href="#l29.18"></a><span id="l29.18">                              &quot;calWcapRequest.js&quot;, &quot;calWcapSession.js&quot;,</span>
<a href="#l29.19"></a><span id="l29.19">                              &quot;calWcapCalendar.js&quot;, &quot;calWcapCalendarItems.js&quot;],</span>
<a href="#l29.20"></a><span id="l29.20">                             this.__parent__);</span>
<a href="#l29.21"></a><span id="l29.21">             initWcapProvider();</span>
<a href="#l29.22"></a><span id="l29.22">             this.m_scriptsLoaded = true;</span>
<a href="#l29.23"></a><span id="l29.23">         }</span>
<a href="#l29.24"></a><span id="l29.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -231,19 +231,19 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l30.4"></a><span id="l30.4">     m_bLogging: false,</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6">     QueryInterface: function calWcapNetworkRequest_QueryInterface(iid) {</span>
<a href="#l30.7"></a><span id="l30.7">         return doQueryInterface(this, calWcapNetworkRequest.prototype, iid, null, g_classInfo.wcapNetworkRequest);</span>
<a href="#l30.8"></a><span id="l30.8">     },</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10">     /**</span>
<a href="#l30.11"></a><span id="l30.11">      * @see nsIInterfaceRequestor</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-     * @see calProviderUtils.js</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+     * @see calProviderUtils.jsm</span>
<a href="#l30.14"></a><span id="l30.14">      */</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-    getInterface: calInterfaceRequestor_getInterface,</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+    getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18">     /**</span>
<a href="#l30.19"></a><span id="l30.19">      * prepareChannel</span>
<a href="#l30.20"></a><span id="l30.20">      * Prepares the passed channel to match this objects properties</span>
<a href="#l30.21"></a><span id="l30.21">      *</span>
<a href="#l30.22"></a><span id="l30.22">      * @param aChannel    The Channel to be prepared</span>
<a href="#l30.23"></a><span id="l30.23">      */</span>
<a href="#l30.24"></a><span id="l30.24">     prepareChannel: function calWcapNetworkRequest_prepareChannel(aChannel) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -268,43 +268,43 @@ calWcapSession.prototype = {</span>
<a href="#l31.4"></a><span id="l31.4">                 }</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6">                 var outUser = { value: this_.credentials.userId };</span>
<a href="#l31.7"></a><span id="l31.7">                 var outPW = { value: this_.credentials.pw };</span>
<a href="#l31.8"></a><span id="l31.8">                 var outSavePW = { value: false };</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10">                 if (outUser.value &amp;&amp; !outPW.value) { // lookup pw manager</span>
<a href="#l31.11"></a><span id="l31.11">                     log(&quot;looking in pw db for: &quot; + this_.uri.spec, this_);</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-                    calPasswordManagerGet(outUser.value, outPW, this_.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+                    cal.auth.passwordManagerGet(outUser.value, outPW, this_.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l31.14"></a><span id="l31.14">                 }</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16">                 function promptAndLoginLoop_resp(err, sessionId) {</span>
<a href="#l31.17"></a><span id="l31.17">                     if (checkErrorCode(err, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l31.18"></a><span id="l31.18">                         log(&quot;prompting for [user/]pw...&quot;, this_);</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-                        if (calGetCredentials(calGetString(&quot;wcap&quot;, &quot;loginDialog.label&quot;),</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-                                              this_.sessionUri.hostPort,</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-                                              outUser,</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-                                              outPW,</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineminus">-                                              outSavePW,</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineminus">-                                              this_.credentials.userId != null)) {</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+                        if (cal.auth.getCredentials(calGetString(&quot;wcap&quot;, &quot;loginDialog.label&quot;),</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+                                                    this_.sessionUri.hostPort,</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+                                                    outUser,</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+                                                    outPW,</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+                                                    outSavePW,</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+                                                    this_.credentials.userId != null)) {</span>
<a href="#l31.31"></a><span id="l31.31">                             this_.login(request, promptAndLoginLoop_resp,</span>
<a href="#l31.32"></a><span id="l31.32">                                         outUser.value, outPW.value);</span>
<a href="#l31.33"></a><span id="l31.33">                         } else {</span>
<a href="#l31.34"></a><span id="l31.34">                             log(&quot;login prompt cancelled.&quot;, this_);</span>
<a href="#l31.35"></a><span id="l31.35">                             this_.defaultCalendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l31.36"></a><span id="l31.36">                             this_.defaultCalendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l31.37"></a><span id="l31.37">                             respFunc(new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l31.38"></a><span id="l31.38">                                                               calIWcapErrors.WCAP_LOGIN_FAILED));</span>
<a href="#l31.39"></a><span id="l31.39">                         }</span>
<a href="#l31.40"></a><span id="l31.40">                     } else if (err) {</span>
<a href="#l31.41"></a><span id="l31.41">                         respFunc(err);</span>
<a href="#l31.42"></a><span id="l31.42">                     } else {</span>
<a href="#l31.43"></a><span id="l31.43">                         if (outSavePW.value) {</span>
<a href="#l31.44"></a><span id="l31.44">                             // so try to remove old pw from db first:</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineminus">-                            calPasswordManagerSave(outUser.value, outPW.value, this_.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+                            cal.auth.passwordManagerSave(outUser.value, outPW.value, this_.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l31.47"></a><span id="l31.47">                         }</span>
<a href="#l31.48"></a><span id="l31.48">                         this_.credentials.userId = outUser.value;</span>
<a href="#l31.49"></a><span id="l31.49">                         this_.credentials.pw = outPW.value;</span>
<a href="#l31.50"></a><span id="l31.50">                         this_.setupSession(sessionId,</span>
<a href="#l31.51"></a><span id="l31.51">                                            request,</span>
<a href="#l31.52"></a><span id="l31.52">                                            function setupSession_resp(err) {</span>
<a href="#l31.53"></a><span id="l31.53">                                                respFunc(err, sessionId);</span>
<a href="#l31.54"></a><span id="l31.54">                                            });</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineat">@@ -1008,22 +1008,22 @@ calWcapSession.prototype = {</span>
<a href="#l31.56"></a><span id="l31.56"> </span>
<a href="#l31.57"></a><span id="l31.57">                         for (var i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l31.58"></a><span id="l31.58">                             var node = nodeList.item(i);</span>
<a href="#l31.59"></a><span id="l31.59">                             var fbType = fbTypeMap[node.attributes.getNamedItem(&quot;FBTYPE&quot;).nodeValue];</span>
<a href="#l31.60"></a><span id="l31.60">                             if (!fbType || (fbType &amp; busyTypes)) {</span>
<a href="#l31.61"></a><span id="l31.61">                                 if (!fbType) {</span>
<a href="#l31.62"></a><span id="l31.62">                                     fbType = calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l31.63"></a><span id="l31.63">                                 }</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineminus">-                                var str = node.textContent;</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-                                var slash = str.indexOf('/');</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-                                var start =  getDatetimeFromIcalString(str.substr(0, slash));</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-                                var end =  getDatetimeFromIcalString(str.substr(slash + 1));</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+                                let str = node.textContent;</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+                                let slash = str.indexOf('/');</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+                                let start = getDatetimeFromIcalString(str.substr(0, slash));</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+                                let end = getDatetimeFromIcalString(str.substr(slash + 1));</span>
<a href="#l31.72"></a><span id="l31.72"> </span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-                                ret.push(new calFreeBusyInterval(calId, fbType, start, end));</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+                                ret.push(new cal.FreeBusyInterval(calId, fbType, start, end));</span>
<a href="#l31.75"></a><span id="l31.75">                             }</span>
<a href="#l31.76"></a><span id="l31.76">                         }</span>
<a href="#l31.77"></a><span id="l31.77">                         request.execRespFunc(null, ret);</span>
<a href="#l31.78"></a><span id="l31.78">                     }</span>
<a href="#l31.79"></a><span id="l31.79">                 },</span>
<a href="#l31.80"></a><span id="l31.80">                 stringToXml_, &quot;get_freebusy&quot;, params);</span>
<a href="#l31.81"></a><span id="l31.81"> </span>
<a href="#l31.82"></a><span id="l31.82">         } catch (exc) {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

