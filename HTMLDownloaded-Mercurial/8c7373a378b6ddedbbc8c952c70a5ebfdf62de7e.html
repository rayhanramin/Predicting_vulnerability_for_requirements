<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26783:8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e" />
<meta property="og:url" content="/comm-central/rev/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e" />
<meta property="og:description" content="Bug 1518823 - Replace FakeTree with a real tree and re-enable 31 disabled tests. r=mkmelin DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e">shortlog</a> |
<a href="/comm-central/log/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e">files</a> |
changeset |
<a href="/comm-central/raw-rev/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e">raw</a>  | <a href="/comm-central/archive/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518823">Bug 1518823</a> - Replace FakeTree with a real tree and re-enable 31 disabled tests. r=mkmelin DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 29 May 2019 11:48:03 +1200</td></tr>

<tr>
 <td>changeset 26783</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e">8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e</a></td>
</tr>



<tr>
<td>parent 26782</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c104316e6c2120b3bff9498631063a37d54530b6">c104316e6c2120b3bff9498631063a37d54530b6</a>
</td>
</tr>

<tr>
<td>child 26784</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7211eed9164b20c7be4ca855151c58c4eef57c3b">7211eed9164b20c7be4ca855151c58c4eef57c3b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e">15993</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 03 Jun 2019 09:02:29 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8c7373a378b6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e&newProject=comm-central&newRevision=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e&newProject=comm-central&newRevision=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e&newProject=comm-central&newRevision=8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518823">1518823</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518823">Bug 1518823</a> - Replace FakeTree with a real tree and re-enable 31 disabled tests. r=mkmelin DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageDisplay.js">mail/base/content/messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageDisplay.js">file</a> |
<a href="/comm-central/annotate/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageDisplay.js">comparison</a> |
<a href="/comm-central/log/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-close-window-on-delete.js">mail/test/mozmill/folder-display/test-close-window-on-delete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-close-window-on-delete.js">file</a> |
<a href="/comm-central/annotate/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-close-window-on-delete.js">annotate</a> |
<a href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-close-window-on-delete.js">diff</a> |
<a href="/comm-central/comparison/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-close-window-on-delete.js">comparison</a> |
<a href="/comm-central/log/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-close-window-on-delete.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">file</a> |
<a href="/comm-central/annotate/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">annotate</a> |
<a href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">diff</a> |
<a href="/comm-central/comparison/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">comparison</a> |
<a href="/comm-central/log/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">file</a> |
<a href="/comm-central/annotate/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">annotate</a> |
<a href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">diff</a> |
<a href="/comm-central/comparison/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">comparison</a> |
<a href="/comm-central/log/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/8c7373a378b6ddedbbc8c952c70a5ebfdf62de7e/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -140,47 +140,44 @@ function FolderDisplayWidget(aTabInfo, a</span>
<a href="#l1.4"></a><span id="l1.4">   /** the next view index to select once the delete completes */</span>
<a href="#l1.5"></a><span id="l1.5">   this._nextViewIndexAfterDelete = null;</span>
<a href="#l1.6"></a><span id="l1.6">   /**</span>
<a href="#l1.7"></a><span id="l1.7">    * Track when a mass move is in effect (we get told by hintMassMoveStarting,</span>
<a href="#l1.8"></a><span id="l1.8">    *  and hintMassMoveCompleted) so that we can avoid deletion-triggered</span>
<a href="#l1.9"></a><span id="l1.9">    *  moving to _nextViewIndexAfterDelete until the mass move completes.</span>
<a href="#l1.10"></a><span id="l1.10">    */</span>
<a href="#l1.11"></a><span id="l1.11">   this._massMoveActive = false;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  /**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+   * Track when a message is being deleted so we can respond appropriately.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+   */</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  this._deleteInProgress = false;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   /**</span>
<a href="#l1.18"></a><span id="l1.18">    * Used by pushNavigation to queue a navigation request for when we enter the</span>
<a href="#l1.19"></a><span id="l1.19">    *  next folder; onMessagesLoaded(true) is the one that processes it.</span>
<a href="#l1.20"></a><span id="l1.20">    */</span>
<a href="#l1.21"></a><span id="l1.21">   this._pendingNavigation = null;</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">   this._active = false;</span>
<a href="#l1.24"></a><span id="l1.24">   /**</span>
<a href="#l1.25"></a><span id="l1.25">    * A list of methods to call on 'this' object when we are next made active.</span>
<a href="#l1.26"></a><span id="l1.26">    *  This list is populated by calls to |_notifyWhenActive| when we are</span>
<a href="#l1.27"></a><span id="l1.27">    *  not active at the moment.</span>
<a href="#l1.28"></a><span id="l1.28">    */</span>
<a href="#l1.29"></a><span id="l1.29">   this._notificationsPendingActivation = [];</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  // Create a DOM node for the fake tree box below.</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  let domNode = document.createXULElement(&quot;vbox&quot;);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-  // We care about onselect events, so add a listener for that.</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-  let self = this;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  domNode.addEventListener(&quot;select&quot;, function() {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    self.view.dbView.selectionChanged();</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  });</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-</span>
<a href="#l1.40"></a><span id="l1.40">   /**</span>
<a href="#l1.41"></a><span id="l1.41">    * Create a fake tree object for if/when this folder is in the background.</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-   * We need to give it a DOM object to send events to, including the onselect</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-   * event we care about and for which we added a handler above, and all the</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-   * other events we don't care about.</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+   * Hide the tree using CSS, because if it's not attached to the document or</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+   * is hidden=&quot;true&quot;, it won't fire select events and stuff will break.</span>
<a href="#l1.47"></a><span id="l1.47">    */</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-  this._fakeTree = new FakeTree(domNode);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+  this._fakeTree = document.createXULElement(&quot;tree&quot;);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  this._fakeTree.setAttribute(&quot;style&quot;, &quot;visibility: collapse&quot;);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  this._fakeTree.appendChild(document.createXULElement(&quot;treechildren&quot;));</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+  document.documentElement.appendChild(this._fakeTree);</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">   /**</span>
<a href="#l1.55"></a><span id="l1.55">    * Create a fake tree selection for cases where we have opened a background</span>
<a href="#l1.56"></a><span id="l1.56">    * tab. We'll get rid of this as soon as we've switched to the tab for the</span>
<a href="#l1.57"></a><span id="l1.57">    * first time, and have a real tree selection.</span>
<a href="#l1.58"></a><span id="l1.58">    */</span>
<a href="#l1.59"></a><span id="l1.59">   this._fakeTreeSelection = new JSTreeSelection(this._fakeTree);</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61" class="difflineat">@@ -820,16 +817,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.62"></a><span id="l1.62">     //  anything else because closing the view could theoretically propagate</span>
<a href="#l1.63"></a><span id="l1.63">     //  down to the message display and we don't want it doing anything it</span>
<a href="#l1.64"></a><span id="l1.64">     //  doesn't have to do.</span>
<a href="#l1.65"></a><span id="l1.65">     this.messageDisplay._close();</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67">     this.view.close();</span>
<a href="#l1.68"></a><span id="l1.68">     this.messenger.setWindow(null, null);</span>
<a href="#l1.69"></a><span id="l1.69">     this.messenger = null;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    this._fakeTree.remove();</span>
<a href="#l1.71"></a><span id="l1.71">     this._fakeTree = null;</span>
<a href="#l1.72"></a><span id="l1.72">     this._fakeTreeSelection = null;</span>
<a href="#l1.73"></a><span id="l1.73">   },</span>
<a href="#l1.74"></a><span id="l1.74">   // @}</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">   /*   ===============================   */</span>
<a href="#l1.77"></a><span id="l1.77">   /* ===== IDBViewWrapper Listener ===== */</span>
<a href="#l1.78"></a><span id="l1.78">   /*   ===============================   */</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineat">@@ -1195,17 +1193,19 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.80"></a><span id="l1.80">    * our message selection. We might know it's coming; if we do then</span>
<a href="#l1.81"></a><span id="l1.81">    * this._nextViewIndexAfterDelete should know what view index to select next.</span>
<a href="#l1.82"></a><span id="l1.82">    * For the imap mark-as-deleted we won't know beforehand.</span>
<a href="#l1.83"></a><span id="l1.83">    */</span>
<a href="#l1.84"></a><span id="l1.84">   onMessagesRemoved() {</span>
<a href="#l1.85"></a><span id="l1.85">     FolderDisplayListenerManager._fireListeners(&quot;onMessagesRemoved&quot;,</span>
<a href="#l1.86"></a><span id="l1.86">                                                 [this]);</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-    if (this.messageDisplay.onMessagesRemoved())</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    let handled = this.messageDisplay.onMessagesRemoved();</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+    this._deleteInProgress = false;</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+    if (handled)</span>
<a href="#l1.92"></a><span id="l1.92">       return;</span>
<a href="#l1.93"></a><span id="l1.93"> </span>
<a href="#l1.94"></a><span id="l1.94">     // - we saw this coming</span>
<a href="#l1.95"></a><span id="l1.95">     let rowCount = this.view.dbView.rowCount;</span>
<a href="#l1.96"></a><span id="l1.96">     if (!this._massMoveActive &amp;&amp; (this._nextViewIndexAfterDelete != null)) {</span>
<a href="#l1.97"></a><span id="l1.97">       // adjust the index if it is after the last row...</span>
<a href="#l1.98"></a><span id="l1.98">       // (this can happen if the &quot;mail.delete_matches_sort_order&quot; pref is not</span>
<a href="#l1.99"></a><span id="l1.99">       //  set and the message is the last message in the view.)</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineat">@@ -1411,16 +1411,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.101"></a><span id="l1.101">    *  to pull on right now.</span>
<a href="#l1.102"></a><span id="l1.102">    * We use this hint to figure out the next message to display once the</span>
<a href="#l1.103"></a><span id="l1.103">    *  deletion completes.  We do this before the deletion happens because the</span>
<a href="#l1.104"></a><span id="l1.104">    *  selection is probably going away (except in the IMAP delete model), and it</span>
<a href="#l1.105"></a><span id="l1.105">    *  might be too late to figure this out after the deletion happens.</span>
<a href="#l1.106"></a><span id="l1.106">    * Our automated complement (that calls us) is updateNextMessageAfterDelete.</span>
<a href="#l1.107"></a><span id="l1.107">    */</span>
<a href="#l1.108"></a><span id="l1.108">   hintAboutToDeleteMessages() {</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    this._deleteInProgress = true;</span>
<a href="#l1.110"></a><span id="l1.110">     // save the value, even if it is nsMsgViewIndex_None.</span>
<a href="#l1.111"></a><span id="l1.111">     this._nextViewIndexAfterDelete = this.view.dbView.msgToSelectAfterDelete;</span>
<a href="#l1.112"></a><span id="l1.112">   },</span>
<a href="#l1.113"></a><span id="l1.113"> </span>
<a href="#l1.114"></a><span id="l1.114">   /**</span>
<a href="#l1.115"></a><span id="l1.115">    * The archive code tells us when it is starting to archive messages.  This</span>
<a href="#l1.116"></a><span id="l1.116">    *  is different from hinting about deletion because it will also tell us</span>
<a href="#l1.117"></a><span id="l1.117">    *  when it has completed its mass move.</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineat">@@ -1767,18 +1768,18 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.119"></a><span id="l1.119">     //  up-to-date even while hidden in the background</span>
<a href="#l1.120"></a><span id="l1.120">     if (aNullRealTreeBoxView &amp;&amp; this.tree)</span>
<a href="#l1.121"></a><span id="l1.121">       this.tree.view = null;</span>
<a href="#l1.122"></a><span id="l1.122">     // (and tell the db view about its selection again...)</span>
<a href="#l1.123"></a><span id="l1.123">     this.view.dbView.selection = treeSelection;</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">     // hook the dbview up to the fake tree box</span>
<a href="#l1.126"></a><span id="l1.126">     this._fakeTree.view = this.view.dbView;</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-    // this.view.dbView.setTree(this._fakeTree);  // See bug 1518823.</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-    // treeSelection.tree = this._fakeTree;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+    this.view.dbView.setTree(this._fakeTree);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+    treeSelection.tree = this._fakeTree;</span>
<a href="#l1.131"></a><span id="l1.131">   },</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133">   /**</span>
<a href="#l1.134"></a><span id="l1.134">    * @name Command Support</span>
<a href="#l1.135"></a><span id="l1.135">    */</span>
<a href="#l1.136"></a><span id="l1.136">   // @{</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">   /**</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineat">@@ -2340,16 +2341,20 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.140"></a><span id="l1.140">     if (this._active)</span>
<a href="#l1.141"></a><span id="l1.141">       this.ensureRowIsVisible(aViewIndex);</span>
<a href="#l1.142"></a><span id="l1.142"> </span>
<a href="#l1.143"></a><span id="l1.143">     // The saved selection is invalidated, since we've got something newer</span>
<a href="#l1.144"></a><span id="l1.144">     this._savedSelection = null;</span>
<a href="#l1.145"></a><span id="l1.145"> </span>
<a href="#l1.146"></a><span id="l1.146">     // Do this here instead of at the beginning to prevent reentrancy issues</span>
<a href="#l1.147"></a><span id="l1.147">     this._aboutToSelectMessage = false;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+    if (tabmail)</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+      tabmail.setTabTitle(this._tabInfo);</span>
<a href="#l1.152"></a><span id="l1.152">   },</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154">   /**</span>
<a href="#l1.155"></a><span id="l1.155">    * For every selected message in the display that is part of a (displayed)</span>
<a href="#l1.156"></a><span id="l1.156">    *  thread and is not the root message, de-select it and ensure that the</span>
<a href="#l1.157"></a><span id="l1.157">    *  root message of the thread is selected.</span>
<a href="#l1.158"></a><span id="l1.158">    * This is primarily intended to be used when collapsing visible threads.</span>
<a href="#l1.159"></a><span id="l1.159">    *</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineat">@@ -2559,163 +2564,8 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.161"></a><span id="l1.161">       if (maxRow == null || rangeMax &gt; maxRow)</span>
<a href="#l1.162"></a><span id="l1.162">         maxRow = rangeMax;</span>
<a href="#l1.163"></a><span id="l1.163">     }</span>
<a href="#l1.164"></a><span id="l1.164"> </span>
<a href="#l1.165"></a><span id="l1.165">     this.ensureRowRangeIsVisible(minRow, maxRow);</span>
<a href="#l1.166"></a><span id="l1.166">   },</span>
<a href="#l1.167"></a><span id="l1.167">   // @}</span>
<a href="#l1.168"></a><span id="l1.168"> };</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-/**</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">- * Implement a fake nsITreeBoxObject so that we can keep the view</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">- *  nsITreeSelection selections 'live' when they are in the background.  We need</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">- *  to do this because nsTreeSelection changes its behaviour (and gets ornery)</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">- *  if it does not have a box object.</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">- * This does not need to exist once we abandon multiplexed tabbing.</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">- *</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">- * Sometimes, nsTreeSelection tries to turn us into an nsIBoxObject and then in</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">- *  turn get the associated element, and then create DOM events on that. The</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">- *  only event that we care about is onselect, so we get a DOM node here (with</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">- *  an event listener for onselect already attached), and pass its boxObject in</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">- *  whenever nsTreeSelection QIs us to nsIBoxObject.</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">- */</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-function FakeTree(aDOMNode) {</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-  this.domNode = aDOMNode;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-  this.view = null;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-}</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-FakeTree.prototype = {</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  view: null,</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-  ensureRowIsVisible() {</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-    // NOP</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-  },</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-  /**</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-   * No need to actually invalidate, as when we re-root the view this will</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-   *  happen.</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-   */</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-  invalidate() {</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-    // NOP</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-  },</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  invalidateRange() {</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-    // NOP</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-  },</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  invalidateRow() {</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-    // NOP</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-  },</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-  beginUpdateBatch() {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-  },</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-  endUpdateBatch() {</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-  },</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  /**</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-   * We're going to make an exception to our NOP rule here, as this is rather</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-   * important for us to pass on. The db view calls this if a row's been</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-   * inserted or deleted. Without this, the selection's going to be out of sync</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-   * with the view.</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-   *</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-   * @param aIndex the index where the rows have been inserted or deleted</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-   * @param aCount the number of rows inserted or deleted (negative for</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-   *               deleted)</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-   */</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-  rowCountChanged(aIndex, aCount) {</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-    if (aCount == 0 || !this.view)</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-      // Nothing to do</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-      return;</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-    let selection = this.view.selection;</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-    if (selection)</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-      selection.adjustSelection(aIndex, aCount);</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-  },</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-  get element() { return this.domNode; },</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-  get x() { return this.domNode.getBoundingClientRect().x; },</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-  get y() { return this.domNode.getBoundingClientRect().y; },</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-  get screenX() { return this.domNode.screenX; },</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-  get screenY() { return this.domNode.screenY; },</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-  get width() { return this.domNode.getBoundingClientRect().width; },</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-  get height() { return this.domNode.getBoundingClientRect().height; },</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-  get parentBox() { return this.domNode.boxObject.parentBox; },</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-  get firstChild() { return this.domNode.boxObject.firstChild; },</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-  get lastChild() { return this.domNode.boxObject.lastChild; },</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-  get nextSibling() { return this.domNode.boxObject.nextSibling; },</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-  get previousSibling() { return this.domNode.boxObject.previousSibling; },</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-  getPropertyAsSupports(propertyName) {</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-    return this.domNode.boxObject.getPropertyAsSupports(propertyName);</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-  },</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-  setPropertyAsSupports(propertyName, value) {</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-    this.domNode.boxObject.setPropertyAsSupports(propertyName, value);</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-  },</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-  getProperty(propertyName) {</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-    return this.domNode.boxObject.getProperty(propertyName);</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-  },</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-  setProperty(propertyName, value) {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-    return this.domNode.boxObject.setProperty(propertyName, value);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-  },</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-  removeProperty(propertyName) {</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-    return this.domNode.boxObject.removeProperty(propertyName);</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-  },</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsIBoxObject&quot;,</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-                                          &quot;XULTreeElement&quot;]),</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-};</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-/*</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">- * Provide attribute and function implementations that complain very loudly if</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">- *  they are used.  Now, XPConnect will return an error to callers if we don't</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">- *  implement part of the interface signature, but this is unlikely to provide</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">- *  the visibility we desire.  In fact, since it is a simple nsresult error,</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">- *  it may make things completely crazy.  So this way we can yell via dump,</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">- *  throw an exception, etc.</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">- */</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-function FTBO_stubOutAttributes(aObj, aAttribNames) {</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-  for (let attrName of aAttribNames) {</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-    let myAttrName = attrName;</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-    aObj.__defineGetter__(attrName,</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-      function() {</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-        let msg = &quot;Read access to stubbed attribute &quot; + myAttrName;</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-        dump(msg + &quot;\n&quot;);</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-        throw new Error(msg);</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-      });</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-    aObj.__defineSetter__(attrName,</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-      function() {</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-        let msg = &quot;Write access to stubbed attribute &quot; + myAttrName;</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-        dump(msg + &quot;\n&quot;);</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-        throw new Error(msg);</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-      });</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-  }</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-}</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-function FTBO_stubOutMethods(aObj, aMethodNames) {</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-  for (let methodName of aMethodNames) {</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-    let myMethodName = methodName;</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-    aObj[myMethodName] = function() {</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-      let msg = &quot;Call to stubbed method &quot; + myMethodName;</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-      dump(msg + &quot;\n&quot;);</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-      throw new Error(msg);</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-    };</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-  }</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-}</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-FTBO_stubOutAttributes(FakeTree.prototype, [</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-  &quot;columns&quot;,</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-  &quot;focused&quot;,</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-  &quot;treeBody&quot;,</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-  &quot;rowHeight&quot;,</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-  &quot;rowWidth&quot;,</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-  &quot;horizontalPosition&quot;,</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-  &quot;selectionRegion&quot;,</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-  ]);</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-FTBO_stubOutMethods(FakeTree.prototype, [</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-  &quot;getFirstVisibleRow&quot;,</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-  &quot;getLastVisibleRow&quot;,</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-  &quot;getPageLength&quot;,</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-  &quot;ensureCellIsVisible&quot;,</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-  &quot;scrollToRow&quot;,</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-  &quot;scrollByLines&quot;,</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-  &quot;scrollByPages&quot;,</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-  &quot;scrollToCell&quot;,</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-  &quot;scrollToColumn&quot;,</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-  &quot;scrollToHorizontalPosition&quot;,</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-  &quot;invalidateColumn&quot;,</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-  &quot;invalidateCell&quot;,</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-  &quot;invalidateColumnRange&quot;,</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-  &quot;getRowAt&quot;,</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-  &quot;getCellAt&quot;,</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-  &quot;getCoordsForCellItem&quot;,</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-  &quot;isCellCropped&quot;,</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-  &quot;clearStyleAndImageCaches&quot;,</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-  ]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/messageDisplay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -500,18 +500,17 @@ MessageTabDisplayWidget.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">   },</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   onSelectedMessagesChanged() {</span>
<a href="#l2.7"></a><span id="l2.7">     // Look at the number of messages left in the db view. If there aren't any,</span>
<a href="#l2.8"></a><span id="l2.8">     // close the tab.</span>
<a href="#l2.9"></a><span id="l2.9">     if (this.folderDisplay.view.dbView.rowCount == 0) {</span>
<a href="#l2.10"></a><span id="l2.10">       if (!this.closing) {</span>
<a href="#l2.11"></a><span id="l2.11">         this.closing = true;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        document.getElementById(&quot;tabmail&quot;).closeTab(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-            this.folderDisplay._tabInfo, true);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+        document.getElementById(&quot;tabmail&quot;).closeTab(this.folderDisplay._tabInfo, true);</span>
<a href="#l2.15"></a><span id="l2.15">       }</span>
<a href="#l2.16"></a><span id="l2.16">       return true;</span>
<a href="#l2.17"></a><span id="l2.17">     }</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">     if (!this.closing)</span>
<a href="#l2.20"></a><span id="l2.20">       document.getElementById(&quot;tabmail&quot;).setTabTitle(this.folderDisplay._tabInfo);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">     // The db view shouldn't do anything if we're inactive or about to close</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -522,22 +521,23 @@ MessageTabDisplayWidget.prototype = {</span>
<a href="#l2.24"></a><span id="l2.24">     this.singleMessageDisplay = true;</span>
<a href="#l2.25"></a><span id="l2.25">     return false;</span>
<a href="#l2.26"></a><span id="l2.26">   },</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   onMessagesRemoved() {</span>
<a href="#l2.29"></a><span id="l2.29">     if (!this.folderDisplay.treeSelection)</span>
<a href="#l2.30"></a><span id="l2.30">       return true;</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-    if (this.folderDisplay.treeSelection.count == 0 &amp;&amp;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    if (this.folderDisplay._deleteInProgress &amp;&amp;</span>
<a href="#l2.34"></a><span id="l2.34">         Services.prefs.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l2.35"></a><span id="l2.35">       document.getElementById(&quot;tabmail&quot;).closeTab(this.folderDisplay._tabInfo,</span>
<a href="#l2.36"></a><span id="l2.36">                                                   true);</span>
<a href="#l2.37"></a><span id="l2.37">       return true;</span>
<a href="#l2.38"></a><span id="l2.38">     }</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+</span>
<a href="#l2.40"></a><span id="l2.40">     return false;</span>
<a href="#l2.41"></a><span id="l2.41">   },</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   /**</span>
<a href="#l2.44"></a><span id="l2.44">    * A message tab should never ever be blank.  Close the tab if we become</span>
<a href="#l2.45"></a><span id="l2.45">    *  blank.</span>
<a href="#l2.46"></a><span id="l2.46">    */</span>
<a href="#l2.47"></a><span id="l2.47">   clearDisplay() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -97,17 +97,17 @@ StandaloneFolderDisplayWidget.prototype </span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">     // only if we're not dealing with a dummy message (from .eml file /</span>
<a href="#l3.6"></a><span id="l3.6">     //  attachment should we try and hook up the selection object.)  Otherwise</span>
<a href="#l3.7"></a><span id="l3.7">     //  the view will not operate in stand alone message mode.</span>
<a href="#l3.8"></a><span id="l3.8">     // XXX the sequencing here may break re-using a message window that is</span>
<a href="#l3.9"></a><span id="l3.9">     //  showing an .eml file to go to a real message, at least in terms of</span>
<a href="#l3.10"></a><span id="l3.10">     //  having the selection object properly associated with the tree.</span>
<a href="#l3.11"></a><span id="l3.11">     if (!this.messageDisplay.isDummy) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      // this.view.dbView.setTree(this._fakeTree);  // See bug 1518823.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      this.view.dbView.setTree(this._fakeTree);</span>
<a href="#l3.14"></a><span id="l3.14">       this.view.dbView.selection = this._magicTreeSelection;</span>
<a href="#l3.15"></a><span id="l3.15">       // This lets the dbView know we don't really have a tree, so it can</span>
<a href="#l3.16"></a><span id="l3.16">       // avoid operating on messages in collapsed threads.</span>
<a href="#l3.17"></a><span id="l3.17">       this._magicTreeSelection.tree = null;</span>
<a href="#l3.18"></a><span id="l3.18">     }</span>
<a href="#l3.19"></a><span id="l3.19">     this.__proto__.__proto__.onCreatedView.call(this);</span>
<a href="#l3.20"></a><span id="l3.20">   },</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -274,17 +274,18 @@ StandaloneMessageDisplayWidget.prototype</span>
<a href="#l3.23"></a><span id="l3.23">       return true;</span>
<a href="#l3.24"></a><span id="l3.24">     }</span>
<a href="#l3.25"></a><span id="l3.25">     return false;</span>
<a href="#l3.26"></a><span id="l3.26">   },</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">   onMessagesRemoved() {</span>
<a href="#l3.29"></a><span id="l3.29">     if (!this.folderDisplay.treeSelection)</span>
<a href="#l3.30"></a><span id="l3.30">       return true;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    if (this.folderDisplay.treeSelection.count == 0 &amp;&amp;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    if (this.folderDisplay._deleteInProgress &amp;&amp;</span>
<a href="#l3.34"></a><span id="l3.34">         Services.prefs.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l3.35"></a><span id="l3.35">       window.close();</span>
<a href="#l3.36"></a><span id="l3.36">       return true;</span>
<a href="#l3.37"></a><span id="l3.37">     }</span>
<a href="#l3.38"></a><span id="l3.38">     return false;</span>
<a href="#l3.39"></a><span id="l3.39">   },</span>
<a href="#l3.40"></a><span id="l3.40"> };</span>
<a href="#l3.41"></a><span id="l3.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-close-window-on-delete.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-close-window-on-delete.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -27,17 +27,17 @@ function setupModule(module) {</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">   make_new_sets_in_folder(folder, [{count: 10}]);</span>
<a href="#l4.6"></a><span id="l4.6"> }</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> /**</span>
<a href="#l4.9"></a><span id="l4.9">  * Delete a message and check that the message window is closed</span>
<a href="#l4.10"></a><span id="l4.10">  * where appropriate.</span>
<a href="#l4.11"></a><span id="l4.11">  */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function disabled_test_close_message_window_on_delete_from_message_window() {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+function test_close_message_window_on_delete_from_message_window() {</span>
<a href="#l4.14"></a><span id="l4.14">   set_close_message_on_delete(true);</span>
<a href="#l4.15"></a><span id="l4.15">   be_in_folder(folder);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">   // select the first message</span>
<a href="#l4.18"></a><span id="l4.18">   select_click_row(0);</span>
<a href="#l4.19"></a><span id="l4.19">   // display it</span>
<a href="#l4.20"></a><span id="l4.20">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -59,17 +59,17 @@ function disabled_test_close_message_win</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">   reset_close_message_on_delete();</span>
<a href="#l4.25"></a><span id="l4.25"> }</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> /**</span>
<a href="#l4.28"></a><span id="l4.28">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l4.29"></a><span id="l4.29">  * message is deleted from one of them.</span>
<a href="#l4.30"></a><span id="l4.30">  */</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-function disabled_test_close_multiple_message_windows_on_delete_from_message_window() {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+function test_close_multiple_message_windows_on_delete_from_message_window() {</span>
<a href="#l4.33"></a><span id="l4.33">   set_close_message_on_delete(true);</span>
<a href="#l4.34"></a><span id="l4.34">   be_in_folder(folder);</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36">   // select the first message</span>
<a href="#l4.37"></a><span id="l4.37">   select_click_row(0);</span>
<a href="#l4.38"></a><span id="l4.38">   // display it</span>
<a href="#l4.39"></a><span id="l4.39">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l4.40"></a><span id="l4.40">   let msgcA = open_selected_message_in_new_window();</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -95,17 +95,17 @@ function disabled_test_close_multiple_me</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">   reset_close_message_on_delete();</span>
<a href="#l4.44"></a><span id="l4.44"> }</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46"> /**</span>
<a href="#l4.47"></a><span id="l4.47">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l4.48"></a><span id="l4.48">  * message is deleted from the 3-pane window.</span>
<a href="#l4.49"></a><span id="l4.49">  */</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-function disabled_test_close_multiple_message_windows_on_delete_from_3pane_window() {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+function test_close_multiple_message_windows_on_delete_from_3pane_window() {</span>
<a href="#l4.52"></a><span id="l4.52">   set_close_message_on_delete(true);</span>
<a href="#l4.53"></a><span id="l4.53">   be_in_folder(folder);</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">   // select the first message</span>
<a href="#l4.56"></a><span id="l4.56">   select_click_row(0);</span>
<a href="#l4.57"></a><span id="l4.57">   // display it</span>
<a href="#l4.58"></a><span id="l4.58">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l4.59"></a><span id="l4.59">   let msgcA = open_selected_message_in_new_window();</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineat">@@ -165,17 +165,17 @@ function test_close_message_tab_on_delet</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62">   reset_close_message_on_delete();</span>
<a href="#l4.63"></a><span id="l4.63"> }</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65"> /**</span>
<a href="#l4.66"></a><span id="l4.66">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l4.67"></a><span id="l4.67">  * message is deleted from one of them.</span>
<a href="#l4.68"></a><span id="l4.68">  */</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-function disabled_test_close_multiple_message_tabs_on_delete_from_message_tab() {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+function test_close_multiple_message_tabs_on_delete_from_message_tab() {</span>
<a href="#l4.71"></a><span id="l4.71">   set_close_message_on_delete(true);</span>
<a href="#l4.72"></a><span id="l4.72">   be_in_folder(folder);</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74">   // select the first message</span>
<a href="#l4.75"></a><span id="l4.75">   select_click_row(0);</span>
<a href="#l4.76"></a><span id="l4.76">   // display it</span>
<a href="#l4.77"></a><span id="l4.77">   let msgc = open_selected_message_in_new_tab(true);</span>
<a href="#l4.78"></a><span id="l4.78">   open_selected_message_in_new_tab(true);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineat">@@ -199,17 +199,17 @@ function disabled_test_close_multiple_me</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">   reset_close_message_on_delete();</span>
<a href="#l4.82"></a><span id="l4.82"> }</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84"> /**</span>
<a href="#l4.85"></a><span id="l4.85">  * Delete a message when multiple tabs are open to the message, and the</span>
<a href="#l4.86"></a><span id="l4.86">  * message is deleted from the 3-pane window.</span>
<a href="#l4.87"></a><span id="l4.87">  */</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-function disabled_test_close_multiple_message_tabs_on_delete_from_3pane_window() {</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+function test_close_multiple_message_tabs_on_delete_from_3pane_window() {</span>
<a href="#l4.90"></a><span id="l4.90">   set_close_message_on_delete(true);</span>
<a href="#l4.91"></a><span id="l4.91">   be_in_folder(folder);</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93">   // select the first message</span>
<a href="#l4.94"></a><span id="l4.94">   select_click_row(0);</span>
<a href="#l4.95"></a><span id="l4.95">   // display it</span>
<a href="#l4.96"></a><span id="l4.96">   open_selected_message_in_new_tab(true);</span>
<a href="#l4.97"></a><span id="l4.97">   open_selected_message_in_new_tab(true);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineat">@@ -234,17 +234,17 @@ function disabled_test_close_multiple_me</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">   reset_close_message_on_delete();</span>
<a href="#l4.101"></a><span id="l4.101"> }</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103"> /**</span>
<a href="#l4.104"></a><span id="l4.104">  * Delete a message when multiple windows and tabs are open to the message, and</span>
<a href="#l4.105"></a><span id="l4.105">  * the message is deleted from the 3-pane window.</span>
<a href="#l4.106"></a><span id="l4.106">  */</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-function disabled_test_close_multiple_windows_tabs_on_delete_from_3pane_window() {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+function test_close_multiple_windows_tabs_on_delete_from_3pane_window() {</span>
<a href="#l4.109"></a><span id="l4.109">   set_close_message_on_delete(true);</span>
<a href="#l4.110"></a><span id="l4.110">   be_in_folder(folder);</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112">   // select the first message</span>
<a href="#l4.113"></a><span id="l4.113">   select_click_row(0);</span>
<a href="#l4.114"></a><span id="l4.114">   // display it</span>
<a href="#l4.115"></a><span id="l4.115">   open_selected_message_in_new_tab(true);</span>
<a href="#l4.116"></a><span id="l4.116">   let msgcA = open_selected_message_in_new_window();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -142,33 +142,33 @@ function test_open_first_message_in_virt</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   _open_first_message();</span>
<a href="#l5.6"></a><span id="l5.6"> }</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> /**</span>
<a href="#l5.9"></a><span id="l5.9">  * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l5.10"></a><span id="l5.10">  * (advancing to the next message).</span>
<a href="#l5.11"></a><span id="l5.11">  */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-function disabled_test_delete_from_virtual_folder_in_folder_tab() {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+function test_delete_from_virtual_folder_in_folder_tab() {</span>
<a href="#l5.14"></a><span id="l5.14">   // - plan to end up on the guy who is currently at index 1</span>
<a href="#l5.15"></a><span id="l5.15">   curMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l5.16"></a><span id="l5.16">   // while we're at it, figure out who is at 2 for the next step</span>
<a href="#l5.17"></a><span id="l5.17">   nextMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l5.18"></a><span id="l5.18">   // - delete the message</span>
<a href="#l5.19"></a><span id="l5.19">   press_delete();</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   // - verify all displays</span>
<a href="#l5.22"></a><span id="l5.22">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l5.23"></a><span id="l5.23"> }</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> /**</span>
<a href="#l5.26"></a><span id="l5.26">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l5.27"></a><span id="l5.27">  *  (advancing to the next message).</span>
<a href="#l5.28"></a><span id="l5.28">  */</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-function disabled_test_delete_from_virtual_folder_in_message_tab() {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+function test_delete_from_virtual_folder_in_message_tab() {</span>
<a href="#l5.31"></a><span id="l5.31">   switch_tab(tabMessage);</span>
<a href="#l5.32"></a><span id="l5.32">   // nextMessage is the guy we want to see once the delete completes.</span>
<a href="#l5.33"></a><span id="l5.33">   press_delete();</span>
<a href="#l5.34"></a><span id="l5.34">   curMessage = nextMessage;</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   // - verify all displays</span>
<a href="#l5.37"></a><span id="l5.37">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39" class="difflineat">@@ -177,29 +177,29 @@ function disabled_test_delete_from_virtu</span>
<a href="#l5.40"></a><span id="l5.40">   if (!nextMessage)</span>
<a href="#l5.41"></a><span id="l5.41">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l5.42"></a><span id="l5.42"> }</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44"> /**</span>
<a href="#l5.45"></a><span id="l5.45">  * Perform a deletion from the message window, verify the others update</span>
<a href="#l5.46"></a><span id="l5.46">  *  correctly (advancing to the next message).</span>
<a href="#l5.47"></a><span id="l5.47">  */</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-function disabled_test_delete_from_virtual_folder_in_message_window() {</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+function test_delete_from_virtual_folder_in_message_window() {</span>
<a href="#l5.50"></a><span id="l5.50">   // - delete</span>
<a href="#l5.51"></a><span id="l5.51">   press_delete(msgc);</span>
<a href="#l5.52"></a><span id="l5.52">   curMessage = nextMessage;</span>
<a href="#l5.53"></a><span id="l5.53">   // - verify all displays</span>
<a href="#l5.54"></a><span id="l5.54">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l5.55"></a><span id="l5.55"> }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57"> /**</span>
<a href="#l5.58"></a><span id="l5.58">  * Delete the last message in that folder, which should close all message</span>
<a href="#l5.59"></a><span id="l5.59">  *  displays.</span>
<a href="#l5.60"></a><span id="l5.60">  */</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-function disabled_test_delete_last_message_from_virtual_folder_closes_message_displays() {</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+function test_delete_last_message_from_virtual_folder_closes_message_displays() {</span>
<a href="#l5.63"></a><span id="l5.63">   // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l5.64"></a><span id="l5.64">   // to open yet another tab to test</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">   // - prep for the message window disappearing</span>
<a href="#l5.67"></a><span id="l5.67">   plan_for_window_close(msgc);</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69">   // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l5.70"></a><span id="l5.70">   switch_tab(tabMessage);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineat">@@ -232,33 +232,33 @@ function test_open_first_message_in_smar</span>
<a href="#l5.72"></a><span id="l5.72">   // Open the first message</span>
<a href="#l5.73"></a><span id="l5.73">   _open_first_message();</span>
<a href="#l5.74"></a><span id="l5.74"> }</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76"> /**</span>
<a href="#l5.77"></a><span id="l5.77">  * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l5.78"></a><span id="l5.78">  * (advancing to the next message).</span>
<a href="#l5.79"></a><span id="l5.79">  */</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-function disabled_test_delete_from_smart_inbox_in_folder_tab() {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+function test_delete_from_smart_inbox_in_folder_tab() {</span>
<a href="#l5.82"></a><span id="l5.82">   // - plan to end up on the guy who is currently at index 1</span>
<a href="#l5.83"></a><span id="l5.83">   curMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l5.84"></a><span id="l5.84">   // while we're at it, figure out who is at 2 for the next step</span>
<a href="#l5.85"></a><span id="l5.85">   nextMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l5.86"></a><span id="l5.86">   // - delete the message</span>
<a href="#l5.87"></a><span id="l5.87">   press_delete();</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89">   // - verify all displays</span>
<a href="#l5.90"></a><span id="l5.90">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l5.91"></a><span id="l5.91"> }</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93"> /**</span>
<a href="#l5.94"></a><span id="l5.94">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l5.95"></a><span id="l5.95">  *  (advancing to the next message).</span>
<a href="#l5.96"></a><span id="l5.96">  */</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-function disabled_test_delete_from_smart_inbox_in_message_tab() {</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+function test_delete_from_smart_inbox_in_message_tab() {</span>
<a href="#l5.99"></a><span id="l5.99">   switch_tab(tabMessage);</span>
<a href="#l5.100"></a><span id="l5.100">   // nextMessage is the guy we want to see once the delete completes.</span>
<a href="#l5.101"></a><span id="l5.101">   press_delete();</span>
<a href="#l5.102"></a><span id="l5.102">   curMessage = nextMessage;</span>
<a href="#l5.103"></a><span id="l5.103"> </span>
<a href="#l5.104"></a><span id="l5.104">   // - verify all displays</span>
<a href="#l5.105"></a><span id="l5.105">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l5.106"></a><span id="l5.106"> </span>
<a href="#l5.107"></a><span id="l5.107" class="difflineat">@@ -267,29 +267,29 @@ function disabled_test_delete_from_smart</span>
<a href="#l5.108"></a><span id="l5.108">   if (!nextMessage)</span>
<a href="#l5.109"></a><span id="l5.109">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l5.110"></a><span id="l5.110"> }</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112"> /**</span>
<a href="#l5.113"></a><span id="l5.113">  * Perform a deletion from the message window, verify the others update</span>
<a href="#l5.114"></a><span id="l5.114">  *  correctly (advancing to the next message).</span>
<a href="#l5.115"></a><span id="l5.115">  */</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-function disabled_test_delete_from_smart_inbox_in_message_window() {</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+function test_delete_from_smart_inbox_in_message_window() {</span>
<a href="#l5.118"></a><span id="l5.118">   // - delete</span>
<a href="#l5.119"></a><span id="l5.119">   press_delete(msgc);</span>
<a href="#l5.120"></a><span id="l5.120">   curMessage = nextMessage;</span>
<a href="#l5.121"></a><span id="l5.121">   // - verify all displays</span>
<a href="#l5.122"></a><span id="l5.122">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l5.123"></a><span id="l5.123"> }</span>
<a href="#l5.124"></a><span id="l5.124"> </span>
<a href="#l5.125"></a><span id="l5.125"> /**</span>
<a href="#l5.126"></a><span id="l5.126">  * Delete the last message in that folder, which should close all message</span>
<a href="#l5.127"></a><span id="l5.127">  *  displays.</span>
<a href="#l5.128"></a><span id="l5.128">  */</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-function disabled_test_delete_last_message_from_smart_inbox_closes_message_displays() {</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+function test_delete_last_message_from_smart_inbox_closes_message_displays() {</span>
<a href="#l5.131"></a><span id="l5.131">   // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l5.132"></a><span id="l5.132">   // to open yet another tab to test</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134">   // - prep for the message window disappearing</span>
<a href="#l5.135"></a><span id="l5.135">   plan_for_window_close(msgc);</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137">   // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l5.138"></a><span id="l5.138">   switch_tab(tabMessage);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -50,17 +50,16 @@ function setupModule(module) {</span>
<a href="#l6.4"></a><span id="l6.4">   make_new_sets_in_folder(multipleDeletionFolder1, [{count: 30}]);</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">   // We're depending on selecting the last message here, so these do matter</span>
<a href="#l6.7"></a><span id="l6.7">   make_new_sets_in_folder(multipleDeletionFolder2, [{count: 10}]);</span>
<a href="#l6.8"></a><span id="l6.8">   make_new_sets_in_folder(multipleDeletionFolder3, [{count: 10}]);</span>
<a href="#l6.9"></a><span id="l6.9">   make_new_sets_in_folder(multipleDeletionFolder4, [{count: 10}]);</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13"> var tabFolder, tabMessage, tabMessageBackground, curMessage, nextMessage;</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> /**</span>
<a href="#l6.16"></a><span id="l6.16">  * The message window controller.  Short names because controllers get used a</span>
<a href="#l6.17"></a><span id="l6.17">  *  lot.</span>
<a href="#l6.18"></a><span id="l6.18">  */</span>
<a href="#l6.19"></a><span id="l6.19"> var msgc;</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -145,33 +144,33 @@ function _verify_message_is_displayed_in</span>
<a href="#l6.22"></a><span id="l6.22"> function test_open_first_message_in_all_four_display_mechanisms() {</span>
<a href="#l6.23"></a><span id="l6.23">   _open_message_in_all_four_display_mechanisms_helper(folder, 0);</span>
<a href="#l6.24"></a><span id="l6.24"> }</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> /**</span>
<a href="#l6.27"></a><span id="l6.27">  * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l6.28"></a><span id="l6.28">  *  (advancing to the next message).</span>
<a href="#l6.29"></a><span id="l6.29">  */</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-function disabled_test_delete_in_folder_tab() {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+function test_delete_in_folder_tab() {</span>
<a href="#l6.32"></a><span id="l6.32">   // - plan to end up on the guy who is currently at index 1</span>
<a href="#l6.33"></a><span id="l6.33">   curMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l6.34"></a><span id="l6.34">   // while we're at it, figure out who is at 2 for the next step</span>
<a href="#l6.35"></a><span id="l6.35">   nextMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l6.36"></a><span id="l6.36">   // - delete the message</span>
<a href="#l6.37"></a><span id="l6.37">   press_delete();</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39">   // - verify all displays</span>
<a href="#l6.40"></a><span id="l6.40">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l6.41"></a><span id="l6.41"> }</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43"> /**</span>
<a href="#l6.44"></a><span id="l6.44">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l6.45"></a><span id="l6.45">  *  (advancing to the next message).</span>
<a href="#l6.46"></a><span id="l6.46">  */</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-function disabled_test_delete_in_message_tab() {</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+function test_delete_in_message_tab() {</span>
<a href="#l6.49"></a><span id="l6.49">   switch_tab(tabMessage);</span>
<a href="#l6.50"></a><span id="l6.50">   // nextMessage is the guy we want to see once the delete completes.</span>
<a href="#l6.51"></a><span id="l6.51">   press_delete();</span>
<a href="#l6.52"></a><span id="l6.52">   curMessage = nextMessage;</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">   // - verify all displays</span>
<a href="#l6.55"></a><span id="l6.55">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57" class="difflineat">@@ -180,29 +179,29 @@ function disabled_test_delete_in_message</span>
<a href="#l6.58"></a><span id="l6.58">   if (!nextMessage)</span>
<a href="#l6.59"></a><span id="l6.59">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l6.60"></a><span id="l6.60"> }</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62"> /**</span>
<a href="#l6.63"></a><span id="l6.63">  * Perform a deletion from the message window, verify the others update</span>
<a href="#l6.64"></a><span id="l6.64">  *  correctly (advancing to the next message).</span>
<a href="#l6.65"></a><span id="l6.65">  */</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-function disabled_test_delete_in_message_window() {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+function test_delete_in_message_window() {</span>
<a href="#l6.68"></a><span id="l6.68">   // - delete</span>
<a href="#l6.69"></a><span id="l6.69">   press_delete(msgc);</span>
<a href="#l6.70"></a><span id="l6.70">   curMessage = nextMessage;</span>
<a href="#l6.71"></a><span id="l6.71">   // - verify all displays</span>
<a href="#l6.72"></a><span id="l6.72">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l6.73"></a><span id="l6.73"> }</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75"> /**</span>
<a href="#l6.76"></a><span id="l6.76">  * Delete the last message in that folder, which should close all message</span>
<a href="#l6.77"></a><span id="l6.77">  *  displays.</span>
<a href="#l6.78"></a><span id="l6.78">  */</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-function disabled_test_delete_last_message_closes_message_displays() {</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+function test_delete_last_message_closes_message_displays() {</span>
<a href="#l6.81"></a><span id="l6.81">   // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l6.82"></a><span id="l6.82">   // to open yet another tab to test</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">   // - prep for the message window disappearing</span>
<a href="#l6.85"></a><span id="l6.85">   plan_for_window_close(msgc);</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87">   // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l6.88"></a><span id="l6.88">   switch_tab(tabMessage);</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineat">@@ -239,33 +238,33 @@ function test_open_last_message_in_all_f</span>
<a href="#l6.90"></a><span id="l6.90">   // since we have four messages, index 3 is the last message.</span>
<a href="#l6.91"></a><span id="l6.91">   _open_message_in_all_four_display_mechanisms_helper(lastMessageFolder, 3);</span>
<a href="#l6.92"></a><span id="l6.92"> }</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94"> /**</span>
<a href="#l6.95"></a><span id="l6.95">  * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l6.96"></a><span id="l6.96">  * (advancing to the next message).</span>
<a href="#l6.97"></a><span id="l6.97">  */</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-function disabled_test_delete_last_message_in_folder_tab() {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+function test_delete_last_message_in_folder_tab() {</span>
<a href="#l6.100"></a><span id="l6.100">   // - plan to end up on the guy who is currently at index 2</span>
<a href="#l6.101"></a><span id="l6.101">   curMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l6.102"></a><span id="l6.102">   // while we're at it, figure out who is at 1 for the next step</span>
<a href="#l6.103"></a><span id="l6.103">   nextMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l6.104"></a><span id="l6.104">   // - delete the message</span>
<a href="#l6.105"></a><span id="l6.105">   press_delete();</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107">   // - verify all displays</span>
<a href="#l6.108"></a><span id="l6.108">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 2);</span>
<a href="#l6.109"></a><span id="l6.109"> }</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111"> /**</span>
<a href="#l6.112"></a><span id="l6.112">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l6.113"></a><span id="l6.113">  * (advancing to the next message).</span>
<a href="#l6.114"></a><span id="l6.114">  */</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-function disabled_test_delete_last_message_in_message_tab() {</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+function test_delete_last_message_in_message_tab() {</span>
<a href="#l6.117"></a><span id="l6.117">   // (we're still on the message tab, and nextMessage is the guy we want to see</span>
<a href="#l6.118"></a><span id="l6.118">   //  once the delete completes.)</span>
<a href="#l6.119"></a><span id="l6.119">   press_delete();</span>
<a href="#l6.120"></a><span id="l6.120">   curMessage = nextMessage;</span>
<a href="#l6.121"></a><span id="l6.121"> </span>
<a href="#l6.122"></a><span id="l6.122">   // - verify all displays</span>
<a href="#l6.123"></a><span id="l6.123">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 1);</span>
<a href="#l6.124"></a><span id="l6.124">   // figure out the next guy...</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineat">@@ -274,17 +273,17 @@ function disabled_test_delete_last_messa</span>
<a href="#l6.126"></a><span id="l6.126">   if (!nextMessage)</span>
<a href="#l6.127"></a><span id="l6.127">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l6.128"></a><span id="l6.128"> }</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130"> /**</span>
<a href="#l6.131"></a><span id="l6.131">  * Perform a deletion from the message window, verify the others update</span>
<a href="#l6.132"></a><span id="l6.132">  * correctly (advancing to the next message).</span>
<a href="#l6.133"></a><span id="l6.133">  */</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-function disabled_test_delete_last_message_in_message_window() {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+function test_delete_last_message_in_message_window() {</span>
<a href="#l6.136"></a><span id="l6.136">   // Vary this up. Switch to the folder tab instead of staying on the message</span>
<a href="#l6.137"></a><span id="l6.137">   // tab</span>
<a href="#l6.138"></a><span id="l6.138">   switch_tab(tabFolder);</span>
<a href="#l6.139"></a><span id="l6.139">   // - delete</span>
<a href="#l6.140"></a><span id="l6.140">   press_delete(msgc);</span>
<a href="#l6.141"></a><span id="l6.141">   curMessage = nextMessage;</span>
<a href="#l6.142"></a><span id="l6.142">   // - verify all displays</span>
<a href="#l6.143"></a><span id="l6.143">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineat">@@ -299,17 +298,17 @@ function disabled_test_delete_last_messa</span>
<a href="#l6.145"></a><span id="l6.145"> /*</span>
<a href="#l6.146"></a><span id="l6.146">  * Our next job is to open up a message, then delete the message one before it</span>
<a href="#l6.147"></a><span id="l6.147">  * in another view. The other selections shouldn't be affected.</span>
<a href="#l6.148"></a><span id="l6.148">  */</span>
<a href="#l6.149"></a><span id="l6.149"> </span>
<a href="#l6.150"></a><span id="l6.150"> /**</span>
<a href="#l6.151"></a><span id="l6.151">  * Test &quot;one before&quot; deletion in the folder tab.</span>
<a href="#l6.152"></a><span id="l6.152">  */</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-function disabled_test_delete_one_before_message_in_folder_tab() {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+function test_delete_one_before_message_in_folder_tab() {</span>
<a href="#l6.155"></a><span id="l6.155">   // Open up message 4 in message tabs and a window (we'll delete message 3).</span>
<a href="#l6.156"></a><span id="l6.156">   _open_message_in_all_four_display_mechanisms_helper(oneBeforeFolder, 4);</span>
<a href="#l6.157"></a><span id="l6.157"> </span>
<a href="#l6.158"></a><span id="l6.158">   let expectedMessage = mc.dbView.getMsgHdrAt(4);</span>
<a href="#l6.159"></a><span id="l6.159">   select_click_row(3);</span>
<a href="#l6.160"></a><span id="l6.160">   press_delete();</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162">   // The message tab, background message tab and window shouldn't have changed</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineat">@@ -322,17 +321,17 @@ function disabled_test_delete_one_before</span>
<a href="#l6.164"></a><span id="l6.164">   close_tab(tabMessage);</span>
<a href="#l6.165"></a><span id="l6.165">   close_tab(tabMessageBackground);</span>
<a href="#l6.166"></a><span id="l6.166">   switch_tab(tabFolder);</span>
<a href="#l6.167"></a><span id="l6.167"> }</span>
<a href="#l6.168"></a><span id="l6.168"> </span>
<a href="#l6.169"></a><span id="l6.169"> /**</span>
<a href="#l6.170"></a><span id="l6.170">  * Test &quot;one before&quot; deletion in the message tab.</span>
<a href="#l6.171"></a><span id="l6.171">  */</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-function disabled_test_delete_one_before_message_in_message_tab() {</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+function test_delete_one_before_message_in_message_tab() {</span>
<a href="#l6.174"></a><span id="l6.174">   // Open up 3 in a message tab, then select and open up 4 in a background tab</span>
<a href="#l6.175"></a><span id="l6.175">   // and window.</span>
<a href="#l6.176"></a><span id="l6.176">   select_click_row(3);</span>
<a href="#l6.177"></a><span id="l6.177">   tabMessage = open_selected_message_in_new_tab(true);</span>
<a href="#l6.178"></a><span id="l6.178">   let expectedMessage = select_click_row(4);</span>
<a href="#l6.179"></a><span id="l6.179">   tabMessageBackground = open_selected_message_in_new_tab(true);</span>
<a href="#l6.180"></a><span id="l6.180">   msgc = open_selected_message_in_new_window(true);</span>
<a href="#l6.181"></a><span id="l6.181"> </span>
<a href="#l6.182"></a><span id="l6.182" class="difflineat">@@ -350,17 +349,17 @@ function disabled_test_delete_one_before</span>
<a href="#l6.183"></a><span id="l6.183">   close_tab(tabMessage);</span>
<a href="#l6.184"></a><span id="l6.184">   close_tab(tabMessageBackground);</span>
<a href="#l6.185"></a><span id="l6.185">   switch_tab(tabFolder);</span>
<a href="#l6.186"></a><span id="l6.186"> }</span>
<a href="#l6.187"></a><span id="l6.187"> </span>
<a href="#l6.188"></a><span id="l6.188"> /**</span>
<a href="#l6.189"></a><span id="l6.189">  * Test &quot;one before&quot; deletion in the message window.</span>
<a href="#l6.190"></a><span id="l6.190">  */</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-function disabled_test_delete_one_before_message_in_message_window() {</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+function test_delete_one_before_message_in_message_window() {</span>
<a href="#l6.193"></a><span id="l6.193">   // Open up 3 in a message window, then select and open up 4 in a background</span>
<a href="#l6.194"></a><span id="l6.194">   // and a foreground tab.</span>
<a href="#l6.195"></a><span id="l6.195">   select_click_row(3);</span>
<a href="#l6.196"></a><span id="l6.196">   msgc = open_selected_message_in_new_window();</span>
<a href="#l6.197"></a><span id="l6.197">   let expectedMessage = select_click_row(4);</span>
<a href="#l6.198"></a><span id="l6.198">   tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l6.199"></a><span id="l6.199">   switch_tab(tabFolder);</span>
<a href="#l6.200"></a><span id="l6.200">   tabMessageBackground = open_selected_message_in_new_tab(true);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineat">@@ -407,17 +406,17 @@ function test_delete_one_after_message_i</span>
<a href="#l6.202"></a><span id="l6.202">   close_tab(tabMessage);</span>
<a href="#l6.203"></a><span id="l6.203">   close_tab(tabMessageBackground);</span>
<a href="#l6.204"></a><span id="l6.204">   switch_tab(tabFolder);</span>
<a href="#l6.205"></a><span id="l6.205"> }</span>
<a href="#l6.206"></a><span id="l6.206"> </span>
<a href="#l6.207"></a><span id="l6.207"> /**</span>
<a href="#l6.208"></a><span id="l6.208">  * Test &quot;one after&quot; deletion in the message tab.</span>
<a href="#l6.209"></a><span id="l6.209">  */</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-function disabled_test_delete_one_after_message_in_message_tab() {</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+function test_delete_one_after_message_in_message_tab() {</span>
<a href="#l6.212"></a><span id="l6.212">   // Open up 5 in a message tab, then select and open up 4 in a background tab</span>
<a href="#l6.213"></a><span id="l6.213">   // and window.</span>
<a href="#l6.214"></a><span id="l6.214">   select_click_row(5);</span>
<a href="#l6.215"></a><span id="l6.215">   tabMessage = open_selected_message_in_new_tab(true);</span>
<a href="#l6.216"></a><span id="l6.216">   let expectedMessage = select_click_row(4);</span>
<a href="#l6.217"></a><span id="l6.217">   tabMessageBackground = open_selected_message_in_new_tab(true);</span>
<a href="#l6.218"></a><span id="l6.218">   msgc = open_selected_message_in_new_window(true);</span>
<a href="#l6.219"></a><span id="l6.219"> </span>
<a href="#l6.220"></a><span id="l6.220" class="difflineat">@@ -471,17 +470,17 @@ function test_delete_one_after_message_i</span>
<a href="#l6.221"></a><span id="l6.221">  * Delete multiple messages in a folder tab. Make sure message displays at the</span>
<a href="#l6.222"></a><span id="l6.222">  * beginning, middle and end of a selection work out.</span>
<a href="#l6.223"></a><span id="l6.223">  */</span>
<a href="#l6.224"></a><span id="l6.224"> </span>
<a href="#l6.225"></a><span id="l6.225"> /**</span>
<a href="#l6.226"></a><span id="l6.226">  * Test deleting multiple messages in a folder tab, with message displays open</span>
<a href="#l6.227"></a><span id="l6.227">  * to the beginning of a selection.</span>
<a href="#l6.228"></a><span id="l6.228">  */</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-function disabled_test_delete_multiple_messages_with_first_selected_message_open() {</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+function test_delete_multiple_messages_with_first_selected_message_open() {</span>
<a href="#l6.231"></a><span id="l6.231">   // Open up 2 in a message tab, background tab, and message window.</span>
<a href="#l6.232"></a><span id="l6.232">   _open_message_in_all_four_display_mechanisms_helper(multipleDeletionFolder1,</span>
<a href="#l6.233"></a><span id="l6.233">                                                       2);</span>
<a href="#l6.234"></a><span id="l6.234"> </span>
<a href="#l6.235"></a><span id="l6.235">   // We'll select 2-5, 8, 9 and 10. We expect 6 to be the next displayed</span>
<a href="#l6.236"></a><span id="l6.236">   // message.</span>
<a href="#l6.237"></a><span id="l6.237">   select_click_row(2);</span>
<a href="#l6.238"></a><span id="l6.238">   select_shift_click_row(5);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineat">@@ -502,17 +501,17 @@ function disabled_test_delete_multiple_m</span>
<a href="#l6.240"></a><span id="l6.240">   close_tab(tabMessageBackground);</span>
<a href="#l6.241"></a><span id="l6.241">   switch_tab(tabFolder);</span>
<a href="#l6.242"></a><span id="l6.242"> }</span>
<a href="#l6.243"></a><span id="l6.243"> </span>
<a href="#l6.244"></a><span id="l6.244"> /**</span>
<a href="#l6.245"></a><span id="l6.245">  * Test deleting multiple messages in a folder tab, with message displays open</span>
<a href="#l6.246"></a><span id="l6.246">  * to somewhere in the middle of a selection.</span>
<a href="#l6.247"></a><span id="l6.247">  */</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-function disabled_test_delete_multiple_messages_with_nth_selected_message_open() {</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+function test_delete_multiple_messages_with_nth_selected_message_open() {</span>
<a href="#l6.250"></a><span id="l6.250">   // Open up 9 in a message tab, background tab, and message window.</span>
<a href="#l6.251"></a><span id="l6.251">   _open_message_in_all_four_display_mechanisms_helper(multipleDeletionFolder1,</span>
<a href="#l6.252"></a><span id="l6.252">                                                       9);</span>
<a href="#l6.253"></a><span id="l6.253"> </span>
<a href="#l6.254"></a><span id="l6.254">   // We'll select 2-5, 8, 9 and 10. We expect 11 to be the next displayed</span>
<a href="#l6.255"></a><span id="l6.255">   // message.</span>
<a href="#l6.256"></a><span id="l6.256">   select_click_row(2);</span>
<a href="#l6.257"></a><span id="l6.257">   select_shift_click_row(5);</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineat">@@ -538,17 +537,17 @@ function disabled_test_delete_multiple_m</span>
<a href="#l6.259"></a><span id="l6.259">   close_tab(tabMessageBackground);</span>
<a href="#l6.260"></a><span id="l6.260">   switch_tab(tabFolder);</span>
<a href="#l6.261"></a><span id="l6.261"> }</span>
<a href="#l6.262"></a><span id="l6.262"> </span>
<a href="#l6.263"></a><span id="l6.263"> /**</span>
<a href="#l6.264"></a><span id="l6.264">  * Test deleting multiple messages in a folder tab, with message displays open</span>
<a href="#l6.265"></a><span id="l6.265">  * to the end of a selection.</span>
<a href="#l6.266"></a><span id="l6.266">  */</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-function disabled_test_delete_multiple_messages_with_last_selected_message_open() {</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+function test_delete_multiple_messages_with_last_selected_message_open() {</span>
<a href="#l6.269"></a><span id="l6.269">   // Open up 10 in a message tab, background tab, and message window.</span>
<a href="#l6.270"></a><span id="l6.270">   _open_message_in_all_four_display_mechanisms_helper(multipleDeletionFolder1,</span>
<a href="#l6.271"></a><span id="l6.271">                                                       9);</span>
<a href="#l6.272"></a><span id="l6.272"> </span>
<a href="#l6.273"></a><span id="l6.273">   // We'll select 2-5, 8, 9 and 10. We expect 11 to be the next displayed</span>
<a href="#l6.274"></a><span id="l6.274">   // message.</span>
<a href="#l6.275"></a><span id="l6.275">   select_click_row(2);</span>
<a href="#l6.276"></a><span id="l6.276">   select_shift_click_row(5);</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineat">@@ -573,17 +572,17 @@ function disabled_test_delete_multiple_m</span>
<a href="#l6.278"></a><span id="l6.278">   close_tab(tabMessageBackground);</span>
<a href="#l6.279"></a><span id="l6.279">   switch_tab(tabFolder);</span>
<a href="#l6.280"></a><span id="l6.280"> }</span>
<a href="#l6.281"></a><span id="l6.281"> </span>
<a href="#l6.282"></a><span id="l6.282"> /**</span>
<a href="#l6.283"></a><span id="l6.283">  * Test deleting multiple messages in a folder tab (including the last one!),</span>
<a href="#l6.284"></a><span id="l6.284">  * with message displays open to the beginning of a selection.</span>
<a href="#l6.285"></a><span id="l6.285">  */</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-function disabled_test_delete_multiple_messages_including_the_last_one_with_first_open() {</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+function test_delete_multiple_messages_including_the_last_one_with_first_open() {</span>
<a href="#l6.288"></a><span id="l6.288">   // 10 messages in this folder. Open up message 1 everywhere.</span>
<a href="#l6.289"></a><span id="l6.289">   _open_message_in_all_four_display_mechanisms_helper(multipleDeletionFolder2,</span>
<a href="#l6.290"></a><span id="l6.290">                                                       1);</span>
<a href="#l6.291"></a><span id="l6.291"> </span>
<a href="#l6.292"></a><span id="l6.292">   // We'll select 1-4, 7, 8 and 9. We expect 5 to be the next displayed message.</span>
<a href="#l6.293"></a><span id="l6.293">   select_click_row(1);</span>
<a href="#l6.294"></a><span id="l6.294">   select_shift_click_row(4);</span>
<a href="#l6.295"></a><span id="l6.295">   select_control_click_row(7);</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineat">@@ -603,17 +602,17 @@ function disabled_test_delete_multiple_m</span>
<a href="#l6.297"></a><span id="l6.297">   close_tab(tabMessageBackground);</span>
<a href="#l6.298"></a><span id="l6.298">   switch_tab(tabFolder);</span>
<a href="#l6.299"></a><span id="l6.299"> }</span>
<a href="#l6.300"></a><span id="l6.300"> </span>
<a href="#l6.301"></a><span id="l6.301"> /**</span>
<a href="#l6.302"></a><span id="l6.302">  * Test deleting multiple messages in a folder tab (including the last one!),</span>
<a href="#l6.303"></a><span id="l6.303">  * with message displays open to the middle of a selection.</span>
<a href="#l6.304"></a><span id="l6.304">  */</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-function disabled_test_delete_multiple_messages_including_the_last_one_with_nth_open() {</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+function test_delete_multiple_messages_including_the_last_one_with_nth_open() {</span>
<a href="#l6.307"></a><span id="l6.307">   // 10 messages in this folder. Open up message 7 everywhere.</span>
<a href="#l6.308"></a><span id="l6.308">   _open_message_in_all_four_display_mechanisms_helper(multipleDeletionFolder3,</span>
<a href="#l6.309"></a><span id="l6.309">                                                       7);</span>
<a href="#l6.310"></a><span id="l6.310"> </span>
<a href="#l6.311"></a><span id="l6.311">   // We'll select 1-4, 7, 8 and 9. We expect 6 to be the next displayed message.</span>
<a href="#l6.312"></a><span id="l6.312">   select_click_row(1);</span>
<a href="#l6.313"></a><span id="l6.313">   select_shift_click_row(4);</span>
<a href="#l6.314"></a><span id="l6.314">   select_control_click_row(7);</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineat">@@ -638,17 +637,17 @@ function disabled_test_delete_multiple_m</span>
<a href="#l6.316"></a><span id="l6.316">   close_tab(tabMessageBackground);</span>
<a href="#l6.317"></a><span id="l6.317">   switch_tab(tabFolder);</span>
<a href="#l6.318"></a><span id="l6.318"> }</span>
<a href="#l6.319"></a><span id="l6.319"> </span>
<a href="#l6.320"></a><span id="l6.320"> /**</span>
<a href="#l6.321"></a><span id="l6.321">  * Test deleting multiple messages in a folder tab (including the last one!),</span>
<a href="#l6.322"></a><span id="l6.322">  * with message displays open to the end of a selection.</span>
<a href="#l6.323"></a><span id="l6.323">  */</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-function disabled_test_delete_multiple_messages_including_the_last_one_with_last_open() {</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+function test_delete_multiple_messages_including_the_last_one_with_last_open() {</span>
<a href="#l6.326"></a><span id="l6.326">   // 10 messages in this folder. Open up message 9 everywhere.</span>
<a href="#l6.327"></a><span id="l6.327">   _open_message_in_all_four_display_mechanisms_helper(multipleDeletionFolder4,</span>
<a href="#l6.328"></a><span id="l6.328">                                                       9);</span>
<a href="#l6.329"></a><span id="l6.329"> </span>
<a href="#l6.330"></a><span id="l6.330">   // We'll select 1-4, 7, 8 and 9. We expect 6 to be the next displayed message.</span>
<a href="#l6.331"></a><span id="l6.331">   select_click_row(1);</span>
<a href="#l6.332"></a><span id="l6.332">   select_shift_click_row(4);</span>
<a href="#l6.333"></a><span id="l6.333">   select_control_click_row(7);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -805,20 +805,20 @@ function assert_number_of_tabs_open(aNum</span>
<a href="#l7.4"></a><span id="l7.4">  */</span>
<a href="#l7.5"></a><span id="l7.5"> function assert_tab_titled_from(aTab, aWhat) {</span>
<a href="#l7.6"></a><span id="l7.6">   let text;</span>
<a href="#l7.7"></a><span id="l7.7">   if (aWhat instanceof Ci.nsIMsgFolder)</span>
<a href="#l7.8"></a><span id="l7.8">     text = aWhat.prettyName;</span>
<a href="#l7.9"></a><span id="l7.9">   else if (aWhat instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l7.10"></a><span id="l7.10">     text = aWhat.mime2DecodedSubject;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  if (!aTab.title.includes(text))</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    mark_failure([&quot;Tab title of tab&quot;, aTab,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-                  &quot;should include '&quot; + text + &quot;' but does not.&quot; +</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-                  &quot; (Current title: '&quot; + aTab.title + &quot;')&quot;]);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  mc.waitFor(</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    () =&gt; aTab.title.includes(text),</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    `Tab title should include '${text}' but does not. (Current title: '${aTab.title}')`</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  );</span>
<a href="#l7.20"></a><span id="l7.20"> }</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> /**</span>
<a href="#l7.23"></a><span id="l7.23">  * Assert that the given tab's title is what is given.</span>
<a href="#l7.24"></a><span id="l7.24">  *</span>
<a href="#l7.25"></a><span id="l7.25">  * @param aTab The tab to check.</span>
<a href="#l7.26"></a><span id="l7.26">  * @param aTitle The title to check.</span>
<a href="#l7.27"></a><span id="l7.27">  */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

