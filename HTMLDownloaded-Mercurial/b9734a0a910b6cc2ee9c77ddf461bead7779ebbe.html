<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 731:b9734a0a910b6cc2ee9c77ddf461bead7779ebbe</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b9734a0a910b6cc2ee9c77ddf461bead7779ebbe" />
<meta property="og:url" content="/comm-central/rev/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe" />
<meta property="og:description" content="more work preparing for cross-folder threading, r/sr=neil 379806" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b9734a0a910b6cc2ee9c77ddf461bead7779ebbe 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe">shortlog</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe">files</a> |
changeset |
<a href="/comm-central/raw-rev/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe">raw</a>  | <a href="/comm-central/archive/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
more work preparing for cross-folder threading, r/sr=neil 379806
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 27 Oct 2008 11:03:39 -0700</td></tr>

<tr>
 <td>changeset 731</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe">b9734a0a910b6cc2ee9c77ddf461bead7779ebbe</a></td>
</tr>



<tr>
<td>parent 730</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/746364a208e162dc5773d2dc98b3a063e499c408">746364a208e162dc5773d2dc98b3a063e499c408</a>
</td>
</tr>

<tr>
<td>child 732</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cf14a12c282ee6b1bc412c8dac4c63d9c1feace6">cf14a12c282ee6b1bc412c8dac4c63d9c1feace6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe">658</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 27 Oct 2008 18:03:34 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b9734a0a910b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe&newProject=comm-central&newRevision=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe&newProject=comm-central&newRevision=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe&newProject=comm-central&newRevision=b9734a0a910b6cc2ee9c77ddf461bead7779ebbe&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=379806">379806</a></td></tr>




</table></div>

<div class="page_body description">more work preparing for cross-folder threading, r/sr=neil 379806</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.h">mailnews/base/src/nsMsgDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.h">file</a> |
<a href="/comm-central/annotate/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.h">annotate</a> |
<a href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.h">diff</a> |
<a href="/comm-central/comparison/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.h">comparison</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgGroupThread.cpp">mailnews/base/src/nsMsgGroupThread.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgGroupThread.cpp">file</a> |
<a href="/comm-central/annotate/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgGroupThread.cpp">annotate</a> |
<a href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgGroupThread.cpp">diff</a> |
<a href="/comm-central/comparison/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgGroupThread.cpp">comparison</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgGroupThread.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgQuickSearchDBView.cpp">mailnews/base/src/nsMsgQuickSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgQuickSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgQuickSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgQuickSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgQuickSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgQuickSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.cpp">mailnews/base/src/nsMsgSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.h">mailnews/base/src/nsMsgSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.h">file</a> |
<a href="/comm-central/annotate/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.h">comparison</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">file</a> |
<a href="/comm-central/annotate/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">annotate</a> |
<a href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">diff</a> |
<a href="/comm-central/comparison/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">comparison</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">mailnews/base/src/nsMsgXFVirtualFolderDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">file</a> |
<a href="/comm-central/annotate/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">annotate</a> |
<a href="/comm-central/diff/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">diff</a> |
<a href="/comm-central/comparison/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">comparison</a> |
<a href="/comm-central/log/b9734a0a910b6cc2ee9c77ddf461bead7779ebbe/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3188,18 +3188,17 @@ void nsMsgDBView::ReverseThreads()</span>
<a href="#l1.4"></a><span id="l1.4">     m_flags.SwapElements(newFlagArray);</span>
<a href="#l1.5"></a><span id="l1.5">     m_levels.SwapElements(newLevelArray);</span>
<a href="#l1.6"></a><span id="l1.6"> }</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> void nsMsgDBView::ReverseSort()</span>
<a href="#l1.9"></a><span id="l1.9"> {</span>
<a href="#l1.10"></a><span id="l1.10">     PRUint32 topIndex = GetSize();</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    nsCOMPtr &lt;nsISupportsArray&gt; folders;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    GetFolders(getter_AddRefs(folders));</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">     // go up half the array swapping values</span>
<a href="#l1.17"></a><span id="l1.17">     for (PRUint32 bottomIndex = 0; bottomIndex &lt; --topIndex; bottomIndex++) </span>
<a href="#l1.18"></a><span id="l1.18">     {</span>
<a href="#l1.19"></a><span id="l1.19">         // swap flags</span>
<a href="#l1.20"></a><span id="l1.20">         PRUint32 tempFlags = m_flags[bottomIndex];</span>
<a href="#l1.21"></a><span id="l1.21">         m_flags[bottomIndex] = m_flags[topIndex];</span>
<a href="#l1.22"></a><span id="l1.22">         m_flags[topIndex] = tempFlags;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -3208,44 +3207,25 @@ void nsMsgDBView::ReverseSort()</span>
<a href="#l1.24"></a><span id="l1.24">         nsMsgKey tempKey = m_keys[bottomIndex];</span>
<a href="#l1.25"></a><span id="l1.25">         m_keys[bottomIndex] = m_keys[topIndex];</span>
<a href="#l1.26"></a><span id="l1.26">         m_keys[topIndex] = tempKey;</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">         if (folders)</span>
<a href="#l1.29"></a><span id="l1.29">         {</span>
<a href="#l1.30"></a><span id="l1.30">             // swap folders --</span>
<a href="#l1.31"></a><span id="l1.31">             // needed when search is done across multiple folders</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; tmpSupports = dont_AddRef(folders-&gt;ElementAt(bottomIndex));</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; topSupports = dont_AddRef(folders-&gt;ElementAt(topIndex));</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-            folders-&gt;SetElementAt(bottomIndex, topSupports);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-            folders-&gt;SetElementAt(topIndex, tmpSupports);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+            nsIMsgFolder *bottomFolder = folders-&gt;ObjectAt(bottomIndex);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+            nsIMsgFolder *topFolder = folders-&gt;ObjectAt(topIndex);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+            folders-&gt;ReplaceObjectAt(topFolder, bottomIndex);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+            folders-&gt;ReplaceObjectAt(bottomFolder, topIndex);</span>
<a href="#l1.40"></a><span id="l1.40">         }</span>
<a href="#l1.41"></a><span id="l1.41">         // no need to swap elements in m_levels; since we only call</span>
<a href="#l1.42"></a><span id="l1.42">         // ReverseSort in non-threaded mode, m_levels are all the same.</span>
<a href="#l1.43"></a><span id="l1.43">     }</span>
<a href="#l1.44"></a><span id="l1.44"> }</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-struct IdDWord</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-{</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-    nsMsgKey    id;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-    PRUint32    bits;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-    PRUint32    dword;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-    nsIMsgFolder* folder;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-};</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-struct IdKey : public IdDWord</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-{</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-    PRUint8     key[1];</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-};</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-struct IdKeyPtr : public IdDWord</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-{</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-    PRUint8     *key;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-};</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-</span>
<a href="#l1.64"></a><span id="l1.64"> int PR_CALLBACK</span>
<a href="#l1.65"></a><span id="l1.65"> nsMsgDBView::FnSortIdKey(const void *pItem1, const void *pItem2, void *privateData)</span>
<a href="#l1.66"></a><span id="l1.66"> {</span>
<a href="#l1.67"></a><span id="l1.67">     PRInt32 retVal = 0;</span>
<a href="#l1.68"></a><span id="l1.68">     nsresult rv;</span>
<a href="#l1.69"></a><span id="l1.69">     viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.70"></a><span id="l1.70"> </span>
<a href="#l1.71"></a><span id="l1.71">     IdKey** p1 = (IdKey**)pItem1;</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineat">@@ -3287,20 +3267,20 @@ nsMsgDBView::FnSortIdKeyPtr(const void *</span>
<a href="#l1.73"></a><span id="l1.73">   if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.74"></a><span id="l1.74">     return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.75"></a><span id="l1.75">             (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l1.76"></a><span id="l1.76">   else</span>
<a href="#l1.77"></a><span id="l1.77">     return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id, (*p1)-&gt;folder, (*p2)-&gt;id, (*p2)-&gt;folder, sortInfo);</span>
<a href="#l1.78"></a><span id="l1.78"> }</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80"> int PR_CALLBACK</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-nsMsgDBView::FnSortIdDWord(const void *pItem1, const void *pItem2, void *privateData)</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-{</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-  IdDWord** p1 = (IdDWord**)pItem1;</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-  IdDWord** p2 = (IdDWord**)pItem2;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+nsMsgDBView::FnSortIdUint32(const void *pItem1, const void *pItem2, void *privateData)</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+{</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+  IdUint32** p1 = (IdUint32**)pItem1;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+  IdUint32** p2 = (IdUint32**)pItem2;</span>
<a href="#l1.89"></a><span id="l1.89">   viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91">   if ((*p1)-&gt;dword &gt; (*p2)-&gt;dword)</span>
<a href="#l1.92"></a><span id="l1.92">     return (sortInfo-&gt;ascendingSort) ? 1 : -1;</span>
<a href="#l1.93"></a><span id="l1.93">   else if ((*p1)-&gt;dword &lt; (*p2)-&gt;dword)</span>
<a href="#l1.94"></a><span id="l1.94">       return (sortInfo-&gt;ascendingSort) ? -1 : 1;</span>
<a href="#l1.95"></a><span id="l1.95">   if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.96"></a><span id="l1.96">     return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineat">@@ -3757,17 +3737,17 @@ PRInt32  nsMsgDBView::SecondarySort(nsMs</span>
<a href="#l1.98"></a><span id="l1.98">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.99"></a><span id="l1.99">       comparisonFun = FnSortIdKeyPtr;</span>
<a href="#l1.100"></a><span id="l1.100">       break;</span>
<a href="#l1.101"></a><span id="l1.101">     case kU32:</span>
<a href="#l1.102"></a><span id="l1.102">       if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.103"></a><span id="l1.103">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.104"></a><span id="l1.104">       else</span>
<a href="#l1.105"></a><span id="l1.105">         GetLongField(hdr1, sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-      comparisonFun = FnSortIdDWord;</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+      comparisonFun = FnSortIdUint32;</span>
<a href="#l1.108"></a><span id="l1.108">       break;</span>
<a href="#l1.109"></a><span id="l1.109">     default:</span>
<a href="#l1.110"></a><span id="l1.110">       return 0;</span>
<a href="#l1.111"></a><span id="l1.111">   }</span>
<a href="#l1.112"></a><span id="l1.112">   PRBool saveAscendingSort = comparisonContext-&gt;ascendingSort;</span>
<a href="#l1.113"></a><span id="l1.113">   comparisonContext-&gt;isSecondarySort = PR_TRUE;</span>
<a href="#l1.114"></a><span id="l1.114">   comparisonContext-&gt;ascendingSort = (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.115"></a><span id="l1.115">   if (fieldType == kCollationKey)</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineat">@@ -3850,18 +3830,17 @@ NS_IMETHODIMP nsMsgDBView::Sort(nsMsgVie</span>
<a href="#l1.117"></a><span id="l1.117">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.118"></a><span id="l1.118"> </span>
<a href="#l1.119"></a><span id="l1.119">   nsVoidArray ptrs;</span>
<a href="#l1.120"></a><span id="l1.120">   PRUint32 arraySize = GetSize();</span>
<a href="#l1.121"></a><span id="l1.121"> </span>
<a href="#l1.122"></a><span id="l1.122">   if (!arraySize)</span>
<a href="#l1.123"></a><span id="l1.123">     return NS_OK;</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  nsCOMPtr &lt;nsISupportsArray&gt; folders;</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-  GetFolders(getter_AddRefs(folders));</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">   IdKey** pPtrBase = (IdKey**)PR_Malloc(arraySize * sizeof(IdKey*));</span>
<a href="#l1.130"></a><span id="l1.130">   NS_ASSERTION(pPtrBase, &quot;out of memory, can't sort&quot;);</span>
<a href="#l1.131"></a><span id="l1.131">   if (!pPtrBase) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.132"></a><span id="l1.132">   ptrs.AppendElement((void *)pPtrBase); // remember this pointer so we can free it later</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134">   // build up the beast, so we can sort it.</span>
<a href="#l1.135"></a><span id="l1.135">   PRUint32 numSoFar = 0;</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineat">@@ -3954,29 +3933,22 @@ NS_IMETHODIMP nsMsgDBView::Sort(nsMsgVie</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">     // now store this entry away in the allocated memory</span>
<a href="#l1.139"></a><span id="l1.139">     IdKey *info = (IdKey*)pTemp;</span>
<a href="#l1.140"></a><span id="l1.140">     pPtrBase[numSoFar] = info;</span>
<a href="#l1.141"></a><span id="l1.141">     info-&gt;id = thisKey;</span>
<a href="#l1.142"></a><span id="l1.142">     info-&gt;bits = m_flags[numSoFar];</span>
<a href="#l1.143"></a><span id="l1.143">     info-&gt;dword = longValue;</span>
<a href="#l1.144"></a><span id="l1.144">     //info-&gt;pad = 0;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-    if (folders)</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-    {</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; curFolder = do_QueryElementAt(folders, numSoFar);</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-      info-&gt;folder = curFolder;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-    }</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-    else</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-      info-&gt;folder = m_folder;</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+    info-&gt;folder = folders ? folders-&gt;ObjectAt(numSoFar) : m_folder.get();</span>
<a href="#l1.154"></a><span id="l1.154"> </span>
<a href="#l1.155"></a><span id="l1.155">     memcpy(info-&gt;key, keyValue, actualFieldLen);</span>
<a href="#l1.156"></a><span id="l1.156">     //In order to align memory for systems that require it, such as HP-UX</span>
<a href="#l1.157"></a><span id="l1.157">     //calculate the correct value to pad the actualFieldLen value</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-    const PRUint32 align = sizeof(IdKey) - sizeof(IdDWord) - 1;</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+    const PRUint32 align = sizeof(IdKey) - sizeof(IdUint32) - 1;</span>
<a href="#l1.160"></a><span id="l1.160">     actualFieldLen = (actualFieldLen + align) &amp; ~align;</span>
<a href="#l1.161"></a><span id="l1.161"> </span>
<a href="#l1.162"></a><span id="l1.162">     pTemp += keyOffset + actualFieldLen;</span>
<a href="#l1.163"></a><span id="l1.163">     ++numSoFar;</span>
<a href="#l1.164"></a><span id="l1.164">     PR_Free(keyValue);</span>
<a href="#l1.165"></a><span id="l1.165">   }</span>
<a href="#l1.166"></a><span id="l1.166"> </span>
<a href="#l1.167"></a><span id="l1.167">   viewSortInfo qsPrivateData;</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineat">@@ -3993,32 +3965,32 @@ NS_IMETHODIMP nsMsgDBView::Sort(nsMsgVie</span>
<a href="#l1.169"></a><span id="l1.169">   {</span>
<a href="#l1.170"></a><span id="l1.170">     // do the sort</span>
<a href="#l1.171"></a><span id="l1.171">     switch (fieldType)</span>
<a href="#l1.172"></a><span id="l1.172">     {</span>
<a href="#l1.173"></a><span id="l1.173">       case kCollationKey:</span>
<a href="#l1.174"></a><span id="l1.174">         NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey*), FnSortIdKey, &amp;qsPrivateData);</span>
<a href="#l1.175"></a><span id="l1.175">         break;</span>
<a href="#l1.176"></a><span id="l1.176">       case kU32:</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-        NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey*), FnSortIdDWord, &amp;qsPrivateData);</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+        NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey*), FnSortIdUint32, &amp;qsPrivateData);</span>
<a href="#l1.179"></a><span id="l1.179">         break;</span>
<a href="#l1.180"></a><span id="l1.180">       default:</span>
<a href="#l1.181"></a><span id="l1.181">         NS_ASSERTION(0, &quot;not supposed to get here&quot;);</span>
<a href="#l1.182"></a><span id="l1.182">         break;</span>
<a href="#l1.183"></a><span id="l1.183">     }</span>
<a href="#l1.184"></a><span id="l1.184">   }</span>
<a href="#l1.185"></a><span id="l1.185"> </span>
<a href="#l1.186"></a><span id="l1.186">   // now put the IDs into the array in proper order</span>
<a href="#l1.187"></a><span id="l1.187">   for (PRUint32 i = 0; i &lt; numSoFar; i++)</span>
<a href="#l1.188"></a><span id="l1.188">   {</span>
<a href="#l1.189"></a><span id="l1.189">     m_keys[i] = pPtrBase[i]-&gt;id;</span>
<a href="#l1.190"></a><span id="l1.190">     m_flags[i] = pPtrBase[i]-&gt;bits;</span>
<a href="#l1.191"></a><span id="l1.191"> </span>
<a href="#l1.192"></a><span id="l1.192">     if (folders)</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-      folders-&gt;SetElementAt(i, pPtrBase[i]-&gt;folder);</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+      folders-&gt;ReplaceObjectAt(pPtrBase[i]-&gt;folder, i);</span>
<a href="#l1.195"></a><span id="l1.195">   }</span>
<a href="#l1.196"></a><span id="l1.196"> </span>
<a href="#l1.197"></a><span id="l1.197">   m_sortType = sortType;</span>
<a href="#l1.198"></a><span id="l1.198">   m_sortOrder = sortOrder;</span>
<a href="#l1.199"></a><span id="l1.199"> </span>
<a href="#l1.200"></a><span id="l1.200">   // free all the memory we allocated</span>
<a href="#l1.201"></a><span id="l1.201">   FreeAll(&amp;ptrs);</span>
<a href="#l1.202"></a><span id="l1.202"> </span>
<a href="#l1.203"></a><span id="l1.203" class="difflineat">@@ -4367,37 +4339,34 @@ nsresult nsMsgDBView::ExpandAll()</span>
<a href="#l1.204"></a><span id="l1.204"> nsresult nsMsgDBView::GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **pThread)</span>
<a href="#l1.205"></a><span id="l1.205"> {</span>
<a href="#l1.206"></a><span id="l1.206">   return m_db-&gt;GetThreadContainingMsgHdr(msgHdr, pThread);</span>
<a href="#l1.207"></a><span id="l1.207"> }</span>
<a href="#l1.208"></a><span id="l1.208"> </span>
<a href="#l1.209"></a><span id="l1.209"> nsresult nsMsgDBView::ExpandByIndex(nsMsgViewIndex index, PRUint32 *pNumExpanded)</span>
<a href="#l1.210"></a><span id="l1.210"> {</span>
<a href="#l1.211"></a><span id="l1.211">   PRUint32      flags = m_flags[index];</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-  nsMsgKey    firstIdInThread;</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-  //nsMsgKey        startMsg = nsMsgKey_None;</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-  nsresult    rv = NS_OK;</span>
<a href="#l1.215"></a><span id="l1.215">   PRUint32      numExpanded = 0;</span>
<a href="#l1.216"></a><span id="l1.216"> </span>
<a href="#l1.217"></a><span id="l1.217">   NS_ASSERTION(flags &amp; MSG_FLAG_ELIDED, &quot;can't expand an already expanded thread&quot;);</span>
<a href="#l1.218"></a><span id="l1.218">   flags &amp;= ~MSG_FLAG_ELIDED;</span>
<a href="#l1.219"></a><span id="l1.219"> </span>
<a href="#l1.220"></a><span id="l1.220">   if ((PRUint32) index &gt; m_keys.Length())</span>
<a href="#l1.221"></a><span id="l1.221">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.222"></a><span id="l1.222"> </span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-  firstIdInThread = m_keys[index];</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+  nsMsgKey firstIdInThread = m_keys[index];</span>
<a href="#l1.225"></a><span id="l1.225">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.226"></a><span id="l1.226">   nsCOMPtr &lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.227"></a><span id="l1.227">   m_db-&gt;GetMsgHdrForKey(firstIdInThread, getter_AddRefs(msgHdr));</span>
<a href="#l1.228"></a><span id="l1.228">   if (msgHdr == nsnull)</span>
<a href="#l1.229"></a><span id="l1.229">   {</span>
<a href="#l1.230"></a><span id="l1.230">     NS_ASSERTION(PR_FALSE, &quot;couldn't find message to expand&quot;);</span>
<a href="#l1.231"></a><span id="l1.231">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.232"></a><span id="l1.232">   }</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-  rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(pThread));</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+  nsresult rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(pThread));</span>
<a href="#l1.235"></a><span id="l1.235">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.236"></a><span id="l1.236">   m_flags[index] = flags;</span>
<a href="#l1.237"></a><span id="l1.237">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.238"></a><span id="l1.238">   if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l1.239"></a><span id="l1.239">   {</span>
<a href="#l1.240"></a><span id="l1.240">     if (flags &amp; MSG_FLAG_READ)</span>
<a href="#l1.241"></a><span id="l1.241">       m_levels.AppendElement(0);  // keep top level hdr in thread, even though read.</span>
<a href="#l1.242"></a><span id="l1.242">     rv = ListUnreadIdsInThread(pThread,  index, &amp;numExpanded);</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineat">@@ -4564,17 +4533,17 @@ nsMsgDBView::GetIndexForThread(nsIMsgDBH</span>
<a href="#l1.244"></a><span id="l1.244">       retStatus = FnSortIdKeyPtr(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.245"></a><span id="l1.245">     }</span>
<a href="#l1.246"></a><span id="l1.246">     else if (fieldType == kU32)</span>
<a href="#l1.247"></a><span id="l1.247">     {</span>
<a href="#l1.248"></a><span id="l1.248">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.249"></a><span id="l1.249">         EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.250"></a><span id="l1.250">       else</span>
<a href="#l1.251"></a><span id="l1.251">         GetLongField(tryHdr, m_sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-      retStatus = FnSortIdDWord(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+      retStatus = FnSortIdUint32(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.254"></a><span id="l1.254">     }</span>
<a href="#l1.255"></a><span id="l1.255">     if (retStatus == 0)</span>
<a href="#l1.256"></a><span id="l1.256">     {</span>
<a href="#l1.257"></a><span id="l1.257">       highIndex = tryIndex;</span>
<a href="#l1.258"></a><span id="l1.258">       break;</span>
<a href="#l1.259"></a><span id="l1.259">     }</span>
<a href="#l1.260"></a><span id="l1.260"> </span>
<a href="#l1.261"></a><span id="l1.261">     if (retStatus &lt; 0)</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineat">@@ -4591,38 +4560,36 @@ nsMsgDBView::GetIndexForThread(nsIMsgDBH</span>
<a href="#l1.263"></a><span id="l1.263">   }</span>
<a href="#l1.264"></a><span id="l1.264"> </span>
<a href="#l1.265"></a><span id="l1.265">   PR_Free(EntryInfo1.key);</span>
<a href="#l1.266"></a><span id="l1.266">   PR_Free(EntryInfo2.key);</span>
<a href="#l1.267"></a><span id="l1.267">   return highIndex;</span>
<a href="#l1.268"></a><span id="l1.268"> }</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270"> nsMsgViewIndex nsMsgDBView::GetInsertIndexHelper(nsIMsgDBHdr *msgHdr, nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+                                                 nsCOMArray&lt;nsIMsgFolder&gt; *folders,</span>
<a href="#l1.272"></a><span id="l1.272">                                                  nsMsgViewSortOrderValue sortOrder, nsMsgViewSortTypeValue sortType)</span>
<a href="#l1.273"></a><span id="l1.273"> {</span>
<a href="#l1.274"></a><span id="l1.274">   nsMsgViewIndex highIndex = keys.Length();</span>
<a href="#l1.275"></a><span id="l1.275">   nsMsgViewIndex lowIndex = 0;</span>
<a href="#l1.276"></a><span id="l1.276">   IdKeyPtr EntryInfo1, EntryInfo2;</span>
<a href="#l1.277"></a><span id="l1.277">   EntryInfo1.key = nsnull;</span>
<a href="#l1.278"></a><span id="l1.278">   EntryInfo2.key = nsnull;</span>
<a href="#l1.279"></a><span id="l1.279"> </span>
<a href="#l1.280"></a><span id="l1.280">   nsresult rv;</span>
<a href="#l1.281"></a><span id="l1.281">   PRUint16  maxLen;</span>
<a href="#l1.282"></a><span id="l1.282">   eFieldType fieldType;</span>
<a href="#l1.283"></a><span id="l1.283">   rv = GetFieldTypeAndLenForSort(sortType, &amp;maxLen, &amp;fieldType);</span>
<a href="#l1.284"></a><span id="l1.284">   const void *pValue1 = &amp;EntryInfo1, *pValue2 = &amp;EntryInfo2;</span>
<a href="#l1.285"></a><span id="l1.285"> </span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-  EntryInfo1.folder = m_folder;</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-  nsCOMPtr &lt;nsISupportsArray&gt; folders;</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-  GetFolders(getter_AddRefs(folders));</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-  </span>
<a href="#l1.290"></a><span id="l1.290">   int (* PR_CALLBACK comparisonFun) (const void *pItem1, const void *pItem2, void *privateData) = nsnull;</span>
<a href="#l1.291"></a><span id="l1.291">   int retStatus = 0;</span>
<a href="#l1.292"></a><span id="l1.292">   msgHdr-&gt;GetMessageKey(&amp;EntryInfo1.id);</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+  msgHdr-&gt;GetFolder(&amp;EntryInfo1.folder);</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+  EntryInfo1.folder-&gt;Release();</span>
<a href="#l1.296"></a><span id="l1.296">   //check if a custom column handler exists. If it does then grab it and pass it in</span>
<a href="#l1.297"></a><span id="l1.297">   //to either GetCollationKey or GetLongField</span>
<a href="#l1.298"></a><span id="l1.298">   nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandlerFromDBInfo();</span>
<a href="#l1.299"></a><span id="l1.299"> </span>
<a href="#l1.300"></a><span id="l1.300">   viewSortInfo comparisonContext;</span>
<a href="#l1.301"></a><span id="l1.301">   comparisonContext.view = this;</span>
<a href="#l1.302"></a><span id="l1.302">   comparisonContext.isSecondarySort = PR_FALSE;</span>
<a href="#l1.303"></a><span id="l1.303">   comparisonContext.ascendingSort = (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineat">@@ -4634,35 +4601,30 @@ nsMsgViewIndex nsMsgDBView::GetInsertInd</span>
<a href="#l1.305"></a><span id="l1.305">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.306"></a><span id="l1.306">       comparisonFun = FnSortIdKeyPtr;</span>
<a href="#l1.307"></a><span id="l1.307">       break;</span>
<a href="#l1.308"></a><span id="l1.308">     case kU32:</span>
<a href="#l1.309"></a><span id="l1.309">       if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.310"></a><span id="l1.310">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.311"></a><span id="l1.311">       else</span>
<a href="#l1.312"></a><span id="l1.312">         GetLongField(msgHdr, sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-      comparisonFun = FnSortIdDWord;</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+      comparisonFun = FnSortIdUint32;</span>
<a href="#l1.315"></a><span id="l1.315">       break;</span>
<a href="#l1.316"></a><span id="l1.316">     default:</span>
<a href="#l1.317"></a><span id="l1.317">       return highIndex;</span>
<a href="#l1.318"></a><span id="l1.318">   }</span>
<a href="#l1.319"></a><span id="l1.319">   while (highIndex &gt; lowIndex)</span>
<a href="#l1.320"></a><span id="l1.320">   {</span>
<a href="#l1.321"></a><span id="l1.321">     nsMsgViewIndex tryIndex = (lowIndex + highIndex - 1) / 2;</span>
<a href="#l1.322"></a><span id="l1.322">     EntryInfo2.id = keys[tryIndex];</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-    if (folders)</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-    {</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; curFolder = do_QueryElementAt(folders, tryIndex);</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-      EntryInfo2.folder = curFolder;</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-    }</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-    else</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-       EntryInfo2.folder = m_folder;</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+    EntryInfo2.folder = folders ? folders-&gt;ObjectAt(tryIndex) : m_folder.get();</span>
<a href="#l1.331"></a><span id="l1.331">     </span>
<a href="#l1.332"></a><span id="l1.332">     nsCOMPtr &lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.333"></a><span id="l1.333">     nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+    // ### this should get the db from the folder...</span>
<a href="#l1.335"></a><span id="l1.335">     GetDBForViewIndex(tryIndex, getter_AddRefs(db));</span>
<a href="#l1.336"></a><span id="l1.336">     if (db)</span>
<a href="#l1.337"></a><span id="l1.337">       rv = db-&gt;GetMsgHdrForKey(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.338"></a><span id="l1.338">     if (!tryHdr)</span>
<a href="#l1.339"></a><span id="l1.339">       break;</span>
<a href="#l1.340"></a><span id="l1.340">     if (fieldType == kCollationKey)</span>
<a href="#l1.341"></a><span id="l1.341">     {</span>
<a href="#l1.342"></a><span id="l1.342">       PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineat">@@ -4705,17 +4667,17 @@ nsMsgViewIndex nsMsgDBView::GetInsertInd</span>
<a href="#l1.344"></a><span id="l1.344">   if (!GetSize())</span>
<a href="#l1.345"></a><span id="l1.345">     return 0;</span>
<a href="#l1.346"></a><span id="l1.346"> </span>
<a href="#l1.347"></a><span id="l1.347">   if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) != 0</span>
<a href="#l1.348"></a><span id="l1.348">         &amp;&amp; !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.349"></a><span id="l1.349">         &amp;&amp; m_sortOrder != nsMsgViewSortType::byId)</span>
<a href="#l1.350"></a><span id="l1.350">     return GetIndexForThread(msgHdr);</span>
<a href="#l1.351"></a><span id="l1.351"> </span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-  return GetInsertIndexHelper(msgHdr, m_keys, m_sortOrder, m_sortType);</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+  return GetInsertIndexHelper(msgHdr, m_keys, GetFolders(), m_sortOrder, m_sortType);</span>
<a href="#l1.354"></a><span id="l1.354"> }</span>
<a href="#l1.355"></a><span id="l1.355"> </span>
<a href="#l1.356"></a><span id="l1.356"> nsresult  nsMsgDBView::AddHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex *resultIndex)</span>
<a href="#l1.357"></a><span id="l1.357"> {</span>
<a href="#l1.358"></a><span id="l1.358">   PRUint32  flags = 0;</span>
<a href="#l1.359"></a><span id="l1.359"> #ifdef DEBUG_bienvenu</span>
<a href="#l1.360"></a><span id="l1.360">   NS_ASSERTION(m_keys.Length() == m_flags.Length() &amp;&amp; (int) m_keys.Length() == m_levels.Length(), &quot;view arrays out of sync!&quot;);</span>
<a href="#l1.361"></a><span id="l1.361"> #endif</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineat">@@ -5347,23 +5309,26 @@ nsresult nsMsgDBView::MarkThreadRead(nsI</span>
<a href="#l1.363"></a><span id="l1.363">         }</span>
<a href="#l1.364"></a><span id="l1.364">     }</span>
<a href="#l1.365"></a><span id="l1.365"> </span>
<a href="#l1.366"></a><span id="l1.366">     return NS_OK;</span>
<a href="#l1.367"></a><span id="l1.367"> }</span>
<a href="#l1.368"></a><span id="l1.368"> </span>
<a href="#l1.369"></a><span id="l1.369"> PRBool nsMsgDBView::AdjustReadFlag(nsIMsgDBHdr *msgHdr, PRUint32 *msgFlags)</span>
<a href="#l1.370"></a><span id="l1.370"> {</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+  // if we're a cross-folder view, just bail on this.</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineplus">+  if (GetFolders())</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+    return *msgFlags &amp; MSG_FLAG_READ;</span>
<a href="#l1.374"></a><span id="l1.374">   PRBool isRead = PR_FALSE;</span>
<a href="#l1.375"></a><span id="l1.375">   nsMsgKey msgKey;</span>
<a href="#l1.376"></a><span id="l1.376">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.377"></a><span id="l1.377">   m_db-&gt;IsRead(msgKey, &amp;isRead);</span>
<a href="#l1.378"></a><span id="l1.378">     // just make sure flag is right in db.</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-#ifdef DEBUG_bienvenu</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-  NS_ASSERTION(isRead == (*msgFlags &amp; MSG_FLAG_READ != 0), &quot;msgFlags out of sync&quot;);</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineplus">+#ifdef DEBUG_David_Bienvenu</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+  NS_ASSERTION(isRead == ((*msgFlags &amp; MSG_FLAG_READ) != 0), &quot;msgFlags out of sync&quot;);</span>
<a href="#l1.383"></a><span id="l1.383"> #endif</span>
<a href="#l1.384"></a><span id="l1.384">   if (isRead)</span>
<a href="#l1.385"></a><span id="l1.385">     *msgFlags |= MSG_FLAG_READ;</span>
<a href="#l1.386"></a><span id="l1.386">   else</span>
<a href="#l1.387"></a><span id="l1.387">     *msgFlags &amp;= ~MSG_FLAG_READ;</span>
<a href="#l1.388"></a><span id="l1.388">   m_db-&gt;MarkHdrRead(msgHdr, isRead, nsnull);</span>
<a href="#l1.389"></a><span id="l1.389">   return isRead;</span>
<a href="#l1.390"></a><span id="l1.390"> }</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineat">@@ -6338,22 +6303,19 @@ nsMsgDBView::GetKeyForFirstSelectedMessa</span>
<a href="#l1.392"></a><span id="l1.392"> </span>
<a href="#l1.393"></a><span id="l1.393">     *key = m_keys[startRange];</span>
<a href="#l1.394"></a><span id="l1.394">   }</span>
<a href="#l1.395"></a><span id="l1.395">   else</span>
<a href="#l1.396"></a><span id="l1.396">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.397"></a><span id="l1.397">   return NS_OK;</span>
<a href="#l1.398"></a><span id="l1.398"> }</span>
<a href="#l1.399"></a><span id="l1.399"> </span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-nsresult nsMsgDBView::GetFolders(nsISupportsArray **aFolders)</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-{</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aFolders);</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-    *aFolders = nsnull;</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineplus">+nsCOMArray&lt;nsIMsgFolder&gt;* nsMsgDBView::GetFolders()</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineplus">+{</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+  return nsnull;</span>
<a href="#l1.409"></a><span id="l1.409"> }</span>
<a href="#l1.410"></a><span id="l1.410"> </span>
<a href="#l1.411"></a><span id="l1.411"> nsresult nsMsgDBView::AdjustRowCount(PRInt32 rowCountBeforeSort, PRInt32 rowCountAfterSort)</span>
<a href="#l1.412"></a><span id="l1.412"> {</span>
<a href="#l1.413"></a><span id="l1.413">   PRInt32 rowChange = rowCountAfterSort - rowCountBeforeSort;</span>
<a href="#l1.414"></a><span id="l1.414"> </span>
<a href="#l1.415"></a><span id="l1.415">   if (rowChange)</span>
<a href="#l1.416"></a><span id="l1.416">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -62,17 +62,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsIWeakReference.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsMsgTagService.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsIMsgCustomColumnHandler.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #define MESSENGER_STRING_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> typedef nsAutoTArray&lt;nsMsgViewIndex, 1&gt; nsMsgViewIndexArray;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> enum eFieldType {</span>
<a href="#l2.19"></a><span id="l2.19">     kCollationKey,</span>
<a href="#l2.20"></a><span id="l2.20">     kU32</span>
<a href="#l2.21"></a><span id="l2.21"> };</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -100,16 +100,36 @@ public:</span>
<a href="#l2.23"></a><span id="l2.23"> /* There currently only 5 labels defined */</span>
<a href="#l2.24"></a><span id="l2.24"> #define PREF_LABELS_MAX 5</span>
<a href="#l2.25"></a><span id="l2.25"> #define PREF_LABELS_DESCRIPTION  &quot;mailnews.labels.description.&quot;</span>
<a href="#l2.26"></a><span id="l2.26"> #define PREF_LABELS_COLOR  &quot;mailnews.labels.color.&quot;</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> #define LABEL_COLOR_STRING &quot;lc-&quot;</span>
<a href="#l2.29"></a><span id="l2.29"> #define LABEL_COLOR_WHITE_STRING &quot;#FFFFFF&quot;</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+struct IdUint32</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+{</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  nsMsgKey    id;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  PRUint32    bits;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  PRUint32    dword;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  nsIMsgFolder* folder;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+};</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+struct IdKey : public IdUint32</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+{</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  // actually a variable length array, whose actual size is determined</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  // when the struct is allocated.</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  PRUint8     key[1];</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+};</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+struct IdKeyPtr : public IdUint32</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+{</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  PRUint8     *key;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+};</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51"> // This is an abstract implementation class.</span>
<a href="#l2.52"></a><span id="l2.52"> // The actual view objects will be instances of sub-classes of this class</span>
<a href="#l2.53"></a><span id="l2.53"> class nsMsgDBView : public nsIMsgDBView, public nsIDBChangeListener,</span>
<a href="#l2.54"></a><span id="l2.54">                     public nsITreeView,</span>
<a href="#l2.55"></a><span id="l2.55">                     public nsIJunkMailClassificationListener</span>
<a href="#l2.56"></a><span id="l2.56"> {</span>
<a href="#l2.57"></a><span id="l2.57"> public:</span>
<a href="#l2.58"></a><span id="l2.58">   nsMsgDBView();</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineat">@@ -117,16 +137,17 @@ public:</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">   NS_DECL_ISUPPORTS</span>
<a href="#l2.62"></a><span id="l2.62">   NS_DECL_NSIMSGDBVIEW</span>
<a href="#l2.63"></a><span id="l2.63">   NS_DECL_NSIDBCHANGELISTENER</span>
<a href="#l2.64"></a><span id="l2.64">   NS_DECL_NSITREEVIEW</span>
<a href="#l2.65"></a><span id="l2.65">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67">   nsMsgViewIndex GetInsertIndexHelper(nsIMsgDBHdr *msgHdr, nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+                                      nsCOMArray&lt;nsIMsgFolder&gt; *folders,</span>
<a href="#l2.69"></a><span id="l2.69">                                         nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l2.70"></a><span id="l2.70">                                         nsMsgViewSortTypeValue sortType);</span>
<a href="#l2.71"></a><span id="l2.71">   PRInt32  SecondarySort(nsMsgKey key1, nsISupports *folder1, nsMsgKey key2, nsISupports *folder2,</span>
<a href="#l2.72"></a><span id="l2.72">                          class viewSortInfo *comparisonContext);</span>
<a href="#l2.73"></a><span id="l2.73"> protected:</span>
<a href="#l2.74"></a><span id="l2.74">   static nsrefcnt gInstanceCount;</span>
<a href="#l2.75"></a><span id="l2.75">   // atoms used for styling the view. we're going to have a lot of</span>
<a href="#l2.76"></a><span id="l2.76">   // these so i'm going to make them static.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineat">@@ -259,20 +280,20 @@ protected:</span>
<a href="#l2.78"></a><span id="l2.78">   nsresult SaveSortInfo(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l2.79"></a><span id="l2.79">   nsresult PersistFolderInfo(nsIDBFolderInfo **dbFolderInfo);</span>
<a href="#l2.80"></a><span id="l2.80">   void     SetMRUTimeForFolder(nsIMsgFolder *folder);</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">   nsMsgKey		GetAt(nsMsgViewIndex index)</span>
<a href="#l2.83"></a><span id="l2.83">                       {return m_keys.SafeElementAt(index, nsMsgKey_None);}</span>
<a href="#l2.84"></a><span id="l2.84">   nsMsgViewIndex	FindViewIndex(nsMsgKey  key) </span>
<a href="#l2.85"></a><span id="l2.85"> 					  {return FindKey(key, PR_FALSE);}</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  nsMsgViewIndex        FindHdr(nsIMsgDBHdr *msgHdr);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+  virtual nsMsgViewIndex        FindHdr(nsIMsgDBHdr *msgHdr);</span>
<a href="#l2.88"></a><span id="l2.88">   virtual nsMsgViewIndex	FindKey(nsMsgKey key, PRBool expand);</span>
<a href="#l2.89"></a><span id="l2.89">   virtual nsresult GetDBForViewIndex(nsMsgViewIndex index, nsIMsgDatabase **db);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-  virtual nsresult GetFolders(nsISupportsArray **folders);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  virtual nsCOMArray&lt;nsIMsgFolder&gt;* GetFolders();</span>
<a href="#l2.92"></a><span id="l2.92">   virtual nsresult GetFolderFromMsgURI(const char *aMsgURI, nsIMsgFolder **aFolder);</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">   virtual nsresult ListIdsInThread(nsIMsgThread *threadHdr, nsMsgViewIndex viewIndex, PRUint32 *pNumListed);</span>
<a href="#l2.95"></a><span id="l2.95">   nsresult ListUnreadIdsInThread(nsIMsgThread *threadHdr, nsMsgViewIndex startOfThreadViewIndex, PRUint32 *pNumListed);</span>
<a href="#l2.96"></a><span id="l2.96">   nsMsgViewIndex FindParentInThread(nsMsgKey parentKey, nsMsgViewIndex startOfThreadViewIndex);</span>
<a href="#l2.97"></a><span id="l2.97">   nsresult ListIdsInThreadOrder(nsIMsgThread *threadHdr, nsMsgKey parentKey, PRInt32 level, nsMsgViewIndex *viewIndex, PRUint32 *pNumListed);</span>
<a href="#l2.98"></a><span id="l2.98">   PRInt32  GetSize(void) {return(m_keys.Length());}</span>
<a href="#l2.99"></a><span id="l2.99"> </span>
<a href="#l2.100"></a><span id="l2.100" class="difflineat">@@ -319,17 +340,17 @@ protected:</span>
<a href="#l2.101"></a><span id="l2.101">   // for sorting</span>
<a href="#l2.102"></a><span id="l2.102">   nsresult GetFieldTypeAndLenForSort(nsMsgViewSortTypeValue sortType, PRUint16 *pMaxLen, eFieldType *pFieldType);</span>
<a href="#l2.103"></a><span id="l2.103">   nsresult GetCollationKey(nsIMsgDBHdr *msgHdr, nsMsgViewSortTypeValue sortType, PRUint8 **result, </span>
<a href="#l2.104"></a><span id="l2.104">                           PRUint32 *len, nsIMsgCustomColumnHandler* colHandler = nsnull);</span>
<a href="#l2.105"></a><span id="l2.105">   nsresult GetLongField(nsIMsgDBHdr *msgHdr, nsMsgViewSortTypeValue sortType, PRUint32 *result, </span>
<a href="#l2.106"></a><span id="l2.106">                           nsIMsgCustomColumnHandler* colHandler = nsnull);</span>
<a href="#l2.107"></a><span id="l2.107">   static int PR_CALLBACK FnSortIdKey(const void *pItem1, const void *pItem2, void *privateData);</span>
<a href="#l2.108"></a><span id="l2.108">   static int PR_CALLBACK FnSortIdKeyPtr(const void *pItem1, const void *pItem2, void *privateData);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  static int PR_CALLBACK FnSortIdDWord(const void *pItem1, const void *pItem2, void *privateData);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+  static int PR_CALLBACK FnSortIdUint32(const void *pItem1, const void *pItem2, void *privateData);</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112">   nsresult GetStatusSortValue(nsIMsgDBHdr *msgHdr, PRUint32 *result);</span>
<a href="#l2.113"></a><span id="l2.113">   nsresult GetLocationCollationKey(nsIMsgDBHdr *msgHdr, PRUint8 **result, PRUint32 *len);</span>
<a href="#l2.114"></a><span id="l2.114">   void PushSort(const MsgViewSortColumnInfo &amp;newSort);</span>
<a href="#l2.115"></a><span id="l2.115">   nsresult EncodeColumnSort(nsString &amp;columnSortString);</span>
<a href="#l2.116"></a><span id="l2.116">   nsresult DecodeColumnSort(nsString &amp;columnSortString);</span>
<a href="#l2.117"></a><span id="l2.117">   // for view navigation</span>
<a href="#l2.118"></a><span id="l2.118">   nsresult NavigateFromPos(nsMsgNavigationTypeValue motion, nsMsgViewIndex startIndex, nsMsgKey *pResultKey, </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupThread.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupThread.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -181,17 +181,17 @@ nsresult nsMsgGroupThread::AddMsgHdrInDa</span>
<a href="#l3.4"></a><span id="l3.4">     nsMsgViewSortOrderValue sortOrder;</span>
<a href="#l3.5"></a><span id="l3.5">     (void) view-&gt;GetSortType(&amp;sortType);</span>
<a href="#l3.6"></a><span id="l3.6">     (void) view-&gt;GetSortOrder(&amp;sortOrder);</span>
<a href="#l3.7"></a><span id="l3.7">     nsMsgViewSortOrderValue threadSortOrder = </span>
<a href="#l3.8"></a><span id="l3.8">       (sortType == nsMsgViewSortType::byDate</span>
<a href="#l3.9"></a><span id="l3.9">         &amp;&amp; sortOrder == nsMsgViewSortOrder::descending) ? </span>
<a href="#l3.10"></a><span id="l3.10">           nsMsgViewSortOrder::descending : nsMsgViewSortOrder::ascending;</span>
<a href="#l3.11"></a><span id="l3.11">     // sort by date within group</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    insertIndex = view-&gt;GetInsertIndexHelper(child, m_keys, threadSortOrder, nsMsgViewSortType::byDate);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    insertIndex = view-&gt;GetInsertIndexHelper(child, m_keys, nsnull, threadSortOrder, nsMsgViewSortType::byDate);</span>
<a href="#l3.14"></a><span id="l3.14">   }</span>
<a href="#l3.15"></a><span id="l3.15">   m_keys.InsertElementAt(insertIndex, newHdrKey);</span>
<a href="#l3.16"></a><span id="l3.16">   if (!insertIndex)</span>
<a href="#l3.17"></a><span id="l3.17">     m_threadRootKey = newHdrKey;</span>
<a href="#l3.18"></a><span id="l3.18">   return ret;</span>
<a href="#l3.19"></a><span id="l3.19"> }</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> nsresult nsMsgGroupThread::AddChildFromGroupView(nsIMsgDBHdr *child, nsMsgDBView *view)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -129,17 +129,17 @@ nsresult nsMsgQuickSearchDBView::OnNewHe</span>
<a href="#l4.4"></a><span id="l4.4">     if (searchSession)</span>
<a href="#l4.5"></a><span id="l4.5">       searchSession-&gt;MatchHdr(newHdr, m_db, &amp;match);</span>
<a href="#l4.6"></a><span id="l4.6">     if (match)</span>
<a href="#l4.7"></a><span id="l4.7">     {</span>
<a href="#l4.8"></a><span id="l4.8">       // put the new header in m_origKeys, so that expanding a thread will</span>
<a href="#l4.9"></a><span id="l4.9">       // show the newly added header.</span>
<a href="#l4.10"></a><span id="l4.10">       nsMsgKey newKey;</span>
<a href="#l4.11"></a><span id="l4.11">       (void) newHdr-&gt;GetMessageKey(&amp;newKey);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      nsMsgViewIndex insertIndex = GetInsertIndexHelper(newHdr, m_origKeys, </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+      nsMsgViewIndex insertIndex = GetInsertIndexHelper(newHdr, m_origKeys, nsnull,</span>
<a href="#l4.14"></a><span id="l4.14">                       nsMsgViewSortOrder::ascending, nsMsgViewSortType::byId);</span>
<a href="#l4.15"></a><span id="l4.15">       m_origKeys.InsertElementAt(insertIndex, newKey);</span>
<a href="#l4.16"></a><span id="l4.16">       nsMsgThreadedDBView::OnNewHeader(newHdr, aParentKey, ensureListed); // do not add a new message if there isn't a match.</span>
<a href="#l4.17"></a><span id="l4.17">     }</span>
<a href="#l4.18"></a><span id="l4.18">   }</span>
<a href="#l4.19"></a><span id="l4.19">   return NS_OK;</span>
<a href="#l4.20"></a><span id="l4.20"> }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -456,17 +456,19 @@ nsresult nsMsgQuickSearchDBView::SortThr</span>
<a href="#l4.23"></a><span id="l4.23">       nsMsgKey rootKey;</span>
<a href="#l4.24"></a><span id="l4.24">       threadHdr-&gt;GetChildKeyAt(0, &amp;rootKey);</span>
<a href="#l4.25"></a><span id="l4.25">       nsMsgViewIndex threadRootIndex = threadRootIds.BinaryIndexOf(rootKey);</span>
<a href="#l4.26"></a><span id="l4.26">       // if we already have that id in top level threads, ignore this msg.</span>
<a href="#l4.27"></a><span id="l4.27">       if (threadRootIndex != kNotFound)</span>
<a href="#l4.28"></a><span id="l4.28">         continue;</span>
<a href="#l4.29"></a><span id="l4.29">       // it would be nice if GetInsertIndexHelper always found the hdr, but it doesn't.</span>
<a href="#l4.30"></a><span id="l4.30">       threadHdr-&gt;GetChildHdrAt(0, getter_AddRefs(rootHdr));</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-      threadRootIndex = GetInsertIndexHelper(rootHdr, threadRootIds, nsMsgViewSortOrder::ascending, nsMsgViewSortType::byId);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+      threadRootIndex = GetInsertIndexHelper(rootHdr, threadRootIds, nsnull,</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+                                             nsMsgViewSortOrder::ascending,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+                                             nsMsgViewSortType::byId);</span>
<a href="#l4.35"></a><span id="l4.35">       threadRootIds.InsertElementAt(threadRootIndex, rootKey);</span>
<a href="#l4.36"></a><span id="l4.36">     }</span>
<a href="#l4.37"></a><span id="l4.37">   }</span>
<a href="#l4.38"></a><span id="l4.38">   m_origKeys.SwapElements(m_keys);</span>
<a href="#l4.39"></a><span id="l4.39">   // need to sort the top level threads now by sort order, if it's not by id.</span>
<a href="#l4.40"></a><span id="l4.40">   if (sortType != nsMsgViewSortType::byId)</span>
<a href="#l4.41"></a><span id="l4.41">   {</span>
<a href="#l4.42"></a><span id="l4.42">     m_keys.SwapElements(threadRootIds);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -60,21 +60,17 @@ nsMsgSearchDBView::nsMsgSearchDBView()</span>
<a href="#l5.4"></a><span id="l5.4"> nsMsgSearchDBView::~nsMsgSearchDBView()</span>
<a href="#l5.5"></a><span id="l5.5"> {	</span>
<a href="#l5.6"></a><span id="l5.6"> }</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> NS_IMPL_ISUPPORTS_INHERITED3(nsMsgSearchDBView, nsMsgDBView, nsIMsgDBView, nsIMsgCopyServiceListener, nsIMsgSearchNotify)</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> NS_IMETHODIMP nsMsgSearchDBView::Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, nsMsgViewFlagsTypeValue viewFlags, PRInt32 *pCount)</span>
<a href="#l5.11"></a><span id="l5.11"> {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    m_folders = do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-    rv = nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+    nsresult rv = nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l5.18"></a><span id="l5.18">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">     if (pCount)</span>
<a href="#l5.21"></a><span id="l5.21">       *pCount = 0;</span>
<a href="#l5.22"></a><span id="l5.22">     m_folder = nsnull;</span>
<a href="#l5.23"></a><span id="l5.23">     return rv;</span>
<a href="#l5.24"></a><span id="l5.24"> }</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -85,29 +81,25 @@ nsMsgSearchDBView::CopyDBView(nsMsgDBVie</span>
<a href="#l5.27"></a><span id="l5.27">   nsMsgDBView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l5.28"></a><span id="l5.28">   nsMsgSearchDBView* newMsgDBView = (nsMsgSearchDBView *) aNewMsgDBView;</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   // now copy all of our private member data</span>
<a href="#l5.31"></a><span id="l5.31">   newMsgDBView-&gt;mDestFolder = mDestFolder;</span>
<a href="#l5.32"></a><span id="l5.32">   newMsgDBView-&gt;mCommand = mCommand;</span>
<a href="#l5.33"></a><span id="l5.33">   newMsgDBView-&gt;mTotalIndices = mTotalIndices;</span>
<a href="#l5.34"></a><span id="l5.34">   newMsgDBView-&gt;mCurIndex = mCurIndex; </span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  if (m_folders)</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-    m_folders-&gt;Clone(getter_AddRefs(newMsgDBView-&gt;m_folders));</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  newMsgDBView-&gt;m_folders.InsertObjectsAt(m_folders, 0);</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   if (m_hdrsForEachFolder)</span>
<a href="#l5.41"></a><span id="l5.41">     m_hdrsForEachFolder-&gt;Clone(getter_AddRefs(newMsgDBView-&gt;m_hdrsForEachFolder));</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">   if (m_copyListenerList)</span>
<a href="#l5.44"></a><span id="l5.44">     m_copyListenerList-&gt;Clone(getter_AddRefs(newMsgDBView-&gt;m_copyListenerList));</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  if (m_uniqueFoldersSelected)</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    m_uniqueFoldersSelected-&gt;Clone(getter_AddRefs(newMsgDBView-&gt;m_uniqueFoldersSelected));</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  newMsgDBView-&gt;m_uniqueFoldersSelected.InsertObjectsAt(m_uniqueFoldersSelected, 0);</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51">   PRInt32 count = m_dbToUseList.Count(); </span>
<a href="#l5.52"></a><span id="l5.52">   for(PRInt32 i = 0; i &lt; count; i++)</span>
<a href="#l5.53"></a><span id="l5.53">   {</span>
<a href="#l5.54"></a><span id="l5.54">     newMsgDBView-&gt;m_dbToUseList.AppendObject(m_dbToUseList[i]);</span>
<a href="#l5.55"></a><span id="l5.55">     // register the new view with the database so it gets notifications</span>
<a href="#l5.56"></a><span id="l5.56">     m_dbToUseList[i]-&gt;AddListener(newMsgDBView);</span>
<a href="#l5.57"></a><span id="l5.57">   }</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineat">@@ -148,47 +140,51 @@ nsresult nsMsgSearchDBView::FetchLocatio</span>
<a href="#l5.59"></a><span id="l5.59"> nsresult nsMsgSearchDBView::OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, PRBool /*ensureListed*/)</span>
<a href="#l5.60"></a><span id="l5.60"> {</span>
<a href="#l5.61"></a><span id="l5.61">    return NS_OK;</span>
<a href="#l5.62"></a><span id="l5.62"> }</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> nsresult nsMsgSearchDBView::GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr)</span>
<a href="#l5.65"></a><span id="l5.65"> {</span>
<a href="#l5.66"></a><span id="l5.66">   nsresult rv = NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(m_folders, index);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  if (index == nsMsgViewIndex_None || index &gt; (PRUint32) m_folders.Count())</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+    return rv;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  nsIMsgFolder *folder = m_folders[index];</span>
<a href="#l5.71"></a><span id="l5.71">   if (folder)</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-    {</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-      nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-      rv = folder-&gt;GetMsgDatabase(msgWindow, getter_AddRefs(db));</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-      if (db)</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-        rv = db-&gt;GetMsgHdrForKey(m_keys[index], msgHdr);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-    }</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+  {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+    rv = folder-&gt;GetMsgDatabase(msgWindow, getter_AddRefs(db));</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+    if (db)</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+      rv = db-&gt;GetMsgHdrForKey(m_keys[index], msgHdr);</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  }</span>
<a href="#l5.88"></a><span id="l5.88">   return rv;</span>
<a href="#l5.89"></a><span id="l5.89"> }</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91"> NS_IMETHODIMP nsMsgSearchDBView::GetFolderForViewIndex(nsMsgViewIndex index, nsIMsgFolder **aFolder)</span>
<a href="#l5.92"></a><span id="l5.92"> {</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-  return m_folders-&gt;QueryElementAt(index, NS_GET_IID(nsIMsgFolder), (void **) aFolder);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  if (index == nsMsgViewIndex_None || index &gt; (PRUint32) m_folders.Count())</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  NS_IF_ADDREF(*aFolder = m_folders[index]);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.99"></a><span id="l5.99"> }</span>
<a href="#l5.100"></a><span id="l5.100"> </span>
<a href="#l5.101"></a><span id="l5.101"> nsresult nsMsgSearchDBView::GetDBForViewIndex(nsMsgViewIndex index, nsIMsgDatabase **db)</span>
<a href="#l5.102"></a><span id="l5.102"> {</span>
<a href="#l5.103"></a><span id="l5.103">   nsCOMPtr &lt;nsIMsgFolder&gt; aFolder;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-  GetFolderForViewIndex(index, getter_AddRefs(aFolder));</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-  if (aFolder)</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-    return aFolder-&gt;GetMsgDatabase(nsnull, db);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-  else</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  nsresult rv = GetFolderForViewIndex(index, getter_AddRefs(aFolder));</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+  return aFolder-&gt;GetMsgDatabase(nsnull, db);</span>
<a href="#l5.112"></a><span id="l5.112"> }</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-nsresult nsMsgSearchDBView::AddHdrFromFolder(nsIMsgDBHdr *msgHdr, nsISupports *folder)</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+nsresult nsMsgSearchDBView::AddHdrFromFolder(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder)</span>
<a href="#l5.116"></a><span id="l5.116"> {</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-  m_folders-&gt;AppendElement(folder);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  m_folders.AppendObject(folder);</span>
<a href="#l5.119"></a><span id="l5.119">   nsMsgKey msgKey;</span>
<a href="#l5.120"></a><span id="l5.120">   PRUint32 msgFlags;</span>
<a href="#l5.121"></a><span id="l5.121">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l5.122"></a><span id="l5.122">   // nsMsgKey_None means it's not a valid hdr.</span>
<a href="#l5.123"></a><span id="l5.123">   if (msgKey != nsMsgKey_None)</span>
<a href="#l5.124"></a><span id="l5.124">   {</span>
<a href="#l5.125"></a><span id="l5.125">     msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.126"></a><span id="l5.126">     m_keys.AppendElement(msgKey);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineat">@@ -203,59 +199,56 @@ nsresult nsMsgSearchDBView::AddHdrFromFo</span>
<a href="#l5.128"></a><span id="l5.128">   }</span>
<a href="#l5.129"></a><span id="l5.129"> </span>
<a href="#l5.130"></a><span id="l5.130"> NS_IMETHODIMP</span>
<a href="#l5.131"></a><span id="l5.131"> nsMsgSearchDBView::OnSearchHit(nsIMsgDBHdr* aMsgHdr, nsIMsgFolder *folder)</span>
<a href="#l5.132"></a><span id="l5.132"> {</span>
<a href="#l5.133"></a><span id="l5.133">   NS_ENSURE_ARG(aMsgHdr);</span>
<a href="#l5.134"></a><span id="l5.134">   NS_ENSURE_ARG(folder);</span>
<a href="#l5.135"></a><span id="l5.135"> </span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(folder);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-  if (m_folders-&gt;IndexOf(supports) &lt; 0 ) //do this just for new folder</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+  if (m_folders.IndexOf(folder) &lt; 0 ) //do this just for new folder</span>
<a href="#l5.139"></a><span id="l5.139">   {</span>
<a href="#l5.140"></a><span id="l5.140">     nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l5.141"></a><span id="l5.141">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l5.142"></a><span id="l5.142">     folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(dbToUse));</span>
<a href="#l5.143"></a><span id="l5.143">     if (dbToUse)</span>
<a href="#l5.144"></a><span id="l5.144">     {</span>
<a href="#l5.145"></a><span id="l5.145">       dbToUse-&gt;AddListener(this);</span>
<a href="#l5.146"></a><span id="l5.146">       m_dbToUseList.AppendObject(dbToUse);</span>
<a href="#l5.147"></a><span id="l5.147">     }</span>
<a href="#l5.148"></a><span id="l5.148">   }</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-  return AddHdrFromFolder(aMsgHdr, supports);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+  return AddHdrFromFolder(aMsgHdr, folder);</span>
<a href="#l5.152"></a><span id="l5.152"> }</span>
<a href="#l5.153"></a><span id="l5.153"> </span>
<a href="#l5.154"></a><span id="l5.154"> NS_IMETHODIMP</span>
<a href="#l5.155"></a><span id="l5.155"> nsMsgSearchDBView::OnSearchDone(nsresult status)</span>
<a href="#l5.156"></a><span id="l5.156"> {</span>
<a href="#l5.157"></a><span id="l5.157">   //we want to set imap delete model once the search is over because setting next</span>
<a href="#l5.158"></a><span id="l5.158">   //message after deletion will happen before deleting the message and search scope</span>
<a href="#l5.159"></a><span id="l5.159">   //can change with every search.</span>
<a href="#l5.160"></a><span id="l5.160">   mDeleteModel = nsMsgImapDeleteModels::MoveToTrash;  //set to default in case it is non-imap folder</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; curFolder = do_QueryElementAt(m_folders, 0);</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+  nsIMsgFolder *curFolder = m_folders.SafeObjectAt(0);</span>
<a href="#l5.163"></a><span id="l5.163">   if (curFolder)   </span>
<a href="#l5.164"></a><span id="l5.164">     GetImapDeleteModel(curFolder);</span>
<a href="#l5.165"></a><span id="l5.165">   return NS_OK;</span>
<a href="#l5.166"></a><span id="l5.166"> }</span>
<a href="#l5.167"></a><span id="l5.167"> </span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-</span>
<a href="#l5.169"></a><span id="l5.169"> // for now also acts as a way of resetting the search datasource</span>
<a href="#l5.170"></a><span id="l5.170"> NS_IMETHODIMP</span>
<a href="#l5.171"></a><span id="l5.171"> nsMsgSearchDBView::OnNewSearch()</span>
<a href="#l5.172"></a><span id="l5.172"> {</span>
<a href="#l5.173"></a><span id="l5.173">   PRInt32 oldSize = GetSize();</span>
<a href="#l5.174"></a><span id="l5.174"> </span>
<a href="#l5.175"></a><span id="l5.175">   PRInt32 count = m_dbToUseList.Count();</span>
<a href="#l5.176"></a><span id="l5.176">   for(PRInt32 j = 0; j &lt; count; j++) </span>
<a href="#l5.177"></a><span id="l5.177">     m_dbToUseList[j]-&gt;RemoveListener(this);</span>
<a href="#l5.178"></a><span id="l5.178"> </span>
<a href="#l5.179"></a><span id="l5.179">   m_dbToUseList.Clear();</span>
<a href="#l5.180"></a><span id="l5.180"> </span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-  m_folders-&gt;Clear();</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  m_folders.Clear();</span>
<a href="#l5.183"></a><span id="l5.183">   m_keys.Clear();</span>
<a href="#l5.184"></a><span id="l5.184">   m_levels.Clear();</span>
<a href="#l5.185"></a><span id="l5.185">   m_flags.Clear();</span>
<a href="#l5.186"></a><span id="l5.186"> </span>
<a href="#l5.187"></a><span id="l5.187">   // needs to happen after we remove the keys, since RowCountChanged() will call our GetRowCount()</span>
<a href="#l5.188"></a><span id="l5.188">   if (mTree) </span>
<a href="#l5.189"></a><span id="l5.189">     mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l5.190"></a><span id="l5.190"> </span>
<a href="#l5.191"></a><span id="l5.191" class="difflineat">@@ -276,21 +269,19 @@ NS_IMETHODIMP nsMsgSearchDBView::OnAnnou</span>
<a href="#l5.192"></a><span id="l5.192">   if (db)</span>
<a href="#l5.193"></a><span id="l5.193">   {</span>
<a href="#l5.194"></a><span id="l5.194">     db-&gt;RemoveListener(this);</span>
<a href="#l5.195"></a><span id="l5.195">     m_dbToUseList.RemoveObject(db);</span>
<a href="#l5.196"></a><span id="l5.196">   }</span>
<a href="#l5.197"></a><span id="l5.197">   return NS_OK;</span>
<a href="#l5.198"></a><span id="l5.198"> }</span>
<a href="#l5.199"></a><span id="l5.199"> </span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-nsresult nsMsgSearchDBView::GetFolders(nsISupportsArray **aFolders)</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+nsCOMArray&lt;nsIMsgFolder&gt;* nsMsgSearchDBView::GetFolders()</span>
<a href="#l5.202"></a><span id="l5.202"> {</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aFolders);</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-  NS_IF_ADDREF(*aFolders = m_folders);</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+  return &amp;m_folders;</span>
<a href="#l5.207"></a><span id="l5.207"> }</span>
<a href="#l5.208"></a><span id="l5.208"> </span>
<a href="#l5.209"></a><span id="l5.209"> NS_IMETHODIMP</span>
<a href="#l5.210"></a><span id="l5.210"> nsMsgSearchDBView::GetCommandStatus(nsMsgViewCommandTypeValue command, PRBool *selectable_p, nsMsgViewCommandCheckStateValue *selected_p)</span>
<a href="#l5.211"></a><span id="l5.211"> {</span>
<a href="#l5.212"></a><span id="l5.212">   if (command != nsMsgViewCommandType::runJunkControls)</span>
<a href="#l5.213"></a><span id="l5.213">     return nsMsgDBView::GetCommandStatus(command, selectable_p, selected_p);</span>
<a href="#l5.214"></a><span id="l5.214"> </span>
<a href="#l5.215"></a><span id="l5.215" class="difflineat">@@ -339,17 +330,17 @@ NS_IMETHODIMP nsMsgSearchDBView::DoComma</span>
<a href="#l5.216"></a><span id="l5.216"> </span>
<a href="#l5.217"></a><span id="l5.217"> // This method just removes the specified line from the view. It does</span>
<a href="#l5.218"></a><span id="l5.218"> // NOT delete it from the database.</span>
<a href="#l5.219"></a><span id="l5.219"> nsresult nsMsgSearchDBView::RemoveByIndex(nsMsgViewIndex index)</span>
<a href="#l5.220"></a><span id="l5.220"> {</span>
<a href="#l5.221"></a><span id="l5.221">     if (!IsValidIndex(index))</span>
<a href="#l5.222"></a><span id="l5.222">         return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l5.223"></a><span id="l5.223"> </span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-    m_folders-&gt;RemoveElementAt(index);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+    m_folders.RemoveObjectAt(index);</span>
<a href="#l5.226"></a><span id="l5.226">     </span>
<a href="#l5.227"></a><span id="l5.227">     return nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l5.228"></a><span id="l5.228"> }</span>
<a href="#l5.229"></a><span id="l5.229"> </span>
<a href="#l5.230"></a><span id="l5.230"> nsresult nsMsgSearchDBView::DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, PRInt32 numIndices, PRBool deleteStorage)</span>
<a href="#l5.231"></a><span id="l5.231"> {</span>
<a href="#l5.232"></a><span id="l5.232">    nsresult rv;</span>
<a href="#l5.233"></a><span id="l5.233">    GetFoldersAndHdrsForSelection(indices, numIndices);</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineat">@@ -384,28 +375,28 @@ nsMsgSearchDBView::CopyMessages(nsIMsgWi</span>
<a href="#l5.235"></a><span id="l5.235">     return rv;</span>
<a href="#l5.236"></a><span id="l5.236"> }</span>
<a href="#l5.237"></a><span id="l5.237"> </span>
<a href="#l5.238"></a><span id="l5.238"> nsresult</span>
<a href="#l5.239"></a><span id="l5.239"> nsMsgSearchDBView::PartitionSelectionByFolder(nsMsgViewIndex *indices, PRInt32 numIndices, nsTArray&lt;PRUint32&gt; **indexArrays, PRInt32 *numArrays)</span>
<a href="#l5.240"></a><span id="l5.240"> {</span>
<a href="#l5.241"></a><span id="l5.241">   nsMsgViewIndex i;</span>
<a href="#l5.242"></a><span id="l5.242">   PRInt32 folderIndex;</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-  nsCOMArray&lt;nsISupports&gt; uniqueFoldersSelected;</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+  nsCOMArray&lt;nsIMsgFolder&gt; uniqueFoldersSelected;</span>
<a href="#l5.245"></a><span id="l5.245">   nsTArray&lt;PRUint32&gt; numIndicesSelected;</span>
<a href="#l5.246"></a><span id="l5.246">   mCurIndex = 0;</span>
<a href="#l5.247"></a><span id="l5.247"> </span>
<a href="#l5.248"></a><span id="l5.248">   //Build unique folder list based on headers selected by the user</span>
<a href="#l5.249"></a><span id="l5.249">   for (i = 0; i &lt; (nsMsgViewIndex) numIndices; i++)</span>
<a href="#l5.250"></a><span id="l5.250">   {</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-    nsCOMPtr &lt;nsISupports&gt; curSupports = dont_AddRef(m_folders-&gt;ElementAt(indices[i]));</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-    folderIndex = uniqueFoldersSelected.IndexOf(curSupports);</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+    nsIMsgFolder *curFolder = m_folders[indices[i]];</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+    folderIndex = uniqueFoldersSelected.IndexOf(curFolder);</span>
<a href="#l5.255"></a><span id="l5.255">     if (folderIndex &lt; 0)</span>
<a href="#l5.256"></a><span id="l5.256">     {</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-      uniqueFoldersSelected.AppendObject(curSupports);</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+      uniqueFoldersSelected.AppendObject(curFolder);</span>
<a href="#l5.259"></a><span id="l5.259">       numIndicesSelected.AppendElement(1);</span>
<a href="#l5.260"></a><span id="l5.260">     }</span>
<a href="#l5.261"></a><span id="l5.261">     else</span>
<a href="#l5.262"></a><span id="l5.262">     {</span>
<a href="#l5.263"></a><span id="l5.263">       numIndicesSelected[folderIndex]++;</span>
<a href="#l5.264"></a><span id="l5.264">     }</span>
<a href="#l5.265"></a><span id="l5.265">   }</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267" class="difflineat">@@ -414,82 +405,69 @@ nsMsgSearchDBView::PartitionSelectionByF</span>
<a href="#l5.268"></a><span id="l5.268">   *numArrays = numFolders;</span>
<a href="#l5.269"></a><span id="l5.269">   NS_ENSURE_TRUE(*indexArrays, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l5.270"></a><span id="l5.270">   for (folderIndex = 0; folderIndex &lt; numFolders; folderIndex++)</span>
<a href="#l5.271"></a><span id="l5.271">   {</span>
<a href="#l5.272"></a><span id="l5.272">     (*indexArrays)[folderIndex].SetCapacity(numIndicesSelected[folderIndex]);</span>
<a href="#l5.273"></a><span id="l5.273">   }</span>
<a href="#l5.274"></a><span id="l5.274">   for (i = 0; i &lt; (nsMsgViewIndex) numIndices; i++) </span>
<a href="#l5.275"></a><span id="l5.275">   {</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineminus">-    nsCOMPtr &lt;nsISupports&gt; curSupports = getter_AddRefs(m_folders-&gt;ElementAt(indices[i]));</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-    PRInt32 folderIndex = uniqueFoldersSelected.IndexOf(curSupports);</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+    nsIMsgFolder *curFolder = m_folders[indices[i]];</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+    PRInt32 folderIndex = uniqueFoldersSelected.IndexOf(curFolder);</span>
<a href="#l5.280"></a><span id="l5.280">     (*indexArrays)[folderIndex].AppendElement(indices[i]);</span>
<a href="#l5.281"></a><span id="l5.281">   }</span>
<a href="#l5.282"></a><span id="l5.282">   return NS_OK;</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-</span>
<a href="#l5.284"></a><span id="l5.284"> }</span>
<a href="#l5.285"></a><span id="l5.285"> </span>
<a href="#l5.286"></a><span id="l5.286"> nsresult</span>
<a href="#l5.287"></a><span id="l5.287"> nsMsgSearchDBView::GetFoldersAndHdrsForSelection(nsMsgViewIndex *indices, PRInt32 numIndices)</span>
<a href="#l5.288"></a><span id="l5.288"> {</span>
<a href="#l5.289"></a><span id="l5.289">   nsresult rv = NS_OK; </span>
<a href="#l5.290"></a><span id="l5.290">   mCurIndex = 0;</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-                    //initialize and clear from the last usage</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-  if (!m_uniqueFoldersSelected)</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-  {</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-    m_uniqueFoldersSelected = do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv); </span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-  }</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-  else</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-    m_uniqueFoldersSelected-&gt;Clear();</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+  m_uniqueFoldersSelected.Clear();</span>
<a href="#l5.300"></a><span id="l5.300">   </span>
<a href="#l5.301"></a><span id="l5.301">   if (!m_hdrsForEachFolder)</span>
<a href="#l5.302"></a><span id="l5.302">   {</span>
<a href="#l5.303"></a><span id="l5.303">     m_hdrsForEachFolder = do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l5.304"></a><span id="l5.304">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.305"></a><span id="l5.305">   }</span>
<a href="#l5.306"></a><span id="l5.306">   else</span>
<a href="#l5.307"></a><span id="l5.307">     m_hdrsForEachFolder-&gt;Clear();</span>
<a href="#l5.308"></a><span id="l5.308"> </span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-  //Build unique folder list based on headers selected by the user</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+  // Build unique folder list based on headers selected by the user</span>
<a href="#l5.311"></a><span id="l5.311">   for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex) numIndices; i++)</span>
<a href="#l5.312"></a><span id="l5.312">   {</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineminus">-     nsCOMPtr &lt;nsISupports&gt; curSupports = getter_AddRefs(m_folders-&gt;ElementAt(indices[i]));</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-     if ( m_uniqueFoldersSelected-&gt;IndexOf(curSupports) &lt; 0)</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-       m_uniqueFoldersSelected-&gt;AppendElement(curSupports); </span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+     nsIMsgFolder *curFolder = m_folders[indices[i]];</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+     if (m_uniqueFoldersSelected.IndexOf(curFolder) &lt; 0)</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+       m_uniqueFoldersSelected.AppendObject(curFolder);</span>
<a href="#l5.319"></a><span id="l5.319">   }</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-  PRUint32 numFolders =0; </span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-  rv = m_uniqueFoldersSelected-&gt;Count(&amp;numFolders);   //group the headers selected by each folder </span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-  for (PRUint32 folderIndex=0; folderIndex &lt; numFolders; folderIndex++)</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+  // Group the headers selected by each folder</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+  PRUint32 numFolders = m_uniqueFoldersSelected.Count();</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+  for (PRUint32 folderIndex = 0; folderIndex &lt; numFolders; folderIndex++)</span>
<a href="#l5.328"></a><span id="l5.328">   {</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-     nsCOMPtr &lt;nsIMsgFolder&gt; curFolder =</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-         do_QueryElementAt(m_uniqueFoldersSelected, folderIndex, &amp;rv);</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+     nsIMsgFolder *curFolder = m_uniqueFoldersSelected[folderIndex];</span>
<a href="#l5.332"></a><span id="l5.332">      nsCOMPtr&lt;nsIMutableArray&gt; msgHdrsForOneFolder(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l5.333"></a><span id="l5.333">      for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex) numIndices; i++) </span>
<a href="#l5.334"></a><span id="l5.334">      {</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-       nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder = do_QueryElementAt(m_folders,</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-                                                             indices[i], &amp;rv);</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+       nsIMsgFolder *msgFolder = m_folders[indices[i]];</span>
<a href="#l5.338"></a><span id="l5.338">        if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder &amp;&amp; msgFolder == curFolder) </span>
<a href="#l5.339"></a><span id="l5.339">        {</span>
<a href="#l5.340"></a><span id="l5.340">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr; </span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-          rv = GetMsgHdrForViewIndex(indices[i],getter_AddRefs(msgHdr));</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+          rv = GetMsgHdrForViewIndex(indices[i], getter_AddRefs(msgHdr));</span>
<a href="#l5.343"></a><span id="l5.343">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-          nsCOMPtr &lt;nsISupports&gt; hdrSupports = do_QueryInterface(msgHdr);</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+          nsCOMPtr&lt;nsISupports&gt; hdrSupports = do_QueryInterface(msgHdr);</span>
<a href="#l5.346"></a><span id="l5.346">           msgHdrsForOneFolder-&gt;AppendElement(hdrSupports, PR_FALSE);</span>
<a href="#l5.347"></a><span id="l5.347">        }</span>
<a href="#l5.348"></a><span id="l5.348">      }</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-     nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(msgHdrsForOneFolder, &amp;rv);</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+     nsCOMPtr&lt;nsISupports&gt; supports = do_QueryInterface(msgHdrsForOneFolder, &amp;rv);</span>
<a href="#l5.351"></a><span id="l5.351">      if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l5.352"></a><span id="l5.352">        m_hdrsForEachFolder-&gt;AppendElement(supports);</span>
<a href="#l5.353"></a><span id="l5.353">   }</span>
<a href="#l5.354"></a><span id="l5.354">   return rv;</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineminus">-</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-</span>
<a href="#l5.357"></a><span id="l5.357"> }</span>
<a href="#l5.358"></a><span id="l5.358"> </span>
<a href="#l5.359"></a><span id="l5.359"> nsresult</span>
<a href="#l5.360"></a><span id="l5.360"> nsMsgSearchDBView::ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command, nsMsgViewIndex* indices,</span>
<a href="#l5.361"></a><span id="l5.361">                     PRInt32 numIndices, nsIMsgFolder *destFolder)</span>
<a href="#l5.362"></a><span id="l5.362"> {</span>
<a href="#l5.363"></a><span id="l5.363">   mCommand = command;</span>
<a href="#l5.364"></a><span id="l5.364">   mDestFolder = destFolder;</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineat">@@ -521,41 +499,36 @@ NS_IMETHODIMP</span>
<a href="#l5.366"></a><span id="l5.366"> nsMsgSearchDBView::GetMessageId(nsACString&amp; messageId)</span>
<a href="#l5.367"></a><span id="l5.367"> {</span>
<a href="#l5.368"></a><span id="l5.368">   return NS_OK;</span>
<a href="#l5.369"></a><span id="l5.369"> }</span>
<a href="#l5.370"></a><span id="l5.370"> </span>
<a href="#l5.371"></a><span id="l5.371"> NS_IMETHODIMP</span>
<a href="#l5.372"></a><span id="l5.372"> nsMsgSearchDBView::OnStopCopy(nsresult aStatus)</span>
<a href="#l5.373"></a><span id="l5.373"> {</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-    if (NS_SUCCEEDED(aStatus))</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+  if (NS_SUCCEEDED(aStatus))</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+  {</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+    mCurIndex++;</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+    PRUint32 numFolders = 0;</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+    if (mCurIndex &lt; (PRUint32) m_uniqueFoldersSelected.Count())</span>
<a href="#l5.382"></a><span id="l5.382">     {</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-        mCurIndex++;</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-        PRUint32 numFolders =0;</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-        rv = m_uniqueFoldersSelected-&gt;Count(&amp;numFolders);</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-        if ( mCurIndex &lt; (PRUint32) numFolders)</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-        {</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-          nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-          ProcessRequestsInOneFolder(msgWindow);</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-        }</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+      nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+      ProcessRequestsInOneFolder(msgWindow);</span>
<a href="#l5.393"></a><span id="l5.393">     }</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-    return rv;</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+  }</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.398"></a><span id="l5.398"> }</span>
<a href="#l5.399"></a><span id="l5.399"> </span>
<a href="#l5.400"></a><span id="l5.400"> // end nsIMsgCopyServiceListener methods</span>
<a href="#l5.401"></a><span id="l5.401"> </span>
<a href="#l5.402"></a><span id="l5.402"> nsresult nsMsgSearchDBView::ProcessRequestsInOneFolder(nsIMsgWindow *window)</span>
<a href="#l5.403"></a><span id="l5.403"> {</span>
<a href="#l5.404"></a><span id="l5.404">     nsresult rv = NS_OK;</span>
<a href="#l5.405"></a><span id="l5.405"> </span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; curFolder =</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-        do_QueryElementAt(m_uniqueFoldersSelected, mCurIndex);</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+    nsIMsgFolder *curFolder = m_uniqueFoldersSelected[mCurIndex];</span>
<a href="#l5.409"></a><span id="l5.409">     NS_ASSERTION(curFolder, &quot;curFolder is null&quot;);</span>
<a href="#l5.410"></a><span id="l5.410">     nsCOMPtr&lt;nsIMutableArray&gt; messageArray =</span>
<a href="#l5.411"></a><span id="l5.411">         do_QueryElementAt(m_hdrsForEachFolder, mCurIndex);</span>
<a href="#l5.412"></a><span id="l5.412">     NS_ASSERTION(messageArray, &quot;messageArray is null&quot;);</span>
<a href="#l5.413"></a><span id="l5.413"> </span>
<a href="#l5.414"></a><span id="l5.414">     // called for delete with trash, copy and move</span>
<a href="#l5.415"></a><span id="l5.415">     if (mCommand == nsMsgViewCommandType::deleteMsg)</span>
<a href="#l5.416"></a><span id="l5.416">         curFolder-&gt;DeleteMessages(messageArray, window, PR_FALSE /* delete storage */, PR_FALSE /* is move*/, this, PR_TRUE /*allowUndo*/);</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineat">@@ -574,33 +547,29 @@ nsresult nsMsgSearchDBView::ProcessReque</span>
<a href="#l5.418"></a><span id="l5.418">          }</span>
<a href="#l5.419"></a><span id="l5.419">       }</span>
<a href="#l5.420"></a><span id="l5.420">     }</span>
<a href="#l5.421"></a><span id="l5.421">     return rv;</span>
<a href="#l5.422"></a><span id="l5.422"> }</span>
<a href="#l5.423"></a><span id="l5.423"> </span>
<a href="#l5.424"></a><span id="l5.424"> nsresult nsMsgSearchDBView::ProcessRequestsInAllFolders(nsIMsgWindow *window)</span>
<a href="#l5.425"></a><span id="l5.425"> {</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineminus">-    PRUint32 numFolders =0;</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-    nsresult rv = m_uniqueFoldersSelected-&gt;Count(&amp;numFolders);</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-    for (PRUint32 folderIndex=0; folderIndex &lt; numFolders; folderIndex++)</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-    {</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-       nsCOMPtr&lt;nsIMsgFolder&gt; curFolder =</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-           do_QueryElementAt(m_uniqueFoldersSelected, folderIndex);</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-       NS_ASSERTION (curFolder, &quot;curFolder is null&quot;);</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+  PRUint32 numFolders = m_uniqueFoldersSelected.Count();</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+  for (PRUint32 folderIndex = 0; folderIndex &lt; numFolders; folderIndex++)</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+  {</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+    nsIMsgFolder *curFolder = m_uniqueFoldersSelected[folderIndex];</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+    NS_ASSERTION (curFolder, &quot;curFolder is null&quot;);</span>
<a href="#l5.439"></a><span id="l5.439"> </span>
<a href="#l5.440"></a><span id="l5.440" class="difflineminus">-       nsCOMPtr&lt;nsIMutableArray&gt; messageArray =</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; messageArray =</span>
<a href="#l5.442"></a><span id="l5.442">            do_QueryElementAt(m_hdrsForEachFolder, folderIndex);</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-       NS_ASSERTION(messageArray, &quot;messageArray is null&quot;);</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+    NS_ASSERTION(messageArray, &quot;messageArray is null&quot;);</span>
<a href="#l5.445"></a><span id="l5.445"> </span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-       curFolder-&gt;DeleteMessages(messageArray, window, PR_TRUE /* delete storage */, PR_FALSE /* is move*/, nsnull/*copyServListener*/, PR_FALSE /*allowUndo*/ );</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-    }</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+    curFolder-&gt;DeleteMessages(messageArray, window, PR_TRUE /* delete storage */, PR_FALSE /* is move*/, nsnull/*copyServListener*/, PR_FALSE /*allowUndo*/ );</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+  }</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.453"></a><span id="l5.453"> }</span>
<a href="#l5.454"></a><span id="l5.454"> </span>
<a href="#l5.455"></a><span id="l5.455"> NS_IMETHODIMP nsMsgSearchDBView::Sort(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l5.456"></a><span id="l5.456"> {</span>
<a href="#l5.457"></a><span id="l5.457">     nsresult rv;</span>
<a href="#l5.458"></a><span id="l5.458">     PRInt32 rowCountBeforeSort = GetSize();</span>
<a href="#l5.459"></a><span id="l5.459"> </span>
<a href="#l5.460"></a><span id="l5.460">     if (!rowCountBeforeSort)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -68,36 +68,36 @@ public:</span>
<a href="#l6.4"></a><span id="l6.4">   // override to get location</span>
<a href="#l6.5"></a><span id="l6.5">   NS_IMETHOD GetCellText(PRInt32 aRow, nsITreeColumn* aCol, nsAString&amp; aValue);</span>
<a href="#l6.6"></a><span id="l6.6">   virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr);</span>
<a href="#l6.7"></a><span id="l6.7">   virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey parentKey, PRBool ensureListed);</span>
<a href="#l6.8"></a><span id="l6.8">   NS_IMETHOD GetFolderForViewIndex(nsMsgViewIndex index, nsIMsgFolder **folder);</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   NS_IMETHOD OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  virtual nsresult GetFolders(nsISupportsArray **aFolders);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  virtual nsCOMArray&lt;nsIMsgFolder&gt;* GetFolders();</span>
<a href="#l6.14"></a><span id="l6.14">   virtual nsresult GetFolderFromMsgURI(const char *aMsgURI, nsIMsgFolder **aFolder);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> protected:</span>
<a href="#l6.17"></a><span id="l6.17">   nsresult FetchLocation(PRInt32 aRow, nsAString&amp; aLocationString);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  virtual nsresult AddHdrFromFolder(nsIMsgDBHdr *msgHdr, nsISupports *folder);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  virtual nsresult AddHdrFromFolder(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder);</span>
<a href="#l6.20"></a><span id="l6.20">   virtual nsresult GetDBForViewIndex(nsMsgViewIndex index, nsIMsgDatabase **db);</span>
<a href="#l6.21"></a><span id="l6.21">   virtual nsresult RemoveByIndex(nsMsgViewIndex index);</span>
<a href="#l6.22"></a><span id="l6.22">   virtual nsresult CopyMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, PRInt32 numIndices, PRBool isMove, nsIMsgFolder *destFolder);</span>
<a href="#l6.23"></a><span id="l6.23">   virtual nsresult DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, PRInt32 numIndices, PRBool deleteStorage);</span>
<a href="#l6.24"></a><span id="l6.24">   nsresult GetFoldersAndHdrsForSelection(nsMsgViewIndex *indices, PRInt32 numIndices);</span>
<a href="#l6.25"></a><span id="l6.25">   nsresult GroupSearchResultsByFolder();</span>
<a href="#l6.26"></a><span id="l6.26">   nsresult PartitionSelectionByFolder(nsMsgViewIndex *indices, PRInt32 numIndices, nsTArray&lt;PRUint32&gt; **indexArrays, PRInt32 *numArrays);</span>
<a href="#l6.27"></a><span id="l6.27">   virtual nsresult ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command, nsMsgViewIndex* indices,</span>
<a href="#l6.28"></a><span id="l6.28">                     PRInt32 numIndices, nsIMsgFolder *destFolder);</span>
<a href="#l6.29"></a><span id="l6.29">   </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  nsCOMPtr &lt;nsISupportsArray&gt; m_folders; // maybe we should store ranges, or the actual headers instead.</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  nsCOMArray&lt;nsIMsgFolder&gt; m_folders;</span>
<a href="#l6.32"></a><span id="l6.32">   nsCOMPtr &lt;nsISupportsArray&gt; m_hdrsForEachFolder;</span>
<a href="#l6.33"></a><span id="l6.33">   nsCOMPtr &lt;nsISupportsArray&gt; m_copyListenerList;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  nsCOMPtr &lt;nsISupportsArray&gt; m_uniqueFoldersSelected;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  nsCOMArray&lt;nsIMsgFolder&gt; m_uniqueFoldersSelected;</span>
<a href="#l6.36"></a><span id="l6.36">   PRInt32 mCurIndex;</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   nsMsgViewIndex* mIndicesForChainedDeleteAndFile;</span>
<a href="#l6.39"></a><span id="l6.39">   PRInt32 mTotalIndices;</span>
<a href="#l6.40"></a><span id="l6.40">   nsCOMArray&lt;nsIMsgDatabase&gt; m_dbToUseList;</span>
<a href="#l6.41"></a><span id="l6.41">   nsMsgViewCommandTypeValue mCommand;</span>
<a href="#l6.42"></a><span id="l6.42">   nsCOMPtr &lt;nsIMsgFolder&gt; mDestFolder;</span>
<a href="#l6.43"></a><span id="l6.43">   nsresult ProcessRequestsInOneFolder(nsIMsgWindow *window);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -190,29 +190,29 @@ NS_IMETHODIMP nsMsgXFVirtualFolderDBView</span>
<a href="#l7.4"></a><span id="l7.4">   if (!match &amp;&amp; plugin &amp;&amp; !wasPlugin)</span>
<a href="#l7.5"></a><span id="l7.5">     RemoveByIndex(index); // remove hdr from view</span>
<a href="#l7.6"></a><span id="l7.6">   else</span>
<a href="#l7.7"></a><span id="l7.7">     NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   return NS_OK;</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-nsresult nsMsgXFVirtualFolderDBView::InsertHdrFromFolder(nsIMsgDBHdr *msgHdr, nsISupports *folder)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+nsresult nsMsgXFVirtualFolderDBView::InsertHdrFromFolder(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder)</span>
<a href="#l7.14"></a><span id="l7.14"> {</span>
<a href="#l7.15"></a><span id="l7.15">   nsMsgViewIndex insertIndex = GetInsertIndex(msgHdr);</span>
<a href="#l7.16"></a><span id="l7.16">   if (insertIndex == nsMsgViewIndex_None)</span>
<a href="#l7.17"></a><span id="l7.17">     return AddHdrFromFolder(msgHdr, folder);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   nsMsgKey msgKey;</span>
<a href="#l7.20"></a><span id="l7.20">   PRUint32 msgFlags;</span>
<a href="#l7.21"></a><span id="l7.21">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l7.22"></a><span id="l7.22">   msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l7.23"></a><span id="l7.23">   m_keys.InsertElementAt(insertIndex, msgKey);</span>
<a href="#l7.24"></a><span id="l7.24">   m_flags.InsertElementAt(insertIndex, msgFlags);</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-  m_folders-&gt;InsertElementAt(folder, insertIndex);</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  m_folders.InsertObjectAt(folder, insertIndex);</span>
<a href="#l7.27"></a><span id="l7.27">   m_levels.InsertElementAt(insertIndex, 0);</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   // the call to NoteChange() has to happen after we add the key</span>
<a href="#l7.30"></a><span id="l7.30">   // as NoteChange() will call RowCountChanged() which will call our GetRowCount()</span>
<a href="#l7.31"></a><span id="l7.31">   NoteChange(insertIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l7.32"></a><span id="l7.32">   return NS_OK;</span>
<a href="#l7.33"></a><span id="l7.33"> }</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35" class="difflineat">@@ -272,47 +272,46 @@ void nsMsgXFVirtualFolderDBView::UpdateC</span>
<a href="#l7.36"></a><span id="l7.36">       // this must be a folder that had no hits with the current search.</span>
<a href="#l7.37"></a><span id="l7.37">       // So all cached hits, if any, need to be removed.</span>
<a href="#l7.38"></a><span id="l7.38">       UpdateCacheAndViewForFolder(m_foldersSearchingOver[0], 0, nsnull);</span>
<a href="#l7.39"></a><span id="l7.39">       m_foldersSearchingOver.RemoveObjectAt(0);</span>
<a href="#l7.40"></a><span id="l7.40">     }</span>
<a href="#l7.41"></a><span id="l7.41">   }</span>
<a href="#l7.42"></a><span id="l7.42"> }</span>
<a href="#l7.43"></a><span id="l7.43"> NS_IMETHODIMP</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-nsMsgXFVirtualFolderDBView::OnSearchHit(nsIMsgDBHdr* aMsgHdr, nsIMsgFolder *folder)</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+nsMsgXFVirtualFolderDBView::OnSearchHit(nsIMsgDBHdr* aMsgHdr, nsIMsgFolder *aFolder)</span>
<a href="#l7.46"></a><span id="l7.46"> {</span>
<a href="#l7.47"></a><span id="l7.47">   NS_ENSURE_ARG(aMsgHdr);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  NS_ENSURE_ARG(folder);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  NS_ENSURE_ARG(aFolder);</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(folder);</span>
<a href="#l7.52"></a><span id="l7.52">   nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l7.53"></a><span id="l7.53">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(dbToUse));</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  aFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(dbToUse));</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  if (m_curFolderGettingHits != folder &amp;&amp; m_doingSearch)</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  if (m_curFolderGettingHits != aFolder &amp;&amp; m_doingSearch)</span>
<a href="#l7.59"></a><span id="l7.59">   {</span>
<a href="#l7.60"></a><span id="l7.60">     m_curFolderHasCachedHits = PR_FALSE;</span>
<a href="#l7.61"></a><span id="l7.61">     // since we've gotten a hit for a new folder, the searches for</span>
<a href="#l7.62"></a><span id="l7.62">     // any previous folders are done, so deal with stale cached hits</span>
<a href="#l7.63"></a><span id="l7.63">     // for those folders now.</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    UpdateCacheAndViewForPrevSearchedFolders(folder);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    m_curFolderGettingHits = folder;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    UpdateCacheAndViewForPrevSearchedFolders(aFolder);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    m_curFolderGettingHits = aFolder;</span>
<a href="#l7.68"></a><span id="l7.68">     m_hdrHits.Clear();</span>
<a href="#l7.69"></a><span id="l7.69">     m_curFolderStartKeyIndex = m_keys.Length();</span>
<a href="#l7.70"></a><span id="l7.70">   }</span>
<a href="#l7.71"></a><span id="l7.71">   PRBool hdrInCache = PR_FALSE;</span>
<a href="#l7.72"></a><span id="l7.72">   nsCString searchUri;</span>
<a href="#l7.73"></a><span id="l7.73">   m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l7.74"></a><span id="l7.74">   dbToUse-&gt;HdrIsInCache(searchUri.get(), aMsgHdr, &amp;hdrInCache);</span>
<a href="#l7.75"></a><span id="l7.75">   if (!m_doingSearch || !m_curFolderHasCachedHits || !hdrInCache)</span>
<a href="#l7.76"></a><span id="l7.76">   {</span>
<a href="#l7.77"></a><span id="l7.77">     if (m_sortValid)</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-      InsertHdrFromFolder(aMsgHdr, supports);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      InsertHdrFromFolder(aMsgHdr, aFolder);</span>
<a href="#l7.80"></a><span id="l7.80">     else</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-      AddHdrFromFolder(aMsgHdr, supports);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+      AddHdrFromFolder(aMsgHdr, aFolder);</span>
<a href="#l7.83"></a><span id="l7.83">   }</span>
<a href="#l7.84"></a><span id="l7.84">   m_hdrHits.AppendObject(aMsgHdr);</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86">   return NS_OK;</span>
<a href="#l7.87"></a><span id="l7.87"> }</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89"> NS_IMETHODIMP</span>
<a href="#l7.90"></a><span id="l7.90"> nsMsgXFVirtualFolderDBView::OnSearchDone(nsresult status)</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineat">@@ -320,21 +319,21 @@ nsMsgXFVirtualFolderDBView::OnSearchDone</span>
<a href="#l7.92"></a><span id="l7.92">   // handle any non verified hits we haven't handled yet.</span>
<a href="#l7.93"></a><span id="l7.93">   UpdateCacheAndViewForPrevSearchedFolders(nsnull);</span>
<a href="#l7.94"></a><span id="l7.94"> </span>
<a href="#l7.95"></a><span id="l7.95">   m_doingSearch = PR_FALSE;</span>
<a href="#l7.96"></a><span id="l7.96">   //we want to set imap delete model once the search is over because setting next</span>
<a href="#l7.97"></a><span id="l7.97">   //message after deletion will happen before deleting the message and search scope</span>
<a href="#l7.98"></a><span id="l7.98">   //can change with every search.</span>
<a href="#l7.99"></a><span id="l7.99">   mDeleteModel = nsMsgImapDeleteModels::MoveToTrash;  //set to default in case it is non-imap folder</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; curFolder = do_QueryElementAt(m_folders, 0);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFolder&gt; curFolder = m_folders.SafeObjectAt(0);</span>
<a href="#l7.102"></a><span id="l7.102">   if (curFolder)</span>
<a href="#l7.103"></a><span id="l7.103">     GetImapDeleteModel(curFolder);</span>
<a href="#l7.104"></a><span id="l7.104"> </span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l7.107"></a><span id="l7.107">   nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l7.108"></a><span id="l7.108">   nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l7.109"></a><span id="l7.109">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.110"></a><span id="l7.110">   // count up the number of unread and total messages from the view, and set those in the</span>
<a href="#l7.111"></a><span id="l7.111">   // folder - easier than trying to keep the count up to date in the face of</span>
<a href="#l7.112"></a><span id="l7.112">   // search hits coming in while the user is reading/deleting messages.</span>
<a href="#l7.113"></a><span id="l7.113">   PRInt32 numUnread = 0;</span>
<a href="#l7.114"></a><span id="l7.114">   for (PRUint32 i = 0; i &lt; m_flags.Length(); i++)</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineat">@@ -359,17 +358,17 @@ NS_IMETHODIMP</span>
<a href="#l7.116"></a><span id="l7.116"> nsMsgXFVirtualFolderDBView::OnNewSearch()</span>
<a href="#l7.117"></a><span id="l7.117"> {</span>
<a href="#l7.118"></a><span id="l7.118">   PRInt32 oldSize = GetSize();</span>
<a href="#l7.119"></a><span id="l7.119"> </span>
<a href="#l7.120"></a><span id="l7.120">   RemovePendingDBListeners();</span>
<a href="#l7.121"></a><span id="l7.121"> </span>
<a href="#l7.122"></a><span id="l7.122">   m_doingSearch = PR_TRUE;</span>
<a href="#l7.123"></a><span id="l7.123"> </span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-  m_folders-&gt;Clear();</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  m_folders.Clear();</span>
<a href="#l7.126"></a><span id="l7.126">   m_keys.Clear();</span>
<a href="#l7.127"></a><span id="l7.127">   m_levels.Clear();</span>
<a href="#l7.128"></a><span id="l7.128">   m_flags.Clear();</span>
<a href="#l7.129"></a><span id="l7.129"> </span>
<a href="#l7.130"></a><span id="l7.130">   // needs to happen after we remove the keys, since RowCountChanged() will call our GetRowCount()</span>
<a href="#l7.131"></a><span id="l7.131">   if (mTree)</span>
<a href="#l7.132"></a><span id="l7.132">     mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l7.133"></a><span id="l7.133"> </span>
<a href="#l7.134"></a><span id="l7.134" class="difflineat">@@ -416,17 +415,17 @@ nsMsgXFVirtualFolderDBView::OnNewSearch(</span>
<a href="#l7.135"></a><span id="l7.135">               nsresult rv = cachedHits-&gt;GetNext(getter_AddRefs(pHeader));</span>
<a href="#l7.136"></a><span id="l7.136">               NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l7.137"></a><span id="l7.137">               if (pHeader &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l7.138"></a><span id="l7.138">               {</span>
<a href="#l7.139"></a><span id="l7.139">                 nsMsgKey msgKey;</span>
<a href="#l7.140"></a><span id="l7.140">                 pHeader-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l7.141"></a><span id="l7.141">                 NS_ASSERTION(prevKey == nsMsgKey_None || msgKey &gt; prevKey, &quot;cached Hits not sorted&quot;);</span>
<a href="#l7.142"></a><span id="l7.142">                 prevKey = msgKey;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-                AddHdrFromFolder(pHeader, searchFolder); // need to QI to nsISupports?</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+                AddHdrFromFolder(pHeader, searchFolder);</span>
<a href="#l7.145"></a><span id="l7.145">               }</span>
<a href="#l7.146"></a><span id="l7.146">               else</span>
<a href="#l7.147"></a><span id="l7.147">                 break;</span>
<a href="#l7.148"></a><span id="l7.148">               cachedHits-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l7.149"></a><span id="l7.149">             }</span>
<a href="#l7.150"></a><span id="l7.150">           }</span>
<a href="#l7.151"></a><span id="l7.151">         }</span>
<a href="#l7.152"></a><span id="l7.152">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -62,17 +62,17 @@ public:</span>
<a href="#l8.4"></a><span id="l8.4">   NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance, </span>
<a href="#l8.5"></a><span id="l8.5">                         nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l8.6"></a><span id="l8.6">   NS_IMETHOD Close();</span>
<a href="#l8.7"></a><span id="l8.7">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType);</span>
<a href="#l8.8"></a><span id="l8.8">   NS_IMETHOD DoCommand(nsMsgViewCommandTypeValue command);</span>
<a href="#l8.9"></a><span id="l8.9">   virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey parentKey, PRBool ensureListed);</span>
<a href="#l8.10"></a><span id="l8.10">   NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, PRBool aPreChange, PRUint32 *aStatus, </span>
<a href="#l8.11"></a><span id="l8.11">                                  nsIDBChangeListener * aInstigator);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  virtual nsresult InsertHdrFromFolder(nsIMsgDBHdr *msgHdr, nsISupports *folder);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  virtual nsresult InsertHdrFromFolder(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder);</span>
<a href="#l8.14"></a><span id="l8.14">   NS_IMETHOD GetMsgFolder(nsIMsgFolder **aMsgFolder);</span>
<a href="#l8.15"></a><span id="l8.15">   void UpdateCacheAndViewForPrevSearchedFolders(nsIMsgFolder *curSearchFolder);</span>
<a href="#l8.16"></a><span id="l8.16">   void UpdateCacheAndViewForFolder(nsIMsgFolder *folder, nsMsgKey *newHits, PRUint32 numNewHits);</span>
<a href="#l8.17"></a><span id="l8.17">   void RemovePendingDBListeners();</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> protected:</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21">   PRUint32 m_cachedFolderArrayIndex; // array index of next folder with cached hits to deal with.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

