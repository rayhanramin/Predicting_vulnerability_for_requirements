<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8409:ea39ab19873be154c3cd2be886335c7b37b0aff0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ea39ab19873be154c3cd2be886335c7b37b0aff0" />
<meta property="og:url" content="/comm-central/rev/ea39ab19873be154c3cd2be886335c7b37b0aff0" />
<meta property="og:description" content="Bug 656984 - Fakeserver fails to support multiple connections properly, r=Standard8." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ea39ab19873be154c3cd2be886335c7b37b0aff0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ea39ab19873be154c3cd2be886335c7b37b0aff0">shortlog</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ea39ab19873be154c3cd2be886335c7b37b0aff0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0">files</a> |
changeset |
<a href="/comm-central/raw-rev/ea39ab19873be154c3cd2be886335c7b37b0aff0">raw</a>  | <a href="/comm-central/archive/ea39ab19873be154c3cd2be886335c7b37b0aff0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=656984">Bug 656984</a> - Fakeserver fails to support multiple connections properly, r=Standard8.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 18 May 2011 14:29:57 -0400</td></tr>

<tr>
 <td>changeset 8409</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ea39ab19873be154c3cd2be886335c7b37b0aff0">ea39ab19873be154c3cd2be886335c7b37b0aff0</a></td>
</tr>



<tr>
<td>parent 8408</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/90378dba149ff8ec398719de6c7151872d2b46ec">90378dba149ff8ec398719de6c7151872d2b46ec</a>
</td>
</tr>

<tr>
<td>child 8410</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2733bbfdc64bcb759d5f98f86249051e37a5e75f">2733bbfdc64bcb759d5f98f86249051e37a5e75f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ea39ab19873be154c3cd2be886335c7b37b0aff0">6452</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 01 Sep 2011 16:12:54 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ea39ab19873b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ea39ab19873be154c3cd2be886335c7b37b0aff0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ea39ab19873be154c3cd2be886335c7b37b0aff0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ea39ab19873be154c3cd2be886335c7b37b0aff0&newProject=comm-central&newRevision=ea39ab19873be154c3cd2be886335c7b37b0aff0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ea39ab19873be154c3cd2be886335c7b37b0aff0&newProject=comm-central&newRevision=ea39ab19873be154c3cd2be886335c7b37b0aff0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ea39ab19873be154c3cd2be886335c7b37b0aff0&newProject=comm-central&newRevision=ea39ab19873be154c3cd2be886335c7b37b0aff0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=656984">656984</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=656984">Bug 656984</a> - Fakeserver fails to support multiple connections properly, r=Standard8.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/head_compose.js">mailnews/compose/test/unit/head_compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/head_compose.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/head_compose.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/head_compose.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/head_compose.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/head_compose.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug155172.js">mailnews/compose/test/unit/test_bug155172.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug155172.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug155172.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug155172.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug155172.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug155172.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug474774.js">mailnews/compose/test/unit/test_bug474774.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug474774.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug474774.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug474774.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug474774.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_bug474774.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendBackground.js">mailnews/compose/test/unit/test_sendBackground.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendBackground.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendBackground.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendBackground.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendBackground.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendBackground.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageFile.js">mailnews/compose/test/unit/test_sendMessageFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageFile.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageFile.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageFile.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageFile.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageFile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater.js">mailnews/compose/test/unit/test_sendMessageLater.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater2.js">mailnews/compose/test/unit/test_sendMessageLater2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater2.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater2.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater2.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater2.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_sendMessageLater2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpAuthMethods.js">mailnews/compose/test/unit/test_smtpAuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpAuthMethods.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpAuthMethods.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpAuthMethods.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpAuthMethods.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpAuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPassword.js">mailnews/compose/test/unit/test_smtpPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPassword.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPassword.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPassword.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPassword.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPassword.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">mailnews/compose/test/unit/test_smtpPasswordFailure1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">mailnews/compose/test/unit/test_smtpPasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">mailnews/compose/test/unit/test_smtpPasswordFailure3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/head_server.js">mailnews/imap/test/unit/head_server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/head_server.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/head_server.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/head_server.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/head_server.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/head_server.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapAuthMethods.js">mailnews/imap/test/unit/test_imapAuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapAuthMethods.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapAuthMethods.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapAuthMethods.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapAuthMethods.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapAuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapCopyTimeout.js">mailnews/imap/test/unit/test_imapCopyTimeout.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapCopyTimeout.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapCopyTimeout.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapCopyTimeout.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapCopyTimeout.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapCopyTimeout.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapFolderCopy.js">mailnews/imap/test/unit/test_imapFolderCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapFolderCopy.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapFolderCopy.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapFolderCopy.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapFolderCopy.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapFolderCopy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapPasswordFailure.js">mailnews/imap/test/unit/test_imapPasswordFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapPasswordFailure.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapPasswordFailure.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapPasswordFailure.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapPasswordFailure.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_imapPasswordFailure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_starttlsFailure.js">mailnews/imap/test/unit/test_starttlsFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_starttlsFailure.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_starttlsFailure.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_starttlsFailure.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_starttlsFailure.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/imap/test/unit/test_starttlsFailure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/head_maillocal.js">mailnews/local/test/unit/head_maillocal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/head_maillocal.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/head_maillocal.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/head_maillocal.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/head_maillocal.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/head_maillocal.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3GSSAPIFail.js">mailnews/local/test/unit/test_pop3GSSAPIFail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3GSSAPIFail.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3GSSAPIFail.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3GSSAPIFail.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3GSSAPIFail.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3GSSAPIFail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure2.js">mailnews/local/test/unit/test_pop3PasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure3.js">mailnews/local/test/unit/test_pop3PasswordFailure3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure3.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure3.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure3.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure3.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3PasswordFailure3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_verifyLogon.js">mailnews/local/test/unit/test_verifyLogon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_verifyLogon.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_verifyLogon.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_verifyLogon.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_verifyLogon.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/local/test/unit/test_verifyLogon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/head_server_setup.js">mailnews/news/test/unit/head_server_setup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/head_server_setup.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/head_server_setup.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/head_server_setup.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/head_server_setup.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/head_server_setup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_biff.js">mailnews/news/test/unit/test_biff.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_biff.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_biff.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_biff.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_biff.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_biff.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug37465.js">mailnews/news/test/unit/test_bug37465.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug37465.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug37465.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug37465.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug37465.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug37465.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug403242.js">mailnews/news/test/unit/test_bug403242.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug403242.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug403242.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug403242.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug403242.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug403242.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug540288.js">mailnews/news/test/unit/test_bug540288.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug540288.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug540288.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug540288.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug540288.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_bug540288.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_filter.js">mailnews/news/test/unit/test_filter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_filter.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_filter.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_filter.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_filter.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_filter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_getNewsMessage.js">mailnews/news/test/unit/test_getNewsMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_getNewsMessage.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_getNewsMessage.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_getNewsMessage.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_getNewsMessage.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_getNewsMessage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_internalUris.js">mailnews/news/test/unit/test_internalUris.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_internalUris.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_internalUris.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_internalUris.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_internalUris.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_internalUris.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpContentLength.js">mailnews/news/test/unit/test_nntpContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpContentLength.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpContentLength.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpContentLength.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpContentLength.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword.js">mailnews/news/test/unit/test_nntpPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword2.js">mailnews/news/test/unit/test_nntpPassword2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword2.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword2.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword2.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword2.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPassword2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPost.js">mailnews/news/test/unit/test_nntpPost.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPost.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPost.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPost.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPost.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_nntpPost.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_server.js">mailnews/news/test/unit/test_server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_server.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_server.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_server.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_server.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/news/test/unit/test_server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/imapd.js">mailnews/test/fakeserver/imapd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/imapd.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/imapd.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/imapd.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/imapd.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/imapd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/maild.js">mailnews/test/fakeserver/maild.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/maild.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/maild.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/maild.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/maild.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/maild.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/smtpd.js">mailnews/test/fakeserver/smtpd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/smtpd.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/smtpd.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/smtpd.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/smtpd.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/fakeserver/smtpd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/IMAPpump.js">mailnews/test/resources/IMAPpump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/IMAPpump.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/IMAPpump.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/IMAPpump.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/IMAPpump.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/IMAPpump.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/POP3pump.js">mailnews/test/resources/POP3pump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/POP3pump.js">file</a> |
<a href="/comm-central/annotate/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/POP3pump.js">annotate</a> |
<a href="/comm-central/diff/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/POP3pump.js">diff</a> |
<a href="/comm-central/comparison/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/POP3pump.js">comparison</a> |
<a href="/comm-central/log/ea39ab19873be154c3cd2be886335c7b37b0aff0/mailnews/test/resources/POP3pump.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -10,18 +10,18 @@ load(&quot;../../../fakeserver/maild.js&quot;)</span>
<a href="#l1.4"></a><span id="l1.4"> load(&quot;../../../fakeserver/auth.js&quot;)</span>
<a href="#l1.5"></a><span id="l1.5"> load(&quot;../../../fakeserver/smtpd.js&quot;)</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> const SMTP_PORT = 1024+120;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // Setup the daemon and server</span>
<a href="#l1.10"></a><span id="l1.10"> function setupServerDaemon(handler) {</span>
<a href="#l1.11"></a><span id="l1.11">   if (!handler)</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    handler = function (d) { return new SMTP_RFC2821_handler(d); }</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  var server = new nsMailServer(handler, new smtpDaemon());</span>
<a href="#l1.16"></a><span id="l1.16">   return server;</span>
<a href="#l1.17"></a><span id="l1.17"> }</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> function getBasicSmtpServer() {</span>
<a href="#l1.20"></a><span id="l1.20">   let server = create_outgoing_server(SMTP_PORT, &quot;user&quot;, &quot;password&quot;);</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">   // Override the default greeting so we get something predicitable</span>
<a href="#l1.23"></a><span id="l1.23">   // in the ELHO message</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -27,24 +27,27 @@ const kUsername = &quot;test.smtp@fakeserver&quot;</span>
<a href="#l2.4"></a><span id="l2.4"> // kPassword 2 is the one defined in signons-mailnews1.8.txt, the other one</span>
<a href="#l2.5"></a><span id="l2.5"> // is intentionally wrong.</span>
<a href="#l2.6"></a><span id="l2.6"> const kPassword1 = &quot;wrong&quot;;</span>
<a href="#l2.7"></a><span id="l2.7"> const kPassword2 = &quot;smtptest&quot;;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> function run_test() {</span>
<a href="#l2.10"></a><span id="l2.10">   registerAlertTestUtils();</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  // Username needs to match signons.txt</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  handler.kUsername = kUsername;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  handler.kPassword = kPassword1;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  handler.kAuthRequired = true;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    // Username needs to match signons.txt</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    handler.kUsername = kUsername;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    handler.kPassword = kPassword1;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    handler.kAuthRequired = true;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    return handler;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  }</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  server = setupServerDaemon(handler);</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  server = setupServerDaemon(createHandler);</span>
<a href="#l2.30"></a><span id="l2.30">   server.setDebugLevel(fsDebugAll);</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l2.33"></a><span id="l2.33">   var signons = do_get_file(&quot;data/signons-smtp.txt&quot;);</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">   // Copy the file to the profile directory for a PAB</span>
<a href="#l2.36"></a><span id="l2.36">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l2.37"></a><span id="l2.37"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -53,17 +53,17 @@ msll.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">       do_check_transaction(server.playTransaction(),</span>
<a href="#l3.6"></a><span id="l3.6">                            [&quot;EHLO test&quot;,</span>
<a href="#l3.7"></a><span id="l3.7">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + originalData.length,</span>
<a href="#l3.8"></a><span id="l3.8">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l3.9"></a><span id="l3.9">                             &quot;DATA&quot;]);</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">       // Compare data file to what the server received</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      do_check_eq(originalData, server._handler.post);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      do_check_eq(originalData, server._daemon.post);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">       // Now wait till the copy is finished for the sent message</span>
<a href="#l3.16"></a><span id="l3.16">       do_test_pending();</span>
<a href="#l3.17"></a><span id="l3.17">     } catch (e) {</span>
<a href="#l3.18"></a><span id="l3.18">       do_throw(e);</span>
<a href="#l3.19"></a><span id="l3.19">     } finally {</span>
<a href="#l3.20"></a><span id="l3.20">       server.stop();</span>
<a href="#l3.21"></a><span id="l3.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendBackground.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendBackground.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -53,17 +53,17 @@ msll.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">       do_check_transaction(server.playTransaction(),</span>
<a href="#l4.6"></a><span id="l4.6">                            [&quot;EHLO test&quot;,</span>
<a href="#l4.7"></a><span id="l4.7">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + originalData.length,</span>
<a href="#l4.8"></a><span id="l4.8">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l4.9"></a><span id="l4.9">                             &quot;DATA&quot;]);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">       // Compare data file to what the server received</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      do_check_eq(originalData, server._handler.post);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+      do_check_eq(originalData, server._daemon.post);</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">       // check there's still one message left in the folder</span>
<a href="#l4.16"></a><span id="l4.16">       do_check_eq(gMsgSendLater.getUnsentMessagesFolder(null)</span>
<a href="#l4.17"></a><span id="l4.17">                                .getTotalMessages(false), 1);</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">       finished = true;</span>
<a href="#l4.20"></a><span id="l4.20">     } catch (e) {</span>
<a href="#l4.21"></a><span id="l4.21">       do_throw(e);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageFile.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageFile.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -36,17 +36,17 @@ msl.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">       do_check_transaction(server.playTransaction(),</span>
<a href="#l5.6"></a><span id="l5.6">                            [&quot;EHLO test&quot;,</span>
<a href="#l5.7"></a><span id="l5.7">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + originalData.length,</span>
<a href="#l5.8"></a><span id="l5.8">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l5.9"></a><span id="l5.9">                             &quot;DATA&quot;]);</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">       // Compare data file to what the server received</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-      do_check_eq(originalData, server._handler.post);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+      do_check_eq(originalData, server._daemon.post);</span>
<a href="#l5.14"></a><span id="l5.14">     } catch (e) {</span>
<a href="#l5.15"></a><span id="l5.15">       do_throw(e);</span>
<a href="#l5.16"></a><span id="l5.16">     } finally {</span>
<a href="#l5.17"></a><span id="l5.17">       server.stop();</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">       var thread = gThreadManager.currentThread;</span>
<a href="#l5.20"></a><span id="l5.20">       while (thread.hasPendingEvents())</span>
<a href="#l5.21"></a><span id="l5.21">         thread.processNextEvent(false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -64,17 +64,17 @@ msll.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">       do_check_transaction(server.playTransaction(),</span>
<a href="#l6.6"></a><span id="l6.6">                            [&quot;EHLO test&quot;,</span>
<a href="#l6.7"></a><span id="l6.7">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + originalData.length,</span>
<a href="#l6.8"></a><span id="l6.8">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l6.9"></a><span id="l6.9">                             &quot;DATA&quot;]);</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">       // Compare data file to what the server received</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-      do_check_eq(originalData, server._handler.post);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+      do_check_eq(originalData, server._daemon.post);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15">       finished = true;</span>
<a href="#l6.16"></a><span id="l6.16">     } catch (e) {</span>
<a href="#l6.17"></a><span id="l6.17">       do_throw(e);</span>
<a href="#l6.18"></a><span id="l6.18">     } finally {</span>
<a href="#l6.19"></a><span id="l6.19">       server.stop();</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">       var thread = gThreadManager.currentThread;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater2.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater2.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -51,17 +51,17 @@ msll.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">   checkMessageSend: function(aCurrentMessage) {</span>
<a href="#l7.5"></a><span id="l7.5">     do_check_transaction(server.playTransaction(),</span>
<a href="#l7.6"></a><span id="l7.6">                          [&quot;EHLO test&quot;,</span>
<a href="#l7.7"></a><span id="l7.7">                           &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + gMsgFileData[gMsgOrder[aCurrentMessage - 1]].length,</span>
<a href="#l7.8"></a><span id="l7.8">                           &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l7.9"></a><span id="l7.9">                           &quot;DATA&quot;]);</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">     // Compare data file to what the server received</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    do_check_eq(gMsgFileData[gMsgOrder[aCurrentMessage - 1]], server._handler.post);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    do_check_eq(gMsgFileData[gMsgOrder[aCurrentMessage - 1]], server._daemon.post);</span>
<a href="#l7.14"></a><span id="l7.14">   },</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16">   // nsIMsgSendLaterListener</span>
<a href="#l7.17"></a><span id="l7.17">   onStartSending: function (aTotalMessageCount) {</span>
<a href="#l7.18"></a><span id="l7.18">     do_check_eq(aTotal, gMsgOrder.length);</span>
<a href="#l7.19"></a><span id="l7.19">     do_check_eq(msgSendLater.sendingMessages, true);</span>
<a href="#l7.20"></a><span id="l7.20">   },</span>
<a href="#l7.21"></a><span id="l7.21">   onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpAuthMethods.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpAuthMethods.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /**</span>
<a href="#l8.6"></a><span id="l8.6">  * Authentication tests for SMTP.</span>
<a href="#l8.7"></a><span id="l8.7">  *</span>
<a href="#l8.8"></a><span id="l8.8">  * Test code &lt;copied from=&quot;test_pop3AuthMethods.js&quot;&gt;</span>
<a href="#l8.9"></a><span id="l8.9">  */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> var server;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var handler;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+var kAuthSchemes;</span>
<a href="#l8.14"></a><span id="l8.14"> var smtpServer;</span>
<a href="#l8.15"></a><span id="l8.15"> var smtpService;</span>
<a href="#l8.16"></a><span id="l8.16"> var testFile;</span>
<a href="#l8.17"></a><span id="l8.17"> var identity;</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> const kUsername = &quot;fred&quot;;</span>
<a href="#l8.20"></a><span id="l8.20"> const kPassword = &quot;wilma&quot;;</span>
<a href="#l8.21"></a><span id="l8.21"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -64,17 +64,17 @@ function nextTest() {</span>
<a href="#l8.23"></a><span id="l8.23">   server.resetTest();</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   var curTest = tests.shift();</span>
<a href="#l8.26"></a><span id="l8.26">   test = curTest.title;</span>
<a href="#l8.27"></a><span id="l8.27">   dump(&quot;NEXT test: &quot; + curTest.title + &quot;\n&quot;);</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30">   // Adapt to curTest</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  handler.kAuthSchemes = curTest.serverAuthMethods;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  kAuthSchemes = curTest.serverAuthMethods;</span>
<a href="#l8.33"></a><span id="l8.33">   smtpServer.authMethod = curTest.clientAuthMethod;</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35">   // Run test</span>
<a href="#l8.36"></a><span id="l8.36">   smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l8.37"></a><span id="l8.37">                               null, null, null, null,</span>
<a href="#l8.38"></a><span id="l8.38">                               false, {}, {});</span>
<a href="#l8.39"></a><span id="l8.39">   server.performTest();</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -82,29 +82,33 @@ function nextTest() {</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43">   nextTest();</span>
<a href="#l8.44"></a><span id="l8.44"> }</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46"> function run_test() {</span>
<a href="#l8.47"></a><span id="l8.47">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l8.48"></a><span id="l8.48">   // the server if something fails.</span>
<a href="#l8.49"></a><span id="l8.49">   try {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    server = new nsMailServer(handler);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    handler.kUsername = kUsername;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    handler.kPassword = kPassword;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-    handler.kAuthRequired = true;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+    function createHandler(d) {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+      var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+      handler.kUsername = kUsername;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+      handler.kPassword = kPassword;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+      handler.kAuthRequired = true;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+      handler.kAuthSchemes = kAuthSchemes;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+      return handler;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    }</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+    server = setupServerDaemon(createHandler);</span>
<a href="#l8.64"></a><span id="l8.64">     dump(&quot;AUTH PLAIN = &quot; + AUTHPLAIN + &quot;\n&quot;);</span>
<a href="#l8.65"></a><span id="l8.65">     server.start(SMTP_PORT);</span>
<a href="#l8.66"></a><span id="l8.66"> </span>
<a href="#l8.67"></a><span id="l8.67">     loadLocalMailAccount();</span>
<a href="#l8.68"></a><span id="l8.68">     smtpServer = getBasicSmtpServer();</span>
<a href="#l8.69"></a><span id="l8.69">     smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-    smtpServer.username = handler.kUsername;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-    smtpServer.password = handler.kPassword;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    smtpServer.username = kUsername;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    smtpServer.password = kPassword;</span>
<a href="#l8.74"></a><span id="l8.74">     identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l8.75"></a><span id="l8.75">     smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l8.76"></a><span id="l8.76">                         .getService(Ci.nsISmtpService);</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78">     testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80">     nextTest();</span>
<a href="#l8.81"></a><span id="l8.81"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -7,22 +7,25 @@ var server;</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l9.6"></a><span id="l9.6"> const kTo = &quot;to@invalid.com&quot;;</span>
<a href="#l9.7"></a><span id="l9.7"> const kUsername = &quot;testsmtp&quot;;</span>
<a href="#l9.8"></a><span id="l9.8"> // This is the same as in the signons file.</span>
<a href="#l9.9"></a><span id="l9.9"> const kPassword = &quot;smtptest&quot;;</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> function run_test() {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-  // Username and password need to match signons.txt</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  handler.kUsername = kUsername;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-  handler.kPassword = kPassword;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-  handler.kAuthRequired = true;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+    // Username needs to match signons.txt</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    handler.kUsername = kUsername;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    handler.kPassword = kPassword;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+    handler.kAuthRequired = true;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+    return handler;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  }</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  server = setupServerDaemon(createHandler);</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l9.29"></a><span id="l9.29">   var signons = do_get_file(&quot;../../../data/signons-mailnews1.8.txt&quot;);</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31">   // Copy the file to the profile directory for a PAB</span>
<a href="#l9.32"></a><span id="l9.32">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">   // Test file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -72,22 +72,25 @@ function confirmEx(aDialogTitle, aText, </span>
<a href="#l10.4"></a><span id="l10.4">       return 1;</span>
<a href="#l10.5"></a><span id="l10.5">     default:</span>
<a href="#l10.6"></a><span id="l10.6">       do_throw(&quot;unexpected attempt number &quot; + attempt);</span>
<a href="#l10.7"></a><span id="l10.7">       return 1;</span>
<a href="#l10.8"></a><span id="l10.8">   }</span>
<a href="#l10.9"></a><span id="l10.9"> }</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> function run_test() {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  // Username needs to match signons.txt</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-  handler.kUsername = kUsername;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-  handler.kPassword = kValidPassword;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-  handler.kAuthRequired = true;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+    var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+    // Username needs to match signons.txt</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+    handler.kUsername = kUsername;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+    handler.kPassword = kValidPassword;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+    handler.kAuthRequired = true;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+    return handler;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  }</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+  server = setupServerDaemon(createHandler);</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l10.29"></a><span id="l10.29">   var signons = do_get_file(&quot;../../../data/signons-mailnews1.8.txt&quot;);</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">   // Copy the file to the profile directory for a PAB</span>
<a href="#l10.32"></a><span id="l10.32">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34">   registerAlertTestUtils();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -82,23 +82,26 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l11.4"></a><span id="l11.4">     aPassword.value = kValidPassword;</span>
<a href="#l11.5"></a><span id="l11.5">     aCheckState.value = true;</span>
<a href="#l11.6"></a><span id="l11.6">     return true;</span>
<a href="#l11.7"></a><span id="l11.7">   }</span>
<a href="#l11.8"></a><span id="l11.8">   return false;</span>
<a href="#l11.9"></a><span id="l11.9"> }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> function run_test() {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  // Username needs to match signons.txt</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  handler.kUsername = kUsername;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-  handler.kPassword = kValidPassword;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-  handler.kAuthRequired = true;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-  handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    // Username needs to match signons.txt</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+    handler.kUsername = kUsername;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+    handler.kPassword = kValidPassword;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+    handler.kAuthRequired = true;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+    handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+    return handler;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+  }</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+  server = setupServerDaemon(createHandler);</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l11.31"></a><span id="l11.31">   var signons = do_get_file(&quot;../../../data/signons-mailnews1.8.txt&quot;);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">   // Copy the file to the profile directory for a PAB</span>
<a href="#l11.34"></a><span id="l11.34">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36">   registerAlertTestUtils();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -80,24 +80,27 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l12.4"></a><span id="l12.4">     aPassword.value = kValidPassword;</span>
<a href="#l12.5"></a><span id="l12.5">     aCheckState.value = true;</span>
<a href="#l12.6"></a><span id="l12.6">     return true;</span>
<a href="#l12.7"></a><span id="l12.7">   }</span>
<a href="#l12.8"></a><span id="l12.8">   return false;</span>
<a href="#l12.9"></a><span id="l12.9"> }</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> function run_test() {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  handler.dropOnAuthFailure = true;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-  // Username needs to match signons.txt</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-  handler.kUsername = kUsername;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-  handler.kPassword = kValidPassword;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-  handler.kAuthRequired = true;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-  handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+    var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+    handler.dropOnAuthFailure = true;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+    // Username needs to match signons.txt</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+    handler.kUsername = kUsername;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+    handler.kPassword = kValidPassword;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+    handler.kAuthRequired = true;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+    handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+    return handler;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+  }</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+  server = setupServerDaemon(createHandler);</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l12.33"></a><span id="l12.33">   var signons = do_get_file(&quot;../../../data/signons-mailnews1.8.txt&quot;);</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">   // Copy the file to the profile directory for a PAB</span>
<a href="#l12.36"></a><span id="l12.36">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">   registerAlertTestUtils();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/test/unit/head_server.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/test/unit/head_server.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -9,30 +9,37 @@ load(gDEPTH + &quot;mailnews/fakeserver/auth.</span>
<a href="#l13.4"></a><span id="l13.4"> load(gDEPTH + &quot;mailnews/fakeserver/imapd.js&quot;);</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> // And mailnews scripts</span>
<a href="#l13.7"></a><span id="l13.7"> load(gDEPTH + &quot;mailnews/resources/mailDirService.js&quot;);</span>
<a href="#l13.8"></a><span id="l13.8"> load(gDEPTH + &quot;mailnews/resources/mailTestUtils.js&quot;);</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> const IMAP_PORT = 1024 + 143;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-function makeServer(daemon, infoString) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+function makeServer(daemon, infoString, otherProps) {</span>
<a href="#l13.14"></a><span id="l13.14">   if (infoString in configurations)</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-    return makeServer(daemon, configurations[infoString].join(&quot;,&quot;));</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+    return makeServer(daemon, configurations[infoString].join(&quot;,&quot;), otherProps);</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+    var handler = new IMAP_RFC3501_handler(d);</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+    if (!infoString)</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+      infoString = &quot;RFC2195&quot;;</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  var handler = new IMAP_RFC3501_handler(daemon);</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-  if (!infoString)</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-    infoString = &quot;RFC2195&quot;;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  var parts = infoString.split(/ *, */);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-  for each (var part in parts) {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    if (part.substring(0, 3) == &quot;RFC&quot;)</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-      mixinExtension(handler, eval(&quot;IMAP_&quot; + part + &quot;_extension&quot;));</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+    var parts = infoString.split(/ *, */);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+    for each (var part in parts) {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+      if (part.substring(0, 3) == &quot;RFC&quot;)</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+        mixinExtension(handler, eval(&quot;IMAP_&quot; + part + &quot;_extension&quot;));</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    }</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+    if (otherProps) {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+      for (var prop in otherProps)</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+        handler[prop] = otherProps[prop];</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+    }</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+    return handler;</span>
<a href="#l13.41"></a><span id="l13.41">   }</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  var server = new nsMailServer(createHandler, daemon);</span>
<a href="#l13.44"></a><span id="l13.44">   server.start(IMAP_PORT);</span>
<a href="#l13.45"></a><span id="l13.45">   return server;</span>
<a href="#l13.46"></a><span id="l13.46"> }</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48"> function createLocalIMAPServer() {</span>
<a href="#l13.49"></a><span id="l13.49">   let server = create_incoming_server(&quot;imap&quot;, IMAP_PORT, &quot;user&quot;, &quot;password&quot;);</span>
<a href="#l13.50"></a><span id="l13.50">   server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l13.51"></a><span id="l13.51">   return server;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAuthMethods.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAuthMethods.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -81,24 +81,19 @@ function nextTest() {</span>
<a href="#l14.4"></a><span id="l14.4">       server.performTest();</span>
<a href="#l14.5"></a><span id="l14.5">     }*/</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7">     test = thisTest.title;</span>
<a href="#l14.8"></a><span id="l14.8">     dump(&quot;NEXT test: &quot; + thisTest.title + &quot;\n&quot;);</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10">     // (re)create fake server</span>
<a href="#l14.11"></a><span id="l14.11">     var daemon = new imapDaemon();</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    var server = makeServer(daemon, &quot;&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    var server = makeServer(daemon, &quot;&quot;,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+      {kAuthSchemes: thisTest.serverAuthMethods});</span>
<a href="#l14.15"></a><span id="l14.15">     server.setDebugLevel(fsDebugAll);</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-    var handler = server._handler;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-    //handler.kUsername = kUsername;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    //handler.kPassword = kPassword;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-    //daemon.createMailbox(&quot;somemailbox&quot;);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-    handler.kAuthSchemes = thisTest.serverAuthMethods;</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23">     // If Mailnews ever caches server capabilities, delete and re-create the incomingServer here</span>
<a href="#l14.24"></a><span id="l14.24">     var incomingServer = createLocalIMAPServer();</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">     let msgServer = incomingServer;</span>
<a href="#l14.27"></a><span id="l14.27">     msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l14.28"></a><span id="l14.28">     msgServer.authMethod = thisTest.clientAuthMethod;</span>
<a href="#l14.29"></a><span id="l14.29"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -106,17 +106,17 @@ var tests = [</span>
<a href="#l15.4"></a><span id="l15.4">   waitForOfflinePlayback,</span>
<a href="#l15.5"></a><span id="l15.5">   updateTargetFolder,</span>
<a href="#l15.6"></a><span id="l15.6">   endTest</span>
<a href="#l15.7"></a><span id="l15.7"> ]</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> let gTargetFolder;</span>
<a href="#l15.10"></a><span id="l15.10"> function createTargetFolder()</span>
<a href="#l15.11"></a><span id="l15.11"> {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  gIMAPServer._handler.copySleep = 5000;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  gIMAPDaemon.copySleep = 5000;</span>
<a href="#l15.14"></a><span id="l15.14">   gIMAPIncomingServer.rootFolder.createSubfolder(&quot;targetFolder&quot;, null);</span>
<a href="#l15.15"></a><span id="l15.15">   yield false; </span>
<a href="#l15.16"></a><span id="l15.16">   gTargetFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;targetFolder&quot;);</span>
<a href="#l15.17"></a><span id="l15.17">   do_check_true(gTargetFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l15.18"></a><span id="l15.18">   gTargetFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l15.19"></a><span id="l15.19">   yield false;</span>
<a href="#l15.20"></a><span id="l15.20"> }  </span>
<a href="#l15.21"></a><span id="l15.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -83,17 +83,17 @@ const gTestArray =</span>
<a href="#l16.4"></a><span id="l16.4">     do_check_neq(folder2, null);</span>
<a href="#l16.5"></a><span id="l16.5">     do_check_neq(folder3, null);</span>
<a href="#l16.6"></a><span id="l16.6">     doTest(++gCurTestNum);</span>
<a href="#l16.7"></a><span id="l16.7">   },</span>
<a href="#l16.8"></a><span id="l16.8">   function testImapFolderCopyFailure() {</span>
<a href="#l16.9"></a><span id="l16.9">     let folders = new Array;</span>
<a href="#l16.10"></a><span id="l16.10">     folders.push(gNotEmptyLocal4.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l16.11"></a><span id="l16.11">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    gServer._handler.commandToFail = &quot;APPEND&quot;;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    gIMAPDaemon.commandToFail = &quot;APPEND&quot;;</span>
<a href="#l16.14"></a><span id="l16.14">     // we expect NS_MSG_ERROR_IMAP_COMMAND_FAILED;</span>
<a href="#l16.15"></a><span id="l16.15">     CopyListener._expectedStatus = 0x80550021;</span>
<a href="#l16.16"></a><span id="l16.16">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l16.17"></a><span id="l16.17">   },</span>
<a href="#l16.18"></a><span id="l16.18">   function finishTest() {</span>
<a href="#l16.19"></a><span id="l16.19">     doTest(++gCurTestNum);</span>
<a href="#l16.20"></a><span id="l16.20">   }</span>
<a href="#l16.21"></a><span id="l16.21"> ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapPasswordFailure.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapPasswordFailure.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -87,22 +87,23 @@ function run_test() {</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">   // Copy the file to the profile directory for a PAB</span>
<a href="#l17.6"></a><span id="l17.6">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8">   registerAlertTestUtils();</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10">   let daemon = new imapDaemon();</span>
<a href="#l17.11"></a><span id="l17.11">   daemon.createMailbox(&quot;Subscribed&quot;, {subscribed : true});</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  server = makeServer(daemon, &quot;&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  server = makeServer(daemon, &quot;&quot;, {</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+    // Make username of server match the singons.txt file</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+    // (pw there is intentionally invalid)</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+    kUsername: kUserName,</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+    kPassword: kValidPassword});</span>
<a href="#l17.18"></a><span id="l17.18">   server.setDebugLevel(fsDebugAll);</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-  // Make username of server match the singons.txt file (pw there is intentionally invalid)</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-  server._handler.kUsername = kUserName;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-  server._handler.kPassword = kValidPassword;</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">   incomingServer = createLocalIMAPServer();</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">   // PerformExpand expects us to already have a password loaded into the</span>
<a href="#l17.27"></a><span id="l17.27">   // incomingServer when we call it, so force a get password call to get it</span>
<a href="#l17.28"></a><span id="l17.28">   // out of the signons file (first removing the value that</span>
<a href="#l17.29"></a><span id="l17.29">   // createLocalIMAPServer puts in there).</span>
<a href="#l17.30"></a><span id="l17.30">   incomingServer.password = &quot;&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -38,18 +38,17 @@ var dummyMsgWindow =</span>
<a href="#l18.4"></a><span id="l18.4"> function alert(aDialogTitle, aText) {</span>
<a href="#l18.5"></a><span id="l18.5">   do_check_eq(aText.indexOf(&quot;Server Mail for  has disconnected&quot;), 0);</span>
<a href="#l18.6"></a><span id="l18.6">   gGotAlert = true;</span>
<a href="#l18.7"></a><span id="l18.7"> }</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> function run_test() {</span>
<a href="#l18.10"></a><span id="l18.10">   // set up IMAP fakeserver and incoming server</span>
<a href="#l18.11"></a><span id="l18.11">   gIMAPDaemon = new imapDaemon();</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  gIMAPServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-  gIMAPServer._handler.dropOnStartTLS = true;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+  gIMAPServer = makeServer(gIMAPDaemon, &quot;&quot;, {dropOnStartTLS: true});</span>
<a href="#l18.15"></a><span id="l18.15">   gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l18.16"></a><span id="l18.16">   gIMAPIncomingServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18">   // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l18.19"></a><span id="l18.19">   loadLocalMailAccount();</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">   // We need an identity so that updateFolder doesn't fail</span>
<a href="#l18.22"></a><span id="l18.22">   let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/local/test/unit/head_maillocal.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/local/test/unit/head_maillocal.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -10,21 +10,28 @@ load(&quot;../../../fakeserver/auth.js&quot;)</span>
<a href="#l19.4"></a><span id="l19.4"> load(&quot;../../../fakeserver/pop3d.js&quot;)</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> const POP3_PORT = 1024+110;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> // Setup the daemon and server</span>
<a href="#l19.9"></a><span id="l19.9"> // If the debugOption is set, then it will be applied to the server.</span>
<a href="#l19.10"></a><span id="l19.10"> function setupServerDaemon(debugOption) {</span>
<a href="#l19.11"></a><span id="l19.11">   var daemon = new pop3Daemon();</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  var handler = new POP3_RFC5034_handler(daemon);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+  var extraProps = {};</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+    var handler = new POP3_RFC5034_handler(d);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+    for (var prop in extraProps) {</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+      handler[prop] = extraProps[prop];</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+    }</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+    return handler;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+  }</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+  var server = new nsMailServer(createHandler, daemon);</span>
<a href="#l19.23"></a><span id="l19.23">   if (debugOption)</span>
<a href="#l19.24"></a><span id="l19.24">     server.setDebugLevel(debugOption);</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-  return [daemon, server, handler];</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+  return [daemon, server, extraProps];</span>
<a href="#l19.27"></a><span id="l19.27"> }</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29"> function createPop3ServerAndLocalFolders() {</span>
<a href="#l19.30"></a><span id="l19.30">   loadLocalMailAccount();</span>
<a href="#l19.31"></a><span id="l19.31">   let server = create_incoming_server(&quot;pop3&quot;, POP3_PORT, &quot;fred&quot;, &quot;wilma&quot;);</span>
<a href="#l19.32"></a><span id="l19.32">   return server;</span>
<a href="#l19.33"></a><span id="l19.33"> }</span>
<a href="#l19.34"></a><span id="l19.34"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3GSSAPIFail.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3GSSAPIFail.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -15,17 +15,17 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * Actually, we (more precisely the OS GSSAPI lib) fail out of band</span>
<a href="#l20.5"></a><span id="l20.5">  * in the Kerberos protocol, before the AUTH GSSAPI command is even issued.</span>
<a href="#l20.6"></a><span id="l20.6">  *</span>
<a href="#l20.7"></a><span id="l20.7">  * @author Ben Bucksch</span>
<a href="#l20.8"></a><span id="l20.8">  */</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> var server;</span>
<a href="#l20.11"></a><span id="l20.11"> var daemon;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-var handler;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+var authSchemes;</span>
<a href="#l20.14"></a><span id="l20.14"> var incomingServer;</span>
<a href="#l20.15"></a><span id="l20.15"> var pop3Service;</span>
<a href="#l20.16"></a><span id="l20.16"> var acctMgr;</span>
<a href="#l20.17"></a><span id="l20.17"> var thisTest;</span>
<a href="#l20.18"></a><span id="l20.18"> var test = null;</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> var tests = [</span>
<a href="#l20.21"></a><span id="l20.21">   { title: &quot;GSSAPI auth, server with GSSAPI only&quot;,</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -114,17 +114,17 @@ function testNext() {</span>
<a href="#l20.23"></a><span id="l20.23">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l20.24"></a><span id="l20.24">   // the server if something fails.</span>
<a href="#l20.25"></a><span id="l20.25">   try {</span>
<a href="#l20.26"></a><span id="l20.26">     server.resetTest();</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">     test = thisTest.title;</span>
<a href="#l20.29"></a><span id="l20.29">     dump(&quot;NEXT test is: &quot; + thisTest.title + &quot;\n&quot;);</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-    handler.kAuthSchemes = thisTest.serverAuthMethods;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+    authSchemes = thisTest.serverAuthMethods;</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34">     // Mailnews caches server capabilities, so try to reset it</span>
<a href="#l20.35"></a><span id="l20.35">     deletePop3Server();</span>
<a href="#l20.36"></a><span id="l20.36">     incomingServer = createPop3Server();</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38">     let msgServer = incomingServer;</span>
<a href="#l20.39"></a><span id="l20.39">     msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l20.40"></a><span id="l20.40">     msgServer.authMethod = thisTest.clientAuthMethod;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineat">@@ -195,18 +195,22 @@ function run_test() {</span>
<a href="#l20.42"></a><span id="l20.42">     .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l20.43"></a><span id="l20.43"> </span>
<a href="#l20.44"></a><span id="l20.44">   prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l20.45"></a><span id="l20.45">   prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l20.46"></a><span id="l20.46">   prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l20.47"></a><span id="l20.47">   prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49">   daemon = new pop3Daemon();</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-  handler = new GSSAPIFail_handler(daemon);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+    var handler = new GSSAPIFail_handler(d);</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+    handler.kAuthSchemes = authSchemes;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+    return handler;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  }</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  server = new nsMailServer(createHandler, daemon);</span>
<a href="#l20.58"></a><span id="l20.58">   server.start(POP3_PORT);</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60">   //incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l20.61"></a><span id="l20.61">   loadLocalMailAccount();</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63">   pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l20.64"></a><span id="l20.64">                       .getService(Ci.nsIPop3Service);</span>
<a href="#l20.65"></a><span id="l20.65">   acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3PasswordFailure2.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3PasswordFailure2.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -204,23 +204,26 @@ function run_test()</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5">   // Copy the file to the profile directory for a PAB</span>
<a href="#l21.6"></a><span id="l21.6">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8">   registerAlertTestUtils();</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10">   // Set up the Server</span>
<a href="#l21.11"></a><span id="l21.11">   daemon = new pop3Daemon();</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  var handler = new POP3_RFC1939_handler(daemon);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-  handler.dropOnAuthFailure = true;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+    var handler = new POP3_RFC1939_handler(d);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+    handler.dropOnAuthFailure = true;</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-  // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-  handler.kUsername = kUserName;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-  handler.kPassword = kValidPassword;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+    // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+    handler.kUsername = kUserName;</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+    handler.kPassword = kValidPassword;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+    return handler;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+  }</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+  server = new nsMailServer(createHandler, daemon);</span>
<a href="#l21.28"></a><span id="l21.28"> </span>
<a href="#l21.29"></a><span id="l21.29">   // Set up the basic accounts and folders.</span>
<a href="#l21.30"></a><span id="l21.30">   // We would use createPop3ServerAndLocalFolders() however we want to have</span>
<a href="#l21.31"></a><span id="l21.31">   // a different username and NO password for this test (as we expect to load</span>
<a href="#l21.32"></a><span id="l21.32">   // it from signons.txt).</span>
<a href="#l21.33"></a><span id="l21.33">   loadLocalMailAccount();</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35">   incomingServer = MailServices.accounts</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3PasswordFailure3.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3PasswordFailure3.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -206,23 +206,26 @@ function run_test()</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5">   // Copy the file to the profile directory for a PAB</span>
<a href="#l22.6"></a><span id="l22.6">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8">   registerAlertTestUtils();</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10">   // Set up the Server</span>
<a href="#l22.11"></a><span id="l22.11">   daemon = new pop3Daemon();</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  var handler = new POP3_RFC5034_handler(daemon);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-  handler.dropOnAuthFailure = true;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+    var handler = new POP3_RFC5034_handler(d);</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+    handler.dropOnAuthFailure = true;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+    // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+    handler.kUsername = kUserName;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+    handler.kPassword = kValidPassword;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+    return handler;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+  }</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+  server = new nsMailServer(createHandler, daemon);</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-  handler.kUsername = kUserName;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-  handler.kPassword = kValidPassword;</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29">   // Set up the basic accounts and folders.</span>
<a href="#l22.30"></a><span id="l22.30">   // We would use createPop3ServerAndLocalFolders() however we want to have</span>
<a href="#l22.31"></a><span id="l22.31">   // a different username and NO password for this test (as we expect to load</span>
<a href="#l22.32"></a><span id="l22.32">   // it from signons.txt).</span>
<a href="#l22.33"></a><span id="l22.33">   loadLocalMailAccount();</span>
<a href="#l22.34"></a><span id="l22.34"> </span>
<a href="#l22.35"></a><span id="l22.35">   incomingServer = MailServices.accounts</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -20,17 +20,16 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * - incomingServer thinks it is still running/busy although the connection is</span>
<a href="#l23.5"></a><span id="l23.5">  *    clearly done and over.</span>
<a href="#l23.6"></a><span id="l23.6">  *</span>
<a href="#l23.7"></a><span id="l23.7">  * @author Ben Bucksch</span>
<a href="#l23.8"></a><span id="l23.8">  */</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10"> var server;</span>
<a href="#l23.11"></a><span id="l23.11"> var daemon;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-var handler;</span>
<a href="#l23.13"></a><span id="l23.13"> var incomingServer;</span>
<a href="#l23.14"></a><span id="l23.14"> var pop3Service;</span>
<a href="#l23.15"></a><span id="l23.15"> const test = &quot;Server which advertises CRAM-MD5, but closes the connection when it's tried&quot;;</span>
<a href="#l23.16"></a><span id="l23.16"> // that's how it currently looks like (we fail to log in):</span>
<a href="#l23.17"></a><span id="l23.17"> const expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot; ];</span>
<a href="#l23.18"></a><span id="l23.18"> // TODO that's how it should look like (we start a new connection and try another scheme):</span>
<a href="#l23.19"></a><span id="l23.19"> //const expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ];</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -94,18 +93,20 @@ function run_test() {</span>
<a href="#l23.22"></a><span id="l23.22">       .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24">     prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l23.25"></a><span id="l23.25">     prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l23.26"></a><span id="l23.26">     prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l23.27"></a><span id="l23.27">     prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">     daemon = new pop3Daemon();</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-    handler = new CRAMFail_handler(daemon);</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-    server = new nsMailServer(handler);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+    function createHandler(d) {</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+      return new CRAMFail_handler(d);</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+    }</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+    server = new nsMailServer(createHandler, daemon);</span>
<a href="#l23.36"></a><span id="l23.36">     server.start(POP3_PORT);</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38">     incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l23.39"></a><span id="l23.39">     let msgServer = incomingServer;</span>
<a href="#l23.40"></a><span id="l23.40">     msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l23.41"></a><span id="l23.41">     // Need to allow any auth here, although that's not use in TB really,</span>
<a href="#l23.42"></a><span id="l23.42">     // because we need to fall back to something after CRAM-MD5 and</span>
<a href="#l23.43"></a><span id="l23.43">     // check that login works after we fell back.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l24.5"></a><span id="l24.5"> /**</span>
<a href="#l24.6"></a><span id="l24.6">  * Server which advertises CRAM-MD5, but fails when it's tried.</span>
<a href="#l24.7"></a><span id="l24.7">  * This reportedly happens for some misconfigured servers.</span>
<a href="#l24.8"></a><span id="l24.8">  */</span>
<a href="#l24.9"></a><span id="l24.9"> var server;</span>
<a href="#l24.10"></a><span id="l24.10"> var daemon;</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-var handler;</span>
<a href="#l24.12"></a><span id="l24.12"> var incomingServer;</span>
<a href="#l24.13"></a><span id="l24.13"> var pop3Service;</span>
<a href="#l24.14"></a><span id="l24.14"> const test = &quot;Server which advertises CRAM-MD5, but fails when it's tried&quot;;</span>
<a href="#l24.15"></a><span id="l24.15"> const expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ];</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17"> var urlListener =</span>
<a href="#l24.18"></a><span id="l24.18"> {</span>
<a href="#l24.19"></a><span id="l24.19">   OnStartRunningUrl: function (url) {</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineat">@@ -85,18 +84,20 @@ function run_test() {</span>
<a href="#l24.21"></a><span id="l24.21">       .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23">     prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l24.24"></a><span id="l24.24">     prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l24.25"></a><span id="l24.25">     prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l24.26"></a><span id="l24.26">     prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">     daemon = new pop3Daemon();</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-    handler = new CRAMFail_handler(daemon);</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-    server = new nsMailServer(handler);</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+    function createHandler(d) {</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+      return new CRAMFail_handler(d);</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+    }</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+    server = new nsMailServer(createHandler, daemon);</span>
<a href="#l24.35"></a><span id="l24.35">     server.start(POP3_PORT);</span>
<a href="#l24.36"></a><span id="l24.36"> </span>
<a href="#l24.37"></a><span id="l24.37">     incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l24.38"></a><span id="l24.38">     let msgServer = incomingServer;</span>
<a href="#l24.39"></a><span id="l24.39">     msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l24.40"></a><span id="l24.40">     // Need to allow any auth here, although that's not use in TB really,</span>
<a href="#l24.41"></a><span id="l24.41">     // because we need to fall back to something after CRAM-MD5 and</span>
<a href="#l24.42"></a><span id="l24.42">     // check that login works after we fell back.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/local/test/unit/test_verifyLogon.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_verifyLogon.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -76,23 +76,26 @@ function run_test()</span>
<a href="#l25.4"></a><span id="l25.4">     .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6">   prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l25.7"></a><span id="l25.7">   prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l25.8"></a><span id="l25.8">   prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l25.9"></a><span id="l25.9">   prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l25.10"></a><span id="l25.10">   // Set up the Server</span>
<a href="#l25.11"></a><span id="l25.11">   daemon = new pop3Daemon();</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  var handler = new POP3_RFC1939_handler(daemon);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+    var handler = new POP3_RFC1939_handler(d);</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+    // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+    handler.kUsername = kUserName;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+    handler.kPassword = kValidPassword;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+    handler.dropOnAuthFailure = true;</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+    return handler;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+  }</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+  server = new nsMailServer(createHandler, daemon);</span>
<a href="#l25.23"></a><span id="l25.23"> </span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-  // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-  handler.kUsername = kUserName;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-  handler.kPassword = kValidPassword;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-  handler.dropOnAuthFailure = true;</span>
<a href="#l25.28"></a><span id="l25.28">   // Set up the basic accounts and folders.</span>
<a href="#l25.29"></a><span id="l25.29">   // We would use createPop3ServerAndLocalFolders() however we want to have</span>
<a href="#l25.30"></a><span id="l25.30">   // a different username and NO password for this test (as we expect to load</span>
<a href="#l25.31"></a><span id="l25.31">   // it from signons.txt).</span>
<a href="#l25.32"></a><span id="l25.32">   loadLocalMailAccount();</span>
<a href="#l25.33"></a><span id="l25.33"> </span>
<a href="#l25.34"></a><span id="l25.34"> </span>
<a href="#l25.35"></a><span id="l25.35">   incomingServer = MailServices.accounts</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/news/test/unit/head_server_setup.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/news/test/unit/head_server_setup.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -63,16 +63,23 @@ function setupNNTPDaemon() {</span>
<a href="#l26.4"></a><span id="l26.4">   });</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6">   var article = new newsArticle(kSimpleNewsArticle);</span>
<a href="#l26.7"></a><span id="l26.7">   daemon.addArticleToGroup(article, &quot;test.subscribe.simple&quot;, 1);</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9">   return daemon;</span>
<a href="#l26.10"></a><span id="l26.10"> }</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+function makeServer(handler, daemon) {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+    return new handler(d);</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+  }</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+  return new nsMailServer(createHandler, daemon);</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+}</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+</span>
<a href="#l26.19"></a><span id="l26.19"> // Enable strict threading</span>
<a href="#l26.20"></a><span id="l26.20"> var prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.21"></a><span id="l26.21">               .getService(Ci.nsIPrefBranch);</span>
<a href="#l26.22"></a><span id="l26.22"> prefs.setBoolPref(&quot;mail.strict_threading&quot;, true);</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25"> // Make sure we don't try to use a protected port. I like adding 1024 to the</span>
<a href="#l26.26"></a><span id="l26.26"> // default port when doing so...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/news/test/unit/test_biff.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_biff.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -17,17 +17,17 @@ function run_test() {</span>
<a href="#l27.4"></a><span id="l27.4">   }</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6">   // Create a filter to mark one message read.</span>
<a href="#l27.7"></a><span id="l27.7">   let filters = localserver.getFilterList(null);</span>
<a href="#l27.8"></a><span id="l27.8">   filters.loggingEnabled = true;</span>
<a href="#l27.9"></a><span id="l27.9">   createFilter(filters, &quot;subject&quot;, &quot;Odd&quot;, &quot;read&quot;);</span>
<a href="#l27.10"></a><span id="l27.10">   localserver.setFilterList(filters);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  let server = new nsMailServer(new NNTP_RFC2980_handler(daemon));</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  let server = makeServer(NNTP_RFC2980_handler, daemon);</span>
<a href="#l27.14"></a><span id="l27.14">   server.start(NNTP_PORT);</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16">   // This is a bit hackish, but we don't have any really functional callbacks</span>
<a href="#l27.17"></a><span id="l27.17">   // for biff. Instead, we use the notifier to look for all 7 messages to be</span>
<a href="#l27.18"></a><span id="l27.18">   // added and take that as our sign that the download is finished.</span>
<a href="#l27.19"></a><span id="l27.19">   let expectCount = 7, seen = 0;</span>
<a href="#l27.20"></a><span id="l27.20">   let notifier = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l27.21"></a><span id="l27.21">                    .getService(Ci.nsIMsgFolderNotificationService);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/news/test/unit/test_bug37465.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_bug37465.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l28.4"></a><span id="l28.4"> // Bug 37465 -- assertions with no accounts</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> function run_test() {</span>
<a href="#l28.9"></a><span id="l28.9">   var daemon = setupNNTPDaemon();</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-  var server = new nsMailServer(new NNTP_RFC2980_handler(daemon));</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+  var server = makeServer(NNTP_RFC2980_handler, daemon);</span>
<a href="#l28.12"></a><span id="l28.12">   server.start(NNTP_PORT);</span>
<a href="#l28.13"></a><span id="l28.13"> </span>
<a href="#l28.14"></a><span id="l28.14">   // Correct URI?</span>
<a href="#l28.15"></a><span id="l28.15">   let ioSvc = Cc['@mozilla.org/network/io-service;1']</span>
<a href="#l28.16"></a><span id="l28.16">                     .getService(Ci.nsIIOService);</span>
<a href="#l28.17"></a><span id="l28.17">   let uri = ioSvc.newURI(&quot;news://localhost:1143/1@regular.invalid&quot;, null, null);</span>
<a href="#l28.18"></a><span id="l28.18">   let newsUri = uri.QueryInterface(Ci.nsINntpUrl)</span>
<a href="#l28.19"></a><span id="l28.19">                    .QueryInterface(Ci.nsIMsgMailNewsUrl);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/news/test/unit/test_bug403242.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_bug403242.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -5,17 +5,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l29.4"></a><span id="l29.4"> var daemon, localserver, server;</span>
<a href="#l29.5"></a><span id="l29.5"> </span>
<a href="#l29.6"></a><span id="l29.6"> function run_test() {</span>
<a href="#l29.7"></a><span id="l29.7">   daemon = setupNNTPDaemon();</span>
<a href="#l29.8"></a><span id="l29.8">   daemon.addGroup(&quot;test1&quot;);</span>
<a href="#l29.9"></a><span id="l29.9">   daemon.addArticle(make_article(do_get_file(&quot;postings/bug403242.eml&quot;)));</span>
<a href="#l29.10"></a><span id="l29.10">   localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l29.11"></a><span id="l29.11">   localserver.subscribeToNewsgroup(&quot;test1&quot;);</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  server = new nsMailServer(new NNTP_RFC2980_handler(daemon));</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  server = makeServer(NNTP_RFC2980_handler, daemon);</span>
<a href="#l29.14"></a><span id="l29.14">   server.start(NNTP_PORT);</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16">   let folder = localserver.rootFolder.getChildNamed(&quot;test1&quot;);</span>
<a href="#l29.17"></a><span id="l29.17">   folder.getNewMessages(null, {</span>
<a href="#l29.18"></a><span id="l29.18">     OnStopRunningUrl: function () { localserver.closeCachedConnections(); }});</span>
<a href="#l29.19"></a><span id="l29.19">   server.performTest();</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21">   // Fetch the message</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/news/test/unit/test_bug540288.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_bug540288.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -58,19 +58,18 @@ function doTestFinished() {</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5">     do_test_finished();</span>
<a href="#l30.6"></a><span id="l30.6"> }</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> const kCacheKey = &quot;news://localhost:&quot; + NNTP_PORT + &quot;/TSS1%40nntp.test&quot;;</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> function run_test() {</span>
<a href="#l30.11"></a><span id="l30.11">   type = &quot;RFC 977&quot;;</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  var handler = new NNTP_RFC977_handler(daemon);</span>
<a href="#l30.13"></a><span id="l30.13">   localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+  server = makeServer(NNTP_RFC977_handler, daemon);</span>
<a href="#l30.16"></a><span id="l30.16">   server.start(NNTP_PORT);</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18">   try {</span>
<a href="#l30.19"></a><span id="l30.19">     // Add an empty message to the cache</span>
<a href="#l30.20"></a><span id="l30.20">     var cache = Cc[&quot;@mozilla.org/messenger/nntpservice;1&quot;]</span>
<a href="#l30.21"></a><span id="l30.21">                   .getService(Ci.nsINntpService)</span>
<a href="#l30.22"></a><span id="l30.22">                   .cacheSession;</span>
<a href="#l30.23"></a><span id="l30.23">     var cacheEntry = cache.openCacheEntry(kCacheKey, Ci.nsICache.ACCESS_WRITE,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/news/test/unit/test_filter.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_filter.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -25,18 +25,18 @@ var attribResults = {</span>
<a href="#l31.4"></a><span id="l31.4">   &quot;1@regular.invalid&quot; : [&quot;isRead&quot;, false],</span>
<a href="#l31.5"></a><span id="l31.5">   &quot;2@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l31.6"></a><span id="l31.6">   &quot;3@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l31.7"></a><span id="l31.7">   &quot;4@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l31.8"></a><span id="l31.8">   &quot;5@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l31.9"></a><span id="l31.9">   &quot;6.odd@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l31.10"></a><span id="l31.10">   &quot;7@regular.invalid&quot; : [&quot;isRead&quot;, true]</span>
<a href="#l31.11"></a><span id="l31.11"> };</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-function testAttrib(handler, localserver) {</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+function testAttrib(handler, daemon, localserver) {</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+  var server = makeServer(handler, daemon);</span>
<a href="#l31.16"></a><span id="l31.16">   server.start(NNTP_PORT);</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18">   // Get the folder and force filters to run</span>
<a href="#l31.19"></a><span id="l31.19">   var folder = localserver.rootFolder.getChildNamed(&quot;test.filter&quot;);</span>
<a href="#l31.20"></a><span id="l31.20">   folder.getNewMessages(null, {</span>
<a href="#l31.21"></a><span id="l31.21">     OnStopRunningUrl: function () { localserver.closeCachedConnections() }});</span>
<a href="#l31.22"></a><span id="l31.22">   server.performTest();</span>
<a href="#l31.23"></a><span id="l31.23"> </span>
<a href="#l31.24"></a><span id="l31.24" class="difflineat">@@ -80,18 +80,18 @@ var actionResults = {</span>
<a href="#l31.25"></a><span id="l31.25">     return (flags &amp; watched) == watched;</span>
<a href="#l31.26"></a><span id="l31.26">   },</span>
<a href="#l31.27"></a><span id="l31.27">   &quot;5@regular.invalid&quot; : [&quot;isFlagged&quot;, true],</span>
<a href="#l31.28"></a><span id="l31.28">   &quot;6.odd@regular.invalid&quot; : [&quot;isRead&quot;, false],</span>
<a href="#l31.29"></a><span id="l31.29">   &quot;7@regular.invalid&quot; : function (header, folder) {</span>
<a href="#l31.30"></a><span id="l31.30">     return header.getStringProperty(&quot;keywords&quot;) == &quot;tag&quot;;</span>
<a href="#l31.31"></a><span id="l31.31">   }</span>
<a href="#l31.32"></a><span id="l31.32"> };</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-function testAction(handler, localserver) {</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+function testAction(handler, daemon, localserver) {</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+  var server = makeServer(handler, daemon);</span>
<a href="#l31.37"></a><span id="l31.37">   server.start(NNTP_PORT);</span>
<a href="#l31.38"></a><span id="l31.38"> </span>
<a href="#l31.39"></a><span id="l31.39">   // Get the folder and force filters to run</span>
<a href="#l31.40"></a><span id="l31.40">   var folder = localserver.rootFolder.getChildNamed(&quot;test.filter&quot;);</span>
<a href="#l31.41"></a><span id="l31.41">   folder.getNewMessages(null, {</span>
<a href="#l31.42"></a><span id="l31.42">     OnStopRunningUrl: function () { localserver.closeCachedConnections() }});</span>
<a href="#l31.43"></a><span id="l31.43">   server.performTest();</span>
<a href="#l31.44"></a><span id="l31.44"> </span>
<a href="#l31.45"></a><span id="l31.45" class="difflineat">@@ -135,18 +135,17 @@ function run_test() {</span>
<a href="#l31.46"></a><span id="l31.46">   // A PRTime is the time in μs, but a JS date is time in ms.</span>
<a href="#l31.47"></a><span id="l31.47">   createFilter(serverFilters, &quot;date&quot;, new Date(2000, 0, 1)*1000, &quot;read&quot;);</span>
<a href="#l31.48"></a><span id="l31.48">   createFilter(serverFilters, &quot;size&quot;, 2, &quot;read&quot;);</span>
<a href="#l31.49"></a><span id="l31.49">   createFilter(serverFilters, &quot;message-id&quot;, &quot;odd&quot;, &quot;read&quot;);</span>
<a href="#l31.50"></a><span id="l31.50">   createFilter(serverFilters, &quot;user-agent&quot;, &quot;Odd/1.0&quot;, &quot;read&quot;);</span>
<a href="#l31.51"></a><span id="l31.51">   localserver.setFilterList(serverFilters);</span>
<a href="#l31.52"></a><span id="l31.52"> </span>
<a href="#l31.53"></a><span id="l31.53">   handlers.forEach( function (handler) {</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-    var handlerObj = new handler(daemon);</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-    testAttrib(handlerObj, localserver);</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+    testAttrib(handler, daemon, localserver);</span>
<a href="#l31.57"></a><span id="l31.57">   });</span>
<a href="#l31.58"></a><span id="l31.58"> </span>
<a href="#l31.59"></a><span id="l31.59">   // Now we test folder-filters... and actions</span>
<a href="#l31.60"></a><span id="l31.60">   // Clear out the server filters</span>
<a href="#l31.61"></a><span id="l31.61">   while (serverFilters.filterCount &gt; 0)</span>
<a href="#l31.62"></a><span id="l31.62">     serverFilters.removeFilterAt(0);</span>
<a href="#l31.63"></a><span id="l31.63">   localserver.setFilterList(serverFilters);</span>
<a href="#l31.64"></a><span id="l31.64"> </span>
<a href="#l31.65"></a><span id="l31.65" class="difflineat">@@ -160,12 +159,11 @@ function run_test() {</span>
<a href="#l31.66"></a><span id="l31.66">   createFilter(folderFilters, &quot;message-id&quot;, &quot;odd&quot;, &quot;stop&quot;);</span>
<a href="#l31.67"></a><span id="l31.67">   // This shouldn't be hit, because of the previous filter</span>
<a href="#l31.68"></a><span id="l31.68">   createFilter(folderFilters, &quot;message-id&quot;, &quot;6.odd&quot;, &quot;read&quot;);</span>
<a href="#l31.69"></a><span id="l31.69">   createFilter(folderFilters, &quot;user-agent&quot;, &quot;Odd/1.0&quot;, &quot;tag&quot;);</span>
<a href="#l31.70"></a><span id="l31.70">   folderFilters.loggingEnabled = true;</span>
<a href="#l31.71"></a><span id="l31.71">   folder.setFilterList(folderFilters);</span>
<a href="#l31.72"></a><span id="l31.72"> </span>
<a href="#l31.73"></a><span id="l31.73">   handlers.forEach( function (handler) {</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineminus">-    var handlerObj = new handler(daemon);</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-    testAction(handlerObj, localserver);</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+    testAction(handler, daemon, localserver);</span>
<a href="#l31.77"></a><span id="l31.77">   });</span>
<a href="#l31.78"></a><span id="l31.78"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/news/test/unit/test_getNewsMessage.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_getNewsMessage.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -61,19 +61,18 @@ function doTestFinished() {</span>
<a href="#l32.4"></a><span id="l32.4">     while (thread.hasPendingEvents())</span>
<a href="#l32.5"></a><span id="l32.5">       thread.processNextEvent(true);</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7">     do_test_finished();</span>
<a href="#l32.8"></a><span id="l32.8"> }</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> function run_test() {</span>
<a href="#l32.11"></a><span id="l32.11">   type = &quot;RFC 977&quot;;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  var handler = new NNTP_RFC977_handler(daemon);</span>
<a href="#l32.13"></a><span id="l32.13">   localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+  server = makeServer(NNTP_RFC977_handler, daemon);</span>
<a href="#l32.16"></a><span id="l32.16">   server.start(NNTP_PORT);</span>
<a href="#l32.17"></a><span id="l32.17"> </span>
<a href="#l32.18"></a><span id="l32.18">   try {</span>
<a href="#l32.19"></a><span id="l32.19">     // Get the folder and new mail</span>
<a href="#l32.20"></a><span id="l32.20">     var folder = localserver.rootFolder.getChildNamed(&quot;test.subscribe.simple&quot;);</span>
<a href="#l32.21"></a><span id="l32.21">     folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l32.22"></a><span id="l32.22">     folder.getNewMessages(null, {</span>
<a href="#l32.23"></a><span id="l32.23">       OnStopRunningUrl: function () { localserver.closeCachedConnections(); }});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/news/test/unit/test_internalUris.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_internalUris.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -184,17 +184,17 @@ function test_forwardInline() {</span>
<a href="#l33.4"></a><span id="l33.4">   let hdr = folder.msgDatabase.GetMsgHdrForKey(1);</span>
<a href="#l33.5"></a><span id="l33.5">   composeSvc.forwardMessage(&quot;a@b.c&quot;, hdr, null,</span>
<a href="#l33.6"></a><span id="l33.6">     localserver, Ci.nsIMsgComposeService.kForwardInline);</span>
<a href="#l33.7"></a><span id="l33.7"> }</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9"> function run_test() {</span>
<a href="#l33.10"></a><span id="l33.10">   daemon = setupNNTPDaemon();</span>
<a href="#l33.11"></a><span id="l33.11">   localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  server = new nsMailServer(new NNTP_RFC2980_handler(daemon));</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  server = makeServer(NNTP_RFC2980_handler, daemon);</span>
<a href="#l33.14"></a><span id="l33.14">   server.start(NNTP_PORT);</span>
<a href="#l33.15"></a><span id="l33.15">   server.setDebugLevel(fsDebugAll);</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17">   // Set up an identity for posting</span>
<a href="#l33.18"></a><span id="l33.18">   var acctmgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l33.19"></a><span id="l33.19">                   .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l33.20"></a><span id="l33.20">   let identity = acctmgr.createIdentity();</span>
<a href="#l33.21"></a><span id="l33.21">   identity.fullName = &quot;Normal Person&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpContentLength.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpContentLength.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -17,19 +17,18 @@ var daemon = setupNNTPDaemon();</span>
<a href="#l34.4"></a><span id="l34.4"> var server;</span>
<a href="#l34.5"></a><span id="l34.5"> var localserver;</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> function run_test() {</span>
<a href="#l34.8"></a><span id="l34.8">   // XXX The server doesn't support returning sizes!</span>
<a href="#l34.9"></a><span id="l34.9">   return;</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11">   type = &quot;RFC 977&quot;;</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  var handler = new NNTP_RFC977_handler(daemon);</span>
<a href="#l34.13"></a><span id="l34.13">   localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-  server = new nsMailServer(handler);</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+  server = makeServer(NNTP_RFC977_handler, daemon);</span>
<a href="#l34.16"></a><span id="l34.16">   server.start(NNTP_PORT);</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18">   try {</span>
<a href="#l34.19"></a><span id="l34.19">     // Get the folder and new mail</span>
<a href="#l34.20"></a><span id="l34.20">     let folder = localserver.rootFolder.getChildNamed(&quot;test.subscribe.simple&quot;);</span>
<a href="#l34.21"></a><span id="l34.21">     folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l34.22"></a><span id="l34.22">     folder.getNewMessages(null, {</span>
<a href="#l34.23"></a><span id="l34.23">       OnStopRunningUrl: function () { localserver.closeCachedConnections(); }});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpPassword.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpPassword.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -17,19 +17,17 @@ function run_test() {</span>
<a href="#l35.4"></a><span id="l35.4">   type = &quot;RFC 4643&quot;;</span>
<a href="#l35.5"></a><span id="l35.5"> </span>
<a href="#l35.6"></a><span id="l35.6">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l35.7"></a><span id="l35.7">   var signons = do_get_file(&quot;../../../data/signons-mailnews1.8.txt&quot;);</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9">   // Copy the file to the profile directory for a PAB</span>
<a href="#l35.10"></a><span id="l35.10">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-  var handler = new NNTP_RFC4643_extension(daemon);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+  var server = makeServer(NNTP_RFC4643_extension, daemon);</span>
<a href="#l35.16"></a><span id="l35.16">   server.start(NNTP_PORT);</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18">   try {</span>
<a href="#l35.19"></a><span id="l35.19">     var prefix = &quot;news://localhost:&quot;+NNTP_PORT+&quot;/&quot;;</span>
<a href="#l35.20"></a><span id="l35.20">     var transaction;</span>
<a href="#l35.21"></a><span id="l35.21"> </span>
<a href="#l35.22"></a><span id="l35.22">     // Test - group subscribe listing</span>
<a href="#l35.23"></a><span id="l35.23">     test = &quot;news:*&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpPassword2.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpPassword2.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -46,19 +46,17 @@ function run_test() {</span>
<a href="#l36.4"></a><span id="l36.4">   type = &quot;RFC 4643&quot;;</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l36.7"></a><span id="l36.7">   var signons = do_get_file(&quot;../../../data/signons-mailnews1.8-alt.txt&quot;);</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9">   // Copy the file to the profile directory</span>
<a href="#l36.10"></a><span id="l36.10">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  var handler = new NNTP_RFC4643_extension(daemon);</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+  var server = makeServer(NNTP_RFC4643_extension, daemon);</span>
<a href="#l36.16"></a><span id="l36.16">   server.start(NNTP_PORT);</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18">   try {</span>
<a href="#l36.19"></a><span id="l36.19">     // Note, the uri is for hostname &quot;invalid&quot; which is the original uri. See </span>
<a href="#l36.20"></a><span id="l36.20">     // setupProtocolTest parameters.</span>
<a href="#l36.21"></a><span id="l36.21">     var prefix = &quot;news://invalid:&quot;+NNTP_PORT+&quot;/&quot;;</span>
<a href="#l36.22"></a><span id="l36.22"> </span>
<a href="#l36.23"></a><span id="l36.23">     // Test - group subscribe listing</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpPost.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpPost.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -7,17 +7,17 @@ function run_test() {</span>
<a href="#l37.4"></a><span id="l37.4">   var listener = { OnStopRunningUrl: function () {</span>
<a href="#l37.5"></a><span id="l37.5">     localserver.closeCachedConnections();</span>
<a href="#l37.6"></a><span id="l37.6">   }};</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8">   // Tests bug 484656.</span>
<a href="#l37.9"></a><span id="l37.9">   localserver.realHostName = localserver.hostName;</span>
<a href="#l37.10"></a><span id="l37.10">   localserver.hostName = &quot;news.example.com&quot;;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  var server = new nsMailServer(new NNTP_RFC977_handler(daemon));</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+  var server = makeServer(NNTP_RFC977_handler, daemon);</span>
<a href="#l37.14"></a><span id="l37.14">   server.start(NNTP_PORT);</span>
<a href="#l37.15"></a><span id="l37.15"> </span>
<a href="#l37.16"></a><span id="l37.16">   try {</span>
<a href="#l37.17"></a><span id="l37.17">     var nntpService = Cc[&quot;@mozilla.org/messenger/nntpservice;1&quot;]</span>
<a href="#l37.18"></a><span id="l37.18">                         .getService(Ci.nsINntpService);</span>
<a href="#l37.19"></a><span id="l37.19">     nntpService.postMessage(do_get_file(&quot;postings/post1.eml&quot;), &quot;test.empty&quot;,</span>
<a href="#l37.20"></a><span id="l37.20">       localserver.key, listener, null);</span>
<a href="#l37.21"></a><span id="l37.21">     server.performTest();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/news/test/unit/test_server.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_server.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -24,19 +24,17 @@ var test = null;</span>
<a href="#l38.4"></a><span id="l38.4"> // would be expected to be used in a session. If more URL types are modified, //</span>
<a href="#l38.5"></a><span id="l38.5"> // please add a corresponding type to the following tests.                    //</span>
<a href="#l38.6"></a><span id="l38.6"> // When adding new servers, only test the commands that become different for  //</span>
<a href="#l38.7"></a><span id="l38.7"> // each specified server, to keep down redudant tests.                        //</span>
<a href="#l38.8"></a><span id="l38.8"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l38.9"></a><span id="l38.9"> </span>
<a href="#l38.10"></a><span id="l38.10"> function testRFC977() {</span>
<a href="#l38.11"></a><span id="l38.11">   type = &quot;RFC 977&quot;;</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  var handler = new NNTP_RFC977_handler(daemon);</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+  var server = makeServer(NNTP_RFC977_handler, daemon);</span>
<a href="#l38.16"></a><span id="l38.16">   server.start(NNTP_PORT);</span>
<a href="#l38.17"></a><span id="l38.17"> </span>
<a href="#l38.18"></a><span id="l38.18">   try {</span>
<a href="#l38.19"></a><span id="l38.19">     var prefix = &quot;news://localhost:&quot;+NNTP_PORT+&quot;/&quot;;</span>
<a href="#l38.20"></a><span id="l38.20">     var transaction;</span>
<a href="#l38.21"></a><span id="l38.21"> </span>
<a href="#l38.22"></a><span id="l38.22">     // Test - group subscribe listing</span>
<a href="#l38.23"></a><span id="l38.23">     test = &quot;news:*&quot;;</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineat">@@ -92,18 +90,17 @@ function testRFC977() {</span>
<a href="#l38.25"></a><span id="l38.25">   server.stop();</span>
<a href="#l38.26"></a><span id="l38.26"> </span>
<a href="#l38.27"></a><span id="l38.27">   var thread = gThreadManager.currentThread;</span>
<a href="#l38.28"></a><span id="l38.28">   while (thread.hasPendingEvents())</span>
<a href="#l38.29"></a><span id="l38.29">     thread.processNextEvent(true);</span>
<a href="#l38.30"></a><span id="l38.30"> }</span>
<a href="#l38.31"></a><span id="l38.31"> </span>
<a href="#l38.32"></a><span id="l38.32"> function testConnectionLimit() {</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-  var handler = new NNTP_RFC977_handler(daemon);</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+  var server = makeServer(NNTP_RFC977_handler, daemon);</span>
<a href="#l38.36"></a><span id="l38.36">   server.start(NNTP_PORT);</span>
<a href="#l38.37"></a><span id="l38.37"> </span>
<a href="#l38.38"></a><span id="l38.38">   var prefix = &quot;news://localhost:&quot;+NNTP_PORT+&quot;/&quot;;</span>
<a href="#l38.39"></a><span id="l38.39">   var transaction;</span>
<a href="#l38.40"></a><span id="l38.40"> </span>
<a href="#l38.41"></a><span id="l38.41">   // To test make connections limit, we run two URIs simultaneously.</span>
<a href="#l38.42"></a><span id="l38.42">   var url = URLCreator.newURI(prefix+&quot;*&quot;, null, null);</span>
<a href="#l38.43"></a><span id="l38.43">   _server.loadNewsUrl(url, null, null);</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineat">@@ -117,18 +114,17 @@ function testConnectionLimit() {</span>
<a href="#l38.45"></a><span id="l38.45">   var thread = gThreadManager.currentThread;</span>
<a href="#l38.46"></a><span id="l38.46">   while (thread.hasPendingEvents())</span>
<a href="#l38.47"></a><span id="l38.47">     thread.processNextEvent(true);</span>
<a href="#l38.48"></a><span id="l38.48"> }</span>
<a href="#l38.49"></a><span id="l38.49"> </span>
<a href="#l38.50"></a><span id="l38.50"> function testReentrantClose() {</span>
<a href="#l38.51"></a><span id="l38.51">   // What we are testing is that a CloseConnection that spins the event loop</span>
<a href="#l38.52"></a><span id="l38.52">   // does not cause a crash.</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-  var handler = new NNTP_RFC977_handler(daemon);</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-  var server = new nsMailServer(handler);</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+  var server = makeServer(NNTP_RFC977_handler, daemon);</span>
<a href="#l38.56"></a><span id="l38.56">   server.start(NNTP_PORT);</span>
<a href="#l38.57"></a><span id="l38.57"> </span>
<a href="#l38.58"></a><span id="l38.58">   var listener = {</span>
<a href="#l38.59"></a><span id="l38.59">     OnStartRunningUrl: function (url) {},</span>
<a href="#l38.60"></a><span id="l38.60">     OnStopRunningUrl: function (url, rv) {</span>
<a href="#l38.61"></a><span id="l38.61">       // Spin the event loop (entering nsNNTPProtocol::ProcessProtocolState)</span>
<a href="#l38.62"></a><span id="l38.62">       let thread = gThreadManager.currentThread;</span>
<a href="#l38.63"></a><span id="l38.63">       while (thread.hasPendingEvents())</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineat">@@ -150,13 +146,41 @@ function testReentrantClose() {</span>
<a href="#l38.65"></a><span id="l38.65">     Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l38.66"></a><span id="l38.66">   server.performTest();</span>
<a href="#l38.67"></a><span id="l38.67">   server.stop();</span>
<a href="#l38.68"></a><span id="l38.68"> </span>
<a href="#l38.69"></a><span id="l38.69">   // Break refcnt loops</span>
<a href="#l38.70"></a><span id="l38.70">   listener = url = null;</span>
<a href="#l38.71"></a><span id="l38.71"> }</span>
<a href="#l38.72"></a><span id="l38.72"> </span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+function testManyConnections() {</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+  // Start up 2 connections at once and make sure that they don't conflict</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+  var server = makeServer(NNTP_RFC2980_handler, daemon);</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+  setupLocalServer(NNTP_PORT);</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+  server.start(NNTP_PORT);</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+  _server.maximumConnectionsNumber = 3;</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+  var listener = {</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+    ran: 0,</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+    OnStartRunningUrl: function (url) {},</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+    OnStopRunningUrl: function (url, rv) {</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+      if (--(this.ran) == 0)</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+        _server.closeCachedConnections();</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+    }</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+  };</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+  let groups = _server.rootFolder.subFolders;</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+  while (groups.hasMoreElements()) {</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+    groups.getNext().QueryInterface(Ci.nsIMsgFolder).getNewMessages(null,</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+      listener);</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+    listener.ran++;</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+  }</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+  server.performTest();</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+  // The last one that is processed is test.filter, so make sure that</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+  // test.subscribed.simple is not retrieving the data meant for test.filter</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+  let folder = _server.rootFolder.getChildNamed(&quot;test.subscribe.simple&quot;)</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+  do_check_eq(folder.getTotalMessages(false), 1);</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+}</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+</span>
<a href="#l38.100"></a><span id="l38.100"> function run_test() {</span>
<a href="#l38.101"></a><span id="l38.101">   testRFC977();</span>
<a href="#l38.102"></a><span id="l38.102">   testConnectionLimit();</span>
<a href="#l38.103"></a><span id="l38.103">   testReentrantClose();</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+  testManyConnections();</span>
<a href="#l38.105"></a><span id="l38.105"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/test/fakeserver/imapd.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/test/fakeserver/imapd.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -47,16 +47,20 @@ function imapDaemon(flags, syncFunc) {</span>
<a href="#l39.4"></a><span id="l39.4">   this.namespaces = [];</span>
<a href="#l39.5"></a><span id="l39.5">   this.idResponse = &quot;NIL&quot;;</span>
<a href="#l39.6"></a><span id="l39.6">   this.root = new imapMailbox(&quot;&quot;, null, {type : IMAP_NAMESPACE_PERSONAL});</span>
<a href="#l39.7"></a><span id="l39.7">   this.uidvalidity = Math.round(Date.now()/1000);</span>
<a href="#l39.8"></a><span id="l39.8">   this.inbox = new imapMailbox(&quot;INBOX&quot;, null, this.uidvalidity++);</span>
<a href="#l39.9"></a><span id="l39.9">   this.root.addMailbox(this.inbox);</span>
<a href="#l39.10"></a><span id="l39.10">   this.namespaces.push(this.root);</span>
<a href="#l39.11"></a><span id="l39.11">   this.syncFunc = syncFunc;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+  // This can be used to cause the artificial failure of any given command.</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+  this.commandToFail = &quot;&quot;;</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+  // This can be used to simulate timeouts on large copies</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+  this.copySleep = 0;</span>
<a href="#l39.16"></a><span id="l39.16"> }</span>
<a href="#l39.17"></a><span id="l39.17"> imapDaemon.prototype = {</span>
<a href="#l39.18"></a><span id="l39.18">   synchronize : function (mailbox, update) {</span>
<a href="#l39.19"></a><span id="l39.19">     if (this.syncFunc)</span>
<a href="#l39.20"></a><span id="l39.20">       this.syncFunc.call(null, this);</span>
<a href="#l39.21"></a><span id="l39.21">     if (update) {</span>
<a href="#l39.22"></a><span id="l39.22">       for each (var message in mailbox._messages) {</span>
<a href="#l39.23"></a><span id="l39.23">         message.recent = false;</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineat">@@ -637,20 +641,16 @@ function formatArg(argument, spec) {</span>
<a href="#l39.25"></a><span id="l39.25">  * implementations, the command property will be called, but this time with an</span>
<a href="#l39.26"></a><span id="l39.26">  * argument that is an array of data items instead of a string representing the</span>
<a href="#l39.27"></a><span id="l39.27">  * rest of the line.</span>
<a href="#l39.28"></a><span id="l39.28">  */</span>
<a href="#l39.29"></a><span id="l39.29"> function IMAP_RFC3501_handler(daemon) {</span>
<a href="#l39.30"></a><span id="l39.30">   this._daemon = daemon;</span>
<a href="#l39.31"></a><span id="l39.31">   this.closing = false;</span>
<a href="#l39.32"></a><span id="l39.32">   this.dropOnStartTLS = false;</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-  // This can be used to simulate timeouts on large copies</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-  this.copySleep = 0;</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineminus">-  // This can be used to cause the artificial failure of any given command.</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineminus">-  this.commandToFail = &quot;&quot;;</span>
<a href="#l39.37"></a><span id="l39.37">   // map: property = auth scheme {String}, value = start function on this obj</span>
<a href="#l39.38"></a><span id="l39.38">   this._kAuthSchemeStartFunction = {};</span>
<a href="#l39.39"></a><span id="l39.39"> </span>
<a href="#l39.40"></a><span id="l39.40">   this.resetTest();</span>
<a href="#l39.41"></a><span id="l39.41"> }</span>
<a href="#l39.42"></a><span id="l39.42"> IMAP_RFC3501_handler.prototype = {</span>
<a href="#l39.43"></a><span id="l39.43"> </span>
<a href="#l39.44"></a><span id="l39.44">   kUsername : &quot;user&quot;,</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineat">@@ -747,17 +747,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l39.46"></a><span id="l39.46">       try {</span>
<a href="#l39.47"></a><span id="l39.47">         return this._tag + &quot; &quot; + func.call(this, line);</span>
<a href="#l39.48"></a><span id="l39.48">       } catch (e) { return this._tag + &quot; BAD &quot; + e; }</span>
<a href="#l39.49"></a><span id="l39.49">     }</span>
<a href="#l39.50"></a><span id="l39.50">     return undefined;</span>
<a href="#l39.51"></a><span id="l39.51">   },</span>
<a href="#l39.52"></a><span id="l39.52">   _dispatchCommand : function (command, args) {</span>
<a href="#l39.53"></a><span id="l39.53">     command = command.toUpperCase();</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineminus">-    if (command == this.commandToFail.toUpperCase())</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+    if (command == this._daemon.commandToFail.toUpperCase())</span>
<a href="#l39.56"></a><span id="l39.56">       return this._tag + &quot; NO &quot; + command + &quot; failed&quot;;</span>
<a href="#l39.57"></a><span id="l39.57">     if (command in this) {</span>
<a href="#l39.58"></a><span id="l39.58">       this._lastCommand = command;</span>
<a href="#l39.59"></a><span id="l39.59">       // Are we allowed to execute this command?</span>
<a href="#l39.60"></a><span id="l39.60">       if (this._enabledCommands[this._state].indexOf(command) == -1)</span>
<a href="#l39.61"></a><span id="l39.61">         return this._tag + &quot; BAD illegal command for current state &quot; + this._state;</span>
<a href="#l39.62"></a><span id="l39.62"> </span>
<a href="#l39.63"></a><span id="l39.63">       try {</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineat">@@ -1277,24 +1277,24 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l39.65"></a><span id="l39.65">       return &quot;NO [TRYCREATE] what mailbox?&quot;;</span>
<a href="#l39.66"></a><span id="l39.66"> </span>
<a href="#l39.67"></a><span id="l39.67">     for each (var message in messages) {</span>
<a href="#l39.68"></a><span id="l39.68">       let newMessage = new imapMessage(message._URI, dest.uidnext++,</span>
<a href="#l39.69"></a><span id="l39.69">                                        message.flags);</span>
<a href="#l39.70"></a><span id="l39.70">       newMessage.recent = false;</span>
<a href="#l39.71"></a><span id="l39.71">       dest.addMessage(newMessage);</span>
<a href="#l39.72"></a><span id="l39.72">     }</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineminus">-    if (this.copySleep &gt; 0) {</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+    if (this._daemon.copySleep &gt; 0) {</span>
<a href="#l39.75"></a><span id="l39.75">       // spin rudely for copyTimeout milliseconds.</span>
<a href="#l39.76"></a><span id="l39.76">       let now = new Date();</span>
<a href="#l39.77"></a><span id="l39.77">       let alarm;</span>
<a href="#l39.78"></a><span id="l39.78">       let startingMSeconds = now.getTime();</span>
<a href="#l39.79"></a><span id="l39.79">       while (true) {</span>
<a href="#l39.80"></a><span id="l39.80">         alarm = new Date();</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineminus">-        if (alarm.getTime() - startingMSeconds &gt; this.copySleep)</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+        if (alarm.getTime() - startingMSeconds &gt; this._daemon.copySleep)</span>
<a href="#l39.83"></a><span id="l39.83">           break;</span>
<a href="#l39.84"></a><span id="l39.84">       }</span>
<a href="#l39.85"></a><span id="l39.85">     }</span>
<a href="#l39.86"></a><span id="l39.86">     return &quot;OK COPY completed&quot;;</span>
<a href="#l39.87"></a><span id="l39.87">   },</span>
<a href="#l39.88"></a><span id="l39.88">   UID : function (args) {</span>
<a href="#l39.89"></a><span id="l39.89">     var name = args.shift();</span>
<a href="#l39.90"></a><span id="l39.90">     if (this.kUidCommands.indexOf(name) == -1)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/test/fakeserver/maild.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/test/fakeserver/maild.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -67,25 +67,36 @@ const ServerSocket = CC(&quot;@mozilla.org/ne</span>
<a href="#l40.4"></a><span id="l40.4"> const BinaryInputStream = CC(&quot;@mozilla.org/binaryinputstream;1&quot;,</span>
<a href="#l40.5"></a><span id="l40.5">                              &quot;nsIBinaryInputStream&quot;,</span>
<a href="#l40.6"></a><span id="l40.6">                              &quot;setInputStream&quot;);</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8"> // Time out after 3 minutes</span>
<a href="#l40.9"></a><span id="l40.9"> const TIMEOUT = 3*60*1000;</span>
<a href="#l40.10"></a><span id="l40.10"> </span>
<a href="#l40.11"></a><span id="l40.11"> /******************************************************************************</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">- * The main server handling class. The handler parameter is to be handed to the</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">- * reading object. Currently, concurrent socket connections should probably be</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">- * avoided, because transactioning information will be overwritten.</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+ * The main server handling class. A fake server consists of three parts, this</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+ * server implementation (which handles the network communication), the handler</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+ * (which handles the state for a connection), and the daemon (which handles</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineplus">+ * the state for the logical server). To make a new server, one needs to pass</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+ * in a function to create handlers--not the handlers themselves--and the</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineplus">+ * backend daemon. Since each handler presumably needs access to the logical</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+ * server daemon, that is passed into the handler creation function. A new</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineplus">+ * handler will be constructed for every connection made.</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+ *</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineplus">+ * As the core code is inherently single-threaded, it is guaranteed that all of</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+ * the calls to the daemon will be made on the same thread, so you do not have</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineplus">+ * to worry about reentrancy in daemon calls.  </span>
<a href="#l40.27"></a><span id="l40.27">  *</span>
<a href="#l40.28"></a><span id="l40.28">  ******************************************************************************</span>
<a href="#l40.29"></a><span id="l40.29">  * Typical usage:</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">- * var handler = &lt;get handler from somewhere&gt;</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+ * function createHandler(daemon) {</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+ *   return new handler(daemon);</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+ * }</span>
<a href="#l40.34"></a><span id="l40.34">  * do_test_pending();</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">- * var server = new nsMailServer(handler);</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+ * var server = new nsMailServer(createHandler, serverDaemon);</span>
<a href="#l40.37"></a><span id="l40.37">  * // Port to use. I tend to like using 1024 + default port number myself.</span>
<a href="#l40.38"></a><span id="l40.38">  * server.start(port);</span>
<a href="#l40.39"></a><span id="l40.39">  *</span>
<a href="#l40.40"></a><span id="l40.40">  * // Set up a connection the server...</span>
<a href="#l40.41"></a><span id="l40.41">  * server.performTest();</span>
<a href="#l40.42"></a><span id="l40.42">  * transaction = server.playTransaction();</span>
<a href="#l40.43"></a><span id="l40.43">  * // Verify that the transaction is correct...</span>
<a href="#l40.44"></a><span id="l40.44">  *</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineat">@@ -98,17 +109,17 @@ const TIMEOUT = 3*60*1000;</span>
<a href="#l40.46"></a><span id="l40.46">  * server.stop();</span>
<a href="#l40.47"></a><span id="l40.47">  *</span>
<a href="#l40.48"></a><span id="l40.48">  * var thread = gThreadManager.currentThread;</span>
<a href="#l40.49"></a><span id="l40.49">  * while (thread.hasPendingEvents())</span>
<a href="#l40.50"></a><span id="l40.50">  *   thread.processNextEvent(true);</span>
<a href="#l40.51"></a><span id="l40.51">  *</span>
<a href="#l40.52"></a><span id="l40.52">  * do_test_finished();</span>
<a href="#l40.53"></a><span id="l40.53">  *****************************************************************************/</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineminus">-function nsMailServer(handler) {</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+function nsMailServer(handlerCreator, daemon) {</span>
<a href="#l40.56"></a><span id="l40.56">   if (!gThreadManager)</span>
<a href="#l40.57"></a><span id="l40.57">     gThreadManager = Cc[&quot;@mozilla.org/thread-manager;1&quot;].getService();</span>
<a href="#l40.58"></a><span id="l40.58"> </span>
<a href="#l40.59"></a><span id="l40.59">   this._debug = fsDebugNone;</span>
<a href="#l40.60"></a><span id="l40.60"> </span>
<a href="#l40.61"></a><span id="l40.61">   /** The port on which this server listens. */</span>
<a href="#l40.62"></a><span id="l40.62">   this._port = undefined;</span>
<a href="#l40.63"></a><span id="l40.63"> </span>
<a href="#l40.64"></a><span id="l40.64" class="difflineat">@@ -123,17 +134,18 @@ function nsMailServer(handler) {</span>
<a href="#l40.65"></a><span id="l40.65"> </span>
<a href="#l40.66"></a><span id="l40.66">   /**</span>
<a href="#l40.67"></a><span id="l40.67">    * Should we log transactions?  This only matters if you want to inspect the</span>
<a href="#l40.68"></a><span id="l40.68">    * protocol traffic.  Defaults to true because this was written for protocol</span>
<a href="#l40.69"></a><span id="l40.69">    * testing.</span>
<a href="#l40.70"></a><span id="l40.70">    */</span>
<a href="#l40.71"></a><span id="l40.71">   this._logTransactions = true;</span>
<a href="#l40.72"></a><span id="l40.72"> </span>
<a href="#l40.73"></a><span id="l40.73" class="difflineminus">-  this._handler = handler;</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineplus">+  this._handlerCreator = handlerCreator;</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+  this._daemon = daemon;</span>
<a href="#l40.76"></a><span id="l40.76">   this._readers = [];</span>
<a href="#l40.77"></a><span id="l40.77">   this._test = false;</span>
<a href="#l40.78"></a><span id="l40.78">   this._watchWord = undefined;</span>
<a href="#l40.79"></a><span id="l40.79"> </span>
<a href="#l40.80"></a><span id="l40.80">   /**</span>
<a href="#l40.81"></a><span id="l40.81">    * An array to hold refs to all the input streams below, so that they don't</span>
<a href="#l40.82"></a><span id="l40.82">    * get GCed</span>
<a href="#l40.83"></a><span id="l40.83">    */</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineat">@@ -145,17 +157,18 @@ nsMailServer.prototype = {</span>
<a href="#l40.85"></a><span id="l40.85">       print(&quot;Received Connection from &quot; + trans.host + &quot;:&quot; + trans.port);</span>
<a href="#l40.86"></a><span id="l40.86"> </span>
<a href="#l40.87"></a><span id="l40.87">     const SEGMENT_SIZE = 1024;</span>
<a href="#l40.88"></a><span id="l40.88">     const SEGMENT_COUNT = 1024;</span>
<a href="#l40.89"></a><span id="l40.89">     var input = trans.openInputStream(0, SEGMENT_SIZE, SEGMENT_COUNT)</span>
<a href="#l40.90"></a><span id="l40.90">                      .QueryInterface(Ci.nsIAsyncInputStream);</span>
<a href="#l40.91"></a><span id="l40.91">     this._inputStreams.push(input);</span>
<a href="#l40.92"></a><span id="l40.92"> </span>
<a href="#l40.93"></a><span id="l40.93" class="difflineminus">-    var reader = new nsMailReader(this, this._handler, trans, this._debug,</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineplus">+    var handler = this._handlerCreator(this._daemon);</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+    var reader = new nsMailReader(this, handler, trans, this._debug,</span>
<a href="#l40.96"></a><span id="l40.96">                                   this._logTransactions);</span>
<a href="#l40.97"></a><span id="l40.97">     this._readers.push(reader);</span>
<a href="#l40.98"></a><span id="l40.98"> </span>
<a href="#l40.99"></a><span id="l40.99">     // Note: must use main thread here, or we might get a GC that will cause</span>
<a href="#l40.100"></a><span id="l40.100">     //       threadsafety assertions.  We really need to fix XPConnect so that</span>
<a href="#l40.101"></a><span id="l40.101">     //       you can actually do things in multi-threaded JS.  :-(</span>
<a href="#l40.102"></a><span id="l40.102">     input.asyncWait(reader, 0, 0, gThreadManager.mainThread);</span>
<a href="#l40.103"></a><span id="l40.103">     this._test = true;</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineat">@@ -163,17 +176,18 @@ nsMailServer.prototype = {</span>
<a href="#l40.105"></a><span id="l40.105"> </span>
<a href="#l40.106"></a><span id="l40.106">   onStopListening : function (socket, status) {</span>
<a href="#l40.107"></a><span id="l40.107">     if (this._debug != fsDebugNone)</span>
<a href="#l40.108"></a><span id="l40.108">       print(&quot;Connection Lost &quot; + status);</span>
<a href="#l40.109"></a><span id="l40.109"> </span>
<a href="#l40.110"></a><span id="l40.110">     this._socketClosed = true;</span>
<a href="#l40.111"></a><span id="l40.111">     // We've been killed or we've stopped, reset the handler to the original</span>
<a href="#l40.112"></a><span id="l40.112">     // state (e.g. to require authentication again).</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineminus">-    this._handler.resetTest();</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+    for (var i = 0; i &lt; this._readers.length; i++)</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+      this._readers[i]._handler.resetTest();</span>
<a href="#l40.116"></a><span id="l40.116">   },</span>
<a href="#l40.117"></a><span id="l40.117"> </span>
<a href="#l40.118"></a><span id="l40.118">   setDebugLevel : function (debug) {</span>
<a href="#l40.119"></a><span id="l40.119">     this._debug = debug;</span>
<a href="#l40.120"></a><span id="l40.120">     for (var i = 0; i &lt; this._readers.length; i++)</span>
<a href="#l40.121"></a><span id="l40.121">       this._readers[i].setDebugLevel(debug);</span>
<a href="#l40.122"></a><span id="l40.122">   },</span>
<a href="#l40.123"></a><span id="l40.123"> </span>
<a href="#l40.124"></a><span id="l40.124" class="difflineat">@@ -272,17 +286,18 @@ nsMailServer.prototype = {</span>
<a href="#l40.125"></a><span id="l40.125">   /**</span>
<a href="#l40.126"></a><span id="l40.126">    * Prepares for the next test.</span>
<a href="#l40.127"></a><span id="l40.127">    */</span>
<a href="#l40.128"></a><span id="l40.128">   resetTest : function() {</span>
<a href="#l40.129"></a><span id="l40.129">     this._readers = this._readers.filter(function (reader) {</span>
<a href="#l40.130"></a><span id="l40.130">       return reader._isRunning;</span>
<a href="#l40.131"></a><span id="l40.131">     });</span>
<a href="#l40.132"></a><span id="l40.132">     this._test = true;</span>
<a href="#l40.133"></a><span id="l40.133" class="difflineminus">-    this._handler.resetTest();</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineplus">+    for (var i = 0; i &lt; this._readers.length; i++)</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineplus">+      this._readers[i]._handler.resetTest();</span>
<a href="#l40.136"></a><span id="l40.136">   }</span>
<a href="#l40.137"></a><span id="l40.137"> };</span>
<a href="#l40.138"></a><span id="l40.138"> </span>
<a href="#l40.139"></a><span id="l40.139"> function readTo(input, count, arr) {</span>
<a href="#l40.140"></a><span id="l40.140">   var old = new BinaryInputStream(input).readByteArray(count);</span>
<a href="#l40.141"></a><span id="l40.141">   Array.prototype.push.apply(arr, old);</span>
<a href="#l40.142"></a><span id="l40.142"> }</span>
<a href="#l40.143"></a><span id="l40.143"> </span>
<a href="#l40.144"></a><span id="l40.144" class="difflineat">@@ -536,17 +551,20 @@ nsMailReader.prototype = {</span>
<a href="#l40.145"></a><span id="l40.145">  * @param port</span>
<a href="#l40.146"></a><span id="l40.146">  *   the port on which the server will run, or -1 if there exists no preference</span>
<a href="#l40.147"></a><span id="l40.147">  *   for a specific port; note that attempting to use some values for this</span>
<a href="#l40.148"></a><span id="l40.148">  *   parameter (particularly those below 1024) may cause this method to throw or</span>
<a href="#l40.149"></a><span id="l40.149">  *   may result in the server being prematurely shut down</span>
<a href="#l40.150"></a><span id="l40.150">  * @param handler</span>
<a href="#l40.151"></a><span id="l40.151">  *   the handler (as defined in the documentation comment above nsMailReader) to</span>
<a href="#l40.152"></a><span id="l40.152">  *   use on the server</span>
<a href="#l40.153"></a><span id="l40.153" class="difflineplus">+ * @param daemon</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineplus">+ *   the daemon (as defined in the documentation comment above nsMailReader) to</span>
<a href="#l40.155"></a><span id="l40.155" class="difflineplus">+ *   use on the server</span>
<a href="#l40.156"></a><span id="l40.156">  */</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineminus">-function server(port, handler) {</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineminus">-  var srv = new nsMailServer(handler);</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineplus">+function server(port, handler, daemon) {</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineplus">+  var srv = new nsMailServer(handler, daemon);</span>
<a href="#l40.161"></a><span id="l40.161">   srv.start(port);</span>
<a href="#l40.162"></a><span id="l40.162">   srv.performTest();</span>
<a href="#l40.163"></a><span id="l40.163">   return srv.playTransaction();</span>
<a href="#l40.164"></a><span id="l40.164"> }</span>
<a href="#l40.165"></a><span id="l40.165"> </span>
<a href="#l40.166"></a><span id="l40.166"> } // gMaild_js__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/test/fakeserver/smtpd.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/test/fakeserver/smtpd.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -80,17 +80,17 @@ SMTP_RFC2821_handler.prototype = {</span>
<a href="#l41.4"></a><span id="l41.4">     if (this._state == kStateAuthNeeded)</span>
<a href="#l41.5"></a><span id="l41.5">       return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l41.6"></a><span id="l41.6">     return &quot;250 ok&quot;;</span>
<a href="#l41.7"></a><span id="l41.7">   },</span>
<a href="#l41.8"></a><span id="l41.8">   DATA: function(args) {</span>
<a href="#l41.9"></a><span id="l41.9">     if (this._state == kStateAuthNeeded)</span>
<a href="#l41.10"></a><span id="l41.10">       return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l41.11"></a><span id="l41.11">     this.expectingData = true;</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-    this.post = &quot;&quot;;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+    this._daemon.post = &quot;&quot;;</span>
<a href="#l41.14"></a><span id="l41.14">     return &quot;354 ok\n&quot;;</span>
<a href="#l41.15"></a><span id="l41.15">   },</span>
<a href="#l41.16"></a><span id="l41.16">   RSET: function (args) {</span>
<a href="#l41.17"></a><span id="l41.17">     return &quot;250 ok\n&quot;;</span>
<a href="#l41.18"></a><span id="l41.18">   },</span>
<a href="#l41.19"></a><span id="l41.19">   VRFY: function (args) {</span>
<a href="#l41.20"></a><span id="l41.20">     if (this._state == kStateAuthNeeded)</span>
<a href="#l41.21"></a><span id="l41.21">       return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -233,17 +233,17 @@ SMTP_RFC2821_handler.prototype = {</span>
<a href="#l41.23"></a><span id="l41.23">       }</span>
<a href="#l41.24"></a><span id="l41.24">       return &quot;503 Huch? How did you get here?&quot;;</span>
<a href="#l41.25"></a><span id="l41.25">     }</span>
<a href="#l41.26"></a><span id="l41.26"> </span>
<a href="#l41.27"></a><span id="l41.27">     if (this.expectingData) {</span>
<a href="#l41.28"></a><span id="l41.28">       if (line.charAt(0) == '.')</span>
<a href="#l41.29"></a><span id="l41.29">         line = line.substring(1);</span>
<a href="#l41.30"></a><span id="l41.30">       // This uses CR LF to match with the specification</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-      this.post += line + '\r\n';</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+      this._daemon.post += line + '\r\n';</span>
<a href="#l41.33"></a><span id="l41.33">     }</span>
<a href="#l41.34"></a><span id="l41.34">     return undefined;</span>
<a href="#l41.35"></a><span id="l41.35">   },</span>
<a href="#l41.36"></a><span id="l41.36">   postCommand: function(reader) {</span>
<a href="#l41.37"></a><span id="l41.37">     if (this.closing)</span>
<a href="#l41.38"></a><span id="l41.38">       reader.closeSocket();</span>
<a href="#l41.39"></a><span id="l41.39">     reader.setMultiline(this._multiline || this.expectingData);</span>
<a href="#l41.40"></a><span id="l41.40">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/test/resources/IMAPpump.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/test/resources/IMAPpump.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -78,26 +78,29 @@ function setupIMAPPump(extensions)</span>
<a href="#l42.4"></a><span id="l42.4">   //   this from any directory.</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6">   const IMAP_PORT = 1024 + 143;</span>
<a href="#l42.7"></a><span id="l42.7"> </span>
<a href="#l42.8"></a><span id="l42.8">   function makeServer(daemon, infoString) {</span>
<a href="#l42.9"></a><span id="l42.9">     if (infoString in configurations)</span>
<a href="#l42.10"></a><span id="l42.10">       return makeServer(daemon, configurations[infoString].join(&quot;,&quot;));</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-    var handler = new IMAP_RFC3501_handler(daemon);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-    if (!infoString)</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineminus">-      infoString = &quot;RFC2195&quot;;</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+    function createHandler(d) {</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+      var handler = new IMAP_RFC3501_handler(d);</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+      if (!infoString)</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+        infoString = &quot;RFC2195&quot;;</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20" class="difflineminus">-    var parts = infoString.split(/ *, */);</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-    for each (var part in parts) {</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-      if (part.substring(0, 3) == &quot;RFC&quot;)</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-        mixinExtension(handler, eval(&quot;IMAP_&quot; + part + &quot;_extension&quot;));</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+      var parts = infoString.split(/ *, */);</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+      for each (var part in parts) {</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+        if (part.substring(0, 3) == &quot;RFC&quot;)</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+          mixinExtension(handler, eval(&quot;IMAP_&quot; + part + &quot;_extension&quot;));</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+      }</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+      return handler;</span>
<a href="#l42.30"></a><span id="l42.30">     }</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-    var server = new nsMailServer(handler);</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+    var server = new nsMailServer(createHandler, daemon);</span>
<a href="#l42.33"></a><span id="l42.33">     server.start(IMAP_PORT);</span>
<a href="#l42.34"></a><span id="l42.34">     return server;</span>
<a href="#l42.35"></a><span id="l42.35">   }</span>
<a href="#l42.36"></a><span id="l42.36"> </span>
<a href="#l42.37"></a><span id="l42.37">   function createLocalIMAPServer() {</span>
<a href="#l42.38"></a><span id="l42.38">     let server = create_incoming_server(&quot;imap&quot;, IMAP_PORT, &quot;user&quot;, &quot;password&quot;);</span>
<a href="#l42.39"></a><span id="l42.39">     server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l42.40"></a><span id="l42.40">     return server;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/test/resources/POP3pump.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/test/resources/POP3pump.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -75,21 +75,23 @@ POP3Pump.prototype._urlListener =</span>
<a href="#l43.4"></a><span id="l43.4">   }</span>
<a href="#l43.5"></a><span id="l43.5"> };</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> // Setup the daemon and server</span>
<a href="#l43.8"></a><span id="l43.8"> // If the debugOption is set, then it will be applied to the server.</span>
<a href="#l43.9"></a><span id="l43.9"> POP3Pump.prototype._setupServerDaemon = function _setupServerDaemon(aDebugOption)</span>
<a href="#l43.10"></a><span id="l43.10"> {</span>
<a href="#l43.11"></a><span id="l43.11">   this._daemon = new pop3Daemon();</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  var handler = new POP3_RFC1939_handler(this._daemon);</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-  this._server = new nsMailServer(handler);</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+  function createHandler(d) {</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+    return new POP3_RFC1939_handler(d);</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+  }</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+  this._server = new nsMailServer(createHandler, this._daemon);</span>
<a href="#l43.18"></a><span id="l43.18">   if (aDebugOption)</span>
<a href="#l43.19"></a><span id="l43.19">     this._server.setDebugLevel(aDebugOption);</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineminus">-  return [this._daemon, this._server, handler];</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+  return [this._daemon, this._server];</span>
<a href="#l43.22"></a><span id="l43.22"> };</span>
<a href="#l43.23"></a><span id="l43.23"> </span>
<a href="#l43.24"></a><span id="l43.24"> POP3Pump.prototype._createPop3ServerAndLocalFolders =</span>
<a href="#l43.25"></a><span id="l43.25">   function _createPop3ServerAndLocalFolders()</span>
<a href="#l43.26"></a><span id="l43.26"> {</span>
<a href="#l43.27"></a><span id="l43.27">   if (typeof gLocalInboxFolder == 'undefined')</span>
<a href="#l43.28"></a><span id="l43.28">     loadLocalMailAccount();</span>
<a href="#l43.29"></a><span id="l43.29"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

