<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26274:2f1b233c4f65d26b0dc3ff3236758b73759cc25a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2f1b233c4f65d26b0dc3ff3236758b73759cc25a" />
<meta property="og:url" content="/comm-central/rev/2f1b233c4f65d26b0dc3ff3236758b73759cc25a" />
<meta property="og:description" content="Bug 1542666 - Turn on ESLint in editor (automatic changes by eslint --fix); rs=me" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2f1b233c4f65d26b0dc3ff3236758b73759cc25a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2f1b233c4f65d26b0dc3ff3236758b73759cc25a">shortlog</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2f1b233c4f65d26b0dc3ff3236758b73759cc25a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a">files</a> |
changeset |
<a href="/comm-central/raw-rev/2f1b233c4f65d26b0dc3ff3236758b73759cc25a">raw</a>  | <a href="/comm-central/archive/2f1b233c4f65d26b0dc3ff3236758b73759cc25a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1542666">Bug 1542666</a> - Turn on ESLint in editor (automatic changes by eslint --fix); rs=me
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 09 Apr 2019 11:57:12 +1200</td></tr>

<tr>
 <td>changeset 26274</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2f1b233c4f65d26b0dc3ff3236758b73759cc25a">2f1b233c4f65d26b0dc3ff3236758b73759cc25a</a></td>
</tr>



<tr>
<td>parent 26273</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/455b5241d71d386bbb88c44163b5cf82908ab2f2">455b5241d71d386bbb88c44163b5cf82908ab2f2</a>
</td>
</tr>

<tr>
<td>child 26275</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/09d757485ede721d43560f4fb42b8a6e7c2b6e9b">09d757485ede721d43560f4fb42b8a6e7c2b6e9b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2f1b233c4f65d26b0dc3ff3236758b73759cc25a">15765</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 08 Apr 2019 23:57:59 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@09d757485ede [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=09d757485ede721d43560f4fb42b8a6e7c2b6e9b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=09d757485ede721d43560f4fb42b8a6e7c2b6e9b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=09d757485ede721d43560f4fb42b8a6e7c2b6e9b&newProject=comm-central&newRevision=2f1b233c4f65d26b0dc3ff3236758b73759cc25a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=09d757485ede721d43560f4fb42b8a6e7c2b6e9b&newProject=comm-central&newRevision=2f1b233c4f65d26b0dc3ff3236758b73759cc25a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=09d757485ede721d43560f4fb42b8a6e7c2b6e9b&newProject=comm-central&newRevision=2f1b233c4f65d26b0dc3ff3236758b73759cc25a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28me%29&revcount=50">me</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1542666">1542666</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1542666">Bug 1542666</a> - Turn on ESLint in editor (automatic changes by eslint --fix); rs=me</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/.eslintignore">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/.eslintignore">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/.eslintignore">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/.eslintignore">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/ComposerCommands.js">editor/ui/composer/content/ComposerCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/ComposerCommands.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/ComposerCommands.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/ComposerCommands.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/ComposerCommands.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/ComposerCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editor.js">editor/ui/composer/content/editor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editor.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editor.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editor.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editor.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editorUtilities.js">editor/ui/composer/content/editorUtilities.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editorUtilities.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editorUtilities.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editorUtilities.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editorUtilities.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/composer/content/editorUtilities.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEAttributes.js">editor/ui/dialogs/content/EdAEAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEAttributes.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEAttributes.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEAttributes.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEAttributes.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAECSSAttributes.js">editor/ui/dialogs/content/EdAECSSAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAECSSAttributes.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAECSSAttributes.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAECSSAttributes.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAECSSAttributes.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAECSSAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEHTMLAttributes.js">editor/ui/dialogs/content/EdAEHTMLAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEHTMLAttributes.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEHTMLAttributes.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEHTMLAttributes.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEHTMLAttributes.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEHTMLAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEJSEAttributes.js">editor/ui/dialogs/content/EdAEJSEAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEJSEAttributes.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEJSEAttributes.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEJSEAttributes.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEJSEAttributes.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAEJSEAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAdvancedEdit.js">editor/ui/dialogs/content/EdAdvancedEdit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAdvancedEdit.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAdvancedEdit.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAdvancedEdit.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAdvancedEdit.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdAdvancedEdit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdButtonProps.js">editor/ui/dialogs/content/EdButtonProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdButtonProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdButtonProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdButtonProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdButtonProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdButtonProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorPicker.js">editor/ui/dialogs/content/EdColorPicker.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorPicker.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorPicker.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorPicker.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorPicker.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorPicker.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorProps.js">editor/ui/dialogs/content/EdColorProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdColorProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdConvertToTable.js">editor/ui/dialogs/content/EdConvertToTable.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdConvertToTable.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdConvertToTable.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdConvertToTable.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdConvertToTable.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdConvertToTable.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogCommon.js">editor/ui/dialogs/content/EdDialogCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogCommon.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogCommon.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogCommon.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogCommon.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogCommon.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogTemplate.js">editor/ui/dialogs/content/EdDialogTemplate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogTemplate.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogTemplate.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogTemplate.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogTemplate.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDialogTemplate.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDictionary.js">editor/ui/dialogs/content/EdDictionary.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDictionary.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDictionary.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDictionary.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDictionary.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdDictionary.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFieldSetProps.js">editor/ui/dialogs/content/EdFieldSetProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFieldSetProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFieldSetProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFieldSetProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFieldSetProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFieldSetProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFormProps.js">editor/ui/dialogs/content/EdFormProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFormProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFormProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFormProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFormProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdFormProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdHLineProps.js">editor/ui/dialogs/content/EdHLineProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdHLineProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdHLineProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdHLineProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdHLineProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdHLineProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageDialog.js">editor/ui/dialogs/content/EdImageDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageDialog.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageDialog.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageDialog.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageDialog.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageLinkLoader.js">editor/ui/dialogs/content/EdImageLinkLoader.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageLinkLoader.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageLinkLoader.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageLinkLoader.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageLinkLoader.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageLinkLoader.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageProps.js">editor/ui/dialogs/content/EdImageProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdImageProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputImage.js">editor/ui/dialogs/content/EdInputImage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputImage.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputImage.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputImage.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputImage.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputImage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputProps.js">editor/ui/dialogs/content/EdInputProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInputProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsSrc.js">editor/ui/dialogs/content/EdInsSrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsSrc.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsSrc.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsSrc.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsSrc.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsSrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertChars.js">editor/ui/dialogs/content/EdInsertChars.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertChars.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertChars.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertChars.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertChars.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertChars.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertMath.js">editor/ui/dialogs/content/EdInsertMath.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertMath.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertMath.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertMath.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertMath.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertMath.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTOC.js">editor/ui/dialogs/content/EdInsertTOC.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTOC.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTOC.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTOC.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTOC.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTOC.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTable.js">editor/ui/dialogs/content/EdInsertTable.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTable.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTable.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTable.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTable.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdInsertTable.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLabelProps.js">editor/ui/dialogs/content/EdLabelProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLabelProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLabelProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLabelProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLabelProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLabelProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLinkProps.js">editor/ui/dialogs/content/EdLinkProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLinkProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLinkProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLinkProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLinkProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdLinkProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdListProps.js">editor/ui/dialogs/content/EdListProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdListProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdListProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdListProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdListProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdListProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdNamedAnchorProps.js">editor/ui/dialogs/content/EdNamedAnchorProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdNamedAnchorProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdNamedAnchorProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdNamedAnchorProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdNamedAnchorProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdNamedAnchorProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdPageProps.js">editor/ui/dialogs/content/EdPageProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdPageProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdPageProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdPageProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdPageProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdPageProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdReplace.js">editor/ui/dialogs/content/EdReplace.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdReplace.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdReplace.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdReplace.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdReplace.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdReplace.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSelectProps.js">editor/ui/dialogs/content/EdSelectProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSelectProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSelectProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSelectProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSelectProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSelectProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSpellCheck.js">editor/ui/dialogs/content/EdSpellCheck.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSpellCheck.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSpellCheck.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSpellCheck.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSpellCheck.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdSpellCheck.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTableProps.js">editor/ui/dialogs/content/EdTableProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTableProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTableProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTableProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTableProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTableProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTextAreaProps.js">editor/ui/dialogs/content/EdTextAreaProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTextAreaProps.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTextAreaProps.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTextAreaProps.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTextAreaProps.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/dialogs/content/EdTextAreaProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/editorUtilities.jsm">editor/ui/editorUtilities.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/editorUtilities.jsm">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/editorUtilities.jsm">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/editorUtilities.jsm">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/editorUtilities.jsm">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/editorUtilities.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/nsComposerCmdLineHandler.js">editor/ui/nsComposerCmdLineHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/nsComposerCmdLineHandler.js">file</a> |
<a href="/comm-central/annotate/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/nsComposerCmdLineHandler.js">annotate</a> |
<a href="/comm-central/diff/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/nsComposerCmdLineHandler.js">diff</a> |
<a href="/comm-central/comparison/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/nsComposerCmdLineHandler.js">comparison</a> |
<a href="/comm-central/log/2f1b233c4f65d26b0dc3ff3236758b73759cc25a/editor/ui/nsComposerCmdLineHandler.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -20,29 +20,51 @@ testing/**</span>
<a href="#l1.4"></a><span id="l1.4"> calendar/base/content/calendar-calendars-list.xul</span>
<a href="#l1.5"></a><span id="l1.5"> calendar/providers/gdata/content/gdata-calendar-creation.xul</span>
<a href="#l1.6"></a><span id="l1.6"> common/src/viewSource.xul</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # We ignore all these directories by default, until we get them enabled.</span>
<a href="#l1.9"></a><span id="l1.9"> # If you are enabling a directory, please add directory specific exclusions</span>
<a href="#l1.10"></a><span id="l1.10"> # below.</span>
<a href="#l1.11"></a><span id="l1.11"> build/**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-editor/**</span>
<a href="#l1.13"></a><span id="l1.13"> ldap/**</span>
<a href="#l1.14"></a><span id="l1.14"> suite/**</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> # chat exclusions</span>
<a href="#l1.17"></a><span id="l1.17"> chat/chat-prefs.js</span>
<a href="#l1.18"></a><span id="l1.18"> # third-party code</span>
<a href="#l1.19"></a><span id="l1.19"> chat/modules/BigInteger.jsm</span>
<a href="#l1.20"></a><span id="l1.20"> chat/protocols/matrix/matrix-sdk/**</span>
<a href="#l1.21"></a><span id="l1.21"> chat/protocols/twitter/twitter-text.jsm</span>
<a href="#l1.22"></a><span id="l1.22"> # preprocessed files</span>
<a href="#l1.23"></a><span id="l1.23"> chat/content/imtooltip.xml</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+# editor exclusions (most files not shipped with Thunderbird)</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+editor/ui/composer.js</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+editor/ui/composer/content/**</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+!editor/ui/composer/content/editor.js</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+!editor/ui/composer/content/editorUtilities.js</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+!editor/ui/composer/content/ComposerCommands.js</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+editor/ui/dialogs/content/EditConflict.js</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+editor/ui/dialogs/content/EditConflict.xul</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+editor/ui/dialogs/content/EditorPublish.js</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+editor/ui/dialogs/content/EditorPublish.xul</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+editor/ui/dialogs/content/EditorPublishOverlay.xul</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+editor/ui/dialogs/content/EditorPublishProgress.js</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+editor/ui/dialogs/content/EditorPublishProgress.xul</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+editor/ui/dialogs/content/EditorPublishSettings.js</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+editor/ui/dialogs/content/EditorPublishSettings.xul</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+editor/ui/dialogs/content/EditorSaveAsCharset.js</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+editor/ui/dialogs/content/EditorSaveAsCharset.xul</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+editor/ui/dialogs/content/EdLinkChecker.js</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+editor/ui/dialogs/content/EdLinkChecker.xul</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+editor/ui/dialogs/content/EdSnapToGrid.js</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+editor/ui/dialogs/content/EdSnapToGrid.xul</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+editor/ui/texzilla/**</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+</span>
<a href="#l1.48"></a><span id="l1.48"> # mailnews exclusions</span>
<a href="#l1.49"></a><span id="l1.49"> mailnews/mailnews.js</span>
<a href="#l1.50"></a><span id="l1.50"> mailnews/base/content/*</span>
<a href="#l1.51"></a><span id="l1.51"> mailnews/base/prefs/*</span>
<a href="#l1.52"></a><span id="l1.52"> mailnews/base/search/*</span>
<a href="#l1.53"></a><span id="l1.53"> mailnews/base/src/*</span>
<a href="#l1.54"></a><span id="l1.54"> mailnews/base/util/*</span>
<a href="#l1.55"></a><span id="l1.55"> mailnews/build/*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/editor/ui/composer/content/ComposerCommands.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/editor/ui/composer/content/ComposerCommands.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -3,108 +3,105 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> /* Implementations of nsIControllerCommand for composer commands */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> var gComposerJSCommandControllerID = 0;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-function SetupHTMLEditorCommands()</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-{</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+function SetupHTMLEditorCommands() {</span>
<a href="#l2.17"></a><span id="l2.17">   var commandTable = GetComposerCommandTable();</span>
<a href="#l2.18"></a><span id="l2.18">   if (!commandTable)</span>
<a href="#l2.19"></a><span id="l2.19">     return;</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   // Include everything a text editor does</span>
<a href="#l2.22"></a><span id="l2.22">   SetupTextEditorCommands();</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-  //dump(&quot;Registering HTML editor commands\n&quot;);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  // dump(&quot;Registering HTML editor commands\n&quot;);</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   commandTable.registerCommand(&quot;cmd_renderedHTMLEnabler&quot;, nsDummyHTMLCommand);</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_grid&quot;,  nsGridCommand);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_listProperties&quot;,  nsListPropertiesCommand);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_pageProperties&quot;,  nsPagePropertiesCommand);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_grid&quot;, nsGridCommand);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_listProperties&quot;, nsListPropertiesCommand);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_pageProperties&quot;, nsPagePropertiesCommand);</span>
<a href="#l2.37"></a><span id="l2.37">   commandTable.registerCommand(&quot;cmd_colorProperties&quot;, nsColorPropertiesCommand);</span>
<a href="#l2.38"></a><span id="l2.38">   commandTable.registerCommand(&quot;cmd_increaseFontStep&quot;, nsIncreaseFontCommand);</span>
<a href="#l2.39"></a><span id="l2.39">   commandTable.registerCommand(&quot;cmd_decreaseFontStep&quot;, nsDecreaseFontCommand);</span>
<a href="#l2.40"></a><span id="l2.40">   commandTable.registerCommand(&quot;cmd_advancedProperties&quot;, nsAdvancedPropertiesCommand);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_objectProperties&quot;,   nsObjectPropertiesCommand);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_objectProperties&quot;, nsObjectPropertiesCommand);</span>
<a href="#l2.43"></a><span id="l2.43">   commandTable.registerCommand(&quot;cmd_removeNamedAnchors&quot;, nsRemoveNamedAnchorsCommand);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_editLink&quot;,        nsEditLinkCommand);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_form&quot;,          nsFormCommand);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_inputtag&quot;,      nsInputTagCommand);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_inputimage&quot;,    nsInputImageCommand);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_textarea&quot;,      nsTextAreaCommand);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_select&quot;,        nsSelectCommand);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_button&quot;,        nsButtonCommand);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_label&quot;,         nsLabelCommand);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_fieldset&quot;,      nsFieldSetCommand);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_isindex&quot;,       nsIsIndexCommand);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_image&quot;,         nsImageCommand);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_hline&quot;,         nsHLineCommand);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_link&quot;,          nsLinkCommand);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_anchor&quot;,        nsAnchorCommand);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_editLink&quot;, nsEditLinkCommand);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_form&quot;, nsFormCommand);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_inputtag&quot;, nsInputTagCommand);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_inputimage&quot;, nsInputImageCommand);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_textarea&quot;, nsTextAreaCommand);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_select&quot;, nsSelectCommand);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_button&quot;, nsButtonCommand);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_label&quot;, nsLabelCommand);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_fieldset&quot;, nsFieldSetCommand);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_isindex&quot;, nsIsIndexCommand);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_image&quot;, nsImageCommand);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_hline&quot;, nsHLineCommand);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_link&quot;, nsLinkCommand);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_anchor&quot;, nsAnchorCommand);</span>
<a href="#l2.74"></a><span id="l2.74">   commandTable.registerCommand(&quot;cmd_insertHTMLWithDialog&quot;, nsInsertHTMLWithDialogCommand);</span>
<a href="#l2.75"></a><span id="l2.75">   commandTable.registerCommand(&quot;cmd_insertMathWithDialog&quot;, nsInsertMathWithDialogCommand);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_insertBreak&quot;,   nsInsertBreakCommand);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_insertBreakAll&quot;,nsInsertBreakAllCommand);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_table&quot;,              nsInsertOrEditTableCommand);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_editTable&quot;,          nsEditTableCommand);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_SelectTable&quot;,        nsSelectTableCommand);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_SelectRow&quot;,          nsSelectTableRowCommand);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_SelectColumn&quot;,       nsSelectTableColumnCommand);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_SelectCell&quot;,         nsSelectTableCellCommand);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_SelectAllCells&quot;,     nsSelectAllTableCellsCommand);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertTable&quot;,        nsInsertTableCommand);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertRowAbove&quot;,     nsInsertTableRowAboveCommand);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertRowBelow&quot;,     nsInsertTableRowBelowCommand);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_insertBreak&quot;, nsInsertBreakCommand);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_insertBreakAll&quot;, nsInsertBreakAllCommand);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_table&quot;, nsInsertOrEditTableCommand);</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_editTable&quot;, nsEditTableCommand);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_SelectTable&quot;, nsSelectTableCommand);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_SelectRow&quot;, nsSelectTableRowCommand);</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_SelectColumn&quot;, nsSelectTableColumnCommand);</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_SelectCell&quot;, nsSelectTableCellCommand);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_SelectAllCells&quot;, nsSelectAllTableCellsCommand);</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_InsertTable&quot;, nsInsertTableCommand);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_InsertRowAbove&quot;, nsInsertTableRowAboveCommand);</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_InsertRowBelow&quot;, nsInsertTableRowBelowCommand);</span>
<a href="#l2.102"></a><span id="l2.102">   commandTable.registerCommand(&quot;cmd_InsertColumnBefore&quot;, nsInsertTableColumnBeforeCommand);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertColumnAfter&quot;,  nsInsertTableColumnAfterCommand);</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertCellBefore&quot;,   nsInsertTableCellBeforeCommand);</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertCellAfter&quot;,    nsInsertTableCellAfterCommand);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_DeleteTable&quot;,        nsDeleteTableCommand);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_DeleteRow&quot;,          nsDeleteTableRowCommand);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_DeleteColumn&quot;,       nsDeleteTableColumnCommand);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_DeleteCell&quot;,         nsDeleteTableCellCommand);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_InsertColumnAfter&quot;, nsInsertTableColumnAfterCommand);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_InsertCellBefore&quot;, nsInsertTableCellBeforeCommand);</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_InsertCellAfter&quot;, nsInsertTableCellAfterCommand);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_DeleteTable&quot;, nsDeleteTableCommand);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_DeleteRow&quot;, nsDeleteTableRowCommand);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_DeleteColumn&quot;, nsDeleteTableColumnCommand);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_DeleteCell&quot;, nsDeleteTableCellCommand);</span>
<a href="#l2.117"></a><span id="l2.117">   commandTable.registerCommand(&quot;cmd_DeleteCellContents&quot;, nsDeleteTableCellContentsCommand);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_JoinTableCells&quot;,     nsJoinTableCellsCommand);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_SplitTableCell&quot;,     nsSplitTableCellCommand);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_TableOrCellColor&quot;,   nsTableOrCellColorCommand);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_NormalizeTable&quot;,     nsNormalizeTableCommand);</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_smiley&quot;,             nsSetSmiley);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_ConvertToTable&quot;,     nsConvertToTable);</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_JoinTableCells&quot;, nsJoinTableCellsCommand);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_SplitTableCell&quot;, nsSplitTableCellCommand);</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_TableOrCellColor&quot;, nsTableOrCellColorCommand);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_NormalizeTable&quot;, nsNormalizeTableCommand);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_smiley&quot;, nsSetSmiley);</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_ConvertToTable&quot;, nsConvertToTable);</span>
<a href="#l2.130"></a><span id="l2.130"> }</span>
<a href="#l2.131"></a><span id="l2.131"> </span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-function SetupTextEditorCommands()</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-{</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+function SetupTextEditorCommands() {</span>
<a href="#l2.135"></a><span id="l2.135">   var commandTable = GetComposerCommandTable();</span>
<a href="#l2.136"></a><span id="l2.136">   if (!commandTable)</span>
<a href="#l2.137"></a><span id="l2.137">     return;</span>
<a href="#l2.138"></a><span id="l2.138"> </span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-  //dump(&quot;Registering plain text editor commands\n&quot;);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_findReplace&quot;,nsFindReplaceCommand);</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_find&quot;,       nsFindCommand);</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_findNext&quot;,   nsFindAgainCommand);</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_findPrev&quot;,   nsFindAgainCommand);</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_rewrap&quot;,     nsRewrapCommand);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_spelling&quot;,   nsSpellingCommand);</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_validate&quot;,   nsValidateCommand);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  // dump(&quot;Registering plain text editor commands\n&quot;);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_findReplace&quot;, nsFindReplaceCommand);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_find&quot;, nsFindCommand);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_findNext&quot;, nsFindAgainCommand);</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_findPrev&quot;, nsFindAgainCommand);</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_rewrap&quot;, nsRewrapCommand);</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_spelling&quot;, nsSpellingCommand);</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_validate&quot;, nsValidateCommand);</span>
<a href="#l2.157"></a><span id="l2.157">   commandTable.registerCommand(&quot;cmd_checkLinks&quot;, nsCheckLinksCommand);</span>
<a href="#l2.158"></a><span id="l2.158">   commandTable.registerCommand(&quot;cmd_insertChars&quot;, nsInsertCharsCommand);</span>
<a href="#l2.159"></a><span id="l2.159"> }</span>
<a href="#l2.160"></a><span id="l2.160"> </span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-function SetupComposerWindowCommands()</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-{</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+function SetupComposerWindowCommands() {</span>
<a href="#l2.164"></a><span id="l2.164">   // Don't need to do this if already done</span>
<a href="#l2.165"></a><span id="l2.165">   if (gComposerWindowControllerID)</span>
<a href="#l2.166"></a><span id="l2.166">     return;</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168">   // Create a command controller and register commands</span>
<a href="#l2.169"></a><span id="l2.169">   //   specific to Web Composer window (file-related commands, HTML Source...)</span>
<a href="#l2.170"></a><span id="l2.170">   //   We can't use the composer controller created on the content window else</span>
<a href="#l2.171"></a><span id="l2.171">   //     we can't process commands when in HTMLSource editor</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineat">@@ -122,114 +119,103 @@ function SetupComposerWindowCommands()</span>
<a href="#l2.173"></a><span id="l2.173">   try {</span>
<a href="#l2.174"></a><span id="l2.174">     composerController = Cc[&quot;@mozilla.org/embedcomp/base-command-controller;1&quot;].createInstance();</span>
<a href="#l2.175"></a><span id="l2.175"> </span>
<a href="#l2.176"></a><span id="l2.176">     editorController = composerController.QueryInterface(Ci.nsIControllerContext);</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178">     // Get the nsIControllerCommandTable interface we need to register commands</span>
<a href="#l2.179"></a><span id="l2.179">     var interfaceRequestor = composerController.QueryInterface(Ci.nsIInterfaceRequestor);</span>
<a href="#l2.180"></a><span id="l2.180">     commandTable = interfaceRequestor.getInterface(Ci.nsIControllerCommandTable);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-  }</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-  catch (e)</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-  {</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+  } catch (e) {</span>
<a href="#l2.185"></a><span id="l2.185">     dump(&quot;Failed to create composerController\n&quot;);</span>
<a href="#l2.186"></a><span id="l2.186">     return;</span>
<a href="#l2.187"></a><span id="l2.187">   }</span>
<a href="#l2.188"></a><span id="l2.188"> </span>
<a href="#l2.189"></a><span id="l2.189"> </span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-  if (!commandTable)</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-  {</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+  if (!commandTable) {</span>
<a href="#l2.193"></a><span id="l2.193">     dump(&quot;Failed to get interface for nsIControllerCommandManager\n&quot;);</span>
<a href="#l2.194"></a><span id="l2.194">     return;</span>
<a href="#l2.195"></a><span id="l2.195">   }</span>
<a href="#l2.196"></a><span id="l2.196"> </span>
<a href="#l2.197"></a><span id="l2.197">   // File-related commands</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_open&quot;,           nsOpenCommand);</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_save&quot;,           nsSaveCommand);</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_saveAs&quot;,         nsSaveAsCommand);</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_exportToText&quot;,   nsExportToTextCommand);</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_saveAndChangeEncoding&quot;,  nsSaveAndChangeEncodingCommand);</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_publish&quot;,        nsPublishCommand);</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_publishAs&quot;,      nsPublishAsCommand);</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_publishSettings&quot;,nsPublishSettingsCommand);</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_revert&quot;,         nsRevertCommand);</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_openRemote&quot;,     nsOpenRemoteCommand);</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_preview&quot;,        nsPreviewCommand);</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_editSendPage&quot;,   nsSendPageCommand);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_print&quot;,          nsPrintCommand);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_printpreview&quot;,   nsPrintPreviewCommand);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_printSetup&quot;,     nsPrintSetupCommand);</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_close&quot;,          nsCloseCommand);</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_preferences&quot;,    nsPreferencesCommand);</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_open&quot;, nsOpenCommand);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_save&quot;, nsSaveCommand);</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_saveAs&quot;, nsSaveAsCommand);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_exportToText&quot;, nsExportToTextCommand);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_saveAndChangeEncoding&quot;, nsSaveAndChangeEncodingCommand);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_publish&quot;, nsPublishCommand);</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_publishAs&quot;, nsPublishAsCommand);</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_publishSettings&quot;, nsPublishSettingsCommand);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_revert&quot;, nsRevertCommand);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_openRemote&quot;, nsOpenRemoteCommand);</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_preview&quot;, nsPreviewCommand);</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_editSendPage&quot;, nsSendPageCommand);</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_print&quot;, nsPrintCommand);</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_printpreview&quot;, nsPrintPreviewCommand);</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_printSetup&quot;, nsPrintSetupCommand);</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_close&quot;, nsCloseCommand);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+  commandTable.registerCommand(&quot;cmd_preferences&quot;, nsPreferencesCommand);</span>
<a href="#l2.232"></a><span id="l2.232"> </span>
<a href="#l2.233"></a><span id="l2.233">   // Edit Mode commands</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-  if (GetCurrentEditorType() == &quot;html&quot;)</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-  {</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_NormalMode&quot;,         nsNormalModeCommand);</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_AllTagsMode&quot;,        nsAllTagsModeCommand);</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_HTMLSourceMode&quot;,     nsHTMLSourceModeCommand);</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_PreviewMode&quot;,        nsPreviewModeCommand);</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_FinishHTMLSource&quot;,   nsFinishHTMLSource);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_CancelHTMLSource&quot;,   nsCancelHTMLSource);</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  if (GetCurrentEditorType() == &quot;html&quot;) {</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+    commandTable.registerCommand(&quot;cmd_NormalMode&quot;, nsNormalModeCommand);</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+    commandTable.registerCommand(&quot;cmd_AllTagsMode&quot;, nsAllTagsModeCommand);</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+    commandTable.registerCommand(&quot;cmd_HTMLSourceMode&quot;, nsHTMLSourceModeCommand);</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+    commandTable.registerCommand(&quot;cmd_PreviewMode&quot;, nsPreviewModeCommand);</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+    commandTable.registerCommand(&quot;cmd_FinishHTMLSource&quot;, nsFinishHTMLSource);</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+    commandTable.registerCommand(&quot;cmd_CancelHTMLSource&quot;, nsCancelHTMLSource);</span>
<a href="#l2.249"></a><span id="l2.249">     commandTable.registerCommand(&quot;cmd_updateStructToolbar&quot;, nsUpdateStructToolbarCommand);</span>
<a href="#l2.250"></a><span id="l2.250">   }</span>
<a href="#l2.251"></a><span id="l2.251"> </span>
<a href="#l2.252"></a><span id="l2.252">   windowControllers.insertControllerAt(0, editorController);</span>
<a href="#l2.253"></a><span id="l2.253"> </span>
<a href="#l2.254"></a><span id="l2.254">   // Store the controller ID so we can be sure to get the right one later</span>
<a href="#l2.255"></a><span id="l2.255">   gComposerWindowControllerID = windowControllers.getControllerId(editorController);</span>
<a href="#l2.256"></a><span id="l2.256"> }</span>
<a href="#l2.257"></a><span id="l2.257"> </span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-function GetComposerCommandTable()</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-{</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+function GetComposerCommandTable() {</span>
<a href="#l2.263"></a><span id="l2.263">   var controller;</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-  if (gComposerJSCommandControllerID)</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-  {</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+  if (gComposerJSCommandControllerID) {</span>
<a href="#l2.267"></a><span id="l2.267">     try {</span>
<a href="#l2.268"></a><span id="l2.268">       controller = window.content.controllers.getControllerById(gComposerJSCommandControllerID);</span>
<a href="#l2.269"></a><span id="l2.269">     } catch (e) {}</span>
<a href="#l2.270"></a><span id="l2.270">   }</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-  if (!controller)</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-  {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-    //create it</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+  if (!controller) {</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+    // create it</span>
<a href="#l2.276"></a><span id="l2.276">     controller = Cc[&quot;@mozilla.org/embedcomp/base-command-controller;1&quot;].createInstance();</span>
<a href="#l2.277"></a><span id="l2.277"> </span>
<a href="#l2.278"></a><span id="l2.278">     var editorController = controller.QueryInterface(Ci.nsIControllerContext);</span>
<a href="#l2.279"></a><span id="l2.279">     editorController.setCommandContext(GetCurrentEditorElement());</span>
<a href="#l2.280"></a><span id="l2.280">     window.content.controllers.insertControllerAt(0, controller);</span>
<a href="#l2.281"></a><span id="l2.281"> </span>
<a href="#l2.282"></a><span id="l2.282">     // Store the controller ID so we can be sure to get the right one later</span>
<a href="#l2.283"></a><span id="l2.283">     gComposerJSCommandControllerID = window.content.controllers.getControllerId(controller);</span>
<a href="#l2.284"></a><span id="l2.284">   }</span>
<a href="#l2.285"></a><span id="l2.285"> </span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-  if (controller)</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-  {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+  if (controller) {</span>
<a href="#l2.289"></a><span id="l2.289">     var interfaceRequestor = controller.QueryInterface(Ci.nsIInterfaceRequestor);</span>
<a href="#l2.290"></a><span id="l2.290">     return interfaceRequestor.getInterface(Ci.nsIControllerCommandTable);</span>
<a href="#l2.291"></a><span id="l2.291">   }</span>
<a href="#l2.292"></a><span id="l2.292">   return null;</span>
<a href="#l2.293"></a><span id="l2.293"> }</span>
<a href="#l2.294"></a><span id="l2.294"> </span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-function goUpdateCommandState(command)</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-{</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-  try</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-  {</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+function goUpdateCommandState(command) {</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+  try {</span>
<a href="#l2.303"></a><span id="l2.303">     var controller = top.document.commandDispatcher.getControllerForCommand(command);</span>
<a href="#l2.304"></a><span id="l2.304">     if (!(controller instanceof Ci.nsICommandController))</span>
<a href="#l2.305"></a><span id="l2.305">       return;</span>
<a href="#l2.306"></a><span id="l2.306"> </span>
<a href="#l2.307"></a><span id="l2.307">     var params = newCommandParams();</span>
<a href="#l2.308"></a><span id="l2.308">     if (!params) return;</span>
<a href="#l2.309"></a><span id="l2.309"> </span>
<a href="#l2.310"></a><span id="l2.310">     controller.getCommandStateWithParams(command, params);</span>
<a href="#l2.311"></a><span id="l2.311"> </span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-    switch (command)</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-    {</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+    switch (command) {</span>
<a href="#l2.315"></a><span id="l2.315">       case &quot;cmd_bold&quot;:</span>
<a href="#l2.316"></a><span id="l2.316">       case &quot;cmd_italic&quot;:</span>
<a href="#l2.317"></a><span id="l2.317">       case &quot;cmd_underline&quot;:</span>
<a href="#l2.318"></a><span id="l2.318">       case &quot;cmd_var&quot;:</span>
<a href="#l2.319"></a><span id="l2.319">       case &quot;cmd_samp&quot;:</span>
<a href="#l2.320"></a><span id="l2.320">       case &quot;cmd_code&quot;:</span>
<a href="#l2.321"></a><span id="l2.321">       case &quot;cmd_acronym&quot;:</span>
<a href="#l2.322"></a><span id="l2.322">       case &quot;cmd_abbr&quot;:</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineat">@@ -264,109 +250,91 @@ function goUpdateCommandState(command)</span>
<a href="#l2.324"></a><span id="l2.324">       case &quot;cmd_increaseFont&quot;:</span>
<a href="#l2.325"></a><span id="l2.325">       case &quot;cmd_decreaseFont&quot;:</span>
<a href="#l2.326"></a><span id="l2.326">       case &quot;cmd_increaseFontStep&quot;:</span>
<a href="#l2.327"></a><span id="l2.327">       case &quot;cmd_decreaseFontStep&quot;:</span>
<a href="#l2.328"></a><span id="l2.328">       case &quot;cmd_removeStyles&quot;:</span>
<a href="#l2.329"></a><span id="l2.329">       case &quot;cmd_smiley&quot;:</span>
<a href="#l2.330"></a><span id="l2.330">         break;</span>
<a href="#l2.331"></a><span id="l2.331"> </span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-      default: dump(&quot;no update for command: &quot; +command+&quot;\n&quot;);</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+      default: dump(&quot;no update for command: &quot; + command + &quot;\n&quot;);</span>
<a href="#l2.334"></a><span id="l2.334">     }</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-  }</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-  catch (e) { dump(&quot;An error occurred updating the &quot;+command+&quot; command: \n&quot;+e+&quot;\n&quot;); }</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+  } catch (e) { dump(&quot;An error occurred updating the &quot; + command + &quot; command: \n&quot; + e + &quot;\n&quot;); }</span>
<a href="#l2.338"></a><span id="l2.338"> }</span>
<a href="#l2.339"></a><span id="l2.339"> </span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-function goUpdateComposerMenuItems(commandset)</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-{</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-  //dump(&quot;Updating commands for &quot; + commandset.id + &quot;\n&quot;);</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-  for (var i = 0; i &lt; commandset.childNodes.length; i++)</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-  {</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+function goUpdateComposerMenuItems(commandset) {</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+  // dump(&quot;Updating commands for &quot; + commandset.id + &quot;\n&quot;);</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+  for (var i = 0; i &lt; commandset.childNodes.length; i++) {</span>
<a href="#l2.350"></a><span id="l2.350">     var commandNode = commandset.childNodes[i];</span>
<a href="#l2.351"></a><span id="l2.351">     var commandID = commandNode.id;</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-    if (commandID)</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-    {</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+    if (commandID) {</span>
<a href="#l2.355"></a><span id="l2.355">       goUpdateCommand(commandID);  // enable or disable</span>
<a href="#l2.356"></a><span id="l2.356">       if (commandNode.hasAttribute(&quot;state&quot;))</span>
<a href="#l2.357"></a><span id="l2.357">         goUpdateCommandState(commandID);</span>
<a href="#l2.358"></a><span id="l2.358">     }</span>
<a href="#l2.359"></a><span id="l2.359">   }</span>
<a href="#l2.360"></a><span id="l2.360"> }</span>
<a href="#l2.361"></a><span id="l2.361"> </span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-function goDoCommandParams(command, params)</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-{</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-  try</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-  {</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+function goDoCommandParams(command, params) {</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+  try {</span>
<a href="#l2.370"></a><span id="l2.370">     var controller = top.document.commandDispatcher.getControllerForCommand(command);</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-    if (controller &amp;&amp; controller.isCommandEnabled(command))</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-    {</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-      if (controller instanceof Ci.nsICommandController)</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-      {</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+    if (controller &amp;&amp; controller.isCommandEnabled(command)) {</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+      if (controller instanceof Ci.nsICommandController) {</span>
<a href="#l2.377"></a><span id="l2.377">         controller.doCommandWithParams(command, params);</span>
<a href="#l2.378"></a><span id="l2.378"> </span>
<a href="#l2.379"></a><span id="l2.379">         // the following two lines should be removed when we implement observers</span>
<a href="#l2.380"></a><span id="l2.380">         if (params)</span>
<a href="#l2.381"></a><span id="l2.381">           controller.getCommandStateWithParams(command, params);</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-      }</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-      else</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-      {</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+      } else {</span>
<a href="#l2.386"></a><span id="l2.386">         controller.doCommand(command);</span>
<a href="#l2.387"></a><span id="l2.387">       }</span>
<a href="#l2.388"></a><span id="l2.388">       ResetStructToolbar();</span>
<a href="#l2.389"></a><span id="l2.389">     }</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-  }</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-  catch (e)</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-  {</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-    dump(&quot;An error occurred executing the &quot;+command+&quot; command\n&quot;);</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+  } catch (e) {</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+    dump(&quot;An error occurred executing the &quot; + command + &quot; command\n&quot;);</span>
<a href="#l2.396"></a><span id="l2.396">   }</span>
<a href="#l2.397"></a><span id="l2.397"> }</span>
<a href="#l2.398"></a><span id="l2.398"> </span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-function pokeStyleUI(uiID, aDesiredState)</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-{</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+function pokeStyleUI(uiID, aDesiredState) {</span>
<a href="#l2.402"></a><span id="l2.402">  try {</span>
<a href="#l2.403"></a><span id="l2.403">   var commandNode = top.document.getElementById(uiID);</span>
<a href="#l2.404"></a><span id="l2.404">   if (!commandNode)</span>
<a href="#l2.405"></a><span id="l2.405">     return;</span>
<a href="#l2.406"></a><span id="l2.406"> </span>
<a href="#l2.407"></a><span id="l2.407">   var uiState = (&quot;true&quot; == commandNode.getAttribute(&quot;state&quot;));</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-  if (aDesiredState != uiState)</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-  {</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+  if (aDesiredState != uiState) {</span>
<a href="#l2.411"></a><span id="l2.411">     commandNode.setAttribute(&quot;state&quot;, aDesiredState ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l2.412"></a><span id="l2.412">   }</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">- } catch(e) { dump(&quot;poking UI for &quot;+uiID+&quot; failed: &quot;+e+&quot;\n&quot;); }</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+ } catch (e) { dump(&quot;poking UI for &quot; + uiID + &quot; failed: &quot; + e + &quot;\n&quot;); }</span>
<a href="#l2.415"></a><span id="l2.415"> }</span>
<a href="#l2.416"></a><span id="l2.416"> </span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-function doStyleUICommand(cmdStr)</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-{</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-  try</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-  {</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+function doStyleUICommand(cmdStr) {</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+  try {</span>
<a href="#l2.423"></a><span id="l2.423">     var cmdParams = newCommandParams();</span>
<a href="#l2.424"></a><span id="l2.424">     goDoCommandParams(cmdStr, cmdParams);</span>
<a href="#l2.425"></a><span id="l2.425">     if (cmdParams)</span>
<a href="#l2.426"></a><span id="l2.426">       pokeStyleUI(cmdStr, cmdParams.getBooleanValue(&quot;state_all&quot;));</span>
<a href="#l2.427"></a><span id="l2.427"> </span>
<a href="#l2.428"></a><span id="l2.428">     ResetStructToolbar();</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-  } catch(e) {}</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+  } catch (e) {}</span>
<a href="#l2.431"></a><span id="l2.431"> }</span>
<a href="#l2.432"></a><span id="l2.432"> </span>
<a href="#l2.433"></a><span id="l2.433"> // Copied from jsmime.js.</span>
<a href="#l2.434"></a><span id="l2.434"> function stringToTypedArray(buffer) {</span>
<a href="#l2.435"></a><span id="l2.435">   var typedarray = new Uint8Array(buffer.length);</span>
<a href="#l2.436"></a><span id="l2.436">   for (var i = 0; i &lt; buffer.length; i++) {</span>
<a href="#l2.437"></a><span id="l2.437">     typedarray[i] = buffer.charCodeAt(i);</span>
<a href="#l2.438"></a><span id="l2.438">   }</span>
<a href="#l2.439"></a><span id="l2.439">   return typedarray;</span>
<a href="#l2.440"></a><span id="l2.440"> }</span>
<a href="#l2.441"></a><span id="l2.441"> </span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-function pokeMultiStateUI(uiID, cmdParams)</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-{</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-  try</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-  {</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+function pokeMultiStateUI(uiID, cmdParams) {</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+  try {</span>
<a href="#l2.448"></a><span id="l2.448">     var commandNode = document.getElementById(uiID);</span>
<a href="#l2.449"></a><span id="l2.449">     if (!commandNode)</span>
<a href="#l2.450"></a><span id="l2.450">       return;</span>
<a href="#l2.451"></a><span id="l2.451"> </span>
<a href="#l2.452"></a><span id="l2.452">     var isMixed = cmdParams.getBooleanValue(&quot;state_mixed&quot;);</span>
<a href="#l2.453"></a><span id="l2.453">     var desiredAttrib;</span>
<a href="#l2.454"></a><span id="l2.454">     if (isMixed)</span>
<a href="#l2.455"></a><span id="l2.455">       desiredAttrib = &quot;mixed&quot;;</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineat">@@ -374,104 +342,93 @@ function pokeMultiStateUI(uiID, cmdParam</span>
<a href="#l2.457"></a><span id="l2.457">       var valuetype = cmdParams.getValueType(&quot;state_attribute&quot;);</span>
<a href="#l2.458"></a><span id="l2.458">       if (valuetype == Ci.nsICommandParams.eStringType) {</span>
<a href="#l2.459"></a><span id="l2.459">         desiredAttrib = cmdParams.getCStringValue(&quot;state_attribute&quot;);</span>
<a href="#l2.460"></a><span id="l2.460">         // Decode UTF-8, for example for font names in Japanese.</span>
<a href="#l2.461"></a><span id="l2.461">         desiredAttrib = new TextDecoder(&quot;UTF-8&quot;).decode(stringToTypedArray(desiredAttrib));</span>
<a href="#l2.462"></a><span id="l2.462">       } else {</span>
<a href="#l2.463"></a><span id="l2.463">         desiredAttrib = cmdParams.getStringValue(&quot;state_attribute&quot;);</span>
<a href="#l2.464"></a><span id="l2.464">       }</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-</span>
<a href="#l2.466"></a><span id="l2.466">     }</span>
<a href="#l2.467"></a><span id="l2.467"> </span>
<a href="#l2.468"></a><span id="l2.468">     var uiState = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-    if (desiredAttrib != uiState)</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-    {</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+    if (desiredAttrib != uiState) {</span>
<a href="#l2.472"></a><span id="l2.472">       commandNode.setAttribute(&quot;state&quot;, desiredAttrib);</span>
<a href="#l2.473"></a><span id="l2.473">     }</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-  } catch(e) {}</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+  } catch (e) {}</span>
<a href="#l2.476"></a><span id="l2.476"> }</span>
<a href="#l2.477"></a><span id="l2.477"> </span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-function doStatefulCommand(commandID, newState)</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-{</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+function doStatefulCommand(commandID, newState) {</span>
<a href="#l2.481"></a><span id="l2.481">   var commandNode = document.getElementById(commandID);</span>
<a href="#l2.482"></a><span id="l2.482">   if (commandNode)</span>
<a href="#l2.483"></a><span id="l2.483">       commandNode.setAttribute(&quot;state&quot;, newState);</span>
<a href="#l2.484"></a><span id="l2.484">   gContentWindow.focus();   // needed for command dispatch to work</span>
<a href="#l2.485"></a><span id="l2.485"> </span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-  try</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-  {</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+  try {</span>
<a href="#l2.489"></a><span id="l2.489">     var cmdParams = newCommandParams();</span>
<a href="#l2.490"></a><span id="l2.490">     if (!cmdParams) return;</span>
<a href="#l2.491"></a><span id="l2.491"> </span>
<a href="#l2.492"></a><span id="l2.492">     cmdParams.setStringValue(&quot;state_attribute&quot;, newState);</span>
<a href="#l2.493"></a><span id="l2.493">     goDoCommandParams(commandID, cmdParams);</span>
<a href="#l2.494"></a><span id="l2.494"> </span>
<a href="#l2.495"></a><span id="l2.495">     pokeMultiStateUI(commandID, cmdParams);</span>
<a href="#l2.496"></a><span id="l2.496"> </span>
<a href="#l2.497"></a><span id="l2.497">     ResetStructToolbar();</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-  } catch(e) { dump(&quot;error thrown in doStatefulCommand: &quot;+e+&quot;\n&quot;); }</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+  } catch (e) { dump(&quot;error thrown in doStatefulCommand: &quot; + e + &quot;\n&quot;); }</span>
<a href="#l2.500"></a><span id="l2.500"> }</span>
<a href="#l2.501"></a><span id="l2.501"> </span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-function PrintObject(obj)</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineminus">-{</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+function PrintObject(obj) {</span>
<a href="#l2.507"></a><span id="l2.507">   dump(&quot;-----&quot; + obj + &quot;------\n&quot;);</span>
<a href="#l2.508"></a><span id="l2.508">   var names = &quot;&quot;;</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-  for (var i in obj)</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-  {</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+  for (var i in obj) {</span>
<a href="#l2.512"></a><span id="l2.512">     if (i == &quot;value&quot;)</span>
<a href="#l2.513"></a><span id="l2.513">       names += i + &quot;: &quot; + obj.value + &quot;\n&quot;;</span>
<a href="#l2.514"></a><span id="l2.514">     else if (i == &quot;id&quot;)</span>
<a href="#l2.515"></a><span id="l2.515">       names += i + &quot;: &quot; + obj.id + &quot;\n&quot;;</span>
<a href="#l2.516"></a><span id="l2.516">     else</span>
<a href="#l2.517"></a><span id="l2.517">       names += i + &quot;\n&quot;;</span>
<a href="#l2.518"></a><span id="l2.518">   }</span>
<a href="#l2.519"></a><span id="l2.519"> </span>
<a href="#l2.520"></a><span id="l2.520">   dump(names + &quot;-----------\n&quot;);</span>
<a href="#l2.521"></a><span id="l2.521"> }</span>
<a href="#l2.522"></a><span id="l2.522"> </span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-function PrintNodeID(id)</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-{</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+function PrintNodeID(id) {</span>
<a href="#l2.528"></a><span id="l2.528">   PrintObject(document.getElementById(id));</span>
<a href="#l2.529"></a><span id="l2.529"> }</span>
<a href="#l2.530"></a><span id="l2.530"> </span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.533"></a><span id="l2.533"> var nsDummyHTMLCommand =</span>
<a href="#l2.534"></a><span id="l2.534"> {</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-  {</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.538"></a><span id="l2.538">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.539"></a><span id="l2.539">   },</span>
<a href="#l2.540"></a><span id="l2.540"> </span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-  {</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.550"></a><span id="l2.550">     // do nothing</span>
<a href="#l2.551"></a><span id="l2.551">     dump(&quot;Hey, who's calling the dummy command?\n&quot;);</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineminus">-  }</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineplus">+  },</span>
<a href="#l2.554"></a><span id="l2.554"> </span>
<a href="#l2.555"></a><span id="l2.555"> };</span>
<a href="#l2.556"></a><span id="l2.556"> </span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.559"></a><span id="l2.559"> var nsOpenCommand =</span>
<a href="#l2.560"></a><span id="l2.560"> {</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-  {</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.564"></a><span id="l2.564">     return true;    // we can always do this</span>
<a href="#l2.565"></a><span id="l2.565">   },</span>
<a href="#l2.566"></a><span id="l2.566"> </span>
<a href="#l2.567"></a><span id="l2.567" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineminus">-  {</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.576"></a><span id="l2.576">     var fileType = IsHTMLEditor() ? &quot;html&quot; : &quot;text&quot;;</span>
<a href="#l2.577"></a><span id="l2.577">     var title = GetString(IsHTMLEditor() ? &quot;OpenHTMLFile&quot; : &quot;OpenTextFile&quot;);</span>
<a href="#l2.578"></a><span id="l2.578"> </span>
<a href="#l2.579"></a><span id="l2.579">     var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l2.580"></a><span id="l2.580">     fp.init(window, title, nsIFilePicker.modeOpen);</span>
<a href="#l2.581"></a><span id="l2.581"> </span>
<a href="#l2.582"></a><span id="l2.582">     SetFilePickerDirectory(fp, fileType);</span>
<a href="#l2.583"></a><span id="l2.583"> </span>
<a href="#l2.584"></a><span id="l2.584" class="difflineat">@@ -488,297 +445,266 @@ var nsOpenCommand =</span>
<a href="#l2.585"></a><span id="l2.585">         return;</span>
<a href="#l2.586"></a><span id="l2.586">       }</span>
<a href="#l2.587"></a><span id="l2.587">       // editPage checks for already open window and activates it.</span>
<a href="#l2.588"></a><span id="l2.588">       if (fp.fileURL.spec) {</span>
<a href="#l2.589"></a><span id="l2.589">         SaveFilePickerDirectory(fp, fileType);</span>
<a href="#l2.590"></a><span id="l2.590">         editPage(fp.fileURL.spec, fileType);</span>
<a href="#l2.591"></a><span id="l2.591">       }</span>
<a href="#l2.592"></a><span id="l2.592">     });</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineminus">-  }</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineplus">+  },</span>
<a href="#l2.595"></a><span id="l2.595"> };</span>
<a href="#l2.596"></a><span id="l2.596"> </span>
<a href="#l2.597"></a><span id="l2.597"> // STRUCTURE TOOLBAR</span>
<a href="#l2.598"></a><span id="l2.598"> //</span>
<a href="#l2.599"></a><span id="l2.599"> var nsUpdateStructToolbarCommand =</span>
<a href="#l2.600"></a><span id="l2.600"> {</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineminus">-  {</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.604"></a><span id="l2.604">     UpdateStructToolbar();</span>
<a href="#l2.605"></a><span id="l2.605">     return true;</span>
<a href="#l2.606"></a><span id="l2.606">   },</span>
<a href="#l2.607"></a><span id="l2.607"> </span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineminus">-  doCommand: function(aCommand)  {}</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineminus">-}</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineplus">+  doCommand(aCommand) {},</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+};</span>
<a href="#l2.616"></a><span id="l2.616"> </span>
<a href="#l2.617"></a><span id="l2.617"> // ******* File output commands and utilities ******** //</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.620"></a><span id="l2.620"> var nsSaveCommand =</span>
<a href="#l2.621"></a><span id="l2.621"> {</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-  {</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.625"></a><span id="l2.625">     // Always allow saving when editing a remote document,</span>
<a href="#l2.626"></a><span id="l2.626">     //  otherwise the document modified state would prevent that</span>
<a href="#l2.627"></a><span id="l2.627">     //  when you first open a remote file.</span>
<a href="#l2.628"></a><span id="l2.628">     try {</span>
<a href="#l2.629"></a><span id="l2.629">       var docUrl = GetDocumentUrl();</span>
<a href="#l2.630"></a><span id="l2.630">       return IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.631"></a><span id="l2.631">         (IsDocumentModified() || IsHTMLSourceChanged() ||</span>
<a href="#l2.632"></a><span id="l2.632">          IsUrlAboutBlank(docUrl) || GetScheme(docUrl) != &quot;file&quot;);</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineminus">-    } catch (e) {return false;}</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+    } catch (e) { return false; }</span>
<a href="#l2.635"></a><span id="l2.635">   },</span>
<a href="#l2.636"></a><span id="l2.636"> </span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-  {</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineplus">+</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.646"></a><span id="l2.646">     var editor = GetCurrentEditor();</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-    if (editor)</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-    {</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineplus">+    if (editor) {</span>
<a href="#l2.650"></a><span id="l2.650">       if (IsHTMLEditor())</span>
<a href="#l2.651"></a><span id="l2.651">         SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.652"></a><span id="l2.652">       SaveDocument(IsUrlAboutBlank(GetDocumentUrl()), false, editor.contentsMIMEType);</span>
<a href="#l2.653"></a><span id="l2.653">     }</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-  }</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-}</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+  },</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineplus">+};</span>
<a href="#l2.658"></a><span id="l2.658"> </span>
<a href="#l2.659"></a><span id="l2.659"> var nsSaveAsCommand =</span>
<a href="#l2.660"></a><span id="l2.660"> {</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineminus">-  {</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.664"></a><span id="l2.664">     return (IsDocumentEditable());</span>
<a href="#l2.665"></a><span id="l2.665">   },</span>
<a href="#l2.666"></a><span id="l2.666"> </span>
<a href="#l2.667"></a><span id="l2.667" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineminus">-  {</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineplus">+</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.676"></a><span id="l2.676">     var editor = GetCurrentEditor();</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineminus">-    if (editor)</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineminus">-    {</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineplus">+    if (editor) {</span>
<a href="#l2.680"></a><span id="l2.680">       if (IsHTMLEditor())</span>
<a href="#l2.681"></a><span id="l2.681">         SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.682"></a><span id="l2.682">       SaveDocument(true, false, editor.contentsMIMEType);</span>
<a href="#l2.683"></a><span id="l2.683">     }</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineminus">-  }</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-}</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+  },</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineplus">+};</span>
<a href="#l2.688"></a><span id="l2.688"> </span>
<a href="#l2.689"></a><span id="l2.689"> var nsExportToTextCommand =</span>
<a href="#l2.690"></a><span id="l2.690"> {</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineminus">-  {</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.694"></a><span id="l2.694">     return (IsDocumentEditable());</span>
<a href="#l2.695"></a><span id="l2.695">   },</span>
<a href="#l2.696"></a><span id="l2.696"> </span>
<a href="#l2.697"></a><span id="l2.697" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineminus">-</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineminus">-  {</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineminus">-    if (GetCurrentEditor())</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineminus">-    {</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineplus">+</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineplus">+    if (GetCurrentEditor()) {</span>
<a href="#l2.709"></a><span id="l2.709">       SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.710"></a><span id="l2.710">       SaveDocument(true, true, &quot;text/plain&quot;);</span>
<a href="#l2.711"></a><span id="l2.711">     }</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineminus">-  }</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineminus">-}</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineplus">+  },</span>
<a href="#l2.715"></a><span id="l2.715" class="difflineplus">+};</span>
<a href="#l2.716"></a><span id="l2.716"> </span>
<a href="#l2.717"></a><span id="l2.717"> var nsSaveAndChangeEncodingCommand =</span>
<a href="#l2.718"></a><span id="l2.718"> {</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineminus">-  {</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.722"></a><span id="l2.722">     return (IsDocumentEditable());</span>
<a href="#l2.723"></a><span id="l2.723">   },</span>
<a href="#l2.724"></a><span id="l2.724"> </span>
<a href="#l2.725"></a><span id="l2.725" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineminus">-</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineminus">-  {</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineplus">+</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.734"></a><span id="l2.734">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.735"></a><span id="l2.735">     window.ok = false;</span>
<a href="#l2.736"></a><span id="l2.736">     window.exportToText = false;</span>
<a href="#l2.737"></a><span id="l2.737">     var oldTitle = GetDocumentTitle();</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EditorSaveAsCharset.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable=yes&quot;);</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EditorSaveAsCharset.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable=yes&quot;);</span>
<a href="#l2.740"></a><span id="l2.740"> </span>
<a href="#l2.741"></a><span id="l2.741">     if (GetDocumentTitle() != oldTitle)</span>
<a href="#l2.742"></a><span id="l2.742">       UpdateWindowTitle();</span>
<a href="#l2.743"></a><span id="l2.743"> </span>
<a href="#l2.744"></a><span id="l2.744" class="difflineminus">-    if (window.ok)</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineminus">-    {</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineminus">-      if (window.exportToText)</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineminus">-      {</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+    if (window.ok) {</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineplus">+      if (window.exportToText) {</span>
<a href="#l2.750"></a><span id="l2.750">         SaveDocument(true, true, &quot;text/plain&quot;);</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineminus">-      }</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineminus">-      else</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineminus">-      {</span>
<a href="#l2.754"></a><span id="l2.754" class="difflineplus">+      } else {</span>
<a href="#l2.755"></a><span id="l2.755">         var editor = GetCurrentEditor();</span>
<a href="#l2.756"></a><span id="l2.756">         SaveDocument(true, false, editor ? editor.contentsMIMEType : null);</span>
<a href="#l2.757"></a><span id="l2.757">       }</span>
<a href="#l2.758"></a><span id="l2.758">     }</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineminus">-  }</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineplus">+  },</span>
<a href="#l2.761"></a><span id="l2.761"> };</span>
<a href="#l2.762"></a><span id="l2.762"> </span>
<a href="#l2.763"></a><span id="l2.763"> var nsPublishCommand =</span>
<a href="#l2.764"></a><span id="l2.764"> {</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineminus">-  {</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineminus">-    if (IsDocumentEditable())</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineminus">-    {</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineplus">+    if (IsDocumentEditable()) {</span>
<a href="#l2.771"></a><span id="l2.771">       // Always allow publishing when editing a local document,</span>
<a href="#l2.772"></a><span id="l2.772">       //  otherwise the document modified state would prevent that</span>
<a href="#l2.773"></a><span id="l2.773">       //  when you first open any local file.</span>
<a href="#l2.774"></a><span id="l2.774">       try {</span>
<a href="#l2.775"></a><span id="l2.775">         var docUrl = GetDocumentUrl();</span>
<a href="#l2.776"></a><span id="l2.776">         return IsDocumentModified() || IsHTMLSourceChanged()</span>
<a href="#l2.777"></a><span id="l2.777">                || IsUrlAboutBlank(docUrl) || GetScheme(docUrl) == &quot;file&quot;;</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineminus">-      } catch (e) {return false;}</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineplus">+      } catch (e) { return false; }</span>
<a href="#l2.780"></a><span id="l2.780">     }</span>
<a href="#l2.781"></a><span id="l2.781">     return false;</span>
<a href="#l2.782"></a><span id="l2.782">   },</span>
<a href="#l2.783"></a><span id="l2.783"> </span>
<a href="#l2.784"></a><span id="l2.784" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineminus">-</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.788"></a><span id="l2.788" class="difflineminus">-  {</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-    if (GetCurrentEditor())</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineminus">-    {</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineplus">+</span>
<a href="#l2.794"></a><span id="l2.794" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.795"></a><span id="l2.795" class="difflineplus">+    if (GetCurrentEditor()) {</span>
<a href="#l2.796"></a><span id="l2.796">       let docUrl = GetDocumentUrl();</span>
<a href="#l2.797"></a><span id="l2.797">       let filename = GetFilename(docUrl);</span>
<a href="#l2.798"></a><span id="l2.798">       let publishData;</span>
<a href="#l2.799"></a><span id="l2.799"> </span>
<a href="#l2.800"></a><span id="l2.800">       // First check pref to always show publish dialog</span>
<a href="#l2.801"></a><span id="l2.801">       let showPublishDialog = Services.prefs.getBoolPref(&quot;editor.always_show_publish_dialog&quot;);</span>
<a href="#l2.802"></a><span id="l2.802"> </span>
<a href="#l2.803"></a><span id="l2.803" class="difflineminus">-      if (!showPublishDialog &amp;&amp; filename)</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineminus">-      {</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineplus">+      if (!showPublishDialog &amp;&amp; filename) {</span>
<a href="#l2.806"></a><span id="l2.806">         // Try to get publish data from the document url</span>
<a href="#l2.807"></a><span id="l2.807">         publishData = CreatePublishDataFromUrl(docUrl);</span>
<a href="#l2.808"></a><span id="l2.808"> </span>
<a href="#l2.809"></a><span id="l2.809">         // If none, use default publishing site? Need a pref for this</span>
<a href="#l2.810"></a><span id="l2.810" class="difflineminus">-        //if (!publishData)</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineplus">+        // if (!publishData)</span>
<a href="#l2.812"></a><span id="l2.812">         //  publishData = GetPublishDataFromSiteName(GetDefaultPublishSiteName(), filename);</span>
<a href="#l2.813"></a><span id="l2.813">       }</span>
<a href="#l2.814"></a><span id="l2.814"> </span>
<a href="#l2.815"></a><span id="l2.815" class="difflineminus">-      if (showPublishDialog || !publishData)</span>
<a href="#l2.816"></a><span id="l2.816" class="difflineminus">-      {</span>
<a href="#l2.817"></a><span id="l2.817" class="difflineplus">+      if (showPublishDialog || !publishData) {</span>
<a href="#l2.818"></a><span id="l2.818">         // Show the publish dialog</span>
<a href="#l2.819"></a><span id="l2.819">         publishData = {};</span>
<a href="#l2.820"></a><span id="l2.820">         window.ok = false;</span>
<a href="#l2.821"></a><span id="l2.821">         let oldTitle = GetDocumentTitle();</span>
<a href="#l2.822"></a><span id="l2.822" class="difflineminus">-        window.openDialog(&quot;chrome://editor/content/EditorPublish.xul&quot;,&quot;_blank&quot;,</span>
<a href="#l2.823"></a><span id="l2.823" class="difflineplus">+        window.openDialog(&quot;chrome://editor/content/EditorPublish.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.824"></a><span id="l2.824">                           &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, &quot;&quot;, publishData);</span>
<a href="#l2.825"></a><span id="l2.825">         if (GetDocumentTitle() != oldTitle)</span>
<a href="#l2.826"></a><span id="l2.826">           UpdateWindowTitle();</span>
<a href="#l2.827"></a><span id="l2.827"> </span>
<a href="#l2.828"></a><span id="l2.828">         if (!window.ok)</span>
<a href="#l2.829"></a><span id="l2.829">           return false;</span>
<a href="#l2.830"></a><span id="l2.830">       }</span>
<a href="#l2.831"></a><span id="l2.831" class="difflineminus">-      if (publishData)</span>
<a href="#l2.832"></a><span id="l2.832" class="difflineminus">-      {</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineplus">+      if (publishData) {</span>
<a href="#l2.834"></a><span id="l2.834">         SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.835"></a><span id="l2.835">         return Publish(publishData);</span>
<a href="#l2.836"></a><span id="l2.836">       }</span>
<a href="#l2.837"></a><span id="l2.837">     }</span>
<a href="#l2.838"></a><span id="l2.838">     return false;</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineminus">-  }</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineminus">-}</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineplus">+  },</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineplus">+};</span>
<a href="#l2.843"></a><span id="l2.843"> </span>
<a href="#l2.844"></a><span id="l2.844"> var nsPublishAsCommand =</span>
<a href="#l2.845"></a><span id="l2.845"> {</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineminus">-  {</span>
<a href="#l2.848"></a><span id="l2.848" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.849"></a><span id="l2.849">     return (IsDocumentEditable());</span>
<a href="#l2.850"></a><span id="l2.850">   },</span>
<a href="#l2.851"></a><span id="l2.851"> </span>
<a href="#l2.852"></a><span id="l2.852" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.854"></a><span id="l2.854" class="difflineminus">-</span>
<a href="#l2.855"></a><span id="l2.855" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.856"></a><span id="l2.856" class="difflineminus">-  {</span>
<a href="#l2.857"></a><span id="l2.857" class="difflineminus">-    if (GetCurrentEditor())</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineminus">-    {</span>
<a href="#l2.859"></a><span id="l2.859" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.860"></a><span id="l2.860" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineplus">+</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.863"></a><span id="l2.863" class="difflineplus">+    if (GetCurrentEditor()) {</span>
<a href="#l2.864"></a><span id="l2.864">       SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.865"></a><span id="l2.865"> </span>
<a href="#l2.866"></a><span id="l2.866">       window.ok = false;</span>
<a href="#l2.867"></a><span id="l2.867">       var publishData = {};</span>
<a href="#l2.868"></a><span id="l2.868">       var oldTitle = GetDocumentTitle();</span>
<a href="#l2.869"></a><span id="l2.869" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EditorPublish.xul&quot;,&quot;_blank&quot;,</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineplus">+      window.openDialog(&quot;chrome://editor/content/EditorPublish.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.871"></a><span id="l2.871">                         &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, &quot;&quot;, publishData);</span>
<a href="#l2.872"></a><span id="l2.872">       if (GetDocumentTitle() != oldTitle)</span>
<a href="#l2.873"></a><span id="l2.873">         UpdateWindowTitle();</span>
<a href="#l2.874"></a><span id="l2.874"> </span>
<a href="#l2.875"></a><span id="l2.875">       if (window.ok)</span>
<a href="#l2.876"></a><span id="l2.876">         return Publish(publishData);</span>
<a href="#l2.877"></a><span id="l2.877">     }</span>
<a href="#l2.878"></a><span id="l2.878">     return false;</span>
<a href="#l2.879"></a><span id="l2.879" class="difflineminus">-  }</span>
<a href="#l2.880"></a><span id="l2.880" class="difflineminus">-}</span>
<a href="#l2.881"></a><span id="l2.881" class="difflineplus">+  },</span>
<a href="#l2.882"></a><span id="l2.882" class="difflineplus">+};</span>
<a href="#l2.883"></a><span id="l2.883"> </span>
<a href="#l2.884"></a><span id="l2.884"> // ------- output utilities   ----- //</span>
<a href="#l2.885"></a><span id="l2.885"> </span>
<a href="#l2.886"></a><span id="l2.886"> // returns a fileExtension string</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineminus">-function GetExtensionBasedOnMimeType(aMIMEType)</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineminus">-{</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineplus">+function GetExtensionBasedOnMimeType(aMIMEType) {</span>
<a href="#l2.890"></a><span id="l2.890">   try {</span>
<a href="#l2.891"></a><span id="l2.891">     var mimeService = null;</span>
<a href="#l2.892"></a><span id="l2.892">     mimeService = Cc[&quot;@mozilla.org/mime;1&quot;]</span>
<a href="#l2.893"></a><span id="l2.893">                     .getService(Ci.nsIMIMEService);</span>
<a href="#l2.894"></a><span id="l2.894"> </span>
<a href="#l2.895"></a><span id="l2.895">     var fileExtension = mimeService.getPrimaryExtension(aMIMEType, null);</span>
<a href="#l2.896"></a><span id="l2.896"> </span>
<a href="#l2.897"></a><span id="l2.897">     // the MIME service likes to give back &quot;.htm&quot; for text/html files,</span>
<a href="#l2.898"></a><span id="l2.898">     // so do a special-case fix here.</span>
<a href="#l2.899"></a><span id="l2.899">     if (fileExtension == &quot;htm&quot;)</span>
<a href="#l2.900"></a><span id="l2.900">       fileExtension = &quot;html&quot;;</span>
<a href="#l2.901"></a><span id="l2.901"> </span>
<a href="#l2.902"></a><span id="l2.902">     return fileExtension;</span>
<a href="#l2.903"></a><span id="l2.903" class="difflineminus">-  }</span>
<a href="#l2.904"></a><span id="l2.904" class="difflineminus">-  catch (e) {}</span>
<a href="#l2.905"></a><span id="l2.905" class="difflineplus">+  } catch (e) {}</span>
<a href="#l2.906"></a><span id="l2.906">   return &quot;&quot;;</span>
<a href="#l2.907"></a><span id="l2.907"> }</span>
<a href="#l2.908"></a><span id="l2.908"> </span>
<a href="#l2.909"></a><span id="l2.909" class="difflineminus">-function GetSuggestedFileName(aDocumentURLString, aMIMEType)</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineminus">-{</span>
<a href="#l2.911"></a><span id="l2.911" class="difflineplus">+function GetSuggestedFileName(aDocumentURLString, aMIMEType) {</span>
<a href="#l2.912"></a><span id="l2.912">   var extension = GetExtensionBasedOnMimeType(aMIMEType);</span>
<a href="#l2.913"></a><span id="l2.913">   if (extension)</span>
<a href="#l2.914"></a><span id="l2.914">     extension = &quot;.&quot; + extension;</span>
<a href="#l2.915"></a><span id="l2.915"> </span>
<a href="#l2.916"></a><span id="l2.916">   // check for existing file name we can use</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineminus">-  if (aDocumentURLString &amp;&amp; !IsUrlAboutBlank(aDocumentURLString))</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineminus">-  {</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineplus">+  if (aDocumentURLString &amp;&amp; !IsUrlAboutBlank(aDocumentURLString)) {</span>
<a href="#l2.920"></a><span id="l2.920">     try {</span>
<a href="#l2.921"></a><span id="l2.921">       let docURI = Services.io.newURI(aDocumentURLString,</span>
<a href="#l2.922"></a><span id="l2.922">         GetCurrentEditor().documentCharacterSet);</span>
<a href="#l2.923"></a><span id="l2.923">       docURI = docURI.QueryInterface(Ci.nsIURL);</span>
<a href="#l2.924"></a><span id="l2.924"> </span>
<a href="#l2.925"></a><span id="l2.925">       // grab the file name</span>
<a href="#l2.926"></a><span id="l2.926">       let url = validateFileName(decodeURIComponent(docURI.fileBaseName));</span>
<a href="#l2.927"></a><span id="l2.927">       if (url)</span>
<a href="#l2.928"></a><span id="l2.928">         return url + extension;</span>
<a href="#l2.929"></a><span id="l2.929" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.931"></a><span id="l2.931">   }</span>
<a href="#l2.932"></a><span id="l2.932"> </span>
<a href="#l2.933"></a><span id="l2.933">   // Check if there is a title we can use to generate a valid filename,</span>
<a href="#l2.934"></a><span id="l2.934">   // if we can't, use the default filename.</span>
<a href="#l2.935"></a><span id="l2.935">   var title = validateFileName(GetDocumentTitle()) ||</span>
<a href="#l2.936"></a><span id="l2.936">               GetString(&quot;untitledDefaultFilename&quot;);</span>
<a href="#l2.937"></a><span id="l2.937">   return title + extension;</span>
<a href="#l2.938"></a><span id="l2.938"> }</span>
<a href="#l2.939"></a><span id="l2.939"> </span>
<a href="#l2.940"></a><span id="l2.940"> /**</span>
<a href="#l2.941"></a><span id="l2.941">  * @return {Promise} dialogResult</span>
<a href="#l2.942"></a><span id="l2.942">  */</span>
<a href="#l2.943"></a><span id="l2.943" class="difflineminus">-function PromptForSaveLocation(aDoSaveAsText, aEditorType, aMIMEType, aDocumentURLString)</span>
<a href="#l2.944"></a><span id="l2.944" class="difflineminus">-{</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineplus">+function PromptForSaveLocation(aDoSaveAsText, aEditorType, aMIMEType, aDocumentURLString) {</span>
<a href="#l2.946"></a><span id="l2.946">   var dialogResult = {};</span>
<a href="#l2.947"></a><span id="l2.947">   dialogResult.filepickerClick = nsIFilePicker.returnCancel;</span>
<a href="#l2.948"></a><span id="l2.948">   dialogResult.resultingURI = &quot;&quot;;</span>
<a href="#l2.949"></a><span id="l2.949">   dialogResult.resultingLocalFile = null;</span>
<a href="#l2.950"></a><span id="l2.950"> </span>
<a href="#l2.951"></a><span id="l2.951">   var fp = null;</span>
<a href="#l2.952"></a><span id="l2.952">   try {</span>
<a href="#l2.953"></a><span id="l2.953">     fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineat">@@ -810,74 +736,66 @@ function PromptForSaveLocation(aDoSaveAs</span>
<a href="#l2.955"></a><span id="l2.955">   // assuming we have information needed (like prior saved location)</span>
<a href="#l2.956"></a><span id="l2.956">   try {</span>
<a href="#l2.957"></a><span id="l2.957">     var fileHandler = GetFileProtocolHandler();</span>
<a href="#l2.958"></a><span id="l2.958"> </span>
<a href="#l2.959"></a><span id="l2.959">     var isLocalFile = true;</span>
<a href="#l2.960"></a><span id="l2.960">     try {</span>
<a href="#l2.961"></a><span id="l2.961">       let docURI = Services.io.newURI(aDocumentURLString, GetCurrentEditor().documentCharacterSet);</span>
<a href="#l2.962"></a><span id="l2.962">       isLocalFile = docURI.schemeIs(&quot;file&quot;);</span>
<a href="#l2.963"></a><span id="l2.963" class="difflineminus">-    }</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineminus">-    catch (e) {}</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.966"></a><span id="l2.966"> </span>
<a href="#l2.967"></a><span id="l2.967">     var parentLocation = null;</span>
<a href="#l2.968"></a><span id="l2.968" class="difflineminus">-    if (isLocalFile)</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineminus">-    {</span>
<a href="#l2.970"></a><span id="l2.970" class="difflineplus">+    if (isLocalFile) {</span>
<a href="#l2.971"></a><span id="l2.971">       var fileLocation = fileHandler.getFileFromURLSpec(aDocumentURLString); // this asserts if url is not local</span>
<a href="#l2.972"></a><span id="l2.972">       parentLocation = fileLocation.parent;</span>
<a href="#l2.973"></a><span id="l2.973">     }</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineminus">-    if (parentLocation)</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineminus">-    {</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineplus">+    if (parentLocation) {</span>
<a href="#l2.977"></a><span id="l2.977">       // Save current filepicker's default location</span>
<a href="#l2.978"></a><span id="l2.978">       if (&quot;gFilePickerDirectory&quot; in window)</span>
<a href="#l2.979"></a><span id="l2.979">         gFilePickerDirectory = fp.displayDirectory;</span>
<a href="#l2.980"></a><span id="l2.980"> </span>
<a href="#l2.981"></a><span id="l2.981">       fp.displayDirectory = parentLocation;</span>
<a href="#l2.982"></a><span id="l2.982" class="difflineminus">-    }</span>
<a href="#l2.983"></a><span id="l2.983" class="difflineminus">-    else</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineminus">-    {</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineplus">+    } else {</span>
<a href="#l2.986"></a><span id="l2.986">       // Initialize to the last-used directory for the particular type (saved in prefs)</span>
<a href="#l2.987"></a><span id="l2.987">       SetFilePickerDirectory(fp, aEditorType);</span>
<a href="#l2.988"></a><span id="l2.988">     }</span>
<a href="#l2.989"></a><span id="l2.989" class="difflineminus">-  }</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineminus">-  catch(e) {}</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineplus">+  } catch (e) {}</span>
<a href="#l2.992"></a><span id="l2.992"> </span>
<a href="#l2.993"></a><span id="l2.993">   return new Promise(resolve =&gt; {</span>
<a href="#l2.994"></a><span id="l2.994">     fp.open(rv =&gt; {</span>
<a href="#l2.995"></a><span id="l2.995">       dialogResult.filepickerClick = rv;</span>
<a href="#l2.996"></a><span id="l2.996">       if (rv != nsIFilePicker.returnCancel &amp;&amp; fp.file) {  // Allow OK and replace.</span>
<a href="#l2.997"></a><span id="l2.997">         // reset urlstring to new save location</span>
<a href="#l2.998"></a><span id="l2.998">         dialogResult.resultingURIString = fileHandler.getURLSpecFromFile(fp.file);</span>
<a href="#l2.999"></a><span id="l2.999">         dialogResult.resultingLocalFile = fp.file;</span>
<a href="#l2.1000"></a><span id="l2.1000">         SaveFilePickerDirectory(fp, aEditorType);</span>
<a href="#l2.1001"></a><span id="l2.1001">         resolve(dialogResult);</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineminus">-      }</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineminus">-      else if (&quot;gFilePickerDirectory&quot; in window &amp;&amp; gFilePickerDirectory) {</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineplus">+      } else if (&quot;gFilePickerDirectory&quot; in window &amp;&amp; gFilePickerDirectory) {</span>
<a href="#l2.1005"></a><span id="l2.1005">         fp.displayDirectory = gFilePickerDirectory;</span>
<a href="#l2.1006"></a><span id="l2.1006">         resolve(null);</span>
<a href="#l2.1007"></a><span id="l2.1007">       }</span>
<a href="#l2.1008"></a><span id="l2.1008">     });</span>
<a href="#l2.1009"></a><span id="l2.1009">   });</span>
<a href="#l2.1010"></a><span id="l2.1010"> }</span>
<a href="#l2.1011"></a><span id="l2.1011"> </span>
<a href="#l2.1012"></a><span id="l2.1012"> /**</span>
<a href="#l2.1013"></a><span id="l2.1013">  * If needed, prompt for document title and set the document title to the</span>
<a href="#l2.1014"></a><span id="l2.1014">  * preferred value.</span>
<a href="#l2.1015"></a><span id="l2.1015">  * @return true if the title was set up successfully;</span>
<a href="#l2.1016"></a><span id="l2.1016">  *         false if the user cancelled the title prompt</span>
<a href="#l2.1017"></a><span id="l2.1017">  */</span>
<a href="#l2.1018"></a><span id="l2.1018" class="difflineminus">-function PromptAndSetTitleIfNone()</span>
<a href="#l2.1019"></a><span id="l2.1019" class="difflineminus">-{</span>
<a href="#l2.1020"></a><span id="l2.1020" class="difflineplus">+function PromptAndSetTitleIfNone() {</span>
<a href="#l2.1021"></a><span id="l2.1021">   if (GetDocumentTitle()) // we have a title; no need to prompt!</span>
<a href="#l2.1022"></a><span id="l2.1022">     return true;</span>
<a href="#l2.1023"></a><span id="l2.1023"> </span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineminus">-  let result = {value:null};</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineplus">+  let result = {value: null};</span>
<a href="#l2.1026"></a><span id="l2.1026">   let captionStr = GetString(&quot;DocumentTitle&quot;);</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineminus">-  let msgStr = GetString(&quot;NeedDocTitle&quot;) + '\n' + GetString(&quot;DocTitleHelp&quot;);</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineminus">-  let confirmed = Services.prompt.prompt(window, captionStr, msgStr, result, null, {value:0});</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineplus">+  let msgStr = GetString(&quot;NeedDocTitle&quot;) + &quot;\n&quot; + GetString(&quot;DocTitleHelp&quot;);</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineplus">+  let confirmed = Services.prompt.prompt(window, captionStr, msgStr, result, null, {value: 0});</span>
<a href="#l2.1031"></a><span id="l2.1031">   if (confirmed)</span>
<a href="#l2.1032"></a><span id="l2.1032">     SetDocumentTitle(TrimString(result.value));</span>
<a href="#l2.1033"></a><span id="l2.1033"> </span>
<a href="#l2.1034"></a><span id="l2.1034">   return confirmed;</span>
<a href="#l2.1035"></a><span id="l2.1035"> }</span>
<a href="#l2.1036"></a><span id="l2.1036"> </span>
<a href="#l2.1037"></a><span id="l2.1037"> var gPersistObj;</span>
<a href="#l2.1038"></a><span id="l2.1038"> </span>
<a href="#l2.1039"></a><span id="l2.1039" class="difflineat">@@ -886,35 +804,32 @@ var gPersistObj;</span>
<a href="#l2.1040"></a><span id="l2.1040"> //    if (doUpdateURI)</span>
<a href="#l2.1041"></a><span id="l2.1041"> //      SetDocumentURI(docURI);</span>
<a href="#l2.1042"></a><span id="l2.1042"> //    UpdateWindowTitle();</span>
<a href="#l2.1043"></a><span id="l2.1043"> //    if (!aSaveCopy)</span>
<a href="#l2.1044"></a><span id="l2.1044"> //      editor.resetModificationCount();</span>
<a href="#l2.1045"></a><span id="l2.1045">       // this should cause notification to listeners that document has changed</span>
<a href="#l2.1046"></a><span id="l2.1046"> </span>
<a href="#l2.1047"></a><span id="l2.1047"> const webPersist = Ci.nsIWebBrowserPersist;</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineminus">-function OutputFileWithPersistAPI(editorDoc, aDestinationLocation, aRelatedFilesParentDir, aMimeType)</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineminus">-{</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineplus">+function OutputFileWithPersistAPI(editorDoc, aDestinationLocation, aRelatedFilesParentDir, aMimeType) {</span>
<a href="#l2.1051"></a><span id="l2.1051">   gPersistObj = null;</span>
<a href="#l2.1052"></a><span id="l2.1052">   var editor = GetCurrentEditor();</span>
<a href="#l2.1053"></a><span id="l2.1053">   try {</span>
<a href="#l2.1054"></a><span id="l2.1054">     editor.forceCompositionEnd();</span>
<a href="#l2.1055"></a><span id="l2.1055">   } catch (e) {}</span>
<a href="#l2.1056"></a><span id="l2.1056"> </span>
<a href="#l2.1057"></a><span id="l2.1057">   var isLocalFile = false;</span>
<a href="#l2.1058"></a><span id="l2.1058">   try {</span>
<a href="#l2.1059"></a><span id="l2.1059">     var tmp1 = aDestinationLocation.QueryInterface(Ci.nsIFile);</span>
<a href="#l2.1060"></a><span id="l2.1060">     isLocalFile = true;</span>
<a href="#l2.1061"></a><span id="l2.1061" class="difflineminus">-  }</span>
<a href="#l2.1062"></a><span id="l2.1062" class="difflineminus">-  catch (e) {</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineplus">+  } catch (e) {</span>
<a href="#l2.1064"></a><span id="l2.1064">     try {</span>
<a href="#l2.1065"></a><span id="l2.1065">       var tmp = aDestinationLocation.QueryInterface(Ci.nsIURI);</span>
<a href="#l2.1066"></a><span id="l2.1066">       isLocalFile = tmp.schemeIs(&quot;file&quot;);</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineminus">-    }</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineminus">-    catch (e) {}</span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.1070"></a><span id="l2.1070">   }</span>
<a href="#l2.1071"></a><span id="l2.1071"> </span>
<a href="#l2.1072"></a><span id="l2.1072">   try {</span>
<a href="#l2.1073"></a><span id="l2.1073">     // we should supply a parent directory if/when we turn on functionality to save related documents</span>
<a href="#l2.1074"></a><span id="l2.1074">     var persistObj = Cc[&quot;@mozilla.org/embedding/browser/nsWebBrowserPersist;1&quot;].createInstance(webPersist);</span>
<a href="#l2.1075"></a><span id="l2.1075">     persistObj.progressListener = gEditorOutputProgressListener;</span>
<a href="#l2.1076"></a><span id="l2.1076"> </span>
<a href="#l2.1077"></a><span id="l2.1077">     var wrapColumn = GetWrapColumn();</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineat">@@ -939,64 +854,57 @@ function OutputFileWithPersistAPI(editor</span>
<a href="#l2.1079"></a><span id="l2.1079">                             | webPersist.PERSIST_FLAGS_NO_BASE_TAG_MODIFICATIONS</span>
<a href="#l2.1080"></a><span id="l2.1080">                             | webPersist.PERSIST_FLAGS_REPLACE_EXISTING_FILES</span>
<a href="#l2.1081"></a><span id="l2.1081">                             | webPersist.PERSIST_FLAGS_DONT_FIXUP_LINKS</span>
<a href="#l2.1082"></a><span id="l2.1082">                             | webPersist.PERSIST_FLAGS_DONT_CHANGE_FILENAMES</span>
<a href="#l2.1083"></a><span id="l2.1083">                             | webPersist.PERSIST_FLAGS_FIXUP_ORIGINAL_DOM;</span>
<a href="#l2.1084"></a><span id="l2.1084">     persistObj.saveDocument(editorDoc, aDestinationLocation, aRelatedFilesParentDir,</span>
<a href="#l2.1085"></a><span id="l2.1085">                             aMimeType, outputFlags, wrapColumn);</span>
<a href="#l2.1086"></a><span id="l2.1086">     gPersistObj = persistObj;</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineminus">-  }</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineminus">-  catch(e) { dump(&quot;caught an error, bail\n&quot;); return false; }</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineplus">+  } catch (e) { dump(&quot;caught an error, bail\n&quot;); return false; }</span>
<a href="#l2.1090"></a><span id="l2.1090"> </span>
<a href="#l2.1091"></a><span id="l2.1091">   return true;</span>
<a href="#l2.1092"></a><span id="l2.1092"> }</span>
<a href="#l2.1093"></a><span id="l2.1093"> </span>
<a href="#l2.1094"></a><span id="l2.1094"> // returns output flags based on mimetype, wrapCol and prefs</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineminus">-function GetOutputFlags(aMimeType, aWrapColumn)</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineminus">-{</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineplus">+function GetOutputFlags(aMimeType, aWrapColumn) {</span>
<a href="#l2.1098"></a><span id="l2.1098">   var outputFlags = 0;</span>
<a href="#l2.1099"></a><span id="l2.1099">   var editor = GetCurrentEditor();</span>
<a href="#l2.1100"></a><span id="l2.1100">   var outputEntity = (editor &amp;&amp; editor.documentCharacterSet == &quot;ISO-8859-1&quot;)</span>
<a href="#l2.1101"></a><span id="l2.1101">     ? webPersist.ENCODE_FLAGS_ENCODE_LATIN1_ENTITIES</span>
<a href="#l2.1102"></a><span id="l2.1102">     : webPersist.ENCODE_FLAGS_ENCODE_BASIC_ENTITIES;</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineminus">-  if (aMimeType == &quot;text/plain&quot;)</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineminus">-  {</span>
<a href="#l2.1105"></a><span id="l2.1105" class="difflineplus">+  if (aMimeType == &quot;text/plain&quot;) {</span>
<a href="#l2.1106"></a><span id="l2.1106">     // When saving in &quot;text/plain&quot; format, always do formatting</span>
<a href="#l2.1107"></a><span id="l2.1107">     outputFlags |= webPersist.ENCODE_FLAGS_FORMATTED;</span>
<a href="#l2.1108"></a><span id="l2.1108" class="difflineminus">-  }</span>
<a href="#l2.1109"></a><span id="l2.1109" class="difflineminus">-  else</span>
<a href="#l2.1110"></a><span id="l2.1110" class="difflineminus">-  {</span>
<a href="#l2.1111"></a><span id="l2.1111" class="difflineplus">+  } else {</span>
<a href="#l2.1112"></a><span id="l2.1112">     // Should we prettyprint? Check the pref</span>
<a href="#l2.1113"></a><span id="l2.1113">     if (Services.prefs.getBoolPref(&quot;editor.prettyprint&quot;))</span>
<a href="#l2.1114"></a><span id="l2.1114">       outputFlags |= webPersist.ENCODE_FLAGS_FORMATTED;</span>
<a href="#l2.1115"></a><span id="l2.1115"> </span>
<a href="#l2.1116"></a><span id="l2.1116">     try {</span>
<a href="#l2.1117"></a><span id="l2.1117">       // How much entity names should we output? Check the pref</span>
<a href="#l2.1118"></a><span id="l2.1118">       switch (Services.prefs.getCharPref(&quot;editor.encode_entity&quot;)) {</span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineminus">-        case &quot;basic&quot;  : outputEntity = webPersist.ENCODE_FLAGS_ENCODE_BASIC_ENTITIES; break;</span>
<a href="#l2.1120"></a><span id="l2.1120" class="difflineplus">+        case &quot;basic&quot; : outputEntity = webPersist.ENCODE_FLAGS_ENCODE_BASIC_ENTITIES; break;</span>
<a href="#l2.1121"></a><span id="l2.1121">         case &quot;latin1&quot; : outputEntity = webPersist.ENCODE_FLAGS_ENCODE_LATIN1_ENTITIES; break;</span>
<a href="#l2.1122"></a><span id="l2.1122" class="difflineminus">-        case &quot;html&quot;   : outputEntity = webPersist.ENCODE_FLAGS_ENCODE_HTML_ENTITIES; break;</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineminus">-        case &quot;none&quot;   : outputEntity = 0; break;</span>
<a href="#l2.1124"></a><span id="l2.1124" class="difflineplus">+        case &quot;html&quot; : outputEntity = webPersist.ENCODE_FLAGS_ENCODE_HTML_ENTITIES; break;</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineplus">+        case &quot;none&quot; : outputEntity = 0; break;</span>
<a href="#l2.1126"></a><span id="l2.1126">       }</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineminus">-    }</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineminus">-    catch (e) {}</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.1130"></a><span id="l2.1130">   }</span>
<a href="#l2.1131"></a><span id="l2.1131">   outputFlags |= outputEntity;</span>
<a href="#l2.1132"></a><span id="l2.1132"> </span>
<a href="#l2.1133"></a><span id="l2.1133">   if (aWrapColumn &gt; 0)</span>
<a href="#l2.1134"></a><span id="l2.1134">     outputFlags |= webPersist.ENCODE_FLAGS_WRAP;</span>
<a href="#l2.1135"></a><span id="l2.1135"> </span>
<a href="#l2.1136"></a><span id="l2.1136">   return outputFlags;</span>
<a href="#l2.1137"></a><span id="l2.1137"> }</span>
<a href="#l2.1138"></a><span id="l2.1138"> </span>
<a href="#l2.1139"></a><span id="l2.1139"> // returns number of column where to wrap</span>
<a href="#l2.1140"></a><span id="l2.1140"> const nsIWebBrowserPersist = Ci.nsIWebBrowserPersist;</span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineminus">-function GetWrapColumn()</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineminus">-{</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineplus">+function GetWrapColumn() {</span>
<a href="#l2.1144"></a><span id="l2.1144">   try {</span>
<a href="#l2.1145"></a><span id="l2.1145">     return GetCurrentEditor().wrapWidth;</span>
<a href="#l2.1146"></a><span id="l2.1146">   } catch (e) {}</span>
<a href="#l2.1147"></a><span id="l2.1147">   return 0;</span>
<a href="#l2.1148"></a><span id="l2.1148"> }</span>
<a href="#l2.1149"></a><span id="l2.1149"> </span>
<a href="#l2.1150"></a><span id="l2.1150"> const gShowDebugOutputStateChange = false;</span>
<a href="#l2.1151"></a><span id="l2.1151"> const gShowDebugOutputProgress = false;</span>
<a href="#l2.1152"></a><span id="l2.1152" class="difflineat">@@ -1009,330 +917,291 @@ const nsIWebProgressListener = Ci.nsIWeb</span>
<a href="#l2.1153"></a><span id="l2.1153"> const nsIChannel = Ci.nsIChannel;</span>
<a href="#l2.1154"></a><span id="l2.1154"> </span>
<a href="#l2.1155"></a><span id="l2.1155"> const kErrorBindingAborted = 2152398850;</span>
<a href="#l2.1156"></a><span id="l2.1156"> const kErrorBindingRedirected = 2152398851;</span>
<a href="#l2.1157"></a><span id="l2.1157"> const kFileNotFound = 2152857618;</span>
<a href="#l2.1158"></a><span id="l2.1158"> </span>
<a href="#l2.1159"></a><span id="l2.1159"> var gEditorOutputProgressListener =</span>
<a href="#l2.1160"></a><span id="l2.1160"> {</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineminus">-  onStateChange : function(aWebProgress, aRequest, aStateFlags, aStatus)</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineminus">-  {</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineplus">+  onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l2.1164"></a><span id="l2.1164">     var editor = GetCurrentEditor();</span>
<a href="#l2.1165"></a><span id="l2.1165"> </span>
<a href="#l2.1166"></a><span id="l2.1166">     // Use this to access onStateChange flags</span>
<a href="#l2.1167"></a><span id="l2.1167">     var requestSpec;</span>
<a href="#l2.1168"></a><span id="l2.1168">     try {</span>
<a href="#l2.1169"></a><span id="l2.1169">       var channel = aRequest.QueryInterface(nsIChannel);</span>
<a href="#l2.1170"></a><span id="l2.1170">       requestSpec = StripUsernamePasswordFromURI(channel.URI);</span>
<a href="#l2.1171"></a><span id="l2.1171">     } catch (e) {</span>
<a href="#l2.1172"></a><span id="l2.1172">       if (gShowDebugOutputStateChange)</span>
<a href="#l2.1173"></a><span id="l2.1173">         dump(&quot;***** onStateChange; NO REQUEST CHANNEL\n&quot;);</span>
<a href="#l2.1174"></a><span id="l2.1174">     }</span>
<a href="#l2.1175"></a><span id="l2.1175"> </span>
<a href="#l2.1176"></a><span id="l2.1176">     var pubSpec;</span>
<a href="#l2.1177"></a><span id="l2.1177">     if (gPublishData)</span>
<a href="#l2.1178"></a><span id="l2.1178">       pubSpec = gPublishData.publishUrl + gPublishData.docDir + gPublishData.filename;</span>
<a href="#l2.1179"></a><span id="l2.1179"> </span>
<a href="#l2.1180"></a><span id="l2.1180" class="difflineminus">-    if (gShowDebugOutputStateChange)</span>
<a href="#l2.1181"></a><span id="l2.1181" class="difflineminus">-    {</span>
<a href="#l2.1182"></a><span id="l2.1182" class="difflineplus">+    if (gShowDebugOutputStateChange) {</span>
<a href="#l2.1183"></a><span id="l2.1183">       dump(&quot;\n***** onStateChange request: &quot; + requestSpec + &quot;\n&quot;);</span>
<a href="#l2.1184"></a><span id="l2.1184">       dump(&quot;      state flags: &quot;);</span>
<a href="#l2.1185"></a><span id="l2.1185"> </span>
<a href="#l2.1186"></a><span id="l2.1186">       if (aStateFlags &amp; nsIWebProgressListener.STATE_START)</span>
<a href="#l2.1187"></a><span id="l2.1187">         dump(&quot; STATE_START, &quot;);</span>
<a href="#l2.1188"></a><span id="l2.1188">       if (aStateFlags &amp; nsIWebProgressListener.STATE_STOP)</span>
<a href="#l2.1189"></a><span id="l2.1189">         dump(&quot; STATE_STOP, &quot;);</span>
<a href="#l2.1190"></a><span id="l2.1190">       if (aStateFlags &amp; nsIWebProgressListener.STATE_IS_NETWORK)</span>
<a href="#l2.1191"></a><span id="l2.1191">         dump(&quot; STATE_IS_NETWORK &quot;);</span>
<a href="#l2.1192"></a><span id="l2.1192"> </span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineminus">-      dump(&quot;\n * requestSpec=&quot;+requestSpec+&quot;, pubSpec=&quot;+pubSpec+&quot;, aStatus=&quot;+aStatus+&quot;\n&quot;);</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineplus">+      dump(&quot;\n * requestSpec=&quot; + requestSpec + &quot;, pubSpec=&quot; + pubSpec + &quot;, aStatus=&quot; + aStatus + &quot;\n&quot;);</span>
<a href="#l2.1195"></a><span id="l2.1195"> </span>
<a href="#l2.1196"></a><span id="l2.1196">       DumpDebugStatus(aStatus);</span>
<a href="#l2.1197"></a><span id="l2.1197">     }</span>
<a href="#l2.1198"></a><span id="l2.1198">     // The rest only concerns publishing, so bail out if no dialog</span>
<a href="#l2.1199"></a><span id="l2.1199">     if (!gProgressDialog)</span>
<a href="#l2.1200"></a><span id="l2.1200">       return;</span>
<a href="#l2.1201"></a><span id="l2.1201"> </span>
<a href="#l2.1202"></a><span id="l2.1202">     // Detect start of file upload of any file:</span>
<a href="#l2.1203"></a><span id="l2.1203">     // (We ignore any START messages after gPersistObj says publishing is finished</span>
<a href="#l2.1204"></a><span id="l2.1204">     if ((aStateFlags &amp; nsIWebProgressListener.STATE_START)</span>
<a href="#l2.1205"></a><span id="l2.1205">          &amp;&amp; gPersistObj &amp;&amp; requestSpec</span>
<a href="#l2.1206"></a><span id="l2.1206" class="difflineminus">-         &amp;&amp; (gPersistObj.currentState != gPersistObj.PERSIST_STATE_FINISHED))</span>
<a href="#l2.1207"></a><span id="l2.1207" class="difflineminus">-    {</span>
<a href="#l2.1208"></a><span id="l2.1208" class="difflineplus">+         &amp;&amp; (gPersistObj.currentState != gPersistObj.PERSIST_STATE_FINISHED)) {</span>
<a href="#l2.1209"></a><span id="l2.1209">       try {</span>
<a href="#l2.1210"></a><span id="l2.1210">         // Add url to progress dialog's list showing each file uploading</span>
<a href="#l2.1211"></a><span id="l2.1211">         gProgressDialog.SetProgressStatus(GetFilename(requestSpec), &quot;busy&quot;);</span>
<a href="#l2.1212"></a><span id="l2.1212" class="difflineminus">-      } catch(e) {}</span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineplus">+      } catch (e) {}</span>
<a href="#l2.1214"></a><span id="l2.1214">     }</span>
<a href="#l2.1215"></a><span id="l2.1215"> </span>
<a href="#l2.1216"></a><span id="l2.1216">     // Detect end of file upload of any file:</span>
<a href="#l2.1217"></a><span id="l2.1217" class="difflineminus">-    if (aStateFlags &amp; nsIWebProgressListener.STATE_STOP)</span>
<a href="#l2.1218"></a><span id="l2.1218" class="difflineminus">-    {</span>
<a href="#l2.1219"></a><span id="l2.1219" class="difflineplus">+    if (aStateFlags &amp; nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l2.1220"></a><span id="l2.1220">       // ignore aStatus == kErrorBindingAborted; check http response for possible errors</span>
<a href="#l2.1221"></a><span id="l2.1221">       try {</span>
<a href="#l2.1222"></a><span id="l2.1222">         // check http channel for response: 200 range is ok; other ranges are not</span>
<a href="#l2.1223"></a><span id="l2.1223">         var httpChannel = aRequest.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l2.1224"></a><span id="l2.1224">         var httpResponse = httpChannel.responseStatus;</span>
<a href="#l2.1225"></a><span id="l2.1225">         if (httpResponse &lt; 200 || httpResponse &gt;= 300)</span>
<a href="#l2.1226"></a><span id="l2.1226">           aStatus = httpResponse;   // not a real error but enough to pass check below</span>
<a href="#l2.1227"></a><span id="l2.1227">         else if (aStatus == kErrorBindingAborted)</span>
<a href="#l2.1228"></a><span id="l2.1228">           aStatus = 0;</span>
<a href="#l2.1229"></a><span id="l2.1229"> </span>
<a href="#l2.1230"></a><span id="l2.1230">         if (gShowDebugOutputStateChange)</span>
<a href="#l2.1231"></a><span id="l2.1231" class="difflineminus">-          dump(&quot;http response is: &quot;+httpResponse+&quot;\n&quot;);</span>
<a href="#l2.1232"></a><span id="l2.1232" class="difflineminus">-      }</span>
<a href="#l2.1233"></a><span id="l2.1233" class="difflineminus">-      catch(e)</span>
<a href="#l2.1234"></a><span id="l2.1234" class="difflineminus">-      {</span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineplus">+          dump(&quot;http response is: &quot; + httpResponse + &quot;\n&quot;);</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineplus">+      } catch (e) {</span>
<a href="#l2.1237"></a><span id="l2.1237">         if (aStatus == kErrorBindingAborted)</span>
<a href="#l2.1238"></a><span id="l2.1238">           aStatus = 0;</span>
<a href="#l2.1239"></a><span id="l2.1239">       }</span>
<a href="#l2.1240"></a><span id="l2.1240"> </span>
<a href="#l2.1241"></a><span id="l2.1241">       // We abort publishing for all errors except if image src file is not found</span>
<a href="#l2.1242"></a><span id="l2.1242">       var abortPublishing = (aStatus != 0 &amp;&amp; aStatus != kFileNotFound);</span>
<a href="#l2.1243"></a><span id="l2.1243"> </span>
<a href="#l2.1244"></a><span id="l2.1244">       // Notify progress dialog when we receive the STOP</span>
<a href="#l2.1245"></a><span id="l2.1245">       //  notification for a file if there was an error</span>
<a href="#l2.1246"></a><span id="l2.1246">       //  or a successful finish</span>
<a href="#l2.1247"></a><span id="l2.1247">       //  (Check requestSpec to be sure message is for destination url)</span>
<a href="#l2.1248"></a><span id="l2.1248">       if (aStatus != 0</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineminus">-           || (requestSpec &amp;&amp; requestSpec.startsWith(GetScheme(gPublishData.publishUrl))))</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineminus">-      {</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineplus">+           || (requestSpec &amp;&amp; requestSpec.startsWith(GetScheme(gPublishData.publishUrl)))) {</span>
<a href="#l2.1252"></a><span id="l2.1252">         try {</span>
<a href="#l2.1253"></a><span id="l2.1253">           gProgressDialog.SetProgressFinished(GetFilename(requestSpec), aStatus);</span>
<a href="#l2.1254"></a><span id="l2.1254" class="difflineminus">-        } catch(e) {}</span>
<a href="#l2.1255"></a><span id="l2.1255" class="difflineplus">+        } catch (e) {}</span>
<a href="#l2.1256"></a><span id="l2.1256">       }</span>
<a href="#l2.1257"></a><span id="l2.1257"> </span>
<a href="#l2.1258"></a><span id="l2.1258"> </span>
<a href="#l2.1259"></a><span id="l2.1259" class="difflineminus">-      if (abortPublishing)</span>
<a href="#l2.1260"></a><span id="l2.1260" class="difflineminus">-      {</span>
<a href="#l2.1261"></a><span id="l2.1261" class="difflineplus">+      if (abortPublishing) {</span>
<a href="#l2.1262"></a><span id="l2.1262">         // Cancel publishing</span>
<a href="#l2.1263"></a><span id="l2.1263">         gPersistObj.cancelSave();</span>
<a href="#l2.1264"></a><span id="l2.1264"> </span>
<a href="#l2.1265"></a><span id="l2.1265">         // Don't do any commands after failure</span>
<a href="#l2.1266"></a><span id="l2.1266">         gCommandAfterPublishing = null;</span>
<a href="#l2.1267"></a><span id="l2.1267"> </span>
<a href="#l2.1268"></a><span id="l2.1268">         // Restore original document to undo image src url adjustments</span>
<a href="#l2.1269"></a><span id="l2.1269" class="difflineminus">-        if (gRestoreDocumentSource)</span>
<a href="#l2.1270"></a><span id="l2.1270" class="difflineminus">-        {</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineplus">+        if (gRestoreDocumentSource) {</span>
<a href="#l2.1272"></a><span id="l2.1272">           try {</span>
<a href="#l2.1273"></a><span id="l2.1273">             editor.rebuildDocumentFromSource(gRestoreDocumentSource);</span>
<a href="#l2.1274"></a><span id="l2.1274"> </span>
<a href="#l2.1275"></a><span id="l2.1275">             // Clear transaction cache since we just did a potentially</span>
<a href="#l2.1276"></a><span id="l2.1276">             //  very large insert and this will eat up memory</span>
<a href="#l2.1277"></a><span id="l2.1277">             editor.transactionManager.clear();</span>
<a href="#l2.1278"></a><span id="l2.1278" class="difflineminus">-          }</span>
<a href="#l2.1279"></a><span id="l2.1279" class="difflineminus">-          catch (e) {}</span>
<a href="#l2.1280"></a><span id="l2.1280" class="difflineplus">+          } catch (e) {}</span>
<a href="#l2.1281"></a><span id="l2.1281">         }</span>
<a href="#l2.1282"></a><span id="l2.1282"> </span>
<a href="#l2.1283"></a><span id="l2.1283">         // Notify progress dialog that we're finished</span>
<a href="#l2.1284"></a><span id="l2.1284">         //  and keep open to show error</span>
<a href="#l2.1285"></a><span id="l2.1285">         gProgressDialog.SetProgressFinished(null, 0);</span>
<a href="#l2.1286"></a><span id="l2.1286"> </span>
<a href="#l2.1287"></a><span id="l2.1287">         // We don't want to change location or reset mod count, etc.</span>
<a href="#l2.1288"></a><span id="l2.1288">         return;</span>
<a href="#l2.1289"></a><span id="l2.1289">       }</span>
<a href="#l2.1290"></a><span id="l2.1290"> </span>
<a href="#l2.1291"></a><span id="l2.1291" class="difflineminus">-      //XXX HACK: &quot;file://&quot; protocol is not supported in network code</span>
<a href="#l2.1292"></a><span id="l2.1292" class="difflineplus">+      // XXX HACK: &quot;file://&quot; protocol is not supported in network code</span>
<a href="#l2.1293"></a><span id="l2.1293">       //    (bug 151867 filed to add this support, bug 151869 filed</span>
<a href="#l2.1294"></a><span id="l2.1294">       //     to remove this and other code in nsIWebBrowserPersist)</span>
<a href="#l2.1295"></a><span id="l2.1295">       //    nsIWebBrowserPersist *does* copy the file(s), but we don't</span>
<a href="#l2.1296"></a><span id="l2.1296">       //    get normal onStateChange messages.</span>
<a href="#l2.1297"></a><span id="l2.1297"> </span>
<a href="#l2.1298"></a><span id="l2.1298">       // Case 1: If images are included, we get fairly normal</span>
<a href="#l2.1299"></a><span id="l2.1299">       //    STATE_START/STATE_STOP &amp; STATE_IS_NETWORK messages associated with the image files,</span>
<a href="#l2.1300"></a><span id="l2.1300">       //    thus we must finish HTML file progress below</span>
<a href="#l2.1301"></a><span id="l2.1301"> </span>
<a href="#l2.1302"></a><span id="l2.1302">       // Case 2: If just HTML file is uploaded, we get STATE_START and STATE_STOP</span>
<a href="#l2.1303"></a><span id="l2.1303">       //    notification with a null &quot;requestSpec&quot;, and</span>
<a href="#l2.1304"></a><span id="l2.1304">       //    the gPersistObj is destroyed before we get here!</span>
<a href="#l2.1305"></a><span id="l2.1305">       //    So create an new object so we can flow through normal processing below</span>
<a href="#l2.1306"></a><span id="l2.1306">       if (!requestSpec &amp;&amp; GetScheme(gPublishData.publishUrl) == &quot;file&quot;</span>
<a href="#l2.1307"></a><span id="l2.1307" class="difflineminus">-          &amp;&amp; (!gPersistObj || gPersistObj.currentState == nsIWebBrowserPersist.PERSIST_STATE_FINISHED))</span>
<a href="#l2.1308"></a><span id="l2.1308" class="difflineminus">-      {</span>
<a href="#l2.1309"></a><span id="l2.1309" class="difflineplus">+          &amp;&amp; (!gPersistObj || gPersistObj.currentState == nsIWebBrowserPersist.PERSIST_STATE_FINISHED)) {</span>
<a href="#l2.1310"></a><span id="l2.1310">         aStateFlags |= nsIWebProgressListener.STATE_IS_NETWORK;</span>
<a href="#l2.1311"></a><span id="l2.1311" class="difflineminus">-        if (!gPersistObj)</span>
<a href="#l2.1312"></a><span id="l2.1312" class="difflineminus">-        {</span>
<a href="#l2.1313"></a><span id="l2.1313" class="difflineplus">+        if (!gPersistObj) {</span>
<a href="#l2.1314"></a><span id="l2.1314">           gPersistObj =</span>
<a href="#l2.1315"></a><span id="l2.1315">           {</span>
<a href="#l2.1316"></a><span id="l2.1316" class="difflineminus">-            result : aStatus,</span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineminus">-            currentState : nsIWebBrowserPersist.PERSIST_STATE_FINISHED</span>
<a href="#l2.1318"></a><span id="l2.1318" class="difflineminus">-          }</span>
<a href="#l2.1319"></a><span id="l2.1319" class="difflineplus">+            result: aStatus,</span>
<a href="#l2.1320"></a><span id="l2.1320" class="difflineplus">+            currentState: nsIWebBrowserPersist.PERSIST_STATE_FINISHED,</span>
<a href="#l2.1321"></a><span id="l2.1321" class="difflineplus">+          };</span>
<a href="#l2.1322"></a><span id="l2.1322">         }</span>
<a href="#l2.1323"></a><span id="l2.1323">       }</span>
<a href="#l2.1324"></a><span id="l2.1324"> </span>
<a href="#l2.1325"></a><span id="l2.1325">       // STATE_IS_NETWORK signals end of publishing, as does the gPersistObj.currentState</span>
<a href="#l2.1326"></a><span id="l2.1326">       if (aStateFlags &amp; nsIWebProgressListener.STATE_IS_NETWORK</span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineminus">-          &amp;&amp; gPersistObj.currentState == nsIWebBrowserPersist.PERSIST_STATE_FINISHED)</span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineminus">-      {</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineminus">-        if (GetScheme(gPublishData.publishUrl) == &quot;file&quot;)</span>
<a href="#l2.1330"></a><span id="l2.1330" class="difflineminus">-        {</span>
<a href="#l2.1331"></a><span id="l2.1331" class="difflineminus">-          //XXX &quot;file://&quot; hack: We don't get notified about the HTML file, so end progress for it</span>
<a href="#l2.1332"></a><span id="l2.1332" class="difflineplus">+          &amp;&amp; gPersistObj.currentState == nsIWebBrowserPersist.PERSIST_STATE_FINISHED) {</span>
<a href="#l2.1333"></a><span id="l2.1333" class="difflineplus">+        if (GetScheme(gPublishData.publishUrl) == &quot;file&quot;) {</span>
<a href="#l2.1334"></a><span id="l2.1334" class="difflineplus">+          // XXX &quot;file://&quot; hack: We don't get notified about the HTML file, so end progress for it</span>
<a href="#l2.1335"></a><span id="l2.1335">           // (This covers both &quot;Case 1 and 2&quot; described above)</span>
<a href="#l2.1336"></a><span id="l2.1336">           gProgressDialog.SetProgressFinished(gPublishData.filename, gPersistObj.result);</span>
<a href="#l2.1337"></a><span id="l2.1337">         }</span>
<a href="#l2.1338"></a><span id="l2.1338"> </span>
<a href="#l2.1339"></a><span id="l2.1339" class="difflineminus">-        if (gPersistObj.result == 0)</span>
<a href="#l2.1340"></a><span id="l2.1340" class="difflineminus">-        {</span>
<a href="#l2.1341"></a><span id="l2.1341" class="difflineplus">+        if (gPersistObj.result == 0) {</span>
<a href="#l2.1342"></a><span id="l2.1342">           // All files are finished and publishing succeeded (some images may have failed)</span>
<a href="#l2.1343"></a><span id="l2.1343">           try {</span>
<a href="#l2.1344"></a><span id="l2.1344">             // Make a new docURI from the &quot;browse location&quot; in case &quot;publish location&quot; was FTP</span>
<a href="#l2.1345"></a><span id="l2.1345">             // We need to set document uri before notifying listeners</span>
<a href="#l2.1346"></a><span id="l2.1346">             var docUrl = GetDocUrlFromPublishData(gPublishData);</span>
<a href="#l2.1347"></a><span id="l2.1347">             SetDocumentURI(Services.io.newURI(docUrl, editor.documentCharacterSet));</span>
<a href="#l2.1348"></a><span id="l2.1348"> </span>
<a href="#l2.1349"></a><span id="l2.1349">             UpdateWindowTitle();</span>
<a href="#l2.1350"></a><span id="l2.1350"> </span>
<a href="#l2.1351"></a><span id="l2.1351">             // this should cause notification to listeners that doc has changed</span>
<a href="#l2.1352"></a><span id="l2.1352">             editor.resetModificationCount();</span>
<a href="#l2.1353"></a><span id="l2.1353"> </span>
<a href="#l2.1354"></a><span id="l2.1354">             // Set UI based on whether we're editing a remote or local url</span>
<a href="#l2.1355"></a><span id="l2.1355">             SetSaveAndPublishUI(urlstring);</span>
<a href="#l2.1356"></a><span id="l2.1356" class="difflineminus">-</span>
<a href="#l2.1357"></a><span id="l2.1357">           } catch (e) {}</span>
<a href="#l2.1358"></a><span id="l2.1358"> </span>
<a href="#l2.1359"></a><span id="l2.1359">           // Save publishData to prefs</span>
<a href="#l2.1360"></a><span id="l2.1360" class="difflineminus">-          if (gPublishData)</span>
<a href="#l2.1361"></a><span id="l2.1361" class="difflineminus">-          {</span>
<a href="#l2.1362"></a><span id="l2.1362" class="difflineminus">-            if (gPublishData.savePublishData)</span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineminus">-            {</span>
<a href="#l2.1364"></a><span id="l2.1364" class="difflineplus">+          if (gPublishData) {</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineplus">+            if (gPublishData.savePublishData) {</span>
<a href="#l2.1366"></a><span id="l2.1366">               // We published successfully, so we can safely</span>
<a href="#l2.1367"></a><span id="l2.1367">               //  save docDir and otherDir to prefs</span>
<a href="#l2.1368"></a><span id="l2.1368">               gPublishData.saveDirs = true;</span>
<a href="#l2.1369"></a><span id="l2.1369">               SavePublishDataToPrefs(gPublishData);</span>
<a href="#l2.1370"></a><span id="l2.1370" class="difflineminus">-            }</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineminus">-            else</span>
<a href="#l2.1372"></a><span id="l2.1372" class="difflineplus">+            } else</span>
<a href="#l2.1373"></a><span id="l2.1373">               SavePassword(gPublishData);</span>
<a href="#l2.1374"></a><span id="l2.1374">           }</span>
<a href="#l2.1375"></a><span id="l2.1375"> </span>
<a href="#l2.1376"></a><span id="l2.1376">           // Ask progress dialog to close, but it may not</span>
<a href="#l2.1377"></a><span id="l2.1377">           // if user checked checkbox to keep it open</span>
<a href="#l2.1378"></a><span id="l2.1378">           gProgressDialog.RequestCloseDialog();</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineminus">-        }</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineminus">-        else</span>
<a href="#l2.1381"></a><span id="l2.1381" class="difflineminus">-        {</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineplus">+        } else {</span>
<a href="#l2.1383"></a><span id="l2.1383">           // We previously aborted publishing because of error:</span>
<a href="#l2.1384"></a><span id="l2.1384">           //   Calling gPersistObj.cancelSave() resulted in a non-zero gPersistObj.result,</span>
<a href="#l2.1385"></a><span id="l2.1385">           //   so notify progress dialog we're finished</span>
<a href="#l2.1386"></a><span id="l2.1386">           gProgressDialog.SetProgressFinished(null, 0);</span>
<a href="#l2.1387"></a><span id="l2.1387">         }</span>
<a href="#l2.1388"></a><span id="l2.1388">       }</span>
<a href="#l2.1389"></a><span id="l2.1389">     }</span>
<a href="#l2.1390"></a><span id="l2.1390">   },</span>
<a href="#l2.1391"></a><span id="l2.1391"> </span>
<a href="#l2.1392"></a><span id="l2.1392" class="difflineminus">-  onProgressChange : function(aWebProgress, aRequest, aCurSelfProgress,</span>
<a href="#l2.1393"></a><span id="l2.1393" class="difflineminus">-                              aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress)</span>
<a href="#l2.1394"></a><span id="l2.1394" class="difflineminus">-  {</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineplus">+  onProgressChange(aWebProgress, aRequest, aCurSelfProgress,</span>
<a href="#l2.1396"></a><span id="l2.1396" class="difflineplus">+                              aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l2.1397"></a><span id="l2.1397">     if (!gPersistObj)</span>
<a href="#l2.1398"></a><span id="l2.1398">       return;</span>
<a href="#l2.1399"></a><span id="l2.1399"> </span>
<a href="#l2.1400"></a><span id="l2.1400" class="difflineminus">-    if (gShowDebugOutputProgress)</span>
<a href="#l2.1401"></a><span id="l2.1401" class="difflineminus">-    {</span>
<a href="#l2.1402"></a><span id="l2.1402" class="difflineminus">-      dump(&quot;\n onProgressChange: gPersistObj.result=&quot;+gPersistObj.result+&quot;\n&quot;);</span>
<a href="#l2.1403"></a><span id="l2.1403" class="difflineplus">+    if (gShowDebugOutputProgress) {</span>
<a href="#l2.1404"></a><span id="l2.1404" class="difflineplus">+      dump(&quot;\n onProgressChange: gPersistObj.result=&quot; + gPersistObj.result + &quot;\n&quot;);</span>
<a href="#l2.1405"></a><span id="l2.1405">       try {</span>
<a href="#l2.1406"></a><span id="l2.1406">       var channel = aRequest.QueryInterface(nsIChannel);</span>
<a href="#l2.1407"></a><span id="l2.1407">       dump(&quot;***** onProgressChange request: &quot; + channel.URI.spec + &quot;\n&quot;);</span>
<a href="#l2.1408"></a><span id="l2.1408" class="difflineminus">-      }</span>
<a href="#l2.1409"></a><span id="l2.1409" class="difflineminus">-      catch (e) {}</span>
<a href="#l2.1410"></a><span id="l2.1410" class="difflineminus">-      dump(&quot;*****       self:  &quot;+aCurSelfProgress+&quot; / &quot;+aMaxSelfProgress+&quot;\n&quot;);</span>
<a href="#l2.1411"></a><span id="l2.1411" class="difflineminus">-      dump(&quot;*****       total: &quot;+aCurTotalProgress+&quot; / &quot;+aMaxTotalProgress+&quot;\n\n&quot;);</span>
<a href="#l2.1412"></a><span id="l2.1412" class="difflineplus">+      } catch (e) {}</span>
<a href="#l2.1413"></a><span id="l2.1413" class="difflineplus">+      dump(&quot;*****       self:  &quot; + aCurSelfProgress + &quot; / &quot; + aMaxSelfProgress + &quot;\n&quot;);</span>
<a href="#l2.1414"></a><span id="l2.1414" class="difflineplus">+      dump(&quot;*****       total: &quot; + aCurTotalProgress + &quot; / &quot; + aMaxTotalProgress + &quot;\n\n&quot;);</span>
<a href="#l2.1415"></a><span id="l2.1415"> </span>
<a href="#l2.1416"></a><span id="l2.1416">       if (gPersistObj.currentState == gPersistObj.PERSIST_STATE_READY)</span>
<a href="#l2.1417"></a><span id="l2.1417">         dump(&quot; Persister is ready to save data\n\n&quot;);</span>
<a href="#l2.1418"></a><span id="l2.1418">       else if (gPersistObj.currentState == gPersistObj.PERSIST_STATE_SAVING)</span>
<a href="#l2.1419"></a><span id="l2.1419">         dump(&quot; Persister is saving data.\n\n&quot;);</span>
<a href="#l2.1420"></a><span id="l2.1420">       else if (gPersistObj.currentState == gPersistObj.PERSIST_STATE_FINISHED)</span>
<a href="#l2.1421"></a><span id="l2.1421">         dump(&quot; PERSISTER HAS FINISHED SAVING DATA\n\n\n&quot;);</span>
<a href="#l2.1422"></a><span id="l2.1422">     }</span>
<a href="#l2.1423"></a><span id="l2.1423">   },</span>
<a href="#l2.1424"></a><span id="l2.1424"> </span>
<a href="#l2.1425"></a><span id="l2.1425" class="difflineminus">-  onLocationChange : function(aWebProgress, aRequest, aLocation, aFlags)</span>
<a href="#l2.1426"></a><span id="l2.1426" class="difflineminus">-  {</span>
<a href="#l2.1427"></a><span id="l2.1427" class="difflineminus">-    if (gShowDebugOutputLocationChange)</span>
<a href="#l2.1428"></a><span id="l2.1428" class="difflineminus">-    {</span>
<a href="#l2.1429"></a><span id="l2.1429" class="difflineminus">-      dump(&quot;***** onLocationChange: &quot;+aLocation.spec+&quot;\n&quot;);</span>
<a href="#l2.1430"></a><span id="l2.1430" class="difflineplus">+  onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {</span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineplus">+    if (gShowDebugOutputLocationChange) {</span>
<a href="#l2.1432"></a><span id="l2.1432" class="difflineplus">+      dump(&quot;***** onLocationChange: &quot; + aLocation.spec + &quot;\n&quot;);</span>
<a href="#l2.1433"></a><span id="l2.1433">       try {</span>
<a href="#l2.1434"></a><span id="l2.1434">         var channel = aRequest.QueryInterface(nsIChannel);</span>
<a href="#l2.1435"></a><span id="l2.1435">         dump(&quot;*****          request: &quot; + channel.URI.spec + &quot;\n&quot;);</span>
<a href="#l2.1436"></a><span id="l2.1436" class="difflineminus">-      }</span>
<a href="#l2.1437"></a><span id="l2.1437" class="difflineminus">-      catch(e) {}</span>
<a href="#l2.1438"></a><span id="l2.1438" class="difflineplus">+      } catch (e) {}</span>
<a href="#l2.1439"></a><span id="l2.1439">     }</span>
<a href="#l2.1440"></a><span id="l2.1440">   },</span>
<a href="#l2.1441"></a><span id="l2.1441"> </span>
<a href="#l2.1442"></a><span id="l2.1442" class="difflineminus">-  onStatusChange : function(aWebProgress, aRequest, aStatus, aMessage)</span>
<a href="#l2.1443"></a><span id="l2.1443" class="difflineminus">-  {</span>
<a href="#l2.1444"></a><span id="l2.1444" class="difflineminus">-    if (gShowDebugOutputStatusChange)</span>
<a href="#l2.1445"></a><span id="l2.1445" class="difflineminus">-    {</span>
<a href="#l2.1446"></a><span id="l2.1446" class="difflineminus">-      dump(&quot;***** onStatusChange: &quot;+aMessage+&quot;\n&quot;);</span>
<a href="#l2.1447"></a><span id="l2.1447" class="difflineplus">+  onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {</span>
<a href="#l2.1448"></a><span id="l2.1448" class="difflineplus">+    if (gShowDebugOutputStatusChange) {</span>
<a href="#l2.1449"></a><span id="l2.1449" class="difflineplus">+      dump(&quot;***** onStatusChange: &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l2.1450"></a><span id="l2.1450">       try {</span>
<a href="#l2.1451"></a><span id="l2.1451">         var channel = aRequest.QueryInterface(nsIChannel);</span>
<a href="#l2.1452"></a><span id="l2.1452">         dump(&quot;*****        request: &quot; + channel.URI.spec + &quot;\n&quot;);</span>
<a href="#l2.1453"></a><span id="l2.1453" class="difflineminus">-      }</span>
<a href="#l2.1454"></a><span id="l2.1454" class="difflineminus">-      catch (e) { dump(&quot;          couldn't get request\n&quot;); }</span>
<a href="#l2.1455"></a><span id="l2.1455" class="difflineplus">+      } catch (e) { dump(&quot;          couldn't get request\n&quot;); }</span>
<a href="#l2.1456"></a><span id="l2.1456"> </span>
<a href="#l2.1457"></a><span id="l2.1457">       DumpDebugStatus(aStatus);</span>
<a href="#l2.1458"></a><span id="l2.1458"> </span>
<a href="#l2.1459"></a><span id="l2.1459" class="difflineminus">-      if (gPersistObj)</span>
<a href="#l2.1460"></a><span id="l2.1460" class="difflineminus">-      {</span>
<a href="#l2.1461"></a><span id="l2.1461" class="difflineplus">+      if (gPersistObj) {</span>
<a href="#l2.1462"></a><span id="l2.1462">         if (gPersistObj.currentState == gPersistObj.PERSIST_STATE_READY)</span>
<a href="#l2.1463"></a><span id="l2.1463">           dump(&quot; Persister is ready to save data\n\n&quot;);</span>
<a href="#l2.1464"></a><span id="l2.1464">         else if (gPersistObj.currentState == gPersistObj.PERSIST_STATE_SAVING)</span>
<a href="#l2.1465"></a><span id="l2.1465">           dump(&quot; Persister is saving data.\n\n&quot;);</span>
<a href="#l2.1466"></a><span id="l2.1466">         else if (gPersistObj.currentState == gPersistObj.PERSIST_STATE_FINISHED)</span>
<a href="#l2.1467"></a><span id="l2.1467">           dump(&quot; PERSISTER HAS FINISHED SAVING DATA\n\n\n&quot;);</span>
<a href="#l2.1468"></a><span id="l2.1468">       }</span>
<a href="#l2.1469"></a><span id="l2.1469">     }</span>
<a href="#l2.1470"></a><span id="l2.1470">   },</span>
<a href="#l2.1471"></a><span id="l2.1471"> </span>
<a href="#l2.1472"></a><span id="l2.1472" class="difflineminus">-  onSecurityChange : function(aWebProgress, aRequest, state)</span>
<a href="#l2.1473"></a><span id="l2.1473" class="difflineminus">-  {</span>
<a href="#l2.1474"></a><span id="l2.1474" class="difflineminus">-    if (gShowDebugOutputSecurityChange)</span>
<a href="#l2.1475"></a><span id="l2.1475" class="difflineminus">-    {</span>
<a href="#l2.1476"></a><span id="l2.1476" class="difflineplus">+  onSecurityChange(aWebProgress, aRequest, state) {</span>
<a href="#l2.1477"></a><span id="l2.1477" class="difflineplus">+    if (gShowDebugOutputSecurityChange) {</span>
<a href="#l2.1478"></a><span id="l2.1478">       try {</span>
<a href="#l2.1479"></a><span id="l2.1479">         var channel = aRequest.QueryInterface(nsIChannel);</span>
<a href="#l2.1480"></a><span id="l2.1480">         dump(&quot;***** onSecurityChange request: &quot; + channel.URI.spec + &quot;\n&quot;);</span>
<a href="#l2.1481"></a><span id="l2.1481">       } catch (e) {}</span>
<a href="#l2.1482"></a><span id="l2.1482">     }</span>
<a href="#l2.1483"></a><span id="l2.1483">   },</span>
<a href="#l2.1484"></a><span id="l2.1484"> </span>
<a href="#l2.1485"></a><span id="l2.1485" class="difflineminus">-  onContentBlockingEvent: function(aWebProgress, aRequest, aEvent)</span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineminus">-  {</span>
<a href="#l2.1487"></a><span id="l2.1487" class="difflineplus">+  onContentBlockingEvent(aWebProgress, aRequest, aEvent) {</span>
<a href="#l2.1488"></a><span id="l2.1488">   },</span>
<a href="#l2.1489"></a><span id="l2.1489"> </span>
<a href="#l2.1490"></a><span id="l2.1490">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l2.1491"></a><span id="l2.1491">                                           &quot;nsISupportsWeakReference&quot;,</span>
<a href="#l2.1492"></a><span id="l2.1492">                                           &quot;nsIPrompt&quot;,</span>
<a href="#l2.1493"></a><span id="l2.1493">                                           &quot;nsIAuthPrompt&quot;]),</span>
<a href="#l2.1494"></a><span id="l2.1494"> </span>
<a href="#l2.1495"></a><span id="l2.1495"> // nsIPrompt</span>
<a href="#l2.1496"></a><span id="l2.1496" class="difflineminus">-  alert : function(dlgTitle, text)</span>
<a href="#l2.1497"></a><span id="l2.1497" class="difflineminus">-  {</span>
<a href="#l2.1498"></a><span id="l2.1498" class="difflineplus">+  alert(dlgTitle, text) {</span>
<a href="#l2.1499"></a><span id="l2.1499">     Services.prompt.alert(gProgressDialog ? gProgressDialog : window, dlgTitle, text);</span>
<a href="#l2.1500"></a><span id="l2.1500">   },</span>
<a href="#l2.1501"></a><span id="l2.1501" class="difflineminus">-  alertCheck : function(dialogTitle, text, checkBoxLabel, checkObj)</span>
<a href="#l2.1502"></a><span id="l2.1502" class="difflineminus">-  {</span>
<a href="#l2.1503"></a><span id="l2.1503" class="difflineplus">+  alertCheck(dialogTitle, text, checkBoxLabel, checkObj) {</span>
<a href="#l2.1504"></a><span id="l2.1504">     Services.prompt.alert(window, dialogTitle, text);</span>
<a href="#l2.1505"></a><span id="l2.1505">   },</span>
<a href="#l2.1506"></a><span id="l2.1506" class="difflineminus">-  confirm : function(dlgTitle, text)</span>
<a href="#l2.1507"></a><span id="l2.1507" class="difflineminus">-  {</span>
<a href="#l2.1508"></a><span id="l2.1508" class="difflineplus">+  confirm(dlgTitle, text) {</span>
<a href="#l2.1509"></a><span id="l2.1509">     return ConfirmWithTitle(dlgTitle, text, null, null);</span>
<a href="#l2.1510"></a><span id="l2.1510">   },</span>
<a href="#l2.1511"></a><span id="l2.1511" class="difflineminus">-  confirmCheck : function(dlgTitle, text, checkBoxLabel, checkObj)</span>
<a href="#l2.1512"></a><span id="l2.1512" class="difflineminus">-  {</span>
<a href="#l2.1513"></a><span id="l2.1513" class="difflineplus">+  confirmCheck(dlgTitle, text, checkBoxLabel, checkObj) {</span>
<a href="#l2.1514"></a><span id="l2.1514">     Services.prompt.confirmEx(window, dlgTitle, text, nsIPromptService.STD_OK_CANCEL_BUTTONS,</span>
<a href="#l2.1515"></a><span id="l2.1515">                               &quot;&quot;, &quot;&quot;, &quot;&quot;, checkBoxLabel, checkObj);</span>
<a href="#l2.1516"></a><span id="l2.1516">   },</span>
<a href="#l2.1517"></a><span id="l2.1517" class="difflineminus">-  confirmEx : function(dlgTitle, text, btnFlags, btn0Title, btn1Title, btn2Title, checkBoxLabel, checkVal)</span>
<a href="#l2.1518"></a><span id="l2.1518" class="difflineminus">-  {</span>
<a href="#l2.1519"></a><span id="l2.1519" class="difflineplus">+  confirmEx(dlgTitle, text, btnFlags, btn0Title, btn1Title, btn2Title, checkBoxLabel, checkVal) {</span>
<a href="#l2.1520"></a><span id="l2.1520">     return Services.prompt.confirmEx(window, dlgTitle, text, btnFlags,</span>
<a href="#l2.1521"></a><span id="l2.1521">                                      btn0Title, btn1Title, btn2Title,</span>
<a href="#l2.1522"></a><span id="l2.1522">                                      checkBoxLabel, checkVal);</span>
<a href="#l2.1523"></a><span id="l2.1523">   },</span>
<a href="#l2.1524"></a><span id="l2.1524"> </span>
<a href="#l2.1525"></a><span id="l2.1525" class="difflineminus">-  /*************************************************************************</span>
<a href="#l2.1526"></a><span id="l2.1526" class="difflineplus">+  /** ***********************************************************************</span>
<a href="#l2.1527"></a><span id="l2.1527">    * gEditorOutputProgressListener needs to implement both nsIPrompt       *</span>
<a href="#l2.1528"></a><span id="l2.1528">    * (providing alert) and nsIAuthPrompt (providing password saving).      *</span>
<a href="#l2.1529"></a><span id="l2.1529">    * Unfortunately, both interfaces specify prompt/promptPassword/         *</span>
<a href="#l2.1530"></a><span id="l2.1530">    * promptUsernameAndPassword, albeit with conflicting method signatures. *</span>
<a href="#l2.1531"></a><span id="l2.1531">    * Luckily, though, we only make use of their nsIAuthPrompt variants,    *</span>
<a href="#l2.1532"></a><span id="l2.1532">    * hence we can comment out the nsIPrompt ones here to avoid JavaScript  *</span>
<a href="#l2.1533"></a><span id="l2.1533">    * strict mode clutter. See bug 371174 for more information.             *</span>
<a href="#l2.1534"></a><span id="l2.1534">    *************************************************************************</span>
<a href="#l2.1535"></a><span id="l2.1535" class="difflineat">@@ -1367,101 +1236,92 @@ var gEditorOutputProgressListener =</span>
<a href="#l2.1536"></a><span id="l2.1536">     var ret = PromptUsernameAndPassword(dlgTitle, text, savePWObj.value, userObj, pwObj);</span>
<a href="#l2.1537"></a><span id="l2.1537">     if (!ret)</span>
<a href="#l2.1538"></a><span id="l2.1538">       setTimeout(CancelPublishing, 0);</span>
<a href="#l2.1539"></a><span id="l2.1539"> </span>
<a href="#l2.1540"></a><span id="l2.1540">     return ret;</span>
<a href="#l2.1541"></a><span id="l2.1541">   },</span>
<a href="#l2.1542"></a><span id="l2.1542">    *************************************************************************/</span>
<a href="#l2.1543"></a><span id="l2.1543"> </span>
<a href="#l2.1544"></a><span id="l2.1544" class="difflineminus">-  select : function(dlgTitle, text, count, selectList, outSelection)</span>
<a href="#l2.1545"></a><span id="l2.1545" class="difflineminus">-  {</span>
<a href="#l2.1546"></a><span id="l2.1546" class="difflineplus">+  select(dlgTitle, text, count, selectList, outSelection) {</span>
<a href="#l2.1547"></a><span id="l2.1547">     return Services.prompt.select(window, dlgTitle, text, count, selectList, outSelection);</span>
<a href="#l2.1548"></a><span id="l2.1548">   },</span>
<a href="#l2.1549"></a><span id="l2.1549"> </span>
<a href="#l2.1550"></a><span id="l2.1550"> // nsIAuthPrompt</span>
<a href="#l2.1551"></a><span id="l2.1551" class="difflineminus">-  prompt : function(dlgTitle, text, pwrealm, savePW, defaultText, result)</span>
<a href="#l2.1552"></a><span id="l2.1552" class="difflineminus">-  {</span>
<a href="#l2.1553"></a><span id="l2.1553" class="difflineplus">+  prompt(dlgTitle, text, pwrealm, savePW, defaultText, result) {</span>
<a href="#l2.1554"></a><span id="l2.1554">     var ret = Services.prompt.prompt(gProgressDialog ? gProgressDialog : window,</span>
<a href="#l2.1555"></a><span id="l2.1555">                                      dlgTitle, text, defaultText, pwrealm, savePWObj);</span>
<a href="#l2.1556"></a><span id="l2.1556">     if (!ret)</span>
<a href="#l2.1557"></a><span id="l2.1557">       setTimeout(CancelPublishing, 0);</span>
<a href="#l2.1558"></a><span id="l2.1558">     return ret;</span>
<a href="#l2.1559"></a><span id="l2.1559">   },</span>
<a href="#l2.1560"></a><span id="l2.1560"> </span>
<a href="#l2.1561"></a><span id="l2.1561" class="difflineminus">-  promptUsernameAndPassword : function(dlgTitle, text, pwrealm, savePW, userObj, pwObj)</span>
<a href="#l2.1562"></a><span id="l2.1562" class="difflineminus">-  {</span>
<a href="#l2.1563"></a><span id="l2.1563" class="difflineplus">+  promptUsernameAndPassword(dlgTitle, text, pwrealm, savePW, userObj, pwObj) {</span>
<a href="#l2.1564"></a><span id="l2.1564">     var ret = PromptUsernameAndPassword(dlgTitle, text, savePW, userObj, pwObj);</span>
<a href="#l2.1565"></a><span id="l2.1565">     if (!ret)</span>
<a href="#l2.1566"></a><span id="l2.1566">       setTimeout(CancelPublishing, 0);</span>
<a href="#l2.1567"></a><span id="l2.1567">     return ret;</span>
<a href="#l2.1568"></a><span id="l2.1568">   },</span>
<a href="#l2.1569"></a><span id="l2.1569"> </span>
<a href="#l2.1570"></a><span id="l2.1570" class="difflineminus">-  promptPassword : function(dlgTitle, text, pwrealm, savePW, pwObj)</span>
<a href="#l2.1571"></a><span id="l2.1571" class="difflineminus">-  {</span>
<a href="#l2.1572"></a><span id="l2.1572" class="difflineplus">+  promptPassword(dlgTitle, text, pwrealm, savePW, pwObj) {</span>
<a href="#l2.1573"></a><span id="l2.1573">     var ret = false;</span>
<a href="#l2.1574"></a><span id="l2.1574">     try {</span>
<a href="#l2.1575"></a><span id="l2.1575">       // Note difference with nsIPrompt::promptPassword, which has</span>
<a href="#l2.1576"></a><span id="l2.1576">       // &quot;inout&quot; savePassword param, while nsIAuthPrompt is just &quot;in&quot;</span>
<a href="#l2.1577"></a><span id="l2.1577">       // Also nsIAuth doesn't supply &quot;checkBoxLabel&quot;</span>
<a href="#l2.1578"></a><span id="l2.1578">       // Initialize with user's previous preference for this site</span>
<a href="#l2.1579"></a><span id="l2.1579" class="difflineminus">-      var savePWObj = {value:savePW};</span>
<a href="#l2.1580"></a><span id="l2.1580" class="difflineplus">+      var savePWObj = {value: savePW};</span>
<a href="#l2.1581"></a><span id="l2.1581">       // Initialize with user's previous preference for this site</span>
<a href="#l2.1582"></a><span id="l2.1582">       if (gPublishData)</span>
<a href="#l2.1583"></a><span id="l2.1583">         savePWObj.value = gPublishData.savePassword;</span>
<a href="#l2.1584"></a><span id="l2.1584"> </span>
<a href="#l2.1585"></a><span id="l2.1585">       ret = Services.prompt.promptPassword(gProgressDialog ? gProgressDialog : window,</span>
<a href="#l2.1586"></a><span id="l2.1586">                                            dlgTitle, text, pwObj, GetString(&quot;SavePassword&quot;), savePWObj);</span>
<a href="#l2.1587"></a><span id="l2.1587"> </span>
<a href="#l2.1588"></a><span id="l2.1588">       if (!ret)</span>
<a href="#l2.1589"></a><span id="l2.1589">         setTimeout(CancelPublishing, 0);</span>
<a href="#l2.1590"></a><span id="l2.1590"> </span>
<a href="#l2.1591"></a><span id="l2.1591">       if (ret &amp;&amp; gPublishData)</span>
<a href="#l2.1592"></a><span id="l2.1592">         UpdateUsernamePasswordFromPrompt(gPublishData, gPublishData.username, pwObj.value, savePWObj.value);</span>
<a href="#l2.1593"></a><span id="l2.1593" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.1594"></a><span id="l2.1594" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.1595"></a><span id="l2.1595"> </span>
<a href="#l2.1596"></a><span id="l2.1596">     return ret;</span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineminus">-  }</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineminus">-}</span>
<a href="#l2.1599"></a><span id="l2.1599" class="difflineminus">-</span>
<a href="#l2.1600"></a><span id="l2.1600" class="difflineminus">-function PromptUsernameAndPassword(dlgTitle, text, savePW, userObj, pwObj)</span>
<a href="#l2.1601"></a><span id="l2.1601" class="difflineminus">-{</span>
<a href="#l2.1602"></a><span id="l2.1602" class="difflineplus">+  },</span>
<a href="#l2.1603"></a><span id="l2.1603" class="difflineplus">+};</span>
<a href="#l2.1604"></a><span id="l2.1604" class="difflineplus">+</span>
<a href="#l2.1605"></a><span id="l2.1605" class="difflineplus">+function PromptUsernameAndPassword(dlgTitle, text, savePW, userObj, pwObj) {</span>
<a href="#l2.1606"></a><span id="l2.1606">   // HTTP prompts us twice even if user Cancels from 1st attempt!</span>
<a href="#l2.1607"></a><span id="l2.1607">   // So never put up dialog if there's no publish data</span>
<a href="#l2.1608"></a><span id="l2.1608">   if (!gPublishData)</span>
<a href="#l2.1609"></a><span id="l2.1609" class="difflineminus">-    return false</span>
<a href="#l2.1610"></a><span id="l2.1610" class="difflineplus">+    return false;</span>
<a href="#l2.1611"></a><span id="l2.1611"> </span>
<a href="#l2.1612"></a><span id="l2.1612">   var ret = false;</span>
<a href="#l2.1613"></a><span id="l2.1613">   try {</span>
<a href="#l2.1614"></a><span id="l2.1614" class="difflineminus">-</span>
<a href="#l2.1615"></a><span id="l2.1615" class="difflineminus">-    var savePWObj = {value:savePW};</span>
<a href="#l2.1616"></a><span id="l2.1616" class="difflineplus">+    var savePWObj = {value: savePW};</span>
<a href="#l2.1617"></a><span id="l2.1617"> </span>
<a href="#l2.1618"></a><span id="l2.1618">     // Initialize with user's previous preference for this site</span>
<a href="#l2.1619"></a><span id="l2.1619" class="difflineminus">-    if (gPublishData)</span>
<a href="#l2.1620"></a><span id="l2.1620" class="difflineminus">-    {</span>
<a href="#l2.1621"></a><span id="l2.1621" class="difflineplus">+    if (gPublishData) {</span>
<a href="#l2.1622"></a><span id="l2.1622">       // HTTP put uses this dialog if either username or password is bad,</span>
<a href="#l2.1623"></a><span id="l2.1623">       //   so prefill username input field with the previous value for modification</span>
<a href="#l2.1624"></a><span id="l2.1624">       savePWObj.value = gPublishData.savePassword;</span>
<a href="#l2.1625"></a><span id="l2.1625">       if (!userObj.value)</span>
<a href="#l2.1626"></a><span id="l2.1626">         userObj.value = gPublishData.username;</span>
<a href="#l2.1627"></a><span id="l2.1627">     }</span>
<a href="#l2.1628"></a><span id="l2.1628"> </span>
<a href="#l2.1629"></a><span id="l2.1629">     ret = Services.prompt.promptUsernameAndPassword(gProgressDialog ? gProgressDialog : window,</span>
<a href="#l2.1630"></a><span id="l2.1630">                                                     dlgTitle, text, userObj, pwObj,</span>
<a href="#l2.1631"></a><span id="l2.1631">                                                     GetString(&quot;SavePassword&quot;), savePWObj);</span>
<a href="#l2.1632"></a><span id="l2.1632">     if (ret &amp;&amp; gPublishData)</span>
<a href="#l2.1633"></a><span id="l2.1633">       UpdateUsernamePasswordFromPrompt(gPublishData, userObj.value, pwObj.value, savePWObj.value);</span>
<a href="#l2.1634"></a><span id="l2.1634" class="difflineminus">-</span>
<a href="#l2.1635"></a><span id="l2.1635">   } catch (e) {}</span>
<a href="#l2.1636"></a><span id="l2.1636"> </span>
<a href="#l2.1637"></a><span id="l2.1637">   return ret;</span>
<a href="#l2.1638"></a><span id="l2.1638"> }</span>
<a href="#l2.1639"></a><span id="l2.1639"> </span>
<a href="#l2.1640"></a><span id="l2.1640" class="difflineminus">-function DumpDebugStatus(aStatus)</span>
<a href="#l2.1641"></a><span id="l2.1641" class="difflineminus">-{</span>
<a href="#l2.1642"></a><span id="l2.1642" class="difflineplus">+function DumpDebugStatus(aStatus) {</span>
<a href="#l2.1643"></a><span id="l2.1643">   // see nsError.h and netCore.h and ftpCore.h</span>
<a href="#l2.1644"></a><span id="l2.1644"> </span>
<a href="#l2.1645"></a><span id="l2.1645">   if (aStatus == kErrorBindingAborted)</span>
<a href="#l2.1646"></a><span id="l2.1646">     dump(&quot;***** status is NS_BINDING_ABORTED\n&quot;);</span>
<a href="#l2.1647"></a><span id="l2.1647">   else if (aStatus == kErrorBindingRedirected)</span>
<a href="#l2.1648"></a><span id="l2.1648">     dump(&quot;***** status is NS_BINDING_REDIRECTED\n&quot;);</span>
<a href="#l2.1649"></a><span id="l2.1649">   else if (aStatus == 2152398859) // in netCore.h 11</span>
<a href="#l2.1650"></a><span id="l2.1650">     dump(&quot;***** status is ALREADY_CONNECTED\n&quot;);</span>
<a href="#l2.1651"></a><span id="l2.1651" class="difflineat">@@ -1529,18 +1389,17 @@ function DumpDebugStatus(aStatus)</span>
<a href="#l2.1652"></a><span id="l2.1652">     dump(&quot;***** status is ACCESS_DENIED\n&quot;);</span>
<a href="#l2.1653"></a><span id="l2.1653">   else if (aStatus == 2152398878)</span>
<a href="#l2.1654"></a><span id="l2.1654">     dump(&quot;***** status is ? (No connection or time out?)\n&quot;);</span>
<a href="#l2.1655"></a><span id="l2.1655">   else</span>
<a href="#l2.1656"></a><span id="l2.1656">     dump(&quot;***** status is &quot; + aStatus + &quot;\n&quot;);</span>
<a href="#l2.1657"></a><span id="l2.1657"> }</span>
<a href="#l2.1658"></a><span id="l2.1658"> </span>
<a href="#l2.1659"></a><span id="l2.1659"> // Update any data that the user supplied in a prompt dialog</span>
<a href="#l2.1660"></a><span id="l2.1660" class="difflineminus">-function UpdateUsernamePasswordFromPrompt(publishData, username, password, savePassword)</span>
<a href="#l2.1661"></a><span id="l2.1661" class="difflineminus">-{</span>
<a href="#l2.1662"></a><span id="l2.1662" class="difflineplus">+function UpdateUsernamePasswordFromPrompt(publishData, username, password, savePassword) {</span>
<a href="#l2.1663"></a><span id="l2.1663">   if (!publishData)</span>
<a href="#l2.1664"></a><span id="l2.1664">     return;</span>
<a href="#l2.1665"></a><span id="l2.1665"> </span>
<a href="#l2.1666"></a><span id="l2.1666">   // Set flag to save publish data after publishing if it changed in dialog</span>
<a href="#l2.1667"></a><span id="l2.1667">   //  and the &quot;SavePassword&quot; checkbox was checked</span>
<a href="#l2.1668"></a><span id="l2.1668">   //  or we already had site data for this site</span>
<a href="#l2.1669"></a><span id="l2.1669">   // (Thus we don't automatically create a site until user brings up Publish As dialog)</span>
<a href="#l2.1670"></a><span id="l2.1670">   publishData.savePublishData = (gPublishData.username != username || gPublishData.password != password)</span>
<a href="#l2.1671"></a><span id="l2.1671" class="difflineat">@@ -1558,32 +1417,29 @@ const kSupportedTextMimeTypes =</span>
<a href="#l2.1672"></a><span id="l2.1672">   &quot;text/rdf&quot;,</span>
<a href="#l2.1673"></a><span id="l2.1673">   &quot;text/xsl&quot;,</span>
<a href="#l2.1674"></a><span id="l2.1674">   &quot;text/javascript&quot;,</span>
<a href="#l2.1675"></a><span id="l2.1675">   &quot;text/ecmascript&quot;,</span>
<a href="#l2.1676"></a><span id="l2.1676">   &quot;application/javascript&quot;,</span>
<a href="#l2.1677"></a><span id="l2.1677">   &quot;application/ecmascript&quot;,</span>
<a href="#l2.1678"></a><span id="l2.1678">   &quot;application/x-javascript&quot;,</span>
<a href="#l2.1679"></a><span id="l2.1679">   &quot;text/xul&quot;,</span>
<a href="#l2.1680"></a><span id="l2.1680" class="difflineminus">-  &quot;application/vnd.mozilla.xul+xml&quot;</span>
<a href="#l2.1681"></a><span id="l2.1681" class="difflineplus">+  &quot;application/vnd.mozilla.xul+xml&quot;,</span>
<a href="#l2.1682"></a><span id="l2.1682"> ];</span>
<a href="#l2.1683"></a><span id="l2.1683"> </span>
<a href="#l2.1684"></a><span id="l2.1684" class="difflineminus">-function IsSupportedTextMimeType(aMimeType)</span>
<a href="#l2.1685"></a><span id="l2.1685" class="difflineminus">-{</span>
<a href="#l2.1686"></a><span id="l2.1686" class="difflineminus">-  for (var i = 0; i &lt; kSupportedTextMimeTypes.length; i++)</span>
<a href="#l2.1687"></a><span id="l2.1687" class="difflineminus">-  {</span>
<a href="#l2.1688"></a><span id="l2.1688" class="difflineplus">+function IsSupportedTextMimeType(aMimeType) {</span>
<a href="#l2.1689"></a><span id="l2.1689" class="difflineplus">+  for (var i = 0; i &lt; kSupportedTextMimeTypes.length; i++) {</span>
<a href="#l2.1690"></a><span id="l2.1690">     if (kSupportedTextMimeTypes[i] == aMimeType)</span>
<a href="#l2.1691"></a><span id="l2.1691">       return true;</span>
<a href="#l2.1692"></a><span id="l2.1692">   }</span>
<a href="#l2.1693"></a><span id="l2.1693">   return false;</span>
<a href="#l2.1694"></a><span id="l2.1694"> }</span>
<a href="#l2.1695"></a><span id="l2.1695"> </span>
<a href="#l2.1696"></a><span id="l2.1696"> // throws an error or returns true if user attempted save; false if user canceled save</span>
<a href="#l2.1697"></a><span id="l2.1697" class="difflineminus">-async function SaveDocument(aSaveAs, aSaveCopy, aMimeType)</span>
<a href="#l2.1698"></a><span id="l2.1698" class="difflineminus">-{</span>
<a href="#l2.1699"></a><span id="l2.1699" class="difflineplus">+async function SaveDocument(aSaveAs, aSaveCopy, aMimeType) {</span>
<a href="#l2.1700"></a><span id="l2.1700">   var editor = GetCurrentEditor();</span>
<a href="#l2.1701"></a><span id="l2.1701">   if (!aMimeType || !editor)</span>
<a href="#l2.1702"></a><span id="l2.1702">     throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l2.1703"></a><span id="l2.1703"> </span>
<a href="#l2.1704"></a><span id="l2.1704">   var editorDoc = editor.document;</span>
<a href="#l2.1705"></a><span id="l2.1705">   if (!editorDoc)</span>
<a href="#l2.1706"></a><span id="l2.1706">     throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l2.1707"></a><span id="l2.1707"> </span>
<a href="#l2.1708"></a><span id="l2.1708" class="difflineat">@@ -1608,22 +1464,20 @@ async function SaveDocument(aSaveAs, aSa</span>
<a href="#l2.1709"></a><span id="l2.1709">   if (!mustShowFileDialog &amp;&amp; GetScheme(urlstring) != &quot;file&quot;)</span>
<a href="#l2.1710"></a><span id="l2.1710">     mustShowFileDialog = true;</span>
<a href="#l2.1711"></a><span id="l2.1711"> </span>
<a href="#l2.1712"></a><span id="l2.1712">   var replacing = !aSaveAs;</span>
<a href="#l2.1713"></a><span id="l2.1713">   var titleChanged = false;</span>
<a href="#l2.1714"></a><span id="l2.1714">   var doUpdateURI = false;</span>
<a href="#l2.1715"></a><span id="l2.1715">   var tempLocalFile = null;</span>
<a href="#l2.1716"></a><span id="l2.1716"> </span>
<a href="#l2.1717"></a><span id="l2.1717" class="difflineminus">-  if (mustShowFileDialog)</span>
<a href="#l2.1718"></a><span id="l2.1718" class="difflineminus">-  {</span>
<a href="#l2.1719"></a><span id="l2.1719" class="difflineplus">+  if (mustShowFileDialog) {</span>
<a href="#l2.1720"></a><span id="l2.1720">     try {</span>
<a href="#l2.1721"></a><span id="l2.1721">       // Prompt for title if we are saving to HTML</span>
<a href="#l2.1722"></a><span id="l2.1722" class="difflineminus">-      if (!saveAsTextFile &amp;&amp; (editorType == &quot;html&quot;))</span>
<a href="#l2.1723"></a><span id="l2.1723" class="difflineminus">-      {</span>
<a href="#l2.1724"></a><span id="l2.1724" class="difflineplus">+      if (!saveAsTextFile &amp;&amp; (editorType == &quot;html&quot;)) {</span>
<a href="#l2.1725"></a><span id="l2.1725">         var userContinuing = PromptAndSetTitleIfNone(); // not cancel</span>
<a href="#l2.1726"></a><span id="l2.1726">         if (!userContinuing)</span>
<a href="#l2.1727"></a><span id="l2.1727">           return false;</span>
<a href="#l2.1728"></a><span id="l2.1728">       }</span>
<a href="#l2.1729"></a><span id="l2.1729"> </span>
<a href="#l2.1730"></a><span id="l2.1730">       var dialogResult = await PromptForSaveLocation(saveAsTextFile, editorType, aMimeType, urlstring);</span>
<a href="#l2.1731"></a><span id="l2.1731">       if (!dialogResult)</span>
<a href="#l2.1732"></a><span id="l2.1732">         return false;</span>
<a href="#l2.1733"></a><span id="l2.1733" class="difflineat">@@ -1641,80 +1495,69 @@ async function SaveDocument(aSaveAs, aSa</span>
<a href="#l2.1734"></a><span id="l2.1734">     }</span>
<a href="#l2.1735"></a><span id="l2.1735">   } // mustShowFileDialog</span>
<a href="#l2.1736"></a><span id="l2.1736"> </span>
<a href="#l2.1737"></a><span id="l2.1737">   var success = true;</span>
<a href="#l2.1738"></a><span id="l2.1738">   try {</span>
<a href="#l2.1739"></a><span id="l2.1739">     // if somehow we didn't get a local file but we did get a uri,</span>
<a href="#l2.1740"></a><span id="l2.1740">     // attempt to create the localfile if it's a &quot;file&quot; url</span>
<a href="#l2.1741"></a><span id="l2.1741">     var docURI;</span>
<a href="#l2.1742"></a><span id="l2.1742" class="difflineminus">-    if (!tempLocalFile)</span>
<a href="#l2.1743"></a><span id="l2.1743" class="difflineminus">-    {</span>
<a href="#l2.1744"></a><span id="l2.1744" class="difflineplus">+    if (!tempLocalFile) {</span>
<a href="#l2.1745"></a><span id="l2.1745">       docURI = Services.io.newURI(urlstring, editor.documentCharacterSet);</span>
<a href="#l2.1746"></a><span id="l2.1746"> </span>
<a href="#l2.1747"></a><span id="l2.1747" class="difflineminus">-      if (docURI.schemeIs(&quot;file&quot;))</span>
<a href="#l2.1748"></a><span id="l2.1748" class="difflineminus">-      {</span>
<a href="#l2.1749"></a><span id="l2.1749" class="difflineplus">+      if (docURI.schemeIs(&quot;file&quot;)) {</span>
<a href="#l2.1750"></a><span id="l2.1750">         var fileHandler = GetFileProtocolHandler();</span>
<a href="#l2.1751"></a><span id="l2.1751">         tempLocalFile = fileHandler.getFileFromURLSpec(urlstring).QueryInterface(Ci.nsIFile);</span>
<a href="#l2.1752"></a><span id="l2.1752">       }</span>
<a href="#l2.1753"></a><span id="l2.1753">     }</span>
<a href="#l2.1754"></a><span id="l2.1754"> </span>
<a href="#l2.1755"></a><span id="l2.1755">     // this is the location where the related files will go</span>
<a href="#l2.1756"></a><span id="l2.1756">     var relatedFilesDir = null;</span>
<a href="#l2.1757"></a><span id="l2.1757"> </span>
<a href="#l2.1758"></a><span id="l2.1758">     // Only change links or move files if pref is set</span>
<a href="#l2.1759"></a><span id="l2.1759">     // and we are saving to a new location</span>
<a href="#l2.1760"></a><span id="l2.1760" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;editor.save_associated_files&quot;) &amp;&amp; aSaveAs)</span>
<a href="#l2.1761"></a><span id="l2.1761" class="difflineminus">-    {</span>
<a href="#l2.1762"></a><span id="l2.1762" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;editor.save_associated_files&quot;) &amp;&amp; aSaveAs) {</span>
<a href="#l2.1763"></a><span id="l2.1763">       try {</span>
<a href="#l2.1764"></a><span id="l2.1764" class="difflineminus">-        if (tempLocalFile)</span>
<a href="#l2.1765"></a><span id="l2.1765" class="difflineminus">-        {</span>
<a href="#l2.1766"></a><span id="l2.1766" class="difflineplus">+        if (tempLocalFile) {</span>
<a href="#l2.1767"></a><span id="l2.1767">           // if we are saving to the same parent directory, don't set relatedFilesDir</span>
<a href="#l2.1768"></a><span id="l2.1768">           // grab old location, chop off file</span>
<a href="#l2.1769"></a><span id="l2.1769">           // grab new location, chop off file, compare</span>
<a href="#l2.1770"></a><span id="l2.1770">           var oldLocation = GetDocumentUrl();</span>
<a href="#l2.1771"></a><span id="l2.1771">           var oldLocationLastSlash = oldLocation.lastIndexOf(&quot;\/&quot;);</span>
<a href="#l2.1772"></a><span id="l2.1772">           if (oldLocationLastSlash != -1)</span>
<a href="#l2.1773"></a><span id="l2.1773">             oldLocation = oldLocation.slice(0, oldLocationLastSlash);</span>
<a href="#l2.1774"></a><span id="l2.1774"> </span>
<a href="#l2.1775"></a><span id="l2.1775">           var relatedFilesDirStr = urlstring;</span>
<a href="#l2.1776"></a><span id="l2.1776">           var newLocationLastSlash = relatedFilesDirStr.lastIndexOf(&quot;\/&quot;);</span>
<a href="#l2.1777"></a><span id="l2.1777">           if (newLocationLastSlash != -1)</span>
<a href="#l2.1778"></a><span id="l2.1778">             relatedFilesDirStr = relatedFilesDirStr.slice(0, newLocationLastSlash);</span>
<a href="#l2.1779"></a><span id="l2.1779">           if (oldLocation == relatedFilesDirStr || IsUrlAboutBlank(oldLocation))</span>
<a href="#l2.1780"></a><span id="l2.1780">             relatedFilesDir = null;</span>
<a href="#l2.1781"></a><span id="l2.1781">           else</span>
<a href="#l2.1782"></a><span id="l2.1782">             relatedFilesDir = tempLocalFile.parent;</span>
<a href="#l2.1783"></a><span id="l2.1783" class="difflineminus">-        }</span>
<a href="#l2.1784"></a><span id="l2.1784" class="difflineminus">-        else</span>
<a href="#l2.1785"></a><span id="l2.1785" class="difflineminus">-        {</span>
<a href="#l2.1786"></a><span id="l2.1786" class="difflineplus">+        } else {</span>
<a href="#l2.1787"></a><span id="l2.1787">           var lastSlash = urlstring.lastIndexOf(&quot;\/&quot;);</span>
<a href="#l2.1788"></a><span id="l2.1788" class="difflineminus">-          if (lastSlash != -1)</span>
<a href="#l2.1789"></a><span id="l2.1789" class="difflineminus">-          {</span>
<a href="#l2.1790"></a><span id="l2.1790" class="difflineplus">+          if (lastSlash != -1) {</span>
<a href="#l2.1791"></a><span id="l2.1791">             var relatedFilesDirString = urlstring.slice(0, lastSlash + 1);  // include last slash</span>
<a href="#l2.1792"></a><span id="l2.1792">             relatedFilesDir = Services.io.newURI(relatedFilesDirString, editor.documentCharacterSet);</span>
<a href="#l2.1793"></a><span id="l2.1793">           }</span>
<a href="#l2.1794"></a><span id="l2.1794">         }</span>
<a href="#l2.1795"></a><span id="l2.1795" class="difflineminus">-      } catch(e) { relatedFilesDir = null; }</span>
<a href="#l2.1796"></a><span id="l2.1796" class="difflineplus">+      } catch (e) { relatedFilesDir = null; }</span>
<a href="#l2.1797"></a><span id="l2.1797">     }</span>
<a href="#l2.1798"></a><span id="l2.1798"> </span>
<a href="#l2.1799"></a><span id="l2.1799">     let destinationLocation = tempLocalFile ? tempLocalFile : docURI;</span>
<a href="#l2.1800"></a><span id="l2.1800"> </span>
<a href="#l2.1801"></a><span id="l2.1801">     success = OutputFileWithPersistAPI(editorDoc, destinationLocation, relatedFilesDir, aMimeType);</span>
<a href="#l2.1802"></a><span id="l2.1802" class="difflineminus">-  }</span>
<a href="#l2.1803"></a><span id="l2.1803" class="difflineminus">-  catch (e)</span>
<a href="#l2.1804"></a><span id="l2.1804" class="difflineminus">-  {</span>
<a href="#l2.1805"></a><span id="l2.1805" class="difflineplus">+  } catch (e) {</span>
<a href="#l2.1806"></a><span id="l2.1806">     success = false;</span>
<a href="#l2.1807"></a><span id="l2.1807">   }</span>
<a href="#l2.1808"></a><span id="l2.1808"> </span>
<a href="#l2.1809"></a><span id="l2.1809" class="difflineminus">-  if (success)</span>
<a href="#l2.1810"></a><span id="l2.1810" class="difflineminus">-  {</span>
<a href="#l2.1811"></a><span id="l2.1811" class="difflineplus">+  if (success) {</span>
<a href="#l2.1812"></a><span id="l2.1812">     try {</span>
<a href="#l2.1813"></a><span id="l2.1813" class="difflineminus">-      if (doUpdateURI)</span>
<a href="#l2.1814"></a><span id="l2.1814" class="difflineminus">-      {</span>
<a href="#l2.1815"></a><span id="l2.1815" class="difflineplus">+      if (doUpdateURI) {</span>
<a href="#l2.1816"></a><span id="l2.1816">          // If a local file, we must create a new uri from nsIFile</span>
<a href="#l2.1817"></a><span id="l2.1817">         if (tempLocalFile)</span>
<a href="#l2.1818"></a><span id="l2.1818">           docURI = GetFileProtocolHandler().newFileURI(tempLocalFile);</span>
<a href="#l2.1819"></a><span id="l2.1819"> </span>
<a href="#l2.1820"></a><span id="l2.1820">         // We need to set new document uri before notifying listeners</span>
<a href="#l2.1821"></a><span id="l2.1821">         SetDocumentURI(docURI);</span>
<a href="#l2.1822"></a><span id="l2.1822">       }</span>
<a href="#l2.1823"></a><span id="l2.1823"> </span>
<a href="#l2.1824"></a><span id="l2.1824" class="difflineat">@@ -1725,176 +1568,158 @@ async function SaveDocument(aSaveAs, aSa</span>
<a href="#l2.1825"></a><span id="l2.1825"> </span>
<a href="#l2.1826"></a><span id="l2.1826">       if (!aSaveCopy)</span>
<a href="#l2.1827"></a><span id="l2.1827">         editor.resetModificationCount();</span>
<a href="#l2.1828"></a><span id="l2.1828">       // this should cause notification to listeners that document has changed</span>
<a href="#l2.1829"></a><span id="l2.1829"> </span>
<a href="#l2.1830"></a><span id="l2.1830">       // Set UI based on whether we're editing a remote or local url</span>
<a href="#l2.1831"></a><span id="l2.1831">       SetSaveAndPublishUI(urlstring);</span>
<a href="#l2.1832"></a><span id="l2.1832">     } catch (e) {}</span>
<a href="#l2.1833"></a><span id="l2.1833" class="difflineminus">-  }</span>
<a href="#l2.1834"></a><span id="l2.1834" class="difflineminus">-  else</span>
<a href="#l2.1835"></a><span id="l2.1835" class="difflineminus">-  {</span>
<a href="#l2.1836"></a><span id="l2.1836" class="difflineplus">+  } else {</span>
<a href="#l2.1837"></a><span id="l2.1837">     Services.prompt.alert(window, GetString(&quot;SaveDocument&quot;), GetString(&quot;SaveFileFailed&quot;));</span>
<a href="#l2.1838"></a><span id="l2.1838">   }</span>
<a href="#l2.1839"></a><span id="l2.1839">   return success;</span>
<a href="#l2.1840"></a><span id="l2.1840"> }</span>
<a href="#l2.1841"></a><span id="l2.1841"> </span>
<a href="#l2.1842"></a><span id="l2.1842" class="difflineminus">-function SetDocumentURI(uri)</span>
<a href="#l2.1843"></a><span id="l2.1843" class="difflineminus">-{</span>
<a href="#l2.1844"></a><span id="l2.1844" class="difflineplus">+function SetDocumentURI(uri) {</span>
<a href="#l2.1845"></a><span id="l2.1845">   try {</span>
<a href="#l2.1846"></a><span id="l2.1846">     // XXX WE'LL NEED TO GET &quot;CURRENT&quot; CONTENT FRAME ONCE MULTIPLE EDITORS ARE ALLOWED</span>
<a href="#l2.1847"></a><span id="l2.1847">     GetCurrentEditorElement().docShell.setCurrentURI(uri);</span>
<a href="#l2.1848"></a><span id="l2.1848" class="difflineminus">-  } catch (e) { dump(&quot;SetDocumentURI:\n&quot;+e +&quot;\n&quot;); }</span>
<a href="#l2.1849"></a><span id="l2.1849" class="difflineplus">+  } catch (e) { dump(&quot;SetDocumentURI:\n&quot; + e + &quot;\n&quot;); }</span>
<a href="#l2.1850"></a><span id="l2.1850"> }</span>
<a href="#l2.1851"></a><span id="l2.1851"> </span>
<a href="#l2.1852"></a><span id="l2.1852"> </span>
<a href="#l2.1853"></a><span id="l2.1853" class="difflineminus">-//-------------------------------  Publishing</span>
<a href="#l2.1854"></a><span id="l2.1854" class="difflineplus">+// -------------------------------  Publishing</span>
<a href="#l2.1855"></a><span id="l2.1855"> var gPublishData;</span>
<a href="#l2.1856"></a><span id="l2.1856"> var gProgressDialog;</span>
<a href="#l2.1857"></a><span id="l2.1857"> var gCommandAfterPublishing = null;</span>
<a href="#l2.1858"></a><span id="l2.1858"> var gRestoreDocumentSource;</span>
<a href="#l2.1859"></a><span id="l2.1859"> </span>
<a href="#l2.1860"></a><span id="l2.1860" class="difflineminus">-function Publish(publishData)</span>
<a href="#l2.1861"></a><span id="l2.1861" class="difflineminus">-{</span>
<a href="#l2.1862"></a><span id="l2.1862" class="difflineplus">+function Publish(publishData) {</span>
<a href="#l2.1863"></a><span id="l2.1863">   if (!publishData)</span>
<a href="#l2.1864"></a><span id="l2.1864">     return false;</span>
<a href="#l2.1865"></a><span id="l2.1865"> </span>
<a href="#l2.1866"></a><span id="l2.1866">   // Set data in global for username password requests</span>
<a href="#l2.1867"></a><span id="l2.1867">   //  and to do &quot;post saving&quot; actions after monitoring nsIWebProgressListener messages</span>
<a href="#l2.1868"></a><span id="l2.1868">   //  and we are sure file transfer was successful</span>
<a href="#l2.1869"></a><span id="l2.1869">   gPublishData = publishData;</span>
<a href="#l2.1870"></a><span id="l2.1870"> </span>
<a href="#l2.1871"></a><span id="l2.1871">   gPublishData.docURI = CreateURIFromPublishData(publishData, true);</span>
<a href="#l2.1872"></a><span id="l2.1872" class="difflineminus">-  if (!gPublishData.docURI)</span>
<a href="#l2.1873"></a><span id="l2.1873" class="difflineminus">-  {</span>
<a href="#l2.1874"></a><span id="l2.1874" class="difflineplus">+  if (!gPublishData.docURI) {</span>
<a href="#l2.1875"></a><span id="l2.1875">     Services.prompt.alert(window, GetString(&quot;Publish&quot;), GetString(&quot;PublishFailed&quot;));</span>
<a href="#l2.1876"></a><span id="l2.1876">     return false;</span>
<a href="#l2.1877"></a><span id="l2.1877">   }</span>
<a href="#l2.1878"></a><span id="l2.1878"> </span>
<a href="#l2.1879"></a><span id="l2.1879">   if (gPublishData.publishOtherFiles)</span>
<a href="#l2.1880"></a><span id="l2.1880">     gPublishData.otherFilesURI = CreateURIFromPublishData(publishData, false);</span>
<a href="#l2.1881"></a><span id="l2.1881">   else</span>
<a href="#l2.1882"></a><span id="l2.1882">     gPublishData.otherFilesURI = null;</span>
<a href="#l2.1883"></a><span id="l2.1883"> </span>
<a href="#l2.1884"></a><span id="l2.1884" class="difflineminus">-  if (gShowDebugOutputStateChange)</span>
<a href="#l2.1885"></a><span id="l2.1885" class="difflineminus">-  {</span>
<a href="#l2.1886"></a><span id="l2.1886" class="difflineminus">-    dump(&quot;\n *** publishData: PublishUrl=&quot;+publishData.publishUrl+&quot;, BrowseUrl=&quot;+publishData.browseUrl+</span>
<a href="#l2.1887"></a><span id="l2.1887" class="difflineminus">-      &quot;, Username=&quot;+publishData.username+&quot;, Dir=&quot;+publishData.docDir+</span>
<a href="#l2.1888"></a><span id="l2.1888" class="difflineminus">-      &quot;, Filename=&quot;+publishData.filename+&quot;\n&quot;);</span>
<a href="#l2.1889"></a><span id="l2.1889" class="difflineminus">-    dump(&quot; * gPublishData.docURI.spec w/o pass=&quot;+StripPassword(gPublishData.docURI.spec)+&quot;, PublishOtherFiles=&quot;+gPublishData.publishOtherFiles+&quot;\n&quot;);</span>
<a href="#l2.1890"></a><span id="l2.1890" class="difflineplus">+  if (gShowDebugOutputStateChange) {</span>
<a href="#l2.1891"></a><span id="l2.1891" class="difflineplus">+    dump(&quot;\n *** publishData: PublishUrl=&quot; + publishData.publishUrl + &quot;, BrowseUrl=&quot; + publishData.browseUrl +</span>
<a href="#l2.1892"></a><span id="l2.1892" class="difflineplus">+      &quot;, Username=&quot; + publishData.username + &quot;, Dir=&quot; + publishData.docDir +</span>
<a href="#l2.1893"></a><span id="l2.1893" class="difflineplus">+      &quot;, Filename=&quot; + publishData.filename + &quot;\n&quot;);</span>
<a href="#l2.1894"></a><span id="l2.1894" class="difflineplus">+    dump(&quot; * gPublishData.docURI.spec w/o pass=&quot; + StripPassword(gPublishData.docURI.spec) + &quot;, PublishOtherFiles=&quot; + gPublishData.publishOtherFiles + &quot;\n&quot;);</span>
<a href="#l2.1895"></a><span id="l2.1895">   }</span>
<a href="#l2.1896"></a><span id="l2.1896"> </span>
<a href="#l2.1897"></a><span id="l2.1897">   // XXX Missing username will make FTP fail</span>
<a href="#l2.1898"></a><span id="l2.1898">   // and it won't call us for prompt dialog (bug 132320)</span>
<a href="#l2.1899"></a><span id="l2.1899">   // (It does prompt if just password is missing)</span>
<a href="#l2.1900"></a><span id="l2.1900">   // So we should do the prompt ourselves before trying to publish</span>
<a href="#l2.1901"></a><span id="l2.1901" class="difflineminus">-  if (GetScheme(publishData.publishUrl) == &quot;ftp&quot; &amp;&amp; !publishData.username)</span>
<a href="#l2.1902"></a><span id="l2.1902" class="difflineminus">-  {</span>
<a href="#l2.1903"></a><span id="l2.1903" class="difflineplus">+  if (GetScheme(publishData.publishUrl) == &quot;ftp&quot; &amp;&amp; !publishData.username) {</span>
<a href="#l2.1904"></a><span id="l2.1904">     var message = GetString(&quot;PromptFTPUsernamePassword&quot;).replace(/%host%/, GetHost(publishData.publishUrl));</span>
<a href="#l2.1905"></a><span id="l2.1905" class="difflineminus">-    var savePWobj = {value:publishData.savePassword};</span>
<a href="#l2.1906"></a><span id="l2.1906" class="difflineminus">-    var userObj = {value:publishData.username};</span>
<a href="#l2.1907"></a><span id="l2.1907" class="difflineminus">-    var pwObj = {value:publishData.password};</span>
<a href="#l2.1908"></a><span id="l2.1908" class="difflineplus">+    var savePWobj = {value: publishData.savePassword};</span>
<a href="#l2.1909"></a><span id="l2.1909" class="difflineplus">+    var userObj = {value: publishData.username};</span>
<a href="#l2.1910"></a><span id="l2.1910" class="difflineplus">+    var pwObj = {value: publishData.password};</span>
<a href="#l2.1911"></a><span id="l2.1911">     if (!PromptUsernameAndPassword(GetString(&quot;Prompt&quot;), message, savePWobj, userObj, pwObj))</span>
<a href="#l2.1912"></a><span id="l2.1912">       return false; // User canceled out of dialog</span>
<a href="#l2.1913"></a><span id="l2.1913"> </span>
<a href="#l2.1914"></a><span id="l2.1914">     // Reset data in URI objects</span>
<a href="#l2.1915"></a><span id="l2.1915">     gPublishData.docURI.username = publishData.username;</span>
<a href="#l2.1916"></a><span id="l2.1916">     gPublishData.docURI.password = publishData.password;</span>
<a href="#l2.1917"></a><span id="l2.1917"> </span>
<a href="#l2.1918"></a><span id="l2.1918" class="difflineminus">-    if (gPublishData.otherFilesURI)</span>
<a href="#l2.1919"></a><span id="l2.1919" class="difflineminus">-    {</span>
<a href="#l2.1920"></a><span id="l2.1920" class="difflineplus">+    if (gPublishData.otherFilesURI) {</span>
<a href="#l2.1921"></a><span id="l2.1921">       gPublishData.otherFilesURI.username = publishData.username;</span>
<a href="#l2.1922"></a><span id="l2.1922">       gPublishData.otherFilesURI.password = publishData.password;</span>
<a href="#l2.1923"></a><span id="l2.1923">     }</span>
<a href="#l2.1924"></a><span id="l2.1924">   }</span>
<a href="#l2.1925"></a><span id="l2.1925"> </span>
<a href="#l2.1926"></a><span id="l2.1926">   try {</span>
<a href="#l2.1927"></a><span id="l2.1927">     // We launch dialog as a dependent</span>
<a href="#l2.1928"></a><span id="l2.1928">     // Don't allow editing document!</span>
<a href="#l2.1929"></a><span id="l2.1929">     SetDocumentEditable(false);</span>
<a href="#l2.1930"></a><span id="l2.1930"> </span>
<a href="#l2.1931"></a><span id="l2.1931">     // Start progress monitoring</span>
<a href="#l2.1932"></a><span id="l2.1932">     gProgressDialog =</span>
<a href="#l2.1933"></a><span id="l2.1933">       window.openDialog(&quot;chrome://editor/content/EditorPublishProgress.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.1934"></a><span id="l2.1934">                         &quot;chrome,dependent,titlebar&quot;, gPublishData, gPersistObj);</span>
<a href="#l2.1935"></a><span id="l2.1935" class="difflineminus">-</span>
<a href="#l2.1936"></a><span id="l2.1936">   } catch (e) {}</span>
<a href="#l2.1937"></a><span id="l2.1937"> </span>
<a href="#l2.1938"></a><span id="l2.1938">   // Network transfer is often too quick for the progress dialog to be initialized</span>
<a href="#l2.1939"></a><span id="l2.1939">   //  and we can completely miss messages for quickly-terminated bad URLs,</span>
<a href="#l2.1940"></a><span id="l2.1940">   //  so we can't call OutputFileWithPersistAPI right away.</span>
<a href="#l2.1941"></a><span id="l2.1941">   // StartPublishing() is called at the end of the dialog's onload method</span>
<a href="#l2.1942"></a><span id="l2.1942">   return true;</span>
<a href="#l2.1943"></a><span id="l2.1943"> }</span>
<a href="#l2.1944"></a><span id="l2.1944"> </span>
<a href="#l2.1945"></a><span id="l2.1945" class="difflineminus">-function StartPublishing()</span>
<a href="#l2.1946"></a><span id="l2.1946" class="difflineminus">-{</span>
<a href="#l2.1947"></a><span id="l2.1947" class="difflineplus">+function StartPublishing() {</span>
<a href="#l2.1948"></a><span id="l2.1948">   var editor = GetCurrentEditor();</span>
<a href="#l2.1949"></a><span id="l2.1949" class="difflineminus">-  if (editor &amp;&amp; gPublishData &amp;&amp; gPublishData.docURI &amp;&amp; gProgressDialog)</span>
<a href="#l2.1950"></a><span id="l2.1950" class="difflineminus">-  {</span>
<a href="#l2.1951"></a><span id="l2.1951" class="difflineplus">+  if (editor &amp;&amp; gPublishData &amp;&amp; gPublishData.docURI &amp;&amp; gProgressDialog) {</span>
<a href="#l2.1952"></a><span id="l2.1952">     gRestoreDocumentSource = null;</span>
<a href="#l2.1953"></a><span id="l2.1953"> </span>
<a href="#l2.1954"></a><span id="l2.1954">     // Save backup document since nsIWebBrowserPersist changes image src urls</span>
<a href="#l2.1955"></a><span id="l2.1955">     // but we only need to do this if publishing images and other related files</span>
<a href="#l2.1956"></a><span id="l2.1956" class="difflineminus">-    if (gPublishData.otherFilesURI)</span>
<a href="#l2.1957"></a><span id="l2.1957" class="difflineminus">-    {</span>
<a href="#l2.1958"></a><span id="l2.1958" class="difflineplus">+    if (gPublishData.otherFilesURI) {</span>
<a href="#l2.1959"></a><span id="l2.1959">       try {</span>
<a href="#l2.1960"></a><span id="l2.1960">         gRestoreDocumentSource =</span>
<a href="#l2.1961"></a><span id="l2.1961">           editor.outputToString(editor.contentsMIMEType, kOutputEncodeW3CEntities);</span>
<a href="#l2.1962"></a><span id="l2.1962">       } catch (e) {}</span>
<a href="#l2.1963"></a><span id="l2.1963">     }</span>
<a href="#l2.1964"></a><span id="l2.1964"> </span>
<a href="#l2.1965"></a><span id="l2.1965">     OutputFileWithPersistAPI(editor.document,</span>
<a href="#l2.1966"></a><span id="l2.1966">                              gPublishData.docURI, gPublishData.otherFilesURI,</span>
<a href="#l2.1967"></a><span id="l2.1967">                              editor.contentsMIMEType);</span>
<a href="#l2.1968"></a><span id="l2.1968">     return gPersistObj;</span>
<a href="#l2.1969"></a><span id="l2.1969">   }</span>
<a href="#l2.1970"></a><span id="l2.1970">   return null;</span>
<a href="#l2.1971"></a><span id="l2.1971"> }</span>
<a href="#l2.1972"></a><span id="l2.1972"> </span>
<a href="#l2.1973"></a><span id="l2.1973" class="difflineminus">-function CancelPublishing()</span>
<a href="#l2.1974"></a><span id="l2.1974" class="difflineminus">-{</span>
<a href="#l2.1975"></a><span id="l2.1975" class="difflineplus">+function CancelPublishing() {</span>
<a href="#l2.1976"></a><span id="l2.1976">   try {</span>
<a href="#l2.1977"></a><span id="l2.1977">     gPersistObj.cancelSave();</span>
<a href="#l2.1978"></a><span id="l2.1978">     gProgressDialog.SetProgressStatusCancel();</span>
<a href="#l2.1979"></a><span id="l2.1979">   } catch (e) {}</span>
<a href="#l2.1980"></a><span id="l2.1980"> </span>
<a href="#l2.1981"></a><span id="l2.1981">   // If canceling publishing do not do any commands after this</span>
<a href="#l2.1982"></a><span id="l2.1982">   gCommandAfterPublishing = null;</span>
<a href="#l2.1983"></a><span id="l2.1983"> </span>
<a href="#l2.1984"></a><span id="l2.1984" class="difflineminus">-  if (gProgressDialog)</span>
<a href="#l2.1985"></a><span id="l2.1985" class="difflineminus">-  {</span>
<a href="#l2.1986"></a><span id="l2.1986" class="difflineplus">+  if (gProgressDialog) {</span>
<a href="#l2.1987"></a><span id="l2.1987">     // Close Progress dialog</span>
<a href="#l2.1988"></a><span id="l2.1988">     // (this will call FinishPublishing())</span>
<a href="#l2.1989"></a><span id="l2.1989">     gProgressDialog.CloseDialog();</span>
<a href="#l2.1990"></a><span id="l2.1990" class="difflineminus">-  }</span>
<a href="#l2.1991"></a><span id="l2.1991" class="difflineminus">-  else</span>
<a href="#l2.1992"></a><span id="l2.1992" class="difflineplus">+  } else</span>
<a href="#l2.1993"></a><span id="l2.1993">     FinishPublishing();</span>
<a href="#l2.1994"></a><span id="l2.1994"> }</span>
<a href="#l2.1995"></a><span id="l2.1995"> </span>
<a href="#l2.1996"></a><span id="l2.1996" class="difflineminus">-function FinishPublishing()</span>
<a href="#l2.1997"></a><span id="l2.1997" class="difflineminus">-{</span>
<a href="#l2.1998"></a><span id="l2.1998" class="difflineplus">+function FinishPublishing() {</span>
<a href="#l2.1999"></a><span id="l2.1999">   SetDocumentEditable(true);</span>
<a href="#l2.2000"></a><span id="l2.2000">   gProgressDialog = null;</span>
<a href="#l2.2001"></a><span id="l2.2001">   gPublishData = null;</span>
<a href="#l2.2002"></a><span id="l2.2002">   gRestoreDocumentSource = null;</span>
<a href="#l2.2003"></a><span id="l2.2003"> </span>
<a href="#l2.2004"></a><span id="l2.2004" class="difflineminus">-  if (gCommandAfterPublishing)</span>
<a href="#l2.2005"></a><span id="l2.2005" class="difflineminus">-  {</span>
<a href="#l2.2006"></a><span id="l2.2006" class="difflineplus">+  if (gCommandAfterPublishing) {</span>
<a href="#l2.2007"></a><span id="l2.2007">     // Be sure to null out the global now in case of trouble when executing command</span>
<a href="#l2.2008"></a><span id="l2.2008">     var command = gCommandAfterPublishing;</span>
<a href="#l2.2009"></a><span id="l2.2009">     gCommandAfterPublishing = null;</span>
<a href="#l2.2010"></a><span id="l2.2010">     goDoCommand(command);</span>
<a href="#l2.2011"></a><span id="l2.2011">   }</span>
<a href="#l2.2012"></a><span id="l2.2012"> }</span>
<a href="#l2.2013"></a><span id="l2.2013"> </span>
<a href="#l2.2014"></a><span id="l2.2014"> // Create a nsIURI object filled in with all required publishing info</span>
<a href="#l2.2015"></a><span id="l2.2015" class="difflineminus">-function CreateURIFromPublishData(publishData, doDocUri)</span>
<a href="#l2.2016"></a><span id="l2.2016" class="difflineminus">-{</span>
<a href="#l2.2017"></a><span id="l2.2017" class="difflineplus">+function CreateURIFromPublishData(publishData, doDocUri) {</span>
<a href="#l2.2018"></a><span id="l2.2018">   if (!publishData || !publishData.publishUrl)</span>
<a href="#l2.2019"></a><span id="l2.2019">     return null;</span>
<a href="#l2.2020"></a><span id="l2.2020"> </span>
<a href="#l2.2021"></a><span id="l2.2021">   var URI;</span>
<a href="#l2.2022"></a><span id="l2.2022">   try {</span>
<a href="#l2.2023"></a><span id="l2.2023">     var spec = publishData.publishUrl;</span>
<a href="#l2.2024"></a><span id="l2.2024">     if (doDocUri)</span>
<a href="#l2.2025"></a><span id="l2.2025">       spec += FormatDirForPublishing(publishData.docDir) + publishData.filename;</span>
<a href="#l2.2026"></a><span id="l2.2026" class="difflineat">@@ -1902,25 +1727,23 @@ function CreateURIFromPublishData(publis</span>
<a href="#l2.2027"></a><span id="l2.2027">       spec += FormatDirForPublishing(publishData.otherDir);</span>
<a href="#l2.2028"></a><span id="l2.2028"> </span>
<a href="#l2.2029"></a><span id="l2.2029">     URI = Services.io.newURI(spec, GetCurrentEditor().documentCharacterSet);</span>
<a href="#l2.2030"></a><span id="l2.2030"> </span>
<a href="#l2.2031"></a><span id="l2.2031">     if (publishData.username)</span>
<a href="#l2.2032"></a><span id="l2.2032">       URI.username = publishData.username;</span>
<a href="#l2.2033"></a><span id="l2.2033">     if (publishData.password)</span>
<a href="#l2.2034"></a><span id="l2.2034">       URI.password = publishData.password;</span>
<a href="#l2.2035"></a><span id="l2.2035" class="difflineminus">-  }</span>
<a href="#l2.2036"></a><span id="l2.2036" class="difflineminus">-  catch (e) {}</span>
<a href="#l2.2037"></a><span id="l2.2037" class="difflineplus">+  } catch (e) {}</span>
<a href="#l2.2038"></a><span id="l2.2038"> </span>
<a href="#l2.2039"></a><span id="l2.2039">   return URI;</span>
<a href="#l2.2040"></a><span id="l2.2040"> }</span>
<a href="#l2.2041"></a><span id="l2.2041"> </span>
<a href="#l2.2042"></a><span id="l2.2042"> // Resolve the correct &quot;http:&quot; document URL when publishing via ftp</span>
<a href="#l2.2043"></a><span id="l2.2043" class="difflineminus">-function GetDocUrlFromPublishData(publishData)</span>
<a href="#l2.2044"></a><span id="l2.2044" class="difflineminus">-{</span>
<a href="#l2.2045"></a><span id="l2.2045" class="difflineplus">+function GetDocUrlFromPublishData(publishData) {</span>
<a href="#l2.2046"></a><span id="l2.2046">   if (!publishData || !publishData.filename || !publishData.publishUrl)</span>
<a href="#l2.2047"></a><span id="l2.2047">     return &quot;&quot;;</span>
<a href="#l2.2048"></a><span id="l2.2048"> </span>
<a href="#l2.2049"></a><span id="l2.2049">   // If user was previously editing an &quot;ftp&quot; url, then keep that as the new scheme</span>
<a href="#l2.2050"></a><span id="l2.2050">   var url;</span>
<a href="#l2.2051"></a><span id="l2.2051">   var docScheme = GetScheme(GetDocumentUrl());</span>
<a href="#l2.2052"></a><span id="l2.2052"> </span>
<a href="#l2.2053"></a><span id="l2.2053">   // Always use the &quot;HTTP&quot; address if available</span>
<a href="#l2.2054"></a><span id="l2.2054" class="difflineat">@@ -1934,151 +1757,136 @@ function GetDocUrlFromPublishData(publis</span>
<a href="#l2.2055"></a><span id="l2.2055">   url += FormatDirForPublishing(publishData.docDir) + publishData.filename;</span>
<a href="#l2.2056"></a><span id="l2.2056"> </span>
<a href="#l2.2057"></a><span id="l2.2057">   if (GetScheme(url) == &quot;ftp&quot;)</span>
<a href="#l2.2058"></a><span id="l2.2058">     url = InsertUsernameIntoUrl(url, publishData.username);</span>
<a href="#l2.2059"></a><span id="l2.2059"> </span>
<a href="#l2.2060"></a><span id="l2.2060">   return url;</span>
<a href="#l2.2061"></a><span id="l2.2061"> }</span>
<a href="#l2.2062"></a><span id="l2.2062"> </span>
<a href="#l2.2063"></a><span id="l2.2063" class="difflineminus">-function SetSaveAndPublishUI(urlstring)</span>
<a href="#l2.2064"></a><span id="l2.2064" class="difflineminus">-{</span>
<a href="#l2.2065"></a><span id="l2.2065" class="difflineplus">+function SetSaveAndPublishUI(urlstring) {</span>
<a href="#l2.2066"></a><span id="l2.2066">   // Be sure enabled state of toolbar buttons are correct</span>
<a href="#l2.2067"></a><span id="l2.2067">   goUpdateCommand(&quot;cmd_save&quot;);</span>
<a href="#l2.2068"></a><span id="l2.2068">   goUpdateCommand(&quot;cmd_publish&quot;);</span>
<a href="#l2.2069"></a><span id="l2.2069"> }</span>
<a href="#l2.2070"></a><span id="l2.2070"> </span>
<a href="#l2.2071"></a><span id="l2.2071" class="difflineminus">-function SetDocumentEditable(isDocEditable)</span>
<a href="#l2.2072"></a><span id="l2.2072" class="difflineminus">-{</span>
<a href="#l2.2073"></a><span id="l2.2073" class="difflineplus">+function SetDocumentEditable(isDocEditable) {</span>
<a href="#l2.2074"></a><span id="l2.2074">   var editor = GetCurrentEditor();</span>
<a href="#l2.2075"></a><span id="l2.2075" class="difflineminus">-  if (editor &amp;&amp; editor.document)</span>
<a href="#l2.2076"></a><span id="l2.2076" class="difflineminus">-  {</span>
<a href="#l2.2077"></a><span id="l2.2077" class="difflineplus">+  if (editor &amp;&amp; editor.document) {</span>
<a href="#l2.2078"></a><span id="l2.2078">     try {</span>
<a href="#l2.2079"></a><span id="l2.2079">       var flags = editor.flags;</span>
<a href="#l2.2080"></a><span id="l2.2080">       editor.flags = isDocEditable ?</span>
<a href="#l2.2081"></a><span id="l2.2081">             flags &amp;= ~nsIPlaintextEditor.eEditorReadonlyMask :</span>
<a href="#l2.2082"></a><span id="l2.2082">             flags | nsIPlaintextEditor.eEditorReadonlyMask;</span>
<a href="#l2.2083"></a><span id="l2.2083" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.2084"></a><span id="l2.2084" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.2085"></a><span id="l2.2085"> </span>
<a href="#l2.2086"></a><span id="l2.2086">     // update all commands</span>
<a href="#l2.2087"></a><span id="l2.2087">     window.updateCommands(&quot;create&quot;);</span>
<a href="#l2.2088"></a><span id="l2.2088">   }</span>
<a href="#l2.2089"></a><span id="l2.2089"> }</span>
<a href="#l2.2090"></a><span id="l2.2090"> </span>
<a href="#l2.2091"></a><span id="l2.2091"> // ****** end of save / publish **********//</span>
<a href="#l2.2092"></a><span id="l2.2092"> </span>
<a href="#l2.2093"></a><span id="l2.2093" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2094"></a><span id="l2.2094" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2095"></a><span id="l2.2095"> var nsPublishSettingsCommand =</span>
<a href="#l2.2096"></a><span id="l2.2096"> {</span>
<a href="#l2.2097"></a><span id="l2.2097" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2098"></a><span id="l2.2098" class="difflineminus">-  {</span>
<a href="#l2.2099"></a><span id="l2.2099" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2100"></a><span id="l2.2100">     return (IsDocumentEditable());</span>
<a href="#l2.2101"></a><span id="l2.2101">   },</span>
<a href="#l2.2102"></a><span id="l2.2102"> </span>
<a href="#l2.2103"></a><span id="l2.2103" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2104"></a><span id="l2.2104" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2105"></a><span id="l2.2105" class="difflineminus">-</span>
<a href="#l2.2106"></a><span id="l2.2106" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2107"></a><span id="l2.2107" class="difflineminus">-  {</span>
<a href="#l2.2108"></a><span id="l2.2108" class="difflineminus">-    if (GetCurrentEditor())</span>
<a href="#l2.2109"></a><span id="l2.2109" class="difflineminus">-    {</span>
<a href="#l2.2110"></a><span id="l2.2110" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2111"></a><span id="l2.2111" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2112"></a><span id="l2.2112" class="difflineplus">+</span>
<a href="#l2.2113"></a><span id="l2.2113" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2114"></a><span id="l2.2114" class="difflineplus">+    if (GetCurrentEditor()) {</span>
<a href="#l2.2115"></a><span id="l2.2115">       // Launch Publish Settings dialog</span>
<a href="#l2.2116"></a><span id="l2.2116"> </span>
<a href="#l2.2117"></a><span id="l2.2117" class="difflineminus">-      window.ok = window.openDialog(&quot;chrome://editor/content/EditorPublishSettings.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.2118"></a><span id="l2.2118" class="difflineplus">+      window.ok = window.openDialog(&quot;chrome://editor/content/EditorPublishSettings.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.2119"></a><span id="l2.2119">       return window.ok;</span>
<a href="#l2.2120"></a><span id="l2.2120">     }</span>
<a href="#l2.2121"></a><span id="l2.2121">     return false;</span>
<a href="#l2.2122"></a><span id="l2.2122" class="difflineminus">-  }</span>
<a href="#l2.2123"></a><span id="l2.2123" class="difflineminus">-}</span>
<a href="#l2.2124"></a><span id="l2.2124" class="difflineminus">-</span>
<a href="#l2.2125"></a><span id="l2.2125" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2126"></a><span id="l2.2126" class="difflineplus">+  },</span>
<a href="#l2.2127"></a><span id="l2.2127" class="difflineplus">+};</span>
<a href="#l2.2128"></a><span id="l2.2128" class="difflineplus">+</span>
<a href="#l2.2129"></a><span id="l2.2129" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2130"></a><span id="l2.2130"> var nsRevertCommand =</span>
<a href="#l2.2131"></a><span id="l2.2131"> {</span>
<a href="#l2.2132"></a><span id="l2.2132" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2133"></a><span id="l2.2133" class="difflineminus">-  {</span>
<a href="#l2.2134"></a><span id="l2.2134" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2135"></a><span id="l2.2135">     return (IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.2136"></a><span id="l2.2136">             IsDocumentModified() &amp;&amp;</span>
<a href="#l2.2137"></a><span id="l2.2137">             !IsUrlAboutBlank(GetDocumentUrl()));</span>
<a href="#l2.2138"></a><span id="l2.2138">   },</span>
<a href="#l2.2139"></a><span id="l2.2139"> </span>
<a href="#l2.2140"></a><span id="l2.2140" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2141"></a><span id="l2.2141" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2142"></a><span id="l2.2142" class="difflineminus">-</span>
<a href="#l2.2143"></a><span id="l2.2143" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2144"></a><span id="l2.2144" class="difflineminus">-  {</span>
<a href="#l2.2145"></a><span id="l2.2145" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2146"></a><span id="l2.2146" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2147"></a><span id="l2.2147" class="difflineplus">+</span>
<a href="#l2.2148"></a><span id="l2.2148" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2149"></a><span id="l2.2149">     // Confirm with the user to abandon current changes</span>
<a href="#l2.2150"></a><span id="l2.2150">     // Put the page title in the message string</span>
<a href="#l2.2151"></a><span id="l2.2151">     let title = GetDocumentTitle();</span>
<a href="#l2.2152"></a><span id="l2.2152" class="difflineminus">-    let msg = GetString(&quot;AbandonChanges&quot;).replace(/%title%/,title);</span>
<a href="#l2.2153"></a><span id="l2.2153" class="difflineplus">+    let msg = GetString(&quot;AbandonChanges&quot;).replace(/%title%/, title);</span>
<a href="#l2.2154"></a><span id="l2.2154"> </span>
<a href="#l2.2155"></a><span id="l2.2155">     let result = Services.prompt.confirmEx(window, GetString(&quot;RevertCaption&quot;), msg,</span>
<a href="#l2.2156"></a><span id="l2.2156">                    (Services.prompt.BUTTON_TITLE_REVERT * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l2.2157"></a><span id="l2.2157">                    (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1),</span>
<a href="#l2.2158"></a><span id="l2.2158" class="difflineminus">-                   null, null, null, null, {value:0});</span>
<a href="#l2.2159"></a><span id="l2.2159" class="difflineplus">+                   null, null, null, null, {value: 0});</span>
<a href="#l2.2160"></a><span id="l2.2160"> </span>
<a href="#l2.2161"></a><span id="l2.2161">     // Reload page if first button (Revert) was pressed</span>
<a href="#l2.2162"></a><span id="l2.2162" class="difflineminus">-    if (result == 0)</span>
<a href="#l2.2163"></a><span id="l2.2163" class="difflineminus">-    {</span>
<a href="#l2.2164"></a><span id="l2.2164" class="difflineplus">+    if (result == 0) {</span>
<a href="#l2.2165"></a><span id="l2.2165">       CancelHTMLSource();</span>
<a href="#l2.2166"></a><span id="l2.2166">       EditorLoadUrl(GetDocumentUrl());</span>
<a href="#l2.2167"></a><span id="l2.2167">     }</span>
<a href="#l2.2168"></a><span id="l2.2168" class="difflineminus">-  }</span>
<a href="#l2.2169"></a><span id="l2.2169" class="difflineplus">+  },</span>
<a href="#l2.2170"></a><span id="l2.2170"> };</span>
<a href="#l2.2171"></a><span id="l2.2171"> </span>
<a href="#l2.2172"></a><span id="l2.2172" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2173"></a><span id="l2.2173" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2174"></a><span id="l2.2174"> var nsCloseCommand =</span>
<a href="#l2.2175"></a><span id="l2.2175"> {</span>
<a href="#l2.2176"></a><span id="l2.2176" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2177"></a><span id="l2.2177" class="difflineminus">-  {</span>
<a href="#l2.2178"></a><span id="l2.2178" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2179"></a><span id="l2.2179">     return GetCurrentEditor() != null;</span>
<a href="#l2.2180"></a><span id="l2.2180">   },</span>
<a href="#l2.2181"></a><span id="l2.2181"> </span>
<a href="#l2.2182"></a><span id="l2.2182" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2183"></a><span id="l2.2183" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2184"></a><span id="l2.2184" class="difflineminus">-</span>
<a href="#l2.2185"></a><span id="l2.2185" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2186"></a><span id="l2.2186" class="difflineminus">-  {</span>
<a href="#l2.2187"></a><span id="l2.2187" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2188"></a><span id="l2.2188" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2189"></a><span id="l2.2189" class="difflineplus">+</span>
<a href="#l2.2190"></a><span id="l2.2190" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2191"></a><span id="l2.2191">     CloseWindow();</span>
<a href="#l2.2192"></a><span id="l2.2192" class="difflineminus">-  }</span>
<a href="#l2.2193"></a><span id="l2.2193" class="difflineplus">+  },</span>
<a href="#l2.2194"></a><span id="l2.2194"> };</span>
<a href="#l2.2195"></a><span id="l2.2195"> </span>
<a href="#l2.2196"></a><span id="l2.2196" class="difflineminus">-async function CloseWindow()</span>
<a href="#l2.2197"></a><span id="l2.2197" class="difflineminus">-{</span>
<a href="#l2.2198"></a><span id="l2.2198" class="difflineplus">+async function CloseWindow() {</span>
<a href="#l2.2199"></a><span id="l2.2199">   // Check to make sure document is saved. &quot;true&quot; means allow &quot;Don't Save&quot; button,</span>
<a href="#l2.2200"></a><span id="l2.2200">   //   so user can choose to close without saving</span>
<a href="#l2.2201"></a><span id="l2.2201" class="difflineminus">-  if (await CheckAndSaveDocument(&quot;cmd_close&quot;, true))</span>
<a href="#l2.2202"></a><span id="l2.2202" class="difflineminus">-  {</span>
<a href="#l2.2203"></a><span id="l2.2203" class="difflineplus">+  if (await CheckAndSaveDocument(&quot;cmd_close&quot;, true)) {</span>
<a href="#l2.2204"></a><span id="l2.2204">     if (window.InsertCharWindow)</span>
<a href="#l2.2205"></a><span id="l2.2205">       SwitchInsertCharToAnotherEditorOrClose();</span>
<a href="#l2.2206"></a><span id="l2.2206"> </span>
<a href="#l2.2207"></a><span id="l2.2207">     try {</span>
<a href="#l2.2208"></a><span id="l2.2208">       var basewin = window.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l2.2209"></a><span id="l2.2209">                       .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l2.2210"></a><span id="l2.2210">                       .QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l2.2211"></a><span id="l2.2211">                       .treeOwner</span>
<a href="#l2.2212"></a><span id="l2.2212">                       .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l2.2213"></a><span id="l2.2213">                       .getInterface(Ci.nsIBaseWindow);</span>
<a href="#l2.2214"></a><span id="l2.2214">       basewin.destroy();</span>
<a href="#l2.2215"></a><span id="l2.2215">     } catch (e) {}</span>
<a href="#l2.2216"></a><span id="l2.2216">   }</span>
<a href="#l2.2217"></a><span id="l2.2217"> }</span>
<a href="#l2.2218"></a><span id="l2.2218"> </span>
<a href="#l2.2219"></a><span id="l2.2219" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2220"></a><span id="l2.2220" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2221"></a><span id="l2.2221"> var nsOpenRemoteCommand =</span>
<a href="#l2.2222"></a><span id="l2.2222"> {</span>
<a href="#l2.2223"></a><span id="l2.2223" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2224"></a><span id="l2.2224" class="difflineminus">-  {</span>
<a href="#l2.2225"></a><span id="l2.2225" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2226"></a><span id="l2.2226">     return true;    // we can always do this</span>
<a href="#l2.2227"></a><span id="l2.2227">   },</span>
<a href="#l2.2228"></a><span id="l2.2228"> </span>
<a href="#l2.2229"></a><span id="l2.2229" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2230"></a><span id="l2.2230" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2231"></a><span id="l2.2231" class="difflineminus">-</span>
<a href="#l2.2232"></a><span id="l2.2232" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2233"></a><span id="l2.2233" class="difflineminus">-  {</span>
<a href="#l2.2234"></a><span id="l2.2234" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2235"></a><span id="l2.2235" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2236"></a><span id="l2.2236" class="difflineplus">+</span>
<a href="#l2.2237"></a><span id="l2.2237" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2238"></a><span id="l2.2238">     var params = { action: &quot;2&quot;, url: &quot;&quot; };</span>
<a href="#l2.2239"></a><span id="l2.2239">     openDialog(&quot;chrome://communicator/content/openLocation.xul&quot;, &quot;_blank&quot;, &quot;chrome,modal,titlebar&quot;, params);</span>
<a href="#l2.2240"></a><span id="l2.2240">     var win = getTopWin();</span>
<a href="#l2.2241"></a><span id="l2.2241">     switch (params.action) {</span>
<a href="#l2.2242"></a><span id="l2.2242">       case &quot;0&quot;: // current window</span>
<a href="#l2.2243"></a><span id="l2.2243">         win.focus();</span>
<a href="#l2.2244"></a><span id="l2.2244">         win.loadURI(params.url, null, null, true);</span>
<a href="#l2.2245"></a><span id="l2.2245">         break;</span>
<a href="#l2.2246"></a><span id="l2.2246" class="difflineat">@@ -2095,1604 +1903,1438 @@ var nsOpenRemoteCommand =</span>
<a href="#l2.2247"></a><span id="l2.2247">         browser.selectedTab = browser.addTab(params.url, {allowThirdPartyFixup: true});</span>
<a href="#l2.2248"></a><span id="l2.2248">         break;</span>
<a href="#l2.2249"></a><span id="l2.2249">       case &quot;4&quot;: // private</span>
<a href="#l2.2250"></a><span id="l2.2250">         openNewPrivateWith(params.url);</span>
<a href="#l2.2251"></a><span id="l2.2251">         break;</span>
<a href="#l2.2252"></a><span id="l2.2252">       default:</span>
<a href="#l2.2253"></a><span id="l2.2253">         break;</span>
<a href="#l2.2254"></a><span id="l2.2254">     }</span>
<a href="#l2.2255"></a><span id="l2.2255" class="difflineminus">-  }</span>
<a href="#l2.2256"></a><span id="l2.2256" class="difflineplus">+  },</span>
<a href="#l2.2257"></a><span id="l2.2257"> };</span>
<a href="#l2.2258"></a><span id="l2.2258"> </span>
<a href="#l2.2259"></a><span id="l2.2259" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2260"></a><span id="l2.2260" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2261"></a><span id="l2.2261"> var nsPreviewCommand =</span>
<a href="#l2.2262"></a><span id="l2.2262"> {</span>
<a href="#l2.2263"></a><span id="l2.2263" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2264"></a><span id="l2.2264" class="difflineminus">-  {</span>
<a href="#l2.2265"></a><span id="l2.2265" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2266"></a><span id="l2.2266">     return (IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.2267"></a><span id="l2.2267">             IsHTMLEditor() &amp;&amp;</span>
<a href="#l2.2268"></a><span id="l2.2268">             (DocumentHasBeenSaved() || IsDocumentModified()));</span>
<a href="#l2.2269"></a><span id="l2.2269">   },</span>
<a href="#l2.2270"></a><span id="l2.2270"> </span>
<a href="#l2.2271"></a><span id="l2.2271" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2272"></a><span id="l2.2272" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2273"></a><span id="l2.2273" class="difflineminus">-</span>
<a href="#l2.2274"></a><span id="l2.2274" class="difflineminus">-  doCommand: async function(aCommand)</span>
<a href="#l2.2275"></a><span id="l2.2275" class="difflineminus">-  {</span>
<a href="#l2.2276"></a><span id="l2.2276" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2277"></a><span id="l2.2277" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2278"></a><span id="l2.2278" class="difflineplus">+</span>
<a href="#l2.2279"></a><span id="l2.2279" class="difflineplus">+  async doCommand(aCommand) {</span>
<a href="#l2.2280"></a><span id="l2.2280">     // Don't continue if user canceled during prompt for saving</span>
<a href="#l2.2281"></a><span id="l2.2281">     // DocumentHasBeenSaved will test if we have a URL and suppress &quot;Don't Save&quot; button if not</span>
<a href="#l2.2282"></a><span id="l2.2282">     if (!(await CheckAndSaveDocument(&quot;cmd_preview&quot;, DocumentHasBeenSaved())))</span>
<a href="#l2.2283"></a><span id="l2.2283">       return;</span>
<a href="#l2.2284"></a><span id="l2.2284"> </span>
<a href="#l2.2285"></a><span id="l2.2285">     // Check if we saved again just in case?</span>
<a href="#l2.2286"></a><span id="l2.2286" class="difflineminus">-    if (DocumentHasBeenSaved())</span>
<a href="#l2.2287"></a><span id="l2.2287" class="difflineminus">-    {</span>
<a href="#l2.2288"></a><span id="l2.2288" class="difflineplus">+    if (DocumentHasBeenSaved()) {</span>
<a href="#l2.2289"></a><span id="l2.2289">       let browser;</span>
<a href="#l2.2290"></a><span id="l2.2290">       try {</span>
<a href="#l2.2291"></a><span id="l2.2291">         // Find a browser with this URL</span>
<a href="#l2.2292"></a><span id="l2.2292">         let enumerator = Services.wm.getEnumerator(&quot;navigator:browser&quot;);</span>
<a href="#l2.2293"></a><span id="l2.2293"> </span>
<a href="#l2.2294"></a><span id="l2.2294">         var documentURI = GetDocumentUrl();</span>
<a href="#l2.2295"></a><span id="l2.2295" class="difflineminus">-        while (enumerator.hasMoreElements())</span>
<a href="#l2.2296"></a><span id="l2.2296" class="difflineminus">-        {</span>
<a href="#l2.2297"></a><span id="l2.2297" class="difflineplus">+        while (enumerator.hasMoreElements()) {</span>
<a href="#l2.2298"></a><span id="l2.2298">           browser = enumerator.getNext();</span>
<a href="#l2.2299"></a><span id="l2.2299">           if (browser &amp;&amp; (documentURI == browser.getBrowser().currentURI.spec))</span>
<a href="#l2.2300"></a><span id="l2.2300">             break;</span>
<a href="#l2.2301"></a><span id="l2.2301"> </span>
<a href="#l2.2302"></a><span id="l2.2302">           browser = null;</span>
<a href="#l2.2303"></a><span id="l2.2303">         }</span>
<a href="#l2.2304"></a><span id="l2.2304" class="difflineminus">-      }</span>
<a href="#l2.2305"></a><span id="l2.2305" class="difflineminus">-      catch (ex) {}</span>
<a href="#l2.2306"></a><span id="l2.2306" class="difflineplus">+      } catch (ex) {}</span>
<a href="#l2.2307"></a><span id="l2.2307"> </span>
<a href="#l2.2308"></a><span id="l2.2308">       // If none found, open a new browser</span>
<a href="#l2.2309"></a><span id="l2.2309" class="difflineminus">-      if (!browser)</span>
<a href="#l2.2310"></a><span id="l2.2310" class="difflineminus">-      {</span>
<a href="#l2.2311"></a><span id="l2.2311" class="difflineplus">+      if (!browser) {</span>
<a href="#l2.2312"></a><span id="l2.2312">         browser = window.openDialog(getBrowserURL(), &quot;_blank&quot;, &quot;chrome,all,dialog=no&quot;, documentURI);</span>
<a href="#l2.2313"></a><span id="l2.2313" class="difflineminus">-      }</span>
<a href="#l2.2314"></a><span id="l2.2314" class="difflineminus">-      else</span>
<a href="#l2.2315"></a><span id="l2.2315" class="difflineminus">-      {</span>
<a href="#l2.2316"></a><span id="l2.2316" class="difflineplus">+      } else {</span>
<a href="#l2.2317"></a><span id="l2.2317">         try {</span>
<a href="#l2.2318"></a><span id="l2.2318">           browser.BrowserReloadSkipCache();</span>
<a href="#l2.2319"></a><span id="l2.2319">           browser.focus();</span>
<a href="#l2.2320"></a><span id="l2.2320">         } catch (ex) {}</span>
<a href="#l2.2321"></a><span id="l2.2321">       }</span>
<a href="#l2.2322"></a><span id="l2.2322">     }</span>
<a href="#l2.2323"></a><span id="l2.2323" class="difflineminus">-  }</span>
<a href="#l2.2324"></a><span id="l2.2324" class="difflineplus">+  },</span>
<a href="#l2.2325"></a><span id="l2.2325"> };</span>
<a href="#l2.2326"></a><span id="l2.2326"> </span>
<a href="#l2.2327"></a><span id="l2.2327" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2328"></a><span id="l2.2328" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2329"></a><span id="l2.2329"> var nsSendPageCommand =</span>
<a href="#l2.2330"></a><span id="l2.2330"> {</span>
<a href="#l2.2331"></a><span id="l2.2331" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2332"></a><span id="l2.2332" class="difflineminus">-  {</span>
<a href="#l2.2333"></a><span id="l2.2333" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2334"></a><span id="l2.2334">     return (IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.2335"></a><span id="l2.2335">             (DocumentHasBeenSaved() || IsDocumentModified()));</span>
<a href="#l2.2336"></a><span id="l2.2336">   },</span>
<a href="#l2.2337"></a><span id="l2.2337"> </span>
<a href="#l2.2338"></a><span id="l2.2338" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2339"></a><span id="l2.2339" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2340"></a><span id="l2.2340" class="difflineminus">-</span>
<a href="#l2.2341"></a><span id="l2.2341" class="difflineminus">-  doCommand: async function(aCommand)</span>
<a href="#l2.2342"></a><span id="l2.2342" class="difflineminus">-  {</span>
<a href="#l2.2343"></a><span id="l2.2343" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2344"></a><span id="l2.2344" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2345"></a><span id="l2.2345" class="difflineplus">+</span>
<a href="#l2.2346"></a><span id="l2.2346" class="difflineplus">+  async doCommand(aCommand) {</span>
<a href="#l2.2347"></a><span id="l2.2347">     // Don't continue if user canceled during prompt for saving</span>
<a href="#l2.2348"></a><span id="l2.2348">     // DocumentHasBeenSaved will test if we have a URL and suppress &quot;Don't Save&quot; button if not</span>
<a href="#l2.2349"></a><span id="l2.2349">     if (!(await CheckAndSaveDocument(&quot;cmd_editSendPage&quot;, DocumentHasBeenSaved())))</span>
<a href="#l2.2350"></a><span id="l2.2350">       return;</span>
<a href="#l2.2351"></a><span id="l2.2351"> </span>
<a href="#l2.2352"></a><span id="l2.2352">     // Check if we saved again just in case?</span>
<a href="#l2.2353"></a><span id="l2.2353" class="difflineminus">-    if (DocumentHasBeenSaved())</span>
<a href="#l2.2354"></a><span id="l2.2354" class="difflineminus">-    {</span>
<a href="#l2.2355"></a><span id="l2.2355" class="difflineplus">+    if (DocumentHasBeenSaved()) {</span>
<a href="#l2.2356"></a><span id="l2.2356">       // Launch Messenger Composer window with current page as contents</span>
<a href="#l2.2357"></a><span id="l2.2357" class="difflineminus">-      try</span>
<a href="#l2.2358"></a><span id="l2.2358" class="difflineminus">-      {</span>
<a href="#l2.2359"></a><span id="l2.2359" class="difflineplus">+      try {</span>
<a href="#l2.2360"></a><span id="l2.2360">         openComposeWindow(GetDocumentUrl(), GetDocumentTitle());</span>
<a href="#l2.2361"></a><span id="l2.2361">       } catch (ex) { dump(&quot;Cannot Send Page: &quot; + ex + &quot;\n&quot;); }</span>
<a href="#l2.2362"></a><span id="l2.2362">     }</span>
<a href="#l2.2363"></a><span id="l2.2363" class="difflineminus">-  }</span>
<a href="#l2.2364"></a><span id="l2.2364" class="difflineplus">+  },</span>
<a href="#l2.2365"></a><span id="l2.2365"> };</span>
<a href="#l2.2366"></a><span id="l2.2366"> </span>
<a href="#l2.2367"></a><span id="l2.2367" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2368"></a><span id="l2.2368" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2369"></a><span id="l2.2369"> var nsPrintCommand =</span>
<a href="#l2.2370"></a><span id="l2.2370"> {</span>
<a href="#l2.2371"></a><span id="l2.2371" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2372"></a><span id="l2.2372" class="difflineminus">-  {</span>
<a href="#l2.2373"></a><span id="l2.2373" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2374"></a><span id="l2.2374">     return true;    // we can always do this</span>
<a href="#l2.2375"></a><span id="l2.2375">   },</span>
<a href="#l2.2376"></a><span id="l2.2376"> </span>
<a href="#l2.2377"></a><span id="l2.2377" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2378"></a><span id="l2.2378" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2379"></a><span id="l2.2379" class="difflineminus">-</span>
<a href="#l2.2380"></a><span id="l2.2380" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2381"></a><span id="l2.2381" class="difflineminus">-  {</span>
<a href="#l2.2382"></a><span id="l2.2382" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2383"></a><span id="l2.2383" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2384"></a><span id="l2.2384" class="difflineplus">+</span>
<a href="#l2.2385"></a><span id="l2.2385" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2386"></a><span id="l2.2386">     // In editor.js</span>
<a href="#l2.2387"></a><span id="l2.2387">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.2388"></a><span id="l2.2388">     try {</span>
<a href="#l2.2389"></a><span id="l2.2389">       let browser = GetCurrentEditorElement();</span>
<a href="#l2.2390"></a><span id="l2.2390">       PrintUtils.printWindow(browser.outerWindowID, browser);</span>
<a href="#l2.2391"></a><span id="l2.2391">     } catch (e) {}</span>
<a href="#l2.2392"></a><span id="l2.2392" class="difflineminus">-  }</span>
<a href="#l2.2393"></a><span id="l2.2393" class="difflineplus">+  },</span>
<a href="#l2.2394"></a><span id="l2.2394"> };</span>
<a href="#l2.2395"></a><span id="l2.2395"> </span>
<a href="#l2.2396"></a><span id="l2.2396" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2397"></a><span id="l2.2397" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2398"></a><span id="l2.2398"> var nsPrintPreviewCommand =</span>
<a href="#l2.2399"></a><span id="l2.2399"> {</span>
<a href="#l2.2400"></a><span id="l2.2400" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2401"></a><span id="l2.2401" class="difflineminus">-  {</span>
<a href="#l2.2402"></a><span id="l2.2402" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2403"></a><span id="l2.2403">     return true;    // we can always do this</span>
<a href="#l2.2404"></a><span id="l2.2404">   },</span>
<a href="#l2.2405"></a><span id="l2.2405"> </span>
<a href="#l2.2406"></a><span id="l2.2406" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2407"></a><span id="l2.2407" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2408"></a><span id="l2.2408" class="difflineminus">-</span>
<a href="#l2.2409"></a><span id="l2.2409" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2410"></a><span id="l2.2410" class="difflineminus">-  {</span>
<a href="#l2.2411"></a><span id="l2.2411" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2412"></a><span id="l2.2412" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2413"></a><span id="l2.2413" class="difflineplus">+</span>
<a href="#l2.2414"></a><span id="l2.2414" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2415"></a><span id="l2.2415">     // In editor.js</span>
<a href="#l2.2416"></a><span id="l2.2416">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.2417"></a><span id="l2.2417">     try {</span>
<a href="#l2.2418"></a><span id="l2.2418">       PrintUtils.printPreview(PrintPreviewListener);</span>
<a href="#l2.2419"></a><span id="l2.2419">     } catch (e) {}</span>
<a href="#l2.2420"></a><span id="l2.2420" class="difflineminus">-  }</span>
<a href="#l2.2421"></a><span id="l2.2421" class="difflineplus">+  },</span>
<a href="#l2.2422"></a><span id="l2.2422"> };</span>
<a href="#l2.2423"></a><span id="l2.2423"> </span>
<a href="#l2.2424"></a><span id="l2.2424" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2425"></a><span id="l2.2425" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2426"></a><span id="l2.2426"> var nsPrintSetupCommand =</span>
<a href="#l2.2427"></a><span id="l2.2427"> {</span>
<a href="#l2.2428"></a><span id="l2.2428" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2429"></a><span id="l2.2429" class="difflineminus">-  {</span>
<a href="#l2.2430"></a><span id="l2.2430" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2431"></a><span id="l2.2431">     return true;    // we can always do this</span>
<a href="#l2.2432"></a><span id="l2.2432">   },</span>
<a href="#l2.2433"></a><span id="l2.2433"> </span>
<a href="#l2.2434"></a><span id="l2.2434" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2435"></a><span id="l2.2435" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2436"></a><span id="l2.2436" class="difflineminus">-</span>
<a href="#l2.2437"></a><span id="l2.2437" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2438"></a><span id="l2.2438" class="difflineminus">-  {</span>
<a href="#l2.2439"></a><span id="l2.2439" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2440"></a><span id="l2.2440" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2441"></a><span id="l2.2441" class="difflineplus">+</span>
<a href="#l2.2442"></a><span id="l2.2442" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2443"></a><span id="l2.2443">     // In editor.js</span>
<a href="#l2.2444"></a><span id="l2.2444">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.2445"></a><span id="l2.2445">     PrintUtils.showPageSetup();</span>
<a href="#l2.2446"></a><span id="l2.2446" class="difflineminus">-  }</span>
<a href="#l2.2447"></a><span id="l2.2447" class="difflineplus">+  },</span>
<a href="#l2.2448"></a><span id="l2.2448"> };</span>
<a href="#l2.2449"></a><span id="l2.2449"> </span>
<a href="#l2.2450"></a><span id="l2.2450" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2451"></a><span id="l2.2451" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2452"></a><span id="l2.2452"> var nsFindReplaceCommand =</span>
<a href="#l2.2453"></a><span id="l2.2453"> {</span>
<a href="#l2.2454"></a><span id="l2.2454" class="difflineminus">-  isCommandEnabled: function(aCommand, editorElement)</span>
<a href="#l2.2455"></a><span id="l2.2455" class="difflineminus">-  {</span>
<a href="#l2.2456"></a><span id="l2.2456" class="difflineplus">+  isCommandEnabled(aCommand, editorElement) {</span>
<a href="#l2.2457"></a><span id="l2.2457">     return editorElement.getEditor(editorElement.contentWindow) != null;</span>
<a href="#l2.2458"></a><span id="l2.2458">   },</span>
<a href="#l2.2459"></a><span id="l2.2459"> </span>
<a href="#l2.2460"></a><span id="l2.2460" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2461"></a><span id="l2.2461" class="difflineminus">-  doCommandParams: function(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2462"></a><span id="l2.2462" class="difflineminus">-</span>
<a href="#l2.2463"></a><span id="l2.2463" class="difflineminus">-  doCommand: function(aCommand, editorElement)</span>
<a href="#l2.2464"></a><span id="l2.2464" class="difflineminus">-  {</span>
<a href="#l2.2465"></a><span id="l2.2465" class="difflineplus">+  getCommandStateParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2466"></a><span id="l2.2466" class="difflineplus">+  doCommandParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2467"></a><span id="l2.2467" class="difflineplus">+</span>
<a href="#l2.2468"></a><span id="l2.2468" class="difflineplus">+  doCommand(aCommand, editorElement) {</span>
<a href="#l2.2469"></a><span id="l2.2469">     window.openDialog(&quot;chrome://editor/content/EdReplace.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.2470"></a><span id="l2.2470">                       &quot;chrome,modal,titlebar&quot;, editorElement);</span>
<a href="#l2.2471"></a><span id="l2.2471" class="difflineminus">-  }</span>
<a href="#l2.2472"></a><span id="l2.2472" class="difflineplus">+  },</span>
<a href="#l2.2473"></a><span id="l2.2473"> };</span>
<a href="#l2.2474"></a><span id="l2.2474"> </span>
<a href="#l2.2475"></a><span id="l2.2475" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2476"></a><span id="l2.2476" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2477"></a><span id="l2.2477"> var nsFindCommand =</span>
<a href="#l2.2478"></a><span id="l2.2478"> {</span>
<a href="#l2.2479"></a><span id="l2.2479" class="difflineminus">-  isCommandEnabled: function(aCommand, editorElement)</span>
<a href="#l2.2480"></a><span id="l2.2480" class="difflineminus">-  {</span>
<a href="#l2.2481"></a><span id="l2.2481" class="difflineplus">+  isCommandEnabled(aCommand, editorElement) {</span>
<a href="#l2.2482"></a><span id="l2.2482">     return editorElement.getEditor(editorElement.contentWindow) != null;</span>
<a href="#l2.2483"></a><span id="l2.2483">   },</span>
<a href="#l2.2484"></a><span id="l2.2484"> </span>
<a href="#l2.2485"></a><span id="l2.2485" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2486"></a><span id="l2.2486" class="difflineminus">-  doCommandParams: function(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2487"></a><span id="l2.2487" class="difflineminus">-</span>
<a href="#l2.2488"></a><span id="l2.2488" class="difflineminus">-  doCommand: function(aCommand, editorElement)</span>
<a href="#l2.2489"></a><span id="l2.2489" class="difflineminus">-  {</span>
<a href="#l2.2490"></a><span id="l2.2490" class="difflineplus">+  getCommandStateParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2491"></a><span id="l2.2491" class="difflineplus">+  doCommandParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2492"></a><span id="l2.2492" class="difflineplus">+</span>
<a href="#l2.2493"></a><span id="l2.2493" class="difflineplus">+  doCommand(aCommand, editorElement) {</span>
<a href="#l2.2494"></a><span id="l2.2494">     document.getElementById(&quot;FindToolbar&quot;).onFindCommand();</span>
<a href="#l2.2495"></a><span id="l2.2495" class="difflineminus">-  }</span>
<a href="#l2.2496"></a><span id="l2.2496" class="difflineplus">+  },</span>
<a href="#l2.2497"></a><span id="l2.2497"> };</span>
<a href="#l2.2498"></a><span id="l2.2498"> </span>
<a href="#l2.2499"></a><span id="l2.2499" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2500"></a><span id="l2.2500" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2501"></a><span id="l2.2501"> var nsFindAgainCommand =</span>
<a href="#l2.2502"></a><span id="l2.2502"> {</span>
<a href="#l2.2503"></a><span id="l2.2503" class="difflineminus">-  isCommandEnabled: function(aCommand, editorElement)</span>
<a href="#l2.2504"></a><span id="l2.2504" class="difflineminus">-  {</span>
<a href="#l2.2505"></a><span id="l2.2505" class="difflineplus">+  isCommandEnabled(aCommand, editorElement) {</span>
<a href="#l2.2506"></a><span id="l2.2506">     // we can only do this if the search pattern is non-empty. Not sure how</span>
<a href="#l2.2507"></a><span id="l2.2507">     // to get that from here</span>
<a href="#l2.2508"></a><span id="l2.2508">     return editorElement.getEditor(editorElement.contentWindow) != null;</span>
<a href="#l2.2509"></a><span id="l2.2509">   },</span>
<a href="#l2.2510"></a><span id="l2.2510"> </span>
<a href="#l2.2511"></a><span id="l2.2511" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineminus">-  doCommandParams: function(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2513"></a><span id="l2.2513" class="difflineminus">-</span>
<a href="#l2.2514"></a><span id="l2.2514" class="difflineminus">-  doCommand: function(aCommand, editorElement)</span>
<a href="#l2.2515"></a><span id="l2.2515" class="difflineminus">-  {</span>
<a href="#l2.2516"></a><span id="l2.2516" class="difflineplus">+  getCommandStateParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2517"></a><span id="l2.2517" class="difflineplus">+  doCommandParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.2518"></a><span id="l2.2518" class="difflineplus">+</span>
<a href="#l2.2519"></a><span id="l2.2519" class="difflineplus">+  doCommand(aCommand, editorElement) {</span>
<a href="#l2.2520"></a><span id="l2.2520">     let findPrev = (aCommand == &quot;cmd_findPrev&quot;);</span>
<a href="#l2.2521"></a><span id="l2.2521">     document.getElementById(&quot;FindToolbar&quot;).onFindAgainCommand(findPrev);</span>
<a href="#l2.2522"></a><span id="l2.2522" class="difflineminus">-  }</span>
<a href="#l2.2523"></a><span id="l2.2523" class="difflineplus">+  },</span>
<a href="#l2.2524"></a><span id="l2.2524"> };</span>
<a href="#l2.2525"></a><span id="l2.2525"> </span>
<a href="#l2.2526"></a><span id="l2.2526" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2527"></a><span id="l2.2527" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2528"></a><span id="l2.2528"> var nsRewrapCommand =</span>
<a href="#l2.2529"></a><span id="l2.2529"> {</span>
<a href="#l2.2530"></a><span id="l2.2530" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2531"></a><span id="l2.2531" class="difflineminus">-  {</span>
<a href="#l2.2532"></a><span id="l2.2532" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2533"></a><span id="l2.2533">     return (IsDocumentEditable() &amp;&amp; !IsInHTMLSourceMode() &amp;&amp;</span>
<a href="#l2.2534"></a><span id="l2.2534">             GetCurrentEditor() instanceof Ci.nsIEditorMailSupport);</span>
<a href="#l2.2535"></a><span id="l2.2535">   },</span>
<a href="#l2.2536"></a><span id="l2.2536"> </span>
<a href="#l2.2537"></a><span id="l2.2537" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2538"></a><span id="l2.2538" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2539"></a><span id="l2.2539" class="difflineminus">-</span>
<a href="#l2.2540"></a><span id="l2.2540" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2541"></a><span id="l2.2541" class="difflineminus">-  {</span>
<a href="#l2.2542"></a><span id="l2.2542" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2543"></a><span id="l2.2543" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2544"></a><span id="l2.2544" class="difflineplus">+</span>
<a href="#l2.2545"></a><span id="l2.2545" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2546"></a><span id="l2.2546">     GetCurrentEditor().QueryInterface(Ci.nsIEditorMailSupport).rewrap(false);</span>
<a href="#l2.2547"></a><span id="l2.2547" class="difflineminus">-  }</span>
<a href="#l2.2548"></a><span id="l2.2548" class="difflineplus">+  },</span>
<a href="#l2.2549"></a><span id="l2.2549"> };</span>
<a href="#l2.2550"></a><span id="l2.2550"> </span>
<a href="#l2.2551"></a><span id="l2.2551" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2552"></a><span id="l2.2552" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2553"></a><span id="l2.2553"> var nsSpellingCommand =</span>
<a href="#l2.2554"></a><span id="l2.2554"> {</span>
<a href="#l2.2555"></a><span id="l2.2555" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2556"></a><span id="l2.2556" class="difflineminus">-  {</span>
<a href="#l2.2557"></a><span id="l2.2557" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2558"></a><span id="l2.2558">     return (IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.2559"></a><span id="l2.2559">             !IsInHTMLSourceMode() &amp;&amp; IsSpellCheckerInstalled());</span>
<a href="#l2.2560"></a><span id="l2.2560">   },</span>
<a href="#l2.2561"></a><span id="l2.2561"> </span>
<a href="#l2.2562"></a><span id="l2.2562" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2563"></a><span id="l2.2563" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2564"></a><span id="l2.2564" class="difflineminus">-</span>
<a href="#l2.2565"></a><span id="l2.2565" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2566"></a><span id="l2.2566" class="difflineminus">-  {</span>
<a href="#l2.2567"></a><span id="l2.2567" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2568"></a><span id="l2.2568" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2569"></a><span id="l2.2569" class="difflineplus">+</span>
<a href="#l2.2570"></a><span id="l2.2570" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2571"></a><span id="l2.2571">     window.cancelSendMessage = false;</span>
<a href="#l2.2572"></a><span id="l2.2572">     try {</span>
<a href="#l2.2573"></a><span id="l2.2573">       var skipBlockQuotes = (window.document.documentElement.getAttribute(&quot;windowtype&quot;) == &quot;msgcompose&quot;);</span>
<a href="#l2.2574"></a><span id="l2.2574">       window.openDialog(&quot;chrome://editor/content/EdSpellCheck.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.2575"></a><span id="l2.2575">               &quot;dialog,close,titlebar,modal,resizable&quot;, false, skipBlockQuotes, true);</span>
<a href="#l2.2576"></a><span id="l2.2576" class="difflineminus">-    }</span>
<a href="#l2.2577"></a><span id="l2.2577" class="difflineminus">-    catch(ex) {}</span>
<a href="#l2.2578"></a><span id="l2.2578" class="difflineminus">-  }</span>
<a href="#l2.2579"></a><span id="l2.2579" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l2.2580"></a><span id="l2.2580" class="difflineplus">+  },</span>
<a href="#l2.2581"></a><span id="l2.2581"> };</span>
<a href="#l2.2582"></a><span id="l2.2582"> </span>
<a href="#l2.2583"></a><span id="l2.2583"> // Validate using http://validator.w3.org/file-upload.html</span>
<a href="#l2.2584"></a><span id="l2.2584"> var URL2Validate;</span>
<a href="#l2.2585"></a><span id="l2.2585"> var nsValidateCommand =</span>
<a href="#l2.2586"></a><span id="l2.2586"> {</span>
<a href="#l2.2587"></a><span id="l2.2587" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2588"></a><span id="l2.2588" class="difflineminus">-  {</span>
<a href="#l2.2589"></a><span id="l2.2589" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2590"></a><span id="l2.2590">     return GetCurrentEditor() != null;</span>
<a href="#l2.2591"></a><span id="l2.2591">   },</span>
<a href="#l2.2592"></a><span id="l2.2592"> </span>
<a href="#l2.2593"></a><span id="l2.2593" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2594"></a><span id="l2.2594" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2595"></a><span id="l2.2595" class="difflineminus">-</span>
<a href="#l2.2596"></a><span id="l2.2596" class="difflineminus">-  doCommand: async function(aCommand)</span>
<a href="#l2.2597"></a><span id="l2.2597" class="difflineminus">-  {</span>
<a href="#l2.2598"></a><span id="l2.2598" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2599"></a><span id="l2.2599" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2600"></a><span id="l2.2600" class="difflineplus">+</span>
<a href="#l2.2601"></a><span id="l2.2601" class="difflineplus">+  async doCommand(aCommand) {</span>
<a href="#l2.2602"></a><span id="l2.2602">     // If the document hasn't been modified,</span>
<a href="#l2.2603"></a><span id="l2.2603">     // then just validate the current url.</span>
<a href="#l2.2604"></a><span id="l2.2604" class="difflineminus">-    if (IsDocumentModified() || IsHTMLSourceChanged())</span>
<a href="#l2.2605"></a><span id="l2.2605" class="difflineminus">-    {</span>
<a href="#l2.2606"></a><span id="l2.2606" class="difflineplus">+    if (IsDocumentModified() || IsHTMLSourceChanged()) {</span>
<a href="#l2.2607"></a><span id="l2.2607">       if (!(await CheckAndSaveDocument(&quot;cmd_validate&quot;, false)))</span>
<a href="#l2.2608"></a><span id="l2.2608">         return;</span>
<a href="#l2.2609"></a><span id="l2.2609"> </span>
<a href="#l2.2610"></a><span id="l2.2610">       // Check if we saved again just in case?</span>
<a href="#l2.2611"></a><span id="l2.2611">       if (!DocumentHasBeenSaved())    // user hit cancel?</span>
<a href="#l2.2612"></a><span id="l2.2612">         return;</span>
<a href="#l2.2613"></a><span id="l2.2613">     }</span>
<a href="#l2.2614"></a><span id="l2.2614"> </span>
<a href="#l2.2615"></a><span id="l2.2615">     URL2Validate = GetDocumentUrl();</span>
<a href="#l2.2616"></a><span id="l2.2616">     // See if it's a file:</span>
<a href="#l2.2617"></a><span id="l2.2617">     var ifile;</span>
<a href="#l2.2618"></a><span id="l2.2618">     try {</span>
<a href="#l2.2619"></a><span id="l2.2619">       var fileHandler = GetFileProtocolHandler();</span>
<a href="#l2.2620"></a><span id="l2.2620">       ifile = fileHandler.getFileFromURLSpec(URL2Validate);</span>
<a href="#l2.2621"></a><span id="l2.2621">       // nsIFile throws an exception if it's not a file url</span>
<a href="#l2.2622"></a><span id="l2.2622">     } catch (e) { ifile = null; }</span>
<a href="#l2.2623"></a><span id="l2.2623" class="difflineminus">-    if (ifile)</span>
<a href="#l2.2624"></a><span id="l2.2624" class="difflineminus">-    {</span>
<a href="#l2.2625"></a><span id="l2.2625" class="difflineplus">+    if (ifile) {</span>
<a href="#l2.2626"></a><span id="l2.2626">       URL2Validate = ifile.path;</span>
<a href="#l2.2627"></a><span id="l2.2627">       var vwin = window.open(&quot;http://validator.w3.org/file-upload.html&quot;,</span>
<a href="#l2.2628"></a><span id="l2.2628">                              &quot;EditorValidate&quot;);</span>
<a href="#l2.2629"></a><span id="l2.2629">       // Window loads asynchronously, so pass control to the load listener:</span>
<a href="#l2.2630"></a><span id="l2.2630">       vwin.addEventListener(&quot;load&quot;, this.validateFilePageLoaded);</span>
<a href="#l2.2631"></a><span id="l2.2631" class="difflineminus">-    }</span>
<a href="#l2.2632"></a><span id="l2.2632" class="difflineminus">-    else</span>
<a href="#l2.2633"></a><span id="l2.2633" class="difflineminus">-    {</span>
<a href="#l2.2634"></a><span id="l2.2634" class="difflineplus">+    } else {</span>
<a href="#l2.2635"></a><span id="l2.2635">       var vwin2 = window.open(&quot;http://validator.w3.org/check?uri=&quot;</span>
<a href="#l2.2636"></a><span id="l2.2636">                               + URL2Validate</span>
<a href="#l2.2637"></a><span id="l2.2637">                               + &quot;&amp;doctype=Inline&quot;,</span>
<a href="#l2.2638"></a><span id="l2.2638">                               &quot;EditorValidate&quot;);</span>
<a href="#l2.2639"></a><span id="l2.2639">       // This does the validation, no need to wait for page loaded.</span>
<a href="#l2.2640"></a><span id="l2.2640">     }</span>
<a href="#l2.2641"></a><span id="l2.2641">   },</span>
<a href="#l2.2642"></a><span id="l2.2642" class="difflineminus">-  validateFilePageLoaded: function(event)</span>
<a href="#l2.2643"></a><span id="l2.2643" class="difflineminus">-  {</span>
<a href="#l2.2644"></a><span id="l2.2644" class="difflineplus">+  validateFilePageLoaded(event) {</span>
<a href="#l2.2645"></a><span id="l2.2645">     event.target.forms[0].uploaded_file.value = URL2Validate;</span>
<a href="#l2.2646"></a><span id="l2.2646" class="difflineminus">-  }</span>
<a href="#l2.2647"></a><span id="l2.2647" class="difflineplus">+  },</span>
<a href="#l2.2648"></a><span id="l2.2648"> };</span>
<a href="#l2.2649"></a><span id="l2.2649"> </span>
<a href="#l2.2650"></a><span id="l2.2650"> var nsCheckLinksCommand =</span>
<a href="#l2.2651"></a><span id="l2.2651"> {</span>
<a href="#l2.2652"></a><span id="l2.2652" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2653"></a><span id="l2.2653" class="difflineminus">-  {</span>
<a href="#l2.2654"></a><span id="l2.2654" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2655"></a><span id="l2.2655">     return (IsDocumentEditable());</span>
<a href="#l2.2656"></a><span id="l2.2656">   },</span>
<a href="#l2.2657"></a><span id="l2.2657"> </span>
<a href="#l2.2658"></a><span id="l2.2658" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2659"></a><span id="l2.2659" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2660"></a><span id="l2.2660" class="difflineminus">-</span>
<a href="#l2.2661"></a><span id="l2.2661" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2662"></a><span id="l2.2662" class="difflineminus">-  {</span>
<a href="#l2.2663"></a><span id="l2.2663" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdLinkChecker.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2664"></a><span id="l2.2664" class="difflineminus">-  }</span>
<a href="#l2.2665"></a><span id="l2.2665" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2666"></a><span id="l2.2666" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2667"></a><span id="l2.2667" class="difflineplus">+</span>
<a href="#l2.2668"></a><span id="l2.2668" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2669"></a><span id="l2.2669" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EdLinkChecker.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2670"></a><span id="l2.2670" class="difflineplus">+  },</span>
<a href="#l2.2671"></a><span id="l2.2671"> };</span>
<a href="#l2.2672"></a><span id="l2.2672"> </span>
<a href="#l2.2673"></a><span id="l2.2673" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2674"></a><span id="l2.2674" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2675"></a><span id="l2.2675"> var nsFormCommand =</span>
<a href="#l2.2676"></a><span id="l2.2676"> {</span>
<a href="#l2.2677"></a><span id="l2.2677" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2678"></a><span id="l2.2678" class="difflineminus">-  {</span>
<a href="#l2.2679"></a><span id="l2.2679" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2680"></a><span id="l2.2680">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2681"></a><span id="l2.2681">   },</span>
<a href="#l2.2682"></a><span id="l2.2682"> </span>
<a href="#l2.2683"></a><span id="l2.2683" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2684"></a><span id="l2.2684" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2685"></a><span id="l2.2685" class="difflineminus">-</span>
<a href="#l2.2686"></a><span id="l2.2686" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2687"></a><span id="l2.2687" class="difflineminus">-  {</span>
<a href="#l2.2688"></a><span id="l2.2688" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2689"></a><span id="l2.2689" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2690"></a><span id="l2.2690" class="difflineplus">+</span>
<a href="#l2.2691"></a><span id="l2.2691" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2692"></a><span id="l2.2692">     window.openDialog(&quot;chrome://editor/content/EdFormProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2693"></a><span id="l2.2693" class="difflineminus">-  }</span>
<a href="#l2.2694"></a><span id="l2.2694" class="difflineplus">+  },</span>
<a href="#l2.2695"></a><span id="l2.2695"> };</span>
<a href="#l2.2696"></a><span id="l2.2696"> </span>
<a href="#l2.2697"></a><span id="l2.2697" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2698"></a><span id="l2.2698" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2699"></a><span id="l2.2699"> var nsInputTagCommand =</span>
<a href="#l2.2700"></a><span id="l2.2700"> {</span>
<a href="#l2.2701"></a><span id="l2.2701" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2702"></a><span id="l2.2702" class="difflineminus">-  {</span>
<a href="#l2.2703"></a><span id="l2.2703" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2704"></a><span id="l2.2704">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2705"></a><span id="l2.2705">   },</span>
<a href="#l2.2706"></a><span id="l2.2706"> </span>
<a href="#l2.2707"></a><span id="l2.2707" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2708"></a><span id="l2.2708" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2709"></a><span id="l2.2709" class="difflineminus">-</span>
<a href="#l2.2710"></a><span id="l2.2710" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2711"></a><span id="l2.2711" class="difflineminus">-  {</span>
<a href="#l2.2712"></a><span id="l2.2712" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2713"></a><span id="l2.2713" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2714"></a><span id="l2.2714" class="difflineplus">+</span>
<a href="#l2.2715"></a><span id="l2.2715" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2716"></a><span id="l2.2716">     window.openDialog(&quot;chrome://editor/content/EdInputProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2717"></a><span id="l2.2717" class="difflineminus">-  }</span>
<a href="#l2.2718"></a><span id="l2.2718" class="difflineplus">+  },</span>
<a href="#l2.2719"></a><span id="l2.2719"> };</span>
<a href="#l2.2720"></a><span id="l2.2720"> </span>
<a href="#l2.2721"></a><span id="l2.2721" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2722"></a><span id="l2.2722" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2723"></a><span id="l2.2723"> var nsInputImageCommand =</span>
<a href="#l2.2724"></a><span id="l2.2724"> {</span>
<a href="#l2.2725"></a><span id="l2.2725" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2726"></a><span id="l2.2726" class="difflineminus">-  {</span>
<a href="#l2.2727"></a><span id="l2.2727" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2728"></a><span id="l2.2728">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2729"></a><span id="l2.2729">   },</span>
<a href="#l2.2730"></a><span id="l2.2730"> </span>
<a href="#l2.2731"></a><span id="l2.2731" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2732"></a><span id="l2.2732" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2733"></a><span id="l2.2733" class="difflineminus">-</span>
<a href="#l2.2734"></a><span id="l2.2734" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2735"></a><span id="l2.2735" class="difflineminus">-  {</span>
<a href="#l2.2736"></a><span id="l2.2736" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2737"></a><span id="l2.2737" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2738"></a><span id="l2.2738" class="difflineplus">+</span>
<a href="#l2.2739"></a><span id="l2.2739" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2740"></a><span id="l2.2740">     window.openDialog(&quot;chrome://editor/content/EdInputImage.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2741"></a><span id="l2.2741" class="difflineminus">-  }</span>
<a href="#l2.2742"></a><span id="l2.2742" class="difflineplus">+  },</span>
<a href="#l2.2743"></a><span id="l2.2743"> };</span>
<a href="#l2.2744"></a><span id="l2.2744"> </span>
<a href="#l2.2745"></a><span id="l2.2745" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2746"></a><span id="l2.2746" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2747"></a><span id="l2.2747"> var nsTextAreaCommand =</span>
<a href="#l2.2748"></a><span id="l2.2748"> {</span>
<a href="#l2.2749"></a><span id="l2.2749" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2750"></a><span id="l2.2750" class="difflineminus">-  {</span>
<a href="#l2.2751"></a><span id="l2.2751" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2752"></a><span id="l2.2752">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2753"></a><span id="l2.2753">   },</span>
<a href="#l2.2754"></a><span id="l2.2754"> </span>
<a href="#l2.2755"></a><span id="l2.2755" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2756"></a><span id="l2.2756" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2757"></a><span id="l2.2757" class="difflineminus">-</span>
<a href="#l2.2758"></a><span id="l2.2758" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2759"></a><span id="l2.2759" class="difflineminus">-  {</span>
<a href="#l2.2760"></a><span id="l2.2760" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2761"></a><span id="l2.2761" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2762"></a><span id="l2.2762" class="difflineplus">+</span>
<a href="#l2.2763"></a><span id="l2.2763" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2764"></a><span id="l2.2764">     window.openDialog(&quot;chrome://editor/content/EdTextAreaProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2765"></a><span id="l2.2765" class="difflineminus">-  }</span>
<a href="#l2.2766"></a><span id="l2.2766" class="difflineplus">+  },</span>
<a href="#l2.2767"></a><span id="l2.2767"> };</span>
<a href="#l2.2768"></a><span id="l2.2768"> </span>
<a href="#l2.2769"></a><span id="l2.2769" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2770"></a><span id="l2.2770" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2771"></a><span id="l2.2771"> var nsSelectCommand =</span>
<a href="#l2.2772"></a><span id="l2.2772"> {</span>
<a href="#l2.2773"></a><span id="l2.2773" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2774"></a><span id="l2.2774" class="difflineminus">-  {</span>
<a href="#l2.2775"></a><span id="l2.2775" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2776"></a><span id="l2.2776">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2777"></a><span id="l2.2777">   },</span>
<a href="#l2.2778"></a><span id="l2.2778"> </span>
<a href="#l2.2779"></a><span id="l2.2779" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2780"></a><span id="l2.2780" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2781"></a><span id="l2.2781" class="difflineminus">-</span>
<a href="#l2.2782"></a><span id="l2.2782" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2783"></a><span id="l2.2783" class="difflineminus">-  {</span>
<a href="#l2.2784"></a><span id="l2.2784" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2785"></a><span id="l2.2785" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2786"></a><span id="l2.2786" class="difflineplus">+</span>
<a href="#l2.2787"></a><span id="l2.2787" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2788"></a><span id="l2.2788">     window.openDialog(&quot;chrome://editor/content/EdSelectProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2789"></a><span id="l2.2789" class="difflineminus">-  }</span>
<a href="#l2.2790"></a><span id="l2.2790" class="difflineplus">+  },</span>
<a href="#l2.2791"></a><span id="l2.2791"> };</span>
<a href="#l2.2792"></a><span id="l2.2792"> </span>
<a href="#l2.2793"></a><span id="l2.2793" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2794"></a><span id="l2.2794" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2795"></a><span id="l2.2795"> var nsButtonCommand =</span>
<a href="#l2.2796"></a><span id="l2.2796"> {</span>
<a href="#l2.2797"></a><span id="l2.2797" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2798"></a><span id="l2.2798" class="difflineminus">-  {</span>
<a href="#l2.2799"></a><span id="l2.2799" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2800"></a><span id="l2.2800">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2801"></a><span id="l2.2801">   },</span>
<a href="#l2.2802"></a><span id="l2.2802"> </span>
<a href="#l2.2803"></a><span id="l2.2803" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2804"></a><span id="l2.2804" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2805"></a><span id="l2.2805" class="difflineminus">-</span>
<a href="#l2.2806"></a><span id="l2.2806" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2807"></a><span id="l2.2807" class="difflineminus">-  {</span>
<a href="#l2.2808"></a><span id="l2.2808" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2809"></a><span id="l2.2809" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2810"></a><span id="l2.2810" class="difflineplus">+</span>
<a href="#l2.2811"></a><span id="l2.2811" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2812"></a><span id="l2.2812">     window.openDialog(&quot;chrome://editor/content/EdButtonProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2813"></a><span id="l2.2813" class="difflineminus">-  }</span>
<a href="#l2.2814"></a><span id="l2.2814" class="difflineplus">+  },</span>
<a href="#l2.2815"></a><span id="l2.2815"> };</span>
<a href="#l2.2816"></a><span id="l2.2816"> </span>
<a href="#l2.2817"></a><span id="l2.2817" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2818"></a><span id="l2.2818" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2819"></a><span id="l2.2819"> var nsLabelCommand =</span>
<a href="#l2.2820"></a><span id="l2.2820"> {</span>
<a href="#l2.2821"></a><span id="l2.2821" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2822"></a><span id="l2.2822" class="difflineminus">-  {</span>
<a href="#l2.2823"></a><span id="l2.2823" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2824"></a><span id="l2.2824">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2825"></a><span id="l2.2825">   },</span>
<a href="#l2.2826"></a><span id="l2.2826"> </span>
<a href="#l2.2827"></a><span id="l2.2827" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2828"></a><span id="l2.2828" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2829"></a><span id="l2.2829" class="difflineminus">-</span>
<a href="#l2.2830"></a><span id="l2.2830" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2831"></a><span id="l2.2831" class="difflineminus">-  {</span>
<a href="#l2.2832"></a><span id="l2.2832" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2833"></a><span id="l2.2833" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2834"></a><span id="l2.2834" class="difflineplus">+</span>
<a href="#l2.2835"></a><span id="l2.2835" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2836"></a><span id="l2.2836">     var tagName = &quot;label&quot;;</span>
<a href="#l2.2837"></a><span id="l2.2837">     try {</span>
<a href="#l2.2838"></a><span id="l2.2838">       var editor = GetCurrentEditor();</span>
<a href="#l2.2839"></a><span id="l2.2839">       // Find selected label or if start/end of selection is in label</span>
<a href="#l2.2840"></a><span id="l2.2840">       var labelElement = editor.getSelectedElement(tagName);</span>
<a href="#l2.2841"></a><span id="l2.2841">       if (!labelElement)</span>
<a href="#l2.2842"></a><span id="l2.2842">         labelElement = editor.getElementOrParentByTagName(tagName, editor.selection.anchorNode);</span>
<a href="#l2.2843"></a><span id="l2.2843">       if (!labelElement)</span>
<a href="#l2.2844"></a><span id="l2.2844">         labelElement = editor.getElementOrParentByTagName(tagName, editor.selection.focusNode);</span>
<a href="#l2.2845"></a><span id="l2.2845">       if (labelElement) {</span>
<a href="#l2.2846"></a><span id="l2.2846">         // We only open the dialog for an existing label</span>
<a href="#l2.2847"></a><span id="l2.2847">         window.openDialog(&quot;chrome://editor/content/EdLabelProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, labelElement);</span>
<a href="#l2.2848"></a><span id="l2.2848">       } else {</span>
<a href="#l2.2849"></a><span id="l2.2849">         EditorSetTextProperty(tagName, &quot;&quot;, &quot;&quot;);</span>
<a href="#l2.2850"></a><span id="l2.2850">       }</span>
<a href="#l2.2851"></a><span id="l2.2851">     } catch (e) {}</span>
<a href="#l2.2852"></a><span id="l2.2852" class="difflineminus">-  }</span>
<a href="#l2.2853"></a><span id="l2.2853" class="difflineplus">+  },</span>
<a href="#l2.2854"></a><span id="l2.2854"> };</span>
<a href="#l2.2855"></a><span id="l2.2855"> </span>
<a href="#l2.2856"></a><span id="l2.2856" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2857"></a><span id="l2.2857" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2858"></a><span id="l2.2858"> var nsFieldSetCommand =</span>
<a href="#l2.2859"></a><span id="l2.2859"> {</span>
<a href="#l2.2860"></a><span id="l2.2860" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2861"></a><span id="l2.2861" class="difflineminus">-  {</span>
<a href="#l2.2862"></a><span id="l2.2862" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2863"></a><span id="l2.2863">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2864"></a><span id="l2.2864">   },</span>
<a href="#l2.2865"></a><span id="l2.2865"> </span>
<a href="#l2.2866"></a><span id="l2.2866" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2867"></a><span id="l2.2867" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2868"></a><span id="l2.2868" class="difflineminus">-</span>
<a href="#l2.2869"></a><span id="l2.2869" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2870"></a><span id="l2.2870" class="difflineminus">-  {</span>
<a href="#l2.2871"></a><span id="l2.2871" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2872"></a><span id="l2.2872" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2873"></a><span id="l2.2873" class="difflineplus">+</span>
<a href="#l2.2874"></a><span id="l2.2874" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2875"></a><span id="l2.2875">     window.openDialog(&quot;chrome://editor/content/EdFieldSetProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2876"></a><span id="l2.2876" class="difflineminus">-  }</span>
<a href="#l2.2877"></a><span id="l2.2877" class="difflineplus">+  },</span>
<a href="#l2.2878"></a><span id="l2.2878"> };</span>
<a href="#l2.2879"></a><span id="l2.2879"> </span>
<a href="#l2.2880"></a><span id="l2.2880" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2881"></a><span id="l2.2881" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2882"></a><span id="l2.2882"> var nsIsIndexCommand =</span>
<a href="#l2.2883"></a><span id="l2.2883"> {</span>
<a href="#l2.2884"></a><span id="l2.2884" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2885"></a><span id="l2.2885" class="difflineminus">-  {</span>
<a href="#l2.2886"></a><span id="l2.2886" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2887"></a><span id="l2.2887">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2888"></a><span id="l2.2888">   },</span>
<a href="#l2.2889"></a><span id="l2.2889"> </span>
<a href="#l2.2890"></a><span id="l2.2890" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2891"></a><span id="l2.2891" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2892"></a><span id="l2.2892" class="difflineminus">-</span>
<a href="#l2.2893"></a><span id="l2.2893" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2894"></a><span id="l2.2894" class="difflineminus">-  {</span>
<a href="#l2.2895"></a><span id="l2.2895" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2896"></a><span id="l2.2896" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2897"></a><span id="l2.2897" class="difflineplus">+</span>
<a href="#l2.2898"></a><span id="l2.2898" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2899"></a><span id="l2.2899">     try {</span>
<a href="#l2.2900"></a><span id="l2.2900">       var editor = GetCurrentEditor();</span>
<a href="#l2.2901"></a><span id="l2.2901">       var isindexElement = editor.createElementWithDefaults(&quot;isindex&quot;);</span>
<a href="#l2.2902"></a><span id="l2.2902">       isindexElement.setAttribute(&quot;prompt&quot;, editor.outputToString(&quot;text/plain&quot;, kOutputSelectionOnly));</span>
<a href="#l2.2903"></a><span id="l2.2903">       editor.insertElementAtSelection(isindexElement, true);</span>
<a href="#l2.2904"></a><span id="l2.2904">     } catch (e) {}</span>
<a href="#l2.2905"></a><span id="l2.2905" class="difflineminus">-  }</span>
<a href="#l2.2906"></a><span id="l2.2906" class="difflineplus">+  },</span>
<a href="#l2.2907"></a><span id="l2.2907"> };</span>
<a href="#l2.2908"></a><span id="l2.2908"> </span>
<a href="#l2.2909"></a><span id="l2.2909" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2910"></a><span id="l2.2910" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2911"></a><span id="l2.2911"> var nsImageCommand =</span>
<a href="#l2.2912"></a><span id="l2.2912"> {</span>
<a href="#l2.2913"></a><span id="l2.2913" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2914"></a><span id="l2.2914" class="difflineminus">-  {</span>
<a href="#l2.2915"></a><span id="l2.2915" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2916"></a><span id="l2.2916">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2917"></a><span id="l2.2917">   },</span>
<a href="#l2.2918"></a><span id="l2.2918"> </span>
<a href="#l2.2919"></a><span id="l2.2919" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2920"></a><span id="l2.2920" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2921"></a><span id="l2.2921" class="difflineminus">-</span>
<a href="#l2.2922"></a><span id="l2.2922" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2923"></a><span id="l2.2923" class="difflineminus">-  {</span>
<a href="#l2.2924"></a><span id="l2.2924" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdImageProps.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2925"></a><span id="l2.2925" class="difflineminus">-  }</span>
<a href="#l2.2926"></a><span id="l2.2926" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2927"></a><span id="l2.2927" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2928"></a><span id="l2.2928" class="difflineplus">+</span>
<a href="#l2.2929"></a><span id="l2.2929" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2930"></a><span id="l2.2930" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EdImageProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2931"></a><span id="l2.2931" class="difflineplus">+  },</span>
<a href="#l2.2932"></a><span id="l2.2932"> };</span>
<a href="#l2.2933"></a><span id="l2.2933"> </span>
<a href="#l2.2934"></a><span id="l2.2934" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.2935"></a><span id="l2.2935" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.2936"></a><span id="l2.2936"> var nsHLineCommand =</span>
<a href="#l2.2937"></a><span id="l2.2937"> {</span>
<a href="#l2.2938"></a><span id="l2.2938" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.2939"></a><span id="l2.2939" class="difflineminus">-  {</span>
<a href="#l2.2940"></a><span id="l2.2940" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2941"></a><span id="l2.2941">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2942"></a><span id="l2.2942">   },</span>
<a href="#l2.2943"></a><span id="l2.2943"> </span>
<a href="#l2.2944"></a><span id="l2.2944" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2945"></a><span id="l2.2945" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2946"></a><span id="l2.2946" class="difflineminus">-</span>
<a href="#l2.2947"></a><span id="l2.2947" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.2948"></a><span id="l2.2948" class="difflineminus">-  {</span>
<a href="#l2.2949"></a><span id="l2.2949" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2950"></a><span id="l2.2950" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2951"></a><span id="l2.2951" class="difflineplus">+</span>
<a href="#l2.2952"></a><span id="l2.2952" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.2953"></a><span id="l2.2953">     // Inserting an HLine is different in that we don't use properties dialog</span>
<a href="#l2.2954"></a><span id="l2.2954">     //  unless we are editing an existing line's attributes</span>
<a href="#l2.2955"></a><span id="l2.2955">     //  We get the last-used attributes from the prefs and insert immediately</span>
<a href="#l2.2956"></a><span id="l2.2956"> </span>
<a href="#l2.2957"></a><span id="l2.2957">     var tagName = &quot;hr&quot;;</span>
<a href="#l2.2958"></a><span id="l2.2958">     var editor = GetCurrentEditor();</span>
<a href="#l2.2959"></a><span id="l2.2959"> </span>
<a href="#l2.2960"></a><span id="l2.2960">     var hLine;</span>
<a href="#l2.2961"></a><span id="l2.2961">     try {</span>
<a href="#l2.2962"></a><span id="l2.2962">       hLine = editor.getSelectedElement(tagName);</span>
<a href="#l2.2963"></a><span id="l2.2963" class="difflineminus">-    } catch (e) {return;}</span>
<a href="#l2.2964"></a><span id="l2.2964" class="difflineminus">-</span>
<a href="#l2.2965"></a><span id="l2.2965" class="difflineminus">-    if (hLine)</span>
<a href="#l2.2966"></a><span id="l2.2966" class="difflineminus">-    {</span>
<a href="#l2.2967"></a><span id="l2.2967" class="difflineplus">+    } catch (e) { return; }</span>
<a href="#l2.2968"></a><span id="l2.2968" class="difflineplus">+</span>
<a href="#l2.2969"></a><span id="l2.2969" class="difflineplus">+    if (hLine) {</span>
<a href="#l2.2970"></a><span id="l2.2970">       // We only open the dialog for an existing HRule</span>
<a href="#l2.2971"></a><span id="l2.2971">       window.openDialog(&quot;chrome://editor/content/EdHLineProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2972"></a><span id="l2.2972" class="difflineminus">-    }</span>
<a href="#l2.2973"></a><span id="l2.2973" class="difflineminus">-    else</span>
<a href="#l2.2974"></a><span id="l2.2974" class="difflineminus">-    {</span>
<a href="#l2.2975"></a><span id="l2.2975" class="difflineplus">+    } else {</span>
<a href="#l2.2976"></a><span id="l2.2976">       try {</span>
<a href="#l2.2977"></a><span id="l2.2977">         hLine = editor.createElementWithDefaults(tagName);</span>
<a href="#l2.2978"></a><span id="l2.2978"> </span>
<a href="#l2.2979"></a><span id="l2.2979">         // We change the default attributes to those saved in the user prefs</span>
<a href="#l2.2980"></a><span id="l2.2980">         let align = Services.prefs.getIntPref(&quot;editor.hrule.align&quot;);</span>
<a href="#l2.2981"></a><span id="l2.2981">         if (align == 0)</span>
<a href="#l2.2982"></a><span id="l2.2982">           editor.setAttributeOrEquivalent(hLine, &quot;align&quot;, &quot;left&quot;, true);</span>
<a href="#l2.2983"></a><span id="l2.2983">         else if (align == 2)</span>
<a href="#l2.2984"></a><span id="l2.2984">           editor.setAttributeOrEquivalent(hLine, &quot;align&quot;, &quot;right&quot;, true);</span>
<a href="#l2.2985"></a><span id="l2.2985"> </span>
<a href="#l2.2986"></a><span id="l2.2986" class="difflineminus">-        //Note: Default is center (don't write attribute)</span>
<a href="#l2.2987"></a><span id="l2.2987" class="difflineplus">+        // Note: Default is center (don't write attribute)</span>
<a href="#l2.2988"></a><span id="l2.2988"> </span>
<a href="#l2.2989"></a><span id="l2.2989">         let width = Services.prefs.getIntPref(&quot;editor.hrule.width&quot;);</span>
<a href="#l2.2990"></a><span id="l2.2990">         if (Services.prefs.getBoolPref(&quot;editor.hrule.width_percent&quot;))</span>
<a href="#l2.2991"></a><span id="l2.2991" class="difflineminus">-          width = width +&quot;%&quot;;</span>
<a href="#l2.2992"></a><span id="l2.2992" class="difflineplus">+          width = width + &quot;%&quot;;</span>
<a href="#l2.2993"></a><span id="l2.2993"> </span>
<a href="#l2.2994"></a><span id="l2.2994">         editor.setAttributeOrEquivalent(hLine, &quot;width&quot;, width, true);</span>
<a href="#l2.2995"></a><span id="l2.2995"> </span>
<a href="#l2.2996"></a><span id="l2.2996">         let height = Services.prefs.getIntPref(&quot;editor.hrule.height&quot;);</span>
<a href="#l2.2997"></a><span id="l2.2997">         editor.setAttributeOrEquivalent(hLine, &quot;size&quot;, String(height), true);</span>
<a href="#l2.2998"></a><span id="l2.2998"> </span>
<a href="#l2.2999"></a><span id="l2.2999">         if (Services.prefs.getBoolPref(&quot;editor.hrule.shading&quot;))</span>
<a href="#l2.3000"></a><span id="l2.3000">           hLine.removeAttribute(&quot;noshade&quot;);</span>
<a href="#l2.3001"></a><span id="l2.3001">         else</span>
<a href="#l2.3002"></a><span id="l2.3002">           hLine.setAttribute(&quot;noshade&quot;, &quot;noshade&quot;);</span>
<a href="#l2.3003"></a><span id="l2.3003"> </span>
<a href="#l2.3004"></a><span id="l2.3004">         editor.insertElementAtSelection(hLine, true);</span>
<a href="#l2.3005"></a><span id="l2.3005" class="difflineminus">-</span>
<a href="#l2.3006"></a><span id="l2.3006">       } catch (e) {}</span>
<a href="#l2.3007"></a><span id="l2.3007">     }</span>
<a href="#l2.3008"></a><span id="l2.3008" class="difflineminus">-  }</span>
<a href="#l2.3009"></a><span id="l2.3009" class="difflineplus">+  },</span>
<a href="#l2.3010"></a><span id="l2.3010"> };</span>
<a href="#l2.3011"></a><span id="l2.3011"> </span>
<a href="#l2.3012"></a><span id="l2.3012" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3013"></a><span id="l2.3013" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3014"></a><span id="l2.3014"> var nsLinkCommand =</span>
<a href="#l2.3015"></a><span id="l2.3015"> {</span>
<a href="#l2.3016"></a><span id="l2.3016" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3017"></a><span id="l2.3017" class="difflineminus">-  {</span>
<a href="#l2.3018"></a><span id="l2.3018" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3019"></a><span id="l2.3019">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3020"></a><span id="l2.3020">   },</span>
<a href="#l2.3021"></a><span id="l2.3021"> </span>
<a href="#l2.3022"></a><span id="l2.3022" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3023"></a><span id="l2.3023" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3024"></a><span id="l2.3024" class="difflineminus">-</span>
<a href="#l2.3025"></a><span id="l2.3025" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3026"></a><span id="l2.3026" class="difflineminus">-  {</span>
<a href="#l2.3027"></a><span id="l2.3027" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3028"></a><span id="l2.3028" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3029"></a><span id="l2.3029" class="difflineplus">+</span>
<a href="#l2.3030"></a><span id="l2.3030" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3031"></a><span id="l2.3031">     // If selected element is an image, launch that dialog instead</span>
<a href="#l2.3032"></a><span id="l2.3032">     // since last tab panel handles link around an image</span>
<a href="#l2.3033"></a><span id="l2.3033">     var element = GetObjectForProperties();</span>
<a href="#l2.3034"></a><span id="l2.3034">     if (element &amp;&amp; element.nodeName.toLowerCase() == &quot;img&quot;)</span>
<a href="#l2.3035"></a><span id="l2.3035" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdImageProps.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, null, true);</span>
<a href="#l2.3036"></a><span id="l2.3036" class="difflineplus">+      window.openDialog(&quot;chrome://editor/content/EdImageProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, null, true);</span>
<a href="#l2.3037"></a><span id="l2.3037">     else</span>
<a href="#l2.3038"></a><span id="l2.3038" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdLinkProps.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.3039"></a><span id="l2.3039" class="difflineminus">-  }</span>
<a href="#l2.3040"></a><span id="l2.3040" class="difflineplus">+      window.openDialog(&quot;chrome://editor/content/EdLinkProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.3041"></a><span id="l2.3041" class="difflineplus">+  },</span>
<a href="#l2.3042"></a><span id="l2.3042"> };</span>
<a href="#l2.3043"></a><span id="l2.3043"> </span>
<a href="#l2.3044"></a><span id="l2.3044" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3045"></a><span id="l2.3045" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3046"></a><span id="l2.3046"> var nsAnchorCommand =</span>
<a href="#l2.3047"></a><span id="l2.3047"> {</span>
<a href="#l2.3048"></a><span id="l2.3048" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3049"></a><span id="l2.3049" class="difflineminus">-  {</span>
<a href="#l2.3050"></a><span id="l2.3050" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3051"></a><span id="l2.3051">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3052"></a><span id="l2.3052">   },</span>
<a href="#l2.3053"></a><span id="l2.3053"> </span>
<a href="#l2.3054"></a><span id="l2.3054" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3055"></a><span id="l2.3055" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3056"></a><span id="l2.3056" class="difflineminus">-</span>
<a href="#l2.3057"></a><span id="l2.3057" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3058"></a><span id="l2.3058" class="difflineminus">-  {</span>
<a href="#l2.3059"></a><span id="l2.3059" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3060"></a><span id="l2.3060" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3061"></a><span id="l2.3061" class="difflineplus">+</span>
<a href="#l2.3062"></a><span id="l2.3062" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3063"></a><span id="l2.3063">     window.openDialog(&quot;chrome://editor/content/EdNamedAnchorProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.3064"></a><span id="l2.3064" class="difflineminus">-  }</span>
<a href="#l2.3065"></a><span id="l2.3065" class="difflineplus">+  },</span>
<a href="#l2.3066"></a><span id="l2.3066"> };</span>
<a href="#l2.3067"></a><span id="l2.3067"> </span>
<a href="#l2.3068"></a><span id="l2.3068" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3069"></a><span id="l2.3069" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3070"></a><span id="l2.3070"> var nsInsertHTMLWithDialogCommand =</span>
<a href="#l2.3071"></a><span id="l2.3071"> {</span>
<a href="#l2.3072"></a><span id="l2.3072" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3073"></a><span id="l2.3073" class="difflineminus">-  {</span>
<a href="#l2.3074"></a><span id="l2.3074" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3075"></a><span id="l2.3075">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3076"></a><span id="l2.3076">   },</span>
<a href="#l2.3077"></a><span id="l2.3077"> </span>
<a href="#l2.3078"></a><span id="l2.3078" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3079"></a><span id="l2.3079" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3080"></a><span id="l2.3080" class="difflineminus">-</span>
<a href="#l2.3081"></a><span id="l2.3081" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3082"></a><span id="l2.3082" class="difflineminus">-  {</span>
<a href="#l2.3083"></a><span id="l2.3083" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdInsSrc.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable&quot;, &quot;&quot;);</span>
<a href="#l2.3084"></a><span id="l2.3084" class="difflineminus">-  }</span>
<a href="#l2.3085"></a><span id="l2.3085" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3086"></a><span id="l2.3086" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3087"></a><span id="l2.3087" class="difflineplus">+</span>
<a href="#l2.3088"></a><span id="l2.3088" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3089"></a><span id="l2.3089" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EdInsSrc.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable&quot;, &quot;&quot;);</span>
<a href="#l2.3090"></a><span id="l2.3090" class="difflineplus">+  },</span>
<a href="#l2.3091"></a><span id="l2.3091"> };</span>
<a href="#l2.3092"></a><span id="l2.3092"> </span>
<a href="#l2.3093"></a><span id="l2.3093" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3094"></a><span id="l2.3094" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3095"></a><span id="l2.3095"> var nsInsertMathWithDialogCommand =</span>
<a href="#l2.3096"></a><span id="l2.3096"> {</span>
<a href="#l2.3097"></a><span id="l2.3097" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3098"></a><span id="l2.3098" class="difflineminus">-  {</span>
<a href="#l2.3099"></a><span id="l2.3099" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3100"></a><span id="l2.3100">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3101"></a><span id="l2.3101">   },</span>
<a href="#l2.3102"></a><span id="l2.3102"> </span>
<a href="#l2.3103"></a><span id="l2.3103" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3104"></a><span id="l2.3104" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3105"></a><span id="l2.3105" class="difflineminus">-</span>
<a href="#l2.3106"></a><span id="l2.3106" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3107"></a><span id="l2.3107" class="difflineminus">-  {</span>
<a href="#l2.3108"></a><span id="l2.3108" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3109"></a><span id="l2.3109" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3110"></a><span id="l2.3110" class="difflineplus">+</span>
<a href="#l2.3111"></a><span id="l2.3111" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3112"></a><span id="l2.3112">     window.openDialog(&quot;chrome://editor/content/EdInsertMath.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable&quot;, &quot;&quot;);</span>
<a href="#l2.3113"></a><span id="l2.3113" class="difflineminus">-  }</span>
<a href="#l2.3114"></a><span id="l2.3114" class="difflineplus">+  },</span>
<a href="#l2.3115"></a><span id="l2.3115"> };</span>
<a href="#l2.3116"></a><span id="l2.3116"> </span>
<a href="#l2.3117"></a><span id="l2.3117" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3118"></a><span id="l2.3118" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3119"></a><span id="l2.3119"> var nsInsertCharsCommand =</span>
<a href="#l2.3120"></a><span id="l2.3120"> {</span>
<a href="#l2.3121"></a><span id="l2.3121" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3122"></a><span id="l2.3122" class="difflineminus">-  {</span>
<a href="#l2.3123"></a><span id="l2.3123" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3124"></a><span id="l2.3124">     return (IsDocumentEditable());</span>
<a href="#l2.3125"></a><span id="l2.3125">   },</span>
<a href="#l2.3126"></a><span id="l2.3126"> </span>
<a href="#l2.3127"></a><span id="l2.3127" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3128"></a><span id="l2.3128" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3129"></a><span id="l2.3129" class="difflineminus">-</span>
<a href="#l2.3130"></a><span id="l2.3130" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3131"></a><span id="l2.3131" class="difflineminus">-  {</span>
<a href="#l2.3132"></a><span id="l2.3132" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3133"></a><span id="l2.3133" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3134"></a><span id="l2.3134" class="difflineplus">+</span>
<a href="#l2.3135"></a><span id="l2.3135" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3136"></a><span id="l2.3136">     EditorFindOrCreateInsertCharWindow();</span>
<a href="#l2.3137"></a><span id="l2.3137" class="difflineminus">-  }</span>
<a href="#l2.3138"></a><span id="l2.3138" class="difflineplus">+  },</span>
<a href="#l2.3139"></a><span id="l2.3139"> };</span>
<a href="#l2.3140"></a><span id="l2.3140"> </span>
<a href="#l2.3141"></a><span id="l2.3141" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3142"></a><span id="l2.3142" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3143"></a><span id="l2.3143"> var nsInsertBreakCommand =</span>
<a href="#l2.3144"></a><span id="l2.3144"> {</span>
<a href="#l2.3145"></a><span id="l2.3145" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3146"></a><span id="l2.3146" class="difflineminus">-  {</span>
<a href="#l2.3147"></a><span id="l2.3147" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3148"></a><span id="l2.3148">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3149"></a><span id="l2.3149">   },</span>
<a href="#l2.3150"></a><span id="l2.3150"> </span>
<a href="#l2.3151"></a><span id="l2.3151" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3152"></a><span id="l2.3152" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3153"></a><span id="l2.3153" class="difflineminus">-</span>
<a href="#l2.3154"></a><span id="l2.3154" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3155"></a><span id="l2.3155" class="difflineminus">-  {</span>
<a href="#l2.3156"></a><span id="l2.3156" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3157"></a><span id="l2.3157" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3158"></a><span id="l2.3158" class="difflineplus">+</span>
<a href="#l2.3159"></a><span id="l2.3159" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3160"></a><span id="l2.3160">     try {</span>
<a href="#l2.3161"></a><span id="l2.3161">       GetCurrentEditor().insertHTML(&quot;&lt;br&gt;&quot;);</span>
<a href="#l2.3162"></a><span id="l2.3162">     } catch (e) {}</span>
<a href="#l2.3163"></a><span id="l2.3163" class="difflineminus">-  }</span>
<a href="#l2.3164"></a><span id="l2.3164" class="difflineplus">+  },</span>
<a href="#l2.3165"></a><span id="l2.3165"> };</span>
<a href="#l2.3166"></a><span id="l2.3166"> </span>
<a href="#l2.3167"></a><span id="l2.3167" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3168"></a><span id="l2.3168" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3169"></a><span id="l2.3169"> var nsInsertBreakAllCommand =</span>
<a href="#l2.3170"></a><span id="l2.3170"> {</span>
<a href="#l2.3171"></a><span id="l2.3171" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3172"></a><span id="l2.3172" class="difflineminus">-  {</span>
<a href="#l2.3173"></a><span id="l2.3173" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3174"></a><span id="l2.3174">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3175"></a><span id="l2.3175">   },</span>
<a href="#l2.3176"></a><span id="l2.3176"> </span>
<a href="#l2.3177"></a><span id="l2.3177" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3178"></a><span id="l2.3178" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3179"></a><span id="l2.3179" class="difflineminus">-</span>
<a href="#l2.3180"></a><span id="l2.3180" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3181"></a><span id="l2.3181" class="difflineminus">-  {</span>
<a href="#l2.3182"></a><span id="l2.3182" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3183"></a><span id="l2.3183" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3184"></a><span id="l2.3184" class="difflineplus">+</span>
<a href="#l2.3185"></a><span id="l2.3185" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3186"></a><span id="l2.3186">     try {</span>
<a href="#l2.3187"></a><span id="l2.3187">       GetCurrentEditor().insertHTML(&quot;&lt;br clear='all'&gt;&quot;);</span>
<a href="#l2.3188"></a><span id="l2.3188">     } catch (e) {}</span>
<a href="#l2.3189"></a><span id="l2.3189" class="difflineminus">-  }</span>
<a href="#l2.3190"></a><span id="l2.3190" class="difflineplus">+  },</span>
<a href="#l2.3191"></a><span id="l2.3191"> };</span>
<a href="#l2.3192"></a><span id="l2.3192"> </span>
<a href="#l2.3193"></a><span id="l2.3193" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3194"></a><span id="l2.3194" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3195"></a><span id="l2.3195"> var nsGridCommand =</span>
<a href="#l2.3196"></a><span id="l2.3196"> {</span>
<a href="#l2.3197"></a><span id="l2.3197" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3198"></a><span id="l2.3198" class="difflineminus">-  {</span>
<a href="#l2.3199"></a><span id="l2.3199" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3200"></a><span id="l2.3200">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3201"></a><span id="l2.3201">   },</span>
<a href="#l2.3202"></a><span id="l2.3202"> </span>
<a href="#l2.3203"></a><span id="l2.3203" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3204"></a><span id="l2.3204" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3205"></a><span id="l2.3205" class="difflineminus">-</span>
<a href="#l2.3206"></a><span id="l2.3206" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3207"></a><span id="l2.3207" class="difflineminus">-  {</span>
<a href="#l2.3208"></a><span id="l2.3208" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdSnapToGrid.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.3209"></a><span id="l2.3209" class="difflineminus">-  }</span>
<a href="#l2.3210"></a><span id="l2.3210" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3211"></a><span id="l2.3211" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3212"></a><span id="l2.3212" class="difflineplus">+</span>
<a href="#l2.3213"></a><span id="l2.3213" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3214"></a><span id="l2.3214" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EdSnapToGrid.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.3215"></a><span id="l2.3215" class="difflineplus">+  },</span>
<a href="#l2.3216"></a><span id="l2.3216"> };</span>
<a href="#l2.3217"></a><span id="l2.3217"> </span>
<a href="#l2.3218"></a><span id="l2.3218"> </span>
<a href="#l2.3219"></a><span id="l2.3219" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3220"></a><span id="l2.3220" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3221"></a><span id="l2.3221"> var nsListPropertiesCommand =</span>
<a href="#l2.3222"></a><span id="l2.3222"> {</span>
<a href="#l2.3223"></a><span id="l2.3223" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3224"></a><span id="l2.3224" class="difflineminus">-  {</span>
<a href="#l2.3225"></a><span id="l2.3225" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3226"></a><span id="l2.3226">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3227"></a><span id="l2.3227">   },</span>
<a href="#l2.3228"></a><span id="l2.3228"> </span>
<a href="#l2.3229"></a><span id="l2.3229" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3230"></a><span id="l2.3230" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3231"></a><span id="l2.3231" class="difflineminus">-</span>
<a href="#l2.3232"></a><span id="l2.3232" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3233"></a><span id="l2.3233" class="difflineminus">-  {</span>
<a href="#l2.3234"></a><span id="l2.3234" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdListProps.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.3235"></a><span id="l2.3235" class="difflineminus">-  }</span>
<a href="#l2.3236"></a><span id="l2.3236" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3237"></a><span id="l2.3237" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3238"></a><span id="l2.3238" class="difflineplus">+</span>
<a href="#l2.3239"></a><span id="l2.3239" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3240"></a><span id="l2.3240" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EdListProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.3241"></a><span id="l2.3241" class="difflineplus">+  },</span>
<a href="#l2.3242"></a><span id="l2.3242"> };</span>
<a href="#l2.3243"></a><span id="l2.3243"> </span>
<a href="#l2.3244"></a><span id="l2.3244"> </span>
<a href="#l2.3245"></a><span id="l2.3245" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3246"></a><span id="l2.3246" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3247"></a><span id="l2.3247"> var nsPagePropertiesCommand =</span>
<a href="#l2.3248"></a><span id="l2.3248"> {</span>
<a href="#l2.3249"></a><span id="l2.3249" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3250"></a><span id="l2.3250" class="difflineminus">-  {</span>
<a href="#l2.3251"></a><span id="l2.3251" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3252"></a><span id="l2.3252">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3253"></a><span id="l2.3253">   },</span>
<a href="#l2.3254"></a><span id="l2.3254"> </span>
<a href="#l2.3255"></a><span id="l2.3255" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3256"></a><span id="l2.3256" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3257"></a><span id="l2.3257" class="difflineminus">-</span>
<a href="#l2.3258"></a><span id="l2.3258" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3259"></a><span id="l2.3259" class="difflineminus">-  {</span>
<a href="#l2.3260"></a><span id="l2.3260" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3261"></a><span id="l2.3261" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3262"></a><span id="l2.3262" class="difflineplus">+</span>
<a href="#l2.3263"></a><span id="l2.3263" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3264"></a><span id="l2.3264">     var oldTitle = GetDocumentTitle();</span>
<a href="#l2.3265"></a><span id="l2.3265" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdPageProps.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.3266"></a><span id="l2.3266" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EdPageProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.3267"></a><span id="l2.3267"> </span>
<a href="#l2.3268"></a><span id="l2.3268">     // Update main window title and</span>
<a href="#l2.3269"></a><span id="l2.3269">     // recent menu data in prefs if doc title changed</span>
<a href="#l2.3270"></a><span id="l2.3270">     if (GetDocumentTitle() != oldTitle)</span>
<a href="#l2.3271"></a><span id="l2.3271">       UpdateWindowTitle();</span>
<a href="#l2.3272"></a><span id="l2.3272" class="difflineminus">-  }</span>
<a href="#l2.3273"></a><span id="l2.3273" class="difflineplus">+  },</span>
<a href="#l2.3274"></a><span id="l2.3274"> };</span>
<a href="#l2.3275"></a><span id="l2.3275"> </span>
<a href="#l2.3276"></a><span id="l2.3276" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3277"></a><span id="l2.3277" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3278"></a><span id="l2.3278"> var nsObjectPropertiesCommand =</span>
<a href="#l2.3279"></a><span id="l2.3279"> {</span>
<a href="#l2.3280"></a><span id="l2.3280" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3281"></a><span id="l2.3281" class="difflineminus">-  {</span>
<a href="#l2.3282"></a><span id="l2.3282" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3283"></a><span id="l2.3283">     var isEnabled = false;</span>
<a href="#l2.3284"></a><span id="l2.3284" class="difflineminus">-    if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML())</span>
<a href="#l2.3285"></a><span id="l2.3285" class="difflineminus">-    {</span>
<a href="#l2.3286"></a><span id="l2.3286" class="difflineplus">+    if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()) {</span>
<a href="#l2.3287"></a><span id="l2.3287">       isEnabled = (GetObjectForProperties() != null ||</span>
<a href="#l2.3288"></a><span id="l2.3288">                    GetCurrentEditor().getSelectedElement(&quot;href&quot;) != null);</span>
<a href="#l2.3289"></a><span id="l2.3289">     }</span>
<a href="#l2.3290"></a><span id="l2.3290">     return isEnabled;</span>
<a href="#l2.3291"></a><span id="l2.3291">   },</span>
<a href="#l2.3292"></a><span id="l2.3292"> </span>
<a href="#l2.3293"></a><span id="l2.3293" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3294"></a><span id="l2.3294" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3295"></a><span id="l2.3295" class="difflineminus">-</span>
<a href="#l2.3296"></a><span id="l2.3296" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3297"></a><span id="l2.3297" class="difflineminus">-  {</span>
<a href="#l2.3298"></a><span id="l2.3298" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3299"></a><span id="l2.3299" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3300"></a><span id="l2.3300" class="difflineplus">+</span>
<a href="#l2.3301"></a><span id="l2.3301" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3302"></a><span id="l2.3302">     // Launch Object properties for appropriate selected element</span>
<a href="#l2.3303"></a><span id="l2.3303">     var element = GetObjectForProperties();</span>
<a href="#l2.3304"></a><span id="l2.3304" class="difflineminus">-    if (element)</span>
<a href="#l2.3305"></a><span id="l2.3305" class="difflineminus">-    {</span>
<a href="#l2.3306"></a><span id="l2.3306" class="difflineplus">+    if (element) {</span>
<a href="#l2.3307"></a><span id="l2.3307">       var name = element.nodeName.toLowerCase();</span>
<a href="#l2.3308"></a><span id="l2.3308" class="difflineminus">-      switch (name)</span>
<a href="#l2.3309"></a><span id="l2.3309" class="difflineminus">-      {</span>
<a href="#l2.3310"></a><span id="l2.3310" class="difflineminus">-        case 'img':</span>
<a href="#l2.3311"></a><span id="l2.3311" class="difflineplus">+      switch (name) {</span>
<a href="#l2.3312"></a><span id="l2.3312" class="difflineplus">+        case &quot;img&quot;:</span>
<a href="#l2.3313"></a><span id="l2.3313">           goDoCommand(&quot;cmd_image&quot;);</span>
<a href="#l2.3314"></a><span id="l2.3314">           break;</span>
<a href="#l2.3315"></a><span id="l2.3315" class="difflineminus">-        case 'hr':</span>
<a href="#l2.3316"></a><span id="l2.3316" class="difflineplus">+        case &quot;hr&quot;:</span>
<a href="#l2.3317"></a><span id="l2.3317">           goDoCommand(&quot;cmd_hline&quot;);</span>
<a href="#l2.3318"></a><span id="l2.3318">           break;</span>
<a href="#l2.3319"></a><span id="l2.3319" class="difflineminus">-        case 'form':</span>
<a href="#l2.3320"></a><span id="l2.3320" class="difflineplus">+        case &quot;form&quot;:</span>
<a href="#l2.3321"></a><span id="l2.3321">           goDoCommand(&quot;cmd_form&quot;);</span>
<a href="#l2.3322"></a><span id="l2.3322">           break;</span>
<a href="#l2.3323"></a><span id="l2.3323" class="difflineminus">-        case 'input':</span>
<a href="#l2.3324"></a><span id="l2.3324" class="difflineplus">+        case &quot;input&quot;:</span>
<a href="#l2.3325"></a><span id="l2.3325">           var type = element.getAttribute(&quot;type&quot;);</span>
<a href="#l2.3326"></a><span id="l2.3326">           if (type &amp;&amp; type.toLowerCase() == &quot;image&quot;)</span>
<a href="#l2.3327"></a><span id="l2.3327">             goDoCommand(&quot;cmd_inputimage&quot;);</span>
<a href="#l2.3328"></a><span id="l2.3328">           else</span>
<a href="#l2.3329"></a><span id="l2.3329">             goDoCommand(&quot;cmd_inputtag&quot;);</span>
<a href="#l2.3330"></a><span id="l2.3330">           break;</span>
<a href="#l2.3331"></a><span id="l2.3331" class="difflineminus">-        case 'textarea':</span>
<a href="#l2.3332"></a><span id="l2.3332" class="difflineplus">+        case &quot;textarea&quot;:</span>
<a href="#l2.3333"></a><span id="l2.3333">           goDoCommand(&quot;cmd_textarea&quot;);</span>
<a href="#l2.3334"></a><span id="l2.3334">           break;</span>
<a href="#l2.3335"></a><span id="l2.3335" class="difflineminus">-        case 'select':</span>
<a href="#l2.3336"></a><span id="l2.3336" class="difflineplus">+        case &quot;select&quot;:</span>
<a href="#l2.3337"></a><span id="l2.3337">           goDoCommand(&quot;cmd_select&quot;);</span>
<a href="#l2.3338"></a><span id="l2.3338">           break;</span>
<a href="#l2.3339"></a><span id="l2.3339" class="difflineminus">-        case 'button':</span>
<a href="#l2.3340"></a><span id="l2.3340" class="difflineplus">+        case &quot;button&quot;:</span>
<a href="#l2.3341"></a><span id="l2.3341">           goDoCommand(&quot;cmd_button&quot;);</span>
<a href="#l2.3342"></a><span id="l2.3342">           break;</span>
<a href="#l2.3343"></a><span id="l2.3343" class="difflineminus">-        case 'label':</span>
<a href="#l2.3344"></a><span id="l2.3344" class="difflineplus">+        case &quot;label&quot;:</span>
<a href="#l2.3345"></a><span id="l2.3345">           goDoCommand(&quot;cmd_label&quot;);</span>
<a href="#l2.3346"></a><span id="l2.3346">           break;</span>
<a href="#l2.3347"></a><span id="l2.3347" class="difflineminus">-        case 'fieldset':</span>
<a href="#l2.3348"></a><span id="l2.3348" class="difflineplus">+        case &quot;fieldset&quot;:</span>
<a href="#l2.3349"></a><span id="l2.3349">           goDoCommand(&quot;cmd_fieldset&quot;);</span>
<a href="#l2.3350"></a><span id="l2.3350">           break;</span>
<a href="#l2.3351"></a><span id="l2.3351" class="difflineminus">-        case 'table':</span>
<a href="#l2.3352"></a><span id="l2.3352" class="difflineplus">+        case &quot;table&quot;:</span>
<a href="#l2.3353"></a><span id="l2.3353">           EditorInsertOrEditTable(false);</span>
<a href="#l2.3354"></a><span id="l2.3354">           break;</span>
<a href="#l2.3355"></a><span id="l2.3355" class="difflineminus">-        case 'td':</span>
<a href="#l2.3356"></a><span id="l2.3356" class="difflineminus">-        case 'th':</span>
<a href="#l2.3357"></a><span id="l2.3357" class="difflineplus">+        case &quot;td&quot;:</span>
<a href="#l2.3358"></a><span id="l2.3358" class="difflineplus">+        case &quot;th&quot;:</span>
<a href="#l2.3359"></a><span id="l2.3359">           EditorTableCellProperties();</span>
<a href="#l2.3360"></a><span id="l2.3360">           break;</span>
<a href="#l2.3361"></a><span id="l2.3361" class="difflineminus">-        case 'ol':</span>
<a href="#l2.3362"></a><span id="l2.3362" class="difflineminus">-        case 'ul':</span>
<a href="#l2.3363"></a><span id="l2.3363" class="difflineminus">-        case 'dl':</span>
<a href="#l2.3364"></a><span id="l2.3364" class="difflineminus">-        case 'li':</span>
<a href="#l2.3365"></a><span id="l2.3365" class="difflineplus">+        case &quot;ol&quot;:</span>
<a href="#l2.3366"></a><span id="l2.3366" class="difflineplus">+        case &quot;ul&quot;:</span>
<a href="#l2.3367"></a><span id="l2.3367" class="difflineplus">+        case &quot;dl&quot;:</span>
<a href="#l2.3368"></a><span id="l2.3368" class="difflineplus">+        case &quot;li&quot;:</span>
<a href="#l2.3369"></a><span id="l2.3369">           goDoCommand(&quot;cmd_listProperties&quot;);</span>
<a href="#l2.3370"></a><span id="l2.3370">           break;</span>
<a href="#l2.3371"></a><span id="l2.3371" class="difflineminus">-        case 'a':</span>
<a href="#l2.3372"></a><span id="l2.3372" class="difflineminus">-          if (element.name)</span>
<a href="#l2.3373"></a><span id="l2.3373" class="difflineminus">-          {</span>
<a href="#l2.3374"></a><span id="l2.3374" class="difflineplus">+        case &quot;a&quot;:</span>
<a href="#l2.3375"></a><span id="l2.3375" class="difflineplus">+          if (element.name) {</span>
<a href="#l2.3376"></a><span id="l2.3376">             goDoCommand(&quot;cmd_anchor&quot;);</span>
<a href="#l2.3377"></a><span id="l2.3377" class="difflineminus">-          }</span>
<a href="#l2.3378"></a><span id="l2.3378" class="difflineminus">-          else if (element.href)</span>
<a href="#l2.3379"></a><span id="l2.3379" class="difflineminus">-          {</span>
<a href="#l2.3380"></a><span id="l2.3380" class="difflineplus">+          } else if (element.href) {</span>
<a href="#l2.3381"></a><span id="l2.3381">             goDoCommand(&quot;cmd_link&quot;);</span>
<a href="#l2.3382"></a><span id="l2.3382">           }</span>
<a href="#l2.3383"></a><span id="l2.3383">           break;</span>
<a href="#l2.3384"></a><span id="l2.3384" class="difflineminus">-        case 'math':</span>
<a href="#l2.3385"></a><span id="l2.3385" class="difflineplus">+        case &quot;math&quot;:</span>
<a href="#l2.3386"></a><span id="l2.3386">           goDoCommand(&quot;cmd_insertMathWithDialog&quot;);</span>
<a href="#l2.3387"></a><span id="l2.3387">           break;</span>
<a href="#l2.3388"></a><span id="l2.3388">         default:</span>
<a href="#l2.3389"></a><span id="l2.3389">           doAdvancedProperties(element);</span>
<a href="#l2.3390"></a><span id="l2.3390">           break;</span>
<a href="#l2.3391"></a><span id="l2.3391">       }</span>
<a href="#l2.3392"></a><span id="l2.3392">     } else {</span>
<a href="#l2.3393"></a><span id="l2.3393">       // We get a partially-selected link if asked for specifically</span>
<a href="#l2.3394"></a><span id="l2.3394">       try {</span>
<a href="#l2.3395"></a><span id="l2.3395">         element = GetCurrentEditor().getSelectedElement(&quot;href&quot;);</span>
<a href="#l2.3396"></a><span id="l2.3396">       } catch (e) {}</span>
<a href="#l2.3397"></a><span id="l2.3397">       if (element)</span>
<a href="#l2.3398"></a><span id="l2.3398">         goDoCommand(&quot;cmd_link&quot;);</span>
<a href="#l2.3399"></a><span id="l2.3399">     }</span>
<a href="#l2.3400"></a><span id="l2.3400" class="difflineminus">-  }</span>
<a href="#l2.3401"></a><span id="l2.3401" class="difflineplus">+  },</span>
<a href="#l2.3402"></a><span id="l2.3402"> };</span>
<a href="#l2.3403"></a><span id="l2.3403"> </span>
<a href="#l2.3404"></a><span id="l2.3404"> </span>
<a href="#l2.3405"></a><span id="l2.3405" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3406"></a><span id="l2.3406" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3407"></a><span id="l2.3407"> var nsSetSmiley =</span>
<a href="#l2.3408"></a><span id="l2.3408"> {</span>
<a href="#l2.3409"></a><span id="l2.3409" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3410"></a><span id="l2.3410" class="difflineminus">-  {</span>
<a href="#l2.3411"></a><span id="l2.3411" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3412"></a><span id="l2.3412">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3413"></a><span id="l2.3413">   },</span>
<a href="#l2.3414"></a><span id="l2.3414"> </span>
<a href="#l2.3415"></a><span id="l2.3415" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3416"></a><span id="l2.3416" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon)</span>
<a href="#l2.3417"></a><span id="l2.3417" class="difflineminus">-  {</span>
<a href="#l2.3418"></a><span id="l2.3418" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3419"></a><span id="l2.3419" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {</span>
<a href="#l2.3420"></a><span id="l2.3420">     var smileyCode = aParams.getStringValue(&quot;state_attribute&quot;);</span>
<a href="#l2.3421"></a><span id="l2.3421"> </span>
<a href="#l2.3422"></a><span id="l2.3422">     var strSml;</span>
<a href="#l2.3423"></a><span id="l2.3423" class="difflineminus">-    switch(smileyCode)</span>
<a href="#l2.3424"></a><span id="l2.3424" class="difflineminus">-    {</span>
<a href="#l2.3425"></a><span id="l2.3425" class="difflineminus">-        case &quot;:-)&quot;: strSml=&quot;s1&quot;;</span>
<a href="#l2.3426"></a><span id="l2.3426" class="difflineplus">+    switch (smileyCode) {</span>
<a href="#l2.3427"></a><span id="l2.3427" class="difflineplus">+        case &quot;:-)&quot;: strSml = &quot;s1&quot;;</span>
<a href="#l2.3428"></a><span id="l2.3428">         break;</span>
<a href="#l2.3429"></a><span id="l2.3429" class="difflineminus">-        case &quot;:-(&quot;: strSml=&quot;s2&quot;;</span>
<a href="#l2.3430"></a><span id="l2.3430" class="difflineplus">+        case &quot;:-(&quot;: strSml = &quot;s2&quot;;</span>
<a href="#l2.3431"></a><span id="l2.3431">         break;</span>
<a href="#l2.3432"></a><span id="l2.3432" class="difflineminus">-        case &quot;;-)&quot;: strSml=&quot;s3&quot;;</span>
<a href="#l2.3433"></a><span id="l2.3433" class="difflineplus">+        case &quot;;-)&quot;: strSml = &quot;s3&quot;;</span>
<a href="#l2.3434"></a><span id="l2.3434">         break;</span>
<a href="#l2.3435"></a><span id="l2.3435">         case &quot;:-P&quot;:</span>
<a href="#l2.3436"></a><span id="l2.3436">         case &quot;:-p&quot;:</span>
<a href="#l2.3437"></a><span id="l2.3437" class="difflineminus">-        case &quot;:-b&quot;: strSml=&quot;s4&quot;;</span>
<a href="#l2.3438"></a><span id="l2.3438" class="difflineplus">+        case &quot;:-b&quot;: strSml = &quot;s4&quot;;</span>
<a href="#l2.3439"></a><span id="l2.3439">         break;</span>
<a href="#l2.3440"></a><span id="l2.3440" class="difflineminus">-        case &quot;:-D&quot;: strSml=&quot;s5&quot;;</span>
<a href="#l2.3441"></a><span id="l2.3441" class="difflineplus">+        case &quot;:-D&quot;: strSml = &quot;s5&quot;;</span>
<a href="#l2.3442"></a><span id="l2.3442">         break;</span>
<a href="#l2.3443"></a><span id="l2.3443" class="difflineminus">-        case &quot;:-[&quot;: strSml=&quot;s6&quot;;</span>
<a href="#l2.3444"></a><span id="l2.3444" class="difflineplus">+        case &quot;:-[&quot;: strSml = &quot;s6&quot;;</span>
<a href="#l2.3445"></a><span id="l2.3445">         break;</span>
<a href="#l2.3446"></a><span id="l2.3446">         case &quot;:-/&quot;:</span>
<a href="#l2.3447"></a><span id="l2.3447">         case &quot;:/&quot;:</span>
<a href="#l2.3448"></a><span id="l2.3448">         case &quot;:-\\&quot;:</span>
<a href="#l2.3449"></a><span id="l2.3449" class="difflineminus">-        case &quot;:\\&quot;: strSml=&quot;s7&quot;;</span>
<a href="#l2.3450"></a><span id="l2.3450" class="difflineplus">+        case &quot;:\\&quot;: strSml = &quot;s7&quot;;</span>
<a href="#l2.3451"></a><span id="l2.3451">         break;</span>
<a href="#l2.3452"></a><span id="l2.3452">         case &quot;=-O&quot;:</span>
<a href="#l2.3453"></a><span id="l2.3453" class="difflineminus">-        case &quot;=-o&quot;: strSml=&quot;s8&quot;;</span>
<a href="#l2.3454"></a><span id="l2.3454" class="difflineplus">+        case &quot;=-o&quot;: strSml = &quot;s8&quot;;</span>
<a href="#l2.3455"></a><span id="l2.3455">         break;</span>
<a href="#l2.3456"></a><span id="l2.3456" class="difflineminus">-        case &quot;:-*&quot;: strSml=&quot;s9&quot;;</span>
<a href="#l2.3457"></a><span id="l2.3457" class="difflineplus">+        case &quot;:-*&quot;: strSml = &quot;s9&quot;;</span>
<a href="#l2.3458"></a><span id="l2.3458">         break;</span>
<a href="#l2.3459"></a><span id="l2.3459">         case &quot;&gt;:o&quot;:</span>
<a href="#l2.3460"></a><span id="l2.3460" class="difflineminus">-        case &quot;&gt;:-o&quot;: strSml=&quot;s10&quot;;</span>
<a href="#l2.3461"></a><span id="l2.3461" class="difflineplus">+        case &quot;&gt;:-o&quot;: strSml = &quot;s10&quot;;</span>
<a href="#l2.3462"></a><span id="l2.3462">         break;</span>
<a href="#l2.3463"></a><span id="l2.3463" class="difflineminus">-        case &quot;8-)&quot;: strSml=&quot;s11&quot;;</span>
<a href="#l2.3464"></a><span id="l2.3464" class="difflineplus">+        case &quot;8-)&quot;: strSml = &quot;s11&quot;;</span>
<a href="#l2.3465"></a><span id="l2.3465">         break;</span>
<a href="#l2.3466"></a><span id="l2.3466" class="difflineminus">-        case &quot;:-$&quot;: strSml=&quot;s12&quot;;</span>
<a href="#l2.3467"></a><span id="l2.3467" class="difflineplus">+        case &quot;:-$&quot;: strSml = &quot;s12&quot;;</span>
<a href="#l2.3468"></a><span id="l2.3468">         break;</span>
<a href="#l2.3469"></a><span id="l2.3469" class="difflineminus">-        case &quot;:-!&quot;: strSml=&quot;s13&quot;;</span>
<a href="#l2.3470"></a><span id="l2.3470" class="difflineplus">+        case &quot;:-!&quot;: strSml = &quot;s13&quot;;</span>
<a href="#l2.3471"></a><span id="l2.3471">         break;</span>
<a href="#l2.3472"></a><span id="l2.3472">         case &quot;O:-)&quot;:</span>
<a href="#l2.3473"></a><span id="l2.3473" class="difflineminus">-        case &quot;o:-)&quot;: strSml=&quot;s14&quot;;</span>
<a href="#l2.3474"></a><span id="l2.3474" class="difflineplus">+        case &quot;o:-)&quot;: strSml = &quot;s14&quot;;</span>
<a href="#l2.3475"></a><span id="l2.3475">         break;</span>
<a href="#l2.3476"></a><span id="l2.3476" class="difflineminus">-        case &quot;:'(&quot;: strSml=&quot;s15&quot;;</span>
<a href="#l2.3477"></a><span id="l2.3477" class="difflineplus">+        case &quot;:'(&quot;: strSml = &quot;s15&quot;;</span>
<a href="#l2.3478"></a><span id="l2.3478">         break;</span>
<a href="#l2.3479"></a><span id="l2.3479">         case &quot;:-X&quot;:</span>
<a href="#l2.3480"></a><span id="l2.3480" class="difflineminus">-        case &quot;:-x&quot;: strSml=&quot;s16&quot;;</span>
<a href="#l2.3481"></a><span id="l2.3481" class="difflineplus">+        case &quot;:-x&quot;: strSml = &quot;s16&quot;;</span>
<a href="#l2.3482"></a><span id="l2.3482">         break;</span>
<a href="#l2.3483"></a><span id="l2.3483" class="difflineminus">-        default: strSml=&quot;&quot;;</span>
<a href="#l2.3484"></a><span id="l2.3484" class="difflineplus">+        default: strSml = &quot;&quot;;</span>
<a href="#l2.3485"></a><span id="l2.3485">         break;</span>
<a href="#l2.3486"></a><span id="l2.3486">     }</span>
<a href="#l2.3487"></a><span id="l2.3487"> </span>
<a href="#l2.3488"></a><span id="l2.3488" class="difflineminus">-    try</span>
<a href="#l2.3489"></a><span id="l2.3489" class="difflineminus">-    {</span>
<a href="#l2.3490"></a><span id="l2.3490" class="difflineplus">+    try {</span>
<a href="#l2.3491"></a><span id="l2.3491">       var editor = GetCurrentEditor();</span>
<a href="#l2.3492"></a><span id="l2.3492">       var selection = editor.selection;</span>
<a href="#l2.3493"></a><span id="l2.3493">       var extElement = editor.createElementWithDefaults(&quot;span&quot;);</span>
<a href="#l2.3494"></a><span id="l2.3494">       extElement.setAttribute(&quot;class&quot;, &quot;moz-smiley-&quot; + strSml);</span>
<a href="#l2.3495"></a><span id="l2.3495"> </span>
<a href="#l2.3496"></a><span id="l2.3496">       var intElement = editor.createElementWithDefaults(&quot;span&quot;);</span>
<a href="#l2.3497"></a><span id="l2.3497">       if (!intElement)</span>
<a href="#l2.3498"></a><span id="l2.3498">         return;</span>
<a href="#l2.3499"></a><span id="l2.3499"> </span>
<a href="#l2.3500"></a><span id="l2.3500">       var txtElement =  editor.document.createTextNode(smileyCode);</span>
<a href="#l2.3501"></a><span id="l2.3501">       if (!txtElement)</span>
<a href="#l2.3502"></a><span id="l2.3502">         return;</span>
<a href="#l2.3503"></a><span id="l2.3503"> </span>
<a href="#l2.3504"></a><span id="l2.3504" class="difflineminus">-      intElement.appendChild (txtElement);</span>
<a href="#l2.3505"></a><span id="l2.3505" class="difflineminus">-      extElement.appendChild (intElement);</span>
<a href="#l2.3506"></a><span id="l2.3506" class="difflineminus">-</span>
<a href="#l2.3507"></a><span id="l2.3507" class="difflineminus">-</span>
<a href="#l2.3508"></a><span id="l2.3508" class="difflineminus">-      editor.insertElementAtSelection(extElement,true);</span>
<a href="#l2.3509"></a><span id="l2.3509" class="difflineplus">+      intElement.appendChild(txtElement);</span>
<a href="#l2.3510"></a><span id="l2.3510" class="difflineplus">+      extElement.appendChild(intElement);</span>
<a href="#l2.3511"></a><span id="l2.3511" class="difflineplus">+</span>
<a href="#l2.3512"></a><span id="l2.3512" class="difflineplus">+</span>
<a href="#l2.3513"></a><span id="l2.3513" class="difflineplus">+      editor.insertElementAtSelection(extElement, true);</span>
<a href="#l2.3514"></a><span id="l2.3514">       window.content.focus();</span>
<a href="#l2.3515"></a><span id="l2.3515" class="difflineminus">-</span>
<a href="#l2.3516"></a><span id="l2.3516" class="difflineminus">-    }</span>
<a href="#l2.3517"></a><span id="l2.3517" class="difflineminus">-    catch (e)</span>
<a href="#l2.3518"></a><span id="l2.3518" class="difflineminus">-    {</span>
<a href="#l2.3519"></a><span id="l2.3519" class="difflineplus">+    } catch (e) {</span>
<a href="#l2.3520"></a><span id="l2.3520">         dump(&quot;Exception occurred in smiley InsertElementAtSelection\n&quot;);</span>
<a href="#l2.3521"></a><span id="l2.3521">     }</span>
<a href="#l2.3522"></a><span id="l2.3522">   },</span>
<a href="#l2.3523"></a><span id="l2.3523">   // This is now deprecated in favor of &quot;doCommandParams&quot;</span>
<a href="#l2.3524"></a><span id="l2.3524" class="difflineminus">-  doCommand: function(aCommand) {}</span>
<a href="#l2.3525"></a><span id="l2.3525" class="difflineplus">+  doCommand(aCommand) {},</span>
<a href="#l2.3526"></a><span id="l2.3526"> };</span>
<a href="#l2.3527"></a><span id="l2.3527"> </span>
<a href="#l2.3528"></a><span id="l2.3528"> </span>
<a href="#l2.3529"></a><span id="l2.3529" class="difflineminus">-function doAdvancedProperties(element)</span>
<a href="#l2.3530"></a><span id="l2.3530" class="difflineminus">-{</span>
<a href="#l2.3531"></a><span id="l2.3531" class="difflineminus">-  if (element)</span>
<a href="#l2.3532"></a><span id="l2.3532" class="difflineminus">-  {</span>
<a href="#l2.3533"></a><span id="l2.3533" class="difflineplus">+function doAdvancedProperties(element) {</span>
<a href="#l2.3534"></a><span id="l2.3534" class="difflineplus">+  if (element) {</span>
<a href="#l2.3535"></a><span id="l2.3535">     window.openDialog(&quot;chrome://editor/content/EdAdvancedEdit.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable=yes&quot;, &quot;&quot;, element);</span>
<a href="#l2.3536"></a><span id="l2.3536">   }</span>
<a href="#l2.3537"></a><span id="l2.3537"> }</span>
<a href="#l2.3538"></a><span id="l2.3538"> </span>
<a href="#l2.3539"></a><span id="l2.3539"> var nsAdvancedPropertiesCommand =</span>
<a href="#l2.3540"></a><span id="l2.3540"> {</span>
<a href="#l2.3541"></a><span id="l2.3541" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3542"></a><span id="l2.3542" class="difflineminus">-  {</span>
<a href="#l2.3543"></a><span id="l2.3543" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3544"></a><span id="l2.3544">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3545"></a><span id="l2.3545">   },</span>
<a href="#l2.3546"></a><span id="l2.3546"> </span>
<a href="#l2.3547"></a><span id="l2.3547" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3548"></a><span id="l2.3548" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3549"></a><span id="l2.3549" class="difflineminus">-</span>
<a href="#l2.3550"></a><span id="l2.3550" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3551"></a><span id="l2.3551" class="difflineminus">-  {</span>
<a href="#l2.3552"></a><span id="l2.3552" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3553"></a><span id="l2.3553" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3554"></a><span id="l2.3554" class="difflineplus">+</span>
<a href="#l2.3555"></a><span id="l2.3555" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3556"></a><span id="l2.3556">     // Launch AdvancedEdit dialog for the selected element</span>
<a href="#l2.3557"></a><span id="l2.3557">     try {</span>
<a href="#l2.3558"></a><span id="l2.3558">       var element = GetCurrentEditor().getSelectedElement(&quot;&quot;);</span>
<a href="#l2.3559"></a><span id="l2.3559">       doAdvancedProperties(element);</span>
<a href="#l2.3560"></a><span id="l2.3560">     } catch (e) {}</span>
<a href="#l2.3561"></a><span id="l2.3561" class="difflineminus">-  }</span>
<a href="#l2.3562"></a><span id="l2.3562" class="difflineplus">+  },</span>
<a href="#l2.3563"></a><span id="l2.3563"> };</span>
<a href="#l2.3564"></a><span id="l2.3564"> </span>
<a href="#l2.3565"></a><span id="l2.3565" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3566"></a><span id="l2.3566" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3567"></a><span id="l2.3567"> var nsColorPropertiesCommand =</span>
<a href="#l2.3568"></a><span id="l2.3568"> {</span>
<a href="#l2.3569"></a><span id="l2.3569" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3570"></a><span id="l2.3570" class="difflineminus">-  {</span>
<a href="#l2.3571"></a><span id="l2.3571" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3572"></a><span id="l2.3572">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3573"></a><span id="l2.3573">   },</span>
<a href="#l2.3574"></a><span id="l2.3574"> </span>
<a href="#l2.3575"></a><span id="l2.3575" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3576"></a><span id="l2.3576" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3577"></a><span id="l2.3577" class="difflineminus">-</span>
<a href="#l2.3578"></a><span id="l2.3578" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3579"></a><span id="l2.3579" class="difflineminus">-  {</span>
<a href="#l2.3580"></a><span id="l2.3580" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdColorProps.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.3581"></a><span id="l2.3581" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3582"></a><span id="l2.3582" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3583"></a><span id="l2.3583" class="difflineplus">+</span>
<a href="#l2.3584"></a><span id="l2.3584" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3585"></a><span id="l2.3585" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EdColorProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.3586"></a><span id="l2.3586">     UpdateDefaultColors();</span>
<a href="#l2.3587"></a><span id="l2.3587" class="difflineminus">-  }</span>
<a href="#l2.3588"></a><span id="l2.3588" class="difflineplus">+  },</span>
<a href="#l2.3589"></a><span id="l2.3589"> };</span>
<a href="#l2.3590"></a><span id="l2.3590"> </span>
<a href="#l2.3591"></a><span id="l2.3591" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3592"></a><span id="l2.3592" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3593"></a><span id="l2.3593"> var nsIncreaseFontCommand =</span>
<a href="#l2.3594"></a><span id="l2.3594"> {</span>
<a href="#l2.3595"></a><span id="l2.3595" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3596"></a><span id="l2.3596" class="difflineminus">-  {</span>
<a href="#l2.3597"></a><span id="l2.3597" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3598"></a><span id="l2.3598">     if (!(IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()))</span>
<a href="#l2.3599"></a><span id="l2.3599">       return false;</span>
<a href="#l2.3600"></a><span id="l2.3600">     var setIndex = getFontSizeIndex();</span>
<a href="#l2.3601"></a><span id="l2.3601">     return (setIndex &gt;= 0 &amp;&amp; setIndex &lt; 5);</span>
<a href="#l2.3602"></a><span id="l2.3602">   },</span>
<a href="#l2.3603"></a><span id="l2.3603"> </span>
<a href="#l2.3604"></a><span id="l2.3604" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3605"></a><span id="l2.3605" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3606"></a><span id="l2.3606" class="difflineminus">-</span>
<a href="#l2.3607"></a><span id="l2.3607" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3608"></a><span id="l2.3608" class="difflineminus">-  {</span>
<a href="#l2.3609"></a><span id="l2.3609" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3610"></a><span id="l2.3610" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3611"></a><span id="l2.3611" class="difflineplus">+</span>
<a href="#l2.3612"></a><span id="l2.3612" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3613"></a><span id="l2.3613">     var setIndex = getFontSizeIndex();</span>
<a href="#l2.3614"></a><span id="l2.3614">     if (setIndex &lt; 0 || setIndex &gt;= 5)</span>
<a href="#l2.3615"></a><span id="l2.3615">       return;</span>
<a href="#l2.3616"></a><span id="l2.3616" class="difflineminus">-    var sizes = ['x-small', 'small', 'medium', 'large', 'x-large', 'xx-large' ];</span>
<a href="#l2.3617"></a><span id="l2.3617" class="difflineminus">-    EditorSetFontSize(sizes[setIndex+1]);</span>
<a href="#l2.3618"></a><span id="l2.3618" class="difflineminus">-  }</span>
<a href="#l2.3619"></a><span id="l2.3619" class="difflineplus">+    var sizes = [&quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot; ];</span>
<a href="#l2.3620"></a><span id="l2.3620" class="difflineplus">+    EditorSetFontSize(sizes[setIndex + 1]);</span>
<a href="#l2.3621"></a><span id="l2.3621" class="difflineplus">+  },</span>
<a href="#l2.3622"></a><span id="l2.3622"> };</span>
<a href="#l2.3623"></a><span id="l2.3623"> </span>
<a href="#l2.3624"></a><span id="l2.3624" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3625"></a><span id="l2.3625" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3626"></a><span id="l2.3626"> var nsDecreaseFontCommand =</span>
<a href="#l2.3627"></a><span id="l2.3627"> {</span>
<a href="#l2.3628"></a><span id="l2.3628" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3629"></a><span id="l2.3629" class="difflineminus">-  {</span>
<a href="#l2.3630"></a><span id="l2.3630" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3631"></a><span id="l2.3631">     if (!(IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()))</span>
<a href="#l2.3632"></a><span id="l2.3632">       return false;</span>
<a href="#l2.3633"></a><span id="l2.3633">     var setIndex = getFontSizeIndex();</span>
<a href="#l2.3634"></a><span id="l2.3634">     return (setIndex &gt; 0);</span>
<a href="#l2.3635"></a><span id="l2.3635">   },</span>
<a href="#l2.3636"></a><span id="l2.3636"> </span>
<a href="#l2.3637"></a><span id="l2.3637" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3638"></a><span id="l2.3638" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3639"></a><span id="l2.3639" class="difflineminus">-</span>
<a href="#l2.3640"></a><span id="l2.3640" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3641"></a><span id="l2.3641" class="difflineminus">-  {</span>
<a href="#l2.3642"></a><span id="l2.3642" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3643"></a><span id="l2.3643" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3644"></a><span id="l2.3644" class="difflineplus">+</span>
<a href="#l2.3645"></a><span id="l2.3645" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3646"></a><span id="l2.3646">     var setIndex = getFontSizeIndex();</span>
<a href="#l2.3647"></a><span id="l2.3647">     if (setIndex &lt;= 0)</span>
<a href="#l2.3648"></a><span id="l2.3648">       return;</span>
<a href="#l2.3649"></a><span id="l2.3649" class="difflineminus">-    var sizes = ['x-small', 'small', 'medium', 'large', 'x-large', 'xx-large' ];</span>
<a href="#l2.3650"></a><span id="l2.3650" class="difflineminus">-    EditorSetFontSize(sizes[setIndex-1]);</span>
<a href="#l2.3651"></a><span id="l2.3651" class="difflineminus">-  }</span>
<a href="#l2.3652"></a><span id="l2.3652" class="difflineplus">+    var sizes = [&quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot; ];</span>
<a href="#l2.3653"></a><span id="l2.3653" class="difflineplus">+    EditorSetFontSize(sizes[setIndex - 1]);</span>
<a href="#l2.3654"></a><span id="l2.3654" class="difflineplus">+  },</span>
<a href="#l2.3655"></a><span id="l2.3655"> };</span>
<a href="#l2.3656"></a><span id="l2.3656"> </span>
<a href="#l2.3657"></a><span id="l2.3657" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3658"></a><span id="l2.3658" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3659"></a><span id="l2.3659"> var nsRemoveNamedAnchorsCommand =</span>
<a href="#l2.3660"></a><span id="l2.3660"> {</span>
<a href="#l2.3661"></a><span id="l2.3661" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3662"></a><span id="l2.3662" class="difflineminus">-  {</span>
<a href="#l2.3663"></a><span id="l2.3663" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3664"></a><span id="l2.3664">     // We could see if there's any link in selection, but it doesn't seem worth the work!</span>
<a href="#l2.3665"></a><span id="l2.3665">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3666"></a><span id="l2.3666">   },</span>
<a href="#l2.3667"></a><span id="l2.3667"> </span>
<a href="#l2.3668"></a><span id="l2.3668" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3669"></a><span id="l2.3669" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3670"></a><span id="l2.3670" class="difflineminus">-</span>
<a href="#l2.3671"></a><span id="l2.3671" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3672"></a><span id="l2.3672" class="difflineminus">-  {</span>
<a href="#l2.3673"></a><span id="l2.3673" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3674"></a><span id="l2.3674" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3675"></a><span id="l2.3675" class="difflineplus">+</span>
<a href="#l2.3676"></a><span id="l2.3676" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3677"></a><span id="l2.3677">     EditorRemoveTextProperty(&quot;name&quot;, &quot;&quot;);</span>
<a href="#l2.3678"></a><span id="l2.3678">     window.content.focus();</span>
<a href="#l2.3679"></a><span id="l2.3679" class="difflineminus">-  }</span>
<a href="#l2.3680"></a><span id="l2.3680" class="difflineplus">+  },</span>
<a href="#l2.3681"></a><span id="l2.3681"> };</span>
<a href="#l2.3682"></a><span id="l2.3682"> </span>
<a href="#l2.3683"></a><span id="l2.3683"> </span>
<a href="#l2.3684"></a><span id="l2.3684" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3685"></a><span id="l2.3685" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3686"></a><span id="l2.3686"> var nsEditLinkCommand =</span>
<a href="#l2.3687"></a><span id="l2.3687"> {</span>
<a href="#l2.3688"></a><span id="l2.3688" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3689"></a><span id="l2.3689" class="difflineminus">-  {</span>
<a href="#l2.3690"></a><span id="l2.3690" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3691"></a><span id="l2.3691">     // Not really used -- this command is only in context menu, and we do enabling there</span>
<a href="#l2.3692"></a><span id="l2.3692">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3693"></a><span id="l2.3693">   },</span>
<a href="#l2.3694"></a><span id="l2.3694"> </span>
<a href="#l2.3695"></a><span id="l2.3695" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3696"></a><span id="l2.3696" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3697"></a><span id="l2.3697" class="difflineminus">-</span>
<a href="#l2.3698"></a><span id="l2.3698" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3699"></a><span id="l2.3699" class="difflineminus">-  {</span>
<a href="#l2.3700"></a><span id="l2.3700" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3701"></a><span id="l2.3701" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3702"></a><span id="l2.3702" class="difflineplus">+</span>
<a href="#l2.3703"></a><span id="l2.3703" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3704"></a><span id="l2.3704">     try {</span>
<a href="#l2.3705"></a><span id="l2.3705">       var element = GetCurrentEditor().getSelectedElement(&quot;href&quot;);</span>
<a href="#l2.3706"></a><span id="l2.3706">       if (element)</span>
<a href="#l2.3707"></a><span id="l2.3707">         editPage(element.href);</span>
<a href="#l2.3708"></a><span id="l2.3708">     } catch (e) {}</span>
<a href="#l2.3709"></a><span id="l2.3709">     window.content.focus();</span>
<a href="#l2.3710"></a><span id="l2.3710" class="difflineminus">-  }</span>
<a href="#l2.3711"></a><span id="l2.3711" class="difflineplus">+  },</span>
<a href="#l2.3712"></a><span id="l2.3712"> };</span>
<a href="#l2.3713"></a><span id="l2.3713"> </span>
<a href="#l2.3714"></a><span id="l2.3714"> </span>
<a href="#l2.3715"></a><span id="l2.3715" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3716"></a><span id="l2.3716" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3717"></a><span id="l2.3717"> var nsNormalModeCommand =</span>
<a href="#l2.3718"></a><span id="l2.3718"> {</span>
<a href="#l2.3719"></a><span id="l2.3719" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3720"></a><span id="l2.3720" class="difflineminus">-  {</span>
<a href="#l2.3721"></a><span id="l2.3721" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3722"></a><span id="l2.3722">     return IsHTMLEditor() &amp;&amp; IsDocumentEditable();</span>
<a href="#l2.3723"></a><span id="l2.3723">   },</span>
<a href="#l2.3724"></a><span id="l2.3724"> </span>
<a href="#l2.3725"></a><span id="l2.3725" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3726"></a><span id="l2.3726" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3727"></a><span id="l2.3727" class="difflineminus">-</span>
<a href="#l2.3728"></a><span id="l2.3728" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3729"></a><span id="l2.3729" class="difflineminus">-  {</span>
<a href="#l2.3730"></a><span id="l2.3730" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3731"></a><span id="l2.3731" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3732"></a><span id="l2.3732" class="difflineplus">+</span>
<a href="#l2.3733"></a><span id="l2.3733" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3734"></a><span id="l2.3734">     SetEditMode(kDisplayModeNormal);</span>
<a href="#l2.3735"></a><span id="l2.3735" class="difflineminus">-  }</span>
<a href="#l2.3736"></a><span id="l2.3736" class="difflineplus">+  },</span>
<a href="#l2.3737"></a><span id="l2.3737"> };</span>
<a href="#l2.3738"></a><span id="l2.3738"> </span>
<a href="#l2.3739"></a><span id="l2.3739"> var nsAllTagsModeCommand =</span>
<a href="#l2.3740"></a><span id="l2.3740"> {</span>
<a href="#l2.3741"></a><span id="l2.3741" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3742"></a><span id="l2.3742" class="difflineminus">-  {</span>
<a href="#l2.3743"></a><span id="l2.3743" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3744"></a><span id="l2.3744">     return (IsDocumentEditable() &amp;&amp; IsHTMLEditor());</span>
<a href="#l2.3745"></a><span id="l2.3745">   },</span>
<a href="#l2.3746"></a><span id="l2.3746"> </span>
<a href="#l2.3747"></a><span id="l2.3747" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3748"></a><span id="l2.3748" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3749"></a><span id="l2.3749" class="difflineminus">-</span>
<a href="#l2.3750"></a><span id="l2.3750" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3751"></a><span id="l2.3751" class="difflineminus">-  {</span>
<a href="#l2.3752"></a><span id="l2.3752" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3753"></a><span id="l2.3753" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3754"></a><span id="l2.3754" class="difflineplus">+</span>
<a href="#l2.3755"></a><span id="l2.3755" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3756"></a><span id="l2.3756">     SetEditMode(kDisplayModeAllTags);</span>
<a href="#l2.3757"></a><span id="l2.3757" class="difflineminus">-  }</span>
<a href="#l2.3758"></a><span id="l2.3758" class="difflineplus">+  },</span>
<a href="#l2.3759"></a><span id="l2.3759"> };</span>
<a href="#l2.3760"></a><span id="l2.3760"> </span>
<a href="#l2.3761"></a><span id="l2.3761"> var nsHTMLSourceModeCommand =</span>
<a href="#l2.3762"></a><span id="l2.3762"> {</span>
<a href="#l2.3763"></a><span id="l2.3763" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3764"></a><span id="l2.3764" class="difflineminus">-  {</span>
<a href="#l2.3765"></a><span id="l2.3765" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3766"></a><span id="l2.3766">     return (IsDocumentEditable() &amp;&amp; IsHTMLEditor());</span>
<a href="#l2.3767"></a><span id="l2.3767">   },</span>
<a href="#l2.3768"></a><span id="l2.3768"> </span>
<a href="#l2.3769"></a><span id="l2.3769" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3770"></a><span id="l2.3770" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3771"></a><span id="l2.3771" class="difflineminus">-</span>
<a href="#l2.3772"></a><span id="l2.3772" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3773"></a><span id="l2.3773" class="difflineminus">-  {</span>
<a href="#l2.3774"></a><span id="l2.3774" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3775"></a><span id="l2.3775" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3776"></a><span id="l2.3776" class="difflineplus">+</span>
<a href="#l2.3777"></a><span id="l2.3777" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3778"></a><span id="l2.3778">     SetEditMode(kDisplayModeSource);</span>
<a href="#l2.3779"></a><span id="l2.3779" class="difflineminus">-  }</span>
<a href="#l2.3780"></a><span id="l2.3780" class="difflineplus">+  },</span>
<a href="#l2.3781"></a><span id="l2.3781"> };</span>
<a href="#l2.3782"></a><span id="l2.3782"> </span>
<a href="#l2.3783"></a><span id="l2.3783"> var nsPreviewModeCommand =</span>
<a href="#l2.3784"></a><span id="l2.3784"> {</span>
<a href="#l2.3785"></a><span id="l2.3785" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3786"></a><span id="l2.3786" class="difflineminus">-  {</span>
<a href="#l2.3787"></a><span id="l2.3787" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3788"></a><span id="l2.3788">     return (IsDocumentEditable() &amp;&amp; IsHTMLEditor());</span>
<a href="#l2.3789"></a><span id="l2.3789">   },</span>
<a href="#l2.3790"></a><span id="l2.3790"> </span>
<a href="#l2.3791"></a><span id="l2.3791" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3792"></a><span id="l2.3792" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3793"></a><span id="l2.3793" class="difflineminus">-</span>
<a href="#l2.3794"></a><span id="l2.3794" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3795"></a><span id="l2.3795" class="difflineminus">-  {</span>
<a href="#l2.3796"></a><span id="l2.3796" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3797"></a><span id="l2.3797" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3798"></a><span id="l2.3798" class="difflineplus">+</span>
<a href="#l2.3799"></a><span id="l2.3799" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3800"></a><span id="l2.3800">     SetEditMode(kDisplayModePreview);</span>
<a href="#l2.3801"></a><span id="l2.3801" class="difflineminus">-  }</span>
<a href="#l2.3802"></a><span id="l2.3802" class="difflineplus">+  },</span>
<a href="#l2.3803"></a><span id="l2.3803"> };</span>
<a href="#l2.3804"></a><span id="l2.3804"> </span>
<a href="#l2.3805"></a><span id="l2.3805" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3806"></a><span id="l2.3806" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3807"></a><span id="l2.3807"> var nsInsertOrEditTableCommand =</span>
<a href="#l2.3808"></a><span id="l2.3808"> {</span>
<a href="#l2.3809"></a><span id="l2.3809" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3810"></a><span id="l2.3810" class="difflineminus">-  {</span>
<a href="#l2.3811"></a><span id="l2.3811" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3812"></a><span id="l2.3812">     return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.3813"></a><span id="l2.3813">   },</span>
<a href="#l2.3814"></a><span id="l2.3814"> </span>
<a href="#l2.3815"></a><span id="l2.3815" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3816"></a><span id="l2.3816" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3817"></a><span id="l2.3817" class="difflineminus">-</span>
<a href="#l2.3818"></a><span id="l2.3818" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3819"></a><span id="l2.3819" class="difflineminus">-  {</span>
<a href="#l2.3820"></a><span id="l2.3820" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3821"></a><span id="l2.3821" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3822"></a><span id="l2.3822" class="difflineplus">+</span>
<a href="#l2.3823"></a><span id="l2.3823" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3824"></a><span id="l2.3824">     if (IsInTableCell())</span>
<a href="#l2.3825"></a><span id="l2.3825">       EditorTableCellProperties();</span>
<a href="#l2.3826"></a><span id="l2.3826">     else</span>
<a href="#l2.3827"></a><span id="l2.3827">       EditorInsertOrEditTable(true);</span>
<a href="#l2.3828"></a><span id="l2.3828" class="difflineminus">-  }</span>
<a href="#l2.3829"></a><span id="l2.3829" class="difflineplus">+  },</span>
<a href="#l2.3830"></a><span id="l2.3830"> };</span>
<a href="#l2.3831"></a><span id="l2.3831"> </span>
<a href="#l2.3832"></a><span id="l2.3832" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3833"></a><span id="l2.3833" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3834"></a><span id="l2.3834"> var nsEditTableCommand =</span>
<a href="#l2.3835"></a><span id="l2.3835"> {</span>
<a href="#l2.3836"></a><span id="l2.3836" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3837"></a><span id="l2.3837" class="difflineminus">-  {</span>
<a href="#l2.3838"></a><span id="l2.3838" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3839"></a><span id="l2.3839">     return IsInTable();</span>
<a href="#l2.3840"></a><span id="l2.3840">   },</span>
<a href="#l2.3841"></a><span id="l2.3841"> </span>
<a href="#l2.3842"></a><span id="l2.3842" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3843"></a><span id="l2.3843" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3844"></a><span id="l2.3844" class="difflineminus">-</span>
<a href="#l2.3845"></a><span id="l2.3845" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3846"></a><span id="l2.3846" class="difflineminus">-  {</span>
<a href="#l2.3847"></a><span id="l2.3847" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3848"></a><span id="l2.3848" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3849"></a><span id="l2.3849" class="difflineplus">+</span>
<a href="#l2.3850"></a><span id="l2.3850" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3851"></a><span id="l2.3851">     EditorInsertOrEditTable(false);</span>
<a href="#l2.3852"></a><span id="l2.3852" class="difflineminus">-  }</span>
<a href="#l2.3853"></a><span id="l2.3853" class="difflineplus">+  },</span>
<a href="#l2.3854"></a><span id="l2.3854"> };</span>
<a href="#l2.3855"></a><span id="l2.3855"> </span>
<a href="#l2.3856"></a><span id="l2.3856" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3857"></a><span id="l2.3857" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3858"></a><span id="l2.3858"> var nsSelectTableCommand =</span>
<a href="#l2.3859"></a><span id="l2.3859"> {</span>
<a href="#l2.3860"></a><span id="l2.3860" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3861"></a><span id="l2.3861" class="difflineminus">-  {</span>
<a href="#l2.3862"></a><span id="l2.3862" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3863"></a><span id="l2.3863">     return IsInTable();</span>
<a href="#l2.3864"></a><span id="l2.3864">   },</span>
<a href="#l2.3865"></a><span id="l2.3865"> </span>
<a href="#l2.3866"></a><span id="l2.3866" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3867"></a><span id="l2.3867" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3868"></a><span id="l2.3868" class="difflineminus">-</span>
<a href="#l2.3869"></a><span id="l2.3869" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3870"></a><span id="l2.3870" class="difflineminus">-  {</span>
<a href="#l2.3871"></a><span id="l2.3871" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3872"></a><span id="l2.3872" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3873"></a><span id="l2.3873" class="difflineplus">+</span>
<a href="#l2.3874"></a><span id="l2.3874" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3875"></a><span id="l2.3875">     try {</span>
<a href="#l2.3876"></a><span id="l2.3876">       GetCurrentTableEditor().selectTable();</span>
<a href="#l2.3877"></a><span id="l2.3877" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.3878"></a><span id="l2.3878" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.3879"></a><span id="l2.3879">     window.content.focus();</span>
<a href="#l2.3880"></a><span id="l2.3880" class="difflineminus">-  }</span>
<a href="#l2.3881"></a><span id="l2.3881" class="difflineplus">+  },</span>
<a href="#l2.3882"></a><span id="l2.3882"> };</span>
<a href="#l2.3883"></a><span id="l2.3883"> </span>
<a href="#l2.3884"></a><span id="l2.3884"> var nsSelectTableRowCommand =</span>
<a href="#l2.3885"></a><span id="l2.3885"> {</span>
<a href="#l2.3886"></a><span id="l2.3886" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3887"></a><span id="l2.3887" class="difflineminus">-  {</span>
<a href="#l2.3888"></a><span id="l2.3888" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3889"></a><span id="l2.3889">     return IsInTableCell();</span>
<a href="#l2.3890"></a><span id="l2.3890">   },</span>
<a href="#l2.3891"></a><span id="l2.3891"> </span>
<a href="#l2.3892"></a><span id="l2.3892" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3893"></a><span id="l2.3893" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3894"></a><span id="l2.3894" class="difflineminus">-</span>
<a href="#l2.3895"></a><span id="l2.3895" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3896"></a><span id="l2.3896" class="difflineminus">-  {</span>
<a href="#l2.3897"></a><span id="l2.3897" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3898"></a><span id="l2.3898" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3899"></a><span id="l2.3899" class="difflineplus">+</span>
<a href="#l2.3900"></a><span id="l2.3900" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3901"></a><span id="l2.3901">     try {</span>
<a href="#l2.3902"></a><span id="l2.3902">       GetCurrentTableEditor().selectTableRow();</span>
<a href="#l2.3903"></a><span id="l2.3903" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.3904"></a><span id="l2.3904" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.3905"></a><span id="l2.3905">     window.content.focus();</span>
<a href="#l2.3906"></a><span id="l2.3906" class="difflineminus">-  }</span>
<a href="#l2.3907"></a><span id="l2.3907" class="difflineplus">+  },</span>
<a href="#l2.3908"></a><span id="l2.3908"> };</span>
<a href="#l2.3909"></a><span id="l2.3909"> </span>
<a href="#l2.3910"></a><span id="l2.3910"> var nsSelectTableColumnCommand =</span>
<a href="#l2.3911"></a><span id="l2.3911"> {</span>
<a href="#l2.3912"></a><span id="l2.3912" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3913"></a><span id="l2.3913" class="difflineminus">-  {</span>
<a href="#l2.3914"></a><span id="l2.3914" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3915"></a><span id="l2.3915">     return IsInTableCell();</span>
<a href="#l2.3916"></a><span id="l2.3916">   },</span>
<a href="#l2.3917"></a><span id="l2.3917"> </span>
<a href="#l2.3918"></a><span id="l2.3918" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3919"></a><span id="l2.3919" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3920"></a><span id="l2.3920" class="difflineminus">-</span>
<a href="#l2.3921"></a><span id="l2.3921" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3922"></a><span id="l2.3922" class="difflineminus">-  {</span>
<a href="#l2.3923"></a><span id="l2.3923" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3924"></a><span id="l2.3924" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3925"></a><span id="l2.3925" class="difflineplus">+</span>
<a href="#l2.3926"></a><span id="l2.3926" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3927"></a><span id="l2.3927">     try {</span>
<a href="#l2.3928"></a><span id="l2.3928">       GetCurrentTableEditor().selectTableColumn();</span>
<a href="#l2.3929"></a><span id="l2.3929" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.3930"></a><span id="l2.3930" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.3931"></a><span id="l2.3931">     window.content.focus();</span>
<a href="#l2.3932"></a><span id="l2.3932" class="difflineminus">-  }</span>
<a href="#l2.3933"></a><span id="l2.3933" class="difflineplus">+  },</span>
<a href="#l2.3934"></a><span id="l2.3934"> };</span>
<a href="#l2.3935"></a><span id="l2.3935"> </span>
<a href="#l2.3936"></a><span id="l2.3936"> var nsSelectTableCellCommand =</span>
<a href="#l2.3937"></a><span id="l2.3937"> {</span>
<a href="#l2.3938"></a><span id="l2.3938" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3939"></a><span id="l2.3939" class="difflineminus">-  {</span>
<a href="#l2.3940"></a><span id="l2.3940" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3941"></a><span id="l2.3941">     return IsInTableCell();</span>
<a href="#l2.3942"></a><span id="l2.3942">   },</span>
<a href="#l2.3943"></a><span id="l2.3943"> </span>
<a href="#l2.3944"></a><span id="l2.3944" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3945"></a><span id="l2.3945" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3946"></a><span id="l2.3946" class="difflineminus">-</span>
<a href="#l2.3947"></a><span id="l2.3947" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3948"></a><span id="l2.3948" class="difflineminus">-  {</span>
<a href="#l2.3949"></a><span id="l2.3949" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3950"></a><span id="l2.3950" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3951"></a><span id="l2.3951" class="difflineplus">+</span>
<a href="#l2.3952"></a><span id="l2.3952" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3953"></a><span id="l2.3953">     try {</span>
<a href="#l2.3954"></a><span id="l2.3954">       GetCurrentTableEditor().selectTableCell();</span>
<a href="#l2.3955"></a><span id="l2.3955" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.3956"></a><span id="l2.3956" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.3957"></a><span id="l2.3957">     window.content.focus();</span>
<a href="#l2.3958"></a><span id="l2.3958" class="difflineminus">-  }</span>
<a href="#l2.3959"></a><span id="l2.3959" class="difflineplus">+  },</span>
<a href="#l2.3960"></a><span id="l2.3960"> };</span>
<a href="#l2.3961"></a><span id="l2.3961"> </span>
<a href="#l2.3962"></a><span id="l2.3962"> var nsSelectAllTableCellsCommand =</span>
<a href="#l2.3963"></a><span id="l2.3963"> {</span>
<a href="#l2.3964"></a><span id="l2.3964" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3965"></a><span id="l2.3965" class="difflineminus">-  {</span>
<a href="#l2.3966"></a><span id="l2.3966" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3967"></a><span id="l2.3967">     return IsInTable();</span>
<a href="#l2.3968"></a><span id="l2.3968">   },</span>
<a href="#l2.3969"></a><span id="l2.3969"> </span>
<a href="#l2.3970"></a><span id="l2.3970" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3971"></a><span id="l2.3971" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3972"></a><span id="l2.3972" class="difflineminus">-</span>
<a href="#l2.3973"></a><span id="l2.3973" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.3974"></a><span id="l2.3974" class="difflineminus">-  {</span>
<a href="#l2.3975"></a><span id="l2.3975" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3976"></a><span id="l2.3976" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3977"></a><span id="l2.3977" class="difflineplus">+</span>
<a href="#l2.3978"></a><span id="l2.3978" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.3979"></a><span id="l2.3979">     try {</span>
<a href="#l2.3980"></a><span id="l2.3980">       GetCurrentTableEditor().selectAllTableCells();</span>
<a href="#l2.3981"></a><span id="l2.3981" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.3982"></a><span id="l2.3982" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.3983"></a><span id="l2.3983">     window.content.focus();</span>
<a href="#l2.3984"></a><span id="l2.3984" class="difflineminus">-  }</span>
<a href="#l2.3985"></a><span id="l2.3985" class="difflineplus">+  },</span>
<a href="#l2.3986"></a><span id="l2.3986"> };</span>
<a href="#l2.3987"></a><span id="l2.3987"> </span>
<a href="#l2.3988"></a><span id="l2.3988" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.3989"></a><span id="l2.3989" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.3990"></a><span id="l2.3990"> var nsInsertTableCommand =</span>
<a href="#l2.3991"></a><span id="l2.3991"> {</span>
<a href="#l2.3992"></a><span id="l2.3992" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.3993"></a><span id="l2.3993" class="difflineminus">-  {</span>
<a href="#l2.3994"></a><span id="l2.3994" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.3995"></a><span id="l2.3995">     return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.3996"></a><span id="l2.3996">   },</span>
<a href="#l2.3997"></a><span id="l2.3997"> </span>
<a href="#l2.3998"></a><span id="l2.3998" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.3999"></a><span id="l2.3999" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4000"></a><span id="l2.4000" class="difflineminus">-</span>
<a href="#l2.4001"></a><span id="l2.4001" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4002"></a><span id="l2.4002" class="difflineminus">-  {</span>
<a href="#l2.4003"></a><span id="l2.4003" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4004"></a><span id="l2.4004" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4005"></a><span id="l2.4005" class="difflineplus">+</span>
<a href="#l2.4006"></a><span id="l2.4006" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4007"></a><span id="l2.4007">     EditorInsertTable();</span>
<a href="#l2.4008"></a><span id="l2.4008" class="difflineminus">-  }</span>
<a href="#l2.4009"></a><span id="l2.4009" class="difflineplus">+  },</span>
<a href="#l2.4010"></a><span id="l2.4010"> };</span>
<a href="#l2.4011"></a><span id="l2.4011"> </span>
<a href="#l2.4012"></a><span id="l2.4012"> var nsInsertTableRowAboveCommand =</span>
<a href="#l2.4013"></a><span id="l2.4013"> {</span>
<a href="#l2.4014"></a><span id="l2.4014" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4015"></a><span id="l2.4015" class="difflineminus">-  {</span>
<a href="#l2.4016"></a><span id="l2.4016" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4017"></a><span id="l2.4017">     return IsInTableCell();</span>
<a href="#l2.4018"></a><span id="l2.4018">   },</span>
<a href="#l2.4019"></a><span id="l2.4019"> </span>
<a href="#l2.4020"></a><span id="l2.4020" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4021"></a><span id="l2.4021" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4022"></a><span id="l2.4022" class="difflineminus">-</span>
<a href="#l2.4023"></a><span id="l2.4023" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4024"></a><span id="l2.4024" class="difflineminus">-  {</span>
<a href="#l2.4025"></a><span id="l2.4025" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4026"></a><span id="l2.4026" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4027"></a><span id="l2.4027" class="difflineplus">+</span>
<a href="#l2.4028"></a><span id="l2.4028" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4029"></a><span id="l2.4029">     try {</span>
<a href="#l2.4030"></a><span id="l2.4030">       GetCurrentTableEditor().insertTableRow(1, false);</span>
<a href="#l2.4031"></a><span id="l2.4031" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.4032"></a><span id="l2.4032" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.4033"></a><span id="l2.4033">     window.content.focus();</span>
<a href="#l2.4034"></a><span id="l2.4034" class="difflineminus">-  }</span>
<a href="#l2.4035"></a><span id="l2.4035" class="difflineplus">+  },</span>
<a href="#l2.4036"></a><span id="l2.4036"> };</span>
<a href="#l2.4037"></a><span id="l2.4037"> </span>
<a href="#l2.4038"></a><span id="l2.4038"> var nsInsertTableRowBelowCommand =</span>
<a href="#l2.4039"></a><span id="l2.4039"> {</span>
<a href="#l2.4040"></a><span id="l2.4040" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4041"></a><span id="l2.4041" class="difflineminus">-  {</span>
<a href="#l2.4042"></a><span id="l2.4042" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4043"></a><span id="l2.4043">     return IsInTableCell();</span>
<a href="#l2.4044"></a><span id="l2.4044">   },</span>
<a href="#l2.4045"></a><span id="l2.4045"> </span>
<a href="#l2.4046"></a><span id="l2.4046" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4047"></a><span id="l2.4047" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4048"></a><span id="l2.4048" class="difflineminus">-</span>
<a href="#l2.4049"></a><span id="l2.4049" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4050"></a><span id="l2.4050" class="difflineminus">-  {</span>
<a href="#l2.4051"></a><span id="l2.4051" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4052"></a><span id="l2.4052" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4053"></a><span id="l2.4053" class="difflineplus">+</span>
<a href="#l2.4054"></a><span id="l2.4054" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4055"></a><span id="l2.4055">     try {</span>
<a href="#l2.4056"></a><span id="l2.4056">       GetCurrentTableEditor().insertTableRow(1, true);</span>
<a href="#l2.4057"></a><span id="l2.4057" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.4058"></a><span id="l2.4058" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.4059"></a><span id="l2.4059">     window.content.focus();</span>
<a href="#l2.4060"></a><span id="l2.4060" class="difflineminus">-  }</span>
<a href="#l2.4061"></a><span id="l2.4061" class="difflineplus">+  },</span>
<a href="#l2.4062"></a><span id="l2.4062"> };</span>
<a href="#l2.4063"></a><span id="l2.4063"> </span>
<a href="#l2.4064"></a><span id="l2.4064"> var nsInsertTableColumnBeforeCommand =</span>
<a href="#l2.4065"></a><span id="l2.4065"> {</span>
<a href="#l2.4066"></a><span id="l2.4066" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4067"></a><span id="l2.4067" class="difflineminus">-  {</span>
<a href="#l2.4068"></a><span id="l2.4068" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4069"></a><span id="l2.4069">     return IsInTableCell();</span>
<a href="#l2.4070"></a><span id="l2.4070">   },</span>
<a href="#l2.4071"></a><span id="l2.4071"> </span>
<a href="#l2.4072"></a><span id="l2.4072" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4073"></a><span id="l2.4073" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4074"></a><span id="l2.4074" class="difflineminus">-</span>
<a href="#l2.4075"></a><span id="l2.4075" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4076"></a><span id="l2.4076" class="difflineminus">-  {</span>
<a href="#l2.4077"></a><span id="l2.4077" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4078"></a><span id="l2.4078" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4079"></a><span id="l2.4079" class="difflineplus">+</span>
<a href="#l2.4080"></a><span id="l2.4080" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4081"></a><span id="l2.4081">     try {</span>
<a href="#l2.4082"></a><span id="l2.4082">       GetCurrentTableEditor().insertTableColumn(1, false);</span>
<a href="#l2.4083"></a><span id="l2.4083" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.4084"></a><span id="l2.4084" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.4085"></a><span id="l2.4085">     window.content.focus();</span>
<a href="#l2.4086"></a><span id="l2.4086" class="difflineminus">-  }</span>
<a href="#l2.4087"></a><span id="l2.4087" class="difflineplus">+  },</span>
<a href="#l2.4088"></a><span id="l2.4088"> };</span>
<a href="#l2.4089"></a><span id="l2.4089"> </span>
<a href="#l2.4090"></a><span id="l2.4090"> var nsInsertTableColumnAfterCommand =</span>
<a href="#l2.4091"></a><span id="l2.4091"> {</span>
<a href="#l2.4092"></a><span id="l2.4092" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4093"></a><span id="l2.4093" class="difflineminus">-  {</span>
<a href="#l2.4094"></a><span id="l2.4094" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4095"></a><span id="l2.4095">     return IsInTableCell();</span>
<a href="#l2.4096"></a><span id="l2.4096">   },</span>
<a href="#l2.4097"></a><span id="l2.4097"> </span>
<a href="#l2.4098"></a><span id="l2.4098" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4099"></a><span id="l2.4099" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4100"></a><span id="l2.4100" class="difflineminus">-</span>
<a href="#l2.4101"></a><span id="l2.4101" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4102"></a><span id="l2.4102" class="difflineminus">-  {</span>
<a href="#l2.4103"></a><span id="l2.4103" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4104"></a><span id="l2.4104" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4105"></a><span id="l2.4105" class="difflineplus">+</span>
<a href="#l2.4106"></a><span id="l2.4106" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4107"></a><span id="l2.4107">     try {</span>
<a href="#l2.4108"></a><span id="l2.4108">       GetCurrentTableEditor().insertTableColumn(1, true);</span>
<a href="#l2.4109"></a><span id="l2.4109" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.4110"></a><span id="l2.4110" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.4111"></a><span id="l2.4111">     window.content.focus();</span>
<a href="#l2.4112"></a><span id="l2.4112" class="difflineminus">-  }</span>
<a href="#l2.4113"></a><span id="l2.4113" class="difflineplus">+  },</span>
<a href="#l2.4114"></a><span id="l2.4114"> };</span>
<a href="#l2.4115"></a><span id="l2.4115"> </span>
<a href="#l2.4116"></a><span id="l2.4116"> var nsInsertTableCellBeforeCommand =</span>
<a href="#l2.4117"></a><span id="l2.4117"> {</span>
<a href="#l2.4118"></a><span id="l2.4118" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4119"></a><span id="l2.4119" class="difflineminus">-  {</span>
<a href="#l2.4120"></a><span id="l2.4120" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4121"></a><span id="l2.4121">     return IsInTableCell();</span>
<a href="#l2.4122"></a><span id="l2.4122">   },</span>
<a href="#l2.4123"></a><span id="l2.4123"> </span>
<a href="#l2.4124"></a><span id="l2.4124" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4125"></a><span id="l2.4125" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4126"></a><span id="l2.4126" class="difflineminus">-</span>
<a href="#l2.4127"></a><span id="l2.4127" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4128"></a><span id="l2.4128" class="difflineminus">-  {</span>
<a href="#l2.4129"></a><span id="l2.4129" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4130"></a><span id="l2.4130" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4131"></a><span id="l2.4131" class="difflineplus">+</span>
<a href="#l2.4132"></a><span id="l2.4132" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4133"></a><span id="l2.4133">     try {</span>
<a href="#l2.4134"></a><span id="l2.4134">       GetCurrentTableEditor().insertTableCell(1, false);</span>
<a href="#l2.4135"></a><span id="l2.4135" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.4136"></a><span id="l2.4136" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.4137"></a><span id="l2.4137">     window.content.focus();</span>
<a href="#l2.4138"></a><span id="l2.4138" class="difflineminus">-  }</span>
<a href="#l2.4139"></a><span id="l2.4139" class="difflineplus">+  },</span>
<a href="#l2.4140"></a><span id="l2.4140"> };</span>
<a href="#l2.4141"></a><span id="l2.4141"> </span>
<a href="#l2.4142"></a><span id="l2.4142"> var nsInsertTableCellAfterCommand =</span>
<a href="#l2.4143"></a><span id="l2.4143"> {</span>
<a href="#l2.4144"></a><span id="l2.4144" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4145"></a><span id="l2.4145" class="difflineminus">-  {</span>
<a href="#l2.4146"></a><span id="l2.4146" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4147"></a><span id="l2.4147">     return IsInTableCell();</span>
<a href="#l2.4148"></a><span id="l2.4148">   },</span>
<a href="#l2.4149"></a><span id="l2.4149"> </span>
<a href="#l2.4150"></a><span id="l2.4150" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4151"></a><span id="l2.4151" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4152"></a><span id="l2.4152" class="difflineminus">-</span>
<a href="#l2.4153"></a><span id="l2.4153" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4154"></a><span id="l2.4154" class="difflineminus">-  {</span>
<a href="#l2.4155"></a><span id="l2.4155" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4156"></a><span id="l2.4156" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4157"></a><span id="l2.4157" class="difflineplus">+</span>
<a href="#l2.4158"></a><span id="l2.4158" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4159"></a><span id="l2.4159">     try {</span>
<a href="#l2.4160"></a><span id="l2.4160">       GetCurrentTableEditor().insertTableCell(1, true);</span>
<a href="#l2.4161"></a><span id="l2.4161" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.4162"></a><span id="l2.4162" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.4163"></a><span id="l2.4163">     window.content.focus();</span>
<a href="#l2.4164"></a><span id="l2.4164" class="difflineminus">-  }</span>
<a href="#l2.4165"></a><span id="l2.4165" class="difflineplus">+  },</span>
<a href="#l2.4166"></a><span id="l2.4166"> };</span>
<a href="#l2.4167"></a><span id="l2.4167"> </span>
<a href="#l2.4168"></a><span id="l2.4168" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.4169"></a><span id="l2.4169" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.4170"></a><span id="l2.4170"> var nsDeleteTableCommand =</span>
<a href="#l2.4171"></a><span id="l2.4171"> {</span>
<a href="#l2.4172"></a><span id="l2.4172" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4173"></a><span id="l2.4173" class="difflineminus">-  {</span>
<a href="#l2.4174"></a><span id="l2.4174" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4175"></a><span id="l2.4175">     return IsInTable();</span>
<a href="#l2.4176"></a><span id="l2.4176">   },</span>
<a href="#l2.4177"></a><span id="l2.4177"> </span>
<a href="#l2.4178"></a><span id="l2.4178" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4179"></a><span id="l2.4179" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4180"></a><span id="l2.4180" class="difflineminus">-</span>
<a href="#l2.4181"></a><span id="l2.4181" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4182"></a><span id="l2.4182" class="difflineminus">-  {</span>
<a href="#l2.4183"></a><span id="l2.4183" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4184"></a><span id="l2.4184" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4185"></a><span id="l2.4185" class="difflineplus">+</span>
<a href="#l2.4186"></a><span id="l2.4186" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4187"></a><span id="l2.4187">     try {</span>
<a href="#l2.4188"></a><span id="l2.4188">       GetCurrentTableEditor().deleteTable();</span>
<a href="#l2.4189"></a><span id="l2.4189" class="difflineminus">-    } catch(e) {}</span>
<a href="#l2.4190"></a><span id="l2.4190" class="difflineplus">+    } catch (e) {}</span>
<a href="#l2.4191"></a><span id="l2.4191">     window.content.focus();</span>
<a href="#l2.4192"></a><span id="l2.4192" class="difflineminus">-  }</span>
<a href="#l2.4193"></a><span id="l2.4193" class="difflineplus">+  },</span>
<a href="#l2.4194"></a><span id="l2.4194"> };</span>
<a href="#l2.4195"></a><span id="l2.4195"> </span>
<a href="#l2.4196"></a><span id="l2.4196"> var nsDeleteTableRowCommand =</span>
<a href="#l2.4197"></a><span id="l2.4197"> {</span>
<a href="#l2.4198"></a><span id="l2.4198" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4199"></a><span id="l2.4199" class="difflineminus">-  {</span>
<a href="#l2.4200"></a><span id="l2.4200" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4201"></a><span id="l2.4201">     return IsInTableCell();</span>
<a href="#l2.4202"></a><span id="l2.4202">   },</span>
<a href="#l2.4203"></a><span id="l2.4203"> </span>
<a href="#l2.4204"></a><span id="l2.4204" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4205"></a><span id="l2.4205" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4206"></a><span id="l2.4206" class="difflineminus">-</span>
<a href="#l2.4207"></a><span id="l2.4207" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4208"></a><span id="l2.4208" class="difflineminus">-  {</span>
<a href="#l2.4209"></a><span id="l2.4209" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4210"></a><span id="l2.4210" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4211"></a><span id="l2.4211" class="difflineplus">+</span>
<a href="#l2.4212"></a><span id="l2.4212" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4213"></a><span id="l2.4213">     var rows = GetNumberOfContiguousSelectedRows();</span>
<a href="#l2.4214"></a><span id="l2.4214">     // Delete at least one row</span>
<a href="#l2.4215"></a><span id="l2.4215">     if (rows == 0)</span>
<a href="#l2.4216"></a><span id="l2.4216">       rows = 1;</span>
<a href="#l2.4217"></a><span id="l2.4217"> </span>
<a href="#l2.4218"></a><span id="l2.4218">     try {</span>
<a href="#l2.4219"></a><span id="l2.4219">       var editor = GetCurrentTableEditor();</span>
<a href="#l2.4220"></a><span id="l2.4220">       editor.beginTransaction();</span>
<a href="#l2.4221"></a><span id="l2.4221"> </span>
<a href="#l2.4222"></a><span id="l2.4222">       // Loop to delete all blocks of contiguous, selected rows</span>
<a href="#l2.4223"></a><span id="l2.4223" class="difflineminus">-      while (rows)</span>
<a href="#l2.4224"></a><span id="l2.4224" class="difflineminus">-      {</span>
<a href="#l2.4225"></a><span id="l2.4225" class="difflineplus">+      while (rows) {</span>
<a href="#l2.4226"></a><span id="l2.4226">         editor.deleteTableRow(rows);</span>
<a href="#l2.4227"></a><span id="l2.4227">         rows = GetNumberOfContiguousSelectedRows();</span>
<a href="#l2.4228"></a><span id="l2.4228">       }</span>
<a href="#l2.4229"></a><span id="l2.4229">     } finally { editor.endTransaction(); }</span>
<a href="#l2.4230"></a><span id="l2.4230">     window.content.focus();</span>
<a href="#l2.4231"></a><span id="l2.4231" class="difflineminus">-  }</span>
<a href="#l2.4232"></a><span id="l2.4232" class="difflineplus">+  },</span>
<a href="#l2.4233"></a><span id="l2.4233"> };</span>
<a href="#l2.4234"></a><span id="l2.4234"> </span>
<a href="#l2.4235"></a><span id="l2.4235"> var nsDeleteTableColumnCommand =</span>
<a href="#l2.4236"></a><span id="l2.4236"> {</span>
<a href="#l2.4237"></a><span id="l2.4237" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4238"></a><span id="l2.4238" class="difflineminus">-  {</span>
<a href="#l2.4239"></a><span id="l2.4239" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4240"></a><span id="l2.4240">     return IsInTableCell();</span>
<a href="#l2.4241"></a><span id="l2.4241">   },</span>
<a href="#l2.4242"></a><span id="l2.4242"> </span>
<a href="#l2.4243"></a><span id="l2.4243" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4244"></a><span id="l2.4244" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4245"></a><span id="l2.4245" class="difflineminus">-</span>
<a href="#l2.4246"></a><span id="l2.4246" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4247"></a><span id="l2.4247" class="difflineminus">-  {</span>
<a href="#l2.4248"></a><span id="l2.4248" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4249"></a><span id="l2.4249" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4250"></a><span id="l2.4250" class="difflineplus">+</span>
<a href="#l2.4251"></a><span id="l2.4251" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4252"></a><span id="l2.4252">     var columns = GetNumberOfContiguousSelectedColumns();</span>
<a href="#l2.4253"></a><span id="l2.4253">     // Delete at least one column</span>
<a href="#l2.4254"></a><span id="l2.4254">     if (columns == 0)</span>
<a href="#l2.4255"></a><span id="l2.4255">       columns = 1;</span>
<a href="#l2.4256"></a><span id="l2.4256"> </span>
<a href="#l2.4257"></a><span id="l2.4257">     try {</span>
<a href="#l2.4258"></a><span id="l2.4258">       var editor = GetCurrentTableEditor();</span>
<a href="#l2.4259"></a><span id="l2.4259">       editor.beginTransaction();</span>
<a href="#l2.4260"></a><span id="l2.4260"> </span>
<a href="#l2.4261"></a><span id="l2.4261">       // Loop to delete all blocks of contiguous, selected columns</span>
<a href="#l2.4262"></a><span id="l2.4262" class="difflineminus">-      while (columns)</span>
<a href="#l2.4263"></a><span id="l2.4263" class="difflineminus">-      {</span>
<a href="#l2.4264"></a><span id="l2.4264" class="difflineplus">+      while (columns) {</span>
<a href="#l2.4265"></a><span id="l2.4265">         editor.deleteTableColumn(columns);</span>
<a href="#l2.4266"></a><span id="l2.4266">         columns = GetNumberOfContiguousSelectedColumns();</span>
<a href="#l2.4267"></a><span id="l2.4267">       }</span>
<a href="#l2.4268"></a><span id="l2.4268">     } finally { editor.endTransaction(); }</span>
<a href="#l2.4269"></a><span id="l2.4269">     window.content.focus();</span>
<a href="#l2.4270"></a><span id="l2.4270" class="difflineminus">-  }</span>
<a href="#l2.4271"></a><span id="l2.4271" class="difflineplus">+  },</span>
<a href="#l2.4272"></a><span id="l2.4272"> };</span>
<a href="#l2.4273"></a><span id="l2.4273"> </span>
<a href="#l2.4274"></a><span id="l2.4274"> var nsDeleteTableCellCommand =</span>
<a href="#l2.4275"></a><span id="l2.4275"> {</span>
<a href="#l2.4276"></a><span id="l2.4276" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4277"></a><span id="l2.4277" class="difflineminus">-  {</span>
<a href="#l2.4278"></a><span id="l2.4278" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4279"></a><span id="l2.4279">     return IsInTableCell();</span>
<a href="#l2.4280"></a><span id="l2.4280">   },</span>
<a href="#l2.4281"></a><span id="l2.4281"> </span>
<a href="#l2.4282"></a><span id="l2.4282" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4283"></a><span id="l2.4283" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4284"></a><span id="l2.4284" class="difflineminus">-</span>
<a href="#l2.4285"></a><span id="l2.4285" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4286"></a><span id="l2.4286" class="difflineminus">-  {</span>
<a href="#l2.4287"></a><span id="l2.4287" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4288"></a><span id="l2.4288" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4289"></a><span id="l2.4289" class="difflineplus">+</span>
<a href="#l2.4290"></a><span id="l2.4290" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4291"></a><span id="l2.4291">     try {</span>
<a href="#l2.4292"></a><span id="l2.4292">       GetCurrentTableEditor().deleteTableCell(1);</span>
<a href="#l2.4293"></a><span id="l2.4293">     } catch (e) {}</span>
<a href="#l2.4294"></a><span id="l2.4294">     window.content.focus();</span>
<a href="#l2.4295"></a><span id="l2.4295" class="difflineminus">-  }</span>
<a href="#l2.4296"></a><span id="l2.4296" class="difflineplus">+  },</span>
<a href="#l2.4297"></a><span id="l2.4297"> };</span>
<a href="#l2.4298"></a><span id="l2.4298"> </span>
<a href="#l2.4299"></a><span id="l2.4299"> var nsDeleteTableCellContentsCommand =</span>
<a href="#l2.4300"></a><span id="l2.4300"> {</span>
<a href="#l2.4301"></a><span id="l2.4301" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4302"></a><span id="l2.4302" class="difflineminus">-  {</span>
<a href="#l2.4303"></a><span id="l2.4303" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4304"></a><span id="l2.4304">     return IsInTableCell();</span>
<a href="#l2.4305"></a><span id="l2.4305">   },</span>
<a href="#l2.4306"></a><span id="l2.4306"> </span>
<a href="#l2.4307"></a><span id="l2.4307" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4308"></a><span id="l2.4308" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4309"></a><span id="l2.4309" class="difflineminus">-</span>
<a href="#l2.4310"></a><span id="l2.4310" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4311"></a><span id="l2.4311" class="difflineminus">-  {</span>
<a href="#l2.4312"></a><span id="l2.4312" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4313"></a><span id="l2.4313" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4314"></a><span id="l2.4314" class="difflineplus">+</span>
<a href="#l2.4315"></a><span id="l2.4315" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4316"></a><span id="l2.4316">     try {</span>
<a href="#l2.4317"></a><span id="l2.4317">       GetCurrentTableEditor().deleteTableCellContents();</span>
<a href="#l2.4318"></a><span id="l2.4318">     } catch (e) {}</span>
<a href="#l2.4319"></a><span id="l2.4319">     window.content.focus();</span>
<a href="#l2.4320"></a><span id="l2.4320" class="difflineminus">-  }</span>
<a href="#l2.4321"></a><span id="l2.4321" class="difflineplus">+  },</span>
<a href="#l2.4322"></a><span id="l2.4322"> };</span>
<a href="#l2.4323"></a><span id="l2.4323"> </span>
<a href="#l2.4324"></a><span id="l2.4324"> </span>
<a href="#l2.4325"></a><span id="l2.4325" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.4326"></a><span id="l2.4326" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.4327"></a><span id="l2.4327"> var nsNormalizeTableCommand =</span>
<a href="#l2.4328"></a><span id="l2.4328"> {</span>
<a href="#l2.4329"></a><span id="l2.4329" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4330"></a><span id="l2.4330" class="difflineminus">-  {</span>
<a href="#l2.4331"></a><span id="l2.4331" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4332"></a><span id="l2.4332">     return IsInTable();</span>
<a href="#l2.4333"></a><span id="l2.4333">   },</span>
<a href="#l2.4334"></a><span id="l2.4334"> </span>
<a href="#l2.4335"></a><span id="l2.4335" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4336"></a><span id="l2.4336" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4337"></a><span id="l2.4337" class="difflineminus">-</span>
<a href="#l2.4338"></a><span id="l2.4338" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4339"></a><span id="l2.4339" class="difflineminus">-  {</span>
<a href="#l2.4340"></a><span id="l2.4340" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4341"></a><span id="l2.4341" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4342"></a><span id="l2.4342" class="difflineplus">+</span>
<a href="#l2.4343"></a><span id="l2.4343" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4344"></a><span id="l2.4344">     // Use nullptr to let editor find table enclosing current selection</span>
<a href="#l2.4345"></a><span id="l2.4345">     try {</span>
<a href="#l2.4346"></a><span id="l2.4346">       GetCurrentTableEditor().normalizeTable(null);</span>
<a href="#l2.4347"></a><span id="l2.4347">     } catch (e) {}</span>
<a href="#l2.4348"></a><span id="l2.4348">     window.content.focus();</span>
<a href="#l2.4349"></a><span id="l2.4349" class="difflineminus">-  }</span>
<a href="#l2.4350"></a><span id="l2.4350" class="difflineplus">+  },</span>
<a href="#l2.4351"></a><span id="l2.4351"> };</span>
<a href="#l2.4352"></a><span id="l2.4352"> </span>
<a href="#l2.4353"></a><span id="l2.4353" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.4354"></a><span id="l2.4354" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.4355"></a><span id="l2.4355"> var nsJoinTableCellsCommand =</span>
<a href="#l2.4356"></a><span id="l2.4356"> {</span>
<a href="#l2.4357"></a><span id="l2.4357" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4358"></a><span id="l2.4358" class="difflineminus">-  {</span>
<a href="#l2.4359"></a><span id="l2.4359" class="difflineminus">-    if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML())</span>
<a href="#l2.4360"></a><span id="l2.4360" class="difflineminus">-    {</span>
<a href="#l2.4361"></a><span id="l2.4361" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4362"></a><span id="l2.4362" class="difflineplus">+    if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()) {</span>
<a href="#l2.4363"></a><span id="l2.4363">       try {</span>
<a href="#l2.4364"></a><span id="l2.4364">         var editor = GetCurrentTableEditor();</span>
<a href="#l2.4365"></a><span id="l2.4365">         var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l2.4366"></a><span id="l2.4366">         var countObj = { value: 0 };</span>
<a href="#l2.4367"></a><span id="l2.4367">         var cell = editor.getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l2.4368"></a><span id="l2.4368"> </span>
<a href="#l2.4369"></a><span id="l2.4369">         // We need a cell and either &gt; 1 selected cell or a cell to the right</span>
<a href="#l2.4370"></a><span id="l2.4370">         //  (this cell may originate in a row spanned from above current row)</span>
<a href="#l2.4371"></a><span id="l2.4371">         // Note that editor returns &quot;td&quot; for &quot;th&quot; also.</span>
<a href="#l2.4372"></a><span id="l2.4372">         // (this is a pain! Editor and gecko use lowercase tagNames, JS uses uppercase!)</span>
<a href="#l2.4373"></a><span id="l2.4373" class="difflineminus">-        if (cell &amp;&amp; (tagNameObj.value == &quot;td&quot;))</span>
<a href="#l2.4374"></a><span id="l2.4374" class="difflineminus">-        {</span>
<a href="#l2.4375"></a><span id="l2.4375" class="difflineplus">+        if (cell &amp;&amp; (tagNameObj.value == &quot;td&quot;)) {</span>
<a href="#l2.4376"></a><span id="l2.4376">           // Selected cells</span>
<a href="#l2.4377"></a><span id="l2.4377">           if (countObj.value &gt; 1) return true;</span>
<a href="#l2.4378"></a><span id="l2.4378"> </span>
<a href="#l2.4379"></a><span id="l2.4379">           var colSpan = cell.getAttribute(&quot;colspan&quot;);</span>
<a href="#l2.4380"></a><span id="l2.4380"> </span>
<a href="#l2.4381"></a><span id="l2.4381">           // getAttribute returns string, we need number</span>
<a href="#l2.4382"></a><span id="l2.4382">           // no attribute means colspan = 1</span>
<a href="#l2.4383"></a><span id="l2.4383">           if (!colSpan)</span>
<a href="#l2.4384"></a><span id="l2.4384" class="difflineat">@@ -3710,185 +3352,166 @@ var nsJoinTableCellsCommand =</span>
<a href="#l2.4385"></a><span id="l2.4385">           return (colSpan &amp;&amp; editor.getCellAt(null, rowObj.value,</span>
<a href="#l2.4386"></a><span id="l2.4386">                                               colObj.value + colSpan));</span>
<a href="#l2.4387"></a><span id="l2.4387">         }</span>
<a href="#l2.4388"></a><span id="l2.4388">       } catch (e) {}</span>
<a href="#l2.4389"></a><span id="l2.4389">     }</span>
<a href="#l2.4390"></a><span id="l2.4390">     return false;</span>
<a href="#l2.4391"></a><span id="l2.4391">   },</span>
<a href="#l2.4392"></a><span id="l2.4392"> </span>
<a href="#l2.4393"></a><span id="l2.4393" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4394"></a><span id="l2.4394" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4395"></a><span id="l2.4395" class="difflineminus">-</span>
<a href="#l2.4396"></a><span id="l2.4396" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4397"></a><span id="l2.4397" class="difflineminus">-  {</span>
<a href="#l2.4398"></a><span id="l2.4398" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4399"></a><span id="l2.4399" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4400"></a><span id="l2.4400" class="difflineplus">+</span>
<a href="#l2.4401"></a><span id="l2.4401" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4402"></a><span id="l2.4402">     // Param: Don't merge non-contiguous cells</span>
<a href="#l2.4403"></a><span id="l2.4403">     try {</span>
<a href="#l2.4404"></a><span id="l2.4404">       GetCurrentTableEditor().joinTableCells(false);</span>
<a href="#l2.4405"></a><span id="l2.4405">     } catch (e) {}</span>
<a href="#l2.4406"></a><span id="l2.4406">     window.content.focus();</span>
<a href="#l2.4407"></a><span id="l2.4407" class="difflineminus">-  }</span>
<a href="#l2.4408"></a><span id="l2.4408" class="difflineplus">+  },</span>
<a href="#l2.4409"></a><span id="l2.4409"> };</span>
<a href="#l2.4410"></a><span id="l2.4410"> </span>
<a href="#l2.4411"></a><span id="l2.4411" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.4412"></a><span id="l2.4412" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.4413"></a><span id="l2.4413"> var nsSplitTableCellCommand =</span>
<a href="#l2.4414"></a><span id="l2.4414"> {</span>
<a href="#l2.4415"></a><span id="l2.4415" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4416"></a><span id="l2.4416" class="difflineminus">-  {</span>
<a href="#l2.4417"></a><span id="l2.4417" class="difflineminus">-    if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML())</span>
<a href="#l2.4418"></a><span id="l2.4418" class="difflineminus">-    {</span>
<a href="#l2.4419"></a><span id="l2.4419" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4420"></a><span id="l2.4420" class="difflineplus">+    if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()) {</span>
<a href="#l2.4421"></a><span id="l2.4421">       var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l2.4422"></a><span id="l2.4422">       var countObj = { value: 0 };</span>
<a href="#l2.4423"></a><span id="l2.4423">       var cell;</span>
<a href="#l2.4424"></a><span id="l2.4424">       try {</span>
<a href="#l2.4425"></a><span id="l2.4425">         cell = GetCurrentTableEditor().getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l2.4426"></a><span id="l2.4426">       } catch (e) {}</span>
<a href="#l2.4427"></a><span id="l2.4427"> </span>
<a href="#l2.4428"></a><span id="l2.4428">       // We need a cell parent and there's just 1 selected cell</span>
<a href="#l2.4429"></a><span id="l2.4429">       // or selection is entirely inside 1 cell</span>
<a href="#l2.4430"></a><span id="l2.4430" class="difflineminus">-      if ( cell &amp;&amp; (tagNameObj.value == &quot;td&quot;) &amp;&amp;</span>
<a href="#l2.4431"></a><span id="l2.4431" class="difflineplus">+      if (cell &amp;&amp; (tagNameObj.value == &quot;td&quot;) &amp;&amp;</span>
<a href="#l2.4432"></a><span id="l2.4432">            countObj.value &lt;= 1 &amp;&amp;</span>
<a href="#l2.4433"></a><span id="l2.4433" class="difflineminus">-           IsSelectionInOneCell() )</span>
<a href="#l2.4434"></a><span id="l2.4434" class="difflineminus">-      {</span>
<a href="#l2.4435"></a><span id="l2.4435" class="difflineplus">+           IsSelectionInOneCell()) {</span>
<a href="#l2.4436"></a><span id="l2.4436">         var colSpan = cell.getAttribute(&quot;colspan&quot;);</span>
<a href="#l2.4437"></a><span id="l2.4437">         var rowSpan = cell.getAttribute(&quot;rowspan&quot;);</span>
<a href="#l2.4438"></a><span id="l2.4438">         if (!colSpan) colSpan = 1;</span>
<a href="#l2.4439"></a><span id="l2.4439">         if (!rowSpan) rowSpan = 1;</span>
<a href="#l2.4440"></a><span id="l2.4440" class="difflineminus">-        return (colSpan &gt; 1  || rowSpan &gt; 1 ||</span>
<a href="#l2.4441"></a><span id="l2.4441" class="difflineplus">+        return (colSpan &gt; 1 || rowSpan &gt; 1 ||</span>
<a href="#l2.4442"></a><span id="l2.4442">                 colSpan == 0 || rowSpan == 0);</span>
<a href="#l2.4443"></a><span id="l2.4443">       }</span>
<a href="#l2.4444"></a><span id="l2.4444">     }</span>
<a href="#l2.4445"></a><span id="l2.4445">     return false;</span>
<a href="#l2.4446"></a><span id="l2.4446">   },</span>
<a href="#l2.4447"></a><span id="l2.4447"> </span>
<a href="#l2.4448"></a><span id="l2.4448" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4449"></a><span id="l2.4449" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4450"></a><span id="l2.4450" class="difflineminus">-</span>
<a href="#l2.4451"></a><span id="l2.4451" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4452"></a><span id="l2.4452" class="difflineminus">-  {</span>
<a href="#l2.4453"></a><span id="l2.4453" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4454"></a><span id="l2.4454" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4455"></a><span id="l2.4455" class="difflineplus">+</span>
<a href="#l2.4456"></a><span id="l2.4456" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4457"></a><span id="l2.4457">     try {</span>
<a href="#l2.4458"></a><span id="l2.4458">       GetCurrentTableEditor().splitTableCell();</span>
<a href="#l2.4459"></a><span id="l2.4459">     } catch (e) {}</span>
<a href="#l2.4460"></a><span id="l2.4460">     window.content.focus();</span>
<a href="#l2.4461"></a><span id="l2.4461" class="difflineminus">-  }</span>
<a href="#l2.4462"></a><span id="l2.4462" class="difflineplus">+  },</span>
<a href="#l2.4463"></a><span id="l2.4463"> };</span>
<a href="#l2.4464"></a><span id="l2.4464"> </span>
<a href="#l2.4465"></a><span id="l2.4465" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.4466"></a><span id="l2.4466" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.4467"></a><span id="l2.4467"> var nsTableOrCellColorCommand =</span>
<a href="#l2.4468"></a><span id="l2.4468"> {</span>
<a href="#l2.4469"></a><span id="l2.4469" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4470"></a><span id="l2.4470" class="difflineminus">-  {</span>
<a href="#l2.4471"></a><span id="l2.4471" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4472"></a><span id="l2.4472">     return IsInTable();</span>
<a href="#l2.4473"></a><span id="l2.4473">   },</span>
<a href="#l2.4474"></a><span id="l2.4474"> </span>
<a href="#l2.4475"></a><span id="l2.4475" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4476"></a><span id="l2.4476" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4477"></a><span id="l2.4477" class="difflineminus">-</span>
<a href="#l2.4478"></a><span id="l2.4478" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4479"></a><span id="l2.4479" class="difflineminus">-  {</span>
<a href="#l2.4480"></a><span id="l2.4480" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4481"></a><span id="l2.4481" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4482"></a><span id="l2.4482" class="difflineplus">+</span>
<a href="#l2.4483"></a><span id="l2.4483" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4484"></a><span id="l2.4484">     EditorSelectColor(&quot;TableOrCell&quot;);</span>
<a href="#l2.4485"></a><span id="l2.4485" class="difflineminus">-  }</span>
<a href="#l2.4486"></a><span id="l2.4486" class="difflineplus">+  },</span>
<a href="#l2.4487"></a><span id="l2.4487"> };</span>
<a href="#l2.4488"></a><span id="l2.4488"> </span>
<a href="#l2.4489"></a><span id="l2.4489" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l2.4490"></a><span id="l2.4490" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l2.4491"></a><span id="l2.4491"> var nsPreferencesCommand =</span>
<a href="#l2.4492"></a><span id="l2.4492"> {</span>
<a href="#l2.4493"></a><span id="l2.4493" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4494"></a><span id="l2.4494" class="difflineminus">-  {</span>
<a href="#l2.4495"></a><span id="l2.4495" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4496"></a><span id="l2.4496">     return true;</span>
<a href="#l2.4497"></a><span id="l2.4497">   },</span>
<a href="#l2.4498"></a><span id="l2.4498"> </span>
<a href="#l2.4499"></a><span id="l2.4499" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4500"></a><span id="l2.4500" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4501"></a><span id="l2.4501" class="difflineminus">-</span>
<a href="#l2.4502"></a><span id="l2.4502" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4503"></a><span id="l2.4503" class="difflineminus">-  {</span>
<a href="#l2.4504"></a><span id="l2.4504" class="difflineminus">-    goPreferences('composer_pane');</span>
<a href="#l2.4505"></a><span id="l2.4505" class="difflineminus">-  }</span>
<a href="#l2.4506"></a><span id="l2.4506" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4507"></a><span id="l2.4507" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4508"></a><span id="l2.4508" class="difflineplus">+</span>
<a href="#l2.4509"></a><span id="l2.4509" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4510"></a><span id="l2.4510" class="difflineplus">+    goPreferences(&quot;composer_pane&quot;);</span>
<a href="#l2.4511"></a><span id="l2.4511" class="difflineplus">+  },</span>
<a href="#l2.4512"></a><span id="l2.4512"> };</span>
<a href="#l2.4513"></a><span id="l2.4513"> </span>
<a href="#l2.4514"></a><span id="l2.4514"> </span>
<a href="#l2.4515"></a><span id="l2.4515"> var nsFinishHTMLSource =</span>
<a href="#l2.4516"></a><span id="l2.4516"> {</span>
<a href="#l2.4517"></a><span id="l2.4517" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4518"></a><span id="l2.4518" class="difflineminus">-  {</span>
<a href="#l2.4519"></a><span id="l2.4519" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4520"></a><span id="l2.4520">     return true;</span>
<a href="#l2.4521"></a><span id="l2.4521">   },</span>
<a href="#l2.4522"></a><span id="l2.4522"> </span>
<a href="#l2.4523"></a><span id="l2.4523" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4524"></a><span id="l2.4524" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4525"></a><span id="l2.4525" class="difflineminus">-</span>
<a href="#l2.4526"></a><span id="l2.4526" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4527"></a><span id="l2.4527" class="difflineminus">-  {</span>
<a href="#l2.4528"></a><span id="l2.4528" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4529"></a><span id="l2.4529" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4530"></a><span id="l2.4530" class="difflineplus">+</span>
<a href="#l2.4531"></a><span id="l2.4531" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4532"></a><span id="l2.4532">     // In editor.js</span>
<a href="#l2.4533"></a><span id="l2.4533">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.4534"></a><span id="l2.4534" class="difflineminus">-  }</span>
<a href="#l2.4535"></a><span id="l2.4535" class="difflineplus">+  },</span>
<a href="#l2.4536"></a><span id="l2.4536"> };</span>
<a href="#l2.4537"></a><span id="l2.4537"> </span>
<a href="#l2.4538"></a><span id="l2.4538"> var nsCancelHTMLSource =</span>
<a href="#l2.4539"></a><span id="l2.4539"> {</span>
<a href="#l2.4540"></a><span id="l2.4540" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4541"></a><span id="l2.4541" class="difflineminus">-  {</span>
<a href="#l2.4542"></a><span id="l2.4542" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4543"></a><span id="l2.4543">     return true;</span>
<a href="#l2.4544"></a><span id="l2.4544">   },</span>
<a href="#l2.4545"></a><span id="l2.4545"> </span>
<a href="#l2.4546"></a><span id="l2.4546" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4547"></a><span id="l2.4547" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4548"></a><span id="l2.4548" class="difflineminus">-</span>
<a href="#l2.4549"></a><span id="l2.4549" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4550"></a><span id="l2.4550" class="difflineminus">-  {</span>
<a href="#l2.4551"></a><span id="l2.4551" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4552"></a><span id="l2.4552" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4553"></a><span id="l2.4553" class="difflineplus">+</span>
<a href="#l2.4554"></a><span id="l2.4554" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4555"></a><span id="l2.4555">     // In editor.js</span>
<a href="#l2.4556"></a><span id="l2.4556">     CancelHTMLSource();</span>
<a href="#l2.4557"></a><span id="l2.4557" class="difflineminus">-  }</span>
<a href="#l2.4558"></a><span id="l2.4558" class="difflineplus">+  },</span>
<a href="#l2.4559"></a><span id="l2.4559"> };</span>
<a href="#l2.4560"></a><span id="l2.4560"> </span>
<a href="#l2.4561"></a><span id="l2.4561"> var nsConvertToTable =</span>
<a href="#l2.4562"></a><span id="l2.4562"> {</span>
<a href="#l2.4563"></a><span id="l2.4563" class="difflineminus">-  isCommandEnabled: function(aCommand, dummy)</span>
<a href="#l2.4564"></a><span id="l2.4564" class="difflineminus">-  {</span>
<a href="#l2.4565"></a><span id="l2.4565" class="difflineminus">-    if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML())</span>
<a href="#l2.4566"></a><span id="l2.4566" class="difflineminus">-    {</span>
<a href="#l2.4567"></a><span id="l2.4567" class="difflineplus">+  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.4568"></a><span id="l2.4568" class="difflineplus">+    if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()) {</span>
<a href="#l2.4569"></a><span id="l2.4569">       var selection;</span>
<a href="#l2.4570"></a><span id="l2.4570">       try {</span>
<a href="#l2.4571"></a><span id="l2.4571">         selection = GetCurrentEditor().selection;</span>
<a href="#l2.4572"></a><span id="l2.4572">       } catch (e) {}</span>
<a href="#l2.4573"></a><span id="l2.4573"> </span>
<a href="#l2.4574"></a><span id="l2.4574" class="difflineminus">-      if (selection &amp;&amp; !selection.isCollapsed)</span>
<a href="#l2.4575"></a><span id="l2.4575" class="difflineminus">-      {</span>
<a href="#l2.4576"></a><span id="l2.4576" class="difflineplus">+      if (selection &amp;&amp; !selection.isCollapsed) {</span>
<a href="#l2.4577"></a><span id="l2.4577">         // Don't allow if table or cell is the selection</span>
<a href="#l2.4578"></a><span id="l2.4578">         var element;</span>
<a href="#l2.4579"></a><span id="l2.4579">         try {</span>
<a href="#l2.4580"></a><span id="l2.4580">           element = GetCurrentEditor().getSelectedElement(&quot;&quot;);</span>
<a href="#l2.4581"></a><span id="l2.4581">         } catch (e) {}</span>
<a href="#l2.4582"></a><span id="l2.4582" class="difflineminus">-        if (element)</span>
<a href="#l2.4583"></a><span id="l2.4583" class="difflineminus">-        {</span>
<a href="#l2.4584"></a><span id="l2.4584" class="difflineplus">+        if (element) {</span>
<a href="#l2.4585"></a><span id="l2.4585">           var name = element.nodeName.toLowerCase();</span>
<a href="#l2.4586"></a><span id="l2.4586">           if (name == &quot;td&quot; ||</span>
<a href="#l2.4587"></a><span id="l2.4587">               name == &quot;th&quot; ||</span>
<a href="#l2.4588"></a><span id="l2.4588">               name == &quot;caption&quot; ||</span>
<a href="#l2.4589"></a><span id="l2.4589">               name == &quot;table&quot;)</span>
<a href="#l2.4590"></a><span id="l2.4590">             return false;</span>
<a href="#l2.4591"></a><span id="l2.4591">         }</span>
<a href="#l2.4592"></a><span id="l2.4592"> </span>
<a href="#l2.4593"></a><span id="l2.4593">         // Selection start and end must be in the same cell</span>
<a href="#l2.4594"></a><span id="l2.4594">         //   in same cell or both are NOT in a cell</span>
<a href="#l2.4595"></a><span id="l2.4595" class="difflineminus">-        if ( GetParentTableCell(selection.focusNode) !=</span>
<a href="#l2.4596"></a><span id="l2.4596" class="difflineminus">-             GetParentTableCell(selection.anchorNode) )</span>
<a href="#l2.4597"></a><span id="l2.4597" class="difflineminus">-          return false</span>
<a href="#l2.4598"></a><span id="l2.4598" class="difflineplus">+        if (GetParentTableCell(selection.focusNode) !=</span>
<a href="#l2.4599"></a><span id="l2.4599" class="difflineplus">+             GetParentTableCell(selection.anchorNode))</span>
<a href="#l2.4600"></a><span id="l2.4600" class="difflineplus">+          return false;</span>
<a href="#l2.4601"></a><span id="l2.4601"> </span>
<a href="#l2.4602"></a><span id="l2.4602">         return true;</span>
<a href="#l2.4603"></a><span id="l2.4603">       }</span>
<a href="#l2.4604"></a><span id="l2.4604">     }</span>
<a href="#l2.4605"></a><span id="l2.4605">     return false;</span>
<a href="#l2.4606"></a><span id="l2.4606">   },</span>
<a href="#l2.4607"></a><span id="l2.4607"> </span>
<a href="#l2.4608"></a><span id="l2.4608" class="difflineminus">-  getCommandStateParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4609"></a><span id="l2.4609" class="difflineminus">-  doCommandParams: function(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4610"></a><span id="l2.4610" class="difflineminus">-</span>
<a href="#l2.4611"></a><span id="l2.4611" class="difflineminus">-  doCommand: function(aCommand)</span>
<a href="#l2.4612"></a><span id="l2.4612" class="difflineminus">-  {</span>
<a href="#l2.4613"></a><span id="l2.4613" class="difflineminus">-    if (this.isCommandEnabled())</span>
<a href="#l2.4614"></a><span id="l2.4614" class="difflineminus">-    {</span>
<a href="#l2.4615"></a><span id="l2.4615" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdConvertToTable.xul&quot;,&quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;)</span>
<a href="#l2.4616"></a><span id="l2.4616" class="difflineplus">+  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4617"></a><span id="l2.4617" class="difflineplus">+  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.4618"></a><span id="l2.4618" class="difflineplus">+</span>
<a href="#l2.4619"></a><span id="l2.4619" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l2.4620"></a><span id="l2.4620" class="difflineplus">+    if (this.isCommandEnabled()) {</span>
<a href="#l2.4621"></a><span id="l2.4621" class="difflineplus">+      window.openDialog(&quot;chrome://editor/content/EdConvertToTable.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.4622"></a><span id="l2.4622">     }</span>
<a href="#l2.4623"></a><span id="l2.4623" class="difflineminus">-  }</span>
<a href="#l2.4624"></a><span id="l2.4624" class="difflineplus">+  },</span>
<a href="#l2.4625"></a><span id="l2.4625"> };</span>
<a href="#l2.4626"></a><span id="l2.4626"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/editor/ui/composer/content/editor.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/editor/ui/composer/content/editor.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -33,33 +33,33 @@ var gDocWasModified = false;  // Check i</span>
<a href="#l3.4"></a><span id="l3.4"> var gContentWindow = 0;</span>
<a href="#l3.5"></a><span id="l3.5"> var gSourceContentWindow = 0;</span>
<a href="#l3.6"></a><span id="l3.6"> var gSourceTextEditor = null;</span>
<a href="#l3.7"></a><span id="l3.7"> var gContentWindowDeck;</span>
<a href="#l3.8"></a><span id="l3.8"> var gFormatToolbar;</span>
<a href="#l3.9"></a><span id="l3.9"> var gFormatToolbarHidden = false;</span>
<a href="#l3.10"></a><span id="l3.10"> var gViewFormatToolbar;</span>
<a href="#l3.11"></a><span id="l3.11"> var gChromeState;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-var gColorObj = { LastTextColor:&quot;&quot;, LastBackgroundColor:&quot;&quot;, LastHighlightColor:&quot;&quot;,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                  Type:&quot;&quot;, SelectedType:&quot;&quot;, NoDefault:false, Cancel:false,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-                  HighlightColor:&quot;&quot;, BackgroundColor:&quot;&quot;, PageColor:&quot;&quot;,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                  TextColor:&quot;&quot;, TableColor:&quot;&quot;, CellColor:&quot;&quot;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+var gColorObj = { LastTextColor: &quot;&quot;, LastBackgroundColor: &quot;&quot;, LastHighlightColor: &quot;&quot;,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+                  Type: &quot;&quot;, SelectedType: &quot;&quot;, NoDefault: false, Cancel: false,</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+                  HighlightColor: &quot;&quot;, BackgroundColor: &quot;&quot;, PageColor: &quot;&quot;,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+                  TextColor: &quot;&quot;, TableColor: &quot;&quot;, CellColor: &quot;&quot;,</span>
<a href="#l3.20"></a><span id="l3.20">                 };</span>
<a href="#l3.21"></a><span id="l3.21"> var gDefaultTextColor = &quot;&quot;;</span>
<a href="#l3.22"></a><span id="l3.22"> var gDefaultBackgroundColor = &quot;&quot;;</span>
<a href="#l3.23"></a><span id="l3.23"> var gCSSPrefListener;</span>
<a href="#l3.24"></a><span id="l3.24"> var gEditorToolbarPrefListener;</span>
<a href="#l3.25"></a><span id="l3.25"> var gReturnInParagraphPrefListener;</span>
<a href="#l3.26"></a><span id="l3.26"> var gLocalFonts = null;</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28"> var gLastFocusNode = null;</span>
<a href="#l3.29"></a><span id="l3.29"> var gLastFocusNodeWasSelected = false;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31"> // These must be kept in synch with the XUL &lt;options&gt; lists</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-var gFontSizeNames = [&quot;xx-small&quot;,&quot;x-small&quot;,&quot;small&quot;,&quot;medium&quot;,&quot;large&quot;,&quot;x-large&quot;,&quot;xx-large&quot;];</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+var gFontSizeNames = [&quot;xx-small&quot;, &quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot;];</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35"> var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37"> var kEditorToolbarPrefs = &quot;editor.toolbars.showbutton.&quot;;</span>
<a href="#l3.38"></a><span id="l3.38"> var kUseCssPref         = &quot;editor.use_css&quot;;</span>
<a href="#l3.39"></a><span id="l3.39"> var kCRInParagraphsPref = &quot;editor.CR_creates_new_p&quot;;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41"> function ShowHideToolbarSeparators(toolbar) {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineat">@@ -78,196 +78,177 @@ function ShowHideToolbarSeparators(toolb</span>
<a href="#l3.43"></a><span id="l3.43">       if (separator)</span>
<a href="#l3.44"></a><span id="l3.44">         separator.hidden = hideSeparator;</span>
<a href="#l3.45"></a><span id="l3.45">       separator = null;</span>
<a href="#l3.46"></a><span id="l3.46">       hideSeparator = false;</span>
<a href="#l3.47"></a><span id="l3.47">     }</span>
<a href="#l3.48"></a><span id="l3.48">   }</span>
<a href="#l3.49"></a><span id="l3.49"> }</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-function ShowHideToolbarButtons()</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-{</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+function ShowHideToolbarButtons() {</span>
<a href="#l3.54"></a><span id="l3.54">   let array = Services.prefs.getChildList(kEditorToolbarPrefs);</span>
<a href="#l3.55"></a><span id="l3.55">   for (let i in array) {</span>
<a href="#l3.56"></a><span id="l3.56">     let prefName = array[i];</span>
<a href="#l3.57"></a><span id="l3.57">     let id = prefName.substr(kEditorToolbarPrefs.length);</span>
<a href="#l3.58"></a><span id="l3.58">     let button = document.getElementById(id + &quot;Button&quot;) ||</span>
<a href="#l3.59"></a><span id="l3.59">                  document.getElementById(id + &quot;-button&quot;);</span>
<a href="#l3.60"></a><span id="l3.60">     if (button)</span>
<a href="#l3.61"></a><span id="l3.61">       button.hidden = !Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.62"></a><span id="l3.62">   }</span>
<a href="#l3.63"></a><span id="l3.63">   ShowHideToolbarSeparators(document.getElementById(&quot;EditToolbar&quot;));</span>
<a href="#l3.64"></a><span id="l3.64">   ShowHideToolbarSeparators(document.getElementById(&quot;FormatToolbar&quot;));</span>
<a href="#l3.65"></a><span id="l3.65"> }</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-function nsPrefListener(prefName)</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-{</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+function nsPrefListener(prefName) {</span>
<a href="#l3.70"></a><span id="l3.70">   this.startup(prefName);</span>
<a href="#l3.71"></a><span id="l3.71"> }</span>
<a href="#l3.72"></a><span id="l3.72"> </span>
<a href="#l3.73"></a><span id="l3.73"> // implements nsIObserver</span>
<a href="#l3.74"></a><span id="l3.74"> nsPrefListener.prototype =</span>
<a href="#l3.75"></a><span id="l3.75"> {</span>
<a href="#l3.76"></a><span id="l3.76">   domain: &quot;&quot;,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  startup: function(prefName)</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  {</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  startup(prefName) {</span>
<a href="#l3.80"></a><span id="l3.80">     this.domain = prefName;</span>
<a href="#l3.81"></a><span id="l3.81">     try {</span>
<a href="#l3.82"></a><span id="l3.82">       Services.prefs.addObserver(this.domain, this);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    } catch(ex) {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.85"></a><span id="l3.85">       dump(&quot;Failed to observe prefs: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.86"></a><span id="l3.86">     }</span>
<a href="#l3.87"></a><span id="l3.87">   },</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-  shutdown: function()</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-  {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  shutdown() {</span>
<a href="#l3.91"></a><span id="l3.91">     try {</span>
<a href="#l3.92"></a><span id="l3.92">       Services.prefs.removeObserver(this.domain, this);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-    } catch(ex) {</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.95"></a><span id="l3.95">       dump(&quot;Failed to remove pref observers: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.96"></a><span id="l3.96">     }</span>
<a href="#l3.97"></a><span id="l3.97">   },</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-  observe: function(subject, topic, prefName)</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-  {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+  observe(subject, topic, prefName) {</span>
<a href="#l3.101"></a><span id="l3.101">     if (!IsHTMLEditor())</span>
<a href="#l3.102"></a><span id="l3.102">       return;</span>
<a href="#l3.103"></a><span id="l3.103">     // verify that we're changing a button pref</span>
<a href="#l3.104"></a><span id="l3.104">     if (topic != &quot;nsPref:changed&quot;)</span>
<a href="#l3.105"></a><span id="l3.105">       return;</span>
<a href="#l3.106"></a><span id="l3.106"> </span>
<a href="#l3.107"></a><span id="l3.107">     let editor = GetCurrentEditor();</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-    if (prefName == kUseCssPref)</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-    {</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+    if (prefName == kUseCssPref) {</span>
<a href="#l3.111"></a><span id="l3.111">       let cmd = document.getElementById(&quot;cmd_highlight&quot;);</span>
<a href="#l3.112"></a><span id="l3.112">       if (cmd) {</span>
<a href="#l3.113"></a><span id="l3.113">         let useCSS = Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.114"></a><span id="l3.114"> </span>
<a href="#l3.115"></a><span id="l3.115">         if (useCSS &amp;&amp; editor) {</span>
<a href="#l3.116"></a><span id="l3.116">           let mixedObj = {};</span>
<a href="#l3.117"></a><span id="l3.117">           let state = editor.getHighlightColorState(mixedObj);</span>
<a href="#l3.118"></a><span id="l3.118">           cmd.setAttribute(&quot;state&quot;, state);</span>
<a href="#l3.119"></a><span id="l3.119">           cmd.collapsed = false;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-        }</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-        else {</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+        } else {</span>
<a href="#l3.123"></a><span id="l3.123">           cmd.setAttribute(&quot;state&quot;, &quot;transparent&quot;);</span>
<a href="#l3.124"></a><span id="l3.124">           cmd.collapsed = true;</span>
<a href="#l3.125"></a><span id="l3.125">         }</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127">         if (editor)</span>
<a href="#l3.128"></a><span id="l3.128">           editor.isCSSEnabled = useCSS;</span>
<a href="#l3.129"></a><span id="l3.129">       }</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-    }</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    else if (prefName.startsWith(kEditorToolbarPrefs))</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-    {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    } else if (prefName.startsWith(kEditorToolbarPrefs)) {</span>
<a href="#l3.134"></a><span id="l3.134">       let id = prefName.substr(kEditorToolbarPrefs.length) + &quot;Button&quot;;</span>
<a href="#l3.135"></a><span id="l3.135">       let button = document.getElementById(id);</span>
<a href="#l3.136"></a><span id="l3.136">       if (button) {</span>
<a href="#l3.137"></a><span id="l3.137">         button.hidden = !Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.138"></a><span id="l3.138">         ShowHideToolbarSeparators(button.parentNode);</span>
<a href="#l3.139"></a><span id="l3.139">       }</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-    }</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-    else if (editor &amp;&amp; (prefName == kCRInParagraphsPref))</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+    } else if (editor &amp;&amp; (prefName == kCRInParagraphsPref))</span>
<a href="#l3.143"></a><span id="l3.143">       editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-  }</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-}</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+  },</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+};</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149"> const gSourceTextListener =</span>
<a href="#l3.150"></a><span id="l3.150"> {</span>
<a href="#l3.151"></a><span id="l3.151">   NotifyDocumentCreated: function NotifyDocumentCreated() {},</span>
<a href="#l3.152"></a><span id="l3.152">   NotifyDocumentWillBeDestroyed: function NotifyDocumentWillBeDestroyed() {},</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-  NotifyDocumentStateChanged: function NotifyDocumentStateChanged(isChanged)</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-  {</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  NotifyDocumentStateChanged: function NotifyDocumentStateChanged(isChanged) {</span>
<a href="#l3.156"></a><span id="l3.156">     window.updateCommands(&quot;save&quot;);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-  }</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+  },</span>
<a href="#l3.159"></a><span id="l3.159"> };</span>
<a href="#l3.160"></a><span id="l3.160"> </span>
<a href="#l3.161"></a><span id="l3.161"> const gSourceTextObserver =</span>
<a href="#l3.162"></a><span id="l3.162"> {</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-  observe: function observe(aSubject, aTopic, aData)</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-  {</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+  observe: function observe(aSubject, aTopic, aData) {</span>
<a href="#l3.166"></a><span id="l3.166">     // we currently only use this to update undo</span>
<a href="#l3.167"></a><span id="l3.167">     window.updateCommands(&quot;undo&quot;);</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-  }</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+  },</span>
<a href="#l3.170"></a><span id="l3.170"> };</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172"> // This should be called by all editor users when they close their window.</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-function EditorCleanup()</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-{</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+function EditorCleanup() {</span>
<a href="#l3.176"></a><span id="l3.176">   SwitchInsertCharToAnotherEditorOrClose();</span>
<a href="#l3.177"></a><span id="l3.177"> }</span>
<a href="#l3.178"></a><span id="l3.178"> </span>
<a href="#l3.179"></a><span id="l3.179"> var DocumentReloadListener =</span>
<a href="#l3.180"></a><span id="l3.180"> {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-  NotifyDocumentCreated: function() {},</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-  NotifyDocumentWillBeDestroyed: function() {},</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-  NotifyDocumentStateChanged:function( isNowDirty )</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-  {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  NotifyDocumentCreated() {},</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+  NotifyDocumentWillBeDestroyed() {},</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+  NotifyDocumentStateChanged(isNowDirty) {</span>
<a href="#l3.190"></a><span id="l3.190">     var editor = GetCurrentEditor();</span>
<a href="#l3.191"></a><span id="l3.191">     try {</span>
<a href="#l3.192"></a><span id="l3.192">       // unregister the listener to prevent multiple callbacks</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-      editor.removeDocumentStateListener( DocumentReloadListener );</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+      editor.removeDocumentStateListener(DocumentReloadListener);</span>
<a href="#l3.195"></a><span id="l3.195"> </span>
<a href="#l3.196"></a><span id="l3.196">       var charset = editor.documentCharacterSet;</span>
<a href="#l3.197"></a><span id="l3.197"> </span>
<a href="#l3.198"></a><span id="l3.198">       // update the META charset with the current presentation charset</span>
<a href="#l3.199"></a><span id="l3.199">       editor.documentCharacterSet = charset;</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-</span>
<a href="#l3.201"></a><span id="l3.201">     } catch (e) {}</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-  }</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+  },</span>
<a href="#l3.204"></a><span id="l3.204"> };</span>
<a href="#l3.205"></a><span id="l3.205"> </span>
<a href="#l3.206"></a><span id="l3.206"> // implements nsIObserver</span>
<a href="#l3.207"></a><span id="l3.207"> var gEditorDocumentObserver =</span>
<a href="#l3.208"></a><span id="l3.208"> {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-  observe: function(aSubject, aTopic, aData)</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-  {</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l3.212"></a><span id="l3.212">     // Should we allow this even if NOT the focused editor?</span>
<a href="#l3.213"></a><span id="l3.213">     var commandManager = GetCurrentCommandManager();</span>
<a href="#l3.214"></a><span id="l3.214">     if (commandManager != aSubject)</span>
<a href="#l3.215"></a><span id="l3.215">       return;</span>
<a href="#l3.216"></a><span id="l3.216"> </span>
<a href="#l3.217"></a><span id="l3.217">     var editor = GetCurrentEditor();</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-    switch(aTopic)</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l3.221"></a><span id="l3.221">       case &quot;obs_documentCreated&quot;:</span>
<a href="#l3.222"></a><span id="l3.222">         // Just for convenience</span>
<a href="#l3.223"></a><span id="l3.223">         gContentWindow = window.content;</span>
<a href="#l3.224"></a><span id="l3.224"> </span>
<a href="#l3.225"></a><span id="l3.225">         // Get state to see if document creation succeeded</span>
<a href="#l3.226"></a><span id="l3.226">         var params = newCommandParams();</span>
<a href="#l3.227"></a><span id="l3.227">         if (!params)</span>
<a href="#l3.228"></a><span id="l3.228">           return;</span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230">         try {</span>
<a href="#l3.231"></a><span id="l3.231">           commandManager.getCommandState(aTopic, gContentWindow, params);</span>
<a href="#l3.232"></a><span id="l3.232">           var errorStringId = 0;</span>
<a href="#l3.233"></a><span id="l3.233">           var editorStatus = params.getLongValue(&quot;state_data&quot;);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-          if (!editor &amp;&amp; editorStatus == nsIEditingSession.eEditorOK)</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-          {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+          if (!editor &amp;&amp; editorStatus == nsIEditingSession.eEditorOK) {</span>
<a href="#l3.237"></a><span id="l3.237">             dump(&quot;\n ****** NO EDITOR BUT NO EDITOR ERROR REPORTED ******* \n\n&quot;);</span>
<a href="#l3.238"></a><span id="l3.238">             editorStatus = nsIEditingSession.eEditorErrorUnknown;</span>
<a href="#l3.239"></a><span id="l3.239">           }</span>
<a href="#l3.240"></a><span id="l3.240"> </span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-          switch (editorStatus)</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-          {</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+          switch (editorStatus) {</span>
<a href="#l3.244"></a><span id="l3.244">             case nsIEditingSession.eEditorErrorCantEditFramesets:</span>
<a href="#l3.245"></a><span id="l3.245">               errorStringId = &quot;CantEditFramesetMsg&quot;;</span>
<a href="#l3.246"></a><span id="l3.246">               break;</span>
<a href="#l3.247"></a><span id="l3.247">             case nsIEditingSession.eEditorErrorCantEditMimeType:</span>
<a href="#l3.248"></a><span id="l3.248">               errorStringId = &quot;CantEditMimeTypeMsg&quot;;</span>
<a href="#l3.249"></a><span id="l3.249">               break;</span>
<a href="#l3.250"></a><span id="l3.250">             case nsIEditingSession.eEditorErrorUnknown:</span>
<a href="#l3.251"></a><span id="l3.251">               errorStringId = &quot;CantEditDocumentMsg&quot;;</span>
<a href="#l3.252"></a><span id="l3.252">               break;</span>
<a href="#l3.253"></a><span id="l3.253">             // Note that for &quot;eEditorErrorFileNotFound,</span>
<a href="#l3.254"></a><span id="l3.254">             // network code popped up an alert dialog, so we don't need to</span>
<a href="#l3.255"></a><span id="l3.255">           }</span>
<a href="#l3.256"></a><span id="l3.256">           if (errorStringId)</span>
<a href="#l3.257"></a><span id="l3.257">             Services.prompt.alert(window, &quot;&quot;, GetString(errorStringId));</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-        } catch(e) { dump(&quot;EXCEPTION GETTING obs_documentCreated state &quot;+e+&quot;\n&quot;); }</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+        } catch (e) { dump(&quot;EXCEPTION GETTING obs_documentCreated state &quot; + e + &quot;\n&quot;); }</span>
<a href="#l3.260"></a><span id="l3.260"> </span>
<a href="#l3.261"></a><span id="l3.261">         // We have a bad editor -- nsIEditingSession will rebuild an editor</span>
<a href="#l3.262"></a><span id="l3.262">         //   with a blank page, so simply abort here</span>
<a href="#l3.263"></a><span id="l3.263">         if (editorStatus)</span>
<a href="#l3.264"></a><span id="l3.264">           return;</span>
<a href="#l3.265"></a><span id="l3.265"> </span>
<a href="#l3.266"></a><span id="l3.266">         if (!(&quot;InsertCharWindow&quot; in window))</span>
<a href="#l3.267"></a><span id="l3.267">           window.InsertCharWindow = null;</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineat">@@ -279,20 +260,19 @@ var gEditorDocumentObserver =</span>
<a href="#l3.269"></a><span id="l3.269">           editor.addOverrideStyleSheet(kNormalStyleSheet);</span>
<a href="#l3.270"></a><span id="l3.270"> </span>
<a href="#l3.271"></a><span id="l3.271">           // remove contenteditable stylesheets if they were applied by the</span>
<a href="#l3.272"></a><span id="l3.272">           // editingSession</span>
<a href="#l3.273"></a><span id="l3.273">           editor.removeOverrideStyleSheet(kContentEditableStyleSheet);</span>
<a href="#l3.274"></a><span id="l3.274">         } catch (e) {}</span>
<a href="#l3.275"></a><span id="l3.275"> </span>
<a href="#l3.276"></a><span id="l3.276">         // Things for just the Web Composer application</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-        if (IsWebComposer())</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-        {</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+        if (IsWebComposer()) {</span>
<a href="#l3.280"></a><span id="l3.280">           InlineSpellCheckerUI.init(editor);</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-          document.getElementById('menu_inlineSpellCheck').setAttribute('disabled', !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+          document.getElementById(&quot;menu_inlineSpellCheck&quot;).setAttribute(&quot;disabled&quot;, !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l3.283"></a><span id="l3.283"> </span>
<a href="#l3.284"></a><span id="l3.284">           editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(kCRInParagraphsPref);</span>
<a href="#l3.285"></a><span id="l3.285"> </span>
<a href="#l3.286"></a><span id="l3.286">           // Set focus to content window if not a mail composer</span>
<a href="#l3.287"></a><span id="l3.287">           // Race conditions prevent us from setting focus here</span>
<a href="#l3.288"></a><span id="l3.288">           //   when loading a url into blank window</span>
<a href="#l3.289"></a><span id="l3.289">           setTimeout(SetFocusOnStartup, 0);</span>
<a href="#l3.290"></a><span id="l3.290"> </span>
<a href="#l3.291"></a><span id="l3.291" class="difflineat">@@ -300,21 +280,20 @@ var gEditorDocumentObserver =</span>
<a href="#l3.292"></a><span id="l3.292">           editor.enableUndo(false);</span>
<a href="#l3.293"></a><span id="l3.293">           EditorSetDefaultPrefsAndDoctype();</span>
<a href="#l3.294"></a><span id="l3.294">           editor.resetModificationCount();</span>
<a href="#l3.295"></a><span id="l3.295">           editor.enableUndo(true);</span>
<a href="#l3.296"></a><span id="l3.296"> </span>
<a href="#l3.297"></a><span id="l3.297">           // We may load a text document into an html editor,</span>
<a href="#l3.298"></a><span id="l3.298">           //   so be sure editortype is set correctly</span>
<a href="#l3.299"></a><span id="l3.299">           // XXX We really should use the &quot;real&quot; plaintext editor for this!</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-          if (editor.contentsMIMEType == &quot;text/plain&quot;)</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-          {</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+          if (editor.contentsMIMEType == &quot;text/plain&quot;) {</span>
<a href="#l3.303"></a><span id="l3.303">             try {</span>
<a href="#l3.304"></a><span id="l3.304">               GetCurrentEditorElement().editortype = &quot;text&quot;;</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-            } catch (e) { dump (e)+&quot;\n&quot;; }</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+            } catch (e) { dump(e) + &quot;\n&quot;; }</span>
<a href="#l3.307"></a><span id="l3.307"> </span>
<a href="#l3.308"></a><span id="l3.308">             // Hide or disable UI not used for plaintext editing</span>
<a href="#l3.309"></a><span id="l3.309">             HideItem(&quot;FormatToolbar&quot;);</span>
<a href="#l3.310"></a><span id="l3.310">             HideItem(&quot;EditModeToolbar&quot;);</span>
<a href="#l3.311"></a><span id="l3.311">             HideItem(&quot;formatMenu&quot;);</span>
<a href="#l3.312"></a><span id="l3.312">             HideItem(&quot;tableMenu&quot;);</span>
<a href="#l3.313"></a><span id="l3.313">             HideItem(&quot;menu_validate&quot;);</span>
<a href="#l3.314"></a><span id="l3.314">             HideItem(&quot;sep_validate&quot;);</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineat">@@ -357,18 +336,17 @@ var gEditorDocumentObserver =</span>
<a href="#l3.316"></a><span id="l3.316">           // (Windows may load with local file paths)</span>
<a href="#l3.317"></a><span id="l3.317">           SetSaveAndPublishUI(GetDocumentUrl());</span>
<a href="#l3.318"></a><span id="l3.318"> </span>
<a href="#l3.319"></a><span id="l3.319">           // Start in &quot;Normal&quot; edit mode</span>
<a href="#l3.320"></a><span id="l3.320">           SetDisplayMode(kDisplayModeNormal);</span>
<a href="#l3.321"></a><span id="l3.321">         }</span>
<a href="#l3.322"></a><span id="l3.322"> </span>
<a href="#l3.323"></a><span id="l3.323">         // Add mouse click watcher if right type of editor</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-        if (IsHTMLEditor())</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-        {</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+        if (IsHTMLEditor()) {</span>
<a href="#l3.327"></a><span id="l3.327">           // Force color widgets to update</span>
<a href="#l3.328"></a><span id="l3.328">           onFontColorChange();</span>
<a href="#l3.329"></a><span id="l3.329">           onBackgroundColorChange();</span>
<a href="#l3.330"></a><span id="l3.330">         }</span>
<a href="#l3.331"></a><span id="l3.331">         break;</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333">       case &quot;cmd_setDocumentModified&quot;:</span>
<a href="#l3.334"></a><span id="l3.334">         window.updateCommands(&quot;save&quot;);</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineat">@@ -379,50 +357,47 @@ var gEditorDocumentObserver =</span>
<a href="#l3.336"></a><span id="l3.336">         break;</span>
<a href="#l3.337"></a><span id="l3.337"> </span>
<a href="#l3.338"></a><span id="l3.338">       case &quot;obs_documentLocationChanged&quot;:</span>
<a href="#l3.339"></a><span id="l3.339">         // Ignore this when editor doesn't exist,</span>
<a href="#l3.340"></a><span id="l3.340">         //   which happens once when page load starts</span>
<a href="#l3.341"></a><span id="l3.341">         if (editor)</span>
<a href="#l3.342"></a><span id="l3.342">           try {</span>
<a href="#l3.343"></a><span id="l3.343">             editor.updateBaseURL();</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-          } catch(e) { dump (e); }</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+          } catch (e) { dump(e); }</span>
<a href="#l3.346"></a><span id="l3.346">         break;</span>
<a href="#l3.347"></a><span id="l3.347"> </span>
<a href="#l3.348"></a><span id="l3.348">       case &quot;cmd_bold&quot;:</span>
<a href="#l3.349"></a><span id="l3.349">         // Update all style items</span>
<a href="#l3.350"></a><span id="l3.350">         // cmd_bold is a proxy; see EditorSharedStartup (above) for details</span>
<a href="#l3.351"></a><span id="l3.351">         window.updateCommands(&quot;style&quot;);</span>
<a href="#l3.352"></a><span id="l3.352">         window.updateCommands(&quot;undo&quot;);</span>
<a href="#l3.353"></a><span id="l3.353">         break;</span>
<a href="#l3.354"></a><span id="l3.354">     }</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-  }</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-}</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-function SetFocusOnStartup()</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-{</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+  },</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+};</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+function SetFocusOnStartup() {</span>
<a href="#l3.364"></a><span id="l3.364">   gContentWindow.focus();</span>
<a href="#l3.365"></a><span id="l3.365"> }</span>
<a href="#l3.366"></a><span id="l3.366"> </span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-function EditorLoadUrl(url)</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-{</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+function EditorLoadUrl(url) {</span>
<a href="#l3.370"></a><span id="l3.370">   try {</span>
<a href="#l3.371"></a><span id="l3.371">     if (url) {</span>
<a href="#l3.372"></a><span id="l3.372">       let loadURIOptions = {</span>
<a href="#l3.373"></a><span id="l3.373">         loadFlags: Ci.nsIWebNavigation.LOAD_FLAGS_BYPASS_CACHE,</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-        triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal()</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+        triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l3.376"></a><span id="l3.376">       };</span>
<a href="#l3.377"></a><span id="l3.377">       GetCurrentEditorElement().webNavigation.loadURI(url, loadURIOptions);</span>
<a href="#l3.378"></a><span id="l3.378">     }</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-  } catch (e) { dump(&quot; EditorLoadUrl failed: &quot;+e+&quot;\n&quot;); }</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+  } catch (e) { dump(&quot; EditorLoadUrl failed: &quot; + e + &quot;\n&quot;); }</span>
<a href="#l3.381"></a><span id="l3.381"> }</span>
<a href="#l3.382"></a><span id="l3.382"> </span>
<a href="#l3.383"></a><span id="l3.383"> // This should be called by all Composer types</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-function EditorSharedStartup()</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-{</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+function EditorSharedStartup() {</span>
<a href="#l3.387"></a><span id="l3.387">   // Just for convenience</span>
<a href="#l3.388"></a><span id="l3.388">   gContentWindow = window.content;</span>
<a href="#l3.389"></a><span id="l3.389"> </span>
<a href="#l3.390"></a><span id="l3.390">   // Disable DNS Prefetching on the docshell - we don't need it for composer</span>
<a href="#l3.391"></a><span id="l3.391">   // type windows.</span>
<a href="#l3.392"></a><span id="l3.392">   GetCurrentEditorElement().docShell.allowDNSPrefetch = false;</span>
<a href="#l3.393"></a><span id="l3.393"> </span>
<a href="#l3.394"></a><span id="l3.394">   // Set up the mime type and register the commands.</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineat">@@ -447,18 +422,18 @@ function EditorSharedStartup()</span>
<a href="#l3.396"></a><span id="l3.396">     commandManager.addCommandObserver(gEditorDocumentObserver, &quot;cmd_bold&quot;);</span>
<a href="#l3.397"></a><span id="l3.397">   } catch (e) { dump(e); }</span>
<a href="#l3.398"></a><span id="l3.398"> </span>
<a href="#l3.399"></a><span id="l3.399">   var isMac = AppConstants.platform == &quot;macosx&quot;;</span>
<a href="#l3.400"></a><span id="l3.400"> </span>
<a href="#l3.401"></a><span id="l3.401">   // Set platform-specific hints for how to select cells</span>
<a href="#l3.402"></a><span id="l3.402">   // Mac uses &quot;Cmd&quot;, all others use &quot;Ctrl&quot;</span>
<a href="#l3.403"></a><span id="l3.403">   var tableKey = GetString(isMac ? &quot;XulKeyMac&quot; : &quot;TableSelectKey&quot;);</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-  var dragStr = tableKey+GetString(&quot;Drag&quot;);</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-  var clickStr = tableKey+GetString(&quot;Click&quot;);</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+  var dragStr = tableKey + GetString(&quot;Drag&quot;);</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+  var clickStr = tableKey + GetString(&quot;Click&quot;);</span>
<a href="#l3.408"></a><span id="l3.408"> </span>
<a href="#l3.409"></a><span id="l3.409">   var delStr = GetString(isMac ? &quot;Clear&quot; : &quot;Del&quot;);</span>
<a href="#l3.410"></a><span id="l3.410"> </span>
<a href="#l3.411"></a><span id="l3.411">   SafeSetAttribute(&quot;menu_SelectCell&quot;, &quot;acceltext&quot;, clickStr);</span>
<a href="#l3.412"></a><span id="l3.412">   SafeSetAttribute(&quot;menu_SelectRow&quot;, &quot;acceltext&quot;, dragStr);</span>
<a href="#l3.413"></a><span id="l3.413">   SafeSetAttribute(&quot;menu_SelectColumn&quot;, &quot;acceltext&quot;, dragStr);</span>
<a href="#l3.414"></a><span id="l3.414">   SafeSetAttribute(&quot;menu_SelectAllCells&quot;, &quot;acceltext&quot;, dragStr);</span>
<a href="#l3.415"></a><span id="l3.415">   // And add &quot;Del&quot; or &quot;Clear&quot;</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineat">@@ -466,53 +441,49 @@ function EditorSharedStartup()</span>
<a href="#l3.417"></a><span id="l3.417"> </span>
<a href="#l3.418"></a><span id="l3.418">   // Set text for indent, outdent keybinding</span>
<a href="#l3.419"></a><span id="l3.419"> </span>
<a href="#l3.420"></a><span id="l3.420">   // hide UI that we don't have components for</span>
<a href="#l3.421"></a><span id="l3.421">   RemoveInapplicableUIElements();</span>
<a href="#l3.422"></a><span id="l3.422"> </span>
<a href="#l3.423"></a><span id="l3.423">   // Use browser colors as initial values for editor's default colors</span>
<a href="#l3.424"></a><span id="l3.424">   var BrowserColors = GetDefaultBrowserColors();</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-  if (BrowserColors)</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-  {</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+  if (BrowserColors) {</span>
<a href="#l3.428"></a><span id="l3.428">     gDefaultTextColor = BrowserColors.TextColor;</span>
<a href="#l3.429"></a><span id="l3.429">     gDefaultBackgroundColor = BrowserColors.BackgroundColor;</span>
<a href="#l3.430"></a><span id="l3.430">   }</span>
<a href="#l3.431"></a><span id="l3.431"> </span>
<a href="#l3.432"></a><span id="l3.432">   // For new window, no default last-picked colors</span>
<a href="#l3.433"></a><span id="l3.433">   gColorObj.LastTextColor = &quot;&quot;;</span>
<a href="#l3.434"></a><span id="l3.434">   gColorObj.LastBackgroundColor = &quot;&quot;;</span>
<a href="#l3.435"></a><span id="l3.435">   gColorObj.LastHighlightColor = &quot;&quot;;</span>
<a href="#l3.436"></a><span id="l3.436"> }</span>
<a href="#l3.437"></a><span id="l3.437"> </span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-function SafeSetAttribute(nodeID, attributeName, attributeValue)</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-{</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+function SafeSetAttribute(nodeID, attributeName, attributeValue) {</span>
<a href="#l3.441"></a><span id="l3.441">     var theNode = document.getElementById(nodeID);</span>
<a href="#l3.442"></a><span id="l3.442">     if (theNode)</span>
<a href="#l3.443"></a><span id="l3.443">         theNode.setAttribute(attributeName, attributeValue);</span>
<a href="#l3.444"></a><span id="l3.444"> }</span>
<a href="#l3.445"></a><span id="l3.445"> </span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-function DocumentHasBeenSaved()</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-{</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+function DocumentHasBeenSaved() {</span>
<a href="#l3.449"></a><span id="l3.449">   var fileurl = &quot;&quot;;</span>
<a href="#l3.450"></a><span id="l3.450">   try {</span>
<a href="#l3.451"></a><span id="l3.451">     fileurl = GetDocumentUrl();</span>
<a href="#l3.452"></a><span id="l3.452">   } catch (e) {</span>
<a href="#l3.453"></a><span id="l3.453">     return false;</span>
<a href="#l3.454"></a><span id="l3.454">   }</span>
<a href="#l3.455"></a><span id="l3.455"> </span>
<a href="#l3.456"></a><span id="l3.456">   if (!fileurl || IsUrlAboutBlank(fileurl))</span>
<a href="#l3.457"></a><span id="l3.457">     return false;</span>
<a href="#l3.458"></a><span id="l3.458"> </span>
<a href="#l3.459"></a><span id="l3.459">   // We have a file URL already</span>
<a href="#l3.460"></a><span id="l3.460">   return true;</span>
<a href="#l3.461"></a><span id="l3.461"> }</span>
<a href="#l3.462"></a><span id="l3.462"> </span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-async function CheckAndSaveDocument(command, allowDontSave)</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-{</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+async function CheckAndSaveDocument(command, allowDontSave) {</span>
<a href="#l3.466"></a><span id="l3.466">   var document;</span>
<a href="#l3.467"></a><span id="l3.467">   try {</span>
<a href="#l3.468"></a><span id="l3.468">     // if we don't have an editor or an document, bail</span>
<a href="#l3.469"></a><span id="l3.469">     var editor = GetCurrentEditor();</span>
<a href="#l3.470"></a><span id="l3.470">     document = editor.document;</span>
<a href="#l3.471"></a><span id="l3.471">     if (!document)</span>
<a href="#l3.472"></a><span id="l3.472">       return true;</span>
<a href="#l3.473"></a><span id="l3.473">   } catch (e) { return true; }</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineat">@@ -523,18 +494,17 @@ async function CheckAndSaveDocument(comm</span>
<a href="#l3.475"></a><span id="l3.475">   // call window.focus, since we need to pop up a dialog</span>
<a href="#l3.476"></a><span id="l3.476">   // and therefore need to be visible (to prevent user confusion)</span>
<a href="#l3.477"></a><span id="l3.477">   top.document.commandDispatcher.focusedWindow.focus();</span>
<a href="#l3.478"></a><span id="l3.478"> </span>
<a href="#l3.479"></a><span id="l3.479">   var scheme = GetScheme(GetDocumentUrl());</span>
<a href="#l3.480"></a><span id="l3.480">   var doPublish = (scheme &amp;&amp; scheme != &quot;file&quot;);</span>
<a href="#l3.481"></a><span id="l3.481"> </span>
<a href="#l3.482"></a><span id="l3.482">   var strID;</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-  switch (command)</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-  {</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+  switch (command) {</span>
<a href="#l3.486"></a><span id="l3.486">     case &quot;cmd_close&quot;:</span>
<a href="#l3.487"></a><span id="l3.487">       strID = &quot;BeforeClosing&quot;;</span>
<a href="#l3.488"></a><span id="l3.488">       break;</span>
<a href="#l3.489"></a><span id="l3.489">     case &quot;cmd_preview&quot;:</span>
<a href="#l3.490"></a><span id="l3.490">       strID = &quot;BeforePreview&quot;;</span>
<a href="#l3.491"></a><span id="l3.491">       break;</span>
<a href="#l3.492"></a><span id="l3.492">     case &quot;cmd_editSendPage&quot;:</span>
<a href="#l3.493"></a><span id="l3.493">       strID = &quot;SendPageReason&quot;;</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineat">@@ -545,49 +515,44 @@ async function CheckAndSaveDocument(comm</span>
<a href="#l3.495"></a><span id="l3.495">   }</span>
<a href="#l3.496"></a><span id="l3.496"> </span>
<a href="#l3.497"></a><span id="l3.497">   var reasonToSave = strID ? GetString(strID) : &quot;&quot;;</span>
<a href="#l3.498"></a><span id="l3.498"> </span>
<a href="#l3.499"></a><span id="l3.499">   var title = document.title || GetString(&quot;untitledDefaultFilename&quot;);</span>
<a href="#l3.500"></a><span id="l3.500"> </span>
<a href="#l3.501"></a><span id="l3.501">   var dialogTitle = GetString(doPublish ? &quot;PublishPage&quot; : &quot;SaveDocument&quot;);</span>
<a href="#l3.502"></a><span id="l3.502">   var dialogMsg = GetString(doPublish ? &quot;PublishPrompt&quot; : &quot;SaveFilePrompt&quot;);</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-  dialogMsg = (dialogMsg.replace(/%title%/,title)).replace(/%reason%/,reasonToSave);</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-  let result = {value:0};</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+  dialogMsg = (dialogMsg.replace(/%title%/, title)).replace(/%reason%/, reasonToSave);</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+  let result = {value: 0};</span>
<a href="#l3.509"></a><span id="l3.509">   let promptFlags = Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1;</span>
<a href="#l3.510"></a><span id="l3.510">   let button1Title = null;</span>
<a href="#l3.511"></a><span id="l3.511">   let button3Title = null;</span>
<a href="#l3.512"></a><span id="l3.512"> </span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-  if (doPublish)</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-  {</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+  if (doPublish) {</span>
<a href="#l3.516"></a><span id="l3.516">     promptFlags += Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.517"></a><span id="l3.517">     button1Title = GetString(&quot;Publish&quot;);</span>
<a href="#l3.518"></a><span id="l3.518">     button3Title = GetString(&quot;DontPublish&quot;);</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-  }</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-  else</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-  {</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+  } else {</span>
<a href="#l3.523"></a><span id="l3.523">     promptFlags += Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.524"></a><span id="l3.524">   }</span>
<a href="#l3.525"></a><span id="l3.525"> </span>
<a href="#l3.526"></a><span id="l3.526">   // If allowing &quot;Don't...&quot; button, add that</span>
<a href="#l3.527"></a><span id="l3.527">   if (allowDontSave)</span>
<a href="#l3.528"></a><span id="l3.528">     promptFlags += doPublish ?</span>
<a href="#l3.529"></a><span id="l3.529">         (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_2)</span>
<a href="#l3.530"></a><span id="l3.530">         : (Services.prompt.BUTTON_TITLE_DONT_SAVE * Services.prompt.BUTTON_POS_2);</span>
<a href="#l3.531"></a><span id="l3.531"> </span>
<a href="#l3.532"></a><span id="l3.532">   result = Services.prompt.confirmEx(window, dialogTitle, dialogMsg, promptFlags,</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-                          button1Title, null, button3Title, null, {value:0});</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-  if (result == 0)</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-  {</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+                          button1Title, null, button3Title, null, {value: 0});</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+  if (result == 0) {</span>
<a href="#l3.540"></a><span id="l3.540">     // Save, but first finish HTML source mode</span>
<a href="#l3.541"></a><span id="l3.541">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-    if (doPublish)</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-    {</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+    if (doPublish) {</span>
<a href="#l3.545"></a><span id="l3.545">       // We save the command the user wanted to do in a global</span>
<a href="#l3.546"></a><span id="l3.546">       // and return as if user canceled because publishing is asynchronous</span>
<a href="#l3.547"></a><span id="l3.547">       // This command will be fired when publishing finishes</span>
<a href="#l3.548"></a><span id="l3.548">       gCommandAfterPublishing = command;</span>
<a href="#l3.549"></a><span id="l3.549">       goDoCommand(&quot;cmd_publish&quot;);</span>
<a href="#l3.550"></a><span id="l3.550">       return false;</span>
<a href="#l3.551"></a><span id="l3.551">     }</span>
<a href="#l3.552"></a><span id="l3.552"> </span>
<a href="#l3.553"></a><span id="l3.553" class="difflineat">@@ -599,92 +564,83 @@ async function CheckAndSaveDocument(comm</span>
<a href="#l3.554"></a><span id="l3.554">     return true;</span>
<a href="#l3.555"></a><span id="l3.555"> </span>
<a href="#l3.556"></a><span id="l3.556">   // Default or result == 1 (Cancel)</span>
<a href="#l3.557"></a><span id="l3.557">   return false;</span>
<a href="#l3.558"></a><span id="l3.558"> }</span>
<a href="#l3.559"></a><span id="l3.559"> </span>
<a href="#l3.560"></a><span id="l3.560"> // --------------------------- View menu ---------------------------</span>
<a href="#l3.561"></a><span id="l3.561"> </span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-function EditorSetCharacterSet(aEvent)</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-{</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+function EditorSetCharacterSet(aEvent) {</span>
<a href="#l3.565"></a><span id="l3.565">   try {</span>
<a href="#l3.566"></a><span id="l3.566">     var editor = GetCurrentEditor();</span>
<a href="#l3.567"></a><span id="l3.567">     if (aEvent.target.hasAttribute(&quot;charset&quot;))</span>
<a href="#l3.568"></a><span id="l3.568">       editor.documentCharacterSet = aEvent.target.getAttribute(&quot;charset&quot;);</span>
<a href="#l3.569"></a><span id="l3.569">     var docUrl = GetDocumentUrl();</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-    if( !IsUrlAboutBlank(docUrl))</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-    {</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+    if (!IsUrlAboutBlank(docUrl)) {</span>
<a href="#l3.573"></a><span id="l3.573">       // reloading the document will reverse any changes to the META charset,</span>
<a href="#l3.574"></a><span id="l3.574">       // we need to put them back in, which is achieved by a dedicated listener</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-      editor.addDocumentStateListener( DocumentReloadListener );</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+      editor.addDocumentStateListener(DocumentReloadListener);</span>
<a href="#l3.577"></a><span id="l3.577">       EditorLoadUrl(docUrl);</span>
<a href="#l3.578"></a><span id="l3.578">     }</span>
<a href="#l3.579"></a><span id="l3.579">   } catch (e) {}</span>
<a href="#l3.580"></a><span id="l3.580"> }</span>
<a href="#l3.581"></a><span id="l3.581"> </span>
<a href="#l3.582"></a><span id="l3.582"> // --------------------------- Text style ---------------------------</span>
<a href="#l3.583"></a><span id="l3.583"> </span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-function onParagraphFormatChange(paraMenuList, commandID)</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-{</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+function onParagraphFormatChange(paraMenuList, commandID) {</span>
<a href="#l3.587"></a><span id="l3.587">   if (!paraMenuList)</span>
<a href="#l3.588"></a><span id="l3.588">     return;</span>
<a href="#l3.589"></a><span id="l3.589"> </span>
<a href="#l3.590"></a><span id="l3.590">   var commandNode = document.getElementById(commandID);</span>
<a href="#l3.591"></a><span id="l3.591">   var state = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.592"></a><span id="l3.592"> </span>
<a href="#l3.593"></a><span id="l3.593">   // force match with &quot;normal&quot;</span>
<a href="#l3.594"></a><span id="l3.594">   if (state == &quot;body&quot;)</span>
<a href="#l3.595"></a><span id="l3.595">     state = &quot;&quot;;</span>
<a href="#l3.596"></a><span id="l3.596"> </span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-  if (state == &quot;mixed&quot;)</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-  {</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-    //Selection is the &quot;mixed&quot; ( &gt; 1 style) state</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+  if (state == &quot;mixed&quot;) {</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+    // Selection is the &quot;mixed&quot; ( &gt; 1 style) state</span>
<a href="#l3.602"></a><span id="l3.602">     paraMenuList.selectedItem = null;</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-    paraMenuList.setAttribute(&quot;label&quot;,GetString('Mixed'));</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-  }</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-  else</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-  {</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+    paraMenuList.setAttribute(&quot;label&quot;, GetString(&quot;Mixed&quot;));</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineplus">+  } else {</span>
<a href="#l3.609"></a><span id="l3.609">     var menuPopup = document.getElementById(&quot;ParagraphPopup&quot;);</span>
<a href="#l3.610"></a><span id="l3.610">     var menuItems = menuPopup.childNodes;</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-    for (var i=0; i &lt; menuItems.length; i++)</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-    {</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+    for (var i = 0; i &lt; menuItems.length; i++) {</span>
<a href="#l3.614"></a><span id="l3.614">       var menuItem = menuItems.item(i);</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-      if (&quot;value&quot; in menuItem &amp;&amp; menuItem.value == state)</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-      {</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+      if (&quot;value&quot; in menuItem &amp;&amp; menuItem.value == state) {</span>
<a href="#l3.618"></a><span id="l3.618">         paraMenuList.selectedItem = menuItem;</span>
<a href="#l3.619"></a><span id="l3.619">         break;</span>
<a href="#l3.620"></a><span id="l3.620">       }</span>
<a href="#l3.621"></a><span id="l3.621">     }</span>
<a href="#l3.622"></a><span id="l3.622">   }</span>
<a href="#l3.623"></a><span id="l3.623"> }</span>
<a href="#l3.624"></a><span id="l3.624"> </span>
<a href="#l3.625"></a><span id="l3.625"> /**</span>
<a href="#l3.626"></a><span id="l3.626">  * Selects the current font face in the menulist.</span>
<a href="#l3.627"></a><span id="l3.627">  *</span>
<a href="#l3.628"></a><span id="l3.628">  * @param fontFaceMenuList  The menulist element containing the list of fonts.</span>
<a href="#l3.629"></a><span id="l3.629">  * @param commandID         The commandID which holds the current font name</span>
<a href="#l3.630"></a><span id="l3.630">  *                          in its &quot;state&quot; attribute.</span>
<a href="#l3.631"></a><span id="l3.631">  */</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-function onFontFaceChange(fontFaceMenuList, commandID)</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-{</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+function onFontFaceChange(fontFaceMenuList, commandID) {</span>
<a href="#l3.635"></a><span id="l3.635">   var commandNode = document.getElementById(commandID);</span>
<a href="#l3.636"></a><span id="l3.636">   var editorFont = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.637"></a><span id="l3.637"> </span>
<a href="#l3.638"></a><span id="l3.638">   // Strip quotes in font names. Experiments have shown that we only</span>
<a href="#l3.639"></a><span id="l3.639">   // ever get double quotes around the font name, never single quotes,</span>
<a href="#l3.640"></a><span id="l3.640">   // even if they were in the HTML source. Also single or double</span>
<a href="#l3.641"></a><span id="l3.641">   // quotes within the font name are never returned.</span>
<a href="#l3.642"></a><span id="l3.642">   editorFont = editorFont.replace(/&quot;/g, &quot;&quot;);</span>
<a href="#l3.643"></a><span id="l3.643"> </span>
<a href="#l3.644"></a><span id="l3.644">   switch (editorFont) {</span>
<a href="#l3.645"></a><span id="l3.645">   case &quot;mixed&quot;:</span>
<a href="#l3.646"></a><span id="l3.646">     // Selection is the &quot;mixed&quot; ( &gt; 1 style) state.</span>
<a href="#l3.647"></a><span id="l3.647">     fontFaceMenuList.selectedItem = null;</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-    fontFaceMenuList.setAttribute(&quot;label&quot;,GetString('Mixed'));</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+    fontFaceMenuList.setAttribute(&quot;label&quot;, GetString(&quot;Mixed&quot;));</span>
<a href="#l3.650"></a><span id="l3.650">     return;</span>
<a href="#l3.651"></a><span id="l3.651">   case &quot;&quot;:</span>
<a href="#l3.652"></a><span id="l3.652">   case &quot;serif&quot;:</span>
<a href="#l3.653"></a><span id="l3.653">   case &quot;sans-serif&quot;:</span>
<a href="#l3.654"></a><span id="l3.654">     // Generic variable width.</span>
<a href="#l3.655"></a><span id="l3.655">     fontFaceMenuList.selectedIndex = 0;</span>
<a href="#l3.656"></a><span id="l3.656">     return;</span>
<a href="#l3.657"></a><span id="l3.657">   case &quot;tt&quot;:</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineat">@@ -725,89 +681,75 @@ function onFontFaceChange(fontFaceMenuLi</span>
<a href="#l3.659"></a><span id="l3.659">   let afterUsedFontSection = false;</span>
<a href="#l3.660"></a><span id="l3.660"> </span>
<a href="#l3.661"></a><span id="l3.661">   // The menu items not only have &quot;label&quot; and &quot;value&quot;, but also some other attributes:</span>
<a href="#l3.662"></a><span id="l3.662">   // &quot;value_parsed&quot;: Is the toLowerCase() and space-stripped value.</span>
<a href="#l3.663"></a><span id="l3.663">   // &quot;value_cache&quot;:  Is a concatenation of all editor fonts that were ever mapped</span>
<a href="#l3.664"></a><span id="l3.664">   //                 onto this menu item. This is done for optimization.</span>
<a href="#l3.665"></a><span id="l3.665">   // &quot;used&quot;:         This item is in the used font section.</span>
<a href="#l3.666"></a><span id="l3.666"> </span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-  for (let i = 0; i &lt; menuItems.length; i++)</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-  {</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+  for (let i = 0; i &lt; menuItems.length; i++) {</span>
<a href="#l3.670"></a><span id="l3.670">     let menuItem = menuItems.item(i);</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-    if (menuItem.hasAttribute(&quot;label&quot;) &amp;&amp; menuItem.hasAttribute(&quot;value_parsed&quot;))</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-    {</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+    if (menuItem.hasAttribute(&quot;label&quot;) &amp;&amp; menuItem.hasAttribute(&quot;value_parsed&quot;)) {</span>
<a href="#l3.674"></a><span id="l3.674">       // The element seems to represent a font &lt;menuitem&gt;.</span>
<a href="#l3.675"></a><span id="l3.675">       let fontMenuValue = menuItem.getAttribute(&quot;value_parsed&quot;);</span>
<a href="#l3.676"></a><span id="l3.676">       if (fontMenuValue == editorFontToLower ||</span>
<a href="#l3.677"></a><span id="l3.677">           (menuItem.hasAttribute(&quot;value_cache&quot;) &amp;&amp;</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-           menuItem.getAttribute(&quot;value_cache&quot;).split(&quot;|&quot;).includes(editorFontToLower)))</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-      {</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+           menuItem.getAttribute(&quot;value_cache&quot;).split(&quot;|&quot;).includes(editorFontToLower))) {</span>
<a href="#l3.681"></a><span id="l3.681">         // This menuitem contains the font we are looking for.</span>
<a href="#l3.682"></a><span id="l3.682">         foundFont = menuItem;</span>
<a href="#l3.683"></a><span id="l3.683">         exactMatch = true;</span>
<a href="#l3.684"></a><span id="l3.684">         break;</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-      }</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-      else if (editorOptionsCount &gt; 1 &amp;&amp; afterUsedFontSection)</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-      {</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+      } else if (editorOptionsCount &gt; 1 &amp;&amp; afterUsedFontSection) {</span>
<a href="#l3.689"></a><span id="l3.689">         // Once we are in the list of all other available fonts,</span>
<a href="#l3.690"></a><span id="l3.690">         // we will find the one that best matches one of the options.</span>
<a href="#l3.691"></a><span id="l3.691">         let matchPos = editorFontOptions.indexOf(fontMenuValue);</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-        if (matchPos &gt;= 0 &amp;&amp; matchPos &lt; matchedFontIndex)</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-        {</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+        if (matchPos &gt;= 0 &amp;&amp; matchPos &lt; matchedFontIndex) {</span>
<a href="#l3.695"></a><span id="l3.695">           // This menu font comes earlier in the list of options,</span>
<a href="#l3.696"></a><span id="l3.696">           // so prefer it.</span>
<a href="#l3.697"></a><span id="l3.697">           matchedFontIndex = matchPos;</span>
<a href="#l3.698"></a><span id="l3.698">           foundFont = menuItem;</span>
<a href="#l3.699"></a><span id="l3.699">           // If we matched the first option, we don't need to look for</span>
<a href="#l3.700"></a><span id="l3.700">           // a better match.</span>
<a href="#l3.701"></a><span id="l3.701">           if (matchPos == 0)</span>
<a href="#l3.702"></a><span id="l3.702">             break;</span>
<a href="#l3.703"></a><span id="l3.703">         }</span>
<a href="#l3.704"></a><span id="l3.704">       }</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-    }</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-    else</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-    {</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+    } else {</span>
<a href="#l3.709"></a><span id="l3.709">       // Some other element type.</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-      if (menuItem == usedFontsSep)</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-      {</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+      if (menuItem == usedFontsSep) {</span>
<a href="#l3.713"></a><span id="l3.713">         // We have now passed the section of used fonts and are now in the list of all.</span>
<a href="#l3.714"></a><span id="l3.714">         afterUsedFontSection = true;</span>
<a href="#l3.715"></a><span id="l3.715">       }</span>
<a href="#l3.716"></a><span id="l3.716">     }</span>
<a href="#l3.717"></a><span id="l3.717">   }</span>
<a href="#l3.718"></a><span id="l3.718"> </span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-  if (foundFont)</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-  {</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineplus">+  if (foundFont) {</span>
<a href="#l3.722"></a><span id="l3.722">     let defaultFontsSep = menuPopup.querySelector(&quot;menuseparator.fontFaceMenuAfterDefaultFonts&quot;);</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-    if (exactMatch)</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-    {</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-      if (afterUsedFontSection)</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-      {</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+    if (exactMatch) {</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+      if (afterUsedFontSection) {</span>
<a href="#l3.729"></a><span id="l3.729">         // Copy the matched font into the section of used fonts.</span>
<a href="#l3.730"></a><span id="l3.730">         // We insert after the separator following the default fonts,</span>
<a href="#l3.731"></a><span id="l3.731">         // so right at the beginning of the used fonts section.</span>
<a href="#l3.732"></a><span id="l3.732">         let copyItem = foundFont.cloneNode(true);</span>
<a href="#l3.733"></a><span id="l3.733">         menuPopup.insertBefore(copyItem, defaultFontsSep.nextSibling);</span>
<a href="#l3.734"></a><span id="l3.734">         usedFontsSep.hidden = false;</span>
<a href="#l3.735"></a><span id="l3.735">         foundFont = copyItem;</span>
<a href="#l3.736"></a><span id="l3.736">         foundFont.setAttribute(&quot;used&quot;, &quot;true&quot;);</span>
<a href="#l3.737"></a><span id="l3.737">       }</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-    }</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-    else</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-    {</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+    } else {</span>
<a href="#l3.742"></a><span id="l3.742">       // Keep only the found font and generic families in the font string.</span>
<a href="#l3.743"></a><span id="l3.743">       editorFont = editorFont.replace(/, /g, &quot;,&quot;).split(&quot;,&quot;).filter(</span>
<a href="#l3.744"></a><span id="l3.744">         font =&gt; ((font.toLowerCase() == foundFont.getAttribute(&quot;value_parsed&quot;)) ||</span>
<a href="#l3.745"></a><span id="l3.745">                  genericFamilies.includes(font))).join(&quot;,&quot;);</span>
<a href="#l3.746"></a><span id="l3.746"> </span>
<a href="#l3.747"></a><span id="l3.747">       // Check if such an item is already in the used font section.</span>
<a href="#l3.748"></a><span id="l3.748">       if (afterUsedFontSection)</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-        foundFont = menuPopup.querySelector('menuitem[used=&quot;true&quot;][value_parsed=&quot;'+</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-                    editorFont.toLowerCase()+'&quot;]');</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+        foundFont = menuPopup.querySelector('menuitem[used=&quot;true&quot;][value_parsed=&quot;' +</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineplus">+                    editorFont.toLowerCase() + '&quot;]');</span>
<a href="#l3.753"></a><span id="l3.753">       // If not, create a new entry which will be inserted into that section.</span>
<a href="#l3.754"></a><span id="l3.754">       if (!foundFont)</span>
<a href="#l3.755"></a><span id="l3.755">         foundFont = createFontFaceMenuitem(editorFont, editorFont, menuPopup);</span>
<a href="#l3.756"></a><span id="l3.756"> </span>
<a href="#l3.757"></a><span id="l3.757">       // Add the editor font string into the 'cache' attribute in the element</span>
<a href="#l3.758"></a><span id="l3.758">       // so we can later find it quickly without building the reduced string again.</span>
<a href="#l3.759"></a><span id="l3.759">       let fontCache = &quot;&quot;;</span>
<a href="#l3.760"></a><span id="l3.760">       if (foundFont.hasAttribute(&quot;value_cache&quot;))</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineat">@@ -816,104 +758,88 @@ function onFontFaceChange(fontFaceMenuLi</span>
<a href="#l3.762"></a><span id="l3.762"> </span>
<a href="#l3.763"></a><span id="l3.763">       // If we created a new item, set it up and insert.</span>
<a href="#l3.764"></a><span id="l3.764">       if (!foundFont.hasAttribute(&quot;used&quot;)) {</span>
<a href="#l3.765"></a><span id="l3.765">         foundFont.setAttribute(&quot;used&quot;, &quot;true&quot;);</span>
<a href="#l3.766"></a><span id="l3.766">         usedFontsSep.hidden = false;</span>
<a href="#l3.767"></a><span id="l3.767">         menuPopup.insertBefore(foundFont, defaultFontsSep.nextSibling);</span>
<a href="#l3.768"></a><span id="l3.768">       }</span>
<a href="#l3.769"></a><span id="l3.769">     }</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-  }</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-  else</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-  {</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+  } else {</span>
<a href="#l3.774"></a><span id="l3.774">     // The editor encountered a font that is not installed on this system.</span>
<a href="#l3.775"></a><span id="l3.775">     // Add it to the font menu now, in the used-fonts section right at the</span>
<a href="#l3.776"></a><span id="l3.776">     // bottom before the separator of the section.</span>
<a href="#l3.777"></a><span id="l3.777">     let fontLabel = GetFormattedString(&quot;NotInstalled&quot;, editorFont);</span>
<a href="#l3.778"></a><span id="l3.778">     foundFont = createFontFaceMenuitem(fontLabel, editorFont, menuPopup);</span>
<a href="#l3.779"></a><span id="l3.779">     foundFont.setAttribute(&quot;used&quot;, &quot;true&quot;);</span>
<a href="#l3.780"></a><span id="l3.780">     usedFontsSep.hidden = false;</span>
<a href="#l3.781"></a><span id="l3.781">     menuPopup.insertBefore(foundFont, usedFontsSep);</span>
<a href="#l3.782"></a><span id="l3.782">   }</span>
<a href="#l3.783"></a><span id="l3.783">   fontFaceMenuList.selectedItem = foundFont;</span>
<a href="#l3.784"></a><span id="l3.784"> }</span>
<a href="#l3.785"></a><span id="l3.785"> </span>
<a href="#l3.786"></a><span id="l3.786"> /**</span>
<a href="#l3.787"></a><span id="l3.787">  * Clears the used fonts list from all the font face menulists.</span>
<a href="#l3.788"></a><span id="l3.788">  */</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-function ClearUsedFonts()</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-{</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+function ClearUsedFonts() {</span>
<a href="#l3.792"></a><span id="l3.792">   let userFontSeps = document.querySelectorAll(&quot;menuseparator.fontFaceMenuAfterDefaultFonts&quot;);</span>
<a href="#l3.793"></a><span id="l3.793">   for (let userFontSep of userFontSeps) {</span>
<a href="#l3.794"></a><span id="l3.794">     let parentList = userFontSep.parentNode;</span>
<a href="#l3.795"></a><span id="l3.795">     while (true) {</span>
<a href="#l3.796"></a><span id="l3.796">       let nextNode = userFontSep.nextSibling;</span>
<a href="#l3.797"></a><span id="l3.797">       if (nextNode.tagName != &quot;menuseparator&quot;) {</span>
<a href="#l3.798"></a><span id="l3.798">         nextNode.remove();</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-      } else {</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-        if (nextNode.classList.contains(&quot;fontFaceMenuAfterUsedFonts&quot;)) {</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+      } else if (nextNode.classList.contains(&quot;fontFaceMenuAfterUsedFonts&quot;)) {</span>
<a href="#l3.802"></a><span id="l3.802">           nextNode.hidden = true;</span>
<a href="#l3.803"></a><span id="l3.803">           break;</span>
<a href="#l3.804"></a><span id="l3.804">         }</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-      }</span>
<a href="#l3.806"></a><span id="l3.806">     }</span>
<a href="#l3.807"></a><span id="l3.807">   }</span>
<a href="#l3.808"></a><span id="l3.808"> }</span>
<a href="#l3.809"></a><span id="l3.809"> </span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-function EditorSelectFontSize()</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-{</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+function EditorSelectFontSize() {</span>
<a href="#l3.813"></a><span id="l3.813">   var select = document.getElementById(&quot;FontSizeSelect&quot;);</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-  if (select)</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-  {</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+  if (select) {</span>
<a href="#l3.817"></a><span id="l3.817">     if (select.selectedIndex == -1)</span>
<a href="#l3.818"></a><span id="l3.818">       return;</span>
<a href="#l3.819"></a><span id="l3.819"> </span>
<a href="#l3.820"></a><span id="l3.820">     EditorSetFontSize(gFontSizeNames[select.selectedIndex]);</span>
<a href="#l3.821"></a><span id="l3.821">   }</span>
<a href="#l3.822"></a><span id="l3.822"> }</span>
<a href="#l3.823"></a><span id="l3.823"> </span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-function onFontSizeChange(fontSizeMenulist, commandID)</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-{</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+function onFontSizeChange(fontSizeMenulist, commandID) {</span>
<a href="#l3.827"></a><span id="l3.827">   // If we don't match anything, set to &quot;0 (normal)&quot;</span>
<a href="#l3.828"></a><span id="l3.828">   var newIndex = 2;</span>
<a href="#l3.829"></a><span id="l3.829">   var size = fontSizeMenulist.getAttribute(&quot;size&quot;);</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-  if ( size == &quot;mixed&quot;)</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-  {</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+  if (size == &quot;mixed&quot;) {</span>
<a href="#l3.833"></a><span id="l3.833">     // No single type selected</span>
<a href="#l3.834"></a><span id="l3.834">     newIndex = -1;</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-  }</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-  else</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-  {</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-    for (var i = 0; i &lt; gFontSizeNames.length; i++)</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-    {</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-      if( gFontSizeNames[i] == size )</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-      {</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+  } else {</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+    for (var i = 0; i &lt; gFontSizeNames.length; i++) {</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+      if (gFontSizeNames[i] == size) {</span>
<a href="#l3.845"></a><span id="l3.845">         newIndex = i;</span>
<a href="#l3.846"></a><span id="l3.846">         break;</span>
<a href="#l3.847"></a><span id="l3.847">       }</span>
<a href="#l3.848"></a><span id="l3.848">     }</span>
<a href="#l3.849"></a><span id="l3.849">   }</span>
<a href="#l3.850"></a><span id="l3.850">   if (fontSizeMenulist.selectedIndex != newIndex)</span>
<a href="#l3.851"></a><span id="l3.851">     fontSizeMenulist.selectedIndex = newIndex;</span>
<a href="#l3.852"></a><span id="l3.852"> }</span>
<a href="#l3.853"></a><span id="l3.853"> </span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-function EditorSetFontSize(size)</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-{</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineminus">-  if( size == &quot;0&quot; || size == &quot;normal&quot; ||</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-      size == &quot;medium&quot; )</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-  {</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+function EditorSetFontSize(size) {</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+  if (size == &quot;0&quot; || size == &quot;normal&quot; ||</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+      size == &quot;medium&quot;) {</span>
<a href="#l3.862"></a><span id="l3.862">     EditorRemoveTextProperty(&quot;font&quot;, &quot;size&quot;);</span>
<a href="#l3.863"></a><span id="l3.863">     // Also remove big and small,</span>
<a href="#l3.864"></a><span id="l3.864">     //  else it will seem like size isn't changing correctly</span>
<a href="#l3.865"></a><span id="l3.865">     EditorRemoveTextProperty(&quot;small&quot;, &quot;&quot;);</span>
<a href="#l3.866"></a><span id="l3.866">     EditorRemoveTextProperty(&quot;big&quot;, &quot;&quot;);</span>
<a href="#l3.867"></a><span id="l3.867">   } else {</span>
<a href="#l3.868"></a><span id="l3.868">     // Temp: convert from new CSS size strings to old HTML size strings</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-    switch (size)</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-    {</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineplus">+    switch (size) {</span>
<a href="#l3.872"></a><span id="l3.872">       case &quot;xx-small&quot;:</span>
<a href="#l3.873"></a><span id="l3.873">       case &quot;x-small&quot;:</span>
<a href="#l3.874"></a><span id="l3.874">         size = &quot;-2&quot;;</span>
<a href="#l3.875"></a><span id="l3.875">         break;</span>
<a href="#l3.876"></a><span id="l3.876">       case &quot;small&quot;:</span>
<a href="#l3.877"></a><span id="l3.877">         size = &quot;-1&quot;;</span>
<a href="#l3.878"></a><span id="l3.878">         break;</span>
<a href="#l3.879"></a><span id="l3.879">       case &quot;large&quot;:</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineat">@@ -926,76 +852,67 @@ function EditorSetFontSize(size)</span>
<a href="#l3.881"></a><span id="l3.881">         size = &quot;+3&quot;;</span>
<a href="#l3.882"></a><span id="l3.882">         break;</span>
<a href="#l3.883"></a><span id="l3.883">     }</span>
<a href="#l3.884"></a><span id="l3.884">     EditorSetTextProperty(&quot;font&quot;, &quot;size&quot;, size);</span>
<a href="#l3.885"></a><span id="l3.885">   }</span>
<a href="#l3.886"></a><span id="l3.886">   gContentWindow.focus();</span>
<a href="#l3.887"></a><span id="l3.887"> }</span>
<a href="#l3.888"></a><span id="l3.888"> </span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-function initFontFaceMenu(menuPopup)</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineminus">-{</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+function initFontFaceMenu(menuPopup) {</span>
<a href="#l3.892"></a><span id="l3.892">   initLocalFontFaceMenu(menuPopup);</span>
<a href="#l3.893"></a><span id="l3.893"> </span>
<a href="#l3.894"></a><span id="l3.894" class="difflineminus">-  if (menuPopup)</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineminus">-  {</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+  if (menuPopup) {</span>
<a href="#l3.897"></a><span id="l3.897">     var children = menuPopup.childNodes;</span>
<a href="#l3.898"></a><span id="l3.898">     if (!children) return;</span>
<a href="#l3.899"></a><span id="l3.899"> </span>
<a href="#l3.900"></a><span id="l3.900">     var mixed = { value: false };</span>
<a href="#l3.901"></a><span id="l3.901">     var editorFont = GetCurrentEditor().getFontFaceState(mixed);</span>
<a href="#l3.902"></a><span id="l3.902"> </span>
<a href="#l3.903"></a><span id="l3.903">     // Strip quotes in font names. Experiments have shown that we only</span>
<a href="#l3.904"></a><span id="l3.904">     // ever get double quotes around the font name, never single quotes,</span>
<a href="#l3.905"></a><span id="l3.905">     // even if they were in the HTML source. Also single or double</span>
<a href="#l3.906"></a><span id="l3.906">     // quotes within the font name are never returned.</span>
<a href="#l3.907"></a><span id="l3.907">     editorFont = editorFont.replace(/&quot;/g, &quot;&quot;);</span>
<a href="#l3.908"></a><span id="l3.908"> </span>
<a href="#l3.909"></a><span id="l3.909" class="difflineminus">-    if (!mixed.value)</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineminus">-    {</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineminus">-      switch (editorFont)</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-      {</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+    if (!mixed.value) {</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+      switch (editorFont) {</span>
<a href="#l3.915"></a><span id="l3.915">       case &quot;&quot;:</span>
<a href="#l3.916"></a><span id="l3.916">       case &quot;serif&quot;:</span>
<a href="#l3.917"></a><span id="l3.917">       case &quot;sans-serif&quot;:</span>
<a href="#l3.918"></a><span id="l3.918">         // Generic variable width.</span>
<a href="#l3.919"></a><span id="l3.919">         editorFont = &quot;&quot;;</span>
<a href="#l3.920"></a><span id="l3.920">         break;</span>
<a href="#l3.921"></a><span id="l3.921">       case &quot;tt&quot;:</span>
<a href="#l3.922"></a><span id="l3.922">       case &quot;monospace&quot;:</span>
<a href="#l3.923"></a><span id="l3.923">         // Generic fixed width.</span>
<a href="#l3.924"></a><span id="l3.924">         editorFont = &quot;tt&quot;;</span>
<a href="#l3.925"></a><span id="l3.925">         break;</span>
<a href="#l3.926"></a><span id="l3.926">       default:</span>
<a href="#l3.927"></a><span id="l3.927">         editorFont = editorFont.toLowerCase().replace(/, /g, &quot;,&quot;); // bug 1139524</span>
<a href="#l3.928"></a><span id="l3.928">       }</span>
<a href="#l3.929"></a><span id="l3.929">     }</span>
<a href="#l3.930"></a><span id="l3.930"> </span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-    var editorFontOptions = editorFont.split(',');</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+    var editorFontOptions = editorFont.split(&quot;,&quot;);</span>
<a href="#l3.933"></a><span id="l3.933">     var matchedOption = editorFontOptions.length;  // initialise to high invalid value</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineminus">-    for (var i = 0; i &lt; children.length; i++)</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineminus">-    {</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+    for (var i = 0; i &lt; children.length; i++) {</span>
<a href="#l3.937"></a><span id="l3.937">       var menuItem = children[i];</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineminus">-      if (menuItem.localName == &quot;menuitem&quot;)</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineminus">-      {</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+      if (menuItem.localName == &quot;menuitem&quot;) {</span>
<a href="#l3.941"></a><span id="l3.941">         var matchFound = false;</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-        if (!mixed.value)</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-        {</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+        if (!mixed.value) {</span>
<a href="#l3.945"></a><span id="l3.945">           var menuFont = menuItem.getAttribute(&quot;value&quot;).toLowerCase().replace(/, /g, &quot;,&quot;);</span>
<a href="#l3.946"></a><span id="l3.946"> </span>
<a href="#l3.947"></a><span id="l3.947">           // First compare the entire font string to match items that contain commas.</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-          if (menuFont == editorFont)</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-          {</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+          if (menuFont == editorFont) {</span>
<a href="#l3.951"></a><span id="l3.951">             menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.952"></a><span id="l3.952">             break;</span>
<a href="#l3.953"></a><span id="l3.953">           }</span>
<a href="#l3.954"></a><span id="l3.954"> </span>
<a href="#l3.955"></a><span id="l3.955">           // Next compare the individual options.</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-          else if (editorFontOptions.length &gt; 1)</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-          {</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+          else if (editorFontOptions.length &gt; 1) {</span>
<a href="#l3.959"></a><span id="l3.959">             var matchPos = editorFontOptions.indexOf(menuFont);</span>
<a href="#l3.960"></a><span id="l3.960">             if (matchPos &gt;= 0 &amp;&amp; matchPos &lt; matchedOption) {</span>
<a href="#l3.961"></a><span id="l3.961">               // This menu font comes earlier in the list of options,</span>
<a href="#l3.962"></a><span id="l3.962">               // so prefer it.</span>
<a href="#l3.963"></a><span id="l3.963">               menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.964"></a><span id="l3.964"> </span>
<a href="#l3.965"></a><span id="l3.965">               // If we matched the first option, we don't need to look for</span>
<a href="#l3.966"></a><span id="l3.966">               // a better match.</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineat">@@ -1022,82 +939,73 @@ function initFontFaceMenu(menuPopup)</span>
<a href="#l3.968"></a><span id="l3.968"> // ==separator</span>
<a href="#l3.969"></a><span id="l3.969"> // Helvetica, Arial</span>
<a href="#l3.970"></a><span id="l3.970"> // Times</span>
<a href="#l3.971"></a><span id="l3.971"> // Courier</span>
<a href="#l3.972"></a><span id="l3.972"> // ==separator</span>
<a href="#l3.973"></a><span id="l3.973"> // ==separator</span>
<a href="#l3.974"></a><span id="l3.974"> const kFixedFontFaceMenuItems = 8;</span>
<a href="#l3.975"></a><span id="l3.975"> </span>
<a href="#l3.976"></a><span id="l3.976" class="difflineminus">-function initLocalFontFaceMenu(menuPopup)</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-{</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-  if (!gLocalFonts)</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-  {</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+function initLocalFontFaceMenu(menuPopup) {</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+  if (!gLocalFonts) {</span>
<a href="#l3.982"></a><span id="l3.982">     // Build list of all local fonts once per editor</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-    try</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-    {</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineplus">+    try {</span>
<a href="#l3.986"></a><span id="l3.986">       var enumerator = Cc[&quot;@mozilla.org/gfx/fontenumerator;1&quot;]</span>
<a href="#l3.987"></a><span id="l3.987">                          .getService(Ci.nsIFontEnumerator);</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-      var localFontCount = { value: 0 }</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+      var localFontCount = { value: 0 };</span>
<a href="#l3.990"></a><span id="l3.990">       gLocalFonts = enumerator.EnumerateAllFonts(localFontCount);</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineminus">-    }</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-    catch(e) { }</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+    } catch (e) { }</span>
<a href="#l3.994"></a><span id="l3.994">   }</span>
<a href="#l3.995"></a><span id="l3.995"> </span>
<a href="#l3.996"></a><span id="l3.996">   // Don't use radios for menulists.</span>
<a href="#l3.997"></a><span id="l3.997">   let useRadioMenuitems = (menuPopup.parentNode.localName == &quot;menu&quot;);</span>
<a href="#l3.998"></a><span id="l3.998">   menuPopup.setAttribute(&quot;useRadios&quot;, useRadioMenuitems);</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-  if (menuPopup.childNodes.length == kFixedFontFaceMenuItems)</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-  {</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+  if (menuPopup.childNodes.length == kFixedFontFaceMenuItems) {</span>
<a href="#l3.1002"></a><span id="l3.1002">     if (gLocalFonts.length == 0) {</span>
<a href="#l3.1003"></a><span id="l3.1003">       menuPopup.querySelector(&quot;.fontFaceMenuAfterDefaultFonts&quot;).hidden = true;</span>
<a href="#l3.1004"></a><span id="l3.1004">     }</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineminus">-    for (let i = 0; i &lt; gLocalFonts.length; ++i)</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineminus">-    {</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineplus">+    for (let i = 0; i &lt; gLocalFonts.length; ++i) {</span>
<a href="#l3.1008"></a><span id="l3.1008">       // Remove Linux system generic fonts that collide with CSS generic fonts.</span>
<a href="#l3.1009"></a><span id="l3.1009">       if (gLocalFonts[i] != &quot;&quot; &amp;&amp;</span>
<a href="#l3.1010"></a><span id="l3.1010">           gLocalFonts[i] != &quot;serif&quot; &amp;&amp;</span>
<a href="#l3.1011"></a><span id="l3.1011">           gLocalFonts[i] != &quot;sans-serif&quot; &amp;&amp;</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineminus">-          gLocalFonts[i] != &quot;monospace&quot;)</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineminus">-      {</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineplus">+          gLocalFonts[i] != &quot;monospace&quot;) {</span>
<a href="#l3.1015"></a><span id="l3.1015">         let itemNode = createFontFaceMenuitem(gLocalFonts[i], gLocalFonts[i], menuPopup);</span>
<a href="#l3.1016"></a><span id="l3.1016">         menuPopup.appendChild(itemNode);</span>
<a href="#l3.1017"></a><span id="l3.1017">       }</span>
<a href="#l3.1018"></a><span id="l3.1018">     }</span>
<a href="#l3.1019"></a><span id="l3.1019">   }</span>
<a href="#l3.1020"></a><span id="l3.1020"> }</span>
<a href="#l3.1021"></a><span id="l3.1021"> </span>
<a href="#l3.1022"></a><span id="l3.1022"> /**</span>
<a href="#l3.1023"></a><span id="l3.1023">  * Creates a menuitem element for the font faces menulist. Returns the menuitem</span>
<a href="#l3.1024"></a><span id="l3.1024">  * but does not add it automatically to the menupopup.</span>
<a href="#l3.1025"></a><span id="l3.1025">  *</span>
<a href="#l3.1026"></a><span id="l3.1026">  * @param aFontLabel  Label to be displayed for the item.</span>
<a href="#l3.1027"></a><span id="l3.1027">  * @param aFontName   The font face value to be used for the item.</span>
<a href="#l3.1028"></a><span id="l3.1028">  *                    Will be used in &lt;font face=&quot;value&quot;&gt; in the edited document.</span>
<a href="#l3.1029"></a><span id="l3.1029">  * @param aMenuPopup  The menupopup for which this menuitem is created.</span>
<a href="#l3.1030"></a><span id="l3.1030">  */</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineminus">-function createFontFaceMenuitem(aFontLabel, aFontName, aMenuPopup)</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineminus">-{</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+function createFontFaceMenuitem(aFontLabel, aFontName, aMenuPopup) {</span>
<a href="#l3.1034"></a><span id="l3.1034">   let itemNode = document.createElementNS(XUL_NS, &quot;menuitem&quot;);</span>
<a href="#l3.1035"></a><span id="l3.1035">   itemNode.setAttribute(&quot;label&quot;, aFontLabel);</span>
<a href="#l3.1036"></a><span id="l3.1036">   itemNode.setAttribute(&quot;value&quot;, aFontName);</span>
<a href="#l3.1037"></a><span id="l3.1037">   itemNode.setAttribute(&quot;value_parsed&quot;, aFontName.toLowerCase().replace(/, /g, &quot;,&quot;));</span>
<a href="#l3.1038"></a><span id="l3.1038">   itemNode.setAttribute(&quot;tooltiptext&quot;, aFontLabel);</span>
<a href="#l3.1039"></a><span id="l3.1039">   if (aMenuPopup.getAttribute(&quot;useRadios&quot;) == &quot;true&quot;) {</span>
<a href="#l3.1040"></a><span id="l3.1040">     itemNode.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l3.1041"></a><span id="l3.1041">     itemNode.setAttribute(&quot;observes&quot;, &quot;cmd_renderedHTMLEnabler&quot;);</span>
<a href="#l3.1042"></a><span id="l3.1042">   }</span>
<a href="#l3.1043"></a><span id="l3.1043">   return itemNode;</span>
<a href="#l3.1044"></a><span id="l3.1044"> }</span>
<a href="#l3.1045"></a><span id="l3.1045"> </span>
<a href="#l3.1046"></a><span id="l3.1046"> /**</span>
<a href="#l3.1047"></a><span id="l3.1047">  * Helper function</span>
<a href="#l3.1048"></a><span id="l3.1048">  */</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineminus">-function getFontSizeIndex()</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineminus">-{</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineplus">+function getFontSizeIndex() {</span>
<a href="#l3.1052"></a><span id="l3.1052">   var firstHas = { value: false };</span>
<a href="#l3.1053"></a><span id="l3.1053">   var anyHas = { value: false };</span>
<a href="#l3.1054"></a><span id="l3.1054">   var allHas = { value: false };</span>
<a href="#l3.1055"></a><span id="l3.1055"> </span>
<a href="#l3.1056"></a><span id="l3.1056">   var fontSize = EditorGetTextProperty(&quot;font&quot;, &quot;size&quot;, null, firstHas, anyHas, allHas);</span>
<a href="#l3.1057"></a><span id="l3.1057"> </span>
<a href="#l3.1058"></a><span id="l3.1058">   // If the element has no size attribute and no size was found at all,</span>
<a href="#l3.1059"></a><span id="l3.1059">   // we assume &quot;medium&quot; size. This is highly problematic since</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineat">@@ -1107,18 +1015,17 @@ function getFontSizeIndex()</span>
<a href="#l3.1061"></a><span id="l3.1061">   // imply &quot;medium&quot;.</span>
<a href="#l3.1062"></a><span id="l3.1062">   if (!anyHas.value)</span>
<a href="#l3.1063"></a><span id="l3.1063">     return 2;</span>
<a href="#l3.1064"></a><span id="l3.1064"> </span>
<a href="#l3.1065"></a><span id="l3.1065">   // Mixed selection.</span>
<a href="#l3.1066"></a><span id="l3.1066">   if (!allHas.value)</span>
<a href="#l3.1067"></a><span id="l3.1067">     return -1;</span>
<a href="#l3.1068"></a><span id="l3.1068"> </span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-  switch (fontSize)</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineminus">-  {</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineplus">+  switch (fontSize) {</span>
<a href="#l3.1072"></a><span id="l3.1072">     case &quot;-3&quot;:</span>
<a href="#l3.1073"></a><span id="l3.1073">     case &quot;-2&quot;:</span>
<a href="#l3.1074"></a><span id="l3.1074">     case &quot;0&quot;:</span>
<a href="#l3.1075"></a><span id="l3.1075">     case &quot;1&quot;:</span>
<a href="#l3.1076"></a><span id="l3.1076">       // x-small.</span>
<a href="#l3.1077"></a><span id="l3.1077">       return 0;</span>
<a href="#l3.1078"></a><span id="l3.1078">     case &quot;-1&quot;:</span>
<a href="#l3.1079"></a><span id="l3.1079">     case &quot;2&quot;:</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineat">@@ -1142,35 +1049,30 @@ function getFontSizeIndex()</span>
<a href="#l3.1081"></a><span id="l3.1081">       // xx-large.</span>
<a href="#l3.1082"></a><span id="l3.1082">       return 5;</span>
<a href="#l3.1083"></a><span id="l3.1083">   }</span>
<a href="#l3.1084"></a><span id="l3.1084"> </span>
<a href="#l3.1085"></a><span id="l3.1085">   // We shouldn't get here. All the selection has a value we don't understand.</span>
<a href="#l3.1086"></a><span id="l3.1086">   return -1;</span>
<a href="#l3.1087"></a><span id="l3.1087"> }</span>
<a href="#l3.1088"></a><span id="l3.1088"> </span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineminus">-function initFontSizeMenu(menuPopup, fullMenu)</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineminus">-{</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineminus">-  if (menuPopup)</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineminus">-  {</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineplus">+function initFontSizeMenu(menuPopup, fullMenu) {</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineplus">+  if (menuPopup) {</span>
<a href="#l3.1095"></a><span id="l3.1095">     var children = menuPopup.childNodes;</span>
<a href="#l3.1096"></a><span id="l3.1096">     if (!children)</span>
<a href="#l3.1097"></a><span id="l3.1097">       return;</span>
<a href="#l3.1098"></a><span id="l3.1098"> </span>
<a href="#l3.1099"></a><span id="l3.1099">     // Fixed size items start after menu separator depending on whether it is</span>
<a href="#l3.1100"></a><span id="l3.1100">     // a full menu.</span>
<a href="#l3.1101"></a><span id="l3.1101">     var menuIndex = fullMenu ? 3 : 0;</span>
<a href="#l3.1102"></a><span id="l3.1102"> </span>
<a href="#l3.1103"></a><span id="l3.1103">     var setIndex = getFontSizeIndex();</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineminus">-    if (setIndex &gt;= 0)</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-    {</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineplus">+    if (setIndex &gt;= 0) {</span>
<a href="#l3.1107"></a><span id="l3.1107">       children[menuIndex + setIndex].setAttribute(&quot;checked&quot;, true);</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineminus">-    }</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineminus">-    else</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineminus">-    {</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineplus">+    } else {</span>
<a href="#l3.1112"></a><span id="l3.1112">       // In case of mixed, clear all items.</span>
<a href="#l3.1113"></a><span id="l3.1113">       for (var i = menuIndex; i &lt; children.length; i++) {</span>
<a href="#l3.1114"></a><span id="l3.1114">         children[i].setAttribute(&quot;checked&quot;, false);</span>
<a href="#l3.1115"></a><span id="l3.1115">       }</span>
<a href="#l3.1116"></a><span id="l3.1116">     }</span>
<a href="#l3.1117"></a><span id="l3.1117"> </span>
<a href="#l3.1118"></a><span id="l3.1118">     // Some configurations might not have the &quot;small/big&quot; indicator as</span>
<a href="#l3.1119"></a><span id="l3.1119">     // last item. If there is no indicator, we are done.</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineat">@@ -1187,470 +1089,400 @@ function initFontSizeMenu(menuPopup, ful</span>
<a href="#l3.1121"></a><span id="l3.1121">     var htmlInfo = &quot;&quot;;</span>
<a href="#l3.1122"></a><span id="l3.1122">     EditorGetTextProperty(&quot;small&quot;, &quot;&quot;, &quot;&quot;, firstHas, anyHas, allHas);</span>
<a href="#l3.1123"></a><span id="l3.1123">     if (anyHas.value)</span>
<a href="#l3.1124"></a><span id="l3.1124">       htmlInfo = &quot;&lt;small&gt;&quot;;</span>
<a href="#l3.1125"></a><span id="l3.1125">     EditorGetTextProperty(&quot;big&quot;, &quot;&quot;, &quot;&quot;, firstHas, anyHas, allHas);</span>
<a href="#l3.1126"></a><span id="l3.1126">     if (anyHas.value)</span>
<a href="#l3.1127"></a><span id="l3.1127">       htmlInfo += &quot;&lt;big&gt;&quot;;</span>
<a href="#l3.1128"></a><span id="l3.1128"> </span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineminus">-    if (htmlInfo)</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineminus">-    {</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+    if (htmlInfo) {</span>
<a href="#l3.1132"></a><span id="l3.1132">       menuPopup.lastChild.hidden = false;</span>
<a href="#l3.1133"></a><span id="l3.1133">       menuPopup.lastChild.setAttribute(&quot;label&quot;, &quot;HTML: &quot; + htmlInfo);</span>
<a href="#l3.1134"></a><span id="l3.1134">       menuPopup.lastChild.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineminus">-    }</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineminus">-    else</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineminus">-    {</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineplus">+    } else {</span>
<a href="#l3.1139"></a><span id="l3.1139">       menuPopup.lastChild.hidden = true;</span>
<a href="#l3.1140"></a><span id="l3.1140">     }</span>
<a href="#l3.1141"></a><span id="l3.1141">   }</span>
<a href="#l3.1142"></a><span id="l3.1142"> }</span>
<a href="#l3.1143"></a><span id="l3.1143"> </span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-function onHighlightColorChange()</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-{</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineplus">+function onHighlightColorChange() {</span>
<a href="#l3.1147"></a><span id="l3.1147">   ChangeButtonColor(&quot;cmd_highlight&quot;, &quot;HighlightColorButton&quot;,</span>
<a href="#l3.1148"></a><span id="l3.1148">                     &quot;transparent&quot;);</span>
<a href="#l3.1149"></a><span id="l3.1149"> }</span>
<a href="#l3.1150"></a><span id="l3.1150"> </span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineminus">-function onFontColorChange()</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineminus">-{</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineplus">+function onFontColorChange() {</span>
<a href="#l3.1154"></a><span id="l3.1154">   ChangeButtonColor(&quot;cmd_fontColor&quot;, &quot;TextColorButton&quot;,</span>
<a href="#l3.1155"></a><span id="l3.1155">                     gDefaultTextColor);</span>
<a href="#l3.1156"></a><span id="l3.1156"> }</span>
<a href="#l3.1157"></a><span id="l3.1157"> </span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineminus">-function onBackgroundColorChange()</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineminus">-{</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineplus">+function onBackgroundColorChange() {</span>
<a href="#l3.1161"></a><span id="l3.1161">   ChangeButtonColor(&quot;cmd_backgroundColor&quot;, &quot;BackgroundColorButton&quot;,</span>
<a href="#l3.1162"></a><span id="l3.1162">                     gDefaultBackgroundColor);</span>
<a href="#l3.1163"></a><span id="l3.1163"> }</span>
<a href="#l3.1164"></a><span id="l3.1164"> </span>
<a href="#l3.1165"></a><span id="l3.1165"> /* Helper function that changes the button color.</span>
<a href="#l3.1166"></a><span id="l3.1166">  *   commandID - The ID of the command element.</span>
<a href="#l3.1167"></a><span id="l3.1167">  *   id - The ID of the button needing to be changed.</span>
<a href="#l3.1168"></a><span id="l3.1168">  *   defaultColor - The default color the button gets set to.</span>
<a href="#l3.1169"></a><span id="l3.1169">  */</span>
<a href="#l3.1170"></a><span id="l3.1170"> function ChangeButtonColor(commandID, id, defaultColor) {</span>
<a href="#l3.1171"></a><span id="l3.1171">   var commandNode = document.getElementById(commandID);</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineminus">-  if (commandNode)</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineminus">-  {</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineplus">+  if (commandNode) {</span>
<a href="#l3.1175"></a><span id="l3.1175">     var color = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.1176"></a><span id="l3.1176">     var button = document.getElementById(id);</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineminus">-    if (button)</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineminus">-    {</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineplus">+    if (button) {</span>
<a href="#l3.1180"></a><span id="l3.1180">       button.setAttribute(&quot;color&quot;, color);</span>
<a href="#l3.1181"></a><span id="l3.1181"> </span>
<a href="#l3.1182"></a><span id="l3.1182">       // No color or a mixed color - get color set on page or other defaults.</span>
<a href="#l3.1183"></a><span id="l3.1183">       if (!color || color == &quot;mixed&quot;)</span>
<a href="#l3.1184"></a><span id="l3.1184">         color = defaultColor;</span>
<a href="#l3.1185"></a><span id="l3.1185"> </span>
<a href="#l3.1186"></a><span id="l3.1186">       button.setAttribute(&quot;style&quot;, &quot;background-color:&quot; + color + &quot; !important&quot;);</span>
<a href="#l3.1187"></a><span id="l3.1187">     }</span>
<a href="#l3.1188"></a><span id="l3.1188">   }</span>
<a href="#l3.1189"></a><span id="l3.1189"> }</span>
<a href="#l3.1190"></a><span id="l3.1190"> </span>
<a href="#l3.1191"></a><span id="l3.1191"> // Call this when user changes text and/or background colors of the page</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineminus">-function UpdateDefaultColors()</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineminus">-{</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineplus">+function UpdateDefaultColors() {</span>
<a href="#l3.1195"></a><span id="l3.1195">   var BrowserColors = GetDefaultBrowserColors();</span>
<a href="#l3.1196"></a><span id="l3.1196">   var bodyelement = GetBodyElement();</span>
<a href="#l3.1197"></a><span id="l3.1197">   var defTextColor = gDefaultTextColor;</span>
<a href="#l3.1198"></a><span id="l3.1198">   var defBackColor = gDefaultBackgroundColor;</span>
<a href="#l3.1199"></a><span id="l3.1199"> </span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineminus">-  if (bodyelement)</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineminus">-  {</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineplus">+  if (bodyelement) {</span>
<a href="#l3.1203"></a><span id="l3.1203">     var color = bodyelement.getAttribute(&quot;text&quot;);</span>
<a href="#l3.1204"></a><span id="l3.1204">     if (color)</span>
<a href="#l3.1205"></a><span id="l3.1205">       gDefaultTextColor = color;</span>
<a href="#l3.1206"></a><span id="l3.1206">     else if (BrowserColors)</span>
<a href="#l3.1207"></a><span id="l3.1207">       gDefaultTextColor = BrowserColors.TextColor;</span>
<a href="#l3.1208"></a><span id="l3.1208"> </span>
<a href="#l3.1209"></a><span id="l3.1209">     color = bodyelement.getAttribute(&quot;bgcolor&quot;);</span>
<a href="#l3.1210"></a><span id="l3.1210">     if (color)</span>
<a href="#l3.1211"></a><span id="l3.1211">       gDefaultBackgroundColor = color;</span>
<a href="#l3.1212"></a><span id="l3.1212">     else if (BrowserColors)</span>
<a href="#l3.1213"></a><span id="l3.1213">       gDefaultBackgroundColor = BrowserColors.BackgroundColor;</span>
<a href="#l3.1214"></a><span id="l3.1214">   }</span>
<a href="#l3.1215"></a><span id="l3.1215"> </span>
<a href="#l3.1216"></a><span id="l3.1216">   // Trigger update on toolbar</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineminus">-  if (defTextColor != gDefaultTextColor)</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineminus">-  {</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineplus">+  if (defTextColor != gDefaultTextColor) {</span>
<a href="#l3.1220"></a><span id="l3.1220">     goUpdateCommandState(&quot;cmd_fontColor&quot;);</span>
<a href="#l3.1221"></a><span id="l3.1221">     onFontColorChange();</span>
<a href="#l3.1222"></a><span id="l3.1222">   }</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineminus">-  if (defBackColor != gDefaultBackgroundColor)</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineminus">-  {</span>
<a href="#l3.1225"></a><span id="l3.1225" class="difflineplus">+  if (defBackColor != gDefaultBackgroundColor) {</span>
<a href="#l3.1226"></a><span id="l3.1226">     goUpdateCommandState(&quot;cmd_backgroundColor&quot;);</span>
<a href="#l3.1227"></a><span id="l3.1227">     onBackgroundColorChange();</span>
<a href="#l3.1228"></a><span id="l3.1228">   }</span>
<a href="#l3.1229"></a><span id="l3.1229"> }</span>
<a href="#l3.1230"></a><span id="l3.1230"> </span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineminus">-function GetBackgroundElementWithColor()</span>
<a href="#l3.1232"></a><span id="l3.1232" class="difflineminus">-{</span>
<a href="#l3.1233"></a><span id="l3.1233" class="difflineplus">+function GetBackgroundElementWithColor() {</span>
<a href="#l3.1234"></a><span id="l3.1234">   var editor = GetCurrentTableEditor();</span>
<a href="#l3.1235"></a><span id="l3.1235">   if (!editor)</span>
<a href="#l3.1236"></a><span id="l3.1236">     return null;</span>
<a href="#l3.1237"></a><span id="l3.1237"> </span>
<a href="#l3.1238"></a><span id="l3.1238">   gColorObj.Type = &quot;&quot;;</span>
<a href="#l3.1239"></a><span id="l3.1239">   gColorObj.PageColor = &quot;&quot;;</span>
<a href="#l3.1240"></a><span id="l3.1240">   gColorObj.TableColor = &quot;&quot;;</span>
<a href="#l3.1241"></a><span id="l3.1241">   gColorObj.CellColor = &quot;&quot;;</span>
<a href="#l3.1242"></a><span id="l3.1242">   gColorObj.BackgroundColor = &quot;&quot;;</span>
<a href="#l3.1243"></a><span id="l3.1243">   gColorObj.SelectedType = &quot;&quot;;</span>
<a href="#l3.1244"></a><span id="l3.1244"> </span>
<a href="#l3.1245"></a><span id="l3.1245">   var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l3.1246"></a><span id="l3.1246">   var element;</span>
<a href="#l3.1247"></a><span id="l3.1247">   try {</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineminus">-    element = editor.getSelectedOrParentTableElement(tagNameObj, {value:0});</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineminus">-  }</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineminus">-  catch(e) {}</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineminus">-</span>
<a href="#l3.1252"></a><span id="l3.1252" class="difflineminus">-  if (element &amp;&amp; tagNameObj &amp;&amp; tagNameObj.value)</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineminus">-  {</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineplus">+    element = editor.getSelectedOrParentTableElement(tagNameObj, {value: 0});</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineplus">+  } catch (e) {}</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineplus">+</span>
<a href="#l3.1257"></a><span id="l3.1257" class="difflineplus">+  if (element &amp;&amp; tagNameObj &amp;&amp; tagNameObj.value) {</span>
<a href="#l3.1258"></a><span id="l3.1258">     gColorObj.BackgroundColor = GetHTMLOrCSSStyleValue(element, &quot;bgcolor&quot;, &quot;background-color&quot;);</span>
<a href="#l3.1259"></a><span id="l3.1259">     gColorObj.BackgroundColor = ConvertRGBColorIntoHEXColor(gColorObj.BackgroundColor);</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineminus">-    if (tagNameObj.value.toLowerCase() == &quot;td&quot;)</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineminus">-    {</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineplus">+    if (tagNameObj.value.toLowerCase() == &quot;td&quot;) {</span>
<a href="#l3.1263"></a><span id="l3.1263">       gColorObj.Type = &quot;Cell&quot;;</span>
<a href="#l3.1264"></a><span id="l3.1264">       gColorObj.CellColor = gColorObj.BackgroundColor;</span>
<a href="#l3.1265"></a><span id="l3.1265"> </span>
<a href="#l3.1266"></a><span id="l3.1266">       // Get any color that might be on parent table</span>
<a href="#l3.1267"></a><span id="l3.1267">       var table = GetParentTable(element);</span>
<a href="#l3.1268"></a><span id="l3.1268">       gColorObj.TableColor = GetHTMLOrCSSStyleValue(table, &quot;bgcolor&quot;, &quot;background-color&quot;);</span>
<a href="#l3.1269"></a><span id="l3.1269">       gColorObj.TableColor = ConvertRGBColorIntoHEXColor(gColorObj.TableColor);</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineminus">-    }</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineminus">-    else</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineminus">-    {</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineplus">+    } else {</span>
<a href="#l3.1274"></a><span id="l3.1274">       gColorObj.Type = &quot;Table&quot;;</span>
<a href="#l3.1275"></a><span id="l3.1275">       gColorObj.TableColor = gColorObj.BackgroundColor;</span>
<a href="#l3.1276"></a><span id="l3.1276">     }</span>
<a href="#l3.1277"></a><span id="l3.1277">     gColorObj.SelectedType = gColorObj.Type;</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineminus">-  }</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineminus">-  else</span>
<a href="#l3.1280"></a><span id="l3.1280" class="difflineminus">-  {</span>
<a href="#l3.1281"></a><span id="l3.1281" class="difflineplus">+  } else {</span>
<a href="#l3.1282"></a><span id="l3.1282">     let IsCSSPrefChecked = Services.prefs.getBoolPref(kUseCssPref);</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineminus">-    if (IsCSSPrefChecked &amp;&amp; IsHTMLEditor())</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineminus">-    {</span>
<a href="#l3.1285"></a><span id="l3.1285" class="difflineplus">+    if (IsCSSPrefChecked &amp;&amp; IsHTMLEditor()) {</span>
<a href="#l3.1286"></a><span id="l3.1286">       let selection = editor.selection;</span>
<a href="#l3.1287"></a><span id="l3.1287" class="difflineminus">-      if (selection)</span>
<a href="#l3.1288"></a><span id="l3.1288" class="difflineminus">-      {</span>
<a href="#l3.1289"></a><span id="l3.1289" class="difflineplus">+      if (selection) {</span>
<a href="#l3.1290"></a><span id="l3.1290">         element = selection.focusNode;</span>
<a href="#l3.1291"></a><span id="l3.1291">         while (!editor.nodeIsBlock(element))</span>
<a href="#l3.1292"></a><span id="l3.1292">           element = element.parentNode;</span>
<a href="#l3.1293"></a><span id="l3.1293" class="difflineminus">-      }</span>
<a href="#l3.1294"></a><span id="l3.1294" class="difflineminus">-      else</span>
<a href="#l3.1295"></a><span id="l3.1295" class="difflineminus">-      {</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineplus">+      } else {</span>
<a href="#l3.1297"></a><span id="l3.1297">         element = GetBodyElement();</span>
<a href="#l3.1298"></a><span id="l3.1298">       }</span>
<a href="#l3.1299"></a><span id="l3.1299" class="difflineminus">-    }</span>
<a href="#l3.1300"></a><span id="l3.1300" class="difflineminus">-    else</span>
<a href="#l3.1301"></a><span id="l3.1301" class="difflineminus">-    {</span>
<a href="#l3.1302"></a><span id="l3.1302" class="difflineplus">+    } else {</span>
<a href="#l3.1303"></a><span id="l3.1303">       element = GetBodyElement();</span>
<a href="#l3.1304"></a><span id="l3.1304">     }</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineminus">-    if (element)</span>
<a href="#l3.1306"></a><span id="l3.1306" class="difflineminus">-    {</span>
<a href="#l3.1307"></a><span id="l3.1307" class="difflineplus">+    if (element) {</span>
<a href="#l3.1308"></a><span id="l3.1308">       gColorObj.Type = &quot;Page&quot;;</span>
<a href="#l3.1309"></a><span id="l3.1309">       gColorObj.BackgroundColor = GetHTMLOrCSSStyleValue(element, &quot;bgcolor&quot;, &quot;background-color&quot;);</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-      if (gColorObj.BackgroundColor == &quot;&quot;)</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineminus">-      {</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineplus">+      if (gColorObj.BackgroundColor == &quot;&quot;) {</span>
<a href="#l3.1313"></a><span id="l3.1313">         gColorObj.BackgroundColor = &quot;transparent&quot;;</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineminus">-      }</span>
<a href="#l3.1315"></a><span id="l3.1315" class="difflineminus">-      else</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineminus">-      {</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineplus">+      } else {</span>
<a href="#l3.1318"></a><span id="l3.1318">         gColorObj.BackgroundColor = ConvertRGBColorIntoHEXColor(gColorObj.BackgroundColor);</span>
<a href="#l3.1319"></a><span id="l3.1319">       }</span>
<a href="#l3.1320"></a><span id="l3.1320">       gColorObj.PageColor = gColorObj.BackgroundColor;</span>
<a href="#l3.1321"></a><span id="l3.1321">     }</span>
<a href="#l3.1322"></a><span id="l3.1322">   }</span>
<a href="#l3.1323"></a><span id="l3.1323">   return element;</span>
<a href="#l3.1324"></a><span id="l3.1324"> }</span>
<a href="#l3.1325"></a><span id="l3.1325"> </span>
<a href="#l3.1326"></a><span id="l3.1326" class="difflineminus">-function SetSmiley(smileyText)</span>
<a href="#l3.1327"></a><span id="l3.1327" class="difflineminus">-{</span>
<a href="#l3.1328"></a><span id="l3.1328" class="difflineplus">+function SetSmiley(smileyText) {</span>
<a href="#l3.1329"></a><span id="l3.1329">   try {</span>
<a href="#l3.1330"></a><span id="l3.1330">     GetCurrentEditor().insertText(smileyText);</span>
<a href="#l3.1331"></a><span id="l3.1331">     gContentWindow.focus();</span>
<a href="#l3.1332"></a><span id="l3.1332" class="difflineminus">-  }</span>
<a href="#l3.1333"></a><span id="l3.1333" class="difflineminus">-  catch(e) {}</span>
<a href="#l3.1334"></a><span id="l3.1334" class="difflineplus">+  } catch (e) {}</span>
<a href="#l3.1335"></a><span id="l3.1335"> }</span>
<a href="#l3.1336"></a><span id="l3.1336"> </span>
<a href="#l3.1337"></a><span id="l3.1337" class="difflineminus">-function EditorSelectColor(colorType, mouseEvent)</span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineminus">-{</span>
<a href="#l3.1339"></a><span id="l3.1339" class="difflineplus">+function EditorSelectColor(colorType, mouseEvent) {</span>
<a href="#l3.1340"></a><span id="l3.1340">   var editor = GetCurrentEditor();</span>
<a href="#l3.1341"></a><span id="l3.1341">   if (!editor || !gColorObj)</span>
<a href="#l3.1342"></a><span id="l3.1342">     return;</span>
<a href="#l3.1343"></a><span id="l3.1343"> </span>
<a href="#l3.1344"></a><span id="l3.1344">   // Shift + mouse click automatically applies last color, if available</span>
<a href="#l3.1345"></a><span id="l3.1345" class="difflineminus">-  var useLastColor = mouseEvent ? ( mouseEvent.button == 0 &amp;&amp; mouseEvent.shiftKey ) : false;</span>
<a href="#l3.1346"></a><span id="l3.1346" class="difflineplus">+  var useLastColor = mouseEvent ? (mouseEvent.button == 0 &amp;&amp; mouseEvent.shiftKey) : false;</span>
<a href="#l3.1347"></a><span id="l3.1347">   var element;</span>
<a href="#l3.1348"></a><span id="l3.1348">   var table;</span>
<a href="#l3.1349"></a><span id="l3.1349">   var currentColor = &quot;&quot;;</span>
<a href="#l3.1350"></a><span id="l3.1350">   var commandNode;</span>
<a href="#l3.1351"></a><span id="l3.1351"> </span>
<a href="#l3.1352"></a><span id="l3.1352">   if (!colorType)</span>
<a href="#l3.1353"></a><span id="l3.1353">     colorType = &quot;&quot;;</span>
<a href="#l3.1354"></a><span id="l3.1354"> </span>
<a href="#l3.1355"></a><span id="l3.1355" class="difflineminus">-  if (colorType == &quot;Text&quot;)</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineminus">-  {</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineplus">+  if (colorType == &quot;Text&quot;) {</span>
<a href="#l3.1358"></a><span id="l3.1358">     gColorObj.Type = colorType;</span>
<a href="#l3.1359"></a><span id="l3.1359"> </span>
<a href="#l3.1360"></a><span id="l3.1360">     // Get color from command node state</span>
<a href="#l3.1361"></a><span id="l3.1361">     commandNode = document.getElementById(&quot;cmd_fontColor&quot;);</span>
<a href="#l3.1362"></a><span id="l3.1362">     currentColor = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.1363"></a><span id="l3.1363">     currentColor = ConvertRGBColorIntoHEXColor(currentColor);</span>
<a href="#l3.1364"></a><span id="l3.1364">     gColorObj.TextColor = currentColor;</span>
<a href="#l3.1365"></a><span id="l3.1365"> </span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineminus">-    if (useLastColor &amp;&amp; gColorObj.LastTextColor )</span>
<a href="#l3.1367"></a><span id="l3.1367" class="difflineplus">+    if (useLastColor &amp;&amp; gColorObj.LastTextColor)</span>
<a href="#l3.1368"></a><span id="l3.1368">       gColorObj.TextColor = gColorObj.LastTextColor;</span>
<a href="#l3.1369"></a><span id="l3.1369">     else</span>
<a href="#l3.1370"></a><span id="l3.1370">       useLastColor = false;</span>
<a href="#l3.1371"></a><span id="l3.1371" class="difflineminus">-  }</span>
<a href="#l3.1372"></a><span id="l3.1372" class="difflineminus">-  else if (colorType == &quot;Highlight&quot;)</span>
<a href="#l3.1373"></a><span id="l3.1373" class="difflineminus">-  {</span>
<a href="#l3.1374"></a><span id="l3.1374" class="difflineplus">+  } else if (colorType == &quot;Highlight&quot;) {</span>
<a href="#l3.1375"></a><span id="l3.1375">     gColorObj.Type = colorType;</span>
<a href="#l3.1376"></a><span id="l3.1376"> </span>
<a href="#l3.1377"></a><span id="l3.1377">     // Get color from command node state</span>
<a href="#l3.1378"></a><span id="l3.1378">     commandNode = document.getElementById(&quot;cmd_highlight&quot;);</span>
<a href="#l3.1379"></a><span id="l3.1379">     currentColor = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.1380"></a><span id="l3.1380">     currentColor = ConvertRGBColorIntoHEXColor(currentColor);</span>
<a href="#l3.1381"></a><span id="l3.1381">     gColorObj.HighlightColor = currentColor;</span>
<a href="#l3.1382"></a><span id="l3.1382"> </span>
<a href="#l3.1383"></a><span id="l3.1383" class="difflineminus">-    if (useLastColor &amp;&amp; gColorObj.LastHighlightColor )</span>
<a href="#l3.1384"></a><span id="l3.1384" class="difflineplus">+    if (useLastColor &amp;&amp; gColorObj.LastHighlightColor)</span>
<a href="#l3.1385"></a><span id="l3.1385">       gColorObj.HighlightColor = gColorObj.LastHighlightColor;</span>
<a href="#l3.1386"></a><span id="l3.1386">     else</span>
<a href="#l3.1387"></a><span id="l3.1387">       useLastColor = false;</span>
<a href="#l3.1388"></a><span id="l3.1388" class="difflineminus">-  }</span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineminus">-  else</span>
<a href="#l3.1390"></a><span id="l3.1390" class="difflineminus">-  {</span>
<a href="#l3.1391"></a><span id="l3.1391" class="difflineplus">+  } else {</span>
<a href="#l3.1392"></a><span id="l3.1392">     element = GetBackgroundElementWithColor();</span>
<a href="#l3.1393"></a><span id="l3.1393">     if (!element)</span>
<a href="#l3.1394"></a><span id="l3.1394">       return;</span>
<a href="#l3.1395"></a><span id="l3.1395"> </span>
<a href="#l3.1396"></a><span id="l3.1396">     // Get the table if we found a cell</span>
<a href="#l3.1397"></a><span id="l3.1397">     if (gColorObj.Type == &quot;Table&quot;)</span>
<a href="#l3.1398"></a><span id="l3.1398">       table = element;</span>
<a href="#l3.1399"></a><span id="l3.1399">     else if (gColorObj.Type == &quot;Cell&quot;)</span>
<a href="#l3.1400"></a><span id="l3.1400">       table = GetParentTable(element);</span>
<a href="#l3.1401"></a><span id="l3.1401"> </span>
<a href="#l3.1402"></a><span id="l3.1402">     // Save to avoid resetting if not necessary</span>
<a href="#l3.1403"></a><span id="l3.1403">     currentColor = gColorObj.BackgroundColor;</span>
<a href="#l3.1404"></a><span id="l3.1404"> </span>
<a href="#l3.1405"></a><span id="l3.1405" class="difflineminus">-    if (colorType == &quot;TableOrCell&quot; || colorType == &quot;Cell&quot;)</span>
<a href="#l3.1406"></a><span id="l3.1406" class="difflineminus">-    {</span>
<a href="#l3.1407"></a><span id="l3.1407" class="difflineplus">+    if (colorType == &quot;TableOrCell&quot; || colorType == &quot;Cell&quot;) {</span>
<a href="#l3.1408"></a><span id="l3.1408">       if (gColorObj.Type == &quot;Cell&quot;)</span>
<a href="#l3.1409"></a><span id="l3.1409">         gColorObj.Type = colorType;</span>
<a href="#l3.1410"></a><span id="l3.1410">       else if (gColorObj.Type != &quot;Table&quot;)</span>
<a href="#l3.1411"></a><span id="l3.1411">         return;</span>
<a href="#l3.1412"></a><span id="l3.1412" class="difflineminus">-    }</span>
<a href="#l3.1413"></a><span id="l3.1413" class="difflineminus">-    else if (colorType == &quot;Table&quot; &amp;&amp; gColorObj.Type == &quot;Page&quot;)</span>
<a href="#l3.1414"></a><span id="l3.1414" class="difflineplus">+    } else if (colorType == &quot;Table&quot; &amp;&amp; gColorObj.Type == &quot;Page&quot;)</span>
<a href="#l3.1415"></a><span id="l3.1415">       return;</span>
<a href="#l3.1416"></a><span id="l3.1416"> </span>
<a href="#l3.1417"></a><span id="l3.1417" class="difflineminus">-    if (colorType == &quot;&quot; &amp;&amp; gColorObj.Type == &quot;Cell&quot;)</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineminus">-    {</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineplus">+    if (colorType == &quot;&quot; &amp;&amp; gColorObj.Type == &quot;Cell&quot;) {</span>
<a href="#l3.1420"></a><span id="l3.1420">       // Using empty string for requested type means</span>
<a href="#l3.1421"></a><span id="l3.1421">       //  we can let user select cell or table</span>
<a href="#l3.1422"></a><span id="l3.1422">       gColorObj.Type = &quot;TableOrCell&quot;;</span>
<a href="#l3.1423"></a><span id="l3.1423">     }</span>
<a href="#l3.1424"></a><span id="l3.1424"> </span>
<a href="#l3.1425"></a><span id="l3.1425" class="difflineminus">-    if (useLastColor &amp;&amp; gColorObj.LastBackgroundColor )</span>
<a href="#l3.1426"></a><span id="l3.1426" class="difflineplus">+    if (useLastColor &amp;&amp; gColorObj.LastBackgroundColor)</span>
<a href="#l3.1427"></a><span id="l3.1427">       gColorObj.BackgroundColor = gColorObj.LastBackgroundColor;</span>
<a href="#l3.1428"></a><span id="l3.1428">     else</span>
<a href="#l3.1429"></a><span id="l3.1429">       useLastColor = false;</span>
<a href="#l3.1430"></a><span id="l3.1430">   }</span>
<a href="#l3.1431"></a><span id="l3.1431">   // Save the type we are really requesting</span>
<a href="#l3.1432"></a><span id="l3.1432">   colorType = gColorObj.Type;</span>
<a href="#l3.1433"></a><span id="l3.1433"> </span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineminus">-  if (!useLastColor)</span>
<a href="#l3.1435"></a><span id="l3.1435" class="difflineminus">-  {</span>
<a href="#l3.1436"></a><span id="l3.1436" class="difflineplus">+  if (!useLastColor) {</span>
<a href="#l3.1437"></a><span id="l3.1437">     // Avoid the JS warning</span>
<a href="#l3.1438"></a><span id="l3.1438">     gColorObj.NoDefault = false;</span>
<a href="#l3.1439"></a><span id="l3.1439"> </span>
<a href="#l3.1440"></a><span id="l3.1440">     // Launch the ColorPicker dialog</span>
<a href="#l3.1441"></a><span id="l3.1441">     // TODO: Figure out how to position this under the color buttons on the toolbar</span>
<a href="#l3.1442"></a><span id="l3.1442">     window.openDialog(&quot;chrome://editor/content/EdColorPicker.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, gColorObj);</span>
<a href="#l3.1443"></a><span id="l3.1443"> </span>
<a href="#l3.1444"></a><span id="l3.1444">     // User canceled the dialog</span>
<a href="#l3.1445"></a><span id="l3.1445">     if (gColorObj.Cancel)</span>
<a href="#l3.1446"></a><span id="l3.1446">       return;</span>
<a href="#l3.1447"></a><span id="l3.1447">   }</span>
<a href="#l3.1448"></a><span id="l3.1448"> </span>
<a href="#l3.1449"></a><span id="l3.1449" class="difflineminus">-  if (gColorObj.Type == &quot;Text&quot;)</span>
<a href="#l3.1450"></a><span id="l3.1450" class="difflineminus">-  {</span>
<a href="#l3.1451"></a><span id="l3.1451" class="difflineminus">-    if (currentColor != gColorObj.TextColor)</span>
<a href="#l3.1452"></a><span id="l3.1452" class="difflineminus">-    {</span>
<a href="#l3.1453"></a><span id="l3.1453" class="difflineplus">+  if (gColorObj.Type == &quot;Text&quot;) {</span>
<a href="#l3.1454"></a><span id="l3.1454" class="difflineplus">+    if (currentColor != gColorObj.TextColor) {</span>
<a href="#l3.1455"></a><span id="l3.1455">       if (gColorObj.TextColor)</span>
<a href="#l3.1456"></a><span id="l3.1456">         EditorSetTextProperty(&quot;font&quot;, &quot;color&quot;, gColorObj.TextColor);</span>
<a href="#l3.1457"></a><span id="l3.1457">       else</span>
<a href="#l3.1458"></a><span id="l3.1458">         EditorRemoveTextProperty(&quot;font&quot;, &quot;color&quot;);</span>
<a href="#l3.1459"></a><span id="l3.1459">     }</span>
<a href="#l3.1460"></a><span id="l3.1460">     // Update the command state (this will trigger color button update)</span>
<a href="#l3.1461"></a><span id="l3.1461">     goUpdateCommandState(&quot;cmd_fontColor&quot;);</span>
<a href="#l3.1462"></a><span id="l3.1462" class="difflineminus">-  }</span>
<a href="#l3.1463"></a><span id="l3.1463" class="difflineminus">-  else if (gColorObj.Type == &quot;Highlight&quot;)</span>
<a href="#l3.1464"></a><span id="l3.1464" class="difflineminus">-  {</span>
<a href="#l3.1465"></a><span id="l3.1465" class="difflineminus">-    if (currentColor != gColorObj.HighlightColor)</span>
<a href="#l3.1466"></a><span id="l3.1466" class="difflineminus">-    {</span>
<a href="#l3.1467"></a><span id="l3.1467" class="difflineplus">+  } else if (gColorObj.Type == &quot;Highlight&quot;) {</span>
<a href="#l3.1468"></a><span id="l3.1468" class="difflineplus">+    if (currentColor != gColorObj.HighlightColor) {</span>
<a href="#l3.1469"></a><span id="l3.1469">       if (gColorObj.HighlightColor)</span>
<a href="#l3.1470"></a><span id="l3.1470">         EditorSetTextProperty(&quot;font&quot;, &quot;bgcolor&quot;, gColorObj.HighlightColor);</span>
<a href="#l3.1471"></a><span id="l3.1471">       else</span>
<a href="#l3.1472"></a><span id="l3.1472">         EditorRemoveTextProperty(&quot;font&quot;, &quot;bgcolor&quot;);</span>
<a href="#l3.1473"></a><span id="l3.1473">     }</span>
<a href="#l3.1474"></a><span id="l3.1474">     // Update the command state (this will trigger color button update)</span>
<a href="#l3.1475"></a><span id="l3.1475">     goUpdateCommandState(&quot;cmd_highlight&quot;);</span>
<a href="#l3.1476"></a><span id="l3.1476" class="difflineminus">-  }</span>
<a href="#l3.1477"></a><span id="l3.1477" class="difflineminus">-  else if (element)</span>
<a href="#l3.1478"></a><span id="l3.1478" class="difflineminus">-  {</span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineminus">-    if (gColorObj.Type == &quot;Table&quot;)</span>
<a href="#l3.1480"></a><span id="l3.1480" class="difflineminus">-    {</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineplus">+  } else if (element) {</span>
<a href="#l3.1482"></a><span id="l3.1482" class="difflineplus">+    if (gColorObj.Type == &quot;Table&quot;) {</span>
<a href="#l3.1483"></a><span id="l3.1483">       // Set background on a table</span>
<a href="#l3.1484"></a><span id="l3.1484">       // Note that we shouldn't trust &quot;currentColor&quot; because of &quot;TableOrCell&quot; behavior</span>
<a href="#l3.1485"></a><span id="l3.1485" class="difflineminus">-      if (table)</span>
<a href="#l3.1486"></a><span id="l3.1486" class="difflineminus">-      {</span>
<a href="#l3.1487"></a><span id="l3.1487" class="difflineplus">+      if (table) {</span>
<a href="#l3.1488"></a><span id="l3.1488">         var bgcolor = table.getAttribute(&quot;bgcolor&quot;);</span>
<a href="#l3.1489"></a><span id="l3.1489">         if (bgcolor != gColorObj.BackgroundColor)</span>
<a href="#l3.1490"></a><span id="l3.1490">         try {</span>
<a href="#l3.1491"></a><span id="l3.1491">           if (gColorObj.BackgroundColor)</span>
<a href="#l3.1492"></a><span id="l3.1492">             editor.setAttributeOrEquivalent(table, &quot;bgcolor&quot;, gColorObj.BackgroundColor, false);</span>
<a href="#l3.1493"></a><span id="l3.1493">           else</span>
<a href="#l3.1494"></a><span id="l3.1494">             editor.removeAttributeOrEquivalent(table, &quot;bgcolor&quot;, false);</span>
<a href="#l3.1495"></a><span id="l3.1495">         } catch (e) {}</span>
<a href="#l3.1496"></a><span id="l3.1496">       }</span>
<a href="#l3.1497"></a><span id="l3.1497" class="difflineminus">-    }</span>
<a href="#l3.1498"></a><span id="l3.1498" class="difflineminus">-    else if (currentColor != gColorObj.BackgroundColor &amp;&amp; IsHTMLEditor())</span>
<a href="#l3.1499"></a><span id="l3.1499" class="difflineminus">-    {</span>
<a href="#l3.1500"></a><span id="l3.1500" class="difflineplus">+    } else if (currentColor != gColorObj.BackgroundColor &amp;&amp; IsHTMLEditor()) {</span>
<a href="#l3.1501"></a><span id="l3.1501">       editor.beginTransaction();</span>
<a href="#l3.1502"></a><span id="l3.1502" class="difflineminus">-      try</span>
<a href="#l3.1503"></a><span id="l3.1503" class="difflineminus">-      {</span>
<a href="#l3.1504"></a><span id="l3.1504" class="difflineplus">+      try {</span>
<a href="#l3.1505"></a><span id="l3.1505">         editor.setBackgroundColor(gColorObj.BackgroundColor);</span>
<a href="#l3.1506"></a><span id="l3.1506"> </span>
<a href="#l3.1507"></a><span id="l3.1507" class="difflineminus">-        if (gColorObj.Type == &quot;Page&quot; &amp;&amp; gColorObj.BackgroundColor)</span>
<a href="#l3.1508"></a><span id="l3.1508" class="difflineminus">-        {</span>
<a href="#l3.1509"></a><span id="l3.1509" class="difflineplus">+        if (gColorObj.Type == &quot;Page&quot; &amp;&amp; gColorObj.BackgroundColor) {</span>
<a href="#l3.1510"></a><span id="l3.1510">           // Set all page colors not explicitly set,</span>
<a href="#l3.1511"></a><span id="l3.1511">           //  else you can end up with unreadable pages</span>
<a href="#l3.1512"></a><span id="l3.1512">           //  because viewer's default colors may not be same as page author's</span>
<a href="#l3.1513"></a><span id="l3.1513">           var bodyelement = GetBodyElement();</span>
<a href="#l3.1514"></a><span id="l3.1514" class="difflineminus">-          if (bodyelement)</span>
<a href="#l3.1515"></a><span id="l3.1515" class="difflineminus">-          {</span>
<a href="#l3.1516"></a><span id="l3.1516" class="difflineplus">+          if (bodyelement) {</span>
<a href="#l3.1517"></a><span id="l3.1517">             var defColors = GetDefaultBrowserColors();</span>
<a href="#l3.1518"></a><span id="l3.1518" class="difflineminus">-            if (defColors)</span>
<a href="#l3.1519"></a><span id="l3.1519" class="difflineminus">-            {</span>
<a href="#l3.1520"></a><span id="l3.1520" class="difflineplus">+            if (defColors) {</span>
<a href="#l3.1521"></a><span id="l3.1521">               if (!bodyelement.getAttribute(&quot;text&quot;))</span>
<a href="#l3.1522"></a><span id="l3.1522">                 editor.setAttributeOrEquivalent(bodyelement, &quot;text&quot;, defColors.TextColor, false);</span>
<a href="#l3.1523"></a><span id="l3.1523"> </span>
<a href="#l3.1524"></a><span id="l3.1524">               // The following attributes have no individual CSS declaration counterparts</span>
<a href="#l3.1525"></a><span id="l3.1525">               // Getting rid of them in favor of CSS implies CSS rules management</span>
<a href="#l3.1526"></a><span id="l3.1526">               if (!bodyelement.getAttribute(&quot;link&quot;))</span>
<a href="#l3.1527"></a><span id="l3.1527">                 editor.setAttribute(bodyelement, &quot;link&quot;, defColors.LinkColor);</span>
<a href="#l3.1528"></a><span id="l3.1528"> </span>
<a href="#l3.1529"></a><span id="l3.1529">               if (!bodyelement.getAttribute(&quot;alink&quot;))</span>
<a href="#l3.1530"></a><span id="l3.1530">                 editor.setAttribute(bodyelement, &quot;alink&quot;, defColors.ActiveLinkColor);</span>
<a href="#l3.1531"></a><span id="l3.1531"> </span>
<a href="#l3.1532"></a><span id="l3.1532">               if (!bodyelement.getAttribute(&quot;vlink&quot;))</span>
<a href="#l3.1533"></a><span id="l3.1533">                 editor.setAttribute(bodyelement, &quot;vlink&quot;, defColors.VisitedLinkColor);</span>
<a href="#l3.1534"></a><span id="l3.1534">             }</span>
<a href="#l3.1535"></a><span id="l3.1535">           }</span>
<a href="#l3.1536"></a><span id="l3.1536">         }</span>
<a href="#l3.1537"></a><span id="l3.1537" class="difflineminus">-      }</span>
<a href="#l3.1538"></a><span id="l3.1538" class="difflineminus">-      catch(e) {}</span>
<a href="#l3.1539"></a><span id="l3.1539" class="difflineplus">+      } catch (e) {}</span>
<a href="#l3.1540"></a><span id="l3.1540"> </span>
<a href="#l3.1541"></a><span id="l3.1541">       editor.endTransaction();</span>
<a href="#l3.1542"></a><span id="l3.1542">     }</span>
<a href="#l3.1543"></a><span id="l3.1543"> </span>
<a href="#l3.1544"></a><span id="l3.1544">     goUpdateCommandState(&quot;cmd_backgroundColor&quot;);</span>
<a href="#l3.1545"></a><span id="l3.1545">   }</span>
<a href="#l3.1546"></a><span id="l3.1546">   gContentWindow.focus();</span>
<a href="#l3.1547"></a><span id="l3.1547"> }</span>
<a href="#l3.1548"></a><span id="l3.1548"> </span>
<a href="#l3.1549"></a><span id="l3.1549" class="difflineminus">-function GetParentTable(element)</span>
<a href="#l3.1550"></a><span id="l3.1550" class="difflineminus">-{</span>
<a href="#l3.1551"></a><span id="l3.1551" class="difflineplus">+function GetParentTable(element) {</span>
<a href="#l3.1552"></a><span id="l3.1552">   var node = element;</span>
<a href="#l3.1553"></a><span id="l3.1553" class="difflineminus">-  while (node)</span>
<a href="#l3.1554"></a><span id="l3.1554" class="difflineminus">-  {</span>
<a href="#l3.1555"></a><span id="l3.1555" class="difflineplus">+  while (node) {</span>
<a href="#l3.1556"></a><span id="l3.1556">     if (node.nodeName.toLowerCase() == &quot;table&quot;)</span>
<a href="#l3.1557"></a><span id="l3.1557">       return node;</span>
<a href="#l3.1558"></a><span id="l3.1558"> </span>
<a href="#l3.1559"></a><span id="l3.1559">     node = node.parentNode;</span>
<a href="#l3.1560"></a><span id="l3.1560">   }</span>
<a href="#l3.1561"></a><span id="l3.1561">   return node;</span>
<a href="#l3.1562"></a><span id="l3.1562"> }</span>
<a href="#l3.1563"></a><span id="l3.1563"> </span>
<a href="#l3.1564"></a><span id="l3.1564" class="difflineminus">-function GetParentTableCell(element)</span>
<a href="#l3.1565"></a><span id="l3.1565" class="difflineminus">-{</span>
<a href="#l3.1566"></a><span id="l3.1566" class="difflineplus">+function GetParentTableCell(element) {</span>
<a href="#l3.1567"></a><span id="l3.1567">   var node = element;</span>
<a href="#l3.1568"></a><span id="l3.1568" class="difflineminus">-  while (node)</span>
<a href="#l3.1569"></a><span id="l3.1569" class="difflineminus">-  {</span>
<a href="#l3.1570"></a><span id="l3.1570" class="difflineplus">+  while (node) {</span>
<a href="#l3.1571"></a><span id="l3.1571">     if (node.nodeName.toLowerCase() == &quot;td&quot; || node.nodeName.toLowerCase() == &quot;th&quot;)</span>
<a href="#l3.1572"></a><span id="l3.1572">       return node;</span>
<a href="#l3.1573"></a><span id="l3.1573"> </span>
<a href="#l3.1574"></a><span id="l3.1574">     node = node.parentNode;</span>
<a href="#l3.1575"></a><span id="l3.1575">   }</span>
<a href="#l3.1576"></a><span id="l3.1576">   return node;</span>
<a href="#l3.1577"></a><span id="l3.1577"> }</span>
<a href="#l3.1578"></a><span id="l3.1578"> </span>
<a href="#l3.1579"></a><span id="l3.1579" class="difflineminus">-function EditorDblClick(event)</span>
<a href="#l3.1580"></a><span id="l3.1580" class="difflineminus">-{</span>
<a href="#l3.1581"></a><span id="l3.1581" class="difflineplus">+function EditorDblClick(event) {</span>
<a href="#l3.1582"></a><span id="l3.1582">   // We check event.explicitOriginalTarget here because .target will never</span>
<a href="#l3.1583"></a><span id="l3.1583">   // be a textnode (bug 193689)</span>
<a href="#l3.1584"></a><span id="l3.1584" class="difflineminus">-  if (event.explicitOriginalTarget)</span>
<a href="#l3.1585"></a><span id="l3.1585" class="difflineminus">-  {</span>
<a href="#l3.1586"></a><span id="l3.1586" class="difflineplus">+  if (event.explicitOriginalTarget) {</span>
<a href="#l3.1587"></a><span id="l3.1587">     // Only bring up properties if clicked on an element or selected link</span>
<a href="#l3.1588"></a><span id="l3.1588">     var element;</span>
<a href="#l3.1589"></a><span id="l3.1589">     try {</span>
<a href="#l3.1590"></a><span id="l3.1590">       element = event.explicitOriginalTarget;</span>
<a href="#l3.1591"></a><span id="l3.1591">     } catch (e) {}</span>
<a href="#l3.1592"></a><span id="l3.1592"> </span>
<a href="#l3.1593"></a><span id="l3.1593">      //  We use &quot;href&quot; instead of &quot;a&quot; to not be fooled by named anchor</span>
<a href="#l3.1594"></a><span id="l3.1594">     if (!element)</span>
<a href="#l3.1595"></a><span id="l3.1595">       try {</span>
<a href="#l3.1596"></a><span id="l3.1596">         element = GetCurrentEditor().getSelectedElement(&quot;href&quot;);</span>
<a href="#l3.1597"></a><span id="l3.1597">       } catch (e) {}</span>
<a href="#l3.1598"></a><span id="l3.1598"> </span>
<a href="#l3.1599"></a><span id="l3.1599">     // Don't fire for body/p and other block elements.</span>
<a href="#l3.1600"></a><span id="l3.1600">     // It's common that people try to double-click</span>
<a href="#l3.1601"></a><span id="l3.1601">     // to select a word, but the click hits an empty area.</span>
<a href="#l3.1602"></a><span id="l3.1602">     if (element &amp;&amp;</span>
<a href="#l3.1603"></a><span id="l3.1603" class="difflineminus">-        ![&quot;body&quot;,&quot;p&quot;,&quot;h1&quot;,&quot;h2&quot;,&quot;h3&quot;,&quot;h4&quot;,&quot;h5&quot;,&quot;h6&quot;,&quot;blockquote&quot;,&quot;div&quot;,&quot;pre&quot;]</span>
<a href="#l3.1604"></a><span id="l3.1604" class="difflineminus">-         .includes(element.nodeName.toLowerCase()))</span>
<a href="#l3.1605"></a><span id="l3.1605" class="difflineminus">-    {</span>
<a href="#l3.1606"></a><span id="l3.1606" class="difflineplus">+        ![&quot;body&quot;, &quot;p&quot;, &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, &quot;h6&quot;, &quot;blockquote&quot;, &quot;div&quot;, &quot;pre&quot;]</span>
<a href="#l3.1607"></a><span id="l3.1607" class="difflineplus">+         .includes(element.nodeName.toLowerCase())) {</span>
<a href="#l3.1608"></a><span id="l3.1608">       goDoCommand(&quot;cmd_objectProperties&quot;);</span>
<a href="#l3.1609"></a><span id="l3.1609">       event.preventDefault();</span>
<a href="#l3.1610"></a><span id="l3.1610">     }</span>
<a href="#l3.1611"></a><span id="l3.1611">   }</span>
<a href="#l3.1612"></a><span id="l3.1612"> }</span>
<a href="#l3.1613"></a><span id="l3.1613"> </span>
<a href="#l3.1614"></a><span id="l3.1614" class="difflineminus">-function EditorClick(event)</span>
<a href="#l3.1615"></a><span id="l3.1615" class="difflineminus">-{</span>
<a href="#l3.1616"></a><span id="l3.1616" class="difflineplus">+function EditorClick(event) {</span>
<a href="#l3.1617"></a><span id="l3.1617">   // For Web Composer: In Show All Tags Mode,</span>
<a href="#l3.1618"></a><span id="l3.1618">   // single click selects entire element,</span>
<a href="#l3.1619"></a><span id="l3.1619">   //  except for body and table elements</span>
<a href="#l3.1620"></a><span id="l3.1620" class="difflineminus">-  if (gEditorDisplayMode == kDisplayModeAllTags)</span>
<a href="#l3.1621"></a><span id="l3.1621" class="difflineminus">-  {</span>
<a href="#l3.1622"></a><span id="l3.1622" class="difflineminus">-    try</span>
<a href="#l3.1623"></a><span id="l3.1623" class="difflineminus">-    {</span>
<a href="#l3.1624"></a><span id="l3.1624" class="difflineplus">+  if (gEditorDisplayMode == kDisplayModeAllTags) {</span>
<a href="#l3.1625"></a><span id="l3.1625" class="difflineplus">+    try {</span>
<a href="#l3.1626"></a><span id="l3.1626">       // We check event.explicitOriginalTarget here because .target will never</span>
<a href="#l3.1627"></a><span id="l3.1627">       // be a textnode (bug 193689)</span>
<a href="#l3.1628"></a><span id="l3.1628">       var element = event.explicitOriginalTarget;</span>
<a href="#l3.1629"></a><span id="l3.1629">       var name = element.localName;</span>
<a href="#l3.1630"></a><span id="l3.1630" class="difflineminus">-      if (![&quot;body&quot;, &quot;caption&quot;, &quot;table&quot;, &quot;td&quot;, &quot;th&quot;, &quot;tr&quot;].includes(name))</span>
<a href="#l3.1631"></a><span id="l3.1631" class="difflineminus">-      {</span>
<a href="#l3.1632"></a><span id="l3.1632" class="difflineplus">+      if (![&quot;body&quot;, &quot;caption&quot;, &quot;table&quot;, &quot;td&quot;, &quot;th&quot;, &quot;tr&quot;].includes(name)) {</span>
<a href="#l3.1633"></a><span id="l3.1633">         GetCurrentEditor().selectElement(event.explicitOriginalTarget);</span>
<a href="#l3.1634"></a><span id="l3.1634">         event.preventDefault();</span>
<a href="#l3.1635"></a><span id="l3.1635">       }</span>
<a href="#l3.1636"></a><span id="l3.1636">     } catch (e) {}</span>
<a href="#l3.1637"></a><span id="l3.1637">   }</span>
<a href="#l3.1638"></a><span id="l3.1638"> }</span>
<a href="#l3.1639"></a><span id="l3.1639"> </span>
<a href="#l3.1640"></a><span id="l3.1640" class="difflineminus">-/*TODO: We need an oncreate hook to do enabling/disabling for the</span>
<a href="#l3.1641"></a><span id="l3.1641" class="difflineplus">+/* TODO: We need an oncreate hook to do enabling/disabling for the</span>
<a href="#l3.1642"></a><span id="l3.1642">         Format menu. There should be code like this for the</span>
<a href="#l3.1643"></a><span id="l3.1643">         object-specific &quot;Properties&quot; item</span>
<a href="#l3.1644"></a><span id="l3.1644"> */</span>
<a href="#l3.1645"></a><span id="l3.1645"> // For property dialogs, we want the selected element,</span>
<a href="#l3.1646"></a><span id="l3.1646"> //  but will accept a parent link, list, or table cell if inside one</span>
<a href="#l3.1647"></a><span id="l3.1647" class="difflineminus">-function GetObjectForProperties()</span>
<a href="#l3.1648"></a><span id="l3.1648" class="difflineminus">-{</span>
<a href="#l3.1649"></a><span id="l3.1649" class="difflineplus">+function GetObjectForProperties() {</span>
<a href="#l3.1650"></a><span id="l3.1650">   var editor = GetCurrentEditor();</span>
<a href="#l3.1651"></a><span id="l3.1651">   if (!editor || !IsHTMLEditor())</span>
<a href="#l3.1652"></a><span id="l3.1652">     return null;</span>
<a href="#l3.1653"></a><span id="l3.1653"> </span>
<a href="#l3.1654"></a><span id="l3.1654">   var element;</span>
<a href="#l3.1655"></a><span id="l3.1655">   try {</span>
<a href="#l3.1656"></a><span id="l3.1656">     element = editor.getSelectedElement(&quot;&quot;);</span>
<a href="#l3.1657"></a><span id="l3.1657">   } catch (e) {}</span>
<a href="#l3.1658"></a><span id="l3.1658" class="difflineat">@@ -1661,114 +1493,103 @@ function GetObjectForProperties()</span>
<a href="#l3.1659"></a><span id="l3.1659">       GetCurrentEditor().selection.collapse(element, 0);</span>
<a href="#l3.1660"></a><span id="l3.1660">     } else</span>
<a href="#l3.1661"></a><span id="l3.1661">       return element;</span>
<a href="#l3.1662"></a><span id="l3.1662">   }</span>
<a href="#l3.1663"></a><span id="l3.1663"> </span>
<a href="#l3.1664"></a><span id="l3.1664">   // Find nearest parent of selection anchor node</span>
<a href="#l3.1665"></a><span id="l3.1665">   //   that is a link, list, table cell, or table</span>
<a href="#l3.1666"></a><span id="l3.1666"> </span>
<a href="#l3.1667"></a><span id="l3.1667" class="difflineminus">-  var anchorNode</span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineplus">+  var anchorNode;</span>
<a href="#l3.1669"></a><span id="l3.1669">   var node;</span>
<a href="#l3.1670"></a><span id="l3.1670">   try {</span>
<a href="#l3.1671"></a><span id="l3.1671">     anchorNode = editor.selection.anchorNode;</span>
<a href="#l3.1672"></a><span id="l3.1672" class="difflineminus">-    if (anchorNode.firstChild)</span>
<a href="#l3.1673"></a><span id="l3.1673" class="difflineminus">-    {</span>
<a href="#l3.1674"></a><span id="l3.1674" class="difflineplus">+    if (anchorNode.firstChild) {</span>
<a href="#l3.1675"></a><span id="l3.1675">       // Start at actual selected node</span>
<a href="#l3.1676"></a><span id="l3.1676">       var offset = editor.selection.anchorOffset;</span>
<a href="#l3.1677"></a><span id="l3.1677">       // Note: If collapsed, offset points to element AFTER caret,</span>
<a href="#l3.1678"></a><span id="l3.1678">       //  thus node may be null</span>
<a href="#l3.1679"></a><span id="l3.1679">       node = anchorNode.childNodes.item(offset);</span>
<a href="#l3.1680"></a><span id="l3.1680">     }</span>
<a href="#l3.1681"></a><span id="l3.1681">     if (!node)</span>
<a href="#l3.1682"></a><span id="l3.1682">       node = anchorNode;</span>
<a href="#l3.1683"></a><span id="l3.1683">   } catch (e) {}</span>
<a href="#l3.1684"></a><span id="l3.1684"> </span>
<a href="#l3.1685"></a><span id="l3.1685" class="difflineminus">-  while (node)</span>
<a href="#l3.1686"></a><span id="l3.1686" class="difflineminus">-  {</span>
<a href="#l3.1687"></a><span id="l3.1687" class="difflineminus">-    if (node.nodeName)</span>
<a href="#l3.1688"></a><span id="l3.1688" class="difflineminus">-    {</span>
<a href="#l3.1689"></a><span id="l3.1689" class="difflineplus">+  while (node) {</span>
<a href="#l3.1690"></a><span id="l3.1690" class="difflineplus">+    if (node.nodeName) {</span>
<a href="#l3.1691"></a><span id="l3.1691">       var nodeName = node.nodeName.toLowerCase();</span>
<a href="#l3.1692"></a><span id="l3.1692"> </span>
<a href="#l3.1693"></a><span id="l3.1693">       // Done when we hit the body</span>
<a href="#l3.1694"></a><span id="l3.1694">       if (nodeName == &quot;body&quot;) break;</span>
<a href="#l3.1695"></a><span id="l3.1695"> </span>
<a href="#l3.1696"></a><span id="l3.1696">       if ((nodeName == &quot;a&quot; &amp;&amp; node.href) ||</span>
<a href="#l3.1697"></a><span id="l3.1697">           nodeName == &quot;ol&quot; || nodeName == &quot;ul&quot; || nodeName == &quot;dl&quot; ||</span>
<a href="#l3.1698"></a><span id="l3.1698">           nodeName == &quot;td&quot; || nodeName == &quot;th&quot; ||</span>
<a href="#l3.1699"></a><span id="l3.1699" class="difflineminus">-          nodeName == &quot;table&quot; || nodeName == &quot;math&quot;)</span>
<a href="#l3.1700"></a><span id="l3.1700" class="difflineminus">-      {</span>
<a href="#l3.1701"></a><span id="l3.1701" class="difflineplus">+          nodeName == &quot;table&quot; || nodeName == &quot;math&quot;) {</span>
<a href="#l3.1702"></a><span id="l3.1702">         return node;</span>
<a href="#l3.1703"></a><span id="l3.1703">       }</span>
<a href="#l3.1704"></a><span id="l3.1704">     }</span>
<a href="#l3.1705"></a><span id="l3.1705">     node = node.parentNode;</span>
<a href="#l3.1706"></a><span id="l3.1706">   }</span>
<a href="#l3.1707"></a><span id="l3.1707">   return null;</span>
<a href="#l3.1708"></a><span id="l3.1708"> }</span>
<a href="#l3.1709"></a><span id="l3.1709"> </span>
<a href="#l3.1710"></a><span id="l3.1710" class="difflineminus">-function SetEditMode(mode)</span>
<a href="#l3.1711"></a><span id="l3.1711" class="difflineminus">-{</span>
<a href="#l3.1712"></a><span id="l3.1712" class="difflineplus">+function SetEditMode(mode) {</span>
<a href="#l3.1713"></a><span id="l3.1713">   if (!IsHTMLEditor())</span>
<a href="#l3.1714"></a><span id="l3.1714">     return;</span>
<a href="#l3.1715"></a><span id="l3.1715"> </span>
<a href="#l3.1716"></a><span id="l3.1716">   var bodyElement = GetBodyElement();</span>
<a href="#l3.1717"></a><span id="l3.1717" class="difflineminus">-  if (!bodyElement)</span>
<a href="#l3.1718"></a><span id="l3.1718" class="difflineminus">-  {</span>
<a href="#l3.1719"></a><span id="l3.1719" class="difflineplus">+  if (!bodyElement) {</span>
<a href="#l3.1720"></a><span id="l3.1720">     dump(&quot;SetEditMode: We don't have a body node!\n&quot;);</span>
<a href="#l3.1721"></a><span id="l3.1721">     return;</span>
<a href="#l3.1722"></a><span id="l3.1722">   }</span>
<a href="#l3.1723"></a><span id="l3.1723"> </span>
<a href="#l3.1724"></a><span id="l3.1724">   // must have editor if here!</span>
<a href="#l3.1725"></a><span id="l3.1725">   var editor = GetCurrentEditor();</span>
<a href="#l3.1726"></a><span id="l3.1726" class="difflineminus">-  var inlineSpellCheckItem = document.getElementById('menu_inlineSpellCheck');</span>
<a href="#l3.1727"></a><span id="l3.1727" class="difflineplus">+  var inlineSpellCheckItem = document.getElementById(&quot;menu_inlineSpellCheck&quot;);</span>
<a href="#l3.1728"></a><span id="l3.1728"> </span>
<a href="#l3.1729"></a><span id="l3.1729">   // Switch the UI mode before inserting contents</span>
<a href="#l3.1730"></a><span id="l3.1730">   //   so user can't type in source window while new window is being filled</span>
<a href="#l3.1731"></a><span id="l3.1731">   var previousMode = gEditorDisplayMode;</span>
<a href="#l3.1732"></a><span id="l3.1732">   if (!SetDisplayMode(mode))</span>
<a href="#l3.1733"></a><span id="l3.1733">     return;</span>
<a href="#l3.1734"></a><span id="l3.1734"> </span>
<a href="#l3.1735"></a><span id="l3.1735" class="difflineminus">-  if (mode == kDisplayModeSource)</span>
<a href="#l3.1736"></a><span id="l3.1736" class="difflineminus">-  {</span>
<a href="#l3.1737"></a><span id="l3.1737" class="difflineplus">+  if (mode == kDisplayModeSource) {</span>
<a href="#l3.1738"></a><span id="l3.1738">     // Display the DOCTYPE as a non-editable string above edit area</span>
<a href="#l3.1739"></a><span id="l3.1739">     var domdoc;</span>
<a href="#l3.1740"></a><span id="l3.1740" class="difflineminus">-    try { domdoc = editor.document; } catch (e) { dump( e + &quot;\n&quot;);}</span>
<a href="#l3.1741"></a><span id="l3.1741" class="difflineminus">-    if (domdoc)</span>
<a href="#l3.1742"></a><span id="l3.1742" class="difflineminus">-    {</span>
<a href="#l3.1743"></a><span id="l3.1743" class="difflineplus">+    try { domdoc = editor.document; } catch (e) { dump(e + &quot;\n&quot;); }</span>
<a href="#l3.1744"></a><span id="l3.1744" class="difflineplus">+    if (domdoc) {</span>
<a href="#l3.1745"></a><span id="l3.1745">       var doctypeNode = document.getElementById(&quot;doctype-text&quot;);</span>
<a href="#l3.1746"></a><span id="l3.1746">       var dt = domdoc.doctype;</span>
<a href="#l3.1747"></a><span id="l3.1747" class="difflineminus">-      if (doctypeNode)</span>
<a href="#l3.1748"></a><span id="l3.1748" class="difflineminus">-      {</span>
<a href="#l3.1749"></a><span id="l3.1749" class="difflineminus">-        if (dt)</span>
<a href="#l3.1750"></a><span id="l3.1750" class="difflineminus">-        {</span>
<a href="#l3.1751"></a><span id="l3.1751" class="difflineplus">+      if (doctypeNode) {</span>
<a href="#l3.1752"></a><span id="l3.1752" class="difflineplus">+        if (dt) {</span>
<a href="#l3.1753"></a><span id="l3.1753">           doctypeNode.collapsed = false;</span>
<a href="#l3.1754"></a><span id="l3.1754">           var doctypeText = &quot;&lt;!DOCTYPE &quot; + domdoc.doctype.name;</span>
<a href="#l3.1755"></a><span id="l3.1755">           if (dt.publicId)</span>
<a href="#l3.1756"></a><span id="l3.1756">             doctypeText += &quot; PUBLIC \&quot;&quot; + domdoc.doctype.publicId;</span>
<a href="#l3.1757"></a><span id="l3.1757">           if (dt.systemId)</span>
<a href="#l3.1758"></a><span id="l3.1758">             doctypeText += &quot; \&quot;&quot; + dt.systemId;</span>
<a href="#l3.1759"></a><span id="l3.1759" class="difflineminus">-          doctypeText += &quot;\&quot;&gt;&quot;</span>
<a href="#l3.1760"></a><span id="l3.1760" class="difflineplus">+          doctypeText += &quot;\&quot;&gt;&quot;;</span>
<a href="#l3.1761"></a><span id="l3.1761">           doctypeNode.setAttribute(&quot;value&quot;, doctypeText);</span>
<a href="#l3.1762"></a><span id="l3.1762" class="difflineminus">-        }</span>
<a href="#l3.1763"></a><span id="l3.1763" class="difflineminus">-        else</span>
<a href="#l3.1764"></a><span id="l3.1764" class="difflineplus">+        } else</span>
<a href="#l3.1765"></a><span id="l3.1765">           doctypeNode.collapsed = true;</span>
<a href="#l3.1766"></a><span id="l3.1766">       }</span>
<a href="#l3.1767"></a><span id="l3.1767">     }</span>
<a href="#l3.1768"></a><span id="l3.1768">     // Get the entire document's source string</span>
<a href="#l3.1769"></a><span id="l3.1769"> </span>
<a href="#l3.1770"></a><span id="l3.1770">     var flags = (editor.documentCharacterSet == &quot;ISO-8859-1&quot;)</span>
<a href="#l3.1771"></a><span id="l3.1771">       ? kOutputEncodeLatin1Entities</span>
<a href="#l3.1772"></a><span id="l3.1772">       : kOutputEncodeBasicEntities;</span>
<a href="#l3.1773"></a><span id="l3.1773">     try {</span>
<a href="#l3.1774"></a><span id="l3.1774">       let encodeEntity = Services.prefs.getCharPref(&quot;editor.encode_entity&quot;);</span>
<a href="#l3.1775"></a><span id="l3.1775">       switch (encodeEntity) {</span>
<a href="#l3.1776"></a><span id="l3.1776" class="difflineminus">-        case &quot;basic&quot;  : flags = kOutputEncodeBasicEntities; break;</span>
<a href="#l3.1777"></a><span id="l3.1777" class="difflineplus">+        case &quot;basic&quot; : flags = kOutputEncodeBasicEntities; break;</span>
<a href="#l3.1778"></a><span id="l3.1778">         case &quot;latin1&quot; : flags = kOutputEncodeLatin1Entities; break;</span>
<a href="#l3.1779"></a><span id="l3.1779" class="difflineminus">-        case &quot;html&quot;   : flags = kOutputEncodeHTMLEntities; break;</span>
<a href="#l3.1780"></a><span id="l3.1780" class="difflineminus">-        case &quot;none&quot;   : flags = 0;     break;</span>
<a href="#l3.1781"></a><span id="l3.1781" class="difflineplus">+        case &quot;html&quot; : flags = kOutputEncodeHTMLEntities; break;</span>
<a href="#l3.1782"></a><span id="l3.1782" class="difflineplus">+        case &quot;none&quot; : flags = 0; break;</span>
<a href="#l3.1783"></a><span id="l3.1783">       }</span>
<a href="#l3.1784"></a><span id="l3.1784">     } catch (e) { }</span>
<a href="#l3.1785"></a><span id="l3.1785"> </span>
<a href="#l3.1786"></a><span id="l3.1786">     if (Services.prefs.getBoolPref(&quot;editor.prettyprint&quot;))</span>
<a href="#l3.1787"></a><span id="l3.1787">       flags |= kOutputFormatted;</span>
<a href="#l3.1788"></a><span id="l3.1788"> </span>
<a href="#l3.1789"></a><span id="l3.1789">     flags |= kOutputLFLineBreak;</span>
<a href="#l3.1790"></a><span id="l3.1790">     var source = editor.outputToString(editor.contentsMIMEType, flags);</span>
<a href="#l3.1791"></a><span id="l3.1791" class="difflineat">@@ -1776,25 +1597,22 @@ function SetEditMode(mode)</span>
<a href="#l3.1792"></a><span id="l3.1792">     if (start == -1) start = 0;</span>
<a href="#l3.1793"></a><span id="l3.1793">     gSourceTextEditor.insertText(source.slice(start));</span>
<a href="#l3.1794"></a><span id="l3.1794">     gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.1795"></a><span id="l3.1795">     gSourceTextEditor.addDocumentStateListener(gSourceTextListener);</span>
<a href="#l3.1796"></a><span id="l3.1796">     gSourceTextEditor.enableUndo(true);</span>
<a href="#l3.1797"></a><span id="l3.1797">     gSourceContentWindow.commandManager.addCommandObserver(gSourceTextObserver, &quot;cmd_undo&quot;);</span>
<a href="#l3.1798"></a><span id="l3.1798">     gSourceContentWindow.contentWindow.focus();</span>
<a href="#l3.1799"></a><span id="l3.1799">     goDoCommand(&quot;cmd_moveTop&quot;);</span>
<a href="#l3.1800"></a><span id="l3.1800" class="difflineminus">-  }</span>
<a href="#l3.1801"></a><span id="l3.1801" class="difflineminus">-  else if (previousMode == kDisplayModeSource)</span>
<a href="#l3.1802"></a><span id="l3.1802" class="difflineminus">-  {</span>
<a href="#l3.1803"></a><span id="l3.1803" class="difflineplus">+  } else if (previousMode == kDisplayModeSource) {</span>
<a href="#l3.1804"></a><span id="l3.1804">     // Only rebuild document if a change was made in source window</span>
<a href="#l3.1805"></a><span id="l3.1805" class="difflineminus">-    if (IsHTMLSourceChanged())</span>
<a href="#l3.1806"></a><span id="l3.1806" class="difflineminus">-    {</span>
<a href="#l3.1807"></a><span id="l3.1807" class="difflineplus">+    if (IsHTMLSourceChanged()) {</span>
<a href="#l3.1808"></a><span id="l3.1808">       // Disable spell checking when rebuilding source</span>
<a href="#l3.1809"></a><span id="l3.1809">       InlineSpellCheckerUI.enabled = false;</span>
<a href="#l3.1810"></a><span id="l3.1810" class="difflineminus">-      inlineSpellCheckItem.removeAttribute('checked');</span>
<a href="#l3.1811"></a><span id="l3.1811" class="difflineplus">+      inlineSpellCheckItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.1812"></a><span id="l3.1812"> </span>
<a href="#l3.1813"></a><span id="l3.1813">       // Reduce the undo count so we don't use too much memory</span>
<a href="#l3.1814"></a><span id="l3.1814">       //   during multiple uses of source window</span>
<a href="#l3.1815"></a><span id="l3.1815">       //   (reinserting entire doc caches all nodes)</span>
<a href="#l3.1816"></a><span id="l3.1816">       try {</span>
<a href="#l3.1817"></a><span id="l3.1817">         editor.transactionManager.maxTransactionCount = 1;</span>
<a href="#l3.1818"></a><span id="l3.1818">       } catch (e) {}</span>
<a href="#l3.1819"></a><span id="l3.1819"> </span>
<a href="#l3.1820"></a><span id="l3.1820" class="difflineat">@@ -1812,17 +1630,16 @@ function SetEditMode(mode)</span>
<a href="#l3.1821"></a><span id="l3.1821">           editor.document.replaceChild(fragment.firstChild, editor.document.documentElement);</span>
<a href="#l3.1822"></a><span id="l3.1822">           editor.enableUndo(true);</span>
<a href="#l3.1823"></a><span id="l3.1823">         }</span>
<a href="#l3.1824"></a><span id="l3.1824"> </span>
<a href="#l3.1825"></a><span id="l3.1825">         // Get the text for the &lt;title&gt; from the newly-parsed document</span>
<a href="#l3.1826"></a><span id="l3.1826">         // (must do this for proper conversion of &quot;escaped&quot; characters)</span>
<a href="#l3.1827"></a><span id="l3.1827">         let titleNode = editor.document.querySelector(&quot;title&quot;);</span>
<a href="#l3.1828"></a><span id="l3.1828">         SetDocumentTitle(titleNode ? titleNode.textContent : &quot;&quot;);</span>
<a href="#l3.1829"></a><span id="l3.1829" class="difflineminus">-</span>
<a href="#l3.1830"></a><span id="l3.1830">       } catch (ex) {</span>
<a href="#l3.1831"></a><span id="l3.1831">         dump(ex);</span>
<a href="#l3.1832"></a><span id="l3.1832">       }</span>
<a href="#l3.1833"></a><span id="l3.1833">       editor.endTransaction();</span>
<a href="#l3.1834"></a><span id="l3.1834"> </span>
<a href="#l3.1835"></a><span id="l3.1835">       // Restore unlimited undo count</span>
<a href="#l3.1836"></a><span id="l3.1836">       try {</span>
<a href="#l3.1837"></a><span id="l3.1837">         editor.transactionManager.maxTransactionCount = -1;</span>
<a href="#l3.1838"></a><span id="l3.1838" class="difflineat">@@ -1834,80 +1651,74 @@ function SetEditMode(mode)</span>
<a href="#l3.1839"></a><span id="l3.1839">     gSourceTextEditor.removeDocumentStateListener(gSourceTextListener);</span>
<a href="#l3.1840"></a><span id="l3.1840">     gSourceTextEditor.enableUndo(false);</span>
<a href="#l3.1841"></a><span id="l3.1841">     gSourceTextEditor.selectAll();</span>
<a href="#l3.1842"></a><span id="l3.1842">     gSourceTextEditor.deleteSelection(gSourceTextEditor.eNone,</span>
<a href="#l3.1843"></a><span id="l3.1843">                                       gSourceTextEditor.eStrip);</span>
<a href="#l3.1844"></a><span id="l3.1844">     gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.1845"></a><span id="l3.1845"> </span>
<a href="#l3.1846"></a><span id="l3.1846">     gContentWindow.focus();</span>
<a href="#l3.1847"></a><span id="l3.1847" class="difflineminus">-    //goDoCommand(&quot;cmd_moveTop&quot;);</span>
<a href="#l3.1848"></a><span id="l3.1848" class="difflineplus">+    // goDoCommand(&quot;cmd_moveTop&quot;);</span>
<a href="#l3.1849"></a><span id="l3.1849">   }</span>
<a href="#l3.1850"></a><span id="l3.1850"> </span>
<a href="#l3.1851"></a><span id="l3.1851">   switch (mode) {</span>
<a href="#l3.1852"></a><span id="l3.1852">     case kDisplayModePreview:</span>
<a href="#l3.1853"></a><span id="l3.1853">       // Disable spell checking when previewing</span>
<a href="#l3.1854"></a><span id="l3.1854">       InlineSpellCheckerUI.enabled = false;</span>
<a href="#l3.1855"></a><span id="l3.1855" class="difflineminus">-      inlineSpellCheckItem.removeAttribute('checked');</span>
<a href="#l3.1856"></a><span id="l3.1856" class="difflineplus">+      inlineSpellCheckItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.1857"></a><span id="l3.1857">       // fall through</span>
<a href="#l3.1858"></a><span id="l3.1858">     case kDisplayModeSource:</span>
<a href="#l3.1859"></a><span id="l3.1859" class="difflineminus">-      inlineSpellCheckItem.setAttribute('disabled', 'true');</span>
<a href="#l3.1860"></a><span id="l3.1860" class="difflineplus">+      inlineSpellCheckItem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.1861"></a><span id="l3.1861">       break;</span>
<a href="#l3.1862"></a><span id="l3.1862">     default:</span>
<a href="#l3.1863"></a><span id="l3.1863" class="difflineminus">-      inlineSpellCheckItem.setAttribute('disabled', !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l3.1864"></a><span id="l3.1864" class="difflineplus">+      inlineSpellCheckItem.setAttribute(&quot;disabled&quot;, !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l3.1865"></a><span id="l3.1865">       break;</span>
<a href="#l3.1866"></a><span id="l3.1866">   }</span>
<a href="#l3.1867"></a><span id="l3.1867"> }</span>
<a href="#l3.1868"></a><span id="l3.1868"> </span>
<a href="#l3.1869"></a><span id="l3.1869" class="difflineminus">-function CancelHTMLSource()</span>
<a href="#l3.1870"></a><span id="l3.1870" class="difflineminus">-{</span>
<a href="#l3.1871"></a><span id="l3.1871" class="difflineplus">+function CancelHTMLSource() {</span>
<a href="#l3.1872"></a><span id="l3.1872">   // Don't convert source text back into the DOM document</span>
<a href="#l3.1873"></a><span id="l3.1873">   gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.1874"></a><span id="l3.1874">   SetDisplayMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l3.1875"></a><span id="l3.1875"> }</span>
<a href="#l3.1876"></a><span id="l3.1876"> </span>
<a href="#l3.1877"></a><span id="l3.1877" class="difflineminus">-function SetDisplayMode(mode)</span>
<a href="#l3.1878"></a><span id="l3.1878" class="difflineminus">-{</span>
<a href="#l3.1879"></a><span id="l3.1879" class="difflineplus">+function SetDisplayMode(mode) {</span>
<a href="#l3.1880"></a><span id="l3.1880">   if (!IsHTMLEditor())</span>
<a href="#l3.1881"></a><span id="l3.1881">     return false;</span>
<a href="#l3.1882"></a><span id="l3.1882"> </span>
<a href="#l3.1883"></a><span id="l3.1883">   // Already in requested mode:</span>
<a href="#l3.1884"></a><span id="l3.1884">   //  return false to indicate we didn't switch</span>
<a href="#l3.1885"></a><span id="l3.1885">   if (mode == gEditorDisplayMode)</span>
<a href="#l3.1886"></a><span id="l3.1886">     return false;</span>
<a href="#l3.1887"></a><span id="l3.1887"> </span>
<a href="#l3.1888"></a><span id="l3.1888">   var previousMode = gEditorDisplayMode;</span>
<a href="#l3.1889"></a><span id="l3.1889">   gEditorDisplayMode = mode;</span>
<a href="#l3.1890"></a><span id="l3.1890"> </span>
<a href="#l3.1891"></a><span id="l3.1891">   ResetStructToolbar();</span>
<a href="#l3.1892"></a><span id="l3.1892" class="difflineminus">-  if (mode == kDisplayModeSource)</span>
<a href="#l3.1893"></a><span id="l3.1893" class="difflineminus">-  {</span>
<a href="#l3.1894"></a><span id="l3.1894" class="difflineplus">+  if (mode == kDisplayModeSource) {</span>
<a href="#l3.1895"></a><span id="l3.1895">     // Switch to the sourceWindow (second in the deck)</span>
<a href="#l3.1896"></a><span id="l3.1896">     gContentWindowDeck.selectedIndex = 1;</span>
<a href="#l3.1897"></a><span id="l3.1897"> </span>
<a href="#l3.1898"></a><span id="l3.1898" class="difflineminus">-    //Hide the formatting toolbar if not already hidden</span>
<a href="#l3.1899"></a><span id="l3.1899" class="difflineplus">+    // Hide the formatting toolbar if not already hidden</span>
<a href="#l3.1900"></a><span id="l3.1900">     gFormatToolbarHidden = gFormatToolbar.hidden;</span>
<a href="#l3.1901"></a><span id="l3.1901">     gFormatToolbar.hidden = true;</span>
<a href="#l3.1902"></a><span id="l3.1902">     gViewFormatToolbar.hidden = true;</span>
<a href="#l3.1903"></a><span id="l3.1903"> </span>
<a href="#l3.1904"></a><span id="l3.1904">     gSourceContentWindow.contentWindow.focus();</span>
<a href="#l3.1905"></a><span id="l3.1905" class="difflineminus">-  }</span>
<a href="#l3.1906"></a><span id="l3.1906" class="difflineminus">-  else</span>
<a href="#l3.1907"></a><span id="l3.1907" class="difflineminus">-  {</span>
<a href="#l3.1908"></a><span id="l3.1908" class="difflineplus">+  } else {</span>
<a href="#l3.1909"></a><span id="l3.1909">     // Save the last non-source mode so we can cancel source editing easily</span>
<a href="#l3.1910"></a><span id="l3.1910">     gPreviousNonSourceDisplayMode = mode;</span>
<a href="#l3.1911"></a><span id="l3.1911"> </span>
<a href="#l3.1912"></a><span id="l3.1912">     // Load/unload appropriate override style sheet</span>
<a href="#l3.1913"></a><span id="l3.1913">     try {</span>
<a href="#l3.1914"></a><span id="l3.1914">       var editor = GetCurrentEditor();</span>
<a href="#l3.1915"></a><span id="l3.1915">       editor.QueryInterface(nsIEditorStyleSheets);</span>
<a href="#l3.1916"></a><span id="l3.1916">       editor instanceof Ci.nsIHTMLObjectResizer;</span>
<a href="#l3.1917"></a><span id="l3.1917"> </span>
<a href="#l3.1918"></a><span id="l3.1918" class="difflineminus">-      switch (mode)</span>
<a href="#l3.1919"></a><span id="l3.1919" class="difflineminus">-      {</span>
<a href="#l3.1920"></a><span id="l3.1920" class="difflineplus">+      switch (mode) {</span>
<a href="#l3.1921"></a><span id="l3.1921">         case kDisplayModePreview:</span>
<a href="#l3.1922"></a><span id="l3.1922">           // Disable all extra &quot;edit mode&quot; style sheets</span>
<a href="#l3.1923"></a><span id="l3.1923">           editor.enableStyleSheet(kNormalStyleSheet, false);</span>
<a href="#l3.1924"></a><span id="l3.1924">           editor.enableStyleSheet(kAllTagsStyleSheet, false);</span>
<a href="#l3.1925"></a><span id="l3.1925">           editor.objectResizingEnabled = true;</span>
<a href="#l3.1926"></a><span id="l3.1926">           break;</span>
<a href="#l3.1927"></a><span id="l3.1927"> </span>
<a href="#l3.1928"></a><span id="l3.1928">         case kDisplayModeNormal:</span>
<a href="#l3.1929"></a><span id="l3.1929" class="difflineat">@@ -1923,17 +1734,17 @@ function SetDisplayMode(mode)</span>
<a href="#l3.1930"></a><span id="l3.1930">           // don't allow resizing in AllTags mode because the visible tags</span>
<a href="#l3.1931"></a><span id="l3.1931">           // change the computed size of images and tables...</span>
<a href="#l3.1932"></a><span id="l3.1932">           if (editor.resizedObject) {</span>
<a href="#l3.1933"></a><span id="l3.1933">             editor.hideResizers();</span>
<a href="#l3.1934"></a><span id="l3.1934">           }</span>
<a href="#l3.1935"></a><span id="l3.1935">           editor.objectResizingEnabled = false;</span>
<a href="#l3.1936"></a><span id="l3.1936">           break;</span>
<a href="#l3.1937"></a><span id="l3.1937">       }</span>
<a href="#l3.1938"></a><span id="l3.1938" class="difflineminus">-    } catch(e) {}</span>
<a href="#l3.1939"></a><span id="l3.1939" class="difflineplus">+    } catch (e) {}</span>
<a href="#l3.1940"></a><span id="l3.1940"> </span>
<a href="#l3.1941"></a><span id="l3.1941">     // Switch to the normal editor (first in the deck)</span>
<a href="#l3.1942"></a><span id="l3.1942">     gContentWindowDeck.selectedIndex = 0;</span>
<a href="#l3.1943"></a><span id="l3.1943"> </span>
<a href="#l3.1944"></a><span id="l3.1944">     // Restore menus and toolbars</span>
<a href="#l3.1945"></a><span id="l3.1945">     gFormatToolbar.hidden = gFormatToolbarHidden;</span>
<a href="#l3.1946"></a><span id="l3.1946">     gViewFormatToolbar.hidden = false;</span>
<a href="#l3.1947"></a><span id="l3.1947"> </span>
<a href="#l3.1948"></a><span id="l3.1948" class="difflineat">@@ -1944,34 +1755,32 @@ function SetDisplayMode(mode)</span>
<a href="#l3.1949"></a><span id="l3.1949">   window.updateCommands(&quot;mode_switch&quot;);</span>
<a href="#l3.1950"></a><span id="l3.1950"> </span>
<a href="#l3.1951"></a><span id="l3.1951">   // Set the selected tab at bottom of window:</span>
<a href="#l3.1952"></a><span id="l3.1952">   // (Note: Setting &quot;selectedIndex = mode&quot; won't redraw tabs when menu is used.)</span>
<a href="#l3.1953"></a><span id="l3.1953">   document.getElementById(&quot;EditModeTabs&quot;).selectedItem = document.getElementById(kDisplayModeTabIDS[mode]);</span>
<a href="#l3.1954"></a><span id="l3.1954"> </span>
<a href="#l3.1955"></a><span id="l3.1955">   // Uncheck previous menuitem and set new check since toolbar may have been used</span>
<a href="#l3.1956"></a><span id="l3.1956">   if (previousMode &gt;= 0)</span>
<a href="#l3.1957"></a><span id="l3.1957" class="difflineminus">-    document.getElementById(kDisplayModeMenuIDs[previousMode]).setAttribute(&quot;checked&quot;,&quot;false&quot;);</span>
<a href="#l3.1958"></a><span id="l3.1958" class="difflineminus">-  document.getElementById(kDisplayModeMenuIDs[mode]).setAttribute(&quot;checked&quot;,&quot;true&quot;);</span>
<a href="#l3.1959"></a><span id="l3.1959" class="difflineplus">+    document.getElementById(kDisplayModeMenuIDs[previousMode]).setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l3.1960"></a><span id="l3.1960" class="difflineplus">+  document.getElementById(kDisplayModeMenuIDs[mode]).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.1961"></a><span id="l3.1961"> </span>
<a href="#l3.1962"></a><span id="l3.1962"> </span>
<a href="#l3.1963"></a><span id="l3.1963">   return true;</span>
<a href="#l3.1964"></a><span id="l3.1964"> }</span>
<a href="#l3.1965"></a><span id="l3.1965"> </span>
<a href="#l3.1966"></a><span id="l3.1966" class="difflineminus">-function UpdateWindowTitle()</span>
<a href="#l3.1967"></a><span id="l3.1967" class="difflineminus">-{</span>
<a href="#l3.1968"></a><span id="l3.1968" class="difflineplus">+function UpdateWindowTitle() {</span>
<a href="#l3.1969"></a><span id="l3.1969">   try {</span>
<a href="#l3.1970"></a><span id="l3.1970">     var filename = &quot;&quot;;</span>
<a href="#l3.1971"></a><span id="l3.1971">     var windowTitle = &quot;&quot;;</span>
<a href="#l3.1972"></a><span id="l3.1972">     var title = GetDocumentTitle();</span>
<a href="#l3.1973"></a><span id="l3.1973"> </span>
<a href="#l3.1974"></a><span id="l3.1974">     // Append just the 'leaf' filename to the Doc. Title for the window caption</span>
<a href="#l3.1975"></a><span id="l3.1975">     var docUrl = GetDocumentUrl();</span>
<a href="#l3.1976"></a><span id="l3.1976" class="difflineminus">-    if (docUrl &amp;&amp; !IsUrlAboutBlank(docUrl))</span>
<a href="#l3.1977"></a><span id="l3.1977" class="difflineminus">-    {</span>
<a href="#l3.1978"></a><span id="l3.1978" class="difflineplus">+    if (docUrl &amp;&amp; !IsUrlAboutBlank(docUrl)) {</span>
<a href="#l3.1979"></a><span id="l3.1979">       var scheme = GetScheme(docUrl);</span>
<a href="#l3.1980"></a><span id="l3.1980">       filename = GetFilename(docUrl);</span>
<a href="#l3.1981"></a><span id="l3.1981">       if (filename)</span>
<a href="#l3.1982"></a><span id="l3.1982">         windowTitle = &quot; [&quot; + scheme + &quot;:/.../&quot; + filename + &quot;]&quot;;</span>
<a href="#l3.1983"></a><span id="l3.1983"> </span>
<a href="#l3.1984"></a><span id="l3.1984">       var fileType = IsHTMLEditor() ? &quot;html&quot; : &quot;text&quot;;</span>
<a href="#l3.1985"></a><span id="l3.1985">       // Save changed title in the recent pages data in prefs</span>
<a href="#l3.1986"></a><span id="l3.1986">       SaveRecentFilesPrefs(title, fileType);</span>
<a href="#l3.1987"></a><span id="l3.1987" class="difflineat">@@ -1982,102 +1791,91 @@ function UpdateWindowTitle()</span>
<a href="#l3.1988"></a><span id="l3.1988"> </span>
<a href="#l3.1989"></a><span id="l3.1989">     document.title = (title || filename || gUntitledString) +</span>
<a href="#l3.1990"></a><span id="l3.1990">                      windowTitle +</span>
<a href="#l3.1991"></a><span id="l3.1991">                      xulWin.getAttribute(&quot;titlemenuseparator&quot;) +</span>
<a href="#l3.1992"></a><span id="l3.1992">                      xulWin.getAttribute(&quot;titlemodifier&quot;);</span>
<a href="#l3.1993"></a><span id="l3.1993">   } catch (e) { dump(e); }</span>
<a href="#l3.1994"></a><span id="l3.1994"> }</span>
<a href="#l3.1995"></a><span id="l3.1995"> </span>
<a href="#l3.1996"></a><span id="l3.1996" class="difflineminus">-function SaveRecentFilesPrefs(aTitle, aFileType)</span>
<a href="#l3.1997"></a><span id="l3.1997" class="difflineminus">-{</span>
<a href="#l3.1998"></a><span id="l3.1998" class="difflineplus">+function SaveRecentFilesPrefs(aTitle, aFileType) {</span>
<a href="#l3.1999"></a><span id="l3.1999">   var curUrl = StripPassword(GetDocumentUrl());</span>
<a href="#l3.2000"></a><span id="l3.2000">   var historyCount = Services.prefs.getIntPref(&quot;editor.history.url_maximum&quot;);</span>
<a href="#l3.2001"></a><span id="l3.2001"> </span>
<a href="#l3.2002"></a><span id="l3.2002">   var titleArray = [];</span>
<a href="#l3.2003"></a><span id="l3.2003">   var urlArray = [];</span>
<a href="#l3.2004"></a><span id="l3.2004">   var typeArray = [];</span>
<a href="#l3.2005"></a><span id="l3.2005"> </span>
<a href="#l3.2006"></a><span id="l3.2006" class="difflineminus">-  if (historyCount &amp;&amp; !IsUrlAboutBlank(curUrl) &amp;&amp;  GetScheme(curUrl) != &quot;data&quot;)</span>
<a href="#l3.2007"></a><span id="l3.2007" class="difflineminus">-  {</span>
<a href="#l3.2008"></a><span id="l3.2008" class="difflineplus">+  if (historyCount &amp;&amp; !IsUrlAboutBlank(curUrl) &amp;&amp; GetScheme(curUrl) != &quot;data&quot;) {</span>
<a href="#l3.2009"></a><span id="l3.2009">     titleArray.push(aTitle);</span>
<a href="#l3.2010"></a><span id="l3.2010">     urlArray.push(curUrl);</span>
<a href="#l3.2011"></a><span id="l3.2011">     typeArray.push(aFileType);</span>
<a href="#l3.2012"></a><span id="l3.2012">   }</span>
<a href="#l3.2013"></a><span id="l3.2013"> </span>
<a href="#l3.2014"></a><span id="l3.2014" class="difflineminus">-  for (let i = 0; i &lt; historyCount &amp;&amp; urlArray.length &lt; historyCount; i++)</span>
<a href="#l3.2015"></a><span id="l3.2015" class="difflineminus">-  {</span>
<a href="#l3.2016"></a><span id="l3.2016" class="difflineplus">+  for (let i = 0; i &lt; historyCount &amp;&amp; urlArray.length &lt; historyCount; i++) {</span>
<a href="#l3.2017"></a><span id="l3.2017">     let url = Services.prefs.getStringPref(&quot;editor.history_url_&quot; + i, &quot;&quot;);</span>
<a href="#l3.2018"></a><span id="l3.2018"> </span>
<a href="#l3.2019"></a><span id="l3.2019">     // Continue if URL pref is missing because</span>
<a href="#l3.2020"></a><span id="l3.2020">     //  a URL not found during loading may have been removed</span>
<a href="#l3.2021"></a><span id="l3.2021"> </span>
<a href="#l3.2022"></a><span id="l3.2022">     // Skip over current an &quot;data&quot; URLs</span>
<a href="#l3.2023"></a><span id="l3.2023" class="difflineminus">-    if (url &amp;&amp; url != curUrl &amp;&amp; GetScheme(url) != &quot;data&quot;)</span>
<a href="#l3.2024"></a><span id="l3.2024" class="difflineminus">-    {</span>
<a href="#l3.2025"></a><span id="l3.2025" class="difflineplus">+    if (url &amp;&amp; url != curUrl &amp;&amp; GetScheme(url) != &quot;data&quot;) {</span>
<a href="#l3.2026"></a><span id="l3.2026">       let title = Services.prefs.getStringPref(&quot;editor.history_title_&quot; + i, &quot;&quot;);</span>
<a href="#l3.2027"></a><span id="l3.2027">       let fileType = Services.prefs.getStringPref(&quot;editor.history_type_&quot; + i, &quot;&quot;);</span>
<a href="#l3.2028"></a><span id="l3.2028">       titleArray.push(title);</span>
<a href="#l3.2029"></a><span id="l3.2029">       urlArray.push(url);</span>
<a href="#l3.2030"></a><span id="l3.2030">       typeArray.push(fileType);</span>
<a href="#l3.2031"></a><span id="l3.2031">     }</span>
<a href="#l3.2032"></a><span id="l3.2032">   }</span>
<a href="#l3.2033"></a><span id="l3.2033"> </span>
<a href="#l3.2034"></a><span id="l3.2034">   // Resave the list back to prefs in the new order</span>
<a href="#l3.2035"></a><span id="l3.2035" class="difflineminus">-  for (let i = 0; i &lt; urlArray.length; i++)</span>
<a href="#l3.2036"></a><span id="l3.2036" class="difflineminus">-  {</span>
<a href="#l3.2037"></a><span id="l3.2037" class="difflineplus">+  for (let i = 0; i &lt; urlArray.length; i++) {</span>
<a href="#l3.2038"></a><span id="l3.2038">     SetStringPref(&quot;editor.history_title_&quot; + i, titleArray[i]);</span>
<a href="#l3.2039"></a><span id="l3.2039">     SetStringPref(&quot;editor.history_url_&quot; + i, urlArray[i]);</span>
<a href="#l3.2040"></a><span id="l3.2040">     SetStringPref(&quot;editor.history_type_&quot; + i, typeArray[i]);</span>
<a href="#l3.2041"></a><span id="l3.2041">   }</span>
<a href="#l3.2042"></a><span id="l3.2042"> }</span>
<a href="#l3.2043"></a><span id="l3.2043"> </span>
<a href="#l3.2044"></a><span id="l3.2044" class="difflineminus">-function EditorInitFormatMenu()</span>
<a href="#l3.2045"></a><span id="l3.2045" class="difflineminus">-{</span>
<a href="#l3.2046"></a><span id="l3.2046" class="difflineplus">+function EditorInitFormatMenu() {</span>
<a href="#l3.2047"></a><span id="l3.2047">   try {</span>
<a href="#l3.2048"></a><span id="l3.2048">     InitObjectPropertiesMenuitem();</span>
<a href="#l3.2049"></a><span id="l3.2049">     InitRemoveStylesMenuitems(&quot;removeStylesMenuitem&quot;, &quot;removeLinksMenuitem&quot;, &quot;removeNamedAnchorsMenuitem&quot;);</span>
<a href="#l3.2050"></a><span id="l3.2050" class="difflineminus">-  } catch(ex) {}</span>
<a href="#l3.2051"></a><span id="l3.2051" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l3.2052"></a><span id="l3.2052"> }</span>
<a href="#l3.2053"></a><span id="l3.2053"> </span>
<a href="#l3.2054"></a><span id="l3.2054" class="difflineminus">-function InitObjectPropertiesMenuitem()</span>
<a href="#l3.2055"></a><span id="l3.2055" class="difflineminus">-{</span>
<a href="#l3.2056"></a><span id="l3.2056" class="difflineplus">+function InitObjectPropertiesMenuitem() {</span>
<a href="#l3.2057"></a><span id="l3.2057">   // Set strings and enable for the [Object] Properties item</span>
<a href="#l3.2058"></a><span id="l3.2058">   // Note that we directly do the enabling instead of</span>
<a href="#l3.2059"></a><span id="l3.2059">   // using goSetCommandEnabled since we already have the command.</span>
<a href="#l3.2060"></a><span id="l3.2060">   var cmd = document.getElementById(&quot;cmd_objectProperties&quot;);</span>
<a href="#l3.2061"></a><span id="l3.2061">   if (!cmd)</span>
<a href="#l3.2062"></a><span id="l3.2062">     return null;</span>
<a href="#l3.2063"></a><span id="l3.2063"> </span>
<a href="#l3.2064"></a><span id="l3.2064">   var element;</span>
<a href="#l3.2065"></a><span id="l3.2065">   var menuStr = GetString(&quot;AdvancedProperties&quot;);</span>
<a href="#l3.2066"></a><span id="l3.2066">   var name;</span>
<a href="#l3.2067"></a><span id="l3.2067"> </span>
<a href="#l3.2068"></a><span id="l3.2068">   if (IsEditingRenderedHTML())</span>
<a href="#l3.2069"></a><span id="l3.2069">     element = GetObjectForProperties();</span>
<a href="#l3.2070"></a><span id="l3.2070"> </span>
<a href="#l3.2071"></a><span id="l3.2071" class="difflineminus">-  if (element &amp;&amp; element.nodeName)</span>
<a href="#l3.2072"></a><span id="l3.2072" class="difflineminus">-  {</span>
<a href="#l3.2073"></a><span id="l3.2073" class="difflineplus">+  if (element &amp;&amp; element.nodeName) {</span>
<a href="#l3.2074"></a><span id="l3.2074">     var objStr = &quot;&quot;;</span>
<a href="#l3.2075"></a><span id="l3.2075">     cmd.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.2076"></a><span id="l3.2076">     name = element.nodeName.toLowerCase();</span>
<a href="#l3.2077"></a><span id="l3.2077" class="difflineminus">-    switch (name)</span>
<a href="#l3.2078"></a><span id="l3.2078" class="difflineminus">-    {</span>
<a href="#l3.2079"></a><span id="l3.2079" class="difflineplus">+    switch (name) {</span>
<a href="#l3.2080"></a><span id="l3.2080">       case &quot;img&quot;:</span>
<a href="#l3.2081"></a><span id="l3.2081">         // Check if img is enclosed in link</span>
<a href="#l3.2082"></a><span id="l3.2082">         //  (use &quot;href&quot; to not be fooled by named anchor)</span>
<a href="#l3.2083"></a><span id="l3.2083" class="difflineminus">-        try</span>
<a href="#l3.2084"></a><span id="l3.2084" class="difflineminus">-        {</span>
<a href="#l3.2085"></a><span id="l3.2085" class="difflineminus">-          if (GetCurrentEditor().getElementOrParentByTagName(&quot;href&quot;, element))</span>
<a href="#l3.2086"></a><span id="l3.2086" class="difflineminus">-          {</span>
<a href="#l3.2087"></a><span id="l3.2087" class="difflineplus">+        try {</span>
<a href="#l3.2088"></a><span id="l3.2088" class="difflineplus">+          if (GetCurrentEditor().getElementOrParentByTagName(&quot;href&quot;, element)) {</span>
<a href="#l3.2089"></a><span id="l3.2089">             objStr = GetString(&quot;ImageAndLink&quot;);</span>
<a href="#l3.2090"></a><span id="l3.2090">             // Return &quot;href&quot; so it is detected as a link.</span>
<a href="#l3.2091"></a><span id="l3.2091">             name = &quot;href&quot;;</span>
<a href="#l3.2092"></a><span id="l3.2092">           }</span>
<a href="#l3.2093"></a><span id="l3.2093" class="difflineminus">-        } catch(e) {}</span>
<a href="#l3.2094"></a><span id="l3.2094" class="difflineplus">+        } catch (e) {}</span>
<a href="#l3.2095"></a><span id="l3.2095"> </span>
<a href="#l3.2096"></a><span id="l3.2096">         if (objStr == &quot;&quot;)</span>
<a href="#l3.2097"></a><span id="l3.2097">           objStr = GetString(&quot;Image&quot;);</span>
<a href="#l3.2098"></a><span id="l3.2098">         break;</span>
<a href="#l3.2099"></a><span id="l3.2099">       case &quot;hr&quot;:</span>
<a href="#l3.2100"></a><span id="l3.2100">         objStr = GetString(&quot;HLine&quot;);</span>
<a href="#l3.2101"></a><span id="l3.2101">         break;</span>
<a href="#l3.2102"></a><span id="l3.2102">       case &quot;table&quot;:</span>
<a href="#l3.2103"></a><span id="l3.2103" class="difflineat">@@ -2117,89 +1915,80 @@ function InitObjectPropertiesMenuitem()</span>
<a href="#l3.2104"></a><span id="l3.2104">         break;</span>
<a href="#l3.2105"></a><span id="l3.2105">       case &quot;label&quot;:</span>
<a href="#l3.2106"></a><span id="l3.2106">         objStr = GetString(&quot;Label&quot;);</span>
<a href="#l3.2107"></a><span id="l3.2107">         break;</span>
<a href="#l3.2108"></a><span id="l3.2108">       case &quot;fieldset&quot;:</span>
<a href="#l3.2109"></a><span id="l3.2109">         objStr = GetString(&quot;FieldSet&quot;);</span>
<a href="#l3.2110"></a><span id="l3.2110">         break;</span>
<a href="#l3.2111"></a><span id="l3.2111">       case &quot;a&quot;:</span>
<a href="#l3.2112"></a><span id="l3.2112" class="difflineminus">-        if (element.name)</span>
<a href="#l3.2113"></a><span id="l3.2113" class="difflineminus">-        {</span>
<a href="#l3.2114"></a><span id="l3.2114" class="difflineplus">+        if (element.name) {</span>
<a href="#l3.2115"></a><span id="l3.2115">           objStr = GetString(&quot;NamedAnchor&quot;);</span>
<a href="#l3.2116"></a><span id="l3.2116">           name = &quot;anchor&quot;;</span>
<a href="#l3.2117"></a><span id="l3.2117" class="difflineminus">-        }</span>
<a href="#l3.2118"></a><span id="l3.2118" class="difflineminus">-        else if(element.href)</span>
<a href="#l3.2119"></a><span id="l3.2119" class="difflineminus">-        {</span>
<a href="#l3.2120"></a><span id="l3.2120" class="difflineplus">+        } else if (element.href) {</span>
<a href="#l3.2121"></a><span id="l3.2121">           objStr = GetString(&quot;Link&quot;);</span>
<a href="#l3.2122"></a><span id="l3.2122">           name = &quot;href&quot;;</span>
<a href="#l3.2123"></a><span id="l3.2123">         }</span>
<a href="#l3.2124"></a><span id="l3.2124">         break;</span>
<a href="#l3.2125"></a><span id="l3.2125">     }</span>
<a href="#l3.2126"></a><span id="l3.2126">     if (objStr)</span>
<a href="#l3.2127"></a><span id="l3.2127" class="difflineminus">-      menuStr = GetString(&quot;ObjectProperties&quot;).replace(/%obj%/,objStr);</span>
<a href="#l3.2128"></a><span id="l3.2128" class="difflineminus">-  }</span>
<a href="#l3.2129"></a><span id="l3.2129" class="difflineminus">-  else</span>
<a href="#l3.2130"></a><span id="l3.2130" class="difflineminus">-  {</span>
<a href="#l3.2131"></a><span id="l3.2131" class="difflineplus">+      menuStr = GetString(&quot;ObjectProperties&quot;).replace(/%obj%/, objStr);</span>
<a href="#l3.2132"></a><span id="l3.2132" class="difflineplus">+  } else {</span>
<a href="#l3.2133"></a><span id="l3.2133">     // We show generic &quot;Properties&quot; string, but disable the command.</span>
<a href="#l3.2134"></a><span id="l3.2134">     cmd.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.2135"></a><span id="l3.2135">   }</span>
<a href="#l3.2136"></a><span id="l3.2136">   cmd.setAttribute(&quot;label&quot;, menuStr);</span>
<a href="#l3.2137"></a><span id="l3.2137">   cmd.setAttribute(&quot;accesskey&quot;, GetString(&quot;ObjectPropertiesAccessKey&quot;));</span>
<a href="#l3.2138"></a><span id="l3.2138">   return name;</span>
<a href="#l3.2139"></a><span id="l3.2139"> }</span>
<a href="#l3.2140"></a><span id="l3.2140"> </span>
<a href="#l3.2141"></a><span id="l3.2141" class="difflineminus">-function InitParagraphMenu()</span>
<a href="#l3.2142"></a><span id="l3.2142" class="difflineminus">-{</span>
<a href="#l3.2143"></a><span id="l3.2143" class="difflineplus">+function InitParagraphMenu() {</span>
<a href="#l3.2144"></a><span id="l3.2144">   var mixedObj = { value: null };</span>
<a href="#l3.2145"></a><span id="l3.2145">   var state;</span>
<a href="#l3.2146"></a><span id="l3.2146">   try {</span>
<a href="#l3.2147"></a><span id="l3.2147">     state = GetCurrentEditor().getParagraphState(mixedObj);</span>
<a href="#l3.2148"></a><span id="l3.2148" class="difflineminus">-  }</span>
<a href="#l3.2149"></a><span id="l3.2149" class="difflineminus">-  catch(e) {}</span>
<a href="#l3.2150"></a><span id="l3.2150" class="difflineplus">+  } catch (e) {}</span>
<a href="#l3.2151"></a><span id="l3.2151">   var IDSuffix;</span>
<a href="#l3.2152"></a><span id="l3.2152"> </span>
<a href="#l3.2153"></a><span id="l3.2153">   // PROBLEM: When we get blockquote, it masks other styles contained by it</span>
<a href="#l3.2154"></a><span id="l3.2154">   // We need a separate method to get blockquote state</span>
<a href="#l3.2155"></a><span id="l3.2155"> </span>
<a href="#l3.2156"></a><span id="l3.2156">   // We use &quot;x&quot; as uninitialized paragraph state</span>
<a href="#l3.2157"></a><span id="l3.2157">   if (!state || state == &quot;x&quot;)</span>
<a href="#l3.2158"></a><span id="l3.2158" class="difflineminus">-    IDSuffix = &quot;bodyText&quot; // No paragraph container</span>
<a href="#l3.2159"></a><span id="l3.2159" class="difflineplus">+    IDSuffix = &quot;bodyText&quot;; // No paragraph container</span>
<a href="#l3.2160"></a><span id="l3.2160">   else</span>
<a href="#l3.2161"></a><span id="l3.2161">     IDSuffix = state;</span>
<a href="#l3.2162"></a><span id="l3.2162"> </span>
<a href="#l3.2163"></a><span id="l3.2163">   // Set &quot;radio&quot; check on one item, but...</span>
<a href="#l3.2164"></a><span id="l3.2164" class="difflineminus">-  var menuItem = document.getElementById(&quot;menu_&quot;+IDSuffix);</span>
<a href="#l3.2165"></a><span id="l3.2165" class="difflineplus">+  var menuItem = document.getElementById(&quot;menu_&quot; + IDSuffix);</span>
<a href="#l3.2166"></a><span id="l3.2166">   menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.2167"></a><span id="l3.2167"> </span>
<a href="#l3.2168"></a><span id="l3.2168">   // ...&quot;bodyText&quot; is returned if mixed selection, so remove checkmark</span>
<a href="#l3.2169"></a><span id="l3.2169">   if (mixedObj.value)</span>
<a href="#l3.2170"></a><span id="l3.2170">     menuItem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l3.2171"></a><span id="l3.2171"> }</span>
<a href="#l3.2172"></a><span id="l3.2172"> </span>
<a href="#l3.2173"></a><span id="l3.2173" class="difflineminus">-function GetListStateString()</span>
<a href="#l3.2174"></a><span id="l3.2174" class="difflineminus">-{</span>
<a href="#l3.2175"></a><span id="l3.2175" class="difflineplus">+function GetListStateString() {</span>
<a href="#l3.2176"></a><span id="l3.2176">   try {</span>
<a href="#l3.2177"></a><span id="l3.2177">     var editor = GetCurrentEditor();</span>
<a href="#l3.2178"></a><span id="l3.2178"> </span>
<a href="#l3.2179"></a><span id="l3.2179">     var mixedObj = { value: null };</span>
<a href="#l3.2180"></a><span id="l3.2180">     var hasOL = { value: false };</span>
<a href="#l3.2181"></a><span id="l3.2181">     var hasUL = { value: false };</span>
<a href="#l3.2182"></a><span id="l3.2182">     var hasDL = { value: false };</span>
<a href="#l3.2183"></a><span id="l3.2183">     editor.getListState(mixedObj, hasOL, hasUL, hasDL);</span>
<a href="#l3.2184"></a><span id="l3.2184"> </span>
<a href="#l3.2185"></a><span id="l3.2185">     if (mixedObj.value)</span>
<a href="#l3.2186"></a><span id="l3.2186">       return &quot;mixed&quot;;</span>
<a href="#l3.2187"></a><span id="l3.2187">     if (hasOL.value)</span>
<a href="#l3.2188"></a><span id="l3.2188">       return &quot;ol&quot;;</span>
<a href="#l3.2189"></a><span id="l3.2189">     if (hasUL.value)</span>
<a href="#l3.2190"></a><span id="l3.2190">       return &quot;ul&quot;;</span>
<a href="#l3.2191"></a><span id="l3.2191"> </span>
<a href="#l3.2192"></a><span id="l3.2192" class="difflineminus">-    if (hasDL.value)</span>
<a href="#l3.2193"></a><span id="l3.2193" class="difflineminus">-    {</span>
<a href="#l3.2194"></a><span id="l3.2194" class="difflineplus">+    if (hasDL.value) {</span>
<a href="#l3.2195"></a><span id="l3.2195">       var hasLI = { value: false };</span>
<a href="#l3.2196"></a><span id="l3.2196">       var hasDT = { value: false };</span>
<a href="#l3.2197"></a><span id="l3.2197">       var hasDD = { value: false };</span>
<a href="#l3.2198"></a><span id="l3.2198">       editor.getListItemState(mixedObj, hasLI, hasDT, hasDD);</span>
<a href="#l3.2199"></a><span id="l3.2199">       if (mixedObj.value)</span>
<a href="#l3.2200"></a><span id="l3.2200">         return &quot;mixed&quot;;</span>
<a href="#l3.2201"></a><span id="l3.2201">       if (hasLI.value)</span>
<a href="#l3.2202"></a><span id="l3.2202">         return &quot;li&quot;;</span>
<a href="#l3.2203"></a><span id="l3.2203" class="difflineat">@@ -2209,35 +1998,33 @@ function GetListStateString()</span>
<a href="#l3.2204"></a><span id="l3.2204">         return &quot;dd&quot;;</span>
<a href="#l3.2205"></a><span id="l3.2205">     }</span>
<a href="#l3.2206"></a><span id="l3.2206">   } catch (e) {}</span>
<a href="#l3.2207"></a><span id="l3.2207"> </span>
<a href="#l3.2208"></a><span id="l3.2208">   // return &quot;noList&quot; if we aren't in a list at all</span>
<a href="#l3.2209"></a><span id="l3.2209">   return &quot;noList&quot;;</span>
<a href="#l3.2210"></a><span id="l3.2210"> }</span>
<a href="#l3.2211"></a><span id="l3.2211"> </span>
<a href="#l3.2212"></a><span id="l3.2212" class="difflineminus">-function InitListMenu()</span>
<a href="#l3.2213"></a><span id="l3.2213" class="difflineminus">-{</span>
<a href="#l3.2214"></a><span id="l3.2214" class="difflineplus">+function InitListMenu() {</span>
<a href="#l3.2215"></a><span id="l3.2215">   if (!IsHTMLEditor())</span>
<a href="#l3.2216"></a><span id="l3.2216">     return;</span>
<a href="#l3.2217"></a><span id="l3.2217"> </span>
<a href="#l3.2218"></a><span id="l3.2218">   var IDSuffix = GetListStateString();</span>
<a href="#l3.2219"></a><span id="l3.2219"> </span>
<a href="#l3.2220"></a><span id="l3.2220">   // Set enable state for the &quot;None&quot; menuitem</span>
<a href="#l3.2221"></a><span id="l3.2221">   goSetCommandEnabled(&quot;cmd_removeList&quot;, IDSuffix != &quot;noList&quot;);</span>
<a href="#l3.2222"></a><span id="l3.2222"> </span>
<a href="#l3.2223"></a><span id="l3.2223">   // Set &quot;radio&quot; check on one item, but...</span>
<a href="#l3.2224"></a><span id="l3.2224">   // we won't find a match if it's &quot;mixed&quot;</span>
<a href="#l3.2225"></a><span id="l3.2225" class="difflineminus">-  var menuItem = document.getElementById(&quot;menu_&quot;+IDSuffix);</span>
<a href="#l3.2226"></a><span id="l3.2226" class="difflineplus">+  var menuItem = document.getElementById(&quot;menu_&quot; + IDSuffix);</span>
<a href="#l3.2227"></a><span id="l3.2227">   if (menuItem)</span>
<a href="#l3.2228"></a><span id="l3.2228">     menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.2229"></a><span id="l3.2229"> }</span>
<a href="#l3.2230"></a><span id="l3.2230"> </span>
<a href="#l3.2231"></a><span id="l3.2231" class="difflineminus">-function GetAlignmentString()</span>
<a href="#l3.2232"></a><span id="l3.2232" class="difflineminus">-{</span>
<a href="#l3.2233"></a><span id="l3.2233" class="difflineplus">+function GetAlignmentString() {</span>
<a href="#l3.2234"></a><span id="l3.2234">   var mixedObj = { value: null };</span>
<a href="#l3.2235"></a><span id="l3.2235">   var alignObj = { value: null };</span>
<a href="#l3.2236"></a><span id="l3.2236">   try {</span>
<a href="#l3.2237"></a><span id="l3.2237">     GetCurrentEditor().getAlignment(mixedObj, alignObj);</span>
<a href="#l3.2238"></a><span id="l3.2238">   } catch (e) {}</span>
<a href="#l3.2239"></a><span id="l3.2239"> </span>
<a href="#l3.2240"></a><span id="l3.2240">   if (mixedObj.value)</span>
<a href="#l3.2241"></a><span id="l3.2241">     return &quot;mixed&quot;;</span>
<a href="#l3.2242"></a><span id="l3.2242" class="difflineat">@@ -2249,176 +2036,157 @@ function GetAlignmentString()</span>
<a href="#l3.2243"></a><span id="l3.2243">     return &quot;right&quot;;</span>
<a href="#l3.2244"></a><span id="l3.2244">   if (alignObj.value == nsIHTMLEditor.eJustify)</span>
<a href="#l3.2245"></a><span id="l3.2245">     return &quot;justify&quot;;</span>
<a href="#l3.2246"></a><span id="l3.2246"> </span>
<a href="#l3.2247"></a><span id="l3.2247">   // return &quot;left&quot; if we got here</span>
<a href="#l3.2248"></a><span id="l3.2248">   return &quot;left&quot;;</span>
<a href="#l3.2249"></a><span id="l3.2249"> }</span>
<a href="#l3.2250"></a><span id="l3.2250"> </span>
<a href="#l3.2251"></a><span id="l3.2251" class="difflineminus">-function InitAlignMenu()</span>
<a href="#l3.2252"></a><span id="l3.2252" class="difflineminus">-{</span>
<a href="#l3.2253"></a><span id="l3.2253" class="difflineplus">+function InitAlignMenu() {</span>
<a href="#l3.2254"></a><span id="l3.2254">   if (!IsHTMLEditor())</span>
<a href="#l3.2255"></a><span id="l3.2255">     return;</span>
<a href="#l3.2256"></a><span id="l3.2256"> </span>
<a href="#l3.2257"></a><span id="l3.2257">   var IDSuffix = GetAlignmentString();</span>
<a href="#l3.2258"></a><span id="l3.2258"> </span>
<a href="#l3.2259"></a><span id="l3.2259">   // we won't find a match if it's &quot;mixed&quot;</span>
<a href="#l3.2260"></a><span id="l3.2260" class="difflineminus">-  var menuItem = document.getElementById(&quot;menu_&quot;+IDSuffix);</span>
<a href="#l3.2261"></a><span id="l3.2261" class="difflineplus">+  var menuItem = document.getElementById(&quot;menu_&quot; + IDSuffix);</span>
<a href="#l3.2262"></a><span id="l3.2262">   if (menuItem)</span>
<a href="#l3.2263"></a><span id="l3.2263">     menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.2264"></a><span id="l3.2264"> }</span>
<a href="#l3.2265"></a><span id="l3.2265"> </span>
<a href="#l3.2266"></a><span id="l3.2266" class="difflineminus">-function EditorSetDefaultPrefsAndDoctype()</span>
<a href="#l3.2267"></a><span id="l3.2267" class="difflineminus">-{</span>
<a href="#l3.2268"></a><span id="l3.2268" class="difflineplus">+function EditorSetDefaultPrefsAndDoctype() {</span>
<a href="#l3.2269"></a><span id="l3.2269">   var editor = GetCurrentEditor();</span>
<a href="#l3.2270"></a><span id="l3.2270"> </span>
<a href="#l3.2271"></a><span id="l3.2271">   var domdoc;</span>
<a href="#l3.2272"></a><span id="l3.2272">   try {</span>
<a href="#l3.2273"></a><span id="l3.2273">     domdoc = editor.document;</span>
<a href="#l3.2274"></a><span id="l3.2274" class="difflineminus">-  } catch (e) { dump( e + &quot;\n&quot;); }</span>
<a href="#l3.2275"></a><span id="l3.2275" class="difflineminus">-  if ( !domdoc )</span>
<a href="#l3.2276"></a><span id="l3.2276" class="difflineminus">-  {</span>
<a href="#l3.2277"></a><span id="l3.2277" class="difflineplus">+  } catch (e) { dump(e + &quot;\n&quot;); }</span>
<a href="#l3.2278"></a><span id="l3.2278" class="difflineplus">+  if (!domdoc) {</span>
<a href="#l3.2279"></a><span id="l3.2279">     dump(&quot;EditorSetDefaultPrefsAndDoctype: EDITOR DOCUMENT NOT FOUND\n&quot;);</span>
<a href="#l3.2280"></a><span id="l3.2280">     return;</span>
<a href="#l3.2281"></a><span id="l3.2281">   }</span>
<a href="#l3.2282"></a><span id="l3.2282"> </span>
<a href="#l3.2283"></a><span id="l3.2283">   // Insert a doctype element</span>
<a href="#l3.2284"></a><span id="l3.2284">   // if it is missing from existing doc</span>
<a href="#l3.2285"></a><span id="l3.2285" class="difflineminus">-  if (!domdoc.doctype)</span>
<a href="#l3.2286"></a><span id="l3.2286" class="difflineminus">-  {</span>
<a href="#l3.2287"></a><span id="l3.2287" class="difflineminus">-    var newdoctype = domdoc.implementation.createDocumentType(&quot;HTML&quot;, &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;,&quot;&quot;);</span>
<a href="#l3.2288"></a><span id="l3.2288" class="difflineplus">+  if (!domdoc.doctype) {</span>
<a href="#l3.2289"></a><span id="l3.2289" class="difflineplus">+    var newdoctype = domdoc.implementation.createDocumentType(&quot;HTML&quot;, &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;, &quot;&quot;);</span>
<a href="#l3.2290"></a><span id="l3.2290">     if (newdoctype)</span>
<a href="#l3.2291"></a><span id="l3.2291">       domdoc.insertBefore(newdoctype, domdoc.firstChild);</span>
<a href="#l3.2292"></a><span id="l3.2292">   }</span>
<a href="#l3.2293"></a><span id="l3.2293"> </span>
<a href="#l3.2294"></a><span id="l3.2294">   // search for head; we'll need this for meta tag additions</span>
<a href="#l3.2295"></a><span id="l3.2295">   let headelement = domdoc.querySelector(&quot;head&quot;);</span>
<a href="#l3.2296"></a><span id="l3.2296" class="difflineminus">-  if (!headelement)</span>
<a href="#l3.2297"></a><span id="l3.2297" class="difflineminus">-  {</span>
<a href="#l3.2298"></a><span id="l3.2298" class="difflineplus">+  if (!headelement) {</span>
<a href="#l3.2299"></a><span id="l3.2299">     headelement = domdoc.createElement(&quot;head&quot;);</span>
<a href="#l3.2300"></a><span id="l3.2300">     if (headelement)</span>
<a href="#l3.2301"></a><span id="l3.2301">       domdoc.insertAfter(headelement, domdoc.firstChild);</span>
<a href="#l3.2302"></a><span id="l3.2302">   }</span>
<a href="#l3.2303"></a><span id="l3.2303"> </span>
<a href="#l3.2304"></a><span id="l3.2304">   /* only set default prefs for new documents */</span>
<a href="#l3.2305"></a><span id="l3.2305">   if (!IsUrlAboutBlank(GetDocumentUrl()))</span>
<a href="#l3.2306"></a><span id="l3.2306">     return;</span>
<a href="#l3.2307"></a><span id="l3.2307"> </span>
<a href="#l3.2308"></a><span id="l3.2308">   // search for author meta tag.</span>
<a href="#l3.2309"></a><span id="l3.2309">   // if one is found, don't do anything.</span>
<a href="#l3.2310"></a><span id="l3.2310">   // if not, create one and make it a child of the head tag</span>
<a href="#l3.2311"></a><span id="l3.2311">   //   and set its content attribute to the value of the editor.author preference.</span>
<a href="#l3.2312"></a><span id="l3.2312"> </span>
<a href="#l3.2313"></a><span id="l3.2313" class="difflineminus">-  if (domdoc.querySelector(&quot;meta&quot;))</span>
<a href="#l3.2314"></a><span id="l3.2314" class="difflineminus">-  {</span>
<a href="#l3.2315"></a><span id="l3.2315" class="difflineplus">+  if (domdoc.querySelector(&quot;meta&quot;)) {</span>
<a href="#l3.2316"></a><span id="l3.2316">     // we should do charset first since we need to have charset before</span>
<a href="#l3.2317"></a><span id="l3.2317">     // hitting other 8-bit char in other meta tags</span>
<a href="#l3.2318"></a><span id="l3.2318">     // grab charset pref and make it the default charset</span>
<a href="#l3.2319"></a><span id="l3.2319">     var element;</span>
<a href="#l3.2320"></a><span id="l3.2320">     var prefCharsetString = Services.prefs.getCharPref(&quot;intl.charset.fallback.override&quot;);</span>
<a href="#l3.2321"></a><span id="l3.2321">     if (prefCharsetString)</span>
<a href="#l3.2322"></a><span id="l3.2322">       editor.documentCharacterSet = prefCharsetString;</span>
<a href="#l3.2323"></a><span id="l3.2323"> </span>
<a href="#l3.2324"></a><span id="l3.2324">     // let's start by assuming we have an author in case we don't have the pref</span>
<a href="#l3.2325"></a><span id="l3.2325"> </span>
<a href="#l3.2326"></a><span id="l3.2326">     var prefAuthorString = null;</span>
<a href="#l3.2327"></a><span id="l3.2327">     let authorFound = domdoc.querySelector('meta[name=&quot;author&quot;]');</span>
<a href="#l3.2328"></a><span id="l3.2328" class="difflineminus">-    try</span>
<a href="#l3.2329"></a><span id="l3.2329" class="difflineminus">-    {</span>
<a href="#l3.2330"></a><span id="l3.2330" class="difflineplus">+    try {</span>
<a href="#l3.2331"></a><span id="l3.2331">       prefAuthorString = Services.prefs.getStringPref(&quot;editor.author&quot;);</span>
<a href="#l3.2332"></a><span id="l3.2332" class="difflineminus">-    }</span>
<a href="#l3.2333"></a><span id="l3.2333" class="difflineminus">-    catch (ex) {}</span>
<a href="#l3.2334"></a><span id="l3.2334" class="difflineminus">-    if (prefAuthorString &amp;&amp; prefAuthorString != 0 &amp;&amp; !authorFound &amp;&amp; headelement)</span>
<a href="#l3.2335"></a><span id="l3.2335" class="difflineminus">-    {</span>
<a href="#l3.2336"></a><span id="l3.2336" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l3.2337"></a><span id="l3.2337" class="difflineplus">+    if (prefAuthorString &amp;&amp; prefAuthorString != 0 &amp;&amp; !authorFound &amp;&amp; headelement) {</span>
<a href="#l3.2338"></a><span id="l3.2338">       // create meta tag with 2 attributes</span>
<a href="#l3.2339"></a><span id="l3.2339">       element = domdoc.createElement(&quot;meta&quot;);</span>
<a href="#l3.2340"></a><span id="l3.2340" class="difflineminus">-      if (element)</span>
<a href="#l3.2341"></a><span id="l3.2341" class="difflineminus">-      {</span>
<a href="#l3.2342"></a><span id="l3.2342" class="difflineplus">+      if (element) {</span>
<a href="#l3.2343"></a><span id="l3.2343">         element.setAttribute(&quot;name&quot;, &quot;author&quot;);</span>
<a href="#l3.2344"></a><span id="l3.2344">         element.setAttribute(&quot;content&quot;, prefAuthorString);</span>
<a href="#l3.2345"></a><span id="l3.2345">         headelement.appendChild(element);</span>
<a href="#l3.2346"></a><span id="l3.2346">       }</span>
<a href="#l3.2347"></a><span id="l3.2347">     }</span>
<a href="#l3.2348"></a><span id="l3.2348">   }</span>
<a href="#l3.2349"></a><span id="l3.2349"> </span>
<a href="#l3.2350"></a><span id="l3.2350">   // add title tag if not present</span>
<a href="#l3.2351"></a><span id="l3.2351" class="difflineminus">-  if (headelement &amp;&amp; !editor.document.querySelector(&quot;title&quot;))</span>
<a href="#l3.2352"></a><span id="l3.2352" class="difflineminus">-  {</span>
<a href="#l3.2353"></a><span id="l3.2353" class="difflineplus">+  if (headelement &amp;&amp; !editor.document.querySelector(&quot;title&quot;)) {</span>
<a href="#l3.2354"></a><span id="l3.2354">      var titleElement = domdoc.createElement(&quot;title&quot;);</span>
<a href="#l3.2355"></a><span id="l3.2355">      if (titleElement)</span>
<a href="#l3.2356"></a><span id="l3.2356">        headelement.appendChild(titleElement);</span>
<a href="#l3.2357"></a><span id="l3.2357">   }</span>
<a href="#l3.2358"></a><span id="l3.2358"> </span>
<a href="#l3.2359"></a><span id="l3.2359">   // find body node</span>
<a href="#l3.2360"></a><span id="l3.2360">   var bodyelement = GetBodyElement();</span>
<a href="#l3.2361"></a><span id="l3.2361" class="difflineminus">-  if (bodyelement)</span>
<a href="#l3.2362"></a><span id="l3.2362" class="difflineminus">-  {</span>
<a href="#l3.2363"></a><span id="l3.2363" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;editor.use_custom_colors&quot;))</span>
<a href="#l3.2364"></a><span id="l3.2364" class="difflineminus">-    {</span>
<a href="#l3.2365"></a><span id="l3.2365" class="difflineplus">+  if (bodyelement) {</span>
<a href="#l3.2366"></a><span id="l3.2366" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;editor.use_custom_colors&quot;)) {</span>
<a href="#l3.2367"></a><span id="l3.2367">       let text_color = Services.prefs.getCharPref(&quot;editor.text_color&quot;);</span>
<a href="#l3.2368"></a><span id="l3.2368">       let background_color = Services.prefs.getCharPref(&quot;editor.background_color&quot;);</span>
<a href="#l3.2369"></a><span id="l3.2369"> </span>
<a href="#l3.2370"></a><span id="l3.2370">       // add the color attributes to the body tag.</span>
<a href="#l3.2371"></a><span id="l3.2371">       // and use them for the default text and background colors if not empty</span>
<a href="#l3.2372"></a><span id="l3.2372">       editor.setAttributeOrEquivalent(bodyelement, &quot;text&quot;, text_color, true);</span>
<a href="#l3.2373"></a><span id="l3.2373">       gDefaultTextColor = text_color;</span>
<a href="#l3.2374"></a><span id="l3.2374">       editor.setAttributeOrEquivalent(bodyelement, &quot;bgcolor&quot;, background_color, true);</span>
<a href="#l3.2375"></a><span id="l3.2375" class="difflineminus">-      gDefaultBackgroundColor = background_color</span>
<a href="#l3.2376"></a><span id="l3.2376" class="difflineplus">+      gDefaultBackgroundColor = background_color;</span>
<a href="#l3.2377"></a><span id="l3.2377">       bodyelement.setAttribute(&quot;link&quot;, Services.prefs.getCharPref(&quot;editor.link_color&quot;));</span>
<a href="#l3.2378"></a><span id="l3.2378">       bodyelement.setAttribute(&quot;alink&quot;, Services.prefs.getCharPref(&quot;editor.active_link_color&quot;));</span>
<a href="#l3.2379"></a><span id="l3.2379">       bodyelement.setAttribute(&quot;vlink&quot;, Services.prefs.getCharPref(&quot;editor.followed_link_color&quot;));</span>
<a href="#l3.2380"></a><span id="l3.2380">     }</span>
<a href="#l3.2381"></a><span id="l3.2381">     // Default image is independent of Custom colors???</span>
<a href="#l3.2382"></a><span id="l3.2382">     try {</span>
<a href="#l3.2383"></a><span id="l3.2383">       let background_image = Services.prefs.getCharPref(&quot;editor.default_background_image&quot;);</span>
<a href="#l3.2384"></a><span id="l3.2384">       if (background_image)</span>
<a href="#l3.2385"></a><span id="l3.2385">         editor.setAttributeOrEquivalent(bodyelement, &quot;background&quot;, background_image, true);</span>
<a href="#l3.2386"></a><span id="l3.2386" class="difflineminus">-    } catch (e) {dump(&quot;BACKGROUND EXCEPTION: &quot;+e+&quot;\n&quot;); }</span>
<a href="#l3.2387"></a><span id="l3.2387" class="difflineminus">-</span>
<a href="#l3.2388"></a><span id="l3.2388" class="difflineplus">+    } catch (e) { dump(&quot;BACKGROUND EXCEPTION: &quot; + e + &quot;\n&quot;); }</span>
<a href="#l3.2389"></a><span id="l3.2389">   }</span>
<a href="#l3.2390"></a><span id="l3.2390">   // auto-save???</span>
<a href="#l3.2391"></a><span id="l3.2391"> }</span>
<a href="#l3.2392"></a><span id="l3.2392"> </span>
<a href="#l3.2393"></a><span id="l3.2393" class="difflineminus">-function GetBodyElement()</span>
<a href="#l3.2394"></a><span id="l3.2394" class="difflineminus">-{</span>
<a href="#l3.2395"></a><span id="l3.2395" class="difflineplus">+function GetBodyElement() {</span>
<a href="#l3.2396"></a><span id="l3.2396">   try {</span>
<a href="#l3.2397"></a><span id="l3.2397">     return GetCurrentEditor().rootElement;</span>
<a href="#l3.2398"></a><span id="l3.2398" class="difflineminus">-  }</span>
<a href="#l3.2399"></a><span id="l3.2399" class="difflineminus">-  catch (ex) {</span>
<a href="#l3.2400"></a><span id="l3.2400" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.2401"></a><span id="l3.2401">     dump(&quot;no body tag found?!\n&quot;);</span>
<a href="#l3.2402"></a><span id="l3.2402">     //  better have one, how can we blow things up here?</span>
<a href="#l3.2403"></a><span id="l3.2403">   }</span>
<a href="#l3.2404"></a><span id="l3.2404">   return null;</span>
<a href="#l3.2405"></a><span id="l3.2405"> }</span>
<a href="#l3.2406"></a><span id="l3.2406"> </span>
<a href="#l3.2407"></a><span id="l3.2407"> // --------------------------- Logging stuff ---------------------------</span>
<a href="#l3.2408"></a><span id="l3.2408"> </span>
<a href="#l3.2409"></a><span id="l3.2409" class="difflineminus">-function EditorGetNodeFromOffsets(offsets)</span>
<a href="#l3.2410"></a><span id="l3.2410" class="difflineminus">-{</span>
<a href="#l3.2411"></a><span id="l3.2411" class="difflineplus">+function EditorGetNodeFromOffsets(offsets) {</span>
<a href="#l3.2412"></a><span id="l3.2412">   var node = null;</span>
<a href="#l3.2413"></a><span id="l3.2413">   try {</span>
<a href="#l3.2414"></a><span id="l3.2414">     node = GetCurrentEditor().document;</span>
<a href="#l3.2415"></a><span id="l3.2415"> </span>
<a href="#l3.2416"></a><span id="l3.2416">     for (var i = 0; i &lt; offsets.length; i++)</span>
<a href="#l3.2417"></a><span id="l3.2417">       node = node.childNodes[offsets[i]];</span>
<a href="#l3.2418"></a><span id="l3.2418">   } catch (e) {}</span>
<a href="#l3.2419"></a><span id="l3.2419">   return node;</span>
<a href="#l3.2420"></a><span id="l3.2420"> }</span>
<a href="#l3.2421"></a><span id="l3.2421"> </span>
<a href="#l3.2422"></a><span id="l3.2422" class="difflineminus">-function EditorSetSelectionFromOffsets(selRanges)</span>
<a href="#l3.2423"></a><span id="l3.2423" class="difflineminus">-{</span>
<a href="#l3.2424"></a><span id="l3.2424" class="difflineplus">+function EditorSetSelectionFromOffsets(selRanges) {</span>
<a href="#l3.2425"></a><span id="l3.2425">   try {</span>
<a href="#l3.2426"></a><span id="l3.2426">     var editor = GetCurrentEditor();</span>
<a href="#l3.2427"></a><span id="l3.2427">     var selection = editor.selection;</span>
<a href="#l3.2428"></a><span id="l3.2428">     selection.removeAllRanges();</span>
<a href="#l3.2429"></a><span id="l3.2429"> </span>
<a href="#l3.2430"></a><span id="l3.2430">     var rangeArr, start, end, node, offset;</span>
<a href="#l3.2431"></a><span id="l3.2431" class="difflineminus">-    for (var i = 0; i &lt; selRanges.length; i++)</span>
<a href="#l3.2432"></a><span id="l3.2432" class="difflineminus">-    {</span>
<a href="#l3.2433"></a><span id="l3.2433" class="difflineplus">+    for (var i = 0; i &lt; selRanges.length; i++) {</span>
<a href="#l3.2434"></a><span id="l3.2434">       rangeArr = selRanges[i];</span>
<a href="#l3.2435"></a><span id="l3.2435">       start    = rangeArr[0];</span>
<a href="#l3.2436"></a><span id="l3.2436">       end      = rangeArr[1];</span>
<a href="#l3.2437"></a><span id="l3.2437"> </span>
<a href="#l3.2438"></a><span id="l3.2438">       var range = editor.document.createRange();</span>
<a href="#l3.2439"></a><span id="l3.2439"> </span>
<a href="#l3.2440"></a><span id="l3.2440">       node   = EditorGetNodeFromOffsets(start[0]);</span>
<a href="#l3.2441"></a><span id="l3.2441">       offset = start[1];</span>
<a href="#l3.2442"></a><span id="l3.2442" class="difflineat">@@ -2430,375 +2198,331 @@ function EditorSetSelectionFromOffsets(s</span>
<a href="#l3.2443"></a><span id="l3.2443"> </span>
<a href="#l3.2444"></a><span id="l3.2444">       range.setEnd(node, offset);</span>
<a href="#l3.2445"></a><span id="l3.2445"> </span>
<a href="#l3.2446"></a><span id="l3.2446">       selection.addRange(range);</span>
<a href="#l3.2447"></a><span id="l3.2447">     }</span>
<a href="#l3.2448"></a><span id="l3.2448">   } catch (e) {}</span>
<a href="#l3.2449"></a><span id="l3.2449"> }</span>
<a href="#l3.2450"></a><span id="l3.2450"> </span>
<a href="#l3.2451"></a><span id="l3.2451" class="difflineminus">-//--------------------------------------------------------------------</span>
<a href="#l3.2452"></a><span id="l3.2452" class="difflineminus">-function initFontStyleMenu(menuPopup)</span>
<a href="#l3.2453"></a><span id="l3.2453" class="difflineminus">-{</span>
<a href="#l3.2454"></a><span id="l3.2454" class="difflineminus">-  for (var i = 0; i &lt; menuPopup.childNodes.length; i++)</span>
<a href="#l3.2455"></a><span id="l3.2455" class="difflineminus">-  {</span>
<a href="#l3.2456"></a><span id="l3.2456" class="difflineplus">+// --------------------------------------------------------------------</span>
<a href="#l3.2457"></a><span id="l3.2457" class="difflineplus">+function initFontStyleMenu(menuPopup) {</span>
<a href="#l3.2458"></a><span id="l3.2458" class="difflineplus">+  for (var i = 0; i &lt; menuPopup.childNodes.length; i++) {</span>
<a href="#l3.2459"></a><span id="l3.2459">     var menuItem = menuPopup.childNodes[i];</span>
<a href="#l3.2460"></a><span id="l3.2460">     var theStyle = menuItem.getAttribute(&quot;state&quot;);</span>
<a href="#l3.2461"></a><span id="l3.2461" class="difflineminus">-    if (theStyle)</span>
<a href="#l3.2462"></a><span id="l3.2462" class="difflineminus">-    {</span>
<a href="#l3.2463"></a><span id="l3.2463" class="difflineplus">+    if (theStyle) {</span>
<a href="#l3.2464"></a><span id="l3.2464">       menuItem.setAttribute(&quot;checked&quot;, theStyle);</span>
<a href="#l3.2465"></a><span id="l3.2465">     }</span>
<a href="#l3.2466"></a><span id="l3.2466">   }</span>
<a href="#l3.2467"></a><span id="l3.2467"> }</span>
<a href="#l3.2468"></a><span id="l3.2468"> </span>
<a href="#l3.2469"></a><span id="l3.2469" class="difflineminus">-//--------------------------------------------------------------------</span>
<a href="#l3.2470"></a><span id="l3.2470" class="difflineminus">-function onButtonUpdate(button, commmandID)</span>
<a href="#l3.2471"></a><span id="l3.2471" class="difflineminus">-{</span>
<a href="#l3.2472"></a><span id="l3.2472" class="difflineplus">+// --------------------------------------------------------------------</span>
<a href="#l3.2473"></a><span id="l3.2473" class="difflineplus">+function onButtonUpdate(button, commmandID) {</span>
<a href="#l3.2474"></a><span id="l3.2474">   var commandNode = document.getElementById(commmandID);</span>
<a href="#l3.2475"></a><span id="l3.2475">   var state = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.2476"></a><span id="l3.2476">   button.checked = state == &quot;true&quot;;</span>
<a href="#l3.2477"></a><span id="l3.2477"> }</span>
<a href="#l3.2478"></a><span id="l3.2478"> </span>
<a href="#l3.2479"></a><span id="l3.2479" class="difflineminus">-//--------------------------------------------------------------------</span>
<a href="#l3.2480"></a><span id="l3.2480" class="difflineminus">-function onStateButtonUpdate(button, commmandID, onState)</span>
<a href="#l3.2481"></a><span id="l3.2481" class="difflineminus">-{</span>
<a href="#l3.2482"></a><span id="l3.2482" class="difflineplus">+// --------------------------------------------------------------------</span>
<a href="#l3.2483"></a><span id="l3.2483" class="difflineplus">+function onStateButtonUpdate(button, commmandID, onState) {</span>
<a href="#l3.2484"></a><span id="l3.2484">   var commandNode = document.getElementById(commmandID);</span>
<a href="#l3.2485"></a><span id="l3.2485">   var state = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.2486"></a><span id="l3.2486"> </span>
<a href="#l3.2487"></a><span id="l3.2487">   button.checked = state == onState;</span>
<a href="#l3.2488"></a><span id="l3.2488"> }</span>
<a href="#l3.2489"></a><span id="l3.2489"> </span>
<a href="#l3.2490"></a><span id="l3.2490"> // --------------------------- Status calls ---------------------------</span>
<a href="#l3.2491"></a><span id="l3.2491" class="difflineminus">-function getColorAndSetColorWell(ColorPickerID, ColorWellID)</span>
<a href="#l3.2492"></a><span id="l3.2492" class="difflineminus">-{</span>
<a href="#l3.2493"></a><span id="l3.2493" class="difflineplus">+function getColorAndSetColorWell(ColorPickerID, ColorWellID) {</span>
<a href="#l3.2494"></a><span id="l3.2494">   var colorWell;</span>
<a href="#l3.2495"></a><span id="l3.2495">   if (ColorWellID)</span>
<a href="#l3.2496"></a><span id="l3.2496">     colorWell = document.getElementById(ColorWellID);</span>
<a href="#l3.2497"></a><span id="l3.2497"> </span>
<a href="#l3.2498"></a><span id="l3.2498">   var colorPicker = document.getElementById(ColorPickerID);</span>
<a href="#l3.2499"></a><span id="l3.2499" class="difflineminus">-  if (colorPicker)</span>
<a href="#l3.2500"></a><span id="l3.2500" class="difflineminus">-  {</span>
<a href="#l3.2501"></a><span id="l3.2501" class="difflineplus">+  if (colorPicker) {</span>
<a href="#l3.2502"></a><span id="l3.2502">     // Extract color from colorPicker and assign to colorWell.</span>
<a href="#l3.2503"></a><span id="l3.2503">     var color = colorPicker.getAttribute(&quot;color&quot;);</span>
<a href="#l3.2504"></a><span id="l3.2504"> </span>
<a href="#l3.2505"></a><span id="l3.2505" class="difflineminus">-    if (colorWell &amp;&amp; color)</span>
<a href="#l3.2506"></a><span id="l3.2506" class="difflineminus">-    {</span>
<a href="#l3.2507"></a><span id="l3.2507" class="difflineplus">+    if (colorWell &amp;&amp; color) {</span>
<a href="#l3.2508"></a><span id="l3.2508">       // Use setAttribute so colorwell can be a XUL element, such as button</span>
<a href="#l3.2509"></a><span id="l3.2509">       colorWell.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + color);</span>
<a href="#l3.2510"></a><span id="l3.2510">     }</span>
<a href="#l3.2511"></a><span id="l3.2511">   }</span>
<a href="#l3.2512"></a><span id="l3.2512">   return color;</span>
<a href="#l3.2513"></a><span id="l3.2513"> }</span>
<a href="#l3.2514"></a><span id="l3.2514"> </span>
<a href="#l3.2515"></a><span id="l3.2515" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l3.2516"></a><span id="l3.2516" class="difflineminus">-function IsSpellCheckerInstalled()</span>
<a href="#l3.2517"></a><span id="l3.2517" class="difflineminus">-{</span>
<a href="#l3.2518"></a><span id="l3.2518" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l3.2519"></a><span id="l3.2519" class="difflineplus">+function IsSpellCheckerInstalled() {</span>
<a href="#l3.2520"></a><span id="l3.2520">   return true;  // Always installed.</span>
<a href="#l3.2521"></a><span id="l3.2521"> }</span>
<a href="#l3.2522"></a><span id="l3.2522"> </span>
<a href="#l3.2523"></a><span id="l3.2523" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l3.2524"></a><span id="l3.2524" class="difflineminus">-function IsFindInstalled()</span>
<a href="#l3.2525"></a><span id="l3.2525" class="difflineminus">-{</span>
<a href="#l3.2526"></a><span id="l3.2526" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l3.2527"></a><span id="l3.2527" class="difflineplus">+function IsFindInstalled() {</span>
<a href="#l3.2528"></a><span id="l3.2528">   return &quot;@mozilla.org/embedcomp/rangefind;1&quot; in Cc</span>
<a href="#l3.2529"></a><span id="l3.2529">           &amp;&amp; &quot;@mozilla.org/find/find_service;1&quot; in Cc;</span>
<a href="#l3.2530"></a><span id="l3.2530"> }</span>
<a href="#l3.2531"></a><span id="l3.2531"> </span>
<a href="#l3.2532"></a><span id="l3.2532" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l3.2533"></a><span id="l3.2533" class="difflineminus">-function RemoveInapplicableUIElements()</span>
<a href="#l3.2534"></a><span id="l3.2534" class="difflineminus">-{</span>
<a href="#l3.2535"></a><span id="l3.2535" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l3.2536"></a><span id="l3.2536" class="difflineplus">+function RemoveInapplicableUIElements() {</span>
<a href="#l3.2537"></a><span id="l3.2537">   // For items that are in their own menu block, remove associated separator</span>
<a href="#l3.2538"></a><span id="l3.2538">   // (we can't use &quot;hidden&quot; since class=&quot;hide-in-IM&quot; CSS rule interferes)</span>
<a href="#l3.2539"></a><span id="l3.2539"> </span>
<a href="#l3.2540"></a><span id="l3.2540">    // if no find, remove find ui</span>
<a href="#l3.2541"></a><span id="l3.2541" class="difflineminus">-  if (!IsFindInstalled())</span>
<a href="#l3.2542"></a><span id="l3.2542" class="difflineminus">-  {</span>
<a href="#l3.2543"></a><span id="l3.2543" class="difflineplus">+  if (!IsFindInstalled()) {</span>
<a href="#l3.2544"></a><span id="l3.2544">     HideItem(&quot;menu_find&quot;);</span>
<a href="#l3.2545"></a><span id="l3.2545">     HideItem(&quot;menu_findnext&quot;);</span>
<a href="#l3.2546"></a><span id="l3.2546">     HideItem(&quot;menu_replace&quot;);</span>
<a href="#l3.2547"></a><span id="l3.2547">     HideItem(&quot;menu_find&quot;);</span>
<a href="#l3.2548"></a><span id="l3.2548">     RemoveItem(&quot;sep_find&quot;);</span>
<a href="#l3.2549"></a><span id="l3.2549">   }</span>
<a href="#l3.2550"></a><span id="l3.2550"> </span>
<a href="#l3.2551"></a><span id="l3.2551">    // if no spell checker, remove spell checker ui</span>
<a href="#l3.2552"></a><span id="l3.2552" class="difflineminus">-  if (!IsSpellCheckerInstalled())</span>
<a href="#l3.2553"></a><span id="l3.2553" class="difflineminus">-  {</span>
<a href="#l3.2554"></a><span id="l3.2554" class="difflineplus">+  if (!IsSpellCheckerInstalled()) {</span>
<a href="#l3.2555"></a><span id="l3.2555">     HideItem(&quot;spellingButton&quot;);</span>
<a href="#l3.2556"></a><span id="l3.2556">     HideItem(&quot;menu_checkspelling&quot;);</span>
<a href="#l3.2557"></a><span id="l3.2557">     RemoveItem(&quot;sep_checkspelling&quot;);</span>
<a href="#l3.2558"></a><span id="l3.2558">   }</span>
<a href="#l3.2559"></a><span id="l3.2559"> </span>
<a href="#l3.2560"></a><span id="l3.2560">   // Remove menu items (from overlay shared with HTML editor) in non-HTML.</span>
<a href="#l3.2561"></a><span id="l3.2561" class="difflineminus">-  if (!IsHTMLEditor())</span>
<a href="#l3.2562"></a><span id="l3.2562" class="difflineminus">-  {</span>
<a href="#l3.2563"></a><span id="l3.2563" class="difflineplus">+  if (!IsHTMLEditor()) {</span>
<a href="#l3.2564"></a><span id="l3.2564">     HideItem(&quot;insertAnchor&quot;);</span>
<a href="#l3.2565"></a><span id="l3.2565">     HideItem(&quot;insertImage&quot;);</span>
<a href="#l3.2566"></a><span id="l3.2566">     HideItem(&quot;insertHline&quot;);</span>
<a href="#l3.2567"></a><span id="l3.2567">     HideItem(&quot;insertTable&quot;);</span>
<a href="#l3.2568"></a><span id="l3.2568">     HideItem(&quot;insertHTML&quot;);</span>
<a href="#l3.2569"></a><span id="l3.2569">     HideItem(&quot;insertFormMenu&quot;);</span>
<a href="#l3.2570"></a><span id="l3.2570">     HideItem(&quot;fileExportToText&quot;);</span>
<a href="#l3.2571"></a><span id="l3.2571">     HideItem(&quot;viewFormatToolbar&quot;);</span>
<a href="#l3.2572"></a><span id="l3.2572">     HideItem(&quot;viewEditModeToolbar&quot;);</span>
<a href="#l3.2573"></a><span id="l3.2573">   }</span>
<a href="#l3.2574"></a><span id="l3.2574"> }</span>
<a href="#l3.2575"></a><span id="l3.2575"> </span>
<a href="#l3.2576"></a><span id="l3.2576" class="difflineminus">-function HideItem(id)</span>
<a href="#l3.2577"></a><span id="l3.2577" class="difflineminus">-{</span>
<a href="#l3.2578"></a><span id="l3.2578" class="difflineplus">+function HideItem(id) {</span>
<a href="#l3.2579"></a><span id="l3.2579">   var item = document.getElementById(id);</span>
<a href="#l3.2580"></a><span id="l3.2580">   if (item)</span>
<a href="#l3.2581"></a><span id="l3.2581">     item.hidden = true;</span>
<a href="#l3.2582"></a><span id="l3.2582"> }</span>
<a href="#l3.2583"></a><span id="l3.2583"> </span>
<a href="#l3.2584"></a><span id="l3.2584" class="difflineminus">-function RemoveItem(id)</span>
<a href="#l3.2585"></a><span id="l3.2585" class="difflineminus">-{</span>
<a href="#l3.2586"></a><span id="l3.2586" class="difflineplus">+function RemoveItem(id) {</span>
<a href="#l3.2587"></a><span id="l3.2587">   var item = document.getElementById(id);</span>
<a href="#l3.2588"></a><span id="l3.2588">   if (item)</span>
<a href="#l3.2589"></a><span id="l3.2589">     item.remove();</span>
<a href="#l3.2590"></a><span id="l3.2590"> }</span>
<a href="#l3.2591"></a><span id="l3.2591"> </span>
<a href="#l3.2592"></a><span id="l3.2592"> // Command Updating Strategy:</span>
<a href="#l3.2593"></a><span id="l3.2593"> //   Don't update on on selection change, only when menu is displayed,</span>
<a href="#l3.2594"></a><span id="l3.2594"> //   with this &quot;oncreate&quot; handler:</span>
<a href="#l3.2595"></a><span id="l3.2595" class="difflineminus">-function EditorInitTableMenu()</span>
<a href="#l3.2596"></a><span id="l3.2596" class="difflineminus">-{</span>
<a href="#l3.2597"></a><span id="l3.2597" class="difflineplus">+function EditorInitTableMenu() {</span>
<a href="#l3.2598"></a><span id="l3.2598">   try {</span>
<a href="#l3.2599"></a><span id="l3.2599">     InitJoinCellMenuitem(&quot;menu_JoinTableCells&quot;);</span>
<a href="#l3.2600"></a><span id="l3.2600">   } catch (ex) {}</span>
<a href="#l3.2601"></a><span id="l3.2601"> </span>
<a href="#l3.2602"></a><span id="l3.2602">   // Set enable states for all table commands</span>
<a href="#l3.2603"></a><span id="l3.2603">   goUpdateTableMenuItems(document.getElementById(&quot;composerTableMenuItems&quot;));</span>
<a href="#l3.2604"></a><span id="l3.2604"> }</span>
<a href="#l3.2605"></a><span id="l3.2605"> </span>
<a href="#l3.2606"></a><span id="l3.2606" class="difflineminus">-function InitJoinCellMenuitem(id)</span>
<a href="#l3.2607"></a><span id="l3.2607" class="difflineminus">-{</span>
<a href="#l3.2608"></a><span id="l3.2608" class="difflineplus">+function InitJoinCellMenuitem(id) {</span>
<a href="#l3.2609"></a><span id="l3.2609">   // Change text on the &quot;Join...&quot; item depending if we</span>
<a href="#l3.2610"></a><span id="l3.2610">   //   are joining selected cells or just cell to right</span>
<a href="#l3.2611"></a><span id="l3.2611">   // TODO: What to do about normal selection that crosses</span>
<a href="#l3.2612"></a><span id="l3.2612">   //       table border? Try to figure out all cells</span>
<a href="#l3.2613"></a><span id="l3.2613">   //       included in the selection?</span>
<a href="#l3.2614"></a><span id="l3.2614">   var menuText;</span>
<a href="#l3.2615"></a><span id="l3.2615">   var menuItem = document.getElementById(id);</span>
<a href="#l3.2616"></a><span id="l3.2616">   if (!menuItem) return;</span>
<a href="#l3.2617"></a><span id="l3.2617"> </span>
<a href="#l3.2618"></a><span id="l3.2618">   // Use &quot;Join selected cells if there's more than 1 cell selected</span>
<a href="#l3.2619"></a><span id="l3.2619">   var numSelected;</span>
<a href="#l3.2620"></a><span id="l3.2620">   var foundElement;</span>
<a href="#l3.2621"></a><span id="l3.2621"> </span>
<a href="#l3.2622"></a><span id="l3.2622">   try {</span>
<a href="#l3.2623"></a><span id="l3.2623">     var tagNameObj = {};</span>
<a href="#l3.2624"></a><span id="l3.2624" class="difflineminus">-    var countObj = {value:0}</span>
<a href="#l3.2625"></a><span id="l3.2625" class="difflineplus">+    var countObj = {value: 0};</span>
<a href="#l3.2626"></a><span id="l3.2626">     foundElement = GetCurrentTableEditor().getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l3.2627"></a><span id="l3.2627" class="difflineminus">-    numSelected = countObj.value</span>
<a href="#l3.2628"></a><span id="l3.2628" class="difflineminus">-  }</span>
<a href="#l3.2629"></a><span id="l3.2629" class="difflineminus">-  catch(e) {}</span>
<a href="#l3.2630"></a><span id="l3.2630" class="difflineplus">+    numSelected = countObj.value;</span>
<a href="#l3.2631"></a><span id="l3.2631" class="difflineplus">+  } catch (e) {}</span>
<a href="#l3.2632"></a><span id="l3.2632">   if (foundElement &amp;&amp; numSelected &gt; 1)</span>
<a href="#l3.2633"></a><span id="l3.2633">     menuText = GetString(&quot;JoinSelectedCells&quot;);</span>
<a href="#l3.2634"></a><span id="l3.2634">   else</span>
<a href="#l3.2635"></a><span id="l3.2635">     menuText = GetString(&quot;JoinCellToRight&quot;);</span>
<a href="#l3.2636"></a><span id="l3.2636"> </span>
<a href="#l3.2637"></a><span id="l3.2637" class="difflineminus">-  menuItem.setAttribute(&quot;label&quot;,menuText);</span>
<a href="#l3.2638"></a><span id="l3.2638" class="difflineminus">-  menuItem.setAttribute(&quot;accesskey&quot;,GetString(&quot;JoinCellAccesskey&quot;));</span>
<a href="#l3.2639"></a><span id="l3.2639" class="difflineplus">+  menuItem.setAttribute(&quot;label&quot;, menuText);</span>
<a href="#l3.2640"></a><span id="l3.2640" class="difflineplus">+  menuItem.setAttribute(&quot;accesskey&quot;, GetString(&quot;JoinCellAccesskey&quot;));</span>
<a href="#l3.2641"></a><span id="l3.2641"> }</span>
<a href="#l3.2642"></a><span id="l3.2642"> </span>
<a href="#l3.2643"></a><span id="l3.2643" class="difflineminus">-function InitRemoveStylesMenuitems(removeStylesId, removeLinksId, removeNamedAnchorsId)</span>
<a href="#l3.2644"></a><span id="l3.2644" class="difflineminus">-{</span>
<a href="#l3.2645"></a><span id="l3.2645" class="difflineplus">+function InitRemoveStylesMenuitems(removeStylesId, removeLinksId, removeNamedAnchorsId) {</span>
<a href="#l3.2646"></a><span id="l3.2646">   var editor = GetCurrentEditor();</span>
<a href="#l3.2647"></a><span id="l3.2647">   if (!editor)</span>
<a href="#l3.2648"></a><span id="l3.2648">     return;</span>
<a href="#l3.2649"></a><span id="l3.2649"> </span>
<a href="#l3.2650"></a><span id="l3.2650">   // Change wording of menuitems depending on selection</span>
<a href="#l3.2651"></a><span id="l3.2651">   var stylesItem = document.getElementById(removeStylesId);</span>
<a href="#l3.2652"></a><span id="l3.2652">   var linkItem = document.getElementById(removeLinksId);</span>
<a href="#l3.2653"></a><span id="l3.2653"> </span>
<a href="#l3.2654"></a><span id="l3.2654">   var isCollapsed = editor.selection.isCollapsed;</span>
<a href="#l3.2655"></a><span id="l3.2655" class="difflineminus">-  if (stylesItem)</span>
<a href="#l3.2656"></a><span id="l3.2656" class="difflineminus">-  {</span>
<a href="#l3.2657"></a><span id="l3.2657" class="difflineplus">+  if (stylesItem) {</span>
<a href="#l3.2658"></a><span id="l3.2658">     stylesItem.setAttribute(&quot;label&quot;, isCollapsed ? GetString(&quot;StopTextStyles&quot;) : GetString(&quot;RemoveTextStyles&quot;));</span>
<a href="#l3.2659"></a><span id="l3.2659">     stylesItem.setAttribute(&quot;accesskey&quot;, GetString(&quot;RemoveTextStylesAccesskey&quot;));</span>
<a href="#l3.2660"></a><span id="l3.2660">   }</span>
<a href="#l3.2661"></a><span id="l3.2661" class="difflineminus">-  if (linkItem)</span>
<a href="#l3.2662"></a><span id="l3.2662" class="difflineminus">-  {</span>
<a href="#l3.2663"></a><span id="l3.2663" class="difflineplus">+  if (linkItem) {</span>
<a href="#l3.2664"></a><span id="l3.2664">     linkItem.setAttribute(&quot;label&quot;, isCollapsed ? GetString(&quot;StopLinks&quot;) : GetString(&quot;RemoveLinks&quot;));</span>
<a href="#l3.2665"></a><span id="l3.2665">     linkItem.setAttribute(&quot;accesskey&quot;, GetString(&quot;RemoveLinksAccesskey&quot;));</span>
<a href="#l3.2666"></a><span id="l3.2666">     // Note: disabling text style is a pain since there are so many - forget it!</span>
<a href="#l3.2667"></a><span id="l3.2667"> </span>
<a href="#l3.2668"></a><span id="l3.2668">     // Disable if not in a link, but always allow &quot;Remove&quot;</span>
<a href="#l3.2669"></a><span id="l3.2669">     //  if selection isn't collapsed since we only look at anchor node</span>
<a href="#l3.2670"></a><span id="l3.2670">     try {</span>
<a href="#l3.2671"></a><span id="l3.2671">       SetElementEnabled(linkItem, !isCollapsed ||</span>
<a href="#l3.2672"></a><span id="l3.2672">                       editor.getElementOrParentByTagName(&quot;href&quot;, null));</span>
<a href="#l3.2673"></a><span id="l3.2673" class="difflineminus">-    } catch(e) {}</span>
<a href="#l3.2674"></a><span id="l3.2674" class="difflineplus">+    } catch (e) {}</span>
<a href="#l3.2675"></a><span id="l3.2675">   }</span>
<a href="#l3.2676"></a><span id="l3.2676">   // Disable if selection is collapsed</span>
<a href="#l3.2677"></a><span id="l3.2677">   SetElementEnabledById(removeNamedAnchorsId, !isCollapsed);</span>
<a href="#l3.2678"></a><span id="l3.2678"> }</span>
<a href="#l3.2679"></a><span id="l3.2679"> </span>
<a href="#l3.2680"></a><span id="l3.2680" class="difflineminus">-function goUpdateTableMenuItems(commandset)</span>
<a href="#l3.2681"></a><span id="l3.2681" class="difflineminus">-{</span>
<a href="#l3.2682"></a><span id="l3.2682" class="difflineplus">+function goUpdateTableMenuItems(commandset) {</span>
<a href="#l3.2683"></a><span id="l3.2683">   var editor = GetCurrentTableEditor();</span>
<a href="#l3.2684"></a><span id="l3.2684" class="difflineminus">-  if (!editor)</span>
<a href="#l3.2685"></a><span id="l3.2685" class="difflineminus">-  {</span>
<a href="#l3.2686"></a><span id="l3.2686" class="difflineplus">+  if (!editor) {</span>
<a href="#l3.2687"></a><span id="l3.2687">     dump(&quot;goUpdateTableMenuItems: too early, not initialized\n&quot;);</span>
<a href="#l3.2688"></a><span id="l3.2688">     return;</span>
<a href="#l3.2689"></a><span id="l3.2689">   }</span>
<a href="#l3.2690"></a><span id="l3.2690"> </span>
<a href="#l3.2691"></a><span id="l3.2691">   var enabled = false;</span>
<a href="#l3.2692"></a><span id="l3.2692">   var enabledIfTable = false;</span>
<a href="#l3.2693"></a><span id="l3.2693"> </span>
<a href="#l3.2694"></a><span id="l3.2694">   var flags = editor.flags;</span>
<a href="#l3.2695"></a><span id="l3.2695">   if (!(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2696"></a><span id="l3.2696" class="difflineminus">-      IsEditingRenderedHTML())</span>
<a href="#l3.2697"></a><span id="l3.2697" class="difflineminus">-  {</span>
<a href="#l3.2698"></a><span id="l3.2698" class="difflineplus">+      IsEditingRenderedHTML()) {</span>
<a href="#l3.2699"></a><span id="l3.2699">     var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l3.2700"></a><span id="l3.2700">     var element;</span>
<a href="#l3.2701"></a><span id="l3.2701">     try {</span>
<a href="#l3.2702"></a><span id="l3.2702" class="difflineminus">-      element = editor.getSelectedOrParentTableElement(tagNameObj, {value:0});</span>
<a href="#l3.2703"></a><span id="l3.2703" class="difflineminus">-    }</span>
<a href="#l3.2704"></a><span id="l3.2704" class="difflineminus">-    catch(e) {}</span>
<a href="#l3.2705"></a><span id="l3.2705" class="difflineminus">-</span>
<a href="#l3.2706"></a><span id="l3.2706" class="difflineminus">-    if (element)</span>
<a href="#l3.2707"></a><span id="l3.2707" class="difflineminus">-    {</span>
<a href="#l3.2708"></a><span id="l3.2708" class="difflineplus">+      element = editor.getSelectedOrParentTableElement(tagNameObj, {value: 0});</span>
<a href="#l3.2709"></a><span id="l3.2709" class="difflineplus">+    } catch (e) {}</span>
<a href="#l3.2710"></a><span id="l3.2710" class="difflineplus">+</span>
<a href="#l3.2711"></a><span id="l3.2711" class="difflineplus">+    if (element) {</span>
<a href="#l3.2712"></a><span id="l3.2712">       // Value when we need to have a selected table or inside a table</span>
<a href="#l3.2713"></a><span id="l3.2713">       enabledIfTable = true;</span>
<a href="#l3.2714"></a><span id="l3.2714"> </span>
<a href="#l3.2715"></a><span id="l3.2715">       // All others require being inside a cell or selected cell</span>
<a href="#l3.2716"></a><span id="l3.2716">       enabled = (tagNameObj.value == &quot;td&quot;);</span>
<a href="#l3.2717"></a><span id="l3.2717">     }</span>
<a href="#l3.2718"></a><span id="l3.2718">   }</span>
<a href="#l3.2719"></a><span id="l3.2719"> </span>
<a href="#l3.2720"></a><span id="l3.2720">   // Loop through command nodes</span>
<a href="#l3.2721"></a><span id="l3.2721" class="difflineminus">-  for (var i = 0; i &lt; commandset.childNodes.length; i++)</span>
<a href="#l3.2722"></a><span id="l3.2722" class="difflineminus">-  {</span>
<a href="#l3.2723"></a><span id="l3.2723" class="difflineplus">+  for (var i = 0; i &lt; commandset.childNodes.length; i++) {</span>
<a href="#l3.2724"></a><span id="l3.2724">     var commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l3.2725"></a><span id="l3.2725" class="difflineminus">-    if (commandID)</span>
<a href="#l3.2726"></a><span id="l3.2726" class="difflineminus">-    {</span>
<a href="#l3.2727"></a><span id="l3.2727" class="difflineplus">+    if (commandID) {</span>
<a href="#l3.2728"></a><span id="l3.2728">       if (commandID == &quot;cmd_InsertTable&quot; ||</span>
<a href="#l3.2729"></a><span id="l3.2729">           commandID == &quot;cmd_JoinTableCells&quot; ||</span>
<a href="#l3.2730"></a><span id="l3.2730">           commandID == &quot;cmd_SplitTableCell&quot; ||</span>
<a href="#l3.2731"></a><span id="l3.2731" class="difflineminus">-          commandID == &quot;cmd_ConvertToTable&quot;)</span>
<a href="#l3.2732"></a><span id="l3.2732" class="difflineminus">-      {</span>
<a href="#l3.2733"></a><span id="l3.2733" class="difflineplus">+          commandID == &quot;cmd_ConvertToTable&quot;) {</span>
<a href="#l3.2734"></a><span id="l3.2734">         // Call the update method in the command class</span>
<a href="#l3.2735"></a><span id="l3.2735">         goUpdateCommand(commandID);</span>
<a href="#l3.2736"></a><span id="l3.2736">       }</span>
<a href="#l3.2737"></a><span id="l3.2737">       // Directly set with the values calculated here</span>
<a href="#l3.2738"></a><span id="l3.2738">       else if (commandID == &quot;cmd_DeleteTable&quot; ||</span>
<a href="#l3.2739"></a><span id="l3.2739">                commandID == &quot;cmd_NormalizeTable&quot; ||</span>
<a href="#l3.2740"></a><span id="l3.2740">                commandID == &quot;cmd_editTable&quot; ||</span>
<a href="#l3.2741"></a><span id="l3.2741">                commandID == &quot;cmd_TableOrCellColor&quot; ||</span>
<a href="#l3.2742"></a><span id="l3.2742" class="difflineminus">-               commandID == &quot;cmd_SelectTable&quot;)</span>
<a href="#l3.2743"></a><span id="l3.2743" class="difflineminus">-      {</span>
<a href="#l3.2744"></a><span id="l3.2744" class="difflineplus">+               commandID == &quot;cmd_SelectTable&quot;) {</span>
<a href="#l3.2745"></a><span id="l3.2745">         goSetCommandEnabled(commandID, enabledIfTable);</span>
<a href="#l3.2746"></a><span id="l3.2746">       } else {</span>
<a href="#l3.2747"></a><span id="l3.2747">         goSetCommandEnabled(commandID, enabled);</span>
<a href="#l3.2748"></a><span id="l3.2748">       }</span>
<a href="#l3.2749"></a><span id="l3.2749">     }</span>
<a href="#l3.2750"></a><span id="l3.2750">   }</span>
<a href="#l3.2751"></a><span id="l3.2751"> }</span>
<a href="#l3.2752"></a><span id="l3.2752"> </span>
<a href="#l3.2753"></a><span id="l3.2753" class="difflineminus">-//-----------------------------------------------------------------------------------</span>
<a href="#l3.2754"></a><span id="l3.2754" class="difflineplus">+// -----------------------------------------------------------------------------------</span>
<a href="#l3.2755"></a><span id="l3.2755"> // Helpers for inserting and editing tables:</span>
<a href="#l3.2756"></a><span id="l3.2756"> </span>
<a href="#l3.2757"></a><span id="l3.2757" class="difflineminus">-function IsInTable()</span>
<a href="#l3.2758"></a><span id="l3.2758" class="difflineminus">-{</span>
<a href="#l3.2759"></a><span id="l3.2759" class="difflineplus">+function IsInTable() {</span>
<a href="#l3.2760"></a><span id="l3.2760">   var editor = GetCurrentEditor();</span>
<a href="#l3.2761"></a><span id="l3.2761">   try {</span>
<a href="#l3.2762"></a><span id="l3.2762">     var flags = editor.flags;</span>
<a href="#l3.2763"></a><span id="l3.2763">     return (IsHTMLEditor() &amp;&amp;</span>
<a href="#l3.2764"></a><span id="l3.2764">             !(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2765"></a><span id="l3.2765">             IsEditingRenderedHTML() &amp;&amp;</span>
<a href="#l3.2766"></a><span id="l3.2766">             null != editor.getElementOrParentByTagName(&quot;table&quot;, null));</span>
<a href="#l3.2767"></a><span id="l3.2767">   } catch (e) {}</span>
<a href="#l3.2768"></a><span id="l3.2768">   return false;</span>
<a href="#l3.2769"></a><span id="l3.2769"> }</span>
<a href="#l3.2770"></a><span id="l3.2770"> </span>
<a href="#l3.2771"></a><span id="l3.2771" class="difflineminus">-function IsInTableCell()</span>
<a href="#l3.2772"></a><span id="l3.2772" class="difflineminus">-{</span>
<a href="#l3.2773"></a><span id="l3.2773" class="difflineplus">+function IsInTableCell() {</span>
<a href="#l3.2774"></a><span id="l3.2774">   try {</span>
<a href="#l3.2775"></a><span id="l3.2775">     var editor = GetCurrentEditor();</span>
<a href="#l3.2776"></a><span id="l3.2776">     var flags = editor.flags;</span>
<a href="#l3.2777"></a><span id="l3.2777">     return (IsHTMLEditor() &amp;&amp;</span>
<a href="#l3.2778"></a><span id="l3.2778">             !(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2779"></a><span id="l3.2779">             IsEditingRenderedHTML() &amp;&amp;</span>
<a href="#l3.2780"></a><span id="l3.2780">             null != editor.getElementOrParentByTagName(&quot;td&quot;, null));</span>
<a href="#l3.2781"></a><span id="l3.2781">   } catch (e) {}</span>
<a href="#l3.2782"></a><span id="l3.2782">   return false;</span>
<a href="#l3.2783"></a><span id="l3.2783" class="difflineminus">-</span>
<a href="#l3.2784"></a><span id="l3.2784"> }</span>
<a href="#l3.2785"></a><span id="l3.2785"> </span>
<a href="#l3.2786"></a><span id="l3.2786" class="difflineminus">-function IsSelectionInOneCell()</span>
<a href="#l3.2787"></a><span id="l3.2787" class="difflineminus">-{</span>
<a href="#l3.2788"></a><span id="l3.2788" class="difflineplus">+function IsSelectionInOneCell() {</span>
<a href="#l3.2789"></a><span id="l3.2789">   try {</span>
<a href="#l3.2790"></a><span id="l3.2790">     var editor = GetCurrentEditor();</span>
<a href="#l3.2791"></a><span id="l3.2791">     var selection = editor.selection;</span>
<a href="#l3.2792"></a><span id="l3.2792"> </span>
<a href="#l3.2793"></a><span id="l3.2793" class="difflineminus">-    if (selection.rangeCount == 1)</span>
<a href="#l3.2794"></a><span id="l3.2794" class="difflineminus">-    {</span>
<a href="#l3.2795"></a><span id="l3.2795" class="difflineplus">+    if (selection.rangeCount == 1) {</span>
<a href="#l3.2796"></a><span id="l3.2796">       // We have a &quot;normal&quot; single-range selection</span>
<a href="#l3.2797"></a><span id="l3.2797">       if (!selection.isCollapsed &amp;&amp;</span>
<a href="#l3.2798"></a><span id="l3.2798" class="difflineminus">-         selection.anchorNode != selection.focusNode)</span>
<a href="#l3.2799"></a><span id="l3.2799" class="difflineminus">-      {</span>
<a href="#l3.2800"></a><span id="l3.2800" class="difflineplus">+         selection.anchorNode != selection.focusNode) {</span>
<a href="#l3.2801"></a><span id="l3.2801">         // Check if both nodes are within the same cell</span>
<a href="#l3.2802"></a><span id="l3.2802">         var anchorCell = editor.getElementOrParentByTagName(&quot;td&quot;, selection.anchorNode);</span>
<a href="#l3.2803"></a><span id="l3.2803">         var focusCell = editor.getElementOrParentByTagName(&quot;td&quot;, selection.focusNode);</span>
<a href="#l3.2804"></a><span id="l3.2804">         return (focusCell != null &amp;&amp; anchorCell != null &amp;&amp; (focusCell == anchorCell));</span>
<a href="#l3.2805"></a><span id="l3.2805">       }</span>
<a href="#l3.2806"></a><span id="l3.2806">       // Collapsed selection or anchor == focus (thus must be in 1 cell)</span>
<a href="#l3.2807"></a><span id="l3.2807">       return true;</span>
<a href="#l3.2808"></a><span id="l3.2808">     }</span>
<a href="#l3.2809"></a><span id="l3.2809">   } catch (e) {}</span>
<a href="#l3.2810"></a><span id="l3.2810">   return false;</span>
<a href="#l3.2811"></a><span id="l3.2811"> }</span>
<a href="#l3.2812"></a><span id="l3.2812"> </span>
<a href="#l3.2813"></a><span id="l3.2813"> // Call this with insertAllowed = true to allow inserting if not in existing table,</span>
<a href="#l3.2814"></a><span id="l3.2814"> //   else use false to do nothing if not in a table</span>
<a href="#l3.2815"></a><span id="l3.2815" class="difflineminus">-function EditorInsertOrEditTable(insertAllowed)</span>
<a href="#l3.2816"></a><span id="l3.2816" class="difflineminus">-{</span>
<a href="#l3.2817"></a><span id="l3.2817" class="difflineminus">-  if (IsInTable())</span>
<a href="#l3.2818"></a><span id="l3.2818" class="difflineminus">-  {</span>
<a href="#l3.2819"></a><span id="l3.2819" class="difflineplus">+function EditorInsertOrEditTable(insertAllowed) {</span>
<a href="#l3.2820"></a><span id="l3.2820" class="difflineplus">+  if (IsInTable()) {</span>
<a href="#l3.2821"></a><span id="l3.2821">     // Edit properties of existing table</span>
<a href="#l3.2822"></a><span id="l3.2822" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdTableProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;,&quot;TablePanel&quot;);</span>
<a href="#l3.2823"></a><span id="l3.2823" class="difflineplus">+    window.openDialog(&quot;chrome://editor/content/EdTableProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, &quot;TablePanel&quot;);</span>
<a href="#l3.2824"></a><span id="l3.2824">     gContentWindow.focus();</span>
<a href="#l3.2825"></a><span id="l3.2825" class="difflineminus">-  }</span>
<a href="#l3.2826"></a><span id="l3.2826" class="difflineminus">-  else if (insertAllowed)</span>
<a href="#l3.2827"></a><span id="l3.2827" class="difflineminus">-  {</span>
<a href="#l3.2828"></a><span id="l3.2828" class="difflineplus">+  } else if (insertAllowed) {</span>
<a href="#l3.2829"></a><span id="l3.2829">     try {</span>
<a href="#l3.2830"></a><span id="l3.2830">       if (GetCurrentEditor().selection.isCollapsed)</span>
<a href="#l3.2831"></a><span id="l3.2831">         // If we have a caret, insert a blank table...</span>
<a href="#l3.2832"></a><span id="l3.2832">         EditorInsertTable();</span>
<a href="#l3.2833"></a><span id="l3.2833">       else</span>
<a href="#l3.2834"></a><span id="l3.2834">         // else convert the selection into a table</span>
<a href="#l3.2835"></a><span id="l3.2835">         goDoCommand(&quot;cmd_ConvertToTable&quot;);</span>
<a href="#l3.2836"></a><span id="l3.2836">     } catch (e) {}</span>
<a href="#l3.2837"></a><span id="l3.2837">   }</span>
<a href="#l3.2838"></a><span id="l3.2838"> }</span>
<a href="#l3.2839"></a><span id="l3.2839"> </span>
<a href="#l3.2840"></a><span id="l3.2840" class="difflineminus">-function EditorInsertTable()</span>
<a href="#l3.2841"></a><span id="l3.2841" class="difflineminus">-{</span>
<a href="#l3.2842"></a><span id="l3.2842" class="difflineplus">+function EditorInsertTable() {</span>
<a href="#l3.2843"></a><span id="l3.2843">   // Insert a new table</span>
<a href="#l3.2844"></a><span id="l3.2844">   window.openDialog(&quot;chrome://editor/content/EdInsertTable.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l3.2845"></a><span id="l3.2845">   gContentWindow.focus();</span>
<a href="#l3.2846"></a><span id="l3.2846"> }</span>
<a href="#l3.2847"></a><span id="l3.2847"> </span>
<a href="#l3.2848"></a><span id="l3.2848" class="difflineminus">-function EditorTableCellProperties()</span>
<a href="#l3.2849"></a><span id="l3.2849" class="difflineminus">-{</span>
<a href="#l3.2850"></a><span id="l3.2850" class="difflineplus">+function EditorTableCellProperties() {</span>
<a href="#l3.2851"></a><span id="l3.2851">   if (!IsHTMLEditor())</span>
<a href="#l3.2852"></a><span id="l3.2852">     return;</span>
<a href="#l3.2853"></a><span id="l3.2853"> </span>
<a href="#l3.2854"></a><span id="l3.2854">   try {</span>
<a href="#l3.2855"></a><span id="l3.2855">     var cell = GetCurrentEditor().getElementOrParentByTagName(&quot;td&quot;, null);</span>
<a href="#l3.2856"></a><span id="l3.2856">     if (cell) {</span>
<a href="#l3.2857"></a><span id="l3.2857">       // Start Table Properties dialog on the &quot;Cell&quot; panel</span>
<a href="#l3.2858"></a><span id="l3.2858">       window.openDialog(&quot;chrome://editor/content/EdTableProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, &quot;CellPanel&quot;);</span>
<a href="#l3.2859"></a><span id="l3.2859">       gContentWindow.focus();</span>
<a href="#l3.2860"></a><span id="l3.2860">     }</span>
<a href="#l3.2861"></a><span id="l3.2861">   } catch (e) {}</span>
<a href="#l3.2862"></a><span id="l3.2862"> }</span>
<a href="#l3.2863"></a><span id="l3.2863"> </span>
<a href="#l3.2864"></a><span id="l3.2864" class="difflineminus">-function GetNumberOfContiguousSelectedRows()</span>
<a href="#l3.2865"></a><span id="l3.2865" class="difflineminus">-{</span>
<a href="#l3.2866"></a><span id="l3.2866" class="difflineplus">+function GetNumberOfContiguousSelectedRows() {</span>
<a href="#l3.2867"></a><span id="l3.2867">   if (!IsHTMLEditor())</span>
<a href="#l3.2868"></a><span id="l3.2868">     return 0;</span>
<a href="#l3.2869"></a><span id="l3.2869"> </span>
<a href="#l3.2870"></a><span id="l3.2870">   var rows = 0;</span>
<a href="#l3.2871"></a><span id="l3.2871">   try {</span>
<a href="#l3.2872"></a><span id="l3.2872">     var editor = GetCurrentTableEditor();</span>
<a href="#l3.2873"></a><span id="l3.2873">     var rowObj = { value: 0 };</span>
<a href="#l3.2874"></a><span id="l3.2874">     var colObj = { value: 0 };</span>
<a href="#l3.2875"></a><span id="l3.2875" class="difflineat">@@ -2806,36 +2530,33 @@ function GetNumberOfContiguousSelectedRo</span>
<a href="#l3.2876"></a><span id="l3.2876">     if (!cell)</span>
<a href="#l3.2877"></a><span id="l3.2877">       return 0;</span>
<a href="#l3.2878"></a><span id="l3.2878"> </span>
<a href="#l3.2879"></a><span id="l3.2879">     // We have at least one row</span>
<a href="#l3.2880"></a><span id="l3.2880">     rows++;</span>
<a href="#l3.2881"></a><span id="l3.2881"> </span>
<a href="#l3.2882"></a><span id="l3.2882">     var lastIndex = rowObj.value;</span>
<a href="#l3.2883"></a><span id="l3.2883">     do {</span>
<a href="#l3.2884"></a><span id="l3.2884" class="difflineminus">-      cell = editor.getNextSelectedCell({value:0});</span>
<a href="#l3.2885"></a><span id="l3.2885" class="difflineminus">-      if (cell)</span>
<a href="#l3.2886"></a><span id="l3.2886" class="difflineminus">-      {</span>
<a href="#l3.2887"></a><span id="l3.2887" class="difflineplus">+      cell = editor.getNextSelectedCell({value: 0});</span>
<a href="#l3.2888"></a><span id="l3.2888" class="difflineplus">+      if (cell) {</span>
<a href="#l3.2889"></a><span id="l3.2889">         editor.getCellIndexes(cell, rowObj, colObj);</span>
<a href="#l3.2890"></a><span id="l3.2890">         var index = rowObj.value;</span>
<a href="#l3.2891"></a><span id="l3.2891" class="difflineminus">-        if (index == lastIndex + 1)</span>
<a href="#l3.2892"></a><span id="l3.2892" class="difflineminus">-        {</span>
<a href="#l3.2893"></a><span id="l3.2893" class="difflineplus">+        if (index == lastIndex + 1) {</span>
<a href="#l3.2894"></a><span id="l3.2894">           lastIndex = index;</span>
<a href="#l3.2895"></a><span id="l3.2895">           rows++;</span>
<a href="#l3.2896"></a><span id="l3.2896">         }</span>
<a href="#l3.2897"></a><span id="l3.2897">       }</span>
<a href="#l3.2898"></a><span id="l3.2898">     }</span>
<a href="#l3.2899"></a><span id="l3.2899">     while (cell);</span>
<a href="#l3.2900"></a><span id="l3.2900">   } catch (e) {}</span>
<a href="#l3.2901"></a><span id="l3.2901"> </span>
<a href="#l3.2902"></a><span id="l3.2902">   return rows;</span>
<a href="#l3.2903"></a><span id="l3.2903"> }</span>
<a href="#l3.2904"></a><span id="l3.2904"> </span>
<a href="#l3.2905"></a><span id="l3.2905" class="difflineminus">-function GetNumberOfContiguousSelectedColumns()</span>
<a href="#l3.2906"></a><span id="l3.2906" class="difflineminus">-{</span>
<a href="#l3.2907"></a><span id="l3.2907" class="difflineplus">+function GetNumberOfContiguousSelectedColumns() {</span>
<a href="#l3.2908"></a><span id="l3.2908">   if (!IsHTMLEditor())</span>
<a href="#l3.2909"></a><span id="l3.2909">     return 0;</span>
<a href="#l3.2910"></a><span id="l3.2910"> </span>
<a href="#l3.2911"></a><span id="l3.2911">   var columns = 0;</span>
<a href="#l3.2912"></a><span id="l3.2912">   try {</span>
<a href="#l3.2913"></a><span id="l3.2913">     var editor = GetCurrentTableEditor();</span>
<a href="#l3.2914"></a><span id="l3.2914">     var colObj = { value: 0 };</span>
<a href="#l3.2915"></a><span id="l3.2915">     var rowObj = { value: 0 };</span>
<a href="#l3.2916"></a><span id="l3.2916" class="difflineat">@@ -2843,161 +2564,137 @@ function GetNumberOfContiguousSelectedCo</span>
<a href="#l3.2917"></a><span id="l3.2917">     if (!cell)</span>
<a href="#l3.2918"></a><span id="l3.2918">       return 0;</span>
<a href="#l3.2919"></a><span id="l3.2919"> </span>
<a href="#l3.2920"></a><span id="l3.2920">     // We have at least one column</span>
<a href="#l3.2921"></a><span id="l3.2921">     columns++;</span>
<a href="#l3.2922"></a><span id="l3.2922"> </span>
<a href="#l3.2923"></a><span id="l3.2923">     var lastIndex = colObj.value;</span>
<a href="#l3.2924"></a><span id="l3.2924">     do {</span>
<a href="#l3.2925"></a><span id="l3.2925" class="difflineminus">-      cell = editor.getNextSelectedCell({value:0});</span>
<a href="#l3.2926"></a><span id="l3.2926" class="difflineminus">-      if (cell)</span>
<a href="#l3.2927"></a><span id="l3.2927" class="difflineminus">-      {</span>
<a href="#l3.2928"></a><span id="l3.2928" class="difflineplus">+      cell = editor.getNextSelectedCell({value: 0});</span>
<a href="#l3.2929"></a><span id="l3.2929" class="difflineplus">+      if (cell) {</span>
<a href="#l3.2930"></a><span id="l3.2930">         editor.getCellIndexes(cell, rowObj, colObj);</span>
<a href="#l3.2931"></a><span id="l3.2931">         var index = colObj.value;</span>
<a href="#l3.2932"></a><span id="l3.2932" class="difflineminus">-        if (index == lastIndex +1)</span>
<a href="#l3.2933"></a><span id="l3.2933" class="difflineminus">-        {</span>
<a href="#l3.2934"></a><span id="l3.2934" class="difflineplus">+        if (index == lastIndex + 1) {</span>
<a href="#l3.2935"></a><span id="l3.2935">           lastIndex = index;</span>
<a href="#l3.2936"></a><span id="l3.2936">           columns++;</span>
<a href="#l3.2937"></a><span id="l3.2937">         }</span>
<a href="#l3.2938"></a><span id="l3.2938">       }</span>
<a href="#l3.2939"></a><span id="l3.2939">     }</span>
<a href="#l3.2940"></a><span id="l3.2940">     while (cell);</span>
<a href="#l3.2941"></a><span id="l3.2941">   } catch (e) {}</span>
<a href="#l3.2942"></a><span id="l3.2942"> </span>
<a href="#l3.2943"></a><span id="l3.2943">   return columns;</span>
<a href="#l3.2944"></a><span id="l3.2944"> }</span>
<a href="#l3.2945"></a><span id="l3.2945"> </span>
<a href="#l3.2946"></a><span id="l3.2946" class="difflineminus">-function EditorOnFocus()</span>
<a href="#l3.2947"></a><span id="l3.2947" class="difflineminus">-{</span>
<a href="#l3.2948"></a><span id="l3.2948" class="difflineplus">+function EditorOnFocus() {</span>
<a href="#l3.2949"></a><span id="l3.2949">   // Current window already has the InsertCharWindow</span>
<a href="#l3.2950"></a><span id="l3.2950">   if (&quot;InsertCharWindow&quot; in window &amp;&amp; window.InsertCharWindow) return;</span>
<a href="#l3.2951"></a><span id="l3.2951"> </span>
<a href="#l3.2952"></a><span id="l3.2952">   // Find window with an InsertCharsWindow and switch association to this one</span>
<a href="#l3.2953"></a><span id="l3.2953">   var windowWithDialog = FindEditorWithInsertCharDialog();</span>
<a href="#l3.2954"></a><span id="l3.2954" class="difflineminus">-  if (windowWithDialog)</span>
<a href="#l3.2955"></a><span id="l3.2955" class="difflineminus">-  {</span>
<a href="#l3.2956"></a><span id="l3.2956" class="difflineplus">+  if (windowWithDialog) {</span>
<a href="#l3.2957"></a><span id="l3.2957">     // Switch the dialog to current window</span>
<a href="#l3.2958"></a><span id="l3.2958">     // this sets focus to dialog, so bring focus back to editor window</span>
<a href="#l3.2959"></a><span id="l3.2959">     if (SwitchInsertCharToThisWindow(windowWithDialog))</span>
<a href="#l3.2960"></a><span id="l3.2960">       top.document.commandDispatcher.focusedWindow.focus();</span>
<a href="#l3.2961"></a><span id="l3.2961">   }</span>
<a href="#l3.2962"></a><span id="l3.2962"> }</span>
<a href="#l3.2963"></a><span id="l3.2963"> </span>
<a href="#l3.2964"></a><span id="l3.2964" class="difflineminus">-function SwitchInsertCharToThisWindow(windowWithDialog)</span>
<a href="#l3.2965"></a><span id="l3.2965" class="difflineminus">-{</span>
<a href="#l3.2966"></a><span id="l3.2966" class="difflineplus">+function SwitchInsertCharToThisWindow(windowWithDialog) {</span>
<a href="#l3.2967"></a><span id="l3.2967">   if (windowWithDialog &amp;&amp; &quot;InsertCharWindow&quot; in windowWithDialog &amp;&amp;</span>
<a href="#l3.2968"></a><span id="l3.2968" class="difflineminus">-      windowWithDialog.InsertCharWindow)</span>
<a href="#l3.2969"></a><span id="l3.2969" class="difflineminus">-  {</span>
<a href="#l3.2970"></a><span id="l3.2970" class="difflineplus">+      windowWithDialog.InsertCharWindow) {</span>
<a href="#l3.2971"></a><span id="l3.2971">     // Move dialog association to the current window</span>
<a href="#l3.2972"></a><span id="l3.2972">     window.InsertCharWindow = windowWithDialog.InsertCharWindow;</span>
<a href="#l3.2973"></a><span id="l3.2973">     windowWithDialog.InsertCharWindow = null;</span>
<a href="#l3.2974"></a><span id="l3.2974"> </span>
<a href="#l3.2975"></a><span id="l3.2975">     // Switch the dialog's opener to current window's</span>
<a href="#l3.2976"></a><span id="l3.2976">     window.InsertCharWindow.opener = window;</span>
<a href="#l3.2977"></a><span id="l3.2977"> </span>
<a href="#l3.2978"></a><span id="l3.2978">     // Bring dialog to the foreground</span>
<a href="#l3.2979"></a><span id="l3.2979">     window.InsertCharWindow.focus();</span>
<a href="#l3.2980"></a><span id="l3.2980">     return true;</span>
<a href="#l3.2981"></a><span id="l3.2981">   }</span>
<a href="#l3.2982"></a><span id="l3.2982">   return false;</span>
<a href="#l3.2983"></a><span id="l3.2983"> }</span>
<a href="#l3.2984"></a><span id="l3.2984"> </span>
<a href="#l3.2985"></a><span id="l3.2985" class="difflineminus">-function FindEditorWithInsertCharDialog()</span>
<a href="#l3.2986"></a><span id="l3.2986" class="difflineminus">-{</span>
<a href="#l3.2987"></a><span id="l3.2987" class="difflineplus">+function FindEditorWithInsertCharDialog() {</span>
<a href="#l3.2988"></a><span id="l3.2988">   try {</span>
<a href="#l3.2989"></a><span id="l3.2989">     // Find window with an InsertCharsWindow and switch association to this one</span>
<a href="#l3.2990"></a><span id="l3.2990">     let enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l3.2991"></a><span id="l3.2991"> </span>
<a href="#l3.2992"></a><span id="l3.2992" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l3.2993"></a><span id="l3.2993" class="difflineminus">-    {</span>
<a href="#l3.2994"></a><span id="l3.2994" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l3.2995"></a><span id="l3.2995">       var tempWindow = enumerator.getNext();</span>
<a href="#l3.2996"></a><span id="l3.2996"> </span>
<a href="#l3.2997"></a><span id="l3.2997">       if (tempWindow != window &amp;&amp; &quot;InsertCharWindow&quot; in tempWindow &amp;&amp;</span>
<a href="#l3.2998"></a><span id="l3.2998" class="difflineminus">-          tempWindow.InsertCharWindow)</span>
<a href="#l3.2999"></a><span id="l3.2999" class="difflineminus">-      {</span>
<a href="#l3.3000"></a><span id="l3.3000" class="difflineplus">+          tempWindow.InsertCharWindow) {</span>
<a href="#l3.3001"></a><span id="l3.3001">         return tempWindow;</span>
<a href="#l3.3002"></a><span id="l3.3002">       }</span>
<a href="#l3.3003"></a><span id="l3.3003">     }</span>
<a href="#l3.3004"></a><span id="l3.3004" class="difflineminus">-  }</span>
<a href="#l3.3005"></a><span id="l3.3005" class="difflineminus">-  catch(e) {}</span>
<a href="#l3.3006"></a><span id="l3.3006" class="difflineplus">+  } catch (e) {}</span>
<a href="#l3.3007"></a><span id="l3.3007">   return null;</span>
<a href="#l3.3008"></a><span id="l3.3008"> }</span>
<a href="#l3.3009"></a><span id="l3.3009"> </span>
<a href="#l3.3010"></a><span id="l3.3010" class="difflineminus">-function EditorFindOrCreateInsertCharWindow()</span>
<a href="#l3.3011"></a><span id="l3.3011" class="difflineminus">-{</span>
<a href="#l3.3012"></a><span id="l3.3012" class="difflineplus">+function EditorFindOrCreateInsertCharWindow() {</span>
<a href="#l3.3013"></a><span id="l3.3013">   if (&quot;InsertCharWindow&quot; in window &amp;&amp; window.InsertCharWindow)</span>
<a href="#l3.3014"></a><span id="l3.3014">     window.InsertCharWindow.focus();</span>
<a href="#l3.3015"></a><span id="l3.3015" class="difflineminus">-  else</span>
<a href="#l3.3016"></a><span id="l3.3016" class="difflineminus">-  {</span>
<a href="#l3.3017"></a><span id="l3.3017" class="difflineplus">+  else {</span>
<a href="#l3.3018"></a><span id="l3.3018">     // Since we switch the dialog during EditorOnFocus(),</span>
<a href="#l3.3019"></a><span id="l3.3019">     //   this should really never be found, but it's good to be sure</span>
<a href="#l3.3020"></a><span id="l3.3020">     var windowWithDialog = FindEditorWithInsertCharDialog();</span>
<a href="#l3.3021"></a><span id="l3.3021" class="difflineminus">-    if (windowWithDialog)</span>
<a href="#l3.3022"></a><span id="l3.3022" class="difflineminus">-    {</span>
<a href="#l3.3023"></a><span id="l3.3023" class="difflineplus">+    if (windowWithDialog) {</span>
<a href="#l3.3024"></a><span id="l3.3024">       SwitchInsertCharToThisWindow(windowWithDialog);</span>
<a href="#l3.3025"></a><span id="l3.3025" class="difflineminus">-    }</span>
<a href="#l3.3026"></a><span id="l3.3026" class="difflineminus">-    else</span>
<a href="#l3.3027"></a><span id="l3.3027" class="difflineminus">-    {</span>
<a href="#l3.3028"></a><span id="l3.3028" class="difflineplus">+    } else {</span>
<a href="#l3.3029"></a><span id="l3.3029">       // The dialog will set window.InsertCharWindow to itself</span>
<a href="#l3.3030"></a><span id="l3.3030">       window.openDialog(&quot;chrome://editor/content/EdInsertChars.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar&quot;, &quot;&quot;);</span>
<a href="#l3.3031"></a><span id="l3.3031">     }</span>
<a href="#l3.3032"></a><span id="l3.3032">   }</span>
<a href="#l3.3033"></a><span id="l3.3033"> }</span>
<a href="#l3.3034"></a><span id="l3.3034"> </span>
<a href="#l3.3035"></a><span id="l3.3035"> // Find another HTML editor window to associate with the InsertChar dialog</span>
<a href="#l3.3036"></a><span id="l3.3036"> //   or close it if none found  (May be a mail composer)</span>
<a href="#l3.3037"></a><span id="l3.3037" class="difflineminus">-function SwitchInsertCharToAnotherEditorOrClose()</span>
<a href="#l3.3038"></a><span id="l3.3038" class="difflineminus">-{</span>
<a href="#l3.3039"></a><span id="l3.3039" class="difflineminus">-  if (&quot;InsertCharWindow&quot; in window &amp;&amp; window.InsertCharWindow)</span>
<a href="#l3.3040"></a><span id="l3.3040" class="difflineminus">-  {</span>
<a href="#l3.3041"></a><span id="l3.3041" class="difflineplus">+function SwitchInsertCharToAnotherEditorOrClose() {</span>
<a href="#l3.3042"></a><span id="l3.3042" class="difflineplus">+  if (&quot;InsertCharWindow&quot; in window &amp;&amp; window.InsertCharWindow) {</span>
<a href="#l3.3043"></a><span id="l3.3043">     var enumerator;</span>
<a href="#l3.3044"></a><span id="l3.3044">     try {</span>
<a href="#l3.3045"></a><span id="l3.3045">       enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l3.3046"></a><span id="l3.3046" class="difflineminus">-    }</span>
<a href="#l3.3047"></a><span id="l3.3047" class="difflineminus">-    catch(e) {}</span>
<a href="#l3.3048"></a><span id="l3.3048" class="difflineplus">+    } catch (e) {}</span>
<a href="#l3.3049"></a><span id="l3.3049">     if (!enumerator) return;</span>
<a href="#l3.3050"></a><span id="l3.3050"> </span>
<a href="#l3.3051"></a><span id="l3.3051">     // TODO: Fix this to search for command controllers and look for &quot;cmd_InsertChars&quot;</span>
<a href="#l3.3052"></a><span id="l3.3052">     // For now, detect just Web Composer and HTML Mail Composer</span>
<a href="#l3.3053"></a><span id="l3.3053" class="difflineminus">-    while ( enumerator.hasMoreElements()  )</span>
<a href="#l3.3054"></a><span id="l3.3054" class="difflineminus">-    {</span>
<a href="#l3.3055"></a><span id="l3.3055" class="difflineminus">-      var  tempWindow = enumerator.getNext();</span>
<a href="#l3.3056"></a><span id="l3.3056" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l3.3057"></a><span id="l3.3057" class="difflineplus">+      var tempWindow = enumerator.getNext();</span>
<a href="#l3.3058"></a><span id="l3.3058">       if (tempWindow != window &amp;&amp; tempWindow != window.InsertCharWindow &amp;&amp;</span>
<a href="#l3.3059"></a><span id="l3.3059" class="difflineminus">-          &quot;GetCurrentEditor&quot; in tempWindow &amp;&amp; tempWindow.GetCurrentEditor())</span>
<a href="#l3.3060"></a><span id="l3.3060" class="difflineminus">-      {</span>
<a href="#l3.3061"></a><span id="l3.3061" class="difflineplus">+          &quot;GetCurrentEditor&quot; in tempWindow &amp;&amp; tempWindow.GetCurrentEditor()) {</span>
<a href="#l3.3062"></a><span id="l3.3062">         tempWindow.InsertCharWindow = window.InsertCharWindow;</span>
<a href="#l3.3063"></a><span id="l3.3063">         window.InsertCharWindow = null;</span>
<a href="#l3.3064"></a><span id="l3.3064">         tempWindow.InsertCharWindow.opener = tempWindow;</span>
<a href="#l3.3065"></a><span id="l3.3065">         return;</span>
<a href="#l3.3066"></a><span id="l3.3066">       }</span>
<a href="#l3.3067"></a><span id="l3.3067">     }</span>
<a href="#l3.3068"></a><span id="l3.3068">     // Didn't find another editor - close the dialog</span>
<a href="#l3.3069"></a><span id="l3.3069">     window.InsertCharWindow.close();</span>
<a href="#l3.3070"></a><span id="l3.3070">   }</span>
<a href="#l3.3071"></a><span id="l3.3071"> }</span>
<a href="#l3.3072"></a><span id="l3.3072"> </span>
<a href="#l3.3073"></a><span id="l3.3073" class="difflineminus">-function ResetStructToolbar()</span>
<a href="#l3.3074"></a><span id="l3.3074" class="difflineminus">-{</span>
<a href="#l3.3075"></a><span id="l3.3075" class="difflineplus">+function ResetStructToolbar() {</span>
<a href="#l3.3076"></a><span id="l3.3076">   gLastFocusNode = null;</span>
<a href="#l3.3077"></a><span id="l3.3077">   UpdateStructToolbar();</span>
<a href="#l3.3078"></a><span id="l3.3078"> }</span>
<a href="#l3.3079"></a><span id="l3.3079"> </span>
<a href="#l3.3080"></a><span id="l3.3080" class="difflineminus">-function newCommandListener(element)</span>
<a href="#l3.3081"></a><span id="l3.3081" class="difflineminus">-{</span>
<a href="#l3.3082"></a><span id="l3.3082" class="difflineplus">+function newCommandListener(element) {</span>
<a href="#l3.3083"></a><span id="l3.3083">   return function() { return SelectFocusNodeAncestor(element); };</span>
<a href="#l3.3084"></a><span id="l3.3084"> }</span>
<a href="#l3.3085"></a><span id="l3.3085"> </span>
<a href="#l3.3086"></a><span id="l3.3086" class="difflineminus">-function newContextmenuListener(button, element)</span>
<a href="#l3.3087"></a><span id="l3.3087" class="difflineminus">-{</span>
<a href="#l3.3088"></a><span id="l3.3088" class="difflineplus">+function newContextmenuListener(button, element) {</span>
<a href="#l3.3089"></a><span id="l3.3089">   return function() { return InitStructBarContextMenu(button, element); };</span>
<a href="#l3.3090"></a><span id="l3.3090"> }</span>
<a href="#l3.3091"></a><span id="l3.3091"> </span>
<a href="#l3.3092"></a><span id="l3.3092" class="difflineminus">-function UpdateStructToolbar()</span>
<a href="#l3.3093"></a><span id="l3.3093" class="difflineminus">-{</span>
<a href="#l3.3094"></a><span id="l3.3094" class="difflineplus">+function UpdateStructToolbar() {</span>
<a href="#l3.3095"></a><span id="l3.3095">   var editor = GetCurrentEditor();</span>
<a href="#l3.3096"></a><span id="l3.3096">   if (!editor) return;</span>
<a href="#l3.3097"></a><span id="l3.3097"> </span>
<a href="#l3.3098"></a><span id="l3.3098">   var mixed = GetSelectionContainer();</span>
<a href="#l3.3099"></a><span id="l3.3099">   if (!mixed) return;</span>
<a href="#l3.3100"></a><span id="l3.3100">   var element = mixed.node;</span>
<a href="#l3.3101"></a><span id="l3.3101">   var oneElementSelected = mixed.oneElementSelected;</span>
<a href="#l3.3102"></a><span id="l3.3102"> </span>
<a href="#l3.3103"></a><span id="l3.3103" class="difflineat">@@ -3014,82 +2711,77 @@ function UpdateStructToolbar()</span>
<a href="#l3.3104"></a><span id="l3.3104">   if (!toolbar) return;</span>
<a href="#l3.3105"></a><span id="l3.3105">   // We need to leave the &lt;label&gt; to flex the buttons to the left.</span>
<a href="#l3.3106"></a><span id="l3.3106">   for (let node of toolbar.querySelectorAll(&quot;toolbarbutton&quot;)) {</span>
<a href="#l3.3107"></a><span id="l3.3107">     node.remove();</span>
<a href="#l3.3108"></a><span id="l3.3108">   }</span>
<a href="#l3.3109"></a><span id="l3.3109"> </span>
<a href="#l3.3110"></a><span id="l3.3110">   toolbar.removeAttribute(&quot;label&quot;);</span>
<a href="#l3.3111"></a><span id="l3.3111"> </span>
<a href="#l3.3112"></a><span id="l3.3112" class="difflineminus">-  if ( IsInHTMLSourceMode() ) {</span>
<a href="#l3.3113"></a><span id="l3.3113" class="difflineplus">+  if (IsInHTMLSourceMode()) {</span>
<a href="#l3.3114"></a><span id="l3.3114">     // we have destroyed the contents of the status bar and are</span>
<a href="#l3.3115"></a><span id="l3.3115">     // about to recreate it ; but we don't want to do that in</span>
<a href="#l3.3116"></a><span id="l3.3116">     // Source mode</span>
<a href="#l3.3117"></a><span id="l3.3117">     return;</span>
<a href="#l3.3118"></a><span id="l3.3118">   }</span>
<a href="#l3.3119"></a><span id="l3.3119"> </span>
<a href="#l3.3120"></a><span id="l3.3120">   var tag, button;</span>
<a href="#l3.3121"></a><span id="l3.3121">   var bodyElement = GetBodyElement();</span>
<a href="#l3.3122"></a><span id="l3.3122">   var isFocusNode = true;</span>
<a href="#l3.3123"></a><span id="l3.3123">   var tmp;</span>
<a href="#l3.3124"></a><span id="l3.3124">   do {</span>
<a href="#l3.3125"></a><span id="l3.3125">     tag = element.nodeName.toLowerCase();</span>
<a href="#l3.3126"></a><span id="l3.3126"> </span>
<a href="#l3.3127"></a><span id="l3.3127">     button = document.createElementNS(XUL_NS, &quot;toolbarbutton&quot;);</span>
<a href="#l3.3128"></a><span id="l3.3128" class="difflineminus">-    button.setAttribute(&quot;label&quot;,   &quot;&lt;&quot; + tag + &quot;&gt;&quot;);</span>
<a href="#l3.3129"></a><span id="l3.3129" class="difflineminus">-    button.setAttribute(&quot;value&quot;,   tag);</span>
<a href="#l3.3130"></a><span id="l3.3130" class="difflineplus">+    button.setAttribute(&quot;label&quot;, &quot;&lt;&quot; + tag + &quot;&gt;&quot;);</span>
<a href="#l3.3131"></a><span id="l3.3131" class="difflineplus">+    button.setAttribute(&quot;value&quot;, tag);</span>
<a href="#l3.3132"></a><span id="l3.3132">     button.setAttribute(&quot;context&quot;, &quot;structToolbarContext&quot;);</span>
<a href="#l3.3133"></a><span id="l3.3133">     button.className = &quot;struct-button&quot;;</span>
<a href="#l3.3134"></a><span id="l3.3134"> </span>
<a href="#l3.3135"></a><span id="l3.3135">     toolbar.insertBefore(button, toolbar.firstChild);</span>
<a href="#l3.3136"></a><span id="l3.3136"> </span>
<a href="#l3.3137"></a><span id="l3.3137">     button.addEventListener(&quot;command&quot;, newCommandListener(element));</span>
<a href="#l3.3138"></a><span id="l3.3138"> </span>
<a href="#l3.3139"></a><span id="l3.3139">     button.addEventListener(&quot;contextmenu&quot;, newContextmenuListener(button, element));</span>
<a href="#l3.3140"></a><span id="l3.3140"> </span>
<a href="#l3.3141"></a><span id="l3.3141">     if (isFocusNode &amp;&amp; oneElementSelected) {</span>
<a href="#l3.3142"></a><span id="l3.3142">       button.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.3143"></a><span id="l3.3143">       isFocusNode = false;</span>
<a href="#l3.3144"></a><span id="l3.3144">     }</span>
<a href="#l3.3145"></a><span id="l3.3145"> </span>
<a href="#l3.3146"></a><span id="l3.3146">     tmp = element;</span>
<a href="#l3.3147"></a><span id="l3.3147">     element = element.parentNode;</span>
<a href="#l3.3148"></a><span id="l3.3148" class="difflineminus">-</span>
<a href="#l3.3149"></a><span id="l3.3149">   } while (tmp != bodyElement);</span>
<a href="#l3.3150"></a><span id="l3.3150"> }</span>
<a href="#l3.3151"></a><span id="l3.3151"> </span>
<a href="#l3.3152"></a><span id="l3.3152" class="difflineminus">-function SelectFocusNodeAncestor(element)</span>
<a href="#l3.3153"></a><span id="l3.3153" class="difflineminus">-{</span>
<a href="#l3.3154"></a><span id="l3.3154" class="difflineplus">+function SelectFocusNodeAncestor(element) {</span>
<a href="#l3.3155"></a><span id="l3.3155">   var editor = GetCurrentEditor();</span>
<a href="#l3.3156"></a><span id="l3.3156">   if (editor) {</span>
<a href="#l3.3157"></a><span id="l3.3157">     if (element == GetBodyElement())</span>
<a href="#l3.3158"></a><span id="l3.3158">       editor.selectAll();</span>
<a href="#l3.3159"></a><span id="l3.3159">     else</span>
<a href="#l3.3160"></a><span id="l3.3160">       editor.selectElement(element);</span>
<a href="#l3.3161"></a><span id="l3.3161">   }</span>
<a href="#l3.3162"></a><span id="l3.3162">   ResetStructToolbar();</span>
<a href="#l3.3163"></a><span id="l3.3163"> }</span>
<a href="#l3.3164"></a><span id="l3.3164"> </span>
<a href="#l3.3165"></a><span id="l3.3165" class="difflineminus">-function GetSelectionContainer()</span>
<a href="#l3.3166"></a><span id="l3.3166" class="difflineminus">-{</span>
<a href="#l3.3167"></a><span id="l3.3167" class="difflineplus">+function GetSelectionContainer() {</span>
<a href="#l3.3168"></a><span id="l3.3168">   var editor = GetCurrentEditor();</span>
<a href="#l3.3169"></a><span id="l3.3169">   if (!editor) return null;</span>
<a href="#l3.3170"></a><span id="l3.3170"> </span>
<a href="#l3.3171"></a><span id="l3.3171">   try {</span>
<a href="#l3.3172"></a><span id="l3.3172">     var selection = editor.selection;</span>
<a href="#l3.3173"></a><span id="l3.3173">     if (!selection) return null;</span>
<a href="#l3.3174"></a><span id="l3.3174" class="difflineminus">-  }</span>
<a href="#l3.3175"></a><span id="l3.3175" class="difflineminus">-  catch (e) { return null; }</span>
<a href="#l3.3176"></a><span id="l3.3176" class="difflineminus">-</span>
<a href="#l3.3177"></a><span id="l3.3177" class="difflineminus">-  var result = { oneElementSelected:false };</span>
<a href="#l3.3178"></a><span id="l3.3178" class="difflineplus">+  } catch (e) { return null; }</span>
<a href="#l3.3179"></a><span id="l3.3179" class="difflineplus">+</span>
<a href="#l3.3180"></a><span id="l3.3180" class="difflineplus">+  var result = { oneElementSelected: false };</span>
<a href="#l3.3181"></a><span id="l3.3181"> </span>
<a href="#l3.3182"></a><span id="l3.3182">   if (selection.isCollapsed) {</span>
<a href="#l3.3183"></a><span id="l3.3183">     result.node = selection.focusNode;</span>
<a href="#l3.3184"></a><span id="l3.3184" class="difflineminus">-  }</span>
<a href="#l3.3185"></a><span id="l3.3185" class="difflineminus">-  else {</span>
<a href="#l3.3186"></a><span id="l3.3186" class="difflineplus">+  } else {</span>
<a href="#l3.3187"></a><span id="l3.3187">     var rangeCount = selection.rangeCount;</span>
<a href="#l3.3188"></a><span id="l3.3188">     if (rangeCount == 1) {</span>
<a href="#l3.3189"></a><span id="l3.3189">       result.node = editor.getSelectedElement(&quot;&quot;);</span>
<a href="#l3.3190"></a><span id="l3.3190">       var range = selection.getRangeAt(0);</span>
<a href="#l3.3191"></a><span id="l3.3191"> </span>
<a href="#l3.3192"></a><span id="l3.3192">       // check for a weird case : when we select a piece of text inside</span>
<a href="#l3.3193"></a><span id="l3.3193">       // a text node and apply an inline style to it, the selection starts</span>
<a href="#l3.3194"></a><span id="l3.3194">       // at the end of the text node preceding the style and ends after the</span>
<a href="#l3.3195"></a><span id="l3.3195" class="difflineat">@@ -3102,30 +2794,27 @@ function GetSelectionContainer()</span>
<a href="#l3.3196"></a><span id="l3.3196">           range.endOffset == range.endContainer.length &amp;&amp;</span>
<a href="#l3.3197"></a><span id="l3.3197">           range.endContainer.nextSibling == null &amp;&amp;</span>
<a href="#l3.3198"></a><span id="l3.3198">           range.startContainer.nextSibling == range.endContainer.parentNode)</span>
<a href="#l3.3199"></a><span id="l3.3199">         result.node = range.endContainer.parentNode;</span>
<a href="#l3.3200"></a><span id="l3.3200"> </span>
<a href="#l3.3201"></a><span id="l3.3201">       if (!result.node) {</span>
<a href="#l3.3202"></a><span id="l3.3202">         // let's rely on the common ancestor of the selection</span>
<a href="#l3.3203"></a><span id="l3.3203">         result.node = range.commonAncestorContainer;</span>
<a href="#l3.3204"></a><span id="l3.3204" class="difflineminus">-      }</span>
<a href="#l3.3205"></a><span id="l3.3205" class="difflineminus">-      else {</span>
<a href="#l3.3206"></a><span id="l3.3206" class="difflineplus">+      } else {</span>
<a href="#l3.3207"></a><span id="l3.3207">         result.oneElementSelected = true;</span>
<a href="#l3.3208"></a><span id="l3.3208">       }</span>
<a href="#l3.3209"></a><span id="l3.3209" class="difflineminus">-    }</span>
<a href="#l3.3210"></a><span id="l3.3210" class="difflineminus">-    else {</span>
<a href="#l3.3211"></a><span id="l3.3211" class="difflineplus">+    } else {</span>
<a href="#l3.3212"></a><span id="l3.3212">       // assume table cells !</span>
<a href="#l3.3213"></a><span id="l3.3213">       var i, container = null;</span>
<a href="#l3.3214"></a><span id="l3.3214">       for (i = 0; i &lt; rangeCount; i++) {</span>
<a href="#l3.3215"></a><span id="l3.3215">         range = selection.getRangeAt(i);</span>
<a href="#l3.3216"></a><span id="l3.3216">         if (!container) {</span>
<a href="#l3.3217"></a><span id="l3.3217">           container = range.startContainer;</span>
<a href="#l3.3218"></a><span id="l3.3218" class="difflineminus">-        }</span>
<a href="#l3.3219"></a><span id="l3.3219" class="difflineminus">-        else if (container != range.startContainer) {</span>
<a href="#l3.3220"></a><span id="l3.3220" class="difflineplus">+        } else if (container != range.startContainer) {</span>
<a href="#l3.3221"></a><span id="l3.3221">           // all table cells don't belong to same row so let's</span>
<a href="#l3.3222"></a><span id="l3.3222">           // select the parent of all rows</span>
<a href="#l3.3223"></a><span id="l3.3223">           result.node = container.parentNode;</span>
<a href="#l3.3224"></a><span id="l3.3224">           break;</span>
<a href="#l3.3225"></a><span id="l3.3225">         }</span>
<a href="#l3.3226"></a><span id="l3.3226">         result.node = container;</span>
<a href="#l3.3227"></a><span id="l3.3227">       }</span>
<a href="#l3.3228"></a><span id="l3.3228">     }</span>
<a href="#l3.3229"></a><span id="l3.3229" class="difflineat">@@ -3140,18 +2829,17 @@ function GetSelectionContainer()</span>
<a href="#l3.3230"></a><span id="l3.3230">   // and don't select anonymous content !!! (fix for bug 190279)</span>
<a href="#l3.3231"></a><span id="l3.3231">   while (result.node.hasAttribute(&quot;_moz_editor_bogus_node&quot;) ||</span>
<a href="#l3.3232"></a><span id="l3.3232">          editor.isAnonymousElement(result.node))</span>
<a href="#l3.3233"></a><span id="l3.3233">     result.node = result.node.parentNode;</span>
<a href="#l3.3234"></a><span id="l3.3234"> </span>
<a href="#l3.3235"></a><span id="l3.3235">   return result;</span>
<a href="#l3.3236"></a><span id="l3.3236"> }</span>
<a href="#l3.3237"></a><span id="l3.3237"> </span>
<a href="#l3.3238"></a><span id="l3.3238" class="difflineminus">-function FillInHTMLTooltipEditor(tooltip)</span>
<a href="#l3.3239"></a><span id="l3.3239" class="difflineminus">-{</span>
<a href="#l3.3240"></a><span id="l3.3240" class="difflineplus">+function FillInHTMLTooltipEditor(tooltip) {</span>
<a href="#l3.3241"></a><span id="l3.3241">   const XLinkNS = &quot;http://www.w3.org/1999/xlink&quot;;</span>
<a href="#l3.3242"></a><span id="l3.3242">   var tooltipText = null;</span>
<a href="#l3.3243"></a><span id="l3.3243">   var node;</span>
<a href="#l3.3244"></a><span id="l3.3244">   if (IsInPreviewMode()) {</span>
<a href="#l3.3245"></a><span id="l3.3245">     for (node = document.tooltipNode; node; node = node.parentNode) {</span>
<a href="#l3.3246"></a><span id="l3.3246">       if (node.nodeType == Node.ELEMENT_NODE) {</span>
<a href="#l3.3247"></a><span id="l3.3247">         tooltipText = node.getAttributeNS(XLinkNS, &quot;title&quot;);</span>
<a href="#l3.3248"></a><span id="l3.3248">         if (tooltipText &amp;&amp; /\S/.test(tooltipText)) {</span>
<a href="#l3.3249"></a><span id="l3.3249" class="difflineat">@@ -3176,45 +2864,41 @@ function FillInHTMLTooltipEditor(tooltip</span>
<a href="#l3.3250"></a><span id="l3.3250">         tooltip.setAttribute(&quot;label&quot;, tooltipText);</span>
<a href="#l3.3251"></a><span id="l3.3251">         return true;</span>
<a href="#l3.3252"></a><span id="l3.3252">       }</span>
<a href="#l3.3253"></a><span id="l3.3253">     }</span>
<a href="#l3.3254"></a><span id="l3.3254">   }</span>
<a href="#l3.3255"></a><span id="l3.3255">   return false;</span>
<a href="#l3.3256"></a><span id="l3.3256"> }</span>
<a href="#l3.3257"></a><span id="l3.3257"> </span>
<a href="#l3.3258"></a><span id="l3.3258" class="difflineminus">-function UpdateTOC()</span>
<a href="#l3.3259"></a><span id="l3.3259" class="difflineminus">-{</span>
<a href="#l3.3260"></a><span id="l3.3260" class="difflineplus">+function UpdateTOC() {</span>
<a href="#l3.3261"></a><span id="l3.3261">   window.openDialog(&quot;chrome://editor/content/EdInsertTOC.xul&quot;,</span>
<a href="#l3.3262"></a><span id="l3.3262">                     &quot;_blank&quot;, &quot;chrome,close,modal,titlebar&quot;);</span>
<a href="#l3.3263"></a><span id="l3.3263">   window.content.focus();</span>
<a href="#l3.3264"></a><span id="l3.3264"> }</span>
<a href="#l3.3265"></a><span id="l3.3265"> </span>
<a href="#l3.3266"></a><span id="l3.3266" class="difflineminus">-function InitTOCMenu()</span>
<a href="#l3.3267"></a><span id="l3.3267" class="difflineminus">-{</span>
<a href="#l3.3268"></a><span id="l3.3268" class="difflineplus">+function InitTOCMenu() {</span>
<a href="#l3.3269"></a><span id="l3.3269">   var elt = GetCurrentEditor().document.getElementById(&quot;mozToc&quot;);</span>
<a href="#l3.3270"></a><span id="l3.3270">   var createMenuitem = document.getElementById(&quot;insertTOCMenuitem&quot;);</span>
<a href="#l3.3271"></a><span id="l3.3271">   var updateMenuitem = document.getElementById(&quot;updateTOCMenuitem&quot;);</span>
<a href="#l3.3272"></a><span id="l3.3272">   var removeMenuitem = document.getElementById(&quot;removeTOCMenuitem&quot;);</span>
<a href="#l3.3273"></a><span id="l3.3273">   if (removeMenuitem &amp;&amp; createMenuitem &amp;&amp; updateMenuitem) {</span>
<a href="#l3.3274"></a><span id="l3.3274">     if (elt) {</span>
<a href="#l3.3275"></a><span id="l3.3275">       createMenuitem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.3276"></a><span id="l3.3276">       updateMenuitem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.3277"></a><span id="l3.3277">       removeMenuitem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.3278"></a><span id="l3.3278" class="difflineminus">-    }</span>
<a href="#l3.3279"></a><span id="l3.3279" class="difflineminus">-    else {</span>
<a href="#l3.3280"></a><span id="l3.3280" class="difflineplus">+    } else {</span>
<a href="#l3.3281"></a><span id="l3.3281">       createMenuitem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.3282"></a><span id="l3.3282">       removeMenuitem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.3283"></a><span id="l3.3283">       updateMenuitem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.3284"></a><span id="l3.3284">     }</span>
<a href="#l3.3285"></a><span id="l3.3285">   }</span>
<a href="#l3.3286"></a><span id="l3.3286"> }</span>
<a href="#l3.3287"></a><span id="l3.3287"> </span>
<a href="#l3.3288"></a><span id="l3.3288" class="difflineminus">-function RemoveTOC()</span>
<a href="#l3.3289"></a><span id="l3.3289" class="difflineminus">-{</span>
<a href="#l3.3290"></a><span id="l3.3290" class="difflineplus">+function RemoveTOC() {</span>
<a href="#l3.3291"></a><span id="l3.3291">   var theDocument = GetCurrentEditor().document;</span>
<a href="#l3.3292"></a><span id="l3.3292">   var elt = theDocument.getElementById(&quot;mozToc&quot;);</span>
<a href="#l3.3293"></a><span id="l3.3293">   if (elt) {</span>
<a href="#l3.3294"></a><span id="l3.3294">     elt.remove();</span>
<a href="#l3.3295"></a><span id="l3.3295">   }</span>
<a href="#l3.3296"></a><span id="l3.3296"> </span>
<a href="#l3.3297"></a><span id="l3.3297">   let anchorNodes = theDocument.querySelectorAll('a[name^=&quot;mozTocId&quot;]');</span>
<a href="#l3.3298"></a><span id="l3.3298">   for (let node of anchorNodes) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/editor/ui/composer/content/editorUtilities.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/editor/ui/composer/content/editorUtilities.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-/**** NAMESPACES ****/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+/** ** NAMESPACES ****/</span>
<a href="#l4.13"></a><span id="l4.13"> const XUL_NS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> // Each editor window must include this file</span>
<a href="#l4.16"></a><span id="l4.16"> // Variables  shared by all dialogs:</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> // Object to attach commonly-used widgets (all dialogs should use this)</span>
<a href="#l4.19"></a><span id="l4.19"> var gDialog = {};</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -21,174 +21,157 @@ var kOutputEncodeW3CEntities = Ci.nsIDoc</span>
<a href="#l4.22"></a><span id="l4.22"> var kOutputFormatted = Ci.nsIDocumentEncoder.OutputFormatted;</span>
<a href="#l4.23"></a><span id="l4.23"> var kOutputLFLineBreak = Ci.nsIDocumentEncoder.OutputLFLineBreak;</span>
<a href="#l4.24"></a><span id="l4.24"> var kOutputSelectionOnly = Ci.nsIDocumentEncoder.OutputSelectionOnly;</span>
<a href="#l4.25"></a><span id="l4.25"> var kOutputWrap = Ci.nsIDocumentEncoder.OutputWrap;</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> var gStringBundle;</span>
<a href="#l4.28"></a><span id="l4.28"> var gFilePickerDirectory;</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-/************* Message dialogs ***************/</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+/** *********** Message dialogs ***************/</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33"> // Optional: Caller may supply text to substitute for &quot;Ok&quot; and/or &quot;Cancel&quot;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-function ConfirmWithTitle(title, message, okButtonText, cancelButtonText)</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-{</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+function ConfirmWithTitle(title, message, okButtonText, cancelButtonText) {</span>
<a href="#l4.37"></a><span id="l4.37">   let okFlag = okButtonText ? Services.prompt.BUTTON_TITLE_IS_STRING : Services.prompt.BUTTON_TITLE_OK;</span>
<a href="#l4.38"></a><span id="l4.38">   let cancelFlag = cancelButtonText ? Services.prompt.BUTTON_TITLE_IS_STRING : Services.prompt.BUTTON_TITLE_CANCEL;</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">   return Services.prompt.confirmEx(window, title, message,</span>
<a href="#l4.41"></a><span id="l4.41">                                    (okFlag * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l4.42"></a><span id="l4.42">                                    (cancelFlag * Services.prompt.BUTTON_POS_1),</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-                                   okButtonText, cancelButtonText, null, null, {value:0}) == 0;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+                                   okButtonText, cancelButtonText, null, null, {value: 0}) == 0;</span>
<a href="#l4.45"></a><span id="l4.45"> }</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-/************* String Utilities ***************/</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+/** *********** String Utilities ***************/</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-function GetString(name)</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-{</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-  if (!gStringBundle)</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  {</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+function GetString(name) {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  if (!gStringBundle) {</span>
<a href="#l4.56"></a><span id="l4.56">     try {</span>
<a href="#l4.57"></a><span id="l4.57">       gStringBundle = Services.strings.createBundle(&quot;chrome://editor/locale/editor.properties&quot;);</span>
<a href="#l4.58"></a><span id="l4.58">     } catch (ex) {}</span>
<a href="#l4.59"></a><span id="l4.59">   }</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-  if (gStringBundle)</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-  {</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  if (gStringBundle) {</span>
<a href="#l4.63"></a><span id="l4.63">     try {</span>
<a href="#l4.64"></a><span id="l4.64">       return gStringBundle.GetStringFromName(name);</span>
<a href="#l4.65"></a><span id="l4.65">     } catch (e) {}</span>
<a href="#l4.66"></a><span id="l4.66">   }</span>
<a href="#l4.67"></a><span id="l4.67">   return null;</span>
<a href="#l4.68"></a><span id="l4.68"> }</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-function GetFormattedString(aName, aVal)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-{</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-  if (!gStringBundle)</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-  {</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+function GetFormattedString(aName, aVal) {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  if (!gStringBundle) {</span>
<a href="#l4.76"></a><span id="l4.76">     try {</span>
<a href="#l4.77"></a><span id="l4.77">       gStringBundle = Services.strings.createBundle(&quot;chrome://editor/locale/editor.properties&quot;);</span>
<a href="#l4.78"></a><span id="l4.78">     } catch (ex) {}</span>
<a href="#l4.79"></a><span id="l4.79">   }</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-  if (gStringBundle)</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  {</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  if (gStringBundle) {</span>
<a href="#l4.83"></a><span id="l4.83">     try {</span>
<a href="#l4.84"></a><span id="l4.84">       return gStringBundle.formatStringFromName(aName, [aVal], 1);</span>
<a href="#l4.85"></a><span id="l4.85">     } catch (e) {}</span>
<a href="#l4.86"></a><span id="l4.86">   }</span>
<a href="#l4.87"></a><span id="l4.87">   return null;</span>
<a href="#l4.88"></a><span id="l4.88"> }</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-function TrimStringLeft(string)</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-{</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+function TrimStringLeft(string) {</span>
<a href="#l4.93"></a><span id="l4.93">   if (!string)</span>
<a href="#l4.94"></a><span id="l4.94">     return &quot;&quot;;</span>
<a href="#l4.95"></a><span id="l4.95">   return string.trimLeft();</span>
<a href="#l4.96"></a><span id="l4.96"> }</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-function TrimStringRight(string)</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-{</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+function TrimStringRight(string) {</span>
<a href="#l4.101"></a><span id="l4.101">   if (!string)</span>
<a href="#l4.102"></a><span id="l4.102">     return &quot;&quot;;</span>
<a href="#l4.103"></a><span id="l4.103">   return string.trimRight();</span>
<a href="#l4.104"></a><span id="l4.104"> }</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106"> // Remove whitespace from both ends of a string</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-function TrimString(string)</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-{</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+function TrimString(string) {</span>
<a href="#l4.110"></a><span id="l4.110">   if (!string)</span>
<a href="#l4.111"></a><span id="l4.111">     return &quot;&quot;;</span>
<a href="#l4.112"></a><span id="l4.112">   return string.trim();</span>
<a href="#l4.113"></a><span id="l4.113"> }</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-function TruncateStringAtWordEnd(string, maxLength, addEllipses)</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-{</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+function TruncateStringAtWordEnd(string, maxLength, addEllipses) {</span>
<a href="#l4.118"></a><span id="l4.118">   // Return empty if string is null, undefined, or the empty string</span>
<a href="#l4.119"></a><span id="l4.119">   if (!string)</span>
<a href="#l4.120"></a><span id="l4.120">     return &quot;&quot;;</span>
<a href="#l4.121"></a><span id="l4.121"> </span>
<a href="#l4.122"></a><span id="l4.122">   // We assume they probably don't want whitespace at the beginning</span>
<a href="#l4.123"></a><span id="l4.123">   string = string.trimLeft();</span>
<a href="#l4.124"></a><span id="l4.124">   if (string.length &lt;= maxLength)</span>
<a href="#l4.125"></a><span id="l4.125">     return string;</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127">   // We need to truncate the string to maxLength or fewer chars</span>
<a href="#l4.128"></a><span id="l4.128">   if (addEllipses)</span>
<a href="#l4.129"></a><span id="l4.129">     maxLength -= 3;</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-  string = string.replace(RegExp(&quot;(.{0,&quot; + maxLength + &quot;})\\s.*&quot;), &quot;$1&quot;)</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+  string = string.replace(RegExp(&quot;(.{0,&quot; + maxLength + &quot;})\\s.*&quot;), &quot;$1&quot;);</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133">   if (string.length &gt; maxLength)</span>
<a href="#l4.134"></a><span id="l4.134">     string = string.slice(0, maxLength);</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136">   if (addEllipses)</span>
<a href="#l4.137"></a><span id="l4.137">     string += &quot;...&quot;;</span>
<a href="#l4.138"></a><span id="l4.138">   return string;</span>
<a href="#l4.139"></a><span id="l4.139"> }</span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141"> // Replace all whitespace characters with supplied character</span>
<a href="#l4.142"></a><span id="l4.142"> // E.g.: Use charReplace = &quot; &quot;, to &quot;unwrap&quot; the string by removing line-end chars</span>
<a href="#l4.143"></a><span id="l4.143"> //       Use charReplace = &quot;_&quot; when you don't want spaces (like in a URL)</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-function ReplaceWhitespace(string, charReplace)</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-{</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+function ReplaceWhitespace(string, charReplace) {</span>
<a href="#l4.147"></a><span id="l4.147">   return string.trim().replace(/\s+/g, charReplace);</span>
<a href="#l4.148"></a><span id="l4.148"> }</span>
<a href="#l4.149"></a><span id="l4.149"> </span>
<a href="#l4.150"></a><span id="l4.150"> // Replace whitespace with &quot;_&quot; and allow only HTML CDATA</span>
<a href="#l4.151"></a><span id="l4.151"> //   characters: &quot;a&quot;-&quot;z&quot;,&quot;A&quot;-&quot;Z&quot;,&quot;0&quot;-&quot;9&quot;, &quot;_&quot;, &quot;:&quot;, &quot;-&quot;, &quot;.&quot;,</span>
<a href="#l4.152"></a><span id="l4.152"> //   and characters above ASCII 127</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-function ConvertToCDATAString(string)</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-{</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-  return string.replace(/\s+/g,&quot;_&quot;).replace(/[^a-zA-Z0-9_\.\-\:\u0080-\uFFFF]+/g,'');</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+function ConvertToCDATAString(string) {</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  return string.replace(/\s+/g, &quot;_&quot;).replace(/[^a-zA-Z0-9_\.\-\:\u0080-\uFFFF]+/g, &quot;&quot;);</span>
<a href="#l4.158"></a><span id="l4.158"> }</span>
<a href="#l4.159"></a><span id="l4.159"> </span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-function GetSelectionAsText()</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-{</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+function GetSelectionAsText() {</span>
<a href="#l4.163"></a><span id="l4.163">   try {</span>
<a href="#l4.164"></a><span id="l4.164">     return GetCurrentEditor().outputToString(&quot;text/plain&quot;, kOutputSelectionOnly);</span>
<a href="#l4.165"></a><span id="l4.165">   } catch (e) {}</span>
<a href="#l4.166"></a><span id="l4.166"> </span>
<a href="#l4.167"></a><span id="l4.167">   return &quot;&quot;;</span>
<a href="#l4.168"></a><span id="l4.168"> }</span>
<a href="#l4.169"></a><span id="l4.169"> </span>
<a href="#l4.170"></a><span id="l4.170"> </span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-/************* Get Current Editor and associated interfaces or info ***************/</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+/** *********** Get Current Editor and associated interfaces or info ***************/</span>
<a href="#l4.173"></a><span id="l4.173"> const nsIPlaintextEditor = Ci.nsIPlaintextEditor;</span>
<a href="#l4.174"></a><span id="l4.174"> const nsIHTMLEditor = Ci.nsIHTMLEditor;</span>
<a href="#l4.175"></a><span id="l4.175"> const nsITableEditor = Ci.nsITableEditor;</span>
<a href="#l4.176"></a><span id="l4.176"> const nsIEditorStyleSheets = Ci.nsIEditorStyleSheets;</span>
<a href="#l4.177"></a><span id="l4.177"> const nsIEditingSession = Ci.nsIEditingSession;</span>
<a href="#l4.178"></a><span id="l4.178"> </span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-function GetCurrentEditor()</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-{</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+function GetCurrentEditor() {</span>
<a href="#l4.182"></a><span id="l4.182">   // Get the active editor from the &lt;editor&gt; tag</span>
<a href="#l4.183"></a><span id="l4.183">   // XXX This will probably change if we support &gt; 1 editor in main Composer window</span>
<a href="#l4.184"></a><span id="l4.184">   //      (e.g. a plaintext editor for HTMLSource)</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186">   // For dialogs: Search up parent chain to find top window with editor</span>
<a href="#l4.187"></a><span id="l4.187">   var editor;</span>
<a href="#l4.188"></a><span id="l4.188">   try {</span>
<a href="#l4.189"></a><span id="l4.189">     var editorElement = GetCurrentEditorElement();</span>
<a href="#l4.190"></a><span id="l4.190">     editor = editorElement.getEditor(editorElement.contentWindow);</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192">     // Do QIs now so editor users won't have to figure out which interface to use</span>
<a href="#l4.193"></a><span id="l4.193">     // Using &quot;instanceof&quot; does the QI for us.</span>
<a href="#l4.194"></a><span id="l4.194">     editor instanceof Ci.nsIPlaintextEditor;</span>
<a href="#l4.195"></a><span id="l4.195">     editor instanceof Ci.nsIHTMLEditor;</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-  } catch (e) { dump (e)+&quot;\n&quot;; }</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+  } catch (e) { dump(e) + &quot;\n&quot;; }</span>
<a href="#l4.198"></a><span id="l4.198"> </span>
<a href="#l4.199"></a><span id="l4.199">   return editor;</span>
<a href="#l4.200"></a><span id="l4.200"> }</span>
<a href="#l4.201"></a><span id="l4.201"> </span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-function GetCurrentTableEditor()</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-{</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+function GetCurrentTableEditor() {</span>
<a href="#l4.205"></a><span id="l4.205">   var editor = GetCurrentEditor();</span>
<a href="#l4.206"></a><span id="l4.206">   return (editor &amp;&amp; (editor instanceof nsITableEditor)) ? editor : null;</span>
<a href="#l4.207"></a><span id="l4.207"> }</span>
<a href="#l4.208"></a><span id="l4.208"> </span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-function GetCurrentEditorElement()</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-{</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+function GetCurrentEditorElement() {</span>
<a href="#l4.212"></a><span id="l4.212">   var tmpWindow = window;</span>
<a href="#l4.213"></a><span id="l4.213"> </span>
<a href="#l4.214"></a><span id="l4.214">   do {</span>
<a href="#l4.215"></a><span id="l4.215">     // Get the &lt;editor&gt; element(s)</span>
<a href="#l4.216"></a><span id="l4.216">     let editorItem = tmpWindow.document.querySelector(&quot;editor&quot;);</span>
<a href="#l4.217"></a><span id="l4.217"> </span>
<a href="#l4.218"></a><span id="l4.218">     // This will change if we support &gt; 1 editor element</span>
<a href="#l4.219"></a><span id="l4.219">     if (editorItem)</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineat">@@ -196,239 +179,202 @@ function GetCurrentEditorElement()</span>
<a href="#l4.221"></a><span id="l4.221"> </span>
<a href="#l4.222"></a><span id="l4.222">     tmpWindow = tmpWindow.opener;</span>
<a href="#l4.223"></a><span id="l4.223">   }</span>
<a href="#l4.224"></a><span id="l4.224">   while (tmpWindow);</span>
<a href="#l4.225"></a><span id="l4.225"> </span>
<a href="#l4.226"></a><span id="l4.226">   return null;</span>
<a href="#l4.227"></a><span id="l4.227"> }</span>
<a href="#l4.228"></a><span id="l4.228"> </span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-function GetCurrentCommandManager()</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-{</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+function GetCurrentCommandManager() {</span>
<a href="#l4.232"></a><span id="l4.232">   try {</span>
<a href="#l4.233"></a><span id="l4.233">     return GetCurrentEditorElement().commandManager;</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-  } catch (e) { dump (e)+&quot;\n&quot;; }</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+  } catch (e) { dump(e) + &quot;\n&quot;; }</span>
<a href="#l4.236"></a><span id="l4.236"> </span>
<a href="#l4.237"></a><span id="l4.237">   return null;</span>
<a href="#l4.238"></a><span id="l4.238"> }</span>
<a href="#l4.239"></a><span id="l4.239"> </span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-function GetCurrentEditorType()</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-{</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+function GetCurrentEditorType() {</span>
<a href="#l4.243"></a><span id="l4.243">   try {</span>
<a href="#l4.244"></a><span id="l4.244">     return GetCurrentEditorElement().editortype;</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-  } catch (e) { dump (e)+&quot;\n&quot;; }</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+  } catch (e) { dump(e) + &quot;\n&quot;; }</span>
<a href="#l4.247"></a><span id="l4.247"> </span>
<a href="#l4.248"></a><span id="l4.248">   return &quot;&quot;;</span>
<a href="#l4.249"></a><span id="l4.249"> }</span>
<a href="#l4.250"></a><span id="l4.250"> </span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-function IsHTMLEditor()</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-{</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+function IsHTMLEditor() {</span>
<a href="#l4.254"></a><span id="l4.254">   // We don't have an editorElement, just return false</span>
<a href="#l4.255"></a><span id="l4.255">   if (!GetCurrentEditorElement())</span>
<a href="#l4.256"></a><span id="l4.256">     return false;</span>
<a href="#l4.257"></a><span id="l4.257"> </span>
<a href="#l4.258"></a><span id="l4.258">   var editortype = GetCurrentEditorType();</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-  switch (editortype)</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-  {</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+  switch (editortype) {</span>
<a href="#l4.262"></a><span id="l4.262">       case &quot;html&quot;:</span>
<a href="#l4.263"></a><span id="l4.263">       case &quot;htmlmail&quot;:</span>
<a href="#l4.264"></a><span id="l4.264">         return true;</span>
<a href="#l4.265"></a><span id="l4.265"> </span>
<a href="#l4.266"></a><span id="l4.266">       case &quot;text&quot;:</span>
<a href="#l4.267"></a><span id="l4.267">       case &quot;textmail&quot;:</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-        return false</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+        return false;</span>
<a href="#l4.270"></a><span id="l4.270"> </span>
<a href="#l4.271"></a><span id="l4.271">       default:</span>
<a href="#l4.272"></a><span id="l4.272">         dump(&quot;INVALID EDITOR TYPE: &quot; + editortype + &quot;\n&quot;);</span>
<a href="#l4.273"></a><span id="l4.273">         break;</span>
<a href="#l4.274"></a><span id="l4.274">   }</span>
<a href="#l4.275"></a><span id="l4.275">   return false;</span>
<a href="#l4.276"></a><span id="l4.276"> }</span>
<a href="#l4.277"></a><span id="l4.277"> </span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-function PageIsEmptyAndUntouched()</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-{</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+function PageIsEmptyAndUntouched() {</span>
<a href="#l4.281"></a><span id="l4.281">   return IsDocumentEmpty() &amp;&amp; !IsDocumentModified() &amp;&amp; !IsHTMLSourceChanged();</span>
<a href="#l4.282"></a><span id="l4.282"> }</span>
<a href="#l4.283"></a><span id="l4.283"> </span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-function IsInHTMLSourceMode()</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-{</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+function IsInHTMLSourceMode() {</span>
<a href="#l4.287"></a><span id="l4.287">   return (gEditorDisplayMode == kDisplayModeSource);</span>
<a href="#l4.288"></a><span id="l4.288"> }</span>
<a href="#l4.289"></a><span id="l4.289"> </span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-function IsInPreviewMode()</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-{</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+function IsInPreviewMode() {</span>
<a href="#l4.293"></a><span id="l4.293">   return (gEditorDisplayMode == kDisplayModePreview);</span>
<a href="#l4.294"></a><span id="l4.294"> }</span>
<a href="#l4.295"></a><span id="l4.295"> </span>
<a href="#l4.296"></a><span id="l4.296"> // are we editing HTML (i.e. neither in HTML source mode, nor editing a text file)</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-function IsEditingRenderedHTML()</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-{</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+function IsEditingRenderedHTML() {</span>
<a href="#l4.300"></a><span id="l4.300">   return IsHTMLEditor() &amp;&amp; !IsInHTMLSourceMode();</span>
<a href="#l4.301"></a><span id="l4.301"> }</span>
<a href="#l4.302"></a><span id="l4.302"> </span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-function IsWebComposer()</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-{</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+function IsWebComposer() {</span>
<a href="#l4.306"></a><span id="l4.306">   return document.documentElement.id == &quot;editorWindow&quot;;</span>
<a href="#l4.307"></a><span id="l4.307"> }</span>
<a href="#l4.308"></a><span id="l4.308"> </span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-function IsDocumentEditable()</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-{</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+function IsDocumentEditable() {</span>
<a href="#l4.312"></a><span id="l4.312">   try {</span>
<a href="#l4.313"></a><span id="l4.313">     return GetCurrentEditor().isDocumentEditable;</span>
<a href="#l4.314"></a><span id="l4.314">   } catch (e) {}</span>
<a href="#l4.315"></a><span id="l4.315">   return false;</span>
<a href="#l4.316"></a><span id="l4.316"> }</span>
<a href="#l4.317"></a><span id="l4.317"> </span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-function IsDocumentEmpty()</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-{</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+function IsDocumentEmpty() {</span>
<a href="#l4.321"></a><span id="l4.321">   try {</span>
<a href="#l4.322"></a><span id="l4.322">     return GetCurrentEditor().documentIsEmpty;</span>
<a href="#l4.323"></a><span id="l4.323">   } catch (e) {}</span>
<a href="#l4.324"></a><span id="l4.324">   return false;</span>
<a href="#l4.325"></a><span id="l4.325"> }</span>
<a href="#l4.326"></a><span id="l4.326"> </span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-function IsDocumentModified()</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-{</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+function IsDocumentModified() {</span>
<a href="#l4.330"></a><span id="l4.330">   try {</span>
<a href="#l4.331"></a><span id="l4.331">     return GetCurrentEditor().documentModified;</span>
<a href="#l4.332"></a><span id="l4.332">   } catch (e) {}</span>
<a href="#l4.333"></a><span id="l4.333">   return false;</span>
<a href="#l4.334"></a><span id="l4.334"> }</span>
<a href="#l4.335"></a><span id="l4.335"> </span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-function IsHTMLSourceChanged()</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-{</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+function IsHTMLSourceChanged() {</span>
<a href="#l4.339"></a><span id="l4.339">   // gSourceTextEditor will not be defined if we're just a text editor.</span>
<a href="#l4.340"></a><span id="l4.340">   return gSourceTextEditor ? gSourceTextEditor.documentModified : false;</span>
<a href="#l4.341"></a><span id="l4.341"> }</span>
<a href="#l4.342"></a><span id="l4.342"> </span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-function newCommandParams()</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-{</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+function newCommandParams() {</span>
<a href="#l4.346"></a><span id="l4.346">   try {</span>
<a href="#l4.347"></a><span id="l4.347">     return Cu.createCommandParams();</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-  }</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-  catch(e) { dump(&quot;error thrown in newCommandParams: &quot;+e+&quot;\n&quot;); }</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+  } catch (e) { dump(&quot;error thrown in newCommandParams: &quot; + e + &quot;\n&quot;); }</span>
<a href="#l4.351"></a><span id="l4.351">   return null;</span>
<a href="#l4.352"></a><span id="l4.352"> }</span>
<a href="#l4.353"></a><span id="l4.353"> </span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-/************* General editing command utilities ***************/</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+/** *********** General editing command utilities ***************/</span>
<a href="#l4.356"></a><span id="l4.356"> </span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-function GetDocumentTitle()</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-{</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+function GetDocumentTitle() {</span>
<a href="#l4.360"></a><span id="l4.360">   try {</span>
<a href="#l4.361"></a><span id="l4.361">     return new XPCNativeWrapper(GetCurrentEditor().document, &quot;title&quot;).title;</span>
<a href="#l4.362"></a><span id="l4.362">   } catch (e) {}</span>
<a href="#l4.363"></a><span id="l4.363"> </span>
<a href="#l4.364"></a><span id="l4.364">   return &quot;&quot;;</span>
<a href="#l4.365"></a><span id="l4.365"> }</span>
<a href="#l4.366"></a><span id="l4.366"> </span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-function SetDocumentTitle(title)</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-{</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+function SetDocumentTitle(title) {</span>
<a href="#l4.371"></a><span id="l4.371">   try {</span>
<a href="#l4.372"></a><span id="l4.372">     GetCurrentEditorElement().contentDocument.title = title;</span>
<a href="#l4.373"></a><span id="l4.373"> </span>
<a href="#l4.374"></a><span id="l4.374">     // Update window title (doesn't work if called from a dialog)</span>
<a href="#l4.375"></a><span id="l4.375">     if (&quot;UpdateWindowTitle&quot; in window)</span>
<a href="#l4.376"></a><span id="l4.376">       window.UpdateWindowTitle();</span>
<a href="#l4.377"></a><span id="l4.377">   } catch (e) {}</span>
<a href="#l4.378"></a><span id="l4.378"> }</span>
<a href="#l4.379"></a><span id="l4.379"> </span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-function EditorGetTextProperty(property, attribute, value, firstHas, anyHas, allHas)</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-{</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+function EditorGetTextProperty(property, attribute, value, firstHas, anyHas, allHas) {</span>
<a href="#l4.383"></a><span id="l4.383">   try {</span>
<a href="#l4.384"></a><span id="l4.384">     return GetCurrentEditor().getInlinePropertyWithAttrValue(property,</span>
<a href="#l4.385"></a><span id="l4.385">                                 attribute, value, firstHas, anyHas, allHas);</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-  }</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-  catch(e) {}</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+  } catch (e) {}</span>
<a href="#l4.389"></a><span id="l4.389"> }</span>
<a href="#l4.390"></a><span id="l4.390"> </span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-function EditorSetTextProperty(property, attribute, value)</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-{</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+function EditorSetTextProperty(property, attribute, value) {</span>
<a href="#l4.394"></a><span id="l4.394">   try {</span>
<a href="#l4.395"></a><span id="l4.395">     GetCurrentEditor().setInlineProperty(property, attribute, value);</span>
<a href="#l4.396"></a><span id="l4.396">     if (&quot;gContentWindow&quot; in window)</span>
<a href="#l4.397"></a><span id="l4.397">       window.gContentWindow.focus();</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-  }</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-  catch(e) {}</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+  } catch (e) {}</span>
<a href="#l4.401"></a><span id="l4.401"> }</span>
<a href="#l4.402"></a><span id="l4.402"> </span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-function EditorRemoveTextProperty(property, attribute)</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-{</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+function EditorRemoveTextProperty(property, attribute) {</span>
<a href="#l4.406"></a><span id="l4.406">   try {</span>
<a href="#l4.407"></a><span id="l4.407">     GetCurrentEditor().removeInlineProperty(property, attribute);</span>
<a href="#l4.408"></a><span id="l4.408">     if (&quot;gContentWindow&quot; in window)</span>
<a href="#l4.409"></a><span id="l4.409">       window.gContentWindow.focus();</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-  }</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-  catch(e) {}</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+  } catch (e) {}</span>
<a href="#l4.413"></a><span id="l4.413"> }</span>
<a href="#l4.414"></a><span id="l4.414"> </span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-/************* Element enbabling/disabling ***************/</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+/** *********** Element enbabling/disabling ***************/</span>
<a href="#l4.417"></a><span id="l4.417"> </span>
<a href="#l4.418"></a><span id="l4.418"> // this function takes an elementID and a flag</span>
<a href="#l4.419"></a><span id="l4.419"> // if the element can be found by ID, then it is either enabled (by removing &quot;disabled&quot; attr)</span>
<a href="#l4.420"></a><span id="l4.420"> // or disabled (setAttribute) as specified in the &quot;doEnable&quot; parameter</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-function SetElementEnabledById(elementID, doEnable)</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-{</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+function SetElementEnabledById(elementID, doEnable) {</span>
<a href="#l4.424"></a><span id="l4.424">   SetElementEnabled(document.getElementById(elementID), doEnable);</span>
<a href="#l4.425"></a><span id="l4.425"> }</span>
<a href="#l4.426"></a><span id="l4.426"> </span>
<a href="#l4.427"></a><span id="l4.427" class="difflineminus">-function SetElementEnabled(element, doEnable)</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-{</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-  if ( element )</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-  {</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-    if ( doEnable )</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+function SetElementEnabled(element, doEnable) {</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+  if (element) {</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+    if (doEnable)</span>
<a href="#l4.435"></a><span id="l4.435">       element.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l4.436"></a><span id="l4.436">     else</span>
<a href="#l4.437"></a><span id="l4.437">       element.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-  }</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-  else</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-  {</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+  } else {</span>
<a href="#l4.442"></a><span id="l4.442">     dump(&quot;Element  not found in SetElementEnabled\n&quot;);</span>
<a href="#l4.443"></a><span id="l4.443">   }</span>
<a href="#l4.444"></a><span id="l4.444"> }</span>
<a href="#l4.445"></a><span id="l4.445"> </span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-/************* Services / Prefs ***************/</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+/** *********** Services / Prefs ***************/</span>
<a href="#l4.448"></a><span id="l4.448"> </span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-function GetFileProtocolHandler()</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineminus">-{</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+function GetFileProtocolHandler() {</span>
<a href="#l4.452"></a><span id="l4.452">   let handler = Services.io.getProtocolHandler(&quot;file&quot;);</span>
<a href="#l4.453"></a><span id="l4.453">   return handler.QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l4.454"></a><span id="l4.454"> }</span>
<a href="#l4.455"></a><span id="l4.455"> </span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-function SetStringPref(aPrefName, aPrefValue)</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineminus">-{</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+function SetStringPref(aPrefName, aPrefValue) {</span>
<a href="#l4.459"></a><span id="l4.459">   try {</span>
<a href="#l4.460"></a><span id="l4.460">     Services.prefs.setStringPref(aPrefName, aPrefValue);</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineminus">-  }</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-  catch(e) {}</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+  } catch (e) {}</span>
<a href="#l4.464"></a><span id="l4.464"> }</span>
<a href="#l4.465"></a><span id="l4.465"> </span>
<a href="#l4.466"></a><span id="l4.466"> // Set initial directory for a filepicker from URLs saved in prefs</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-function SetFilePickerDirectory(filePicker, fileType)</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-{</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-  if (filePicker)</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-  {</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+function SetFilePickerDirectory(filePicker, fileType) {</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+  if (filePicker) {</span>
<a href="#l4.473"></a><span id="l4.473">     try {</span>
<a href="#l4.474"></a><span id="l4.474">       // Save current directory so we can reset it in SaveFilePickerDirectory</span>
<a href="#l4.475"></a><span id="l4.475">       gFilePickerDirectory = filePicker.displayDirectory;</span>
<a href="#l4.476"></a><span id="l4.476"> </span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-      let location = Services.prefs.getComplexValue(&quot;editor.lastFileLocation.&quot;+fileType,</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+      let location = Services.prefs.getComplexValue(&quot;editor.lastFileLocation.&quot; + fileType,</span>
<a href="#l4.479"></a><span id="l4.479">                                                     Ci.nsIFile);</span>
<a href="#l4.480"></a><span id="l4.480">       if (location)</span>
<a href="#l4.481"></a><span id="l4.481">         filePicker.displayDirectory = location;</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-    }</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-    catch(e) {}</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+    } catch (e) {}</span>
<a href="#l4.485"></a><span id="l4.485">   }</span>
<a href="#l4.486"></a><span id="l4.486"> }</span>
<a href="#l4.487"></a><span id="l4.487"> </span>
<a href="#l4.488"></a><span id="l4.488"> // Save the directory of the selected file to prefs</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineminus">-function SaveFilePickerDirectory(filePicker, fileType)</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineminus">-{</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-  if (filePicker &amp;&amp; filePicker.file)</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineminus">-  {</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+function SaveFilePickerDirectory(filePicker, fileType) {</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+  if (filePicker &amp;&amp; filePicker.file) {</span>
<a href="#l4.495"></a><span id="l4.495">     try {</span>
<a href="#l4.496"></a><span id="l4.496">       var fileDir;</span>
<a href="#l4.497"></a><span id="l4.497">       if (filePicker.file.parent)</span>
<a href="#l4.498"></a><span id="l4.498">         fileDir = filePicker.file.parent.QueryInterface(Ci.nsIFile);</span>
<a href="#l4.499"></a><span id="l4.499"> </span>
<a href="#l4.500"></a><span id="l4.500">         Services.prefs.setComplexValue(&quot;editor.lastFileLocation.&quot; + fileType,</span>
<a href="#l4.501"></a><span id="l4.501">                                        Ci.nsIFile, fileDir);</span>
<a href="#l4.502"></a><span id="l4.502"> </span>
<a href="#l4.503"></a><span id="l4.503" class="difflineat">@@ -439,24 +385,22 @@ function SaveFilePickerDirectory(filePic</span>
<a href="#l4.504"></a><span id="l4.504">   // Restore the directory used before SetFilePickerDirectory was called;</span>
<a href="#l4.505"></a><span id="l4.505">   // This reduces interference with Browser and other module directory defaults</span>
<a href="#l4.506"></a><span id="l4.506">   if (gFilePickerDirectory)</span>
<a href="#l4.507"></a><span id="l4.507">     filePicker.displayDirectory = gFilePickerDirectory;</span>
<a href="#l4.508"></a><span id="l4.508"> </span>
<a href="#l4.509"></a><span id="l4.509">   gFilePickerDirectory = null;</span>
<a href="#l4.510"></a><span id="l4.510"> }</span>
<a href="#l4.511"></a><span id="l4.511"> </span>
<a href="#l4.512"></a><span id="l4.512" class="difflineminus">-function GetDefaultBrowserColors()</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineminus">-{</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineminus">-  var colors = { TextColor:0, BackgroundColor:0, LinkColor:0, ActiveLinkColor:0 , VisitedLinkColor:0 };</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+function GetDefaultBrowserColors() {</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+  var colors = { TextColor: 0, BackgroundColor: 0, LinkColor: 0, ActiveLinkColor: 0, VisitedLinkColor: 0 };</span>
<a href="#l4.517"></a><span id="l4.517">   var useSysColors = false;</span>
<a href="#l4.518"></a><span id="l4.518">   try { useSysColors = Services.prefs.getBoolPref(&quot;browser.display.use_system_colors&quot;); } catch (e) {}</span>
<a href="#l4.519"></a><span id="l4.519"> </span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-  if (!useSysColors)</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-  {</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+  if (!useSysColors) {</span>
<a href="#l4.523"></a><span id="l4.523">     try { colors.TextColor = Services.prefs.getCharPref(&quot;browser.display.foreground_color&quot;); } catch (e) {}</span>
<a href="#l4.524"></a><span id="l4.524"> </span>
<a href="#l4.525"></a><span id="l4.525">     try { colors.BackgroundColor = Services.prefs.getCharPref(&quot;browser.display.background_color&quot;); } catch (e) {}</span>
<a href="#l4.526"></a><span id="l4.526">   }</span>
<a href="#l4.527"></a><span id="l4.527">   // Use OS colors for text and background if explicitly asked or pref is not set</span>
<a href="#l4.528"></a><span id="l4.528">   if (!colors.TextColor)</span>
<a href="#l4.529"></a><span id="l4.529">     colors.TextColor = &quot;windowtext&quot;;</span>
<a href="#l4.530"></a><span id="l4.530"> </span>
<a href="#l4.531"></a><span id="l4.531" class="difflineat">@@ -465,30 +409,27 @@ function GetDefaultBrowserColors()</span>
<a href="#l4.532"></a><span id="l4.532"> </span>
<a href="#l4.533"></a><span id="l4.533">   colors.LinkColor = Services.prefs.getCharPref(&quot;browser.anchor_color&quot;);</span>
<a href="#l4.534"></a><span id="l4.534">   colors.ActiveLinkColor = Services.prefs.getCharPref(&quot;browser.active_color&quot;);</span>
<a href="#l4.535"></a><span id="l4.535">   colors.VisitedLinkColor = Services.prefs.getCharPref(&quot;browser.visited_color&quot;);</span>
<a href="#l4.536"></a><span id="l4.536"> </span>
<a href="#l4.537"></a><span id="l4.537">   return colors;</span>
<a href="#l4.538"></a><span id="l4.538"> }</span>
<a href="#l4.539"></a><span id="l4.539"> </span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-/************* URL handling ***************/</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+/** *********** URL handling ***************/</span>
<a href="#l4.542"></a><span id="l4.542"> </span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-function TextIsURI(selectedText)</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-{</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+function TextIsURI(selectedText) {</span>
<a href="#l4.546"></a><span id="l4.546">   return selectedText &amp;&amp; /^http:\/\/|^https:\/\/|^file:\/\/|^ftp:\/\/|^about:|^mailto:|^news:|^snews:|^telnet:|^ldap:|^ldaps:|^gopher:|^finger:|^javascript:/i.test(selectedText);</span>
<a href="#l4.547"></a><span id="l4.547"> }</span>
<a href="#l4.548"></a><span id="l4.548"> </span>
<a href="#l4.549"></a><span id="l4.549" class="difflineminus">-function IsUrlAboutBlank(urlString)</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineminus">-{</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+function IsUrlAboutBlank(urlString) {</span>
<a href="#l4.552"></a><span id="l4.552">   return (urlString == &quot;about:blank&quot;);</span>
<a href="#l4.553"></a><span id="l4.553"> }</span>
<a href="#l4.554"></a><span id="l4.554"> </span>
<a href="#l4.555"></a><span id="l4.555" class="difflineminus">-function MakeRelativeUrl(url)</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineminus">-{</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+function MakeRelativeUrl(url) {</span>
<a href="#l4.558"></a><span id="l4.558">   let inputUrl = url.trim();</span>
<a href="#l4.559"></a><span id="l4.559">   if (!inputUrl)</span>
<a href="#l4.560"></a><span id="l4.560">     return inputUrl;</span>
<a href="#l4.561"></a><span id="l4.561"> </span>
<a href="#l4.562"></a><span id="l4.562">   // Get the filespec relative to current document's location</span>
<a href="#l4.563"></a><span id="l4.563">   // NOTE: Can't do this if file isn't saved yet!</span>
<a href="#l4.564"></a><span id="l4.564">   var docUrl = GetDocumentBaseUrl();</span>
<a href="#l4.565"></a><span id="l4.565">   var docScheme = GetScheme(docUrl);</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineat">@@ -534,83 +475,72 @@ function MakeRelativeUrl(url)</span>
<a href="#l4.567"></a><span id="l4.567">   var nextDocSlash = 0;</span>
<a href="#l4.568"></a><span id="l4.568">   var done = false;</span>
<a href="#l4.569"></a><span id="l4.569"> </span>
<a href="#l4.570"></a><span id="l4.570">   // Remove all matching subdirs common to both doc and input urls</span>
<a href="#l4.571"></a><span id="l4.571">   do {</span>
<a href="#l4.572"></a><span id="l4.572">     nextDocSlash = docPath.indexOf(&quot;\/&quot;);</span>
<a href="#l4.573"></a><span id="l4.573">     var nextUrlSlash = urlPath.indexOf(&quot;\/&quot;);</span>
<a href="#l4.574"></a><span id="l4.574"> </span>
<a href="#l4.575"></a><span id="l4.575" class="difflineminus">-    if (nextUrlSlash == -1)</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineminus">-    {</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+    if (nextUrlSlash == -1) {</span>
<a href="#l4.578"></a><span id="l4.578">       // We're done matching and all dirs in url</span>
<a href="#l4.579"></a><span id="l4.579">       // what's left is the filename</span>
<a href="#l4.580"></a><span id="l4.580">       done = true;</span>
<a href="#l4.581"></a><span id="l4.581"> </span>
<a href="#l4.582"></a><span id="l4.582">       // Remove filename for named anchors in the same file</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineminus">-      if (nextDocSlash == -1 &amp;&amp; docFilename)</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-      {</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+      if (nextDocSlash == -1 &amp;&amp; docFilename) {</span>
<a href="#l4.586"></a><span id="l4.586">         var anchorIndex = urlPath.indexOf(&quot;#&quot;);</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-        if (anchorIndex &gt; 0)</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-        {</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+        if (anchorIndex &gt; 0) {</span>
<a href="#l4.590"></a><span id="l4.590">           var urlFilename = doCaseInsensitive ? urlPath.toLowerCase() : urlPath;</span>
<a href="#l4.591"></a><span id="l4.591"> </span>
<a href="#l4.592"></a><span id="l4.592">           if (urlFilename.startsWith(docFilename))</span>
<a href="#l4.593"></a><span id="l4.593">             urlPath = urlPath.slice(anchorIndex);</span>
<a href="#l4.594"></a><span id="l4.594">         }</span>
<a href="#l4.595"></a><span id="l4.595">       }</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineminus">-    }</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineminus">-    else if (nextDocSlash &gt;= 0)</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineminus">-    {</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+    } else if (nextDocSlash &gt;= 0) {</span>
<a href="#l4.600"></a><span id="l4.600">       // Test for matching subdir</span>
<a href="#l4.601"></a><span id="l4.601">       var docDir = docPath.slice(0, nextDocSlash);</span>
<a href="#l4.602"></a><span id="l4.602">       var urlDir = urlPath.slice(0, nextUrlSlash);</span>
<a href="#l4.603"></a><span id="l4.603">       if (doCaseInsensitive)</span>
<a href="#l4.604"></a><span id="l4.604">         urlDir = urlDir.toLowerCase();</span>
<a href="#l4.605"></a><span id="l4.605"> </span>
<a href="#l4.606"></a><span id="l4.606" class="difflineminus">-      if (urlDir == docDir)</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-      {</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+      if (urlDir == docDir) {</span>
<a href="#l4.609"></a><span id="l4.609">         // Remove matching dir+&quot;/&quot; from each path</span>
<a href="#l4.610"></a><span id="l4.610">         // and continue to next dir.</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-        docPath = docPath.slice(nextDocSlash+1);</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-        urlPath = urlPath.slice(nextUrlSlash+1);</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-      }</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-      else</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineminus">-      {</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+        docPath = docPath.slice(nextDocSlash + 1);</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+        urlPath = urlPath.slice(nextUrlSlash + 1);</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+      } else {</span>
<a href="#l4.619"></a><span id="l4.619">         // No match, we're done.</span>
<a href="#l4.620"></a><span id="l4.620">         done = true;</span>
<a href="#l4.621"></a><span id="l4.621"> </span>
<a href="#l4.622"></a><span id="l4.622">         // Be sure we are on the same local drive or volume</span>
<a href="#l4.623"></a><span id="l4.623">         //   (the first &quot;dir&quot; in the path) because we can't</span>
<a href="#l4.624"></a><span id="l4.624">         //   relativize to different drives/volumes.</span>
<a href="#l4.625"></a><span id="l4.625">         // UNIX doesn't have volumes, so we must not do this else</span>
<a href="#l4.626"></a><span id="l4.626">         // the first directory will be misinterpreted as a volume name.</span>
<a href="#l4.627"></a><span id="l4.627">         if (firstDirTest &amp;&amp; docScheme == &quot;file&quot; &amp;&amp;</span>
<a href="#l4.628"></a><span id="l4.628">             AppConstants.platform != &quot;unix&quot;)</span>
<a href="#l4.629"></a><span id="l4.629">           return inputUrl;</span>
<a href="#l4.630"></a><span id="l4.630">       }</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineminus">-    }</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineminus">-    else  // No more doc dirs left, we're done</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineplus">+    } else  // No more doc dirs left, we're done</span>
<a href="#l4.634"></a><span id="l4.634">       done = true;</span>
<a href="#l4.635"></a><span id="l4.635"> </span>
<a href="#l4.636"></a><span id="l4.636">     firstDirTest = false;</span>
<a href="#l4.637"></a><span id="l4.637">   }</span>
<a href="#l4.638"></a><span id="l4.638">   while (!done);</span>
<a href="#l4.639"></a><span id="l4.639"> </span>
<a href="#l4.640"></a><span id="l4.640">   // Add &quot;../&quot; for each dir left in docPath</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineminus">-  while (nextDocSlash &gt; 0)</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineminus">-  {</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+  while (nextDocSlash &gt; 0) {</span>
<a href="#l4.644"></a><span id="l4.644">     urlPath = &quot;../&quot; + urlPath;</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineminus">-    nextDocSlash = docPath.indexOf(&quot;\/&quot;, nextDocSlash+1);</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineplus">+    nextDocSlash = docPath.indexOf(&quot;\/&quot;, nextDocSlash + 1);</span>
<a href="#l4.647"></a><span id="l4.647">   }</span>
<a href="#l4.648"></a><span id="l4.648">   return urlPath;</span>
<a href="#l4.649"></a><span id="l4.649"> }</span>
<a href="#l4.650"></a><span id="l4.650"> </span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-function MakeAbsoluteUrl(url)</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineminus">-{</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+function MakeAbsoluteUrl(url) {</span>
<a href="#l4.654"></a><span id="l4.654">   let resultUrl = TrimString(url);</span>
<a href="#l4.655"></a><span id="l4.655">   if (!resultUrl)</span>
<a href="#l4.656"></a><span id="l4.656">     return resultUrl;</span>
<a href="#l4.657"></a><span id="l4.657"> </span>
<a href="#l4.658"></a><span id="l4.658">   // Check if URL is already absolute, i.e., it has a scheme</span>
<a href="#l4.659"></a><span id="l4.659">   let urlScheme = GetScheme(resultUrl);</span>
<a href="#l4.660"></a><span id="l4.660"> </span>
<a href="#l4.661"></a><span id="l4.661">   if (urlScheme)</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineat">@@ -626,260 +556,235 @@ function MakeAbsoluteUrl(url)</span>
<a href="#l4.663"></a><span id="l4.663">   // Make a URI object to use its &quot;resolve&quot; method</span>
<a href="#l4.664"></a><span id="l4.664">   let absoluteUrl = resultUrl;</span>
<a href="#l4.665"></a><span id="l4.665">   let docUri = Services.io.newURI(docUrl, GetCurrentEditor().documentCharacterSet);</span>
<a href="#l4.666"></a><span id="l4.666"> </span>
<a href="#l4.667"></a><span id="l4.667">   try {</span>
<a href="#l4.668"></a><span id="l4.668">     absoluteUrl = docUri.resolve(resultUrl);</span>
<a href="#l4.669"></a><span id="l4.669">     // This is deprecated and buggy!</span>
<a href="#l4.670"></a><span id="l4.670">     // If used, we must make it a path for the parent directory (remove filename)</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-    //absoluteUrl = IOService.resolveRelativePath(resultUrl, docUrl);</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+    // absoluteUrl = IOService.resolveRelativePath(resultUrl, docUrl);</span>
<a href="#l4.673"></a><span id="l4.673">   } catch (e) {}</span>
<a href="#l4.674"></a><span id="l4.674"> </span>
<a href="#l4.675"></a><span id="l4.675">   return absoluteUrl;</span>
<a href="#l4.676"></a><span id="l4.676"> }</span>
<a href="#l4.677"></a><span id="l4.677"> </span>
<a href="#l4.678"></a><span id="l4.678"> // Get the HREF of the page's &lt;base&gt; tag or the document location</span>
<a href="#l4.679"></a><span id="l4.679"> // returns empty string if no base href and document hasn't been saved yet</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineminus">-function GetDocumentBaseUrl()</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineminus">-{</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+function GetDocumentBaseUrl() {</span>
<a href="#l4.683"></a><span id="l4.683">   try {</span>
<a href="#l4.684"></a><span id="l4.684">     var docUrl;</span>
<a href="#l4.685"></a><span id="l4.685"> </span>
<a href="#l4.686"></a><span id="l4.686">     // if document supplies a &lt;base&gt; tag, use that URL instead</span>
<a href="#l4.687"></a><span id="l4.687">     let base = GetCurrentEditor().document.querySelector(&quot;base&quot;);</span>
<a href="#l4.688"></a><span id="l4.688">     if (base)</span>
<a href="#l4.689"></a><span id="l4.689">       docUrl = base.getAttribute(&quot;href&quot;);</span>
<a href="#l4.690"></a><span id="l4.690">     if (!docUrl)</span>
<a href="#l4.691"></a><span id="l4.691">       docUrl = GetDocumentUrl();</span>
<a href="#l4.692"></a><span id="l4.692"> </span>
<a href="#l4.693"></a><span id="l4.693">     if (!IsUrlAboutBlank(docUrl))</span>
<a href="#l4.694"></a><span id="l4.694">       return docUrl;</span>
<a href="#l4.695"></a><span id="l4.695">   } catch (e) {}</span>
<a href="#l4.696"></a><span id="l4.696">   return &quot;&quot;;</span>
<a href="#l4.697"></a><span id="l4.697"> }</span>
<a href="#l4.698"></a><span id="l4.698"> </span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-function GetDocumentUrl()</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-{</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineplus">+function GetDocumentUrl() {</span>
<a href="#l4.702"></a><span id="l4.702">   try {</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineminus">-    return GetCurrentEditor().document.URL;;</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineminus">-  }</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineminus">-  catch (e) {}</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineplus">+    return GetCurrentEditor().document.URL;</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+  } catch (e) {}</span>
<a href="#l4.708"></a><span id="l4.708">   return &quot;&quot;;</span>
<a href="#l4.709"></a><span id="l4.709"> }</span>
<a href="#l4.710"></a><span id="l4.710"> </span>
<a href="#l4.711"></a><span id="l4.711"> // Extract the scheme (e.g., 'file', 'http') from a URL string</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineminus">-function GetScheme(urlspec)</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-{</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+function GetScheme(urlspec) {</span>
<a href="#l4.715"></a><span id="l4.715">   var resultUrl = TrimString(urlspec);</span>
<a href="#l4.716"></a><span id="l4.716">   // Unsaved document URL has no acceptable scheme yet</span>
<a href="#l4.717"></a><span id="l4.717">   if (!resultUrl || IsUrlAboutBlank(resultUrl))</span>
<a href="#l4.718"></a><span id="l4.718">     return &quot;&quot;;</span>
<a href="#l4.719"></a><span id="l4.719"> </span>
<a href="#l4.720"></a><span id="l4.720">   var scheme = &quot;&quot;;</span>
<a href="#l4.721"></a><span id="l4.721">   try {</span>
<a href="#l4.722"></a><span id="l4.722">     // This fails if there's no scheme</span>
<a href="#l4.723"></a><span id="l4.723">     scheme = Services.io.extractScheme(resultUrl);</span>
<a href="#l4.724"></a><span id="l4.724">   } catch (e) {}</span>
<a href="#l4.725"></a><span id="l4.725"> </span>
<a href="#l4.726"></a><span id="l4.726">   return scheme ? scheme.toLowerCase() : &quot;&quot;;</span>
<a href="#l4.727"></a><span id="l4.727"> }</span>
<a href="#l4.728"></a><span id="l4.728"> </span>
<a href="#l4.729"></a><span id="l4.729" class="difflineminus">-function GetHost(urlspec)</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineminus">-{</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+function GetHost(urlspec) {</span>
<a href="#l4.732"></a><span id="l4.732">   if (!urlspec)</span>
<a href="#l4.733"></a><span id="l4.733">     return &quot;&quot;;</span>
<a href="#l4.734"></a><span id="l4.734"> </span>
<a href="#l4.735"></a><span id="l4.735">   var host = &quot;&quot;;</span>
<a href="#l4.736"></a><span id="l4.736">   try {</span>
<a href="#l4.737"></a><span id="l4.737">     host = Services.io.newURI(urlspec).host;</span>
<a href="#l4.738"></a><span id="l4.738">    } catch (e) {}</span>
<a href="#l4.739"></a><span id="l4.739"> </span>
<a href="#l4.740"></a><span id="l4.740">   return host;</span>
<a href="#l4.741"></a><span id="l4.741"> }</span>
<a href="#l4.742"></a><span id="l4.742"> </span>
<a href="#l4.743"></a><span id="l4.743" class="difflineminus">-function GetUsername(urlspec)</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineminus">-{</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineplus">+function GetUsername(urlspec) {</span>
<a href="#l4.746"></a><span id="l4.746">   if (!urlspec)</span>
<a href="#l4.747"></a><span id="l4.747">     return &quot;&quot;;</span>
<a href="#l4.748"></a><span id="l4.748"> </span>
<a href="#l4.749"></a><span id="l4.749">   var username = &quot;&quot;;</span>
<a href="#l4.750"></a><span id="l4.750">   try {</span>
<a href="#l4.751"></a><span id="l4.751">     username = Services.io.newURI(urlspec).username;</span>
<a href="#l4.752"></a><span id="l4.752">   } catch (e) {}</span>
<a href="#l4.753"></a><span id="l4.753"> </span>
<a href="#l4.754"></a><span id="l4.754">   return username;</span>
<a href="#l4.755"></a><span id="l4.755"> }</span>
<a href="#l4.756"></a><span id="l4.756"> </span>
<a href="#l4.757"></a><span id="l4.757" class="difflineminus">-function GetFilename(urlspec)</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineminus">-{</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineplus">+function GetFilename(urlspec) {</span>
<a href="#l4.760"></a><span id="l4.760">   if (!urlspec || IsUrlAboutBlank(urlspec))</span>
<a href="#l4.761"></a><span id="l4.761">     return &quot;&quot;;</span>
<a href="#l4.762"></a><span id="l4.762"> </span>
<a href="#l4.763"></a><span id="l4.763">   var filename;</span>
<a href="#l4.764"></a><span id="l4.764"> </span>
<a href="#l4.765"></a><span id="l4.765">   try {</span>
<a href="#l4.766"></a><span id="l4.766">     let uri = Services.io.newURI(urlspec);</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineminus">-    if (uri)</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineminus">-    {</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineplus">+    if (uri) {</span>
<a href="#l4.770"></a><span id="l4.770">       let url = uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l4.771"></a><span id="l4.771">       if (url)</span>
<a href="#l4.772"></a><span id="l4.772">         filename = url.fileName;</span>
<a href="#l4.773"></a><span id="l4.773">     }</span>
<a href="#l4.774"></a><span id="l4.774">   } catch (e) {}</span>
<a href="#l4.775"></a><span id="l4.775"> </span>
<a href="#l4.776"></a><span id="l4.776">   return filename ? filename : &quot;&quot;;</span>
<a href="#l4.777"></a><span id="l4.777"> }</span>
<a href="#l4.778"></a><span id="l4.778"> </span>
<a href="#l4.779"></a><span id="l4.779"> // Return the url without username and password</span>
<a href="#l4.780"></a><span id="l4.780"> // Optional output objects return extracted username and password strings</span>
<a href="#l4.781"></a><span id="l4.781"> // This uses just string routines via nsIIOServices</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-function StripUsernamePassword(urlspec, usernameObj, passwordObj)</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineminus">-{</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+function StripUsernamePassword(urlspec, usernameObj, passwordObj) {</span>
<a href="#l4.785"></a><span id="l4.785">   urlspec = TrimString(urlspec);</span>
<a href="#l4.786"></a><span id="l4.786">   if (!urlspec || IsUrlAboutBlank(urlspec))</span>
<a href="#l4.787"></a><span id="l4.787">     return urlspec;</span>
<a href="#l4.788"></a><span id="l4.788"> </span>
<a href="#l4.789"></a><span id="l4.789">   if (usernameObj)</span>
<a href="#l4.790"></a><span id="l4.790">     usernameObj.value = &quot;&quot;;</span>
<a href="#l4.791"></a><span id="l4.791">   if (passwordObj)</span>
<a href="#l4.792"></a><span id="l4.792">     passwordObj.value = &quot;&quot;;</span>
<a href="#l4.793"></a><span id="l4.793"> </span>
<a href="#l4.794"></a><span id="l4.794">   // &quot;@&quot; must exist else we will never detect username or password</span>
<a href="#l4.795"></a><span id="l4.795">   var atIndex = urlspec.indexOf(&quot;@&quot;);</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineminus">-  if (atIndex &gt; 0)</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineminus">-  {</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineplus">+  if (atIndex &gt; 0) {</span>
<a href="#l4.799"></a><span id="l4.799">     try {</span>
<a href="#l4.800"></a><span id="l4.800">       let uri = Services.io.newURI(urlspec);</span>
<a href="#l4.801"></a><span id="l4.801">       let username = uri.username;</span>
<a href="#l4.802"></a><span id="l4.802">       let password = uri.password;</span>
<a href="#l4.803"></a><span id="l4.803"> </span>
<a href="#l4.804"></a><span id="l4.804">       if (usernameObj &amp;&amp; username)</span>
<a href="#l4.805"></a><span id="l4.805">         usernameObj.value = username;</span>
<a href="#l4.806"></a><span id="l4.806">       if (passwordObj &amp;&amp; password)</span>
<a href="#l4.807"></a><span id="l4.807">         passwordObj.value = password;</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineminus">-      if (username)</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineminus">-      {</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineplus">+      if (username) {</span>
<a href="#l4.811"></a><span id="l4.811">         let usernameStart = urlspec.indexOf(username);</span>
<a href="#l4.812"></a><span id="l4.812">         if (usernameStart != -1)</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineminus">-          return urlspec.slice(0, usernameStart) + urlspec.slice(atIndex+1);</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineplus">+          return urlspec.slice(0, usernameStart) + urlspec.slice(atIndex + 1);</span>
<a href="#l4.815"></a><span id="l4.815">       }</span>
<a href="#l4.816"></a><span id="l4.816">     } catch (e) {}</span>
<a href="#l4.817"></a><span id="l4.817">   }</span>
<a href="#l4.818"></a><span id="l4.818">   return urlspec;</span>
<a href="#l4.819"></a><span id="l4.819"> }</span>
<a href="#l4.820"></a><span id="l4.820"> </span>
<a href="#l4.821"></a><span id="l4.821" class="difflineminus">-function StripPassword(urlspec, passwordObj)</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineminus">-{</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineplus">+function StripPassword(urlspec, passwordObj) {</span>
<a href="#l4.824"></a><span id="l4.824">   urlspec = TrimString(urlspec);</span>
<a href="#l4.825"></a><span id="l4.825">   if (!urlspec || IsUrlAboutBlank(urlspec))</span>
<a href="#l4.826"></a><span id="l4.826">     return urlspec;</span>
<a href="#l4.827"></a><span id="l4.827"> </span>
<a href="#l4.828"></a><span id="l4.828">   if (passwordObj)</span>
<a href="#l4.829"></a><span id="l4.829">     passwordObj.value = &quot;&quot;;</span>
<a href="#l4.830"></a><span id="l4.830"> </span>
<a href="#l4.831"></a><span id="l4.831">   // &quot;@&quot; must exist else we will never detect password</span>
<a href="#l4.832"></a><span id="l4.832">   var atIndex = urlspec.indexOf(&quot;@&quot;);</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineminus">-  if (atIndex &gt; 0)</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineminus">-  {</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+  if (atIndex &gt; 0) {</span>
<a href="#l4.836"></a><span id="l4.836">     try {</span>
<a href="#l4.837"></a><span id="l4.837">       let password = Services.io.newURI(urlspec).password;</span>
<a href="#l4.838"></a><span id="l4.838"> </span>
<a href="#l4.839"></a><span id="l4.839">       if (passwordObj &amp;&amp; password)</span>
<a href="#l4.840"></a><span id="l4.840">         passwordObj.value = password;</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineminus">-      if (password)</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineminus">-      {</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+      if (password) {</span>
<a href="#l4.844"></a><span id="l4.844">         // Find last &quot;:&quot; before &quot;@&quot;</span>
<a href="#l4.845"></a><span id="l4.845">         let colon = urlspec.lastIndexOf(&quot;:&quot;, atIndex);</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineminus">-        if (colon != -1)</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineminus">-        {</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineplus">+        if (colon != -1) {</span>
<a href="#l4.849"></a><span id="l4.849">           // Include the &quot;@&quot;</span>
<a href="#l4.850"></a><span id="l4.850">           return urlspec.slice(0, colon) + urlspec.slice(atIndex);</span>
<a href="#l4.851"></a><span id="l4.851">         }</span>
<a href="#l4.852"></a><span id="l4.852">       }</span>
<a href="#l4.853"></a><span id="l4.853">     } catch (e) {}</span>
<a href="#l4.854"></a><span id="l4.854">   }</span>
<a href="#l4.855"></a><span id="l4.855">   return urlspec;</span>
<a href="#l4.856"></a><span id="l4.856"> }</span>
<a href="#l4.857"></a><span id="l4.857"> </span>
<a href="#l4.858"></a><span id="l4.858"> // Version to use when you have an nsIURI object</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineminus">-function StripUsernamePasswordFromURI(uri)</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineminus">-{</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineplus">+function StripUsernamePasswordFromURI(uri) {</span>
<a href="#l4.862"></a><span id="l4.862">   var urlspec = &quot;&quot;;</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineminus">-  if (uri)</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineminus">-  {</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineplus">+  if (uri) {</span>
<a href="#l4.866"></a><span id="l4.866">     try {</span>
<a href="#l4.867"></a><span id="l4.867">       urlspec = uri.spec;</span>
<a href="#l4.868"></a><span id="l4.868">       var userPass = uri.userPass;</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineminus">-      if (userPass)</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineminus">-      {</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineplus">+      if (userPass) {</span>
<a href="#l4.872"></a><span id="l4.872">         start = urlspec.indexOf(userPass);</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineminus">-        urlspec = urlspec.slice(0, start) + urlspec.slice(start+userPass.length+1);</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineplus">+        urlspec = urlspec.slice(0, start) + urlspec.slice(start + userPass.length + 1);</span>
<a href="#l4.875"></a><span id="l4.875">       }</span>
<a href="#l4.876"></a><span id="l4.876">     } catch (e) {}</span>
<a href="#l4.877"></a><span id="l4.877">   }</span>
<a href="#l4.878"></a><span id="l4.878">   return urlspec;</span>
<a href="#l4.879"></a><span id="l4.879"> }</span>
<a href="#l4.880"></a><span id="l4.880"> </span>
<a href="#l4.881"></a><span id="l4.881" class="difflineminus">-function InsertUsernameIntoUrl(urlspec, username)</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineminus">-{</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineplus">+function InsertUsernameIntoUrl(urlspec, username) {</span>
<a href="#l4.884"></a><span id="l4.884">   if (!urlspec || !username)</span>
<a href="#l4.885"></a><span id="l4.885">     return urlspec;</span>
<a href="#l4.886"></a><span id="l4.886"> </span>
<a href="#l4.887"></a><span id="l4.887">   try {</span>
<a href="#l4.888"></a><span id="l4.888">     let URI = Services.io.newURI(urlspec, GetCurrentEditor().documentCharacterSet);</span>
<a href="#l4.889"></a><span id="l4.889">     URI.username = username;</span>
<a href="#l4.890"></a><span id="l4.890">     return URI.spec;</span>
<a href="#l4.891"></a><span id="l4.891">   } catch (e) {}</span>
<a href="#l4.892"></a><span id="l4.892"> </span>
<a href="#l4.893"></a><span id="l4.893">   return urlspec;</span>
<a href="#l4.894"></a><span id="l4.894"> }</span>
<a href="#l4.895"></a><span id="l4.895"> </span>
<a href="#l4.896"></a><span id="l4.896" class="difflineminus">-function ConvertRGBColorIntoHEXColor(color)</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineminus">-{</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineminus">-  if ( /rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.test(color) ) {</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+function ConvertRGBColorIntoHEXColor(color) {</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+  if (/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.test(color)) {</span>
<a href="#l4.901"></a><span id="l4.901">     var r = Number(RegExp.$1).toString(16);</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineminus">-    if (r.length == 1) r = &quot;0&quot;+r;</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineplus">+    if (r.length == 1) r = &quot;0&quot; + r;</span>
<a href="#l4.904"></a><span id="l4.904">     var g = Number(RegExp.$2).toString(16);</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineminus">-    if (g.length == 1) g = &quot;0&quot;+g;</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineplus">+    if (g.length == 1) g = &quot;0&quot; + g;</span>
<a href="#l4.907"></a><span id="l4.907">     var b = Number(RegExp.$3).toString(16);</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineminus">-    if (b.length == 1) b = &quot;0&quot;+b;</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineminus">-    return &quot;#&quot;+r+g+b;</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineplus">+    if (b.length == 1) b = &quot;0&quot; + b;</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineplus">+    return &quot;#&quot; + r + g + b;</span>
<a href="#l4.912"></a><span id="l4.912">   }</span>
<a href="#l4.913"></a><span id="l4.913" class="difflineminus">-  else</span>
<a href="#l4.914"></a><span id="l4.914" class="difflineminus">-  {</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineplus">+</span>
<a href="#l4.916"></a><span id="l4.916">     return color;</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineminus">-  }</span>
<a href="#l4.918"></a><span id="l4.918"> }</span>
<a href="#l4.919"></a><span id="l4.919"> </span>
<a href="#l4.920"></a><span id="l4.920" class="difflineminus">-/************* CSS ***************/</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineplus">+/** *********** CSS ***************/</span>
<a href="#l4.922"></a><span id="l4.922"> </span>
<a href="#l4.923"></a><span id="l4.923" class="difflineminus">-function GetHTMLOrCSSStyleValue(element, attrName, cssPropertyName)</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineminus">-{</span>
<a href="#l4.925"></a><span id="l4.925" class="difflineplus">+function GetHTMLOrCSSStyleValue(element, attrName, cssPropertyName) {</span>
<a href="#l4.926"></a><span id="l4.926">   var value;</span>
<a href="#l4.927"></a><span id="l4.927">   if (Services.prefs.getBoolPref(&quot;editor.use_css&quot;) &amp;&amp; IsHTMLEditor())</span>
<a href="#l4.928"></a><span id="l4.928">     value = element.style.getPropertyValue(cssPropertyName);</span>
<a href="#l4.929"></a><span id="l4.929"> </span>
<a href="#l4.930"></a><span id="l4.930">   if (!value)</span>
<a href="#l4.931"></a><span id="l4.931">     value = element.getAttribute(attrName);</span>
<a href="#l4.932"></a><span id="l4.932"> </span>
<a href="#l4.933"></a><span id="l4.933">   if (!value)</span>
<a href="#l4.934"></a><span id="l4.934">     return &quot;&quot;;</span>
<a href="#l4.935"></a><span id="l4.935"> </span>
<a href="#l4.936"></a><span id="l4.936">   return value;</span>
<a href="#l4.937"></a><span id="l4.937"> }</span>
<a href="#l4.938"></a><span id="l4.938"> </span>
<a href="#l4.939"></a><span id="l4.939" class="difflineminus">-/************* Miscellaneous ***************/</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineplus">+/** *********** Miscellaneous ***************/</span>
<a href="#l4.941"></a><span id="l4.941"> // Clone simple JS objects</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineminus">-function Clone(obj)</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineminus">-{</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineplus">+function Clone(obj) {</span>
<a href="#l4.945"></a><span id="l4.945">   var clone = {};</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineminus">-  for (var i in obj)</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineminus">-  {</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineminus">-    if (typeof obj[i] == 'object')</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+  for (var i in obj) {</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineplus">+    if (typeof obj[i] == &quot;object&quot;)</span>
<a href="#l4.951"></a><span id="l4.951">       clone[i] = Clone(obj[i]);</span>
<a href="#l4.952"></a><span id="l4.952">     else</span>
<a href="#l4.953"></a><span id="l4.953">       clone[i] = obj[i];</span>
<a href="#l4.954"></a><span id="l4.954">   }</span>
<a href="#l4.955"></a><span id="l4.955">   return clone;</span>
<a href="#l4.956"></a><span id="l4.956"> }</span>
<a href="#l4.957"></a><span id="l4.957"> </span>
<a href="#l4.958"></a><span id="l4.958"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAEAttributes.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAEAttributes.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -10,17 +10,17 @@ var gJSAttr = {};</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> // Core HTML attribute values //</span>
<a href="#l5.7"></a><span id="l5.7"> // This is appended to Name menulist when &quot;_core&quot; is attribute name</span>
<a href="#l5.8"></a><span id="l5.8"> var gCoreHTMLAttr =</span>
<a href="#l5.9"></a><span id="l5.9"> [</span>
<a href="#l5.10"></a><span id="l5.10">   &quot;^id&quot;,</span>
<a href="#l5.11"></a><span id="l5.11">   &quot;class&quot;,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  &quot;title&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  &quot;title&quot;,</span>
<a href="#l5.14"></a><span id="l5.14"> ];</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> // Core event attribute values //</span>
<a href="#l5.17"></a><span id="l5.17"> // This is appended to all JS menulists</span>
<a href="#l5.18"></a><span id="l5.18"> //   except those elements having &quot;noJSEvents&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> //   as a value in their gJSAttr array.</span>
<a href="#l5.20"></a><span id="l5.20"> var gCoreJSEvents =</span>
<a href="#l5.21"></a><span id="l5.21"> [</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -29,17 +29,17 @@ var gCoreJSEvents =</span>
<a href="#l5.23"></a><span id="l5.23">   &quot;onmousedown&quot;,</span>
<a href="#l5.24"></a><span id="l5.24">   &quot;onmouseup&quot;,</span>
<a href="#l5.25"></a><span id="l5.25">   &quot;onmouseover&quot;,</span>
<a href="#l5.26"></a><span id="l5.26">   &quot;onmousemove&quot;,</span>
<a href="#l5.27"></a><span id="l5.27">   &quot;onmouseout&quot;,</span>
<a href="#l5.28"></a><span id="l5.28">   &quot;-&quot;,</span>
<a href="#l5.29"></a><span id="l5.29">   &quot;onkeypress&quot;,</span>
<a href="#l5.30"></a><span id="l5.30">   &quot;onkeydown&quot;,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  &quot;onkeyup&quot;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  &quot;onkeyup&quot;,</span>
<a href="#l5.33"></a><span id="l5.33"> ];</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35"> // Following are commonly-used strings</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37"> // Also accept: sRGB: #RRGGBB //</span>
<a href="#l5.38"></a><span id="l5.38"> var gHTMLColors =</span>
<a href="#l5.39"></a><span id="l5.39"> [</span>
<a href="#l5.40"></a><span id="l5.40">   &quot;Aqua&quot;,</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineat">@@ -52,57 +52,57 @@ var gHTMLColors =</span>
<a href="#l5.42"></a><span id="l5.42">   &quot;Maroon&quot;,</span>
<a href="#l5.43"></a><span id="l5.43">   &quot;Navy&quot;,</span>
<a href="#l5.44"></a><span id="l5.44">   &quot;Olive&quot;,</span>
<a href="#l5.45"></a><span id="l5.45">   &quot;Purple&quot;,</span>
<a href="#l5.46"></a><span id="l5.46">   &quot;Red&quot;,</span>
<a href="#l5.47"></a><span id="l5.47">   &quot;Silver&quot;,</span>
<a href="#l5.48"></a><span id="l5.48">   &quot;Teal&quot;,</span>
<a href="#l5.49"></a><span id="l5.49">   &quot;White&quot;,</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-  &quot;Yellow&quot;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  &quot;Yellow&quot;,</span>
<a href="#l5.52"></a><span id="l5.52"> ];</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54"> var gHAlign =</span>
<a href="#l5.55"></a><span id="l5.55"> [</span>
<a href="#l5.56"></a><span id="l5.56">   &quot;left&quot;,</span>
<a href="#l5.57"></a><span id="l5.57">   &quot;center&quot;,</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.60"></a><span id="l5.60"> ];</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62"> var gHAlignJustify =</span>
<a href="#l5.63"></a><span id="l5.63"> [</span>
<a href="#l5.64"></a><span id="l5.64">   &quot;left&quot;,</span>
<a href="#l5.65"></a><span id="l5.65">   &quot;center&quot;,</span>
<a href="#l5.66"></a><span id="l5.66">   &quot;right&quot;,</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  &quot;justify&quot;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  &quot;justify&quot;,</span>
<a href="#l5.69"></a><span id="l5.69"> ];</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71"> var gHAlignTableContent =</span>
<a href="#l5.72"></a><span id="l5.72"> [</span>
<a href="#l5.73"></a><span id="l5.73">   &quot;left&quot;,</span>
<a href="#l5.74"></a><span id="l5.74">   &quot;center&quot;,</span>
<a href="#l5.75"></a><span id="l5.75">   &quot;right&quot;,</span>
<a href="#l5.76"></a><span id="l5.76">   &quot;justify&quot;,</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-  &quot;char&quot;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  &quot;char&quot;,</span>
<a href="#l5.79"></a><span id="l5.79"> ];</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81"> var gVAlignTable =</span>
<a href="#l5.82"></a><span id="l5.82"> [</span>
<a href="#l5.83"></a><span id="l5.83">   &quot;top&quot;,</span>
<a href="#l5.84"></a><span id="l5.84">   &quot;middle&quot;,</span>
<a href="#l5.85"></a><span id="l5.85">   &quot;bottom&quot;,</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-  &quot;baseline&quot;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  &quot;baseline&quot;,</span>
<a href="#l5.88"></a><span id="l5.88"> ];</span>
<a href="#l5.89"></a><span id="l5.89"> </span>
<a href="#l5.90"></a><span id="l5.90"> var gTarget =</span>
<a href="#l5.91"></a><span id="l5.91"> [</span>
<a href="#l5.92"></a><span id="l5.92">   &quot;_blank&quot;,</span>
<a href="#l5.93"></a><span id="l5.93">   &quot;_self&quot;,</span>
<a href="#l5.94"></a><span id="l5.94">   &quot;_parent&quot;,</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-  &quot;_top&quot;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  &quot;_top&quot;,</span>
<a href="#l5.97"></a><span id="l5.97"> ];</span>
<a href="#l5.98"></a><span id="l5.98"> </span>
<a href="#l5.99"></a><span id="l5.99"> // ================ HTML Attributes ================ //</span>
<a href="#l5.100"></a><span id="l5.100"> /* For each element, there is an array of attributes,</span>
<a href="#l5.101"></a><span id="l5.101">    whose name is the element name,</span>
<a href="#l5.102"></a><span id="l5.102">    used to fill the &quot;Attribute Name&quot; menulist.</span>
<a href="#l5.103"></a><span id="l5.103">    For each of those attributes, if they have a specific</span>
<a href="#l5.104"></a><span id="l5.104">    set of values, those are listed in an array named:</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineat">@@ -122,17 +122,17 @@ var gTarget =</span>
<a href="#l5.106"></a><span id="l5.106">    Most elements have the &quot;dir&quot; attribute,</span>
<a href="#l5.107"></a><span id="l5.107">    so we use this value array</span>
<a href="#l5.108"></a><span id="l5.108">    for all elements instead of specifying</span>
<a href="#l5.109"></a><span id="l5.109">    separately for each element</span>
<a href="#l5.110"></a><span id="l5.110"> */</span>
<a href="#l5.111"></a><span id="l5.111"> gHTMLAttr.all_dir =</span>
<a href="#l5.112"></a><span id="l5.112"> [</span>
<a href="#l5.113"></a><span id="l5.113">   &quot;ltr&quot;,</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-  &quot;rtl&quot;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  &quot;rtl&quot;,</span>
<a href="#l5.116"></a><span id="l5.116"> ];</span>
<a href="#l5.117"></a><span id="l5.117"> </span>
<a href="#l5.118"></a><span id="l5.118"> </span>
<a href="#l5.119"></a><span id="l5.119"> gHTMLAttr.a =</span>
<a href="#l5.120"></a><span id="l5.120"> [</span>
<a href="#l5.121"></a><span id="l5.121">   &quot;charset&quot;,</span>
<a href="#l5.122"></a><span id="l5.122">   &quot;type&quot;,</span>
<a href="#l5.123"></a><span id="l5.123">   &quot;name&quot;,</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineat">@@ -144,17 +144,17 @@ gHTMLAttr.a =</span>
<a href="#l5.125"></a><span id="l5.125">   &quot;!accesskey&quot;,</span>
<a href="#l5.126"></a><span id="l5.126">   &quot;shape&quot;,   // with imagemap //</span>
<a href="#l5.127"></a><span id="l5.127">   &quot;coords&quot;,  // with imagemap //</span>
<a href="#l5.128"></a><span id="l5.128">   &quot;#tabindex&quot;,</span>
<a href="#l5.129"></a><span id="l5.129">   &quot;-&quot;,</span>
<a href="#l5.130"></a><span id="l5.130">   &quot;_core&quot;,</span>
<a href="#l5.131"></a><span id="l5.131">   &quot;-&quot;,</span>
<a href="#l5.132"></a><span id="l5.132">   &quot;^lang&quot;,</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.135"></a><span id="l5.135"> ];</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137"> gHTMLAttr.a_target = gTarget;</span>
<a href="#l5.138"></a><span id="l5.138"> </span>
<a href="#l5.139"></a><span id="l5.139"> gHTMLAttr.a_rel =</span>
<a href="#l5.140"></a><span id="l5.140"> [</span>
<a href="#l5.141"></a><span id="l5.141">   &quot;alternate&quot;,</span>
<a href="#l5.142"></a><span id="l5.142">   &quot;stylesheet&quot;,</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineat">@@ -165,17 +165,17 @@ gHTMLAttr.a_rel =</span>
<a href="#l5.144"></a><span id="l5.144">   &quot;index&quot;,</span>
<a href="#l5.145"></a><span id="l5.145">   &quot;glossary&quot;,</span>
<a href="#l5.146"></a><span id="l5.146">   &quot;copyright&quot;,</span>
<a href="#l5.147"></a><span id="l5.147">   &quot;chapter&quot;,</span>
<a href="#l5.148"></a><span id="l5.148">   &quot;section&quot;,</span>
<a href="#l5.149"></a><span id="l5.149">   &quot;subsection&quot;,</span>
<a href="#l5.150"></a><span id="l5.150">   &quot;appendix&quot;,</span>
<a href="#l5.151"></a><span id="l5.151">   &quot;help&quot;,</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-  &quot;bookmark&quot;</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+  &quot;bookmark&quot;,</span>
<a href="#l5.154"></a><span id="l5.154"> ];</span>
<a href="#l5.155"></a><span id="l5.155"> </span>
<a href="#l5.156"></a><span id="l5.156"> gHTMLAttr.a_rev =</span>
<a href="#l5.157"></a><span id="l5.157"> [</span>
<a href="#l5.158"></a><span id="l5.158">   &quot;alternate&quot;,</span>
<a href="#l5.159"></a><span id="l5.159">   &quot;stylesheet&quot;,</span>
<a href="#l5.160"></a><span id="l5.160">   &quot;start&quot;,</span>
<a href="#l5.161"></a><span id="l5.161">   &quot;next&quot;,</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineat">@@ -184,49 +184,49 @@ gHTMLAttr.a_rev =</span>
<a href="#l5.163"></a><span id="l5.163">   &quot;index&quot;,</span>
<a href="#l5.164"></a><span id="l5.164">   &quot;glossary&quot;,</span>
<a href="#l5.165"></a><span id="l5.165">   &quot;copyright&quot;,</span>
<a href="#l5.166"></a><span id="l5.166">   &quot;chapter&quot;,</span>
<a href="#l5.167"></a><span id="l5.167">   &quot;section&quot;,</span>
<a href="#l5.168"></a><span id="l5.168">   &quot;subsection&quot;,</span>
<a href="#l5.169"></a><span id="l5.169">   &quot;appendix&quot;,</span>
<a href="#l5.170"></a><span id="l5.170">   &quot;help&quot;,</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-  &quot;bookmark&quot;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  &quot;bookmark&quot;,</span>
<a href="#l5.173"></a><span id="l5.173"> ];</span>
<a href="#l5.174"></a><span id="l5.174"> </span>
<a href="#l5.175"></a><span id="l5.175"> gHTMLAttr.a_shape =</span>
<a href="#l5.176"></a><span id="l5.176"> [</span>
<a href="#l5.177"></a><span id="l5.177">   &quot;rect&quot;,</span>
<a href="#l5.178"></a><span id="l5.178">   &quot;circle&quot;,</span>
<a href="#l5.179"></a><span id="l5.179">   &quot;poly&quot;,</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-  &quot;default&quot;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+  &quot;default&quot;,</span>
<a href="#l5.182"></a><span id="l5.182"> ];</span>
<a href="#l5.183"></a><span id="l5.183"> </span>
<a href="#l5.184"></a><span id="l5.184"> gHTMLAttr.abbr =</span>
<a href="#l5.185"></a><span id="l5.185"> [</span>
<a href="#l5.186"></a><span id="l5.186">   &quot;_core&quot;,</span>
<a href="#l5.187"></a><span id="l5.187">   &quot;-&quot;,</span>
<a href="#l5.188"></a><span id="l5.188">   &quot;^lang&quot;,</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.191"></a><span id="l5.191"> ];</span>
<a href="#l5.192"></a><span id="l5.192"> </span>
<a href="#l5.193"></a><span id="l5.193"> gHTMLAttr.acronym =</span>
<a href="#l5.194"></a><span id="l5.194"> [</span>
<a href="#l5.195"></a><span id="l5.195">   &quot;_core&quot;,</span>
<a href="#l5.196"></a><span id="l5.196">   &quot;-&quot;,</span>
<a href="#l5.197"></a><span id="l5.197">   &quot;^lang&quot;,</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.200"></a><span id="l5.200"> ];</span>
<a href="#l5.201"></a><span id="l5.201"> </span>
<a href="#l5.202"></a><span id="l5.202"> gHTMLAttr.address =</span>
<a href="#l5.203"></a><span id="l5.203"> [</span>
<a href="#l5.204"></a><span id="l5.204">   &quot;_core&quot;,</span>
<a href="#l5.205"></a><span id="l5.205">   &quot;-&quot;,</span>
<a href="#l5.206"></a><span id="l5.206">   &quot;^lang&quot;,</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.209"></a><span id="l5.209"> ];</span>
<a href="#l5.210"></a><span id="l5.210"> </span>
<a href="#l5.211"></a><span id="l5.211"> // this is deprecated //</span>
<a href="#l5.212"></a><span id="l5.212"> gHTMLAttr.applet =</span>
<a href="#l5.213"></a><span id="l5.213"> [</span>
<a href="#l5.214"></a><span id="l5.214">   &quot;codebase&quot;,</span>
<a href="#l5.215"></a><span id="l5.215">   &quot;archive&quot;,</span>
<a href="#l5.216"></a><span id="l5.216">   &quot;code&quot;,</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineat">@@ -234,397 +234,397 @@ gHTMLAttr.applet =</span>
<a href="#l5.218"></a><span id="l5.218">   &quot;alt&quot;,</span>
<a href="#l5.219"></a><span id="l5.219">   &quot;name&quot;,</span>
<a href="#l5.220"></a><span id="l5.220">   &quot;%$width&quot;,</span>
<a href="#l5.221"></a><span id="l5.221">   &quot;%$height&quot;,</span>
<a href="#l5.222"></a><span id="l5.222">   &quot;align&quot;,</span>
<a href="#l5.223"></a><span id="l5.223">   &quot;#hspace&quot;,</span>
<a href="#l5.224"></a><span id="l5.224">   &quot;#vspace&quot;,</span>
<a href="#l5.225"></a><span id="l5.225">   &quot;-&quot;,</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-  &quot;_core&quot;</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+  &quot;_core&quot;,</span>
<a href="#l5.228"></a><span id="l5.228"> ];</span>
<a href="#l5.229"></a><span id="l5.229"> </span>
<a href="#l5.230"></a><span id="l5.230"> gHTMLAttr.applet_align =</span>
<a href="#l5.231"></a><span id="l5.231"> [</span>
<a href="#l5.232"></a><span id="l5.232">   &quot;top&quot;,</span>
<a href="#l5.233"></a><span id="l5.233">   &quot;middle&quot;,</span>
<a href="#l5.234"></a><span id="l5.234">   &quot;bottom&quot;,</span>
<a href="#l5.235"></a><span id="l5.235">   &quot;left&quot;,</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.238"></a><span id="l5.238"> ];</span>
<a href="#l5.239"></a><span id="l5.239"> </span>
<a href="#l5.240"></a><span id="l5.240"> gHTMLAttr.area =</span>
<a href="#l5.241"></a><span id="l5.241"> [</span>
<a href="#l5.242"></a><span id="l5.242">   &quot;shape&quot;,</span>
<a href="#l5.243"></a><span id="l5.243">   &quot;coords&quot;,</span>
<a href="#l5.244"></a><span id="l5.244">   &quot;href&quot;,</span>
<a href="#l5.245"></a><span id="l5.245">   &quot;nohref&quot;,</span>
<a href="#l5.246"></a><span id="l5.246">   &quot;target&quot;,</span>
<a href="#l5.247"></a><span id="l5.247">   &quot;$alt&quot;,</span>
<a href="#l5.248"></a><span id="l5.248">   &quot;#tabindex&quot;,</span>
<a href="#l5.249"></a><span id="l5.249">   &quot;!accesskey&quot;,</span>
<a href="#l5.250"></a><span id="l5.250">   &quot;-&quot;,</span>
<a href="#l5.251"></a><span id="l5.251">   &quot;_core&quot;,</span>
<a href="#l5.252"></a><span id="l5.252">   &quot;-&quot;,</span>
<a href="#l5.253"></a><span id="l5.253">   &quot;^lang&quot;,</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.256"></a><span id="l5.256"> ];</span>
<a href="#l5.257"></a><span id="l5.257"> </span>
<a href="#l5.258"></a><span id="l5.258"> gHTMLAttr.area_target = gTarget;</span>
<a href="#l5.259"></a><span id="l5.259"> </span>
<a href="#l5.260"></a><span id="l5.260"> gHTMLAttr.area_shape =</span>
<a href="#l5.261"></a><span id="l5.261"> [</span>
<a href="#l5.262"></a><span id="l5.262">   &quot;rect&quot;,</span>
<a href="#l5.263"></a><span id="l5.263">   &quot;circle&quot;,</span>
<a href="#l5.264"></a><span id="l5.264">   &quot;poly&quot;,</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-  &quot;default&quot;</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+  &quot;default&quot;,</span>
<a href="#l5.267"></a><span id="l5.267"> ];</span>
<a href="#l5.268"></a><span id="l5.268"> </span>
<a href="#l5.269"></a><span id="l5.269"> gHTMLAttr.area_nohref =</span>
<a href="#l5.270"></a><span id="l5.270"> [</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-  &quot;nohref&quot;</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+  &quot;nohref&quot;,</span>
<a href="#l5.273"></a><span id="l5.273"> ];</span>
<a href="#l5.274"></a><span id="l5.274"> </span>
<a href="#l5.275"></a><span id="l5.275"> gHTMLAttr.b =</span>
<a href="#l5.276"></a><span id="l5.276"> [</span>
<a href="#l5.277"></a><span id="l5.277">   &quot;_core&quot;,</span>
<a href="#l5.278"></a><span id="l5.278">   &quot;-&quot;,</span>
<a href="#l5.279"></a><span id="l5.279">   &quot;^lang&quot;,</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.282"></a><span id="l5.282"> ];</span>
<a href="#l5.283"></a><span id="l5.283"> </span>
<a href="#l5.284"></a><span id="l5.284"> gHTMLAttr.base =</span>
<a href="#l5.285"></a><span id="l5.285"> [</span>
<a href="#l5.286"></a><span id="l5.286">   &quot;href&quot;,</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-  &quot;target&quot;</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+  &quot;target&quot;,</span>
<a href="#l5.289"></a><span id="l5.289"> ];</span>
<a href="#l5.290"></a><span id="l5.290"> </span>
<a href="#l5.291"></a><span id="l5.291"> gHTMLAttr.base_target = gTarget;</span>
<a href="#l5.292"></a><span id="l5.292"> </span>
<a href="#l5.293"></a><span id="l5.293"> // this is deprecated //</span>
<a href="#l5.294"></a><span id="l5.294"> gHTMLAttr.basefont =</span>
<a href="#l5.295"></a><span id="l5.295"> [</span>
<a href="#l5.296"></a><span id="l5.296">   &quot;^id&quot;,</span>
<a href="#l5.297"></a><span id="l5.297">   &quot;$size&quot;,</span>
<a href="#l5.298"></a><span id="l5.298">   &quot;color&quot;,</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-  &quot;face&quot;</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+  &quot;face&quot;,</span>
<a href="#l5.301"></a><span id="l5.301"> ];</span>
<a href="#l5.302"></a><span id="l5.302"> </span>
<a href="#l5.303"></a><span id="l5.303"> gHTMLAttr.basefont_color = gHTMLColors;</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305"> gHTMLAttr.bdo =</span>
<a href="#l5.306"></a><span id="l5.306"> [</span>
<a href="#l5.307"></a><span id="l5.307">   &quot;_core&quot;,</span>
<a href="#l5.308"></a><span id="l5.308">   &quot;-&quot;,</span>
<a href="#l5.309"></a><span id="l5.309">   &quot;^lang&quot;,</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-  &quot;$dir&quot;</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+  &quot;$dir&quot;,</span>
<a href="#l5.312"></a><span id="l5.312"> ];</span>
<a href="#l5.313"></a><span id="l5.313"> </span>
<a href="#l5.314"></a><span id="l5.314"> gHTMLAttr.bdo_dir =</span>
<a href="#l5.315"></a><span id="l5.315"> [</span>
<a href="#l5.316"></a><span id="l5.316">   &quot;ltr&quot;,</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-  &quot;rtl&quot;</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+  &quot;rtl&quot;,</span>
<a href="#l5.319"></a><span id="l5.319"> ];</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321"> gHTMLAttr.big =</span>
<a href="#l5.322"></a><span id="l5.322"> [</span>
<a href="#l5.323"></a><span id="l5.323">   &quot;_core&quot;,</span>
<a href="#l5.324"></a><span id="l5.324">   &quot;-&quot;,</span>
<a href="#l5.325"></a><span id="l5.325">   &quot;^lang&quot;,</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.328"></a><span id="l5.328"> ];</span>
<a href="#l5.329"></a><span id="l5.329"> </span>
<a href="#l5.330"></a><span id="l5.330"> gHTMLAttr.blockquote =</span>
<a href="#l5.331"></a><span id="l5.331"> [</span>
<a href="#l5.332"></a><span id="l5.332">   &quot;cite&quot;,</span>
<a href="#l5.333"></a><span id="l5.333">   &quot;-&quot;,</span>
<a href="#l5.334"></a><span id="l5.334">   &quot;_core&quot;,</span>
<a href="#l5.335"></a><span id="l5.335">   &quot;-&quot;,</span>
<a href="#l5.336"></a><span id="l5.336">   &quot;^lang&quot;,</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.339"></a><span id="l5.339"> ];</span>
<a href="#l5.340"></a><span id="l5.340"> </span>
<a href="#l5.341"></a><span id="l5.341"> gHTMLAttr.body =</span>
<a href="#l5.342"></a><span id="l5.342"> [</span>
<a href="#l5.343"></a><span id="l5.343">   &quot;background&quot;,</span>
<a href="#l5.344"></a><span id="l5.344">   &quot;bgcolor&quot;,</span>
<a href="#l5.345"></a><span id="l5.345">   &quot;text&quot;,</span>
<a href="#l5.346"></a><span id="l5.346">   &quot;link&quot;,</span>
<a href="#l5.347"></a><span id="l5.347">   &quot;vlink&quot;,</span>
<a href="#l5.348"></a><span id="l5.348">   &quot;alink&quot;,</span>
<a href="#l5.349"></a><span id="l5.349">   &quot;-&quot;,</span>
<a href="#l5.350"></a><span id="l5.350">   &quot;_core&quot;,</span>
<a href="#l5.351"></a><span id="l5.351">   &quot;-&quot;,</span>
<a href="#l5.352"></a><span id="l5.352">   &quot;^lang&quot;,</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.355"></a><span id="l5.355"> ];</span>
<a href="#l5.356"></a><span id="l5.356"> </span>
<a href="#l5.357"></a><span id="l5.357"> gHTMLAttr.body_bgcolor = gHTMLColors;</span>
<a href="#l5.358"></a><span id="l5.358"> </span>
<a href="#l5.359"></a><span id="l5.359"> gHTMLAttr.body_text = gHTMLColors;</span>
<a href="#l5.360"></a><span id="l5.360"> </span>
<a href="#l5.361"></a><span id="l5.361"> gHTMLAttr.body_link = gHTMLColors;</span>
<a href="#l5.362"></a><span id="l5.362"> </span>
<a href="#l5.363"></a><span id="l5.363"> gHTMLAttr.body_vlink = gHTMLColors;</span>
<a href="#l5.364"></a><span id="l5.364"> </span>
<a href="#l5.365"></a><span id="l5.365"> gHTMLAttr.body_alink = gHTMLColors;</span>
<a href="#l5.366"></a><span id="l5.366"> </span>
<a href="#l5.367"></a><span id="l5.367"> gHTMLAttr.br =</span>
<a href="#l5.368"></a><span id="l5.368"> [</span>
<a href="#l5.369"></a><span id="l5.369">   &quot;clear&quot;,</span>
<a href="#l5.370"></a><span id="l5.370">   &quot;-&quot;,</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-  &quot;_core&quot;</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+  &quot;_core&quot;,</span>
<a href="#l5.373"></a><span id="l5.373"> ];</span>
<a href="#l5.374"></a><span id="l5.374"> </span>
<a href="#l5.375"></a><span id="l5.375"> gHTMLAttr.br_clear =</span>
<a href="#l5.376"></a><span id="l5.376"> [</span>
<a href="#l5.377"></a><span id="l5.377">   &quot;none&quot;,</span>
<a href="#l5.378"></a><span id="l5.378">   &quot;left&quot;,</span>
<a href="#l5.379"></a><span id="l5.379">   &quot;all&quot;,</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.382"></a><span id="l5.382"> ];</span>
<a href="#l5.383"></a><span id="l5.383"> </span>
<a href="#l5.384"></a><span id="l5.384"> gHTMLAttr.button =</span>
<a href="#l5.385"></a><span id="l5.385"> [</span>
<a href="#l5.386"></a><span id="l5.386">   &quot;name&quot;,</span>
<a href="#l5.387"></a><span id="l5.387">   &quot;value&quot;,</span>
<a href="#l5.388"></a><span id="l5.388">   &quot;$type&quot;,</span>
<a href="#l5.389"></a><span id="l5.389">   &quot;disabled&quot;,</span>
<a href="#l5.390"></a><span id="l5.390">   &quot;#tabindex&quot;,</span>
<a href="#l5.391"></a><span id="l5.391">   &quot;!accesskey&quot;,</span>
<a href="#l5.392"></a><span id="l5.392">   &quot;-&quot;,</span>
<a href="#l5.393"></a><span id="l5.393">   &quot;_core&quot;,</span>
<a href="#l5.394"></a><span id="l5.394">   &quot;-&quot;,</span>
<a href="#l5.395"></a><span id="l5.395">   &quot;^lang&quot;,</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.398"></a><span id="l5.398"> ];</span>
<a href="#l5.399"></a><span id="l5.399"> </span>
<a href="#l5.400"></a><span id="l5.400"> gHTMLAttr.button_type =</span>
<a href="#l5.401"></a><span id="l5.401"> [</span>
<a href="#l5.402"></a><span id="l5.402">   &quot;submit&quot;,</span>
<a href="#l5.403"></a><span id="l5.403">   &quot;button&quot;,</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-  &quot;reset&quot;</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+  &quot;reset&quot;,</span>
<a href="#l5.406"></a><span id="l5.406"> ];</span>
<a href="#l5.407"></a><span id="l5.407"> </span>
<a href="#l5.408"></a><span id="l5.408"> gHTMLAttr.button_disabled =</span>
<a href="#l5.409"></a><span id="l5.409"> [</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-  &quot;disabled&quot;</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+  &quot;disabled&quot;,</span>
<a href="#l5.412"></a><span id="l5.412"> ];</span>
<a href="#l5.413"></a><span id="l5.413"> </span>
<a href="#l5.414"></a><span id="l5.414"> gHTMLAttr.caption =</span>
<a href="#l5.415"></a><span id="l5.415"> [</span>
<a href="#l5.416"></a><span id="l5.416">   &quot;align&quot;,</span>
<a href="#l5.417"></a><span id="l5.417">   &quot;-&quot;,</span>
<a href="#l5.418"></a><span id="l5.418">   &quot;_core&quot;,</span>
<a href="#l5.419"></a><span id="l5.419">   &quot;-&quot;,</span>
<a href="#l5.420"></a><span id="l5.420">   &quot;^lang&quot;,</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.423"></a><span id="l5.423"> ];</span>
<a href="#l5.424"></a><span id="l5.424"> </span>
<a href="#l5.425"></a><span id="l5.425"> gHTMLAttr.caption_align =</span>
<a href="#l5.426"></a><span id="l5.426"> [</span>
<a href="#l5.427"></a><span id="l5.427">   &quot;top&quot;,</span>
<a href="#l5.428"></a><span id="l5.428">   &quot;bottom&quot;,</span>
<a href="#l5.429"></a><span id="l5.429">   &quot;left&quot;,</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.432"></a><span id="l5.432"> ];</span>
<a href="#l5.433"></a><span id="l5.433"> </span>
<a href="#l5.434"></a><span id="l5.434"> </span>
<a href="#l5.435"></a><span id="l5.435"> // this is deprecated //</span>
<a href="#l5.436"></a><span id="l5.436"> gHTMLAttr.center =</span>
<a href="#l5.437"></a><span id="l5.437"> [</span>
<a href="#l5.438"></a><span id="l5.438">   &quot;_core&quot;,</span>
<a href="#l5.439"></a><span id="l5.439">   &quot;-&quot;,</span>
<a href="#l5.440"></a><span id="l5.440">   &quot;^lang&quot;,</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.443"></a><span id="l5.443"> ];</span>
<a href="#l5.444"></a><span id="l5.444"> </span>
<a href="#l5.445"></a><span id="l5.445"> gHTMLAttr.cite =</span>
<a href="#l5.446"></a><span id="l5.446"> [</span>
<a href="#l5.447"></a><span id="l5.447">   &quot;_core&quot;,</span>
<a href="#l5.448"></a><span id="l5.448">   &quot;-&quot;,</span>
<a href="#l5.449"></a><span id="l5.449">   &quot;^lang&quot;,</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.452"></a><span id="l5.452"> ];</span>
<a href="#l5.453"></a><span id="l5.453"> </span>
<a href="#l5.454"></a><span id="l5.454"> gHTMLAttr.code =</span>
<a href="#l5.455"></a><span id="l5.455"> [</span>
<a href="#l5.456"></a><span id="l5.456">   &quot;_core&quot;,</span>
<a href="#l5.457"></a><span id="l5.457">   &quot;-&quot;,</span>
<a href="#l5.458"></a><span id="l5.458">   &quot;^lang&quot;,</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.461"></a><span id="l5.461"> ];</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463"> gHTMLAttr.col =</span>
<a href="#l5.464"></a><span id="l5.464"> [</span>
<a href="#l5.465"></a><span id="l5.465">   &quot;#$span&quot;,</span>
<a href="#l5.466"></a><span id="l5.466">   &quot;%width&quot;,</span>
<a href="#l5.467"></a><span id="l5.467">   &quot;align&quot;,</span>
<a href="#l5.468"></a><span id="l5.468">   &quot;!char&quot;,</span>
<a href="#l5.469"></a><span id="l5.469">   &quot;#charoff&quot;,</span>
<a href="#l5.470"></a><span id="l5.470">   &quot;valign&quot;,</span>
<a href="#l5.471"></a><span id="l5.471">   &quot;char&quot;,</span>
<a href="#l5.472"></a><span id="l5.472">   &quot;-&quot;,</span>
<a href="#l5.473"></a><span id="l5.473">   &quot;_core&quot;,</span>
<a href="#l5.474"></a><span id="l5.474">   &quot;-&quot;,</span>
<a href="#l5.475"></a><span id="l5.475">   &quot;^lang&quot;,</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.478"></a><span id="l5.478"> ];</span>
<a href="#l5.479"></a><span id="l5.479"> </span>
<a href="#l5.480"></a><span id="l5.480"> gHTMLAttr.col_span =</span>
<a href="#l5.481"></a><span id="l5.481"> [</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-  &quot;1&quot;  // default</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+  &quot;1&quot;,  // default</span>
<a href="#l5.484"></a><span id="l5.484"> ];</span>
<a href="#l5.485"></a><span id="l5.485"> </span>
<a href="#l5.486"></a><span id="l5.486"> gHTMLAttr.col_align = gHAlignTableContent;</span>
<a href="#l5.487"></a><span id="l5.487"> </span>
<a href="#l5.488"></a><span id="l5.488"> gHTMLAttr.col_valign =</span>
<a href="#l5.489"></a><span id="l5.489"> [</span>
<a href="#l5.490"></a><span id="l5.490">   &quot;top&quot;,</span>
<a href="#l5.491"></a><span id="l5.491">   &quot;middle&quot;,</span>
<a href="#l5.492"></a><span id="l5.492">   &quot;bottom&quot;,</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-  &quot;baseline&quot;</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+  &quot;baseline&quot;,</span>
<a href="#l5.495"></a><span id="l5.495"> ];</span>
<a href="#l5.496"></a><span id="l5.496"> </span>
<a href="#l5.497"></a><span id="l5.497"> </span>
<a href="#l5.498"></a><span id="l5.498"> gHTMLAttr.colgroup =</span>
<a href="#l5.499"></a><span id="l5.499"> [</span>
<a href="#l5.500"></a><span id="l5.500">   &quot;#$span&quot;,</span>
<a href="#l5.501"></a><span id="l5.501">   &quot;%width&quot;,</span>
<a href="#l5.502"></a><span id="l5.502">   &quot;align&quot;,</span>
<a href="#l5.503"></a><span id="l5.503">   &quot;!char&quot;,</span>
<a href="#l5.504"></a><span id="l5.504">   &quot;#charoff&quot;,</span>
<a href="#l5.505"></a><span id="l5.505">   &quot;valign&quot;,</span>
<a href="#l5.506"></a><span id="l5.506">   &quot;-&quot;,</span>
<a href="#l5.507"></a><span id="l5.507">   &quot;_core&quot;,</span>
<a href="#l5.508"></a><span id="l5.508">   &quot;-&quot;,</span>
<a href="#l5.509"></a><span id="l5.509">   &quot;^lang&quot;,</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.512"></a><span id="l5.512"> ];</span>
<a href="#l5.513"></a><span id="l5.513"> </span>
<a href="#l5.514"></a><span id="l5.514"> gHTMLAttr.colgroup_span =</span>
<a href="#l5.515"></a><span id="l5.515"> [</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-  &quot;1&quot; // default</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+  &quot;1&quot;, // default</span>
<a href="#l5.518"></a><span id="l5.518"> ];</span>
<a href="#l5.519"></a><span id="l5.519"> </span>
<a href="#l5.520"></a><span id="l5.520"> gHTMLAttr.colgroup_align = gHAlignTableContent;</span>
<a href="#l5.521"></a><span id="l5.521"> </span>
<a href="#l5.522"></a><span id="l5.522"> gHTMLAttr.colgroup_valign =</span>
<a href="#l5.523"></a><span id="l5.523"> [</span>
<a href="#l5.524"></a><span id="l5.524">   &quot;top&quot;,</span>
<a href="#l5.525"></a><span id="l5.525">   &quot;middle&quot;,</span>
<a href="#l5.526"></a><span id="l5.526">   &quot;bottom&quot;,</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineminus">-  &quot;baseline&quot;</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+  &quot;baseline&quot;,</span>
<a href="#l5.529"></a><span id="l5.529"> ];</span>
<a href="#l5.530"></a><span id="l5.530"> </span>
<a href="#l5.531"></a><span id="l5.531"> gHTMLAttr.dd =</span>
<a href="#l5.532"></a><span id="l5.532"> [</span>
<a href="#l5.533"></a><span id="l5.533">   &quot;_core&quot;,</span>
<a href="#l5.534"></a><span id="l5.534">   &quot;-&quot;,</span>
<a href="#l5.535"></a><span id="l5.535">   &quot;^lang&quot;,</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.538"></a><span id="l5.538"> ];</span>
<a href="#l5.539"></a><span id="l5.539"> </span>
<a href="#l5.540"></a><span id="l5.540"> gHTMLAttr.del =</span>
<a href="#l5.541"></a><span id="l5.541"> [</span>
<a href="#l5.542"></a><span id="l5.542">   &quot;cite&quot;,</span>
<a href="#l5.543"></a><span id="l5.543">   &quot;datetime&quot;,</span>
<a href="#l5.544"></a><span id="l5.544">   &quot;_core&quot;,</span>
<a href="#l5.545"></a><span id="l5.545">   &quot;-&quot;,</span>
<a href="#l5.546"></a><span id="l5.546">   &quot;^lang&quot;,</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.549"></a><span id="l5.549"> ];</span>
<a href="#l5.550"></a><span id="l5.550"> </span>
<a href="#l5.551"></a><span id="l5.551"> gHTMLAttr.dfn =</span>
<a href="#l5.552"></a><span id="l5.552"> [</span>
<a href="#l5.553"></a><span id="l5.553">   &quot;_core&quot;,</span>
<a href="#l5.554"></a><span id="l5.554">   &quot;-&quot;,</span>
<a href="#l5.555"></a><span id="l5.555">   &quot;^lang&quot;,</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.558"></a><span id="l5.558"> ];</span>
<a href="#l5.559"></a><span id="l5.559"> </span>
<a href="#l5.560"></a><span id="l5.560"> // this is deprecated //</span>
<a href="#l5.561"></a><span id="l5.561"> gHTMLAttr.dir =</span>
<a href="#l5.562"></a><span id="l5.562"> [</span>
<a href="#l5.563"></a><span id="l5.563">   &quot;compact&quot;,</span>
<a href="#l5.564"></a><span id="l5.564">   &quot;-&quot;,</span>
<a href="#l5.565"></a><span id="l5.565">   &quot;_core&quot;,</span>
<a href="#l5.566"></a><span id="l5.566">   &quot;-&quot;,</span>
<a href="#l5.567"></a><span id="l5.567">   &quot;^lang&quot;,</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.570"></a><span id="l5.570"> ];</span>
<a href="#l5.571"></a><span id="l5.571"> </span>
<a href="#l5.572"></a><span id="l5.572"> gHTMLAttr.dir_compact =</span>
<a href="#l5.573"></a><span id="l5.573"> [</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineminus">-  &quot;compact&quot;</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+  &quot;compact&quot;,</span>
<a href="#l5.576"></a><span id="l5.576"> ];</span>
<a href="#l5.577"></a><span id="l5.577"> </span>
<a href="#l5.578"></a><span id="l5.578"> gHTMLAttr.div =</span>
<a href="#l5.579"></a><span id="l5.579"> [</span>
<a href="#l5.580"></a><span id="l5.580">   &quot;align&quot;,</span>
<a href="#l5.581"></a><span id="l5.581">   &quot;-&quot;,</span>
<a href="#l5.582"></a><span id="l5.582">   &quot;_core&quot;,</span>
<a href="#l5.583"></a><span id="l5.583">   &quot;-&quot;,</span>
<a href="#l5.584"></a><span id="l5.584">   &quot;^lang&quot;,</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.587"></a><span id="l5.587"> ];</span>
<a href="#l5.588"></a><span id="l5.588"> </span>
<a href="#l5.589"></a><span id="l5.589"> gHTMLAttr.div_align = gHAlignJustify;</span>
<a href="#l5.590"></a><span id="l5.590"> </span>
<a href="#l5.591"></a><span id="l5.591"> gHTMLAttr.dl =</span>
<a href="#l5.592"></a><span id="l5.592"> [</span>
<a href="#l5.593"></a><span id="l5.593">   &quot;compact&quot;,</span>
<a href="#l5.594"></a><span id="l5.594">   &quot;-&quot;,</span>
<a href="#l5.595"></a><span id="l5.595">   &quot;_core&quot;,</span>
<a href="#l5.596"></a><span id="l5.596">   &quot;-&quot;,</span>
<a href="#l5.597"></a><span id="l5.597">   &quot;^lang&quot;,</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.600"></a><span id="l5.600"> ];</span>
<a href="#l5.601"></a><span id="l5.601"> </span>
<a href="#l5.602"></a><span id="l5.602"> gHTMLAttr.dl_compact =</span>
<a href="#l5.603"></a><span id="l5.603"> [</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineminus">-  &quot;compact&quot;</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineplus">+  &quot;compact&quot;,</span>
<a href="#l5.606"></a><span id="l5.606"> ];</span>
<a href="#l5.607"></a><span id="l5.607"> </span>
<a href="#l5.608"></a><span id="l5.608"> </span>
<a href="#l5.609"></a><span id="l5.609"> gHTMLAttr.dt =</span>
<a href="#l5.610"></a><span id="l5.610"> [</span>
<a href="#l5.611"></a><span id="l5.611">   &quot;_core&quot;,</span>
<a href="#l5.612"></a><span id="l5.612">   &quot;-&quot;,</span>
<a href="#l5.613"></a><span id="l5.613">   &quot;^lang&quot;,</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.616"></a><span id="l5.616"> ];</span>
<a href="#l5.617"></a><span id="l5.617"> </span>
<a href="#l5.618"></a><span id="l5.618"> gHTMLAttr.em =</span>
<a href="#l5.619"></a><span id="l5.619"> [</span>
<a href="#l5.620"></a><span id="l5.620">   &quot;_core&quot;,</span>
<a href="#l5.621"></a><span id="l5.621">   &quot;-&quot;,</span>
<a href="#l5.622"></a><span id="l5.622">   &quot;^lang&quot;,</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.625"></a><span id="l5.625"> ];</span>
<a href="#l5.626"></a><span id="l5.626"> </span>
<a href="#l5.627"></a><span id="l5.627"> gHTMLAttr.fieldset =</span>
<a href="#l5.628"></a><span id="l5.628"> [</span>
<a href="#l5.629"></a><span id="l5.629">   &quot;_core&quot;,</span>
<a href="#l5.630"></a><span id="l5.630">   &quot;-&quot;,</span>
<a href="#l5.631"></a><span id="l5.631">   &quot;^lang&quot;,</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.634"></a><span id="l5.634"> ];</span>
<a href="#l5.635"></a><span id="l5.635"> </span>
<a href="#l5.636"></a><span id="l5.636"> // this is deprecated //</span>
<a href="#l5.637"></a><span id="l5.637"> gHTMLAttr.font =</span>
<a href="#l5.638"></a><span id="l5.638"> [</span>
<a href="#l5.639"></a><span id="l5.639">   &quot;+size&quot;,</span>
<a href="#l5.640"></a><span id="l5.640">   &quot;color&quot;,</span>
<a href="#l5.641"></a><span id="l5.641">   &quot;face&quot;,</span>
<a href="#l5.642"></a><span id="l5.642">   &quot;-&quot;,</span>
<a href="#l5.643"></a><span id="l5.643">   &quot;_core&quot;,</span>
<a href="#l5.644"></a><span id="l5.644">   &quot;-&quot;,</span>
<a href="#l5.645"></a><span id="l5.645">   &quot;^lang&quot;,</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.648"></a><span id="l5.648"> ];</span>
<a href="#l5.649"></a><span id="l5.649"> </span>
<a href="#l5.650"></a><span id="l5.650"> gHTMLAttr.font_color = gHTMLColors;</span>
<a href="#l5.651"></a><span id="l5.651"> </span>
<a href="#l5.652"></a><span id="l5.652"> gHTMLAttr.form =</span>
<a href="#l5.653"></a><span id="l5.653"> [</span>
<a href="#l5.654"></a><span id="l5.654">   &quot;$action&quot;,</span>
<a href="#l5.655"></a><span id="l5.655">   &quot;$method&quot;,</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineat">@@ -632,225 +632,225 @@ gHTMLAttr.form =</span>
<a href="#l5.657"></a><span id="l5.657">   &quot;accept&quot;,</span>
<a href="#l5.658"></a><span id="l5.658">   &quot;name&quot;,</span>
<a href="#l5.659"></a><span id="l5.659">   &quot;accept-charset&quot;,</span>
<a href="#l5.660"></a><span id="l5.660">   &quot;target&quot;,</span>
<a href="#l5.661"></a><span id="l5.661">   &quot;-&quot;,</span>
<a href="#l5.662"></a><span id="l5.662">   &quot;_core&quot;,</span>
<a href="#l5.663"></a><span id="l5.663">   &quot;-&quot;,</span>
<a href="#l5.664"></a><span id="l5.664">   &quot;^lang&quot;,</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.667"></a><span id="l5.667"> ];</span>
<a href="#l5.668"></a><span id="l5.668"> </span>
<a href="#l5.669"></a><span id="l5.669"> gHTMLAttr.form_method =</span>
<a href="#l5.670"></a><span id="l5.670"> [</span>
<a href="#l5.671"></a><span id="l5.671">   &quot;get&quot;,</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineminus">-  &quot;post&quot;</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+  &quot;post&quot;,</span>
<a href="#l5.674"></a><span id="l5.674"> ];</span>
<a href="#l5.675"></a><span id="l5.675"> </span>
<a href="#l5.676"></a><span id="l5.676"> gHTMLAttr.form_enctype =</span>
<a href="#l5.677"></a><span id="l5.677"> [</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineminus">-  &quot;application/x-www-form-urlencoded&quot;</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineplus">+  &quot;application/x-www-form-urlencoded&quot;,</span>
<a href="#l5.680"></a><span id="l5.680"> ];</span>
<a href="#l5.681"></a><span id="l5.681"> </span>
<a href="#l5.682"></a><span id="l5.682"> gHTMLAttr.form_target = gTarget;</span>
<a href="#l5.683"></a><span id="l5.683"> </span>
<a href="#l5.684"></a><span id="l5.684"> gHTMLAttr.frame =</span>
<a href="#l5.685"></a><span id="l5.685"> [</span>
<a href="#l5.686"></a><span id="l5.686">   &quot;longdesc&quot;,</span>
<a href="#l5.687"></a><span id="l5.687">   &quot;name&quot;,</span>
<a href="#l5.688"></a><span id="l5.688">   &quot;src&quot;,</span>
<a href="#l5.689"></a><span id="l5.689">   &quot;#frameborder&quot;,</span>
<a href="#l5.690"></a><span id="l5.690">   &quot;#marginwidth&quot;,</span>
<a href="#l5.691"></a><span id="l5.691">   &quot;#marginheight&quot;,</span>
<a href="#l5.692"></a><span id="l5.692">   &quot;noresize&quot;,</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineminus">-  &quot;$scrolling&quot;</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+  &quot;$scrolling&quot;,</span>
<a href="#l5.695"></a><span id="l5.695"> ];</span>
<a href="#l5.696"></a><span id="l5.696"> </span>
<a href="#l5.697"></a><span id="l5.697"> gHTMLAttr.frame_frameborder =</span>
<a href="#l5.698"></a><span id="l5.698"> [</span>
<a href="#l5.699"></a><span id="l5.699">   &quot;1&quot;,</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineminus">-  &quot;0&quot;</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineplus">+  &quot;0&quot;,</span>
<a href="#l5.702"></a><span id="l5.702"> ];</span>
<a href="#l5.703"></a><span id="l5.703"> </span>
<a href="#l5.704"></a><span id="l5.704"> gHTMLAttr.frame_noresize =</span>
<a href="#l5.705"></a><span id="l5.705"> [</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineminus">-  &quot;noresize&quot;</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineplus">+  &quot;noresize&quot;,</span>
<a href="#l5.708"></a><span id="l5.708"> ];</span>
<a href="#l5.709"></a><span id="l5.709"> </span>
<a href="#l5.710"></a><span id="l5.710"> gHTMLAttr.frame_scrolling =</span>
<a href="#l5.711"></a><span id="l5.711"> [</span>
<a href="#l5.712"></a><span id="l5.712">   &quot;auto&quot;,</span>
<a href="#l5.713"></a><span id="l5.713">   &quot;yes&quot;,</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineminus">-  &quot;no&quot;</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineplus">+  &quot;no&quot;,</span>
<a href="#l5.716"></a><span id="l5.716"> ];</span>
<a href="#l5.717"></a><span id="l5.717"> </span>
<a href="#l5.718"></a><span id="l5.718"> </span>
<a href="#l5.719"></a><span id="l5.719"> gHTMLAttr.frameset =</span>
<a href="#l5.720"></a><span id="l5.720"> [</span>
<a href="#l5.721"></a><span id="l5.721">   &quot;rows&quot;,</span>
<a href="#l5.722"></a><span id="l5.722">   &quot;cols&quot;,</span>
<a href="#l5.723"></a><span id="l5.723">   &quot;-&quot;,</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineminus">-  &quot;_core&quot;</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+  &quot;_core&quot;,</span>
<a href="#l5.726"></a><span id="l5.726"> ];</span>
<a href="#l5.727"></a><span id="l5.727"> </span>
<a href="#l5.728"></a><span id="l5.728"> gHTMLAttr.h1 =</span>
<a href="#l5.729"></a><span id="l5.729"> [</span>
<a href="#l5.730"></a><span id="l5.730">   &quot;align&quot;,</span>
<a href="#l5.731"></a><span id="l5.731">   &quot;-&quot;,</span>
<a href="#l5.732"></a><span id="l5.732">   &quot;_core&quot;,</span>
<a href="#l5.733"></a><span id="l5.733">   &quot;-&quot;,</span>
<a href="#l5.734"></a><span id="l5.734">   &quot;^lang&quot;,</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.737"></a><span id="l5.737"> ];</span>
<a href="#l5.738"></a><span id="l5.738"> </span>
<a href="#l5.739"></a><span id="l5.739"> gHTMLAttr.h1_align = gHAlignJustify;</span>
<a href="#l5.740"></a><span id="l5.740"> </span>
<a href="#l5.741"></a><span id="l5.741"> gHTMLAttr.h2 =</span>
<a href="#l5.742"></a><span id="l5.742"> [</span>
<a href="#l5.743"></a><span id="l5.743">   &quot;align&quot;,</span>
<a href="#l5.744"></a><span id="l5.744">   &quot;-&quot;,</span>
<a href="#l5.745"></a><span id="l5.745">   &quot;_core&quot;,</span>
<a href="#l5.746"></a><span id="l5.746">   &quot;-&quot;,</span>
<a href="#l5.747"></a><span id="l5.747">   &quot;^lang&quot;,</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.750"></a><span id="l5.750"> ];</span>
<a href="#l5.751"></a><span id="l5.751"> </span>
<a href="#l5.752"></a><span id="l5.752"> gHTMLAttr.h2_align = gHAlignJustify;</span>
<a href="#l5.753"></a><span id="l5.753"> </span>
<a href="#l5.754"></a><span id="l5.754"> gHTMLAttr.h3 =</span>
<a href="#l5.755"></a><span id="l5.755"> [</span>
<a href="#l5.756"></a><span id="l5.756">   &quot;align&quot;,</span>
<a href="#l5.757"></a><span id="l5.757">   &quot;-&quot;,</span>
<a href="#l5.758"></a><span id="l5.758">   &quot;_core&quot;,</span>
<a href="#l5.759"></a><span id="l5.759">   &quot;-&quot;,</span>
<a href="#l5.760"></a><span id="l5.760">   &quot;^lang&quot;,</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.763"></a><span id="l5.763"> ];</span>
<a href="#l5.764"></a><span id="l5.764"> </span>
<a href="#l5.765"></a><span id="l5.765"> gHTMLAttr.h3_align =  gHAlignJustify;</span>
<a href="#l5.766"></a><span id="l5.766"> </span>
<a href="#l5.767"></a><span id="l5.767"> gHTMLAttr.h4 =</span>
<a href="#l5.768"></a><span id="l5.768"> [</span>
<a href="#l5.769"></a><span id="l5.769">   &quot;align&quot;,</span>
<a href="#l5.770"></a><span id="l5.770">   &quot;-&quot;,</span>
<a href="#l5.771"></a><span id="l5.771">   &quot;_core&quot;,</span>
<a href="#l5.772"></a><span id="l5.772">   &quot;-&quot;,</span>
<a href="#l5.773"></a><span id="l5.773">   &quot;^lang&quot;,</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.776"></a><span id="l5.776"> ];</span>
<a href="#l5.777"></a><span id="l5.777"> </span>
<a href="#l5.778"></a><span id="l5.778"> gHTMLAttr.h4_align = gHAlignJustify;</span>
<a href="#l5.779"></a><span id="l5.779"> </span>
<a href="#l5.780"></a><span id="l5.780"> </span>
<a href="#l5.781"></a><span id="l5.781"> gHTMLAttr.h5 =</span>
<a href="#l5.782"></a><span id="l5.782"> [</span>
<a href="#l5.783"></a><span id="l5.783">   &quot;align&quot;,</span>
<a href="#l5.784"></a><span id="l5.784">   &quot;-&quot;,</span>
<a href="#l5.785"></a><span id="l5.785">   &quot;_core&quot;,</span>
<a href="#l5.786"></a><span id="l5.786">   &quot;-&quot;,</span>
<a href="#l5.787"></a><span id="l5.787">   &quot;^lang&quot;,</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.790"></a><span id="l5.790"> ];</span>
<a href="#l5.791"></a><span id="l5.791"> </span>
<a href="#l5.792"></a><span id="l5.792"> gHTMLAttr.h5_align = gHAlignJustify;</span>
<a href="#l5.793"></a><span id="l5.793"> </span>
<a href="#l5.794"></a><span id="l5.794"> gHTMLAttr.h6 =</span>
<a href="#l5.795"></a><span id="l5.795"> [</span>
<a href="#l5.796"></a><span id="l5.796">   &quot;align&quot;,</span>
<a href="#l5.797"></a><span id="l5.797">   &quot;-&quot;,</span>
<a href="#l5.798"></a><span id="l5.798">   &quot;_core&quot;,</span>
<a href="#l5.799"></a><span id="l5.799">   &quot;-&quot;,</span>
<a href="#l5.800"></a><span id="l5.800">   &quot;^lang&quot;,</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.803"></a><span id="l5.803"> ];</span>
<a href="#l5.804"></a><span id="l5.804"> </span>
<a href="#l5.805"></a><span id="l5.805"> gHTMLAttr.h6_align = gHAlignJustify;</span>
<a href="#l5.806"></a><span id="l5.806"> </span>
<a href="#l5.807"></a><span id="l5.807"> gHTMLAttr.head =</span>
<a href="#l5.808"></a><span id="l5.808"> [</span>
<a href="#l5.809"></a><span id="l5.809">   &quot;profile&quot;,</span>
<a href="#l5.810"></a><span id="l5.810">   &quot;-&quot;,</span>
<a href="#l5.811"></a><span id="l5.811">   &quot;^lang&quot;,</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.814"></a><span id="l5.814"> ];</span>
<a href="#l5.815"></a><span id="l5.815"> </span>
<a href="#l5.816"></a><span id="l5.816"> gHTMLAttr.hr =</span>
<a href="#l5.817"></a><span id="l5.817"> [</span>
<a href="#l5.818"></a><span id="l5.818">   &quot;align&quot;,</span>
<a href="#l5.819"></a><span id="l5.819">   &quot;noshade&quot;,</span>
<a href="#l5.820"></a><span id="l5.820">   &quot;#size&quot;,</span>
<a href="#l5.821"></a><span id="l5.821">   &quot;%width&quot;,</span>
<a href="#l5.822"></a><span id="l5.822">   &quot;-&quot;,</span>
<a href="#l5.823"></a><span id="l5.823">   &quot;_core&quot;,</span>
<a href="#l5.824"></a><span id="l5.824">   &quot;-&quot;,</span>
<a href="#l5.825"></a><span id="l5.825">   &quot;^lang&quot;,</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.828"></a><span id="l5.828"> ];</span>
<a href="#l5.829"></a><span id="l5.829"> </span>
<a href="#l5.830"></a><span id="l5.830"> gHTMLAttr.hr_align = gHAlign;</span>
<a href="#l5.831"></a><span id="l5.831"> </span>
<a href="#l5.832"></a><span id="l5.832"> gHTMLAttr.hr_noshade =</span>
<a href="#l5.833"></a><span id="l5.833"> [</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineminus">-  &quot;noshade&quot;</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+  &quot;noshade&quot;,</span>
<a href="#l5.836"></a><span id="l5.836"> ];</span>
<a href="#l5.837"></a><span id="l5.837"> </span>
<a href="#l5.838"></a><span id="l5.838"> </span>
<a href="#l5.839"></a><span id="l5.839"> gHTMLAttr.html =</span>
<a href="#l5.840"></a><span id="l5.840"> [</span>
<a href="#l5.841"></a><span id="l5.841">   &quot;version&quot;,</span>
<a href="#l5.842"></a><span id="l5.842">   &quot;-&quot;,</span>
<a href="#l5.843"></a><span id="l5.843">   &quot;^lang&quot;,</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.846"></a><span id="l5.846"> ];</span>
<a href="#l5.847"></a><span id="l5.847"> </span>
<a href="#l5.848"></a><span id="l5.848"> gHTMLAttr.i =</span>
<a href="#l5.849"></a><span id="l5.849"> [</span>
<a href="#l5.850"></a><span id="l5.850">   &quot;_core&quot;,</span>
<a href="#l5.851"></a><span id="l5.851">   &quot;-&quot;,</span>
<a href="#l5.852"></a><span id="l5.852">   &quot;^lang&quot;,</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.855"></a><span id="l5.855"> ];</span>
<a href="#l5.856"></a><span id="l5.856"> </span>
<a href="#l5.857"></a><span id="l5.857"> gHTMLAttr.iframe =</span>
<a href="#l5.858"></a><span id="l5.858"> [</span>
<a href="#l5.859"></a><span id="l5.859">   &quot;longdesc&quot;,</span>
<a href="#l5.860"></a><span id="l5.860">   &quot;name&quot;,</span>
<a href="#l5.861"></a><span id="l5.861">   &quot;src&quot;,</span>
<a href="#l5.862"></a><span id="l5.862">   &quot;$frameborder&quot;,</span>
<a href="#l5.863"></a><span id="l5.863">   &quot;marginwidth&quot;,</span>
<a href="#l5.864"></a><span id="l5.864">   &quot;marginheight&quot;,</span>
<a href="#l5.865"></a><span id="l5.865">   &quot;$scrolling&quot;,</span>
<a href="#l5.866"></a><span id="l5.866">   &quot;align&quot;,</span>
<a href="#l5.867"></a><span id="l5.867">   &quot;%height&quot;,</span>
<a href="#l5.868"></a><span id="l5.868">   &quot;%width&quot;,</span>
<a href="#l5.869"></a><span id="l5.869">   &quot;-&quot;,</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineminus">-  &quot;_core&quot;</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineplus">+  &quot;_core&quot;,</span>
<a href="#l5.872"></a><span id="l5.872"> ];</span>
<a href="#l5.873"></a><span id="l5.873"> </span>
<a href="#l5.874"></a><span id="l5.874"> gHTMLAttr.iframe_frameborder =</span>
<a href="#l5.875"></a><span id="l5.875"> [</span>
<a href="#l5.876"></a><span id="l5.876">   &quot;1&quot;,</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineminus">-  &quot;0&quot;</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineplus">+  &quot;0&quot;,</span>
<a href="#l5.879"></a><span id="l5.879"> ];</span>
<a href="#l5.880"></a><span id="l5.880"> </span>
<a href="#l5.881"></a><span id="l5.881"> gHTMLAttr.iframe_scrolling =</span>
<a href="#l5.882"></a><span id="l5.882"> [</span>
<a href="#l5.883"></a><span id="l5.883">   &quot;auto&quot;,</span>
<a href="#l5.884"></a><span id="l5.884">   &quot;yes&quot;,</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineminus">-  &quot;no&quot;</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineplus">+  &quot;no&quot;,</span>
<a href="#l5.887"></a><span id="l5.887"> ];</span>
<a href="#l5.888"></a><span id="l5.888"> </span>
<a href="#l5.889"></a><span id="l5.889"> gHTMLAttr.iframe_align =</span>
<a href="#l5.890"></a><span id="l5.890"> [</span>
<a href="#l5.891"></a><span id="l5.891">   &quot;top&quot;,</span>
<a href="#l5.892"></a><span id="l5.892">   &quot;middle&quot;,</span>
<a href="#l5.893"></a><span id="l5.893">   &quot;bottom&quot;,</span>
<a href="#l5.894"></a><span id="l5.894">   &quot;left&quot;,</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.897"></a><span id="l5.897"> ];</span>
<a href="#l5.898"></a><span id="l5.898"> </span>
<a href="#l5.899"></a><span id="l5.899"> gHTMLAttr.img =</span>
<a href="#l5.900"></a><span id="l5.900"> [</span>
<a href="#l5.901"></a><span id="l5.901">   &quot;$src&quot;,</span>
<a href="#l5.902"></a><span id="l5.902">   &quot;$alt&quot;,</span>
<a href="#l5.903"></a><span id="l5.903">   &quot;longdesc&quot;,</span>
<a href="#l5.904"></a><span id="l5.904">   &quot;name&quot;,</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineat">@@ -861,31 +861,31 @@ gHTMLAttr.img =</span>
<a href="#l5.906"></a><span id="l5.906">   &quot;align&quot;,</span>
<a href="#l5.907"></a><span id="l5.907">   &quot;#border&quot;,</span>
<a href="#l5.908"></a><span id="l5.908">   &quot;#hspace&quot;,</span>
<a href="#l5.909"></a><span id="l5.909">   &quot;#vspace&quot;,</span>
<a href="#l5.910"></a><span id="l5.910">   &quot;-&quot;,</span>
<a href="#l5.911"></a><span id="l5.911">   &quot;_core&quot;,</span>
<a href="#l5.912"></a><span id="l5.912">   &quot;-&quot;,</span>
<a href="#l5.913"></a><span id="l5.913">   &quot;^lang&quot;,</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.916"></a><span id="l5.916"> ];</span>
<a href="#l5.917"></a><span id="l5.917"> </span>
<a href="#l5.918"></a><span id="l5.918"> gHTMLAttr.img_ismap =</span>
<a href="#l5.919"></a><span id="l5.919"> [</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineminus">-  &quot;ismap&quot;</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineplus">+  &quot;ismap&quot;,</span>
<a href="#l5.922"></a><span id="l5.922"> ];</span>
<a href="#l5.923"></a><span id="l5.923"> </span>
<a href="#l5.924"></a><span id="l5.924"> gHTMLAttr.img_align =</span>
<a href="#l5.925"></a><span id="l5.925"> [</span>
<a href="#l5.926"></a><span id="l5.926">   &quot;top&quot;,</span>
<a href="#l5.927"></a><span id="l5.927">   &quot;middle&quot;,</span>
<a href="#l5.928"></a><span id="l5.928">   &quot;bottom&quot;,</span>
<a href="#l5.929"></a><span id="l5.929">   &quot;left&quot;,</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.932"></a><span id="l5.932"> ];</span>
<a href="#l5.933"></a><span id="l5.933"> </span>
<a href="#l5.934"></a><span id="l5.934"> gHTMLAttr.input =</span>
<a href="#l5.935"></a><span id="l5.935"> [</span>
<a href="#l5.936"></a><span id="l5.936">   &quot;$type&quot;,</span>
<a href="#l5.937"></a><span id="l5.937">   &quot;name&quot;,</span>
<a href="#l5.938"></a><span id="l5.938">   &quot;value&quot;,</span>
<a href="#l5.939"></a><span id="l5.939">   &quot;checked&quot;,</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineat">@@ -900,162 +900,162 @@ gHTMLAttr.input =</span>
<a href="#l5.941"></a><span id="l5.941">   &quot;#tabindex&quot;,</span>
<a href="#l5.942"></a><span id="l5.942">   &quot;!accesskey&quot;,</span>
<a href="#l5.943"></a><span id="l5.943">   &quot;accept&quot;,</span>
<a href="#l5.944"></a><span id="l5.944">   &quot;align&quot;,</span>
<a href="#l5.945"></a><span id="l5.945">   &quot;-&quot;,</span>
<a href="#l5.946"></a><span id="l5.946">   &quot;_core&quot;,</span>
<a href="#l5.947"></a><span id="l5.947">   &quot;-&quot;,</span>
<a href="#l5.948"></a><span id="l5.948">   &quot;^lang&quot;,</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.951"></a><span id="l5.951"> ];</span>
<a href="#l5.952"></a><span id="l5.952"> </span>
<a href="#l5.953"></a><span id="l5.953"> gHTMLAttr.input_type =</span>
<a href="#l5.954"></a><span id="l5.954"> [</span>
<a href="#l5.955"></a><span id="l5.955">   &quot;text&quot;,</span>
<a href="#l5.956"></a><span id="l5.956">   &quot;password&quot;,</span>
<a href="#l5.957"></a><span id="l5.957">   &quot;checkbox&quot;,</span>
<a href="#l5.958"></a><span id="l5.958">   &quot;radio&quot;,</span>
<a href="#l5.959"></a><span id="l5.959">   &quot;submit&quot;,</span>
<a href="#l5.960"></a><span id="l5.960">   &quot;reset&quot;,</span>
<a href="#l5.961"></a><span id="l5.961">   &quot;file&quot;,</span>
<a href="#l5.962"></a><span id="l5.962">   &quot;hidden&quot;,</span>
<a href="#l5.963"></a><span id="l5.963">   &quot;image&quot;,</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineminus">-  &quot;button&quot;</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineplus">+  &quot;button&quot;,</span>
<a href="#l5.966"></a><span id="l5.966"> ];</span>
<a href="#l5.967"></a><span id="l5.967"> </span>
<a href="#l5.968"></a><span id="l5.968"> gHTMLAttr.input_checked =</span>
<a href="#l5.969"></a><span id="l5.969"> [</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineminus">-  &quot;checked&quot;</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineplus">+  &quot;checked&quot;,</span>
<a href="#l5.972"></a><span id="l5.972"> ];</span>
<a href="#l5.973"></a><span id="l5.973"> </span>
<a href="#l5.974"></a><span id="l5.974"> gHTMLAttr.input_disabled =</span>
<a href="#l5.975"></a><span id="l5.975"> [</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineminus">-  &quot;disabled&quot;</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineplus">+  &quot;disabled&quot;,</span>
<a href="#l5.978"></a><span id="l5.978"> ];</span>
<a href="#l5.979"></a><span id="l5.979"> </span>
<a href="#l5.980"></a><span id="l5.980"> gHTMLAttr.input_readonly =</span>
<a href="#l5.981"></a><span id="l5.981"> [</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineminus">-  &quot;readonly&quot;</span>
<a href="#l5.983"></a><span id="l5.983" class="difflineplus">+  &quot;readonly&quot;,</span>
<a href="#l5.984"></a><span id="l5.984"> ];</span>
<a href="#l5.985"></a><span id="l5.985"> </span>
<a href="#l5.986"></a><span id="l5.986"> </span>
<a href="#l5.987"></a><span id="l5.987"> gHTMLAttr.input_ismap =</span>
<a href="#l5.988"></a><span id="l5.988"> [</span>
<a href="#l5.989"></a><span id="l5.989" class="difflineminus">-  &quot;ismap&quot;</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineplus">+  &quot;ismap&quot;,</span>
<a href="#l5.991"></a><span id="l5.991"> ];</span>
<a href="#l5.992"></a><span id="l5.992"> </span>
<a href="#l5.993"></a><span id="l5.993"> </span>
<a href="#l5.994"></a><span id="l5.994"> gHTMLAttr.input_align =</span>
<a href="#l5.995"></a><span id="l5.995"> [</span>
<a href="#l5.996"></a><span id="l5.996">   &quot;top&quot;,</span>
<a href="#l5.997"></a><span id="l5.997">   &quot;middle&quot;,</span>
<a href="#l5.998"></a><span id="l5.998">   &quot;bottom&quot;,</span>
<a href="#l5.999"></a><span id="l5.999">   &quot;left&quot;,</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.1002"></a><span id="l5.1002"> ];</span>
<a href="#l5.1003"></a><span id="l5.1003"> </span>
<a href="#l5.1004"></a><span id="l5.1004"> gHTMLAttr.ins =</span>
<a href="#l5.1005"></a><span id="l5.1005"> [</span>
<a href="#l5.1006"></a><span id="l5.1006">   &quot;cite&quot;,</span>
<a href="#l5.1007"></a><span id="l5.1007">   &quot;datetime&quot;,</span>
<a href="#l5.1008"></a><span id="l5.1008">   &quot;-&quot;,</span>
<a href="#l5.1009"></a><span id="l5.1009">   &quot;_core&quot;,</span>
<a href="#l5.1010"></a><span id="l5.1010">   &quot;-&quot;,</span>
<a href="#l5.1011"></a><span id="l5.1011">   &quot;^lang&quot;,</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1014"></a><span id="l5.1014"> ];</span>
<a href="#l5.1015"></a><span id="l5.1015"> </span>
<a href="#l5.1016"></a><span id="l5.1016"> gHTMLAttr.isindex =</span>
<a href="#l5.1017"></a><span id="l5.1017"> [</span>
<a href="#l5.1018"></a><span id="l5.1018">   &quot;prompt&quot;,</span>
<a href="#l5.1019"></a><span id="l5.1019">   &quot;-&quot;,</span>
<a href="#l5.1020"></a><span id="l5.1020">   &quot;_core&quot;,</span>
<a href="#l5.1021"></a><span id="l5.1021">   &quot;-&quot;,</span>
<a href="#l5.1022"></a><span id="l5.1022">   &quot;^lang&quot;,</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1025"></a><span id="l5.1025"> ];</span>
<a href="#l5.1026"></a><span id="l5.1026"> </span>
<a href="#l5.1027"></a><span id="l5.1027"> gHTMLAttr.kbd =</span>
<a href="#l5.1028"></a><span id="l5.1028"> [</span>
<a href="#l5.1029"></a><span id="l5.1029">   &quot;_core&quot;,</span>
<a href="#l5.1030"></a><span id="l5.1030">   &quot;-&quot;,</span>
<a href="#l5.1031"></a><span id="l5.1031">   &quot;^lang&quot;,</span>
<a href="#l5.1032"></a><span id="l5.1032" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1034"></a><span id="l5.1034"> ];</span>
<a href="#l5.1035"></a><span id="l5.1035"> </span>
<a href="#l5.1036"></a><span id="l5.1036"> gHTMLAttr.label =</span>
<a href="#l5.1037"></a><span id="l5.1037"> [</span>
<a href="#l5.1038"></a><span id="l5.1038">   &quot;for&quot;,</span>
<a href="#l5.1039"></a><span id="l5.1039">   &quot;!accesskey&quot;,</span>
<a href="#l5.1040"></a><span id="l5.1040">   &quot;-&quot;,</span>
<a href="#l5.1041"></a><span id="l5.1041">   &quot;_core&quot;,</span>
<a href="#l5.1042"></a><span id="l5.1042">   &quot;-&quot;,</span>
<a href="#l5.1043"></a><span id="l5.1043">   &quot;^lang&quot;,</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1045"></a><span id="l5.1045" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1046"></a><span id="l5.1046"> ];</span>
<a href="#l5.1047"></a><span id="l5.1047"> </span>
<a href="#l5.1048"></a><span id="l5.1048"> gHTMLAttr.legend =</span>
<a href="#l5.1049"></a><span id="l5.1049"> [</span>
<a href="#l5.1050"></a><span id="l5.1050">   &quot;!accesskey&quot;,</span>
<a href="#l5.1051"></a><span id="l5.1051">   &quot;align&quot;,</span>
<a href="#l5.1052"></a><span id="l5.1052">   &quot;-&quot;,</span>
<a href="#l5.1053"></a><span id="l5.1053">   &quot;_core&quot;,</span>
<a href="#l5.1054"></a><span id="l5.1054">   &quot;-&quot;,</span>
<a href="#l5.1055"></a><span id="l5.1055">   &quot;^lang&quot;,</span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1058"></a><span id="l5.1058"> ];</span>
<a href="#l5.1059"></a><span id="l5.1059"> </span>
<a href="#l5.1060"></a><span id="l5.1060"> gHTMLAttr.legend_align =</span>
<a href="#l5.1061"></a><span id="l5.1061"> [</span>
<a href="#l5.1062"></a><span id="l5.1062">   &quot;top&quot;,</span>
<a href="#l5.1063"></a><span id="l5.1063">   &quot;bottom&quot;,</span>
<a href="#l5.1064"></a><span id="l5.1064">   &quot;left&quot;,</span>
<a href="#l5.1065"></a><span id="l5.1065" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.1066"></a><span id="l5.1066" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.1067"></a><span id="l5.1067"> ];</span>
<a href="#l5.1068"></a><span id="l5.1068"> </span>
<a href="#l5.1069"></a><span id="l5.1069"> gHTMLAttr.li =</span>
<a href="#l5.1070"></a><span id="l5.1070"> [</span>
<a href="#l5.1071"></a><span id="l5.1071">   &quot;type&quot;,</span>
<a href="#l5.1072"></a><span id="l5.1072">   &quot;#value&quot;,</span>
<a href="#l5.1073"></a><span id="l5.1073">   &quot;-&quot;,</span>
<a href="#l5.1074"></a><span id="l5.1074">   &quot;_core&quot;,</span>
<a href="#l5.1075"></a><span id="l5.1075">   &quot;-&quot;,</span>
<a href="#l5.1076"></a><span id="l5.1076">   &quot;^lang&quot;,</span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1079"></a><span id="l5.1079"> ];</span>
<a href="#l5.1080"></a><span id="l5.1080"> </span>
<a href="#l5.1081"></a><span id="l5.1081"> gHTMLAttr.li_type =</span>
<a href="#l5.1082"></a><span id="l5.1082"> [</span>
<a href="#l5.1083"></a><span id="l5.1083">   &quot;disc&quot;,</span>
<a href="#l5.1084"></a><span id="l5.1084">   &quot;square&quot;,</span>
<a href="#l5.1085"></a><span id="l5.1085">   &quot;circle&quot;,</span>
<a href="#l5.1086"></a><span id="l5.1086">   &quot;-&quot;,</span>
<a href="#l5.1087"></a><span id="l5.1087">   &quot;1&quot;,</span>
<a href="#l5.1088"></a><span id="l5.1088">   &quot;a&quot;,</span>
<a href="#l5.1089"></a><span id="l5.1089">   &quot;A&quot;,</span>
<a href="#l5.1090"></a><span id="l5.1090">   &quot;i&quot;,</span>
<a href="#l5.1091"></a><span id="l5.1091" class="difflineminus">-  &quot;I&quot;</span>
<a href="#l5.1092"></a><span id="l5.1092" class="difflineplus">+  &quot;I&quot;,</span>
<a href="#l5.1093"></a><span id="l5.1093"> ];</span>
<a href="#l5.1094"></a><span id="l5.1094"> </span>
<a href="#l5.1095"></a><span id="l5.1095"> gHTMLAttr.link =</span>
<a href="#l5.1096"></a><span id="l5.1096"> [</span>
<a href="#l5.1097"></a><span id="l5.1097">   &quot;charset&quot;,</span>
<a href="#l5.1098"></a><span id="l5.1098">   &quot;href&quot;,</span>
<a href="#l5.1099"></a><span id="l5.1099">   &quot;^hreflang&quot;,</span>
<a href="#l5.1100"></a><span id="l5.1100">   &quot;type&quot;,</span>
<a href="#l5.1101"></a><span id="l5.1101">   &quot;rel&quot;,</span>
<a href="#l5.1102"></a><span id="l5.1102">   &quot;rev&quot;,</span>
<a href="#l5.1103"></a><span id="l5.1103">   &quot;media&quot;,</span>
<a href="#l5.1104"></a><span id="l5.1104">   &quot;target&quot;,</span>
<a href="#l5.1105"></a><span id="l5.1105">   &quot;-&quot;,</span>
<a href="#l5.1106"></a><span id="l5.1106">   &quot;_core&quot;,</span>
<a href="#l5.1107"></a><span id="l5.1107">   &quot;-&quot;,</span>
<a href="#l5.1108"></a><span id="l5.1108">   &quot;^lang&quot;,</span>
<a href="#l5.1109"></a><span id="l5.1109" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1110"></a><span id="l5.1110" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1111"></a><span id="l5.1111"> ];</span>
<a href="#l5.1112"></a><span id="l5.1112"> </span>
<a href="#l5.1113"></a><span id="l5.1113"> gHTMLAttr.link_target = gTarget;</span>
<a href="#l5.1114"></a><span id="l5.1114"> </span>
<a href="#l5.1115"></a><span id="l5.1115"> gHTMLAttr.link_rel =</span>
<a href="#l5.1116"></a><span id="l5.1116"> [</span>
<a href="#l5.1117"></a><span id="l5.1117">   &quot;alternate&quot;,</span>
<a href="#l5.1118"></a><span id="l5.1118">   &quot;stylesheet&quot;,</span>
<a href="#l5.1119"></a><span id="l5.1119" class="difflineat">@@ -1066,17 +1066,17 @@ gHTMLAttr.link_rel =</span>
<a href="#l5.1120"></a><span id="l5.1120">   &quot;index&quot;,</span>
<a href="#l5.1121"></a><span id="l5.1121">   &quot;glossary&quot;,</span>
<a href="#l5.1122"></a><span id="l5.1122">   &quot;copyright&quot;,</span>
<a href="#l5.1123"></a><span id="l5.1123">   &quot;chapter&quot;,</span>
<a href="#l5.1124"></a><span id="l5.1124">   &quot;section&quot;,</span>
<a href="#l5.1125"></a><span id="l5.1125">   &quot;subsection&quot;,</span>
<a href="#l5.1126"></a><span id="l5.1126">   &quot;appendix&quot;,</span>
<a href="#l5.1127"></a><span id="l5.1127">   &quot;help&quot;,</span>
<a href="#l5.1128"></a><span id="l5.1128" class="difflineminus">-  &quot;bookmark&quot;</span>
<a href="#l5.1129"></a><span id="l5.1129" class="difflineplus">+  &quot;bookmark&quot;,</span>
<a href="#l5.1130"></a><span id="l5.1130"> ];</span>
<a href="#l5.1131"></a><span id="l5.1131"> </span>
<a href="#l5.1132"></a><span id="l5.1132"> gHTMLAttr.link_rev =</span>
<a href="#l5.1133"></a><span id="l5.1133"> [</span>
<a href="#l5.1134"></a><span id="l5.1134">   &quot;alternate&quot;,</span>
<a href="#l5.1135"></a><span id="l5.1135">   &quot;stylesheet&quot;,</span>
<a href="#l5.1136"></a><span id="l5.1136">   &quot;start&quot;,</span>
<a href="#l5.1137"></a><span id="l5.1137">   &quot;next&quot;,</span>
<a href="#l5.1138"></a><span id="l5.1138" class="difflineat">@@ -1085,69 +1085,69 @@ gHTMLAttr.link_rev =</span>
<a href="#l5.1139"></a><span id="l5.1139">   &quot;index&quot;,</span>
<a href="#l5.1140"></a><span id="l5.1140">   &quot;glossary&quot;,</span>
<a href="#l5.1141"></a><span id="l5.1141">   &quot;copyright&quot;,</span>
<a href="#l5.1142"></a><span id="l5.1142">   &quot;chapter&quot;,</span>
<a href="#l5.1143"></a><span id="l5.1143">   &quot;section&quot;,</span>
<a href="#l5.1144"></a><span id="l5.1144">   &quot;subsection&quot;,</span>
<a href="#l5.1145"></a><span id="l5.1145">   &quot;appendix&quot;,</span>
<a href="#l5.1146"></a><span id="l5.1146">   &quot;help&quot;,</span>
<a href="#l5.1147"></a><span id="l5.1147" class="difflineminus">-  &quot;bookmark&quot;</span>
<a href="#l5.1148"></a><span id="l5.1148" class="difflineplus">+  &quot;bookmark&quot;,</span>
<a href="#l5.1149"></a><span id="l5.1149"> ];</span>
<a href="#l5.1150"></a><span id="l5.1150"> </span>
<a href="#l5.1151"></a><span id="l5.1151"> gHTMLAttr.map =</span>
<a href="#l5.1152"></a><span id="l5.1152"> [</span>
<a href="#l5.1153"></a><span id="l5.1153">   &quot;$name&quot;,</span>
<a href="#l5.1154"></a><span id="l5.1154">   &quot;-&quot;,</span>
<a href="#l5.1155"></a><span id="l5.1155">   &quot;_core&quot;,</span>
<a href="#l5.1156"></a><span id="l5.1156">   &quot;-&quot;,</span>
<a href="#l5.1157"></a><span id="l5.1157">   &quot;^lang&quot;,</span>
<a href="#l5.1158"></a><span id="l5.1158" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1159"></a><span id="l5.1159" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1160"></a><span id="l5.1160"> ];</span>
<a href="#l5.1161"></a><span id="l5.1161"> </span>
<a href="#l5.1162"></a><span id="l5.1162"> gHTMLAttr.menu =</span>
<a href="#l5.1163"></a><span id="l5.1163"> [</span>
<a href="#l5.1164"></a><span id="l5.1164">   &quot;compact&quot;,</span>
<a href="#l5.1165"></a><span id="l5.1165">   &quot;-&quot;,</span>
<a href="#l5.1166"></a><span id="l5.1166">   &quot;_core&quot;,</span>
<a href="#l5.1167"></a><span id="l5.1167">   &quot;-&quot;,</span>
<a href="#l5.1168"></a><span id="l5.1168">   &quot;^lang&quot;,</span>
<a href="#l5.1169"></a><span id="l5.1169" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1170"></a><span id="l5.1170" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1171"></a><span id="l5.1171"> ];</span>
<a href="#l5.1172"></a><span id="l5.1172"> </span>
<a href="#l5.1173"></a><span id="l5.1173"> gHTMLAttr.menu_compact =</span>
<a href="#l5.1174"></a><span id="l5.1174"> [</span>
<a href="#l5.1175"></a><span id="l5.1175" class="difflineminus">-  &quot;compact&quot;</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineplus">+  &quot;compact&quot;,</span>
<a href="#l5.1177"></a><span id="l5.1177"> ];</span>
<a href="#l5.1178"></a><span id="l5.1178"> </span>
<a href="#l5.1179"></a><span id="l5.1179"> gHTMLAttr.meta =</span>
<a href="#l5.1180"></a><span id="l5.1180"> [</span>
<a href="#l5.1181"></a><span id="l5.1181">   &quot;http-equiv&quot;,</span>
<a href="#l5.1182"></a><span id="l5.1182">   &quot;name&quot;,</span>
<a href="#l5.1183"></a><span id="l5.1183">   &quot;$content&quot;,</span>
<a href="#l5.1184"></a><span id="l5.1184">   &quot;scheme&quot;,</span>
<a href="#l5.1185"></a><span id="l5.1185">   &quot;-&quot;,</span>
<a href="#l5.1186"></a><span id="l5.1186">   &quot;^lang&quot;,</span>
<a href="#l5.1187"></a><span id="l5.1187" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1188"></a><span id="l5.1188" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1189"></a><span id="l5.1189"> ];</span>
<a href="#l5.1190"></a><span id="l5.1190"> </span>
<a href="#l5.1191"></a><span id="l5.1191"> gHTMLAttr.noframes =</span>
<a href="#l5.1192"></a><span id="l5.1192"> [</span>
<a href="#l5.1193"></a><span id="l5.1193">   &quot;_core&quot;,</span>
<a href="#l5.1194"></a><span id="l5.1194">   &quot;-&quot;,</span>
<a href="#l5.1195"></a><span id="l5.1195">   &quot;^lang&quot;,</span>
<a href="#l5.1196"></a><span id="l5.1196" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1197"></a><span id="l5.1197" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1198"></a><span id="l5.1198"> ];</span>
<a href="#l5.1199"></a><span id="l5.1199"> </span>
<a href="#l5.1200"></a><span id="l5.1200"> gHTMLAttr.noscript =</span>
<a href="#l5.1201"></a><span id="l5.1201"> [</span>
<a href="#l5.1202"></a><span id="l5.1202">   &quot;_core&quot;,</span>
<a href="#l5.1203"></a><span id="l5.1203">   &quot;-&quot;,</span>
<a href="#l5.1204"></a><span id="l5.1204">   &quot;^lang&quot;,</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1207"></a><span id="l5.1207"> ];</span>
<a href="#l5.1208"></a><span id="l5.1208"> </span>
<a href="#l5.1209"></a><span id="l5.1209"> gHTMLAttr.object =</span>
<a href="#l5.1210"></a><span id="l5.1210"> [</span>
<a href="#l5.1211"></a><span id="l5.1211">   &quot;declare&quot;,</span>
<a href="#l5.1212"></a><span id="l5.1212">   &quot;classid&quot;,</span>
<a href="#l5.1213"></a><span id="l5.1213">   &quot;codebase&quot;,</span>
<a href="#l5.1214"></a><span id="l5.1214">   &quot;data&quot;,</span>
<a href="#l5.1215"></a><span id="l5.1215" class="difflineat">@@ -1163,261 +1163,261 @@ gHTMLAttr.object =</span>
<a href="#l5.1216"></a><span id="l5.1216">   &quot;align&quot;,</span>
<a href="#l5.1217"></a><span id="l5.1217">   &quot;#border&quot;,</span>
<a href="#l5.1218"></a><span id="l5.1218">   &quot;#hspace&quot;,</span>
<a href="#l5.1219"></a><span id="l5.1219">   &quot;#vspace&quot;,</span>
<a href="#l5.1220"></a><span id="l5.1220">   &quot;-&quot;,</span>
<a href="#l5.1221"></a><span id="l5.1221">   &quot;_core&quot;,</span>
<a href="#l5.1222"></a><span id="l5.1222">   &quot;-&quot;,</span>
<a href="#l5.1223"></a><span id="l5.1223">   &quot;^lang&quot;,</span>
<a href="#l5.1224"></a><span id="l5.1224" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1225"></a><span id="l5.1225" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1226"></a><span id="l5.1226"> ];</span>
<a href="#l5.1227"></a><span id="l5.1227"> </span>
<a href="#l5.1228"></a><span id="l5.1228"> gHTMLAttr.object_declare =</span>
<a href="#l5.1229"></a><span id="l5.1229"> [</span>
<a href="#l5.1230"></a><span id="l5.1230" class="difflineminus">-  &quot;declare&quot;</span>
<a href="#l5.1231"></a><span id="l5.1231" class="difflineplus">+  &quot;declare&quot;,</span>
<a href="#l5.1232"></a><span id="l5.1232"> ];</span>
<a href="#l5.1233"></a><span id="l5.1233"> </span>
<a href="#l5.1234"></a><span id="l5.1234"> gHTMLAttr.object_align =</span>
<a href="#l5.1235"></a><span id="l5.1235"> [</span>
<a href="#l5.1236"></a><span id="l5.1236">   &quot;top&quot;,</span>
<a href="#l5.1237"></a><span id="l5.1237">   &quot;middle&quot;,</span>
<a href="#l5.1238"></a><span id="l5.1238">   &quot;bottom&quot;,</span>
<a href="#l5.1239"></a><span id="l5.1239">   &quot;left&quot;,</span>
<a href="#l5.1240"></a><span id="l5.1240" class="difflineminus">-  &quot;right&quot;</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineplus">+  &quot;right&quot;,</span>
<a href="#l5.1242"></a><span id="l5.1242"> ];</span>
<a href="#l5.1243"></a><span id="l5.1243"> </span>
<a href="#l5.1244"></a><span id="l5.1244"> gHTMLAttr.ol =</span>
<a href="#l5.1245"></a><span id="l5.1245"> [</span>
<a href="#l5.1246"></a><span id="l5.1246">   &quot;type&quot;,</span>
<a href="#l5.1247"></a><span id="l5.1247">   &quot;compact&quot;,</span>
<a href="#l5.1248"></a><span id="l5.1248">   &quot;#start&quot;,</span>
<a href="#l5.1249"></a><span id="l5.1249">   &quot;-&quot;,</span>
<a href="#l5.1250"></a><span id="l5.1250">   &quot;_core&quot;,</span>
<a href="#l5.1251"></a><span id="l5.1251">   &quot;-&quot;,</span>
<a href="#l5.1252"></a><span id="l5.1252">   &quot;^lang&quot;,</span>
<a href="#l5.1253"></a><span id="l5.1253" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1254"></a><span id="l5.1254" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1255"></a><span id="l5.1255"> ];</span>
<a href="#l5.1256"></a><span id="l5.1256"> </span>
<a href="#l5.1257"></a><span id="l5.1257"> gHTMLAttr.ol_type =</span>
<a href="#l5.1258"></a><span id="l5.1258"> [</span>
<a href="#l5.1259"></a><span id="l5.1259">   &quot;1&quot;,</span>
<a href="#l5.1260"></a><span id="l5.1260">   &quot;a&quot;,</span>
<a href="#l5.1261"></a><span id="l5.1261">   &quot;A&quot;,</span>
<a href="#l5.1262"></a><span id="l5.1262">   &quot;i&quot;,</span>
<a href="#l5.1263"></a><span id="l5.1263" class="difflineminus">-  &quot;I&quot;</span>
<a href="#l5.1264"></a><span id="l5.1264" class="difflineplus">+  &quot;I&quot;,</span>
<a href="#l5.1265"></a><span id="l5.1265"> ];</span>
<a href="#l5.1266"></a><span id="l5.1266"> </span>
<a href="#l5.1267"></a><span id="l5.1267"> gHTMLAttr.ol_compact =</span>
<a href="#l5.1268"></a><span id="l5.1268"> [</span>
<a href="#l5.1269"></a><span id="l5.1269" class="difflineminus">-  &quot;compact&quot;</span>
<a href="#l5.1270"></a><span id="l5.1270" class="difflineplus">+  &quot;compact&quot;,</span>
<a href="#l5.1271"></a><span id="l5.1271"> ];</span>
<a href="#l5.1272"></a><span id="l5.1272"> </span>
<a href="#l5.1273"></a><span id="l5.1273"> </span>
<a href="#l5.1274"></a><span id="l5.1274"> gHTMLAttr.optgroup =</span>
<a href="#l5.1275"></a><span id="l5.1275"> [</span>
<a href="#l5.1276"></a><span id="l5.1276">   &quot;disabled&quot;,</span>
<a href="#l5.1277"></a><span id="l5.1277">   &quot;$label&quot;,</span>
<a href="#l5.1278"></a><span id="l5.1278">   &quot;-&quot;,</span>
<a href="#l5.1279"></a><span id="l5.1279">   &quot;_core&quot;,</span>
<a href="#l5.1280"></a><span id="l5.1280">   &quot;-&quot;,</span>
<a href="#l5.1281"></a><span id="l5.1281">   &quot;^lang&quot;,</span>
<a href="#l5.1282"></a><span id="l5.1282" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1283"></a><span id="l5.1283" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1284"></a><span id="l5.1284"> ];</span>
<a href="#l5.1285"></a><span id="l5.1285"> </span>
<a href="#l5.1286"></a><span id="l5.1286"> gHTMLAttr.optgroup_disabled =</span>
<a href="#l5.1287"></a><span id="l5.1287"> [</span>
<a href="#l5.1288"></a><span id="l5.1288" class="difflineminus">-  &quot;disabled&quot;</span>
<a href="#l5.1289"></a><span id="l5.1289" class="difflineplus">+  &quot;disabled&quot;,</span>
<a href="#l5.1290"></a><span id="l5.1290"> ];</span>
<a href="#l5.1291"></a><span id="l5.1291"> </span>
<a href="#l5.1292"></a><span id="l5.1292"> </span>
<a href="#l5.1293"></a><span id="l5.1293"> gHTMLAttr.option =</span>
<a href="#l5.1294"></a><span id="l5.1294"> [</span>
<a href="#l5.1295"></a><span id="l5.1295">   &quot;selected&quot;,</span>
<a href="#l5.1296"></a><span id="l5.1296">   &quot;disabled&quot;,</span>
<a href="#l5.1297"></a><span id="l5.1297">   &quot;label&quot;,</span>
<a href="#l5.1298"></a><span id="l5.1298">   &quot;value&quot;,</span>
<a href="#l5.1299"></a><span id="l5.1299">   &quot;-&quot;,</span>
<a href="#l5.1300"></a><span id="l5.1300">   &quot;_core&quot;,</span>
<a href="#l5.1301"></a><span id="l5.1301">   &quot;-&quot;,</span>
<a href="#l5.1302"></a><span id="l5.1302">   &quot;^lang&quot;,</span>
<a href="#l5.1303"></a><span id="l5.1303" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1304"></a><span id="l5.1304" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1305"></a><span id="l5.1305"> ];</span>
<a href="#l5.1306"></a><span id="l5.1306"> </span>
<a href="#l5.1307"></a><span id="l5.1307"> gHTMLAttr.option_selected =</span>
<a href="#l5.1308"></a><span id="l5.1308"> [</span>
<a href="#l5.1309"></a><span id="l5.1309" class="difflineminus">-  &quot;selected&quot;</span>
<a href="#l5.1310"></a><span id="l5.1310" class="difflineplus">+  &quot;selected&quot;,</span>
<a href="#l5.1311"></a><span id="l5.1311"> ];</span>
<a href="#l5.1312"></a><span id="l5.1312"> </span>
<a href="#l5.1313"></a><span id="l5.1313"> gHTMLAttr.option_disabled =</span>
<a href="#l5.1314"></a><span id="l5.1314"> [</span>
<a href="#l5.1315"></a><span id="l5.1315" class="difflineminus">-  &quot;disabled&quot;</span>
<a href="#l5.1316"></a><span id="l5.1316" class="difflineplus">+  &quot;disabled&quot;,</span>
<a href="#l5.1317"></a><span id="l5.1317"> ];</span>
<a href="#l5.1318"></a><span id="l5.1318"> </span>
<a href="#l5.1319"></a><span id="l5.1319"> </span>
<a href="#l5.1320"></a><span id="l5.1320"> gHTMLAttr.p =</span>
<a href="#l5.1321"></a><span id="l5.1321"> [</span>
<a href="#l5.1322"></a><span id="l5.1322">   &quot;align&quot;,</span>
<a href="#l5.1323"></a><span id="l5.1323">   &quot;-&quot;,</span>
<a href="#l5.1324"></a><span id="l5.1324">   &quot;_core&quot;,</span>
<a href="#l5.1325"></a><span id="l5.1325">   &quot;-&quot;,</span>
<a href="#l5.1326"></a><span id="l5.1326">   &quot;^lang&quot;,</span>
<a href="#l5.1327"></a><span id="l5.1327" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1328"></a><span id="l5.1328" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1329"></a><span id="l5.1329"> ];</span>
<a href="#l5.1330"></a><span id="l5.1330"> </span>
<a href="#l5.1331"></a><span id="l5.1331"> gHTMLAttr.p_align = gHAlignJustify;</span>
<a href="#l5.1332"></a><span id="l5.1332"> </span>
<a href="#l5.1333"></a><span id="l5.1333"> gHTMLAttr.param =</span>
<a href="#l5.1334"></a><span id="l5.1334"> [</span>
<a href="#l5.1335"></a><span id="l5.1335">   &quot;^id&quot;,</span>
<a href="#l5.1336"></a><span id="l5.1336">   &quot;$name&quot;,</span>
<a href="#l5.1337"></a><span id="l5.1337">   &quot;value&quot;,</span>
<a href="#l5.1338"></a><span id="l5.1338">   &quot;$valuetype&quot;,</span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineminus">-  &quot;type&quot;</span>
<a href="#l5.1340"></a><span id="l5.1340" class="difflineplus">+  &quot;type&quot;,</span>
<a href="#l5.1341"></a><span id="l5.1341"> ];</span>
<a href="#l5.1342"></a><span id="l5.1342"> </span>
<a href="#l5.1343"></a><span id="l5.1343"> gHTMLAttr.param_valuetype =</span>
<a href="#l5.1344"></a><span id="l5.1344"> [</span>
<a href="#l5.1345"></a><span id="l5.1345">   &quot;data&quot;,</span>
<a href="#l5.1346"></a><span id="l5.1346">   &quot;ref&quot;,</span>
<a href="#l5.1347"></a><span id="l5.1347" class="difflineminus">-  &quot;object&quot;</span>
<a href="#l5.1348"></a><span id="l5.1348" class="difflineplus">+  &quot;object&quot;,</span>
<a href="#l5.1349"></a><span id="l5.1349"> ];</span>
<a href="#l5.1350"></a><span id="l5.1350"> </span>
<a href="#l5.1351"></a><span id="l5.1351"> </span>
<a href="#l5.1352"></a><span id="l5.1352"> gHTMLAttr.pre =</span>
<a href="#l5.1353"></a><span id="l5.1353"> [</span>
<a href="#l5.1354"></a><span id="l5.1354">   &quot;%width&quot;,</span>
<a href="#l5.1355"></a><span id="l5.1355">   &quot;-&quot;,</span>
<a href="#l5.1356"></a><span id="l5.1356">   &quot;_core&quot;,</span>
<a href="#l5.1357"></a><span id="l5.1357">   &quot;-&quot;,</span>
<a href="#l5.1358"></a><span id="l5.1358">   &quot;^lang&quot;,</span>
<a href="#l5.1359"></a><span id="l5.1359" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1360"></a><span id="l5.1360" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1361"></a><span id="l5.1361"> ];</span>
<a href="#l5.1362"></a><span id="l5.1362"> </span>
<a href="#l5.1363"></a><span id="l5.1363"> gHTMLAttr.q =</span>
<a href="#l5.1364"></a><span id="l5.1364"> [</span>
<a href="#l5.1365"></a><span id="l5.1365">   &quot;cite&quot;,</span>
<a href="#l5.1366"></a><span id="l5.1366">   &quot;-&quot;,</span>
<a href="#l5.1367"></a><span id="l5.1367">   &quot;_core&quot;,</span>
<a href="#l5.1368"></a><span id="l5.1368">   &quot;-&quot;,</span>
<a href="#l5.1369"></a><span id="l5.1369">   &quot;^lang&quot;,</span>
<a href="#l5.1370"></a><span id="l5.1370" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1371"></a><span id="l5.1371" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1372"></a><span id="l5.1372"> ];</span>
<a href="#l5.1373"></a><span id="l5.1373"> </span>
<a href="#l5.1374"></a><span id="l5.1374"> gHTMLAttr.s =</span>
<a href="#l5.1375"></a><span id="l5.1375"> [</span>
<a href="#l5.1376"></a><span id="l5.1376">   &quot;_core&quot;,</span>
<a href="#l5.1377"></a><span id="l5.1377">   &quot;-&quot;,</span>
<a href="#l5.1378"></a><span id="l5.1378">   &quot;^lang&quot;,</span>
<a href="#l5.1379"></a><span id="l5.1379" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1380"></a><span id="l5.1380" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1381"></a><span id="l5.1381"> ];</span>
<a href="#l5.1382"></a><span id="l5.1382"> </span>
<a href="#l5.1383"></a><span id="l5.1383"> gHTMLAttr.samp =</span>
<a href="#l5.1384"></a><span id="l5.1384"> [</span>
<a href="#l5.1385"></a><span id="l5.1385">   &quot;_core&quot;,</span>
<a href="#l5.1386"></a><span id="l5.1386">   &quot;-&quot;,</span>
<a href="#l5.1387"></a><span id="l5.1387">   &quot;^lang&quot;,</span>
<a href="#l5.1388"></a><span id="l5.1388" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1389"></a><span id="l5.1389" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1390"></a><span id="l5.1390"> ];</span>
<a href="#l5.1391"></a><span id="l5.1391"> </span>
<a href="#l5.1392"></a><span id="l5.1392"> gHTMLAttr.script =</span>
<a href="#l5.1393"></a><span id="l5.1393"> [</span>
<a href="#l5.1394"></a><span id="l5.1394">   &quot;charset&quot;,</span>
<a href="#l5.1395"></a><span id="l5.1395">   &quot;$type&quot;,</span>
<a href="#l5.1396"></a><span id="l5.1396">   &quot;language&quot;,</span>
<a href="#l5.1397"></a><span id="l5.1397">   &quot;src&quot;,</span>
<a href="#l5.1398"></a><span id="l5.1398" class="difflineminus">-  &quot;defer&quot;</span>
<a href="#l5.1399"></a><span id="l5.1399" class="difflineplus">+  &quot;defer&quot;,</span>
<a href="#l5.1400"></a><span id="l5.1400"> ];</span>
<a href="#l5.1401"></a><span id="l5.1401"> </span>
<a href="#l5.1402"></a><span id="l5.1402"> gHTMLAttr.script_defer =</span>
<a href="#l5.1403"></a><span id="l5.1403"> [</span>
<a href="#l5.1404"></a><span id="l5.1404" class="difflineminus">-  &quot;defer&quot;</span>
<a href="#l5.1405"></a><span id="l5.1405" class="difflineplus">+  &quot;defer&quot;,</span>
<a href="#l5.1406"></a><span id="l5.1406"> ];</span>
<a href="#l5.1407"></a><span id="l5.1407"> </span>
<a href="#l5.1408"></a><span id="l5.1408"> </span>
<a href="#l5.1409"></a><span id="l5.1409"> gHTMLAttr.select =</span>
<a href="#l5.1410"></a><span id="l5.1410"> [</span>
<a href="#l5.1411"></a><span id="l5.1411">   &quot;name&quot;,</span>
<a href="#l5.1412"></a><span id="l5.1412">   &quot;#size&quot;,</span>
<a href="#l5.1413"></a><span id="l5.1413">   &quot;multiple&quot;,</span>
<a href="#l5.1414"></a><span id="l5.1414">   &quot;disabled&quot;,</span>
<a href="#l5.1415"></a><span id="l5.1415">   &quot;#tabindex&quot;,</span>
<a href="#l5.1416"></a><span id="l5.1416">   &quot;-&quot;,</span>
<a href="#l5.1417"></a><span id="l5.1417">   &quot;_core&quot;,</span>
<a href="#l5.1418"></a><span id="l5.1418">   &quot;-&quot;,</span>
<a href="#l5.1419"></a><span id="l5.1419">   &quot;^lang&quot;,</span>
<a href="#l5.1420"></a><span id="l5.1420" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1421"></a><span id="l5.1421" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1422"></a><span id="l5.1422"> ];</span>
<a href="#l5.1423"></a><span id="l5.1423"> </span>
<a href="#l5.1424"></a><span id="l5.1424"> gHTMLAttr.select_multiple =</span>
<a href="#l5.1425"></a><span id="l5.1425"> [</span>
<a href="#l5.1426"></a><span id="l5.1426" class="difflineminus">-  &quot;multiple&quot;</span>
<a href="#l5.1427"></a><span id="l5.1427" class="difflineplus">+  &quot;multiple&quot;,</span>
<a href="#l5.1428"></a><span id="l5.1428"> ];</span>
<a href="#l5.1429"></a><span id="l5.1429"> </span>
<a href="#l5.1430"></a><span id="l5.1430"> gHTMLAttr.select_disabled =</span>
<a href="#l5.1431"></a><span id="l5.1431"> [</span>
<a href="#l5.1432"></a><span id="l5.1432" class="difflineminus">-  &quot;disabled&quot;</span>
<a href="#l5.1433"></a><span id="l5.1433" class="difflineplus">+  &quot;disabled&quot;,</span>
<a href="#l5.1434"></a><span id="l5.1434"> ];</span>
<a href="#l5.1435"></a><span id="l5.1435"> </span>
<a href="#l5.1436"></a><span id="l5.1436"> gHTMLAttr.small =</span>
<a href="#l5.1437"></a><span id="l5.1437"> [</span>
<a href="#l5.1438"></a><span id="l5.1438">   &quot;_core&quot;,</span>
<a href="#l5.1439"></a><span id="l5.1439">   &quot;-&quot;,</span>
<a href="#l5.1440"></a><span id="l5.1440">   &quot;^lang&quot;,</span>
<a href="#l5.1441"></a><span id="l5.1441" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1442"></a><span id="l5.1442" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1443"></a><span id="l5.1443"> ];</span>
<a href="#l5.1444"></a><span id="l5.1444"> </span>
<a href="#l5.1445"></a><span id="l5.1445"> gHTMLAttr.span =</span>
<a href="#l5.1446"></a><span id="l5.1446"> [</span>
<a href="#l5.1447"></a><span id="l5.1447">   &quot;_core&quot;,</span>
<a href="#l5.1448"></a><span id="l5.1448">   &quot;-&quot;,</span>
<a href="#l5.1449"></a><span id="l5.1449">   &quot;^lang&quot;,</span>
<a href="#l5.1450"></a><span id="l5.1450" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1451"></a><span id="l5.1451" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1452"></a><span id="l5.1452"> ];</span>
<a href="#l5.1453"></a><span id="l5.1453"> </span>
<a href="#l5.1454"></a><span id="l5.1454"> gHTMLAttr.strike =</span>
<a href="#l5.1455"></a><span id="l5.1455"> [</span>
<a href="#l5.1456"></a><span id="l5.1456">   &quot;_core&quot;,</span>
<a href="#l5.1457"></a><span id="l5.1457">   &quot;-&quot;,</span>
<a href="#l5.1458"></a><span id="l5.1458">   &quot;^lang&quot;,</span>
<a href="#l5.1459"></a><span id="l5.1459" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1460"></a><span id="l5.1460" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1461"></a><span id="l5.1461"> ];</span>
<a href="#l5.1462"></a><span id="l5.1462"> </span>
<a href="#l5.1463"></a><span id="l5.1463"> gHTMLAttr.strong =</span>
<a href="#l5.1464"></a><span id="l5.1464"> [</span>
<a href="#l5.1465"></a><span id="l5.1465">   &quot;_core&quot;,</span>
<a href="#l5.1466"></a><span id="l5.1466">   &quot;-&quot;,</span>
<a href="#l5.1467"></a><span id="l5.1467">   &quot;^lang&quot;,</span>
<a href="#l5.1468"></a><span id="l5.1468" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1469"></a><span id="l5.1469" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1470"></a><span id="l5.1470"> ];</span>
<a href="#l5.1471"></a><span id="l5.1471"> </span>
<a href="#l5.1472"></a><span id="l5.1472"> gHTMLAttr.style =</span>
<a href="#l5.1473"></a><span id="l5.1473"> [</span>
<a href="#l5.1474"></a><span id="l5.1474">   &quot;$type&quot;,</span>
<a href="#l5.1475"></a><span id="l5.1475">   &quot;media&quot;,</span>
<a href="#l5.1476"></a><span id="l5.1476">   &quot;title&quot;,</span>
<a href="#l5.1477"></a><span id="l5.1477">   &quot;-&quot;,</span>
<a href="#l5.1478"></a><span id="l5.1478">   &quot;^lang&quot;,</span>
<a href="#l5.1479"></a><span id="l5.1479" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1480"></a><span id="l5.1480" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1481"></a><span id="l5.1481"> ];</span>
<a href="#l5.1482"></a><span id="l5.1482"> </span>
<a href="#l5.1483"></a><span id="l5.1483"> gHTMLAttr.sub =</span>
<a href="#l5.1484"></a><span id="l5.1484"> [</span>
<a href="#l5.1485"></a><span id="l5.1485">   &quot;_core&quot;,</span>
<a href="#l5.1486"></a><span id="l5.1486">   &quot;-&quot;,</span>
<a href="#l5.1487"></a><span id="l5.1487">   &quot;^lang&quot;,</span>
<a href="#l5.1488"></a><span id="l5.1488" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1489"></a><span id="l5.1489" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1490"></a><span id="l5.1490"> ];</span>
<a href="#l5.1491"></a><span id="l5.1491"> </span>
<a href="#l5.1492"></a><span id="l5.1492"> gHTMLAttr.sup =</span>
<a href="#l5.1493"></a><span id="l5.1493"> [</span>
<a href="#l5.1494"></a><span id="l5.1494">   &quot;_core&quot;,</span>
<a href="#l5.1495"></a><span id="l5.1495">   &quot;-&quot;,</span>
<a href="#l5.1496"></a><span id="l5.1496">   &quot;^lang&quot;,</span>
<a href="#l5.1497"></a><span id="l5.1497" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1498"></a><span id="l5.1498" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1499"></a><span id="l5.1499"> ];</span>
<a href="#l5.1500"></a><span id="l5.1500"> </span>
<a href="#l5.1501"></a><span id="l5.1501"> gHTMLAttr.table =</span>
<a href="#l5.1502"></a><span id="l5.1502"> [</span>
<a href="#l5.1503"></a><span id="l5.1503">   &quot;summary&quot;,</span>
<a href="#l5.1504"></a><span id="l5.1504">   &quot;%width&quot;,</span>
<a href="#l5.1505"></a><span id="l5.1505">   &quot;#border&quot;,</span>
<a href="#l5.1506"></a><span id="l5.1506">   &quot;frame&quot;,</span>
<a href="#l5.1507"></a><span id="l5.1507" class="difflineat">@@ -1425,39 +1425,39 @@ gHTMLAttr.table =</span>
<a href="#l5.1508"></a><span id="l5.1508">   &quot;#cellspacing&quot;,</span>
<a href="#l5.1509"></a><span id="l5.1509">   &quot;#cellpadding&quot;,</span>
<a href="#l5.1510"></a><span id="l5.1510">   &quot;align&quot;,</span>
<a href="#l5.1511"></a><span id="l5.1511">   &quot;bgcolor&quot;,</span>
<a href="#l5.1512"></a><span id="l5.1512">   &quot;-&quot;,</span>
<a href="#l5.1513"></a><span id="l5.1513">   &quot;_core&quot;,</span>
<a href="#l5.1514"></a><span id="l5.1514">   &quot;-&quot;,</span>
<a href="#l5.1515"></a><span id="l5.1515">   &quot;^lang&quot;,</span>
<a href="#l5.1516"></a><span id="l5.1516" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1517"></a><span id="l5.1517" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1518"></a><span id="l5.1518"> ];</span>
<a href="#l5.1519"></a><span id="l5.1519"> </span>
<a href="#l5.1520"></a><span id="l5.1520"> gHTMLAttr.table_frame =</span>
<a href="#l5.1521"></a><span id="l5.1521"> [</span>
<a href="#l5.1522"></a><span id="l5.1522">   &quot;void&quot;,</span>
<a href="#l5.1523"></a><span id="l5.1523">   &quot;above&quot;,</span>
<a href="#l5.1524"></a><span id="l5.1524">   &quot;below&quot;,</span>
<a href="#l5.1525"></a><span id="l5.1525">   &quot;hsides&quot;,</span>
<a href="#l5.1526"></a><span id="l5.1526">   &quot;lhs&quot;,</span>
<a href="#l5.1527"></a><span id="l5.1527">   &quot;rhs&quot;,</span>
<a href="#l5.1528"></a><span id="l5.1528">   &quot;vsides&quot;,</span>
<a href="#l5.1529"></a><span id="l5.1529">   &quot;box&quot;,</span>
<a href="#l5.1530"></a><span id="l5.1530" class="difflineminus">-  &quot;border&quot;</span>
<a href="#l5.1531"></a><span id="l5.1531" class="difflineplus">+  &quot;border&quot;,</span>
<a href="#l5.1532"></a><span id="l5.1532"> ];</span>
<a href="#l5.1533"></a><span id="l5.1533"> </span>
<a href="#l5.1534"></a><span id="l5.1534"> gHTMLAttr.table_rules =</span>
<a href="#l5.1535"></a><span id="l5.1535"> [</span>
<a href="#l5.1536"></a><span id="l5.1536">   &quot;none&quot;,</span>
<a href="#l5.1537"></a><span id="l5.1537">   &quot;groups&quot;,</span>
<a href="#l5.1538"></a><span id="l5.1538">   &quot;rows&quot;,</span>
<a href="#l5.1539"></a><span id="l5.1539">   &quot;cols&quot;,</span>
<a href="#l5.1540"></a><span id="l5.1540" class="difflineminus">-  &quot;all&quot;</span>
<a href="#l5.1541"></a><span id="l5.1541" class="difflineplus">+  &quot;all&quot;,</span>
<a href="#l5.1542"></a><span id="l5.1542"> ];</span>
<a href="#l5.1543"></a><span id="l5.1543"> </span>
<a href="#l5.1544"></a><span id="l5.1544"> // Note; This is alignment of the table,</span>
<a href="#l5.1545"></a><span id="l5.1545"> //  not table contents, like all other table child elements</span>
<a href="#l5.1546"></a><span id="l5.1546"> gHTMLAttr.table_align = gHAlign;</span>
<a href="#l5.1547"></a><span id="l5.1547"> </span>
<a href="#l5.1548"></a><span id="l5.1548"> gHTMLAttr.table_bgcolor = gHTMLColors;</span>
<a href="#l5.1549"></a><span id="l5.1549"> </span>
<a href="#l5.1550"></a><span id="l5.1550" class="difflineat">@@ -1466,17 +1466,17 @@ gHTMLAttr.tbody =</span>
<a href="#l5.1551"></a><span id="l5.1551">   &quot;align&quot;,</span>
<a href="#l5.1552"></a><span id="l5.1552">   &quot;!char&quot;,</span>
<a href="#l5.1553"></a><span id="l5.1553">   &quot;#charoff&quot;,</span>
<a href="#l5.1554"></a><span id="l5.1554">   &quot;valign&quot;,</span>
<a href="#l5.1555"></a><span id="l5.1555">   &quot;-&quot;,</span>
<a href="#l5.1556"></a><span id="l5.1556">   &quot;_core&quot;,</span>
<a href="#l5.1557"></a><span id="l5.1557">   &quot;-&quot;,</span>
<a href="#l5.1558"></a><span id="l5.1558">   &quot;^lang&quot;,</span>
<a href="#l5.1559"></a><span id="l5.1559" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1560"></a><span id="l5.1560" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1561"></a><span id="l5.1561"> ];</span>
<a href="#l5.1562"></a><span id="l5.1562"> </span>
<a href="#l5.1563"></a><span id="l5.1563"> gHTMLAttr.tbody_align = gHAlignTableContent;</span>
<a href="#l5.1564"></a><span id="l5.1564"> </span>
<a href="#l5.1565"></a><span id="l5.1565"> gHTMLAttr.tbody_valign = gVAlignTable;</span>
<a href="#l5.1566"></a><span id="l5.1566"> </span>
<a href="#l5.1567"></a><span id="l5.1567"> gHTMLAttr.td =</span>
<a href="#l5.1568"></a><span id="l5.1568"> [</span>
<a href="#l5.1569"></a><span id="l5.1569" class="difflineat">@@ -1493,44 +1493,44 @@ gHTMLAttr.td =</span>
<a href="#l5.1570"></a><span id="l5.1570">   &quot;nowrap&quot;,</span>
<a href="#l5.1571"></a><span id="l5.1571">   &quot;bgcolor&quot;,</span>
<a href="#l5.1572"></a><span id="l5.1572">   &quot;%width&quot;,</span>
<a href="#l5.1573"></a><span id="l5.1573">   &quot;%height&quot;,</span>
<a href="#l5.1574"></a><span id="l5.1574">   &quot;-&quot;,</span>
<a href="#l5.1575"></a><span id="l5.1575">   &quot;_core&quot;,</span>
<a href="#l5.1576"></a><span id="l5.1576">   &quot;-&quot;,</span>
<a href="#l5.1577"></a><span id="l5.1577">   &quot;^lang&quot;,</span>
<a href="#l5.1578"></a><span id="l5.1578" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1579"></a><span id="l5.1579" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1580"></a><span id="l5.1580"> ];</span>
<a href="#l5.1581"></a><span id="l5.1581"> </span>
<a href="#l5.1582"></a><span id="l5.1582"> gHTMLAttr.td_scope =</span>
<a href="#l5.1583"></a><span id="l5.1583"> [</span>
<a href="#l5.1584"></a><span id="l5.1584">   &quot;row&quot;,</span>
<a href="#l5.1585"></a><span id="l5.1585">   &quot;col&quot;,</span>
<a href="#l5.1586"></a><span id="l5.1586">   &quot;rowgroup&quot;,</span>
<a href="#l5.1587"></a><span id="l5.1587" class="difflineminus">-  &quot;colgroup&quot;</span>
<a href="#l5.1588"></a><span id="l5.1588" class="difflineplus">+  &quot;colgroup&quot;,</span>
<a href="#l5.1589"></a><span id="l5.1589"> ];</span>
<a href="#l5.1590"></a><span id="l5.1590"> </span>
<a href="#l5.1591"></a><span id="l5.1591"> gHTMLAttr.td_rowspan =</span>
<a href="#l5.1592"></a><span id="l5.1592"> [</span>
<a href="#l5.1593"></a><span id="l5.1593" class="difflineminus">-  &quot;1&quot; // default</span>
<a href="#l5.1594"></a><span id="l5.1594" class="difflineplus">+  &quot;1&quot;, // default</span>
<a href="#l5.1595"></a><span id="l5.1595"> ];</span>
<a href="#l5.1596"></a><span id="l5.1596"> </span>
<a href="#l5.1597"></a><span id="l5.1597"> gHTMLAttr.td_colspan =</span>
<a href="#l5.1598"></a><span id="l5.1598"> [</span>
<a href="#l5.1599"></a><span id="l5.1599" class="difflineminus">-  &quot;1&quot; // default</span>
<a href="#l5.1600"></a><span id="l5.1600" class="difflineplus">+  &quot;1&quot;, // default</span>
<a href="#l5.1601"></a><span id="l5.1601"> ];</span>
<a href="#l5.1602"></a><span id="l5.1602"> </span>
<a href="#l5.1603"></a><span id="l5.1603"> gHTMLAttr.td_align = gHAlignTableContent;</span>
<a href="#l5.1604"></a><span id="l5.1604"> </span>
<a href="#l5.1605"></a><span id="l5.1605"> gHTMLAttr.td_valign = gVAlignTable;</span>
<a href="#l5.1606"></a><span id="l5.1606"> </span>
<a href="#l5.1607"></a><span id="l5.1607"> gHTMLAttr.td_nowrap =</span>
<a href="#l5.1608"></a><span id="l5.1608"> [</span>
<a href="#l5.1609"></a><span id="l5.1609" class="difflineminus">-  &quot;nowrap&quot;</span>
<a href="#l5.1610"></a><span id="l5.1610" class="difflineplus">+  &quot;nowrap&quot;,</span>
<a href="#l5.1611"></a><span id="l5.1611"> ];</span>
<a href="#l5.1612"></a><span id="l5.1612"> </span>
<a href="#l5.1613"></a><span id="l5.1613"> gHTMLAttr.td_bgcolor = gHTMLColors;</span>
<a href="#l5.1614"></a><span id="l5.1614"> </span>
<a href="#l5.1615"></a><span id="l5.1615"> gHTMLAttr.textarea =</span>
<a href="#l5.1616"></a><span id="l5.1616"> [</span>
<a href="#l5.1617"></a><span id="l5.1617">   &quot;name&quot;,</span>
<a href="#l5.1618"></a><span id="l5.1618">   &quot;$#rows&quot;,</span>
<a href="#l5.1619"></a><span id="l5.1619" class="difflineat">@@ -1538,41 +1538,41 @@ gHTMLAttr.textarea =</span>
<a href="#l5.1620"></a><span id="l5.1620">   &quot;disabled&quot;,</span>
<a href="#l5.1621"></a><span id="l5.1621">   &quot;readonly&quot;,</span>
<a href="#l5.1622"></a><span id="l5.1622">   &quot;#tabindex&quot;,</span>
<a href="#l5.1623"></a><span id="l5.1623">   &quot;!accesskey&quot;,</span>
<a href="#l5.1624"></a><span id="l5.1624">   &quot;-&quot;,</span>
<a href="#l5.1625"></a><span id="l5.1625">   &quot;_core&quot;,</span>
<a href="#l5.1626"></a><span id="l5.1626">   &quot;-&quot;,</span>
<a href="#l5.1627"></a><span id="l5.1627">   &quot;^lang&quot;,</span>
<a href="#l5.1628"></a><span id="l5.1628" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1629"></a><span id="l5.1629" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1630"></a><span id="l5.1630"> ];</span>
<a href="#l5.1631"></a><span id="l5.1631"> </span>
<a href="#l5.1632"></a><span id="l5.1632"> gHTMLAttr.textarea_disabled =</span>
<a href="#l5.1633"></a><span id="l5.1633"> [</span>
<a href="#l5.1634"></a><span id="l5.1634" class="difflineminus">-  &quot;disabled&quot;</span>
<a href="#l5.1635"></a><span id="l5.1635" class="difflineplus">+  &quot;disabled&quot;,</span>
<a href="#l5.1636"></a><span id="l5.1636"> ];</span>
<a href="#l5.1637"></a><span id="l5.1637"> </span>
<a href="#l5.1638"></a><span id="l5.1638"> gHTMLAttr.textarea_readonly =</span>
<a href="#l5.1639"></a><span id="l5.1639"> [</span>
<a href="#l5.1640"></a><span id="l5.1640" class="difflineminus">-  &quot;readonly&quot;</span>
<a href="#l5.1641"></a><span id="l5.1641" class="difflineplus">+  &quot;readonly&quot;,</span>
<a href="#l5.1642"></a><span id="l5.1642"> ];</span>
<a href="#l5.1643"></a><span id="l5.1643"> </span>
<a href="#l5.1644"></a><span id="l5.1644"> </span>
<a href="#l5.1645"></a><span id="l5.1645"> gHTMLAttr.tfoot =</span>
<a href="#l5.1646"></a><span id="l5.1646"> [</span>
<a href="#l5.1647"></a><span id="l5.1647">   &quot;align&quot;,</span>
<a href="#l5.1648"></a><span id="l5.1648">   &quot;!char&quot;,</span>
<a href="#l5.1649"></a><span id="l5.1649">   &quot;#charoff&quot;,</span>
<a href="#l5.1650"></a><span id="l5.1650">   &quot;valign&quot;,</span>
<a href="#l5.1651"></a><span id="l5.1651">   &quot;-&quot;,</span>
<a href="#l5.1652"></a><span id="l5.1652">   &quot;_core&quot;,</span>
<a href="#l5.1653"></a><span id="l5.1653">   &quot;-&quot;,</span>
<a href="#l5.1654"></a><span id="l5.1654">   &quot;^lang&quot;,</span>
<a href="#l5.1655"></a><span id="l5.1655" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1656"></a><span id="l5.1656" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1657"></a><span id="l5.1657"> ];</span>
<a href="#l5.1658"></a><span id="l5.1658"> </span>
<a href="#l5.1659"></a><span id="l5.1659"> gHTMLAttr.tfoot_align = gHAlignTableContent;</span>
<a href="#l5.1660"></a><span id="l5.1660"> </span>
<a href="#l5.1661"></a><span id="l5.1661"> gHTMLAttr.tfoot_valign = gVAlignTable;</span>
<a href="#l5.1662"></a><span id="l5.1662"> </span>
<a href="#l5.1663"></a><span id="l5.1663"> gHTMLAttr.th =</span>
<a href="#l5.1664"></a><span id="l5.1664"> [</span>
<a href="#l5.1665"></a><span id="l5.1665" class="difflineat">@@ -1589,223 +1589,223 @@ gHTMLAttr.th =</span>
<a href="#l5.1666"></a><span id="l5.1666">   &quot;nowrap&quot;,</span>
<a href="#l5.1667"></a><span id="l5.1667">   &quot;bgcolor&quot;,</span>
<a href="#l5.1668"></a><span id="l5.1668">   &quot;%width&quot;,</span>
<a href="#l5.1669"></a><span id="l5.1669">   &quot;%height&quot;,</span>
<a href="#l5.1670"></a><span id="l5.1670">   &quot;-&quot;,</span>
<a href="#l5.1671"></a><span id="l5.1671">   &quot;_core&quot;,</span>
<a href="#l5.1672"></a><span id="l5.1672">   &quot;-&quot;,</span>
<a href="#l5.1673"></a><span id="l5.1673">   &quot;^lang&quot;,</span>
<a href="#l5.1674"></a><span id="l5.1674" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1675"></a><span id="l5.1675" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1676"></a><span id="l5.1676"> ];</span>
<a href="#l5.1677"></a><span id="l5.1677"> </span>
<a href="#l5.1678"></a><span id="l5.1678"> gHTMLAttr.th_scope =</span>
<a href="#l5.1679"></a><span id="l5.1679"> [</span>
<a href="#l5.1680"></a><span id="l5.1680">   &quot;row&quot;,</span>
<a href="#l5.1681"></a><span id="l5.1681">   &quot;col&quot;,</span>
<a href="#l5.1682"></a><span id="l5.1682">   &quot;rowgroup&quot;,</span>
<a href="#l5.1683"></a><span id="l5.1683" class="difflineminus">-  &quot;colgroup&quot;</span>
<a href="#l5.1684"></a><span id="l5.1684" class="difflineplus">+  &quot;colgroup&quot;,</span>
<a href="#l5.1685"></a><span id="l5.1685"> ];</span>
<a href="#l5.1686"></a><span id="l5.1686"> </span>
<a href="#l5.1687"></a><span id="l5.1687"> gHTMLAttr.th_rowspan =</span>
<a href="#l5.1688"></a><span id="l5.1688"> [</span>
<a href="#l5.1689"></a><span id="l5.1689" class="difflineminus">-  &quot;1&quot; // default</span>
<a href="#l5.1690"></a><span id="l5.1690" class="difflineplus">+  &quot;1&quot;, // default</span>
<a href="#l5.1691"></a><span id="l5.1691"> ];</span>
<a href="#l5.1692"></a><span id="l5.1692"> </span>
<a href="#l5.1693"></a><span id="l5.1693"> gHTMLAttr.th_colspan =</span>
<a href="#l5.1694"></a><span id="l5.1694"> [</span>
<a href="#l5.1695"></a><span id="l5.1695" class="difflineminus">-  &quot;1&quot; // default</span>
<a href="#l5.1696"></a><span id="l5.1696" class="difflineplus">+  &quot;1&quot;, // default</span>
<a href="#l5.1697"></a><span id="l5.1697"> ];</span>
<a href="#l5.1698"></a><span id="l5.1698"> </span>
<a href="#l5.1699"></a><span id="l5.1699"> gHTMLAttr.th_align = gHAlignTableContent;</span>
<a href="#l5.1700"></a><span id="l5.1700"> </span>
<a href="#l5.1701"></a><span id="l5.1701"> gHTMLAttr.th_valign = gVAlignTable;</span>
<a href="#l5.1702"></a><span id="l5.1702"> </span>
<a href="#l5.1703"></a><span id="l5.1703"> gHTMLAttr.th_nowrap =</span>
<a href="#l5.1704"></a><span id="l5.1704"> [</span>
<a href="#l5.1705"></a><span id="l5.1705" class="difflineminus">-  &quot;nowrap&quot;</span>
<a href="#l5.1706"></a><span id="l5.1706" class="difflineplus">+  &quot;nowrap&quot;,</span>
<a href="#l5.1707"></a><span id="l5.1707"> ];</span>
<a href="#l5.1708"></a><span id="l5.1708"> </span>
<a href="#l5.1709"></a><span id="l5.1709"> gHTMLAttr.th_bgcolor = gHTMLColors;</span>
<a href="#l5.1710"></a><span id="l5.1710"> </span>
<a href="#l5.1711"></a><span id="l5.1711"> gHTMLAttr.thead =</span>
<a href="#l5.1712"></a><span id="l5.1712"> [</span>
<a href="#l5.1713"></a><span id="l5.1713">   &quot;align&quot;,</span>
<a href="#l5.1714"></a><span id="l5.1714">   &quot;!char&quot;,</span>
<a href="#l5.1715"></a><span id="l5.1715">   &quot;#charoff&quot;,</span>
<a href="#l5.1716"></a><span id="l5.1716">   &quot;valign&quot;,</span>
<a href="#l5.1717"></a><span id="l5.1717">   &quot;-&quot;,</span>
<a href="#l5.1718"></a><span id="l5.1718">   &quot;_core&quot;,</span>
<a href="#l5.1719"></a><span id="l5.1719">   &quot;-&quot;,</span>
<a href="#l5.1720"></a><span id="l5.1720">   &quot;^lang&quot;,</span>
<a href="#l5.1721"></a><span id="l5.1721" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1722"></a><span id="l5.1722" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1723"></a><span id="l5.1723"> ];</span>
<a href="#l5.1724"></a><span id="l5.1724"> </span>
<a href="#l5.1725"></a><span id="l5.1725"> gHTMLAttr.thead_align = gHAlignTableContent;</span>
<a href="#l5.1726"></a><span id="l5.1726"> </span>
<a href="#l5.1727"></a><span id="l5.1727"> gHTMLAttr.thead_valign = gVAlignTable;</span>
<a href="#l5.1728"></a><span id="l5.1728"> </span>
<a href="#l5.1729"></a><span id="l5.1729"> gHTMLAttr.title =</span>
<a href="#l5.1730"></a><span id="l5.1730"> [</span>
<a href="#l5.1731"></a><span id="l5.1731">   &quot;^lang&quot;,</span>
<a href="#l5.1732"></a><span id="l5.1732" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1733"></a><span id="l5.1733" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1734"></a><span id="l5.1734"> ];</span>
<a href="#l5.1735"></a><span id="l5.1735"> </span>
<a href="#l5.1736"></a><span id="l5.1736"> gHTMLAttr.tr =</span>
<a href="#l5.1737"></a><span id="l5.1737"> [</span>
<a href="#l5.1738"></a><span id="l5.1738">   &quot;align&quot;,</span>
<a href="#l5.1739"></a><span id="l5.1739">   &quot;!char&quot;,</span>
<a href="#l5.1740"></a><span id="l5.1740">   &quot;#charoff&quot;,</span>
<a href="#l5.1741"></a><span id="l5.1741">   &quot;valign&quot;,</span>
<a href="#l5.1742"></a><span id="l5.1742">   &quot;bgcolor&quot;,</span>
<a href="#l5.1743"></a><span id="l5.1743">   &quot;-&quot;,</span>
<a href="#l5.1744"></a><span id="l5.1744">   &quot;_core&quot;,</span>
<a href="#l5.1745"></a><span id="l5.1745">   &quot;-&quot;,</span>
<a href="#l5.1746"></a><span id="l5.1746">   &quot;^lang&quot;,</span>
<a href="#l5.1747"></a><span id="l5.1747" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1748"></a><span id="l5.1748" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1749"></a><span id="l5.1749"> ];</span>
<a href="#l5.1750"></a><span id="l5.1750"> </span>
<a href="#l5.1751"></a><span id="l5.1751"> gHTMLAttr.tr_align = gHAlignTableContent;</span>
<a href="#l5.1752"></a><span id="l5.1752"> </span>
<a href="#l5.1753"></a><span id="l5.1753"> gHTMLAttr.tr_valign = gVAlignTable;</span>
<a href="#l5.1754"></a><span id="l5.1754"> </span>
<a href="#l5.1755"></a><span id="l5.1755"> gHTMLAttr.tr_bgcolor = gHTMLColors;</span>
<a href="#l5.1756"></a><span id="l5.1756"> </span>
<a href="#l5.1757"></a><span id="l5.1757"> gHTMLAttr.tt =</span>
<a href="#l5.1758"></a><span id="l5.1758"> [</span>
<a href="#l5.1759"></a><span id="l5.1759">   &quot;_core&quot;,</span>
<a href="#l5.1760"></a><span id="l5.1760">   &quot;-&quot;,</span>
<a href="#l5.1761"></a><span id="l5.1761">   &quot;^lang&quot;,</span>
<a href="#l5.1762"></a><span id="l5.1762" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1763"></a><span id="l5.1763" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1764"></a><span id="l5.1764"> ];</span>
<a href="#l5.1765"></a><span id="l5.1765"> </span>
<a href="#l5.1766"></a><span id="l5.1766"> gHTMLAttr.u =</span>
<a href="#l5.1767"></a><span id="l5.1767"> [</span>
<a href="#l5.1768"></a><span id="l5.1768">   &quot;_core&quot;,</span>
<a href="#l5.1769"></a><span id="l5.1769">   &quot;-&quot;,</span>
<a href="#l5.1770"></a><span id="l5.1770">   &quot;^lang&quot;,</span>
<a href="#l5.1771"></a><span id="l5.1771" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1772"></a><span id="l5.1772" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1773"></a><span id="l5.1773"> ];</span>
<a href="#l5.1774"></a><span id="l5.1774"> gHTMLAttr.ul =</span>
<a href="#l5.1775"></a><span id="l5.1775"> [</span>
<a href="#l5.1776"></a><span id="l5.1776">   &quot;type&quot;,</span>
<a href="#l5.1777"></a><span id="l5.1777">   &quot;compact&quot;,</span>
<a href="#l5.1778"></a><span id="l5.1778">   &quot;-&quot;,</span>
<a href="#l5.1779"></a><span id="l5.1779">   &quot;_core&quot;,</span>
<a href="#l5.1780"></a><span id="l5.1780">   &quot;-&quot;,</span>
<a href="#l5.1781"></a><span id="l5.1781">   &quot;^lang&quot;,</span>
<a href="#l5.1782"></a><span id="l5.1782" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1783"></a><span id="l5.1783" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1784"></a><span id="l5.1784"> ];</span>
<a href="#l5.1785"></a><span id="l5.1785"> </span>
<a href="#l5.1786"></a><span id="l5.1786"> gHTMLAttr.ul_type =</span>
<a href="#l5.1787"></a><span id="l5.1787"> [</span>
<a href="#l5.1788"></a><span id="l5.1788">   &quot;disc&quot;,</span>
<a href="#l5.1789"></a><span id="l5.1789">   &quot;square&quot;,</span>
<a href="#l5.1790"></a><span id="l5.1790" class="difflineminus">-  &quot;circle&quot;</span>
<a href="#l5.1791"></a><span id="l5.1791" class="difflineplus">+  &quot;circle&quot;,</span>
<a href="#l5.1792"></a><span id="l5.1792"> ];</span>
<a href="#l5.1793"></a><span id="l5.1793"> </span>
<a href="#l5.1794"></a><span id="l5.1794"> gHTMLAttr.ul_compact =</span>
<a href="#l5.1795"></a><span id="l5.1795"> [</span>
<a href="#l5.1796"></a><span id="l5.1796" class="difflineminus">-  &quot;compact&quot;</span>
<a href="#l5.1797"></a><span id="l5.1797" class="difflineplus">+  &quot;compact&quot;,</span>
<a href="#l5.1798"></a><span id="l5.1798"> ];</span>
<a href="#l5.1799"></a><span id="l5.1799"> </span>
<a href="#l5.1800"></a><span id="l5.1800"> </span>
<a href="#l5.1801"></a><span id="l5.1801"> // Prefix with &quot;_&quot; since this is reserved (it's stripped out)</span>
<a href="#l5.1802"></a><span id="l5.1802"> gHTMLAttr._var =</span>
<a href="#l5.1803"></a><span id="l5.1803"> [</span>
<a href="#l5.1804"></a><span id="l5.1804">   &quot;_core&quot;,</span>
<a href="#l5.1805"></a><span id="l5.1805">   &quot;-&quot;,</span>
<a href="#l5.1806"></a><span id="l5.1806">   &quot;^lang&quot;,</span>
<a href="#l5.1807"></a><span id="l5.1807" class="difflineminus">-  &quot;dir&quot;</span>
<a href="#l5.1808"></a><span id="l5.1808" class="difflineplus">+  &quot;dir&quot;,</span>
<a href="#l5.1809"></a><span id="l5.1809"> ];</span>
<a href="#l5.1810"></a><span id="l5.1810"> </span>
<a href="#l5.1811"></a><span id="l5.1811"> // ================ JS Attributes ================ //</span>
<a href="#l5.1812"></a><span id="l5.1812"> // These are element specific even handlers.</span>
<a href="#l5.1813"></a><span id="l5.1813"> /* Most all elements use gCoreJSEvents, so those</span>
<a href="#l5.1814"></a><span id="l5.1814">    are assumed except for those listed here with &quot;noEvents&quot;</span>
<a href="#l5.1815"></a><span id="l5.1815"> */</span>
<a href="#l5.1816"></a><span id="l5.1816"> </span>
<a href="#l5.1817"></a><span id="l5.1817"> gJSAttr.a =</span>
<a href="#l5.1818"></a><span id="l5.1818"> [</span>
<a href="#l5.1819"></a><span id="l5.1819">   &quot;onfocus&quot;,</span>
<a href="#l5.1820"></a><span id="l5.1820" class="difflineminus">-  &quot;onblur&quot;</span>
<a href="#l5.1821"></a><span id="l5.1821" class="difflineplus">+  &quot;onblur&quot;,</span>
<a href="#l5.1822"></a><span id="l5.1822"> ];</span>
<a href="#l5.1823"></a><span id="l5.1823"> </span>
<a href="#l5.1824"></a><span id="l5.1824"> gJSAttr.area =</span>
<a href="#l5.1825"></a><span id="l5.1825"> [</span>
<a href="#l5.1826"></a><span id="l5.1826">   &quot;onfocus&quot;,</span>
<a href="#l5.1827"></a><span id="l5.1827" class="difflineminus">-  &quot;onblur&quot;</span>
<a href="#l5.1828"></a><span id="l5.1828" class="difflineplus">+  &quot;onblur&quot;,</span>
<a href="#l5.1829"></a><span id="l5.1829"> ];</span>
<a href="#l5.1830"></a><span id="l5.1830"> </span>
<a href="#l5.1831"></a><span id="l5.1831"> gJSAttr.body =</span>
<a href="#l5.1832"></a><span id="l5.1832"> [</span>
<a href="#l5.1833"></a><span id="l5.1833">   &quot;onload&quot;,</span>
<a href="#l5.1834"></a><span id="l5.1834" class="difflineminus">-  &quot;onupload&quot;</span>
<a href="#l5.1835"></a><span id="l5.1835" class="difflineplus">+  &quot;onupload&quot;,</span>
<a href="#l5.1836"></a><span id="l5.1836"> ];</span>
<a href="#l5.1837"></a><span id="l5.1837"> </span>
<a href="#l5.1838"></a><span id="l5.1838"> gJSAttr.button =</span>
<a href="#l5.1839"></a><span id="l5.1839"> [</span>
<a href="#l5.1840"></a><span id="l5.1840">   &quot;onfocus&quot;,</span>
<a href="#l5.1841"></a><span id="l5.1841" class="difflineminus">-  &quot;onblur&quot;</span>
<a href="#l5.1842"></a><span id="l5.1842" class="difflineplus">+  &quot;onblur&quot;,</span>
<a href="#l5.1843"></a><span id="l5.1843"> ];</span>
<a href="#l5.1844"></a><span id="l5.1844"> </span>
<a href="#l5.1845"></a><span id="l5.1845"> gJSAttr.form =</span>
<a href="#l5.1846"></a><span id="l5.1846"> [</span>
<a href="#l5.1847"></a><span id="l5.1847">   &quot;onsubmit&quot;,</span>
<a href="#l5.1848"></a><span id="l5.1848" class="difflineminus">-  &quot;onreset&quot;</span>
<a href="#l5.1849"></a><span id="l5.1849" class="difflineplus">+  &quot;onreset&quot;,</span>
<a href="#l5.1850"></a><span id="l5.1850"> ];</span>
<a href="#l5.1851"></a><span id="l5.1851"> </span>
<a href="#l5.1852"></a><span id="l5.1852"> gJSAttr.frameset =</span>
<a href="#l5.1853"></a><span id="l5.1853"> [</span>
<a href="#l5.1854"></a><span id="l5.1854">   &quot;onload&quot;,</span>
<a href="#l5.1855"></a><span id="l5.1855" class="difflineminus">-  &quot;onunload&quot;</span>
<a href="#l5.1856"></a><span id="l5.1856" class="difflineplus">+  &quot;onunload&quot;,</span>
<a href="#l5.1857"></a><span id="l5.1857"> ];</span>
<a href="#l5.1858"></a><span id="l5.1858"> </span>
<a href="#l5.1859"></a><span id="l5.1859"> gJSAttr.input =</span>
<a href="#l5.1860"></a><span id="l5.1860"> [</span>
<a href="#l5.1861"></a><span id="l5.1861">   &quot;onfocus&quot;,</span>
<a href="#l5.1862"></a><span id="l5.1862">   &quot;onblur&quot;,</span>
<a href="#l5.1863"></a><span id="l5.1863">   &quot;onselect&quot;,</span>
<a href="#l5.1864"></a><span id="l5.1864" class="difflineminus">-  &quot;onchange&quot;</span>
<a href="#l5.1865"></a><span id="l5.1865" class="difflineplus">+  &quot;onchange&quot;,</span>
<a href="#l5.1866"></a><span id="l5.1866"> ];</span>
<a href="#l5.1867"></a><span id="l5.1867"> </span>
<a href="#l5.1868"></a><span id="l5.1868"> gJSAttr.label =</span>
<a href="#l5.1869"></a><span id="l5.1869"> [</span>
<a href="#l5.1870"></a><span id="l5.1870">   &quot;onfocus&quot;,</span>
<a href="#l5.1871"></a><span id="l5.1871" class="difflineminus">-  &quot;onblur&quot;</span>
<a href="#l5.1872"></a><span id="l5.1872" class="difflineplus">+  &quot;onblur&quot;,</span>
<a href="#l5.1873"></a><span id="l5.1873"> ];</span>
<a href="#l5.1874"></a><span id="l5.1874"> </span>
<a href="#l5.1875"></a><span id="l5.1875"> gJSAttr.select =</span>
<a href="#l5.1876"></a><span id="l5.1876"> [</span>
<a href="#l5.1877"></a><span id="l5.1877">   &quot;onfocus&quot;,</span>
<a href="#l5.1878"></a><span id="l5.1878">   &quot;onblur&quot;,</span>
<a href="#l5.1879"></a><span id="l5.1879" class="difflineminus">-  &quot;onchange&quot;</span>
<a href="#l5.1880"></a><span id="l5.1880" class="difflineplus">+  &quot;onchange&quot;,</span>
<a href="#l5.1881"></a><span id="l5.1881"> ];</span>
<a href="#l5.1882"></a><span id="l5.1882"> </span>
<a href="#l5.1883"></a><span id="l5.1883"> gJSAttr.textarea =</span>
<a href="#l5.1884"></a><span id="l5.1884"> [</span>
<a href="#l5.1885"></a><span id="l5.1885">   &quot;onfocus&quot;,</span>
<a href="#l5.1886"></a><span id="l5.1886">   &quot;onblur&quot;,</span>
<a href="#l5.1887"></a><span id="l5.1887">   &quot;onselect&quot;,</span>
<a href="#l5.1888"></a><span id="l5.1888" class="difflineminus">-  &quot;onchange&quot;</span>
<a href="#l5.1889"></a><span id="l5.1889" class="difflineplus">+  &quot;onchange&quot;,</span>
<a href="#l5.1890"></a><span id="l5.1890"> ];</span>
<a href="#l5.1891"></a><span id="l5.1891"> </span>
<a href="#l5.1892"></a><span id="l5.1892"> // Elements that don't have JSEvents:</span>
<a href="#l5.1893"></a><span id="l5.1893"> gJSAttr.font =</span>
<a href="#l5.1894"></a><span id="l5.1894"> [</span>
<a href="#l5.1895"></a><span id="l5.1895" class="difflineminus">-  &quot;noJSEvents&quot;</span>
<a href="#l5.1896"></a><span id="l5.1896" class="difflineplus">+  &quot;noJSEvents&quot;,</span>
<a href="#l5.1897"></a><span id="l5.1897"> ];</span>
<a href="#l5.1898"></a><span id="l5.1898"> </span>
<a href="#l5.1899"></a><span id="l5.1899"> gJSAttr.applet =</span>
<a href="#l5.1900"></a><span id="l5.1900"> [</span>
<a href="#l5.1901"></a><span id="l5.1901" class="difflineminus">-  &quot;noJSEvents&quot;</span>
<a href="#l5.1902"></a><span id="l5.1902" class="difflineplus">+  &quot;noJSEvents&quot;,</span>
<a href="#l5.1903"></a><span id="l5.1903"> ];</span>
<a href="#l5.1904"></a><span id="l5.1904"> </span>
<a href="#l5.1905"></a><span id="l5.1905"> gJSAttr.isindex =</span>
<a href="#l5.1906"></a><span id="l5.1906"> [</span>
<a href="#l5.1907"></a><span id="l5.1907" class="difflineminus">-  &quot;noJSEvents&quot;</span>
<a href="#l5.1908"></a><span id="l5.1908" class="difflineplus">+  &quot;noJSEvents&quot;,</span>
<a href="#l5.1909"></a><span id="l5.1909"> ];</span>
<a href="#l5.1910"></a><span id="l5.1910"> </span>
<a href="#l5.1911"></a><span id="l5.1911"> gJSAttr.iframe =</span>
<a href="#l5.1912"></a><span id="l5.1912"> [</span>
<a href="#l5.1913"></a><span id="l5.1913" class="difflineminus">-  &quot;noJSEvents&quot;</span>
<a href="#l5.1914"></a><span id="l5.1914" class="difflineplus">+  &quot;noJSEvents&quot;,</span>
<a href="#l5.1915"></a><span id="l5.1915"> ];</span>
<a href="#l5.1916"></a><span id="l5.1916"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAECSSAttributes.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAECSSAttributes.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,144 +1,126 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> // build attribute list in tree form from element attributes</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-function BuildCSSAttributeTable()</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-{</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+function BuildCSSAttributeTable() {</span>
<a href="#l6.12"></a><span id="l6.12">   var style = gElement.style;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  if (style == undefined)</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  {</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  if (style == undefined) {</span>
<a href="#l6.16"></a><span id="l6.16">     dump(&quot;Inline styles undefined\n&quot;);</span>
<a href="#l6.17"></a><span id="l6.17">     return;</span>
<a href="#l6.18"></a><span id="l6.18">   }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   var declLength = style.length;</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-  if (declLength == undefined || declLength == 0)</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-  {</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  if (declLength == undefined || declLength == 0) {</span>
<a href="#l6.25"></a><span id="l6.25">     if (declLength == undefined) {</span>
<a href="#l6.26"></a><span id="l6.26">       dump(&quot;Failed to query the number of inline style declarations\n&quot;);</span>
<a href="#l6.27"></a><span id="l6.27">     }</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">     return;</span>
<a href="#l6.30"></a><span id="l6.30">   }</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  if (declLength &gt; 0)</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-    for (var i = 0; i &lt; declLength; ++i)</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-    {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  if (declLength &gt; 0) {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    for (var i = 0; i &lt; declLength; ++i) {</span>
<a href="#l6.38"></a><span id="l6.38">       var name = style.item(i);</span>
<a href="#l6.39"></a><span id="l6.39">       var value = style.getPropertyValue(name);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-      AddTreeItem( name, value, &quot;CSSAList&quot;, CSSAttrs );</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+      AddTreeItem(name, value, &quot;CSSAList&quot;, CSSAttrs);</span>
<a href="#l6.42"></a><span id="l6.42">     }</span>
<a href="#l6.43"></a><span id="l6.43">   }</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">   ClearCSSInputWidgets();</span>
<a href="#l6.46"></a><span id="l6.46"> }</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-function onChangeCSSAttribute()</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-{</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+function onChangeCSSAttribute() {</span>
<a href="#l6.51"></a><span id="l6.51">   var name = TrimString(gDialog.AddCSSAttributeNameInput.value);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  if ( !name )</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  if (!name)</span>
<a href="#l6.54"></a><span id="l6.54">     return;</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56">   var value = TrimString(gDialog.AddCSSAttributeValueInput.value);</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">   // First try to update existing attribute</span>
<a href="#l6.59"></a><span id="l6.59">   // If not found, add new attribute</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-  if ( !UpdateExistingAttribute( name, value, &quot;CSSAList&quot; ) &amp;&amp; value)</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-    AddTreeItem( name, value, &quot;CSSAList&quot;, CSSAttrs );</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  if (!UpdateExistingAttribute(name, value, &quot;CSSAList&quot;) &amp;&amp; value)</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    AddTreeItem(name, value, &quot;CSSAList&quot;, CSSAttrs);</span>
<a href="#l6.64"></a><span id="l6.64"> }</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-function ClearCSSInputWidgets()</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-{</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+function ClearCSSInputWidgets() {</span>
<a href="#l6.69"></a><span id="l6.69">   gDialog.AddCSSAttributeTree.view.selection.clearSelection();</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  gDialog.AddCSSAttributeNameInput.value =&quot;&quot;;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  gDialog.AddCSSAttributeNameInput.value = &quot;&quot;;</span>
<a href="#l6.72"></a><span id="l6.72">   gDialog.AddCSSAttributeValueInput.value = &quot;&quot;;</span>
<a href="#l6.73"></a><span id="l6.73">   SetTextboxFocus(gDialog.AddCSSAttributeNameInput);</span>
<a href="#l6.74"></a><span id="l6.74"> }</span>
<a href="#l6.75"></a><span id="l6.75"> </span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-function onSelectCSSTreeItem()</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-{</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+function onSelectCSSTreeItem() {</span>
<a href="#l6.79"></a><span id="l6.79">   if (!gDoOnSelectTree)</span>
<a href="#l6.80"></a><span id="l6.80">     return;</span>
<a href="#l6.81"></a><span id="l6.81"> </span>
<a href="#l6.82"></a><span id="l6.82">   var tree = gDialog.AddCSSAttributeTree;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  if (tree &amp;&amp; tree.view.selection.count)</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-  {</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  if (tree &amp;&amp; tree.view.selection.count) {</span>
<a href="#l6.86"></a><span id="l6.86">     gDialog.AddCSSAttributeNameInput.value = GetTreeItemAttributeStr(getSelectedItem(tree));</span>
<a href="#l6.87"></a><span id="l6.87">     gDialog.AddCSSAttributeValueInput.value = GetTreeItemValueStr(getSelectedItem(tree));</span>
<a href="#l6.88"></a><span id="l6.88">   }</span>
<a href="#l6.89"></a><span id="l6.89"> }</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-function onInputCSSAttributeName()</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-{</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+function onInputCSSAttributeName() {</span>
<a href="#l6.94"></a><span id="l6.94">   var attName = TrimString(gDialog.AddCSSAttributeNameInput.value).toLowerCase();</span>
<a href="#l6.95"></a><span id="l6.95">   var newValue = &quot;&quot;;</span>
<a href="#l6.96"></a><span id="l6.96"> </span>
<a href="#l6.97"></a><span id="l6.97">   var existingValue = GetAndSelectExistingAttributeValue(attName, &quot;CSSAList&quot;);</span>
<a href="#l6.98"></a><span id="l6.98">   if (existingValue)</span>
<a href="#l6.99"></a><span id="l6.99">     newValue = existingValue;</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101">   gDialog.AddCSSAttributeValueInput.value = newValue;</span>
<a href="#l6.102"></a><span id="l6.102"> }</span>
<a href="#l6.103"></a><span id="l6.103"> </span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-function editCSSAttributeValue(targetCell)</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-{</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+function editCSSAttributeValue(targetCell) {</span>
<a href="#l6.107"></a><span id="l6.107">   if (IsNotTreeHeader(targetCell))</span>
<a href="#l6.108"></a><span id="l6.108">     gDialog.AddCSSAttributeValueInput.inputField.select();</span>
<a href="#l6.109"></a><span id="l6.109"> }</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-function UpdateCSSAttributes()</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-{</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+function UpdateCSSAttributes() {</span>
<a href="#l6.114"></a><span id="l6.114">   var CSSAList = document.getElementById(&quot;CSSAList&quot;);</span>
<a href="#l6.115"></a><span id="l6.115">   var styleString = &quot;&quot;;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  for(var i = 0; i &lt; CSSAList.childNodes.length; i++)</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  {</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+  for (var i = 0; i &lt; CSSAList.childNodes.length; i++) {</span>
<a href="#l6.119"></a><span id="l6.119">     var item = CSSAList.childNodes[i];</span>
<a href="#l6.120"></a><span id="l6.120">     var name = GetTreeItemAttributeStr(item);</span>
<a href="#l6.121"></a><span id="l6.121">     var value = GetTreeItemValueStr(item);</span>
<a href="#l6.122"></a><span id="l6.122">     // this code allows users to be sloppy in typing in values, and enter</span>
<a href="#l6.123"></a><span id="l6.123">     // things like &quot;foo: &quot; and &quot;bar;&quot;. This will trim off everything after the</span>
<a href="#l6.124"></a><span id="l6.124">     // respective character.</span>
<a href="#l6.125"></a><span id="l6.125">     if (name.includes(&quot;:&quot;))</span>
<a href="#l6.126"></a><span id="l6.126">       name = name.substring(0, name.lastIndexOf(&quot;:&quot;));</span>
<a href="#l6.127"></a><span id="l6.127">     if (value.includes(&quot;;&quot;))</span>
<a href="#l6.128"></a><span id="l6.128">       value = value.substring(0, value.lastIndexOf(&quot;;&quot;));</span>
<a href="#l6.129"></a><span id="l6.129">     if (i == (CSSAList.childNodes.length - 1))</span>
<a href="#l6.130"></a><span id="l6.130">       styleString += name + &quot;: &quot; + value + &quot;;&quot;;   // last property</span>
<a href="#l6.131"></a><span id="l6.131">     else</span>
<a href="#l6.132"></a><span id="l6.132">       styleString += name + &quot;: &quot; + value + &quot;; &quot;;</span>
<a href="#l6.133"></a><span id="l6.133">   }</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-  if (styleString)</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-  {</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+  if (styleString) {</span>
<a href="#l6.137"></a><span id="l6.137">     // Use editor transactions if modifying the element directly in the document</span>
<a href="#l6.138"></a><span id="l6.138">     doRemoveAttribute(&quot;style&quot;);</span>
<a href="#l6.139"></a><span id="l6.139">     doSetAttribute(&quot;style&quot;, styleString);  // NOTE BUG 18894!!!</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-  }</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-  else if (gElement.getAttribute(&quot;style&quot;))</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  } else if (gElement.getAttribute(&quot;style&quot;))</span>
<a href="#l6.143"></a><span id="l6.143">     doRemoveAttribute(&quot;style&quot;);</span>
<a href="#l6.144"></a><span id="l6.144"> }</span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-function RemoveCSSAttribute()</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-{</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+function RemoveCSSAttribute() {</span>
<a href="#l6.149"></a><span id="l6.149">   // We only allow 1 selected item</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-  if (gDialog.AddCSSAttributeTree.view.selection.count)</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-  {</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  if (gDialog.AddCSSAttributeTree.view.selection.count) {</span>
<a href="#l6.153"></a><span id="l6.153">     // Remove the item from the tree</span>
<a href="#l6.154"></a><span id="l6.154">     // We always rebuild complete &quot;style&quot; string,</span>
<a href="#l6.155"></a><span id="l6.155">     //  so no list of &quot;removed&quot; items</span>
<a href="#l6.156"></a><span id="l6.156">     getSelectedItem(gDialog.AddCSSAttributeTree).remove();</span>
<a href="#l6.157"></a><span id="l6.157"> </span>
<a href="#l6.158"></a><span id="l6.158">     ClearCSSInputWidgets();</span>
<a href="#l6.159"></a><span id="l6.159">   }</span>
<a href="#l6.160"></a><span id="l6.160"> }</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-function SelectCSSTree( index )</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-{</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+function SelectCSSTree(index) {</span>
<a href="#l6.165"></a><span id="l6.165">   gDoOnSelectTree = false;</span>
<a href="#l6.166"></a><span id="l6.166">   try {</span>
<a href="#l6.167"></a><span id="l6.167">     gDialog.AddCSSAttributeTree.selectedIndex = index;</span>
<a href="#l6.168"></a><span id="l6.168">   } catch (e) {}</span>
<a href="#l6.169"></a><span id="l6.169">   gDoOnSelectTree = true;</span>
<a href="#l6.170"></a><span id="l6.170"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAEHTMLAttributes.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAEHTMLAttributes.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,169 +1,144 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-function BuildHTMLAttributeNameList()</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-{</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+function BuildHTMLAttributeNameList() {</span>
<a href="#l7.11"></a><span id="l7.11">   gDialog.AddHTMLAttributeNameInput.removeAllItems();</span>
<a href="#l7.12"></a><span id="l7.12"> </span>
<a href="#l7.13"></a><span id="l7.13">   var elementName = gElement.localName;</span>
<a href="#l7.14"></a><span id="l7.14">   var attNames = gHTMLAttr[elementName];</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  if (attNames &amp;&amp; attNames.length)</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  if (attNames &amp;&amp; attNames.length) {</span>
<a href="#l7.19"></a><span id="l7.19">     var menuitem;</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-    for (var i = 0; i &lt; attNames.length; i++)</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-    {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+    for (var i = 0; i &lt; attNames.length; i++) {</span>
<a href="#l7.24"></a><span id="l7.24">       var name = attNames[i];</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-      if (name == &quot;_core&quot;)</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-      {</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+      if (name == &quot;_core&quot;) {</span>
<a href="#l7.29"></a><span id="l7.29">         // Signal to append the common 'core' attributes.</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-        for (var j = 0; j &lt; gCoreHTMLAttr.length; j++)</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-        {</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+        for (var j = 0; j &lt; gCoreHTMLAttr.length; j++) {</span>
<a href="#l7.33"></a><span id="l7.33">           name = gCoreHTMLAttr[j];</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">           // only filtering rule used for core attributes as of 8-20-01</span>
<a href="#l7.36"></a><span id="l7.36">           // Add more rules if necessary.</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-          if (name.includes(&quot;^&quot;))</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-          {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+          if (name.includes(&quot;^&quot;)) {</span>
<a href="#l7.40"></a><span id="l7.40">             name = name.replace(/\^/g, &quot;&quot;);</span>
<a href="#l7.41"></a><span id="l7.41">             menuitem = gDialog.AddHTMLAttributeNameInput.appendItem(name, name);</span>
<a href="#l7.42"></a><span id="l7.42">             menuitem.setAttribute(&quot;limitFirstChar&quot;, &quot;true&quot;);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-          }</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-          else</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+          } else</span>
<a href="#l7.46"></a><span id="l7.46">             gDialog.AddHTMLAttributeNameInput.appendItem(name, name);</span>
<a href="#l7.47"></a><span id="l7.47">         }</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-      }</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-      else if (name == &quot;-&quot;)</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-      {</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+      } else if (name == &quot;-&quot;) {</span>
<a href="#l7.52"></a><span id="l7.52">         // Signal for separator</span>
<a href="#l7.53"></a><span id="l7.53">         var popup = gDialog.AddHTMLAttributeNameInput.menupopup;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-        if (popup)</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-        {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+        if (popup) {</span>
<a href="#l7.57"></a><span id="l7.57">           var sep = document.createElementNS(XUL_NS, &quot;menuseparator&quot;);</span>
<a href="#l7.58"></a><span id="l7.58">           if (sep)</span>
<a href="#l7.59"></a><span id="l7.59">             popup.appendChild(sep);</span>
<a href="#l7.60"></a><span id="l7.60">         }</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-      }</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-      else</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-      {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+      } else {</span>
<a href="#l7.65"></a><span id="l7.65">         // Get information about value filtering</span>
<a href="#l7.66"></a><span id="l7.66">         let forceOneChar = name.includes(&quot;!&quot;);</span>
<a href="#l7.67"></a><span id="l7.67">         let forceInteger = name.includes(&quot;#&quot;);</span>
<a href="#l7.68"></a><span id="l7.68">         let forceSignedInteger = name.includes(&quot;+&quot;);</span>
<a href="#l7.69"></a><span id="l7.69">         let forceIntOrPercent = name.includes(&quot;%&quot;);</span>
<a href="#l7.70"></a><span id="l7.70">         let limitFirstChar = name.includes(&quot;\^&quot;);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-        //let required = name.includes(&quot;$&quot;);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+        // let required = name.includes(&quot;$&quot;);</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74">         // Strip flag characters</span>
<a href="#l7.75"></a><span id="l7.75">         name = name.replace(/[!^#%$+]/g, &quot;&quot;);</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">         menuitem = gDialog.AddHTMLAttributeNameInput.appendItem(name, name);</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-        if (menuitem)</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-        {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+        if (menuitem) {</span>
<a href="#l7.81"></a><span id="l7.81">           // Signify &quot;required&quot; attributes by special style</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-          //TODO: Don't do this until next version, when we add</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+          // TODO: Don't do this until next version, when we add</span>
<a href="#l7.84"></a><span id="l7.84">           //      explanatory text and an 'Autofill Required Attributes' button</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-          //if (required)</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+          // if (required)</span>
<a href="#l7.87"></a><span id="l7.87">           //  menuitem.setAttribute(&quot;class&quot;, &quot;menuitem-highlight-1&quot;);</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89">           // Set flags to filter value input</span>
<a href="#l7.90"></a><span id="l7.90">           if (forceOneChar)</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-            menuitem.setAttribute(&quot;forceOneChar&quot;,&quot;true&quot;);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+            menuitem.setAttribute(&quot;forceOneChar&quot;, &quot;true&quot;);</span>
<a href="#l7.93"></a><span id="l7.93">           if (limitFirstChar)</span>
<a href="#l7.94"></a><span id="l7.94">             menuitem.setAttribute(&quot;limitFirstChar&quot;, &quot;true&quot;);</span>
<a href="#l7.95"></a><span id="l7.95">           if (forceInteger)</span>
<a href="#l7.96"></a><span id="l7.96">             menuitem.setAttribute(&quot;forceInteger&quot;, &quot;true&quot;);</span>
<a href="#l7.97"></a><span id="l7.97">           if (forceSignedInteger)</span>
<a href="#l7.98"></a><span id="l7.98">             menuitem.setAttribute(&quot;forceSignedInteger&quot;, &quot;true&quot;);</span>
<a href="#l7.99"></a><span id="l7.99">           if (forceIntOrPercent)</span>
<a href="#l7.100"></a><span id="l7.100">             menuitem.setAttribute(&quot;forceIntOrPercent&quot;, &quot;true&quot;);</span>
<a href="#l7.101"></a><span id="l7.101">         }</span>
<a href="#l7.102"></a><span id="l7.102">       }</span>
<a href="#l7.103"></a><span id="l7.103">     }</span>
<a href="#l7.104"></a><span id="l7.104">   }</span>
<a href="#l7.105"></a><span id="l7.105"> }</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107"> // build attribute list in tree form from element attributes</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-function BuildHTMLAttributeTable()</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-{</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+function BuildHTMLAttributeTable() {</span>
<a href="#l7.111"></a><span id="l7.111">   var nodeMap = gElement.attributes;</span>
<a href="#l7.112"></a><span id="l7.112">   var i;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-  if (nodeMap.length &gt; 0)</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-  {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  if (nodeMap.length &gt; 0) {</span>
<a href="#l7.116"></a><span id="l7.116">     var added = false;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-    for(i = 0; i &lt; nodeMap.length; i++)</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-    {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+    for (i = 0; i &lt; nodeMap.length; i++) {</span>
<a href="#l7.120"></a><span id="l7.120">       let name = nodeMap[i].name.trim().toLowerCase();</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-      if ( CheckAttributeNameSimilarity( nodeMap[i].nodeName, HTMLAttrs ) ||</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-           name.startsWith(&quot;on&quot;) || name == &quot;style&quot; ) {</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+      if (CheckAttributeNameSimilarity(nodeMap[i].nodeName, HTMLAttrs) ||</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+           name.startsWith(&quot;on&quot;) || name == &quot;style&quot;) {</span>
<a href="#l7.125"></a><span id="l7.125">         continue;   // repeated or non-HTML attribute, ignore this one and go to next</span>
<a href="#l7.126"></a><span id="l7.126">       }</span>
<a href="#l7.127"></a><span id="l7.127">       if (!name.startsWith(&quot;_moz&quot;) &amp;&amp;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-          AddTreeItem(name, nodeMap[i].value, &quot;HTMLAList&quot;, HTMLAttrs))</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-      {</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+          AddTreeItem(name, nodeMap[i].value, &quot;HTMLAList&quot;, HTMLAttrs)) {</span>
<a href="#l7.131"></a><span id="l7.131">         added = true;</span>
<a href="#l7.132"></a><span id="l7.132">       }</span>
<a href="#l7.133"></a><span id="l7.133">     }</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135">     if (added)</span>
<a href="#l7.136"></a><span id="l7.136">       SelectHTMLTree(0);</span>
<a href="#l7.137"></a><span id="l7.137">   }</span>
<a href="#l7.138"></a><span id="l7.138"> }</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-function ClearHTMLInputWidgets()</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-{</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+function ClearHTMLInputWidgets() {</span>
<a href="#l7.143"></a><span id="l7.143">   gDialog.AddHTMLAttributeTree.view.selection.clearSelection();</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-  gDialog.AddHTMLAttributeNameInput.value =&quot;&quot;;</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  gDialog.AddHTMLAttributeNameInput.value = &quot;&quot;;</span>
<a href="#l7.146"></a><span id="l7.146">   gDialog.AddHTMLAttributeValueInput.value = &quot;&quot;;</span>
<a href="#l7.147"></a><span id="l7.147">   SetTextboxFocus(gDialog.AddHTMLAttributeNameInput);</span>
<a href="#l7.148"></a><span id="l7.148"> }</span>
<a href="#l7.149"></a><span id="l7.149"> </span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-function onSelectHTMLTreeItem()</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-{</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+function onSelectHTMLTreeItem() {</span>
<a href="#l7.153"></a><span id="l7.153">   if (!gDoOnSelectTree)</span>
<a href="#l7.154"></a><span id="l7.154">     return;</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156">   var tree = gDialog.AddHTMLAttributeTree;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-  if (tree &amp;&amp; tree.view.selection.count)</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-  {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  if (tree &amp;&amp; tree.view.selection.count) {</span>
<a href="#l7.160"></a><span id="l7.160">     var inputName = TrimString(gDialog.AddHTMLAttributeNameInput.value).toLowerCase();</span>
<a href="#l7.161"></a><span id="l7.161">     var selectedItem = getSelectedItem(tree);</span>
<a href="#l7.162"></a><span id="l7.162">     var selectedName = selectedItem.firstChild.firstChild.getAttribute(&quot;label&quot;);</span>
<a href="#l7.163"></a><span id="l7.163"> </span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-    if (inputName == selectedName)</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-    {</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+    if (inputName == selectedName) {</span>
<a href="#l7.167"></a><span id="l7.167">       // Already editing selected name - just update the value input</span>
<a href="#l7.168"></a><span id="l7.168">       gDialog.AddHTMLAttributeValueInput.value = GetTreeItemValueStr(selectedItem);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-    }</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-    else</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-    {</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    } else {</span>
<a href="#l7.173"></a><span id="l7.173">       gDialog.AddHTMLAttributeNameInput.value = selectedName;</span>
<a href="#l7.174"></a><span id="l7.174"> </span>
<a href="#l7.175"></a><span id="l7.175">       // Change value input based on new selected name</span>
<a href="#l7.176"></a><span id="l7.176">       onInputHTMLAttributeName();</span>
<a href="#l7.177"></a><span id="l7.177">     }</span>
<a href="#l7.178"></a><span id="l7.178">   }</span>
<a href="#l7.179"></a><span id="l7.179"> }</span>
<a href="#l7.180"></a><span id="l7.180"> </span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-function onInputHTMLAttributeName()</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-{</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+function onInputHTMLAttributeName() {</span>
<a href="#l7.184"></a><span id="l7.184">   let attName = gDialog.AddHTMLAttributeNameInput.value.toLowerCase().trim();</span>
<a href="#l7.185"></a><span id="l7.185"> </span>
<a href="#l7.186"></a><span id="l7.186">   // Clear value widget, but prevent triggering update in tree</span>
<a href="#l7.187"></a><span id="l7.187">   gUpdateTreeValue = false;</span>
<a href="#l7.188"></a><span id="l7.188">   gDialog.AddHTMLAttributeValueInput.value = &quot;&quot;;</span>
<a href="#l7.189"></a><span id="l7.189">   gUpdateTreeValue = true;</span>
<a href="#l7.190"></a><span id="l7.190"> </span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-  if (attName)</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-  {</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  if (attName) {</span>
<a href="#l7.194"></a><span id="l7.194">     // Get value list for current attribute name</span>
<a href="#l7.195"></a><span id="l7.195">     var valueListName;</span>
<a href="#l7.196"></a><span id="l7.196"> </span>
<a href="#l7.197"></a><span id="l7.197">     // Most elements have the &quot;dir&quot; attribute,</span>
<a href="#l7.198"></a><span id="l7.198">     //   so we have just one array for the allowed values instead</span>
<a href="#l7.199"></a><span id="l7.199">     //   requiring duplicate entries for each element in EdAEAttributes.js</span>
<a href="#l7.200"></a><span id="l7.200">     if (attName == &quot;dir&quot;)</span>
<a href="#l7.201"></a><span id="l7.201">       valueListName = &quot;all_dir&quot;;</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineat">@@ -175,58 +150,51 @@ function onInputHTMLAttributeName()</span>
<a href="#l7.203"></a><span id="l7.203">       valueListName = valueListName.slice(1);</span>
<a href="#l7.204"></a><span id="l7.204"> </span>
<a href="#l7.205"></a><span id="l7.205">     var newValue = &quot;&quot;;</span>
<a href="#l7.206"></a><span id="l7.206">     var listLen = 0;</span>
<a href="#l7.207"></a><span id="l7.207"> </span>
<a href="#l7.208"></a><span id="l7.208">     // Index to which widget we were using to edit the value</span>
<a href="#l7.209"></a><span id="l7.209">     var deckIndex = gDialog.AddHTMLAttributeValueDeck.getAttribute(&quot;selectedIndex&quot;);</span>
<a href="#l7.210"></a><span id="l7.210"> </span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-    if (valueListName in gHTMLAttr)</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-    {</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    if (valueListName in gHTMLAttr) {</span>
<a href="#l7.214"></a><span id="l7.214">       var valueList = gHTMLAttr[valueListName];</span>
<a href="#l7.215"></a><span id="l7.215"> </span>
<a href="#l7.216"></a><span id="l7.216">       listLen = valueList.length;</span>
<a href="#l7.217"></a><span id="l7.217">       if (listLen == 1)</span>
<a href="#l7.218"></a><span id="l7.218">         newValue = valueList[0];</span>
<a href="#l7.219"></a><span id="l7.219"> </span>
<a href="#l7.220"></a><span id="l7.220">       // Note: For case where &quot;value list&quot; is actually just</span>
<a href="#l7.221"></a><span id="l7.221">       // one (default) item, don't use menulist for that</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-      if (listLen &gt; 1)</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-      {</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+      if (listLen &gt; 1) {</span>
<a href="#l7.225"></a><span id="l7.225">         gDialog.AddHTMLAttributeValueMenulist.removeAllItems();</span>
<a href="#l7.226"></a><span id="l7.226"> </span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-        if (deckIndex != &quot;1&quot;)</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-        {</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+        if (deckIndex != &quot;1&quot;) {</span>
<a href="#l7.230"></a><span id="l7.230">           // Switch to using editable menulist</span>
<a href="#l7.231"></a><span id="l7.231">           gDialog.AddHTMLAttributeValueInput = gDialog.AddHTMLAttributeValueMenulist;</span>
<a href="#l7.232"></a><span id="l7.232">           gDialog.AddHTMLAttributeValueDeck.setAttribute(&quot;selectedIndex&quot;, &quot;1&quot;);</span>
<a href="#l7.233"></a><span id="l7.233">         }</span>
<a href="#l7.234"></a><span id="l7.234">         // Rebuild the list</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-        for (var i = 0; i &lt; listLen; i++)</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-        {</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-          if (valueList[i] == &quot;-&quot;)</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-          {</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+        for (var i = 0; i &lt; listLen; i++) {</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+          if (valueList[i] == &quot;-&quot;) {</span>
<a href="#l7.241"></a><span id="l7.241">             // Signal for separator</span>
<a href="#l7.242"></a><span id="l7.242">             var popup = gDialog.AddHTMLAttributeValueInput.menupopup;</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-            if (popup)</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-            {</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+            if (popup) {</span>
<a href="#l7.246"></a><span id="l7.246">               var sep = document.createElementNS(XUL_NS, &quot;menuseparator&quot;);</span>
<a href="#l7.247"></a><span id="l7.247">               if (sep)</span>
<a href="#l7.248"></a><span id="l7.248">                 popup.appendChild(sep);</span>
<a href="#l7.249"></a><span id="l7.249">             }</span>
<a href="#l7.250"></a><span id="l7.250">           } else {</span>
<a href="#l7.251"></a><span id="l7.251">             gDialog.AddHTMLAttributeValueMenulist.appendItem(valueList[i], valueList[i]);</span>
<a href="#l7.252"></a><span id="l7.252">           }</span>
<a href="#l7.253"></a><span id="l7.253">         }</span>
<a href="#l7.254"></a><span id="l7.254">       }</span>
<a href="#l7.255"></a><span id="l7.255">     }</span>
<a href="#l7.256"></a><span id="l7.256"> </span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-    if (listLen &lt;= 1 &amp;&amp; deckIndex != &quot;0&quot;)</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-    {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+    if (listLen &lt;= 1 &amp;&amp; deckIndex != &quot;0&quot;) {</span>
<a href="#l7.260"></a><span id="l7.260">       // No list: Use textbox for input instead</span>
<a href="#l7.261"></a><span id="l7.261">       gDialog.AddHTMLAttributeValueInput = gDialog.AddHTMLAttributeValueTextbox;</span>
<a href="#l7.262"></a><span id="l7.262">       gDialog.AddHTMLAttributeValueDeck.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l7.263"></a><span id="l7.263">     }</span>
<a href="#l7.264"></a><span id="l7.264"> </span>
<a href="#l7.265"></a><span id="l7.265">     // If attribute already exists in tree, use associated value,</span>
<a href="#l7.266"></a><span id="l7.266">     //  else use default found above</span>
<a href="#l7.267"></a><span id="l7.267">     var existingValue = GetAndSelectExistingAttributeValue(attName, &quot;HTMLAList&quot;);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineat">@@ -235,133 +203,116 @@ function onInputHTMLAttributeName()</span>
<a href="#l7.269"></a><span id="l7.269"> </span>
<a href="#l7.270"></a><span id="l7.270">     gDialog.AddHTMLAttributeValueInput.value = newValue;</span>
<a href="#l7.271"></a><span id="l7.271"> </span>
<a href="#l7.272"></a><span id="l7.272">     if (!existingValue)</span>
<a href="#l7.273"></a><span id="l7.273">       onInputHTMLAttributeValue();</span>
<a href="#l7.274"></a><span id="l7.274">   }</span>
<a href="#l7.275"></a><span id="l7.275"> }</span>
<a href="#l7.276"></a><span id="l7.276"> </span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-function onInputHTMLAttributeValue()</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-{</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+function onInputHTMLAttributeValue() {</span>
<a href="#l7.280"></a><span id="l7.280">   if (!gUpdateTreeValue)</span>
<a href="#l7.281"></a><span id="l7.281">     return;</span>
<a href="#l7.282"></a><span id="l7.282"> </span>
<a href="#l7.283"></a><span id="l7.283">   var name = TrimString(gDialog.AddHTMLAttributeNameInput.value);</span>
<a href="#l7.284"></a><span id="l7.284">   if (!name)</span>
<a href="#l7.285"></a><span id="l7.285">     return;</span>
<a href="#l7.286"></a><span id="l7.286"> </span>
<a href="#l7.287"></a><span id="l7.287">   // Trim spaces only from left since we must allow spaces within the string</span>
<a href="#l7.288"></a><span id="l7.288">   //  (we always reset the input field's value below)</span>
<a href="#l7.289"></a><span id="l7.289">   var value = TrimStringLeft(gDialog.AddHTMLAttributeValueInput.value);</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">-  if (value)</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-  {</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+  if (value) {</span>
<a href="#l7.293"></a><span id="l7.293">     // Do value filtering based on type of attribute</span>
<a href="#l7.294"></a><span id="l7.294">     // (Do not use &quot;forceInteger()&quot; to avoid multiple</span>
<a href="#l7.295"></a><span id="l7.295">     //  resetting of input's value and flickering)</span>
<a href="#l7.296"></a><span id="l7.296">     var selectedItem = gDialog.AddHTMLAttributeNameInput.selectedItem;</span>
<a href="#l7.297"></a><span id="l7.297"> </span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-    if (selectedItem)</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-    {</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-      if ( selectedItem.getAttribute(&quot;forceOneChar&quot;) == &quot;true&quot; &amp;&amp;</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-           value.length &gt; 1 )</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+    if (selectedItem) {</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+      if (selectedItem.getAttribute(&quot;forceOneChar&quot;) == &quot;true&quot; &amp;&amp;</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+           value.length &gt; 1)</span>
<a href="#l7.305"></a><span id="l7.305">         value = value.slice(0, 1);</span>
<a href="#l7.306"></a><span id="l7.306"> </span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-      if ( selectedItem.getAttribute(&quot;forceIntOrPercent&quot;) == &quot;true&quot; )</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-      {</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+      if (selectedItem.getAttribute(&quot;forceIntOrPercent&quot;) == &quot;true&quot;) {</span>
<a href="#l7.310"></a><span id="l7.310">         // Allow integer with optional &quot;%&quot; as last character</span>
<a href="#l7.311"></a><span id="l7.311">         var percent = TrimStringRight(value).slice(-1);</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-        value = value.replace(/\D+/g,&quot;&quot;);</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+        value = value.replace(/\D+/g, &quot;&quot;);</span>
<a href="#l7.314"></a><span id="l7.314">         if (percent == &quot;%&quot;)</span>
<a href="#l7.315"></a><span id="l7.315">           value += percent;</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-      }</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-      else if ( selectedItem.getAttribute(&quot;forceInteger&quot;) == &quot;true&quot; )</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-      {</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-        value = value.replace(/\D+/g,&quot;&quot;);</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-      }</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-      else if ( selectedItem.getAttribute(&quot;forceSignedInteger&quot;) == &quot;true&quot; )</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-      {</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+      } else if (selectedItem.getAttribute(&quot;forceInteger&quot;) == &quot;true&quot;) {</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+        value = value.replace(/\D+/g, &quot;&quot;);</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+      } else if (selectedItem.getAttribute(&quot;forceSignedInteger&quot;) == &quot;true&quot;) {</span>
<a href="#l7.326"></a><span id="l7.326">         // Allow integer with optional &quot;+&quot; or &quot;-&quot; as first character</span>
<a href="#l7.327"></a><span id="l7.327">         var sign = value[0];</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-        value = value.replace(/\D+/g,&quot;&quot;);</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+        value = value.replace(/\D+/g, &quot;&quot;);</span>
<a href="#l7.330"></a><span id="l7.330">         if (sign == &quot;+&quot; || sign == &quot;-&quot;)</span>
<a href="#l7.331"></a><span id="l7.331">           value = sign + value;</span>
<a href="#l7.332"></a><span id="l7.332">       }</span>
<a href="#l7.333"></a><span id="l7.333"> </span>
<a href="#l7.334"></a><span id="l7.334">       // Special case attributes</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-      if (selectedItem.getAttribute(&quot;limitFirstChar&quot;) == &quot;true&quot;)</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-      {</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+      if (selectedItem.getAttribute(&quot;limitFirstChar&quot;) == &quot;true&quot;) {</span>
<a href="#l7.338"></a><span id="l7.338">         // Limit first character to letter, and all others to</span>
<a href="#l7.339"></a><span id="l7.339">         //  letters, numbers, and a few others</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-        value = value.replace(/^[^a-zA-Z\u0080-\uFFFF]/, &quot;&quot;).replace(/[^a-zA-Z0-9_\.\-\:\u0080-\uFFFF]+/g,'');</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+        value = value.replace(/^[^a-zA-Z\u0080-\uFFFF]/, &quot;&quot;).replace(/[^a-zA-Z0-9_\.\-\:\u0080-\uFFFF]+/g, &quot;&quot;);</span>
<a href="#l7.342"></a><span id="l7.342">       }</span>
<a href="#l7.343"></a><span id="l7.343"> </span>
<a href="#l7.344"></a><span id="l7.344">       // Update once only if it changed</span>
<a href="#l7.345"></a><span id="l7.345">       if (value != gDialog.AddHTMLAttributeValueInput.value)</span>
<a href="#l7.346"></a><span id="l7.346">         gDialog.AddHTMLAttributeValueInput.value = value;</span>
<a href="#l7.347"></a><span id="l7.347">     }</span>
<a href="#l7.348"></a><span id="l7.348">   }</span>
<a href="#l7.349"></a><span id="l7.349"> </span>
<a href="#l7.350"></a><span id="l7.350">   // Update value in the tree list</span>
<a href="#l7.351"></a><span id="l7.351">   // If not found, add new attribute</span>
<a href="#l7.352"></a><span id="l7.352">   if (!UpdateExistingAttribute(name, value, &quot;HTMLAList&quot;) &amp;&amp; value)</span>
<a href="#l7.353"></a><span id="l7.353">     AddTreeItem(name, value, &quot;HTMLAList&quot;, HTMLAttrs);</span>
<a href="#l7.354"></a><span id="l7.354"> }</span>
<a href="#l7.355"></a><span id="l7.355"> </span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-function editHTMLAttributeValue(targetCell)</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-{</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+function editHTMLAttributeValue(targetCell) {</span>
<a href="#l7.359"></a><span id="l7.359">   if (IsNotTreeHeader(targetCell))</span>
<a href="#l7.360"></a><span id="l7.360">     gDialog.AddHTMLAttributeValueInput.select();</span>
<a href="#l7.361"></a><span id="l7.361"> }</span>
<a href="#l7.362"></a><span id="l7.362"> </span>
<a href="#l7.363"></a><span id="l7.363"> </span>
<a href="#l7.364"></a><span id="l7.364"> // update the object with added and removed attributes</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-function UpdateHTMLAttributes()</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-{</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+function UpdateHTMLAttributes() {</span>
<a href="#l7.368"></a><span id="l7.368">   var HTMLAList = document.getElementById(&quot;HTMLAList&quot;);</span>
<a href="#l7.369"></a><span id="l7.369">   var i;</span>
<a href="#l7.370"></a><span id="l7.370"> </span>
<a href="#l7.371"></a><span id="l7.371">   // remove removed attributes</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-  for (i = 0; i &lt; HTMLRAttrs.length; i++)</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-  {</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+  for (i = 0; i &lt; HTMLRAttrs.length; i++) {</span>
<a href="#l7.375"></a><span id="l7.375">     var name = HTMLRAttrs[i];</span>
<a href="#l7.376"></a><span id="l7.376"> </span>
<a href="#l7.377"></a><span id="l7.377">     if (gElement.hasAttribute(name))</span>
<a href="#l7.378"></a><span id="l7.378">       doRemoveAttribute(name);</span>
<a href="#l7.379"></a><span id="l7.379">   }</span>
<a href="#l7.380"></a><span id="l7.380"> </span>
<a href="#l7.381"></a><span id="l7.381">   // Set added or changed attributes</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-  for( i = 0; i &lt; HTMLAList.childNodes.length; i++)</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-  {</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+  for (i = 0; i &lt; HTMLAList.childNodes.length; i++) {</span>
<a href="#l7.385"></a><span id="l7.385">     var item = HTMLAList.childNodes[i];</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-    doSetAttribute( GetTreeItemAttributeStr(item), GetTreeItemValueStr(item));</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+    doSetAttribute(GetTreeItemAttributeStr(item), GetTreeItemValueStr(item));</span>
<a href="#l7.388"></a><span id="l7.388">   }</span>
<a href="#l7.389"></a><span id="l7.389"> }</span>
<a href="#l7.390"></a><span id="l7.390"> </span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-function RemoveHTMLAttribute()</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-{</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+function RemoveHTMLAttribute() {</span>
<a href="#l7.394"></a><span id="l7.394">   // We only allow 1 selected item</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-  if (gDialog.AddHTMLAttributeTree.view.selection.count)</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-  {</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+  if (gDialog.AddHTMLAttributeTree.view.selection.count) {</span>
<a href="#l7.398"></a><span id="l7.398">     var item = getSelectedItem(gDialog.AddHTMLAttributeTree);</span>
<a href="#l7.399"></a><span id="l7.399">     var attr = GetTreeItemAttributeStr(item);</span>
<a href="#l7.400"></a><span id="l7.400"> </span>
<a href="#l7.401"></a><span id="l7.401">     // remove the item from the attribute array</span>
<a href="#l7.402"></a><span id="l7.402">     HTMLRAttrs[HTMLRAttrs.length] = attr;</span>
<a href="#l7.403"></a><span id="l7.403">     RemoveNameFromAttArray(attr, HTMLAttrs);</span>
<a href="#l7.404"></a><span id="l7.404"> </span>
<a href="#l7.405"></a><span id="l7.405">     // Remove the item from the tree</span>
<a href="#l7.406"></a><span id="l7.406">     item.remove();</span>
<a href="#l7.407"></a><span id="l7.407"> </span>
<a href="#l7.408"></a><span id="l7.408">     // Clear inputs and selected item in tree</span>
<a href="#l7.409"></a><span id="l7.409">     ClearHTMLInputWidgets();</span>
<a href="#l7.410"></a><span id="l7.410">   }</span>
<a href="#l7.411"></a><span id="l7.411"> }</span>
<a href="#l7.412"></a><span id="l7.412"> </span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-function SelectHTMLTree( index )</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineminus">-{</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+function SelectHTMLTree(index) {</span>
<a href="#l7.417"></a><span id="l7.417">   gDoOnSelectTree = false;</span>
<a href="#l7.418"></a><span id="l7.418">   try {</span>
<a href="#l7.419"></a><span id="l7.419">     gDialog.AddHTMLAttributeTree.selectedIndex = index;</span>
<a href="#l7.420"></a><span id="l7.420">   } catch (e) {}</span>
<a href="#l7.421"></a><span id="l7.421">   gDoOnSelectTree = true;</span>
<a href="#l7.422"></a><span id="l7.422"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAEJSEAttributes.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAEJSEAttributes.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,187 +1,164 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-function BuildJSEAttributeNameList()</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-{</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+function BuildJSEAttributeNameList() {</span>
<a href="#l8.11"></a><span id="l8.11">   gDialog.AddJSEAttributeNameList.removeAllItems();</span>
<a href="#l8.12"></a><span id="l8.12"> </span>
<a href="#l8.13"></a><span id="l8.13">   // Get events specific to current element</span>
<a href="#l8.14"></a><span id="l8.14">   var elementName = gElement.localName;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-  if (elementName in gJSAttr)</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  if (elementName in gJSAttr) {</span>
<a href="#l8.18"></a><span id="l8.18">     var attNames = gJSAttr[elementName];</span>
<a href="#l8.19"></a><span id="l8.19">     var i;</span>
<a href="#l8.20"></a><span id="l8.20">     var popup;</span>
<a href="#l8.21"></a><span id="l8.21">     var sep;</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-    if (attNames &amp;&amp; attNames.length)</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-    {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+    if (attNames &amp;&amp; attNames.length) {</span>
<a href="#l8.26"></a><span id="l8.26">       // Since we don't allow user-editable JS events yet (but we will soon)</span>
<a href="#l8.27"></a><span id="l8.27">       //  simply remove the JS tab to not allow adding JS events</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-      if (attNames[0] == &quot;noJSEvents&quot;)</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-      {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+      if (attNames[0] == &quot;noJSEvents&quot;) {</span>
<a href="#l8.31"></a><span id="l8.31">         var tab = document.getElementById(&quot;tabJSE&quot;);</span>
<a href="#l8.32"></a><span id="l8.32">         if (tab)</span>
<a href="#l8.33"></a><span id="l8.33">           tab.remove();</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35">         return;</span>
<a href="#l8.36"></a><span id="l8.36">       }</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">       for (i = 0; i &lt; attNames.length; i++)</span>
<a href="#l8.39"></a><span id="l8.39">         gDialog.AddJSEAttributeNameList.appendItem(attNames[i], attNames[i]);</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">       popup = gDialog.AddJSEAttributeNameList.firstChild;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-      if (popup)</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-      {</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+      if (popup) {</span>
<a href="#l8.45"></a><span id="l8.45">         sep = document.createElementNS(XUL_NS, &quot;menuseparator&quot;);</span>
<a href="#l8.46"></a><span id="l8.46">         if (sep)</span>
<a href="#l8.47"></a><span id="l8.47">           popup.appendChild(sep);</span>
<a href="#l8.48"></a><span id="l8.48">       }</span>
<a href="#l8.49"></a><span id="l8.49">     }</span>
<a href="#l8.50"></a><span id="l8.50">   }</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52">   // Always add core JS events unless we aborted above</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  for (i = 0; i &lt; gCoreJSEvents.length; i++)</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  {</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-    if (gCoreJSEvents[i] == &quot;-&quot;)</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    {</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  for (i = 0; i &lt; gCoreJSEvents.length; i++) {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    if (gCoreJSEvents[i] == &quot;-&quot;) {</span>
<a href="#l8.59"></a><span id="l8.59">       if (!popup)</span>
<a href="#l8.60"></a><span id="l8.60">         popup = gDialog.AddJSEAttributeNameList.firstChild;</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">       sep = document.createElementNS(XUL_NS, &quot;menuseparator&quot;);</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64">       if (popup &amp;&amp; sep)</span>
<a href="#l8.65"></a><span id="l8.65">         popup.appendChild(sep);</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    }</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-    else</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    } else</span>
<a href="#l8.69"></a><span id="l8.69">       gDialog.AddJSEAttributeNameList.appendItem(gCoreJSEvents[i], gCoreJSEvents[i]);</span>
<a href="#l8.70"></a><span id="l8.70">   }</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">   gDialog.AddJSEAttributeNameList.selectedIndex = 0;</span>
<a href="#l8.73"></a><span id="l8.73"> </span>
<a href="#l8.74"></a><span id="l8.74">   // Use current name and value of first tree item if it exists</span>
<a href="#l8.75"></a><span id="l8.75">   onSelectJSETreeItem();</span>
<a href="#l8.76"></a><span id="l8.76"> }</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78"> // build attribute list in tree form from element attributes</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-function BuildJSEAttributeTable()</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-{</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+function BuildJSEAttributeTable() {</span>
<a href="#l8.82"></a><span id="l8.82">   var nodeMap = gElement.attributes;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  if (nodeMap.length &gt; 0)</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-  {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  if (nodeMap.length &gt; 0) {</span>
<a href="#l8.86"></a><span id="l8.86">     var added = false;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-    for (var i = 0; i &lt; nodeMap.length; i++)</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    {</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    for (var i = 0; i &lt; nodeMap.length; i++) {</span>
<a href="#l8.90"></a><span id="l8.90">       let name = nodeMap[i].nodeName.toLowerCase();</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-      if( CheckAttributeNameSimilarity( nodeMap[i].nodeName, JSEAttrs ) )</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+      if (CheckAttributeNameSimilarity(nodeMap[i].nodeName, JSEAttrs))</span>
<a href="#l8.93"></a><span id="l8.93">         continue;   // repeated or non-JS handler, ignore this one and go to next</span>
<a href="#l8.94"></a><span id="l8.94">       if (!name.startsWith(&quot;on&quot;))</span>
<a href="#l8.95"></a><span id="l8.95">         continue; // attribute isn't an event handler.</span>
<a href="#l8.96"></a><span id="l8.96">       var value = gElement.getAttribute(nodeMap[i].nodeName);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-      if (AddTreeItem( name, value, &quot;JSEAList&quot;, JSEAttrs )) // add item to tree</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+      if (AddTreeItem(name, value, &quot;JSEAList&quot;, JSEAttrs)) // add item to tree</span>
<a href="#l8.99"></a><span id="l8.99">         added = true;</span>
<a href="#l8.100"></a><span id="l8.100">     }</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102">     // Select first item</span>
<a href="#l8.103"></a><span id="l8.103">     if (added)</span>
<a href="#l8.104"></a><span id="l8.104">       gDialog.AddJSEAttributeTree.selectedIndex = 0;</span>
<a href="#l8.105"></a><span id="l8.105">   }</span>
<a href="#l8.106"></a><span id="l8.106"> }</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-function onSelectJSEAttribute()</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-{</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-  if(!gDoOnSelectTree)</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+function onSelectJSEAttribute() {</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+  if (!gDoOnSelectTree)</span>
<a href="#l8.113"></a><span id="l8.113">     return;</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">   gDialog.AddJSEAttributeValueInput.value =</span>
<a href="#l8.116"></a><span id="l8.116">       GetAndSelectExistingAttributeValue(gDialog.AddJSEAttributeNameList.label, &quot;JSEAList&quot;);</span>
<a href="#l8.117"></a><span id="l8.117"> }</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-function onSelectJSETreeItem()</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-{</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+function onSelectJSETreeItem() {</span>
<a href="#l8.122"></a><span id="l8.122">   var tree = gDialog.AddJSEAttributeTree;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-  if (tree &amp;&amp; tree.view.selection.count)</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-  {</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+  if (tree &amp;&amp; tree.view.selection.count) {</span>
<a href="#l8.126"></a><span id="l8.126">     // Select attribute name in list</span>
<a href="#l8.127"></a><span id="l8.127">     gDialog.AddJSEAttributeNameList.value = GetTreeItemAttributeStr(getSelectedItem(tree));</span>
<a href="#l8.128"></a><span id="l8.128"> </span>
<a href="#l8.129"></a><span id="l8.129">     // Set value input to that in tree (no need to update this in the tree)</span>
<a href="#l8.130"></a><span id="l8.130">     gUpdateTreeValue = false;</span>
<a href="#l8.131"></a><span id="l8.131">     gDialog.AddJSEAttributeValueInput.value =  GetTreeItemValueStr(getSelectedItem(tree));</span>
<a href="#l8.132"></a><span id="l8.132">     gUpdateTreeValue = true;</span>
<a href="#l8.133"></a><span id="l8.133">   }</span>
<a href="#l8.134"></a><span id="l8.134"> }</span>
<a href="#l8.135"></a><span id="l8.135"> </span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-function onInputJSEAttributeValue()</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-{</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-  if (gUpdateTreeValue)</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-  {</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+function onInputJSEAttributeValue() {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  if (gUpdateTreeValue) {</span>
<a href="#l8.143"></a><span id="l8.143">     var name = TrimString(gDialog.AddJSEAttributeNameList.label);</span>
<a href="#l8.144"></a><span id="l8.144">     var value = TrimString(gDialog.AddJSEAttributeValueInput.value);</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146">     // Update value in the tree list</span>
<a href="#l8.147"></a><span id="l8.147">     // Since we have a non-editable menulist,</span>
<a href="#l8.148"></a><span id="l8.148">     //   we MUST automatically add the event attribute if it doesn't exist</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-    if (!UpdateExistingAttribute( name, value, &quot;JSEAList&quot; ) &amp;&amp; value)</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-      AddTreeItem( name, value, &quot;JSEAList&quot;, JSEAttrs );</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    if (!UpdateExistingAttribute(name, value, &quot;JSEAList&quot;) &amp;&amp; value)</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+      AddTreeItem(name, value, &quot;JSEAList&quot;, JSEAttrs);</span>
<a href="#l8.153"></a><span id="l8.153">   }</span>
<a href="#l8.154"></a><span id="l8.154"> }</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-function editJSEAttributeValue(targetCell)</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-{</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+function editJSEAttributeValue(targetCell) {</span>
<a href="#l8.159"></a><span id="l8.159">   if (IsNotTreeHeader(targetCell))</span>
<a href="#l8.160"></a><span id="l8.160">     gDialog.AddJSEAttributeValueInput.inputField.select();</span>
<a href="#l8.161"></a><span id="l8.161"> }</span>
<a href="#l8.162"></a><span id="l8.162"> </span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-function UpdateJSEAttributes()</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-{</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+function UpdateJSEAttributes() {</span>
<a href="#l8.166"></a><span id="l8.166">   var JSEAList = document.getElementById(&quot;JSEAList&quot;);</span>
<a href="#l8.167"></a><span id="l8.167">   var i;</span>
<a href="#l8.168"></a><span id="l8.168"> </span>
<a href="#l8.169"></a><span id="l8.169">   // remove removed attributes</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-  for (i = 0; i &lt; JSERAttrs.length; i++)</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-  {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  for (i = 0; i &lt; JSERAttrs.length; i++) {</span>
<a href="#l8.173"></a><span id="l8.173">     var name = JSERAttrs[i];</span>
<a href="#l8.174"></a><span id="l8.174"> </span>
<a href="#l8.175"></a><span id="l8.175">     if (gElement.hasAttribute(name))</span>
<a href="#l8.176"></a><span id="l8.176">       doRemoveAttribute(name);</span>
<a href="#l8.177"></a><span id="l8.177">   }</span>
<a href="#l8.178"></a><span id="l8.178"> </span>
<a href="#l8.179"></a><span id="l8.179">   // Add events</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-  for (i = 0; i &lt; JSEAList.childNodes.length; i++)</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-  {</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+  for (i = 0; i &lt; JSEAList.childNodes.length; i++) {</span>
<a href="#l8.183"></a><span id="l8.183">     var item = JSEAList.childNodes[i];</span>
<a href="#l8.184"></a><span id="l8.184"> </span>
<a href="#l8.185"></a><span id="l8.185">     // set the event handler</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-    doSetAttribute( GetTreeItemAttributeStr(item), GetTreeItemValueStr(item) );</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+    doSetAttribute(GetTreeItemAttributeStr(item), GetTreeItemValueStr(item));</span>
<a href="#l8.188"></a><span id="l8.188">   }</span>
<a href="#l8.189"></a><span id="l8.189"> }</span>
<a href="#l8.190"></a><span id="l8.190"> </span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-function RemoveJSEAttribute()</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-{</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+function RemoveJSEAttribute() {</span>
<a href="#l8.194"></a><span id="l8.194">   // This differs from HTML and CSS panels:</span>
<a href="#l8.195"></a><span id="l8.195">   // We reselect after removing, because there is not</span>
<a href="#l8.196"></a><span id="l8.196">   //  editable attribute name input, so we can't clear that</span>
<a href="#l8.197"></a><span id="l8.197">   //  like we do in other panels</span>
<a href="#l8.198"></a><span id="l8.198">   var newIndex = gDialog.AddJSEAttributeTree.selectedIndex;</span>
<a href="#l8.199"></a><span id="l8.199"> </span>
<a href="#l8.200"></a><span id="l8.200">   // We only allow 1 selected item</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-  if (gDialog.AddJSEAttributeTree.view.selection.count)</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-  {</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+  if (gDialog.AddJSEAttributeTree.view.selection.count) {</span>
<a href="#l8.204"></a><span id="l8.204">     var item = getSelectedItem(gDialog.AddJSEAttributeTree);</span>
<a href="#l8.205"></a><span id="l8.205"> </span>
<a href="#l8.206"></a><span id="l8.206">     // Name is the text of the treecell</span>
<a href="#l8.207"></a><span id="l8.207">     var attr = GetTreeItemAttributeStr(item);</span>
<a href="#l8.208"></a><span id="l8.208"> </span>
<a href="#l8.209"></a><span id="l8.209">     // remove the item from the attribute array</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-    if (newIndex &gt;= (JSEAttrs.length-1))</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+    if (newIndex &gt;= (JSEAttrs.length - 1))</span>
<a href="#l8.212"></a><span id="l8.212">       newIndex--;</span>
<a href="#l8.213"></a><span id="l8.213"> </span>
<a href="#l8.214"></a><span id="l8.214">     // remove the item from the attribute array</span>
<a href="#l8.215"></a><span id="l8.215">     JSERAttrs[JSERAttrs.length] = attr;</span>
<a href="#l8.216"></a><span id="l8.216">     RemoveNameFromAttArray(attr, JSEAttrs);</span>
<a href="#l8.217"></a><span id="l8.217"> </span>
<a href="#l8.218"></a><span id="l8.218">     // Remove the item from the tree</span>
<a href="#l8.219"></a><span id="l8.219">     item.remove();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAdvancedEdit.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAdvancedEdit.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,46 +1,44 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-/**************         GLOBALS         **************/</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+/** ************         GLOBALS         **************/</span>
<a href="#l9.10"></a><span id="l9.10"> var gElement    = null; // handle to actual element edited</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12"> var HTMLAttrs   = [];   // html attributes</span>
<a href="#l9.13"></a><span id="l9.13"> var CSSAttrs    = [];   // css attributes</span>
<a href="#l9.14"></a><span id="l9.14"> var JSEAttrs    = [];   // js events</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> var HTMLRAttrs  = [];   // removed html attributes</span>
<a href="#l9.17"></a><span id="l9.17"> var JSERAttrs   = [];   // removed js events</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19"> /* Set false to allow changing selection in tree</span>
<a href="#l9.20"></a><span id="l9.20">    without doing &quot;onselect&quot; handler actions</span>
<a href="#l9.21"></a><span id="l9.21"> */</span>
<a href="#l9.22"></a><span id="l9.22"> var gDoOnSelectTree = true;</span>
<a href="#l9.23"></a><span id="l9.23"> var gUpdateTreeValue = true;</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-/************** INITIALISATION &amp;&amp; SETUP **************/</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+/** ************ INITIALISATION &amp;&amp; SETUP **************/</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l9.29"></a><span id="l9.29"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31"> /**</span>
<a href="#l9.32"></a><span id="l9.32">  * function   : void Startup();</span>
<a href="#l9.33"></a><span id="l9.33">  * parameters : none</span>
<a href="#l9.34"></a><span id="l9.34">  * returns    : none</span>
<a href="#l9.35"></a><span id="l9.35">  * desc.      : startup and initialisation, prepares dialog.</span>
<a href="#l9.36"></a><span id="l9.36">  **/</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-function Startup()</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-{</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+function Startup() {</span>
<a href="#l9.40"></a><span id="l9.40">   var editor = GetCurrentEditor();</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42">   // Element to edit is passed in</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-  if (!editor || !window.arguments[1])</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  {</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  if (!editor || !window.arguments[1]) {</span>
<a href="#l9.46"></a><span id="l9.46">     dump(&quot;Advanced Edit: No editor or element to edit not supplied\n&quot;);</span>
<a href="#l9.47"></a><span id="l9.47">     window.close();</span>
<a href="#l9.48"></a><span id="l9.48">     return;</span>
<a href="#l9.49"></a><span id="l9.49">   }</span>
<a href="#l9.50"></a><span id="l9.50">   // This is the return value for the parent,</span>
<a href="#l9.51"></a><span id="l9.51">   // who only needs to know if OK was clicked</span>
<a href="#l9.52"></a><span id="l9.52">   window.opener.AdvancedEditOK = false;</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54" class="difflineat">@@ -89,100 +87,92 @@ function Startup()</span>
<a href="#l9.55"></a><span id="l9.55"> }</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57"> /**</span>
<a href="#l9.58"></a><span id="l9.58">  * function   : bool onAccept ( void );</span>
<a href="#l9.59"></a><span id="l9.59">  * parameters : none</span>
<a href="#l9.60"></a><span id="l9.60">  * returns    : boolean true to close the window</span>
<a href="#l9.61"></a><span id="l9.61">  * desc.      : event handler for ok button</span>
<a href="#l9.62"></a><span id="l9.62">  **/</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-function onAccept()</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-{</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+function onAccept() {</span>
<a href="#l9.66"></a><span id="l9.66">   var editor = GetCurrentEditor();</span>
<a href="#l9.67"></a><span id="l9.67">   editor.beginTransaction();</span>
<a href="#l9.68"></a><span id="l9.68">   try {</span>
<a href="#l9.69"></a><span id="l9.69">     // Update our gElement attributes</span>
<a href="#l9.70"></a><span id="l9.70">     UpdateHTMLAttributes();</span>
<a href="#l9.71"></a><span id="l9.71">     UpdateCSSAttributes();</span>
<a href="#l9.72"></a><span id="l9.72">     UpdateJSEAttributes();</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  } catch(ex) {</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+  } catch (ex) {</span>
<a href="#l9.75"></a><span id="l9.75">     dump(ex);</span>
<a href="#l9.76"></a><span id="l9.76">   }</span>
<a href="#l9.77"></a><span id="l9.77">   editor.endTransaction();</span>
<a href="#l9.78"></a><span id="l9.78"> </span>
<a href="#l9.79"></a><span id="l9.79">   window.opener.AdvancedEditOK = true;</span>
<a href="#l9.80"></a><span id="l9.80">   SaveWindowLocation();</span>
<a href="#l9.81"></a><span id="l9.81"> }</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83"> // Helpers for removing and setting attributes</span>
<a href="#l9.84"></a><span id="l9.84"> // Use editor transactions if modifying the element already in the document</span>
<a href="#l9.85"></a><span id="l9.85"> // (Temporary element from a property dialog won't have a parent node)</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-function doRemoveAttribute(attrib)</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-{</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+function doRemoveAttribute(attrib) {</span>
<a href="#l9.89"></a><span id="l9.89">   try {</span>
<a href="#l9.90"></a><span id="l9.90">     var editor = GetCurrentEditor();</span>
<a href="#l9.91"></a><span id="l9.91">     if (gElement.parentNode)</span>
<a href="#l9.92"></a><span id="l9.92">       editor.removeAttribute(gElement, attrib);</span>
<a href="#l9.93"></a><span id="l9.93">     else</span>
<a href="#l9.94"></a><span id="l9.94">       gElement.removeAttribute(attrib);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  } catch(ex) {}</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l9.97"></a><span id="l9.97"> }</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-function doSetAttribute(attrib, value)</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-{</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+function doSetAttribute(attrib, value) {</span>
<a href="#l9.102"></a><span id="l9.102">   try {</span>
<a href="#l9.103"></a><span id="l9.103">     var editor = GetCurrentEditor();</span>
<a href="#l9.104"></a><span id="l9.104">     if (gElement.parentNode)</span>
<a href="#l9.105"></a><span id="l9.105">       editor.setAttribute(gElement, attrib, value);</span>
<a href="#l9.106"></a><span id="l9.106">     else</span>
<a href="#l9.107"></a><span id="l9.107">       gElement.setAttribute(attrib, value);</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-  } catch(ex) {}</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l9.110"></a><span id="l9.110"> }</span>
<a href="#l9.111"></a><span id="l9.111"> </span>
<a href="#l9.112"></a><span id="l9.112"> /**</span>
<a href="#l9.113"></a><span id="l9.113">  * function   : bool CheckAttributeNameSimilarity ( string attName, array attArray );</span>
<a href="#l9.114"></a><span id="l9.114">  * parameters : attribute to look for, array of current attributes</span>
<a href="#l9.115"></a><span id="l9.115">  * returns    : true if attribute already exists, false if it does not</span>
<a href="#l9.116"></a><span id="l9.116">  * desc.      : checks to see if any other attributes by the same name as the arg supplied</span>
<a href="#l9.117"></a><span id="l9.117">  *              already exist.</span>
<a href="#l9.118"></a><span id="l9.118">  **/</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-function CheckAttributeNameSimilarity(attName, attArray)</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-{</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-  for (var i = 0; i &lt; attArray.length; i++)</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-  {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+function CheckAttributeNameSimilarity(attName, attArray) {</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  for (var i = 0; i &lt; attArray.length; i++) {</span>
<a href="#l9.125"></a><span id="l9.125">     if (attName.toLowerCase() == attArray[i].toLowerCase())</span>
<a href="#l9.126"></a><span id="l9.126">       return true;</span>
<a href="#l9.127"></a><span id="l9.127">   }</span>
<a href="#l9.128"></a><span id="l9.128">   return false;</span>
<a href="#l9.129"></a><span id="l9.129"> }</span>
<a href="#l9.130"></a><span id="l9.130"> </span>
<a href="#l9.131"></a><span id="l9.131"> /**</span>
<a href="#l9.132"></a><span id="l9.132">  * function   : bool UpdateExistingAttribute ( string attName, string attValue, string treeChildrenId );</span>
<a href="#l9.133"></a><span id="l9.133">  * parameters : attribute to look for, new value, ID of &lt;treeChildren&gt; node in XUL tree</span>
<a href="#l9.134"></a><span id="l9.134">  * returns    : true if attribute already exists in tree, false if it does not</span>
<a href="#l9.135"></a><span id="l9.135">  * desc.      : checks to see if any other attributes by the same name as the arg supplied</span>
<a href="#l9.136"></a><span id="l9.136">  *              already exist while setting the associated value if different from current value</span>
<a href="#l9.137"></a><span id="l9.137">  **/</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-function UpdateExistingAttribute( attName, attValue, treeChildrenId )</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-{</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+function UpdateExistingAttribute(attName, attValue, treeChildrenId) {</span>
<a href="#l9.141"></a><span id="l9.141">   var treeChildren = document.getElementById(treeChildrenId);</span>
<a href="#l9.142"></a><span id="l9.142">   if (!treeChildren)</span>
<a href="#l9.143"></a><span id="l9.143">     return false;</span>
<a href="#l9.144"></a><span id="l9.144"> </span>
<a href="#l9.145"></a><span id="l9.145">   var name;</span>
<a href="#l9.146"></a><span id="l9.146">   var i;</span>
<a href="#l9.147"></a><span id="l9.147">   attName = TrimString(attName).toLowerCase();</span>
<a href="#l9.148"></a><span id="l9.148">   attValue = TrimString(attValue);</span>
<a href="#l9.149"></a><span id="l9.149"> </span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-  for (i = 0; i &lt; treeChildren.childNodes.length; i++)</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-  {</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+  for (i = 0; i &lt; treeChildren.childNodes.length; i++) {</span>
<a href="#l9.153"></a><span id="l9.153">     var item = treeChildren.childNodes[i];</span>
<a href="#l9.154"></a><span id="l9.154">     name = GetTreeItemAttributeStr(item);</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-    if (name.toLowerCase() == attName)</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    {</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+    if (name.toLowerCase() == attName) {</span>
<a href="#l9.158"></a><span id="l9.158">       // Set the text in the &quot;value' column treecell</span>
<a href="#l9.159"></a><span id="l9.159">       SetTreeItemValueStr(item, attValue);</span>
<a href="#l9.160"></a><span id="l9.160"> </span>
<a href="#l9.161"></a><span id="l9.161">       // Select item just changed,</span>
<a href="#l9.162"></a><span id="l9.162">       //  but don't trigger the tree's onSelect handler</span>
<a href="#l9.163"></a><span id="l9.163">       gDoOnSelectTree = false;</span>
<a href="#l9.164"></a><span id="l9.164">       try {</span>
<a href="#l9.165"></a><span id="l9.165">         selectTreeItem(treeChildren, item);</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineat">@@ -195,31 +185,28 @@ function UpdateExistingAttribute( attNam</span>
<a href="#l9.167"></a><span id="l9.167">   return false;</span>
<a href="#l9.168"></a><span id="l9.168"> }</span>
<a href="#l9.169"></a><span id="l9.169"> </span>
<a href="#l9.170"></a><span id="l9.170"> /**</span>
<a href="#l9.171"></a><span id="l9.171">  * function   : string GetAndSelectExistingAttributeValue ( string attName, string treeChildrenId );</span>
<a href="#l9.172"></a><span id="l9.172">  * parameters : attribute to look for, ID of &lt;treeChildren&gt; node in XUL tree</span>
<a href="#l9.173"></a><span id="l9.173">  * returns    : value in from the tree or empty string if name not found</span>
<a href="#l9.174"></a><span id="l9.174">  **/</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-function GetAndSelectExistingAttributeValue( attName, treeChildrenId )</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-{</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+function GetAndSelectExistingAttributeValue(attName, treeChildrenId) {</span>
<a href="#l9.178"></a><span id="l9.178">   if (!attName)</span>
<a href="#l9.179"></a><span id="l9.179">     return &quot;&quot;;</span>
<a href="#l9.180"></a><span id="l9.180"> </span>
<a href="#l9.181"></a><span id="l9.181">   var treeChildren = document.getElementById(treeChildrenId);</span>
<a href="#l9.182"></a><span id="l9.182">   var name;</span>
<a href="#l9.183"></a><span id="l9.183">   var i;</span>
<a href="#l9.184"></a><span id="l9.184"> </span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-  for (i = 0; i &lt; treeChildren.childNodes.length; i++)</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-  {</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+  for (i = 0; i &lt; treeChildren.childNodes.length; i++) {</span>
<a href="#l9.188"></a><span id="l9.188">     var item = treeChildren.childNodes[i];</span>
<a href="#l9.189"></a><span id="l9.189">     name = GetTreeItemAttributeStr(item);</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-    if (name.toLowerCase() == attName.toLowerCase())</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-    {</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+    if (name.toLowerCase() == attName.toLowerCase()) {</span>
<a href="#l9.193"></a><span id="l9.193">       // Select item in the tree</span>
<a href="#l9.194"></a><span id="l9.194">       //  but don't trigger the tree's onSelect handler</span>
<a href="#l9.195"></a><span id="l9.195">       gDoOnSelectTree = false;</span>
<a href="#l9.196"></a><span id="l9.196">       try {</span>
<a href="#l9.197"></a><span id="l9.197">         selectTreeItem(treeChildren, item);</span>
<a href="#l9.198"></a><span id="l9.198">       } catch (e) {}</span>
<a href="#l9.199"></a><span id="l9.199">       gDoOnSelectTree = true;</span>
<a href="#l9.200"></a><span id="l9.200"> </span>
<a href="#l9.201"></a><span id="l9.201" class="difflineat">@@ -239,96 +226,85 @@ function GetAndSelectExistingAttributeVa</span>
<a href="#l9.202"></a><span id="l9.202"> }</span>
<a href="#l9.203"></a><span id="l9.203"> </span>
<a href="#l9.204"></a><span id="l9.204"> /* Tree structure:</span>
<a href="#l9.205"></a><span id="l9.205">   &lt;treeItem&gt;</span>
<a href="#l9.206"></a><span id="l9.206">     &lt;treeRow&gt;</span>
<a href="#l9.207"></a><span id="l9.207">       &lt;treeCell&gt; // Name Cell</span>
<a href="#l9.208"></a><span id="l9.208">       &lt;treeCell  // Value Cell</span>
<a href="#l9.209"></a><span id="l9.209"> */</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-function GetTreeItemAttributeStr(treeItem)</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-{</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+function GetTreeItemAttributeStr(treeItem) {</span>
<a href="#l9.213"></a><span id="l9.213">   if (treeItem)</span>
<a href="#l9.214"></a><span id="l9.214">     return TrimString(treeItem.firstChild.firstChild.getAttribute(&quot;label&quot;));</span>
<a href="#l9.215"></a><span id="l9.215"> </span>
<a href="#l9.216"></a><span id="l9.216">   return &quot;&quot;;</span>
<a href="#l9.217"></a><span id="l9.217"> }</span>
<a href="#l9.218"></a><span id="l9.218"> </span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-function GetTreeItemValueStr(treeItem)</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-{</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+function GetTreeItemValueStr(treeItem) {</span>
<a href="#l9.222"></a><span id="l9.222">   if (treeItem)</span>
<a href="#l9.223"></a><span id="l9.223">     return TrimString(treeItem.firstChild.lastChild.getAttribute(&quot;label&quot;));</span>
<a href="#l9.224"></a><span id="l9.224"> </span>
<a href="#l9.225"></a><span id="l9.225">   return &quot;&quot;;</span>
<a href="#l9.226"></a><span id="l9.226"> }</span>
<a href="#l9.227"></a><span id="l9.227"> </span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-function SetTreeItemValueStr(treeItem, value)</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-{</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+function SetTreeItemValueStr(treeItem, value) {</span>
<a href="#l9.231"></a><span id="l9.231">   if (treeItem &amp;&amp; GetTreeItemValueStr(treeItem) != value)</span>
<a href="#l9.232"></a><span id="l9.232">     treeItem.firstChild.lastChild.setAttribute(&quot;label&quot;, value);</span>
<a href="#l9.233"></a><span id="l9.233"> }</span>
<a href="#l9.234"></a><span id="l9.234"> </span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-function IsNotTreeHeader(treeCell)</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-{</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+function IsNotTreeHeader(treeCell) {</span>
<a href="#l9.238"></a><span id="l9.238">   if (treeCell)</span>
<a href="#l9.239"></a><span id="l9.239">     return (treeCell.parentNode.parentNode.nodeName != &quot;treehead&quot;);</span>
<a href="#l9.240"></a><span id="l9.240"> </span>
<a href="#l9.241"></a><span id="l9.241">   return false;</span>
<a href="#l9.242"></a><span id="l9.242"> }</span>
<a href="#l9.243"></a><span id="l9.243"> </span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-function RemoveNameFromAttArray(attName, attArray)</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-{</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-  for (var i=0; i &lt; attArray.length; i++)</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-  {</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-    if (attName.toLowerCase() == attArray[i].toLowerCase())</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-    {</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+function RemoveNameFromAttArray(attName, attArray) {</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+  for (var i = 0; i &lt; attArray.length; i++) {</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+    if (attName.toLowerCase() == attArray[i].toLowerCase()) {</span>
<a href="#l9.253"></a><span id="l9.253">       // Remove 1 array item</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-      attArray.splice(i,1);</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+      attArray.splice(i, 1);</span>
<a href="#l9.256"></a><span id="l9.256">       break;</span>
<a href="#l9.257"></a><span id="l9.257">     }</span>
<a href="#l9.258"></a><span id="l9.258">   }</span>
<a href="#l9.259"></a><span id="l9.259"> }</span>
<a href="#l9.260"></a><span id="l9.260"> </span>
<a href="#l9.261"></a><span id="l9.261"> // adds a generalised treeitem.</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-function AddTreeItem ( name, value, treeChildrenId, attArray )</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-{</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+function AddTreeItem(name, value, treeChildrenId, attArray) {</span>
<a href="#l9.265"></a><span id="l9.265">   attArray[attArray.length] = name;</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-  var treeChildren    = document.getElementById ( treeChildrenId );</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-  var treeitem    = document.createElementNS ( XUL_NS, &quot;treeitem&quot; );</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-  var treerow     = document.createElementNS ( XUL_NS, &quot;treerow&quot; );</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+  var treeChildren    = document.getElementById(treeChildrenId);</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+  var treeitem    = document.createElementNS(XUL_NS, &quot;treeitem&quot;);</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+  var treerow     = document.createElementNS(XUL_NS, &quot;treerow&quot;);</span>
<a href="#l9.272"></a><span id="l9.272"> </span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-  var attrCell    = document.createElementNS ( XUL_NS, &quot;treecell&quot; );</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-  attrCell.setAttribute( &quot;class&quot;, &quot;propertylist&quot; );</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-  attrCell.setAttribute( &quot;label&quot;, name );</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+  var attrCell    = document.createElementNS(XUL_NS, &quot;treecell&quot;);</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+  attrCell.setAttribute(&quot;class&quot;, &quot;propertylist&quot;);</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+  attrCell.setAttribute(&quot;label&quot;, name);</span>
<a href="#l9.279"></a><span id="l9.279"> </span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-  var valueCell    = document.createElementNS ( XUL_NS, &quot;treecell&quot; );</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-  valueCell.setAttribute( &quot;class&quot;, &quot;propertylist&quot; );</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-  valueCell.setAttribute( &quot;label&quot;, value );</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+  var valueCell    = document.createElementNS(XUL_NS, &quot;treecell&quot;);</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+  valueCell.setAttribute(&quot;class&quot;, &quot;propertylist&quot;);</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+  valueCell.setAttribute(&quot;label&quot;, value);</span>
<a href="#l9.286"></a><span id="l9.286"> </span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-  treerow.appendChild ( attrCell );</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-  treerow.appendChild ( valueCell );</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-  treeitem.appendChild ( treerow );</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-  treeChildren.appendChild ( treeitem );</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+  treerow.appendChild(attrCell);</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+  treerow.appendChild(valueCell);</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+  treeitem.appendChild(treerow);</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineplus">+  treeChildren.appendChild(treeitem);</span>
<a href="#l9.295"></a><span id="l9.295"> </span>
<a href="#l9.296"></a><span id="l9.296">   // Select item just added,</span>
<a href="#l9.297"></a><span id="l9.297">   //  but suppress calling the onSelect handler</span>
<a href="#l9.298"></a><span id="l9.298">   gDoOnSelectTree = false;</span>
<a href="#l9.299"></a><span id="l9.299">   try {</span>
<a href="#l9.300"></a><span id="l9.300">     selectTreeItem(treeChildren, treeitem);</span>
<a href="#l9.301"></a><span id="l9.301">   } catch (e) {}</span>
<a href="#l9.302"></a><span id="l9.302">   gDoOnSelectTree = true;</span>
<a href="#l9.303"></a><span id="l9.303"> </span>
<a href="#l9.304"></a><span id="l9.304">   return treeitem;</span>
<a href="#l9.305"></a><span id="l9.305"> }</span>
<a href="#l9.306"></a><span id="l9.306"> </span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-function selectTreeItem(treeChildren, item)</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-{</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+function selectTreeItem(treeChildren, item) {</span>
<a href="#l9.310"></a><span id="l9.310">   var index = treeChildren.parentNode.view.getIndexOfItem(item);</span>
<a href="#l9.311"></a><span id="l9.311">   treeChildren.parentNode.view.selection.select(index);</span>
<a href="#l9.312"></a><span id="l9.312"> }</span>
<a href="#l9.313"></a><span id="l9.313"> </span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-function getSelectedItem(tree)</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-{</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+function getSelectedItem(tree) {</span>
<a href="#l9.317"></a><span id="l9.317">   if (tree.view.selection.count == 1)</span>
<a href="#l9.318"></a><span id="l9.318">     return tree.view.getItemAtIndex(tree.currentIndex);</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-  else</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-    return null;</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineplus">+  return null;</span>
<a href="#l9.322"></a><span id="l9.322"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdButtonProps.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdButtonProps.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -5,58 +5,54 @@</span>
<a href="#l10.4"></a><span id="l10.4"> var insertNew;</span>
<a href="#l10.5"></a><span id="l10.5"> var buttonElement;</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> // dialog initialization code</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l10.10"></a><span id="l10.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-function Startup()</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+function Startup() {</span>
<a href="#l10.15"></a><span id="l10.15">   var editor = GetCurrentEditor();</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-  if (!editor)</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-  {</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l10.19"></a><span id="l10.19">     window.close();</span>
<a href="#l10.20"></a><span id="l10.20">     return;</span>
<a href="#l10.21"></a><span id="l10.21">   }</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">   gDialog = {</span>
<a href="#l10.24"></a><span id="l10.24">     buttonType:       document.getElementById(&quot;ButtonType&quot;),</span>
<a href="#l10.25"></a><span id="l10.25">     buttonName:       document.getElementById(&quot;ButtonName&quot;),</span>
<a href="#l10.26"></a><span id="l10.26">     buttonValue:      document.getElementById(&quot;ButtonValue&quot;),</span>
<a href="#l10.27"></a><span id="l10.27">     buttonDisabled:   document.getElementById(&quot;ButtonDisabled&quot;),</span>
<a href="#l10.28"></a><span id="l10.28">     buttonTabIndex:   document.getElementById(&quot;ButtonTabIndex&quot;),</span>
<a href="#l10.29"></a><span id="l10.29">     buttonAccessKey:  document.getElementById(&quot;ButtonAccessKey&quot;),</span>
<a href="#l10.30"></a><span id="l10.30">     MoreSection:      document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l10.31"></a><span id="l10.31">     MoreFewerButton:  document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    RemoveButton:     document.getElementById(&quot;RemoveButton&quot;)</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    RemoveButton:     document.getElementById(&quot;RemoveButton&quot;),</span>
<a href="#l10.34"></a><span id="l10.34">   };</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">   // Get a single selected button element</span>
<a href="#l10.37"></a><span id="l10.37">   const kTagName = &quot;button&quot;;</span>
<a href="#l10.38"></a><span id="l10.38">   try {</span>
<a href="#l10.39"></a><span id="l10.39">     buttonElement = editor.getSelectedElement(kTagName);</span>
<a href="#l10.40"></a><span id="l10.40">   } catch (e) {}</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42">   if (buttonElement)</span>
<a href="#l10.43"></a><span id="l10.43">     // We found an element and don't need to insert one</span>
<a href="#l10.44"></a><span id="l10.44">     insertNew = false;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  else</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  {</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  else {</span>
<a href="#l10.48"></a><span id="l10.48">     insertNew = true;</span>
<a href="#l10.49"></a><span id="l10.49"> </span>
<a href="#l10.50"></a><span id="l10.50">     // We don't have an element selected,</span>
<a href="#l10.51"></a><span id="l10.51">     //  so create one with default attributes</span>
<a href="#l10.52"></a><span id="l10.52">     try {</span>
<a href="#l10.53"></a><span id="l10.53">       buttonElement = editor.createElementWithDefaults(kTagName);</span>
<a href="#l10.54"></a><span id="l10.54">     } catch (e) {}</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-    if (!buttonElement)</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-    {</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+    if (!buttonElement) {</span>
<a href="#l10.59"></a><span id="l10.59">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l10.60"></a><span id="l10.60">       window.close();</span>
<a href="#l10.61"></a><span id="l10.61">       return;</span>
<a href="#l10.62"></a><span id="l10.62">     }</span>
<a href="#l10.63"></a><span id="l10.63">     // Hide button removing existing button</span>
<a href="#l10.64"></a><span id="l10.64">     gDialog.RemoveButton.hidden = true;</span>
<a href="#l10.65"></a><span id="l10.65">   }</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67" class="difflineat">@@ -67,81 +63,73 @@ function Startup()</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69">   InitMoreFewer();</span>
<a href="#l10.70"></a><span id="l10.70"> </span>
<a href="#l10.71"></a><span id="l10.71">   gDialog.buttonType.focus();</span>
<a href="#l10.72"></a><span id="l10.72"> </span>
<a href="#l10.73"></a><span id="l10.73">   SetWindowLocation();</span>
<a href="#l10.74"></a><span id="l10.74"> }</span>
<a href="#l10.75"></a><span id="l10.75"> </span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-function InitDialog()</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-{</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+function InitDialog() {</span>
<a href="#l10.79"></a><span id="l10.79">   var type = globalElement.getAttribute(&quot;type&quot;);</span>
<a href="#l10.80"></a><span id="l10.80">   var index = 0;</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-  switch (type)</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  {</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+  switch (type) {</span>
<a href="#l10.84"></a><span id="l10.84">     case &quot;button&quot;:</span>
<a href="#l10.85"></a><span id="l10.85">       index = 2;</span>
<a href="#l10.86"></a><span id="l10.86">       break;</span>
<a href="#l10.87"></a><span id="l10.87">     case &quot;reset&quot;:</span>
<a href="#l10.88"></a><span id="l10.88">       index = 1;</span>
<a href="#l10.89"></a><span id="l10.89">       break;</span>
<a href="#l10.90"></a><span id="l10.90">   }</span>
<a href="#l10.91"></a><span id="l10.91">   gDialog.buttonType.selectedIndex = index;</span>
<a href="#l10.92"></a><span id="l10.92">   gDialog.buttonName.value = globalElement.getAttribute(&quot;name&quot;);</span>
<a href="#l10.93"></a><span id="l10.93">   gDialog.buttonValue.value = globalElement.getAttribute(&quot;value&quot;);</span>
<a href="#l10.94"></a><span id="l10.94">   gDialog.buttonDisabled.setAttribute(&quot;checked&quot;, globalElement.hasAttribute(&quot;disabled&quot;));</span>
<a href="#l10.95"></a><span id="l10.95">   gDialog.buttonTabIndex.value = globalElement.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l10.96"></a><span id="l10.96">   gDialog.buttonAccessKey.value = globalElement.getAttribute(&quot;accesskey&quot;);</span>
<a href="#l10.97"></a><span id="l10.97"> }</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-function RemoveButton()</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-{</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+function RemoveButton() {</span>
<a href="#l10.102"></a><span id="l10.102">   RemoveContainer(buttonElement);</span>
<a href="#l10.103"></a><span id="l10.103">   SaveWindowLocation();</span>
<a href="#l10.104"></a><span id="l10.104">   window.close();</span>
<a href="#l10.105"></a><span id="l10.105"> }</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-function ValidateData()</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-{</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+function ValidateData() {</span>
<a href="#l10.110"></a><span id="l10.110">   var attributes = {</span>
<a href="#l10.111"></a><span id="l10.111">     type: [&quot;&quot;, &quot;reset&quot;, &quot;button&quot;][gDialog.buttonType.selectedIndex],</span>
<a href="#l10.112"></a><span id="l10.112">     name: gDialog.buttonName.value,</span>
<a href="#l10.113"></a><span id="l10.113">     value: gDialog.buttonValue.value,</span>
<a href="#l10.114"></a><span id="l10.114">     tabindex: gDialog.buttonTabIndex.value,</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-    accesskey: gDialog.buttonAccessKey.value</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+    accesskey: gDialog.buttonAccessKey.value,</span>
<a href="#l10.117"></a><span id="l10.117">   };</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-  for (var a in attributes)</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-  {</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+  for (var a in attributes) {</span>
<a href="#l10.121"></a><span id="l10.121">     if (attributes[a])</span>
<a href="#l10.122"></a><span id="l10.122">       globalElement.setAttribute(a, attributes[a]);</span>
<a href="#l10.123"></a><span id="l10.123">     else</span>
<a href="#l10.124"></a><span id="l10.124">       globalElement.removeAttribute(a);</span>
<a href="#l10.125"></a><span id="l10.125">   }</span>
<a href="#l10.126"></a><span id="l10.126">   if (gDialog.buttonDisabled.checked)</span>
<a href="#l10.127"></a><span id="l10.127">     globalElement.setAttribute(&quot;disabled&quot;, &quot;&quot;);</span>
<a href="#l10.128"></a><span id="l10.128">   else</span>
<a href="#l10.129"></a><span id="l10.129">     globalElement.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l10.130"></a><span id="l10.130">   return true;</span>
<a href="#l10.131"></a><span id="l10.131"> }</span>
<a href="#l10.132"></a><span id="l10.132"> </span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-function onAccept()</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-{</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+function onAccept() {</span>
<a href="#l10.136"></a><span id="l10.136">   // All values are valid - copy to actual element in doc or</span>
<a href="#l10.137"></a><span id="l10.137">   //   element created to insert</span>
<a href="#l10.138"></a><span id="l10.138">   ValidateData();</span>
<a href="#l10.139"></a><span id="l10.139"> </span>
<a href="#l10.140"></a><span id="l10.140">   var editor = GetCurrentEditor();</span>
<a href="#l10.141"></a><span id="l10.141"> </span>
<a href="#l10.142"></a><span id="l10.142">   editor.cloneAttributes(buttonElement, globalElement);</span>
<a href="#l10.143"></a><span id="l10.143"> </span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-  if (insertNew)</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-  {</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-    if (!InsertElementAroundSelection(buttonElement))</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-    {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+  if (insertNew) {</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+    if (!InsertElementAroundSelection(buttonElement)) {</span>
<a href="#l10.150"></a><span id="l10.150">       buttonElement.innerHTML = editor.outputToString(&quot;text/html&quot;, kOutputSelectionOnly);</span>
<a href="#l10.151"></a><span id="l10.151">       editor.insertElementAtSelection(buttonElement, true);</span>
<a href="#l10.152"></a><span id="l10.152">     }</span>
<a href="#l10.153"></a><span id="l10.153">   }</span>
<a href="#l10.154"></a><span id="l10.154"> </span>
<a href="#l10.155"></a><span id="l10.155">   SaveWindowLocation();</span>
<a href="#l10.156"></a><span id="l10.156"> }</span>
<a href="#l10.157"></a><span id="l10.157"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdColorPicker.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdColorPicker.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,36 +1,34 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-//Cancel() is in EdDialogCommon.js</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+// Cancel() is in EdDialogCommon.js</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12"> var insertNew = true;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-var tagname = &quot;TAG NAME&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+var tagname = &quot;TAG NAME&quot;;</span>
<a href="#l11.15"></a><span id="l11.15"> var gColor = &quot;&quot;;</span>
<a href="#l11.16"></a><span id="l11.16"> var LastPickedColor = &quot;&quot;;</span>
<a href="#l11.17"></a><span id="l11.17"> var ColorType = &quot;Text&quot;;</span>
<a href="#l11.18"></a><span id="l11.18"> var TextType = false;</span>
<a href="#l11.19"></a><span id="l11.19"> var HighlightType = false;</span>
<a href="#l11.20"></a><span id="l11.20"> var TableOrCell = false;</span>
<a href="#l11.21"></a><span id="l11.21"> var LastPickedIsDefault = true;</span>
<a href="#l11.22"></a><span id="l11.22"> var NoDefault = false;</span>
<a href="#l11.23"></a><span id="l11.23"> var gColorObj;</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> // dialog initialization code</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l11.28"></a><span id="l11.28"> document.addEventListener(&quot;dialogcancel&quot;, onCancelColor);</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-function Startup()</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-{</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  if (!window.arguments[1])</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  {</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+function Startup() {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  if (!window.arguments[1]) {</span>
<a href="#l11.36"></a><span id="l11.36">     dump(&quot;EdColorPicker: Missing color object param\n&quot;);</span>
<a href="#l11.37"></a><span id="l11.37">     return;</span>
<a href="#l11.38"></a><span id="l11.38">   }</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40">   // window.arguments[1] is object to get initial values and return color data</span>
<a href="#l11.41"></a><span id="l11.41">   gColorObj = window.arguments[1];</span>
<a href="#l11.42"></a><span id="l11.42">   gColorObj.Cancel = false;</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44" class="difflineat">@@ -42,38 +40,35 @@ function Startup()</span>
<a href="#l11.45"></a><span id="l11.45">   gDialog.TableRadio       = document.getElementById(&quot;TableRadio&quot;);</span>
<a href="#l11.46"></a><span id="l11.46">   gDialog.CellRadio        = document.getElementById(&quot;CellRadio&quot;);</span>
<a href="#l11.47"></a><span id="l11.47">   gDialog.ColorSwatch      = document.getElementById(&quot;ColorPickerSwatch&quot;);</span>
<a href="#l11.48"></a><span id="l11.48">   gDialog.Ok               = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50">   // The type of color we are setting:</span>
<a href="#l11.51"></a><span id="l11.51">   //  text: Text, Link, ActiveLink, VisitedLink,</span>
<a href="#l11.52"></a><span id="l11.52">   //  or background: Page, Table, or Cell</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-  if (gColorObj.Type)</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-  {</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  if (gColorObj.Type) {</span>
<a href="#l11.56"></a><span id="l11.56">     ColorType = gColorObj.Type;</span>
<a href="#l11.57"></a><span id="l11.57">     // Get string for dialog title from passed-in type</span>
<a href="#l11.58"></a><span id="l11.58">     //   (note constraint on editor.properties string name)</span>
<a href="#l11.59"></a><span id="l11.59">     let IsCSSPrefChecked = Services.prefs.getBoolPref(&quot;editor.use_css&quot;);</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    if (GetCurrentEditor())</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-    {</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+    if (GetCurrentEditor()) {</span>
<a href="#l11.64"></a><span id="l11.64">       if (ColorType == &quot;Page&quot; &amp;&amp; IsCSSPrefChecked &amp;&amp; IsHTMLEditor())</span>
<a href="#l11.65"></a><span id="l11.65">         document.title = GetString(&quot;BlockColor&quot;);</span>
<a href="#l11.66"></a><span id="l11.66">       else</span>
<a href="#l11.67"></a><span id="l11.67">         document.title = GetString(ColorType + &quot;Color&quot;);</span>
<a href="#l11.68"></a><span id="l11.68">     }</span>
<a href="#l11.69"></a><span id="l11.69">   }</span>
<a href="#l11.70"></a><span id="l11.70"> </span>
<a href="#l11.71"></a><span id="l11.71">   gDialog.ColorInput.value = &quot;&quot;;</span>
<a href="#l11.72"></a><span id="l11.72">   var tmpColor;</span>
<a href="#l11.73"></a><span id="l11.73">   var haveTableRadio = false;</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  switch (ColorType)</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-  {</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  switch (ColorType) {</span>
<a href="#l11.78"></a><span id="l11.78">     case &quot;Page&quot;:</span>
<a href="#l11.79"></a><span id="l11.79">       tmpColor = gColorObj.PageColor;</span>
<a href="#l11.80"></a><span id="l11.80">       if (tmpColor &amp;&amp; tmpColor.toLowerCase() != &quot;window&quot;)</span>
<a href="#l11.81"></a><span id="l11.81">         gColor = tmpColor;</span>
<a href="#l11.82"></a><span id="l11.82">       break;</span>
<a href="#l11.83"></a><span id="l11.83">     case &quot;Table&quot;:</span>
<a href="#l11.84"></a><span id="l11.84">       if (gColorObj.TableColor)</span>
<a href="#l11.85"></a><span id="l11.85">         gColor = gColorObj.TableColor;</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineat">@@ -81,24 +76,21 @@ function Startup()</span>
<a href="#l11.87"></a><span id="l11.87">     case &quot;Cell&quot;:</span>
<a href="#l11.88"></a><span id="l11.88">       if (gColorObj.CellColor)</span>
<a href="#l11.89"></a><span id="l11.89">         gColor = gColorObj.CellColor;</span>
<a href="#l11.90"></a><span id="l11.90">       break;</span>
<a href="#l11.91"></a><span id="l11.91">     case &quot;TableOrCell&quot;:</span>
<a href="#l11.92"></a><span id="l11.92">       TableOrCell = true;</span>
<a href="#l11.93"></a><span id="l11.93">       document.getElementById(&quot;TableOrCellGroup&quot;).collapsed = false;</span>
<a href="#l11.94"></a><span id="l11.94">       haveTableRadio = true;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-      if (gColorObj.SelectedType == &quot;Cell&quot;)</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-      {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+      if (gColorObj.SelectedType == &quot;Cell&quot;) {</span>
<a href="#l11.98"></a><span id="l11.98">         gColor = gColorObj.CellColor;</span>
<a href="#l11.99"></a><span id="l11.99">         gDialog.CellOrTableGroup.selectedItem = gDialog.CellRadio;</span>
<a href="#l11.100"></a><span id="l11.100">         gDialog.CellRadio.focus();</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-      }</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-      else</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-      {</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+      } else {</span>
<a href="#l11.105"></a><span id="l11.105">         gColor = gColorObj.TableColor;</span>
<a href="#l11.106"></a><span id="l11.106">         gDialog.CellOrTableGroup.selectedItem = gDialog.TableRadio;</span>
<a href="#l11.107"></a><span id="l11.107">         gDialog.TableRadio.focus();</span>
<a href="#l11.108"></a><span id="l11.108">       }</span>
<a href="#l11.109"></a><span id="l11.109">       break;</span>
<a href="#l11.110"></a><span id="l11.110">     case &quot;Highlight&quot;:</span>
<a href="#l11.111"></a><span id="l11.111">       HighlightType = true;</span>
<a href="#l11.112"></a><span id="l11.112">       if (gColorObj.HighlightColor)</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineat">@@ -113,31 +105,26 @@ function Startup()</span>
<a href="#l11.114"></a><span id="l11.114">       break;</span>
<a href="#l11.115"></a><span id="l11.115">   }</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117">   // Set initial color in input field and in the colorpicker</span>
<a href="#l11.118"></a><span id="l11.118">   SetCurrentColor(gColor);</span>
<a href="#l11.119"></a><span id="l11.119">   gDialog.ColorPicker.value = gColor;</span>
<a href="#l11.120"></a><span id="l11.120"> </span>
<a href="#l11.121"></a><span id="l11.121">   // Use last-picked colors passed in, or those persistent on dialog</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-  if (TextType)</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-  {</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-    if ( !(&quot;LastTextColor&quot; in gColorObj) || !gColorObj.LastTextColor)</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  if (TextType) {</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+    if (!(&quot;LastTextColor&quot; in gColorObj) || !gColorObj.LastTextColor)</span>
<a href="#l11.127"></a><span id="l11.127">       gColorObj.LastTextColor = gDialog.LastPickedColor.getAttribute(&quot;LastTextColor&quot;);</span>
<a href="#l11.128"></a><span id="l11.128">     LastPickedColor = gColorObj.LastTextColor;</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-  }</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-  else if (HighlightType)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-  {</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-    if ( !(&quot;LastHighlightColor&quot; in gColorObj) || !gColorObj.LastHighlightColor)</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+  } else if (HighlightType) {</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+    if (!(&quot;LastHighlightColor&quot; in gColorObj) || !gColorObj.LastHighlightColor)</span>
<a href="#l11.135"></a><span id="l11.135">       gColorObj.LastHighlightColor = gDialog.LastPickedColor.getAttribute(&quot;LastHighlightColor&quot;);</span>
<a href="#l11.136"></a><span id="l11.136">     LastPickedColor = gColorObj.LastHighlightColor;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-  }</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  else</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-  {</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-    if ( !(&quot;LastBackgroundColor&quot; in gColorObj) || !gColorObj.LastBackgroundColor)</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+  } else {</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+    if (!(&quot;LastBackgroundColor&quot; in gColorObj) || !gColorObj.LastBackgroundColor)</span>
<a href="#l11.143"></a><span id="l11.143">       gColorObj.LastBackgroundColor = gDialog.LastPickedColor.getAttribute(&quot;LastBackgroundColor&quot;);</span>
<a href="#l11.144"></a><span id="l11.144">     LastPickedColor = gColorObj.LastBackgroundColor;</span>
<a href="#l11.145"></a><span id="l11.145">   }</span>
<a href="#l11.146"></a><span id="l11.146"> </span>
<a href="#l11.147"></a><span id="l11.147">   // Set method to detect clicking on OK button</span>
<a href="#l11.148"></a><span id="l11.148">   //  so we don't get fooled by changing &quot;default&quot; behavior</span>
<a href="#l11.149"></a><span id="l11.149">   gDialog.Ok.setAttribute(&quot;onclick&quot;, &quot;SetDefaultToOk()&quot;);</span>
<a href="#l11.150"></a><span id="l11.150"> </span>
<a href="#l11.151"></a><span id="l11.151" class="difflineat">@@ -149,155 +136,131 @@ function Startup()</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153">     // Make &quot;Last-picked&quot; the default button, until the user selects a color.</span>
<a href="#l11.154"></a><span id="l11.154">     gDialog.Ok.removeAttribute(&quot;default&quot;);</span>
<a href="#l11.155"></a><span id="l11.155">     gDialog.LastPickedButton.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l11.156"></a><span id="l11.156">   }</span>
<a href="#l11.157"></a><span id="l11.157"> </span>
<a href="#l11.158"></a><span id="l11.158">   // Caller can prevent user from submitting an empty, i.e., default color</span>
<a href="#l11.159"></a><span id="l11.159">   NoDefault = gColorObj.NoDefault;</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-  if (NoDefault)</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-  {</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+  if (NoDefault) {</span>
<a href="#l11.163"></a><span id="l11.163">     // Hide the &quot;Default button -- user must pick a color</span>
<a href="#l11.164"></a><span id="l11.164">     document.getElementById(&quot;DefaultColorButton&quot;).collapsed = true;</span>
<a href="#l11.165"></a><span id="l11.165">   }</span>
<a href="#l11.166"></a><span id="l11.166"> </span>
<a href="#l11.167"></a><span id="l11.167">   // Set focus to colorpicker if not set to table radio buttons above</span>
<a href="#l11.168"></a><span id="l11.168">   if (!haveTableRadio)</span>
<a href="#l11.169"></a><span id="l11.169">     gDialog.ColorPicker.focus();</span>
<a href="#l11.170"></a><span id="l11.170"> </span>
<a href="#l11.171"></a><span id="l11.171">   SetWindowLocation();</span>
<a href="#l11.172"></a><span id="l11.172"> }</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-function SelectColor()</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-{</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+function SelectColor() {</span>
<a href="#l11.177"></a><span id="l11.177">   var color = gDialog.ColorPicker.value;</span>
<a href="#l11.178"></a><span id="l11.178">   if (color)</span>
<a href="#l11.179"></a><span id="l11.179">     SetCurrentColor(color);</span>
<a href="#l11.180"></a><span id="l11.180"> }</span>
<a href="#l11.181"></a><span id="l11.181"> </span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-function RemoveColor()</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-{</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+function RemoveColor() {</span>
<a href="#l11.185"></a><span id="l11.185">   SetCurrentColor(&quot;&quot;);</span>
<a href="#l11.186"></a><span id="l11.186">   gDialog.ColorInput.focus();</span>
<a href="#l11.187"></a><span id="l11.187">   SetDefaultToOk();</span>
<a href="#l11.188"></a><span id="l11.188"> }</span>
<a href="#l11.189"></a><span id="l11.189"> </span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-function SelectColorByKeypress(aEvent)</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-{</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-  if (aEvent.charCode == aEvent.DOM_VK_SPACE)</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-  {</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+function SelectColorByKeypress(aEvent) {</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+  if (aEvent.charCode == aEvent.DOM_VK_SPACE) {</span>
<a href="#l11.196"></a><span id="l11.196">     SelectColor();</span>
<a href="#l11.197"></a><span id="l11.197">     SetDefaultToOk();</span>
<a href="#l11.198"></a><span id="l11.198">   }</span>
<a href="#l11.199"></a><span id="l11.199"> }</span>
<a href="#l11.200"></a><span id="l11.200"> </span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-function SelectLastPickedColor()</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-{</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+function SelectLastPickedColor() {</span>
<a href="#l11.204"></a><span id="l11.204">   SetCurrentColor(LastPickedColor);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-  if ( onAccept() )</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-    //window.close();</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+  if (onAccept())</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+    // window.close();</span>
<a href="#l11.209"></a><span id="l11.209">     return true;</span>
<a href="#l11.210"></a><span id="l11.210"> </span>
<a href="#l11.211"></a><span id="l11.211">   return false;</span>
<a href="#l11.212"></a><span id="l11.212"> }</span>
<a href="#l11.213"></a><span id="l11.213"> </span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-function SetCurrentColor(color)</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-{</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+function SetCurrentColor(color) {</span>
<a href="#l11.217"></a><span id="l11.217">   // TODO: Validate color?</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-  if(!color) color = &quot;&quot;;</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+  if (!color) color = &quot;&quot;;</span>
<a href="#l11.220"></a><span id="l11.220">   gColor = TrimString(color).toLowerCase();</span>
<a href="#l11.221"></a><span id="l11.221">   if (gColor == &quot;mixed&quot;)</span>
<a href="#l11.222"></a><span id="l11.222">     gColor = &quot;&quot;;</span>
<a href="#l11.223"></a><span id="l11.223">   gDialog.ColorInput.value = gColor;</span>
<a href="#l11.224"></a><span id="l11.224">   SetColorSwatch();</span>
<a href="#l11.225"></a><span id="l11.225"> }</span>
<a href="#l11.226"></a><span id="l11.226"> </span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-function SetColorSwatch()</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-{</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+function SetColorSwatch() {</span>
<a href="#l11.230"></a><span id="l11.230">   // TODO: DON'T ALLOW SPACES?</span>
<a href="#l11.231"></a><span id="l11.231">   var color = TrimString(gDialog.ColorInput.value);</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-  if (color)</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-  {</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-    gDialog.ColorSwatch.setAttribute(&quot;style&quot;,(&quot;background-color:&quot;+color));</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+  if (color) {</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+    gDialog.ColorSwatch.setAttribute(&quot;style&quot;, (&quot;background-color:&quot; + color));</span>
<a href="#l11.237"></a><span id="l11.237">     gDialog.ColorSwatch.removeAttribute(&quot;default&quot;);</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-  }</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-  else</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-  {</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-    gDialog.ColorSwatch.setAttribute(&quot;style&quot;,(&quot;background-color:inherit&quot;));</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-    gDialog.ColorSwatch.setAttribute(&quot;default&quot;,&quot;true&quot;);</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+  } else {</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+    gDialog.ColorSwatch.setAttribute(&quot;style&quot;, (&quot;background-color:inherit&quot;));</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+    gDialog.ColorSwatch.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l11.246"></a><span id="l11.246">   }</span>
<a href="#l11.247"></a><span id="l11.247"> }</span>
<a href="#l11.248"></a><span id="l11.248"> </span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-function SetDefaultToOk()</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-{</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+function SetDefaultToOk() {</span>
<a href="#l11.252"></a><span id="l11.252">   gDialog.LastPickedButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-  gDialog.Ok.setAttribute(&quot;default&quot;,&quot;true&quot;);</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+  gDialog.Ok.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l11.255"></a><span id="l11.255">   LastPickedIsDefault = false;</span>
<a href="#l11.256"></a><span id="l11.256"> }</span>
<a href="#l11.257"></a><span id="l11.257"> </span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-function ValidateData()</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-{</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+function ValidateData() {</span>
<a href="#l11.261"></a><span id="l11.261">   if (LastPickedIsDefault)</span>
<a href="#l11.262"></a><span id="l11.262">     gColor = LastPickedColor;</span>
<a href="#l11.263"></a><span id="l11.263">   else</span>
<a href="#l11.264"></a><span id="l11.264">     gColor = gDialog.ColorInput.value;</span>
<a href="#l11.265"></a><span id="l11.265"> </span>
<a href="#l11.266"></a><span id="l11.266">   gColor = TrimString(gColor).toLowerCase();</span>
<a href="#l11.267"></a><span id="l11.267"> </span>
<a href="#l11.268"></a><span id="l11.268">   // TODO: Validate the color string!</span>
<a href="#l11.269"></a><span id="l11.269"> </span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-  if (NoDefault &amp;&amp; !gColor)</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-  {</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+  if (NoDefault &amp;&amp; !gColor) {</span>
<a href="#l11.273"></a><span id="l11.273">     ShowInputErrorMessage(GetString(&quot;NoColorError&quot;));</span>
<a href="#l11.274"></a><span id="l11.274">     SetTextboxFocus(gDialog.ColorInput);</span>
<a href="#l11.275"></a><span id="l11.275">     return false;</span>
<a href="#l11.276"></a><span id="l11.276">   }</span>
<a href="#l11.277"></a><span id="l11.277">   return true;</span>
<a href="#l11.278"></a><span id="l11.278"> }</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-function onAccept(event)</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-{</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+function onAccept(event) {</span>
<a href="#l11.283"></a><span id="l11.283">   if (!ValidateData()) {</span>
<a href="#l11.284"></a><span id="l11.284">     event.preventDefault();</span>
<a href="#l11.285"></a><span id="l11.285">     return;</span>
<a href="#l11.286"></a><span id="l11.286">   }</span>
<a href="#l11.287"></a><span id="l11.287"> </span>
<a href="#l11.288"></a><span id="l11.288">   // Set return values and save in persistent color attributes</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-  if (TextType)</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-  {</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+  if (TextType) {</span>
<a href="#l11.292"></a><span id="l11.292">     gColorObj.TextColor = gColor;</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-    if (gColor.length &gt; 0)</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-    {</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+    if (gColor.length &gt; 0) {</span>
<a href="#l11.296"></a><span id="l11.296">       gDialog.LastPickedColor.setAttribute(&quot;LastTextColor&quot;, gColor);</span>
<a href="#l11.297"></a><span id="l11.297">       gColorObj.LastTextColor = gColor;</span>
<a href="#l11.298"></a><span id="l11.298">     }</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-  }</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-  else if (HighlightType)</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-  {</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+  } else if (HighlightType) {</span>
<a href="#l11.303"></a><span id="l11.303">     gColorObj.HighlightColor = gColor;</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-    if (gColor.length &gt; 0)</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-    {</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+    if (gColor.length &gt; 0) {</span>
<a href="#l11.307"></a><span id="l11.307">       gDialog.LastPickedColor.setAttribute(&quot;LastHighlightColor&quot;, gColor);</span>
<a href="#l11.308"></a><span id="l11.308">       gColorObj.LastHighlightColor = gColor;</span>
<a href="#l11.309"></a><span id="l11.309">     }</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-  }</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-  else</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-  {</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+  } else {</span>
<a href="#l11.314"></a><span id="l11.314">     gColorObj.BackgroundColor = gColor;</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-    if (gColor.length &gt; 0)</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineminus">-    {</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+    if (gColor.length &gt; 0) {</span>
<a href="#l11.318"></a><span id="l11.318">       gDialog.LastPickedColor.setAttribute(&quot;LastBackgroundColor&quot;, gColor);</span>
<a href="#l11.319"></a><span id="l11.319">       gColorObj.LastBackgroundColor = gColor;</span>
<a href="#l11.320"></a><span id="l11.320">     }</span>
<a href="#l11.321"></a><span id="l11.321">     // If table or cell requested, tell caller which element to set on</span>
<a href="#l11.322"></a><span id="l11.322">     if (TableOrCell &amp;&amp; gDialog.TableRadio.selected)</span>
<a href="#l11.323"></a><span id="l11.323">       gColorObj.Type = &quot;Table&quot;;</span>
<a href="#l11.324"></a><span id="l11.324">   }</span>
<a href="#l11.325"></a><span id="l11.325">   SaveWindowLocation();</span>
<a href="#l11.326"></a><span id="l11.326"> }</span>
<a href="#l11.327"></a><span id="l11.327"> </span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-function onCancelColor()</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-{</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+function onCancelColor() {</span>
<a href="#l11.331"></a><span id="l11.331">   // Tells caller that user canceled</span>
<a href="#l11.332"></a><span id="l11.332">   gColorObj.Cancel = true;</span>
<a href="#l11.333"></a><span id="l11.333">   SaveWindowLocation();</span>
<a href="#l11.334"></a><span id="l11.334"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdColorProps.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdColorProps.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -7,31 +7,31 @@</span>
<a href="#l12.4"></a><span id="l12.4">  Radio buttons select &quot;UseDefaultColors&quot; vs. &quot;UseCustomColors&quot; modes.</span>
<a href="#l12.5"></a><span id="l12.5">  If any color attribute is set in the body, mode is &quot;Custom Colors&quot;,</span>
<a href="#l12.6"></a><span id="l12.6">   even if 1 or more (but not all) are actually null (= &quot;use default&quot;)</span>
<a href="#l12.7"></a><span id="l12.7">  When in &quot;Custom Colors&quot; mode, all colors will be set on body tag,</span>
<a href="#l12.8"></a><span id="l12.8">   even if they are just default colors, to assure compatible colors in page.</span>
<a href="#l12.9"></a><span id="l12.9">  User cannot select &quot;use default&quot; for individual colors</span>
<a href="#l12.10"></a><span id="l12.10"> */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-//Cancel() is in EdDialogCommon.js</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+// Cancel() is in EdDialogCommon.js</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l12.16"></a><span id="l12.16"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> var gBodyElement;</span>
<a href="#l12.19"></a><span id="l12.19"> var prefs;</span>
<a href="#l12.20"></a><span id="l12.20"> var gBackgroundImage;</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22"> // Initialize in case we can't get them from prefs???</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-var defaultTextColor=&quot;#000000&quot;;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-var defaultLinkColor=&quot;#000099&quot;;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-var defaultActiveColor=&quot;#000099&quot;;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-var defaultVisitedColor=&quot;#990099&quot;;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-var defaultBackgroundColor=&quot;#FFFFFF&quot;;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+var defaultTextColor = &quot;#000000&quot;;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+var defaultLinkColor = &quot;#000099&quot;;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+var defaultActiveColor = &quot;#000099&quot;;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+var defaultVisitedColor = &quot;#990099&quot;;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+var defaultBackgroundColor = &quot;#FFFFFF&quot;;</span>
<a href="#l12.33"></a><span id="l12.33"> const styleStr =       &quot;style&quot;;</span>
<a href="#l12.34"></a><span id="l12.34"> const textStr =        &quot;text&quot;;</span>
<a href="#l12.35"></a><span id="l12.35"> const linkStr =        &quot;link&quot;;</span>
<a href="#l12.36"></a><span id="l12.36"> const vlinkStr =       &quot;vlink&quot;;</span>
<a href="#l12.37"></a><span id="l12.37"> const alinkStr =       &quot;alink&quot;;</span>
<a href="#l12.38"></a><span id="l12.38"> const bgcolorStr =     &quot;bgcolor&quot;;</span>
<a href="#l12.39"></a><span id="l12.39"> const backgroundStr =  &quot;background&quot;;</span>
<a href="#l12.40"></a><span id="l12.40"> const cssColorStr = &quot;color&quot;;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineat">@@ -45,21 +45,19 @@ var customTextColor;</span>
<a href="#l12.42"></a><span id="l12.42"> var customLinkColor;</span>
<a href="#l12.43"></a><span id="l12.43"> var customActiveColor;</span>
<a href="#l12.44"></a><span id="l12.44"> var customVisitedColor;</span>
<a href="#l12.45"></a><span id="l12.45"> var customBackgroundColor;</span>
<a href="#l12.46"></a><span id="l12.46"> var previewBGColor;</span>
<a href="#l12.47"></a><span id="l12.47"> var gHaveDocumentUrl = false;</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49"> // dialog initialization code</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-function Startup()</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-{</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+function Startup() {</span>
<a href="#l12.53"></a><span id="l12.53">   var editor = GetCurrentEditor();</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-  if (!editor)</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-  {</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+  if (!editor) {</span>
<a href="#l12.57"></a><span id="l12.57">     window.close();</span>
<a href="#l12.58"></a><span id="l12.58">     return;</span>
<a href="#l12.59"></a><span id="l12.59">   }</span>
<a href="#l12.60"></a><span id="l12.60"> </span>
<a href="#l12.61"></a><span id="l12.61">   gDialog.ColorPreview = document.getElementById(&quot;ColorPreview&quot;);</span>
<a href="#l12.62"></a><span id="l12.62">   gDialog.NormalText = document.getElementById(&quot;NormalText&quot;);</span>
<a href="#l12.63"></a><span id="l12.63">   gDialog.LinkText = document.getElementById(&quot;LinkText&quot;);</span>
<a href="#l12.64"></a><span id="l12.64">   gDialog.ActiveLinkText = document.getElementById(&quot;ActiveLinkText&quot;);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineat">@@ -68,114 +66,106 @@ function Startup()</span>
<a href="#l12.66"></a><span id="l12.66">   gDialog.DefaultColorsRadio = document.getElementById(&quot;DefaultColorsRadio&quot;);</span>
<a href="#l12.67"></a><span id="l12.67">   gDialog.CustomColorsRadio = document.getElementById(&quot;CustomColorsRadio&quot;);</span>
<a href="#l12.68"></a><span id="l12.68">   gDialog.BackgroundImageInput = document.getElementById(&quot;BackgroundImageInput&quot;);</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70">   try {</span>
<a href="#l12.71"></a><span id="l12.71">     gBodyElement = editor.rootElement;</span>
<a href="#l12.72"></a><span id="l12.72">   } catch (e) {}</span>
<a href="#l12.73"></a><span id="l12.73"> </span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  if (!gBodyElement)</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-  {</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+  if (!gBodyElement) {</span>
<a href="#l12.77"></a><span id="l12.77">     dump(&quot;Failed to get BODY element!\n&quot;);</span>
<a href="#l12.78"></a><span id="l12.78">     window.close();</span>
<a href="#l12.79"></a><span id="l12.79">   }</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81">   // Set element we will edit</span>
<a href="#l12.82"></a><span id="l12.82">   globalElement = gBodyElement.cloneNode(false);</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84">   // Initialize default colors from browser prefs</span>
<a href="#l12.85"></a><span id="l12.85">   var browserColors = GetDefaultBrowserColors();</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-  if (browserColors)</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-  {</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  if (browserColors) {</span>
<a href="#l12.89"></a><span id="l12.89">     // Use author's browser pref colors passed into dialog</span>
<a href="#l12.90"></a><span id="l12.90">     defaultTextColor = browserColors.TextColor;</span>
<a href="#l12.91"></a><span id="l12.91">     defaultLinkColor = browserColors.LinkColor;</span>
<a href="#l12.92"></a><span id="l12.92">     defaultActiveColor = browserColors.ActiveLinkColor;</span>
<a href="#l12.93"></a><span id="l12.93">     defaultVisitedColor =  browserColors.VisitedLinkColor;</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-    defaultBackgroundColor=  browserColors.BackgroundColor;</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+    defaultBackgroundColor =  browserColors.BackgroundColor;</span>
<a href="#l12.96"></a><span id="l12.96">   }</span>
<a href="#l12.97"></a><span id="l12.97"> </span>
<a href="#l12.98"></a><span id="l12.98">   // We only need to test for this once per dialog load</span>
<a href="#l12.99"></a><span id="l12.99">   gHaveDocumentUrl = GetDocumentBaseUrl();</span>
<a href="#l12.100"></a><span id="l12.100"> </span>
<a href="#l12.101"></a><span id="l12.101">   InitDialog();</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103">   gDialog.PageColorGroup.focus();</span>
<a href="#l12.104"></a><span id="l12.104"> </span>
<a href="#l12.105"></a><span id="l12.105">   SetWindowLocation();</span>
<a href="#l12.106"></a><span id="l12.106"> }</span>
<a href="#l12.107"></a><span id="l12.107"> </span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-function InitDialog()</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-{</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+function InitDialog() {</span>
<a href="#l12.111"></a><span id="l12.111">   // Get image from document</span>
<a href="#l12.112"></a><span id="l12.112">   gBackgroundImage = GetHTMLOrCSSStyleValue(globalElement, backgroundStr, cssBackgroundImageStr);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-  if (/url\((.*)\)/.test( gBackgroundImage ))</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  if (/url\((.*)\)/.test(gBackgroundImage))</span>
<a href="#l12.115"></a><span id="l12.115">     gBackgroundImage = RegExp.$1;</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117">   if (gBackgroundImage) {</span>
<a href="#l12.118"></a><span id="l12.118">     // Shorten data URIs for display.</span>
<a href="#l12.119"></a><span id="l12.119">     shortenImageData(gBackgroundImage, gDialog.BackgroundImageInput);</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-    gDialog.ColorPreview.setAttribute(styleStr, backImageStyle+gBackgroundImage+&quot;);&quot;);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+    gDialog.ColorPreview.setAttribute(styleStr, backImageStyle + gBackgroundImage + &quot;);&quot;);</span>
<a href="#l12.122"></a><span id="l12.122">   }</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124">   SetRelativeCheckbox();</span>
<a href="#l12.125"></a><span id="l12.125"> </span>
<a href="#l12.126"></a><span id="l12.126">   customTextColor        = GetHTMLOrCSSStyleValue(globalElement, textStr, cssColorStr);</span>
<a href="#l12.127"></a><span id="l12.127">   customTextColor        = ConvertRGBColorIntoHEXColor(customTextColor);</span>
<a href="#l12.128"></a><span id="l12.128">   customLinkColor        = globalElement.getAttribute(linkStr);</span>
<a href="#l12.129"></a><span id="l12.129">   customActiveColor      = globalElement.getAttribute(alinkStr);</span>
<a href="#l12.130"></a><span id="l12.130">   customVisitedColor     = globalElement.getAttribute(vlinkStr);</span>
<a href="#l12.131"></a><span id="l12.131">   customBackgroundColor  = GetHTMLOrCSSStyleValue(globalElement, bgcolorStr, cssBackgroundColorStr);</span>
<a href="#l12.132"></a><span id="l12.132">   customBackgroundColor  = ConvertRGBColorIntoHEXColor(customBackgroundColor);</span>
<a href="#l12.133"></a><span id="l12.133"> </span>
<a href="#l12.134"></a><span id="l12.134">   var haveCustomColor =</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-        customTextColor       ||</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-        customLinkColor       ||</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-        customVisitedColor    ||</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-        customActiveColor     ||</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+        customTextColor ||</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+        customLinkColor ||</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+        customVisitedColor ||</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+        customActiveColor ||</span>
<a href="#l12.143"></a><span id="l12.143">         customBackgroundColor;</span>
<a href="#l12.144"></a><span id="l12.144"> </span>
<a href="#l12.145"></a><span id="l12.145">   // Set default color explicitly for any that are missing</span>
<a href="#l12.146"></a><span id="l12.146">   // PROBLEM: We are using &quot;windowtext&quot; and &quot;window&quot; for the Windows OS</span>
<a href="#l12.147"></a><span id="l12.147">   //   default color values. This works with CSS in preview window,</span>
<a href="#l12.148"></a><span id="l12.148">   //   but we should NOT use these as values for HTML attributes!</span>
<a href="#l12.149"></a><span id="l12.149"> </span>
<a href="#l12.150"></a><span id="l12.150">   if (!customTextColor) customTextColor = defaultTextColor;</span>
<a href="#l12.151"></a><span id="l12.151">   if (!customLinkColor) customLinkColor = defaultLinkColor;</span>
<a href="#l12.152"></a><span id="l12.152">   if (!customActiveColor) customActiveColor = defaultActiveColor;</span>
<a href="#l12.153"></a><span id="l12.153">   if (!customVisitedColor) customVisitedColor = defaultVisitedColor;</span>
<a href="#l12.154"></a><span id="l12.154">   if (!customBackgroundColor) customBackgroundColor = defaultBackgroundColor;</span>
<a href="#l12.155"></a><span id="l12.155"> </span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-  if (haveCustomColor)</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-  {</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+  if (haveCustomColor) {</span>
<a href="#l12.159"></a><span id="l12.159">     // If any colors are set, then check the &quot;Custom&quot; radio button</span>
<a href="#l12.160"></a><span id="l12.160">     gDialog.PageColorGroup.selectedItem = gDialog.CustomColorsRadio;</span>
<a href="#l12.161"></a><span id="l12.161">     UseCustomColors();</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-  }</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-  else</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-  {</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+  } else {</span>
<a href="#l12.166"></a><span id="l12.166">     gDialog.PageColorGroup.selectedItem = gDialog.DefaultColorsRadio;</span>
<a href="#l12.167"></a><span id="l12.167">     UseDefaultColors();</span>
<a href="#l12.168"></a><span id="l12.168">   }</span>
<a href="#l12.169"></a><span id="l12.169"> }</span>
<a href="#l12.170"></a><span id="l12.170"> </span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-function GetColorAndUpdate(ColorWellID)</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-{</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+function GetColorAndUpdate(ColorWellID) {</span>
<a href="#l12.174"></a><span id="l12.174">   // Only allow selecting when in custom mode</span>
<a href="#l12.175"></a><span id="l12.175">   if (!gDialog.CustomColorsRadio.selected) return;</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177">   var colorWell = document.getElementById(ColorWellID);</span>
<a href="#l12.178"></a><span id="l12.178">   if (!colorWell) return;</span>
<a href="#l12.179"></a><span id="l12.179"> </span>
<a href="#l12.180"></a><span id="l12.180">   // Don't allow a blank color, i.e., using the &quot;default&quot;</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-  var colorObj = { NoDefault:true, Type:&quot;&quot;, TextColor:0, PageColor:0, Cancel:false };</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+  var colorObj = { NoDefault: true, Type: &quot;&quot;, TextColor: 0, PageColor: 0, Cancel: false };</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-  switch( ColorWellID )</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-  {</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  switch (ColorWellID) {</span>
<a href="#l12.187"></a><span id="l12.187">     case &quot;textCW&quot;:</span>
<a href="#l12.188"></a><span id="l12.188">       colorObj.Type = &quot;Text&quot;;</span>
<a href="#l12.189"></a><span id="l12.189">       colorObj.TextColor = customTextColor;</span>
<a href="#l12.190"></a><span id="l12.190">       break;</span>
<a href="#l12.191"></a><span id="l12.191">     case &quot;linkCW&quot;:</span>
<a href="#l12.192"></a><span id="l12.192">       colorObj.Type = &quot;Link&quot;;</span>
<a href="#l12.193"></a><span id="l12.193">       colorObj.TextColor = customLinkColor;</span>
<a href="#l12.194"></a><span id="l12.194">       break;</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineat">@@ -195,18 +185,17 @@ function GetColorAndUpdate(ColorWellID)</span>
<a href="#l12.196"></a><span id="l12.196"> </span>
<a href="#l12.197"></a><span id="l12.197">   window.openDialog(&quot;chrome://editor/content/EdColorPicker.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, colorObj);</span>
<a href="#l12.198"></a><span id="l12.198"> </span>
<a href="#l12.199"></a><span id="l12.199">   // User canceled the dialog</span>
<a href="#l12.200"></a><span id="l12.200">   if (colorObj.Cancel)</span>
<a href="#l12.201"></a><span id="l12.201">     return;</span>
<a href="#l12.202"></a><span id="l12.202"> </span>
<a href="#l12.203"></a><span id="l12.203">   var color = &quot;&quot;;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-  switch( ColorWellID )</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-  {</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+  switch (ColorWellID) {</span>
<a href="#l12.207"></a><span id="l12.207">     case &quot;textCW&quot;:</span>
<a href="#l12.208"></a><span id="l12.208">       color = customTextColor = colorObj.TextColor;</span>
<a href="#l12.209"></a><span id="l12.209">       break;</span>
<a href="#l12.210"></a><span id="l12.210">     case &quot;linkCW&quot;:</span>
<a href="#l12.211"></a><span id="l12.211">       color = customLinkColor = colorObj.TextColor;</span>
<a href="#l12.212"></a><span id="l12.212">       break;</span>
<a href="#l12.213"></a><span id="l12.213">     case &quot;activeCW&quot;:</span>
<a href="#l12.214"></a><span id="l12.214">       color = customActiveColor = colorObj.TextColor;</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineat">@@ -218,207 +207,188 @@ function GetColorAndUpdate(ColorWellID)</span>
<a href="#l12.216"></a><span id="l12.216">       color = customBackgroundColor = colorObj.BackgroundColor;</span>
<a href="#l12.217"></a><span id="l12.217">       break;</span>
<a href="#l12.218"></a><span id="l12.218">   }</span>
<a href="#l12.219"></a><span id="l12.219"> </span>
<a href="#l12.220"></a><span id="l12.220">   setColorWell(ColorWellID, color);</span>
<a href="#l12.221"></a><span id="l12.221">   SetColorPreview(ColorWellID, color);</span>
<a href="#l12.222"></a><span id="l12.222"> }</span>
<a href="#l12.223"></a><span id="l12.223"> </span>
<a href="#l12.224"></a><span id="l12.224" class="difflineminus">-function SetColorPreview(ColorWellID, color)</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-{</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-  switch( ColorWellID )</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-  {</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+function SetColorPreview(ColorWellID, color) {</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+  switch (ColorWellID) {</span>
<a href="#l12.230"></a><span id="l12.230">     case &quot;textCW&quot;:</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-      gDialog.NormalText.setAttribute(styleStr,colorStyle+color);</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+      gDialog.NormalText.setAttribute(styleStr, colorStyle + color);</span>
<a href="#l12.233"></a><span id="l12.233">       break;</span>
<a href="#l12.234"></a><span id="l12.234">     case &quot;linkCW&quot;:</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-      gDialog.LinkText.setAttribute(styleStr,colorStyle+color);</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+      gDialog.LinkText.setAttribute(styleStr, colorStyle + color);</span>
<a href="#l12.237"></a><span id="l12.237">       break;</span>
<a href="#l12.238"></a><span id="l12.238">     case &quot;activeCW&quot;:</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-      gDialog.ActiveLinkText.setAttribute(styleStr,colorStyle+color);</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+      gDialog.ActiveLinkText.setAttribute(styleStr, colorStyle + color);</span>
<a href="#l12.241"></a><span id="l12.241">       break;</span>
<a href="#l12.242"></a><span id="l12.242">     case &quot;visitedCW&quot;:</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-      gDialog.VisitedLinkText.setAttribute(styleStr,colorStyle+color);</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+      gDialog.VisitedLinkText.setAttribute(styleStr, colorStyle + color);</span>
<a href="#l12.245"></a><span id="l12.245">       break;</span>
<a href="#l12.246"></a><span id="l12.246">     case &quot;backgroundCW&quot;:</span>
<a href="#l12.247"></a><span id="l12.247">       // Must combine background color and image style values</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineminus">-      var styleValue = backColorStyle+color;</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+      var styleValue = backColorStyle + color;</span>
<a href="#l12.250"></a><span id="l12.250">       if (gBackgroundImage)</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-        styleValue += &quot;;&quot;+backImageStyle+gBackgroundImage+&quot;);&quot;;</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+        styleValue += &quot;;&quot; + backImageStyle + gBackgroundImage + &quot;);&quot;;</span>
<a href="#l12.253"></a><span id="l12.253"> </span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-      gDialog.ColorPreview.setAttribute(styleStr,styleValue);</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+      gDialog.ColorPreview.setAttribute(styleStr, styleValue);</span>
<a href="#l12.256"></a><span id="l12.256">       previewBGColor = color;</span>
<a href="#l12.257"></a><span id="l12.257">       break;</span>
<a href="#l12.258"></a><span id="l12.258">   }</span>
<a href="#l12.259"></a><span id="l12.259"> }</span>
<a href="#l12.260"></a><span id="l12.260"> </span>
<a href="#l12.261"></a><span id="l12.261" class="difflineminus">-function UseCustomColors()</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineminus">-{</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+function UseCustomColors() {</span>
<a href="#l12.264"></a><span id="l12.264">   SetElementEnabledById(&quot;TextButton&quot;, true);</span>
<a href="#l12.265"></a><span id="l12.265">   SetElementEnabledById(&quot;LinkButton&quot;, true);</span>
<a href="#l12.266"></a><span id="l12.266">   SetElementEnabledById(&quot;ActiveLinkButton&quot;, true);</span>
<a href="#l12.267"></a><span id="l12.267">   SetElementEnabledById(&quot;VisitedLinkButton&quot;, true);</span>
<a href="#l12.268"></a><span id="l12.268">   SetElementEnabledById(&quot;BackgroundButton&quot;, true);</span>
<a href="#l12.269"></a><span id="l12.269">   SetElementEnabledById(&quot;Text&quot;, true);</span>
<a href="#l12.270"></a><span id="l12.270">   SetElementEnabledById(&quot;Link&quot;, true);</span>
<a href="#l12.271"></a><span id="l12.271">   SetElementEnabledById(&quot;Active&quot;, true);</span>
<a href="#l12.272"></a><span id="l12.272">   SetElementEnabledById(&quot;Visited&quot;, true);</span>
<a href="#l12.273"></a><span id="l12.273">   SetElementEnabledById(&quot;Background&quot;, true);</span>
<a href="#l12.274"></a><span id="l12.274"> </span>
<a href="#l12.275"></a><span id="l12.275" class="difflineminus">-  SetColorPreview(&quot;textCW&quot;,       customTextColor);</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineminus">-  SetColorPreview(&quot;linkCW&quot;,       customLinkColor);</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineminus">-  SetColorPreview(&quot;activeCW&quot;,     customActiveColor);</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineminus">-  SetColorPreview(&quot;visitedCW&quot;,    customVisitedColor);</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+  SetColorPreview(&quot;textCW&quot;, customTextColor);</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+  SetColorPreview(&quot;linkCW&quot;, customLinkColor);</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+  SetColorPreview(&quot;activeCW&quot;, customActiveColor);</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+  SetColorPreview(&quot;visitedCW&quot;, customVisitedColor);</span>
<a href="#l12.283"></a><span id="l12.283">   SetColorPreview(&quot;backgroundCW&quot;, customBackgroundColor);</span>
<a href="#l12.284"></a><span id="l12.284"> </span>
<a href="#l12.285"></a><span id="l12.285" class="difflineminus">-  setColorWell(&quot;textCW&quot;,          customTextColor);</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineminus">-  setColorWell(&quot;linkCW&quot;,          customLinkColor);</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineminus">-  setColorWell(&quot;activeCW&quot;,        customActiveColor);</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineminus">-  setColorWell(&quot;visitedCW&quot;,       customVisitedColor);</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineminus">-  setColorWell(&quot;backgroundCW&quot;,    customBackgroundColor);</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+  setColorWell(&quot;textCW&quot;, customTextColor);</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+  setColorWell(&quot;linkCW&quot;, customLinkColor);</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+  setColorWell(&quot;activeCW&quot;, customActiveColor);</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+  setColorWell(&quot;visitedCW&quot;, customVisitedColor);</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+  setColorWell(&quot;backgroundCW&quot;, customBackgroundColor);</span>
<a href="#l12.295"></a><span id="l12.295"> }</span>
<a href="#l12.296"></a><span id="l12.296"> </span>
<a href="#l12.297"></a><span id="l12.297" class="difflineminus">-function UseDefaultColors()</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineminus">-{</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineminus">-  SetColorPreview(&quot;textCW&quot;,       defaultTextColor);</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-  SetColorPreview(&quot;linkCW&quot;,       defaultLinkColor);</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-  SetColorPreview(&quot;activeCW&quot;,     defaultActiveColor);</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-  SetColorPreview(&quot;visitedCW&quot;,    defaultVisitedColor);</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+function UseDefaultColors() {</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+  SetColorPreview(&quot;textCW&quot;, defaultTextColor);</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+  SetColorPreview(&quot;linkCW&quot;, defaultLinkColor);</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+  SetColorPreview(&quot;activeCW&quot;, defaultActiveColor);</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+  SetColorPreview(&quot;visitedCW&quot;, defaultVisitedColor);</span>
<a href="#l12.308"></a><span id="l12.308">   SetColorPreview(&quot;backgroundCW&quot;, defaultBackgroundColor);</span>
<a href="#l12.309"></a><span id="l12.309"> </span>
<a href="#l12.310"></a><span id="l12.310">   // Setting to blank color will remove color from buttons,</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-  setColorWell(&quot;textCW&quot;,       &quot;&quot;);</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineminus">-  setColorWell(&quot;linkCW&quot;,       &quot;&quot;);</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">-  setColorWell(&quot;activeCW&quot;,     &quot;&quot;);</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-  setColorWell(&quot;visitedCW&quot;,    &quot;&quot;);</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+  setColorWell(&quot;textCW&quot;, &quot;&quot;);</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+  setColorWell(&quot;linkCW&quot;, &quot;&quot;);</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+  setColorWell(&quot;activeCW&quot;, &quot;&quot;);</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+  setColorWell(&quot;visitedCW&quot;, &quot;&quot;);</span>
<a href="#l12.319"></a><span id="l12.319">   setColorWell(&quot;backgroundCW&quot;, &quot;&quot;);</span>
<a href="#l12.320"></a><span id="l12.320"> </span>
<a href="#l12.321"></a><span id="l12.321">   // Disable color buttons and labels</span>
<a href="#l12.322"></a><span id="l12.322">   SetElementEnabledById(&quot;TextButton&quot;, false);</span>
<a href="#l12.323"></a><span id="l12.323">   SetElementEnabledById(&quot;LinkButton&quot;, false);</span>
<a href="#l12.324"></a><span id="l12.324">   SetElementEnabledById(&quot;ActiveLinkButton&quot;, false);</span>
<a href="#l12.325"></a><span id="l12.325">   SetElementEnabledById(&quot;VisitedLinkButton&quot;, false);</span>
<a href="#l12.326"></a><span id="l12.326">   SetElementEnabledById(&quot;BackgroundButton&quot;, false);</span>
<a href="#l12.327"></a><span id="l12.327">   SetElementEnabledById(&quot;Text&quot;, false);</span>
<a href="#l12.328"></a><span id="l12.328">   SetElementEnabledById(&quot;Link&quot;, false);</span>
<a href="#l12.329"></a><span id="l12.329">   SetElementEnabledById(&quot;Active&quot;, false);</span>
<a href="#l12.330"></a><span id="l12.330">   SetElementEnabledById(&quot;Visited&quot;, false);</span>
<a href="#l12.331"></a><span id="l12.331">   SetElementEnabledById(&quot;Background&quot;, false);</span>
<a href="#l12.332"></a><span id="l12.332"> }</span>
<a href="#l12.333"></a><span id="l12.333"> </span>
<a href="#l12.334"></a><span id="l12.334" class="difflineminus">-function chooseFile()</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineminus">-{</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+function chooseFile() {</span>
<a href="#l12.337"></a><span id="l12.337">   // Get a local image file, converted into URL format</span>
<a href="#l12.338"></a><span id="l12.338">   GetLocalFileURL(&quot;img&quot;).then(fileURL =&gt; {</span>
<a href="#l12.339"></a><span id="l12.339">     // Always try to relativize local file URLs</span>
<a href="#l12.340"></a><span id="l12.340">     if (gHaveDocumentUrl)</span>
<a href="#l12.341"></a><span id="l12.341">       fileURL = MakeRelativeUrl(fileURL);</span>
<a href="#l12.342"></a><span id="l12.342"> </span>
<a href="#l12.343"></a><span id="l12.343">     gDialog.BackgroundImageInput.value = fileURL;</span>
<a href="#l12.344"></a><span id="l12.344"> </span>
<a href="#l12.345"></a><span id="l12.345">     SetRelativeCheckbox();</span>
<a href="#l12.346"></a><span id="l12.346">     ValidateAndPreviewImage(true);</span>
<a href="#l12.347"></a><span id="l12.347">     SetTextboxFocus(gDialog.BackgroundImageInput);</span>
<a href="#l12.348"></a><span id="l12.348">   });</span>
<a href="#l12.349"></a><span id="l12.349"> }</span>
<a href="#l12.350"></a><span id="l12.350"> </span>
<a href="#l12.351"></a><span id="l12.351" class="difflineminus">-function ChangeBackgroundImage()</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineminus">-{</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+function ChangeBackgroundImage() {</span>
<a href="#l12.354"></a><span id="l12.354">   // Don't show error message for image while user is typing</span>
<a href="#l12.355"></a><span id="l12.355">   ValidateAndPreviewImage(false);</span>
<a href="#l12.356"></a><span id="l12.356">   SetRelativeCheckbox();</span>
<a href="#l12.357"></a><span id="l12.357"> }</span>
<a href="#l12.358"></a><span id="l12.358"> </span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-function ValidateAndPreviewImage(ShowErrorMessage)</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-{</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+function ValidateAndPreviewImage(ShowErrorMessage) {</span>
<a href="#l12.362"></a><span id="l12.362">   // First make a string with just background color</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-  var styleValue = backColorStyle+previewBGColor+&quot;;&quot;;</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+  var styleValue = backColorStyle + previewBGColor + &quot;;&quot;;</span>
<a href="#l12.365"></a><span id="l12.365"> </span>
<a href="#l12.366"></a><span id="l12.366">   var retVal = true;</span>
<a href="#l12.367"></a><span id="l12.367">   var image = TrimString(gDialog.BackgroundImageInput.value);</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineminus">-  if (image)</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-  {</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineminus">-    if (isImageDataShortened(image))</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineminus">-    {</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineplus">+  if (image) {</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineplus">+    if (isImageDataShortened(image)) {</span>
<a href="#l12.374"></a><span id="l12.374">       gBackgroundImage = restoredImageData(gDialog.BackgroundImageInput);</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineminus">-    }</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineminus">-    else</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-    {</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineplus">+    } else {</span>
<a href="#l12.379"></a><span id="l12.379">       gBackgroundImage = image;</span>
<a href="#l12.380"></a><span id="l12.380"> </span>
<a href="#l12.381"></a><span id="l12.381">       // Display must use absolute URL if possible</span>
<a href="#l12.382"></a><span id="l12.382">       var displayImage = gHaveDocumentUrl ? MakeAbsoluteUrl(image) : image;</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineminus">-      styleValue += backImageStyle+displayImage+&quot;);&quot;;</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+      styleValue += backImageStyle + displayImage + &quot;);&quot;;</span>
<a href="#l12.385"></a><span id="l12.385">     }</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineminus">-  }</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineminus">-  else</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineminus">-  {</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineplus">+  } else {</span>
<a href="#l12.390"></a><span id="l12.390">     gBackgroundImage = null;</span>
<a href="#l12.391"></a><span id="l12.391">   }</span>
<a href="#l12.392"></a><span id="l12.392"> </span>
<a href="#l12.393"></a><span id="l12.393">   // Set style on preview (removes image if not valid)</span>
<a href="#l12.394"></a><span id="l12.394">   gDialog.ColorPreview.setAttribute(styleStr, styleValue);</span>
<a href="#l12.395"></a><span id="l12.395"> </span>
<a href="#l12.396"></a><span id="l12.396">   // Note that an &quot;empty&quot; string is valid</span>
<a href="#l12.397"></a><span id="l12.397">   return retVal;</span>
<a href="#l12.398"></a><span id="l12.398"> }</span>
<a href="#l12.399"></a><span id="l12.399"> </span>
<a href="#l12.400"></a><span id="l12.400" class="difflineminus">-function ValidateData()</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineminus">-{</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+function ValidateData() {</span>
<a href="#l12.403"></a><span id="l12.403">   var editor = GetCurrentEditor();</span>
<a href="#l12.404"></a><span id="l12.404">   try {</span>
<a href="#l12.405"></a><span id="l12.405">     // Colors values are updated as they are picked, no validation necessary</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineminus">-    if (gDialog.DefaultColorsRadio.selected)</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineminus">-    {</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineplus">+    if (gDialog.DefaultColorsRadio.selected) {</span>
<a href="#l12.409"></a><span id="l12.409">       editor.removeAttributeOrEquivalent(globalElement, textStr, true);</span>
<a href="#l12.410"></a><span id="l12.410">       globalElement.removeAttribute(linkStr);</span>
<a href="#l12.411"></a><span id="l12.411">       globalElement.removeAttribute(vlinkStr);</span>
<a href="#l12.412"></a><span id="l12.412">       globalElement.removeAttribute(alinkStr);</span>
<a href="#l12.413"></a><span id="l12.413">       editor.removeAttributeOrEquivalent(globalElement, bgcolorStr, true);</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineminus">-    }</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineminus">-    else</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineminus">-    {</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineminus">-      //Do NOT accept the CSS &quot;WindowsOS&quot; color strings!</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineplus">+    } else {</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineplus">+      // Do NOT accept the CSS &quot;WindowsOS&quot; color strings!</span>
<a href="#l12.420"></a><span id="l12.420">       // Problem: We really should try to get the actual color values</span>
<a href="#l12.421"></a><span id="l12.421">       //  from windows, but I don't know how to do that!</span>
<a href="#l12.422"></a><span id="l12.422">       var tmpColor = customTextColor.toLowerCase();</span>
<a href="#l12.423"></a><span id="l12.423">       if (tmpColor != &quot;windowtext&quot;)</span>
<a href="#l12.424"></a><span id="l12.424">         editor.setAttributeOrEquivalent(globalElement, textStr,</span>
<a href="#l12.425"></a><span id="l12.425">                                         customTextColor, true);</span>
<a href="#l12.426"></a><span id="l12.426">       else</span>
<a href="#l12.427"></a><span id="l12.427">         editor.removeAttributeOrEquivalent(globalElement, textStr, true);</span>
<a href="#l12.428"></a><span id="l12.428"> </span>
<a href="#l12.429"></a><span id="l12.429">       tmpColor = customBackgroundColor.toLowerCase();</span>
<a href="#l12.430"></a><span id="l12.430">       if (tmpColor != &quot;window&quot;)</span>
<a href="#l12.431"></a><span id="l12.431">         editor.setAttributeOrEquivalent(globalElement, bgcolorStr, customBackgroundColor, true);</span>
<a href="#l12.432"></a><span id="l12.432">       else</span>
<a href="#l12.433"></a><span id="l12.433">         editor.removeAttributeOrEquivalent(globalElement, bgcolorStr, true);</span>
<a href="#l12.434"></a><span id="l12.434"> </span>
<a href="#l12.435"></a><span id="l12.435" class="difflineminus">-      globalElement.setAttribute(linkStr,    customLinkColor);</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineminus">-      globalElement.setAttribute(vlinkStr,   customVisitedColor);</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineminus">-      globalElement.setAttribute(alinkStr,   customActiveColor);</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+      globalElement.setAttribute(linkStr, customLinkColor);</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineplus">+      globalElement.setAttribute(vlinkStr, customVisitedColor);</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineplus">+      globalElement.setAttribute(alinkStr, customActiveColor);</span>
<a href="#l12.441"></a><span id="l12.441">     }</span>
<a href="#l12.442"></a><span id="l12.442"> </span>
<a href="#l12.443"></a><span id="l12.443" class="difflineminus">-    if (ValidateAndPreviewImage(true))</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineminus">-    {</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineplus">+    if (ValidateAndPreviewImage(true)) {</span>
<a href="#l12.446"></a><span id="l12.446">       // A valid image may be null for no image</span>
<a href="#l12.447"></a><span id="l12.447">       if (gBackgroundImage)</span>
<a href="#l12.448"></a><span id="l12.448">         globalElement.setAttribute(backgroundStr, gBackgroundImage);</span>
<a href="#l12.449"></a><span id="l12.449">       else</span>
<a href="#l12.450"></a><span id="l12.450">         editor.removeAttributeOrEquivalent(globalElement, backgroundStr, true);</span>
<a href="#l12.451"></a><span id="l12.451"> </span>
<a href="#l12.452"></a><span id="l12.452">       return true;</span>
<a href="#l12.453"></a><span id="l12.453">     }</span>
<a href="#l12.454"></a><span id="l12.454">   } catch (e) {}</span>
<a href="#l12.455"></a><span id="l12.455">   return false;</span>
<a href="#l12.456"></a><span id="l12.456"> }</span>
<a href="#l12.457"></a><span id="l12.457"> </span>
<a href="#l12.458"></a><span id="l12.458" class="difflineminus">-function onAccept(event)</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineminus">-{</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+function onAccept(event) {</span>
<a href="#l12.461"></a><span id="l12.461">   // If it's a file, convert to a data URL.</span>
<a href="#l12.462"></a><span id="l12.462">   if (gBackgroundImage &amp;&amp; /^file:/i.test(gBackgroundImage)) {</span>
<a href="#l12.463"></a><span id="l12.463">     let nsFile = Services.io.newURI(gBackgroundImage)</span>
<a href="#l12.464"></a><span id="l12.464">       .QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l12.465"></a><span id="l12.465">     if (nsFile.exists()) {</span>
<a href="#l12.466"></a><span id="l12.466">       let reader = new FileReader();</span>
<a href="#l12.467"></a><span id="l12.467">       reader.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l12.468"></a><span id="l12.468">         gBackgroundImage = reader.result;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdConvertToTable.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdConvertToTable.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -6,36 +6,33 @@ document.addEventListener(&quot;dialogaccept&quot;</span>
<a href="#l13.4"></a><span id="l13.4"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> var gIndex;</span>
<a href="#l13.7"></a><span id="l13.7"> var gCommaIndex = &quot;0&quot;;</span>
<a href="#l13.8"></a><span id="l13.8"> var gSpaceIndex = &quot;1&quot;;</span>
<a href="#l13.9"></a><span id="l13.9"> var gOtherIndex = &quot;2&quot;;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> // dialog initialization code</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-function Startup()</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-  if (!GetCurrentEditor())</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-  {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+function Startup() {</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+  if (!GetCurrentEditor()) {</span>
<a href="#l13.18"></a><span id="l13.18">     window.close();</span>
<a href="#l13.19"></a><span id="l13.19">     return;</span>
<a href="#l13.20"></a><span id="l13.20">   }</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">   gDialog.sepRadioGroup      = document.getElementById(&quot;SepRadioGroup&quot;);</span>
<a href="#l13.23"></a><span id="l13.23">   gDialog.sepCharacterInput  = document.getElementById(&quot;SepCharacterInput&quot;);</span>
<a href="#l13.24"></a><span id="l13.24">   gDialog.deleteSepCharacter = document.getElementById(&quot;DeleteSepCharacter&quot;);</span>
<a href="#l13.25"></a><span id="l13.25">   gDialog.collapseSpaces     = document.getElementById(&quot;CollapseSpaces&quot;);</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27">   // We persist the user's separator character</span>
<a href="#l13.28"></a><span id="l13.28">   gDialog.sepCharacterInput.value = gDialog.sepRadioGroup.getAttribute(&quot;character&quot;);</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">   gIndex = gDialog.sepRadioGroup.getAttribute(&quot;index&quot;);</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  switch (gIndex)</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  {</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  switch (gIndex) {</span>
<a href="#l13.35"></a><span id="l13.35">     case gCommaIndex:</span>
<a href="#l13.36"></a><span id="l13.36">     default:</span>
<a href="#l13.37"></a><span id="l13.37">       gDialog.sepRadioGroup.selectedItem = document.getElementById(&quot;comma&quot;);</span>
<a href="#l13.38"></a><span id="l13.38">       break;</span>
<a href="#l13.39"></a><span id="l13.39">     case gSpaceIndex:</span>
<a href="#l13.40"></a><span id="l13.40">       gDialog.sepRadioGroup.selectedItem = document.getElementById(&quot;space&quot;);</span>
<a href="#l13.41"></a><span id="l13.41">       break;</span>
<a href="#l13.42"></a><span id="l13.42">     case gOtherIndex:</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineat">@@ -44,61 +41,56 @@ function Startup()</span>
<a href="#l13.44"></a><span id="l13.44">   }</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46">   // Set initial enable state on character input and &quot;collapse&quot; checkbox</span>
<a href="#l13.47"></a><span id="l13.47">   SelectCharacter(gIndex);</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49">   SetWindowLocation();</span>
<a href="#l13.50"></a><span id="l13.50"> }</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-function InputSepCharacter()</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-{</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+function InputSepCharacter() {</span>
<a href="#l13.55"></a><span id="l13.55">   var str = gDialog.sepCharacterInput.value;</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57">   // Limit input to 1 character</span>
<a href="#l13.58"></a><span id="l13.58">   if (str.length &gt; 1)</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-    str = str.slice(0,1);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    str = str.slice(0, 1);</span>
<a href="#l13.61"></a><span id="l13.61"> </span>
<a href="#l13.62"></a><span id="l13.62">   // We can never allow tag or entity delimiters for separator character</span>
<a href="#l13.63"></a><span id="l13.63">   if (str == &quot;&lt;&quot; || str == &quot;&gt;&quot; || str == &quot;&amp;&quot; || str == &quot;;&quot; || str == &quot; &quot;)</span>
<a href="#l13.64"></a><span id="l13.64">     str = &quot;&quot;;</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">   gDialog.sepCharacterInput.value = str;</span>
<a href="#l13.67"></a><span id="l13.67"> }</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-function SelectCharacter(radioGroupIndex)</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-{</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+function SelectCharacter(radioGroupIndex) {</span>
<a href="#l13.72"></a><span id="l13.72">   gIndex = radioGroupIndex;</span>
<a href="#l13.73"></a><span id="l13.73">   SetElementEnabledById(&quot;SepCharacterInput&quot;, gIndex == gOtherIndex);</span>
<a href="#l13.74"></a><span id="l13.74">   SetElementEnabledById(&quot;CollapseSpaces&quot;, gIndex == gSpaceIndex);</span>
<a href="#l13.75"></a><span id="l13.75"> }</span>
<a href="#l13.76"></a><span id="l13.76"> </span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-function onAccept()</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-{</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+function onAccept() {</span>
<a href="#l13.80"></a><span id="l13.80">   var sepCharacter = &quot;&quot;;</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-  switch (gIndex)</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-  {</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  switch (gIndex) {</span>
<a href="#l13.84"></a><span id="l13.84">     case gCommaIndex:</span>
<a href="#l13.85"></a><span id="l13.85">       sepCharacter = &quot;,&quot;;</span>
<a href="#l13.86"></a><span id="l13.86">       break;</span>
<a href="#l13.87"></a><span id="l13.87">     case gSpaceIndex:</span>
<a href="#l13.88"></a><span id="l13.88">       sepCharacter = &quot; &quot;;</span>
<a href="#l13.89"></a><span id="l13.89">       break;</span>
<a href="#l13.90"></a><span id="l13.90">     case gOtherIndex:</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-      sepCharacter = gDialog.sepCharacterInput.value.slice(0,1);</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+      sepCharacter = gDialog.sepCharacterInput.value.slice(0, 1);</span>
<a href="#l13.93"></a><span id="l13.93">       break;</span>
<a href="#l13.94"></a><span id="l13.94">   }</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96">   var editor = GetCurrentEditor();</span>
<a href="#l13.97"></a><span id="l13.97">   var str;</span>
<a href="#l13.98"></a><span id="l13.98">   try {</span>
<a href="#l13.99"></a><span id="l13.99">     str = editor.outputToString(&quot;text/html&quot;, kOutputLFLineBreak | kOutputSelectionOnly);</span>
<a href="#l13.100"></a><span id="l13.100">   } catch (e) {}</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-  if (!str)</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-  {</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+  if (!str) {</span>
<a href="#l13.104"></a><span id="l13.104">     SaveWindowLocation();</span>
<a href="#l13.105"></a><span id="l13.105">     return;</span>
<a href="#l13.106"></a><span id="l13.106">   }</span>
<a href="#l13.107"></a><span id="l13.107"> </span>
<a href="#l13.108"></a><span id="l13.108">   // Replace nbsp with spaces:</span>
<a href="#l13.109"></a><span id="l13.109">   str = str.replace(/\u00a0/g, &quot; &quot;);</span>
<a href="#l13.110"></a><span id="l13.110"> </span>
<a href="#l13.111"></a><span id="l13.111">   // Strip out &lt;/p&gt; completely</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineat">@@ -112,17 +104,17 @@ function onAccept()</span>
<a href="#l13.113"></a><span id="l13.113">   // Trim leading &lt;br&gt;s</span>
<a href="#l13.114"></a><span id="l13.114">   str = str.replace(/^(&lt;br&gt;)+/, &quot;&quot;);</span>
<a href="#l13.115"></a><span id="l13.115"> </span>
<a href="#l13.116"></a><span id="l13.116">   // Trim trailing &lt;br&gt;s</span>
<a href="#l13.117"></a><span id="l13.117">   str = str.replace(/(&lt;br&gt;)+$/, &quot;&quot;);</span>
<a href="#l13.118"></a><span id="l13.118"> </span>
<a href="#l13.119"></a><span id="l13.119">   // Reduce multiple internal &lt;br&gt; to just 1</span>
<a href="#l13.120"></a><span id="l13.120">   // TODO: Maybe add a checkbox to let user decide</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  //str = str.replace(/(&lt;br&gt;)+/g, &quot;&lt;br&gt;&quot;);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+  // str = str.replace(/(&lt;br&gt;)+/g, &quot;&lt;br&gt;&quot;);</span>
<a href="#l13.123"></a><span id="l13.123"> </span>
<a href="#l13.124"></a><span id="l13.124">   // Trim leading and trailing spaces</span>
<a href="#l13.125"></a><span id="l13.125">   str = str.trim();</span>
<a href="#l13.126"></a><span id="l13.126"> </span>
<a href="#l13.127"></a><span id="l13.127">   // Remove all tag contents so we don't replace</span>
<a href="#l13.128"></a><span id="l13.128">   //   separator character within tags</span>
<a href="#l13.129"></a><span id="l13.129">   // Also converts lists to something useful</span>
<a href="#l13.130"></a><span id="l13.130">   var stack = [];</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineat">@@ -131,120 +123,103 @@ function onAccept()</span>
<a href="#l13.132"></a><span id="l13.132">   var searchStart = 0;</span>
<a href="#l13.133"></a><span id="l13.133">   var listSeparator = &quot;&quot;;</span>
<a href="#l13.134"></a><span id="l13.134">   var listItemSeparator = &quot;&quot;;</span>
<a href="#l13.135"></a><span id="l13.135">   var endList = false;</span>
<a href="#l13.136"></a><span id="l13.136"> </span>
<a href="#l13.137"></a><span id="l13.137">   do {</span>
<a href="#l13.138"></a><span id="l13.138">     start = str.indexOf(&quot;&lt;&quot;, searchStart);</span>
<a href="#l13.139"></a><span id="l13.139"> </span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-    if (start &gt;= 0)</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-    {</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-      end = str.indexOf(&quot;&gt;&quot;, start+1);</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-      if (end &gt; start)</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-      {</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+    if (start &gt;= 0) {</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+      end = str.indexOf(&quot;&gt;&quot;, start + 1);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+      if (end &gt; start) {</span>
<a href="#l13.148"></a><span id="l13.148">         let tagContent = str.slice(start + 1, end).trim();</span>
<a href="#l13.149"></a><span id="l13.149"> </span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-        if (/^ol|^ul|^dl/.test(tagContent))</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-        {</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+        if (/^ol|^ul|^dl/.test(tagContent)) {</span>
<a href="#l13.153"></a><span id="l13.153">           //  Replace list tag with &lt;BR&gt; to start new row</span>
<a href="#l13.154"></a><span id="l13.154">           //   at beginning of second or greater list tag</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-          str = str.slice(0, start) + listSeparator + str.slice(end+1);</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+          str = str.slice(0, start) + listSeparator + str.slice(end + 1);</span>
<a href="#l13.157"></a><span id="l13.157">           if (listSeparator == &quot;&quot;)</span>
<a href="#l13.158"></a><span id="l13.158">             listSeparator = &quot;&lt;br&gt;&quot;;</span>
<a href="#l13.159"></a><span id="l13.159"> </span>
<a href="#l13.160"></a><span id="l13.160">           // Reset for list item separation into cells</span>
<a href="#l13.161"></a><span id="l13.161">           listItemSeparator = &quot;&quot;;</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-        }</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-        else if (/^li|^dt|^dd/.test(tagContent))</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-        {</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+        } else if (/^li|^dt|^dd/.test(tagContent)) {</span>
<a href="#l13.166"></a><span id="l13.166">           // Start a new row if this is first item after the ending the last list</span>
<a href="#l13.167"></a><span id="l13.167">           if (endList)</span>
<a href="#l13.168"></a><span id="l13.168">             listItemSeparator = &quot;&lt;br&gt;&quot;;</span>
<a href="#l13.169"></a><span id="l13.169"> </span>
<a href="#l13.170"></a><span id="l13.170">           // Start new cell at beginning of second or greater list items</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-          str = str.slice(0, start) + listItemSeparator + str.slice(end+1);</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+          str = str.slice(0, start) + listItemSeparator + str.slice(end + 1);</span>
<a href="#l13.173"></a><span id="l13.173"> </span>
<a href="#l13.174"></a><span id="l13.174">           if (endList || listItemSeparator == &quot;&quot;)</span>
<a href="#l13.175"></a><span id="l13.175">             listItemSeparator = sepCharacter;</span>
<a href="#l13.176"></a><span id="l13.176"> </span>
<a href="#l13.177"></a><span id="l13.177">           endList = false;</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-        }</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-        else</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-        {</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+        } else {</span>
<a href="#l13.182"></a><span id="l13.182">           // Find end tags</span>
<a href="#l13.183"></a><span id="l13.183">           endList = /^\/ol|^\/ul|^\/dl/.test(tagContent);</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-          if (endList || /^\/li|^\/dt|^\/dd/.test(tagContent))</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-          {</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+          if (endList || /^\/li|^\/dt|^\/dd/.test(tagContent)) {</span>
<a href="#l13.187"></a><span id="l13.187">             // Strip out tag</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineminus">-            str = str.slice(0, start) + str.slice(end+1);</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-          }</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-          else</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-          {</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+            str = str.slice(0, start) + str.slice(end + 1);</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+          } else {</span>
<a href="#l13.194"></a><span id="l13.194">             // Not a list-related tag: Store tag contents in an array</span>
<a href="#l13.195"></a><span id="l13.195">             stack.push(tagContent);</span>
<a href="#l13.196"></a><span id="l13.196"> </span>
<a href="#l13.197"></a><span id="l13.197">             // Keep the &quot;&lt;&quot; and &quot;&gt;&quot; while removing from source string</span>
<a href="#l13.198"></a><span id="l13.198">             start++;</span>
<a href="#l13.199"></a><span id="l13.199">             str = str.slice(0, start) + str.slice(end);</span>
<a href="#l13.200"></a><span id="l13.200">           }</span>
<a href="#l13.201"></a><span id="l13.201">         }</span>
<a href="#l13.202"></a><span id="l13.202">       }</span>
<a href="#l13.203"></a><span id="l13.203">       searchStart = start + 1;</span>
<a href="#l13.204"></a><span id="l13.204">     }</span>
<a href="#l13.205"></a><span id="l13.205">   } while (start &gt;= 0);</span>
<a href="#l13.206"></a><span id="l13.206"> </span>
<a href="#l13.207"></a><span id="l13.207">   // Replace separator characters with table cells</span>
<a href="#l13.208"></a><span id="l13.208">   var replaceString;</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-  if (gDialog.deleteSepCharacter.checked)</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-  {</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+  if (gDialog.deleteSepCharacter.checked) {</span>
<a href="#l13.212"></a><span id="l13.212">     replaceString = &quot;&quot;;</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-  }</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">-  else</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-  {</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+  } else {</span>
<a href="#l13.217"></a><span id="l13.217">     // Don't delete separator character,</span>
<a href="#l13.218"></a><span id="l13.218">     //  so include it at start of string to replace</span>
<a href="#l13.219"></a><span id="l13.219">     replaceString = sepCharacter;</span>
<a href="#l13.220"></a><span id="l13.220">   }</span>
<a href="#l13.221"></a><span id="l13.221"> </span>
<a href="#l13.222"></a><span id="l13.222">   replaceString += &quot;&lt;td&gt;&quot;;</span>
<a href="#l13.223"></a><span id="l13.223"> </span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-  if (sepCharacter.length &gt; 0)</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-  {</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+  if (sepCharacter.length &gt; 0) {</span>
<a href="#l13.227"></a><span id="l13.227">     var tempStr = sepCharacter;</span>
<a href="#l13.228"></a><span id="l13.228">     var regExpChars = &quot;.!@#$%^&amp;*-+[]{}()\|\\\/&quot;;</span>
<a href="#l13.229"></a><span id="l13.229">     if (regExpChars.includes(sepCharacter))</span>
<a href="#l13.230"></a><span id="l13.230">       tempStr = &quot;\\&quot; + sepCharacter;</span>
<a href="#l13.231"></a><span id="l13.231"> </span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-    if (gIndex == gSpaceIndex)</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-    {</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+    if (gIndex == gSpaceIndex) {</span>
<a href="#l13.235"></a><span id="l13.235">       // If checkbox is checked,</span>
<a href="#l13.236"></a><span id="l13.236">       //   one or more adjacent spaces are one separator</span>
<a href="#l13.237"></a><span id="l13.237">       if (gDialog.collapseSpaces.checked)</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-          tempStr = &quot;\\s+&quot;</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+          tempStr = &quot;\\s+&quot;;</span>
<a href="#l13.240"></a><span id="l13.240">         else</span>
<a href="#l13.241"></a><span id="l13.241">           tempStr = &quot;\\s&quot;;</span>
<a href="#l13.242"></a><span id="l13.242">     }</span>
<a href="#l13.243"></a><span id="l13.243">     var pattern = new RegExp(tempStr, &quot;g&quot;);</span>
<a href="#l13.244"></a><span id="l13.244">     str = str.replace(pattern, replaceString);</span>
<a href="#l13.245"></a><span id="l13.245">   }</span>
<a href="#l13.246"></a><span id="l13.246"> </span>
<a href="#l13.247"></a><span id="l13.247">   // Put back tag contents that we removed above</span>
<a href="#l13.248"></a><span id="l13.248">   searchStart = 0;</span>
<a href="#l13.249"></a><span id="l13.249">   var stackIndex = 0;</span>
<a href="#l13.250"></a><span id="l13.250">   do {</span>
<a href="#l13.251"></a><span id="l13.251">     start = str.indexOf(&quot;&lt;&quot;, searchStart);</span>
<a href="#l13.252"></a><span id="l13.252">     end = start + 1;</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-    if (start &gt;= 0 &amp;&amp; str.charAt(end) == &quot;&gt;&quot;)</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-    {</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+    if (start &gt;= 0 &amp;&amp; str.charAt(end) == &quot;&gt;&quot;) {</span>
<a href="#l13.256"></a><span id="l13.256">       // We really need a FIFO stack!</span>
<a href="#l13.257"></a><span id="l13.257">       str = str.slice(0, end) + stack[stackIndex++] + str.slice(end);</span>
<a href="#l13.258"></a><span id="l13.258">     }</span>
<a href="#l13.259"></a><span id="l13.259">     searchStart = end;</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-</span>
<a href="#l13.261"></a><span id="l13.261">   } while (start &gt;= 0);</span>
<a href="#l13.262"></a><span id="l13.262"> </span>
<a href="#l13.263"></a><span id="l13.263">   // End table row and start another for each br or p</span>
<a href="#l13.264"></a><span id="l13.264">   str = str.replace(/\s*&lt;br&gt;\s*/g, &quot;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;&quot;);</span>
<a href="#l13.265"></a><span id="l13.265"> </span>
<a href="#l13.266"></a><span id="l13.266">   // Add the table tags and the opening and closing tr/td tags</span>
<a href="#l13.267"></a><span id="l13.267">   // Default table attributes should be same as those used in nsHTMLEditor::CreateElementWithDefaults()</span>
<a href="#l13.268"></a><span id="l13.268">   // (Default width=&quot;100%&quot; is used in EdInsertTable.js)</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineat">@@ -255,70 +230,62 @@ function onAccept()</span>
<a href="#l13.270"></a><span id="l13.270">   // Delete the selection -- makes it easier to find where table will insert</span>
<a href="#l13.271"></a><span id="l13.271">   var nodeBeforeTable = null;</span>
<a href="#l13.272"></a><span id="l13.272">   var nodeAfterTable = null;</span>
<a href="#l13.273"></a><span id="l13.273">   try {</span>
<a href="#l13.274"></a><span id="l13.274">     editor.deleteSelection(editor.eNone, editor.eStrip);</span>
<a href="#l13.275"></a><span id="l13.275"> </span>
<a href="#l13.276"></a><span id="l13.276">     var anchorNodeBeforeInsert = editor.selection.anchorNode;</span>
<a href="#l13.277"></a><span id="l13.277">     var offset = editor.selection.anchorOffset;</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-    if (anchorNodeBeforeInsert.nodeType == Node.TEXT_NODE)</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-    {</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+    if (anchorNodeBeforeInsert.nodeType == Node.TEXT_NODE) {</span>
<a href="#l13.281"></a><span id="l13.281">       // Text was split. Table should be right after the first or before</span>
<a href="#l13.282"></a><span id="l13.282">       nodeBeforeTable = anchorNodeBeforeInsert.previousSibling;</span>
<a href="#l13.283"></a><span id="l13.283">       nodeAfterTable = anchorNodeBeforeInsert;</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-    }</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineminus">-    else</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-    {</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+    } else {</span>
<a href="#l13.288"></a><span id="l13.288">       // Table should be inserted right after node pointed to by selection</span>
<a href="#l13.289"></a><span id="l13.289">       if (offset &gt; 0)</span>
<a href="#l13.290"></a><span id="l13.290">         nodeBeforeTable = anchorNodeBeforeInsert.childNodes.item(offset - 1);</span>
<a href="#l13.291"></a><span id="l13.291"> </span>
<a href="#l13.292"></a><span id="l13.292">       nodeAfterTable = anchorNodeBeforeInsert.childNodes.item(offset);</span>
<a href="#l13.293"></a><span id="l13.293">     }</span>
<a href="#l13.294"></a><span id="l13.294"> </span>
<a href="#l13.295"></a><span id="l13.295">     editor.insertHTML(str);</span>
<a href="#l13.296"></a><span id="l13.296">   } catch (e) {}</span>
<a href="#l13.297"></a><span id="l13.297"> </span>
<a href="#l13.298"></a><span id="l13.298">   var table = null;</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-  if (nodeAfterTable)</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-  {</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+  if (nodeAfterTable) {</span>
<a href="#l13.302"></a><span id="l13.302">     var previous = nodeAfterTable.previousSibling;</span>
<a href="#l13.303"></a><span id="l13.303">     if (previous &amp;&amp; previous.nodeName.toLowerCase() == &quot;table&quot;)</span>
<a href="#l13.304"></a><span id="l13.304">       table = previous;</span>
<a href="#l13.305"></a><span id="l13.305">   }</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-  if (!table &amp;&amp; nodeBeforeTable)</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-  {</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+  if (!table &amp;&amp; nodeBeforeTable) {</span>
<a href="#l13.309"></a><span id="l13.309">     var next = nodeBeforeTable.nextSibling;</span>
<a href="#l13.310"></a><span id="l13.310">     if (next &amp;&amp; next.nodeName.toLowerCase() == &quot;table&quot;)</span>
<a href="#l13.311"></a><span id="l13.311">       table = next;</span>
<a href="#l13.312"></a><span id="l13.312">   }</span>
<a href="#l13.313"></a><span id="l13.313"> </span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-  if (table)</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-  {</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+  if (table) {</span>
<a href="#l13.317"></a><span id="l13.317">     // Fixup table only if pref is set</span>
<a href="#l13.318"></a><span id="l13.318">     var firstRow;</span>
<a href="#l13.319"></a><span id="l13.319">     try {</span>
<a href="#l13.320"></a><span id="l13.320">       if (Services.prefs.getBoolPref(&quot;editor.table.maintain_structure&quot;))</span>
<a href="#l13.321"></a><span id="l13.321">         editor.normalizeTable(table);</span>
<a href="#l13.322"></a><span id="l13.322"> </span>
<a href="#l13.323"></a><span id="l13.323">       firstRow = editor.getFirstRow(table);</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-    } catch(e) {}</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+    } catch (e) {}</span>
<a href="#l13.326"></a><span id="l13.326"> </span>
<a href="#l13.327"></a><span id="l13.327">     // Put caret in first cell</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-    if (firstRow)</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-    {</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+    if (firstRow) {</span>
<a href="#l13.331"></a><span id="l13.331">       var node2 = firstRow.firstChild;</span>
<a href="#l13.332"></a><span id="l13.332">       do {</span>
<a href="#l13.333"></a><span id="l13.333">         if (node2.nodeName.toLowerCase() == &quot;td&quot; ||</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-            node2.nodeName.toLowerCase() == &quot;th&quot;)</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-        {</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+            node2.nodeName.toLowerCase() == &quot;th&quot;) {</span>
<a href="#l13.337"></a><span id="l13.337">           try {</span>
<a href="#l13.338"></a><span id="l13.338">             editor.selection.collapse(node2, 0);</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineminus">-          } catch(e) {}</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+          } catch (e) {}</span>
<a href="#l13.341"></a><span id="l13.341">           break;</span>
<a href="#l13.342"></a><span id="l13.342">         }</span>
<a href="#l13.343"></a><span id="l13.343">         node2 = node.nextSibling;</span>
<a href="#l13.344"></a><span id="l13.344">       } while (node2);</span>
<a href="#l13.345"></a><span id="l13.345">     }</span>
<a href="#l13.346"></a><span id="l13.346">   }</span>
<a href="#l13.347"></a><span id="l13.347"> </span>
<a href="#l13.348"></a><span id="l13.348">   editor.endTransaction();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdDialogCommon.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdDialogCommon.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -47,65 +47,58 @@ var globalElement;</span>
<a href="#l14.4"></a><span id="l14.4">  *    If error, we also:</span>
<a href="#l14.5"></a><span id="l14.5">  *      Shift focus and select contents of the inputWidget,</span>
<a href="#l14.6"></a><span id="l14.6">  *      Switch to appropriate panel of tabbed dialog if user implements &quot;SwitchToValidate()&quot;,</span>
<a href="#l14.7"></a><span id="l14.7">  *      and/or will expand the dialog to full size if &quot;More / Fewer&quot; feature is implemented</span>
<a href="#l14.8"></a><span id="l14.8">  *</span>
<a href="#l14.9"></a><span id="l14.9">  *  Returns the &quot;value&quot; as a string, or &quot;&quot; if error or input contents are empty</span>
<a href="#l14.10"></a><span id="l14.10">  *  The global &quot;gValidationError&quot; variable is set true if error was found</span>
<a href="#l14.11"></a><span id="l14.11">  */</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-function ValidateNumber(inputWidget, listWidget, minVal, maxVal, element, attName, mustHaveValue, mustShowMoreSection)</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-  if (!inputWidget)</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-  {</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+function ValidateNumber(inputWidget, listWidget, minVal, maxVal, element, attName, mustHaveValue, mustShowMoreSection) {</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+  if (!inputWidget) {</span>
<a href="#l14.18"></a><span id="l14.18">     gValidationError = true;</span>
<a href="#l14.19"></a><span id="l14.19">     return &quot;&quot;;</span>
<a href="#l14.20"></a><span id="l14.20">   }</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22">   // Global error return value</span>
<a href="#l14.23"></a><span id="l14.23">   gValidationError = false;</span>
<a href="#l14.24"></a><span id="l14.24">   var maxLimit = maxVal;</span>
<a href="#l14.25"></a><span id="l14.25">   var isPercent = false;</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   var numString = TrimString(inputWidget.value);</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  if (numString || mustHaveValue)</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-  {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+  if (numString || mustHaveValue) {</span>
<a href="#l14.31"></a><span id="l14.31">     if (listWidget)</span>
<a href="#l14.32"></a><span id="l14.32">       isPercent = (listWidget.selectedIndex == 1);</span>
<a href="#l14.33"></a><span id="l14.33">     if (isPercent)</span>
<a href="#l14.34"></a><span id="l14.34">       maxLimit = 100;</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36">     // This method puts up the error message</span>
<a href="#l14.37"></a><span id="l14.37">     numString = ValidateNumberRange(numString, minVal, maxLimit, mustHaveValue);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-    if(!numString)</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-    {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+    if (!numString) {</span>
<a href="#l14.41"></a><span id="l14.41">       // Switch to appropriate panel for error reporting</span>
<a href="#l14.42"></a><span id="l14.42">       SwitchToValidatePanel();</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44">       // or expand dialog for users of &quot;More / Fewer&quot; button</span>
<a href="#l14.45"></a><span id="l14.45">       if (&quot;dialog&quot; in window &amp;&amp; dialog &amp;&amp;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-           &quot;MoreSection&quot; in gDialog &amp;&amp; gDialog.MoreSection)</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-      {</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-        if ( !SeeMore )</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+           &quot;MoreSection&quot; in gDialog &amp;&amp; gDialog.MoreSection) {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+        if (!SeeMore)</span>
<a href="#l14.51"></a><span id="l14.51">           onMoreFewer();</span>
<a href="#l14.52"></a><span id="l14.52">       }</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54">       // Error - shift to offending input widget</span>
<a href="#l14.55"></a><span id="l14.55">       SetTextboxFocus(inputWidget);</span>
<a href="#l14.56"></a><span id="l14.56">       gValidationError = true;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-    }</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-    else</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-    {</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+    } else {</span>
<a href="#l14.61"></a><span id="l14.61">       if (isPercent)</span>
<a href="#l14.62"></a><span id="l14.62">         numString += &quot;%&quot;;</span>
<a href="#l14.63"></a><span id="l14.63">       if (element)</span>
<a href="#l14.64"></a><span id="l14.64">         GetCurrentEditor().setAttributeOrEquivalent(element, attName, numString, true);</span>
<a href="#l14.65"></a><span id="l14.65">     }</span>
<a href="#l14.66"></a><span id="l14.66">   } else if (element) {</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-    GetCurrentEditor().removeAttributeOrEquivalent(element, attName, true)</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    GetCurrentEditor().removeAttributeOrEquivalent(element, attName, true);</span>
<a href="#l14.69"></a><span id="l14.69">   }</span>
<a href="#l14.70"></a><span id="l14.70">   return numString;</span>
<a href="#l14.71"></a><span id="l14.71"> }</span>
<a href="#l14.72"></a><span id="l14.72"> </span>
<a href="#l14.73"></a><span id="l14.73"> /* Validate contents of an input field</span>
<a href="#l14.74"></a><span id="l14.74">  *</span>
<a href="#l14.75"></a><span id="l14.75">  *  value          number to validate</span>
<a href="#l14.76"></a><span id="l14.76">  *  minVal         minimum allowed for input widget's value</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineat">@@ -116,311 +109,269 @@ function ValidateNumber(inputWidget, lis</span>
<a href="#l14.78"></a><span id="l14.78">  *</span>
<a href="#l14.79"></a><span id="l14.79">  *  If inputWidget's value is outside of range, or is empty when &quot;mustHaveValue&quot; = true,</span>
<a href="#l14.80"></a><span id="l14.80">  *      an error dialog is popuped up to inform the user. The focus is shifted</span>
<a href="#l14.81"></a><span id="l14.81">  *      to the inputWidget.</span>
<a href="#l14.82"></a><span id="l14.82">  *</span>
<a href="#l14.83"></a><span id="l14.83">  *  Returns the &quot;value&quot; as a string, or &quot;&quot; if error or input contents are empty</span>
<a href="#l14.84"></a><span id="l14.84">  *  The global &quot;gValidationError&quot; variable is set true if error was found</span>
<a href="#l14.85"></a><span id="l14.85">  */</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-function ValidateNumberRange(value, minValue, maxValue, mustHaveValue)</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-{</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+function ValidateNumberRange(value, minValue, maxValue, mustHaveValue) {</span>
<a href="#l14.89"></a><span id="l14.89">   // Initialize global error flag</span>
<a href="#l14.90"></a><span id="l14.90">   gValidationError = false;</span>
<a href="#l14.91"></a><span id="l14.91">   value = TrimString(String(value));</span>
<a href="#l14.92"></a><span id="l14.92"> </span>
<a href="#l14.93"></a><span id="l14.93">   // We don't show error for empty string unless caller wants to</span>
<a href="#l14.94"></a><span id="l14.94">   if (!value &amp;&amp; !mustHaveValue)</span>
<a href="#l14.95"></a><span id="l14.95">     return &quot;&quot;;</span>
<a href="#l14.96"></a><span id="l14.96"> </span>
<a href="#l14.97"></a><span id="l14.97">   var numberStr = &quot;&quot;;</span>
<a href="#l14.98"></a><span id="l14.98"> </span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-  if (value.length &gt; 0)</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-  {</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+  if (value.length &gt; 0) {</span>
<a href="#l14.102"></a><span id="l14.102">     // Extract just numeric characters</span>
<a href="#l14.103"></a><span id="l14.103">     var number = Number(value.replace(/\D+/g, &quot;&quot;));</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-    if (number &gt;= minValue &amp;&amp; number &lt;= maxValue )</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-    {</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+    if (number &gt;= minValue &amp;&amp; number &lt;= maxValue) {</span>
<a href="#l14.107"></a><span id="l14.107">       // Return string version of the number</span>
<a href="#l14.108"></a><span id="l14.108">       return String(number);</span>
<a href="#l14.109"></a><span id="l14.109">     }</span>
<a href="#l14.110"></a><span id="l14.110">     numberStr = String(number);</span>
<a href="#l14.111"></a><span id="l14.111">   }</span>
<a href="#l14.112"></a><span id="l14.112"> </span>
<a href="#l14.113"></a><span id="l14.113">   var message = &quot;&quot;;</span>
<a href="#l14.114"></a><span id="l14.114"> </span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-  if (numberStr.length &gt; 0)</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-  {</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  if (numberStr.length &gt; 0) {</span>
<a href="#l14.118"></a><span id="l14.118">     // We have a number from user outside of allowed range</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-    message = GetString( &quot;ValidateRangeMsg&quot;);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+    message = GetString(&quot;ValidateRangeMsg&quot;);</span>
<a href="#l14.121"></a><span id="l14.121">     message = message.replace(/%n%/, numberStr);</span>
<a href="#l14.122"></a><span id="l14.122">     message += &quot;\n &quot;;</span>
<a href="#l14.123"></a><span id="l14.123">   }</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  message += GetString( &quot;ValidateNumberMsg&quot;);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+  message += GetString(&quot;ValidateNumberMsg&quot;);</span>
<a href="#l14.126"></a><span id="l14.126"> </span>
<a href="#l14.127"></a><span id="l14.127">   // Replace variable placeholders in message with number values</span>
<a href="#l14.128"></a><span id="l14.128">   message = message.replace(/%min%/, minValue).replace(/%max%/, maxValue);</span>
<a href="#l14.129"></a><span id="l14.129">   ShowInputErrorMessage(message);</span>
<a href="#l14.130"></a><span id="l14.130"> </span>
<a href="#l14.131"></a><span id="l14.131">   // Return an empty string to indicate error</span>
<a href="#l14.132"></a><span id="l14.132">   gValidationError = true;</span>
<a href="#l14.133"></a><span id="l14.133">   return &quot;&quot;;</span>
<a href="#l14.134"></a><span id="l14.134"> }</span>
<a href="#l14.135"></a><span id="l14.135"> </span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-function SetTextboxFocusById(id)</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-{</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+function SetTextboxFocusById(id) {</span>
<a href="#l14.139"></a><span id="l14.139">   SetTextboxFocus(document.getElementById(id));</span>
<a href="#l14.140"></a><span id="l14.140"> }</span>
<a href="#l14.141"></a><span id="l14.141"> </span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-function SetTextboxFocus(textbox)</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-{</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-  if (textbox)</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-  {</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-    //XXX Using the setTimeout is hacky workaround for bug 103197</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+function SetTextboxFocus(textbox) {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+  if (textbox) {</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+    // XXX Using the setTimeout is hacky workaround for bug 103197</span>
<a href="#l14.150"></a><span id="l14.150">     // Must create a new function to keep &quot;textbox&quot; in scope</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-    setTimeout( function(textbox) { textbox.focus(); textbox.select(); }, 0, textbox );</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+    setTimeout(function(textbox) { textbox.focus(); textbox.select(); }, 0, textbox);</span>
<a href="#l14.153"></a><span id="l14.153">   }</span>
<a href="#l14.154"></a><span id="l14.154"> }</span>
<a href="#l14.155"></a><span id="l14.155"> </span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-function ShowInputErrorMessage(message)</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-{</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+function ShowInputErrorMessage(message) {</span>
<a href="#l14.159"></a><span id="l14.159">   Services.prompt.alert(window, GetString(&quot;InputError&quot;), message);</span>
<a href="#l14.160"></a><span id="l14.160">   window.focus();</span>
<a href="#l14.161"></a><span id="l14.161"> }</span>
<a href="#l14.162"></a><span id="l14.162"> </span>
<a href="#l14.163"></a><span id="l14.163"> // Get the text appropriate to parent container</span>
<a href="#l14.164"></a><span id="l14.164"> //  to determine what a &quot;%&quot; value is referring to.</span>
<a href="#l14.165"></a><span id="l14.165"> // elementForAtt is element we are actually setting attributes on</span>
<a href="#l14.166"></a><span id="l14.166"> //  (a temporary copy of element in the doc to allow canceling),</span>
<a href="#l14.167"></a><span id="l14.167"> //  but elementInDoc is needed to find parent context in document</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-function GetAppropriatePercentString(elementForAtt, elementInDoc)</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-{</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+function GetAppropriatePercentString(elementForAtt, elementInDoc) {</span>
<a href="#l14.171"></a><span id="l14.171">   var editor = GetCurrentEditor();</span>
<a href="#l14.172"></a><span id="l14.172">   try {</span>
<a href="#l14.173"></a><span id="l14.173">     var name = elementForAtt.nodeName.toLowerCase();</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-    if ( name == &quot;td&quot; || name == &quot;th&quot;)</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+    if (name == &quot;td&quot; || name == &quot;th&quot;)</span>
<a href="#l14.176"></a><span id="l14.176">       return GetString(&quot;PercentOfTable&quot;);</span>
<a href="#l14.177"></a><span id="l14.177"> </span>
<a href="#l14.178"></a><span id="l14.178">     // Check if element is within a table cell</span>
<a href="#l14.179"></a><span id="l14.179">     if (editor.getElementOrParentByTagName(&quot;td&quot;, elementInDoc))</span>
<a href="#l14.180"></a><span id="l14.180">       return GetString(&quot;PercentOfCell&quot;);</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-    else</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-      return GetString(&quot;PercentOfWindow&quot;);</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-  } catch (e) { return &quot;&quot;;}</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+    return GetString(&quot;PercentOfWindow&quot;);</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+  } catch (e) { return &quot;&quot;; }</span>
<a href="#l14.186"></a><span id="l14.186"> }</span>
<a href="#l14.187"></a><span id="l14.187"> </span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-function ClearListbox(listbox)</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-{</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-  if (listbox)</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">-  {</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+function ClearListbox(listbox) {</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+  if (listbox) {</span>
<a href="#l14.194"></a><span id="l14.194">     listbox.clearSelection();</span>
<a href="#l14.195"></a><span id="l14.195">     while (listbox.hasChildNodes())</span>
<a href="#l14.196"></a><span id="l14.196">       listbox.lastChild.remove();</span>
<a href="#l14.197"></a><span id="l14.197">   }</span>
<a href="#l14.198"></a><span id="l14.198"> }</span>
<a href="#l14.199"></a><span id="l14.199"> </span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-function forceInteger(elementID)</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-{</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineminus">-  var editField = document.getElementById( elementID );</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-  if ( !editField )</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+function forceInteger(elementID) {</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+  var editField = document.getElementById(elementID);</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+  if (!editField)</span>
<a href="#l14.207"></a><span id="l14.207">     return;</span>
<a href="#l14.208"></a><span id="l14.208"> </span>
<a href="#l14.209"></a><span id="l14.209">   var stringIn = editField.value;</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-  if (stringIn &amp;&amp; stringIn.length &gt; 0)</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-  {</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+  if (stringIn &amp;&amp; stringIn.length &gt; 0) {</span>
<a href="#l14.213"></a><span id="l14.213">     // Strip out all nonnumeric characters</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-    stringIn = stringIn.replace(/\D+/g,&quot;&quot;);</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+    stringIn = stringIn.replace(/\D+/g, &quot;&quot;);</span>
<a href="#l14.216"></a><span id="l14.216">     if (!stringIn) stringIn = &quot;&quot;;</span>
<a href="#l14.217"></a><span id="l14.217"> </span>
<a href="#l14.218"></a><span id="l14.218">     // Write back only if changed</span>
<a href="#l14.219"></a><span id="l14.219">     if (stringIn != editField.value)</span>
<a href="#l14.220"></a><span id="l14.220">       editField.value = stringIn;</span>
<a href="#l14.221"></a><span id="l14.221">   }</span>
<a href="#l14.222"></a><span id="l14.222"> }</span>
<a href="#l14.223"></a><span id="l14.223"> </span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-function InitPixelOrPercentMenulist(elementForAtt, elementInDoc, attribute, menulistID, defaultIndex)</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineminus">-{</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+function InitPixelOrPercentMenulist(elementForAtt, elementInDoc, attribute, menulistID, defaultIndex) {</span>
<a href="#l14.227"></a><span id="l14.227">   if (!defaultIndex) defaultIndex = gPixel;</span>
<a href="#l14.228"></a><span id="l14.228"> </span>
<a href="#l14.229"></a><span id="l14.229">   // var size  = elementForAtt.getAttribute(attribute);</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-  var size = GetHTMLOrCSSStyleValue(elementForAtt, attribute, attribute)</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+  var size = GetHTMLOrCSSStyleValue(elementForAtt, attribute, attribute);</span>
<a href="#l14.232"></a><span id="l14.232">   var menulist = document.getElementById(menulistID);</span>
<a href="#l14.233"></a><span id="l14.233">   var pixelItem;</span>
<a href="#l14.234"></a><span id="l14.234">   var percentItem;</span>
<a href="#l14.235"></a><span id="l14.235"> </span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-  if (!menulist)</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-  {</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-    dump(&quot;NO MENULIST found for ID=&quot;+menulistID+&quot;\n&quot;);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+  if (!menulist) {</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+    dump(&quot;NO MENULIST found for ID=&quot; + menulistID + &quot;\n&quot;);</span>
<a href="#l14.241"></a><span id="l14.241">     return size;</span>
<a href="#l14.242"></a><span id="l14.242">   }</span>
<a href="#l14.243"></a><span id="l14.243"> </span>
<a href="#l14.244"></a><span id="l14.244">   menulist.removeAllItems();</span>
<a href="#l14.245"></a><span id="l14.245">   pixelItem = menulist.appendItem(GetString(&quot;Pixels&quot;));</span>
<a href="#l14.246"></a><span id="l14.246"> </span>
<a href="#l14.247"></a><span id="l14.247">   if (!pixelItem) return 0;</span>
<a href="#l14.248"></a><span id="l14.248"> </span>
<a href="#l14.249"></a><span id="l14.249">   percentItem = menulist.appendItem(GetAppropriatePercentString(elementForAtt, elementInDoc));</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-  if (size &amp;&amp; size.length &gt; 0)</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-  {</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+  if (size &amp;&amp; size.length &gt; 0) {</span>
<a href="#l14.253"></a><span id="l14.253">     // Search for a &quot;%&quot; or &quot;px&quot;</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-    if (size.includes(&quot;%&quot;))</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-    {</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+    if (size.includes(&quot;%&quot;)) {</span>
<a href="#l14.257"></a><span id="l14.257">       // Strip out the %</span>
<a href="#l14.258"></a><span id="l14.258">       size = size.substr(0, size.indexOf(&quot;%&quot;));</span>
<a href="#l14.259"></a><span id="l14.259">       if (percentItem)</span>
<a href="#l14.260"></a><span id="l14.260">         menulist.selectedItem = percentItem;</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-    }</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-    else</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-    {</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+    } else {</span>
<a href="#l14.265"></a><span id="l14.265">       if (size.includes(&quot;px&quot;))</span>
<a href="#l14.266"></a><span id="l14.266">         // Strip out the px</span>
<a href="#l14.267"></a><span id="l14.267">         size = size.substr(0, size.indexOf(&quot;px&quot;));</span>
<a href="#l14.268"></a><span id="l14.268">       menulist.selectedItem = pixelItem;</span>
<a href="#l14.269"></a><span id="l14.269">     }</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-  }</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-  else</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+  } else</span>
<a href="#l14.273"></a><span id="l14.273">     menulist.selectedIndex = defaultIndex;</span>
<a href="#l14.274"></a><span id="l14.274"> </span>
<a href="#l14.275"></a><span id="l14.275">   return size;</span>
<a href="#l14.276"></a><span id="l14.276"> }</span>
<a href="#l14.277"></a><span id="l14.277"> </span>
<a href="#l14.278"></a><span id="l14.278" class="difflineminus">-function onAdvancedEdit()</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineminus">-{</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+function onAdvancedEdit() {</span>
<a href="#l14.281"></a><span id="l14.281">   // First validate data from widgets in the &quot;simpler&quot; property dialog</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineminus">-  if (ValidateData())</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineminus">-  {</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l14.285"></a><span id="l14.285">     // Set true if OK is clicked in the Advanced Edit dialog</span>
<a href="#l14.286"></a><span id="l14.286">     window.AdvancedEditOK = false;</span>
<a href="#l14.287"></a><span id="l14.287">     // Open the AdvancedEdit dialog, passing in the element to be edited</span>
<a href="#l14.288"></a><span id="l14.288">     //  (the copy named &quot;globalElement&quot;)</span>
<a href="#l14.289"></a><span id="l14.289">     window.openDialog(&quot;chrome://editor/content/EdAdvancedEdit.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable=yes&quot;, &quot;&quot;, globalElement);</span>
<a href="#l14.290"></a><span id="l14.290">     window.focus();</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineminus">-    if (window.AdvancedEditOK)</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineminus">-    {</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+    if (window.AdvancedEditOK) {</span>
<a href="#l14.294"></a><span id="l14.294">       // Copy edited attributes to the dialog widgets:</span>
<a href="#l14.295"></a><span id="l14.295">       InitDialog();</span>
<a href="#l14.296"></a><span id="l14.296">     }</span>
<a href="#l14.297"></a><span id="l14.297">   }</span>
<a href="#l14.298"></a><span id="l14.298"> }</span>
<a href="#l14.299"></a><span id="l14.299"> </span>
<a href="#l14.300"></a><span id="l14.300" class="difflineminus">-function getColor(ColorPickerID)</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-{</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+function getColor(ColorPickerID) {</span>
<a href="#l14.303"></a><span id="l14.303">   var colorPicker = document.getElementById(ColorPickerID);</span>
<a href="#l14.304"></a><span id="l14.304">   var color;</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-  if (colorPicker)</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-  {</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+  if (colorPicker) {</span>
<a href="#l14.308"></a><span id="l14.308">     // Extract color from colorPicker and assign to colorWell.</span>
<a href="#l14.309"></a><span id="l14.309">     color = colorPicker.getAttribute(&quot;color&quot;);</span>
<a href="#l14.310"></a><span id="l14.310">     if (color &amp;&amp; color == &quot;&quot;)</span>
<a href="#l14.311"></a><span id="l14.311">       return null;</span>
<a href="#l14.312"></a><span id="l14.312">     // Clear color so next if it's called again before</span>
<a href="#l14.313"></a><span id="l14.313">     //  color picker is actually used, we dedect the &quot;don't set color&quot; state</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-    colorPicker.setAttribute(&quot;color&quot;,&quot;&quot;);</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+    colorPicker.setAttribute(&quot;color&quot;, &quot;&quot;);</span>
<a href="#l14.316"></a><span id="l14.316">   }</span>
<a href="#l14.317"></a><span id="l14.317"> </span>
<a href="#l14.318"></a><span id="l14.318">   return color;</span>
<a href="#l14.319"></a><span id="l14.319"> }</span>
<a href="#l14.320"></a><span id="l14.320"> </span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-function setColorWell(ColorWellID, color)</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-{</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+function setColorWell(ColorWellID, color) {</span>
<a href="#l14.324"></a><span id="l14.324">   var colorWell = document.getElementById(ColorWellID);</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineminus">-  if (colorWell)</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineminus">-  {</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineminus">-    if (!color || color == &quot;&quot;)</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineminus">-    {</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineplus">+  if (colorWell) {</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+    if (!color || color == &quot;&quot;) {</span>
<a href="#l14.331"></a><span id="l14.331">       // Don't set color (use default)</span>
<a href="#l14.332"></a><span id="l14.332">       // Trigger change to not show color swatch</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineminus">-      colorWell.setAttribute(&quot;default&quot;,&quot;true&quot;);</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+      colorWell.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l14.335"></a><span id="l14.335">       // Style in CSS sets &quot;background-color&quot;,</span>
<a href="#l14.336"></a><span id="l14.336">       //   but color won't clear unless we do this:</span>
<a href="#l14.337"></a><span id="l14.337">       colorWell.removeAttribute(&quot;style&quot;);</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineminus">-    }</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-    else</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-    {</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+    } else {</span>
<a href="#l14.342"></a><span id="l14.342">       colorWell.removeAttribute(&quot;default&quot;);</span>
<a href="#l14.343"></a><span id="l14.343">       // Use setAttribute so colorwell can be a XUL element, such as button</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineminus">-      colorWell.setAttribute(&quot;style&quot;, &quot;background-color:&quot;+color);</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineplus">+      colorWell.setAttribute(&quot;style&quot;, &quot;background-color:&quot; + color);</span>
<a href="#l14.346"></a><span id="l14.346">     }</span>
<a href="#l14.347"></a><span id="l14.347">   }</span>
<a href="#l14.348"></a><span id="l14.348"> }</span>
<a href="#l14.349"></a><span id="l14.349"> </span>
<a href="#l14.350"></a><span id="l14.350" class="difflineminus">-function getColorAndSetColorWell(ColorPickerID, ColorWellID)</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineminus">-{</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineplus">+function getColorAndSetColorWell(ColorPickerID, ColorWellID) {</span>
<a href="#l14.353"></a><span id="l14.353">   var color = getColor(ColorPickerID);</span>
<a href="#l14.354"></a><span id="l14.354">   setColorWell(ColorWellID, color);</span>
<a href="#l14.355"></a><span id="l14.355">   return color;</span>
<a href="#l14.356"></a><span id="l14.356"> }</span>
<a href="#l14.357"></a><span id="l14.357"> </span>
<a href="#l14.358"></a><span id="l14.358" class="difflineminus">-function InitMoreFewer()</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineminus">-{</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+function InitMoreFewer() {</span>
<a href="#l14.361"></a><span id="l14.361">   // Set SeeMore bool to the OPPOSITE of the current state,</span>
<a href="#l14.362"></a><span id="l14.362">   //   which is automatically saved by using the 'persist=&quot;more&quot;'</span>
<a href="#l14.363"></a><span id="l14.363">   //   attribute on the gDialog.MoreFewerButton button</span>
<a href="#l14.364"></a><span id="l14.364">   //   onMoreFewer will toggle it and redraw the dialog</span>
<a href="#l14.365"></a><span id="l14.365">   SeeMore = (gDialog.MoreFewerButton.getAttribute(&quot;more&quot;) != &quot;1&quot;);</span>
<a href="#l14.366"></a><span id="l14.366">   onMoreFewer();</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineminus">-  gDialog.MoreFewerButton.setAttribute(&quot;accesskey&quot;,GetString(&quot;PropertiesAccessKey&quot;));</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+  gDialog.MoreFewerButton.setAttribute(&quot;accesskey&quot;, GetString(&quot;PropertiesAccessKey&quot;));</span>
<a href="#l14.369"></a><span id="l14.369"> }</span>
<a href="#l14.370"></a><span id="l14.370"> </span>
<a href="#l14.371"></a><span id="l14.371" class="difflineminus">-function onMoreFewer()</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineminus">-{</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineminus">-  if (SeeMore)</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineminus">-  {</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineplus">+function onMoreFewer() {</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+  if (SeeMore) {</span>
<a href="#l14.377"></a><span id="l14.377">     gDialog.MoreSection.collapsed = true;</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineminus">-    gDialog.MoreFewerButton.setAttribute(&quot;more&quot;,&quot;0&quot;);</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineminus">-    gDialog.MoreFewerButton.setAttribute(&quot;label&quot;,GetString(&quot;MoreProperties&quot;));</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineplus">+    gDialog.MoreFewerButton.setAttribute(&quot;more&quot;, &quot;0&quot;);</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineplus">+    gDialog.MoreFewerButton.setAttribute(&quot;label&quot;, GetString(&quot;MoreProperties&quot;));</span>
<a href="#l14.382"></a><span id="l14.382">     SeeMore = false;</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineminus">-  }</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineminus">-  else</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineminus">-  {</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+  } else {</span>
<a href="#l14.387"></a><span id="l14.387">     gDialog.MoreSection.collapsed = false;</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineminus">-    gDialog.MoreFewerButton.setAttribute(&quot;more&quot;,&quot;1&quot;);</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineminus">-    gDialog.MoreFewerButton.setAttribute(&quot;label&quot;,GetString(&quot;FewerProperties&quot;));</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+    gDialog.MoreFewerButton.setAttribute(&quot;more&quot;, &quot;1&quot;);</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+    gDialog.MoreFewerButton.setAttribute(&quot;label&quot;, GetString(&quot;FewerProperties&quot;));</span>
<a href="#l14.392"></a><span id="l14.392">     SeeMore = true;</span>
<a href="#l14.393"></a><span id="l14.393">   }</span>
<a href="#l14.394"></a><span id="l14.394">   window.sizeToContent();</span>
<a href="#l14.395"></a><span id="l14.395"> }</span>
<a href="#l14.396"></a><span id="l14.396"> </span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-function SwitchToValidatePanel()</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-{</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+function SwitchToValidatePanel() {</span>
<a href="#l14.400"></a><span id="l14.400">   // no default implementation</span>
<a href="#l14.401"></a><span id="l14.401">   // Only EdTableProps.js currently implements this</span>
<a href="#l14.402"></a><span id="l14.402"> }</span>
<a href="#l14.403"></a><span id="l14.403"> </span>
<a href="#l14.404"></a><span id="l14.404"> const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l14.405"></a><span id="l14.405"> </span>
<a href="#l14.406"></a><span id="l14.406"> /**</span>
<a href="#l14.407"></a><span id="l14.407">  * @return {Promise} URL spec of the file chosen, or null</span>
<a href="#l14.408"></a><span id="l14.408">  */</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineminus">-function GetLocalFileURL(filterType)</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineminus">-{</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineplus">+function GetLocalFileURL(filterType) {</span>
<a href="#l14.412"></a><span id="l14.412">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l14.413"></a><span id="l14.413">   var fileType = &quot;html&quot;;</span>
<a href="#l14.414"></a><span id="l14.414"> </span>
<a href="#l14.415"></a><span id="l14.415" class="difflineminus">-  if (filterType == &quot;img&quot;)</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineminus">-  {</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineplus">+  if (filterType == &quot;img&quot;) {</span>
<a href="#l14.418"></a><span id="l14.418">     fp.init(window, GetString(&quot;SelectImageFile&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l14.419"></a><span id="l14.419">     fp.appendFilters(nsIFilePicker.filterImages);</span>
<a href="#l14.420"></a><span id="l14.420">     fileType = &quot;image&quot;;</span>
<a href="#l14.421"></a><span id="l14.421">   }</span>
<a href="#l14.422"></a><span id="l14.422">   // Current usage of this is in Link dialog,</span>
<a href="#l14.423"></a><span id="l14.423">   //  where we always want HTML first</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineminus">-  else if (filterType.startsWith(&quot;html&quot;))</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineminus">-  {</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineplus">+  else if (filterType.startsWith(&quot;html&quot;)) {</span>
<a href="#l14.427"></a><span id="l14.427">     fp.init(window, GetString(&quot;OpenHTMLFile&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l14.428"></a><span id="l14.428"> </span>
<a href="#l14.429"></a><span id="l14.429">     // When loading into Composer, direct user to prefer HTML files and text files,</span>
<a href="#l14.430"></a><span id="l14.430">     //   so we call separately to control the order of the filter list</span>
<a href="#l14.431"></a><span id="l14.431">     fp.appendFilters(nsIFilePicker.filterHTML);</span>
<a href="#l14.432"></a><span id="l14.432">     fp.appendFilters(nsIFilePicker.filterText);</span>
<a href="#l14.433"></a><span id="l14.433"> </span>
<a href="#l14.434"></a><span id="l14.434">     // Link dialog also allows linking to images</span>
<a href="#l14.435"></a><span id="l14.435">     if (filterType.includes(&quot;img&quot;, 1))</span>
<a href="#l14.436"></a><span id="l14.436">       fp.appendFilters(nsIFilePicker.filterImages);</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineminus">-</span>
<a href="#l14.438"></a><span id="l14.438">   }</span>
<a href="#l14.439"></a><span id="l14.439">   // Default or last filter is &quot;All Files&quot;</span>
<a href="#l14.440"></a><span id="l14.440">   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l14.441"></a><span id="l14.441"> </span>
<a href="#l14.442"></a><span id="l14.442">   // set the file picker's current directory to last-opened location saved in prefs</span>
<a href="#l14.443"></a><span id="l14.443">   SetFilePickerDirectory(fp, fileType);</span>
<a href="#l14.444"></a><span id="l14.444"> </span>
<a href="#l14.445"></a><span id="l14.445">   return new Promise(resolve =&gt; {</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineat">@@ -430,155 +381,131 @@ function GetLocalFileURL(filterType)</span>
<a href="#l14.447"></a><span id="l14.447">         return;</span>
<a href="#l14.448"></a><span id="l14.448">       }</span>
<a href="#l14.449"></a><span id="l14.449">       SaveFilePickerDirectory(fp, fileType);</span>
<a href="#l14.450"></a><span id="l14.450">       resolve(fp.fileURL.spec);</span>
<a href="#l14.451"></a><span id="l14.451">     });</span>
<a href="#l14.452"></a><span id="l14.452">   });</span>
<a href="#l14.453"></a><span id="l14.453"> }</span>
<a href="#l14.454"></a><span id="l14.454"> </span>
<a href="#l14.455"></a><span id="l14.455" class="difflineminus">-function GetMetaElementByAttribute(name, value)</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineminus">-{</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineminus">-  if (name)</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineminus">-  {</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+function GetMetaElementByAttribute(name, value) {</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineplus">+  if (name) {</span>
<a href="#l14.461"></a><span id="l14.461">     name = name.toLowerCase();</span>
<a href="#l14.462"></a><span id="l14.462">     let editor = GetCurrentEditor();</span>
<a href="#l14.463"></a><span id="l14.463">     try {</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineminus">-      return editor.document.querySelector('meta[' + name + '=&quot;' + value + '&quot;]');</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+      return editor.document.querySelector(&quot;meta[&quot; + name + '=&quot;' + value + '&quot;]');</span>
<a href="#l14.466"></a><span id="l14.466">     } catch (e) {}</span>
<a href="#l14.467"></a><span id="l14.467">   }</span>
<a href="#l14.468"></a><span id="l14.468">   return null;</span>
<a href="#l14.469"></a><span id="l14.469"> }</span>
<a href="#l14.470"></a><span id="l14.470"> </span>
<a href="#l14.471"></a><span id="l14.471" class="difflineminus">-function CreateMetaElementWithAttribute(name, value)</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineminus">-{</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineplus">+function CreateMetaElementWithAttribute(name, value) {</span>
<a href="#l14.474"></a><span id="l14.474">   let editor = GetCurrentEditor();</span>
<a href="#l14.475"></a><span id="l14.475">   try {</span>
<a href="#l14.476"></a><span id="l14.476">     let metaElement = editor.createElementWithDefaults(&quot;meta&quot;);</span>
<a href="#l14.477"></a><span id="l14.477">     if (name) {</span>
<a href="#l14.478"></a><span id="l14.478">       metaElement.setAttribute(name, value);</span>
<a href="#l14.479"></a><span id="l14.479">     }</span>
<a href="#l14.480"></a><span id="l14.480">     return metaElement;</span>
<a href="#l14.481"></a><span id="l14.481">   } catch (e) {}</span>
<a href="#l14.482"></a><span id="l14.482">   return null;</span>
<a href="#l14.483"></a><span id="l14.483"> }</span>
<a href="#l14.484"></a><span id="l14.484"> </span>
<a href="#l14.485"></a><span id="l14.485"> // Change &quot;content&quot; attribute on a META element,</span>
<a href="#l14.486"></a><span id="l14.486"> //   or delete entire element it if content is empty</span>
<a href="#l14.487"></a><span id="l14.487"> // This uses undoable editor transactions</span>
<a href="#l14.488"></a><span id="l14.488" class="difflineminus">-function SetMetaElementContent(metaElement, content, insertNew, prepend)</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineminus">-{</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineminus">-  if (metaElement)</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineminus">-  {</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineplus">+function SetMetaElementContent(metaElement, content, insertNew, prepend) {</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineplus">+  if (metaElement) {</span>
<a href="#l14.494"></a><span id="l14.494">     var editor = GetCurrentEditor();</span>
<a href="#l14.495"></a><span id="l14.495">     try {</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineminus">-      if(!content || content == &quot;&quot;)</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineminus">-      {</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineplus">+      if (!content || content == &quot;&quot;) {</span>
<a href="#l14.499"></a><span id="l14.499">         if (!insertNew)</span>
<a href="#l14.500"></a><span id="l14.500">           editor.deleteNode(metaElement);</span>
<a href="#l14.501"></a><span id="l14.501" class="difflineminus">-      }</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineminus">-      else</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineminus">-      {</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineminus">-        if (insertNew)</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineminus">-        {</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineplus">+      } else if (insertNew) {</span>
<a href="#l14.507"></a><span id="l14.507">           metaElement.setAttribute(&quot;content&quot;, content);</span>
<a href="#l14.508"></a><span id="l14.508">           if (prepend)</span>
<a href="#l14.509"></a><span id="l14.509">             PrependHeadElement(metaElement);</span>
<a href="#l14.510"></a><span id="l14.510">           else</span>
<a href="#l14.511"></a><span id="l14.511">             AppendHeadElement(metaElement);</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineminus">-        }</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineminus">-        else</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineplus">+        } else</span>
<a href="#l14.515"></a><span id="l14.515">           editor.setAttribute(metaElement, &quot;content&quot;, content);</span>
<a href="#l14.516"></a><span id="l14.516" class="difflineminus">-      }</span>
<a href="#l14.517"></a><span id="l14.517">     } catch (e) {}</span>
<a href="#l14.518"></a><span id="l14.518">   }</span>
<a href="#l14.519"></a><span id="l14.519"> }</span>
<a href="#l14.520"></a><span id="l14.520"> </span>
<a href="#l14.521"></a><span id="l14.521" class="difflineminus">-function GetHeadElement()</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineminus">-{</span>
<a href="#l14.523"></a><span id="l14.523" class="difflineplus">+function GetHeadElement() {</span>
<a href="#l14.524"></a><span id="l14.524">   var editor = GetCurrentEditor();</span>
<a href="#l14.525"></a><span id="l14.525">   try {</span>
<a href="#l14.526"></a><span id="l14.526">     return editor.document.querySelector(&quot;head&quot;);</span>
<a href="#l14.527"></a><span id="l14.527">   } catch (e) {}</span>
<a href="#l14.528"></a><span id="l14.528"> </span>
<a href="#l14.529"></a><span id="l14.529">   return null;</span>
<a href="#l14.530"></a><span id="l14.530"> }</span>
<a href="#l14.531"></a><span id="l14.531"> </span>
<a href="#l14.532"></a><span id="l14.532" class="difflineminus">-function PrependHeadElement(element)</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineminus">-{</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineplus">+function PrependHeadElement(element) {</span>
<a href="#l14.535"></a><span id="l14.535">   var head = GetHeadElement();</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineminus">-  if (head)</span>
<a href="#l14.537"></a><span id="l14.537" class="difflineminus">-  {</span>
<a href="#l14.538"></a><span id="l14.538" class="difflineplus">+  if (head) {</span>
<a href="#l14.539"></a><span id="l14.539">     var editor = GetCurrentEditor();</span>
<a href="#l14.540"></a><span id="l14.540">     try {</span>
<a href="#l14.541"></a><span id="l14.541">       // Use editor's undoable transaction</span>
<a href="#l14.542"></a><span id="l14.542">       // Last param &quot;true&quot; says &quot;don't change the selection&quot;</span>
<a href="#l14.543"></a><span id="l14.543">       editor.insertNode(element, head, 0, true);</span>
<a href="#l14.544"></a><span id="l14.544">     } catch (e) {}</span>
<a href="#l14.545"></a><span id="l14.545">   }</span>
<a href="#l14.546"></a><span id="l14.546"> }</span>
<a href="#l14.547"></a><span id="l14.547"> </span>
<a href="#l14.548"></a><span id="l14.548" class="difflineminus">-function AppendHeadElement(element)</span>
<a href="#l14.549"></a><span id="l14.549" class="difflineminus">-{</span>
<a href="#l14.550"></a><span id="l14.550" class="difflineplus">+function AppendHeadElement(element) {</span>
<a href="#l14.551"></a><span id="l14.551">   var head = GetHeadElement();</span>
<a href="#l14.552"></a><span id="l14.552" class="difflineminus">-  if (head)</span>
<a href="#l14.553"></a><span id="l14.553" class="difflineminus">-  {</span>
<a href="#l14.554"></a><span id="l14.554" class="difflineplus">+  if (head) {</span>
<a href="#l14.555"></a><span id="l14.555">     var position = 0;</span>
<a href="#l14.556"></a><span id="l14.556">     if (head.hasChildNodes())</span>
<a href="#l14.557"></a><span id="l14.557">       position = head.childNodes.length;</span>
<a href="#l14.558"></a><span id="l14.558"> </span>
<a href="#l14.559"></a><span id="l14.559">     var editor = GetCurrentEditor();</span>
<a href="#l14.560"></a><span id="l14.560">     try {</span>
<a href="#l14.561"></a><span id="l14.561">       // Use editor's undoable transaction</span>
<a href="#l14.562"></a><span id="l14.562">       // Last param &quot;true&quot; says &quot;don't change the selection&quot;</span>
<a href="#l14.563"></a><span id="l14.563">       editor.insertNode(element, head, position, true);</span>
<a href="#l14.564"></a><span id="l14.564">     } catch (e) {}</span>
<a href="#l14.565"></a><span id="l14.565">   }</span>
<a href="#l14.566"></a><span id="l14.566"> }</span>
<a href="#l14.567"></a><span id="l14.567"> </span>
<a href="#l14.568"></a><span id="l14.568" class="difflineminus">-function SetWindowLocation()</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineminus">-{</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineplus">+function SetWindowLocation() {</span>
<a href="#l14.571"></a><span id="l14.571">   gLocation = document.getElementById(&quot;location&quot;);</span>
<a href="#l14.572"></a><span id="l14.572" class="difflineminus">-  if (gLocation)</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineminus">-  {</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineplus">+  if (gLocation) {</span>
<a href="#l14.575"></a><span id="l14.575">     window.screenX = Math.max(0, Math.min(window.opener.screenX + Number(gLocation.getAttribute(&quot;offsetX&quot;)),</span>
<a href="#l14.576"></a><span id="l14.576">                                           screen.availWidth - window.outerWidth));</span>
<a href="#l14.577"></a><span id="l14.577">     window.screenY = Math.max(0, Math.min(window.opener.screenY + Number(gLocation.getAttribute(&quot;offsetY&quot;)),</span>
<a href="#l14.578"></a><span id="l14.578">                                           screen.availHeight - window.outerHeight));</span>
<a href="#l14.579"></a><span id="l14.579">   }</span>
<a href="#l14.580"></a><span id="l14.580"> }</span>
<a href="#l14.581"></a><span id="l14.581"> </span>
<a href="#l14.582"></a><span id="l14.582" class="difflineminus">-function SaveWindowLocation()</span>
<a href="#l14.583"></a><span id="l14.583" class="difflineminus">-{</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineminus">-  if (gLocation)</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineminus">-  {</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineplus">+function SaveWindowLocation() {</span>
<a href="#l14.587"></a><span id="l14.587" class="difflineplus">+  if (gLocation) {</span>
<a href="#l14.588"></a><span id="l14.588">     var newOffsetX = window.screenX - window.opener.screenX;</span>
<a href="#l14.589"></a><span id="l14.589">     var newOffsetY = window.screenY - window.opener.screenY;</span>
<a href="#l14.590"></a><span id="l14.590">     gLocation.setAttribute(&quot;offsetX&quot;, window.screenX - window.opener.screenX);</span>
<a href="#l14.591"></a><span id="l14.591">     gLocation.setAttribute(&quot;offsetY&quot;, window.screenY - window.opener.screenY);</span>
<a href="#l14.592"></a><span id="l14.592">   }</span>
<a href="#l14.593"></a><span id="l14.593"> }</span>
<a href="#l14.594"></a><span id="l14.594"> </span>
<a href="#l14.595"></a><span id="l14.595" class="difflineminus">-function onCancel()</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineminus">-{</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineplus">+function onCancel() {</span>
<a href="#l14.598"></a><span id="l14.598">   SaveWindowLocation();</span>
<a href="#l14.599"></a><span id="l14.599"> }</span>
<a href="#l14.600"></a><span id="l14.600"> </span>
<a href="#l14.601"></a><span id="l14.601" class="difflineminus">-function SetRelativeCheckbox(checkbox)</span>
<a href="#l14.602"></a><span id="l14.602" class="difflineminus">-{</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineplus">+function SetRelativeCheckbox(checkbox) {</span>
<a href="#l14.604"></a><span id="l14.604">   if (!checkbox) {</span>
<a href="#l14.605"></a><span id="l14.605">     checkbox = document.getElementById(&quot;MakeRelativeCheckbox&quot;);</span>
<a href="#l14.606"></a><span id="l14.606">     if (!checkbox)</span>
<a href="#l14.607"></a><span id="l14.607">       return;</span>
<a href="#l14.608"></a><span id="l14.608">   }</span>
<a href="#l14.609"></a><span id="l14.609"> </span>
<a href="#l14.610"></a><span id="l14.610">   var editor = GetCurrentEditor();</span>
<a href="#l14.611"></a><span id="l14.611">   // Mail never allows relative URLs, so hide the checkbox</span>
<a href="#l14.612"></a><span id="l14.612" class="difflineminus">-  if (editor &amp;&amp; (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask))</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineminus">-  {</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineplus">+  if (editor &amp;&amp; (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)) {</span>
<a href="#l14.615"></a><span id="l14.615">     checkbox.collapsed = true;</span>
<a href="#l14.616"></a><span id="l14.616">     return;</span>
<a href="#l14.617"></a><span id="l14.617">   }</span>
<a href="#l14.618"></a><span id="l14.618"> </span>
<a href="#l14.619"></a><span id="l14.619">   var input =  document.getElementById(checkbox.getAttribute(&quot;for&quot;));</span>
<a href="#l14.620"></a><span id="l14.620">   if (!input)</span>
<a href="#l14.621"></a><span id="l14.621">     return;</span>
<a href="#l14.622"></a><span id="l14.622"> </span>
<a href="#l14.623"></a><span id="l14.623" class="difflineat">@@ -589,66 +516,55 @@ function SetRelativeCheckbox(checkbox)</span>
<a href="#l14.624"></a><span id="l14.624">   checkbox.checked = url.length &gt; 0 &amp;&amp; !urlScheme;</span>
<a href="#l14.625"></a><span id="l14.625"> </span>
<a href="#l14.626"></a><span id="l14.626">   // Now do checkbox enabling:</span>
<a href="#l14.627"></a><span id="l14.627">   var enable = false;</span>
<a href="#l14.628"></a><span id="l14.628"> </span>
<a href="#l14.629"></a><span id="l14.629">   var docUrl = GetDocumentBaseUrl();</span>
<a href="#l14.630"></a><span id="l14.630">   var docScheme = GetScheme(docUrl);</span>
<a href="#l14.631"></a><span id="l14.631"> </span>
<a href="#l14.632"></a><span id="l14.632" class="difflineminus">-  if (url &amp;&amp; docUrl &amp;&amp; docScheme)</span>
<a href="#l14.633"></a><span id="l14.633" class="difflineminus">-  {</span>
<a href="#l14.634"></a><span id="l14.634" class="difflineminus">-    if (urlScheme)</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineminus">-    {</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineplus">+  if (url &amp;&amp; docUrl &amp;&amp; docScheme) {</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineplus">+    if (urlScheme) {</span>
<a href="#l14.638"></a><span id="l14.638">       // Url is absolute</span>
<a href="#l14.639"></a><span id="l14.639">       // If we can make a relative URL, then enable must be true!</span>
<a href="#l14.640"></a><span id="l14.640">       // (this lets the smarts of MakeRelativeUrl do all the hard work)</span>
<a href="#l14.641"></a><span id="l14.641">       enable = (GetScheme(MakeRelativeUrl(url)).length == 0);</span>
<a href="#l14.642"></a><span id="l14.642" class="difflineminus">-    }</span>
<a href="#l14.643"></a><span id="l14.643" class="difflineminus">-    else</span>
<a href="#l14.644"></a><span id="l14.644" class="difflineminus">-    {</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineplus">+    } else {</span>
<a href="#l14.646"></a><span id="l14.646">       // Url is relative</span>
<a href="#l14.647"></a><span id="l14.647">       // Check if url is a named anchor</span>
<a href="#l14.648"></a><span id="l14.648">       //  but document doesn't have a filename</span>
<a href="#l14.649"></a><span id="l14.649">       // (it's probably &quot;index.html&quot; or &quot;index.htm&quot;,</span>
<a href="#l14.650"></a><span id="l14.650">       //  but we don't want to allow a malformed URL)</span>
<a href="#l14.651"></a><span id="l14.651" class="difflineminus">-      if (url[0] == &quot;#&quot;)</span>
<a href="#l14.652"></a><span id="l14.652" class="difflineminus">-      {</span>
<a href="#l14.653"></a><span id="l14.653" class="difflineplus">+      if (url[0] == &quot;#&quot;) {</span>
<a href="#l14.654"></a><span id="l14.654">         var docFilename = GetFilename(docUrl);</span>
<a href="#l14.655"></a><span id="l14.655">         enable = docFilename.length &gt; 0;</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineminus">-      }</span>
<a href="#l14.657"></a><span id="l14.657" class="difflineminus">-      else</span>
<a href="#l14.658"></a><span id="l14.658" class="difflineminus">-      {</span>
<a href="#l14.659"></a><span id="l14.659" class="difflineplus">+      } else {</span>
<a href="#l14.660"></a><span id="l14.660">         // Any other url is assumed</span>
<a href="#l14.661"></a><span id="l14.661">         //  to be ok to try to make absolute</span>
<a href="#l14.662"></a><span id="l14.662">         enable = true;</span>
<a href="#l14.663"></a><span id="l14.663">       }</span>
<a href="#l14.664"></a><span id="l14.664">     }</span>
<a href="#l14.665"></a><span id="l14.665">   }</span>
<a href="#l14.666"></a><span id="l14.666"> </span>
<a href="#l14.667"></a><span id="l14.667">   SetElementEnabled(checkbox, enable);</span>
<a href="#l14.668"></a><span id="l14.668"> }</span>
<a href="#l14.669"></a><span id="l14.669"> </span>
<a href="#l14.670"></a><span id="l14.670"> // oncommand handler for the Relativize checkbox in EditorOverlay.xul</span>
<a href="#l14.671"></a><span id="l14.671" class="difflineminus">-function MakeInputValueRelativeOrAbsolute(checkbox)</span>
<a href="#l14.672"></a><span id="l14.672" class="difflineminus">-{</span>
<a href="#l14.673"></a><span id="l14.673" class="difflineplus">+function MakeInputValueRelativeOrAbsolute(checkbox) {</span>
<a href="#l14.674"></a><span id="l14.674">   var input =  document.getElementById(checkbox.getAttribute(&quot;for&quot;));</span>
<a href="#l14.675"></a><span id="l14.675">   if (!input)</span>
<a href="#l14.676"></a><span id="l14.676">     return;</span>
<a href="#l14.677"></a><span id="l14.677"> </span>
<a href="#l14.678"></a><span id="l14.678">   var docUrl = GetDocumentBaseUrl();</span>
<a href="#l14.679"></a><span id="l14.679" class="difflineminus">-  if (!docUrl)</span>
<a href="#l14.680"></a><span id="l14.680" class="difflineminus">-  {</span>
<a href="#l14.681"></a><span id="l14.681" class="difflineplus">+  if (!docUrl) {</span>
<a href="#l14.682"></a><span id="l14.682">     // Checkbox should be disabled if not saved,</span>
<a href="#l14.683"></a><span id="l14.683">     //  but keep this error message in case we change that</span>
<a href="#l14.684"></a><span id="l14.684">     Services.prompt.alert(window, &quot;&quot;, GetString(&quot;SaveToUseRelativeUrl&quot;));</span>
<a href="#l14.685"></a><span id="l14.685">     window.focus();</span>
<a href="#l14.686"></a><span id="l14.686" class="difflineminus">-  }</span>
<a href="#l14.687"></a><span id="l14.687" class="difflineminus">-  else</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineminus">-  {</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineplus">+  } else {</span>
<a href="#l14.690"></a><span id="l14.690">     // Note that &quot;checked&quot; is opposite of its last state,</span>
<a href="#l14.691"></a><span id="l14.691">     //  which determines what we want to do here</span>
<a href="#l14.692"></a><span id="l14.692">     if (checkbox.checked)</span>
<a href="#l14.693"></a><span id="l14.693">       input.value = MakeRelativeUrl(input.value);</span>
<a href="#l14.694"></a><span id="l14.694">     else</span>
<a href="#l14.695"></a><span id="l14.695">       input.value = MakeAbsoluteUrl(input.value);</span>
<a href="#l14.696"></a><span id="l14.696"> </span>
<a href="#l14.697"></a><span id="l14.697">     // Reset checkbox to reflect url state</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineat">@@ -681,54 +597,50 @@ var NotAnInlineParent = [</span>
<a href="#l14.699"></a><span id="l14.699">   &quot;table&quot;,</span>
<a href="#l14.700"></a><span id="l14.700">   &quot;tbody&quot;,</span>
<a href="#l14.701"></a><span id="l14.701">   &quot;tfoot&quot;,</span>
<a href="#l14.702"></a><span id="l14.702">   &quot;thead&quot;,</span>
<a href="#l14.703"></a><span id="l14.703">   &quot;tr&quot;,</span>
<a href="#l14.704"></a><span id="l14.704">   &quot;ul&quot;,</span>
<a href="#l14.705"></a><span id="l14.705"> ];</span>
<a href="#l14.706"></a><span id="l14.706"> </span>
<a href="#l14.707"></a><span id="l14.707" class="difflineminus">-function nodeIsBreak(editor, node)</span>
<a href="#l14.708"></a><span id="l14.708" class="difflineminus">-{</span>
<a href="#l14.709"></a><span id="l14.709" class="difflineplus">+function nodeIsBreak(editor, node) {</span>
<a href="#l14.710"></a><span id="l14.710">   // XXX This doesn't work because .localName is lowercase (see bug 1306060).</span>
<a href="#l14.711"></a><span id="l14.711" class="difflineminus">-  return !node || node.localName == 'BR' || editor.nodeIsBlock(node);</span>
<a href="#l14.712"></a><span id="l14.712" class="difflineplus">+  return !node || node.localName == &quot;BR&quot; || editor.nodeIsBlock(node);</span>
<a href="#l14.713"></a><span id="l14.713"> }</span>
<a href="#l14.714"></a><span id="l14.714"> </span>
<a href="#l14.715"></a><span id="l14.715" class="difflineminus">-function InsertElementAroundSelection(element)</span>
<a href="#l14.716"></a><span id="l14.716" class="difflineminus">-{</span>
<a href="#l14.717"></a><span id="l14.717" class="difflineplus">+function InsertElementAroundSelection(element) {</span>
<a href="#l14.718"></a><span id="l14.718">   var editor = GetCurrentEditor();</span>
<a href="#l14.719"></a><span id="l14.719">   editor.beginTransaction();</span>
<a href="#l14.720"></a><span id="l14.720"> </span>
<a href="#l14.721"></a><span id="l14.721">   try {</span>
<a href="#l14.722"></a><span id="l14.722">     // First get the selection as a single range</span>
<a href="#l14.723"></a><span id="l14.723">     var range, start, end, offset;</span>
<a href="#l14.724"></a><span id="l14.724">     var count = editor.selection.rangeCount;</span>
<a href="#l14.725"></a><span id="l14.725">     if (count == 1)</span>
<a href="#l14.726"></a><span id="l14.726">       range = editor.selection.getRangeAt(0).cloneRange();</span>
<a href="#l14.727"></a><span id="l14.727" class="difflineminus">-    else</span>
<a href="#l14.728"></a><span id="l14.728" class="difflineminus">-    {</span>
<a href="#l14.729"></a><span id="l14.729" class="difflineplus">+    else {</span>
<a href="#l14.730"></a><span id="l14.730">       range = editor.document.createRange();</span>
<a href="#l14.731"></a><span id="l14.731" class="difflineminus">-      start = editor.selection.getRangeAt(0)</span>
<a href="#l14.732"></a><span id="l14.732" class="difflineplus">+      start = editor.selection.getRangeAt(0);</span>
<a href="#l14.733"></a><span id="l14.733">       range.setStart(start.startContainer, start.startOffset);</span>
<a href="#l14.734"></a><span id="l14.734">       end = editor.selection.getRangeAt(--count);</span>
<a href="#l14.735"></a><span id="l14.735">       range.setEnd(end.endContainer, end.endOffset);</span>
<a href="#l14.736"></a><span id="l14.736">     }</span>
<a href="#l14.737"></a><span id="l14.737"> </span>
<a href="#l14.738"></a><span id="l14.738">     // Flatten the selection to child nodes of the common ancestor</span>
<a href="#l14.739"></a><span id="l14.739">     while (range.startContainer != range.commonAncestorContainer)</span>
<a href="#l14.740"></a><span id="l14.740">       range.setStartBefore(range.startContainer);</span>
<a href="#l14.741"></a><span id="l14.741">     while (range.endContainer != range.commonAncestorContainer)</span>
<a href="#l14.742"></a><span id="l14.742">       range.setEndAfter(range.endContainer);</span>
<a href="#l14.743"></a><span id="l14.743"> </span>
<a href="#l14.744"></a><span id="l14.744">     if (editor.nodeIsBlock(element))</span>
<a href="#l14.745"></a><span id="l14.745">       // Block element parent must be a valid block</span>
<a href="#l14.746"></a><span id="l14.746">       while (!IsBlockParent.includes(range.commonAncestorContainer.localName))</span>
<a href="#l14.747"></a><span id="l14.747">         range.selectNode(range.commonAncestorContainer);</span>
<a href="#l14.748"></a><span id="l14.748" class="difflineminus">-    else</span>
<a href="#l14.749"></a><span id="l14.749" class="difflineminus">-    {</span>
<a href="#l14.750"></a><span id="l14.750" class="difflineplus">+    else {</span>
<a href="#l14.751"></a><span id="l14.751">       // Fail if we're not inserting a block (use setInlineProperty instead)</span>
<a href="#l14.752"></a><span id="l14.752">       if (!nodeIsBreak(editor, range.commonAncestorContainer))</span>
<a href="#l14.753"></a><span id="l14.753">         return false;</span>
<a href="#l14.754"></a><span id="l14.754">       else if (NotAnInlineParent.includes(range.commonAncestorContainer.localName))</span>
<a href="#l14.755"></a><span id="l14.755">         // Inline element parent must not be an invalid block</span>
<a href="#l14.756"></a><span id="l14.756">         do range.selectNode(range.commonAncestorContainer);</span>
<a href="#l14.757"></a><span id="l14.757">         while (NotAnInlineParent.includes(range.commonAncestorContainer.localName));</span>
<a href="#l14.758"></a><span id="l14.758">       else</span>
<a href="#l14.759"></a><span id="l14.759" class="difflineat">@@ -738,96 +650,85 @@ function InsertElementAroundSelection(el</span>
<a href="#l14.760"></a><span id="l14.760">             return false;</span>
<a href="#l14.761"></a><span id="l14.761">           else if (nodeIsBreak(editor, range.commonAncestorContainer.childNodes[i]))</span>
<a href="#l14.762"></a><span id="l14.762">             break;</span>
<a href="#l14.763"></a><span id="l14.763">     }</span>
<a href="#l14.764"></a><span id="l14.764"> </span>
<a href="#l14.765"></a><span id="l14.765">     // The range may be contained by body text, which should all be selected.</span>
<a href="#l14.766"></a><span id="l14.766">     offset = range.startOffset;</span>
<a href="#l14.767"></a><span id="l14.767">     start = range.startContainer.childNodes[offset];</span>
<a href="#l14.768"></a><span id="l14.768" class="difflineminus">-    if (!nodeIsBreak(editor, start))</span>
<a href="#l14.769"></a><span id="l14.769" class="difflineminus">-    {</span>
<a href="#l14.770"></a><span id="l14.770" class="difflineminus">-      while (!nodeIsBreak(editor, start.previousSibling))</span>
<a href="#l14.771"></a><span id="l14.771" class="difflineminus">-      {</span>
<a href="#l14.772"></a><span id="l14.772" class="difflineplus">+    if (!nodeIsBreak(editor, start)) {</span>
<a href="#l14.773"></a><span id="l14.773" class="difflineplus">+      while (!nodeIsBreak(editor, start.previousSibling)) {</span>
<a href="#l14.774"></a><span id="l14.774">         start = start.previousSibling;</span>
<a href="#l14.775"></a><span id="l14.775">         offset--;</span>
<a href="#l14.776"></a><span id="l14.776">       }</span>
<a href="#l14.777"></a><span id="l14.777">     }</span>
<a href="#l14.778"></a><span id="l14.778">     end = range.endContainer.childNodes[range.endOffset];</span>
<a href="#l14.779"></a><span id="l14.779" class="difflineminus">-    if (end &amp;&amp; !nodeIsBreak(editor, end.previousSibling))</span>
<a href="#l14.780"></a><span id="l14.780" class="difflineminus">-    {</span>
<a href="#l14.781"></a><span id="l14.781" class="difflineplus">+    if (end &amp;&amp; !nodeIsBreak(editor, end.previousSibling)) {</span>
<a href="#l14.782"></a><span id="l14.782">       while (!nodeIsBreak(editor, end))</span>
<a href="#l14.783"></a><span id="l14.783">         end = end.nextSibling;</span>
<a href="#l14.784"></a><span id="l14.784">     }</span>
<a href="#l14.785"></a><span id="l14.785"> </span>
<a href="#l14.786"></a><span id="l14.786">     // Now insert the node</span>
<a href="#l14.787"></a><span id="l14.787">     editor.insertNode(element, range.commonAncestorContainer, offset, true);</span>
<a href="#l14.788"></a><span id="l14.788">     offset = element.childNodes.length;</span>
<a href="#l14.789"></a><span id="l14.789">     if (!editor.nodeIsBlock(element))</span>
<a href="#l14.790"></a><span id="l14.790">       editor.setShouldTxnSetSelection(false);</span>
<a href="#l14.791"></a><span id="l14.791"> </span>
<a href="#l14.792"></a><span id="l14.792">     // Move all the old child nodes to the element</span>
<a href="#l14.793"></a><span id="l14.793">     var empty = true;</span>
<a href="#l14.794"></a><span id="l14.794" class="difflineminus">-    while (start != end)</span>
<a href="#l14.795"></a><span id="l14.795" class="difflineminus">-    {</span>
<a href="#l14.796"></a><span id="l14.796" class="difflineplus">+    while (start != end) {</span>
<a href="#l14.797"></a><span id="l14.797">       var next = start.nextSibling;</span>
<a href="#l14.798"></a><span id="l14.798">       editor.deleteNode(start);</span>
<a href="#l14.799"></a><span id="l14.799">       editor.insertNode(start, element, element.childNodes.length);</span>
<a href="#l14.800"></a><span id="l14.800">       empty = false;</span>
<a href="#l14.801"></a><span id="l14.801">       start = next;</span>
<a href="#l14.802"></a><span id="l14.802">     }</span>
<a href="#l14.803"></a><span id="l14.803">     if (!editor.nodeIsBlock(element))</span>
<a href="#l14.804"></a><span id="l14.804">       editor.setShouldTxnSetSelection(true);</span>
<a href="#l14.805"></a><span id="l14.805" class="difflineminus">-    else</span>
<a href="#l14.806"></a><span id="l14.806" class="difflineminus">-    {</span>
<a href="#l14.807"></a><span id="l14.807" class="difflineplus">+    else {</span>
<a href="#l14.808"></a><span id="l14.808">       // Also move a trailing &lt;br&gt;</span>
<a href="#l14.809"></a><span id="l14.809">       // XXX This doesn't work because .localName is lowercase (see bug 1306060).</span>
<a href="#l14.810"></a><span id="l14.810" class="difflineminus">-      if (start &amp;&amp; start.localName == 'BR')</span>
<a href="#l14.811"></a><span id="l14.811" class="difflineminus">-      {</span>
<a href="#l14.812"></a><span id="l14.812" class="difflineplus">+      if (start &amp;&amp; start.localName == &quot;BR&quot;) {</span>
<a href="#l14.813"></a><span id="l14.813">         editor.deleteNode(start);</span>
<a href="#l14.814"></a><span id="l14.814">         editor.insertNode(start, element, element.childNodes.length);</span>
<a href="#l14.815"></a><span id="l14.815">         empty = false;</span>
<a href="#l14.816"></a><span id="l14.816">       }</span>
<a href="#l14.817"></a><span id="l14.817">       // Still nothing? Insert a &lt;br&gt; so the node is not empty</span>
<a href="#l14.818"></a><span id="l14.818">       if (empty)</span>
<a href="#l14.819"></a><span id="l14.819">         editor.insertNode(editor.createElementWithDefaults(&quot;br&quot;), element, element.childNodes.length);</span>
<a href="#l14.820"></a><span id="l14.820"> </span>
<a href="#l14.821"></a><span id="l14.821">       // Hack to set the selection just inside the element</span>
<a href="#l14.822"></a><span id="l14.822">       editor.insertNode(editor.document.createTextNode(&quot;&quot;), element, offset);</span>
<a href="#l14.823"></a><span id="l14.823">     }</span>
<a href="#l14.824"></a><span id="l14.824" class="difflineminus">-  }</span>
<a href="#l14.825"></a><span id="l14.825" class="difflineminus">-  finally {</span>
<a href="#l14.826"></a><span id="l14.826" class="difflineplus">+  } finally {</span>
<a href="#l14.827"></a><span id="l14.827">     editor.endTransaction();</span>
<a href="#l14.828"></a><span id="l14.828">   }</span>
<a href="#l14.829"></a><span id="l14.829"> </span>
<a href="#l14.830"></a><span id="l14.830">   return true;</span>
<a href="#l14.831"></a><span id="l14.831"> }</span>
<a href="#l14.832"></a><span id="l14.832"> </span>
<a href="#l14.833"></a><span id="l14.833" class="difflineminus">-function nodeIsBlank(node)</span>
<a href="#l14.834"></a><span id="l14.834" class="difflineminus">-{</span>
<a href="#l14.835"></a><span id="l14.835" class="difflineplus">+function nodeIsBlank(node) {</span>
<a href="#l14.836"></a><span id="l14.836">   return node &amp;&amp; node.nodeType == Node.TEXT_NODE &amp;&amp; !/\S/.test(node.data);</span>
<a href="#l14.837"></a><span id="l14.837"> }</span>
<a href="#l14.838"></a><span id="l14.838"> </span>
<a href="#l14.839"></a><span id="l14.839" class="difflineminus">-function nodeBeginsBlock(editor, node)</span>
<a href="#l14.840"></a><span id="l14.840" class="difflineminus">-{</span>
<a href="#l14.841"></a><span id="l14.841" class="difflineplus">+function nodeBeginsBlock(editor, node) {</span>
<a href="#l14.842"></a><span id="l14.842">   while (nodeIsBlank(node))</span>
<a href="#l14.843"></a><span id="l14.843">     node = node.nextSibling;</span>
<a href="#l14.844"></a><span id="l14.844">   return nodeIsBreak(editor, node);</span>
<a href="#l14.845"></a><span id="l14.845"> }</span>
<a href="#l14.846"></a><span id="l14.846"> </span>
<a href="#l14.847"></a><span id="l14.847" class="difflineminus">-function nodeEndsBlock(editor, node)</span>
<a href="#l14.848"></a><span id="l14.848" class="difflineminus">-{</span>
<a href="#l14.849"></a><span id="l14.849" class="difflineplus">+function nodeEndsBlock(editor, node) {</span>
<a href="#l14.850"></a><span id="l14.850">   while (nodeIsBlank(node))</span>
<a href="#l14.851"></a><span id="l14.851">     node = node.previousSibling;</span>
<a href="#l14.852"></a><span id="l14.852">   return nodeIsBreak(editor, node);</span>
<a href="#l14.853"></a><span id="l14.853"> }</span>
<a href="#l14.854"></a><span id="l14.854"> </span>
<a href="#l14.855"></a><span id="l14.855"> // C++ function isn't exposed to JS :-(</span>
<a href="#l14.856"></a><span id="l14.856" class="difflineminus">-function RemoveBlockContainer(element)</span>
<a href="#l14.857"></a><span id="l14.857" class="difflineminus">-{</span>
<a href="#l14.858"></a><span id="l14.858" class="difflineplus">+function RemoveBlockContainer(element) {</span>
<a href="#l14.859"></a><span id="l14.859">   var editor = GetCurrentEditor();</span>
<a href="#l14.860"></a><span id="l14.860">   editor.beginTransaction();</span>
<a href="#l14.861"></a><span id="l14.861"> </span>
<a href="#l14.862"></a><span id="l14.862">   try {</span>
<a href="#l14.863"></a><span id="l14.863">     var range = editor.document.createRange();</span>
<a href="#l14.864"></a><span id="l14.864">     range.selectNode(element);</span>
<a href="#l14.865"></a><span id="l14.865">     var offset = range.startOffset;</span>
<a href="#l14.866"></a><span id="l14.866">     var parent = element.parentNode;</span>
<a href="#l14.867"></a><span id="l14.867" class="difflineat">@@ -843,145 +744,129 @@ function RemoveBlockContainer(element)</span>
<a href="#l14.868"></a><span id="l14.868">       editor.insertNode(editor.createElementWithDefaults(&quot;br&quot;), parent, offset++);</span>
<a href="#l14.869"></a><span id="l14.869"> </span>
<a href="#l14.870"></a><span id="l14.870">     // Now remove the element</span>
<a href="#l14.871"></a><span id="l14.871">     editor.deleteNode(element);</span>
<a href="#l14.872"></a><span id="l14.872"> </span>
<a href="#l14.873"></a><span id="l14.873">     // Need to copy the contained nodes?</span>
<a href="#l14.874"></a><span id="l14.874">     for (var i = 0; i &lt; element.childNodes.length; i++)</span>
<a href="#l14.875"></a><span id="l14.875">       editor.insertNode(element.childNodes[i].cloneNode(true), parent, offset++);</span>
<a href="#l14.876"></a><span id="l14.876" class="difflineminus">-  }</span>
<a href="#l14.877"></a><span id="l14.877" class="difflineminus">-  finally {</span>
<a href="#l14.878"></a><span id="l14.878" class="difflineplus">+  } finally {</span>
<a href="#l14.879"></a><span id="l14.879">     editor.endTransaction();</span>
<a href="#l14.880"></a><span id="l14.880">   }</span>
<a href="#l14.881"></a><span id="l14.881"> }</span>
<a href="#l14.882"></a><span id="l14.882"> </span>
<a href="#l14.883"></a><span id="l14.883"> // C++ function isn't exposed to JS :-(</span>
<a href="#l14.884"></a><span id="l14.884" class="difflineminus">-function RemoveContainer(element)</span>
<a href="#l14.885"></a><span id="l14.885" class="difflineminus">-{</span>
<a href="#l14.886"></a><span id="l14.886" class="difflineplus">+function RemoveContainer(element) {</span>
<a href="#l14.887"></a><span id="l14.887">   var editor = GetCurrentEditor();</span>
<a href="#l14.888"></a><span id="l14.888">   editor.beginTransaction();</span>
<a href="#l14.889"></a><span id="l14.889"> </span>
<a href="#l14.890"></a><span id="l14.890">   try {</span>
<a href="#l14.891"></a><span id="l14.891">     var range = editor.document.createRange();</span>
<a href="#l14.892"></a><span id="l14.892">     var parent = element.parentNode;</span>
<a href="#l14.893"></a><span id="l14.893">     // Allow for automatic joining of text nodes</span>
<a href="#l14.894"></a><span id="l14.894">     // so we can't delete the container yet</span>
<a href="#l14.895"></a><span id="l14.895">     // so we need to copy the contained nodes</span>
<a href="#l14.896"></a><span id="l14.896">     for (var i = 0; i &lt; element.childNodes.length; i++) {</span>
<a href="#l14.897"></a><span id="l14.897">       range.selectNode(element);</span>
<a href="#l14.898"></a><span id="l14.898">       editor.insertNode(element.childNodes[i].cloneNode(true), parent, range.startOffset);</span>
<a href="#l14.899"></a><span id="l14.899">     }</span>
<a href="#l14.900"></a><span id="l14.900">     // Now remove the element</span>
<a href="#l14.901"></a><span id="l14.901">     editor.deleteNode(element);</span>
<a href="#l14.902"></a><span id="l14.902" class="difflineminus">-  }</span>
<a href="#l14.903"></a><span id="l14.903" class="difflineminus">-  finally {</span>
<a href="#l14.904"></a><span id="l14.904" class="difflineplus">+  } finally {</span>
<a href="#l14.905"></a><span id="l14.905">     editor.endTransaction();</span>
<a href="#l14.906"></a><span id="l14.906">   }</span>
<a href="#l14.907"></a><span id="l14.907"> }</span>
<a href="#l14.908"></a><span id="l14.908"> </span>
<a href="#l14.909"></a><span id="l14.909" class="difflineminus">-function FillLinkMenulist(linkMenulist, headingsArray)</span>
<a href="#l14.910"></a><span id="l14.910" class="difflineminus">-{</span>
<a href="#l14.911"></a><span id="l14.911" class="difflineplus">+function FillLinkMenulist(linkMenulist, headingsArray) {</span>
<a href="#l14.912"></a><span id="l14.912">   var menupopup = linkMenulist.firstChild;</span>
<a href="#l14.913"></a><span id="l14.913">   var editor = GetCurrentEditor();</span>
<a href="#l14.914"></a><span id="l14.914">   try {</span>
<a href="#l14.915"></a><span id="l14.915">     var treeWalker = editor.document.createTreeWalker(editor.document, 1, null, true);</span>
<a href="#l14.916"></a><span id="l14.916">     var headingList = [];</span>
<a href="#l14.917"></a><span id="l14.917">     var anchorList = []; // for sorting</span>
<a href="#l14.918"></a><span id="l14.918">     var anchorMap  = {}; // for weeding out duplicates and making heading anchors unique</span>
<a href="#l14.919"></a><span id="l14.919">     var anchor;</span>
<a href="#l14.920"></a><span id="l14.920">     var i;</span>
<a href="#l14.921"></a><span id="l14.921" class="difflineminus">-    for (var element = treeWalker.nextNode(); element; element = treeWalker.nextNode())</span>
<a href="#l14.922"></a><span id="l14.922" class="difflineminus">-    {</span>
<a href="#l14.923"></a><span id="l14.923" class="difflineplus">+    for (var element = treeWalker.nextNode(); element; element = treeWalker.nextNode()) {</span>
<a href="#l14.924"></a><span id="l14.924">       // grab headings</span>
<a href="#l14.925"></a><span id="l14.925">       // Skip headings that already have a named anchor as their first child</span>
<a href="#l14.926"></a><span id="l14.926">       //  (this may miss nearby anchors, but at least we don't insert another</span>
<a href="#l14.927"></a><span id="l14.927">       //   under the same heading)</span>
<a href="#l14.928"></a><span id="l14.928">       if (element instanceof HTMLHeadingElement &amp;&amp; element.textContent &amp;&amp;</span>
<a href="#l14.929"></a><span id="l14.929">           !(element.firstChild instanceof HTMLAnchorElement &amp;&amp; element.firstChild.name))</span>
<a href="#l14.930"></a><span id="l14.930">         headingList.push(element);</span>
<a href="#l14.931"></a><span id="l14.931"> </span>
<a href="#l14.932"></a><span id="l14.932">       // grab named anchors</span>
<a href="#l14.933"></a><span id="l14.933" class="difflineminus">-      if (element instanceof HTMLAnchorElement &amp;&amp; element.name)</span>
<a href="#l14.934"></a><span id="l14.934" class="difflineminus">-      {</span>
<a href="#l14.935"></a><span id="l14.935" class="difflineminus">-        anchor = '#' + element.name;</span>
<a href="#l14.936"></a><span id="l14.936" class="difflineminus">-        if (!(anchor in anchorMap))</span>
<a href="#l14.937"></a><span id="l14.937" class="difflineminus">-        {</span>
<a href="#l14.938"></a><span id="l14.938" class="difflineminus">-          anchorList.push({anchor: anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.939"></a><span id="l14.939" class="difflineplus">+      if (element instanceof HTMLAnchorElement &amp;&amp; element.name) {</span>
<a href="#l14.940"></a><span id="l14.940" class="difflineplus">+        anchor = &quot;#&quot; + element.name;</span>
<a href="#l14.941"></a><span id="l14.941" class="difflineplus">+        if (!(anchor in anchorMap)) {</span>
<a href="#l14.942"></a><span id="l14.942" class="difflineplus">+          anchorList.push({anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.943"></a><span id="l14.943">           anchorMap[anchor] = true;</span>
<a href="#l14.944"></a><span id="l14.944">         }</span>
<a href="#l14.945"></a><span id="l14.945">       }</span>
<a href="#l14.946"></a><span id="l14.946"> </span>
<a href="#l14.947"></a><span id="l14.947">       // grab IDs</span>
<a href="#l14.948"></a><span id="l14.948" class="difflineminus">-      if (element.id)</span>
<a href="#l14.949"></a><span id="l14.949" class="difflineminus">-      {</span>
<a href="#l14.950"></a><span id="l14.950" class="difflineminus">-        anchor = '#' + element.id;</span>
<a href="#l14.951"></a><span id="l14.951" class="difflineminus">-        if (!(anchor in anchorMap))</span>
<a href="#l14.952"></a><span id="l14.952" class="difflineminus">-        {</span>
<a href="#l14.953"></a><span id="l14.953" class="difflineminus">-          anchorList.push({anchor: anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.954"></a><span id="l14.954" class="difflineplus">+      if (element.id) {</span>
<a href="#l14.955"></a><span id="l14.955" class="difflineplus">+        anchor = &quot;#&quot; + element.id;</span>
<a href="#l14.956"></a><span id="l14.956" class="difflineplus">+        if (!(anchor in anchorMap)) {</span>
<a href="#l14.957"></a><span id="l14.957" class="difflineplus">+          anchorList.push({anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.958"></a><span id="l14.958">           anchorMap[anchor] = true;</span>
<a href="#l14.959"></a><span id="l14.959">         }</span>
<a href="#l14.960"></a><span id="l14.960">       }</span>
<a href="#l14.961"></a><span id="l14.961">     }</span>
<a href="#l14.962"></a><span id="l14.962">     // add anchor for headings</span>
<a href="#l14.963"></a><span id="l14.963" class="difflineminus">-    for (i = 0; i &lt; headingList.length; i++)</span>
<a href="#l14.964"></a><span id="l14.964" class="difflineminus">-    {</span>
<a href="#l14.965"></a><span id="l14.965" class="difflineplus">+    for (i = 0; i &lt; headingList.length; i++) {</span>
<a href="#l14.966"></a><span id="l14.966">       var heading = headingList[i];</span>
<a href="#l14.967"></a><span id="l14.967"> </span>
<a href="#l14.968"></a><span id="l14.968">       // Use just first 40 characters, don't add &quot;...&quot;,</span>
<a href="#l14.969"></a><span id="l14.969">       //  and replace whitespace with &quot;_&quot; and strip non-word characters</span>
<a href="#l14.970"></a><span id="l14.970" class="difflineminus">-      anchor = '#' + ConvertToCDATAString(TruncateStringAtWordEnd(heading.textContent, 40, false));</span>
<a href="#l14.971"></a><span id="l14.971" class="difflineplus">+      anchor = &quot;#&quot; + ConvertToCDATAString(TruncateStringAtWordEnd(heading.textContent, 40, false));</span>
<a href="#l14.972"></a><span id="l14.972"> </span>
<a href="#l14.973"></a><span id="l14.973">       // Append &quot;_&quot; to any name already in the list</span>
<a href="#l14.974"></a><span id="l14.974">       while (anchor in anchorMap)</span>
<a href="#l14.975"></a><span id="l14.975">         anchor += &quot;_&quot;;</span>
<a href="#l14.976"></a><span id="l14.976" class="difflineminus">-      anchorList.push({anchor: anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.977"></a><span id="l14.977" class="difflineplus">+      anchorList.push({anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.978"></a><span id="l14.978">       anchorMap[anchor] = true;</span>
<a href="#l14.979"></a><span id="l14.979"> </span>
<a href="#l14.980"></a><span id="l14.980">       // Save nodes in an array so we can create anchor node under it later</span>
<a href="#l14.981"></a><span id="l14.981">       headingsArray[anchor] = heading;</span>
<a href="#l14.982"></a><span id="l14.982">     }</span>
<a href="#l14.983"></a><span id="l14.983" class="difflineminus">-    if (anchorList.length)</span>
<a href="#l14.984"></a><span id="l14.984" class="difflineminus">-    {</span>
<a href="#l14.985"></a><span id="l14.985" class="difflineplus">+    if (anchorList.length) {</span>
<a href="#l14.986"></a><span id="l14.986">       // case insensitive sort</span>
<a href="#l14.987"></a><span id="l14.987">       anchorList.sort(function compare(a, b) {</span>
<a href="#l14.988"></a><span id="l14.988">         if (a.sortkey &lt; b.sortkey) return -1;</span>
<a href="#l14.989"></a><span id="l14.989">         if (a.sortkey &gt; b.sortkey) return 1;</span>
<a href="#l14.990"></a><span id="l14.990">         return 0;</span>
<a href="#l14.991"></a><span id="l14.991">       });</span>
<a href="#l14.992"></a><span id="l14.992"> </span>
<a href="#l14.993"></a><span id="l14.993">       for (i = 0; i &lt; anchorList.length; i++)</span>
<a href="#l14.994"></a><span id="l14.994" class="difflineminus">-        createMenuItem(menupopup,anchorList[i].anchor);</span>
<a href="#l14.995"></a><span id="l14.995" class="difflineminus">-    }</span>
<a href="#l14.996"></a><span id="l14.996" class="difflineminus">-    else</span>
<a href="#l14.997"></a><span id="l14.997" class="difflineminus">-    {</span>
<a href="#l14.998"></a><span id="l14.998" class="difflineplus">+        createMenuItem(menupopup, anchorList[i].anchor);</span>
<a href="#l14.999"></a><span id="l14.999" class="difflineplus">+    } else {</span>
<a href="#l14.1000"></a><span id="l14.1000">       // Don't bother with named anchors in Mail.</span>
<a href="#l14.1001"></a><span id="l14.1001" class="difflineminus">-      if (editor &amp;&amp; (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask))</span>
<a href="#l14.1002"></a><span id="l14.1002" class="difflineminus">-      {</span>
<a href="#l14.1003"></a><span id="l14.1003" class="difflineplus">+      if (editor &amp;&amp; (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)) {</span>
<a href="#l14.1004"></a><span id="l14.1004">         menupopup.remove();</span>
<a href="#l14.1005"></a><span id="l14.1005">         linkMenulist.removeAttribute(&quot;enablehistory&quot;);</span>
<a href="#l14.1006"></a><span id="l14.1006">         return;</span>
<a href="#l14.1007"></a><span id="l14.1007">       }</span>
<a href="#l14.1008"></a><span id="l14.1008">       var item = createMenuItem(menupopup, GetString(&quot;NoNamedAnchorsOrHeadings&quot;));</span>
<a href="#l14.1009"></a><span id="l14.1009">       item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l14.1010"></a><span id="l14.1010">     }</span>
<a href="#l14.1011"></a><span id="l14.1011">   } catch (e) {}</span>
<a href="#l14.1012"></a><span id="l14.1012"> }</span>
<a href="#l14.1013"></a><span id="l14.1013"> </span>
<a href="#l14.1014"></a><span id="l14.1014" class="difflineminus">-function createMenuItem(aMenuPopup, aLabel)</span>
<a href="#l14.1015"></a><span id="l14.1015" class="difflineminus">-{</span>
<a href="#l14.1016"></a><span id="l14.1016" class="difflineplus">+function createMenuItem(aMenuPopup, aLabel) {</span>
<a href="#l14.1017"></a><span id="l14.1017">   var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l14.1018"></a><span id="l14.1018">   menuitem.setAttribute(&quot;label&quot;, aLabel);</span>
<a href="#l14.1019"></a><span id="l14.1019">   aMenuPopup.appendChild(menuitem);</span>
<a href="#l14.1020"></a><span id="l14.1020">   return menuitem;</span>
<a href="#l14.1021"></a><span id="l14.1021"> }</span>
<a href="#l14.1022"></a><span id="l14.1022"> </span>
<a href="#l14.1023"></a><span id="l14.1023"> // Shared by Image and Link dialogs for the &quot;Choose&quot; button for links</span>
<a href="#l14.1024"></a><span id="l14.1024" class="difflineminus">-function chooseLinkFile()</span>
<a href="#l14.1025"></a><span id="l14.1025" class="difflineminus">-{</span>
<a href="#l14.1026"></a><span id="l14.1026" class="difflineplus">+function chooseLinkFile() {</span>
<a href="#l14.1027"></a><span id="l14.1027">   GetLocalFileURL(&quot;html, img&quot;).then(fileURL =&gt; {</span>
<a href="#l14.1028"></a><span id="l14.1028">     // Always try to relativize local file URLs</span>
<a href="#l14.1029"></a><span id="l14.1029">     if (gHaveDocumentUrl)</span>
<a href="#l14.1030"></a><span id="l14.1030">       fileURL = MakeRelativeUrl(fileURL);</span>
<a href="#l14.1031"></a><span id="l14.1031"> </span>
<a href="#l14.1032"></a><span id="l14.1032">     gDialog.hrefInput.value = fileURL;</span>
<a href="#l14.1033"></a><span id="l14.1033"> </span>
<a href="#l14.1034"></a><span id="l14.1034">     // Do stuff specific to a particular dialog</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdDialogTemplate.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdDialogTemplate.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,47 +1,43 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-//Cancel() is in EdDialogCommon.js</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+// Cancel() is in EdDialogCommon.js</span>
<a href="#l15.11"></a><span id="l15.11"> var insertNew = true;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-var tagname = &quot;TAG NAME&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+var tagname = &quot;TAG NAME&quot;;</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> // dialog initialization code</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l15.18"></a><span id="l15.18"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-function Startup()</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-{</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-  if (!GetCurrentEditor())</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-  {</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+function Startup() {</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+  if (!GetCurrentEditor()) {</span>
<a href="#l15.26"></a><span id="l15.26">     window.close();</span>
<a href="#l15.27"></a><span id="l15.27">     return;</span>
<a href="#l15.28"></a><span id="l15.28">   }</span>
<a href="#l15.29"></a><span id="l15.29">   // gDialog is declared in EdDialogCommon.js</span>
<a href="#l15.30"></a><span id="l15.30">   // Set commonly-used widgets like this:</span>
<a href="#l15.31"></a><span id="l15.31">   gDialog.fooButton = document.getElementById(&quot;fooButton&quot;);</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33">   initDialog();</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">   // Set window location relative to parent window (based on persisted attributes)</span>
<a href="#l15.36"></a><span id="l15.36">   SetWindowLocation();</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">   // Set focus to first widget in dialog, e.g.:</span>
<a href="#l15.39"></a><span id="l15.39">   SetTextboxFocus(gDialog.fooButton);</span>
<a href="#l15.40"></a><span id="l15.40"> }</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-function InitDialog()</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-{</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+function InitDialog() {</span>
<a href="#l15.45"></a><span id="l15.45">   // Initialize all dialog widgets here,</span>
<a href="#l15.46"></a><span id="l15.46">   // e.g., get attributes from an element for property dialog</span>
<a href="#l15.47"></a><span id="l15.47"> }</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-function onAccept()</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-{</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+function onAccept() {</span>
<a href="#l15.52"></a><span id="l15.52">   // Validate all user data and set attributes and possibly insert new element here</span>
<a href="#l15.53"></a><span id="l15.53">   // If there's an error the user must correct, return false to keep dialog open.</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55">   SaveWindowLocation();</span>
<a href="#l15.56"></a><span id="l15.56"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdDictionary.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdDictionary.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,29 +1,26 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l16.5"></a><span id="l16.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> var gSpellChecker;</span>
<a href="#l16.10"></a><span id="l16.10"> var gWordToAdd;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-function Startup()</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-{</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-  if (!GetCurrentEditor())</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-  {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+function Startup() {</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  if (!GetCurrentEditor()) {</span>
<a href="#l16.18"></a><span id="l16.18">     window.close();</span>
<a href="#l16.19"></a><span id="l16.19">     return;</span>
<a href="#l16.20"></a><span id="l16.20">   }</span>
<a href="#l16.21"></a><span id="l16.21">   // Get the SpellChecker shell</span>
<a href="#l16.22"></a><span id="l16.22">   if (&quot;gSpellChecker&quot; in window.opener &amp;&amp; window.opener.gSpellChecker)</span>
<a href="#l16.23"></a><span id="l16.23">     gSpellChecker = window.opener.gSpellChecker;</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-  if (!gSpellChecker)</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-  {</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+  if (!gSpellChecker) {</span>
<a href="#l16.28"></a><span id="l16.28">     dump(&quot;SpellChecker not found!!!\n&quot;);</span>
<a href="#l16.29"></a><span id="l16.29">     window.close();</span>
<a href="#l16.30"></a><span id="l16.30">     return;</span>
<a href="#l16.31"></a><span id="l16.31">   }</span>
<a href="#l16.32"></a><span id="l16.32">   // The word to add word is passed as the 2nd extra parameter in window.openDialog()</span>
<a href="#l16.33"></a><span id="l16.33">   gWordToAdd = window.arguments[1];</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35">   gDialog.WordInput = document.getElementById(&quot;WordInput&quot;);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineat">@@ -32,67 +29,54 @@ function Startup()</span>
<a href="#l16.37"></a><span id="l16.37">   gDialog.WordInput.value = gWordToAdd;</span>
<a href="#l16.38"></a><span id="l16.38">   FillDictionaryList();</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40">   // Select the supplied word if it is already in the list</span>
<a href="#l16.41"></a><span id="l16.41">   SelectWordToAddInList();</span>
<a href="#l16.42"></a><span id="l16.42">   SetTextboxFocus(gDialog.WordInput);</span>
<a href="#l16.43"></a><span id="l16.43"> }</span>
<a href="#l16.44"></a><span id="l16.44"> </span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-function ValidateWordToAdd()</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-{</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+function ValidateWordToAdd() {</span>
<a href="#l16.48"></a><span id="l16.48">   gWordToAdd = TrimString(gDialog.WordInput.value);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  if (gWordToAdd.length &gt; 0)</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  if (gWordToAdd.length &gt; 0) {</span>
<a href="#l16.52"></a><span id="l16.52">     return true;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-  } else {</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  }</span>
<a href="#l16.55"></a><span id="l16.55">     return false;</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-  }</span>
<a href="#l16.57"></a><span id="l16.57"> }</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-function SelectWordToAddInList()</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-{</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-  for (var i = 0; i &lt; gDialog.DictionaryList.getRowCount(); i++)</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-  {</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+function SelectWordToAddInList() {</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+  for (var i = 0; i &lt; gDialog.DictionaryList.getRowCount(); i++) {</span>
<a href="#l16.66"></a><span id="l16.66">     var wordInList = gDialog.DictionaryList.getItemAtIndex(i);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-    if (wordInList &amp;&amp; gWordToAdd == wordInList.label)</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-    {</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+    if (wordInList &amp;&amp; gWordToAdd == wordInList.label) {</span>
<a href="#l16.70"></a><span id="l16.70">       gDialog.DictionaryList.selectedIndex = i;</span>
<a href="#l16.71"></a><span id="l16.71">       break;</span>
<a href="#l16.72"></a><span id="l16.72">     }</span>
<a href="#l16.73"></a><span id="l16.73">   }</span>
<a href="#l16.74"></a><span id="l16.74"> }</span>
<a href="#l16.75"></a><span id="l16.75"> </span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-function AddWord()</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-{</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-  if (ValidateWordToAdd())</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-  {</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+function AddWord() {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+  if (ValidateWordToAdd()) {</span>
<a href="#l16.82"></a><span id="l16.82">     try {</span>
<a href="#l16.83"></a><span id="l16.83">       gSpellChecker.AddWordToDictionary(gWordToAdd);</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-    }</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-    catch (e) {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+    } catch (e) {</span>
<a href="#l16.87"></a><span id="l16.87">       dump(&quot;Exception occurred in gSpellChecker.AddWordToDictionary\nWord to add probably already existed\n&quot;);</span>
<a href="#l16.88"></a><span id="l16.88">     }</span>
<a href="#l16.89"></a><span id="l16.89"> </span>
<a href="#l16.90"></a><span id="l16.90">     // Rebuild the dialog list</span>
<a href="#l16.91"></a><span id="l16.91">     FillDictionaryList();</span>
<a href="#l16.92"></a><span id="l16.92"> </span>
<a href="#l16.93"></a><span id="l16.93">     SelectWordToAddInList();</span>
<a href="#l16.94"></a><span id="l16.94">     gDialog.WordInput.value = &quot;&quot;;</span>
<a href="#l16.95"></a><span id="l16.95">   }</span>
<a href="#l16.96"></a><span id="l16.96"> }</span>
<a href="#l16.97"></a><span id="l16.97"> </span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-function ReplaceWord()</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-{</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-  if (ValidateWordToAdd())</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-  {</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+function ReplaceWord() {</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+  if (ValidateWordToAdd()) {</span>
<a href="#l16.104"></a><span id="l16.104">     var selItem = gDialog.DictionaryList.selectedItem;</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-    if (selItem)</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-    {</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    if (selItem) {</span>
<a href="#l16.108"></a><span id="l16.108">       try {</span>
<a href="#l16.109"></a><span id="l16.109">         gSpellChecker.RemoveWordFromDictionary(selItem.label);</span>
<a href="#l16.110"></a><span id="l16.110">       } catch (e) {}</span>
<a href="#l16.111"></a><span id="l16.111"> </span>
<a href="#l16.112"></a><span id="l16.112">       try {</span>
<a href="#l16.113"></a><span id="l16.113">         // Add to the dictionary list</span>
<a href="#l16.114"></a><span id="l16.114">         gSpellChecker.AddWordToDictionary(gWordToAdd);</span>
<a href="#l16.115"></a><span id="l16.115"> </span>
<a href="#l16.116"></a><span id="l16.116" class="difflineat">@@ -104,72 +88,65 @@ function ReplaceWord()</span>
<a href="#l16.117"></a><span id="l16.117">         dump(&quot;Exception occurred adding word in ReplaceWord\n&quot;);</span>
<a href="#l16.118"></a><span id="l16.118">         FillDictionaryList();</span>
<a href="#l16.119"></a><span id="l16.119">         SelectWordToAddInList();</span>
<a href="#l16.120"></a><span id="l16.120">       }</span>
<a href="#l16.121"></a><span id="l16.121">     }</span>
<a href="#l16.122"></a><span id="l16.122">   }</span>
<a href="#l16.123"></a><span id="l16.123"> }</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-function RemoveWord()</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-{</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+function RemoveWord() {</span>
<a href="#l16.128"></a><span id="l16.128">   var selIndex = gDialog.DictionaryList.selectedIndex;</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-  if (selIndex &gt;= 0)</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-  {</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+  if (selIndex &gt;= 0) {</span>
<a href="#l16.132"></a><span id="l16.132">     var word = gDialog.DictionaryList.selectedItem.label;</span>
<a href="#l16.133"></a><span id="l16.133"> </span>
<a href="#l16.134"></a><span id="l16.134">     // Remove word from list</span>
<a href="#l16.135"></a><span id="l16.135">     gDialog.DictionaryList.selectedItem.remove();</span>
<a href="#l16.136"></a><span id="l16.136"> </span>
<a href="#l16.137"></a><span id="l16.137">     // Remove from dictionary</span>
<a href="#l16.138"></a><span id="l16.138">     try {</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-      //Not working: BUG 43348</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+      // Not working: BUG 43348</span>
<a href="#l16.141"></a><span id="l16.141">       gSpellChecker.RemoveWordFromDictionary(word);</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-    }</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-    catch (e)</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-    {</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+    } catch (e) {</span>
<a href="#l16.146"></a><span id="l16.146">       dump(&quot;Failed to remove word from dictionary\n&quot;);</span>
<a href="#l16.147"></a><span id="l16.147">     }</span>
<a href="#l16.148"></a><span id="l16.148"> </span>
<a href="#l16.149"></a><span id="l16.149">     ResetSelectedItem(selIndex);</span>
<a href="#l16.150"></a><span id="l16.150">   }</span>
<a href="#l16.151"></a><span id="l16.151"> }</span>
<a href="#l16.152"></a><span id="l16.152"> </span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-function FillDictionaryList()</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-{</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+function FillDictionaryList() {</span>
<a href="#l16.156"></a><span id="l16.156">   var selIndex = gDialog.DictionaryList.selectedIndex;</span>
<a href="#l16.157"></a><span id="l16.157"> </span>
<a href="#l16.158"></a><span id="l16.158">   // Clear the current contents of the list</span>
<a href="#l16.159"></a><span id="l16.159">   ClearListbox(gDialog.DictionaryList);</span>
<a href="#l16.160"></a><span id="l16.160"> </span>
<a href="#l16.161"></a><span id="l16.161">   // Get the list from the spell checker</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-  gSpellChecker.GetPersonalDictionary()</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+  gSpellChecker.GetPersonalDictionary();</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165">   var haveList = false;</span>
<a href="#l16.166"></a><span id="l16.166"> </span>
<a href="#l16.167"></a><span id="l16.167">   // Get words until an empty string is returned</span>
<a href="#l16.168"></a><span id="l16.168">   do {</span>
<a href="#l16.169"></a><span id="l16.169">     var word = gSpellChecker.GetPersonalDictionaryWord();</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-    if (word != &quot;&quot;)</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-    {</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+    if (word != &quot;&quot;) {</span>
<a href="#l16.173"></a><span id="l16.173">       gDialog.DictionaryList.appendItem(word, &quot;&quot;);</span>
<a href="#l16.174"></a><span id="l16.174">       haveList = true;</span>
<a href="#l16.175"></a><span id="l16.175">     }</span>
<a href="#l16.176"></a><span id="l16.176">   } while (word != &quot;&quot;);</span>
<a href="#l16.177"></a><span id="l16.177"> </span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-  //XXX: BUG 74467: If list is empty, it doesn't layout to full height correctly</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+  // XXX: BUG 74467: If list is empty, it doesn't layout to full height correctly</span>
<a href="#l16.180"></a><span id="l16.180">   //     (ignores &quot;rows&quot; attribute) (bug is latered, so we are fixing here for now)</span>
<a href="#l16.181"></a><span id="l16.181">   if (!haveList)</span>
<a href="#l16.182"></a><span id="l16.182">       gDialog.DictionaryList.appendItem(&quot;&quot;, &quot;&quot;);</span>
<a href="#l16.183"></a><span id="l16.183"> </span>
<a href="#l16.184"></a><span id="l16.184">   ResetSelectedItem(selIndex);</span>
<a href="#l16.185"></a><span id="l16.185"> }</span>
<a href="#l16.186"></a><span id="l16.186"> </span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-function ResetSelectedItem(index)</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineminus">-{</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+function ResetSelectedItem(index) {</span>
<a href="#l16.190"></a><span id="l16.190">   var lastIndex = gDialog.DictionaryList.getRowCount() - 1;</span>
<a href="#l16.191"></a><span id="l16.191">   if (index &gt; lastIndex)</span>
<a href="#l16.192"></a><span id="l16.192">     index = lastIndex;</span>
<a href="#l16.193"></a><span id="l16.193"> </span>
<a href="#l16.194"></a><span id="l16.194">   // If we didn't have a selected item,</span>
<a href="#l16.195"></a><span id="l16.195">   //  set it to the first item</span>
<a href="#l16.196"></a><span id="l16.196">   if (index == -1 &amp;&amp; lastIndex &gt;= 0)</span>
<a href="#l16.197"></a><span id="l16.197">     index = 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdFieldSetProps.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdFieldSetProps.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -7,21 +7,19 @@ var fieldsetElement;</span>
<a href="#l17.4"></a><span id="l17.4"> var newLegend;</span>
<a href="#l17.5"></a><span id="l17.5"> var legendElement;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> // dialog initialization code</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l17.10"></a><span id="l17.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-function Startup()</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-{</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+function Startup() {</span>
<a href="#l17.15"></a><span id="l17.15">   var editor = GetCurrentEditor();</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-  if (!editor)</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-  {</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l17.19"></a><span id="l17.19">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l17.20"></a><span id="l17.20">     window.close();</span>
<a href="#l17.21"></a><span id="l17.21">     return;</span>
<a href="#l17.22"></a><span id="l17.22">   }</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">   gDialog.editText = document.getElementById(&quot;EditText&quot;);</span>
<a href="#l17.25"></a><span id="l17.25">   gDialog.legendText = document.getElementById(&quot;LegendText&quot;);</span>
<a href="#l17.26"></a><span id="l17.26">   gDialog.legendAlign = document.getElementById(&quot;LegendAlign&quot;);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineat">@@ -36,148 +34,129 @@ function Startup()</span>
<a href="#l17.28"></a><span id="l17.28">       fieldsetElement = editor.getElementOrParentByTagName(kTagName, editor.selection.anchorNode);</span>
<a href="#l17.29"></a><span id="l17.29">     if (!fieldsetElement)</span>
<a href="#l17.30"></a><span id="l17.30">       fieldsetElement = editor.getElementOrParentByTagName(kTagName, editor.selection.focusNode);</span>
<a href="#l17.31"></a><span id="l17.31">   } catch (e) {}</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33">   if (fieldsetElement)</span>
<a href="#l17.34"></a><span id="l17.34">     // We found an element and don't need to insert one</span>
<a href="#l17.35"></a><span id="l17.35">     insertNew = false;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-  else</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-  {</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  else {</span>
<a href="#l17.39"></a><span id="l17.39">     insertNew = true;</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41">     // We don't have an element selected,</span>
<a href="#l17.42"></a><span id="l17.42">     //  so create one with default attributes</span>
<a href="#l17.43"></a><span id="l17.43">     try {</span>
<a href="#l17.44"></a><span id="l17.44">       fieldsetElement = editor.createElementWithDefaults(kTagName);</span>
<a href="#l17.45"></a><span id="l17.45">     } catch (e) {}</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-    if (!fieldsetElement)</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-    {</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+    if (!fieldsetElement) {</span>
<a href="#l17.50"></a><span id="l17.50">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l17.51"></a><span id="l17.51">       window.close();</span>
<a href="#l17.52"></a><span id="l17.52">       return;</span>
<a href="#l17.53"></a><span id="l17.53">     }</span>
<a href="#l17.54"></a><span id="l17.54">     // Hide button removing existing fieldset</span>
<a href="#l17.55"></a><span id="l17.55">     gDialog.RemoveFieldSet.hidden = true;</span>
<a href="#l17.56"></a><span id="l17.56">   }</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58">   legendElement = fieldsetElement.querySelector(&quot;legend&quot;);</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-  if (legendElement)</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-  {</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+  if (legendElement) {</span>
<a href="#l17.62"></a><span id="l17.62">     newLegend = false;</span>
<a href="#l17.63"></a><span id="l17.63">     var range = editor.document.createRange();</span>
<a href="#l17.64"></a><span id="l17.64">     range.selectNode(legendElement);</span>
<a href="#l17.65"></a><span id="l17.65">     gDialog.legendText.value = range.toString();</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-    if (legendElement.innerHTML.includes(&quot;&lt;&quot;))</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-    {</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+    if (legendElement.innerHTML.includes(&quot;&lt;&quot;)) {</span>
<a href="#l17.69"></a><span id="l17.69">       gDialog.editText.checked = false;</span>
<a href="#l17.70"></a><span id="l17.70">       gDialog.editText.disabled = false;</span>
<a href="#l17.71"></a><span id="l17.71">       gDialog.legendText.disabled = true;</span>
<a href="#l17.72"></a><span id="l17.72">       gDialog.editText.addEventListener(&quot;command&quot;,</span>
<a href="#l17.73"></a><span id="l17.73">         () =&gt; Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;EditTextWarning&quot;)),</span>
<a href="#l17.74"></a><span id="l17.74">         {capture: false, once: true});</span>
<a href="#l17.75"></a><span id="l17.75">       gDialog.RemoveFieldSet.focus();</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-    }</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-    else</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+    } else</span>
<a href="#l17.79"></a><span id="l17.79">       SetTextboxFocus(gDialog.legendText);</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-  }</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-  else</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-  {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+  } else {</span>
<a href="#l17.84"></a><span id="l17.84">     newLegend = true;</span>
<a href="#l17.85"></a><span id="l17.85"> </span>
<a href="#l17.86"></a><span id="l17.86">     // We don't have an element selected,</span>
<a href="#l17.87"></a><span id="l17.87">     //  so create one with default attributes</span>
<a href="#l17.88"></a><span id="l17.88"> </span>
<a href="#l17.89"></a><span id="l17.89">     legendElement = editor.createElementWithDefaults(&quot;legend&quot;);</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-    if (!legendElement)</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-    {</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    if (!legendElement) {</span>
<a href="#l17.93"></a><span id="l17.93">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l17.94"></a><span id="l17.94">       window.close();</span>
<a href="#l17.95"></a><span id="l17.95">       return;</span>
<a href="#l17.96"></a><span id="l17.96">     }</span>
<a href="#l17.97"></a><span id="l17.97">     SetTextboxFocus(gDialog.legendText);</span>
<a href="#l17.98"></a><span id="l17.98">   }</span>
<a href="#l17.99"></a><span id="l17.99"> </span>
<a href="#l17.100"></a><span id="l17.100">   // Make a copy to use for AdvancedEdit</span>
<a href="#l17.101"></a><span id="l17.101">   globalElement = legendElement.cloneNode(false);</span>
<a href="#l17.102"></a><span id="l17.102"> </span>
<a href="#l17.103"></a><span id="l17.103">   InitDialog();</span>
<a href="#l17.104"></a><span id="l17.104"> </span>
<a href="#l17.105"></a><span id="l17.105">   SetWindowLocation();</span>
<a href="#l17.106"></a><span id="l17.106"> }</span>
<a href="#l17.107"></a><span id="l17.107"> </span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-function InitDialog()</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-{</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+function InitDialog() {</span>
<a href="#l17.111"></a><span id="l17.111">   gDialog.legendAlign.value = GetHTMLOrCSSStyleValue(globalElement, &quot;align&quot;, &quot;caption-side&quot;);</span>
<a href="#l17.112"></a><span id="l17.112"> }</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-function RemoveFieldSet()</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-{</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+function RemoveFieldSet() {</span>
<a href="#l17.117"></a><span id="l17.117">   var editor = GetCurrentEditor();</span>
<a href="#l17.118"></a><span id="l17.118">   editor.beginTransaction();</span>
<a href="#l17.119"></a><span id="l17.119">   try {</span>
<a href="#l17.120"></a><span id="l17.120">     if (!newLegend)</span>
<a href="#l17.121"></a><span id="l17.121">       editor.deleteNode(legendElement);</span>
<a href="#l17.122"></a><span id="l17.122">     RemoveBlockContainer(fieldsetElement);</span>
<a href="#l17.123"></a><span id="l17.123">   } finally {</span>
<a href="#l17.124"></a><span id="l17.124">     editor.endTransaction();</span>
<a href="#l17.125"></a><span id="l17.125">   }</span>
<a href="#l17.126"></a><span id="l17.126">   SaveWindowLocation();</span>
<a href="#l17.127"></a><span id="l17.127">   window.close();</span>
<a href="#l17.128"></a><span id="l17.128"> }</span>
<a href="#l17.129"></a><span id="l17.129"> </span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-function ValidateData()</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-{</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+function ValidateData() {</span>
<a href="#l17.133"></a><span id="l17.133">   if (gDialog.legendAlign.value)</span>
<a href="#l17.134"></a><span id="l17.134">     globalElement.setAttribute(&quot;align&quot;, gDialog.legendAlign.value);</span>
<a href="#l17.135"></a><span id="l17.135">   else</span>
<a href="#l17.136"></a><span id="l17.136">     globalElement.removeAttribute(&quot;align&quot;);</span>
<a href="#l17.137"></a><span id="l17.137">   return true;</span>
<a href="#l17.138"></a><span id="l17.138"> }</span>
<a href="#l17.139"></a><span id="l17.139"> </span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-function onAccept()</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-{</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+function onAccept() {</span>
<a href="#l17.143"></a><span id="l17.143">   // All values are valid - copy to actual element in doc</span>
<a href="#l17.144"></a><span id="l17.144">   ValidateData();</span>
<a href="#l17.145"></a><span id="l17.145"> </span>
<a href="#l17.146"></a><span id="l17.146">   var editor = GetCurrentEditor();</span>
<a href="#l17.147"></a><span id="l17.147"> </span>
<a href="#l17.148"></a><span id="l17.148">   editor.beginTransaction();</span>
<a href="#l17.149"></a><span id="l17.149"> </span>
<a href="#l17.150"></a><span id="l17.150">   try {</span>
<a href="#l17.151"></a><span id="l17.151">     editor.cloneAttributes(legendElement, globalElement);</span>
<a href="#l17.152"></a><span id="l17.152"> </span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-    if (insertNew)</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-    {</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-      if (gDialog.legendText.value)</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-      {</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+    if (insertNew) {</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+      if (gDialog.legendText.value) {</span>
<a href="#l17.159"></a><span id="l17.159">         fieldsetElement.appendChild(legendElement);</span>
<a href="#l17.160"></a><span id="l17.160">         legendElement.appendChild(editor.document.createTextNode(gDialog.legendText.value));</span>
<a href="#l17.161"></a><span id="l17.161">       }</span>
<a href="#l17.162"></a><span id="l17.162">       InsertElementAroundSelection(fieldsetElement);</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-    }</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-    else if (gDialog.editText.checked)</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-    {</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+    } else if (gDialog.editText.checked) {</span>
<a href="#l17.167"></a><span id="l17.167">       editor.setShouldTxnSetSelection(false);</span>
<a href="#l17.168"></a><span id="l17.168"> </span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-      if (gDialog.legendText.value)</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-      {</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+      if (gDialog.legendText.value) {</span>
<a href="#l17.172"></a><span id="l17.172">         if (newLegend)</span>
<a href="#l17.173"></a><span id="l17.173">           editor.insertNode(legendElement, fieldsetElement, 0, true);</span>
<a href="#l17.174"></a><span id="l17.174">         else while (legendElement.firstChild)</span>
<a href="#l17.175"></a><span id="l17.175">           editor.deleteNode(legendElement.lastChild);</span>
<a href="#l17.176"></a><span id="l17.176">         editor.insertNode(editor.document.createTextNode(gDialog.legendText.value), legendElement, 0);</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-      }</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-      else if (!newLegend)</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+      } else if (!newLegend)</span>
<a href="#l17.180"></a><span id="l17.180">         editor.deleteNode(legendElement);</span>
<a href="#l17.181"></a><span id="l17.181"> </span>
<a href="#l17.182"></a><span id="l17.182">       editor.setShouldTxnSetSelection(true);</span>
<a href="#l17.183"></a><span id="l17.183">     }</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-  }</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-  finally {</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+  } finally {</span>
<a href="#l17.187"></a><span id="l17.187">     editor.endTransaction();</span>
<a href="#l17.188"></a><span id="l17.188">   }</span>
<a href="#l17.189"></a><span id="l17.189"> </span>
<a href="#l17.190"></a><span id="l17.190">   SaveWindowLocation();</span>
<a href="#l17.191"></a><span id="l17.191"> }</span>
<a href="#l17.192"></a><span id="l17.192"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdFormProps.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdFormProps.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -5,66 +5,60 @@</span>
<a href="#l18.4"></a><span id="l18.4"> var gForm;</span>
<a href="#l18.5"></a><span id="l18.5"> var insertNew;</span>
<a href="#l18.6"></a><span id="l18.6"> var formElement;</span>
<a href="#l18.7"></a><span id="l18.7"> var formActionWarning;</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l18.10"></a><span id="l18.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-function Startup()</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-{</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+function Startup() {</span>
<a href="#l18.15"></a><span id="l18.15">   var editor = GetCurrentEditor();</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-  if (!editor)</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  {</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l18.19"></a><span id="l18.19">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l18.20"></a><span id="l18.20">     window.close();</span>
<a href="#l18.21"></a><span id="l18.21">     return;</span>
<a href="#l18.22"></a><span id="l18.22">   }</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24">   gForm = {</span>
<a href="#l18.25"></a><span id="l18.25">     Name:     document.getElementById(&quot;FormName&quot;),</span>
<a href="#l18.26"></a><span id="l18.26">     Action:   document.getElementById(&quot;FormAction&quot;),</span>
<a href="#l18.27"></a><span id="l18.27">     Method:   document.getElementById(&quot;FormMethod&quot;),</span>
<a href="#l18.28"></a><span id="l18.28">     EncType:  document.getElementById(&quot;FormEncType&quot;),</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-    Target:   document.getElementById(&quot;FormTarget&quot;)</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-  }</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+    Target:   document.getElementById(&quot;FormTarget&quot;),</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  };</span>
<a href="#l18.33"></a><span id="l18.33">   gDialog.MoreSection = document.getElementById(&quot;MoreSection&quot;);</span>
<a href="#l18.34"></a><span id="l18.34">   gDialog.MoreFewerButton = document.getElementById(&quot;MoreFewerButton&quot;);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-  gDialog.RemoveForm = document.getElementById(&quot;RemoveForm&quot;)</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+  gDialog.RemoveForm = document.getElementById(&quot;RemoveForm&quot;);</span>
<a href="#l18.37"></a><span id="l18.37"> </span>
<a href="#l18.38"></a><span id="l18.38">   // Get a single selected form element</span>
<a href="#l18.39"></a><span id="l18.39">   const kTagName = &quot;form&quot;;</span>
<a href="#l18.40"></a><span id="l18.40">   try {</span>
<a href="#l18.41"></a><span id="l18.41">     formElement = editor.getSelectedElement(kTagName);</span>
<a href="#l18.42"></a><span id="l18.42">     if (!formElement)</span>
<a href="#l18.43"></a><span id="l18.43">       formElement = editor.getElementOrParentByTagName(kTagName, editor.selection.anchorNode);</span>
<a href="#l18.44"></a><span id="l18.44">     if (!formElement)</span>
<a href="#l18.45"></a><span id="l18.45">       formElement = editor.getElementOrParentByTagName(kTagName, editor.selection.focusNode);</span>
<a href="#l18.46"></a><span id="l18.46">   } catch (e) {}</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-  if (formElement)</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-  {</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+  if (formElement) {</span>
<a href="#l18.51"></a><span id="l18.51">     // We found an element and don't need to insert one</span>
<a href="#l18.52"></a><span id="l18.52">     insertNew = false;</span>
<a href="#l18.53"></a><span id="l18.53">     formActionWarning = formElement.hasAttribute(&quot;action&quot;);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-  }</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  else</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-  {</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  } else {</span>
<a href="#l18.58"></a><span id="l18.58">     insertNew = true;</span>
<a href="#l18.59"></a><span id="l18.59">     formActionWarning = true;</span>
<a href="#l18.60"></a><span id="l18.60"> </span>
<a href="#l18.61"></a><span id="l18.61">     // We don't have an element selected,</span>
<a href="#l18.62"></a><span id="l18.62">     //  so create one with default attributes</span>
<a href="#l18.63"></a><span id="l18.63">     try {</span>
<a href="#l18.64"></a><span id="l18.64">       formElement = editor.createElementWithDefaults(kTagName);</span>
<a href="#l18.65"></a><span id="l18.65">     } catch (e) {}</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-    if (!formElement)</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-    {</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    if (!formElement) {</span>
<a href="#l18.70"></a><span id="l18.70">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l18.71"></a><span id="l18.71">       window.close();</span>
<a href="#l18.72"></a><span id="l18.72">       return;</span>
<a href="#l18.73"></a><span id="l18.73">     }</span>
<a href="#l18.74"></a><span id="l18.74">     // Hide button removing existing form</span>
<a href="#l18.75"></a><span id="l18.75">     gDialog.RemoveForm.hidden = true;</span>
<a href="#l18.76"></a><span id="l18.76">   }</span>
<a href="#l18.77"></a><span id="l18.77"> </span>
<a href="#l18.78"></a><span id="l18.78" class="difflineat">@@ -75,45 +69,39 @@ function Startup()</span>
<a href="#l18.79"></a><span id="l18.79"> </span>
<a href="#l18.80"></a><span id="l18.80">   InitMoreFewer();</span>
<a href="#l18.81"></a><span id="l18.81"> </span>
<a href="#l18.82"></a><span id="l18.82">   SetTextboxFocus(gForm.Name);</span>
<a href="#l18.83"></a><span id="l18.83"> </span>
<a href="#l18.84"></a><span id="l18.84">   SetWindowLocation();</span>
<a href="#l18.85"></a><span id="l18.85"> }</span>
<a href="#l18.86"></a><span id="l18.86"> </span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-function InitDialog()</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-{</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+function InitDialog() {</span>
<a href="#l18.90"></a><span id="l18.90">   for (var attribute in gForm)</span>
<a href="#l18.91"></a><span id="l18.91">     gForm[attribute].value = globalElement.getAttribute(attribute);</span>
<a href="#l18.92"></a><span id="l18.92"> }</span>
<a href="#l18.93"></a><span id="l18.93"> </span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-function RemoveForm()</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-{</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+function RemoveForm() {</span>
<a href="#l18.97"></a><span id="l18.97">   RemoveBlockContainer(formElement);</span>
<a href="#l18.98"></a><span id="l18.98">   SaveWindowLocation();</span>
<a href="#l18.99"></a><span id="l18.99">   window.close();</span>
<a href="#l18.100"></a><span id="l18.100"> }</span>
<a href="#l18.101"></a><span id="l18.101"> </span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-function ValidateData()</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-{</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-  for (var attribute in gForm)</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-  {</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+function ValidateData() {</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+  for (var attribute in gForm) {</span>
<a href="#l18.108"></a><span id="l18.108">     if (gForm[attribute].value)</span>
<a href="#l18.109"></a><span id="l18.109">       globalElement.setAttribute(attribute, gForm[attribute].value);</span>
<a href="#l18.110"></a><span id="l18.110">     else</span>
<a href="#l18.111"></a><span id="l18.111">       globalElement.removeAttribute(attribute);</span>
<a href="#l18.112"></a><span id="l18.112">   }</span>
<a href="#l18.113"></a><span id="l18.113">   return true;</span>
<a href="#l18.114"></a><span id="l18.114"> }</span>
<a href="#l18.115"></a><span id="l18.115"> </span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-function onAccept(event)</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-{</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-  if (formActionWarning &amp;&amp; !gForm.Action.value)</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-  {</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+function onAccept(event) {</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+  if (formActionWarning &amp;&amp; !gForm.Action.value) {</span>
<a href="#l18.122"></a><span id="l18.122">     Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;NoFormAction&quot;));</span>
<a href="#l18.123"></a><span id="l18.123">     gForm.Action.focus();</span>
<a href="#l18.124"></a><span id="l18.124">     formActionWarning = false;</span>
<a href="#l18.125"></a><span id="l18.125">     event.preventDefault();</span>
<a href="#l18.126"></a><span id="l18.126">     return;</span>
<a href="#l18.127"></a><span id="l18.127">   }</span>
<a href="#l18.128"></a><span id="l18.128">   // All values are valid - copy to actual element in doc or</span>
<a href="#l18.129"></a><span id="l18.129">   //   element created to insert</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdHLineProps.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdHLineProps.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -10,21 +10,19 @@ var align;</span>
<a href="#l19.4"></a><span id="l19.4"> var shading;</span>
<a href="#l19.5"></a><span id="l19.5"> const gMaxHRSize = 1000; // This is hard-coded in nsHTMLHRElement::StringToAttribute()</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> // dialog initialization code</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l19.10"></a><span id="l19.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-function Startup()</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-{</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+function Startup() {</span>
<a href="#l19.15"></a><span id="l19.15">   var editor = GetCurrentEditor();</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-  if (!editor)</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-  {</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l19.19"></a><span id="l19.19">     window.close();</span>
<a href="#l19.20"></a><span id="l19.20">     return;</span>
<a href="#l19.21"></a><span id="l19.21">   }</span>
<a href="#l19.22"></a><span id="l19.22">   try {</span>
<a href="#l19.23"></a><span id="l19.23">     // Get the selected horizontal line</span>
<a href="#l19.24"></a><span id="l19.24">     gHLineElement = editor.getSelectedElement(tagName);</span>
<a href="#l19.25"></a><span id="l19.25">   } catch (e) {}</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27" class="difflineat">@@ -41,71 +39,67 @@ function Startup()</span>
<a href="#l19.28"></a><span id="l19.28">   gDialog.alignGroup = gDialog.rightAlign.radioGroup;</span>
<a href="#l19.29"></a><span id="l19.29">   gDialog.shading = document.getElementById(&quot;3dShading&quot;);</span>
<a href="#l19.30"></a><span id="l19.30">   gDialog.pixelOrPercentMenulist = document.getElementById(&quot;pixelOrPercentMenulist&quot;);</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32">   // Make a copy to use for AdvancedEdit and onSaveDefault</span>
<a href="#l19.33"></a><span id="l19.33">   globalElement = gHLineElement.cloneNode(false);</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35">   // Initialize control values based on existing attributes</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-  InitDialog()</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+  InitDialog();</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39">   // SET FOCUS TO FIRST CONTROL</span>
<a href="#l19.40"></a><span id="l19.40">   SetTextboxFocus(gDialog.widthInput);</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42">   // Resize window</span>
<a href="#l19.43"></a><span id="l19.43">   window.sizeToContent();</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">   SetWindowLocation();</span>
<a href="#l19.46"></a><span id="l19.46"> }</span>
<a href="#l19.47"></a><span id="l19.47"> </span>
<a href="#l19.48"></a><span id="l19.48"> // Set dialog widgets with attribute data</span>
<a href="#l19.49"></a><span id="l19.49"> // We get them from globalElement copy so this can be used</span>
<a href="#l19.50"></a><span id="l19.50"> //   by AdvancedEdit(), which is shared by all property dialogs</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-function InitDialog()</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-{</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+function InitDialog() {</span>
<a href="#l19.54"></a><span id="l19.54">   // Just to be confusing, &quot;size&quot; is used instead of height because it does</span>
<a href="#l19.55"></a><span id="l19.55">   // not accept % values, only pixels</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-  var height = GetHTMLOrCSSStyleValue(globalElement, &quot;size&quot;, &quot;height&quot;)</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+  var height = GetHTMLOrCSSStyleValue(globalElement, &quot;size&quot;, &quot;height&quot;);</span>
<a href="#l19.58"></a><span id="l19.58">   if (height.includes(&quot;px&quot;)) {</span>
<a href="#l19.59"></a><span id="l19.59">     height = height.substr(0, height.indexOf(&quot;px&quot;));</span>
<a href="#l19.60"></a><span id="l19.60">   }</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-  if(!height) {</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-    height = 2; //Default value</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+  if (!height) {</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+    height = 2; // Default value</span>
<a href="#l19.65"></a><span id="l19.65">   }</span>
<a href="#l19.66"></a><span id="l19.66"> </span>
<a href="#l19.67"></a><span id="l19.67">   // We will use &quot;height&quot; here and in UI</span>
<a href="#l19.68"></a><span id="l19.68">   gDialog.heightInput.value = height;</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70">   // Get the width attribute of the element, stripping out &quot;%&quot;</span>
<a href="#l19.71"></a><span id="l19.71">   // This sets contents of menulist (adds pixel and percent menuitems elements)</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-  gDialog.widthInput.value = InitPixelOrPercentMenulist(globalElement, gHLineElement, &quot;width&quot;,&quot;pixelOrPercentMenulist&quot;);</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+  gDialog.widthInput.value = InitPixelOrPercentMenulist(globalElement, gHLineElement, &quot;width&quot;, &quot;pixelOrPercentMenulist&quot;);</span>
<a href="#l19.74"></a><span id="l19.74"> </span>
<a href="#l19.75"></a><span id="l19.75">   var marginLeft  = GetHTMLOrCSSStyleValue(globalElement, &quot;align&quot;, &quot;margin-left&quot;).toLowerCase();</span>
<a href="#l19.76"></a><span id="l19.76">   var marginRight = GetHTMLOrCSSStyleValue(globalElement, &quot;align&quot;, &quot;margin-right&quot;).toLowerCase();</span>
<a href="#l19.77"></a><span id="l19.77">   align = marginLeft + &quot; &quot; + marginRight;</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-  gDialog.leftAlign.checked   = (align == &quot;left left&quot;     || align == &quot;0px auto&quot;);</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+  gDialog.leftAlign.checked   = (align == &quot;left left&quot; || align == &quot;0px auto&quot;);</span>
<a href="#l19.80"></a><span id="l19.80">   gDialog.centerAlign.checked = (align == &quot;center center&quot; || align == &quot;auto auto&quot; || align == &quot; &quot;);</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-  gDialog.rightAlign.checked  = (align == &quot;right right&quot;   || align == &quot;auto 0px&quot;);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+  gDialog.rightAlign.checked  = (align == &quot;right right&quot; || align == &quot;auto 0px&quot;);</span>
<a href="#l19.83"></a><span id="l19.83"> </span>
<a href="#l19.84"></a><span id="l19.84">   if (gDialog.centerAlign.checked) {</span>
<a href="#l19.85"></a><span id="l19.85">     gDialog.alignGroup.selectedItem = gDialog.centerAlign;</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-  }</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-  else if (gDialog.rightAlign.checked) {</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+  } else if (gDialog.rightAlign.checked) {</span>
<a href="#l19.89"></a><span id="l19.89">     gDialog.alignGroup.selectedItem = gDialog.rightAlign;</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-  }</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-  else {</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+  } else {</span>
<a href="#l19.93"></a><span id="l19.93">     gDialog.alignGroup.selectedItem = gDialog.leftAlign;</span>
<a href="#l19.94"></a><span id="l19.94">   }</span>
<a href="#l19.95"></a><span id="l19.95"> </span>
<a href="#l19.96"></a><span id="l19.96">   gDialog.shading.checked = !globalElement.hasAttribute(&quot;noshade&quot;);</span>
<a href="#l19.97"></a><span id="l19.97"> }</span>
<a href="#l19.98"></a><span id="l19.98"> </span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-function onSaveDefault()</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-{</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+function onSaveDefault() {</span>
<a href="#l19.102"></a><span id="l19.102">   // &quot;false&quot; means set attributes on the globalElement,</span>
<a href="#l19.103"></a><span id="l19.103">   //   not the real element being edited</span>
<a href="#l19.104"></a><span id="l19.104">   if (ValidateData()) {</span>
<a href="#l19.105"></a><span id="l19.105">     var alignInt;</span>
<a href="#l19.106"></a><span id="l19.106">     if (align == &quot;left&quot;) {</span>
<a href="#l19.107"></a><span id="l19.107">       alignInt = 0;</span>
<a href="#l19.108"></a><span id="l19.108">     } else if (align == &quot;right&quot;) {</span>
<a href="#l19.109"></a><span id="l19.109">       alignInt = 2;</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineat">@@ -113,28 +107,25 @@ function onSaveDefault()</span>
<a href="#l19.111"></a><span id="l19.111">       alignInt = 1;</span>
<a href="#l19.112"></a><span id="l19.112">     }</span>
<a href="#l19.113"></a><span id="l19.113">     Services.prefs.setIntPref(&quot;editor.hrule.align&quot;, alignInt);</span>
<a href="#l19.114"></a><span id="l19.114"> </span>
<a href="#l19.115"></a><span id="l19.115">     var percent;</span>
<a href="#l19.116"></a><span id="l19.116">     var widthInt;</span>
<a href="#l19.117"></a><span id="l19.117">     var heightInt;</span>
<a href="#l19.118"></a><span id="l19.118"> </span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-    if (width)</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-    {</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+    if (width) {</span>
<a href="#l19.122"></a><span id="l19.122">       if (width.includes(&quot;%&quot;)) {</span>
<a href="#l19.123"></a><span id="l19.123">         percent = true;</span>
<a href="#l19.124"></a><span id="l19.124">         widthInt = Number(width.substr(0, width.indexOf(&quot;%&quot;)));</span>
<a href="#l19.125"></a><span id="l19.125">       } else {</span>
<a href="#l19.126"></a><span id="l19.126">         percent = false;</span>
<a href="#l19.127"></a><span id="l19.127">         widthInt = Number(width);</span>
<a href="#l19.128"></a><span id="l19.128">       }</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-    }</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-    else</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-    {</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+    } else {</span>
<a href="#l19.133"></a><span id="l19.133">       percent = true;</span>
<a href="#l19.134"></a><span id="l19.134">       widthInt = Number(100);</span>
<a href="#l19.135"></a><span id="l19.135">     }</span>
<a href="#l19.136"></a><span id="l19.136"> </span>
<a href="#l19.137"></a><span id="l19.137">     heightInt = height ? Number(height) : 2;</span>
<a href="#l19.138"></a><span id="l19.138"> </span>
<a href="#l19.139"></a><span id="l19.139">     Services.prefs.setIntPref(&quot;editor.hrule.width&quot;, widthInt);</span>
<a href="#l19.140"></a><span id="l19.140">     Services.prefs.setBoolPref(&quot;editor.hrule.width_percent&quot;, percent);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineat">@@ -143,18 +134,17 @@ function onSaveDefault()</span>
<a href="#l19.142"></a><span id="l19.142"> </span>
<a href="#l19.143"></a><span id="l19.143">     // Write the prefs out NOW!</span>
<a href="#l19.144"></a><span id="l19.144">     Services.prefs.savePrefFile(null);</span>
<a href="#l19.145"></a><span id="l19.145">   }</span>
<a href="#l19.146"></a><span id="l19.146"> }</span>
<a href="#l19.147"></a><span id="l19.147"> </span>
<a href="#l19.148"></a><span id="l19.148"> // Get and validate data from widgets.</span>
<a href="#l19.149"></a><span id="l19.149"> // Set attributes on globalElement so they can be accessed by AdvancedEdit()</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-function ValidateData()</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-{</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+function ValidateData() {</span>
<a href="#l19.153"></a><span id="l19.153">   // Height is always pixels</span>
<a href="#l19.154"></a><span id="l19.154">   height = ValidateNumber(gDialog.heightInput, null, 1, gMaxHRSize,</span>
<a href="#l19.155"></a><span id="l19.155">                           globalElement, &quot;size&quot;, false);</span>
<a href="#l19.156"></a><span id="l19.156">   if (gValidationError)</span>
<a href="#l19.157"></a><span id="l19.157">     return false;</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159">   width = ValidateNumber(gDialog.widthInput, gDialog.pixelOrPercentMenulist, 1, gMaxPixels,</span>
<a href="#l19.160"></a><span id="l19.160">                          globalElement, &quot;width&quot;, false);</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineat">@@ -180,20 +170,18 @@ function ValidateData()</span>
<a href="#l19.162"></a><span id="l19.162">     globalElement.removeAttribute(&quot;noshade&quot;);</span>
<a href="#l19.163"></a><span id="l19.163">   } else {</span>
<a href="#l19.164"></a><span id="l19.164">     shading = false;</span>
<a href="#l19.165"></a><span id="l19.165">     globalElement.setAttribute(&quot;noshade&quot;, &quot;noshade&quot;);</span>
<a href="#l19.166"></a><span id="l19.166">   }</span>
<a href="#l19.167"></a><span id="l19.167">   return true;</span>
<a href="#l19.168"></a><span id="l19.168"> }</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-function onAccept(event)</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-{</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-  if (ValidateData())</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-  {</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+function onAccept(event) {</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l19.176"></a><span id="l19.176">     // Copy attributes from the globalElement to the document element</span>
<a href="#l19.177"></a><span id="l19.177">     try {</span>
<a href="#l19.178"></a><span id="l19.178">       GetCurrentEditor().cloneAttributes(gHLineElement, globalElement);</span>
<a href="#l19.179"></a><span id="l19.179">     } catch (e) {}</span>
<a href="#l19.180"></a><span id="l19.180">     return;</span>
<a href="#l19.181"></a><span id="l19.181">   }</span>
<a href="#l19.182"></a><span id="l19.182">   event.preventDefault();</span>
<a href="#l19.183"></a><span id="l19.183"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdImageDialog.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdImageDialog.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -33,51 +33,49 @@ var gValidateTab;</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> // These must correspond to values in EditorDialog.css for each theme</span>
<a href="#l20.6"></a><span id="l20.6"> // (unfortunately, setting &quot;style&quot; attribute here doesn't work!)</span>
<a href="#l20.7"></a><span id="l20.7"> var gPreviewImageWidth = 80;</span>
<a href="#l20.8"></a><span id="l20.8"> var gPreviewImageHeight = 50;</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> // dialog initialization code</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-function ImageStartup()</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-{</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-  gDialog.tabBox            = document.getElementById( &quot;TabBox&quot; );</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-  gDialog.tabLocation       = document.getElementById( &quot;imageLocationTab&quot; );</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-  gDialog.tabDimensions     = document.getElementById( &quot;imageDimensionsTab&quot; );</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-  gDialog.tabBorder         = document.getElementById( &quot;imageBorderTab&quot; );</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-  gDialog.srcInput          = document.getElementById( &quot;srcInput&quot; );</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-  gDialog.titleInput        = document.getElementById( &quot;titleInput&quot; );</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-  gDialog.altTextInput      = document.getElementById( &quot;altTextInput&quot; );</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-  gDialog.altTextRadioGroup = document.getElementById( &quot;altTextRadioGroup&quot; );</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-  gDialog.altTextRadio      = document.getElementById( &quot;altTextRadio&quot; );</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-  gDialog.noAltTextRadio    = document.getElementById( &quot;noAltTextRadio&quot; );</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-  gDialog.actualSizeRadio   = document.getElementById( &quot;actualSizeRadio&quot; );</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-  gDialog.constrainCheckbox = document.getElementById( &quot;constrainCheckbox&quot; );</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-  gDialog.widthInput        = document.getElementById( &quot;widthInput&quot; );</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-  gDialog.heightInput       = document.getElementById( &quot;heightInput&quot; );</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-  gDialog.widthUnitsMenulist   = document.getElementById( &quot;widthUnitsMenulist&quot; );</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-  gDialog.heightUnitsMenulist  = document.getElementById( &quot;heightUnitsMenulist&quot; );</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  gDialog.imagelrInput      = document.getElementById( &quot;imageleftrightInput&quot; );</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  gDialog.imagetbInput      = document.getElementById( &quot;imagetopbottomInput&quot; );</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  gDialog.border            = document.getElementById( &quot;border&quot; );</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  gDialog.alignTypeSelect   = document.getElementById( &quot;alignTypeSelect&quot; );</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-  gDialog.ImageHolder       = document.getElementById( &quot;preview-image-holder&quot; );</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-  gDialog.PreviewWidth      = document.getElementById( &quot;PreviewWidth&quot; );</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  gDialog.PreviewHeight     = document.getElementById( &quot;PreviewHeight&quot; );</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  gDialog.PreviewSize       = document.getElementById( &quot;PreviewSize&quot; );</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+function ImageStartup() {</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  gDialog.tabBox            = document.getElementById(&quot;TabBox&quot;);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+  gDialog.tabLocation       = document.getElementById(&quot;imageLocationTab&quot;);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+  gDialog.tabDimensions     = document.getElementById(&quot;imageDimensionsTab&quot;);</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  gDialog.tabBorder         = document.getElementById(&quot;imageBorderTab&quot;);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  gDialog.srcInput          = document.getElementById(&quot;srcInput&quot;);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+  gDialog.titleInput        = document.getElementById(&quot;titleInput&quot;);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+  gDialog.altTextInput      = document.getElementById(&quot;altTextInput&quot;);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+  gDialog.altTextRadioGroup = document.getElementById(&quot;altTextRadioGroup&quot;);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+  gDialog.altTextRadio      = document.getElementById(&quot;altTextRadio&quot;);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+  gDialog.noAltTextRadio    = document.getElementById(&quot;noAltTextRadio&quot;);</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+  gDialog.actualSizeRadio   = document.getElementById(&quot;actualSizeRadio&quot;);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+  gDialog.constrainCheckbox = document.getElementById(&quot;constrainCheckbox&quot;);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+  gDialog.widthInput        = document.getElementById(&quot;widthInput&quot;);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+  gDialog.heightInput       = document.getElementById(&quot;heightInput&quot;);</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+  gDialog.widthUnitsMenulist   = document.getElementById(&quot;widthUnitsMenulist&quot;);</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  gDialog.heightUnitsMenulist  = document.getElementById(&quot;heightUnitsMenulist&quot;);</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+  gDialog.imagelrInput      = document.getElementById(&quot;imageleftrightInput&quot;);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  gDialog.imagetbInput      = document.getElementById(&quot;imagetopbottomInput&quot;);</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  gDialog.border            = document.getElementById(&quot;border&quot;);</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+  gDialog.alignTypeSelect   = document.getElementById(&quot;alignTypeSelect&quot;);</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+  gDialog.ImageHolder       = document.getElementById(&quot;preview-image-holder&quot;);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+  gDialog.PreviewWidth      = document.getElementById(&quot;PreviewWidth&quot;);</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+  gDialog.PreviewHeight     = document.getElementById(&quot;PreviewHeight&quot;);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+  gDialog.PreviewSize       = document.getElementById(&quot;PreviewSize&quot;);</span>
<a href="#l20.63"></a><span id="l20.63">   gDialog.PreviewImage      = null;</span>
<a href="#l20.64"></a><span id="l20.64">   gDialog.OkButton          = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l20.65"></a><span id="l20.65"> }</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67"> // Set dialog widgets with attribute data</span>
<a href="#l20.68"></a><span id="l20.68"> // We get them from globalElement copy so this can be used</span>
<a href="#l20.69"></a><span id="l20.69"> //   by AdvancedEdit(), which is shared by all property dialogs</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-function InitImage()</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-{</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+function InitImage() {</span>
<a href="#l20.73"></a><span id="l20.73">   // Set the controls to the image's attributes</span>
<a href="#l20.74"></a><span id="l20.74">   var src = globalElement.getAttribute(&quot;src&quot;);</span>
<a href="#l20.75"></a><span id="l20.75"> </span>
<a href="#l20.76"></a><span id="l20.76">   // For image insertion the 'src' attribute is null.</span>
<a href="#l20.77"></a><span id="l20.77">   if (src) {</span>
<a href="#l20.78"></a><span id="l20.78">     // Shorten data URIs for display.</span>
<a href="#l20.79"></a><span id="l20.79">     shortenImageData(src, gDialog.srcInput);</span>
<a href="#l20.80"></a><span id="l20.80">   }</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineat">@@ -88,22 +86,19 @@ function InitImage()</span>
<a href="#l20.82"></a><span id="l20.82">   // Force loading of image from its source and show preview image</span>
<a href="#l20.83"></a><span id="l20.83">   LoadPreviewImage();</span>
<a href="#l20.84"></a><span id="l20.84"> </span>
<a href="#l20.85"></a><span id="l20.85">   gDialog.titleInput.value = globalElement.getAttribute(&quot;title&quot;);</span>
<a href="#l20.86"></a><span id="l20.86"> </span>
<a href="#l20.87"></a><span id="l20.87">   var hasAltText = globalElement.hasAttribute(&quot;alt&quot;);</span>
<a href="#l20.88"></a><span id="l20.88">   var altText = globalElement.getAttribute(&quot;alt&quot;);</span>
<a href="#l20.89"></a><span id="l20.89">   gDialog.altTextInput.value = altText;</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-  if (altText || (!hasAltText &amp;&amp; globalElement.hasAttribute(&quot;src&quot;)))</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-  {</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+  if (altText || (!hasAltText &amp;&amp; globalElement.hasAttribute(&quot;src&quot;))) {</span>
<a href="#l20.93"></a><span id="l20.93">     gDialog.altTextRadioGroup.selectedItem = gDialog.altTextRadio;</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-  }</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-  else if (hasAltText)</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-  {</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+  } else if (hasAltText) {</span>
<a href="#l20.98"></a><span id="l20.98">     gDialog.altTextRadioGroup.selectedItem = gDialog.noAltTextRadio;</span>
<a href="#l20.99"></a><span id="l20.99">   }</span>
<a href="#l20.100"></a><span id="l20.100">   SetAltTextDisabled(gDialog.altTextRadioGroup.selectedItem == gDialog.noAltTextRadio);</span>
<a href="#l20.101"></a><span id="l20.101"> </span>
<a href="#l20.102"></a><span id="l20.102">   // setup the height and width widgets</span>
<a href="#l20.103"></a><span id="l20.103">   var width = InitPixelOrPercentMenulist(globalElement,</span>
<a href="#l20.104"></a><span id="l20.104">                     gInsertNewImage ? null : imageElement,</span>
<a href="#l20.105"></a><span id="l20.105">                     &quot;width&quot;, &quot;widthUnitsMenulist&quot;, gPixel);</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineat">@@ -118,45 +113,37 @@ function InitImage()</span>
<a href="#l20.107"></a><span id="l20.107">   gDialog.heightInput.value = gConstrainHeight = height ? height : (gActualHeight ? gActualHeight : &quot;&quot;);</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">   // set spacing editfields</span>
<a href="#l20.110"></a><span id="l20.110">   gDialog.imagelrInput.value = globalElement.getAttribute(&quot;hspace&quot;);</span>
<a href="#l20.111"></a><span id="l20.111">   gDialog.imagetbInput.value = globalElement.getAttribute(&quot;vspace&quot;);</span>
<a href="#l20.112"></a><span id="l20.112"> </span>
<a href="#l20.113"></a><span id="l20.113">   // dialog.border.value       = globalElement.getAttribute(&quot;border&quot;);</span>
<a href="#l20.114"></a><span id="l20.114">   var bv = GetHTMLOrCSSStyleValue(globalElement, &quot;border&quot;, &quot;border-top-width&quot;);</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-  if (bv.includes(&quot;px&quot;))</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-  {</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+  if (bv.includes(&quot;px&quot;)) {</span>
<a href="#l20.118"></a><span id="l20.118">     // Strip out the px</span>
<a href="#l20.119"></a><span id="l20.119">     bv = bv.substr(0, bv.indexOf(&quot;px&quot;));</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-  }</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-  else if (bv == &quot;thin&quot;)</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-  {</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+  } else if (bv == &quot;thin&quot;) {</span>
<a href="#l20.124"></a><span id="l20.124">     bv = &quot;1&quot;;</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-  }</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-  else if (bv == &quot;medium&quot;)</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-  {</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+  } else if (bv == &quot;medium&quot;) {</span>
<a href="#l20.129"></a><span id="l20.129">     bv = &quot;3&quot;;</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-  }</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-  else if (bv == &quot;thick&quot;)</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-  {</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+  } else if (bv == &quot;thick&quot;) {</span>
<a href="#l20.134"></a><span id="l20.134">     bv = &quot;5&quot;;</span>
<a href="#l20.135"></a><span id="l20.135">   }</span>
<a href="#l20.136"></a><span id="l20.136">   gDialog.border.value = bv;</span>
<a href="#l20.137"></a><span id="l20.137"> </span>
<a href="#l20.138"></a><span id="l20.138">   // Get alignment setting</span>
<a href="#l20.139"></a><span id="l20.139">   var align = globalElement.getAttribute(&quot;align&quot;);</span>
<a href="#l20.140"></a><span id="l20.140">   if (align)</span>
<a href="#l20.141"></a><span id="l20.141">     align = align.toLowerCase();</span>
<a href="#l20.142"></a><span id="l20.142"> </span>
<a href="#l20.143"></a><span id="l20.143">   var imgClass;</span>
<a href="#l20.144"></a><span id="l20.144">   var textID;</span>
<a href="#l20.145"></a><span id="l20.145"> </span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-  switch ( align )</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-  {</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+  switch (align) {</span>
<a href="#l20.149"></a><span id="l20.149">     case &quot;top&quot;:</span>
<a href="#l20.150"></a><span id="l20.150">     case &quot;middle&quot;:</span>
<a href="#l20.151"></a><span id="l20.151">     case &quot;right&quot;:</span>
<a href="#l20.152"></a><span id="l20.152">     case &quot;left&quot;:</span>
<a href="#l20.153"></a><span id="l20.153">       gDialog.alignTypeSelect.value = align;</span>
<a href="#l20.154"></a><span id="l20.154">       break;</span>
<a href="#l20.155"></a><span id="l20.155">     default:  // Default or &quot;bottom&quot;</span>
<a href="#l20.156"></a><span id="l20.156">       gDialog.alignTypeSelect.value = &quot;bottom&quot;;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineat">@@ -164,61 +151,52 @@ function InitImage()</span>
<a href="#l20.158"></a><span id="l20.158"> </span>
<a href="#l20.159"></a><span id="l20.159">   // Get image map for image</span>
<a href="#l20.160"></a><span id="l20.160">   gImageMap = GetImageMap();</span>
<a href="#l20.161"></a><span id="l20.161"> </span>
<a href="#l20.162"></a><span id="l20.162">   doOverallEnabling();</span>
<a href="#l20.163"></a><span id="l20.163">   doDimensionEnabling();</span>
<a href="#l20.164"></a><span id="l20.164"> }</span>
<a href="#l20.165"></a><span id="l20.165"> </span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-function  SetSizeWidgets(width, height)</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-{</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+function SetSizeWidgets(width, height) {</span>
<a href="#l20.169"></a><span id="l20.169">   if (!(width || height) || (gActualWidth &amp;&amp; gActualHeight &amp;&amp; width == gActualWidth &amp;&amp; height == gActualHeight))</span>
<a href="#l20.170"></a><span id="l20.170">     gDialog.actualSizeRadio.radioGroup.selectedItem = gDialog.actualSizeRadio;</span>
<a href="#l20.171"></a><span id="l20.171"> </span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-  if (!gDialog.actualSizeRadio.selected)</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-  {</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+  if (!gDialog.actualSizeRadio.selected) {</span>
<a href="#l20.175"></a><span id="l20.175">     // Decide if user's sizes are in the same ratio as actual sizes</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-    if (gActualWidth &amp;&amp; gActualHeight)</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-    {</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+    if (gActualWidth &amp;&amp; gActualHeight) {</span>
<a href="#l20.179"></a><span id="l20.179">       if (gActualWidth &gt; gActualHeight)</span>
<a href="#l20.180"></a><span id="l20.180">         gDialog.constrainCheckbox.checked = (Math.round(gActualHeight * width / gActualWidth) == height);</span>
<a href="#l20.181"></a><span id="l20.181">       else</span>
<a href="#l20.182"></a><span id="l20.182">         gDialog.constrainCheckbox.checked = (Math.round(gActualWidth * height / gActualHeight) == width);</span>
<a href="#l20.183"></a><span id="l20.183">     }</span>
<a href="#l20.184"></a><span id="l20.184">   }</span>
<a href="#l20.185"></a><span id="l20.185"> }</span>
<a href="#l20.186"></a><span id="l20.186"> </span>
<a href="#l20.187"></a><span id="l20.187"> // Disable alt text input when &quot;Don't use alt&quot; radio is checked</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-function SetAltTextDisabled(disable)</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-{</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+function SetAltTextDisabled(disable) {</span>
<a href="#l20.191"></a><span id="l20.191">   gDialog.altTextInput.disabled = disable;</span>
<a href="#l20.192"></a><span id="l20.192"> }</span>
<a href="#l20.193"></a><span id="l20.193"> </span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-function GetImageMap()</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-{</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+function GetImageMap() {</span>
<a href="#l20.197"></a><span id="l20.197">   var usemap = globalElement.getAttribute(&quot;usemap&quot;);</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineminus">-  if (usemap)</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-  {</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+  if (usemap) {</span>
<a href="#l20.201"></a><span id="l20.201">     gCanRemoveImageMap = true;</span>
<a href="#l20.202"></a><span id="l20.202">     let mapname = usemap.substr(1);</span>
<a href="#l20.203"></a><span id="l20.203">     try {</span>
<a href="#l20.204"></a><span id="l20.204">       return GetCurrentEditor().document.querySelector('[name=&quot;' + mapname + '&quot;]');</span>
<a href="#l20.205"></a><span id="l20.205">     } catch (e) {}</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-  }</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-  else</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-  {</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+  } else {</span>
<a href="#l20.210"></a><span id="l20.210">     gCanRemoveImageMap = false;</span>
<a href="#l20.211"></a><span id="l20.211">   }</span>
<a href="#l20.212"></a><span id="l20.212"> </span>
<a href="#l20.213"></a><span id="l20.213">   return null;</span>
<a href="#l20.214"></a><span id="l20.214"> }</span>
<a href="#l20.215"></a><span id="l20.215"> </span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-function chooseFile()</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-{</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+function chooseFile() {</span>
<a href="#l20.219"></a><span id="l20.219">   if (gTimerID)</span>
<a href="#l20.220"></a><span id="l20.220">     clearTimeout(gTimerID);</span>
<a href="#l20.221"></a><span id="l20.221"> </span>
<a href="#l20.222"></a><span id="l20.222">   // Put focus into the input field</span>
<a href="#l20.223"></a><span id="l20.223">   SetTextboxFocus(gDialog.srcInput);</span>
<a href="#l20.224"></a><span id="l20.224"> </span>
<a href="#l20.225"></a><span id="l20.225">   GetLocalFileURL(&quot;img&quot;).then(fileURL =&gt; {</span>
<a href="#l20.226"></a><span id="l20.226">     // Always try to relativize local file URLs</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineat">@@ -228,36 +206,31 @@ function chooseFile()</span>
<a href="#l20.228"></a><span id="l20.228">     gDialog.srcInput.value = fileURL;</span>
<a href="#l20.229"></a><span id="l20.229"> </span>
<a href="#l20.230"></a><span id="l20.230">     SetRelativeCheckbox();</span>
<a href="#l20.231"></a><span id="l20.231">     doOverallEnabling();</span>
<a href="#l20.232"></a><span id="l20.232">     LoadPreviewImage();</span>
<a href="#l20.233"></a><span id="l20.233">   });</span>
<a href="#l20.234"></a><span id="l20.234"> }</span>
<a href="#l20.235"></a><span id="l20.235"> </span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-function PreviewImageLoaded()</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-{</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-  if (gDialog.PreviewImage)</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-  {</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+function PreviewImageLoaded() {</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+  if (gDialog.PreviewImage) {</span>
<a href="#l20.242"></a><span id="l20.242">     // Image loading has completed -- we can get actual width</span>
<a href="#l20.243"></a><span id="l20.243">     gActualWidth  = gDialog.PreviewImage.naturalWidth;</span>
<a href="#l20.244"></a><span id="l20.244">     gActualHeight = gDialog.PreviewImage.naturalHeight;</span>
<a href="#l20.245"></a><span id="l20.245"> </span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-    if (gActualWidth &amp;&amp; gActualHeight)</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-    {</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+    if (gActualWidth &amp;&amp; gActualHeight) {</span>
<a href="#l20.249"></a><span id="l20.249">       // Use actual size or scale to fit preview if either dimension is too large</span>
<a href="#l20.250"></a><span id="l20.250">       var width = gActualWidth;</span>
<a href="#l20.251"></a><span id="l20.251">       var height = gActualHeight;</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-      if (gActualWidth &gt; gPreviewImageWidth)</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineminus">-      {</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+      if (gActualWidth &gt; gPreviewImageWidth) {</span>
<a href="#l20.255"></a><span id="l20.255">           width = gPreviewImageWidth;</span>
<a href="#l20.256"></a><span id="l20.256">           height = gActualHeight * (gPreviewImageWidth / gActualWidth);</span>
<a href="#l20.257"></a><span id="l20.257">       }</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-      if (height &gt; gPreviewImageHeight)</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-      {</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+      if (height &gt; gPreviewImageHeight) {</span>
<a href="#l20.261"></a><span id="l20.261">         height = gPreviewImageHeight;</span>
<a href="#l20.262"></a><span id="l20.262">         width = gActualWidth * (gPreviewImageHeight / gActualHeight);</span>
<a href="#l20.263"></a><span id="l20.263">       }</span>
<a href="#l20.264"></a><span id="l20.264">       gDialog.PreviewImage.width = width;</span>
<a href="#l20.265"></a><span id="l20.265">       gDialog.PreviewImage.height = height;</span>
<a href="#l20.266"></a><span id="l20.266"> </span>
<a href="#l20.267"></a><span id="l20.267">       gDialog.PreviewWidth.setAttribute(&quot;value&quot;, gActualWidth);</span>
<a href="#l20.268"></a><span id="l20.268">       gDialog.PreviewHeight.setAttribute(&quot;value&quot;, gActualHeight);</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineat">@@ -268,221 +241,200 @@ function PreviewImageLoaded()</span>
<a href="#l20.270"></a><span id="l20.270">       SetSizeWidgets(gDialog.widthInput.value, gDialog.heightInput.value);</span>
<a href="#l20.271"></a><span id="l20.271">     }</span>
<a href="#l20.272"></a><span id="l20.272"> </span>
<a href="#l20.273"></a><span id="l20.273">     if (gDialog.actualSizeRadio.selected)</span>
<a href="#l20.274"></a><span id="l20.274">       SetActualSize();</span>
<a href="#l20.275"></a><span id="l20.275">   }</span>
<a href="#l20.276"></a><span id="l20.276"> }</span>
<a href="#l20.277"></a><span id="l20.277"> </span>
<a href="#l20.278"></a><span id="l20.278" class="difflineminus">-function LoadPreviewImage()</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineminus">-{</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineplus">+function LoadPreviewImage() {</span>
<a href="#l20.281"></a><span id="l20.281">   gDialog.PreviewSize.collapsed = true;</span>
<a href="#l20.282"></a><span id="l20.282">   // XXXbz workaround for bug 265416 / bug 266284</span>
<a href="#l20.283"></a><span id="l20.283">   gDialog.ImageHolder.collapsed = true;</span>
<a href="#l20.284"></a><span id="l20.284"> </span>
<a href="#l20.285"></a><span id="l20.285">   var imageSrc = TrimString(gDialog.srcInput.value);</span>
<a href="#l20.286"></a><span id="l20.286">   if (!imageSrc)</span>
<a href="#l20.287"></a><span id="l20.287">     return;</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineminus">-  if (isImageDataShortened(imageSrc))</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineminus">-  {</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineplus">+  if (isImageDataShortened(imageSrc)) {</span>
<a href="#l20.291"></a><span id="l20.291">     imageSrc = restoredImageData(gDialog.srcInput);</span>
<a href="#l20.292"></a><span id="l20.292">   }</span>
<a href="#l20.293"></a><span id="l20.293"> </span>
<a href="#l20.294"></a><span id="l20.294">   try {</span>
<a href="#l20.295"></a><span id="l20.295">     // Remove the image URL from image cache so it loads fresh</span>
<a href="#l20.296"></a><span id="l20.296">     //  (if we don't do this, loads after the first will always use image cache</span>
<a href="#l20.297"></a><span id="l20.297">     //   and we won't see image edit changes or be able to get actual width and height)</span>
<a href="#l20.298"></a><span id="l20.298"> </span>
<a href="#l20.299"></a><span id="l20.299">     // We must have an absolute URL to preview it or remove it from the cache</span>
<a href="#l20.300"></a><span id="l20.300">     imageSrc = MakeAbsoluteUrl(imageSrc);</span>
<a href="#l20.301"></a><span id="l20.301"> </span>
<a href="#l20.302"></a><span id="l20.302" class="difflineminus">-    if (GetScheme(imageSrc))</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineminus">-    {</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineplus">+    if (GetScheme(imageSrc)) {</span>
<a href="#l20.305"></a><span id="l20.305">       let uri = Services.io.newURI(imageSrc);</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineminus">-      if (uri)</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineminus">-      {</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineplus">+      if (uri) {</span>
<a href="#l20.309"></a><span id="l20.309">         let imgCache = Cc[&quot;@mozilla.org/image/cache;1&quot;]</span>
<a href="#l20.310"></a><span id="l20.310">                          .getService(Ci.imgICache);</span>
<a href="#l20.311"></a><span id="l20.311"> </span>
<a href="#l20.312"></a><span id="l20.312">         // This returns error if image wasn't in the cache; ignore that</span>
<a href="#l20.313"></a><span id="l20.313">         imgCache.removeEntry(uri);</span>
<a href="#l20.314"></a><span id="l20.314">       }</span>
<a href="#l20.315"></a><span id="l20.315">     }</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineminus">-  } catch(e) {}</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineplus">+  } catch (e) {}</span>
<a href="#l20.318"></a><span id="l20.318"> </span>
<a href="#l20.319"></a><span id="l20.319">   if (gDialog.PreviewImage)</span>
<a href="#l20.320"></a><span id="l20.320">     removeEventListener(&quot;load&quot;, PreviewImageLoaded, true);</span>
<a href="#l20.321"></a><span id="l20.321"> </span>
<a href="#l20.322"></a><span id="l20.322">   if (gDialog.ImageHolder.hasChildNodes())</span>
<a href="#l20.323"></a><span id="l20.323">     gDialog.ImageHolder.firstChild.remove();</span>
<a href="#l20.324"></a><span id="l20.324"> </span>
<a href="#l20.325"></a><span id="l20.325">   gDialog.PreviewImage = document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;html:img&quot;);</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineminus">-  if (gDialog.PreviewImage)</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineminus">-  {</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineplus">+  if (gDialog.PreviewImage) {</span>
<a href="#l20.329"></a><span id="l20.329">     // set the src before appending to the document -- see bug 198435 for why</span>
<a href="#l20.330"></a><span id="l20.330">     // this is needed.</span>
<a href="#l20.331"></a><span id="l20.331">     // XXXbz that bug is long-since fixed.  Is this still needed?</span>
<a href="#l20.332"></a><span id="l20.332">     gDialog.PreviewImage.addEventListener(&quot;load&quot;, PreviewImageLoaded, true);</span>
<a href="#l20.333"></a><span id="l20.333">     gDialog.PreviewImage.src = imageSrc;</span>
<a href="#l20.334"></a><span id="l20.334">     gDialog.ImageHolder.appendChild(gDialog.PreviewImage);</span>
<a href="#l20.335"></a><span id="l20.335">   }</span>
<a href="#l20.336"></a><span id="l20.336"> }</span>
<a href="#l20.337"></a><span id="l20.337"> </span>
<a href="#l20.338"></a><span id="l20.338" class="difflineminus">-function SetActualSize()</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineminus">-{</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineplus">+function SetActualSize() {</span>
<a href="#l20.341"></a><span id="l20.341">   gDialog.widthInput.value = gActualWidth ? gActualWidth : &quot;&quot;;</span>
<a href="#l20.342"></a><span id="l20.342">   gDialog.widthUnitsMenulist.selectedIndex = 0;</span>
<a href="#l20.343"></a><span id="l20.343">   gDialog.heightInput.value = gActualHeight ? gActualHeight : &quot;&quot;;</span>
<a href="#l20.344"></a><span id="l20.344">   gDialog.heightUnitsMenulist.selectedIndex = 0;</span>
<a href="#l20.345"></a><span id="l20.345">   doDimensionEnabling();</span>
<a href="#l20.346"></a><span id="l20.346"> }</span>
<a href="#l20.347"></a><span id="l20.347"> </span>
<a href="#l20.348"></a><span id="l20.348" class="difflineminus">-function ChangeImageSrc()</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineminus">-{</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineplus">+function ChangeImageSrc() {</span>
<a href="#l20.351"></a><span id="l20.351">   if (gTimerID)</span>
<a href="#l20.352"></a><span id="l20.352">     clearTimeout(gTimerID);</span>
<a href="#l20.353"></a><span id="l20.353"> </span>
<a href="#l20.354"></a><span id="l20.354">   gTimerID = setTimeout(LoadPreviewImage, 800);</span>
<a href="#l20.355"></a><span id="l20.355"> </span>
<a href="#l20.356"></a><span id="l20.356">   SetRelativeCheckbox();</span>
<a href="#l20.357"></a><span id="l20.357">   doOverallEnabling();</span>
<a href="#l20.358"></a><span id="l20.358"> }</span>
<a href="#l20.359"></a><span id="l20.359"> </span>
<a href="#l20.360"></a><span id="l20.360" class="difflineminus">-function doDimensionEnabling()</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineminus">-{</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineplus">+function doDimensionEnabling() {</span>
<a href="#l20.363"></a><span id="l20.363">   // Enabled unless &quot;Actual Size&quot; is selected</span>
<a href="#l20.364"></a><span id="l20.364">   var enable = !gDialog.actualSizeRadio.selected;</span>
<a href="#l20.365"></a><span id="l20.365"> </span>
<a href="#l20.366"></a><span id="l20.366">   // BUG 74145: After input field is disabled,</span>
<a href="#l20.367"></a><span id="l20.367">   //   setting it enabled causes blinking caret to appear</span>
<a href="#l20.368"></a><span id="l20.368">   //   even though focus isn't set to it.</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineminus">-  SetElementEnabledById( &quot;heightInput&quot;, enable );</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineminus">-  SetElementEnabledById( &quot;heightLabel&quot;, enable );</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineminus">-  SetElementEnabledById( &quot;heightUnitsMenulist&quot;, enable );</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineplus">+  SetElementEnabledById(&quot;heightInput&quot;, enable);</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineplus">+  SetElementEnabledById(&quot;heightLabel&quot;, enable);</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineplus">+  SetElementEnabledById(&quot;heightUnitsMenulist&quot;, enable);</span>
<a href="#l20.375"></a><span id="l20.375"> </span>
<a href="#l20.376"></a><span id="l20.376" class="difflineminus">-  SetElementEnabledById( &quot;widthInput&quot;, enable );</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-  SetElementEnabledById( &quot;widthLabel&quot;, enable);</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineminus">-  SetElementEnabledById( &quot;widthUnitsMenulist&quot;, enable );</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineplus">+  SetElementEnabledById(&quot;widthInput&quot;, enable);</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineplus">+  SetElementEnabledById(&quot;widthLabel&quot;, enable);</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+  SetElementEnabledById(&quot;widthUnitsMenulist&quot;, enable);</span>
<a href="#l20.382"></a><span id="l20.382"> </span>
<a href="#l20.383"></a><span id="l20.383">   var constrainEnable = enable</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineminus">-         &amp;&amp; ( gDialog.widthUnitsMenulist.selectedIndex == 0 )</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineminus">-         &amp;&amp; ( gDialog.heightUnitsMenulist.selectedIndex == 0 );</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineplus">+         &amp;&amp; (gDialog.widthUnitsMenulist.selectedIndex == 0)</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineplus">+         &amp;&amp; (gDialog.heightUnitsMenulist.selectedIndex == 0);</span>
<a href="#l20.388"></a><span id="l20.388"> </span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-  SetElementEnabledById( &quot;constrainCheckbox&quot;, constrainEnable );</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineplus">+  SetElementEnabledById(&quot;constrainCheckbox&quot;, constrainEnable);</span>
<a href="#l20.391"></a><span id="l20.391"> }</span>
<a href="#l20.392"></a><span id="l20.392"> </span>
<a href="#l20.393"></a><span id="l20.393" class="difflineminus">-function doOverallEnabling()</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineminus">-{</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineplus">+function doOverallEnabling() {</span>
<a href="#l20.396"></a><span id="l20.396">   var enabled = TrimString(gDialog.srcInput.value) != &quot;&quot;;</span>
<a href="#l20.397"></a><span id="l20.397"> </span>
<a href="#l20.398"></a><span id="l20.398">   SetElementEnabled(gDialog.OkButton, enabled);</span>
<a href="#l20.399"></a><span id="l20.399">   SetElementEnabledById(&quot;AdvancedEditButton1&quot;, enabled);</span>
<a href="#l20.400"></a><span id="l20.400">   SetElementEnabledById(&quot;imagemapLabel&quot;, enabled);</span>
<a href="#l20.401"></a><span id="l20.401">   SetElementEnabledById(&quot;removeImageMap&quot;, gCanRemoveImageMap);</span>
<a href="#l20.402"></a><span id="l20.402"> }</span>
<a href="#l20.403"></a><span id="l20.403"> </span>
<a href="#l20.404"></a><span id="l20.404" class="difflineminus">-function ToggleConstrain()</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineminus">-{</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineplus">+function ToggleConstrain() {</span>
<a href="#l20.407"></a><span id="l20.407">   // If just turned on, save the current width and height as basis for constrain ratio</span>
<a href="#l20.408"></a><span id="l20.408">   // Thus clicking on/off lets user say &quot;Use these values as aspect ration&quot;</span>
<a href="#l20.409"></a><span id="l20.409">   if (gDialog.constrainCheckbox.checked &amp;&amp; !gDialog.constrainCheckbox.disabled</span>
<a href="#l20.410"></a><span id="l20.410">      &amp;&amp; (gDialog.widthUnitsMenulist.selectedIndex == 0)</span>
<a href="#l20.411"></a><span id="l20.411" class="difflineminus">-     &amp;&amp; (gDialog.heightUnitsMenulist.selectedIndex == 0))</span>
<a href="#l20.412"></a><span id="l20.412" class="difflineminus">-  {</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineplus">+     &amp;&amp; (gDialog.heightUnitsMenulist.selectedIndex == 0)) {</span>
<a href="#l20.414"></a><span id="l20.414">     gConstrainWidth = Number(TrimString(gDialog.widthInput.value));</span>
<a href="#l20.415"></a><span id="l20.415">     gConstrainHeight = Number(TrimString(gDialog.heightInput.value));</span>
<a href="#l20.416"></a><span id="l20.416">   }</span>
<a href="#l20.417"></a><span id="l20.417"> }</span>
<a href="#l20.418"></a><span id="l20.418"> </span>
<a href="#l20.419"></a><span id="l20.419" class="difflineminus">-function constrainProportions( srcID, destID )</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineminus">-{</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineplus">+function constrainProportions(srcID, destID) {</span>
<a href="#l20.422"></a><span id="l20.422">   var srcElement = document.getElementById(srcID);</span>
<a href="#l20.423"></a><span id="l20.423">   if (!srcElement)</span>
<a href="#l20.424"></a><span id="l20.424">     return;</span>
<a href="#l20.425"></a><span id="l20.425"> </span>
<a href="#l20.426"></a><span id="l20.426">   var destElement = document.getElementById(destID);</span>
<a href="#l20.427"></a><span id="l20.427">   if (!destElement)</span>
<a href="#l20.428"></a><span id="l20.428">     return;</span>
<a href="#l20.429"></a><span id="l20.429"> </span>
<a href="#l20.430"></a><span id="l20.430">   // always force an integer (whether we are constraining or not)</span>
<a href="#l20.431"></a><span id="l20.431">   forceInteger(srcID);</span>
<a href="#l20.432"></a><span id="l20.432"> </span>
<a href="#l20.433"></a><span id="l20.433">   if (!gActualWidth || !gActualHeight ||</span>
<a href="#l20.434"></a><span id="l20.434">       !(gDialog.constrainCheckbox.checked &amp;&amp; !gDialog.constrainCheckbox.disabled))</span>
<a href="#l20.435"></a><span id="l20.435">     return;</span>
<a href="#l20.436"></a><span id="l20.436"> </span>
<a href="#l20.437"></a><span id="l20.437">   // double-check that neither width nor height is in percent mode; bail if so!</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineminus">-  if ( (gDialog.widthUnitsMenulist.selectedIndex != 0)</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineminus">-     || (gDialog.heightUnitsMenulist.selectedIndex != 0) )</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineplus">+  if ((gDialog.widthUnitsMenulist.selectedIndex != 0)</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineplus">+     || (gDialog.heightUnitsMenulist.selectedIndex != 0))</span>
<a href="#l20.442"></a><span id="l20.442">     return;</span>
<a href="#l20.443"></a><span id="l20.443"> </span>
<a href="#l20.444"></a><span id="l20.444">   // This always uses the actual width and height ratios</span>
<a href="#l20.445"></a><span id="l20.445">   // which is kind of funky if you change one number without the constrain</span>
<a href="#l20.446"></a><span id="l20.446">   // and then turn constrain on and change a number</span>
<a href="#l20.447"></a><span id="l20.447">   // I prefer the old strategy (below) but I can see some merit to this solution</span>
<a href="#l20.448"></a><span id="l20.448">   if (srcID == &quot;widthInput&quot;)</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineminus">-    destElement.value = Math.round( srcElement.value * gActualHeight / gActualWidth );</span>
<a href="#l20.450"></a><span id="l20.450" class="difflineplus">+    destElement.value = Math.round(srcElement.value * gActualHeight / gActualWidth);</span>
<a href="#l20.451"></a><span id="l20.451">   else</span>
<a href="#l20.452"></a><span id="l20.452" class="difflineminus">-    destElement.value = Math.round( srcElement.value * gActualWidth / gActualHeight );</span>
<a href="#l20.453"></a><span id="l20.453" class="difflineplus">+    destElement.value = Math.round(srcElement.value * gActualWidth / gActualHeight);</span>
<a href="#l20.454"></a><span id="l20.454"> </span>
<a href="#l20.455"></a><span id="l20.455"> /*</span>
<a href="#l20.456"></a><span id="l20.456">   // With this strategy, the width and height ratio</span>
<a href="#l20.457"></a><span id="l20.457">   //   can be reset to whatever the user entered.</span>
<a href="#l20.458"></a><span id="l20.458">   if (srcID == &quot;widthInput&quot;)</span>
<a href="#l20.459"></a><span id="l20.459">     destElement.value = Math.round( srcElement.value * gConstrainHeight / gConstrainWidth );</span>
<a href="#l20.460"></a><span id="l20.460">   else</span>
<a href="#l20.461"></a><span id="l20.461">     destElement.value = Math.round( srcElement.value * gConstrainWidth / gConstrainHeight );</span>
<a href="#l20.462"></a><span id="l20.462"> */</span>
<a href="#l20.463"></a><span id="l20.463"> }</span>
<a href="#l20.464"></a><span id="l20.464"> </span>
<a href="#l20.465"></a><span id="l20.465" class="difflineminus">-function removeImageMap()</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-{</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineplus">+function removeImageMap() {</span>
<a href="#l20.468"></a><span id="l20.468">   gRemoveImageMap = true;</span>
<a href="#l20.469"></a><span id="l20.469">   gCanRemoveImageMap = false;</span>
<a href="#l20.470"></a><span id="l20.470">   SetElementEnabledById(&quot;removeImageMap&quot;, false);</span>
<a href="#l20.471"></a><span id="l20.471"> }</span>
<a href="#l20.472"></a><span id="l20.472"> </span>
<a href="#l20.473"></a><span id="l20.473" class="difflineminus">-function SwitchToValidatePanel()</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineminus">-{</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineplus">+function SwitchToValidatePanel() {</span>
<a href="#l20.476"></a><span id="l20.476">   if (gDialog.tabBox &amp;&amp; gValidateTab &amp;&amp; gDialog.tabBox.selectedTab != gValidateTab)</span>
<a href="#l20.477"></a><span id="l20.477">     gDialog.tabBox.selectedTab = gValidateTab;</span>
<a href="#l20.478"></a><span id="l20.478"> }</span>
<a href="#l20.479"></a><span id="l20.479"> </span>
<a href="#l20.480"></a><span id="l20.480"> // Get data from widgets, validate, and set for the global element</span>
<a href="#l20.481"></a><span id="l20.481"> //   accessible to AdvancedEdit() [in EdDialogCommon.js]</span>
<a href="#l20.482"></a><span id="l20.482" class="difflineminus">-function ValidateImage()</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineminus">-{</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineplus">+function ValidateImage() {</span>
<a href="#l20.485"></a><span id="l20.485">   var editor = GetCurrentEditor();</span>
<a href="#l20.486"></a><span id="l20.486">   if (!editor)</span>
<a href="#l20.487"></a><span id="l20.487">     return false;</span>
<a href="#l20.488"></a><span id="l20.488"> </span>
<a href="#l20.489"></a><span id="l20.489">   gValidateTab = gDialog.tabLocation;</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineminus">-  if (!gDialog.srcInput.value)</span>
<a href="#l20.491"></a><span id="l20.491" class="difflineminus">-  {</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineplus">+  if (!gDialog.srcInput.value) {</span>
<a href="#l20.493"></a><span id="l20.493">     Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;MissingImageError&quot;));</span>
<a href="#l20.494"></a><span id="l20.494">     SwitchToValidatePanel();</span>
<a href="#l20.495"></a><span id="l20.495">     gDialog.srcInput.focus();</span>
<a href="#l20.496"></a><span id="l20.496">     return false;</span>
<a href="#l20.497"></a><span id="l20.497">   }</span>
<a href="#l20.498"></a><span id="l20.498"> </span>
<a href="#l20.499"></a><span id="l20.499">   // We must convert to &quot;file:///&quot; or &quot;http://&quot; format else image doesn't load!</span>
<a href="#l20.500"></a><span id="l20.500">   let src = gDialog.srcInput.value.trim();</span>
<a href="#l20.501"></a><span id="l20.501"> </span>
<a href="#l20.502"></a><span id="l20.502" class="difflineminus">-  if (isImageDataShortened(src))</span>
<a href="#l20.503"></a><span id="l20.503" class="difflineminus">-  {</span>
<a href="#l20.504"></a><span id="l20.504" class="difflineplus">+  if (isImageDataShortened(src)) {</span>
<a href="#l20.505"></a><span id="l20.505">     src = restoredImageData(gDialog.srcInput);</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineminus">-  }</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineminus">-  else</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineminus">-  {</span>
<a href="#l20.509"></a><span id="l20.509" class="difflineplus">+  } else {</span>
<a href="#l20.510"></a><span id="l20.510">     var checkbox = document.getElementById(&quot;MakeRelativeCheckbox&quot;);</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineminus">-    try</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineminus">-    {</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineminus">-      if (checkbox &amp;&amp; !checkbox.checked)</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineminus">-      {</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineplus">+    try {</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineplus">+      if (checkbox &amp;&amp; !checkbox.checked) {</span>
<a href="#l20.517"></a><span id="l20.517">         src = Services.uriFixup.createFixupURI(src, Ci.nsIURIFixup.FIXUP_FLAG_NONE).spec;</span>
<a href="#l20.518"></a><span id="l20.518">       }</span>
<a href="#l20.519"></a><span id="l20.519">     } catch (e) { }</span>
<a href="#l20.520"></a><span id="l20.520"> </span>
<a href="#l20.521"></a><span id="l20.521">     globalElement.setAttribute(&quot;src&quot;, src);</span>
<a href="#l20.522"></a><span id="l20.522">   }</span>
<a href="#l20.523"></a><span id="l20.523"> </span>
<a href="#l20.524"></a><span id="l20.524">   let title = gDialog.titleInput.value.trim();</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineat">@@ -493,38 +445,32 @@ function ValidateImage()</span>
<a href="#l20.526"></a><span id="l20.526"> </span>
<a href="#l20.527"></a><span id="l20.527">   // Force user to enter Alt text only if &quot;Alternate text&quot; radio is checked</span>
<a href="#l20.528"></a><span id="l20.528">   // Don't allow just spaces in alt text</span>
<a href="#l20.529"></a><span id="l20.529">   var alt = &quot;&quot;;</span>
<a href="#l20.530"></a><span id="l20.530">   var useAlt = gDialog.altTextRadioGroup.selectedItem == gDialog.altTextRadio;</span>
<a href="#l20.531"></a><span id="l20.531">   if (useAlt)</span>
<a href="#l20.532"></a><span id="l20.532">     alt = TrimString(gDialog.altTextInput.value);</span>
<a href="#l20.533"></a><span id="l20.533"> </span>
<a href="#l20.534"></a><span id="l20.534" class="difflineminus">-  if (alt || !useAlt)</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineminus">-  {</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineplus">+  if (alt || !useAlt) {</span>
<a href="#l20.537"></a><span id="l20.537">     globalElement.setAttribute(&quot;alt&quot;, alt);</span>
<a href="#l20.538"></a><span id="l20.538" class="difflineminus">-  }</span>
<a href="#l20.539"></a><span id="l20.539" class="difflineminus">-  else if (!gDoAltTextError)</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineminus">-  {</span>
<a href="#l20.541"></a><span id="l20.541" class="difflineplus">+  } else if (!gDoAltTextError) {</span>
<a href="#l20.542"></a><span id="l20.542">     globalElement.removeAttribute(&quot;alt&quot;);</span>
<a href="#l20.543"></a><span id="l20.543" class="difflineminus">-  }</span>
<a href="#l20.544"></a><span id="l20.544" class="difflineminus">-  else</span>
<a href="#l20.545"></a><span id="l20.545" class="difflineminus">-  {</span>
<a href="#l20.546"></a><span id="l20.546" class="difflineplus">+  } else {</span>
<a href="#l20.547"></a><span id="l20.547">     Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;NoAltText&quot;));</span>
<a href="#l20.548"></a><span id="l20.548">     SwitchToValidatePanel();</span>
<a href="#l20.549"></a><span id="l20.549">     gDialog.altTextInput.focus();</span>
<a href="#l20.550"></a><span id="l20.550">     return false;</span>
<a href="#l20.551"></a><span id="l20.551">   }</span>
<a href="#l20.552"></a><span id="l20.552"> </span>
<a href="#l20.553"></a><span id="l20.553">   var width = &quot;&quot;;</span>
<a href="#l20.554"></a><span id="l20.554">   var height = &quot;&quot;;</span>
<a href="#l20.555"></a><span id="l20.555"> </span>
<a href="#l20.556"></a><span id="l20.556">   gValidateTab = gDialog.tabDimensions;</span>
<a href="#l20.557"></a><span id="l20.557" class="difflineminus">-  if (!gDialog.actualSizeRadio.selected)</span>
<a href="#l20.558"></a><span id="l20.558" class="difflineminus">-  {</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineplus">+  if (!gDialog.actualSizeRadio.selected) {</span>
<a href="#l20.560"></a><span id="l20.560">     // Get user values for width and height</span>
<a href="#l20.561"></a><span id="l20.561">     width = ValidateNumber(gDialog.widthInput, gDialog.widthUnitsMenulist, 1, gMaxPixels,</span>
<a href="#l20.562"></a><span id="l20.562">                            globalElement, &quot;width&quot;, false, true);</span>
<a href="#l20.563"></a><span id="l20.563">     if (gValidationError)</span>
<a href="#l20.564"></a><span id="l20.564">       return false;</span>
<a href="#l20.565"></a><span id="l20.565"> </span>
<a href="#l20.566"></a><span id="l20.566">     height = ValidateNumber(gDialog.heightInput, gDialog.heightUnitsMenulist, 1, gMaxPixels,</span>
<a href="#l20.567"></a><span id="l20.567">                             globalElement, &quot;height&quot;, false, true);</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineat">@@ -569,24 +515,23 @@ function ValidateImage()</span>
<a href="#l20.569"></a><span id="l20.569">                  globalElement, &quot;border&quot;, false, true);</span>
<a href="#l20.570"></a><span id="l20.570">   if (gValidationError)</span>
<a href="#l20.571"></a><span id="l20.571">     return false;</span>
<a href="#l20.572"></a><span id="l20.572"> </span>
<a href="#l20.573"></a><span id="l20.573">   // Default or setting &quot;bottom&quot; means don't set the attribute</span>
<a href="#l20.574"></a><span id="l20.574">   // Note that the attributes &quot;left&quot; and &quot;right&quot; are opposite</span>
<a href="#l20.575"></a><span id="l20.575">   //  of what we use in the UI, which describes where the TEXT wraps,</span>
<a href="#l20.576"></a><span id="l20.576">   //  not the image location (which is what the HTML describes)</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineminus">-  switch ( gDialog.alignTypeSelect.value )</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineminus">-  {</span>
<a href="#l20.579"></a><span id="l20.579" class="difflineplus">+  switch (gDialog.alignTypeSelect.value) {</span>
<a href="#l20.580"></a><span id="l20.580">     case &quot;top&quot;:</span>
<a href="#l20.581"></a><span id="l20.581">     case &quot;middle&quot;:</span>
<a href="#l20.582"></a><span id="l20.582">     case &quot;right&quot;:</span>
<a href="#l20.583"></a><span id="l20.583">     case &quot;left&quot;:</span>
<a href="#l20.584"></a><span id="l20.584" class="difflineminus">-      editor.setAttributeOrEquivalent( globalElement, &quot;align&quot;,</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineminus">-                                       gDialog.alignTypeSelect.value , true);</span>
<a href="#l20.586"></a><span id="l20.586" class="difflineplus">+      editor.setAttributeOrEquivalent(globalElement, &quot;align&quot;,</span>
<a href="#l20.587"></a><span id="l20.587" class="difflineplus">+                                       gDialog.alignTypeSelect.value, true);</span>
<a href="#l20.588"></a><span id="l20.588">       break;</span>
<a href="#l20.589"></a><span id="l20.589">     default:</span>
<a href="#l20.590"></a><span id="l20.590">       try {</span>
<a href="#l20.591"></a><span id="l20.591">         editor.removeAttributeOrEquivalent(globalElement, &quot;align&quot;, true);</span>
<a href="#l20.592"></a><span id="l20.592">       } catch (e) {}</span>
<a href="#l20.593"></a><span id="l20.593">   }</span>
<a href="#l20.594"></a><span id="l20.594"> </span>
<a href="#l20.595"></a><span id="l20.595">   return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdImageLinkLoader.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdImageLinkLoader.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -9,37 +9,34 @@ var gMsgCompInputElement = null;</span>
<a href="#l21.4"></a><span id="l21.4"> var gMsgCompPrevInputValue = null;</span>
<a href="#l21.5"></a><span id="l21.5"> var gMsgCompPrevMozDoNotSendAttribute;</span>
<a href="#l21.6"></a><span id="l21.6"> var gMsgCompAttachSourceElement = null;</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> function OnLoadDialog() {</span>
<a href="#l21.9"></a><span id="l21.9">   gMsgCompAttachSourceElement = document.getElementById(&quot;AttachSourceToMail&quot;);</span>
<a href="#l21.10"></a><span id="l21.10">   var editor = GetCurrentEditor();</span>
<a href="#l21.11"></a><span id="l21.11">   if (gMsgCompAttachSourceElement &amp;&amp; editor &amp;&amp;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-      (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask))</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  {</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-    SetRelativeCheckbox = function() { SetAttachCheckbox();};</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-    //initialize the AttachSourceToMail checkbox</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+      (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)) {</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+    SetRelativeCheckbox = function() { SetAttachCheckbox(); };</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+    // initialize the AttachSourceToMail checkbox</span>
<a href="#l21.19"></a><span id="l21.19">     gMsgCompAttachSourceElement.hidden = false;</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-    switch (document.documentElement.id)</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-    {</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+    switch (document.documentElement.id) {</span>
<a href="#l21.24"></a><span id="l21.24">       case &quot;imageDlg&quot;:</span>
<a href="#l21.25"></a><span id="l21.25">         gMsgCompInputElement = gDialog.srcInput;</span>
<a href="#l21.26"></a><span id="l21.26">         gMsgCompProcessLink = false;</span>
<a href="#l21.27"></a><span id="l21.27">         break;</span>
<a href="#l21.28"></a><span id="l21.28">       case &quot;linkDlg&quot; :</span>
<a href="#l21.29"></a><span id="l21.29">         gMsgCompInputElement =  gDialog.hrefInput;</span>
<a href="#l21.30"></a><span id="l21.30">         gMsgCompProcessLink = true;</span>
<a href="#l21.31"></a><span id="l21.31">         break;</span>
<a href="#l21.32"></a><span id="l21.32">     }</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-    if (gMsgCompInputElement)</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-    {</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+    if (gMsgCompInputElement) {</span>
<a href="#l21.36"></a><span id="l21.36">       SetAttachCheckbox();</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-      gMsgCompPrevMozDoNotSendAttribute = globalElement.getAttribute(&quot;moz-do-not-send&quot;)</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+      gMsgCompPrevMozDoNotSendAttribute = globalElement.getAttribute(&quot;moz-do-not-send&quot;);</span>
<a href="#l21.39"></a><span id="l21.39">     }</span>
<a href="#l21.40"></a><span id="l21.40">   }</span>
<a href="#l21.41"></a><span id="l21.41"> }</span>
<a href="#l21.42"></a><span id="l21.42"> addEventListener(&quot;load&quot;, OnLoadDialog, false);</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44"> function OnAcceptDialog() {</span>
<a href="#l21.45"></a><span id="l21.45">   // Auto-convert file URLs to data URLs. If we're in the link properties</span>
<a href="#l21.46"></a><span id="l21.46">   // dialog convert only when requested - for the image dialog do it always.</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineat">@@ -52,52 +49,46 @@ function OnAcceptDialog() {</span>
<a href="#l21.48"></a><span id="l21.48">   DoAttachSourceCheckbox();</span>
<a href="#l21.49"></a><span id="l21.49"> }</span>
<a href="#l21.50"></a><span id="l21.50"> document.addEventListener(&quot;dialogaccept&quot;, OnAcceptDialog, true);</span>
<a href="#l21.51"></a><span id="l21.51"> </span>
<a href="#l21.52"></a><span id="l21.52"> function SetAttachCheckbox() {</span>
<a href="#l21.53"></a><span id="l21.53">   var resetCheckbox = false;</span>
<a href="#l21.54"></a><span id="l21.54">   var mozDoNotSend = globalElement.getAttribute(&quot;moz-do-not-send&quot;);</span>
<a href="#l21.55"></a><span id="l21.55"> </span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-  //In case somebody played with the advanced property and changed the moz-do-not-send attribute</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  if (mozDoNotSend != gMsgCompPrevMozDoNotSendAttribute)</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-  {</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+  // In case somebody played with the advanced property and changed the moz-do-not-send attribute</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+  if (mozDoNotSend != gMsgCompPrevMozDoNotSendAttribute) {</span>
<a href="#l21.61"></a><span id="l21.61">     gMsgCompPrevMozDoNotSendAttribute = mozDoNotSend;</span>
<a href="#l21.62"></a><span id="l21.62">     resetCheckbox = true;</span>
<a href="#l21.63"></a><span id="l21.63">   }</span>
<a href="#l21.64"></a><span id="l21.64"> </span>
<a href="#l21.65"></a><span id="l21.65">   // Has the URL changed</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  if (gMsgCompInputElement &amp;&amp; gMsgCompInputElement.value != gMsgCompPrevInputValue)</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-  {</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+  if (gMsgCompInputElement &amp;&amp; gMsgCompInputElement.value != gMsgCompPrevInputValue) {</span>
<a href="#l21.69"></a><span id="l21.69">     gMsgCompPrevInputValue = gMsgCompInputElement.value;</span>
<a href="#l21.70"></a><span id="l21.70">     resetCheckbox = true;</span>
<a href="#l21.71"></a><span id="l21.71">   }</span>
<a href="#l21.72"></a><span id="l21.72"> </span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  if (gMsgCompInputElement &amp;&amp; resetCheckbox)</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-  {</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  if (gMsgCompInputElement &amp;&amp; resetCheckbox) {</span>
<a href="#l21.76"></a><span id="l21.76">     // Here is the rule about how to set the checkbox Attach Source To Message:</span>
<a href="#l21.77"></a><span id="l21.77">     // If the attribute &quot;moz-do-not-send&quot; has not been set, we look at the scheme of the URL</span>
<a href="#l21.78"></a><span id="l21.78">     // and at some preference to decide what is the best for the user.</span>
<a href="#l21.79"></a><span id="l21.79">     // If it is set to &quot;false&quot;, the checkbox is checked, otherwise unchecked.</span>
<a href="#l21.80"></a><span id="l21.80">     var attach = false;</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-    if (mozDoNotSend == null)</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-    {</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+    if (mozDoNotSend == null) {</span>
<a href="#l21.84"></a><span id="l21.84">       // We haven't yet set the &quot;moz-do-not-send&quot; attribute.</span>
<a href="#l21.85"></a><span id="l21.85">       var inputValue = gMsgCompInputElement.value.trim();</span>
<a href="#l21.86"></a><span id="l21.86">       if (/^(file|data):/i.test(inputValue)) {</span>
<a href="#l21.87"></a><span id="l21.87">         // For files or data URLs, default to attach them.</span>
<a href="#l21.88"></a><span id="l21.88">         attach = true;</span>
<a href="#l21.89"></a><span id="l21.89">       } else if (!gMsgCompProcessLink &amp;&amp; // Implies image dialogue.</span>
<a href="#l21.90"></a><span id="l21.90">                  /^https?:/i.test(inputValue)) {</span>
<a href="#l21.91"></a><span id="l21.91">         // For images loaded via http(s) we default to the preference value.</span>
<a href="#l21.92"></a><span id="l21.92">         attach = Services.prefs.getBoolPref(&quot;mail.compose.attach_http_images&quot;);</span>
<a href="#l21.93"></a><span id="l21.93">       }</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-    }</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-    else</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-    {</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+    } else {</span>
<a href="#l21.98"></a><span id="l21.98">       attach = (mozDoNotSend == &quot;false&quot;);</span>
<a href="#l21.99"></a><span id="l21.99">     }</span>
<a href="#l21.100"></a><span id="l21.100"> </span>
<a href="#l21.101"></a><span id="l21.101">     gMsgCompAttachSourceElement.checked = attach;</span>
<a href="#l21.102"></a><span id="l21.102">   }</span>
<a href="#l21.103"></a><span id="l21.103"> }</span>
<a href="#l21.104"></a><span id="l21.104"> </span>
<a href="#l21.105"></a><span id="l21.105"> function DoAttachSourceCheckbox() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdImageProps.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdImageProps.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -7,310 +7,263 @@ var gLinkElement = null;</span>
<a href="#l22.4"></a><span id="l22.4"> var gOriginalHref = &quot;&quot;;</span>
<a href="#l22.5"></a><span id="l22.5"> var gHNodeArray = {};</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> // dialog initialization code</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l22.10"></a><span id="l22.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-function Startup()</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-{</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+function Startup() {</span>
<a href="#l22.15"></a><span id="l22.15">   var editor = GetCurrentEditor();</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-  if (!editor)</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-  {</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l22.19"></a><span id="l22.19">     window.close();</span>
<a href="#l22.20"></a><span id="l22.20">     return;</span>
<a href="#l22.21"></a><span id="l22.21">   }</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23">   ImageStartup();</span>
<a href="#l22.24"></a><span id="l22.24">   gDialog.hrefInput        = document.getElementById(&quot;hrefInput&quot;);</span>
<a href="#l22.25"></a><span id="l22.25">   gDialog.makeRelativeLink = document.getElementById(&quot;MakeRelativeLink&quot;);</span>
<a href="#l22.26"></a><span id="l22.26">   gDialog.showLinkBorder   = document.getElementById(&quot;showLinkBorder&quot;);</span>
<a href="#l22.27"></a><span id="l22.27">   gDialog.linkTab          = document.getElementById(&quot;imageLinkTab&quot;);</span>
<a href="#l22.28"></a><span id="l22.28">   gDialog.linkAdvanced     = document.getElementById(&quot;LinkAdvancedEditButton&quot;);</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30">   // Get a single selected image element</span>
<a href="#l22.31"></a><span id="l22.31">   var tagName = &quot;img&quot;;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-  {</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l22.35"></a><span id="l22.35">     imageElement = window.arguments[0];</span>
<a href="#l22.36"></a><span id="l22.36">     // We've been called from form field properties, so we can't insert a link</span>
<a href="#l22.37"></a><span id="l22.37">     gDialog.linkTab.remove();</span>
<a href="#l22.38"></a><span id="l22.38">     gDialog.linkTab = null;</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-  }</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-  else</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-  {</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+  } else {</span>
<a href="#l22.43"></a><span id="l22.43">     // First check for &lt;input type=&quot;image&quot;&gt;</span>
<a href="#l22.44"></a><span id="l22.44">     try {</span>
<a href="#l22.45"></a><span id="l22.45">       imageElement = editor.getSelectedElement(&quot;input&quot;);</span>
<a href="#l22.46"></a><span id="l22.46"> </span>
<a href="#l22.47"></a><span id="l22.47">       if (!imageElement || imageElement.getAttribute(&quot;type&quot;) != &quot;image&quot;) {</span>
<a href="#l22.48"></a><span id="l22.48">         // Get a single selected image element</span>
<a href="#l22.49"></a><span id="l22.49">         imageElement = editor.getSelectedElement(tagName);</span>
<a href="#l22.50"></a><span id="l22.50">         if (imageElement)</span>
<a href="#l22.51"></a><span id="l22.51">           gAnchorElement = editor.getElementOrParentByTagName(&quot;href&quot;, imageElement);</span>
<a href="#l22.52"></a><span id="l22.52">       }</span>
<a href="#l22.53"></a><span id="l22.53">     } catch (e) {}</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-</span>
<a href="#l22.55"></a><span id="l22.55">   }</span>
<a href="#l22.56"></a><span id="l22.56"> </span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-  if (imageElement)</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-  {</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+  if (imageElement) {</span>
<a href="#l22.60"></a><span id="l22.60">     // We found an element and don't need to insert one</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-    if (imageElement.hasAttribute(&quot;src&quot;))</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-    {</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+    if (imageElement.hasAttribute(&quot;src&quot;)) {</span>
<a href="#l22.64"></a><span id="l22.64">       gInsertNewImage = false;</span>
<a href="#l22.65"></a><span id="l22.65">       gActualWidth  = imageElement.naturalWidth;</span>
<a href="#l22.66"></a><span id="l22.66">       gActualHeight = imageElement.naturalHeight;</span>
<a href="#l22.67"></a><span id="l22.67">     }</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-  }</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-  else</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-  {</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+  } else {</span>
<a href="#l22.72"></a><span id="l22.72">     gInsertNewImage = true;</span>
<a href="#l22.73"></a><span id="l22.73"> </span>
<a href="#l22.74"></a><span id="l22.74">     // We don't have an element selected,</span>
<a href="#l22.75"></a><span id="l22.75">     //  so create one with default attributes</span>
<a href="#l22.76"></a><span id="l22.76">     try {</span>
<a href="#l22.77"></a><span id="l22.77">       imageElement = editor.createElementWithDefaults(tagName);</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-    } catch(e) {}</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+    } catch (e) {}</span>
<a href="#l22.80"></a><span id="l22.80"> </span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-    if (!imageElement)</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-    {</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+    if (!imageElement) {</span>
<a href="#l22.84"></a><span id="l22.84">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l22.85"></a><span id="l22.85">       window.close();</span>
<a href="#l22.86"></a><span id="l22.86">       return;</span>
<a href="#l22.87"></a><span id="l22.87">     }</span>
<a href="#l22.88"></a><span id="l22.88">     try {</span>
<a href="#l22.89"></a><span id="l22.89">       gAnchorElement = editor.getSelectedElement(&quot;href&quot;);</span>
<a href="#l22.90"></a><span id="l22.90">     } catch (e) {}</span>
<a href="#l22.91"></a><span id="l22.91">   }</span>
<a href="#l22.92"></a><span id="l22.92"> </span>
<a href="#l22.93"></a><span id="l22.93">   // Make a copy to use for AdvancedEdit</span>
<a href="#l22.94"></a><span id="l22.94">   globalElement = imageElement.cloneNode(false);</span>
<a href="#l22.95"></a><span id="l22.95"> </span>
<a href="#l22.96"></a><span id="l22.96">   // We only need to test for this once per dialog load</span>
<a href="#l22.97"></a><span id="l22.97">   gHaveDocumentUrl = GetDocumentBaseUrl();</span>
<a href="#l22.98"></a><span id="l22.98"> </span>
<a href="#l22.99"></a><span id="l22.99">   InitDialog();</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-  if (gAnchorElement)</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-  {</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+  if (gAnchorElement) {</span>
<a href="#l22.103"></a><span id="l22.103">     gOriginalHref = gAnchorElement.getAttribute(&quot;href&quot;);</span>
<a href="#l22.104"></a><span id="l22.104">     // Make a copy to use for AdvancedEdit</span>
<a href="#l22.105"></a><span id="l22.105">     gLinkElement = gAnchorElement.cloneNode(false);</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineminus">-  }</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineminus">-  else</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineminus">-  {</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+  } else {</span>
<a href="#l22.110"></a><span id="l22.110">     gLinkElement = editor.createElementWithDefaults(&quot;a&quot;);</span>
<a href="#l22.111"></a><span id="l22.111">   }</span>
<a href="#l22.112"></a><span id="l22.112">   gDialog.hrefInput.value = gOriginalHref;</span>
<a href="#l22.113"></a><span id="l22.113"> </span>
<a href="#l22.114"></a><span id="l22.114">   FillLinkMenulist(gDialog.hrefInput, gHNodeArray);</span>
<a href="#l22.115"></a><span id="l22.115">   ChangeLinkLocation();</span>
<a href="#l22.116"></a><span id="l22.116"> </span>
<a href="#l22.117"></a><span id="l22.117">   // Save initial source URL</span>
<a href="#l22.118"></a><span id="l22.118">   gOriginalSrc = gDialog.srcInput.value;</span>
<a href="#l22.119"></a><span id="l22.119"> </span>
<a href="#l22.120"></a><span id="l22.120">   // By default turn constrain on, but both width and height must be in pixels</span>
<a href="#l22.121"></a><span id="l22.121">   gDialog.constrainCheckbox.checked =</span>
<a href="#l22.122"></a><span id="l22.122">     gDialog.widthUnitsMenulist.selectedIndex == 0 &amp;&amp;</span>
<a href="#l22.123"></a><span id="l22.123">     gDialog.heightUnitsMenulist.selectedIndex == 0;</span>
<a href="#l22.124"></a><span id="l22.124"> </span>
<a href="#l22.125"></a><span id="l22.125">   // Start in &quot;Link&quot; tab if 2nd argument is true</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-  if (gDialog.linkTab &amp;&amp; &quot;arguments&quot; in window &amp;&amp; window.arguments[1])</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-  {</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineplus">+  if (gDialog.linkTab &amp;&amp; &quot;arguments&quot; in window &amp;&amp; window.arguments[1]) {</span>
<a href="#l22.129"></a><span id="l22.129">     document.getElementById(&quot;TabBox&quot;).selectedTab = gDialog.linkTab;</span>
<a href="#l22.130"></a><span id="l22.130">     SetTextboxFocus(gDialog.hrefInput);</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-  }</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-  else</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+  } else</span>
<a href="#l22.134"></a><span id="l22.134">     SetTextboxFocus(gDialog.srcInput);</span>
<a href="#l22.135"></a><span id="l22.135"> </span>
<a href="#l22.136"></a><span id="l22.136">   SetWindowLocation();</span>
<a href="#l22.137"></a><span id="l22.137"> }</span>
<a href="#l22.138"></a><span id="l22.138"> </span>
<a href="#l22.139"></a><span id="l22.139"> // Set dialog widgets with attribute data</span>
<a href="#l22.140"></a><span id="l22.140"> // We get them from globalElement copy so this can be used</span>
<a href="#l22.141"></a><span id="l22.141"> //   by AdvancedEdit(), which is shared by all property dialogs</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-function InitDialog()</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-{</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineplus">+function InitDialog() {</span>
<a href="#l22.145"></a><span id="l22.145">   InitImage();</span>
<a href="#l22.146"></a><span id="l22.146">   var border = TrimString(gDialog.border.value);</span>
<a href="#l22.147"></a><span id="l22.147">   gDialog.showLinkBorder.checked = border != &quot;&quot; &amp;&amp; border &gt; 0;</span>
<a href="#l22.148"></a><span id="l22.148"> }</span>
<a href="#l22.149"></a><span id="l22.149"> </span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-function ChangeLinkLocation()</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-{</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+function ChangeLinkLocation() {</span>
<a href="#l22.153"></a><span id="l22.153">   var href = TrimString(gDialog.hrefInput.value);</span>
<a href="#l22.154"></a><span id="l22.154">   SetRelativeCheckbox(gDialog.makeRelativeLink);</span>
<a href="#l22.155"></a><span id="l22.155">   gDialog.showLinkBorder.disabled = !href;</span>
<a href="#l22.156"></a><span id="l22.156">   gDialog.linkAdvanced.disabled = !href;</span>
<a href="#l22.157"></a><span id="l22.157">   gLinkElement.setAttribute(&quot;href&quot;, href);</span>
<a href="#l22.158"></a><span id="l22.158"> }</span>
<a href="#l22.159"></a><span id="l22.159"> </span>
<a href="#l22.160"></a><span id="l22.160" class="difflineminus">-function ToggleShowLinkBorder()</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineminus">-{</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineminus">-  if (gDialog.showLinkBorder.checked)</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-  {</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineplus">+function ToggleShowLinkBorder() {</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+  if (gDialog.showLinkBorder.checked) {</span>
<a href="#l22.166"></a><span id="l22.166">     var border = TrimString(gDialog.border.value);</span>
<a href="#l22.167"></a><span id="l22.167">     if (!border || border == &quot;0&quot;)</span>
<a href="#l22.168"></a><span id="l22.168">       gDialog.border.value = &quot;2&quot;;</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-  }</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-  else</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineminus">-  {</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+  } else {</span>
<a href="#l22.173"></a><span id="l22.173">     gDialog.border.value = &quot;0&quot;;</span>
<a href="#l22.174"></a><span id="l22.174">   }</span>
<a href="#l22.175"></a><span id="l22.175"> }</span>
<a href="#l22.176"></a><span id="l22.176"> </span>
<a href="#l22.177"></a><span id="l22.177"> // Get data from widgets, validate, and set for the global element</span>
<a href="#l22.178"></a><span id="l22.178"> //   accessible to AdvancedEdit() [in EdDialogCommon.js]</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineminus">-function ValidateData()</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-{</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+function ValidateData() {</span>
<a href="#l22.182"></a><span id="l22.182">   return ValidateImage();</span>
<a href="#l22.183"></a><span id="l22.183"> }</span>
<a href="#l22.184"></a><span id="l22.184"> </span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-function onAccept(event)</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-{</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+function onAccept(event) {</span>
<a href="#l22.188"></a><span id="l22.188">   // Use this now (default = false) so Advanced Edit button dialog doesn't trigger error message</span>
<a href="#l22.189"></a><span id="l22.189">   gDoAltTextError = true;</span>
<a href="#l22.190"></a><span id="l22.190"> </span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-  if (ValidateData())</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineminus">-  {</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineminus">-    if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineminus">-    {</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+    if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l22.197"></a><span id="l22.197">       SaveWindowLocation();</span>
<a href="#l22.198"></a><span id="l22.198">       return;</span>
<a href="#l22.199"></a><span id="l22.199">     }</span>
<a href="#l22.200"></a><span id="l22.200"> </span>
<a href="#l22.201"></a><span id="l22.201">     var editor = GetCurrentEditor();</span>
<a href="#l22.202"></a><span id="l22.202"> </span>
<a href="#l22.203"></a><span id="l22.203">     editor.beginTransaction();</span>
<a href="#l22.204"></a><span id="l22.204"> </span>
<a href="#l22.205"></a><span id="l22.205" class="difflineminus">-    try</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineminus">-    {</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineminus">-      if (gRemoveImageMap)</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineminus">-      {</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineplus">+    try {</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+      if (gRemoveImageMap) {</span>
<a href="#l22.211"></a><span id="l22.211">         globalElement.removeAttribute(&quot;usemap&quot;);</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineminus">-        if (gImageMap)</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineminus">-        {</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineplus">+        if (gImageMap) {</span>
<a href="#l22.215"></a><span id="l22.215">           editor.deleteNode(gImageMap);</span>
<a href="#l22.216"></a><span id="l22.216">           gInsertNewIMap = true;</span>
<a href="#l22.217"></a><span id="l22.217">           gImageMap = null;</span>
<a href="#l22.218"></a><span id="l22.218">         }</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineminus">-      }</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineminus">-      else if (gImageMap)</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineminus">-      {</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineplus">+      } else if (gImageMap) {</span>
<a href="#l22.223"></a><span id="l22.223">         // un-comment to see that inserting image maps does not work!</span>
<a href="#l22.224"></a><span id="l22.224">         /*</span>
<a href="#l22.225"></a><span id="l22.225">         gImageMap = editor.createElementWithDefaults(&quot;map&quot;);</span>
<a href="#l22.226"></a><span id="l22.226">         gImageMap.setAttribute(&quot;name&quot;, &quot;testing&quot;);</span>
<a href="#l22.227"></a><span id="l22.227">         var testArea = editor.createElementWithDefaults(&quot;area&quot;);</span>
<a href="#l22.228"></a><span id="l22.228">         testArea.setAttribute(&quot;shape&quot;, &quot;circle&quot;);</span>
<a href="#l22.229"></a><span id="l22.229">         testArea.setAttribute(&quot;coords&quot;, &quot;86,102,52&quot;);</span>
<a href="#l22.230"></a><span id="l22.230">         testArea.setAttribute(&quot;href&quot;, &quot;test&quot;);</span>
<a href="#l22.231"></a><span id="l22.231">         gImageMap.appendChild(testArea);</span>
<a href="#l22.232"></a><span id="l22.232">         */</span>
<a href="#l22.233"></a><span id="l22.233"> </span>
<a href="#l22.234"></a><span id="l22.234">         // Assign to map if there is one</span>
<a href="#l22.235"></a><span id="l22.235">         var mapName = gImageMap.getAttribute(&quot;name&quot;);</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineminus">-        if (mapName != &quot;&quot;)</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineminus">-        {</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineminus">-          globalElement.setAttribute(&quot;usemap&quot;, (&quot;#&quot;+mapName));</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+        if (mapName != &quot;&quot;) {</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineplus">+          globalElement.setAttribute(&quot;usemap&quot;, (&quot;#&quot; + mapName));</span>
<a href="#l22.241"></a><span id="l22.241">           if (globalElement.getAttribute(&quot;border&quot;) == &quot;&quot;)</span>
<a href="#l22.242"></a><span id="l22.242">             globalElement.setAttribute(&quot;border&quot;, 0);</span>
<a href="#l22.243"></a><span id="l22.243">         }</span>
<a href="#l22.244"></a><span id="l22.244">       }</span>
<a href="#l22.245"></a><span id="l22.245"> </span>
<a href="#l22.246"></a><span id="l22.246">       // Create or remove the link as appropriate</span>
<a href="#l22.247"></a><span id="l22.247">       var href = gDialog.hrefInput.value;</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineminus">-      if (href != gOriginalHref)</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineminus">-      {</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineminus">-        if (href &amp;&amp; !gInsertNewImage)</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineminus">-        {</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+      if (href != gOriginalHref) {</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineplus">+        if (href &amp;&amp; !gInsertNewImage) {</span>
<a href="#l22.254"></a><span id="l22.254">           EditorSetTextProperty(&quot;a&quot;, &quot;href&quot;, href);</span>
<a href="#l22.255"></a><span id="l22.255">           // gAnchorElement is needed for cloning attributes later.</span>
<a href="#l22.256"></a><span id="l22.256">           if (!gAnchorElement)</span>
<a href="#l22.257"></a><span id="l22.257">             gAnchorElement = editor.getElementOrParentByTagName(&quot;href&quot;, imageElement);</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineminus">-        }</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineminus">-        else</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineminus">-        {</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+        } else {</span>
<a href="#l22.262"></a><span id="l22.262">           EditorRemoveTextProperty(&quot;href&quot;, &quot;&quot;);</span>
<a href="#l22.263"></a><span id="l22.263">         }</span>
<a href="#l22.264"></a><span id="l22.264">       }</span>
<a href="#l22.265"></a><span id="l22.265"> </span>
<a href="#l22.266"></a><span id="l22.266">       // If inside a link, always write the 'border' attribute</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineminus">-      if (href)</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-      {</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineminus">-        if (gDialog.showLinkBorder.checked)</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineminus">-        {</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineplus">+      if (href) {</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineplus">+        if (gDialog.showLinkBorder.checked) {</span>
<a href="#l22.273"></a><span id="l22.273">           // Use default = 2 if border attribute is empty</span>
<a href="#l22.274"></a><span id="l22.274">           if (!globalElement.hasAttribute(&quot;border&quot;))</span>
<a href="#l22.275"></a><span id="l22.275">             globalElement.setAttribute(&quot;border&quot;, &quot;2&quot;);</span>
<a href="#l22.276"></a><span id="l22.276" class="difflineminus">-        }</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineminus">-        else</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineplus">+        } else</span>
<a href="#l22.279"></a><span id="l22.279">           globalElement.setAttribute(&quot;border&quot;, &quot;0&quot;);</span>
<a href="#l22.280"></a><span id="l22.280">       }</span>
<a href="#l22.281"></a><span id="l22.281"> </span>
<a href="#l22.282"></a><span id="l22.282" class="difflineminus">-      if (gInsertNewImage)</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineminus">-      {</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineplus">+      if (gInsertNewImage) {</span>
<a href="#l22.285"></a><span id="l22.285">         if (href) {</span>
<a href="#l22.286"></a><span id="l22.286">           gLinkElement.appendChild(imageElement);</span>
<a href="#l22.287"></a><span id="l22.287">           editor.insertElementAtSelection(gLinkElement, true);</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineminus">-        }</span>
<a href="#l22.289"></a><span id="l22.289" class="difflineminus">-        else</span>
<a href="#l22.290"></a><span id="l22.290" class="difflineplus">+        } else</span>
<a href="#l22.291"></a><span id="l22.291">           // 'true' means delete the selection before inserting</span>
<a href="#l22.292"></a><span id="l22.292">           editor.insertElementAtSelection(imageElement, true);</span>
<a href="#l22.293"></a><span id="l22.293">       }</span>
<a href="#l22.294"></a><span id="l22.294"> </span>
<a href="#l22.295"></a><span id="l22.295">       // Check to see if the link was to a heading</span>
<a href="#l22.296"></a><span id="l22.296">       // Do this last because it moves the caret (BAD!)</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineminus">-      if (href in gHNodeArray)</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineminus">-      {</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineplus">+      if (href in gHNodeArray) {</span>
<a href="#l22.300"></a><span id="l22.300">         var anchorNode = editor.createElementWithDefaults(&quot;a&quot;);</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineminus">-        if (anchorNode)</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineminus">-        {</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineplus">+        if (anchorNode) {</span>
<a href="#l22.304"></a><span id="l22.304">           anchorNode.name = href.substr(1);</span>
<a href="#l22.305"></a><span id="l22.305">           // Remember to use editor method so it is undoable!</span>
<a href="#l22.306"></a><span id="l22.306">           editor.insertNode(anchorNode, gHNodeArray[href], 0, false);</span>
<a href="#l22.307"></a><span id="l22.307">         }</span>
<a href="#l22.308"></a><span id="l22.308">       }</span>
<a href="#l22.309"></a><span id="l22.309">       // All values are valid - copy to actual element in doc or</span>
<a href="#l22.310"></a><span id="l22.310">       //   element we just inserted</span>
<a href="#l22.311"></a><span id="l22.311">       editor.cloneAttributes(imageElement, globalElement);</span>
<a href="#l22.312"></a><span id="l22.312">       if (gAnchorElement)</span>
<a href="#l22.313"></a><span id="l22.313">         editor.cloneAttributes(gAnchorElement, gLinkElement);</span>
<a href="#l22.314"></a><span id="l22.314"> </span>
<a href="#l22.315"></a><span id="l22.315">       // If document is empty, the map element won't insert,</span>
<a href="#l22.316"></a><span id="l22.316">       //  so always insert the image first</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineminus">-      if (gImageMap &amp;&amp; gInsertNewIMap)</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineminus">-      {</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineplus">+      if (gImageMap &amp;&amp; gInsertNewIMap) {</span>
<a href="#l22.320"></a><span id="l22.320">         // Insert the ImageMap element at beginning of document</span>
<a href="#l22.321"></a><span id="l22.321">         var body = editor.rootElement;</span>
<a href="#l22.322"></a><span id="l22.322">         editor.setShouldTxnSetSelection(false);</span>
<a href="#l22.323"></a><span id="l22.323">         editor.insertNode(gImageMap, body, 0);</span>
<a href="#l22.324"></a><span id="l22.324">         editor.setShouldTxnSetSelection(true);</span>
<a href="#l22.325"></a><span id="l22.325">       }</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineminus">-    }</span>
<a href="#l22.327"></a><span id="l22.327" class="difflineminus">-    catch (e)</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineminus">-    {</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineplus">+    } catch (e) {</span>
<a href="#l22.330"></a><span id="l22.330">       dump(e);</span>
<a href="#l22.331"></a><span id="l22.331">     }</span>
<a href="#l22.332"></a><span id="l22.332"> </span>
<a href="#l22.333"></a><span id="l22.333">     editor.endTransaction();</span>
<a href="#l22.334"></a><span id="l22.334"> </span>
<a href="#l22.335"></a><span id="l22.335">     SaveWindowLocation();</span>
<a href="#l22.336"></a><span id="l22.336">     return;</span>
<a href="#l22.337"></a><span id="l22.337">   }</span>
<a href="#l22.338"></a><span id="l22.338"> </span>
<a href="#l22.339"></a><span id="l22.339">   gDoAltTextError = false;</span>
<a href="#l22.340"></a><span id="l22.340"> </span>
<a href="#l22.341"></a><span id="l22.341">   event.preventDefault();</span>
<a href="#l22.342"></a><span id="l22.342"> }</span>
<a href="#l22.343"></a><span id="l22.343"> </span>
<a href="#l22.344"></a><span id="l22.344" class="difflineminus">-function onLinkAdvancedEdit()</span>
<a href="#l22.345"></a><span id="l22.345" class="difflineminus">-{</span>
<a href="#l22.346"></a><span id="l22.346" class="difflineplus">+function onLinkAdvancedEdit() {</span>
<a href="#l22.347"></a><span id="l22.347">   window.AdvancedEditOK = false;</span>
<a href="#l22.348"></a><span id="l22.348">   window.openDialog(&quot;chrome://editor/content/EdAdvancedEdit.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l22.349"></a><span id="l22.349">                     &quot;chrome,close,titlebar,modal,resizable=yes&quot;, &quot;&quot;,</span>
<a href="#l22.350"></a><span id="l22.350">                     gLinkElement);</span>
<a href="#l22.351"></a><span id="l22.351">   window.focus();</span>
<a href="#l22.352"></a><span id="l22.352">   if (window.AdvancedEditOK)</span>
<a href="#l22.353"></a><span id="l22.353">     gDialog.hrefInput.value = gLinkElement.getAttribute(&quot;href&quot;);</span>
<a href="#l22.354"></a><span id="l22.354"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInputImage.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInputImage.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -2,67 +2,60 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.5"></a><span id="l23.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> // dialog initialization code</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l23.10"></a><span id="l23.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-function Startup()</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-{</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+function Startup() {</span>
<a href="#l23.15"></a><span id="l23.15">   var editor = GetCurrentEditor();</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-  if (!editor)</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-  {</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l23.19"></a><span id="l23.19">     window.close();</span>
<a href="#l23.20"></a><span id="l23.20">     return;</span>
<a href="#l23.21"></a><span id="l23.21">   }</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23">   gDialog = {</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-    inputName:      document.getElementById( &quot;InputName&quot; ),</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-    inputDisabled:  document.getElementById( &quot;InputDisabled&quot; ),</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-    inputTabIndex:  document.getElementById( &quot;InputTabIndex&quot; )</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+    inputName:      document.getElementById(&quot;InputName&quot;),</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+    inputDisabled:  document.getElementById(&quot;InputDisabled&quot;),</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+    inputTabIndex:  document.getElementById(&quot;InputTabIndex&quot;),</span>
<a href="#l23.30"></a><span id="l23.30">   };</span>
<a href="#l23.31"></a><span id="l23.31"> </span>
<a href="#l23.32"></a><span id="l23.32">   ImageStartup();</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34">   // Get a single selected input element</span>
<a href="#l23.35"></a><span id="l23.35">   var tagName = &quot;input&quot;;</span>
<a href="#l23.36"></a><span id="l23.36">   try {</span>
<a href="#l23.37"></a><span id="l23.37">     imageElement = editor.getSelectedElement(tagName);</span>
<a href="#l23.38"></a><span id="l23.38">   } catch (e) {}</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-  if (imageElement)</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-  {</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+  if (imageElement) {</span>
<a href="#l23.43"></a><span id="l23.43">     // We found an element and don't need to insert one</span>
<a href="#l23.44"></a><span id="l23.44">     gInsertNewImage = false;</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-  }</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-  else</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-  {</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+  } else {</span>
<a href="#l23.49"></a><span id="l23.49">     gInsertNewImage = true;</span>
<a href="#l23.50"></a><span id="l23.50"> </span>
<a href="#l23.51"></a><span id="l23.51">     // We don't have an element selected,</span>
<a href="#l23.52"></a><span id="l23.52">     //  so create one with default attributes</span>
<a href="#l23.53"></a><span id="l23.53">     try {</span>
<a href="#l23.54"></a><span id="l23.54">       imageElement = editor.createElementWithDefaults(tagName);</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-    } catch(e) {}</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+    } catch (e) {}</span>
<a href="#l23.57"></a><span id="l23.57"> </span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-    if (!imageElement )</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-    {</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+    if (!imageElement) {</span>
<a href="#l23.61"></a><span id="l23.61">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l23.62"></a><span id="l23.62">       window.close();</span>
<a href="#l23.63"></a><span id="l23.63">       return;</span>
<a href="#l23.64"></a><span id="l23.64">     }</span>
<a href="#l23.65"></a><span id="l23.65">     var imgElement;</span>
<a href="#l23.66"></a><span id="l23.66">     try {</span>
<a href="#l23.67"></a><span id="l23.67">       imgElement = editor.getSelectedElement(&quot;img&quot;);</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-    } catch(e) {}</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+    } catch (e) {}</span>
<a href="#l23.70"></a><span id="l23.70"> </span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-    if (imgElement)</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-    {</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+    if (imgElement) {</span>
<a href="#l23.74"></a><span id="l23.74">       // We found an image element, convert it to an input type=&quot;image&quot;</span>
<a href="#l23.75"></a><span id="l23.75">       var attributes = [&quot;src&quot;, &quot;alt&quot;, &quot;width&quot;, &quot;height&quot;, &quot;hspace&quot;, &quot;vspace&quot;, &quot;border&quot;, &quot;align&quot;, &quot;usemap&quot;, &quot;ismap&quot;];</span>
<a href="#l23.76"></a><span id="l23.76">       for (i in attributes)</span>
<a href="#l23.77"></a><span id="l23.77">         imageElement.setAttribute(attributes[i], imgElement.getAttribute(attributes[i]));</span>
<a href="#l23.78"></a><span id="l23.78">     }</span>
<a href="#l23.79"></a><span id="l23.79">   }</span>
<a href="#l23.80"></a><span id="l23.80"> </span>
<a href="#l23.81"></a><span id="l23.81">   // Make a copy to use for AdvancedEdit</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineat">@@ -81,26 +74,24 @@ function Startup()</span>
<a href="#l23.83"></a><span id="l23.83">     gDialog.widthUnitsMenulist.selectedIndex == 0 &amp;&amp;</span>
<a href="#l23.84"></a><span id="l23.84">     gDialog.heightUnitsMenulist.selectedIndex == 0;</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86">   SetTextboxFocus(gDialog.inputName);</span>
<a href="#l23.87"></a><span id="l23.87"> </span>
<a href="#l23.88"></a><span id="l23.88">   SetWindowLocation();</span>
<a href="#l23.89"></a><span id="l23.89"> }</span>
<a href="#l23.90"></a><span id="l23.90"> </span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-function InitDialog()</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-{</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+function InitDialog() {</span>
<a href="#l23.94"></a><span id="l23.94">   InitImage();</span>
<a href="#l23.95"></a><span id="l23.95">   gDialog.inputName.value = globalElement.getAttribute(&quot;name&quot;);</span>
<a href="#l23.96"></a><span id="l23.96">   gDialog.inputDisabled.setAttribute(&quot;checked&quot;, globalElement.hasAttribute(&quot;disabled&quot;));</span>
<a href="#l23.97"></a><span id="l23.97">   gDialog.inputTabIndex.value = globalElement.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l23.98"></a><span id="l23.98"> }</span>
<a href="#l23.99"></a><span id="l23.99"> </span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-function ValidateData()</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-{</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+function ValidateData() {</span>
<a href="#l23.103"></a><span id="l23.103">   if (!ValidateImage())</span>
<a href="#l23.104"></a><span id="l23.104">     return false;</span>
<a href="#l23.105"></a><span id="l23.105">   if (gDialog.inputName.value)</span>
<a href="#l23.106"></a><span id="l23.106">     globalElement.setAttribute(&quot;name&quot;, gDialog.inputName.value);</span>
<a href="#l23.107"></a><span id="l23.107">   else</span>
<a href="#l23.108"></a><span id="l23.108">     globalElement.removeAttribute(&quot;name&quot;);</span>
<a href="#l23.109"></a><span id="l23.109">   if (gDialog.inputTabIndex.value)</span>
<a href="#l23.110"></a><span id="l23.110">     globalElement.setAttribute(&quot;tabindex&quot;, gDialog.inputTabIndex.value);</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineat">@@ -109,65 +100,55 @@ function ValidateData()</span>
<a href="#l23.112"></a><span id="l23.112">   if (gDialog.inputDisabled.checked)</span>
<a href="#l23.113"></a><span id="l23.113">     globalElement.setAttribute(&quot;disabled&quot;, &quot;&quot;);</span>
<a href="#l23.114"></a><span id="l23.114">   else</span>
<a href="#l23.115"></a><span id="l23.115">     globalElement.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l23.116"></a><span id="l23.116">   globalElement.setAttribute(&quot;type&quot;, &quot;image&quot;);</span>
<a href="#l23.117"></a><span id="l23.117">   return true;</span>
<a href="#l23.118"></a><span id="l23.118"> }</span>
<a href="#l23.119"></a><span id="l23.119"> </span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-function onAccept(event)</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-{</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+function onAccept(event) {</span>
<a href="#l23.123"></a><span id="l23.123">   // Show alt text error only once</span>
<a href="#l23.124"></a><span id="l23.124">   // (we don't initialize doAltTextError=true</span>
<a href="#l23.125"></a><span id="l23.125">   //  so Advanced edit button dialog doesn't trigger that error message)</span>
<a href="#l23.126"></a><span id="l23.126">   // Use this now (default = false) so Advanced Edit button dialog doesn't trigger error message</span>
<a href="#l23.127"></a><span id="l23.127">   gDoAltTextError = true;</span>
<a href="#l23.128"></a><span id="l23.128"> </span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-  if (ValidateData())</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-  {</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l23.133"></a><span id="l23.133">     var editor = GetCurrentEditor();</span>
<a href="#l23.134"></a><span id="l23.134">     editor.beginTransaction();</span>
<a href="#l23.135"></a><span id="l23.135"> </span>
<a href="#l23.136"></a><span id="l23.136">     try {</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-      if (gRemoveImageMap)</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-      {</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+      if (gRemoveImageMap) {</span>
<a href="#l23.140"></a><span id="l23.140">         globalElement.removeAttribute(&quot;usemap&quot;);</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-        if (gImageMap)</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-        {</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+        if (gImageMap) {</span>
<a href="#l23.144"></a><span id="l23.144">           editor.deleteNode(gImageMap);</span>
<a href="#l23.145"></a><span id="l23.145">           gInsertNewIMap = true;</span>
<a href="#l23.146"></a><span id="l23.146">           gImageMap = null;</span>
<a href="#l23.147"></a><span id="l23.147">         }</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-      }</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-      else if (gImageMap)</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-      {</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineplus">+      } else if (gImageMap) {</span>
<a href="#l23.152"></a><span id="l23.152">         // Assign to map if there is one</span>
<a href="#l23.153"></a><span id="l23.153">         var mapName = gImageMap.getAttribute(&quot;name&quot;);</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-        if (mapName != &quot;&quot;)</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineminus">-        {</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-          globalElement.setAttribute(&quot;usemap&quot;, (&quot;#&quot;+mapName));</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+        if (mapName != &quot;&quot;) {</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+          globalElement.setAttribute(&quot;usemap&quot;, (&quot;#&quot; + mapName));</span>
<a href="#l23.159"></a><span id="l23.159">           if (globalElement.getAttribute(&quot;border&quot;) == &quot;&quot;)</span>
<a href="#l23.160"></a><span id="l23.160">             globalElement.setAttribute(&quot;border&quot;, 0);</span>
<a href="#l23.161"></a><span id="l23.161">         }</span>
<a href="#l23.162"></a><span id="l23.162">       }</span>
<a href="#l23.163"></a><span id="l23.163"> </span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-      if (gInsertNewImage)</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-      {</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineplus">+      if (gInsertNewImage) {</span>
<a href="#l23.167"></a><span id="l23.167">         // 'true' means delete the selection before inserting</span>
<a href="#l23.168"></a><span id="l23.168">         // in case were are converting an image to an input type=&quot;image&quot;</span>
<a href="#l23.169"></a><span id="l23.169">         editor.insertElementAtSelection(imageElement, true);</span>
<a href="#l23.170"></a><span id="l23.170">       }</span>
<a href="#l23.171"></a><span id="l23.171">       editor.cloneAttributes(imageElement, globalElement);</span>
<a href="#l23.172"></a><span id="l23.172"> </span>
<a href="#l23.173"></a><span id="l23.173">       // If document is empty, the map element won't insert,</span>
<a href="#l23.174"></a><span id="l23.174">       //  so always insert the image element first</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineminus">-      if (gImageMap &amp;&amp; gInsertNewIMap)</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-      {</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineplus">+      if (gImageMap &amp;&amp; gInsertNewIMap) {</span>
<a href="#l23.178"></a><span id="l23.178">         // Insert the ImageMap element at beginning of document</span>
<a href="#l23.179"></a><span id="l23.179">         var body = editor.rootElement;</span>
<a href="#l23.180"></a><span id="l23.180">         editor.setShouldTxnSetSelection(false);</span>
<a href="#l23.181"></a><span id="l23.181">         editor.insertNode(gImageMap, body, 0);</span>
<a href="#l23.182"></a><span id="l23.182">         editor.setShouldTxnSetSelection(true);</span>
<a href="#l23.183"></a><span id="l23.183">       }</span>
<a href="#l23.184"></a><span id="l23.184">     } catch (e) {}</span>
<a href="#l23.185"></a><span id="l23.185"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInputProps.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInputProps.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -5,21 +5,19 @@</span>
<a href="#l24.4"></a><span id="l24.4"> var insertNew;</span>
<a href="#l24.5"></a><span id="l24.5"> var inputElement;</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> // dialog initialization code</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l24.10"></a><span id="l24.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-function Startup()</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-{</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+function Startup() {</span>
<a href="#l24.15"></a><span id="l24.15">   var editor = GetCurrentEditor();</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-  if (!editor)</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-  {</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l24.19"></a><span id="l24.19">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l24.20"></a><span id="l24.20">     window.close();</span>
<a href="#l24.21"></a><span id="l24.21">     return;</span>
<a href="#l24.22"></a><span id="l24.22">   }</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24">   gDialog = {</span>
<a href="#l24.25"></a><span id="l24.25">     accept:             document.documentElement.getButton(&quot;accept&quot;),</span>
<a href="#l24.26"></a><span id="l24.26">     inputType:          document.getElementById(&quot;InputType&quot;),</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineat">@@ -35,77 +33,71 @@ function Startup()</span>
<a href="#l24.28"></a><span id="l24.28">     inputTabIndex:      document.getElementById(&quot;InputTabIndex&quot;),</span>
<a href="#l24.29"></a><span id="l24.29">     inputAccessKey:     document.getElementById(&quot;InputAccessKey&quot;),</span>
<a href="#l24.30"></a><span id="l24.30">     inputSize:          document.getElementById(&quot;InputSize&quot;),</span>
<a href="#l24.31"></a><span id="l24.31">     inputMaxLength:     document.getElementById(&quot;InputMaxLength&quot;),</span>
<a href="#l24.32"></a><span id="l24.32">     inputAccept:        document.getElementById(&quot;InputAccept&quot;),</span>
<a href="#l24.33"></a><span id="l24.33">     MoreSection:        document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l24.34"></a><span id="l24.34">     MoreFewerButton:    document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l24.35"></a><span id="l24.35">     AdvancedEditButton: document.getElementById(&quot;AdvancedEditButton&quot;),</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-    AdvancedEditDeck:   document.getElementById(&quot;AdvancedEditDeck&quot;)</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+    AdvancedEditDeck:   document.getElementById(&quot;AdvancedEditDeck&quot;),</span>
<a href="#l24.38"></a><span id="l24.38">   };</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40">   // Get a single selected input element</span>
<a href="#l24.41"></a><span id="l24.41">   const kTagName = &quot;input&quot;;</span>
<a href="#l24.42"></a><span id="l24.42">   try {</span>
<a href="#l24.43"></a><span id="l24.43">     inputElement = editor.getSelectedElement(kTagName);</span>
<a href="#l24.44"></a><span id="l24.44">   } catch (e) {}</span>
<a href="#l24.45"></a><span id="l24.45"> </span>
<a href="#l24.46"></a><span id="l24.46">   if (inputElement)</span>
<a href="#l24.47"></a><span id="l24.47">     // We found an element and don't need to insert one</span>
<a href="#l24.48"></a><span id="l24.48">     insertNew = false;</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-  else</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-  {</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+  else {</span>
<a href="#l24.52"></a><span id="l24.52">     insertNew = true;</span>
<a href="#l24.53"></a><span id="l24.53"> </span>
<a href="#l24.54"></a><span id="l24.54">     // We don't have an element selected,</span>
<a href="#l24.55"></a><span id="l24.55">     //  so create one with default attributes</span>
<a href="#l24.56"></a><span id="l24.56">     try {</span>
<a href="#l24.57"></a><span id="l24.57">       inputElement = editor.createElementWithDefaults(kTagName);</span>
<a href="#l24.58"></a><span id="l24.58">     } catch (e) {}</span>
<a href="#l24.59"></a><span id="l24.59"> </span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-    if (!inputElement)</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-    {</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+    if (!inputElement) {</span>
<a href="#l24.63"></a><span id="l24.63">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l24.64"></a><span id="l24.64">       window.close();</span>
<a href="#l24.65"></a><span id="l24.65">       return;</span>
<a href="#l24.66"></a><span id="l24.66">     }</span>
<a href="#l24.67"></a><span id="l24.67"> </span>
<a href="#l24.68"></a><span id="l24.68">     var imgElement = editor.getSelectedElement(&quot;img&quot;);</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-    if (imgElement)</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-    {</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+    if (imgElement) {</span>
<a href="#l24.72"></a><span id="l24.72">       // We found an image element, convert it to an input type=&quot;image&quot;</span>
<a href="#l24.73"></a><span id="l24.73">       inputElement.setAttribute(&quot;type&quot;, &quot;image&quot;);</span>
<a href="#l24.74"></a><span id="l24.74"> </span>
<a href="#l24.75"></a><span id="l24.75">       var attributes = [&quot;src&quot;, &quot;alt&quot;, &quot;width&quot;, &quot;height&quot;, &quot;hspace&quot;, &quot;vspace&quot;, &quot;border&quot;, &quot;align&quot;];</span>
<a href="#l24.76"></a><span id="l24.76">       for (i in attributes)</span>
<a href="#l24.77"></a><span id="l24.77">         inputElement.setAttribute(attributes[i], imgElement.getAttribute(attributes[i]));</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-    }</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-    else</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+    } else</span>
<a href="#l24.81"></a><span id="l24.81">       inputElement.setAttribute(&quot;value&quot;, GetSelectionAsText());</span>
<a href="#l24.82"></a><span id="l24.82">   }</span>
<a href="#l24.83"></a><span id="l24.83"> </span>
<a href="#l24.84"></a><span id="l24.84">   // Make a copy to use for AdvancedEdit</span>
<a href="#l24.85"></a><span id="l24.85">   globalElement = inputElement.cloneNode(false);</span>
<a href="#l24.86"></a><span id="l24.86"> </span>
<a href="#l24.87"></a><span id="l24.87">   InitDialog();</span>
<a href="#l24.88"></a><span id="l24.88"> </span>
<a href="#l24.89"></a><span id="l24.89">   InitMoreFewer();</span>
<a href="#l24.90"></a><span id="l24.90"> </span>
<a href="#l24.91"></a><span id="l24.91">   gDialog.inputType.focus();</span>
<a href="#l24.92"></a><span id="l24.92"> </span>
<a href="#l24.93"></a><span id="l24.93">   SetWindowLocation();</span>
<a href="#l24.94"></a><span id="l24.94"> }</span>
<a href="#l24.95"></a><span id="l24.95"> </span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-function InitDialog()</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-{</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+function InitDialog() {</span>
<a href="#l24.99"></a><span id="l24.99">   var type = globalElement.getAttribute(&quot;type&quot;);</span>
<a href="#l24.100"></a><span id="l24.100">   var index = 0;</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-  switch (type)</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineminus">-  {</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+  switch (type) {</span>
<a href="#l24.104"></a><span id="l24.104">     case &quot;button&quot;:</span>
<a href="#l24.105"></a><span id="l24.105">       index = 9;</span>
<a href="#l24.106"></a><span id="l24.106">       break;</span>
<a href="#l24.107"></a><span id="l24.107">     case &quot;checkbox&quot;:</span>
<a href="#l24.108"></a><span id="l24.108">       index = 2;</span>
<a href="#l24.109"></a><span id="l24.109">       break;</span>
<a href="#l24.110"></a><span id="l24.110">     case &quot;file&quot;:</span>
<a href="#l24.111"></a><span id="l24.111">       index = 6;</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineat">@@ -139,33 +131,31 @@ function InitDialog()</span>
<a href="#l24.113"></a><span id="l24.113">   gDialog.inputTabIndex.value = globalElement.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l24.114"></a><span id="l24.114">   gDialog.inputAccessKey.value = globalElement.getAttribute(&quot;accesskey&quot;);</span>
<a href="#l24.115"></a><span id="l24.115">   gDialog.inputSize.value = globalElement.getAttribute(&quot;size&quot;);</span>
<a href="#l24.116"></a><span id="l24.116">   gDialog.inputMaxLength.value = globalElement.getAttribute(&quot;maxlength&quot;);</span>
<a href="#l24.117"></a><span id="l24.117">   gDialog.inputAccept.value = globalElement.getAttribute(&quot;accept&quot;);</span>
<a href="#l24.118"></a><span id="l24.118">   SelectInputType();</span>
<a href="#l24.119"></a><span id="l24.119"> }</span>
<a href="#l24.120"></a><span id="l24.120"> </span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-function SelectInputType()</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-{</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+function SelectInputType() {</span>
<a href="#l24.124"></a><span id="l24.124">   var index = gDialog.inputType.selectedIndex;</span>
<a href="#l24.125"></a><span id="l24.125">   gDialog.AdvancedEditDeck.setAttribute(&quot;selectedIndex&quot;, 0);</span>
<a href="#l24.126"></a><span id="l24.126">   gDialog.inputNameDeck.setAttribute(&quot;selectedIndex&quot;, 0);</span>
<a href="#l24.127"></a><span id="l24.127">   gDialog.inputValueDeck.setAttribute(&quot;selectedIndex&quot;, 0);</span>
<a href="#l24.128"></a><span id="l24.128">   gDialog.inputValue.disabled = false;</span>
<a href="#l24.129"></a><span id="l24.129">   gDialog.inputChecked.disabled = index != 2;</span>
<a href="#l24.130"></a><span id="l24.130">   gDialog.inputSelected.disabled = index != 3;</span>
<a href="#l24.131"></a><span id="l24.131">   gDialog.inputReadOnly.disabled = index &gt; 1;</span>
<a href="#l24.132"></a><span id="l24.132">   gDialog.inputTabIndex.disabled = index == 7;</span>
<a href="#l24.133"></a><span id="l24.133">   gDialog.inputAccessKey.disabled = index == 7;</span>
<a href="#l24.134"></a><span id="l24.134">   gDialog.inputSize.disabled = index &gt; 1;</span>
<a href="#l24.135"></a><span id="l24.135">   gDialog.inputMaxLength.disabled = index &gt; 1;</span>
<a href="#l24.136"></a><span id="l24.136">   gDialog.inputAccept.disabled = index != 6;</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-  switch (index)</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-  {</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+  switch (index) {</span>
<a href="#l24.140"></a><span id="l24.140">     case 0:</span>
<a href="#l24.141"></a><span id="l24.141">     case 1:</span>
<a href="#l24.142"></a><span id="l24.142">       gDialog.inputValueDeck.setAttribute(&quot;selectedIndex&quot;, 1);</span>
<a href="#l24.143"></a><span id="l24.143">       gDialog.inputDeck.setAttribute(&quot;selectedIndex&quot;, 2);</span>
<a href="#l24.144"></a><span id="l24.144">       break;</span>
<a href="#l24.145"></a><span id="l24.145">     case 2:</span>
<a href="#l24.146"></a><span id="l24.146">       gDialog.inputDeck.setAttribute(&quot;selectedIndex&quot;, 0);</span>
<a href="#l24.147"></a><span id="l24.147">       break;</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineat">@@ -184,68 +174,62 @@ function SelectInputType()</span>
<a href="#l24.149"></a><span id="l24.149">       break;</span>
<a href="#l24.150"></a><span id="l24.150">     case 7:</span>
<a href="#l24.151"></a><span id="l24.151">       gDialog.inputValueDeck.setAttribute(&quot;selectedIndex&quot;, 1);</span>
<a href="#l24.152"></a><span id="l24.152">       break;</span>
<a href="#l24.153"></a><span id="l24.153">   }</span>
<a href="#l24.154"></a><span id="l24.154">   onInput();</span>
<a href="#l24.155"></a><span id="l24.155"> }</span>
<a href="#l24.156"></a><span id="l24.156"> </span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-function onInput()</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">-{</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-  var disabled = false;;</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-  switch (gDialog.inputType.selectedIndex)</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-  {</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+function onInput() {</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineplus">+  var disabled = false;</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+  switch (gDialog.inputType.selectedIndex) {</span>
<a href="#l24.165"></a><span id="l24.165">   case 3:</span>
<a href="#l24.166"></a><span id="l24.166">     disabled = disabled || !gDialog.inputValue.value;</span>
<a href="#l24.167"></a><span id="l24.167">   case 4:</span>
<a href="#l24.168"></a><span id="l24.168">   case 5:</span>
<a href="#l24.169"></a><span id="l24.169">     break;</span>
<a href="#l24.170"></a><span id="l24.170">   case 8:</span>
<a href="#l24.171"></a><span id="l24.171">     disabled = !globalElement.hasAttribute(&quot;src&quot;);</span>
<a href="#l24.172"></a><span id="l24.172">     break;</span>
<a href="#l24.173"></a><span id="l24.173">   default:</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-    disabled = !gDialog.inputName.value</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+    disabled = !gDialog.inputName.value;</span>
<a href="#l24.176"></a><span id="l24.176">     break;</span>
<a href="#l24.177"></a><span id="l24.177">   }</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-  if (gDialog.accept.disabled != disabled)</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineminus">-  {</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineplus">+  if (gDialog.accept.disabled != disabled) {</span>
<a href="#l24.181"></a><span id="l24.181">     gDialog.accept.disabled = disabled;</span>
<a href="#l24.182"></a><span id="l24.182">     gDialog.AdvancedEditButton.disabled = disabled;</span>
<a href="#l24.183"></a><span id="l24.183">   }</span>
<a href="#l24.184"></a><span id="l24.184"> }</span>
<a href="#l24.185"></a><span id="l24.185"> </span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-function doImageProperties()</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-{</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+function doImageProperties() {</span>
<a href="#l24.189"></a><span id="l24.189">   window.openDialog(&quot;chrome://editor/content/EdImageProps.xul&quot;,</span>
<a href="#l24.190"></a><span id="l24.190">                     &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, globalElement);</span>
<a href="#l24.191"></a><span id="l24.191">   window.focus();</span>
<a href="#l24.192"></a><span id="l24.192">   onInput();</span>
<a href="#l24.193"></a><span id="l24.193"> }</span>
<a href="#l24.194"></a><span id="l24.194"> </span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">-function ValidateData()</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-{</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineplus">+function ValidateData() {</span>
<a href="#l24.198"></a><span id="l24.198">   var attributes = {</span>
<a href="#l24.199"></a><span id="l24.199">     type: &quot;&quot;,</span>
<a href="#l24.200"></a><span id="l24.200">     name: gDialog.inputName.value,</span>
<a href="#l24.201"></a><span id="l24.201">     value: gDialog.inputValue.value,</span>
<a href="#l24.202"></a><span id="l24.202">     tabindex: gDialog.inputTabIndex.value,</span>
<a href="#l24.203"></a><span id="l24.203">     accesskey: &quot;&quot;,</span>
<a href="#l24.204"></a><span id="l24.204">     size: &quot;&quot;,</span>
<a href="#l24.205"></a><span id="l24.205">     maxlength: &quot;&quot;,</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineminus">-    accept: &quot;&quot;</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineplus">+    accept: &quot;&quot;,</span>
<a href="#l24.208"></a><span id="l24.208">   };</span>
<a href="#l24.209"></a><span id="l24.209">   var index = gDialog.inputType.selectedIndex;</span>
<a href="#l24.210"></a><span id="l24.210">   var flags = {</span>
<a href="#l24.211"></a><span id="l24.211">     checked: false,</span>
<a href="#l24.212"></a><span id="l24.212">     readonly: false,</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineminus">-    disabled: gDialog.inputDisabled.checked</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineplus">+    disabled: gDialog.inputDisabled.checked,</span>
<a href="#l24.215"></a><span id="l24.215">   };</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineminus">-  switch (index)</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineminus">-  {</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineplus">+  switch (index) {</span>
<a href="#l24.219"></a><span id="l24.219">     case 1:</span>
<a href="#l24.220"></a><span id="l24.220">       attributes.type = &quot;password&quot;;</span>
<a href="#l24.221"></a><span id="l24.221">     case 0:</span>
<a href="#l24.222"></a><span id="l24.222">       flags.readonly = gDialog.inputReadOnly.checked;</span>
<a href="#l24.223"></a><span id="l24.223">       attributes.size = gDialog.inputSize.value;</span>
<a href="#l24.224"></a><span id="l24.224">       attributes.maxlength = gDialog.inputMaxLength.value;</span>
<a href="#l24.225"></a><span id="l24.225">       break;</span>
<a href="#l24.226"></a><span id="l24.226">     case 2:</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineat">@@ -277,46 +261,41 @@ function ValidateData()</span>
<a href="#l24.228"></a><span id="l24.228">       attributes.type = &quot;image&quot;;</span>
<a href="#l24.229"></a><span id="l24.229">       attributes.value = &quot;&quot;;</span>
<a href="#l24.230"></a><span id="l24.230">       break;</span>
<a href="#l24.231"></a><span id="l24.231">     case 9:</span>
<a href="#l24.232"></a><span id="l24.232">       attributes.type = &quot;button&quot;;</span>
<a href="#l24.233"></a><span id="l24.233">       attributes.accesskey = gDialog.inputAccessKey.value;</span>
<a href="#l24.234"></a><span id="l24.234">       break;</span>
<a href="#l24.235"></a><span id="l24.235">   }</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-  for (var a in attributes)</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-  {</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineplus">+  for (var a in attributes) {</span>
<a href="#l24.239"></a><span id="l24.239">     if (attributes[a])</span>
<a href="#l24.240"></a><span id="l24.240">       globalElement.setAttribute(a, attributes[a]);</span>
<a href="#l24.241"></a><span id="l24.241">     else</span>
<a href="#l24.242"></a><span id="l24.242">       globalElement.removeAttribute(a);</span>
<a href="#l24.243"></a><span id="l24.243">   }</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineminus">-  for (var f in flags)</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineminus">-  {</span>
<a href="#l24.246"></a><span id="l24.246" class="difflineplus">+  for (var f in flags) {</span>
<a href="#l24.247"></a><span id="l24.247">     if (flags[f])</span>
<a href="#l24.248"></a><span id="l24.248">       globalElement.setAttribute(f, &quot;&quot;);</span>
<a href="#l24.249"></a><span id="l24.249">     else</span>
<a href="#l24.250"></a><span id="l24.250">       globalElement.removeAttribute(f);</span>
<a href="#l24.251"></a><span id="l24.251">   }</span>
<a href="#l24.252"></a><span id="l24.252">   return true;</span>
<a href="#l24.253"></a><span id="l24.253"> }</span>
<a href="#l24.254"></a><span id="l24.254"> </span>
<a href="#l24.255"></a><span id="l24.255" class="difflineminus">-function onAccept(event)</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-{</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-  if (ValidateData())</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-  {</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineplus">+function onAccept(event) {</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l24.261"></a><span id="l24.261">     // All values are valid - copy to actual element in doc or</span>
<a href="#l24.262"></a><span id="l24.262">     //   element created to insert</span>
<a href="#l24.263"></a><span id="l24.263"> </span>
<a href="#l24.264"></a><span id="l24.264">     var editor = GetCurrentEditor();</span>
<a href="#l24.265"></a><span id="l24.265"> </span>
<a href="#l24.266"></a><span id="l24.266">     editor.cloneAttributes(inputElement, globalElement);</span>
<a href="#l24.267"></a><span id="l24.267"> </span>
<a href="#l24.268"></a><span id="l24.268" class="difflineminus">-    if (insertNew)</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineminus">-    {</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineplus">+    if (insertNew) {</span>
<a href="#l24.271"></a><span id="l24.271">       try {</span>
<a href="#l24.272"></a><span id="l24.272">         // 'true' means delete the selection before inserting</span>
<a href="#l24.273"></a><span id="l24.273">         // in case were are converting an image to an input type=&quot;image&quot;</span>
<a href="#l24.274"></a><span id="l24.274">         editor.insertElementAtSelection(inputElement, true);</span>
<a href="#l24.275"></a><span id="l24.275">       } catch (e) {</span>
<a href="#l24.276"></a><span id="l24.276">         dump(e);</span>
<a href="#l24.277"></a><span id="l24.277">       }</span>
<a href="#l24.278"></a><span id="l24.278">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsSrc.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsSrc.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -7,57 +7,52 @@</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> var gFullDataStrings = new Map();</span>
<a href="#l25.6"></a><span id="l25.6"> var gShortDataStrings = new Map();</span>
<a href="#l25.7"></a><span id="l25.7"> var gListenerAttached = false;</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l25.10"></a><span id="l25.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-function Startup()</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-{</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+function Startup() {</span>
<a href="#l25.15"></a><span id="l25.15">   let editor = GetCurrentEditor();</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-  if (!editor)</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-  {</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l25.19"></a><span id="l25.19">     window.close();</span>
<a href="#l25.20"></a><span id="l25.20">     return;</span>
<a href="#l25.21"></a><span id="l25.21">   }</span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23">   document.documentElement.getButton(&quot;accept&quot;).removeAttribute(&quot;default&quot;);</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25">   // Create dialog object to store controls for easy access</span>
<a href="#l25.26"></a><span id="l25.26">   gDialog.srcInput = document.getElementById(&quot;srcInput&quot;);</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28">   // Attach a paste listener so we can detect pasted data URIs we need to shorten.</span>
<a href="#l25.29"></a><span id="l25.29">   gDialog.srcInput.addEventListener(&quot;paste&quot;, onPaste);</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31">   let selection;</span>
<a href="#l25.32"></a><span id="l25.32">   try {</span>
<a href="#l25.33"></a><span id="l25.33">     selection = editor.outputToString(&quot;text/html&quot;, kOutputFormatted | kOutputSelectionOnly | kOutputWrap);</span>
<a href="#l25.34"></a><span id="l25.34">   } catch (e) {}</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-  if (selection)</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-  {</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-    selection = (selection.replace(/&lt;body[^&gt;]*&gt;/,&quot;&quot;)).replace(/&lt;\/body&gt;/,&quot;&quot;);</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+  if (selection) {</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+    selection = (selection.replace(/&lt;body[^&gt;]*&gt;/, &quot;&quot;)).replace(/&lt;\/body&gt;/, &quot;&quot;);</span>
<a href="#l25.40"></a><span id="l25.40"> </span>
<a href="#l25.41"></a><span id="l25.41">     // Shorten data URIs for display.</span>
<a href="#l25.42"></a><span id="l25.42">     selection = replaceDataURIs(selection);</span>
<a href="#l25.43"></a><span id="l25.43"> </span>
<a href="#l25.44"></a><span id="l25.44">     if (selection)</span>
<a href="#l25.45"></a><span id="l25.45">       gDialog.srcInput.value = selection;</span>
<a href="#l25.46"></a><span id="l25.46">   }</span>
<a href="#l25.47"></a><span id="l25.47">   // Set initial focus</span>
<a href="#l25.48"></a><span id="l25.48">   gDialog.srcInput.focus();</span>
<a href="#l25.49"></a><span id="l25.49">   SetWindowLocation();</span>
<a href="#l25.50"></a><span id="l25.50"> }</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-function replaceDataURIs(input)</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-{</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+function replaceDataURIs(input) {</span>
<a href="#l25.55"></a><span id="l25.55">   return input.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi,</span>
<a href="#l25.56"></a><span id="l25.56">     function(match, nonDataPart, dataPart) {</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-</span>
<a href="#l25.58"></a><span id="l25.58">       if (gShortDataStrings.has(dataPart)) {</span>
<a href="#l25.59"></a><span id="l25.59">           // We found the exact same data URI, just return the shortened URI.</span>
<a href="#l25.60"></a><span id="l25.60">           return nonDataPart + gShortDataStrings.get(dataPart);</span>
<a href="#l25.61"></a><span id="l25.61">       }</span>
<a href="#l25.62"></a><span id="l25.62"> </span>
<a href="#l25.63"></a><span id="l25.63">       let l = 5;</span>
<a href="#l25.64"></a><span id="l25.64">       // Normally we insert the ellipsis after five characters but if it's not unique</span>
<a href="#l25.65"></a><span id="l25.65">       // we include more data.</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineat">@@ -75,18 +70,17 @@ function replaceDataURIs(input)</span>
<a href="#l25.67"></a><span id="l25.67">         gDialog.srcInput.addEventListener(&quot;cut&quot;, onCopyOrCut);</span>
<a href="#l25.68"></a><span id="l25.68">         gListenerAttached = true;</span>
<a href="#l25.69"></a><span id="l25.69">       }</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71">       return nonDataPart + key;</span>
<a href="#l25.72"></a><span id="l25.72">     });</span>
<a href="#l25.73"></a><span id="l25.73"> }</span>
<a href="#l25.74"></a><span id="l25.74"> </span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-function onCopyOrCut(event)</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-{</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+function onCopyOrCut(event) {</span>
<a href="#l25.78"></a><span id="l25.78">   let startPos = gDialog.srcInput.selectionStart;</span>
<a href="#l25.79"></a><span id="l25.79">   if (startPos == undefined)</span>
<a href="#l25.80"></a><span id="l25.80">     return;</span>
<a href="#l25.81"></a><span id="l25.81">   let endPos = gDialog.srcInput.selectionEnd;</span>
<a href="#l25.82"></a><span id="l25.82">   let clipboard = gDialog.srcInput.value.substring(startPos, endPos);</span>
<a href="#l25.83"></a><span id="l25.83"> </span>
<a href="#l25.84"></a><span id="l25.84">   // Add back the original data URIs we stashed away earlier.</span>
<a href="#l25.85"></a><span id="l25.85">   clipboard = clipboard.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi,</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineat">@@ -99,34 +93,32 @@ function onCopyOrCut(event)</span>
<a href="#l25.87"></a><span id="l25.87">   if (event.type == &quot;cut&quot;) {</span>
<a href="#l25.88"></a><span id="l25.88">     // We have to cut the selection manually.</span>
<a href="#l25.89"></a><span id="l25.89">     gDialog.srcInput.value = gDialog.srcInput.value.substr(0, startPos) +</span>
<a href="#l25.90"></a><span id="l25.90">                              gDialog.srcInput.value.substr(endPos);</span>
<a href="#l25.91"></a><span id="l25.91">   }</span>
<a href="#l25.92"></a><span id="l25.92">   event.preventDefault();</span>
<a href="#l25.93"></a><span id="l25.93"> }</span>
<a href="#l25.94"></a><span id="l25.94"> </span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-function onPaste(event)</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-{</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+function onPaste(event) {</span>
<a href="#l25.98"></a><span id="l25.98">   let startPos = gDialog.srcInput.selectionStart;</span>
<a href="#l25.99"></a><span id="l25.99">   if (startPos == undefined)</span>
<a href="#l25.100"></a><span id="l25.100">     return;</span>
<a href="#l25.101"></a><span id="l25.101">   let endPos = gDialog.srcInput.selectionEnd;</span>
<a href="#l25.102"></a><span id="l25.102">   let clipboard = event.clipboardData.getData(&quot;text/plain&quot;);</span>
<a href="#l25.103"></a><span id="l25.103"> </span>
<a href="#l25.104"></a><span id="l25.104">   // We do out own paste by replacing the selection with the pre-processed</span>
<a href="#l25.105"></a><span id="l25.105">   // clipboard data.</span>
<a href="#l25.106"></a><span id="l25.106">   gDialog.srcInput.value = gDialog.srcInput.value.substr(0, startPos) +</span>
<a href="#l25.107"></a><span id="l25.107">                            replaceDataURIs(clipboard) +</span>
<a href="#l25.108"></a><span id="l25.108">                            gDialog.srcInput.value.substr(endPos);</span>
<a href="#l25.109"></a><span id="l25.109">   event.preventDefault();</span>
<a href="#l25.110"></a><span id="l25.110"> }</span>
<a href="#l25.111"></a><span id="l25.111"> </span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-function onAccept(event)</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-{</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+function onAccept(event) {</span>
<a href="#l25.115"></a><span id="l25.115">   let html = gDialog.srcInput.value;</span>
<a href="#l25.116"></a><span id="l25.116">   if (!html) {</span>
<a href="#l25.117"></a><span id="l25.117">     event.preventDefault();</span>
<a href="#l25.118"></a><span id="l25.118">     return;</span>
<a href="#l25.119"></a><span id="l25.119">   }</span>
<a href="#l25.120"></a><span id="l25.120"> </span>
<a href="#l25.121"></a><span id="l25.121">   // Add back the original data URIs we stashed away earlier.</span>
<a href="#l25.122"></a><span id="l25.122">   html = html.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsertChars.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsertChars.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,97 +1,90 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.5"></a><span id="l26.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.6"></a><span id="l26.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8" class="difflineminus">-//------------------------------------------------------------------</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+// ------------------------------------------------------------------</span>
<a href="#l26.10"></a><span id="l26.10"> // From Unicode 3.0 Page 54. 3.11 Conjoining Jamo Behavior</span>
<a href="#l26.11"></a><span id="l26.11"> var SBase = 0xac00;</span>
<a href="#l26.12"></a><span id="l26.12"> var LBase = 0x1100;</span>
<a href="#l26.13"></a><span id="l26.13"> var VBase = 0x1161;</span>
<a href="#l26.14"></a><span id="l26.14"> var TBase = 0x11A7;</span>
<a href="#l26.15"></a><span id="l26.15"> var LCount = 19;</span>
<a href="#l26.16"></a><span id="l26.16"> var VCount = 21;</span>
<a href="#l26.17"></a><span id="l26.17"> var TCount = 28;</span>
<a href="#l26.18"></a><span id="l26.18"> var NCount = VCount * TCount;</span>
<a href="#l26.19"></a><span id="l26.19"> // End of Unicode 3.0</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21"> // dialog initialization code</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-function Startup()</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-{</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-  if (!GetCurrentEditor())</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-  {</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+function Startup() {</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+  if (!GetCurrentEditor()) {</span>
<a href="#l26.28"></a><span id="l26.28">     window.close();</span>
<a href="#l26.29"></a><span id="l26.29">     return;</span>
<a href="#l26.30"></a><span id="l26.30">   }</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32">   StartupLatin();</span>
<a href="#l26.33"></a><span id="l26.33"> </span>
<a href="#l26.34"></a><span id="l26.34">   // Set a variable on the opener window so we</span>
<a href="#l26.35"></a><span id="l26.35">   //  can track ownership of close this window with it</span>
<a href="#l26.36"></a><span id="l26.36">   window.opener.InsertCharWindow = window;</span>
<a href="#l26.37"></a><span id="l26.37">   window.sizeToContent();</span>
<a href="#l26.38"></a><span id="l26.38"> </span>
<a href="#l26.39"></a><span id="l26.39">   SetWindowLocation();</span>
<a href="#l26.40"></a><span id="l26.40"> }</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-function onAccept()</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-{</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+function onAccept() {</span>
<a href="#l26.45"></a><span id="l26.45">   // Insert the character</span>
<a href="#l26.46"></a><span id="l26.46">   try {</span>
<a href="#l26.47"></a><span id="l26.47">     GetCurrentEditor().insertText(LatinM.label);</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-  } catch(e) {}</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+  } catch (e) {}</span>
<a href="#l26.50"></a><span id="l26.50"> </span>
<a href="#l26.51"></a><span id="l26.51">   // Set persistent attributes to save</span>
<a href="#l26.52"></a><span id="l26.52">   //  which category, letter, and character modifier was used</span>
<a href="#l26.53"></a><span id="l26.53">   CategoryGroup.setAttribute(&quot;category&quot;, category);</span>
<a href="#l26.54"></a><span id="l26.54">   CategoryGroup.setAttribute(&quot;letter_index&quot;, indexL);</span>
<a href="#l26.55"></a><span id="l26.55">   CategoryGroup.setAttribute(&quot;char_index&quot;, indexM);</span>
<a href="#l26.56"></a><span id="l26.56"> </span>
<a href="#l26.57"></a><span id="l26.57">   // Don't close the dialog</span>
<a href="#l26.58"></a><span id="l26.58">   return false;</span>
<a href="#l26.59"></a><span id="l26.59"> }</span>
<a href="#l26.60"></a><span id="l26.60"> </span>
<a href="#l26.61"></a><span id="l26.61"> // Don't allow inserting in HTML Source Mode</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-function onFocus()</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-{</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+function onFocus() {</span>
<a href="#l26.65"></a><span id="l26.65">   var enable = true;</span>
<a href="#l26.66"></a><span id="l26.66">   if (&quot;gEditorDisplayMode&quot; in window.opener)</span>
<a href="#l26.67"></a><span id="l26.67">     enable = !window.opener.IsInHTMLSourceMode();</span>
<a href="#l26.68"></a><span id="l26.68"> </span>
<a href="#l26.69"></a><span id="l26.69">   SetElementEnabled(document.documentElement.getButton(&quot;accept&quot;), enable);</span>
<a href="#l26.70"></a><span id="l26.70"> }</span>
<a href="#l26.71"></a><span id="l26.71"> </span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-function onClose()</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-{</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+function onClose() {</span>
<a href="#l26.75"></a><span id="l26.75">   window.opener.InsertCharWindow = null;</span>
<a href="#l26.76"></a><span id="l26.76">   SaveWindowLocation();</span>
<a href="#l26.77"></a><span id="l26.77">   return true;</span>
<a href="#l26.78"></a><span id="l26.78"> }</span>
<a href="#l26.79"></a><span id="l26.79"> </span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-//------------------------------------------------------------------</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+// ------------------------------------------------------------------</span>
<a href="#l26.82"></a><span id="l26.82"> var LatinL;</span>
<a href="#l26.83"></a><span id="l26.83"> var LatinM;</span>
<a href="#l26.84"></a><span id="l26.84"> var LatinL_Label;</span>
<a href="#l26.85"></a><span id="l26.85"> var LatinM_Label;</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-var indexL=0;</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineminus">-var indexM=0;</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineminus">-var indexM_AU=0;</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-var indexM_AL=0;</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineminus">-var indexM_U=0;</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-var indexM_L=0;</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineminus">-var indexM_S=0;</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-var LItems=0;</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+var indexL = 0;</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineplus">+var indexM = 0;</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineplus">+var indexM_AU = 0;</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineplus">+var indexM_AL = 0;</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineplus">+var indexM_U = 0;</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineplus">+var indexM_L = 0;</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineplus">+var indexM_S = 0;</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+var LItems = 0;</span>
<a href="#l26.102"></a><span id="l26.102"> var category;</span>
<a href="#l26.103"></a><span id="l26.103"> var CategoryGroup;</span>
<a href="#l26.104"></a><span id="l26.104"> var initialize = true;</span>
<a href="#l26.105"></a><span id="l26.105"> </span>
<a href="#l26.106"></a><span id="l26.106" class="difflineminus">-function StartupLatin()</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineminus">-{</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineminus">-</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineplus">+function StartupLatin() {</span>
<a href="#l26.110"></a><span id="l26.110">   LatinL = document.getElementById(&quot;LatinL&quot;);</span>
<a href="#l26.111"></a><span id="l26.111">   LatinM = document.getElementById(&quot;LatinM&quot;);</span>
<a href="#l26.112"></a><span id="l26.112">   LatinL_Label = document.getElementById(&quot;LatinL_Label&quot;);</span>
<a href="#l26.113"></a><span id="l26.113">   LatinM_Label = document.getElementById(&quot;LatinM_Label&quot;);</span>
<a href="#l26.114"></a><span id="l26.114"> </span>
<a href="#l26.115"></a><span id="l26.115">   var Symbol      = document.getElementById(&quot;Symbol&quot;);</span>
<a href="#l26.116"></a><span id="l26.116">   var AccentUpper = document.getElementById(&quot;AccentUpper&quot;);</span>
<a href="#l26.117"></a><span id="l26.117">   var AccentLower = document.getElementById(&quot;AccentLower&quot;);</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineat">@@ -106,18 +99,17 @@ function StartupLatin()</span>
<a href="#l26.119"></a><span id="l26.119">   var index = Number(CategoryGroup.getAttribute(&quot;letter_index&quot;));</span>
<a href="#l26.120"></a><span id="l26.120">   if (index &amp;&amp; index &gt;= 0)</span>
<a href="#l26.121"></a><span id="l26.121">     indexL = index;</span>
<a href="#l26.122"></a><span id="l26.122">   index = Number(CategoryGroup.getAttribute(&quot;char_index&quot;));</span>
<a href="#l26.123"></a><span id="l26.123">   if (index &amp;&amp; index &gt;= 0)</span>
<a href="#l26.124"></a><span id="l26.124">     indexM = index;</span>
<a href="#l26.125"></a><span id="l26.125"> </span>
<a href="#l26.126"></a><span id="l26.126"> </span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-  switch (category)</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineminus">-  {</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+  switch (category) {</span>
<a href="#l26.130"></a><span id="l26.130">     case &quot;AccentUpper&quot;: // Uppercase Diacritical</span>
<a href="#l26.131"></a><span id="l26.131">       CategoryGroup.selectedItem = AccentUpper;</span>
<a href="#l26.132"></a><span id="l26.132">       indexM_AU = indexM;</span>
<a href="#l26.133"></a><span id="l26.133">       break;</span>
<a href="#l26.134"></a><span id="l26.134">     case &quot;AccentLower&quot;: // Lowercase Diacritical</span>
<a href="#l26.135"></a><span id="l26.135">       CategoryGroup.selectedItem = AccentLower;</span>
<a href="#l26.136"></a><span id="l26.136">       indexM_AL = indexM;</span>
<a href="#l26.137"></a><span id="l26.137">       break;</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineat">@@ -135,170 +127,155 @@ function StartupLatin()</span>
<a href="#l26.139"></a><span id="l26.139">       indexM_S = indexM;</span>
<a href="#l26.140"></a><span id="l26.140">       break;</span>
<a href="#l26.141"></a><span id="l26.141">   }</span>
<a href="#l26.142"></a><span id="l26.142"> </span>
<a href="#l26.143"></a><span id="l26.143">   ChangeCategory(category);</span>
<a href="#l26.144"></a><span id="l26.144">   initialize = false;</span>
<a href="#l26.145"></a><span id="l26.145"> }</span>
<a href="#l26.146"></a><span id="l26.146"> </span>
<a href="#l26.147"></a><span id="l26.147" class="difflineminus">-function ChangeCategory(newCategory)</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineminus">-{</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineminus">-  if (category != newCategory || initialize)</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineminus">-  {</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineplus">+function ChangeCategory(newCategory) {</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineplus">+  if (category != newCategory || initialize) {</span>
<a href="#l26.153"></a><span id="l26.153">     category = newCategory;</span>
<a href="#l26.154"></a><span id="l26.154">     // Note: Must do L before M to set LatinL.selectedIndex</span>
<a href="#l26.155"></a><span id="l26.155">     UpdateLatinL();</span>
<a href="#l26.156"></a><span id="l26.156">     UpdateLatinM();</span>
<a href="#l26.157"></a><span id="l26.157">     UpdateCharacter();</span>
<a href="#l26.158"></a><span id="l26.158">   }</span>
<a href="#l26.159"></a><span id="l26.159"> }</span>
<a href="#l26.160"></a><span id="l26.160"> </span>
<a href="#l26.161"></a><span id="l26.161" class="difflineminus">-function SelectLatinLetter()</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineminus">-{</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-  if(LatinL.selectedIndex != indexL )</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-  {</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineplus">+function SelectLatinLetter() {</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+  if (LatinL.selectedIndex != indexL) {</span>
<a href="#l26.167"></a><span id="l26.167">     indexL = LatinL.selectedIndex;</span>
<a href="#l26.168"></a><span id="l26.168">     UpdateLatinM();</span>
<a href="#l26.169"></a><span id="l26.169">     UpdateCharacter();</span>
<a href="#l26.170"></a><span id="l26.170">   }</span>
<a href="#l26.171"></a><span id="l26.171"> }</span>
<a href="#l26.172"></a><span id="l26.172"> </span>
<a href="#l26.173"></a><span id="l26.173" class="difflineminus">-function SelectLatinModifier()</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineminus">-{</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineminus">-  if(LatinM.selectedIndex != indexM )</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineminus">-  {</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineplus">+function SelectLatinModifier() {</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineplus">+  if (LatinM.selectedIndex != indexM) {</span>
<a href="#l26.179"></a><span id="l26.179">     indexM = LatinM.selectedIndex;</span>
<a href="#l26.180"></a><span id="l26.180">     UpdateCharacter();</span>
<a href="#l26.181"></a><span id="l26.181">   }</span>
<a href="#l26.182"></a><span id="l26.182"> }</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineminus">-function DisableLatinL(disable)</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineminus">-{</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineplus">+function DisableLatinL(disable) {</span>
<a href="#l26.186"></a><span id="l26.186">   if (disable) {</span>
<a href="#l26.187"></a><span id="l26.187">     LatinL_Label.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.188"></a><span id="l26.188">     LatinL.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l26.189"></a><span id="l26.189">   } else {</span>
<a href="#l26.190"></a><span id="l26.190">     LatinL_Label.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.191"></a><span id="l26.191">     LatinL.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l26.192"></a><span id="l26.192">   }</span>
<a href="#l26.193"></a><span id="l26.193"> }</span>
<a href="#l26.194"></a><span id="l26.194"> </span>
<a href="#l26.195"></a><span id="l26.195" class="difflineminus">-function UpdateLatinL()</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineminus">-{</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineplus">+function UpdateLatinL() {</span>
<a href="#l26.198"></a><span id="l26.198">   LatinL.removeAllItems();</span>
<a href="#l26.199"></a><span id="l26.199" class="difflineminus">-  if (category == &quot;AccentUpper&quot; || category == &quot;AccentLower&quot;)</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineminus">-  {</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineplus">+  if (category == &quot;AccentUpper&quot; || category == &quot;AccentLower&quot;) {</span>
<a href="#l26.202"></a><span id="l26.202">     DisableLatinL(false);</span>
<a href="#l26.203"></a><span id="l26.203">     // No Q or q</span>
<a href="#l26.204"></a><span id="l26.204">     var alphabet = category == &quot;AccentUpper&quot; ? &quot;ABCDEFGHIJKLMNOPRSTUVWXYZ&quot; : &quot;abcdefghijklmnoprstuvwxyz&quot;;</span>
<a href="#l26.205"></a><span id="l26.205">     for (var letter = 0; letter &lt; alphabet.length; letter++)</span>
<a href="#l26.206"></a><span id="l26.206">       LatinL.appendItem(alphabet.charAt(letter));</span>
<a href="#l26.207"></a><span id="l26.207"> </span>
<a href="#l26.208"></a><span id="l26.208">     LatinL.selectedIndex = indexL;</span>
<a href="#l26.209"></a><span id="l26.209" class="difflineminus">-  }</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineminus">-  else</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineminus">-  {</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineplus">+  } else {</span>
<a href="#l26.213"></a><span id="l26.213">     // Other categories don't hinge on a &quot;letter&quot;</span>
<a href="#l26.214"></a><span id="l26.214">     DisableLatinL(true);</span>
<a href="#l26.215"></a><span id="l26.215">     // Note: don't change the indexL so it can be used next time</span>
<a href="#l26.216"></a><span id="l26.216">   }</span>
<a href="#l26.217"></a><span id="l26.217"> }</span>
<a href="#l26.218"></a><span id="l26.218"> </span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-function UpdateLatinM()</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineminus">-{</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineplus">+function UpdateLatinM() {</span>
<a href="#l26.222"></a><span id="l26.222">   LatinM.removeAllItems();</span>
<a href="#l26.223"></a><span id="l26.223">   var i, accent;</span>
<a href="#l26.224"></a><span id="l26.224" class="difflineminus">-  switch(category)</span>
<a href="#l26.225"></a><span id="l26.225" class="difflineminus">-  {</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineplus">+  switch (category) {</span>
<a href="#l26.227"></a><span id="l26.227">     case &quot;AccentUpper&quot;: // Uppercase Diacritical</span>
<a href="#l26.228"></a><span id="l26.228">       accent = upper[indexL];</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineminus">-      for(i=0; i &lt; accent.length; i++)</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineplus">+      for (i = 0; i &lt; accent.length; i++)</span>
<a href="#l26.231"></a><span id="l26.231">         LatinM.appendItem(accent.charAt(i));</span>
<a href="#l26.232"></a><span id="l26.232"> </span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-      if(indexM_AU &lt; accent.length)</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineplus">+      if (indexM_AU &lt; accent.length)</span>
<a href="#l26.235"></a><span id="l26.235">         indexM = indexM_AU;</span>
<a href="#l26.236"></a><span id="l26.236">       else</span>
<a href="#l26.237"></a><span id="l26.237">         indexM = accent.length - 1;</span>
<a href="#l26.238"></a><span id="l26.238">       indexM_AU = indexM;</span>
<a href="#l26.239"></a><span id="l26.239">       break;</span>
<a href="#l26.240"></a><span id="l26.240"> </span>
<a href="#l26.241"></a><span id="l26.241">     case &quot;AccentLower&quot;: // Lowercase Diacritical</span>
<a href="#l26.242"></a><span id="l26.242">       accent = lower[indexL];</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-      for(i=0; i &lt; accent.length; i++)</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineplus">+      for (i = 0; i &lt; accent.length; i++)</span>
<a href="#l26.245"></a><span id="l26.245">         LatinM.appendItem(accent.charAt(i));</span>
<a href="#l26.246"></a><span id="l26.246"> </span>
<a href="#l26.247"></a><span id="l26.247" class="difflineminus">-      if(indexM_AL &lt; accent.length)</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineplus">+      if (indexM_AL &lt; accent.length)</span>
<a href="#l26.249"></a><span id="l26.249">         indexM = indexM_AL;</span>
<a href="#l26.250"></a><span id="l26.250">       else</span>
<a href="#l26.251"></a><span id="l26.251">         indexM = lower[indexL].length - 1;</span>
<a href="#l26.252"></a><span id="l26.252">       indexM_AL = indexM;</span>
<a href="#l26.253"></a><span id="l26.253">       break;</span>
<a href="#l26.254"></a><span id="l26.254"> </span>
<a href="#l26.255"></a><span id="l26.255">     case &quot;Upper&quot;: // Uppercase w/o Diacritical</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineminus">-      for(i=0; i &lt; otherupper.length; i++)</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineplus">+      for (i = 0; i &lt; otherupper.length; i++)</span>
<a href="#l26.258"></a><span id="l26.258">         LatinM.appendItem(otherupper.charAt(i));</span>
<a href="#l26.259"></a><span id="l26.259"> </span>
<a href="#l26.260"></a><span id="l26.260" class="difflineminus">-      if(indexM_U &lt; otherupper.length)</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineplus">+      if (indexM_U &lt; otherupper.length)</span>
<a href="#l26.262"></a><span id="l26.262">         indexM = indexM_U;</span>
<a href="#l26.263"></a><span id="l26.263">       else</span>
<a href="#l26.264"></a><span id="l26.264">         indexM = otherupper.length - 1;</span>
<a href="#l26.265"></a><span id="l26.265">       indexM_U = indexM;</span>
<a href="#l26.266"></a><span id="l26.266">       break;</span>
<a href="#l26.267"></a><span id="l26.267"> </span>
<a href="#l26.268"></a><span id="l26.268">     case &quot;Lower&quot;: // Lowercase w/o Diacritical</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineminus">-      for(i=0; i &lt; otherlower.length; i++)</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineplus">+      for (i = 0; i &lt; otherlower.length; i++)</span>
<a href="#l26.271"></a><span id="l26.271">         LatinM.appendItem(otherlower.charAt(i));</span>
<a href="#l26.272"></a><span id="l26.272"> </span>
<a href="#l26.273"></a><span id="l26.273" class="difflineminus">-      if(indexM_L &lt; otherlower.length)</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineplus">+      if (indexM_L &lt; otherlower.length)</span>
<a href="#l26.275"></a><span id="l26.275">         indexM = indexM_L;</span>
<a href="#l26.276"></a><span id="l26.276">       else</span>
<a href="#l26.277"></a><span id="l26.277">         indexM = otherlower.length - 1;</span>
<a href="#l26.278"></a><span id="l26.278">       indexM_L = indexM;</span>
<a href="#l26.279"></a><span id="l26.279">       break;</span>
<a href="#l26.280"></a><span id="l26.280"> </span>
<a href="#l26.281"></a><span id="l26.281">     case &quot;Symbol&quot;: // Symbol</span>
<a href="#l26.282"></a><span id="l26.282" class="difflineminus">-      for(i=0; i &lt; symbol.length; i++)</span>
<a href="#l26.283"></a><span id="l26.283" class="difflineplus">+      for (i = 0; i &lt; symbol.length; i++)</span>
<a href="#l26.284"></a><span id="l26.284">         LatinM.appendItem(symbol.charAt(i));</span>
<a href="#l26.285"></a><span id="l26.285"> </span>
<a href="#l26.286"></a><span id="l26.286" class="difflineminus">-      if(indexM_S &lt; symbol.length)</span>
<a href="#l26.287"></a><span id="l26.287" class="difflineplus">+      if (indexM_S &lt; symbol.length)</span>
<a href="#l26.288"></a><span id="l26.288">         indexM = indexM_S;</span>
<a href="#l26.289"></a><span id="l26.289">       else</span>
<a href="#l26.290"></a><span id="l26.290">         indexM = symbol.length - 1;</span>
<a href="#l26.291"></a><span id="l26.291">       indexM_S = indexM;</span>
<a href="#l26.292"></a><span id="l26.292">       break;</span>
<a href="#l26.293"></a><span id="l26.293">   }</span>
<a href="#l26.294"></a><span id="l26.294">   LatinM.selectedIndex = indexM;</span>
<a href="#l26.295"></a><span id="l26.295"> }</span>
<a href="#l26.296"></a><span id="l26.296"> </span>
<a href="#l26.297"></a><span id="l26.297" class="difflineminus">-function UpdateCharacter()</span>
<a href="#l26.298"></a><span id="l26.298" class="difflineminus">-{</span>
<a href="#l26.299"></a><span id="l26.299" class="difflineplus">+function UpdateCharacter() {</span>
<a href="#l26.300"></a><span id="l26.300">   indexM = LatinM.selectedIndex;</span>
<a href="#l26.301"></a><span id="l26.301"> </span>
<a href="#l26.302"></a><span id="l26.302" class="difflineminus">-  switch(category)</span>
<a href="#l26.303"></a><span id="l26.303" class="difflineminus">-  {</span>
<a href="#l26.304"></a><span id="l26.304" class="difflineplus">+  switch (category) {</span>
<a href="#l26.305"></a><span id="l26.305">     case &quot;AccentUpper&quot;: // Uppercase Diacritical</span>
<a href="#l26.306"></a><span id="l26.306">       indexM_AU = indexM;</span>
<a href="#l26.307"></a><span id="l26.307">       break;</span>
<a href="#l26.308"></a><span id="l26.308">     case &quot;AccentLower&quot;: // Lowercase Diacritical</span>
<a href="#l26.309"></a><span id="l26.309">       indexM_AL = indexM;</span>
<a href="#l26.310"></a><span id="l26.310">       break;</span>
<a href="#l26.311"></a><span id="l26.311">     case &quot;Upper&quot;: // Uppercase w/o Diacritical</span>
<a href="#l26.312"></a><span id="l26.312">       indexM_U = indexM;</span>
<a href="#l26.313"></a><span id="l26.313">       break;</span>
<a href="#l26.314"></a><span id="l26.314">     case &quot;Lower&quot;: // Lowercase w/o Diacritical</span>
<a href="#l26.315"></a><span id="l26.315">       indexM_L = indexM;</span>
<a href="#l26.316"></a><span id="l26.316">       break;</span>
<a href="#l26.317"></a><span id="l26.317">     case &quot;Symbol&quot;:</span>
<a href="#l26.318"></a><span id="l26.318">       indexM_S = indexM;</span>
<a href="#l26.319"></a><span id="l26.319">       break;</span>
<a href="#l26.320"></a><span id="l26.320">   }</span>
<a href="#l26.321"></a><span id="l26.321" class="difflineminus">-//dump(&quot;Letter Index=&quot;+indexL+&quot;, Character Index=&quot;+indexM+&quot;, Character = &quot;+LatinM.label+&quot;\n&quot;);</span>
<a href="#l26.322"></a><span id="l26.322" class="difflineplus">+// dump(&quot;Letter Index=&quot;+indexL+&quot;, Character Index=&quot;+indexM+&quot;, Character = &quot;+LatinM.label+&quot;\n&quot;);</span>
<a href="#l26.323"></a><span id="l26.323"> }</span>
<a href="#l26.324"></a><span id="l26.324"> </span>
<a href="#l26.325"></a><span id="l26.325" class="difflineminus">-const upper=[</span>
<a href="#l26.326"></a><span id="l26.326" class="difflineplus">+const upper = [</span>
<a href="#l26.327"></a><span id="l26.327">   // A</span>
<a href="#l26.328"></a><span id="l26.328">   &quot;\u00c0\u00c1\u00c2\u00c3\u00c4\u00c5\u0100\u0102\u0104\u01cd\u01de\u01de\u01e0\u01fa\u0200\u0202\u0226\u1e00\u1ea0\u1ea2\u1ea4\u1ea6\u1ea8\u1eaa\u1eac\u1eae\u1eb0\u1eb2\u1eb4\u1eb6&quot;,</span>
<a href="#l26.329"></a><span id="l26.329">   // B</span>
<a href="#l26.330"></a><span id="l26.330">   &quot;\u0181\u0182\u0184\u1e02\u1e04\u1e06&quot;,</span>
<a href="#l26.331"></a><span id="l26.331">   // C</span>
<a href="#l26.332"></a><span id="l26.332">   &quot;\u00c7\u0106\u0108\u010a\u010c\u0187\u1e08&quot;,</span>
<a href="#l26.333"></a><span id="l26.333">   // D</span>
<a href="#l26.334"></a><span id="l26.334">   &quot;\u010e\u0110\u0189\u018a\u1e0a\u1e0c\u1e0e\u1e10\u1e12&quot;,</span>
<a href="#l26.335"></a><span id="l26.335" class="difflineat">@@ -339,20 +316,20 @@ const upper=[</span>
<a href="#l26.336"></a><span id="l26.336">   &quot;\u1e7c\u1e7e&quot;,</span>
<a href="#l26.337"></a><span id="l26.337">   // W</span>
<a href="#l26.338"></a><span id="l26.338">   &quot;\u0174\u1e80\u1e82\u1e84\u1e86\u1e88&quot;,</span>
<a href="#l26.339"></a><span id="l26.339">   // X</span>
<a href="#l26.340"></a><span id="l26.340">   &quot;\u1e8a\u1e8c&quot;,</span>
<a href="#l26.341"></a><span id="l26.341">   // Y</span>
<a href="#l26.342"></a><span id="l26.342">   &quot;\u00DD\u0176\u0178\u0232\u1e8e\u1ef2\u1ef4\u1ef6\u1ef8&quot;,</span>
<a href="#l26.343"></a><span id="l26.343">   // Z</span>
<a href="#l26.344"></a><span id="l26.344" class="difflineminus">-  &quot;\u0179\u017B\u017D\u0224\u1e90\u1e92\u1e94&quot;</span>
<a href="#l26.345"></a><span id="l26.345" class="difflineplus">+  &quot;\u0179\u017B\u017D\u0224\u1e90\u1e92\u1e94&quot;,</span>
<a href="#l26.346"></a><span id="l26.346"> ];</span>
<a href="#l26.347"></a><span id="l26.347"> </span>
<a href="#l26.348"></a><span id="l26.348" class="difflineminus">-const lower=[</span>
<a href="#l26.349"></a><span id="l26.349" class="difflineplus">+const lower = [</span>
<a href="#l26.350"></a><span id="l26.350">   // a</span>
<a href="#l26.351"></a><span id="l26.351">   &quot;\u00e0\u00e1\u00e2\u00e3\u00e4\u00e5\u0101\u0103\u0105\u01ce\u01df\u01e1\u01fb\u0201\u0203\u0227\u1e01\u1e9a\u1ea1\u1ea3\u1ea5\u1ea7\u1ea9\u1eab\u1ead\u1eaf\u1eb1\u1eb3\u1eb5\u1eb7&quot;,</span>
<a href="#l26.352"></a><span id="l26.352">   // b</span>
<a href="#l26.353"></a><span id="l26.353">   &quot;\u0180\u0183\u0185\u1e03\u1e05\u1e07&quot;,</span>
<a href="#l26.354"></a><span id="l26.354">   // c</span>
<a href="#l26.355"></a><span id="l26.355">   &quot;\u00e7\u0107\u0109\u010b\u010d\u0188\u1e09&quot;,</span>
<a href="#l26.356"></a><span id="l26.356">   // d</span>
<a href="#l26.357"></a><span id="l26.357">   &quot;\u010f\u0111\u1e0b\u1e0d\u1e0f\u1e11\u1e13&quot;,</span>
<a href="#l26.358"></a><span id="l26.358" class="difflineat">@@ -393,17 +370,17 @@ const lower=[</span>
<a href="#l26.359"></a><span id="l26.359">   &quot;\u1e7d\u1e7f&quot;,</span>
<a href="#l26.360"></a><span id="l26.360">   // w</span>
<a href="#l26.361"></a><span id="l26.361">   &quot;\u0175\u1e81\u1e83\u1e85\u1e87\u1e89\u1e98&quot;,</span>
<a href="#l26.362"></a><span id="l26.362">   // x</span>
<a href="#l26.363"></a><span id="l26.363">   &quot;\u1e8b\u1e8d&quot;,</span>
<a href="#l26.364"></a><span id="l26.364">   // y</span>
<a href="#l26.365"></a><span id="l26.365">   &quot;\u00fd\u00ff\u0177\u0233\u1e8f\u1e99\u1ef3\u1ef5\u1ef7\u1ef9&quot;,</span>
<a href="#l26.366"></a><span id="l26.366">   // z</span>
<a href="#l26.367"></a><span id="l26.367" class="difflineminus">-  &quot;\u017a\u017c\u017e\u0225\u1e91\u1e93\u1e95&quot;</span>
<a href="#l26.368"></a><span id="l26.368" class="difflineplus">+  &quot;\u017a\u017c\u017e\u0225\u1e91\u1e93\u1e95&quot;,</span>
<a href="#l26.369"></a><span id="l26.369"> ];</span>
<a href="#l26.370"></a><span id="l26.370"> </span>
<a href="#l26.371"></a><span id="l26.371"> </span>
<a href="#l26.372"></a><span id="l26.372"> const symbol = &quot;\u00a1\u00a2\u00a3\u00a4\u00a5\u20ac\u00a6\u00a7\u00a8\u00a9\u00aa\u00ab\u00ac\u00ae\u00af\u00b0\u00b1\u00b2\u00b3\u00b4\u00b5\u00b6\u00b7\u00b8\u00b9\u00ba\u00bb\u00bc\u00bd\u00be\u00bf\u00d7\u00f7&quot;;</span>
<a href="#l26.373"></a><span id="l26.373"> </span>
<a href="#l26.374"></a><span id="l26.374"> const otherupper = &quot;\u00c6\u00d0\u00d8\u00de\u0132\u0152\u0186\u01c4\u01c5\u01c7\u01c8\u01ca\u01cb\u01F1\u01f2&quot;;</span>
<a href="#l26.375"></a><span id="l26.375"> </span>
<a href="#l26.376"></a><span id="l26.376"> const otherlower = &quot;\u00e6\u00f0\u00f8\u00fe\u00df\u0133\u0153\u01c6\u01c9\u01cc\u01f3&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsertMath.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsertMath.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -5,18 +5,17 @@</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> /* Insert MathML dialog */</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> var XULNS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l27.10"></a><span id="l27.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-function Startup()</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-{</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+function Startup() {</span>
<a href="#l27.15"></a><span id="l27.15">   var editor = GetCurrentEditor();</span>
<a href="#l27.16"></a><span id="l27.16">   if (!editor) {</span>
<a href="#l27.17"></a><span id="l27.17">     window.close();</span>
<a href="#l27.18"></a><span id="l27.18">     return;</span>
<a href="#l27.19"></a><span id="l27.19">   }</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21">   // Create dialog object for easy access</span>
<a href="#l27.22"></a><span id="l27.22">   gDialog.accept = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineat">@@ -71,49 +70,48 @@ function Startup()</span>
<a href="#l27.24"></a><span id="l27.24">             &quot;\\widevec{⋯}&quot;,</span>
<a href="#l27.25"></a><span id="l27.25">             &quot;\\widetilde{⋯}&quot;,</span>
<a href="#l27.26"></a><span id="l27.26">             &quot;\\widehat{⋯}&quot;,</span>
<a href="#l27.27"></a><span id="l27.27">             &quot;\\widecheck{⋯}&quot;,</span>
<a href="#l27.28"></a><span id="l27.28">             &quot;\\widebar{⋯}&quot;,</span>
<a href="#l27.29"></a><span id="l27.29">             &quot;\\dot{⋯}&quot;,</span>
<a href="#l27.30"></a><span id="l27.30">             &quot;\\ddot{⋯}&quot;,</span>
<a href="#l27.31"></a><span id="l27.31">             &quot;\\boxed{⋯}&quot;,</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-            &quot;\\slash{⋯}&quot;</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+            &quot;\\slash{⋯}&quot;,</span>
<a href="#l27.34"></a><span id="l27.34">     ],</span>
<a href="#l27.35"></a><span id="l27.35">     &quot;(▦)&quot;: [&quot;\\begin{matrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{matrix}&quot;,</span>
<a href="#l27.36"></a><span id="l27.36">             &quot;\\begin{pmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{pmatrix}&quot;,</span>
<a href="#l27.37"></a><span id="l27.37">             &quot;\\begin{bmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{bmatrix}&quot;,</span>
<a href="#l27.38"></a><span id="l27.38">             &quot;\\begin{Bmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{Bmatrix}&quot;,</span>
<a href="#l27.39"></a><span id="l27.39">             &quot;\\begin{vmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{vmatrix}&quot;,</span>
<a href="#l27.40"></a><span id="l27.40">             &quot;\\begin{Vmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{Vmatrix}&quot;,</span>
<a href="#l27.41"></a><span id="l27.41">             &quot;\\begin{cases} ⋯ \\\\ ⋯  \\end{cases}&quot;,</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-            &quot;\\begin{aligned} ⋯ &amp;= ⋯ \\\\ ⋯ &amp;= ⋯ \\end{aligned}&quot;</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-    ]</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+            &quot;\\begin{aligned} ⋯ &amp;= ⋯ \\\\ ⋯ &amp;= ⋯ \\end{aligned}&quot;,</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+    ],</span>
<a href="#l27.46"></a><span id="l27.46">   });</span>
<a href="#l27.47"></a><span id="l27.47">   createSymbolPanels([</span>
<a href="#l27.48"></a><span id="l27.48">     &quot;∏∐∑∫∬∭⨌∮⊎⊕⊖⊗⊘⊙⋀⋁⋂⋃⌈⌉⌊⌋⎰⎱⟨⟩⟪⟫∥⫼⨀⨁⨂⨄⨅⨆ðıȷℏℑℓ℘ℜℵℶ&quot;,</span>
<a href="#l27.49"></a><span id="l27.49">     &quot;∀∃∄∅∉∊∋∌⊂⊃⊄⊅⊆⊇⊈⊈⊉⊊⊊⊋⊋⊏⊐⊑⊒⊓⊔⊥⋐⋑⋔⫅⫆⫋⫋⫌⫌…⋮⋯⋰⋱♭♮♯∂∇&quot;,</span>
<a href="#l27.50"></a><span id="l27.50">     &quot;±×÷†‡•∓∔∗∘∝∠∡∢∧∨∴∵∼∽≁≃≅≇≈≈≊≍≎≏≐≑≒≓≖≗≜≡≢≬⊚⊛⊞⊡⊢⊣⊤⊥&quot;,</span>
<a href="#l27.51"></a><span id="l27.51">     &quot;⊨⊩⊪⊫⊬⊭⊯⊲⊲⊳⊴⊵⊸⊻⋄⋅⋇⋈⋉⋊⋋⋌⋍⋎⋏⋒⋓⌅⌆⌣△▴▵▸▹▽▾▿◂◃◊○★♠♡♢♣⧫&quot;,</span>
<a href="#l27.52"></a><span id="l27.52">     &quot;≦≧≨≩≩≪≫≮≯≰≱≲≳≶≷≺≻≼≽≾≿⊀⊁⋖⋗⋘⋙⋚⋛⋞⋟⋦⋧⋨⋩⩽⩾⪅⪆⪇⪈⪉⪊⪋⪌⪕⪯⪰⪷⪸⪹⪺&quot;,</span>
<a href="#l27.53"></a><span id="l27.53">     &quot;←↑→↓↔↕↖↗↘↙↜↝↞↠↢↣↦↩↪↫↬↭↭↰↱↼↽↾↿⇀⇁⇂⇃⇄⇆⇇⇈⇉⇊⇋⇌⇐⇑⇒⇓⇕⇖⇗⇘⇙⟺&quot;,</span>
<a href="#l27.54"></a><span id="l27.54">     &quot;αβγδϵ϶εζηθϑικϰλμνξℴπϖρϱσςτυϕφχψωΓΔΘΛΞΠΣϒΦΨΩϝ℧&quot;,</span>
<a href="#l27.55"></a><span id="l27.55">     &quot;𝕒𝕓𝕔𝕕𝕖𝕗𝕘𝕙𝕚𝕛𝕜𝕝𝕞𝕟𝕠𝕡𝕢𝕣𝕤𝕥𝕦𝕧𝕨𝕩𝕪𝕫𝔸𝔹ℂ𝔻𝔼𝔽𝔾ℍ𝕀𝕁𝕂𝕃𝕄ℕ𝕆ℙℚℝ𝕊𝕋𝕌𝕍𝕎𝕏𝕐ℤ&quot;,</span>
<a href="#l27.56"></a><span id="l27.56">     &quot;𝒶𝒷𝒸𝒹ℯ𝒻ℊ𝒽𝒾𝒿𝓀𝓁𝓂𝓃ℴ𝓅𝓆𝓇𝓈𝓉𝓊𝓋𝓌𝓍𝓎𝓏𝒜ℬ𝒞𝒟ℰℱ𝒢ℋℐ𝒥𝒦ℒℳ𝒩𝒪𝒫𝒬ℛ𝒮𝒯𝒰𝒱𝒲𝒳𝒴𝒵&quot;,</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-    &quot;𝔞𝔟𝔠𝔡𝔢𝔣𝔤𝔥𝔦𝔧𝔨𝔩𝔪𝔫𝔬𝔭𝔮𝔯𝔰𝔱𝔲𝔳𝔴𝔵𝔶𝔷𝔄𝔅ℭ𝔇𝔈𝔉𝔊ℌℑ𝔍𝔎𝔏𝔐𝔑𝔒𝔓𝔔ℜ𝔖𝔗𝔘𝔙𝔚𝔛𝔜ℨ&quot;</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+    &quot;𝔞𝔟𝔠𝔡𝔢𝔣𝔤𝔥𝔦𝔧𝔨𝔩𝔪𝔫𝔬𝔭𝔮𝔯𝔰𝔱𝔲𝔳𝔴𝔵𝔶𝔷𝔄𝔅ℭ𝔇𝔈𝔉𝔊ℌℑ𝔍𝔎𝔏𝔐𝔑𝔒𝔓𝔔ℜ𝔖𝔗𝔘𝔙𝔚𝔛𝔜ℨ&quot;,</span>
<a href="#l27.59"></a><span id="l27.59">   ]);</span>
<a href="#l27.60"></a><span id="l27.60">   gDialog.tabbox.selectedIndex = 0;</span>
<a href="#l27.61"></a><span id="l27.61"> </span>
<a href="#l27.62"></a><span id="l27.62">   updateMath();</span>
<a href="#l27.63"></a><span id="l27.63"> </span>
<a href="#l27.64"></a><span id="l27.64">   SetWindowLocation();</span>
<a href="#l27.65"></a><span id="l27.65"> }</span>
<a href="#l27.66"></a><span id="l27.66"> </span>
<a href="#l27.67"></a><span id="l27.67" class="difflineminus">-function insertLaTeXCommand(aButton)</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineminus">-{</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+function insertLaTeXCommand(aButton) {</span>
<a href="#l27.70"></a><span id="l27.70">   gDialog.input.focus();</span>
<a href="#l27.71"></a><span id="l27.71"> </span>
<a href="#l27.72"></a><span id="l27.72">   // For a single math symbol, just use the insertText command.</span>
<a href="#l27.73"></a><span id="l27.73">   if (aButton.label) {</span>
<a href="#l27.74"></a><span id="l27.74">     gDialog.input.editor.QueryInterface(Ci.nsIPlaintextEditor).insertText(aButton.label);</span>
<a href="#l27.75"></a><span id="l27.75">     return;</span>
<a href="#l27.76"></a><span id="l27.76">   }</span>
<a href="#l27.77"></a><span id="l27.77"> </span>
<a href="#l27.78"></a><span id="l27.78" class="difflineat">@@ -145,22 +143,20 @@ function insertLaTeXCommand(aButton)</span>
<a href="#l27.79"></a><span id="l27.79">   // Update the input text and selection.</span>
<a href="#l27.80"></a><span id="l27.80">   gDialog.input.editor.QueryInterface(Ci.nsIPlaintextEditor).insertText(latex);</span>
<a href="#l27.81"></a><span id="l27.81">   gDialog.input.setSelectionRange(selectionStart + latexNewStart,</span>
<a href="#l27.82"></a><span id="l27.82">                                   selectionStart + latexNewEnd);</span>
<a href="#l27.83"></a><span id="l27.83"> </span>
<a href="#l27.84"></a><span id="l27.84">   updateMath();</span>
<a href="#l27.85"></a><span id="l27.85"> }</span>
<a href="#l27.86"></a><span id="l27.86"> </span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-function createCommandPanel(aCommandPanelList)</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-{</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+function createCommandPanel(aCommandPanelList) {</span>
<a href="#l27.90"></a><span id="l27.90">   const columnCount = 10;</span>
<a href="#l27.91"></a><span id="l27.91"> </span>
<a href="#l27.92"></a><span id="l27.92">   for (var label in aCommandPanelList) {</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineminus">-</span>
<a href="#l27.94"></a><span id="l27.94">     var commands = aCommandPanelList[label];</span>
<a href="#l27.95"></a><span id="l27.95"> </span>
<a href="#l27.96"></a><span id="l27.96">     // Create a &lt;rows&gt; element with some LaTeX commands.</span>
<a href="#l27.97"></a><span id="l27.97">     var rows = document.createElementNS(XULNS, &quot;rows&quot;);</span>
<a href="#l27.98"></a><span id="l27.98"> </span>
<a href="#l27.99"></a><span id="l27.99">     var i = 0, row;</span>
<a href="#l27.100"></a><span id="l27.100">     for (var command of commands) {</span>
<a href="#l27.101"></a><span id="l27.101">       if (i % columnCount == 0) {</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineat">@@ -196,22 +192,20 @@ function createCommandPanel(aCommandPane</span>
<a href="#l27.103"></a><span id="l27.103">     tab.setAttribute(&quot;label&quot;, label);</span>
<a href="#l27.104"></a><span id="l27.104">     gDialog.tabbox.tabs.appendChild(tab);</span>
<a href="#l27.105"></a><span id="l27.105"> </span>
<a href="#l27.106"></a><span id="l27.106">     // Append the new tab panel.</span>
<a href="#l27.107"></a><span id="l27.107">     gDialog.tabbox.tabpanels.appendChild(grid);</span>
<a href="#l27.108"></a><span id="l27.108">   }</span>
<a href="#l27.109"></a><span id="l27.109"> }</span>
<a href="#l27.110"></a><span id="l27.110"> </span>
<a href="#l27.111"></a><span id="l27.111" class="difflineminus">-function createSymbolPanels(aSymbolPanelList)</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineminus">-{</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-  const columnCount = 13, tabLabelLength = 3</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineplus">+function createSymbolPanels(aSymbolPanelList) {</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+  const columnCount = 13, tabLabelLength = 3;</span>
<a href="#l27.116"></a><span id="l27.116"> </span>
<a href="#l27.117"></a><span id="l27.117">   for (var symbols of aSymbolPanelList) {</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineminus">-</span>
<a href="#l27.119"></a><span id="l27.119">     // Create a &lt;rows&gt; element with the symbols of the i-th panel.</span>
<a href="#l27.120"></a><span id="l27.120">     var rows = document.createElementNS(XULNS, &quot;rows&quot;);</span>
<a href="#l27.121"></a><span id="l27.121">     var i = 0, tabLabel = &quot;&quot;, row;</span>
<a href="#l27.122"></a><span id="l27.122">     for (var symbol of symbols) {</span>
<a href="#l27.123"></a><span id="l27.123">       if (i % columnCount == 0) {</span>
<a href="#l27.124"></a><span id="l27.124">         // Create a new row.</span>
<a href="#l27.125"></a><span id="l27.125">         row = document.createElementNS(XULNS, &quot;row&quot;);</span>
<a href="#l27.126"></a><span id="l27.126">         rows.appendChild(row);</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineat">@@ -249,47 +243,42 @@ function createSymbolPanels(aSymbolPanel</span>
<a href="#l27.128"></a><span id="l27.128">     tab.setAttribute(&quot;label&quot;, tabLabel);</span>
<a href="#l27.129"></a><span id="l27.129">     gDialog.tabbox.tabs.appendChild(tab);</span>
<a href="#l27.130"></a><span id="l27.130"> </span>
<a href="#l27.131"></a><span id="l27.131">     // Append the new tab panel.</span>
<a href="#l27.132"></a><span id="l27.132">     gDialog.tabbox.tabpanels.appendChild(grid);</span>
<a href="#l27.133"></a><span id="l27.133">   }</span>
<a href="#l27.134"></a><span id="l27.134"> }</span>
<a href="#l27.135"></a><span id="l27.135"> </span>
<a href="#l27.136"></a><span id="l27.136" class="difflineminus">-function onAccept(event)</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineminus">-{</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineminus">-  if (gDialog.output.firstChild)</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineminus">-  {</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineplus">+function onAccept(event) {</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineplus">+  if (gDialog.output.firstChild) {</span>
<a href="#l27.142"></a><span id="l27.142">     var editor = GetCurrentEditor();</span>
<a href="#l27.143"></a><span id="l27.143">     editor.beginTransaction();</span>
<a href="#l27.144"></a><span id="l27.144"> </span>
<a href="#l27.145"></a><span id="l27.145">     try {</span>
<a href="#l27.146"></a><span id="l27.146">       var newMath = editor.document.importNode(gDialog.output.firstChild, true);</span>
<a href="#l27.147"></a><span id="l27.147">       if (gDialog.oldMath) {</span>
<a href="#l27.148"></a><span id="l27.148">         // Replace the old &lt;math&gt; element with the new one.</span>
<a href="#l27.149"></a><span id="l27.149">         editor.selectElement(gDialog.oldMath);</span>
<a href="#l27.150"></a><span id="l27.150">         editor.insertElementAtSelection(newMath, true);</span>
<a href="#l27.151"></a><span id="l27.151">       } else {</span>
<a href="#l27.152"></a><span id="l27.152">         // Insert the new &lt;math&gt; element.</span>
<a href="#l27.153"></a><span id="l27.153">         editor.insertElementAtSelection(newMath, false);</span>
<a href="#l27.154"></a><span id="l27.154">       }</span>
<a href="#l27.155"></a><span id="l27.155">     } catch (e) {}</span>
<a href="#l27.156"></a><span id="l27.156"> </span>
<a href="#l27.157"></a><span id="l27.157">     editor.endTransaction();</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineminus">-  }</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineminus">-  else</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-  {</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineplus">+  } else {</span>
<a href="#l27.162"></a><span id="l27.162">     dump(&quot;Null value -- not inserting in MathML Source dialog\n&quot;);</span>
<a href="#l27.163"></a><span id="l27.163">     event.preventDefault();</span>
<a href="#l27.164"></a><span id="l27.164">   }</span>
<a href="#l27.165"></a><span id="l27.165">   SaveWindowLocation();</span>
<a href="#l27.166"></a><span id="l27.166"> }</span>
<a href="#l27.167"></a><span id="l27.167"> </span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-function updateMath()</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineminus">-{</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineplus">+function updateMath() {</span>
<a href="#l27.171"></a><span id="l27.171">   // Remove the preview, if any.</span>
<a href="#l27.172"></a><span id="l27.172">   if (gDialog.output.firstChild)</span>
<a href="#l27.173"></a><span id="l27.173">     gDialog.output.firstChild.remove();</span>
<a href="#l27.174"></a><span id="l27.174"> </span>
<a href="#l27.175"></a><span id="l27.175">   // Try to convert the LaTeX source into MathML using TeXZilla.</span>
<a href="#l27.176"></a><span id="l27.176">   // We use the placeholder text if no input is provided.</span>
<a href="#l27.177"></a><span id="l27.177">   try {</span>
<a href="#l27.178"></a><span id="l27.178">     var input = gDialog.input.value || gDialog.input.placeholder;</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineat">@@ -297,19 +286,17 @@ function updateMath()</span>
<a href="#l27.180"></a><span id="l27.180">     gDialog.output.appendChild(document.importNode(newMath, true));</span>
<a href="#l27.181"></a><span id="l27.181">     gDialog.output.style.opacity = gDialog.input.value ? 1 : .5;</span>
<a href="#l27.182"></a><span id="l27.182">   } catch (e) {</span>
<a href="#l27.183"></a><span id="l27.183">   }</span>
<a href="#l27.184"></a><span id="l27.184">   // Disable the accept button if parsing fails or when the placeholder is used.</span>
<a href="#l27.185"></a><span id="l27.185">   gDialog.accept.disabled = !gDialog.input.value || !gDialog.output.firstChild;</span>
<a href="#l27.186"></a><span id="l27.186"> }</span>
<a href="#l27.187"></a><span id="l27.187"> </span>
<a href="#l27.188"></a><span id="l27.188" class="difflineminus">-function updateMode()</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineminus">-{</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineplus">+function updateMode() {</span>
<a href="#l27.191"></a><span id="l27.191">   if (gDialog.output.firstChild)</span>
<a href="#l27.192"></a><span id="l27.192">     gDialog.output.firstChild.setAttribute(&quot;display&quot;, gDialog.mode.selectedIndex ? &quot;block&quot; : &quot;inline&quot;);</span>
<a href="#l27.193"></a><span id="l27.193"> }</span>
<a href="#l27.194"></a><span id="l27.194"> </span>
<a href="#l27.195"></a><span id="l27.195" class="difflineminus">-function updateDirection()</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineminus">-{</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineplus">+function updateDirection() {</span>
<a href="#l27.198"></a><span id="l27.198">   if (gDialog.output.firstChild)</span>
<a href="#l27.199"></a><span id="l27.199">     gDialog.output.firstChild.setAttribute(&quot;dir&quot;, gDialog.direction.selectedIndex ? &quot;rtl&quot; : &quot;ltr&quot;);</span>
<a href="#l27.200"></a><span id="l27.200"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsertTOC.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsertTOC.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -21,18 +21,17 @@ const kMozTocLength            = 6;</span>
<a href="#l28.4"></a><span id="l28.4"> const kMozTocIdPrefix          = &quot;mozTocId&quot;;</span>
<a href="#l28.5"></a><span id="l28.5"> const kMozTocIdPrefixLength    = 8;</span>
<a href="#l28.6"></a><span id="l28.6"> const kMozTocClassPrefix       = &quot;mozToc&quot;;</span>
<a href="#l28.7"></a><span id="l28.7"> const kMozTocClassPrefixLength = 6;</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> document.addEventListener(&quot;dialogaccept&quot;, () =&gt; BuildTOC(true));</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11"> // Startup() is called when EdInsertTOC.xul is opened</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-function Startup()</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-{</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+function Startup() {</span>
<a href="#l28.15"></a><span id="l28.15">   // early way out if if we have no editor</span>
<a href="#l28.16"></a><span id="l28.16">   if (!GetCurrentEditor()) {</span>
<a href="#l28.17"></a><span id="l28.17">     window.close();</span>
<a href="#l28.18"></a><span id="l28.18">     return;</span>
<a href="#l28.19"></a><span id="l28.19">   }</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21">   var i, j;</span>
<a href="#l28.22"></a><span id="l28.22">   // clean the table of tag/class pairs we look for</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineat">@@ -71,17 +70,17 @@ function Startup()</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25">     // let's see if it's an OL or an UL</span>
<a href="#l28.26"></a><span id="l28.26">     orderedList = (toc.nodeName.toLowerCase() == &quot;ol&quot;);</span>
<a href="#l28.27"></a><span id="l28.27">     orderedListCheckbox.checked = orderedList;</span>
<a href="#l28.28"></a><span id="l28.28"> </span>
<a href="#l28.29"></a><span id="l28.29">     var nodeList = toc.childNodes;</span>
<a href="#l28.30"></a><span id="l28.30">     // let's look at the children of the TOC ; if we find a comment beginning</span>
<a href="#l28.31"></a><span id="l28.31">     // with &quot;mozToc&quot;, it contains the TOC definition</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-    for (i = 0; i&lt; nodeList.length; ++i) {</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+    for (i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l28.34"></a><span id="l28.34">       if (nodeList.item(i).nodeType == Node.COMMENT_NODE &amp;&amp;</span>
<a href="#l28.35"></a><span id="l28.35">           nodeList.item(i).data.startsWith(kMozToc)) {</span>
<a href="#l28.36"></a><span id="l28.36">         // yep, there is already a definition here; parse it !</span>
<a href="#l28.37"></a><span id="l28.37">         headers = nodeList.item(i).data.substr(kMozTocLength + 1,</span>
<a href="#l28.38"></a><span id="l28.38">                                     nodeList.item(i).length - kMozTocLength - 1);</span>
<a href="#l28.39"></a><span id="l28.39">         break;</span>
<a href="#l28.40"></a><span id="l28.40">       }</span>
<a href="#l28.41"></a><span id="l28.41">     }</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineat">@@ -116,23 +115,21 @@ function Startup()</span>
<a href="#l28.43"></a><span id="l28.43">         textbox.value = className;</span>
<a href="#l28.44"></a><span id="l28.44">       }</span>
<a href="#l28.45"></a><span id="l28.45">       tocHeadersArray[index - 1] = [ tag, className ];</span>
<a href="#l28.46"></a><span id="l28.46">     }</span>
<a href="#l28.47"></a><span id="l28.47">   }</span>
<a href="#l28.48"></a><span id="l28.48"> }</span>
<a href="#l28.49"></a><span id="l28.49"> </span>
<a href="#l28.50"></a><span id="l28.50"> </span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-function BuildTOC(update)</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-{</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+function BuildTOC(update) {</span>
<a href="#l28.54"></a><span id="l28.54">   // controlClass() is a node filter that accepts a node if</span>
<a href="#l28.55"></a><span id="l28.55">   // (a) we don't look for a class (b) we look for a class and</span>
<a href="#l28.56"></a><span id="l28.56">   // node has it</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-  function controlClass(node, index)</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-  {</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+  function controlClass(node, index) {</span>
<a href="#l28.60"></a><span id="l28.60">     currentHeaderLevel = index + 1;</span>
<a href="#l28.61"></a><span id="l28.61">     if (tocHeadersArray[index][1] == &quot;&quot;) {</span>
<a href="#l28.62"></a><span id="l28.62">       // we are not looking for a specific class, this node is ok</span>
<a href="#l28.63"></a><span id="l28.63">       return NodeFilter.FILTER_ACCEPT;</span>
<a href="#l28.64"></a><span id="l28.64">     }</span>
<a href="#l28.65"></a><span id="l28.65">     if (node.getAttribute(&quot;class&quot;)) {</span>
<a href="#l28.66"></a><span id="l28.66">       // yep, we look for a class, let's look at all the classes</span>
<a href="#l28.67"></a><span id="l28.67">       // the node has</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineat">@@ -145,20 +142,18 @@ function BuildTOC(update)</span>
<a href="#l28.69"></a><span id="l28.69">       }</span>
<a href="#l28.70"></a><span id="l28.70">     }</span>
<a href="#l28.71"></a><span id="l28.71">     return NodeFilter.FILTER_SKIP;</span>
<a href="#l28.72"></a><span id="l28.72">   }</span>
<a href="#l28.73"></a><span id="l28.73"> </span>
<a href="#l28.74"></a><span id="l28.74">   // the main node filter for our node iterator</span>
<a href="#l28.75"></a><span id="l28.75">   // it selects the tag names as specified in the dialog</span>
<a href="#l28.76"></a><span id="l28.76">   // then calls the controlClass filter above</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-  function acceptNode(node)</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineminus">-  {</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineminus">-    switch (node.nodeName.toLowerCase())</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-    {</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+  function acceptNode(node) {</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+    switch (node.nodeName.toLowerCase()) {</span>
<a href="#l28.83"></a><span id="l28.83">       case tocHeadersArray[0][0]:</span>
<a href="#l28.84"></a><span id="l28.84">         return controlClass(node, 0);</span>
<a href="#l28.85"></a><span id="l28.85">         break;</span>
<a href="#l28.86"></a><span id="l28.86">       case tocHeadersArray[1][0]:</span>
<a href="#l28.87"></a><span id="l28.87">         return controlClass(node, 1);</span>
<a href="#l28.88"></a><span id="l28.88">         break;</span>
<a href="#l28.89"></a><span id="l28.89">       case tocHeadersArray[2][0]:</span>
<a href="#l28.90"></a><span id="l28.90">         return controlClass(node, 2);</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineat">@@ -206,25 +201,24 @@ function BuildTOC(update)</span>
<a href="#l28.92"></a><span id="l28.92"> </span>
<a href="#l28.93"></a><span id="l28.93">       var anchor = tocSourceNode.firstChild, id;</span>
<a href="#l28.94"></a><span id="l28.94">       // do we have a named anchor as 1st child of our node ?</span>
<a href="#l28.95"></a><span id="l28.95">       if (anchor.nodeName.toLowerCase() == &quot;a&quot; &amp;&amp;</span>
<a href="#l28.96"></a><span id="l28.96">           anchor.hasAttribute(&quot;name&quot;) &amp;&amp;</span>
<a href="#l28.97"></a><span id="l28.97">           anchor.getAttribute(&quot;name&quot;).startsWith(kMozTocIdPrefix)) {</span>
<a href="#l28.98"></a><span id="l28.98">         // yep, get its name</span>
<a href="#l28.99"></a><span id="l28.99">         id = anchor.getAttribute(&quot;name&quot;);</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-      }</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineminus">-      else {</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+      } else {</span>
<a href="#l28.103"></a><span id="l28.103">         // no we don't and we need to create one</span>
<a href="#l28.104"></a><span id="l28.104">         anchor = theDocument.createElement(&quot;a&quot;);</span>
<a href="#l28.105"></a><span id="l28.105">         tocSourceNode.insertBefore(anchor, tocSourceNode.firstChild);</span>
<a href="#l28.106"></a><span id="l28.106">         // let's give it a random ID</span>
<a href="#l28.107"></a><span id="l28.107">         var c = 1000000 * Math.random();</span>
<a href="#l28.108"></a><span id="l28.108">         id = kMozTocIdPrefix + Math.round(c);</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineminus">-        anchor.setAttribute(&quot;name&quot;,  id);</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+        anchor.setAttribute(&quot;name&quot;, id);</span>
<a href="#l28.111"></a><span id="l28.111">         anchor.setAttribute(&quot;class&quot;, kMozTocClassPrefix +</span>
<a href="#l28.112"></a><span id="l28.112">                                      tocSourceNode.nodeName.toUpperCase());</span>
<a href="#l28.113"></a><span id="l28.113">       }</span>
<a href="#l28.114"></a><span id="l28.114">       // and store that new entry in our array</span>
<a href="#l28.115"></a><span id="l28.115">       tocArray.push(headerIndex, headerText, id);</span>
<a href="#l28.116"></a><span id="l28.116">       tocSourceNode = treeWalker.nextNode();</span>
<a href="#l28.117"></a><span id="l28.117">     }</span>
<a href="#l28.118"></a><span id="l28.118">   }</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineat">@@ -244,30 +238,28 @@ function BuildTOC(update)</span>
<a href="#l28.120"></a><span id="l28.120">         // Composer will refuse an empty list and will remove it !</span>
<a href="#l28.121"></a><span id="l28.121">         var pit = theDocument.createElement(&quot;li&quot;);</span>
<a href="#l28.122"></a><span id="l28.122">         toc.appendChild(pit);</span>
<a href="#l28.123"></a><span id="l28.123">         GetCurrentEditor().insertElementAtSelection(toc, true);</span>
<a href="#l28.124"></a><span id="l28.124">         // ah, now it's inserted so let's remove the useless list item...</span>
<a href="#l28.125"></a><span id="l28.125">         toc.removeChild(pit);</span>
<a href="#l28.126"></a><span id="l28.126">         // we need to recognize later that this list is our TOC</span>
<a href="#l28.127"></a><span id="l28.127">         toc.setAttribute(&quot;id&quot;, kMozToc);</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineminus">-      }</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineminus">-      else {</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineplus">+      } else {</span>
<a href="#l28.131"></a><span id="l28.131">         // we have to update an existing TOC, is the existing TOC of the</span>
<a href="#l28.132"></a><span id="l28.132">         // desired type (ordered or not) ?</span>
<a href="#l28.133"></a><span id="l28.133">         if (orderedList != (toc.nodeName.toLowerCase() == &quot;ol&quot;)) {</span>
<a href="#l28.134"></a><span id="l28.134">           // nope, we have to recreate the list</span>
<a href="#l28.135"></a><span id="l28.135">           var newToc = GetCurrentEditor().createElementWithDefaults(orderedList ? &quot;ol&quot; : &quot;ul&quot;);</span>
<a href="#l28.136"></a><span id="l28.136">           toc.parentNode.insertBefore(newToc, toc);</span>
<a href="#l28.137"></a><span id="l28.137">           // and remove the old one</span>
<a href="#l28.138"></a><span id="l28.138">           toc.remove();</span>
<a href="#l28.139"></a><span id="l28.139">           toc = newToc;</span>
<a href="#l28.140"></a><span id="l28.140">           toc.setAttribute(&quot;id&quot;, kMozToc);</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineminus">-        }</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineminus">-        else {</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineplus">+        } else {</span>
<a href="#l28.144"></a><span id="l28.144">           // we can keep the list itself but let's get rid of the TOC entries</span>
<a href="#l28.145"></a><span id="l28.145">           while (toc.hasChildNodes())</span>
<a href="#l28.146"></a><span id="l28.146">             toc.lastChild.remove();</span>
<a href="#l28.147"></a><span id="l28.147">         }</span>
<a href="#l28.148"></a><span id="l28.148">       }</span>
<a href="#l28.149"></a><span id="l28.149">       var commentText = &quot;mozToc &quot;;</span>
<a href="#l28.150"></a><span id="l28.150">       for (var j = 0; j &lt; 6; j++) {</span>
<a href="#l28.151"></a><span id="l28.151">         if (tocHeadersArray[j][0] != &quot;&quot;) {</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineat">@@ -285,18 +277,17 @@ function BuildTOC(update)</span>
<a href="#l28.153"></a><span id="l28.153">       // the TOC definition for us</span>
<a href="#l28.154"></a><span id="l28.154">       var ct = theDocument.createComment(commentText);</span>
<a href="#l28.155"></a><span id="l28.155">       toc.appendChild(ct);</span>
<a href="#l28.156"></a><span id="l28.156"> </span>
<a href="#l28.157"></a><span id="l28.157">       // assign a special class to the TOC top element if the TOC is readonly</span>
<a href="#l28.158"></a><span id="l28.158">       // the definition of this class is in EditorOverride.css</span>
<a href="#l28.159"></a><span id="l28.159">       if (readonly) {</span>
<a href="#l28.160"></a><span id="l28.160">         toc.setAttribute(&quot;class&quot;, &quot;readonly&quot;);</span>
<a href="#l28.161"></a><span id="l28.161" class="difflineminus">-      }</span>
<a href="#l28.162"></a><span id="l28.162" class="difflineminus">-      else {</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineplus">+      } else {</span>
<a href="#l28.164"></a><span id="l28.164">         toc.removeAttribute(&quot;class&quot;);</span>
<a href="#l28.165"></a><span id="l28.165">       }</span>
<a href="#l28.166"></a><span id="l28.166"> </span>
<a href="#l28.167"></a><span id="l28.167">       // We need a new variable to hold the local ul/ol container</span>
<a href="#l28.168"></a><span id="l28.168">       // The toplevel TOC element is not the parent element of a</span>
<a href="#l28.169"></a><span id="l28.169">       // TOC entry if its depth is &gt; 1...</span>
<a href="#l28.170"></a><span id="l28.170">       var tocList = toc;</span>
<a href="#l28.171"></a><span id="l28.171">       // create a list item</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineat">@@ -307,73 +298,65 @@ function BuildTOC(update)</span>
<a href="#l28.173"></a><span id="l28.173">       tocAnchor.setAttribute(&quot;href&quot;, &quot;#&quot; + tocArray[i + 2]);</span>
<a href="#l28.174"></a><span id="l28.174">       // and put the textual contents of the TOC entry in that anchor</span>
<a href="#l28.175"></a><span id="l28.175">       var tocEntry = theDocument.createTextNode(tocArray[i + 1]);</span>
<a href="#l28.176"></a><span id="l28.176">       // now, insert everything where it has to be inserted</span>
<a href="#l28.177"></a><span id="l28.177">       tocAnchor.appendChild(tocEntry);</span>
<a href="#l28.178"></a><span id="l28.178">       tocItem.appendChild(tocAnchor);</span>
<a href="#l28.179"></a><span id="l28.179">       tocList.appendChild(tocItem);</span>
<a href="#l28.180"></a><span id="l28.180">       item = tocList;</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineminus">-    }</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineminus">-    else {</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineplus">+    } else {</span>
<a href="#l28.184"></a><span id="l28.184">       if (tocArray[i] &lt; headerIndex) {</span>
<a href="#l28.185"></a><span id="l28.185">         // if the depth of the new TOC entry is less than the depth of the</span>
<a href="#l28.186"></a><span id="l28.186">         // last entry we created, find the good ul/ol ancestor</span>
<a href="#l28.187"></a><span id="l28.187">         for (j = headerIndex - tocArray[i]; j &gt; 0; --j) {</span>
<a href="#l28.188"></a><span id="l28.188">           if (item != toc) {</span>
<a href="#l28.189"></a><span id="l28.189">             item = item.parentNode.parentNode;</span>
<a href="#l28.190"></a><span id="l28.190">           }</span>
<a href="#l28.191"></a><span id="l28.191">         }</span>
<a href="#l28.192"></a><span id="l28.192">         tocItem = theDocument.createElement(&quot;li&quot;);</span>
<a href="#l28.193"></a><span id="l28.193" class="difflineminus">-      }</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineminus">-      else if (tocArray[i] &gt; headerIndex) {</span>
<a href="#l28.195"></a><span id="l28.195" class="difflineplus">+      } else if (tocArray[i] &gt; headerIndex) {</span>
<a href="#l28.196"></a><span id="l28.196">         // to the contrary, it's deeper than the last one</span>
<a href="#l28.197"></a><span id="l28.197">         // we need to create sub ul/ol's and li's</span>
<a href="#l28.198"></a><span id="l28.198">         for (j = tocArray[i] - headerIndex; j &gt; 0; --j) {</span>
<a href="#l28.199"></a><span id="l28.199">           tocList = theDocument.createElement(orderedList ? &quot;ol&quot; : &quot;ul&quot;);</span>
<a href="#l28.200"></a><span id="l28.200">           item.lastChild.appendChild(tocList);</span>
<a href="#l28.201"></a><span id="l28.201">           tocItem = theDocument.createElement(&quot;li&quot;);</span>
<a href="#l28.202"></a><span id="l28.202">           tocList.appendChild(tocItem);</span>
<a href="#l28.203"></a><span id="l28.203">           item = tocList;</span>
<a href="#l28.204"></a><span id="l28.204">         }</span>
<a href="#l28.205"></a><span id="l28.205" class="difflineminus">-      }</span>
<a href="#l28.206"></a><span id="l28.206" class="difflineminus">-      else {</span>
<a href="#l28.207"></a><span id="l28.207" class="difflineplus">+      } else {</span>
<a href="#l28.208"></a><span id="l28.208">         tocItem = theDocument.createElement(&quot;li&quot;);</span>
<a href="#l28.209"></a><span id="l28.209">       }</span>
<a href="#l28.210"></a><span id="l28.210">       tocAnchor = theDocument.createElement(&quot;a&quot;);</span>
<a href="#l28.211"></a><span id="l28.211">       tocAnchor.setAttribute(&quot;href&quot;, &quot;#&quot; + tocArray[i + 2]);</span>
<a href="#l28.212"></a><span id="l28.212">       tocEntry = theDocument.createTextNode(tocArray[i + 1]);</span>
<a href="#l28.213"></a><span id="l28.213">       tocAnchor.appendChild(tocEntry);</span>
<a href="#l28.214"></a><span id="l28.214">       tocItem.appendChild(tocAnchor);</span>
<a href="#l28.215"></a><span id="l28.215">       item.appendChild(tocItem);</span>
<a href="#l28.216"></a><span id="l28.216">       headerIndex = tocArray[i];</span>
<a href="#l28.217"></a><span id="l28.217">     }</span>
<a href="#l28.218"></a><span id="l28.218">   }</span>
<a href="#l28.219"></a><span id="l28.219">   SaveWindowLocation();</span>
<a href="#l28.220"></a><span id="l28.220"> }</span>
<a href="#l28.221"></a><span id="l28.221"> </span>
<a href="#l28.222"></a><span id="l28.222" class="difflineminus">-function selectHeader(elt, index)</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineminus">-{</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineplus">+function selectHeader(elt, index) {</span>
<a href="#l28.225"></a><span id="l28.225">   var tag = elt.value;</span>
<a href="#l28.226"></a><span id="l28.226">   tocHeadersArray[index - 1][0] = tag;</span>
<a href="#l28.227"></a><span id="l28.227">   var textbox = document.getElementById(&quot;header&quot; + index + &quot;Class&quot;);</span>
<a href="#l28.228"></a><span id="l28.228">   if (tag == &quot;&quot;) {</span>
<a href="#l28.229"></a><span id="l28.229">     textbox.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineminus">-  }</span>
<a href="#l28.231"></a><span id="l28.231" class="difflineminus">-  else {</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineplus">+  } else {</span>
<a href="#l28.233"></a><span id="l28.233">     textbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.234"></a><span id="l28.234">   }</span>
<a href="#l28.235"></a><span id="l28.235"> }</span>
<a href="#l28.236"></a><span id="l28.236"> </span>
<a href="#l28.237"></a><span id="l28.237" class="difflineminus">-function changeClass(elt, index)</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineminus">-{</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineplus">+function changeClass(elt, index) {</span>
<a href="#l28.240"></a><span id="l28.240">   tocHeadersArray[index - 1][1] = elt.value;</span>
<a href="#l28.241"></a><span id="l28.241"> }</span>
<a href="#l28.242"></a><span id="l28.242"> </span>
<a href="#l28.243"></a><span id="l28.243" class="difflineminus">-function ToggleReadOnlyToc(elt)</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineminus">-{</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineplus">+function ToggleReadOnlyToc(elt) {</span>
<a href="#l28.246"></a><span id="l28.246">   readonly = elt.checked;</span>
<a href="#l28.247"></a><span id="l28.247"> }</span>
<a href="#l28.248"></a><span id="l28.248"> </span>
<a href="#l28.249"></a><span id="l28.249" class="difflineminus">-function ToggleOrderedList(elt)</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineminus">-{</span>
<a href="#l28.251"></a><span id="l28.251" class="difflineplus">+function ToggleOrderedList(elt) {</span>
<a href="#l28.252"></a><span id="l28.252">   orderedList = elt.checked;</span>
<a href="#l28.253"></a><span id="l28.253"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsertTable.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsertTable.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,57 +1,53 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.5"></a><span id="l29.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.6"></a><span id="l29.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">-//Cancel() is in EdDialogCommon.js</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+// Cancel() is in EdDialogCommon.js</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11"> var gTableElement = null;</span>
<a href="#l29.12"></a><span id="l29.12"> var gRows;</span>
<a href="#l29.13"></a><span id="l29.13"> var gColumns;</span>
<a href="#l29.14"></a><span id="l29.14"> var gActiveEditor;</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16"> // dialog initialization code</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l29.19"></a><span id="l29.19"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-function Startup()</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-{</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+function Startup() {</span>
<a href="#l29.24"></a><span id="l29.24">   gActiveEditor = GetCurrentTableEditor();</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-  if (!gActiveEditor)</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-  {</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+  if (!gActiveEditor) {</span>
<a href="#l29.28"></a><span id="l29.28">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l29.29"></a><span id="l29.29">     window.close();</span>
<a href="#l29.30"></a><span id="l29.30">     return;</span>
<a href="#l29.31"></a><span id="l29.31">   }</span>
<a href="#l29.32"></a><span id="l29.32"> </span>
<a href="#l29.33"></a><span id="l29.33">   try {</span>
<a href="#l29.34"></a><span id="l29.34">     gTableElement = gActiveEditor.createElementWithDefaults(&quot;table&quot;);</span>
<a href="#l29.35"></a><span id="l29.35">   } catch (e) {}</span>
<a href="#l29.36"></a><span id="l29.36"> </span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-  if(!gTableElement)</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-  {</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+  if (!gTableElement) {</span>
<a href="#l29.40"></a><span id="l29.40">     dump(&quot;Failed to create a new table!\n&quot;);</span>
<a href="#l29.41"></a><span id="l29.41">     window.close();</span>
<a href="#l29.42"></a><span id="l29.42">     return;</span>
<a href="#l29.43"></a><span id="l29.43">   }</span>
<a href="#l29.44"></a><span id="l29.44">   gDialog.rowsInput    = document.getElementById(&quot;rowsInput&quot;);</span>
<a href="#l29.45"></a><span id="l29.45">   gDialog.columnsInput = document.getElementById(&quot;columnsInput&quot;);</span>
<a href="#l29.46"></a><span id="l29.46">   gDialog.widthInput = document.getElementById(&quot;widthInput&quot;);</span>
<a href="#l29.47"></a><span id="l29.47">   gDialog.borderInput = document.getElementById(&quot;borderInput&quot;);</span>
<a href="#l29.48"></a><span id="l29.48">   gDialog.widthPixelOrPercentMenulist = document.getElementById(&quot;widthPixelOrPercentMenulist&quot;);</span>
<a href="#l29.49"></a><span id="l29.49">   gDialog.OkButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l29.50"></a><span id="l29.50"> </span>
<a href="#l29.51"></a><span id="l29.51">   // Make a copy to use for AdvancedEdit</span>
<a href="#l29.52"></a><span id="l29.52">   globalElement = gTableElement.cloneNode(false);</span>
<a href="#l29.53"></a><span id="l29.53">   try {</span>
<a href="#l29.54"></a><span id="l29.54">     if (Services.prefs.getBoolPref(&quot;editor.use_css&quot;) &amp;&amp; IsHTMLEditor()</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-        &amp;&amp; !(gActiveEditor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask))</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-    {</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+        &amp;&amp; !(gActiveEditor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)) {</span>
<a href="#l29.58"></a><span id="l29.58">       // only for Composer and not for htmlmail</span>
<a href="#l29.59"></a><span id="l29.59">       globalElement.setAttribute(&quot;style&quot;, &quot;text-align: left;&quot;);</span>
<a href="#l29.60"></a><span id="l29.60">     }</span>
<a href="#l29.61"></a><span id="l29.61">   } catch (e) {}</span>
<a href="#l29.62"></a><span id="l29.62"> </span>
<a href="#l29.63"></a><span id="l29.63">   // Initialize all widgets with image attributes</span>
<a href="#l29.64"></a><span id="l29.64">   InitDialog();</span>
<a href="#l29.65"></a><span id="l29.65"> </span>
<a href="#l29.66"></a><span id="l29.66" class="difflineat">@@ -59,65 +55,61 @@ function Startup()</span>
<a href="#l29.67"></a><span id="l29.67">   // Note, these are not attributes on the table,</span>
<a href="#l29.68"></a><span id="l29.68">   //  so don't put them in InitDialog(),</span>
<a href="#l29.69"></a><span id="l29.69">   //  else the user's values will be trashed when they use</span>
<a href="#l29.70"></a><span id="l29.70">   //  the Advanced Edit dialog</span>
<a href="#l29.71"></a><span id="l29.71">   gDialog.rowsInput.value = 2;</span>
<a href="#l29.72"></a><span id="l29.72">   gDialog.columnsInput.value = 2;</span>
<a href="#l29.73"></a><span id="l29.73"> </span>
<a href="#l29.74"></a><span id="l29.74">   // If no default value on the width, set to 100%</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-  if (gDialog.widthInput.value.length == 0)</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-  {</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+  if (gDialog.widthInput.value.length == 0) {</span>
<a href="#l29.78"></a><span id="l29.78">     gDialog.widthInput.value = &quot;100&quot;;</span>
<a href="#l29.79"></a><span id="l29.79">     gDialog.widthPixelOrPercentMenulist.selectedIndex = 1;</span>
<a href="#l29.80"></a><span id="l29.80">   }</span>
<a href="#l29.81"></a><span id="l29.81"> </span>
<a href="#l29.82"></a><span id="l29.82">   SetTextboxFocusById(&quot;rowsInput&quot;);</span>
<a href="#l29.83"></a><span id="l29.83"> </span>
<a href="#l29.84"></a><span id="l29.84">   SetWindowLocation();</span>
<a href="#l29.85"></a><span id="l29.85"> }</span>
<a href="#l29.86"></a><span id="l29.86"> </span>
<a href="#l29.87"></a><span id="l29.87"> // Set dialog widgets with attribute data</span>
<a href="#l29.88"></a><span id="l29.88"> // We get them from globalElement copy so this can be used</span>
<a href="#l29.89"></a><span id="l29.89"> //   by AdvancedEdit(), which is shared by all property dialogs</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-function InitDialog()</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-{</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+function InitDialog() {</span>
<a href="#l29.93"></a><span id="l29.93">   // Get default attributes set on the created table:</span>
<a href="#l29.94"></a><span id="l29.94">   // Get the width attribute of the element, stripping out &quot;%&quot;</span>
<a href="#l29.95"></a><span id="l29.95">   // This sets contents of menu combobox list</span>
<a href="#l29.96"></a><span id="l29.96">   // 2nd param = null: Use current selection to find if parent is table cell or window</span>
<a href="#l29.97"></a><span id="l29.97">   gDialog.widthInput.value = InitPixelOrPercentMenulist(globalElement, null, &quot;width&quot;, &quot;widthPixelOrPercentMenulist&quot;, gPercent);</span>
<a href="#l29.98"></a><span id="l29.98">   gDialog.borderInput.value = globalElement.getAttribute(&quot;border&quot;);</span>
<a href="#l29.99"></a><span id="l29.99"> }</span>
<a href="#l29.100"></a><span id="l29.100"> </span>
<a href="#l29.101"></a><span id="l29.101" class="difflineminus">-function ChangeRowOrColumn(id)</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-{</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+function ChangeRowOrColumn(id) {</span>
<a href="#l29.104"></a><span id="l29.104">   // Allow only integers</span>
<a href="#l29.105"></a><span id="l29.105">   forceInteger(id);</span>
<a href="#l29.106"></a><span id="l29.106"> </span>
<a href="#l29.107"></a><span id="l29.107">   // Enable OK only if both rows and columns have a value &gt; 0</span>
<a href="#l29.108"></a><span id="l29.108">   var enable = gDialog.rowsInput.value.length &gt; 0 &amp;&amp;</span>
<a href="#l29.109"></a><span id="l29.109">                               gDialog.rowsInput.value &gt; 0 &amp;&amp;</span>
<a href="#l29.110"></a><span id="l29.110">                               gDialog.columnsInput.value.length &gt; 0 &amp;&amp;</span>
<a href="#l29.111"></a><span id="l29.111">                               gDialog.columnsInput.value &gt; 0;</span>
<a href="#l29.112"></a><span id="l29.112"> </span>
<a href="#l29.113"></a><span id="l29.113">   SetElementEnabled(gDialog.OkButton, enable);</span>
<a href="#l29.114"></a><span id="l29.114">   SetElementEnabledById(&quot;AdvancedEditButton1&quot;, enable);</span>
<a href="#l29.115"></a><span id="l29.115"> }</span>
<a href="#l29.116"></a><span id="l29.116"> </span>
<a href="#l29.117"></a><span id="l29.117"> </span>
<a href="#l29.118"></a><span id="l29.118"> // Get and validate data from widgets.</span>
<a href="#l29.119"></a><span id="l29.119"> // Set attributes on globalElement so they can be accessed by AdvancedEdit()</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineminus">-function ValidateData()</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineminus">-{</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineminus">-  gRows = ValidateNumber(gDialog.rowsInput, null, 1, gMaxRows, null, null, true)</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineplus">+function ValidateData() {</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+  gRows = ValidateNumber(gDialog.rowsInput, null, 1, gMaxRows, null, null, true);</span>
<a href="#l29.125"></a><span id="l29.125">   if (gValidationError)</span>
<a href="#l29.126"></a><span id="l29.126">     return false;</span>
<a href="#l29.127"></a><span id="l29.127"> </span>
<a href="#l29.128"></a><span id="l29.128" class="difflineminus">-  gColumns = ValidateNumber(gDialog.columnsInput, null, 1, gMaxColumns, null, null, true)</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+  gColumns = ValidateNumber(gDialog.columnsInput, null, 1, gMaxColumns, null, null, true);</span>
<a href="#l29.130"></a><span id="l29.130">   if (gValidationError)</span>
<a href="#l29.131"></a><span id="l29.131">     return false;</span>
<a href="#l29.132"></a><span id="l29.132"> </span>
<a href="#l29.133"></a><span id="l29.133">   // Set attributes: NOTE: These may be empty strings (last param = false)</span>
<a href="#l29.134"></a><span id="l29.134">   ValidateNumber(gDialog.borderInput, null, 0, gMaxPixels, globalElement, &quot;border&quot;, false);</span>
<a href="#l29.135"></a><span id="l29.135">   // TODO: Deal with &quot;BORDER&quot; without value issue</span>
<a href="#l29.136"></a><span id="l29.136">   if (gValidationError) return false;</span>
<a href="#l29.137"></a><span id="l29.137"> </span>
<a href="#l29.138"></a><span id="l29.138" class="difflineat">@@ -125,96 +117,82 @@ function ValidateData()</span>
<a href="#l29.139"></a><span id="l29.139">                  1, gMaxTableSize, globalElement, &quot;width&quot;, false);</span>
<a href="#l29.140"></a><span id="l29.140">   if (gValidationError)</span>
<a href="#l29.141"></a><span id="l29.141">     return false;</span>
<a href="#l29.142"></a><span id="l29.142"> </span>
<a href="#l29.143"></a><span id="l29.143">   return true;</span>
<a href="#l29.144"></a><span id="l29.144"> }</span>
<a href="#l29.145"></a><span id="l29.145"> </span>
<a href="#l29.146"></a><span id="l29.146"> </span>
<a href="#l29.147"></a><span id="l29.147" class="difflineminus">-function onAccept(event)</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineminus">-{</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineminus">-  if (ValidateData())</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineminus">-  {</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineplus">+function onAccept(event) {</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l29.153"></a><span id="l29.153">     gActiveEditor.beginTransaction();</span>
<a href="#l29.154"></a><span id="l29.154">     try {</span>
<a href="#l29.155"></a><span id="l29.155">       gActiveEditor.cloneAttributes(gTableElement, globalElement);</span>
<a href="#l29.156"></a><span id="l29.156"> </span>
<a href="#l29.157"></a><span id="l29.157">       // Create necessary rows and cells for the table</span>
<a href="#l29.158"></a><span id="l29.158">       var tableBody = gActiveEditor.createElementWithDefaults(&quot;tbody&quot;);</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineminus">-      if (tableBody)</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineminus">-      {</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineplus">+      if (tableBody) {</span>
<a href="#l29.162"></a><span id="l29.162">         gTableElement.appendChild(tableBody);</span>
<a href="#l29.163"></a><span id="l29.163"> </span>
<a href="#l29.164"></a><span id="l29.164">         // Create necessary rows and cells for the table</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineminus">-        for (var i = 0; i &lt; gRows; i++)</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineminus">-        {</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineplus">+        for (var i = 0; i &lt; gRows; i++) {</span>
<a href="#l29.168"></a><span id="l29.168">           var newRow = gActiveEditor.createElementWithDefaults(&quot;tr&quot;);</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineminus">-          if (newRow)</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineminus">-          {</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineplus">+          if (newRow) {</span>
<a href="#l29.172"></a><span id="l29.172">             tableBody.appendChild(newRow);</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineminus">-            for (var j = 0; j &lt; gColumns; j++)</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineminus">-            {</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineplus">+            for (var j = 0; j &lt; gColumns; j++) {</span>
<a href="#l29.176"></a><span id="l29.176">               var newCell = gActiveEditor.createElementWithDefaults(&quot;td&quot;);</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineminus">-              if (newCell)</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineminus">-              {</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineplus">+              if (newCell) {</span>
<a href="#l29.180"></a><span id="l29.180">                 newRow.appendChild(newCell);</span>
<a href="#l29.181"></a><span id="l29.181">               }</span>
<a href="#l29.182"></a><span id="l29.182">             }</span>
<a href="#l29.183"></a><span id="l29.183">           }</span>
<a href="#l29.184"></a><span id="l29.184">         }</span>
<a href="#l29.185"></a><span id="l29.185">       }</span>
<a href="#l29.186"></a><span id="l29.186">       // Detect when entire cells are selected:</span>
<a href="#l29.187"></a><span id="l29.187">         // Get number of cells selected</span>
<a href="#l29.188"></a><span id="l29.188">       var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l29.189"></a><span id="l29.189">       var countObj = { value: 0 };</span>
<a href="#l29.190"></a><span id="l29.190">       var element = gActiveEditor.getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l29.191"></a><span id="l29.191">       var deletePlaceholder = false;</span>
<a href="#l29.192"></a><span id="l29.192"> </span>
<a href="#l29.193"></a><span id="l29.193" class="difflineminus">-      if (tagNameObj.value == &quot;table&quot;)</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineminus">-      {</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineminus">-        //Replace entire selected table with new table, so delete the table</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineplus">+      if (tagNameObj.value == &quot;table&quot;) {</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineplus">+        // Replace entire selected table with new table, so delete the table</span>
<a href="#l29.198"></a><span id="l29.198">         gActiveEditor.deleteTable();</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineminus">-      }</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineminus">-      else if (tagNameObj.value == &quot;td&quot;)</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineminus">-      {</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineminus">-        if (countObj.value &gt;= 1)</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineminus">-        {</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineminus">-          if (countObj.value &gt; 1)</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineminus">-          {</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+      } else if (tagNameObj.value == &quot;td&quot;) {</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineplus">+        if (countObj.value &gt;= 1) {</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineplus">+          if (countObj.value &gt; 1) {</span>
<a href="#l29.209"></a><span id="l29.209">             // Assume user wants to replace a block of</span>
<a href="#l29.210"></a><span id="l29.210">             //  contiguous cells with a table, so</span>
<a href="#l29.211"></a><span id="l29.211">             //  join the selected cells</span>
<a href="#l29.212"></a><span id="l29.212">             gActiveEditor.joinTableCells(false);</span>
<a href="#l29.213"></a><span id="l29.213"> </span>
<a href="#l29.214"></a><span id="l29.214">             // Get the cell everything was merged into</span>
<a href="#l29.215"></a><span id="l29.215">             element = gActiveEditor.getFirstSelectedCell();</span>
<a href="#l29.216"></a><span id="l29.216"> </span>
<a href="#l29.217"></a><span id="l29.217">             // Collapse selection into just that cell</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineminus">-            gActiveEditor.selection.collapse(element,0);</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineplus">+            gActiveEditor.selection.collapse(element, 0);</span>
<a href="#l29.220"></a><span id="l29.220">           }</span>
<a href="#l29.221"></a><span id="l29.221"> </span>
<a href="#l29.222"></a><span id="l29.222" class="difflineminus">-          if (element)</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineminus">-          {</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineplus">+          if (element) {</span>
<a href="#l29.225"></a><span id="l29.225">             // Empty just the contents of the cell</span>
<a href="#l29.226"></a><span id="l29.226">             gActiveEditor.deleteTableCellContents();</span>
<a href="#l29.227"></a><span id="l29.227"> </span>
<a href="#l29.228"></a><span id="l29.228">             // Collapse selection to start of empty cell...</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineminus">-            gActiveEditor.selection.collapse(element,0);</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineplus">+            gActiveEditor.selection.collapse(element, 0);</span>
<a href="#l29.231"></a><span id="l29.231">             // ...but it will contain a &lt;br&gt; placeholder</span>
<a href="#l29.232"></a><span id="l29.232">             deletePlaceholder = true;</span>
<a href="#l29.233"></a><span id="l29.233">           }</span>
<a href="#l29.234"></a><span id="l29.234">         }</span>
<a href="#l29.235"></a><span id="l29.235">       }</span>
<a href="#l29.236"></a><span id="l29.236"> </span>
<a href="#l29.237"></a><span id="l29.237">       // true means delete selection when inserting</span>
<a href="#l29.238"></a><span id="l29.238">       gActiveEditor.insertElementAtSelection(gTableElement, true);</span>
<a href="#l29.239"></a><span id="l29.239"> </span>
<a href="#l29.240"></a><span id="l29.240" class="difflineminus">-      if (deletePlaceholder &amp;&amp; gTableElement &amp;&amp; gTableElement.nextSibling)</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineminus">-      {</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineplus">+      if (deletePlaceholder &amp;&amp; gTableElement &amp;&amp; gTableElement.nextSibling) {</span>
<a href="#l29.243"></a><span id="l29.243">         // Delete the placeholder &lt;br&gt;</span>
<a href="#l29.244"></a><span id="l29.244">         gActiveEditor.deleteNode(gTableElement.nextSibling);</span>
<a href="#l29.245"></a><span id="l29.245">       }</span>
<a href="#l29.246"></a><span id="l29.246">     } catch (e) {}</span>
<a href="#l29.247"></a><span id="l29.247"> </span>
<a href="#l29.248"></a><span id="l29.248">     gActiveEditor.endTransaction();</span>
<a href="#l29.249"></a><span id="l29.249"> </span>
<a href="#l29.250"></a><span id="l29.250">     SaveWindowLocation();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdLabelProps.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdLabelProps.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -4,21 +4,19 @@</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5"> var labelElement;</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7"> // dialog initialization code</span>
<a href="#l30.8"></a><span id="l30.8"> </span>
<a href="#l30.9"></a><span id="l30.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l30.10"></a><span id="l30.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-function Startup()</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-{</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+function Startup() {</span>
<a href="#l30.15"></a><span id="l30.15">   var editor = GetCurrentEditor();</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-  if (!editor)</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-  {</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l30.19"></a><span id="l30.19">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l30.20"></a><span id="l30.20">     window.close();</span>
<a href="#l30.21"></a><span id="l30.21">     return;</span>
<a href="#l30.22"></a><span id="l30.22">   }</span>
<a href="#l30.23"></a><span id="l30.23"> </span>
<a href="#l30.24"></a><span id="l30.24">   gDialog.editText = document.getElementById(&quot;EditText&quot;);</span>
<a href="#l30.25"></a><span id="l30.25">   gDialog.labelText = document.getElementById(&quot;LabelText&quot;);</span>
<a href="#l30.26"></a><span id="l30.26">   gDialog.labelFor = document.getElementById(&quot;LabelFor&quot;);</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineat">@@ -30,80 +28,73 @@ function Startup()</span>
<a href="#l30.28"></a><span id="l30.28">   globalElement = labelElement.cloneNode(false);</span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30">   InitDialog();</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32">   var range = editor.document.createRange();</span>
<a href="#l30.33"></a><span id="l30.33">   range.selectNode(labelElement);</span>
<a href="#l30.34"></a><span id="l30.34">   gDialog.labelText.value = range.toString();</span>
<a href="#l30.35"></a><span id="l30.35"> </span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-  if (labelElement.innerHTML.includes(&quot;&lt;&quot;))</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-  {</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+  if (labelElement.innerHTML.includes(&quot;&lt;&quot;)) {</span>
<a href="#l30.39"></a><span id="l30.39">     gDialog.editText.checked = false;</span>
<a href="#l30.40"></a><span id="l30.40">     gDialog.editText.disabled = false;</span>
<a href="#l30.41"></a><span id="l30.41">     gDialog.labelText.disabled = true;</span>
<a href="#l30.42"></a><span id="l30.42">     gDialog.editText.addEventListener(&quot;command&quot;,</span>
<a href="#l30.43"></a><span id="l30.43">       () =&gt; Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;EditTextWarning&quot;)),</span>
<a href="#l30.44"></a><span id="l30.44">       {capture: false, once: true});</span>
<a href="#l30.45"></a><span id="l30.45">     SetTextboxFocus(gDialog.labelFor);</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-  }</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-  else</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+  } else</span>
<a href="#l30.49"></a><span id="l30.49">     SetTextboxFocus(gDialog.labelText);</span>
<a href="#l30.50"></a><span id="l30.50"> </span>
<a href="#l30.51"></a><span id="l30.51">   SetWindowLocation();</span>
<a href="#l30.52"></a><span id="l30.52"> }</span>
<a href="#l30.53"></a><span id="l30.53"> </span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-function InitDialog()</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-{</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+function InitDialog() {</span>
<a href="#l30.57"></a><span id="l30.57">   gDialog.labelFor.value = globalElement.getAttribute(&quot;for&quot;);</span>
<a href="#l30.58"></a><span id="l30.58">   gDialog.labelAccessKey.value = globalElement.getAttribute(&quot;accesskey&quot;);</span>
<a href="#l30.59"></a><span id="l30.59"> }</span>
<a href="#l30.60"></a><span id="l30.60"> </span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-function RemoveLabel()</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-{</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+function RemoveLabel() {</span>
<a href="#l30.64"></a><span id="l30.64">   RemoveContainer(labelElement);</span>
<a href="#l30.65"></a><span id="l30.65">   SaveWindowLocation();</span>
<a href="#l30.66"></a><span id="l30.66">   window.close();</span>
<a href="#l30.67"></a><span id="l30.67"> }</span>
<a href="#l30.68"></a><span id="l30.68"> </span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-function ValidateData()</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-{</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+function ValidateData() {</span>
<a href="#l30.72"></a><span id="l30.72">   if (gDialog.labelFor.value)</span>
<a href="#l30.73"></a><span id="l30.73">     globalElement.setAttribute(&quot;for&quot;, gDialog.labelFor.value);</span>
<a href="#l30.74"></a><span id="l30.74">   else</span>
<a href="#l30.75"></a><span id="l30.75">     globalElement.removeAttribute(&quot;for&quot;);</span>
<a href="#l30.76"></a><span id="l30.76">   if (gDialog.labelAccessKey.value)</span>
<a href="#l30.77"></a><span id="l30.77">     globalElement.setAttribute(&quot;accesskey&quot;, gDialog.labelAccessKey.value);</span>
<a href="#l30.78"></a><span id="l30.78">   else</span>
<a href="#l30.79"></a><span id="l30.79">     globalElement.removeAttribute(&quot;accesskey&quot;);</span>
<a href="#l30.80"></a><span id="l30.80">   return true;</span>
<a href="#l30.81"></a><span id="l30.81"> }</span>
<a href="#l30.82"></a><span id="l30.82"> </span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-function onAccept()</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-{</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+function onAccept() {</span>
<a href="#l30.86"></a><span id="l30.86">   // All values are valid - copy to actual element in doc</span>
<a href="#l30.87"></a><span id="l30.87">   ValidateData();</span>
<a href="#l30.88"></a><span id="l30.88"> </span>
<a href="#l30.89"></a><span id="l30.89">   var editor = GetCurrentEditor();</span>
<a href="#l30.90"></a><span id="l30.90"> </span>
<a href="#l30.91"></a><span id="l30.91">   editor.beginTransaction();</span>
<a href="#l30.92"></a><span id="l30.92"> </span>
<a href="#l30.93"></a><span id="l30.93">   try {</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-    if (gDialog.editText.checked)</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-    {</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+    if (gDialog.editText.checked) {</span>
<a href="#l30.97"></a><span id="l30.97">       editor.setShouldTxnSetSelection(false);</span>
<a href="#l30.98"></a><span id="l30.98"> </span>
<a href="#l30.99"></a><span id="l30.99">       while (labelElement.firstChild)</span>
<a href="#l30.100"></a><span id="l30.100">         editor.deleteNode(labelElement.firstChild);</span>
<a href="#l30.101"></a><span id="l30.101">       if (gDialog.labelText.value)</span>
<a href="#l30.102"></a><span id="l30.102">         editor.insertNode(editor.document.createTextNode(gDialog.labelText.value), labelElement, 0);</span>
<a href="#l30.103"></a><span id="l30.103"> </span>
<a href="#l30.104"></a><span id="l30.104">       editor.setShouldTxnSetSelection(true);</span>
<a href="#l30.105"></a><span id="l30.105">     }</span>
<a href="#l30.106"></a><span id="l30.106"> </span>
<a href="#l30.107"></a><span id="l30.107">     editor.cloneAttributes(labelElement, globalElement);</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-  } catch(e) {}</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+  } catch (e) {}</span>
<a href="#l30.110"></a><span id="l30.110"> </span>
<a href="#l30.111"></a><span id="l30.111">   editor.endTransaction();</span>
<a href="#l30.112"></a><span id="l30.112"> </span>
<a href="#l30.113"></a><span id="l30.113">   SaveWindowLocation();</span>
<a href="#l30.114"></a><span id="l30.114"> }</span>
<a href="#l30.115"></a><span id="l30.115"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdLinkProps.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdLinkProps.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -22,152 +22,129 @@ var gHaveDocumentUrl = false;</span>
<a href="#l31.4"></a><span id="l31.4"> // The returned node is has an &quot;a&quot; tagName</span>
<a href="#l31.5"></a><span id="l31.5"> var tagName = &quot;href&quot;;</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7"> // dialog initialization code</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l31.10"></a><span id="l31.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-function Startup()</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-{</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+function Startup() {</span>
<a href="#l31.15"></a><span id="l31.15">   gActiveEditor = GetCurrentEditor();</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-  if (!gActiveEditor)</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-  {</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+  if (!gActiveEditor) {</span>
<a href="#l31.19"></a><span id="l31.19">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l31.20"></a><span id="l31.20">     window.close();</span>
<a href="#l31.21"></a><span id="l31.21">     return;</span>
<a href="#l31.22"></a><span id="l31.22">   }</span>
<a href="#l31.23"></a><span id="l31.23">   // Message was wrapped in a &lt;label&gt; or &lt;div&gt;, so actual text is a child text node</span>
<a href="#l31.24"></a><span id="l31.24">   gDialog.linkTextCaption     = document.getElementById(&quot;linkTextCaption&quot;);</span>
<a href="#l31.25"></a><span id="l31.25">   gDialog.linkTextMessage     = document.getElementById(&quot;linkTextMessage&quot;);</span>
<a href="#l31.26"></a><span id="l31.26">   gDialog.linkTextInput       = document.getElementById(&quot;linkTextInput&quot;);</span>
<a href="#l31.27"></a><span id="l31.27">   gDialog.hrefInput           = document.getElementById(&quot;hrefInput&quot;);</span>
<a href="#l31.28"></a><span id="l31.28">   gDialog.makeRelativeLink    = document.getElementById(&quot;MakeRelativeLink&quot;);</span>
<a href="#l31.29"></a><span id="l31.29">   gDialog.AdvancedEditSection = document.getElementById(&quot;AdvancedEdit&quot;);</span>
<a href="#l31.30"></a><span id="l31.30"> </span>
<a href="#l31.31"></a><span id="l31.31">   // See if we have a single selected image</span>
<a href="#l31.32"></a><span id="l31.32">   imageElement = gActiveEditor.getSelectedElement(&quot;img&quot;);</span>
<a href="#l31.33"></a><span id="l31.33"> </span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-  if (imageElement)</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-  {</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+  if (imageElement) {</span>
<a href="#l31.37"></a><span id="l31.37">     // Get the parent link if it exists -- more efficient than GetSelectedElement()</span>
<a href="#l31.38"></a><span id="l31.38">     anchorElement = gActiveEditor.getElementOrParentByTagName(&quot;href&quot;, imageElement);</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-    if (anchorElement)</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineminus">-    {</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-      if (anchorElement.childNodes.length &gt; 1)</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-      {</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+    if (anchorElement) {</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+      if (anchorElement.childNodes.length &gt; 1) {</span>
<a href="#l31.45"></a><span id="l31.45">         // If there are other children, then we want to break</span>
<a href="#l31.46"></a><span id="l31.46">         //  this image away by inserting a new link around it,</span>
<a href="#l31.47"></a><span id="l31.47">         //  so make a new node and copy existing attributes</span>
<a href="#l31.48"></a><span id="l31.48">         anchorElement = anchorElement.cloneNode(false);</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-        //insertNew = true;</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+        // insertNew = true;</span>
<a href="#l31.51"></a><span id="l31.51">         replaceExistingLink = true;</span>
<a href="#l31.52"></a><span id="l31.52">       }</span>
<a href="#l31.53"></a><span id="l31.53">     }</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-  }</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-  else</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-  {</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+  } else {</span>
<a href="#l31.58"></a><span id="l31.58">     // Get an anchor element if caret or</span>
<a href="#l31.59"></a><span id="l31.59">     //   entire selection is within the link.</span>
<a href="#l31.60"></a><span id="l31.60">     anchorElement = gActiveEditor.getSelectedElement(tagName);</span>
<a href="#l31.61"></a><span id="l31.61"> </span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-    if (anchorElement)</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-    {</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+    if (anchorElement) {</span>
<a href="#l31.65"></a><span id="l31.65">       // Select the entire link</span>
<a href="#l31.66"></a><span id="l31.66">       gActiveEditor.selectElement(anchorElement);</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-    }</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-    else</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-    {</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+    } else {</span>
<a href="#l31.71"></a><span id="l31.71">       // If selection starts in a link, but extends beyond it,</span>
<a href="#l31.72"></a><span id="l31.72">       //   the user probably wants to extend existing link to new selection,</span>
<a href="#l31.73"></a><span id="l31.73">       //   so check if either end of selection is within a link</span>
<a href="#l31.74"></a><span id="l31.74">       // POTENTIAL PROBLEM: This prevents user from selecting text in an existing</span>
<a href="#l31.75"></a><span id="l31.75">       //   link and making 2 links.</span>
<a href="#l31.76"></a><span id="l31.76">       // Note that this isn't a problem with images, handled above</span>
<a href="#l31.77"></a><span id="l31.77"> </span>
<a href="#l31.78"></a><span id="l31.78">       anchorElement = gActiveEditor.getElementOrParentByTagName(&quot;href&quot;, gActiveEditor.selection.anchorNode);</span>
<a href="#l31.79"></a><span id="l31.79">       if (!anchorElement)</span>
<a href="#l31.80"></a><span id="l31.80">         anchorElement = gActiveEditor.getElementOrParentByTagName(&quot;href&quot;, gActiveEditor.selection.focusNode);</span>
<a href="#l31.81"></a><span id="l31.81"> </span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-      if (anchorElement)</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-      {</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+      if (anchorElement) {</span>
<a href="#l31.85"></a><span id="l31.85">         // But clone it for reinserting/merging around existing</span>
<a href="#l31.86"></a><span id="l31.86">         //   link that only partially overlaps the selection</span>
<a href="#l31.87"></a><span id="l31.87">         anchorElement = anchorElement.cloneNode(false);</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineminus">-        //insertNew = true;</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+        // insertNew = true;</span>
<a href="#l31.90"></a><span id="l31.90">         replaceExistingLink = true;</span>
<a href="#l31.91"></a><span id="l31.91">       }</span>
<a href="#l31.92"></a><span id="l31.92">     }</span>
<a href="#l31.93"></a><span id="l31.93">   }</span>
<a href="#l31.94"></a><span id="l31.94"> </span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-  if(!anchorElement)</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-  {</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+  if (!anchorElement) {</span>
<a href="#l31.98"></a><span id="l31.98">     // No existing link -- create a new one</span>
<a href="#l31.99"></a><span id="l31.99">     anchorElement = gActiveEditor.createElementWithDefaults(tagName);</span>
<a href="#l31.100"></a><span id="l31.100">     insertNew = true;</span>
<a href="#l31.101"></a><span id="l31.101">     // Hide message about removing existing link</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineminus">-    //document.getElementById(&quot;RemoveLinkMsg&quot;).hidden = true;</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+    // document.getElementById(&quot;RemoveLinkMsg&quot;).hidden = true;</span>
<a href="#l31.104"></a><span id="l31.104">   }</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-  if(!anchorElement)</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-  {</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+  if (!anchorElement) {</span>
<a href="#l31.108"></a><span id="l31.108">     dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l31.109"></a><span id="l31.109">     window.close();</span>
<a href="#l31.110"></a><span id="l31.110">     return;</span>
<a href="#l31.111"></a><span id="l31.111">   }</span>
<a href="#l31.112"></a><span id="l31.112"> </span>
<a href="#l31.113"></a><span id="l31.113">   // We insert at caret only when nothing is selected</span>
<a href="#l31.114"></a><span id="l31.114">   insertLinkAtCaret = gActiveEditor.selection.isCollapsed;</span>
<a href="#l31.115"></a><span id="l31.115"> </span>
<a href="#l31.116"></a><span id="l31.116">   var selectedText;</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-  if (insertLinkAtCaret)</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-  {</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+  if (insertLinkAtCaret) {</span>
<a href="#l31.120"></a><span id="l31.120">     // Groupbox caption:</span>
<a href="#l31.121"></a><span id="l31.121">     gDialog.linkTextCaption.setAttribute(&quot;label&quot;, GetString(&quot;LinkText&quot;));</span>
<a href="#l31.122"></a><span id="l31.122"> </span>
<a href="#l31.123"></a><span id="l31.123">     // Message above input field:</span>
<a href="#l31.124"></a><span id="l31.124">     gDialog.linkTextMessage.setAttribute(&quot;value&quot;, GetString(&quot;EnterLinkText&quot;));</span>
<a href="#l31.125"></a><span id="l31.125">     gDialog.linkTextMessage.setAttribute(&quot;accesskey&quot;, GetString(&quot;EnterLinkTextAccessKey&quot;));</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-  }</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineminus">-  else</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineminus">-  {</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineminus">-    if (!imageElement)</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineminus">-    {</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+  } else {</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+    if (!imageElement) {</span>
<a href="#l31.133"></a><span id="l31.133">       // We get here if selection is exactly around a link node</span>
<a href="#l31.134"></a><span id="l31.134">       // Check if selection has some text - use that first</span>
<a href="#l31.135"></a><span id="l31.135">       selectedText = GetSelectionAsText();</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineminus">-      if (!selectedText)</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-      {</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+      if (!selectedText) {</span>
<a href="#l31.139"></a><span id="l31.139">         // No text, look for first image in the selection</span>
<a href="#l31.140"></a><span id="l31.140">         var children = anchorElement.childNodes;</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineminus">-        if (children)</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineminus">-        {</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineminus">-          for(var i=0; i &lt; children.length; i++)</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineminus">-          {</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineplus">+        if (children) {</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineplus">+          for (var i = 0; i &lt; children.length; i++) {</span>
<a href="#l31.147"></a><span id="l31.147">             var nodeName = children.item(i).nodeName.toLowerCase();</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineminus">-            if (nodeName == &quot;img&quot;)</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineminus">-            {</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineplus">+            if (nodeName == &quot;img&quot;) {</span>
<a href="#l31.151"></a><span id="l31.151">               imageElement = children.item(i);</span>
<a href="#l31.152"></a><span id="l31.152">               break;</span>
<a href="#l31.153"></a><span id="l31.153">             }</span>
<a href="#l31.154"></a><span id="l31.154">           }</span>
<a href="#l31.155"></a><span id="l31.155">         }</span>
<a href="#l31.156"></a><span id="l31.156">       }</span>
<a href="#l31.157"></a><span id="l31.157">     }</span>
<a href="#l31.158"></a><span id="l31.158">     // Set &quot;caption&quot; for link source and the source text or image URL</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineminus">-    if (imageElement)</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineminus">-    {</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineplus">+    if (imageElement) {</span>
<a href="#l31.162"></a><span id="l31.162">       gDialog.linkTextCaption.setAttribute(&quot;label&quot;, GetString(&quot;LinkImage&quot;));</span>
<a href="#l31.163"></a><span id="l31.163">       // Link source string is the source URL of image</span>
<a href="#l31.164"></a><span id="l31.164">       // TODO: THIS DOESN'T HANDLE MULTIPLE SELECTED IMAGES!</span>
<a href="#l31.165"></a><span id="l31.165">       gDialog.linkTextMessage.setAttribute(&quot;value&quot;, imageElement.src);</span>
<a href="#l31.166"></a><span id="l31.166">     } else {</span>
<a href="#l31.167"></a><span id="l31.167">       gDialog.linkTextCaption.setAttribute(&quot;label&quot;, GetString(&quot;LinkText&quot;));</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineminus">-      if (selectedText)</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineminus">-      {</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineplus">+      if (selectedText) {</span>
<a href="#l31.171"></a><span id="l31.171">         // Use just the first 60 characters and add &quot;...&quot;</span>
<a href="#l31.172"></a><span id="l31.172">         gDialog.linkTextMessage.setAttribute(&quot;value&quot;, TruncateStringAtWordEnd(ReplaceWhitespace(selectedText, &quot; &quot;), 60, true));</span>
<a href="#l31.173"></a><span id="l31.173">       } else {</span>
<a href="#l31.174"></a><span id="l31.174">         gDialog.linkTextMessage.setAttribute(&quot;value&quot;, GetString(&quot;MixedSelection&quot;));</span>
<a href="#l31.175"></a><span id="l31.175">       }</span>
<a href="#l31.176"></a><span id="l31.176">     }</span>
<a href="#l31.177"></a><span id="l31.177">   }</span>
<a href="#l31.178"></a><span id="l31.178"> </span>
<a href="#l31.179"></a><span id="l31.179" class="difflineat">@@ -205,140 +182,121 @@ function Startup()</span>
<a href="#l31.180"></a><span id="l31.180">   doEnabling();</span>
<a href="#l31.181"></a><span id="l31.181"> </span>
<a href="#l31.182"></a><span id="l31.182">   SetWindowLocation();</span>
<a href="#l31.183"></a><span id="l31.183"> }</span>
<a href="#l31.184"></a><span id="l31.184"> </span>
<a href="#l31.185"></a><span id="l31.185"> // Set dialog widgets with attribute data</span>
<a href="#l31.186"></a><span id="l31.186"> // We get them from globalElement copy so this can be used</span>
<a href="#l31.187"></a><span id="l31.187"> //   by AdvancedEdit(), which is shared by all property dialogs</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineminus">-function InitDialog()</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineminus">-{</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineplus">+function InitDialog() {</span>
<a href="#l31.191"></a><span id="l31.191">   // Must use getAttribute, not &quot;globalElement.href&quot;,</span>
<a href="#l31.192"></a><span id="l31.192">   //  or foreign chars aren't converted correctly!</span>
<a href="#l31.193"></a><span id="l31.193">   gDialog.hrefInput.value = globalElement.getAttribute(&quot;href&quot;);</span>
<a href="#l31.194"></a><span id="l31.194"> </span>
<a href="#l31.195"></a><span id="l31.195">   // Set &quot;Relativize&quot; checkbox according to current URL state</span>
<a href="#l31.196"></a><span id="l31.196">   SetRelativeCheckbox(gDialog.makeRelativeLink);</span>
<a href="#l31.197"></a><span id="l31.197"> }</span>
<a href="#l31.198"></a><span id="l31.198"> </span>
<a href="#l31.199"></a><span id="l31.199" class="difflineminus">-function doEnabling()</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineminus">-{</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineplus">+function doEnabling() {</span>
<a href="#l31.202"></a><span id="l31.202">   // We disable Ok button when there's no href text only if inserting a new link</span>
<a href="#l31.203"></a><span id="l31.203">   var enable = insertNew ? (TrimString(gDialog.hrefInput.value).length &gt; 0) : true;</span>
<a href="#l31.204"></a><span id="l31.204"> </span>
<a href="#l31.205"></a><span id="l31.205">   // anon. content, so can't use SetElementEnabledById here</span>
<a href="#l31.206"></a><span id="l31.206">   var dialogNode = document.getElementById(&quot;linkDlg&quot;);</span>
<a href="#l31.207"></a><span id="l31.207">   dialogNode.getButton(&quot;accept&quot;).disabled = !enable;</span>
<a href="#l31.208"></a><span id="l31.208"> </span>
<a href="#l31.209"></a><span id="l31.209" class="difflineminus">-  SetElementEnabledById( &quot;AdvancedEditButton1&quot;, enable);</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineplus">+  SetElementEnabledById(&quot;AdvancedEditButton1&quot;, enable);</span>
<a href="#l31.211"></a><span id="l31.211"> }</span>
<a href="#l31.212"></a><span id="l31.212"> </span>
<a href="#l31.213"></a><span id="l31.213" class="difflineminus">-function ChangeLinkLocation()</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineminus">-{</span>
<a href="#l31.215"></a><span id="l31.215" class="difflineplus">+function ChangeLinkLocation() {</span>
<a href="#l31.216"></a><span id="l31.216">   SetRelativeCheckbox(gDialog.makeRelativeLink);</span>
<a href="#l31.217"></a><span id="l31.217">   // Set OK button enable state</span>
<a href="#l31.218"></a><span id="l31.218">   doEnabling();</span>
<a href="#l31.219"></a><span id="l31.219"> }</span>
<a href="#l31.220"></a><span id="l31.220"> </span>
<a href="#l31.221"></a><span id="l31.221"> // Get and validate data from widgets.</span>
<a href="#l31.222"></a><span id="l31.222"> // Set attributes on globalElement so they can be accessed by AdvancedEdit()</span>
<a href="#l31.223"></a><span id="l31.223" class="difflineminus">-function ValidateData()</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineminus">-{</span>
<a href="#l31.225"></a><span id="l31.225" class="difflineplus">+function ValidateData() {</span>
<a href="#l31.226"></a><span id="l31.226">   href = TrimString(gDialog.hrefInput.value);</span>
<a href="#l31.227"></a><span id="l31.227" class="difflineminus">-  if (href)</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineminus">-  {</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineplus">+  if (href) {</span>
<a href="#l31.230"></a><span id="l31.230">     // Set the HREF directly on the editor document's anchor node</span>
<a href="#l31.231"></a><span id="l31.231">     //  or on the newly-created node if insertNew is true</span>
<a href="#l31.232"></a><span id="l31.232" class="difflineminus">-    globalElement.setAttribute(&quot;href&quot;,href);</span>
<a href="#l31.233"></a><span id="l31.233" class="difflineminus">-  }</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineminus">-  else if (insertNew)</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineminus">-  {</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineplus">+    globalElement.setAttribute(&quot;href&quot;, href);</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineplus">+  } else if (insertNew) {</span>
<a href="#l31.238"></a><span id="l31.238">     // We must have a URL to insert a new link</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineminus">-    //NOTE: We accept an empty HREF on existing link to indicate removing the link</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineplus">+    // NOTE: We accept an empty HREF on existing link to indicate removing the link</span>
<a href="#l31.241"></a><span id="l31.241">     ShowInputErrorMessage(GetString(&quot;EmptyHREFError&quot;));</span>
<a href="#l31.242"></a><span id="l31.242">     return false;</span>
<a href="#l31.243"></a><span id="l31.243">   }</span>
<a href="#l31.244"></a><span id="l31.244" class="difflineminus">-  if (gDialog.linkTextInput)</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineminus">-  {</span>
<a href="#l31.246"></a><span id="l31.246" class="difflineplus">+  if (gDialog.linkTextInput) {</span>
<a href="#l31.247"></a><span id="l31.247">     // The text we will insert isn't really an attribute,</span>
<a href="#l31.248"></a><span id="l31.248">     //  but it makes sense to validate it</span>
<a href="#l31.249"></a><span id="l31.249">     newLinkText = TrimString(gDialog.linkTextInput.value);</span>
<a href="#l31.250"></a><span id="l31.250" class="difflineminus">-    if (!newLinkText)</span>
<a href="#l31.251"></a><span id="l31.251" class="difflineminus">-    {</span>
<a href="#l31.252"></a><span id="l31.252" class="difflineplus">+    if (!newLinkText) {</span>
<a href="#l31.253"></a><span id="l31.253">       if (href)</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineminus">-        newLinkText = href</span>
<a href="#l31.255"></a><span id="l31.255" class="difflineminus">-      else</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineminus">-      {</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineplus">+        newLinkText = href;</span>
<a href="#l31.258"></a><span id="l31.258" class="difflineplus">+      else {</span>
<a href="#l31.259"></a><span id="l31.259">         ShowInputErrorMessage(GetString(&quot;EmptyLinkTextError&quot;));</span>
<a href="#l31.260"></a><span id="l31.260">         SetTextboxFocus(gDialog.linkTextInput);</span>
<a href="#l31.261"></a><span id="l31.261">         return false;</span>
<a href="#l31.262"></a><span id="l31.262">       }</span>
<a href="#l31.263"></a><span id="l31.263">     }</span>
<a href="#l31.264"></a><span id="l31.264">   }</span>
<a href="#l31.265"></a><span id="l31.265">   return true;</span>
<a href="#l31.266"></a><span id="l31.266"> }</span>
<a href="#l31.267"></a><span id="l31.267"> </span>
<a href="#l31.268"></a><span id="l31.268" class="difflineminus">-function onAccept(event)</span>
<a href="#l31.269"></a><span id="l31.269" class="difflineminus">-{</span>
<a href="#l31.270"></a><span id="l31.270" class="difflineminus">-  if (ValidateData())</span>
<a href="#l31.271"></a><span id="l31.271" class="difflineminus">-  {</span>
<a href="#l31.272"></a><span id="l31.272" class="difflineminus">-    if (href.length &gt; 0)</span>
<a href="#l31.273"></a><span id="l31.273" class="difflineminus">-    {</span>
<a href="#l31.274"></a><span id="l31.274" class="difflineplus">+function onAccept(event) {</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineplus">+    if (href.length &gt; 0) {</span>
<a href="#l31.277"></a><span id="l31.277">       // Copy attributes to element we are changing or inserting</span>
<a href="#l31.278"></a><span id="l31.278">       gActiveEditor.cloneAttributes(anchorElement, globalElement);</span>
<a href="#l31.279"></a><span id="l31.279"> </span>
<a href="#l31.280"></a><span id="l31.280">       // Coalesce into one undo transaction</span>
<a href="#l31.281"></a><span id="l31.281">       gActiveEditor.beginTransaction();</span>
<a href="#l31.282"></a><span id="l31.282"> </span>
<a href="#l31.283"></a><span id="l31.283">       // Get text to use for a new link</span>
<a href="#l31.284"></a><span id="l31.284" class="difflineminus">-      if (insertLinkAtCaret)</span>
<a href="#l31.285"></a><span id="l31.285" class="difflineminus">-      {</span>
<a href="#l31.286"></a><span id="l31.286" class="difflineplus">+      if (insertLinkAtCaret) {</span>
<a href="#l31.287"></a><span id="l31.287">         // Append the link text as the last child node</span>
<a href="#l31.288"></a><span id="l31.288">         //   of the anchor node</span>
<a href="#l31.289"></a><span id="l31.289">         var textNode = gActiveEditor.document.createTextNode(newLinkText);</span>
<a href="#l31.290"></a><span id="l31.290">         if (textNode)</span>
<a href="#l31.291"></a><span id="l31.291">           anchorElement.appendChild(textNode);</span>
<a href="#l31.292"></a><span id="l31.292">         try {</span>
<a href="#l31.293"></a><span id="l31.293">           gActiveEditor.insertElementAtSelection(anchorElement, false);</span>
<a href="#l31.294"></a><span id="l31.294">         } catch (e) {</span>
<a href="#l31.295"></a><span id="l31.295">           dump(&quot;Exception occurred in InsertElementAtSelection\n&quot;);</span>
<a href="#l31.296"></a><span id="l31.296">           return;</span>
<a href="#l31.297"></a><span id="l31.297">         }</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineminus">-      } else if (insertNew || replaceExistingLink)</span>
<a href="#l31.299"></a><span id="l31.299" class="difflineminus">-      {</span>
<a href="#l31.300"></a><span id="l31.300" class="difflineplus">+      } else if (insertNew || replaceExistingLink) {</span>
<a href="#l31.301"></a><span id="l31.301">         //  Link source was supplied by the selection,</span>
<a href="#l31.302"></a><span id="l31.302">         //  so insert a link node as parent of this</span>
<a href="#l31.303"></a><span id="l31.303">         //  (may be text, image, or other inline content)</span>
<a href="#l31.304"></a><span id="l31.304">         try {</span>
<a href="#l31.305"></a><span id="l31.305">           gActiveEditor.insertLinkAroundSelection(anchorElement);</span>
<a href="#l31.306"></a><span id="l31.306">         } catch (e) {</span>
<a href="#l31.307"></a><span id="l31.307">           dump(&quot;Exception occurred in InsertElementAtSelection\n&quot;);</span>
<a href="#l31.308"></a><span id="l31.308">           return;</span>
<a href="#l31.309"></a><span id="l31.309">         }</span>
<a href="#l31.310"></a><span id="l31.310">       }</span>
<a href="#l31.311"></a><span id="l31.311">       // Check if the link was to a heading</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineminus">-      if (href in gHNodeArray)</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineminus">-      {</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineplus">+      if (href in gHNodeArray) {</span>
<a href="#l31.315"></a><span id="l31.315">         var anchorNode = gActiveEditor.createElementWithDefaults(&quot;a&quot;);</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineminus">-        if (anchorNode)</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineminus">-        {</span>
<a href="#l31.318"></a><span id="l31.318" class="difflineplus">+        if (anchorNode) {</span>
<a href="#l31.319"></a><span id="l31.319">           anchorNode.name = href.substr(1);</span>
<a href="#l31.320"></a><span id="l31.320"> </span>
<a href="#l31.321"></a><span id="l31.321">           // Insert the anchor into the document,</span>
<a href="#l31.322"></a><span id="l31.322">           //  but don't let the transaction change the selection</span>
<a href="#l31.323"></a><span id="l31.323">           gActiveEditor.setShouldTxnSetSelection(false);</span>
<a href="#l31.324"></a><span id="l31.324">           gActiveEditor.insertNode(anchorNode, gHNodeArray[href], 0);</span>
<a href="#l31.325"></a><span id="l31.325">           gActiveEditor.setShouldTxnSetSelection(true);</span>
<a href="#l31.326"></a><span id="l31.326">         }</span>
<a href="#l31.327"></a><span id="l31.327">       }</span>
<a href="#l31.328"></a><span id="l31.328">       gActiveEditor.endTransaction();</span>
<a href="#l31.329"></a><span id="l31.329" class="difflineminus">-    }</span>
<a href="#l31.330"></a><span id="l31.330" class="difflineminus">-    else if (!insertNew)</span>
<a href="#l31.331"></a><span id="l31.331" class="difflineminus">-    {</span>
<a href="#l31.332"></a><span id="l31.332" class="difflineplus">+    } else if (!insertNew) {</span>
<a href="#l31.333"></a><span id="l31.333">       // We already had a link, but empty HREF means remove it</span>
<a href="#l31.334"></a><span id="l31.334">       EditorRemoveTextProperty(&quot;href&quot;, &quot;&quot;);</span>
<a href="#l31.335"></a><span id="l31.335">     }</span>
<a href="#l31.336"></a><span id="l31.336">     SaveWindowLocation();</span>
<a href="#l31.337"></a><span id="l31.337">     return;</span>
<a href="#l31.338"></a><span id="l31.338">   }</span>
<a href="#l31.339"></a><span id="l31.339">   event.preventDefault();</span>
<a href="#l31.340"></a><span id="l31.340"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdListProps.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdListProps.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.5"></a><span id="l32.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.6"></a><span id="l32.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8" class="difflineminus">-//Cancel() is in EdDialogCommon.js</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+// Cancel() is in EdDialogCommon.js</span>
<a href="#l32.10"></a><span id="l32.10"> var gBulletStyleType = &quot;&quot;;</span>
<a href="#l32.11"></a><span id="l32.11"> var gNumberStyleType = &quot;&quot;;</span>
<a href="#l32.12"></a><span id="l32.12"> var gListElement;</span>
<a href="#l32.13"></a><span id="l32.13"> var gOriginalListType = &quot;&quot;;</span>
<a href="#l32.14"></a><span id="l32.14"> var gListType = &quot;&quot;;</span>
<a href="#l32.15"></a><span id="l32.15"> var gMixedListSelection = false;</span>
<a href="#l32.16"></a><span id="l32.16"> var gStyleType = &quot;&quot;;</span>
<a href="#l32.17"></a><span id="l32.17"> var gOriginalStyleType = &quot;&quot;;</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineat">@@ -28,272 +28,243 @@ const gLowerRomanCSS = &quot;lower-roman&quot;;</span>
<a href="#l32.19"></a><span id="l32.19"> const gUpperAlphaCSS = &quot;upper-alpha&quot;;</span>
<a href="#l32.20"></a><span id="l32.20"> const gLowerAlphaCSS = &quot;lower-alpha&quot;;</span>
<a href="#l32.21"></a><span id="l32.21"> </span>
<a href="#l32.22"></a><span id="l32.22"> // dialog initialization code</span>
<a href="#l32.23"></a><span id="l32.23"> </span>
<a href="#l32.24"></a><span id="l32.24"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l32.25"></a><span id="l32.25"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-function Startup()</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-{</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+function Startup() {</span>
<a href="#l32.30"></a><span id="l32.30">   var editor = GetCurrentEditor();</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-  if (!editor)</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-  {</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+  if (!editor) {</span>
<a href="#l32.34"></a><span id="l32.34">     window.close();</span>
<a href="#l32.35"></a><span id="l32.35">     return;</span>
<a href="#l32.36"></a><span id="l32.36">   }</span>
<a href="#l32.37"></a><span id="l32.37">   gDialog.ListTypeList = document.getElementById(&quot;ListType&quot;);</span>
<a href="#l32.38"></a><span id="l32.38">   gDialog.BulletStyleList = document.getElementById(&quot;BulletStyle&quot;);</span>
<a href="#l32.39"></a><span id="l32.39">   gDialog.BulletStyleLabel = document.getElementById(&quot;BulletStyleLabel&quot;);</span>
<a href="#l32.40"></a><span id="l32.40">   gDialog.StartingNumberInput = document.getElementById(&quot;StartingNumber&quot;);</span>
<a href="#l32.41"></a><span id="l32.41">   gDialog.StartingNumberLabel = document.getElementById(&quot;StartingNumberLabel&quot;);</span>
<a href="#l32.42"></a><span id="l32.42">   gDialog.AdvancedEditButton = document.getElementById(&quot;AdvancedEditButton1&quot;);</span>
<a href="#l32.43"></a><span id="l32.43">   gDialog.RadioGroup = document.getElementById(&quot;RadioGroup&quot;);</span>
<a href="#l32.44"></a><span id="l32.44">   gDialog.ChangeAllRadio = document.getElementById(&quot;ChangeAll&quot;);</span>
<a href="#l32.45"></a><span id="l32.45">   gDialog.ChangeSelectedRadio = document.getElementById(&quot;ChangeSelected&quot;);</span>
<a href="#l32.46"></a><span id="l32.46"> </span>
<a href="#l32.47"></a><span id="l32.47">   // Try to get an existing list(s)</span>
<a href="#l32.48"></a><span id="l32.48">   var mixedObj = { value: null };</span>
<a href="#l32.49"></a><span id="l32.49">   try {</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-    gListType = editor.getListState(mixedObj, {}, {}, {} );</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+    gListType = editor.getListState(mixedObj, {}, {}, {});</span>
<a href="#l32.52"></a><span id="l32.52"> </span>
<a href="#l32.53"></a><span id="l32.53">     // We may have mixed list and non-list, or &gt; 1 list type in selection</span>
<a href="#l32.54"></a><span id="l32.54">     gMixedListSelection = mixedObj.value;</span>
<a href="#l32.55"></a><span id="l32.55"> </span>
<a href="#l32.56"></a><span id="l32.56">     // Get the list element at the anchor node</span>
<a href="#l32.57"></a><span id="l32.57">     gListElement = editor.getElementOrParentByTagName(&quot;list&quot;, null);</span>
<a href="#l32.58"></a><span id="l32.58">   } catch (e) {}</span>
<a href="#l32.59"></a><span id="l32.59"> </span>
<a href="#l32.60"></a><span id="l32.60">   // The copy to use in AdvancedEdit</span>
<a href="#l32.61"></a><span id="l32.61">   if (gListElement)</span>
<a href="#l32.62"></a><span id="l32.62">     globalElement = gListElement.cloneNode(false);</span>
<a href="#l32.63"></a><span id="l32.63"> </span>
<a href="#l32.64"></a><span id="l32.64">   // Show extra options for changing entire list if we have one already.</span>
<a href="#l32.65"></a><span id="l32.65">   gDialog.RadioGroup.collapsed = !gListElement;</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-  if (gListElement)</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-  {</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+  if (gListElement) {</span>
<a href="#l32.69"></a><span id="l32.69">     // Radio button index is persistent</span>
<a href="#l32.70"></a><span id="l32.70">     if (gDialog.RadioGroup.getAttribute(&quot;index&quot;) == &quot;1&quot;)</span>
<a href="#l32.71"></a><span id="l32.71">       gDialog.RadioGroup.selectedItem = gDialog.ChangeSelectedRadio;</span>
<a href="#l32.72"></a><span id="l32.72">     else</span>
<a href="#l32.73"></a><span id="l32.73">       gDialog.RadioGroup.selectedItem = gDialog.ChangeAllRadio;</span>
<a href="#l32.74"></a><span id="l32.74">   }</span>
<a href="#l32.75"></a><span id="l32.75"> </span>
<a href="#l32.76"></a><span id="l32.76">   InitDialog();</span>
<a href="#l32.77"></a><span id="l32.77"> </span>
<a href="#l32.78"></a><span id="l32.78">   gOriginalListType = gListType;</span>
<a href="#l32.79"></a><span id="l32.79"> </span>
<a href="#l32.80"></a><span id="l32.80">   gDialog.ListTypeList.focus();</span>
<a href="#l32.81"></a><span id="l32.81"> </span>
<a href="#l32.82"></a><span id="l32.82">   SetWindowLocation();</span>
<a href="#l32.83"></a><span id="l32.83"> }</span>
<a href="#l32.84"></a><span id="l32.84"> </span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-function InitDialog()</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-{</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+function InitDialog() {</span>
<a href="#l32.88"></a><span id="l32.88">   // Note that if mixed, we we pay attention</span>
<a href="#l32.89"></a><span id="l32.89">   //   only to the anchor node's list type</span>
<a href="#l32.90"></a><span id="l32.90">   // (i.e., don't confuse user with &quot;mixed&quot; designation)</span>
<a href="#l32.91"></a><span id="l32.91">   if (gListElement)</span>
<a href="#l32.92"></a><span id="l32.92">     gListType = gListElement.nodeName.toLowerCase();</span>
<a href="#l32.93"></a><span id="l32.93">   else</span>
<a href="#l32.94"></a><span id="l32.94">     gListType = &quot;&quot;;</span>
<a href="#l32.95"></a><span id="l32.95"> </span>
<a href="#l32.96"></a><span id="l32.96">   gDialog.ListTypeList.value = gListType;</span>
<a href="#l32.97"></a><span id="l32.97">   gDialog.StartingNumberInput.value = &quot;&quot;;</span>
<a href="#l32.98"></a><span id="l32.98"> </span>
<a href="#l32.99"></a><span id="l32.99">   // Last param = true means attribute value is case-sensitive</span>
<a href="#l32.100"></a><span id="l32.100">   var type = globalElement ? GetHTMLOrCSSStyleValue(globalElement, &quot;type&quot;, &quot;list-style-type&quot;) : null;</span>
<a href="#l32.101"></a><span id="l32.101"> </span>
<a href="#l32.102"></a><span id="l32.102">   var index = 0;</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-  if (gListType == &quot;ul&quot;)</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-  {</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-    if (type)</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-    {</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+  if (gListType == &quot;ul&quot;) {</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineplus">+    if (type) {</span>
<a href="#l32.109"></a><span id="l32.109">       type = type.toLowerCase();</span>
<a href="#l32.110"></a><span id="l32.110">       gBulletStyleType = type;</span>
<a href="#l32.111"></a><span id="l32.111">       gOriginalStyleType = type;</span>
<a href="#l32.112"></a><span id="l32.112">     }</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-  }</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-  else if (gListType == &quot;ol&quot;)</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-  {</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+  } else if (gListType == &quot;ol&quot;) {</span>
<a href="#l32.117"></a><span id="l32.117">     // Translate CSS property strings</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineminus">-    switch (type.toLowerCase())</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-    {</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineplus">+    switch (type.toLowerCase()) {</span>
<a href="#l32.121"></a><span id="l32.121">       case gDecimalCSS:</span>
<a href="#l32.122"></a><span id="l32.122">         type = gArabic;</span>
<a href="#l32.123"></a><span id="l32.123">         break;</span>
<a href="#l32.124"></a><span id="l32.124">       case gUpperRomanCSS:</span>
<a href="#l32.125"></a><span id="l32.125">         type = gUpperRoman;</span>
<a href="#l32.126"></a><span id="l32.126">         break;</span>
<a href="#l32.127"></a><span id="l32.127">       case gLowerRomanCSS:</span>
<a href="#l32.128"></a><span id="l32.128">         type = gLowerRoman;</span>
<a href="#l32.129"></a><span id="l32.129">         break;</span>
<a href="#l32.130"></a><span id="l32.130">       case gUpperAlphaCSS:</span>
<a href="#l32.131"></a><span id="l32.131">         type = gUpperLetters;</span>
<a href="#l32.132"></a><span id="l32.132">         break;</span>
<a href="#l32.133"></a><span id="l32.133">       case gLowerAlphaCSS:</span>
<a href="#l32.134"></a><span id="l32.134">         type = gLowerLetters;</span>
<a href="#l32.135"></a><span id="l32.135">         break;</span>
<a href="#l32.136"></a><span id="l32.136">     }</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineminus">-    if (type)</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineminus">-    {</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineplus">+    if (type) {</span>
<a href="#l32.140"></a><span id="l32.140">       gNumberStyleType = type;</span>
<a href="#l32.141"></a><span id="l32.141">       gOriginalStyleType = type;</span>
<a href="#l32.142"></a><span id="l32.142">     }</span>
<a href="#l32.143"></a><span id="l32.143"> </span>
<a href="#l32.144"></a><span id="l32.144">     // Convert attribute number to appropriate letter or roman numeral</span>
<a href="#l32.145"></a><span id="l32.145">     gDialog.StartingNumberInput.value =</span>
<a href="#l32.146"></a><span id="l32.146">       ConvertStartAttrToUserString(globalElement.getAttribute(&quot;start&quot;), type);</span>
<a href="#l32.147"></a><span id="l32.147">   }</span>
<a href="#l32.148"></a><span id="l32.148">   BuildBulletStyleList();</span>
<a href="#l32.149"></a><span id="l32.149"> }</span>
<a href="#l32.150"></a><span id="l32.150"> </span>
<a href="#l32.151"></a><span id="l32.151"> // Convert attribute number to appropriate letter or roman numeral</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineminus">-function ConvertStartAttrToUserString(startAttr, type)</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineminus">-{</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineminus">-  switch (type)</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineminus">-  {</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+function ConvertStartAttrToUserString(startAttr, type) {</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineplus">+  switch (type) {</span>
<a href="#l32.158"></a><span id="l32.158">     case gUpperRoman:</span>
<a href="#l32.159"></a><span id="l32.159">       startAttr = ConvertArabicToRoman(startAttr);</span>
<a href="#l32.160"></a><span id="l32.160">       break;</span>
<a href="#l32.161"></a><span id="l32.161">     case gLowerRoman:</span>
<a href="#l32.162"></a><span id="l32.162">       startAttr = ConvertArabicToRoman(startAttr).toLowerCase();</span>
<a href="#l32.163"></a><span id="l32.163">       break;</span>
<a href="#l32.164"></a><span id="l32.164">     case gUpperLetters:</span>
<a href="#l32.165"></a><span id="l32.165">       startAttr = ConvertArabicToLetters(startAttr);</span>
<a href="#l32.166"></a><span id="l32.166">       break;</span>
<a href="#l32.167"></a><span id="l32.167">     case gLowerLetters:</span>
<a href="#l32.168"></a><span id="l32.168">       startAttr = ConvertArabicToLetters(startAttr).toLowerCase();</span>
<a href="#l32.169"></a><span id="l32.169">       break;</span>
<a href="#l32.170"></a><span id="l32.170">   }</span>
<a href="#l32.171"></a><span id="l32.171">   return startAttr;</span>
<a href="#l32.172"></a><span id="l32.172"> }</span>
<a href="#l32.173"></a><span id="l32.173"> </span>
<a href="#l32.174"></a><span id="l32.174" class="difflineminus">-function BuildBulletStyleList()</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineminus">-{</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineplus">+function BuildBulletStyleList() {</span>
<a href="#l32.177"></a><span id="l32.177">   gDialog.BulletStyleList.removeAllItems();</span>
<a href="#l32.178"></a><span id="l32.178">   var label;</span>
<a href="#l32.179"></a><span id="l32.179"> </span>
<a href="#l32.180"></a><span id="l32.180" class="difflineminus">-  if (gListType == &quot;ul&quot;)</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineminus">-  {</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineplus">+  if (gListType == &quot;ul&quot;) {</span>
<a href="#l32.183"></a><span id="l32.183">     gDialog.BulletStyleList.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l32.184"></a><span id="l32.184">     gDialog.BulletStyleLabel.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l32.185"></a><span id="l32.185">     gDialog.StartingNumberInput.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.186"></a><span id="l32.186">     gDialog.StartingNumberLabel.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.187"></a><span id="l32.187"> </span>
<a href="#l32.188"></a><span id="l32.188">     label = GetString(&quot;BulletStyle&quot;);</span>
<a href="#l32.189"></a><span id="l32.189"> </span>
<a href="#l32.190"></a><span id="l32.190">     gDialog.BulletStyleList.appendItem(GetString(&quot;Automatic&quot;), &quot;&quot;);</span>
<a href="#l32.191"></a><span id="l32.191">     gDialog.BulletStyleList.appendItem(GetString(&quot;SolidCircle&quot;), &quot;disc&quot;);</span>
<a href="#l32.192"></a><span id="l32.192">     gDialog.BulletStyleList.appendItem(GetString(&quot;OpenCircle&quot;), &quot;circle&quot;);</span>
<a href="#l32.193"></a><span id="l32.193">     gDialog.BulletStyleList.appendItem(GetString(&quot;SolidSquare&quot;), &quot;square&quot;);</span>
<a href="#l32.194"></a><span id="l32.194"> </span>
<a href="#l32.195"></a><span id="l32.195">     gDialog.BulletStyleList.value = gBulletStyleType;</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineminus">-  }</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineminus">-  else if (gListType == &quot;ol&quot;)</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineminus">-  {</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineplus">+  } else if (gListType == &quot;ol&quot;) {</span>
<a href="#l32.200"></a><span id="l32.200">     gDialog.BulletStyleList.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l32.201"></a><span id="l32.201">     gDialog.BulletStyleLabel.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l32.202"></a><span id="l32.202">     gDialog.StartingNumberInput.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l32.203"></a><span id="l32.203">     gDialog.StartingNumberLabel.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l32.204"></a><span id="l32.204">     label = GetString(&quot;NumberStyle&quot;);</span>
<a href="#l32.205"></a><span id="l32.205"> </span>
<a href="#l32.206"></a><span id="l32.206">     gDialog.BulletStyleList.appendItem(GetString(&quot;Automatic&quot;), &quot;&quot;);</span>
<a href="#l32.207"></a><span id="l32.207">     gDialog.BulletStyleList.appendItem(GetString(&quot;Style_1&quot;), gArabic);</span>
<a href="#l32.208"></a><span id="l32.208">     gDialog.BulletStyleList.appendItem(GetString(&quot;Style_I&quot;), gUpperRoman);</span>
<a href="#l32.209"></a><span id="l32.209">     gDialog.BulletStyleList.appendItem(GetString(&quot;Style_i&quot;), gLowerRoman);</span>
<a href="#l32.210"></a><span id="l32.210">     gDialog.BulletStyleList.appendItem(GetString(&quot;Style_A&quot;), gUpperLetters);</span>
<a href="#l32.211"></a><span id="l32.211">     gDialog.BulletStyleList.appendItem(GetString(&quot;Style_a&quot;), gLowerLetters);</span>
<a href="#l32.212"></a><span id="l32.212"> </span>
<a href="#l32.213"></a><span id="l32.213">     gDialog.BulletStyleList.value = gNumberStyleType;</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineminus">-  }</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineminus">-  else</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineminus">-  {</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineplus">+  } else {</span>
<a href="#l32.218"></a><span id="l32.218">     gDialog.BulletStyleList.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.219"></a><span id="l32.219">     gDialog.BulletStyleLabel.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.220"></a><span id="l32.220">     gDialog.StartingNumberInput.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.221"></a><span id="l32.221">     gDialog.StartingNumberLabel.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.222"></a><span id="l32.222">   }</span>
<a href="#l32.223"></a><span id="l32.223"> </span>
<a href="#l32.224"></a><span id="l32.224">   // Disable advanced edit button if changing to &quot;normal&quot;</span>
<a href="#l32.225"></a><span id="l32.225">   if (gListType)</span>
<a href="#l32.226"></a><span id="l32.226">     gDialog.AdvancedEditButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l32.227"></a><span id="l32.227">   else</span>
<a href="#l32.228"></a><span id="l32.228">     gDialog.AdvancedEditButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.229"></a><span id="l32.229"> </span>
<a href="#l32.230"></a><span id="l32.230">   if (label)</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineminus">-    gDialog.BulletStyleLabel.setAttribute(&quot;label&quot;,label);</span>
<a href="#l32.232"></a><span id="l32.232" class="difflineplus">+    gDialog.BulletStyleLabel.setAttribute(&quot;label&quot;, label);</span>
<a href="#l32.233"></a><span id="l32.233"> }</span>
<a href="#l32.234"></a><span id="l32.234"> </span>
<a href="#l32.235"></a><span id="l32.235" class="difflineminus">-function SelectListType()</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineminus">-{</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineplus">+function SelectListType() {</span>
<a href="#l32.238"></a><span id="l32.238">   // Each list type is stored in the &quot;value&quot; of each menuitem</span>
<a href="#l32.239"></a><span id="l32.239">   var NewType = gDialog.ListTypeList.value;</span>
<a href="#l32.240"></a><span id="l32.240"> </span>
<a href="#l32.241"></a><span id="l32.241">   if (NewType == &quot;ol&quot;)</span>
<a href="#l32.242"></a><span id="l32.242">     SetTextboxFocus(gDialog.StartingNumberInput);</span>
<a href="#l32.243"></a><span id="l32.243"> </span>
<a href="#l32.244"></a><span id="l32.244" class="difflineminus">-  if (gListType != NewType)</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineminus">-  {</span>
<a href="#l32.246"></a><span id="l32.246" class="difflineplus">+  if (gListType != NewType) {</span>
<a href="#l32.247"></a><span id="l32.247">     gListType = NewType;</span>
<a href="#l32.248"></a><span id="l32.248"> </span>
<a href="#l32.249"></a><span id="l32.249">     // Create a newlist object for Advanced Editing</span>
<a href="#l32.250"></a><span id="l32.250">     try {</span>
<a href="#l32.251"></a><span id="l32.251">       if (gListType)</span>
<a href="#l32.252"></a><span id="l32.252">         globalElement = GetCurrentEditor().createElementWithDefaults(gListType);</span>
<a href="#l32.253"></a><span id="l32.253">     } catch (e) {}</span>
<a href="#l32.254"></a><span id="l32.254"> </span>
<a href="#l32.255"></a><span id="l32.255">     BuildBulletStyleList();</span>
<a href="#l32.256"></a><span id="l32.256">   }</span>
<a href="#l32.257"></a><span id="l32.257"> }</span>
<a href="#l32.258"></a><span id="l32.258"> </span>
<a href="#l32.259"></a><span id="l32.259" class="difflineminus">-function SelectBulletStyle()</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineminus">-{</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineplus">+function SelectBulletStyle() {</span>
<a href="#l32.262"></a><span id="l32.262">   // Save the selected index so when user changes</span>
<a href="#l32.263"></a><span id="l32.263">   //   list style, restore index to associated list</span>
<a href="#l32.264"></a><span id="l32.264">   // Each bullet or number type is stored in the &quot;value&quot; of each menuitem</span>
<a href="#l32.265"></a><span id="l32.265">   if (gListType == &quot;ul&quot;)</span>
<a href="#l32.266"></a><span id="l32.266">     gBulletStyleType = gDialog.BulletStyleList.value;</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineminus">-  else if (gListType == &quot;ol&quot;)</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineminus">-  {</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineplus">+  else if (gListType == &quot;ol&quot;) {</span>
<a href="#l32.270"></a><span id="l32.270">     var type = gDialog.BulletStyleList.value;</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineminus">-    if (gNumberStyleType != type)</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineminus">-    {</span>
<a href="#l32.273"></a><span id="l32.273" class="difflineplus">+    if (gNumberStyleType != type) {</span>
<a href="#l32.274"></a><span id="l32.274">       // Convert existing input value to attr number first,</span>
<a href="#l32.275"></a><span id="l32.275">       //   then convert to the appropriate format for the newly-selected</span>
<a href="#l32.276"></a><span id="l32.276">       gDialog.StartingNumberInput.value =</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineminus">-        ConvertStartAttrToUserString( ConvertUserStringToStartAttr(gNumberStyleType), type);</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineplus">+        ConvertStartAttrToUserString(ConvertUserStringToStartAttr(gNumberStyleType), type);</span>
<a href="#l32.279"></a><span id="l32.279"> </span>
<a href="#l32.280"></a><span id="l32.280">       gNumberStyleType = type;</span>
<a href="#l32.281"></a><span id="l32.281">       SetTextboxFocus(gDialog.StartingNumberInput);</span>
<a href="#l32.282"></a><span id="l32.282">     }</span>
<a href="#l32.283"></a><span id="l32.283">   }</span>
<a href="#l32.284"></a><span id="l32.284"> }</span>
<a href="#l32.285"></a><span id="l32.285"> </span>
<a href="#l32.286"></a><span id="l32.286" class="difflineminus">-function ValidateData()</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineminus">-{</span>
<a href="#l32.288"></a><span id="l32.288" class="difflineplus">+function ValidateData() {</span>
<a href="#l32.289"></a><span id="l32.289">   gBulletStyleType = gDialog.BulletStyleList.value;</span>
<a href="#l32.290"></a><span id="l32.290">   // globalElement should already be of the correct type</span>
<a href="#l32.291"></a><span id="l32.291"> </span>
<a href="#l32.292"></a><span id="l32.292" class="difflineminus">-  if (globalElement)</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineminus">-  {</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineplus">+  if (globalElement) {</span>
<a href="#l32.295"></a><span id="l32.295">     var editor = GetCurrentEditor();</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineminus">-    if (gListType == &quot;ul&quot;)</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineminus">-    {</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineplus">+    if (gListType == &quot;ul&quot;) {</span>
<a href="#l32.299"></a><span id="l32.299">       if (gBulletStyleType &amp;&amp; gDialog.ChangeAllRadio.selected)</span>
<a href="#l32.300"></a><span id="l32.300">         globalElement.setAttribute(&quot;type&quot;, gBulletStyleType);</span>
<a href="#l32.301"></a><span id="l32.301">       else</span>
<a href="#l32.302"></a><span id="l32.302">         try {</span>
<a href="#l32.303"></a><span id="l32.303">           editor.removeAttributeOrEquivalent(globalElement, &quot;type&quot;, true);</span>
<a href="#l32.304"></a><span id="l32.304">         } catch (e) {}</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineminus">-</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineminus">-    }</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineminus">-    else if (gListType == &quot;ol&quot;)</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineminus">-    {</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineplus">+    } else if (gListType == &quot;ol&quot;) {</span>
<a href="#l32.310"></a><span id="l32.310">       if (gBulletStyleType)</span>
<a href="#l32.311"></a><span id="l32.311">         globalElement.setAttribute(&quot;type&quot;, gBulletStyleType);</span>
<a href="#l32.312"></a><span id="l32.312">       else</span>
<a href="#l32.313"></a><span id="l32.313">         try {</span>
<a href="#l32.314"></a><span id="l32.314">           editor.removeAttributeOrEquivalent(globalElement, &quot;type&quot;, true);</span>
<a href="#l32.315"></a><span id="l32.315">         } catch (e) {}</span>
<a href="#l32.316"></a><span id="l32.316"> </span>
<a href="#l32.317"></a><span id="l32.317">       var startingNumber = ConvertUserStringToStartAttr(gBulletStyleType);</span>
<a href="#l32.318"></a><span id="l32.318" class="difflineat">@@ -301,134 +272,117 @@ function ValidateData()</span>
<a href="#l32.319"></a><span id="l32.319">         globalElement.setAttribute(&quot;start&quot;, startingNumber);</span>
<a href="#l32.320"></a><span id="l32.320">       else</span>
<a href="#l32.321"></a><span id="l32.321">         globalElement.removeAttribute(&quot;start&quot;);</span>
<a href="#l32.322"></a><span id="l32.322">     }</span>
<a href="#l32.323"></a><span id="l32.323">   }</span>
<a href="#l32.324"></a><span id="l32.324">   return true;</span>
<a href="#l32.325"></a><span id="l32.325"> }</span>
<a href="#l32.326"></a><span id="l32.326"> </span>
<a href="#l32.327"></a><span id="l32.327" class="difflineminus">-function ConvertUserStringToStartAttr(type)</span>
<a href="#l32.328"></a><span id="l32.328" class="difflineminus">-{</span>
<a href="#l32.329"></a><span id="l32.329" class="difflineplus">+function ConvertUserStringToStartAttr(type) {</span>
<a href="#l32.330"></a><span id="l32.330">   var startingNumber = TrimString(gDialog.StartingNumberInput.value);</span>
<a href="#l32.331"></a><span id="l32.331"> </span>
<a href="#l32.332"></a><span id="l32.332" class="difflineminus">-  switch (type)</span>
<a href="#l32.333"></a><span id="l32.333" class="difflineminus">-  {</span>
<a href="#l32.334"></a><span id="l32.334" class="difflineplus">+  switch (type) {</span>
<a href="#l32.335"></a><span id="l32.335">     case gUpperRoman:</span>
<a href="#l32.336"></a><span id="l32.336">     case gLowerRoman:</span>
<a href="#l32.337"></a><span id="l32.337">       // If the input isn't an integer, assume it's a roman numeral. Convert it.</span>
<a href="#l32.338"></a><span id="l32.338">       if (!Number(startingNumber))</span>
<a href="#l32.339"></a><span id="l32.339">         startingNumber = ConvertRomanToArabic(startingNumber);</span>
<a href="#l32.340"></a><span id="l32.340">       break;</span>
<a href="#l32.341"></a><span id="l32.341">     case gUpperLetters:</span>
<a href="#l32.342"></a><span id="l32.342">     case gLowerLetters:</span>
<a href="#l32.343"></a><span id="l32.343">       // Get the number equivalent of the letters</span>
<a href="#l32.344"></a><span id="l32.344">       if (!Number(startingNumber))</span>
<a href="#l32.345"></a><span id="l32.345">         startingNumber = ConvertLettersToArabic(startingNumber);</span>
<a href="#l32.346"></a><span id="l32.346">       break;</span>
<a href="#l32.347"></a><span id="l32.347">   }</span>
<a href="#l32.348"></a><span id="l32.348">   return startingNumber;</span>
<a href="#l32.349"></a><span id="l32.349"> }</span>
<a href="#l32.350"></a><span id="l32.350"> </span>
<a href="#l32.351"></a><span id="l32.351" class="difflineminus">-function ConvertRomanToArabic(num)</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineminus">-{</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineplus">+function ConvertRomanToArabic(num) {</span>
<a href="#l32.354"></a><span id="l32.354">   num = num.toUpperCase();</span>
<a href="#l32.355"></a><span id="l32.355" class="difflineminus">-  if (num &amp;&amp; !/[^MDCLXVI]/i.test(num))</span>
<a href="#l32.356"></a><span id="l32.356" class="difflineminus">-  {</span>
<a href="#l32.357"></a><span id="l32.357" class="difflineplus">+  if (num &amp;&amp; !/[^MDCLXVI]/i.test(num)) {</span>
<a href="#l32.358"></a><span id="l32.358">     var Arabic = 0;</span>
<a href="#l32.359"></a><span id="l32.359">     var last_digit = 1000;</span>
<a href="#l32.360"></a><span id="l32.360" class="difflineminus">-    for (var i=0; i &lt; num.length; i++)</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineminus">-    {</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineplus">+    for (var i = 0; i &lt; num.length; i++) {</span>
<a href="#l32.363"></a><span id="l32.363">       var digit = gRomanDigits[num.charAt(i)];</span>
<a href="#l32.364"></a><span id="l32.364">       if (last_digit &lt; digit)</span>
<a href="#l32.365"></a><span id="l32.365">         Arabic -= 2 * last_digit;</span>
<a href="#l32.366"></a><span id="l32.366"> </span>
<a href="#l32.367"></a><span id="l32.367">       last_digit = digit;</span>
<a href="#l32.368"></a><span id="l32.368">       Arabic += last_digit;</span>
<a href="#l32.369"></a><span id="l32.369">     }</span>
<a href="#l32.370"></a><span id="l32.370">     return Arabic;</span>
<a href="#l32.371"></a><span id="l32.371">   }</span>
<a href="#l32.372"></a><span id="l32.372"> </span>
<a href="#l32.373"></a><span id="l32.373">   return &quot;&quot;;</span>
<a href="#l32.374"></a><span id="l32.374"> }</span>
<a href="#l32.375"></a><span id="l32.375"> </span>
<a href="#l32.376"></a><span id="l32.376" class="difflineminus">-function ConvertArabicToRoman(num)</span>
<a href="#l32.377"></a><span id="l32.377" class="difflineminus">-{</span>
<a href="#l32.378"></a><span id="l32.378" class="difflineminus">-  if (/^\d{1,4}$/.test(num))</span>
<a href="#l32.379"></a><span id="l32.379" class="difflineminus">-  {</span>
<a href="#l32.380"></a><span id="l32.380" class="difflineplus">+function ConvertArabicToRoman(num) {</span>
<a href="#l32.381"></a><span id="l32.381" class="difflineplus">+  if (/^\d{1,4}$/.test(num)) {</span>
<a href="#l32.382"></a><span id="l32.382">     var digits = (&quot;000&quot; + num).substr(-4);</span>
<a href="#l32.383"></a><span id="l32.383">     return gThousandsArray[digits.charAt(0)] +</span>
<a href="#l32.384"></a><span id="l32.384">            gHundredsArray[digits.charAt(1)] +</span>
<a href="#l32.385"></a><span id="l32.385">            gTensArray[digits.charAt(2)] +</span>
<a href="#l32.386"></a><span id="l32.386">            gOnesArray[digits.charAt(3)];</span>
<a href="#l32.387"></a><span id="l32.387">   }</span>
<a href="#l32.388"></a><span id="l32.388">   return &quot;&quot;;</span>
<a href="#l32.389"></a><span id="l32.389"> }</span>
<a href="#l32.390"></a><span id="l32.390"> </span>
<a href="#l32.391"></a><span id="l32.391" class="difflineminus">-function ConvertLettersToArabic(letters)</span>
<a href="#l32.392"></a><span id="l32.392" class="difflineminus">-{</span>
<a href="#l32.393"></a><span id="l32.393" class="difflineplus">+function ConvertLettersToArabic(letters) {</span>
<a href="#l32.394"></a><span id="l32.394">   letters = letters.toUpperCase();</span>
<a href="#l32.395"></a><span id="l32.395">   if (!letters || /[^A-Z]/.test(letters))</span>
<a href="#l32.396"></a><span id="l32.396">     return &quot;&quot;;</span>
<a href="#l32.397"></a><span id="l32.397"> </span>
<a href="#l32.398"></a><span id="l32.398">   var num = 0;</span>
<a href="#l32.399"></a><span id="l32.399">   for (var i = 0; i &lt; letters.length; i++)</span>
<a href="#l32.400"></a><span id="l32.400">     num = num * 26 + letters.charCodeAt(i) - A + 1;</span>
<a href="#l32.401"></a><span id="l32.401">   return num;</span>
<a href="#l32.402"></a><span id="l32.402"> }</span>
<a href="#l32.403"></a><span id="l32.403"> </span>
<a href="#l32.404"></a><span id="l32.404" class="difflineminus">-function ConvertArabicToLetters(num)</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineminus">-{</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineplus">+function ConvertArabicToLetters(num) {</span>
<a href="#l32.407"></a><span id="l32.407">   var letters = &quot;&quot;;</span>
<a href="#l32.408"></a><span id="l32.408">   while (num) {</span>
<a href="#l32.409"></a><span id="l32.409">     num--;</span>
<a href="#l32.410"></a><span id="l32.410">     letters = String.fromCharCode(A + (num % 26)) + letters;</span>
<a href="#l32.411"></a><span id="l32.411">     num = Math.floor(num / 26);</span>
<a href="#l32.412"></a><span id="l32.412">   }</span>
<a href="#l32.413"></a><span id="l32.413">   return letters;</span>
<a href="#l32.414"></a><span id="l32.414"> }</span>
<a href="#l32.415"></a><span id="l32.415"> </span>
<a href="#l32.416"></a><span id="l32.416" class="difflineminus">-function onAccept(event)</span>
<a href="#l32.417"></a><span id="l32.417" class="difflineminus">-{</span>
<a href="#l32.418"></a><span id="l32.418" class="difflineminus">-  if (ValidateData())</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineminus">-  {</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineplus">+function onAccept(event) {</span>
<a href="#l32.421"></a><span id="l32.421" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l32.422"></a><span id="l32.422">     // Coalesce into one undo transaction</span>
<a href="#l32.423"></a><span id="l32.423">     var editor = GetCurrentEditor();</span>
<a href="#l32.424"></a><span id="l32.424"> </span>
<a href="#l32.425"></a><span id="l32.425">     editor.beginTransaction();</span>
<a href="#l32.426"></a><span id="l32.426"> </span>
<a href="#l32.427"></a><span id="l32.427">     var changeEntireList = gDialog.RadioGroup.selectedItem == gDialog.ChangeAllRadio;</span>
<a href="#l32.428"></a><span id="l32.428"> </span>
<a href="#l32.429"></a><span id="l32.429">     // Remember which radio button was selected</span>
<a href="#l32.430"></a><span id="l32.430">     if (gListElement)</span>
<a href="#l32.431"></a><span id="l32.431">       gDialog.RadioGroup.setAttribute(&quot;index&quot;, changeEntireList ? &quot;0&quot; : &quot;1&quot;);</span>
<a href="#l32.432"></a><span id="l32.432"> </span>
<a href="#l32.433"></a><span id="l32.433">     var changeList;</span>
<a href="#l32.434"></a><span id="l32.434" class="difflineminus">-    if (gListElement &amp;&amp; gDialog.ChangeAllRadio.selected)</span>
<a href="#l32.435"></a><span id="l32.435" class="difflineminus">-    {</span>
<a href="#l32.436"></a><span id="l32.436" class="difflineplus">+    if (gListElement &amp;&amp; gDialog.ChangeAllRadio.selected) {</span>
<a href="#l32.437"></a><span id="l32.437">       changeList = true;</span>
<a href="#l32.438"></a><span id="l32.438" class="difflineminus">-    }</span>
<a href="#l32.439"></a><span id="l32.439" class="difflineminus">-    else</span>
<a href="#l32.440"></a><span id="l32.440" class="difflineplus">+    } else</span>
<a href="#l32.441"></a><span id="l32.441">       changeList = gMixedListSelection || gListType != gOriginalListType ||</span>
<a href="#l32.442"></a><span id="l32.442">                    gBulletStyleType != gOriginalStyleType;</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineminus">-    if (changeList)</span>
<a href="#l32.444"></a><span id="l32.444" class="difflineminus">-    {</span>
<a href="#l32.445"></a><span id="l32.445" class="difflineplus">+    if (changeList) {</span>
<a href="#l32.446"></a><span id="l32.446">       try {</span>
<a href="#l32.447"></a><span id="l32.447" class="difflineminus">-        if (gListType)</span>
<a href="#l32.448"></a><span id="l32.448" class="difflineminus">-        {</span>
<a href="#l32.449"></a><span id="l32.449" class="difflineplus">+        if (gListType) {</span>
<a href="#l32.450"></a><span id="l32.450">           editor.makeOrChangeList(gListType, changeEntireList,</span>
<a href="#l32.451"></a><span id="l32.451">                      (gBulletStyleType != gOriginalStyleType) ? gBulletStyleType : null);</span>
<a href="#l32.452"></a><span id="l32.452"> </span>
<a href="#l32.453"></a><span id="l32.453">           // Get the new list created:</span>
<a href="#l32.454"></a><span id="l32.454">           gListElement = editor.getElementOrParentByTagName(gListType, null);</span>
<a href="#l32.455"></a><span id="l32.455"> </span>
<a href="#l32.456"></a><span id="l32.456">           editor.cloneAttributes(gListElement, globalElement);</span>
<a href="#l32.457"></a><span id="l32.457" class="difflineminus">-        }</span>
<a href="#l32.458"></a><span id="l32.458" class="difflineminus">-        else</span>
<a href="#l32.459"></a><span id="l32.459" class="difflineminus">-        {</span>
<a href="#l32.460"></a><span id="l32.460" class="difflineplus">+        } else {</span>
<a href="#l32.461"></a><span id="l32.461">           // Remove all existing lists</span>
<a href="#l32.462"></a><span id="l32.462">           if (gListElement &amp;&amp; changeEntireList)</span>
<a href="#l32.463"></a><span id="l32.463">             editor.selectElement(gListElement);</span>
<a href="#l32.464"></a><span id="l32.464"> </span>
<a href="#l32.465"></a><span id="l32.465">           editor.removeList(&quot;ol&quot;);</span>
<a href="#l32.466"></a><span id="l32.466">           editor.removeList(&quot;ul&quot;);</span>
<a href="#l32.467"></a><span id="l32.467">           editor.removeList(&quot;dl&quot;);</span>
<a href="#l32.468"></a><span id="l32.468">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdNamedAnchorProps.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdNamedAnchorProps.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -7,21 +7,19 @@ var gAnchorElement = null;</span>
<a href="#l33.4"></a><span id="l33.4"> var gOriginalName = &quot;&quot;;</span>
<a href="#l33.5"></a><span id="l33.5"> const kTagName = &quot;anchor&quot;;</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> // dialog initialization code</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l33.10"></a><span id="l33.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-function Startup()</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-{</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+function Startup() {</span>
<a href="#l33.15"></a><span id="l33.15">   var editor = GetCurrentEditor();</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-  if (!editor)</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-  {</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l33.19"></a><span id="l33.19">     window.close();</span>
<a href="#l33.20"></a><span id="l33.20">     return;</span>
<a href="#l33.21"></a><span id="l33.21">   }</span>
<a href="#l33.22"></a><span id="l33.22"> </span>
<a href="#l33.23"></a><span id="l33.23">   gDialog.OkButton  = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l33.24"></a><span id="l33.24">   gDialog.NameInput = document.getElementById(&quot;nameInput&quot;);</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26">   // Get a single selected element of the desired type</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineat">@@ -40,128 +38,114 @@ function Startup()</span>
<a href="#l33.28"></a><span id="l33.28">     //  so create one with default attributes</span>
<a href="#l33.29"></a><span id="l33.29">     gAnchorElement = editor.createElementWithDefaults(kTagName);</span>
<a href="#l33.30"></a><span id="l33.30">     if (gAnchorElement) {</span>
<a href="#l33.31"></a><span id="l33.31">       // Use the current selection as suggested name</span>
<a href="#l33.32"></a><span id="l33.32">       var name = GetSelectionAsText();</span>
<a href="#l33.33"></a><span id="l33.33">       // Get 40 characters of the selected text and don't add &quot;...&quot;,</span>
<a href="#l33.34"></a><span id="l33.34">       //  replace whitespace with &quot;_&quot; and strip non-word characters</span>
<a href="#l33.35"></a><span id="l33.35">       name = ConvertToCDATAString(TruncateStringAtWordEnd(name, 40, false));</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-      //Be sure the name is unique to the document</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+      // Be sure the name is unique to the document</span>
<a href="#l33.38"></a><span id="l33.38">       if (AnchorNameExists(name))</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-        name += &quot;_&quot;</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+        name += &quot;_&quot;;</span>
<a href="#l33.41"></a><span id="l33.41"> </span>
<a href="#l33.42"></a><span id="l33.42">       // Make a copy to use for AdvancedEdit</span>
<a href="#l33.43"></a><span id="l33.43">       globalElement = gAnchorElement.cloneNode(false);</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineminus">-      globalElement.setAttribute(&quot;name&quot;,name);</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+      globalElement.setAttribute(&quot;name&quot;, name);</span>
<a href="#l33.46"></a><span id="l33.46">     }</span>
<a href="#l33.47"></a><span id="l33.47">   }</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-  if(!gAnchorElement)</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-  {</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+  if (!gAnchorElement) {</span>
<a href="#l33.51"></a><span id="l33.51">     dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l33.52"></a><span id="l33.52">     window.close();</span>
<a href="#l33.53"></a><span id="l33.53">     return;</span>
<a href="#l33.54"></a><span id="l33.54">   }</span>
<a href="#l33.55"></a><span id="l33.55"> </span>
<a href="#l33.56"></a><span id="l33.56">   InitDialog();</span>
<a href="#l33.57"></a><span id="l33.57"> </span>
<a href="#l33.58"></a><span id="l33.58">   DoEnabling();</span>
<a href="#l33.59"></a><span id="l33.59">   SetTextboxFocus(gDialog.NameInput);</span>
<a href="#l33.60"></a><span id="l33.60">   SetWindowLocation();</span>
<a href="#l33.61"></a><span id="l33.61"> }</span>
<a href="#l33.62"></a><span id="l33.62"> </span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-function InitDialog()</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-{</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+function InitDialog() {</span>
<a href="#l33.66"></a><span id="l33.66">   gDialog.NameInput.value = globalElement.getAttribute(&quot;name&quot;);</span>
<a href="#l33.67"></a><span id="l33.67"> }</span>
<a href="#l33.68"></a><span id="l33.68"> </span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-function ChangeName()</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-{</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-  if (gDialog.NameInput.value.length &gt; 0)</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineminus">-  {</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+function ChangeName() {</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+  if (gDialog.NameInput.value.length &gt; 0) {</span>
<a href="#l33.75"></a><span id="l33.75">     // Replace spaces with &quot;_&quot; and strip other non-URL characters</span>
<a href="#l33.76"></a><span id="l33.76">     // Note: we could use ConvertAndEscape, but then we'd</span>
<a href="#l33.77"></a><span id="l33.77">     //  have to UnEscapeAndConvert beforehand - too messy!</span>
<a href="#l33.78"></a><span id="l33.78">     gDialog.NameInput.value = ConvertToCDATAString(gDialog.NameInput.value);</span>
<a href="#l33.79"></a><span id="l33.79">   }</span>
<a href="#l33.80"></a><span id="l33.80">   DoEnabling();</span>
<a href="#l33.81"></a><span id="l33.81"> }</span>
<a href="#l33.82"></a><span id="l33.82"> </span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-function DoEnabling()</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-{</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+function DoEnabling() {</span>
<a href="#l33.86"></a><span id="l33.86">   var enable = gDialog.NameInput.value.length &gt; 0;</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-  SetElementEnabled(gDialog.OkButton,  enable);</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+  SetElementEnabled(gDialog.OkButton, enable);</span>
<a href="#l33.89"></a><span id="l33.89">   SetElementEnabledById(&quot;AdvancedEditButton1&quot;, enable);</span>
<a href="#l33.90"></a><span id="l33.90"> }</span>
<a href="#l33.91"></a><span id="l33.91"> </span>
<a href="#l33.92"></a><span id="l33.92" class="difflineminus">-function AnchorNameExists(name)</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-{</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+function AnchorNameExists(name) {</span>
<a href="#l33.95"></a><span id="l33.95">   var anchorList;</span>
<a href="#l33.96"></a><span id="l33.96">   try {</span>
<a href="#l33.97"></a><span id="l33.97">     anchorList = GetCurrentEditor().document.anchors;</span>
<a href="#l33.98"></a><span id="l33.98">   } catch (e) {}</span>
<a href="#l33.99"></a><span id="l33.99"> </span>
<a href="#l33.100"></a><span id="l33.100">   if (anchorList) {</span>
<a href="#l33.101"></a><span id="l33.101">     for (var i = 0; i &lt; anchorList.length; i++) {</span>
<a href="#l33.102"></a><span id="l33.102">       if (anchorList[i].name == name)</span>
<a href="#l33.103"></a><span id="l33.103">         return true;</span>
<a href="#l33.104"></a><span id="l33.104">     }</span>
<a href="#l33.105"></a><span id="l33.105">   }</span>
<a href="#l33.106"></a><span id="l33.106">   return false;</span>
<a href="#l33.107"></a><span id="l33.107"> }</span>
<a href="#l33.108"></a><span id="l33.108"> </span>
<a href="#l33.109"></a><span id="l33.109"> // Get and validate data from widgets.</span>
<a href="#l33.110"></a><span id="l33.110"> // Set attributes on globalElement so they can be accessed by AdvancedEdit()</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineminus">-function ValidateData()</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineminus">-{</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+function ValidateData() {</span>
<a href="#l33.114"></a><span id="l33.114">   var name = TrimString(gDialog.NameInput.value);</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineminus">-  if (!name)</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineminus">-  {</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+  if (!name) {</span>
<a href="#l33.118"></a><span id="l33.118">       ShowInputErrorMessage(GetString(&quot;MissingAnchorNameError&quot;));</span>
<a href="#l33.119"></a><span id="l33.119">       SetTextboxFocus(gDialog.NameInput);</span>
<a href="#l33.120"></a><span id="l33.120">       return false;</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-  } else {</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+  }</span>
<a href="#l33.123"></a><span id="l33.123">     // Replace spaces with &quot;_&quot; and strip other characters</span>
<a href="#l33.124"></a><span id="l33.124">     // Note: we could use ConvertAndEscape, but then we'd</span>
<a href="#l33.125"></a><span id="l33.125">     //  have to UnConverAndEscape beforehand - too messy!</span>
<a href="#l33.126"></a><span id="l33.126">     name = ConvertToCDATAString(name);</span>
<a href="#l33.127"></a><span id="l33.127"> </span>
<a href="#l33.128"></a><span id="l33.128" class="difflineminus">-    if (gOriginalName != name &amp;&amp; AnchorNameExists(name))</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineminus">-    {</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineminus">-      ShowInputErrorMessage(GetString(&quot;DuplicateAnchorNameError&quot;).replace(/%name%/,name));</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+    if (gOriginalName != name &amp;&amp; AnchorNameExists(name)) {</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+      ShowInputErrorMessage(GetString(&quot;DuplicateAnchorNameError&quot;).replace(/%name%/, name));</span>
<a href="#l33.133"></a><span id="l33.133">       SetTextboxFocus(gDialog.NameInput);</span>
<a href="#l33.134"></a><span id="l33.134">       return false;</span>
<a href="#l33.135"></a><span id="l33.135">     }</span>
<a href="#l33.136"></a><span id="l33.136">     globalElement.name = name;</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineminus">-  }</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+</span>
<a href="#l33.139"></a><span id="l33.139">   return true;</span>
<a href="#l33.140"></a><span id="l33.140"> }</span>
<a href="#l33.141"></a><span id="l33.141"> </span>
<a href="#l33.142"></a><span id="l33.142" class="difflineminus">-function onAccept(event)</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineminus">-{</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineminus">-  if (ValidateData())</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineminus">-  {</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineminus">-    if (gOriginalName != globalElement.name)</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineminus">-    {</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+function onAccept(event) {</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+    if (gOriginalName != globalElement.name) {</span>
<a href="#l33.151"></a><span id="l33.151">       var editor = GetCurrentEditor();</span>
<a href="#l33.152"></a><span id="l33.152">       editor.beginTransaction();</span>
<a href="#l33.153"></a><span id="l33.153"> </span>
<a href="#l33.154"></a><span id="l33.154">       try {</span>
<a href="#l33.155"></a><span id="l33.155">         // &quot;false&quot; = don't delete selected text when inserting</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineminus">-        if (gInsertNew)</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineminus">-        {</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineplus">+        if (gInsertNew) {</span>
<a href="#l33.159"></a><span id="l33.159">           // We must insert element before copying CSS style attribute,</span>
<a href="#l33.160"></a><span id="l33.160">           //  but we must set the name else it won't insert at all</span>
<a href="#l33.161"></a><span id="l33.161">           gAnchorElement.name = globalElement.name;</span>
<a href="#l33.162"></a><span id="l33.162">           editor.insertElementAtSelection(gAnchorElement, false);</span>
<a href="#l33.163"></a><span id="l33.163">         }</span>
<a href="#l33.164"></a><span id="l33.164"> </span>
<a href="#l33.165"></a><span id="l33.165">         // Copy attributes to element we are changing or inserting</span>
<a href="#l33.166"></a><span id="l33.166">         editor.cloneAttributes(gAnchorElement, globalElement);</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineminus">-</span>
<a href="#l33.168"></a><span id="l33.168">       } catch (e) {}</span>
<a href="#l33.169"></a><span id="l33.169"> </span>
<a href="#l33.170"></a><span id="l33.170">       editor.endTransaction();</span>
<a href="#l33.171"></a><span id="l33.171">     }</span>
<a href="#l33.172"></a><span id="l33.172">     SaveWindowLocation();</span>
<a href="#l33.173"></a><span id="l33.173">     return;</span>
<a href="#l33.174"></a><span id="l33.174">   }</span>
<a href="#l33.175"></a><span id="l33.175">   event.preventDefault();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdPageProps.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdPageProps.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -8,140 +8,126 @@ var gDescription = &quot;&quot;;</span>
<a href="#l34.4"></a><span id="l34.4"> var gAuthorElement;</span>
<a href="#l34.5"></a><span id="l34.5"> var gDescriptionElement;</span>
<a href="#l34.6"></a><span id="l34.6"> var gInsertNewAuthor = false;</span>
<a href="#l34.7"></a><span id="l34.7"> var gInsertNewDescription = false;</span>
<a href="#l34.8"></a><span id="l34.8"> var gTitleWasEdited = false;</span>
<a href="#l34.9"></a><span id="l34.9"> var gAuthorWasEdited = false;</span>
<a href="#l34.10"></a><span id="l34.10"> var gDescWasEdited = false;</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-//Cancel() is in EdDialogCommon.js</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+// Cancel() is in EdDialogCommon.js</span>
<a href="#l34.14"></a><span id="l34.14"> // dialog initialization code</span>
<a href="#l34.15"></a><span id="l34.15"> </span>
<a href="#l34.16"></a><span id="l34.16"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l34.17"></a><span id="l34.17"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-function Startup()</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-{</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+function Startup() {</span>
<a href="#l34.22"></a><span id="l34.22">   var editor = GetCurrentEditor();</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-  if (!editor)</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-  {</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+  if (!editor) {</span>
<a href="#l34.26"></a><span id="l34.26">     window.close();</span>
<a href="#l34.27"></a><span id="l34.27">     return;</span>
<a href="#l34.28"></a><span id="l34.28">   }</span>
<a href="#l34.29"></a><span id="l34.29"> </span>
<a href="#l34.30"></a><span id="l34.30">   gDialog.PageLocation     = document.getElementById(&quot;PageLocation&quot;);</span>
<a href="#l34.31"></a><span id="l34.31">   gDialog.PageModDate      = document.getElementById(&quot;PageModDate&quot;);</span>
<a href="#l34.32"></a><span id="l34.32">   gDialog.TitleInput       = document.getElementById(&quot;TitleInput&quot;);</span>
<a href="#l34.33"></a><span id="l34.33">   gDialog.AuthorInput      = document.getElementById(&quot;AuthorInput&quot;);</span>
<a href="#l34.34"></a><span id="l34.34">   gDialog.DescriptionInput = document.getElementById(&quot;DescriptionInput&quot;);</span>
<a href="#l34.35"></a><span id="l34.35"> </span>
<a href="#l34.36"></a><span id="l34.36">   // Default string for new page is set from DTD string in XUL,</span>
<a href="#l34.37"></a><span id="l34.37">   //   so set only if not new doc URL</span>
<a href="#l34.38"></a><span id="l34.38">   var location = GetDocumentUrl();</span>
<a href="#l34.39"></a><span id="l34.39">   var lastmodString = GetString(&quot;Unknown&quot;);</span>
<a href="#l34.40"></a><span id="l34.40"> </span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-  if (!IsUrlAboutBlank(location))</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-  {</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+  if (!IsUrlAboutBlank(location)) {</span>
<a href="#l34.44"></a><span id="l34.44">     // NEVER show username and password in clear text</span>
<a href="#l34.45"></a><span id="l34.45">     gDialog.PageLocation.setAttribute(&quot;value&quot;, StripPassword(location));</span>
<a href="#l34.46"></a><span id="l34.46"> </span>
<a href="#l34.47"></a><span id="l34.47">     // Get last-modified file date+time</span>
<a href="#l34.48"></a><span id="l34.48">     // TODO: Convert this to local time?</span>
<a href="#l34.49"></a><span id="l34.49">     var lastmod;</span>
<a href="#l34.50"></a><span id="l34.50">     try {</span>
<a href="#l34.51"></a><span id="l34.51">       lastmod = editor.document.lastModified;  // get string of last modified date</span>
<a href="#l34.52"></a><span id="l34.52">     } catch (e) {}</span>
<a href="#l34.53"></a><span id="l34.53">     // Convert modified string to date (0 = unknown date or January 1, 1970 GMT)</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-    if(Date.parse(lastmod))</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-    {</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+    if (Date.parse(lastmod)) {</span>
<a href="#l34.57"></a><span id="l34.57">       try {</span>
<a href="#l34.58"></a><span id="l34.58">         const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-          dateStyle: &quot;long&quot;, timeStyle: &quot;short&quot;</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+          dateStyle: &quot;long&quot;, timeStyle: &quot;short&quot;,</span>
<a href="#l34.61"></a><span id="l34.61">         });</span>
<a href="#l34.62"></a><span id="l34.62"> </span>
<a href="#l34.63"></a><span id="l34.63">         var lastModDate = new Date();</span>
<a href="#l34.64"></a><span id="l34.64">         lastModDate.setTime(Date.parse(lastmod));</span>
<a href="#l34.65"></a><span id="l34.65">         lastmodString = dateTimeFormatter.format(lastModDate);</span>
<a href="#l34.66"></a><span id="l34.66">       } catch (e) {}</span>
<a href="#l34.67"></a><span id="l34.67">     }</span>
<a href="#l34.68"></a><span id="l34.68">   }</span>
<a href="#l34.69"></a><span id="l34.69">   gDialog.PageModDate.value = lastmodString;</span>
<a href="#l34.70"></a><span id="l34.70"> </span>
<a href="#l34.71"></a><span id="l34.71">   gAuthorElement = GetMetaElementByAttribute(&quot;name&quot;, &quot;author&quot;);</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-  if (!gAuthorElement)</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-  {</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+  if (!gAuthorElement) {</span>
<a href="#l34.75"></a><span id="l34.75">     gAuthorElement = CreateMetaElementWithAttribute(&quot;name&quot;, &quot;author&quot;);</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-    if (!gAuthorElement)</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-    {</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+    if (!gAuthorElement) {</span>
<a href="#l34.79"></a><span id="l34.79">       window.close();</span>
<a href="#l34.80"></a><span id="l34.80">       return;</span>
<a href="#l34.81"></a><span id="l34.81">     }</span>
<a href="#l34.82"></a><span id="l34.82">     gInsertNewAuthor = true;</span>
<a href="#l34.83"></a><span id="l34.83">   }</span>
<a href="#l34.84"></a><span id="l34.84"> </span>
<a href="#l34.85"></a><span id="l34.85">   gDescriptionElement = GetMetaElementByAttribute(&quot;name&quot;, &quot;description&quot;);</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-  if (!gDescriptionElement)</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-  {</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+  if (!gDescriptionElement) {</span>
<a href="#l34.89"></a><span id="l34.89">     gDescriptionElement = CreateMetaElementWithAttribute(&quot;name&quot;, &quot;description&quot;);</span>
<a href="#l34.90"></a><span id="l34.90">     if (!gDescriptionElement)</span>
<a href="#l34.91"></a><span id="l34.91">       window.close();</span>
<a href="#l34.92"></a><span id="l34.92"> </span>
<a href="#l34.93"></a><span id="l34.93">     gInsertNewDescription = true;</span>
<a href="#l34.94"></a><span id="l34.94">   }</span>
<a href="#l34.95"></a><span id="l34.95"> </span>
<a href="#l34.96"></a><span id="l34.96">   InitDialog();</span>
<a href="#l34.97"></a><span id="l34.97"> </span>
<a href="#l34.98"></a><span id="l34.98">   SetTextboxFocus(gDialog.TitleInput);</span>
<a href="#l34.99"></a><span id="l34.99"> </span>
<a href="#l34.100"></a><span id="l34.100">   SetWindowLocation();</span>
<a href="#l34.101"></a><span id="l34.101"> }</span>
<a href="#l34.102"></a><span id="l34.102"> </span>
<a href="#l34.103"></a><span id="l34.103" class="difflineminus">-function InitDialog()</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineminus">-{</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+function InitDialog() {</span>
<a href="#l34.106"></a><span id="l34.106">   gDialog.TitleInput.value = GetDocumentTitle();</span>
<a href="#l34.107"></a><span id="l34.107"> </span>
<a href="#l34.108"></a><span id="l34.108">   var gAuthor = TrimString(gAuthorElement.getAttribute(&quot;content&quot;));</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineminus">-  if (!gAuthor)</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-  {</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+  if (!gAuthor) {</span>
<a href="#l34.112"></a><span id="l34.112">     // Fill in with value from editor prefs</span>
<a href="#l34.113"></a><span id="l34.113">     gAuthor = Services.prefs.getCharPref(&quot;editor.author&quot;);</span>
<a href="#l34.114"></a><span id="l34.114">   }</span>
<a href="#l34.115"></a><span id="l34.115">   gDialog.AuthorInput.value = gAuthor;</span>
<a href="#l34.116"></a><span id="l34.116">   gDialog.DescriptionInput.value = gDescriptionElement.getAttribute(&quot;content&quot;);</span>
<a href="#l34.117"></a><span id="l34.117"> }</span>
<a href="#l34.118"></a><span id="l34.118"> </span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-function TextboxChanged(ID)</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineminus">-{</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-  switch(ID)</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineminus">-  {</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineplus">+function TextboxChanged(ID) {</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineplus">+  switch (ID) {</span>
<a href="#l34.125"></a><span id="l34.125">     case &quot;TitleInput&quot;:</span>
<a href="#l34.126"></a><span id="l34.126">       gTitleWasEdited = true;</span>
<a href="#l34.127"></a><span id="l34.127">       break;</span>
<a href="#l34.128"></a><span id="l34.128">     case &quot;AuthorInput&quot;:</span>
<a href="#l34.129"></a><span id="l34.129">       gAuthorWasEdited = true;</span>
<a href="#l34.130"></a><span id="l34.130">       break;</span>
<a href="#l34.131"></a><span id="l34.131">     case &quot;DescriptionInput&quot;:</span>
<a href="#l34.132"></a><span id="l34.132">       gDescWasEdited = true;</span>
<a href="#l34.133"></a><span id="l34.133">       break;</span>
<a href="#l34.134"></a><span id="l34.134">   }</span>
<a href="#l34.135"></a><span id="l34.135"> }</span>
<a href="#l34.136"></a><span id="l34.136"> </span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-function ValidateData()</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">-{</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineplus">+function ValidateData() {</span>
<a href="#l34.140"></a><span id="l34.140">   gNewTitle = TrimString(gDialog.TitleInput.value);</span>
<a href="#l34.141"></a><span id="l34.141">   gAuthor = TrimString(gDialog.AuthorInput.value);</span>
<a href="#l34.142"></a><span id="l34.142">   gDescription = TrimString(gDialog.DescriptionInput.value);</span>
<a href="#l34.143"></a><span id="l34.143">   return true;</span>
<a href="#l34.144"></a><span id="l34.144"> }</span>
<a href="#l34.145"></a><span id="l34.145"> </span>
<a href="#l34.146"></a><span id="l34.146" class="difflineminus">-function onAccept(event)</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineminus">-{</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineminus">-  if (ValidateData())</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-  {</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineplus">+function onAccept(event) {</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l34.152"></a><span id="l34.152">     var editor = GetCurrentEditor();</span>
<a href="#l34.153"></a><span id="l34.153">     editor.beginTransaction();</span>
<a href="#l34.154"></a><span id="l34.154"> </span>
<a href="#l34.155"></a><span id="l34.155">     // Set title contents even if string is empty</span>
<a href="#l34.156"></a><span id="l34.156">     //  because TITLE is a required HTML element</span>
<a href="#l34.157"></a><span id="l34.157">     if (gTitleWasEdited)</span>
<a href="#l34.158"></a><span id="l34.158">       SetDocumentTitle(gNewTitle);</span>
<a href="#l34.159"></a><span id="l34.159"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdReplace.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdReplace.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -9,33 +9,31 @@ var gFindInst;           // nsIWebBrowse</span>
<a href="#l35.4"></a><span id="l35.4"> var gFindService;        // Global service which remembers find params</span>
<a href="#l35.5"></a><span id="l35.5"> var gEditor;             // the editor we're using</span>
<a href="#l35.6"></a><span id="l35.6"> </span>
<a href="#l35.7"></a><span id="l35.7"> document.addEventListener(&quot;dialogaccept&quot;, (event) =&gt; {</span>
<a href="#l35.8"></a><span id="l35.8">   onFindNext();</span>
<a href="#l35.9"></a><span id="l35.9">   event.preventDefault();</span>
<a href="#l35.10"></a><span id="l35.10"> });</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-function initDialogObject()</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-{</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+function initDialogObject() {</span>
<a href="#l35.15"></a><span id="l35.15">   // Create gReplaceDialog object and initialize.</span>
<a href="#l35.16"></a><span id="l35.16">   gReplaceDialog = {};</span>
<a href="#l35.17"></a><span id="l35.17">   gReplaceDialog.findInput       = document.getElementById(&quot;dialog.findInput&quot;);</span>
<a href="#l35.18"></a><span id="l35.18">   gReplaceDialog.replaceInput    = document.getElementById(&quot;dialog.replaceInput&quot;);</span>
<a href="#l35.19"></a><span id="l35.19">   gReplaceDialog.caseSensitive   = document.getElementById(&quot;dialog.caseSensitive&quot;);</span>
<a href="#l35.20"></a><span id="l35.20">   gReplaceDialog.wrap            = document.getElementById(&quot;dialog.wrap&quot;);</span>
<a href="#l35.21"></a><span id="l35.21">   gReplaceDialog.searchBackwards = document.getElementById(&quot;dialog.searchBackwards&quot;);</span>
<a href="#l35.22"></a><span id="l35.22">   gReplaceDialog.findNext        = document.getElementById(&quot;findNext&quot;);</span>
<a href="#l35.23"></a><span id="l35.23">   gReplaceDialog.replace         = document.getElementById(&quot;replace&quot;);</span>
<a href="#l35.24"></a><span id="l35.24">   gReplaceDialog.replaceAndFind  = document.getElementById(&quot;replaceAndFind&quot;);</span>
<a href="#l35.25"></a><span id="l35.25">   gReplaceDialog.replaceAll      = document.getElementById(&quot;replaceAll&quot;);</span>
<a href="#l35.26"></a><span id="l35.26"> }</span>
<a href="#l35.27"></a><span id="l35.27"> </span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-function loadDialog()</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-{</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+function loadDialog() {</span>
<a href="#l35.31"></a><span id="l35.31">   // Set initial dialog field contents.</span>
<a href="#l35.32"></a><span id="l35.32">   // Set initial dialog field contents. Use the gFindInst attributes first,</span>
<a href="#l35.33"></a><span id="l35.33">   // this is necessary for window.find()</span>
<a href="#l35.34"></a><span id="l35.34">   gReplaceDialog.findInput.value         = (gFindInst.searchString</span>
<a href="#l35.35"></a><span id="l35.35">                                             ? gFindInst.searchString</span>
<a href="#l35.36"></a><span id="l35.36">                                             : gFindService.searchString);</span>
<a href="#l35.37"></a><span id="l35.37">   gReplaceDialog.replaceInput.value = gFindService.replaceString;</span>
<a href="#l35.38"></a><span id="l35.38">   gReplaceDialog.caseSensitive.checked   = (gFindInst.matchCase</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineat">@@ -46,143 +44,127 @@ function loadDialog()</span>
<a href="#l35.40"></a><span id="l35.40">                                             : gFindService.wrapFind);</span>
<a href="#l35.41"></a><span id="l35.41">   gReplaceDialog.searchBackwards.checked = (gFindInst.findBackwards</span>
<a href="#l35.42"></a><span id="l35.42">                                             ? gFindInst.findBackwards</span>
<a href="#l35.43"></a><span id="l35.43">                                             : gFindService.findBackwards);</span>
<a href="#l35.44"></a><span id="l35.44"> </span>
<a href="#l35.45"></a><span id="l35.45">   doEnabling();</span>
<a href="#l35.46"></a><span id="l35.46"> }</span>
<a href="#l35.47"></a><span id="l35.47"> </span>
<a href="#l35.48"></a><span id="l35.48" class="difflineminus">-function onLoad()</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-{</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+function onLoad() {</span>
<a href="#l35.51"></a><span id="l35.51">   // Get the xul &lt;editor&gt; element:</span>
<a href="#l35.52"></a><span id="l35.52">   var editorElement = window.arguments[0];</span>
<a href="#l35.53"></a><span id="l35.53"> </span>
<a href="#l35.54"></a><span id="l35.54">   // If we don't get the editor, then we won't allow replacing.</span>
<a href="#l35.55"></a><span id="l35.55">   gEditor = editorElement.getEditor(editorElement.contentWindow);</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineminus">-  if (!gEditor)</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineminus">-  {</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+  if (!gEditor) {</span>
<a href="#l35.59"></a><span id="l35.59">     window.close();</span>
<a href="#l35.60"></a><span id="l35.60">     return;</span>
<a href="#l35.61"></a><span id="l35.61">   }</span>
<a href="#l35.62"></a><span id="l35.62"> </span>
<a href="#l35.63"></a><span id="l35.63">   // Get the nsIWebBrowserFind service:</span>
<a href="#l35.64"></a><span id="l35.64">   gFindInst = editorElement.webBrowserFind;</span>
<a href="#l35.65"></a><span id="l35.65"> </span>
<a href="#l35.66"></a><span id="l35.66">   try {</span>
<a href="#l35.67"></a><span id="l35.67">   // get the find service, which stores global find state</span>
<a href="#l35.68"></a><span id="l35.68">     gFindService = Cc[&quot;@mozilla.org/find/find_service;1&quot;]</span>
<a href="#l35.69"></a><span id="l35.69">                          .getService(Ci.nsIFindService);</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-  } catch(e) { dump(&quot;No find service!\n&quot;); gFindService = 0; }</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+  } catch (e) { dump(&quot;No find service!\n&quot;); gFindService = 0; }</span>
<a href="#l35.72"></a><span id="l35.72"> </span>
<a href="#l35.73"></a><span id="l35.73">   // Init gReplaceDialog.</span>
<a href="#l35.74"></a><span id="l35.74">   initDialogObject();</span>
<a href="#l35.75"></a><span id="l35.75"> </span>
<a href="#l35.76"></a><span id="l35.76">   // Change &quot;OK&quot; to &quot;Find&quot;.</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineminus">-  //dialog.find.label = document.getElementById(&quot;fBLT&quot;).getAttribute(&quot;label&quot;);</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+  // dialog.find.label = document.getElementById(&quot;fBLT&quot;).getAttribute(&quot;label&quot;);</span>
<a href="#l35.79"></a><span id="l35.79"> </span>
<a href="#l35.80"></a><span id="l35.80">   // Fill dialog.</span>
<a href="#l35.81"></a><span id="l35.81">   loadDialog();</span>
<a href="#l35.82"></a><span id="l35.82"> </span>
<a href="#l35.83"></a><span id="l35.83">   if (gReplaceDialog.findInput.value)</span>
<a href="#l35.84"></a><span id="l35.84">     gReplaceDialog.findInput.select();</span>
<a href="#l35.85"></a><span id="l35.85">   else</span>
<a href="#l35.86"></a><span id="l35.86">     gReplaceDialog.findInput.focus();</span>
<a href="#l35.87"></a><span id="l35.87"> }</span>
<a href="#l35.88"></a><span id="l35.88"> </span>
<a href="#l35.89"></a><span id="l35.89"> function onUnload() {</span>
<a href="#l35.90"></a><span id="l35.90">   // Disconnect context from this dialog.</span>
<a href="#l35.91"></a><span id="l35.91">   gFindReplaceData.replaceDialog = null;</span>
<a href="#l35.92"></a><span id="l35.92"> }</span>
<a href="#l35.93"></a><span id="l35.93"> </span>
<a href="#l35.94"></a><span id="l35.94" class="difflineminus">-function saveFindData()</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineminus">-{</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+function saveFindData() {</span>
<a href="#l35.97"></a><span id="l35.97">   // Set data attributes per user input.</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineminus">-  if (gFindService)</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineminus">-  {</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+  if (gFindService) {</span>
<a href="#l35.101"></a><span id="l35.101">     gFindService.searchString  = gReplaceDialog.findInput.value;</span>
<a href="#l35.102"></a><span id="l35.102">     gFindService.matchCase     = gReplaceDialog.caseSensitive.checked;</span>
<a href="#l35.103"></a><span id="l35.103">     gFindService.wrapFind      = gReplaceDialog.wrap.checked;</span>
<a href="#l35.104"></a><span id="l35.104">     gFindService.findBackwards = gReplaceDialog.searchBackwards.checked;</span>
<a href="#l35.105"></a><span id="l35.105">   }</span>
<a href="#l35.106"></a><span id="l35.106"> }</span>
<a href="#l35.107"></a><span id="l35.107"> </span>
<a href="#l35.108"></a><span id="l35.108" class="difflineminus">-function setUpFindInst()</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineminus">-{</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+function setUpFindInst() {</span>
<a href="#l35.111"></a><span id="l35.111">   gFindInst.searchString  = gReplaceDialog.findInput.value;</span>
<a href="#l35.112"></a><span id="l35.112">   gFindInst.matchCase     = gReplaceDialog.caseSensitive.checked;</span>
<a href="#l35.113"></a><span id="l35.113">   gFindInst.wrapFind      = gReplaceDialog.wrap.checked;</span>
<a href="#l35.114"></a><span id="l35.114">   gFindInst.findBackwards = gReplaceDialog.searchBackwards.checked;</span>
<a href="#l35.115"></a><span id="l35.115"> }</span>
<a href="#l35.116"></a><span id="l35.116"> </span>
<a href="#l35.117"></a><span id="l35.117" class="difflineminus">-function onFindNext()</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineminus">-{</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+function onFindNext() {</span>
<a href="#l35.120"></a><span id="l35.120">   // Transfer dialog contents to the find service.</span>
<a href="#l35.121"></a><span id="l35.121">   saveFindData();</span>
<a href="#l35.122"></a><span id="l35.122">   // set up the find instance</span>
<a href="#l35.123"></a><span id="l35.123">   setUpFindInst();</span>
<a href="#l35.124"></a><span id="l35.124"> </span>
<a href="#l35.125"></a><span id="l35.125">   // Search.</span>
<a href="#l35.126"></a><span id="l35.126">   var result = gFindInst.findNext();</span>
<a href="#l35.127"></a><span id="l35.127"> </span>
<a href="#l35.128"></a><span id="l35.128" class="difflineminus">-  if (!result)</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineminus">-  {</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+  if (!result) {</span>
<a href="#l35.131"></a><span id="l35.131">     var bundle = document.getElementById(&quot;findBundle&quot;);</span>
<a href="#l35.132"></a><span id="l35.132">     Services.prompt.alert(window, GetString(&quot;Alert&quot;), bundle.getString(&quot;notFoundWarning&quot;));</span>
<a href="#l35.133"></a><span id="l35.133">     SetTextboxFocus(gReplaceDialog.findInput);</span>
<a href="#l35.134"></a><span id="l35.134">     gReplaceDialog.findInput.select();</span>
<a href="#l35.135"></a><span id="l35.135">     gReplaceDialog.findInput.focus();</span>
<a href="#l35.136"></a><span id="l35.136">     return false;</span>
<a href="#l35.137"></a><span id="l35.137">   }</span>
<a href="#l35.138"></a><span id="l35.138">   return true;</span>
<a href="#l35.139"></a><span id="l35.139"> }</span>
<a href="#l35.140"></a><span id="l35.140"> </span>
<a href="#l35.141"></a><span id="l35.141" class="difflineminus">-function onReplace()</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineminus">-{</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+function onReplace() {</span>
<a href="#l35.144"></a><span id="l35.144">   if (!gEditor)</span>
<a href="#l35.145"></a><span id="l35.145">     return false;</span>
<a href="#l35.146"></a><span id="l35.146"> </span>
<a href="#l35.147"></a><span id="l35.147">   // Does the current selection match the find string?</span>
<a href="#l35.148"></a><span id="l35.148">   var selection = gEditor.selection;</span>
<a href="#l35.149"></a><span id="l35.149"> </span>
<a href="#l35.150"></a><span id="l35.150">   var selStr = selection.toString();</span>
<a href="#l35.151"></a><span id="l35.151">   var specStr = gReplaceDialog.findInput.value;</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineminus">-  if (!gReplaceDialog.caseSensitive.checked)</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineminus">-  {</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+  if (!gReplaceDialog.caseSensitive.checked) {</span>
<a href="#l35.155"></a><span id="l35.155">     selStr = selStr.toLowerCase();</span>
<a href="#l35.156"></a><span id="l35.156">     specStr = specStr.toLowerCase();</span>
<a href="#l35.157"></a><span id="l35.157">   }</span>
<a href="#l35.158"></a><span id="l35.158">   // Unfortunately, because of whitespace we can't just check</span>
<a href="#l35.159"></a><span id="l35.159">   // whether (selStr == specStr), but have to loop ourselves.</span>
<a href="#l35.160"></a><span id="l35.160">   // N chars of whitespace in specStr can match any M &gt;= N in selStr.</span>
<a href="#l35.161"></a><span id="l35.161">   var matches = true;</span>
<a href="#l35.162"></a><span id="l35.162">   var specLen = specStr.length;</span>
<a href="#l35.163"></a><span id="l35.163">   var selLen = selStr.length;</span>
<a href="#l35.164"></a><span id="l35.164">   if (selLen &lt; specLen)</span>
<a href="#l35.165"></a><span id="l35.165">     matches = false;</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineminus">-  else</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineminus">-  {</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+  else {</span>
<a href="#l35.169"></a><span id="l35.169">     var specArray = specStr.match(/\S+|\s+/g);</span>
<a href="#l35.170"></a><span id="l35.170">     var selArray = selStr.match(/\S+|\s+/g);</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineminus">-    if ( specArray.length != selArray.length)</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+    if (specArray.length != selArray.length)</span>
<a href="#l35.173"></a><span id="l35.173">       matches = false;</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineminus">-    else</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineminus">-    {</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineminus">-      for (var i=0; i&lt;selArray.length; i++)</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineminus">-      {</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineminus">-        if (selArray[i] != specArray[i])</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineminus">-        {</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineminus">-          if ( /\S/.test(selArray[i][0]) || /\S/.test(specArray[i][0]) )</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineminus">-          {</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+    else {</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+      for (var i = 0; i &lt; selArray.length; i++) {</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+        if (selArray[i] != specArray[i]) {</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+          if (/\S/.test(selArray[i][0]) || /\S/.test(specArray[i][0])) {</span>
<a href="#l35.186"></a><span id="l35.186">             // not a space chunk -- match fails</span>
<a href="#l35.187"></a><span id="l35.187">             matches = false;</span>
<a href="#l35.188"></a><span id="l35.188">             break;</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineminus">-          }</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineminus">-          else if ( selArray[i].length &lt; specArray[i].length )</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineminus">-          {</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+          } else if (selArray[i].length &lt; specArray[i].length) {</span>
<a href="#l35.193"></a><span id="l35.193">             // if it's a space chunk then we only care that sel be</span>
<a href="#l35.194"></a><span id="l35.194">             // at least as long as spec</span>
<a href="#l35.195"></a><span id="l35.195">             matches = false;</span>
<a href="#l35.196"></a><span id="l35.196">             break;</span>
<a href="#l35.197"></a><span id="l35.197">           }</span>
<a href="#l35.198"></a><span id="l35.198">         }</span>
<a href="#l35.199"></a><span id="l35.199">       }</span>
<a href="#l35.200"></a><span id="l35.200">     }</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineat">@@ -196,42 +178,39 @@ function onReplace()</span>
<a href="#l35.202"></a><span id="l35.202">     return false;</span>
<a href="#l35.203"></a><span id="l35.203"> </span>
<a href="#l35.204"></a><span id="l35.204">   // Transfer dialog contents to the find service.</span>
<a href="#l35.205"></a><span id="l35.205">   saveFindData();</span>
<a href="#l35.206"></a><span id="l35.206"> </span>
<a href="#l35.207"></a><span id="l35.207">   // For reverse finds, need to remember the caret position</span>
<a href="#l35.208"></a><span id="l35.208">   // before current selection</span>
<a href="#l35.209"></a><span id="l35.209">   var newRange;</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineminus">-  if (gReplaceDialog.searchBackwards.checked &amp;&amp; selection.rangeCount &gt; 0)</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineminus">-  {</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+  if (gReplaceDialog.searchBackwards.checked &amp;&amp; selection.rangeCount &gt; 0) {</span>
<a href="#l35.213"></a><span id="l35.213">     newRange = selection.getRangeAt(0).cloneRange();</span>
<a href="#l35.214"></a><span id="l35.214">     newRange.collapse(true);</span>
<a href="#l35.215"></a><span id="l35.215">   }</span>
<a href="#l35.216"></a><span id="l35.216"> </span>
<a href="#l35.217"></a><span id="l35.217">   // nsPlaintextEditor::InsertText fails if the string is empty,</span>
<a href="#l35.218"></a><span id="l35.218">   // so make that a special case:</span>
<a href="#l35.219"></a><span id="l35.219">   var replStr = gReplaceDialog.replaceInput.value;</span>
<a href="#l35.220"></a><span id="l35.220">   if (replStr == &quot;&quot;)</span>
<a href="#l35.221"></a><span id="l35.221">     gEditor.deleteSelection(gEditor.eNone, gEditor.eStrip);</span>
<a href="#l35.222"></a><span id="l35.222">   else</span>
<a href="#l35.223"></a><span id="l35.223">     gEditor.insertText(replStr);</span>
<a href="#l35.224"></a><span id="l35.224"> </span>
<a href="#l35.225"></a><span id="l35.225">   // For reverse finds, need to move caret just before the replaced text</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineminus">-  if (gReplaceDialog.searchBackwards.checked &amp;&amp; newRange)</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineminus">-  {</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+  if (gReplaceDialog.searchBackwards.checked &amp;&amp; newRange) {</span>
<a href="#l35.229"></a><span id="l35.229">     gEditor.selection.removeAllRanges();</span>
<a href="#l35.230"></a><span id="l35.230">     gEditor.selection.addRange(newRange);</span>
<a href="#l35.231"></a><span id="l35.231">   }</span>
<a href="#l35.232"></a><span id="l35.232"> </span>
<a href="#l35.233"></a><span id="l35.233">   return true;</span>
<a href="#l35.234"></a><span id="l35.234"> }</span>
<a href="#l35.235"></a><span id="l35.235"> </span>
<a href="#l35.236"></a><span id="l35.236" class="difflineminus">-function onReplaceAll()</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineminus">-{</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+function onReplaceAll() {</span>
<a href="#l35.239"></a><span id="l35.239">   if (!gEditor)</span>
<a href="#l35.240"></a><span id="l35.240">     return;</span>
<a href="#l35.241"></a><span id="l35.241"> </span>
<a href="#l35.242"></a><span id="l35.242">   var findStr = gReplaceDialog.findInput.value;</span>
<a href="#l35.243"></a><span id="l35.243">   var repStr = gReplaceDialog.replaceInput.value;</span>
<a href="#l35.244"></a><span id="l35.244"> </span>
<a href="#l35.245"></a><span id="l35.245">   // Transfer dialog contents to the find service.</span>
<a href="#l35.246"></a><span id="l35.246">   saveFindData();</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineat">@@ -258,128 +237,115 @@ function onReplaceAll()</span>
<a href="#l35.248"></a><span id="l35.248">     // We'll need a range for the whole document:</span>
<a href="#l35.249"></a><span id="l35.249">     var wholeDocRange = gEditor.document.createRange();</span>
<a href="#l35.250"></a><span id="l35.250">     var rootNode = gEditor.rootElement;</span>
<a href="#l35.251"></a><span id="l35.251">     wholeDocRange.selectNodeContents(rootNode);</span>
<a href="#l35.252"></a><span id="l35.252"> </span>
<a href="#l35.253"></a><span id="l35.253">     // And start and end points:</span>
<a href="#l35.254"></a><span id="l35.254">     var endPt = gEditor.document.createRange();</span>
<a href="#l35.255"></a><span id="l35.255"> </span>
<a href="#l35.256"></a><span id="l35.256" class="difflineminus">-    if (gReplaceDialog.searchBackwards.checked)</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineminus">-    {</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+    if (gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l35.259"></a><span id="l35.259">       endPt.setStart(wholeDocRange.startContainer, wholeDocRange.startOffset);</span>
<a href="#l35.260"></a><span id="l35.260">       endPt.setEnd(wholeDocRange.startContainer, wholeDocRange.startOffset);</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineminus">-    }</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineminus">-    else</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineminus">-    {</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+    } else {</span>
<a href="#l35.265"></a><span id="l35.265">       endPt.setStart(wholeDocRange.endContainer, wholeDocRange.endOffset);</span>
<a href="#l35.266"></a><span id="l35.266">       endPt.setEnd(wholeDocRange.endContainer, wholeDocRange.endOffset);</span>
<a href="#l35.267"></a><span id="l35.267">     }</span>
<a href="#l35.268"></a><span id="l35.268"> </span>
<a href="#l35.269"></a><span id="l35.269">     // Find and replace from here to end (start) of document:</span>
<a href="#l35.270"></a><span id="l35.270">     var foundRange;</span>
<a href="#l35.271"></a><span id="l35.271">     var searchRange = wholeDocRange.cloneRange();</span>
<a href="#l35.272"></a><span id="l35.272">     while ((foundRange = finder.Find(findStr, searchRange,</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineminus">-                                     selecRange, endPt)) != null)</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineminus">-    {</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+                                     selecRange, endPt)) != null) {</span>
<a href="#l35.276"></a><span id="l35.276">       gEditor.selection.removeAllRanges();</span>
<a href="#l35.277"></a><span id="l35.277">       gEditor.selection.addRange(foundRange);</span>
<a href="#l35.278"></a><span id="l35.278"> </span>
<a href="#l35.279"></a><span id="l35.279">       // The editor will leave the caret at the end of the replaced text.</span>
<a href="#l35.280"></a><span id="l35.280">       // For reverse finds, we need it at the beginning,</span>
<a href="#l35.281"></a><span id="l35.281">       // so save the next position now.</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineminus">-      if (gReplaceDialog.searchBackwards.checked)</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineminus">-      {</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+      if (gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l35.285"></a><span id="l35.285">         selecRange = foundRange.cloneRange();</span>
<a href="#l35.286"></a><span id="l35.286">         selecRange.setEnd(selecRange.startContainer, selecRange.startOffset);</span>
<a href="#l35.287"></a><span id="l35.287">       }</span>
<a href="#l35.288"></a><span id="l35.288"> </span>
<a href="#l35.289"></a><span id="l35.289">       // nsPlaintextEditor::InsertText fails if the string is empty,</span>
<a href="#l35.290"></a><span id="l35.290">       // so make that a special case:</span>
<a href="#l35.291"></a><span id="l35.291">       if (repStr == &quot;&quot;)</span>
<a href="#l35.292"></a><span id="l35.292">         gEditor.deleteSelection(gEditor.eNone, gEditor.eStrip);</span>
<a href="#l35.293"></a><span id="l35.293">       else</span>
<a href="#l35.294"></a><span id="l35.294">         gEditor.insertText(repStr);</span>
<a href="#l35.295"></a><span id="l35.295"> </span>
<a href="#l35.296"></a><span id="l35.296">       // If we're going forward, we didn't save selecRange before, so do it now:</span>
<a href="#l35.297"></a><span id="l35.297" class="difflineminus">-      if (!gReplaceDialog.searchBackwards.checked)</span>
<a href="#l35.298"></a><span id="l35.298" class="difflineminus">-      {</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineplus">+      if (!gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l35.300"></a><span id="l35.300">         selection = gEditor.selection;</span>
<a href="#l35.301"></a><span id="l35.301">         if (selection.rangeCount &lt;= 0) {</span>
<a href="#l35.302"></a><span id="l35.302">           gEditor.endTransaction();</span>
<a href="#l35.303"></a><span id="l35.303">           return;</span>
<a href="#l35.304"></a><span id="l35.304">         }</span>
<a href="#l35.305"></a><span id="l35.305">         selecRange = selection.getRangeAt(0).cloneRange();</span>
<a href="#l35.306"></a><span id="l35.306">       }</span>
<a href="#l35.307"></a><span id="l35.307">     }</span>
<a href="#l35.308"></a><span id="l35.308"> </span>
<a href="#l35.309"></a><span id="l35.309">     // If no wrapping, then we're done</span>
<a href="#l35.310"></a><span id="l35.310">     if (!gReplaceDialog.wrap.checked) {</span>
<a href="#l35.311"></a><span id="l35.311">       gEditor.endTransaction();</span>
<a href="#l35.312"></a><span id="l35.312">       return;</span>
<a href="#l35.313"></a><span id="l35.313">     }</span>
<a href="#l35.314"></a><span id="l35.314"> </span>
<a href="#l35.315"></a><span id="l35.315">     // If wrapping, find from start/end of document back to start point.</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineminus">-    if (gReplaceDialog.searchBackwards.checked)</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineminus">-    {</span>
<a href="#l35.318"></a><span id="l35.318" class="difflineplus">+    if (gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l35.319"></a><span id="l35.319">       // Collapse origRange to end</span>
<a href="#l35.320"></a><span id="l35.320">       origRange.setStart(origRange.endContainer, origRange.endOffset);</span>
<a href="#l35.321"></a><span id="l35.321">       // Set current position to document end</span>
<a href="#l35.322"></a><span id="l35.322">       selecRange.setEnd(wholeDocRange.endContainer, wholeDocRange.endOffset);</span>
<a href="#l35.323"></a><span id="l35.323">       selecRange.setStart(wholeDocRange.endContainer, wholeDocRange.endOffset);</span>
<a href="#l35.324"></a><span id="l35.324" class="difflineminus">-    }</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineminus">-    else</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineminus">-    {</span>
<a href="#l35.327"></a><span id="l35.327" class="difflineplus">+    } else {</span>
<a href="#l35.328"></a><span id="l35.328">       // Collapse origRange to start</span>
<a href="#l35.329"></a><span id="l35.329">       origRange.setEnd(origRange.startContainer, origRange.startOffset);</span>
<a href="#l35.330"></a><span id="l35.330">       // Set current position to document start</span>
<a href="#l35.331"></a><span id="l35.331">       selecRange.setStart(wholeDocRange.startContainer,</span>
<a href="#l35.332"></a><span id="l35.332">                           wholeDocRange.startOffset);</span>
<a href="#l35.333"></a><span id="l35.333">       selecRange.setEnd(wholeDocRange.startContainer, wholeDocRange.startOffset);</span>
<a href="#l35.334"></a><span id="l35.334">     }</span>
<a href="#l35.335"></a><span id="l35.335"> </span>
<a href="#l35.336"></a><span id="l35.336">     while ((foundRange = finder.Find(findStr, wholeDocRange,</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineminus">-                                     selecRange, origRange)) != null)</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineminus">-    {</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineplus">+                                     selecRange, origRange)) != null) {</span>
<a href="#l35.340"></a><span id="l35.340">       gEditor.selection.removeAllRanges();</span>
<a href="#l35.341"></a><span id="l35.341">       gEditor.selection.addRange(foundRange);</span>
<a href="#l35.342"></a><span id="l35.342"> </span>
<a href="#l35.343"></a><span id="l35.343">       // Save insert point for backward case</span>
<a href="#l35.344"></a><span id="l35.344" class="difflineminus">-      if (gReplaceDialog.searchBackwards.checked)</span>
<a href="#l35.345"></a><span id="l35.345" class="difflineminus">-      {</span>
<a href="#l35.346"></a><span id="l35.346" class="difflineplus">+      if (gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l35.347"></a><span id="l35.347">         selecRange = foundRange.cloneRange();</span>
<a href="#l35.348"></a><span id="l35.348">         selecRange.setEnd(selecRange.startContainer, selecRange.startOffset);</span>
<a href="#l35.349"></a><span id="l35.349">       }</span>
<a href="#l35.350"></a><span id="l35.350"> </span>
<a href="#l35.351"></a><span id="l35.351">       // nsPlaintextEditor::InsertText fails if the string is empty,</span>
<a href="#l35.352"></a><span id="l35.352">       // so make that a special case:</span>
<a href="#l35.353"></a><span id="l35.353">       if (repStr == &quot;&quot;)</span>
<a href="#l35.354"></a><span id="l35.354">         gEditor.deleteSelection(gEditor.eNone, gEditor.eStrip);</span>
<a href="#l35.355"></a><span id="l35.355">       else</span>
<a href="#l35.356"></a><span id="l35.356">         gEditor.insertText(repStr);</span>
<a href="#l35.357"></a><span id="l35.357"> </span>
<a href="#l35.358"></a><span id="l35.358">       // Get insert point for forward case</span>
<a href="#l35.359"></a><span id="l35.359" class="difflineminus">-      if (!gReplaceDialog.searchBackwards.checked)</span>
<a href="#l35.360"></a><span id="l35.360" class="difflineminus">-      {</span>
<a href="#l35.361"></a><span id="l35.361" class="difflineplus">+      if (!gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l35.362"></a><span id="l35.362">         selection = gEditor.selection;</span>
<a href="#l35.363"></a><span id="l35.363">         if (selection.rangeCount &lt;= 0) {</span>
<a href="#l35.364"></a><span id="l35.364">           gEditor.endTransaction();</span>
<a href="#l35.365"></a><span id="l35.365">           return;</span>
<a href="#l35.366"></a><span id="l35.366">         }</span>
<a href="#l35.367"></a><span id="l35.367">         selecRange = selection.getRangeAt(0);</span>
<a href="#l35.368"></a><span id="l35.368">       }</span>
<a href="#l35.369"></a><span id="l35.369">     }</span>
<a href="#l35.370"></a><span id="l35.370">   } // end try</span>
<a href="#l35.371"></a><span id="l35.371">   catch (e) { }</span>
<a href="#l35.372"></a><span id="l35.372"> </span>
<a href="#l35.373"></a><span id="l35.373">   gEditor.endTransaction();</span>
<a href="#l35.374"></a><span id="l35.374"> }</span>
<a href="#l35.375"></a><span id="l35.375"> </span>
<a href="#l35.376"></a><span id="l35.376" class="difflineminus">-function doEnabling()</span>
<a href="#l35.377"></a><span id="l35.377" class="difflineminus">-{</span>
<a href="#l35.378"></a><span id="l35.378" class="difflineplus">+function doEnabling() {</span>
<a href="#l35.379"></a><span id="l35.379">   var findStr = gReplaceDialog.findInput.value;</span>
<a href="#l35.380"></a><span id="l35.380">   var repStr = gReplaceDialog.replaceInput.value;</span>
<a href="#l35.381"></a><span id="l35.381">   gReplaceDialog.enabled = findStr;</span>
<a href="#l35.382"></a><span id="l35.382">   gReplaceDialog.findNext.disabled = !findStr;</span>
<a href="#l35.383"></a><span id="l35.383">   gReplaceDialog.replace.disabled = !findStr;</span>
<a href="#l35.384"></a><span id="l35.384">   gReplaceDialog.replaceAndFind.disabled = !findStr;</span>
<a href="#l35.385"></a><span id="l35.385">   gReplaceDialog.replaceAll.disabled = !findStr;</span>
<a href="#l35.386"></a><span id="l35.386"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdSelectProps.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdSelectProps.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -15,35 +15,30 @@ var currentItem = null;</span>
<a href="#l36.4"></a><span id="l36.4"> var selectedOption = null;</span>
<a href="#l36.5"></a><span id="l36.5"> var selectedOptionCount = 0;</span>
<a href="#l36.6"></a><span id="l36.6"> </span>
<a href="#l36.7"></a><span id="l36.7"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l36.8"></a><span id="l36.8"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10"> // Utility functions</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-function getParentIndex(index)</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-{</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-  switch (itemArray[index].level)</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineminus">-  {</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+function getParentIndex(index) {</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+  switch (itemArray[index].level) {</span>
<a href="#l36.18"></a><span id="l36.18">   case 0: return -1;</span>
<a href="#l36.19"></a><span id="l36.19">   case 1: return 0;</span>
<a href="#l36.20"></a><span id="l36.20">   }</span>
<a href="#l36.21"></a><span id="l36.21">   while (itemArray[--index].level &gt; 1);</span>
<a href="#l36.22"></a><span id="l36.22">   return index;</span>
<a href="#l36.23"></a><span id="l36.23"> }</span>
<a href="#l36.24"></a><span id="l36.24"> </span>
<a href="#l36.25"></a><span id="l36.25" class="difflineminus">-function UpdateSelectMultiple()</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineminus">-{</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineminus">-  if (selectedOptionCount &gt; 1)</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-  {</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+function UpdateSelectMultiple() {</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+  if (selectedOptionCount &gt; 1) {</span>
<a href="#l36.31"></a><span id="l36.31">     gDialog.selectMultiple.checked = true;</span>
<a href="#l36.32"></a><span id="l36.32">     gDialog.selectMultiple.disabled = true;</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-  }</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-  else</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+  } else</span>
<a href="#l36.36"></a><span id="l36.36">     gDialog.selectMultiple.disabled = false;</span>
<a href="#l36.37"></a><span id="l36.37"> }</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39"> /* wrapper objects:</span>
<a href="#l36.40"></a><span id="l36.40">  * readonly attribute Node element; // DOM node (select/optgroup/option)</span>
<a href="#l36.41"></a><span id="l36.41">  * readonly attribute int level; // tree depth</span>
<a href="#l36.42"></a><span id="l36.42">  * readonly attribute boolean container; // can contain options</span>
<a href="#l36.43"></a><span id="l36.43">  * string getCellText(string col); // tree view helper</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineat">@@ -56,110 +51,98 @@ function UpdateSelectMultiple()</span>
<a href="#l36.45"></a><span id="l36.45">  * boolean canMoveDown();</span>
<a href="#l36.46"></a><span id="l36.46">  * void moveDown();</span>
<a href="#l36.47"></a><span id="l36.47">  * void appendOption(newElement, currentIndex);</span>
<a href="#l36.48"></a><span id="l36.48">  */</span>
<a href="#l36.49"></a><span id="l36.49"> </span>
<a href="#l36.50"></a><span id="l36.50"> // OPTION element wrapper object</span>
<a href="#l36.51"></a><span id="l36.51"> </span>
<a href="#l36.52"></a><span id="l36.52"> // Create a wrapper for the given element at the given level</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-function optionObject(option, level)</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-{</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+function optionObject(option, level) {</span>
<a href="#l36.56"></a><span id="l36.56">   // select an added option (when loading from document)</span>
<a href="#l36.57"></a><span id="l36.57">   if (option.hasAttribute(&quot;selected&quot;))</span>
<a href="#l36.58"></a><span id="l36.58">     selectedOptionCount++;</span>
<a href="#l36.59"></a><span id="l36.59">   this.level = level;</span>
<a href="#l36.60"></a><span id="l36.60">   this.element = option;</span>
<a href="#l36.61"></a><span id="l36.61"> }</span>
<a href="#l36.62"></a><span id="l36.62"> </span>
<a href="#l36.63"></a><span id="l36.63"> optionObject.prototype.container = false;</span>
<a href="#l36.64"></a><span id="l36.64"> </span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">-optionObject.prototype.getCellText = function getCellText(column)</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineminus">-{</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+optionObject.prototype.getCellText = function getCellText(column) {</span>
<a href="#l36.68"></a><span id="l36.68">   if (column.id == &quot;SelectSelCol&quot;)</span>
<a href="#l36.69"></a><span id="l36.69">     return &quot;&quot;;</span>
<a href="#l36.70"></a><span id="l36.70">   if (column.id == &quot;SelectValCol&quot; &amp;&amp; this.element.hasAttribute(&quot;value&quot;))</span>
<a href="#l36.71"></a><span id="l36.71">     return this.element.getAttribute(&quot;value&quot;);</span>
<a href="#l36.72"></a><span id="l36.72">   return this.element.text;</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-}</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+};</span>
<a href="#l36.75"></a><span id="l36.75"> </span>
<a href="#l36.76"></a><span id="l36.76" class="difflineminus">-optionObject.prototype.cycleCell = function cycleCell(index)</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineminus">-{</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineminus">-  if (this.element.hasAttribute(&quot;selected&quot;))</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-  {</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+optionObject.prototype.cycleCell = function cycleCell(index) {</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+  if (this.element.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l36.82"></a><span id="l36.82">     this.element.removeAttribute(&quot;selected&quot;);</span>
<a href="#l36.83"></a><span id="l36.83">     selectedOptionCount--;</span>
<a href="#l36.84"></a><span id="l36.84">     selectedOption = null;</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-  }</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-  else</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-  {</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+  } else {</span>
<a href="#l36.89"></a><span id="l36.89">     // Different handling for multiselect lists</span>
<a href="#l36.90"></a><span id="l36.90">     if (gDialog.selectMultiple.checked || !selectedOption)</span>
<a href="#l36.91"></a><span id="l36.91">       selectedOptionCount++;</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineminus">-    else if (selectedOption)</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineminus">-    {</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+    else if (selectedOption) {</span>
<a href="#l36.95"></a><span id="l36.95">       selectedOption.removeAttribute(&quot;selected&quot;);</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineminus">-      var column = theTree.columns[&quot;SelectSelCol&quot;];</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineplus">+      var column = theTree.columns.SelectSelCol;</span>
<a href="#l36.98"></a><span id="l36.98">       theTree.invalidateColumn(column);</span>
<a href="#l36.99"></a><span id="l36.99">       selectedOption = null;</span>
<a href="#l36.100"></a><span id="l36.100">     }</span>
<a href="#l36.101"></a><span id="l36.101">     this.element.setAttribute(&quot;selected&quot;, &quot;&quot;);</span>
<a href="#l36.102"></a><span id="l36.102">     selectedOption = this.element;</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineminus">-    var column = theTree.columns[&quot;SelectSelCol&quot;];</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+    var column = theTree.columns.SelectSelCol;</span>
<a href="#l36.105"></a><span id="l36.105">     theTree.invalidateCell(index, column);</span>
<a href="#l36.106"></a><span id="l36.106">   }</span>
<a href="#l36.107"></a><span id="l36.107">   if (currentItem == this)</span>
<a href="#l36.108"></a><span id="l36.108">     // Also update the deck</span>
<a href="#l36.109"></a><span id="l36.109">     gDialog.optionSelected.setAttribute(&quot;checked&quot;, this.element.hasAttribute(&quot;selected&quot;));</span>
<a href="#l36.110"></a><span id="l36.110">   UpdateSelectMultiple();</span>
<a href="#l36.111"></a><span id="l36.111"> };</span>
<a href="#l36.112"></a><span id="l36.112"> </span>
<a href="#l36.113"></a><span id="l36.113" class="difflineminus">-optionObject.prototype.onFocus = function onFocus()</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineminus">-{</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+optionObject.prototype.onFocus = function onFocus() {</span>
<a href="#l36.116"></a><span id="l36.116">   gDialog.optionText.value = this.element.text;</span>
<a href="#l36.117"></a><span id="l36.117">   hasValue = this.element.hasAttribute(&quot;value&quot;);</span>
<a href="#l36.118"></a><span id="l36.118">   oldValue = this.element.value;</span>
<a href="#l36.119"></a><span id="l36.119">   gDialog.optionHasValue.checked = hasValue;</span>
<a href="#l36.120"></a><span id="l36.120">   gDialog.optionValue.value = hasValue ? this.element.value : this.element.text;</span>
<a href="#l36.121"></a><span id="l36.121">   gDialog.optionSelected.checked = this.element.hasAttribute(&quot;selected&quot;);</span>
<a href="#l36.122"></a><span id="l36.122">   gDialog.optionDisabled.checked = this.element.hasAttribute(&quot;disabled&quot;);</span>
<a href="#l36.123"></a><span id="l36.123">   gDialog.selectDeck.setAttribute(&quot;selectedIndex&quot;, &quot;2&quot;);</span>
<a href="#l36.124"></a><span id="l36.124"> };</span>
<a href="#l36.125"></a><span id="l36.125"> </span>
<a href="#l36.126"></a><span id="l36.126" class="difflineminus">-optionObject.prototype.onBlur = function onBlur()</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineminus">-{</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+optionObject.prototype.onBlur = function onBlur() {</span>
<a href="#l36.129"></a><span id="l36.129">   this.element.text = gDialog.optionText.value;</span>
<a href="#l36.130"></a><span id="l36.130">   if (gDialog.optionHasValue.checked)</span>
<a href="#l36.131"></a><span id="l36.131">     this.element.value = gDialog.optionValue.value;</span>
<a href="#l36.132"></a><span id="l36.132">   else</span>
<a href="#l36.133"></a><span id="l36.133">     this.element.removeAttribute(&quot;value&quot;);</span>
<a href="#l36.134"></a><span id="l36.134">   if (gDialog.optionSelected.checked)</span>
<a href="#l36.135"></a><span id="l36.135">     this.element.setAttribute(&quot;selected&quot;, &quot;&quot;);</span>
<a href="#l36.136"></a><span id="l36.136">   else</span>
<a href="#l36.137"></a><span id="l36.137">     this.element.removeAttribute(&quot;selected&quot;);</span>
<a href="#l36.138"></a><span id="l36.138">   if (gDialog.optionDisabled.checked)</span>
<a href="#l36.139"></a><span id="l36.139">     this.element.setAttribute(&quot;disabled&quot;, &quot;&quot;);</span>
<a href="#l36.140"></a><span id="l36.140">   else</span>
<a href="#l36.141"></a><span id="l36.141">     this.element.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l36.142"></a><span id="l36.142"> };</span>
<a href="#l36.143"></a><span id="l36.143"> </span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-optionObject.prototype.canDestroy = function canDestroy(prompt)</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-{</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+optionObject.prototype.canDestroy = function canDestroy(prompt) {</span>
<a href="#l36.147"></a><span id="l36.147">   return true;</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineminus">-/*return !prompt ||</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+/* return !prompt ||</span>
<a href="#l36.150"></a><span id="l36.150">     ConfirmWithTitle(GetString(&quot;DeleteOption&quot;),</span>
<a href="#l36.151"></a><span id="l36.151">                      GetString(&quot;DeleteOptionMsg&quot;),</span>
<a href="#l36.152"></a><span id="l36.152">                      GetString(&quot;DeleteOption&quot;));*/</span>
<a href="#l36.153"></a><span id="l36.153"> };</span>
<a href="#l36.154"></a><span id="l36.154"> </span>
<a href="#l36.155"></a><span id="l36.155" class="difflineminus">-optionObject.prototype.destroy = function destroy()</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineminus">-{</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+optionObject.prototype.destroy = function destroy() {</span>
<a href="#l36.158"></a><span id="l36.158">   // Deselect a removed option</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineminus">-  if (this.element.hasAttribute(&quot;selected&quot;))</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineminus">-  {</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+  if (this.element.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l36.162"></a><span id="l36.162">     selectedOptionCount--;</span>
<a href="#l36.163"></a><span id="l36.163">     selectedOption = null;</span>
<a href="#l36.164"></a><span id="l36.164">     UpdateSelectMultiple();</span>
<a href="#l36.165"></a><span id="l36.165">   }</span>
<a href="#l36.166"></a><span id="l36.166"> };</span>
<a href="#l36.167"></a><span id="l36.167"> </span>
<a href="#l36.168"></a><span id="l36.168"> /* 4 cases:</span>
<a href="#l36.169"></a><span id="l36.169">  * a) optgroup -&gt; optgroup</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineat">@@ -169,207 +152,182 @@ optionObject.prototype.destroy = functio</span>
<a href="#l36.171"></a><span id="l36.171">  *      option    optgroup</span>
<a href="#l36.172"></a><span id="l36.172">  *      ...         ...</span>
<a href="#l36.173"></a><span id="l36.173">  * c) option</span>
<a href="#l36.174"></a><span id="l36.174">  *    option</span>
<a href="#l36.175"></a><span id="l36.175">  * d)   option</span>
<a href="#l36.176"></a><span id="l36.176">  *      option</span>
<a href="#l36.177"></a><span id="l36.177">  */</span>
<a href="#l36.178"></a><span id="l36.178"> </span>
<a href="#l36.179"></a><span id="l36.179" class="difflineminus">-optionObject.prototype.moveUp = function moveUp()</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineminus">-{</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+optionObject.prototype.moveUp = function moveUp() {</span>
<a href="#l36.182"></a><span id="l36.182">   var i;</span>
<a href="#l36.183"></a><span id="l36.183">   var index = treeSelection.currentIndex;</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineminus">-  if (itemArray[index].level &lt; itemArray[index - 1].level + itemArray[index - 1].container)</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineminus">-  {</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineplus">+  if (itemArray[index].level &lt; itemArray[index - 1].level + itemArray[index - 1].container) {</span>
<a href="#l36.187"></a><span id="l36.187">     // we need to repaint the tree's lines</span>
<a href="#l36.188"></a><span id="l36.188">     theTree.invalidateRange(getParentIndex(index), index);</span>
<a href="#l36.189"></a><span id="l36.189">     // a) option is just after an optgroup, so it becomes the last child</span>
<a href="#l36.190"></a><span id="l36.190">     itemArray[index].level = 2;</span>
<a href="#l36.191"></a><span id="l36.191">     theTree.view.selectionChanged();</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineminus">-  }</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineminus">-  else</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineminus">-  {</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+  } else {</span>
<a href="#l36.196"></a><span id="l36.196">     // otherwise new option level is now the same as the previous item</span>
<a href="#l36.197"></a><span id="l36.197">     itemArray[index].level = itemArray[index - 1].level;</span>
<a href="#l36.198"></a><span id="l36.198">     // swap the option with the previous item</span>
<a href="#l36.199"></a><span id="l36.199">     itemArray.splice(index, 0, itemArray.splice(--index, 1)[0]);</span>
<a href="#l36.200"></a><span id="l36.200">   }</span>
<a href="#l36.201"></a><span id="l36.201">   selectTreeIndex(index, true);</span>
<a href="#l36.202"></a><span id="l36.202" class="difflineminus">-}</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineplus">+};</span>
<a href="#l36.204"></a><span id="l36.204"> </span>
<a href="#l36.205"></a><span id="l36.205" class="difflineminus">-optionObject.prototype.canMoveDown = function canMoveDown()</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineminus">-{</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineplus">+optionObject.prototype.canMoveDown = function canMoveDown() {</span>
<a href="#l36.208"></a><span id="l36.208">   // move down is not allowed on the last option if its level is 1</span>
<a href="#l36.209"></a><span id="l36.209">   return this.level &gt; 1 || itemArray.length - treeSelection.currentIndex &gt; 1;</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineminus">-}</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineplus">+};</span>
<a href="#l36.212"></a><span id="l36.212"> </span>
<a href="#l36.213"></a><span id="l36.213" class="difflineminus">-optionObject.prototype.moveDown = function moveDown()</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineminus">-{</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineplus">+optionObject.prototype.moveDown = function moveDown() {</span>
<a href="#l36.216"></a><span id="l36.216">   var i;</span>
<a href="#l36.217"></a><span id="l36.217">   var index = treeSelection.currentIndex;</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineminus">-  if (index + 1 == itemArray.length || itemArray[index].level &gt; itemArray[index + 1].level)</span>
<a href="#l36.219"></a><span id="l36.219" class="difflineminus">-  {</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineplus">+  if (index + 1 == itemArray.length || itemArray[index].level &gt; itemArray[index + 1].level) {</span>
<a href="#l36.221"></a><span id="l36.221">     // we need to repaint the tree's lines</span>
<a href="#l36.222"></a><span id="l36.222">     theTree.invalidateRange(getParentIndex(index), index);</span>
<a href="#l36.223"></a><span id="l36.223">     // a) option is last child of an optgroup, so it moves just after</span>
<a href="#l36.224"></a><span id="l36.224">     itemArray[index].level = 1;</span>
<a href="#l36.225"></a><span id="l36.225">     theTree.view.selectionChanged();</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineminus">-  }</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineminus">-  else</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineminus">-  {</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+  } else {</span>
<a href="#l36.230"></a><span id="l36.230">     // level increases if the option was preceding an optgroup</span>
<a href="#l36.231"></a><span id="l36.231">     itemArray[index].level += itemArray[index + 1].container;</span>
<a href="#l36.232"></a><span id="l36.232">     // swap the option with the next item</span>
<a href="#l36.233"></a><span id="l36.233">     itemArray.splice(index, 0, itemArray.splice(++index, 1)[0]);</span>
<a href="#l36.234"></a><span id="l36.234">   }</span>
<a href="#l36.235"></a><span id="l36.235">   selectTreeIndex(index, true);</span>
<a href="#l36.236"></a><span id="l36.236" class="difflineminus">-}</span>
<a href="#l36.237"></a><span id="l36.237" class="difflineplus">+};</span>
<a href="#l36.238"></a><span id="l36.238"> </span>
<a href="#l36.239"></a><span id="l36.239" class="difflineminus">-optionObject.prototype.appendOption = function appendOption(child, parent)</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineminus">-{</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineplus">+optionObject.prototype.appendOption = function appendOption(child, parent) {</span>
<a href="#l36.242"></a><span id="l36.242">   // special case quick check</span>
<a href="#l36.243"></a><span id="l36.243">   if (this.level == 1)</span>
<a href="#l36.244"></a><span id="l36.244">     return gDialog.appendOption(child, 0);</span>
<a href="#l36.245"></a><span id="l36.245"> </span>
<a href="#l36.246"></a><span id="l36.246">   // append the option to the parent element</span>
<a href="#l36.247"></a><span id="l36.247">   parent = getParentIndex(parent);</span>
<a href="#l36.248"></a><span id="l36.248">   return itemArray[parent].appendOption(child, parent);</span>
<a href="#l36.249"></a><span id="l36.249"> };</span>
<a href="#l36.250"></a><span id="l36.250"> </span>
<a href="#l36.251"></a><span id="l36.251"> // OPTGROUP element wrapper object</span>
<a href="#l36.252"></a><span id="l36.252"> </span>
<a href="#l36.253"></a><span id="l36.253" class="difflineminus">-function optgroupObject(optgroup)</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineminus">-{</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineplus">+function optgroupObject(optgroup) {</span>
<a href="#l36.256"></a><span id="l36.256">   this.element = optgroup;</span>
<a href="#l36.257"></a><span id="l36.257"> }</span>
<a href="#l36.258"></a><span id="l36.258"> </span>
<a href="#l36.259"></a><span id="l36.259"> optgroupObject.prototype.level = 1;</span>
<a href="#l36.260"></a><span id="l36.260"> </span>
<a href="#l36.261"></a><span id="l36.261"> optgroupObject.prototype.container = true;</span>
<a href="#l36.262"></a><span id="l36.262"> </span>
<a href="#l36.263"></a><span id="l36.263" class="difflineminus">-optgroupObject.prototype.getCellText = function getCellText(column)</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineminus">-{</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineplus">+optgroupObject.prototype.getCellText = function getCellText(column) {</span>
<a href="#l36.266"></a><span id="l36.266">   return column.id == &quot;SelectTextCol&quot; ? this.element.label : &quot;&quot;;</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineminus">-}</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineminus">-</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineminus">-optgroupObject.prototype.cycleCell = function cycleCell(index)</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineminus">-{</span>
<a href="#l36.271"></a><span id="l36.271"> };</span>
<a href="#l36.272"></a><span id="l36.272"> </span>
<a href="#l36.273"></a><span id="l36.273" class="difflineminus">-optgroupObject.prototype.onFocus = function onFocus()</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineminus">-{</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineplus">+optgroupObject.prototype.cycleCell = function cycleCell(index) {</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineplus">+};</span>
<a href="#l36.277"></a><span id="l36.277" class="difflineplus">+</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineplus">+optgroupObject.prototype.onFocus = function onFocus() {</span>
<a href="#l36.279"></a><span id="l36.279">   gDialog.optgroupLabel.value = this.element.label;</span>
<a href="#l36.280"></a><span id="l36.280">   gDialog.optgroupDisabled.checked = this.element.disabled;</span>
<a href="#l36.281"></a><span id="l36.281">   gDialog.selectDeck.setAttribute(&quot;selectedIndex&quot;, &quot;1&quot;);</span>
<a href="#l36.282"></a><span id="l36.282"> };</span>
<a href="#l36.283"></a><span id="l36.283"> </span>
<a href="#l36.284"></a><span id="l36.284" class="difflineminus">-optgroupObject.prototype.onBlur = function onBlur()</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineminus">-{</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineplus">+optgroupObject.prototype.onBlur = function onBlur() {</span>
<a href="#l36.287"></a><span id="l36.287">   this.element.label = gDialog.optgroupLabel.value;</span>
<a href="#l36.288"></a><span id="l36.288">   this.element.disabled = gDialog.optgroupDisabled.checked;</span>
<a href="#l36.289"></a><span id="l36.289"> };</span>
<a href="#l36.290"></a><span id="l36.290"> </span>
<a href="#l36.291"></a><span id="l36.291" class="difflineminus">-optgroupObject.prototype.canDestroy = function canDestroy(prompt)</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineminus">-{</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineplus">+optgroupObject.prototype.canDestroy = function canDestroy(prompt) {</span>
<a href="#l36.294"></a><span id="l36.294">   // Only removing empty option groups for now</span>
<a href="#l36.295"></a><span id="l36.295">   return gDialog.nextChild(treeSelection.currentIndex) - treeSelection.currentIndex == 1;</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineminus">-/*&amp;&amp; (!prompt ||</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineplus">+/* &amp;&amp; (!prompt ||</span>
<a href="#l36.298"></a><span id="l36.298">     ConfirmWithTitle(GetString(&quot;DeleteOptGroup&quot;),</span>
<a href="#l36.299"></a><span id="l36.299">                      GetString(&quot;DeleteOptGroupMsg&quot;),</span>
<a href="#l36.300"></a><span id="l36.300">                      GetString(&quot;DeleteOptGroup&quot;)));</span>
<a href="#l36.301"></a><span id="l36.301"> */</span>
<a href="#l36.302"></a><span id="l36.302"> };</span>
<a href="#l36.303"></a><span id="l36.303"> </span>
<a href="#l36.304"></a><span id="l36.304" class="difflineminus">-optgroupObject.prototype.destroy = function destroy()</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineminus">-{</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineplus">+optgroupObject.prototype.destroy = function destroy() {</span>
<a href="#l36.307"></a><span id="l36.307"> };</span>
<a href="#l36.308"></a><span id="l36.308"> </span>
<a href="#l36.309"></a><span id="l36.309" class="difflineminus">-optgroupObject.prototype.moveUp = function moveUp()</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineminus">-{</span>
<a href="#l36.311"></a><span id="l36.311" class="difflineplus">+optgroupObject.prototype.moveUp = function moveUp() {</span>
<a href="#l36.312"></a><span id="l36.312">   // Find the index of the previous and next elements at the same level</span>
<a href="#l36.313"></a><span id="l36.313">   var index = treeSelection.currentIndex;</span>
<a href="#l36.314"></a><span id="l36.314">   var i = index;</span>
<a href="#l36.315"></a><span id="l36.315">   while (itemArray[--index].level &gt; 1);</span>
<a href="#l36.316"></a><span id="l36.316">   var j = gDialog.nextChild(i);</span>
<a href="#l36.317"></a><span id="l36.317">   // Cut out the element, cut the array in two, then join together</span>
<a href="#l36.318"></a><span id="l36.318">   var movedItems = itemArray.splice(i, j - i);</span>
<a href="#l36.319"></a><span id="l36.319">   var endItems = itemArray.splice(index);</span>
<a href="#l36.320"></a><span id="l36.320">   itemArray = itemArray.concat(movedItems).concat(endItems);</span>
<a href="#l36.321"></a><span id="l36.321">   // Repaint the lot</span>
<a href="#l36.322"></a><span id="l36.322">   theTree.invalidateRange(index, j);</span>
<a href="#l36.323"></a><span id="l36.323">   selectTreeIndex(index, true);</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineminus">-}</span>
<a href="#l36.325"></a><span id="l36.325" class="difflineplus">+};</span>
<a href="#l36.326"></a><span id="l36.326"> </span>
<a href="#l36.327"></a><span id="l36.327" class="difflineminus">-optgroupObject.prototype.canMoveDown = function canMoveDown()</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineminus">-{</span>
<a href="#l36.329"></a><span id="l36.329" class="difflineplus">+optgroupObject.prototype.canMoveDown = function canMoveDown() {</span>
<a href="#l36.330"></a><span id="l36.330">   return gDialog.lastChild() &gt; treeSelection.currentIndex;</span>
<a href="#l36.331"></a><span id="l36.331" class="difflineminus">-}</span>
<a href="#l36.332"></a><span id="l36.332" class="difflineplus">+};</span>
<a href="#l36.333"></a><span id="l36.333"> </span>
<a href="#l36.334"></a><span id="l36.334" class="difflineminus">-optgroupObject.prototype.moveDown = function moveDown()</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineminus">-{</span>
<a href="#l36.336"></a><span id="l36.336" class="difflineplus">+optgroupObject.prototype.moveDown = function moveDown() {</span>
<a href="#l36.337"></a><span id="l36.337">   // Find the index of the next two elements at the same level</span>
<a href="#l36.338"></a><span id="l36.338">   var index = treeSelection.currentIndex;</span>
<a href="#l36.339"></a><span id="l36.339">   var i = gDialog.nextChild(index);</span>
<a href="#l36.340"></a><span id="l36.340">   var j = gDialog.nextChild(i);</span>
<a href="#l36.341"></a><span id="l36.341">   // Cut out the element, cut the array in two, then join together</span>
<a href="#l36.342"></a><span id="l36.342">   var movedItems = itemArray.splice(i, j - 1);</span>
<a href="#l36.343"></a><span id="l36.343">   var endItems = itemArray.splice(index);</span>
<a href="#l36.344"></a><span id="l36.344">   itemArray = itemArray.concat(movedItems).concat(endItems);</span>
<a href="#l36.345"></a><span id="l36.345">   // Repaint the lot</span>
<a href="#l36.346"></a><span id="l36.346">   theTree.invalidateRange(index, j);</span>
<a href="#l36.347"></a><span id="l36.347">   index += j - i;</span>
<a href="#l36.348"></a><span id="l36.348">   selectTreeIndex(index, true);</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineminus">-}</span>
<a href="#l36.350"></a><span id="l36.350" class="difflineplus">+};</span>
<a href="#l36.351"></a><span id="l36.351"> </span>
<a href="#l36.352"></a><span id="l36.352" class="difflineminus">-optgroupObject.prototype.appendOption = function appendOption(child, parent)</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineminus">-{</span>
<a href="#l36.354"></a><span id="l36.354" class="difflineplus">+optgroupObject.prototype.appendOption = function appendOption(child, parent) {</span>
<a href="#l36.355"></a><span id="l36.355">   var index = gDialog.nextChild(parent);</span>
<a href="#l36.356"></a><span id="l36.356">   // XXX need to repaint the lines, tree won't do this</span>
<a href="#l36.357"></a><span id="l36.357">   var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l36.358"></a><span id="l36.358">   theTree.invalidateCell(index - 1, primaryCol);</span>
<a href="#l36.359"></a><span id="l36.359">   // insert the wrapped object as the last child</span>
<a href="#l36.360"></a><span id="l36.360">   itemArray.splice(index, 0, new optionObject(child, 2));</span>
<a href="#l36.361"></a><span id="l36.361">   theTree.rowCountChanged(index, 1);</span>
<a href="#l36.362"></a><span id="l36.362">   selectTreeIndex(index, false);</span>
<a href="#l36.363"></a><span id="l36.363"> };</span>
<a href="#l36.364"></a><span id="l36.364"> </span>
<a href="#l36.365"></a><span id="l36.365"> // dialog initialization code</span>
<a href="#l36.366"></a><span id="l36.366"> </span>
<a href="#l36.367"></a><span id="l36.367" class="difflineminus">-function Startup()</span>
<a href="#l36.368"></a><span id="l36.368" class="difflineminus">-{</span>
<a href="#l36.369"></a><span id="l36.369" class="difflineplus">+function Startup() {</span>
<a href="#l36.370"></a><span id="l36.370">   var editor = GetCurrentEditor();</span>
<a href="#l36.371"></a><span id="l36.371" class="difflineminus">-  if (!editor)</span>
<a href="#l36.372"></a><span id="l36.372" class="difflineminus">-  {</span>
<a href="#l36.373"></a><span id="l36.373" class="difflineplus">+  if (!editor) {</span>
<a href="#l36.374"></a><span id="l36.374">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l36.375"></a><span id="l36.375">     window.close();</span>
<a href="#l36.376"></a><span id="l36.376">     return;</span>
<a href="#l36.377"></a><span id="l36.377">   }</span>
<a href="#l36.378"></a><span id="l36.378"> </span>
<a href="#l36.379"></a><span id="l36.379">   // Get a single selected select element</span>
<a href="#l36.380"></a><span id="l36.380">   const kTagName = &quot;select&quot;;</span>
<a href="#l36.381"></a><span id="l36.381">   try {</span>
<a href="#l36.382"></a><span id="l36.382">     selectElement = editor.getSelectedElement(kTagName);</span>
<a href="#l36.383"></a><span id="l36.383">   } catch (e) {}</span>
<a href="#l36.384"></a><span id="l36.384"> </span>
<a href="#l36.385"></a><span id="l36.385">   if (selectElement)</span>
<a href="#l36.386"></a><span id="l36.386">     // We found an element and don't need to insert one</span>
<a href="#l36.387"></a><span id="l36.387">     insertNew = false;</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineminus">-  else</span>
<a href="#l36.389"></a><span id="l36.389" class="difflineminus">-  {</span>
<a href="#l36.390"></a><span id="l36.390" class="difflineplus">+  else {</span>
<a href="#l36.391"></a><span id="l36.391">     insertNew = true;</span>
<a href="#l36.392"></a><span id="l36.392"> </span>
<a href="#l36.393"></a><span id="l36.393">     // We don't have an element selected,</span>
<a href="#l36.394"></a><span id="l36.394">     //  so create one with default attributes</span>
<a href="#l36.395"></a><span id="l36.395">     try {</span>
<a href="#l36.396"></a><span id="l36.396">       selectElement = editor.createElementWithDefaults(kTagName);</span>
<a href="#l36.397"></a><span id="l36.397">     } catch (e) {}</span>
<a href="#l36.398"></a><span id="l36.398"> </span>
<a href="#l36.399"></a><span id="l36.399" class="difflineminus">-    if(!selectElement)</span>
<a href="#l36.400"></a><span id="l36.400" class="difflineminus">-    {</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineplus">+    if (!selectElement) {</span>
<a href="#l36.402"></a><span id="l36.402">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l36.403"></a><span id="l36.403">       window.close();</span>
<a href="#l36.404"></a><span id="l36.404">       return;</span>
<a href="#l36.405"></a><span id="l36.405">     }</span>
<a href="#l36.406"></a><span id="l36.406">   }</span>
<a href="#l36.407"></a><span id="l36.407"> </span>
<a href="#l36.408"></a><span id="l36.408">   // SELECT element wrapper object</span>
<a href="#l36.409"></a><span id="l36.409">   gDialog = {</span>
<a href="#l36.410"></a><span id="l36.410" class="difflineat">@@ -391,33 +349,30 @@ function Startup()</span>
<a href="#l36.411"></a><span id="l36.411">     removeButton:     document.getElementById(&quot;RemoveButton&quot;),</span>
<a href="#l36.412"></a><span id="l36.412">     previousButton:   document.getElementById(&quot;PreviousButton&quot;),</span>
<a href="#l36.413"></a><span id="l36.413">     nextButton:       document.getElementById(&quot;NextButton&quot;),</span>
<a href="#l36.414"></a><span id="l36.414">     tree:             document.getElementById(&quot;SelectTree&quot;),</span>
<a href="#l36.415"></a><span id="l36.415">     // wrapper methods (except MoveUp and MoveDown)</span>
<a href="#l36.416"></a><span id="l36.416">     element:          selectElement.cloneNode(false),</span>
<a href="#l36.417"></a><span id="l36.417">     level:            0,</span>
<a href="#l36.418"></a><span id="l36.418">     container:        true,</span>
<a href="#l36.419"></a><span id="l36.419" class="difflineminus">-    getCellText:      function getCellText(column)</span>
<a href="#l36.420"></a><span id="l36.420" class="difflineminus">-    {</span>
<a href="#l36.421"></a><span id="l36.421" class="difflineplus">+    getCellText:      function getCellText(column) {</span>
<a href="#l36.422"></a><span id="l36.422">       return column.id == &quot;SelectTextCol&quot; ? this.element.getAttribute(&quot;name&quot;) : &quot;&quot;;</span>
<a href="#l36.423"></a><span id="l36.423">     },</span>
<a href="#l36.424"></a><span id="l36.424">     cycleCell:        function cycleCell(index) {},</span>
<a href="#l36.425"></a><span id="l36.425" class="difflineminus">-    onFocus:          function onFocus()</span>
<a href="#l36.426"></a><span id="l36.426" class="difflineminus">-    {</span>
<a href="#l36.427"></a><span id="l36.427" class="difflineplus">+    onFocus:          function onFocus() {</span>
<a href="#l36.428"></a><span id="l36.428">       gDialog.selectName.value = this.element.getAttribute(&quot;name&quot;);</span>
<a href="#l36.429"></a><span id="l36.429">       gDialog.selectSize.value = this.element.getAttribute(&quot;size&quot;);</span>
<a href="#l36.430"></a><span id="l36.430">       gDialog.selectMultiple.checked = this.element.hasAttribute(&quot;multiple&quot;);</span>
<a href="#l36.431"></a><span id="l36.431">       gDialog.selectDisabled.checked = this.element.hasAttribute(&quot;disabled&quot;);</span>
<a href="#l36.432"></a><span id="l36.432">       gDialog.selectTabIndex.value = this.element.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l36.433"></a><span id="l36.433">       this.selectDeck.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l36.434"></a><span id="l36.434">       onNameInput();</span>
<a href="#l36.435"></a><span id="l36.435">     },</span>
<a href="#l36.436"></a><span id="l36.436" class="difflineminus">-    onBlur:           function onBlur()</span>
<a href="#l36.437"></a><span id="l36.437" class="difflineminus">-    {</span>
<a href="#l36.438"></a><span id="l36.438" class="difflineplus">+    onBlur:           function onBlur() {</span>
<a href="#l36.439"></a><span id="l36.439">       this.element.setAttribute(&quot;name&quot;, gDialog.selectName.value);</span>
<a href="#l36.440"></a><span id="l36.440">       if (gDialog.selectSize.value)</span>
<a href="#l36.441"></a><span id="l36.441">         this.element.setAttribute(&quot;size&quot;, gDialog.selectSize.value);</span>
<a href="#l36.442"></a><span id="l36.442">       else</span>
<a href="#l36.443"></a><span id="l36.443">         this.element.removeAttribute(&quot;size&quot;);</span>
<a href="#l36.444"></a><span id="l36.444">       if (gDialog.selectMultiple.checked)</span>
<a href="#l36.445"></a><span id="l36.445">         this.element.setAttribute(&quot;multiple&quot;, &quot;&quot;);</span>
<a href="#l36.446"></a><span id="l36.446">       else</span>
<a href="#l36.447"></a><span id="l36.447" class="difflineat">@@ -426,59 +381,52 @@ function Startup()</span>
<a href="#l36.448"></a><span id="l36.448">         this.element.setAttribute(&quot;disabled&quot;, &quot;&quot;);</span>
<a href="#l36.449"></a><span id="l36.449">       else</span>
<a href="#l36.450"></a><span id="l36.450">         this.element.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l36.451"></a><span id="l36.451">       if (gDialog.selectTabIndex.value)</span>
<a href="#l36.452"></a><span id="l36.452">         this.element.setAttribute(&quot;tabindex&quot;, gDialog.selectTabIndex.value);</span>
<a href="#l36.453"></a><span id="l36.453">       else</span>
<a href="#l36.454"></a><span id="l36.454">         this.element.removeAttribute(&quot;tabindex&quot;);</span>
<a href="#l36.455"></a><span id="l36.455">     },</span>
<a href="#l36.456"></a><span id="l36.456" class="difflineminus">-    appendOption:     function appendOption(child, parent)</span>
<a href="#l36.457"></a><span id="l36.457" class="difflineminus">-    {</span>
<a href="#l36.458"></a><span id="l36.458" class="difflineplus">+    appendOption:     function appendOption(child, parent) {</span>
<a href="#l36.459"></a><span id="l36.459">       var index = itemArray.length;</span>
<a href="#l36.460"></a><span id="l36.460">       // XXX need to repaint the lines, tree won't do this</span>
<a href="#l36.461"></a><span id="l36.461">       theTree.invalidateRange(this.lastChild(), index);</span>
<a href="#l36.462"></a><span id="l36.462">       // append the wrapped object</span>
<a href="#l36.463"></a><span id="l36.463">       itemArray.push(new optionObject(child, 1));</span>
<a href="#l36.464"></a><span id="l36.464">       theTree.rowCountChanged(index, 1);</span>
<a href="#l36.465"></a><span id="l36.465">       selectTreeIndex(index, false);</span>
<a href="#l36.466"></a><span id="l36.466">     },</span>
<a href="#l36.467"></a><span id="l36.467" class="difflineminus">-    canDestroy:       function canDestroy(prompt)</span>
<a href="#l36.468"></a><span id="l36.468" class="difflineminus">-    {</span>
<a href="#l36.469"></a><span id="l36.469" class="difflineplus">+    canDestroy:       function canDestroy(prompt) {</span>
<a href="#l36.470"></a><span id="l36.470">       return false;</span>
<a href="#l36.471"></a><span id="l36.471">     },</span>
<a href="#l36.472"></a><span id="l36.472" class="difflineminus">-    canMoveDown:      function canMoveDown()</span>
<a href="#l36.473"></a><span id="l36.473" class="difflineminus">-    {</span>
<a href="#l36.474"></a><span id="l36.474" class="difflineplus">+    canMoveDown:      function canMoveDown() {</span>
<a href="#l36.475"></a><span id="l36.475">       return false;</span>
<a href="#l36.476"></a><span id="l36.476">     },</span>
<a href="#l36.477"></a><span id="l36.477">     // helper methods</span>
<a href="#l36.478"></a><span id="l36.478">     // Find the index of the next immediate child of the select</span>
<a href="#l36.479"></a><span id="l36.479" class="difflineminus">-    nextChild:        function nextChild(index)</span>
<a href="#l36.480"></a><span id="l36.480" class="difflineminus">-    {</span>
<a href="#l36.481"></a><span id="l36.481" class="difflineplus">+    nextChild:        function nextChild(index) {</span>
<a href="#l36.482"></a><span id="l36.482">       while (++index &lt; itemArray.length &amp;&amp; itemArray[index].level &gt; 1);</span>
<a href="#l36.483"></a><span id="l36.483">       return index;</span>
<a href="#l36.484"></a><span id="l36.484">     },</span>
<a href="#l36.485"></a><span id="l36.485">     // Find the index of the last immediate child of the select</span>
<a href="#l36.486"></a><span id="l36.486" class="difflineminus">-    lastChild:        function lastChild()</span>
<a href="#l36.487"></a><span id="l36.487" class="difflineminus">-    {</span>
<a href="#l36.488"></a><span id="l36.488" class="difflineplus">+    lastChild:        function lastChild() {</span>
<a href="#l36.489"></a><span id="l36.489">       var index = itemArray.length;</span>
<a href="#l36.490"></a><span id="l36.490">       while (itemArray[--index].level &gt; 1);</span>
<a href="#l36.491"></a><span id="l36.491">       return index;</span>
<a href="#l36.492"></a><span id="l36.492" class="difflineminus">-    }</span>
<a href="#l36.493"></a><span id="l36.493" class="difflineminus">-  }</span>
<a href="#l36.494"></a><span id="l36.494" class="difflineplus">+    },</span>
<a href="#l36.495"></a><span id="l36.495" class="difflineplus">+  };</span>
<a href="#l36.496"></a><span id="l36.496">   // Start with the &lt;select&gt; wrapper</span>
<a href="#l36.497"></a><span id="l36.497">   itemArray = [gDialog];</span>
<a href="#l36.498"></a><span id="l36.498"> </span>
<a href="#l36.499"></a><span id="l36.499">   // We modify the actual option and optgroup elements so clone them first</span>
<a href="#l36.500"></a><span id="l36.500" class="difflineminus">-  for (var child = selectElement.firstChild; child; child = child.nextSibling)</span>
<a href="#l36.501"></a><span id="l36.501" class="difflineminus">-  {</span>
<a href="#l36.502"></a><span id="l36.502" class="difflineplus">+  for (var child = selectElement.firstChild; child; child = child.nextSibling) {</span>
<a href="#l36.503"></a><span id="l36.503">     if (child.tagName == &quot;OPTION&quot;)</span>
<a href="#l36.504"></a><span id="l36.504">       itemArray.push(new optionObject(child.cloneNode(true), 1));</span>
<a href="#l36.505"></a><span id="l36.505" class="difflineminus">-    else if (child.tagName == &quot;OPTGROUP&quot;)</span>
<a href="#l36.506"></a><span id="l36.506" class="difflineminus">-    {</span>
<a href="#l36.507"></a><span id="l36.507" class="difflineplus">+    else if (child.tagName == &quot;OPTGROUP&quot;) {</span>
<a href="#l36.508"></a><span id="l36.508">       itemArray.push(new optgroupObject(child.cloneNode(false)));</span>
<a href="#l36.509"></a><span id="l36.509">       for (var grandchild = child.firstChild; grandchild; grandchild = grandchild.nextSibling)</span>
<a href="#l36.510"></a><span id="l36.510">         if (grandchild.tagName == &quot;OPTION&quot;)</span>
<a href="#l36.511"></a><span id="l36.511">           itemArray.push(new optionObject(grandchild.cloneNode(true), 2));</span>
<a href="#l36.512"></a><span id="l36.512">     }</span>
<a href="#l36.513"></a><span id="l36.513">   }</span>
<a href="#l36.514"></a><span id="l36.514"> </span>
<a href="#l36.515"></a><span id="l36.515">   UpdateSelectMultiple();</span>
<a href="#l36.516"></a><span id="l36.516" class="difflineat">@@ -490,110 +438,102 @@ function Startup()</span>
<a href="#l36.517"></a><span id="l36.517">                                             &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l36.518"></a><span id="l36.518">     // useful for debugging</span>
<a href="#l36.519"></a><span id="l36.519">     get wrappedJSObject() { return this; },</span>
<a href="#l36.520"></a><span id="l36.520">     get rowCount() { return itemArray.length; },</span>
<a href="#l36.521"></a><span id="l36.521">     get selection() { return treeSelection; },</span>
<a href="#l36.522"></a><span id="l36.522">     set selection(selection) { return treeSelection = selection; },</span>
<a href="#l36.523"></a><span id="l36.523">     getRowProperties: function getRowProperties(index) { return &quot;&quot;; },</span>
<a href="#l36.524"></a><span id="l36.524">     // could have used a wrapper for this</span>
<a href="#l36.525"></a><span id="l36.525" class="difflineminus">-    getCellProperties: function getCellProperties(index, column)</span>
<a href="#l36.526"></a><span id="l36.526" class="difflineminus">-    {</span>
<a href="#l36.527"></a><span id="l36.527" class="difflineplus">+    getCellProperties: function getCellProperties(index, column) {</span>
<a href="#l36.528"></a><span id="l36.528">       if (column.id == &quot;SelectSelCol&quot; &amp;&amp; !itemArray[index].container)</span>
<a href="#l36.529"></a><span id="l36.529">         return &quot;checked-&quot; + itemArray[index].element.hasAttribute(&quot;selected&quot;);</span>
<a href="#l36.530"></a><span id="l36.530">       return &quot;&quot;;</span>
<a href="#l36.531"></a><span id="l36.531">     },</span>
<a href="#l36.532"></a><span id="l36.532">     getColumnProperties: function getColumnProperties(column) { return &quot;&quot;; },</span>
<a href="#l36.533"></a><span id="l36.533">     // get info from wrapper</span>
<a href="#l36.534"></a><span id="l36.534">     isContainer: function isContainer(index) { return itemArray[index].container; },</span>
<a href="#l36.535"></a><span id="l36.535">     isContainerOpen: function isContainerOpen(index) { return true; },</span>
<a href="#l36.536"></a><span id="l36.536">     isContainerEmpty: function isContainerEmpty(index) { return true; },</span>
<a href="#l36.537"></a><span id="l36.537">     isSeparator: function isSeparator(index) { return false; },</span>
<a href="#l36.538"></a><span id="l36.538">     isSorted: function isSorted() { return false; },</span>
<a href="#l36.539"></a><span id="l36.539">     // d&amp;d not implemented yet!</span>
<a href="#l36.540"></a><span id="l36.540">     canDrop: function canDrop(index, orientation) { return false; },</span>
<a href="#l36.541"></a><span id="l36.541" class="difflineminus">-    drop: function drop(index, orientation) { alert('drop:' + index + ',' + orientation); },</span>
<a href="#l36.542"></a><span id="l36.542" class="difflineplus">+    drop: function drop(index, orientation) { alert(&quot;drop:&quot; + index + &quot;,&quot; + orientation); },</span>
<a href="#l36.543"></a><span id="l36.543">     // same as the global helper</span>
<a href="#l36.544"></a><span id="l36.544" class="difflineminus">-    getParentIndex: getParentIndex,</span>
<a href="#l36.545"></a><span id="l36.545" class="difflineplus">+    getParentIndex,</span>
<a href="#l36.546"></a><span id="l36.546">     // tree needs to know when to paint lines</span>
<a href="#l36.547"></a><span id="l36.547" class="difflineminus">-    hasNextSibling: function hasNextSibling(index, after)</span>
<a href="#l36.548"></a><span id="l36.548" class="difflineminus">-    {</span>
<a href="#l36.549"></a><span id="l36.549" class="difflineplus">+    hasNextSibling: function hasNextSibling(index, after) {</span>
<a href="#l36.550"></a><span id="l36.550">       if (!index)</span>
<a href="#l36.551"></a><span id="l36.551">         return false;</span>
<a href="#l36.552"></a><span id="l36.552">       var level = itemArray[index].level;</span>
<a href="#l36.553"></a><span id="l36.553">       while (++after &lt; itemArray.length)</span>
<a href="#l36.554"></a><span id="l36.554" class="difflineminus">-        switch (level - itemArray[after].level)</span>
<a href="#l36.555"></a><span id="l36.555" class="difflineminus">-        {</span>
<a href="#l36.556"></a><span id="l36.556" class="difflineplus">+        switch (level - itemArray[after].level) {</span>
<a href="#l36.557"></a><span id="l36.557">         case 1: return false;</span>
<a href="#l36.558"></a><span id="l36.558">         case 0: return true;</span>
<a href="#l36.559"></a><span id="l36.559">         }</span>
<a href="#l36.560"></a><span id="l36.560">       return false;</span>
<a href="#l36.561"></a><span id="l36.561">     },</span>
<a href="#l36.562"></a><span id="l36.562">     getLevel: function getLevel(index) { return itemArray[index].level; },</span>
<a href="#l36.563"></a><span id="l36.563">     getImageSrc: function getImageSrc(index, column) { },</span>
<a href="#l36.564"></a><span id="l36.564" class="difflineminus">-    getProgressMode : function getProgressMode(index,column) { },</span>
<a href="#l36.565"></a><span id="l36.565" class="difflineplus">+    getProgressMode: function getProgressMode(index, column) { },</span>
<a href="#l36.566"></a><span id="l36.566">     getCellValue: function getCellValue(index, column) { },</span>
<a href="#l36.567"></a><span id="l36.567">     getCellText: function getCellText(index, column) { return itemArray[index].getCellText(column); },</span>
<a href="#l36.568"></a><span id="l36.568">     setTree: function setTree(tree) { this.tree = tree; },</span>
<a href="#l36.569"></a><span id="l36.569">     toggleOpenState: function toggleOpenState(index) { },</span>
<a href="#l36.570"></a><span id="l36.570">     cycleHeader: function cycleHeader(col) { },</span>
<a href="#l36.571"></a><span id="l36.571" class="difflineminus">-    selectionChanged: function selectionChanged()</span>
<a href="#l36.572"></a><span id="l36.572" class="difflineminus">-    {</span>
<a href="#l36.573"></a><span id="l36.573" class="difflineplus">+    selectionChanged: function selectionChanged() {</span>
<a href="#l36.574"></a><span id="l36.574">       // Save current values and update buttons and deck</span>
<a href="#l36.575"></a><span id="l36.575">       if (currentItem)</span>
<a href="#l36.576"></a><span id="l36.576">         currentItem.onBlur();</span>
<a href="#l36.577"></a><span id="l36.577">       var currentIndex = treeSelection.currentIndex;</span>
<a href="#l36.578"></a><span id="l36.578">       currentItem = itemArray[currentIndex];</span>
<a href="#l36.579"></a><span id="l36.579">       gDialog.removeButton.disabled = !currentItem.canDestroy();</span>
<a href="#l36.580"></a><span id="l36.580">       gDialog.previousButton.disabled = currentIndex &lt; 2;</span>
<a href="#l36.581"></a><span id="l36.581">       gDialog.nextButton.disabled = !currentItem.canMoveDown();</span>
<a href="#l36.582"></a><span id="l36.582">       // For Advanced Edit</span>
<a href="#l36.583"></a><span id="l36.583">       globalElement = currentItem.element;</span>
<a href="#l36.584"></a><span id="l36.584">       currentItem.onFocus();</span>
<a href="#l36.585"></a><span id="l36.585">     },</span>
<a href="#l36.586"></a><span id="l36.586">     cycleCell: function cycleCell(index, column) { itemArray[index].cycleCell(index); },</span>
<a href="#l36.587"></a><span id="l36.587">     isEditable: function isEditable(index, column) { return false; },</span>
<a href="#l36.588"></a><span id="l36.588">     performAction: function performAction(action) { },</span>
<a href="#l36.589"></a><span id="l36.589" class="difflineminus">-    performActionOnCell: function performActionOnCell(action, index, column) { }</span>
<a href="#l36.590"></a><span id="l36.590" class="difflineplus">+    performActionOnCell: function performActionOnCell(action, index, column) { },</span>
<a href="#l36.591"></a><span id="l36.591">   };</span>
<a href="#l36.592"></a><span id="l36.592">   treeSelection.select(0);</span>
<a href="#l36.593"></a><span id="l36.593">   currentItem = gDialog;</span>
<a href="#l36.594"></a><span id="l36.594" class="difflineminus">-  //onNameInput();</span>
<a href="#l36.595"></a><span id="l36.595" class="difflineplus">+  // onNameInput();</span>
<a href="#l36.596"></a><span id="l36.596"> </span>
<a href="#l36.597"></a><span id="l36.597">   SetTextboxFocus(gDialog.selectName);</span>
<a href="#l36.598"></a><span id="l36.598"> </span>
<a href="#l36.599"></a><span id="l36.599">   SetWindowLocation();</span>
<a href="#l36.600"></a><span id="l36.600"> }</span>
<a href="#l36.601"></a><span id="l36.601"> </span>
<a href="#l36.602"></a><span id="l36.602"> // Called from Advanced Edit</span>
<a href="#l36.603"></a><span id="l36.603" class="difflineminus">-function InitDialog()</span>
<a href="#l36.604"></a><span id="l36.604" class="difflineminus">-{</span>
<a href="#l36.605"></a><span id="l36.605" class="difflineplus">+function InitDialog() {</span>
<a href="#l36.606"></a><span id="l36.606">   currentItem.onFocus();</span>
<a href="#l36.607"></a><span id="l36.607"> }</span>
<a href="#l36.608"></a><span id="l36.608"> </span>
<a href="#l36.609"></a><span id="l36.609"> // Called from Advanced Edit</span>
<a href="#l36.610"></a><span id="l36.610" class="difflineminus">-function ValidateData()</span>
<a href="#l36.611"></a><span id="l36.611" class="difflineminus">-{</span>
<a href="#l36.612"></a><span id="l36.612" class="difflineplus">+function ValidateData() {</span>
<a href="#l36.613"></a><span id="l36.613">   currentItem.onBlur();</span>
<a href="#l36.614"></a><span id="l36.614">   return true;</span>
<a href="#l36.615"></a><span id="l36.615"> }</span>
<a href="#l36.616"></a><span id="l36.616"> </span>
<a href="#l36.617"></a><span id="l36.617" class="difflineminus">-function onAccept()</span>
<a href="#l36.618"></a><span id="l36.618" class="difflineminus">-{</span>
<a href="#l36.619"></a><span id="l36.619" class="difflineplus">+function onAccept() {</span>
<a href="#l36.620"></a><span id="l36.620">   // All values are valid - copy to actual element in doc or</span>
<a href="#l36.621"></a><span id="l36.621">   //   element created to insert</span>
<a href="#l36.622"></a><span id="l36.622">   ValidateData();</span>
<a href="#l36.623"></a><span id="l36.623"> </span>
<a href="#l36.624"></a><span id="l36.624">   var editor = GetCurrentEditor();</span>
<a href="#l36.625"></a><span id="l36.625"> </span>
<a href="#l36.626"></a><span id="l36.626">   // Coalesce into one undo transaction</span>
<a href="#l36.627"></a><span id="l36.627">   editor.beginTransaction();</span>
<a href="#l36.628"></a><span id="l36.628"> </span>
<a href="#l36.629"></a><span id="l36.629" class="difflineminus">-  try</span>
<a href="#l36.630"></a><span id="l36.630" class="difflineminus">-  {</span>
<a href="#l36.631"></a><span id="l36.631" class="difflineplus">+  try {</span>
<a href="#l36.632"></a><span id="l36.632">     editor.cloneAttributes(selectElement, gDialog.element);</span>
<a href="#l36.633"></a><span id="l36.633"> </span>
<a href="#l36.634"></a><span id="l36.634">     if (insertNew)</span>
<a href="#l36.635"></a><span id="l36.635">       // 'true' means delete the selection before inserting</span>
<a href="#l36.636"></a><span id="l36.636">       editor.insertElementAtSelection(selectElement, true);</span>
<a href="#l36.637"></a><span id="l36.637"> </span>
<a href="#l36.638"></a><span id="l36.638">     editor.setShouldTxnSetSelection(false);</span>
<a href="#l36.639"></a><span id="l36.639"> </span>
<a href="#l36.640"></a><span id="l36.640" class="difflineat">@@ -603,49 +543,43 @@ function onAccept()</span>
<a href="#l36.641"></a><span id="l36.641">     var offset = 0;</span>
<a href="#l36.642"></a><span id="l36.642">     for (var i = 1; i &lt; itemArray.length; i++)</span>
<a href="#l36.643"></a><span id="l36.643">       if (itemArray[i].level &gt; 1)</span>
<a href="#l36.644"></a><span id="l36.644">         selectElement.lastChild.appendChild(itemArray[i].element);</span>
<a href="#l36.645"></a><span id="l36.645">       else</span>
<a href="#l36.646"></a><span id="l36.646">         editor.insertNode(itemArray[i].element, selectElement, offset++, true);</span>
<a href="#l36.647"></a><span id="l36.647"> </span>
<a href="#l36.648"></a><span id="l36.648">     editor.setShouldTxnSetSelection(true);</span>
<a href="#l36.649"></a><span id="l36.649" class="difflineminus">-  }</span>
<a href="#l36.650"></a><span id="l36.650" class="difflineminus">-  finally</span>
<a href="#l36.651"></a><span id="l36.651" class="difflineminus">-  {</span>
<a href="#l36.652"></a><span id="l36.652" class="difflineplus">+  } finally {</span>
<a href="#l36.653"></a><span id="l36.653">     editor.endTransaction();</span>
<a href="#l36.654"></a><span id="l36.654">   }</span>
<a href="#l36.655"></a><span id="l36.655"> </span>
<a href="#l36.656"></a><span id="l36.656">   SaveWindowLocation();</span>
<a href="#l36.657"></a><span id="l36.657"> }</span>
<a href="#l36.658"></a><span id="l36.658"> </span>
<a href="#l36.659"></a><span id="l36.659"> // Button actions</span>
<a href="#l36.660"></a><span id="l36.660" class="difflineminus">-function AddOption()</span>
<a href="#l36.661"></a><span id="l36.661" class="difflineminus">-{</span>
<a href="#l36.662"></a><span id="l36.662" class="difflineplus">+function AddOption() {</span>
<a href="#l36.663"></a><span id="l36.663">   currentItem.appendOption(GetCurrentEditor().createElementWithDefaults(&quot;option&quot;), treeSelection.currentIndex);</span>
<a href="#l36.664"></a><span id="l36.664">   SetTextboxFocus(gDialog.optionText);</span>
<a href="#l36.665"></a><span id="l36.665"> }</span>
<a href="#l36.666"></a><span id="l36.666"> </span>
<a href="#l36.667"></a><span id="l36.667" class="difflineminus">-function AddOptGroup()</span>
<a href="#l36.668"></a><span id="l36.668" class="difflineminus">-{</span>
<a href="#l36.669"></a><span id="l36.669" class="difflineplus">+function AddOptGroup() {</span>
<a href="#l36.670"></a><span id="l36.670">   var optgroupElement = GetCurrentEditor().createElementWithDefaults(&quot;optgroup&quot;);</span>
<a href="#l36.671"></a><span id="l36.671">   var index = itemArray.length;</span>
<a href="#l36.672"></a><span id="l36.672">   // XXX need to repaint the lines, tree won't do this</span>
<a href="#l36.673"></a><span id="l36.673">   theTree.invalidateRange(gDialog.lastChild(), index);</span>
<a href="#l36.674"></a><span id="l36.674">   // append the wrapped object</span>
<a href="#l36.675"></a><span id="l36.675">   itemArray.push(new optgroupObject(optgroupElement));</span>
<a href="#l36.676"></a><span id="l36.676">   theTree.rowCountChanged(index, 1);</span>
<a href="#l36.677"></a><span id="l36.677">   selectTreeIndex(index, false);</span>
<a href="#l36.678"></a><span id="l36.678">   SetTextboxFocus(gDialog.optgroupLabel);</span>
<a href="#l36.679"></a><span id="l36.679"> }</span>
<a href="#l36.680"></a><span id="l36.680"> </span>
<a href="#l36.681"></a><span id="l36.681" class="difflineminus">-function RemoveElement()</span>
<a href="#l36.682"></a><span id="l36.682" class="difflineminus">-{</span>
<a href="#l36.683"></a><span id="l36.683" class="difflineminus">-  if (currentItem.canDestroy(true))</span>
<a href="#l36.684"></a><span id="l36.684" class="difflineminus">-  {</span>
<a href="#l36.685"></a><span id="l36.685" class="difflineplus">+function RemoveElement() {</span>
<a href="#l36.686"></a><span id="l36.686" class="difflineplus">+  if (currentItem.canDestroy(true)) {</span>
<a href="#l36.687"></a><span id="l36.687">     // Only removing empty option groups for now</span>
<a href="#l36.688"></a><span id="l36.688">     var index = treeSelection.currentIndex;</span>
<a href="#l36.689"></a><span id="l36.689">     var level = itemArray[index].level;</span>
<a href="#l36.690"></a><span id="l36.690">     // Perform necessary cleanup and remove the wrapper</span>
<a href="#l36.691"></a><span id="l36.691">     itemArray[index].destroy();</span>
<a href="#l36.692"></a><span id="l36.692">     itemArray.splice(index, 1);</span>
<a href="#l36.693"></a><span id="l36.693">     --index;</span>
<a href="#l36.694"></a><span id="l36.694">     // XXX need to repaint the lines, tree won't do this</span>
<a href="#l36.695"></a><span id="l36.695" class="difflineat">@@ -655,91 +589,78 @@ function RemoveElement()</span>
<a href="#l36.696"></a><span id="l36.696">         theTree.invalidateRange(last, index);</span>
<a href="#l36.697"></a><span id="l36.697">     }</span>
<a href="#l36.698"></a><span id="l36.698">     selectTreeIndex(index, true);</span>
<a href="#l36.699"></a><span id="l36.699">     theTree.rowCountChanged(++index, -1);</span>
<a href="#l36.700"></a><span id="l36.700">   }</span>
<a href="#l36.701"></a><span id="l36.701"> }</span>
<a href="#l36.702"></a><span id="l36.702"> </span>
<a href="#l36.703"></a><span id="l36.703"> // Event handler</span>
<a href="#l36.704"></a><span id="l36.704" class="difflineminus">-function onTreeKeyUp(event)</span>
<a href="#l36.705"></a><span id="l36.705" class="difflineminus">-{</span>
<a href="#l36.706"></a><span id="l36.706" class="difflineplus">+function onTreeKeyUp(event) {</span>
<a href="#l36.707"></a><span id="l36.707">   if (event.keyCode == event.DOM_VK_SPACE)</span>
<a href="#l36.708"></a><span id="l36.708">     currentItem.cycleCell();</span>
<a href="#l36.709"></a><span id="l36.709"> }</span>
<a href="#l36.710"></a><span id="l36.710"> </span>
<a href="#l36.711"></a><span id="l36.711" class="difflineminus">-function onNameInput()</span>
<a href="#l36.712"></a><span id="l36.712" class="difflineminus">-{</span>
<a href="#l36.713"></a><span id="l36.713" class="difflineplus">+function onNameInput() {</span>
<a href="#l36.714"></a><span id="l36.714">   var disabled = !gDialog.selectName.value;</span>
<a href="#l36.715"></a><span id="l36.715">   if (gDialog.accept.disabled != disabled)</span>
<a href="#l36.716"></a><span id="l36.716">     gDialog.accept.disabled = disabled;</span>
<a href="#l36.717"></a><span id="l36.717">   gDialog.element.setAttribute(&quot;name&quot;, gDialog.selectName.value);</span>
<a href="#l36.718"></a><span id="l36.718">   // repaint the tree</span>
<a href="#l36.719"></a><span id="l36.719">   var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l36.720"></a><span id="l36.720">   theTree.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l36.721"></a><span id="l36.721"> }</span>
<a href="#l36.722"></a><span id="l36.722"> </span>
<a href="#l36.723"></a><span id="l36.723" class="difflineminus">-function onLabelInput()</span>
<a href="#l36.724"></a><span id="l36.724" class="difflineminus">-{</span>
<a href="#l36.725"></a><span id="l36.725" class="difflineplus">+function onLabelInput() {</span>
<a href="#l36.726"></a><span id="l36.726">   currentItem.element.setAttribute(&quot;label&quot;, gDialog.optgroupLabel.value);</span>
<a href="#l36.727"></a><span id="l36.727">   // repaint the tree</span>
<a href="#l36.728"></a><span id="l36.728">   var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l36.729"></a><span id="l36.729">   theTree.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l36.730"></a><span id="l36.730"> }</span>
<a href="#l36.731"></a><span id="l36.731"> </span>
<a href="#l36.732"></a><span id="l36.732" class="difflineminus">-function onTextInput()</span>
<a href="#l36.733"></a><span id="l36.733" class="difflineminus">-{</span>
<a href="#l36.734"></a><span id="l36.734" class="difflineplus">+function onTextInput() {</span>
<a href="#l36.735"></a><span id="l36.735">   currentItem.element.text = gDialog.optionText.value;</span>
<a href="#l36.736"></a><span id="l36.736">   // repaint the tree</span>
<a href="#l36.737"></a><span id="l36.737">   if (hasValue) {</span>
<a href="#l36.738"></a><span id="l36.738">     var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l36.739"></a><span id="l36.739">     theTree.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l36.740"></a><span id="l36.740" class="difflineminus">-  }</span>
<a href="#l36.741"></a><span id="l36.741" class="difflineminus">-  else</span>
<a href="#l36.742"></a><span id="l36.742" class="difflineminus">-  {</span>
<a href="#l36.743"></a><span id="l36.743" class="difflineplus">+  } else {</span>
<a href="#l36.744"></a><span id="l36.744">     gDialog.optionValue.value = gDialog.optionText.value;</span>
<a href="#l36.745"></a><span id="l36.745">     theTree.invalidateRow(treeSelection.currentIndex);</span>
<a href="#l36.746"></a><span id="l36.746">   }</span>
<a href="#l36.747"></a><span id="l36.747"> }</span>
<a href="#l36.748"></a><span id="l36.748"> </span>
<a href="#l36.749"></a><span id="l36.749" class="difflineminus">-function onValueInput()</span>
<a href="#l36.750"></a><span id="l36.750" class="difflineminus">-{</span>
<a href="#l36.751"></a><span id="l36.751" class="difflineplus">+function onValueInput() {</span>
<a href="#l36.752"></a><span id="l36.752">   gDialog.optionHasValue.checked = hasValue = true;</span>
<a href="#l36.753"></a><span id="l36.753">   oldValue = gDialog.optionValue.value;</span>
<a href="#l36.754"></a><span id="l36.754">   currentItem.element.setAttribute(&quot;value&quot;, oldValue);</span>
<a href="#l36.755"></a><span id="l36.755">   // repaint the tree</span>
<a href="#l36.756"></a><span id="l36.756" class="difflineminus">-  var column = theTree.columns[&quot;SelectValCol&quot;];</span>
<a href="#l36.757"></a><span id="l36.757" class="difflineplus">+  var column = theTree.columns.SelectValCol;</span>
<a href="#l36.758"></a><span id="l36.758">   theTree.invalidateCell(treeSelection.currentIndex, column);</span>
<a href="#l36.759"></a><span id="l36.759"> }</span>
<a href="#l36.760"></a><span id="l36.760"> </span>
<a href="#l36.761"></a><span id="l36.761" class="difflineminus">-function onHasValueClick()</span>
<a href="#l36.762"></a><span id="l36.762" class="difflineminus">-{</span>
<a href="#l36.763"></a><span id="l36.763" class="difflineplus">+function onHasValueClick() {</span>
<a href="#l36.764"></a><span id="l36.764">   hasValue = gDialog.optionHasValue.checked;</span>
<a href="#l36.765"></a><span id="l36.765" class="difflineminus">-  if (hasValue)</span>
<a href="#l36.766"></a><span id="l36.766" class="difflineminus">-  {</span>
<a href="#l36.767"></a><span id="l36.767" class="difflineplus">+  if (hasValue) {</span>
<a href="#l36.768"></a><span id="l36.768">     gDialog.optionValue.value = oldValue;</span>
<a href="#l36.769"></a><span id="l36.769">     currentItem.element.setAttribute(&quot;value&quot;, oldValue);</span>
<a href="#l36.770"></a><span id="l36.770" class="difflineminus">-  }</span>
<a href="#l36.771"></a><span id="l36.771" class="difflineminus">-  else</span>
<a href="#l36.772"></a><span id="l36.772" class="difflineminus">-  {</span>
<a href="#l36.773"></a><span id="l36.773" class="difflineplus">+  } else {</span>
<a href="#l36.774"></a><span id="l36.774">     oldValue = gDialog.optionValue.value;</span>
<a href="#l36.775"></a><span id="l36.775">     gDialog.optionValue.value = gDialog.optionText.value;</span>
<a href="#l36.776"></a><span id="l36.776">     currentItem.element.removeAttribute(&quot;value&quot;);</span>
<a href="#l36.777"></a><span id="l36.777">   }</span>
<a href="#l36.778"></a><span id="l36.778">   // repaint the tree</span>
<a href="#l36.779"></a><span id="l36.779" class="difflineminus">-  var column = theTree.columns[&quot;SelectValCol&quot;];</span>
<a href="#l36.780"></a><span id="l36.780" class="difflineplus">+  var column = theTree.columns.SelectValCol;</span>
<a href="#l36.781"></a><span id="l36.781">   theTree.invalidateCell(treeSelection.currentIndex, column);</span>
<a href="#l36.782"></a><span id="l36.782"> }</span>
<a href="#l36.783"></a><span id="l36.783"> </span>
<a href="#l36.784"></a><span id="l36.784" class="difflineminus">-function onSelectMultipleClick()</span>
<a href="#l36.785"></a><span id="l36.785" class="difflineminus">-{</span>
<a href="#l36.786"></a><span id="l36.786" class="difflineplus">+function onSelectMultipleClick() {</span>
<a href="#l36.787"></a><span id="l36.787">   // Recalculate the unique selected option if we need it and have lost it</span>
<a href="#l36.788"></a><span id="l36.788">   if (!gDialog.selectMultiple.checked &amp;&amp; selectedOptionCount == 1 &amp;&amp; !selectedOption)</span>
<a href="#l36.789"></a><span id="l36.789">     for (var i = 1; !(selectedOption = itemArray[i].element).hasAttribute(&quot;selected&quot;); i++);</span>
<a href="#l36.790"></a><span id="l36.790"> }</span>
<a href="#l36.791"></a><span id="l36.791"> </span>
<a href="#l36.792"></a><span id="l36.792" class="difflineminus">-function selectTreeIndex(index, focus)</span>
<a href="#l36.793"></a><span id="l36.793" class="difflineminus">-{</span>
<a href="#l36.794"></a><span id="l36.794" class="difflineplus">+function selectTreeIndex(index, focus) {</span>
<a href="#l36.795"></a><span id="l36.795">   treeSelection.select(index);</span>
<a href="#l36.796"></a><span id="l36.796">   theTree.ensureRowIsVisible(index);</span>
<a href="#l36.797"></a><span id="l36.797">   if (focus)</span>
<a href="#l36.798"></a><span id="l36.798">     gDialog.tree.focus();</span>
<a href="#l36.799"></a><span id="l36.799"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdSpellCheck.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdSpellCheck.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -11,47 +11,43 @@ var gAllowSelectWord = true;</span>
<a href="#l37.4"></a><span id="l37.4"> var gPreviousReplaceWord = &quot;&quot;;</span>
<a href="#l37.5"></a><span id="l37.5"> var gFirstTime = true;</span>
<a href="#l37.6"></a><span id="l37.6"> var gLastSelectedLang = null;</span>
<a href="#l37.7"></a><span id="l37.7"> var gDictCount = 0;</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9"> document.addEventListener(&quot;dialogaccept&quot;, doDefault);</span>
<a href="#l37.10"></a><span id="l37.10"> document.addEventListener(&quot;dialogcancel&quot;, CancelSpellCheck);</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-function Startup()</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-{</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+function Startup() {</span>
<a href="#l37.15"></a><span id="l37.15">   var editor = GetCurrentEditor();</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-  if (!editor)</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineminus">-  {</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l37.19"></a><span id="l37.19">     window.close();</span>
<a href="#l37.20"></a><span id="l37.20">     return;</span>
<a href="#l37.21"></a><span id="l37.21">   }</span>
<a href="#l37.22"></a><span id="l37.22"> </span>
<a href="#l37.23"></a><span id="l37.23">   // Get the spellChecker shell</span>
<a href="#l37.24"></a><span id="l37.24">   gSpellChecker = Cu.createSpellChecker();</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-  if (!gSpellChecker)</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-  {</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+  if (!gSpellChecker) {</span>
<a href="#l37.28"></a><span id="l37.28">     dump(&quot;SpellChecker not found!!!\n&quot;);</span>
<a href="#l37.29"></a><span id="l37.29">     window.close();</span>
<a href="#l37.30"></a><span id="l37.30">     return;</span>
<a href="#l37.31"></a><span id="l37.31">   }</span>
<a href="#l37.32"></a><span id="l37.32"> </span>
<a href="#l37.33"></a><span id="l37.33">   // Start the spell checker module.</span>
<a href="#l37.34"></a><span id="l37.34">   try {</span>
<a href="#l37.35"></a><span id="l37.35">     var skipBlockQuotes = window.arguments[1];</span>
<a href="#l37.36"></a><span id="l37.36">     var enableSelectionChecking = window.arguments[2];</span>
<a href="#l37.37"></a><span id="l37.37"> </span>
<a href="#l37.38"></a><span id="l37.38">     gSpellChecker.setFilterType(skipBlockQuotes ?</span>
<a href="#l37.39"></a><span id="l37.39">                                 Ci.nsIEditorSpellCheck.FILTERTYPE_MAIL :</span>
<a href="#l37.40"></a><span id="l37.40">                                 Ci.nsIEditorSpellCheck.FILTERTYPE_NORMAL);</span>
<a href="#l37.41"></a><span id="l37.41">     gSpellChecker.InitSpellChecker(editor, enableSelectionChecking, spellCheckStarted);</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineminus">-  } catch(ex) {</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+  } catch (ex) {</span>
<a href="#l37.44"></a><span id="l37.44">     dump(&quot;*** Exception error: InitSpellChecker\n&quot;);</span>
<a href="#l37.45"></a><span id="l37.45">     window.close();</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-    return;</span>
<a href="#l37.47"></a><span id="l37.47">   }</span>
<a href="#l37.48"></a><span id="l37.48"> }</span>
<a href="#l37.49"></a><span id="l37.49"> </span>
<a href="#l37.50"></a><span id="l37.50"> function spellCheckStarted() {</span>
<a href="#l37.51"></a><span id="l37.51">   gDialog.MisspelledWordLabel = document.getElementById(&quot;MisspelledWordLabel&quot;);</span>
<a href="#l37.52"></a><span id="l37.52">   gDialog.MisspelledWord      = document.getElementById(&quot;MisspelledWord&quot;);</span>
<a href="#l37.53"></a><span id="l37.53">   gDialog.ReplaceButton       = document.getElementById(&quot;Replace&quot;);</span>
<a href="#l37.54"></a><span id="l37.54">   gDialog.IgnoreButton        = document.getElementById(&quot;Ignore&quot;);</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineat">@@ -63,72 +59,63 @@ function spellCheckStarted() {</span>
<a href="#l37.56"></a><span id="l37.56"> </span>
<a href="#l37.57"></a><span id="l37.57">   // Fill in the language menulist and sync it up</span>
<a href="#l37.58"></a><span id="l37.58">   // with the spellchecker's current language.</span>
<a href="#l37.59"></a><span id="l37.59"> </span>
<a href="#l37.60"></a><span id="l37.60">   var curLang;</span>
<a href="#l37.61"></a><span id="l37.61"> </span>
<a href="#l37.62"></a><span id="l37.62">   try {</span>
<a href="#l37.63"></a><span id="l37.63">     curLang = gSpellChecker.GetCurrentDictionary();</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineminus">-  } catch(ex) {</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+  } catch (ex) {</span>
<a href="#l37.66"></a><span id="l37.66">     curLang = &quot;&quot;;</span>
<a href="#l37.67"></a><span id="l37.67">   }</span>
<a href="#l37.68"></a><span id="l37.68"> </span>
<a href="#l37.69"></a><span id="l37.69">   InitLanguageMenu(curLang);</span>
<a href="#l37.70"></a><span id="l37.70"> </span>
<a href="#l37.71"></a><span id="l37.71">   // Get the first misspelled word and setup all UI</span>
<a href="#l37.72"></a><span id="l37.72">   NextWord();</span>
<a href="#l37.73"></a><span id="l37.73"> </span>
<a href="#l37.74"></a><span id="l37.74">   // When startup param is true, setup different UI when spell checking</span>
<a href="#l37.75"></a><span id="l37.75">   //   just before sending mail message</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineminus">-  if (window.arguments[0])</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineminus">-  {</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+  if (window.arguments[0]) {</span>
<a href="#l37.79"></a><span id="l37.79">     // If no misspelled words found, simply close dialog and send message</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineminus">-    if (!gMisspelledWord)</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineminus">-    {</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+    if (!gMisspelledWord) {</span>
<a href="#l37.83"></a><span id="l37.83">       onClose();</span>
<a href="#l37.84"></a><span id="l37.84">       return;</span>
<a href="#l37.85"></a><span id="l37.85">     }</span>
<a href="#l37.86"></a><span id="l37.86"> </span>
<a href="#l37.87"></a><span id="l37.87">     // Hide &quot;Close&quot; button and use &quot;Send&quot; instead</span>
<a href="#l37.88"></a><span id="l37.88">     gDialog.CloseButton.hidden = true;</span>
<a href="#l37.89"></a><span id="l37.89">     gDialog.CloseButton = document.getElementById(&quot;Send&quot;);</span>
<a href="#l37.90"></a><span id="l37.90">     gDialog.CloseButton.hidden = false;</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineminus">-  }</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineminus">-  else</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineminus">-  {</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+  } else {</span>
<a href="#l37.95"></a><span id="l37.95">     // Normal spell checking - hide the &quot;Stop&quot; button</span>
<a href="#l37.96"></a><span id="l37.96">     // (Note that this button is the &quot;Cancel&quot; button for</span>
<a href="#l37.97"></a><span id="l37.97">     //  Esc keybinding and related window close actions)</span>
<a href="#l37.98"></a><span id="l37.98">     gDialog.StopButton.hidden = true;</span>
<a href="#l37.99"></a><span id="l37.99">   }</span>
<a href="#l37.100"></a><span id="l37.100"> </span>
<a href="#l37.101"></a><span id="l37.101">   // Clear flag that determines message when</span>
<a href="#l37.102"></a><span id="l37.102">   //  no misspelled word is found</span>
<a href="#l37.103"></a><span id="l37.103">   //  (different message when used for the first time)</span>
<a href="#l37.104"></a><span id="l37.104">   gFirstTime = false;</span>
<a href="#l37.105"></a><span id="l37.105"> </span>
<a href="#l37.106"></a><span id="l37.106">   window.sizeToContent();</span>
<a href="#l37.107"></a><span id="l37.107"> }</span>
<a href="#l37.108"></a><span id="l37.108"> </span>
<a href="#l37.109"></a><span id="l37.109" class="difflineminus">-function InitLanguageMenu(aCurLang)</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineminus">-{</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineminus">-</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineplus">+function InitLanguageMenu(aCurLang) {</span>
<a href="#l37.113"></a><span id="l37.113">   var o1 = {};</span>
<a href="#l37.114"></a><span id="l37.114">   var o2 = {};</span>
<a href="#l37.115"></a><span id="l37.115"> </span>
<a href="#l37.116"></a><span id="l37.116">   // Get the list of dictionaries from</span>
<a href="#l37.117"></a><span id="l37.117">   // the spellchecker.</span>
<a href="#l37.118"></a><span id="l37.118"> </span>
<a href="#l37.119"></a><span id="l37.119" class="difflineminus">-  try</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineminus">-  {</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineplus">+  try {</span>
<a href="#l37.122"></a><span id="l37.122">     gSpellChecker.GetDictionaryList(o1, o2);</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-  }</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineminus">-  catch(ex)</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-  {</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+  } catch (ex) {</span>
<a href="#l37.127"></a><span id="l37.127">     dump(&quot;Failed to get DictionaryList!\n&quot;);</span>
<a href="#l37.128"></a><span id="l37.128">     return;</span>
<a href="#l37.129"></a><span id="l37.129">   }</span>
<a href="#l37.130"></a><span id="l37.130"> </span>
<a href="#l37.131"></a><span id="l37.131">   var dictList = o1.value;</span>
<a href="#l37.132"></a><span id="l37.132">   var count    = o2.value;</span>
<a href="#l37.133"></a><span id="l37.133"> </span>
<a href="#l37.134"></a><span id="l37.134">   // If we're not just starting up and dictionary count</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineat">@@ -144,47 +131,43 @@ function InitLanguageMenu(aCurLang)</span>
<a href="#l37.136"></a><span id="l37.136"> </span>
<a href="#l37.137"></a><span id="l37.137">   // Remove any languages from the list.</span>
<a href="#l37.138"></a><span id="l37.138">   var languageMenuPopup = gDialog.LanguageMenulist.menupopup;</span>
<a href="#l37.139"></a><span id="l37.139">   while (languageMenuPopup.firstChild.localName != &quot;menuseparator&quot;)</span>
<a href="#l37.140"></a><span id="l37.140">     languageMenuPopup.firstChild.remove();</span>
<a href="#l37.141"></a><span id="l37.141"> </span>
<a href="#l37.142"></a><span id="l37.142">   var defaultItem = null;</span>
<a href="#l37.143"></a><span id="l37.143"> </span>
<a href="#l37.144"></a><span id="l37.144" class="difflineminus">-  for (var i = 0; i &lt; count; i++)</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineminus">-  {</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+  for (var i = 0; i &lt; count; i++) {</span>
<a href="#l37.147"></a><span id="l37.147">     let item = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;menuitem&quot;);</span>
<a href="#l37.148"></a><span id="l37.148">     item.setAttribute(&quot;label&quot;, sortedList[i].displayName);</span>
<a href="#l37.149"></a><span id="l37.149">     item.setAttribute(&quot;value&quot;, sortedList[i].localeCode);</span>
<a href="#l37.150"></a><span id="l37.150">     let beforeItem = gDialog.LanguageMenulist.getItemAtIndex(i);</span>
<a href="#l37.151"></a><span id="l37.151">     languageMenuPopup.insertBefore(item, beforeItem);</span>
<a href="#l37.152"></a><span id="l37.152"> </span>
<a href="#l37.153"></a><span id="l37.153">     if (aCurLang &amp;&amp; sortedList[i].localeCode == aCurLang)</span>
<a href="#l37.154"></a><span id="l37.154">       defaultItem = item;</span>
<a href="#l37.155"></a><span id="l37.155">   }</span>
<a href="#l37.156"></a><span id="l37.156"> </span>
<a href="#l37.157"></a><span id="l37.157">   // Now make sure the correct item in the menu list is selected.</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineminus">-  if (defaultItem)</span>
<a href="#l37.159"></a><span id="l37.159" class="difflineminus">-  {</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineplus">+  if (defaultItem) {</span>
<a href="#l37.161"></a><span id="l37.161">     gDialog.LanguageMenulist.selectedItem = defaultItem;</span>
<a href="#l37.162"></a><span id="l37.162">     gLastSelectedLang = defaultItem;</span>
<a href="#l37.163"></a><span id="l37.163">   }</span>
<a href="#l37.164"></a><span id="l37.164"> }</span>
<a href="#l37.165"></a><span id="l37.165"> </span>
<a href="#l37.166"></a><span id="l37.166" class="difflineminus">-function DoEnabling()</span>
<a href="#l37.167"></a><span id="l37.167" class="difflineminus">-{</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineminus">-  if (!gMisspelledWord)</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineminus">-  {</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineplus">+function DoEnabling() {</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineplus">+  if (!gMisspelledWord) {</span>
<a href="#l37.172"></a><span id="l37.172">     // No more misspelled words</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineminus">-    gDialog.MisspelledWord.setAttribute(&quot;value&quot;,GetString( gFirstTime ? &quot;NoMisspelledWord&quot; : &quot;CheckSpellingDone&quot;));</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+    gDialog.MisspelledWord.setAttribute(&quot;value&quot;, GetString(gFirstTime ? &quot;NoMisspelledWord&quot; : &quot;CheckSpellingDone&quot;));</span>
<a href="#l37.175"></a><span id="l37.175"> </span>
<a href="#l37.176"></a><span id="l37.176">     gDialog.ReplaceButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l37.177"></a><span id="l37.177">     gDialog.IgnoreButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l37.178"></a><span id="l37.178"> </span>
<a href="#l37.179"></a><span id="l37.179" class="difflineminus">-    gDialog.CloseButton.setAttribute(&quot;default&quot;,&quot;true&quot;);</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+    gDialog.CloseButton.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l37.181"></a><span id="l37.181">     // Shouldn't have to do this if &quot;default&quot; is true?</span>
<a href="#l37.182"></a><span id="l37.182">     gDialog.CloseButton.focus();</span>
<a href="#l37.183"></a><span id="l37.183"> </span>
<a href="#l37.184"></a><span id="l37.184">     SetElementEnabledById(&quot;MisspelledWordLabel&quot;, false);</span>
<a href="#l37.185"></a><span id="l37.185">     SetElementEnabledById(&quot;ReplaceWordLabel&quot;, false);</span>
<a href="#l37.186"></a><span id="l37.186">     SetElementEnabledById(&quot;ReplaceWordInput&quot;, false);</span>
<a href="#l37.187"></a><span id="l37.187">     SetElementEnabledById(&quot;CheckWord&quot;, false);</span>
<a href="#l37.188"></a><span id="l37.188">     SetElementEnabledById(&quot;SuggestedListLabel&quot;, false);</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineat">@@ -205,323 +188,278 @@ function DoEnabling()</span>
<a href="#l37.190"></a><span id="l37.190">     SetElementEnabledById(&quot;IgnoreAll&quot;, true);</span>
<a href="#l37.191"></a><span id="l37.191">     SetElementEnabledById(&quot;AddToDictionary&quot;, true);</span>
<a href="#l37.192"></a><span id="l37.192"> </span>
<a href="#l37.193"></a><span id="l37.193">     gDialog.CloseButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l37.194"></a><span id="l37.194">     SetReplaceEnable();</span>
<a href="#l37.195"></a><span id="l37.195">   }</span>
<a href="#l37.196"></a><span id="l37.196"> }</span>
<a href="#l37.197"></a><span id="l37.197"> </span>
<a href="#l37.198"></a><span id="l37.198" class="difflineminus">-function NextWord()</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineminus">-{</span>
<a href="#l37.200"></a><span id="l37.200" class="difflineplus">+function NextWord() {</span>
<a href="#l37.201"></a><span id="l37.201">   gMisspelledWord = gSpellChecker.GetNextMisspelledWord();</span>
<a href="#l37.202"></a><span id="l37.202">   SetWidgetsForMisspelledWord();</span>
<a href="#l37.203"></a><span id="l37.203"> }</span>
<a href="#l37.204"></a><span id="l37.204"> </span>
<a href="#l37.205"></a><span id="l37.205" class="difflineminus">-function SetWidgetsForMisspelledWord()</span>
<a href="#l37.206"></a><span id="l37.206" class="difflineminus">-{</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineplus">+function SetWidgetsForMisspelledWord() {</span>
<a href="#l37.208"></a><span id="l37.208">   gDialog.MisspelledWord.setAttribute(&quot;value&quot;, gMisspelledWord);</span>
<a href="#l37.209"></a><span id="l37.209"> </span>
<a href="#l37.210"></a><span id="l37.210"> </span>
<a href="#l37.211"></a><span id="l37.211">   // Initial replace word is misspelled word</span>
<a href="#l37.212"></a><span id="l37.212">   gDialog.ReplaceWordInput.value = gMisspelledWord;</span>
<a href="#l37.213"></a><span id="l37.213">   gPreviousReplaceWord = gMisspelledWord;</span>
<a href="#l37.214"></a><span id="l37.214"> </span>
<a href="#l37.215"></a><span id="l37.215">   // This sets gDialog.ReplaceWordInput to first suggested word in list</span>
<a href="#l37.216"></a><span id="l37.216">   FillSuggestedList(gMisspelledWord);</span>
<a href="#l37.217"></a><span id="l37.217"> </span>
<a href="#l37.218"></a><span id="l37.218">   DoEnabling();</span>
<a href="#l37.219"></a><span id="l37.219"> </span>
<a href="#l37.220"></a><span id="l37.220">   if (gMisspelledWord)</span>
<a href="#l37.221"></a><span id="l37.221">     SetTextboxFocus(gDialog.ReplaceWordInput);</span>
<a href="#l37.222"></a><span id="l37.222"> }</span>
<a href="#l37.223"></a><span id="l37.223"> </span>
<a href="#l37.224"></a><span id="l37.224" class="difflineminus">-function CheckWord()</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineminus">-{</span>
<a href="#l37.226"></a><span id="l37.226" class="difflineplus">+function CheckWord() {</span>
<a href="#l37.227"></a><span id="l37.227">   var word = gDialog.ReplaceWordInput.value;</span>
<a href="#l37.228"></a><span id="l37.228" class="difflineminus">-  if (word)</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineminus">-  {</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineminus">-    if (gSpellChecker.CheckCurrentWord(word))</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineminus">-    {</span>
<a href="#l37.232"></a><span id="l37.232" class="difflineplus">+  if (word) {</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineplus">+    if (gSpellChecker.CheckCurrentWord(word)) {</span>
<a href="#l37.234"></a><span id="l37.234">       FillSuggestedList(word);</span>
<a href="#l37.235"></a><span id="l37.235">       SetReplaceEnable();</span>
<a href="#l37.236"></a><span id="l37.236" class="difflineminus">-    }</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineminus">-    else</span>
<a href="#l37.238"></a><span id="l37.238" class="difflineminus">-    {</span>
<a href="#l37.239"></a><span id="l37.239" class="difflineplus">+    } else {</span>
<a href="#l37.240"></a><span id="l37.240">       ClearListbox(gDialog.SuggestedList);</span>
<a href="#l37.241"></a><span id="l37.241">       var item = gDialog.SuggestedList.appendItem(GetString(&quot;CorrectSpelling&quot;), &quot;&quot;);</span>
<a href="#l37.242"></a><span id="l37.242">       if (item) item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l37.243"></a><span id="l37.243">       // Suppress being able to select the message text</span>
<a href="#l37.244"></a><span id="l37.244">       gAllowSelectWord = false;</span>
<a href="#l37.245"></a><span id="l37.245">     }</span>
<a href="#l37.246"></a><span id="l37.246">   }</span>
<a href="#l37.247"></a><span id="l37.247"> }</span>
<a href="#l37.248"></a><span id="l37.248"> </span>
<a href="#l37.249"></a><span id="l37.249" class="difflineminus">-function SelectSuggestedWord()</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineminus">-{</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineminus">-  if (gAllowSelectWord)</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineminus">-  {</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineminus">-    var selectedItem</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineminus">-    if (gDialog.SuggestedList.selectedItem)</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineminus">-    {</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineplus">+function SelectSuggestedWord() {</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineplus">+  if (gAllowSelectWord) {</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineplus">+    var selectedItem;</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineplus">+    if (gDialog.SuggestedList.selectedItem) {</span>
<a href="#l37.260"></a><span id="l37.260">       var selValue = gDialog.SuggestedList.selectedItem.label;</span>
<a href="#l37.261"></a><span id="l37.261">       gDialog.ReplaceWordInput.value = selValue;</span>
<a href="#l37.262"></a><span id="l37.262">       gPreviousReplaceWord = selValue;</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineminus">-    }</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineminus">-    else</span>
<a href="#l37.265"></a><span id="l37.265" class="difflineminus">-    {</span>
<a href="#l37.266"></a><span id="l37.266" class="difflineplus">+    } else {</span>
<a href="#l37.267"></a><span id="l37.267">       gDialog.ReplaceWordInput.value = gPreviousReplaceWord;</span>
<a href="#l37.268"></a><span id="l37.268">     }</span>
<a href="#l37.269"></a><span id="l37.269">     SetReplaceEnable();</span>
<a href="#l37.270"></a><span id="l37.270">   }</span>
<a href="#l37.271"></a><span id="l37.271"> }</span>
<a href="#l37.272"></a><span id="l37.272"> </span>
<a href="#l37.273"></a><span id="l37.273" class="difflineminus">-function ChangeReplaceWord()</span>
<a href="#l37.274"></a><span id="l37.274" class="difflineminus">-{</span>
<a href="#l37.275"></a><span id="l37.275" class="difflineplus">+function ChangeReplaceWord() {</span>
<a href="#l37.276"></a><span id="l37.276">   // Calling this triggers SelectSuggestedWord(),</span>
<a href="#l37.277"></a><span id="l37.277">   //  so temporarily suppress the effect of that</span>
<a href="#l37.278"></a><span id="l37.278">   var saveAllow = gAllowSelectWord;</span>
<a href="#l37.279"></a><span id="l37.279">   gAllowSelectWord = false;</span>
<a href="#l37.280"></a><span id="l37.280"> </span>
<a href="#l37.281"></a><span id="l37.281">   // Select matching word in list</span>
<a href="#l37.282"></a><span id="l37.282">   var newIndex = -1;</span>
<a href="#l37.283"></a><span id="l37.283">   var newSelectedItem;</span>
<a href="#l37.284"></a><span id="l37.284">   var replaceWord = TrimString(gDialog.ReplaceWordInput.value);</span>
<a href="#l37.285"></a><span id="l37.285" class="difflineminus">-  if (replaceWord)</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineminus">-  {</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineminus">-    for (var i = 0; i &lt; gDialog.SuggestedList.getRowCount(); i++)</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineminus">-    {</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineplus">+  if (replaceWord) {</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+    for (var i = 0; i &lt; gDialog.SuggestedList.getRowCount(); i++) {</span>
<a href="#l37.291"></a><span id="l37.291">       var item = gDialog.SuggestedList.getItemAtIndex(i);</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineminus">-      if (item.label == replaceWord)</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineminus">-      {</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineplus">+      if (item.label == replaceWord) {</span>
<a href="#l37.295"></a><span id="l37.295">         newSelectedItem = item;</span>
<a href="#l37.296"></a><span id="l37.296">         break;</span>
<a href="#l37.297"></a><span id="l37.297">       }</span>
<a href="#l37.298"></a><span id="l37.298">     }</span>
<a href="#l37.299"></a><span id="l37.299">   }</span>
<a href="#l37.300"></a><span id="l37.300">   gDialog.SuggestedList.selectedItem = newSelectedItem;</span>
<a href="#l37.301"></a><span id="l37.301"> </span>
<a href="#l37.302"></a><span id="l37.302">   gAllowSelectWord = saveAllow;</span>
<a href="#l37.303"></a><span id="l37.303"> </span>
<a href="#l37.304"></a><span id="l37.304">   // Remember the new word</span>
<a href="#l37.305"></a><span id="l37.305">   gPreviousReplaceWord = gDialog.ReplaceWordInput.value;</span>
<a href="#l37.306"></a><span id="l37.306"> </span>
<a href="#l37.307"></a><span id="l37.307">   SetReplaceEnable();</span>
<a href="#l37.308"></a><span id="l37.308"> }</span>
<a href="#l37.309"></a><span id="l37.309"> </span>
<a href="#l37.310"></a><span id="l37.310" class="difflineminus">-function Ignore()</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineminus">-{</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineplus">+function Ignore() {</span>
<a href="#l37.313"></a><span id="l37.313">   NextWord();</span>
<a href="#l37.314"></a><span id="l37.314"> }</span>
<a href="#l37.315"></a><span id="l37.315"> </span>
<a href="#l37.316"></a><span id="l37.316" class="difflineminus">-function IgnoreAll()</span>
<a href="#l37.317"></a><span id="l37.317" class="difflineminus">-{</span>
<a href="#l37.318"></a><span id="l37.318" class="difflineplus">+function IgnoreAll() {</span>
<a href="#l37.319"></a><span id="l37.319">   if (gMisspelledWord) {</span>
<a href="#l37.320"></a><span id="l37.320">     gSpellChecker.IgnoreWordAllOccurrences(gMisspelledWord);</span>
<a href="#l37.321"></a><span id="l37.321">   }</span>
<a href="#l37.322"></a><span id="l37.322">   NextWord();</span>
<a href="#l37.323"></a><span id="l37.323"> }</span>
<a href="#l37.324"></a><span id="l37.324"> </span>
<a href="#l37.325"></a><span id="l37.325" class="difflineminus">-function Replace(newWord)</span>
<a href="#l37.326"></a><span id="l37.326" class="difflineminus">-{</span>
<a href="#l37.327"></a><span id="l37.327" class="difflineplus">+function Replace(newWord) {</span>
<a href="#l37.328"></a><span id="l37.328">   if (!newWord)</span>
<a href="#l37.329"></a><span id="l37.329">     return;</span>
<a href="#l37.330"></a><span id="l37.330"> </span>
<a href="#l37.331"></a><span id="l37.331" class="difflineminus">-  if (gMisspelledWord &amp;&amp; gMisspelledWord != newWord)</span>
<a href="#l37.332"></a><span id="l37.332" class="difflineminus">-  {</span>
<a href="#l37.333"></a><span id="l37.333" class="difflineplus">+  if (gMisspelledWord &amp;&amp; gMisspelledWord != newWord) {</span>
<a href="#l37.334"></a><span id="l37.334">     var editor = GetCurrentEditor();</span>
<a href="#l37.335"></a><span id="l37.335">     editor.beginTransaction();</span>
<a href="#l37.336"></a><span id="l37.336">     try {</span>
<a href="#l37.337"></a><span id="l37.337">       gSpellChecker.ReplaceWord(gMisspelledWord, newWord, false);</span>
<a href="#l37.338"></a><span id="l37.338">     } catch (e) {}</span>
<a href="#l37.339"></a><span id="l37.339">     editor.endTransaction();</span>
<a href="#l37.340"></a><span id="l37.340">   }</span>
<a href="#l37.341"></a><span id="l37.341">   NextWord();</span>
<a href="#l37.342"></a><span id="l37.342"> }</span>
<a href="#l37.343"></a><span id="l37.343"> </span>
<a href="#l37.344"></a><span id="l37.344" class="difflineminus">-function ReplaceAll()</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineminus">-{</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineplus">+function ReplaceAll() {</span>
<a href="#l37.347"></a><span id="l37.347">   var newWord = gDialog.ReplaceWordInput.value;</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineminus">-  if (gMisspelledWord &amp;&amp; gMisspelledWord != newWord)</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineminus">-  {</span>
<a href="#l37.350"></a><span id="l37.350" class="difflineplus">+  if (gMisspelledWord &amp;&amp; gMisspelledWord != newWord) {</span>
<a href="#l37.351"></a><span id="l37.351">     var editor = GetCurrentEditor();</span>
<a href="#l37.352"></a><span id="l37.352">     editor.beginTransaction();</span>
<a href="#l37.353"></a><span id="l37.353">     try {</span>
<a href="#l37.354"></a><span id="l37.354">       gSpellChecker.ReplaceWord(gMisspelledWord, newWord, true);</span>
<a href="#l37.355"></a><span id="l37.355">     } catch (e) {}</span>
<a href="#l37.356"></a><span id="l37.356">     editor.endTransaction();</span>
<a href="#l37.357"></a><span id="l37.357">   }</span>
<a href="#l37.358"></a><span id="l37.358">   NextWord();</span>
<a href="#l37.359"></a><span id="l37.359"> }</span>
<a href="#l37.360"></a><span id="l37.360"> </span>
<a href="#l37.361"></a><span id="l37.361" class="difflineminus">-function AddToDictionary()</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineminus">-{</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineplus">+function AddToDictionary() {</span>
<a href="#l37.364"></a><span id="l37.364">   if (gMisspelledWord) {</span>
<a href="#l37.365"></a><span id="l37.365">     gSpellChecker.AddWordToDictionary(gMisspelledWord);</span>
<a href="#l37.366"></a><span id="l37.366">   }</span>
<a href="#l37.367"></a><span id="l37.367">   NextWord();</span>
<a href="#l37.368"></a><span id="l37.368"> }</span>
<a href="#l37.369"></a><span id="l37.369"> </span>
<a href="#l37.370"></a><span id="l37.370" class="difflineminus">-function EditDictionary()</span>
<a href="#l37.371"></a><span id="l37.371" class="difflineminus">-{</span>
<a href="#l37.372"></a><span id="l37.372" class="difflineplus">+function EditDictionary() {</span>
<a href="#l37.373"></a><span id="l37.373">   window.openDialog(&quot;chrome://editor/content/EdDictionary.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, gMisspelledWord);</span>
<a href="#l37.374"></a><span id="l37.374"> }</span>
<a href="#l37.375"></a><span id="l37.375"> </span>
<a href="#l37.376"></a><span id="l37.376" class="difflineminus">-function SelectLanguage()</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineminus">-{</span>
<a href="#l37.378"></a><span id="l37.378" class="difflineplus">+function SelectLanguage() {</span>
<a href="#l37.379"></a><span id="l37.379">   var item = gDialog.LanguageMenulist.selectedItem;</span>
<a href="#l37.380"></a><span id="l37.380">   if (item.value != &quot;more-cmd&quot;) {</span>
<a href="#l37.381"></a><span id="l37.381">     gSpellChecker.SetCurrentDictionary(item.value);</span>
<a href="#l37.382"></a><span id="l37.382">     // For compose windows we need to set the &quot;lang&quot; attribute so the</span>
<a href="#l37.383"></a><span id="l37.383">     // core editor uses the correct dictionary for the inline spell check.</span>
<a href="#l37.384"></a><span id="l37.384">     if (window.arguments[1]) {</span>
<a href="#l37.385"></a><span id="l37.385">       if (&quot;ComposeChangeLanguage&quot; in window.opener) {</span>
<a href="#l37.386"></a><span id="l37.386">         // We came here from a compose window.</span>
<a href="#l37.387"></a><span id="l37.387">         window.opener.ComposeChangeLanguage(item.value);</span>
<a href="#l37.388"></a><span id="l37.388">       } else {</span>
<a href="#l37.389"></a><span id="l37.389">         window.opener.document.documentElement.setAttribute(&quot;lang&quot;, item.value);</span>
<a href="#l37.390"></a><span id="l37.390">       }</span>
<a href="#l37.391"></a><span id="l37.391">     }</span>
<a href="#l37.392"></a><span id="l37.392">     gLastSelectedLang = item;</span>
<a href="#l37.393"></a><span id="l37.393" class="difflineminus">-  }</span>
<a href="#l37.394"></a><span id="l37.394" class="difflineminus">-  else {</span>
<a href="#l37.395"></a><span id="l37.395" class="difflineplus">+  } else {</span>
<a href="#l37.396"></a><span id="l37.396">     openDictionaryList();</span>
<a href="#l37.397"></a><span id="l37.397"> </span>
<a href="#l37.398"></a><span id="l37.398">     if (gLastSelectedLang)</span>
<a href="#l37.399"></a><span id="l37.399">       gDialog.LanguageMenulist.selectedItem = gLastSelectedLang;</span>
<a href="#l37.400"></a><span id="l37.400">   }</span>
<a href="#l37.401"></a><span id="l37.401"> }</span>
<a href="#l37.402"></a><span id="l37.402"> </span>
<a href="#l37.403"></a><span id="l37.403" class="difflineminus">-function Recheck()</span>
<a href="#l37.404"></a><span id="l37.404" class="difflineminus">-{</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineplus">+function Recheck() {</span>
<a href="#l37.406"></a><span id="l37.406">   var recheckLanguage;</span>
<a href="#l37.407"></a><span id="l37.407"> </span>
<a href="#l37.408"></a><span id="l37.408">   function finishRecheck() {</span>
<a href="#l37.409"></a><span id="l37.409">     gSpellChecker.SetCurrentDictionary(recheckLanguage);</span>
<a href="#l37.410"></a><span id="l37.410">     gMisspelledWord = gSpellChecker.GetNextMisspelledWord();</span>
<a href="#l37.411"></a><span id="l37.411">     SetWidgetsForMisspelledWord();</span>
<a href="#l37.412"></a><span id="l37.412">   }</span>
<a href="#l37.413"></a><span id="l37.413"> </span>
<a href="#l37.414"></a><span id="l37.414" class="difflineminus">-  //TODO: Should we bother to add a &quot;Recheck&quot; method to interface?</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineplus">+  // TODO: Should we bother to add a &quot;Recheck&quot; method to interface?</span>
<a href="#l37.416"></a><span id="l37.416">   try {</span>
<a href="#l37.417"></a><span id="l37.417">     recheckLanguage = gSpellChecker.GetCurrentDictionary();</span>
<a href="#l37.418"></a><span id="l37.418">     gSpellChecker.UninitSpellChecker();</span>
<a href="#l37.419"></a><span id="l37.419">     // Clear the ignore all list.</span>
<a href="#l37.420"></a><span id="l37.420">     Cc[&quot;@mozilla.org/spellchecker/personaldictionary;1&quot;]</span>
<a href="#l37.421"></a><span id="l37.421">       .getService(Ci.mozIPersonalDictionary)</span>
<a href="#l37.422"></a><span id="l37.422">       .endSession();</span>
<a href="#l37.423"></a><span id="l37.423">     gSpellChecker.InitSpellChecker(GetCurrentEditor(), false, finishRecheck);</span>
<a href="#l37.424"></a><span id="l37.424" class="difflineminus">-  } catch(ex) {</span>
<a href="#l37.425"></a><span id="l37.425" class="difflineplus">+  } catch (ex) {</span>
<a href="#l37.426"></a><span id="l37.426">     Cu.reportError(ex);</span>
<a href="#l37.427"></a><span id="l37.427">   }</span>
<a href="#l37.428"></a><span id="l37.428"> }</span>
<a href="#l37.429"></a><span id="l37.429"> </span>
<a href="#l37.430"></a><span id="l37.430" class="difflineminus">-function FillSuggestedList(misspelledWord)</span>
<a href="#l37.431"></a><span id="l37.431" class="difflineminus">-{</span>
<a href="#l37.432"></a><span id="l37.432" class="difflineplus">+function FillSuggestedList(misspelledWord) {</span>
<a href="#l37.433"></a><span id="l37.433">   var list = gDialog.SuggestedList;</span>
<a href="#l37.434"></a><span id="l37.434"> </span>
<a href="#l37.435"></a><span id="l37.435">   // Clear the current contents of the list</span>
<a href="#l37.436"></a><span id="l37.436">   gAllowSelectWord = false;</span>
<a href="#l37.437"></a><span id="l37.437">   ClearListbox(list);</span>
<a href="#l37.438"></a><span id="l37.438">   var item;</span>
<a href="#l37.439"></a><span id="l37.439"> </span>
<a href="#l37.440"></a><span id="l37.440" class="difflineminus">-  if (misspelledWord.length &gt; 0)</span>
<a href="#l37.441"></a><span id="l37.441" class="difflineminus">-  {</span>
<a href="#l37.442"></a><span id="l37.442" class="difflineplus">+  if (misspelledWord.length &gt; 0) {</span>
<a href="#l37.443"></a><span id="l37.443">     // Get suggested words until an empty string is returned</span>
<a href="#l37.444"></a><span id="l37.444">     var count = 0;</span>
<a href="#l37.445"></a><span id="l37.445">     var firstWord = 0;</span>
<a href="#l37.446"></a><span id="l37.446">     do {</span>
<a href="#l37.447"></a><span id="l37.447">       var word = gSpellChecker.GetSuggestedWord();</span>
<a href="#l37.448"></a><span id="l37.448" class="difflineminus">-      if (count==0)</span>
<a href="#l37.449"></a><span id="l37.449" class="difflineplus">+      if (count == 0)</span>
<a href="#l37.450"></a><span id="l37.450">         firstWord = word;</span>
<a href="#l37.451"></a><span id="l37.451" class="difflineminus">-      if (word.length &gt; 0)</span>
<a href="#l37.452"></a><span id="l37.452" class="difflineminus">-      {</span>
<a href="#l37.453"></a><span id="l37.453" class="difflineplus">+      if (word.length &gt; 0) {</span>
<a href="#l37.454"></a><span id="l37.454">         list.appendItem(word, &quot;&quot;);</span>
<a href="#l37.455"></a><span id="l37.455">         count++;</span>
<a href="#l37.456"></a><span id="l37.456">       }</span>
<a href="#l37.457"></a><span id="l37.457">     } while (word.length &gt; 0);</span>
<a href="#l37.458"></a><span id="l37.458"> </span>
<a href="#l37.459"></a><span id="l37.459" class="difflineminus">-    if (count == 0)</span>
<a href="#l37.460"></a><span id="l37.460" class="difflineminus">-    {</span>
<a href="#l37.461"></a><span id="l37.461" class="difflineplus">+    if (count == 0) {</span>
<a href="#l37.462"></a><span id="l37.462">       // No suggestions - show a message but don't let user select it</span>
<a href="#l37.463"></a><span id="l37.463">       item = list.appendItem(GetString(&quot;NoSuggestedWords&quot;));</span>
<a href="#l37.464"></a><span id="l37.464">       if (item) item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l37.465"></a><span id="l37.465">       gAllowSelectWord = false;</span>
<a href="#l37.466"></a><span id="l37.466">     } else {</span>
<a href="#l37.467"></a><span id="l37.467">       gAllowSelectWord = true;</span>
<a href="#l37.468"></a><span id="l37.468">       // Initialize with first suggested list by selecting it</span>
<a href="#l37.469"></a><span id="l37.469">       gDialog.SuggestedList.selectedIndex = 0;</span>
<a href="#l37.470"></a><span id="l37.470">     }</span>
<a href="#l37.471"></a><span id="l37.471" class="difflineminus">-  }</span>
<a href="#l37.472"></a><span id="l37.472" class="difflineminus">-  else</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineminus">-  {</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineplus">+  } else {</span>
<a href="#l37.475"></a><span id="l37.475">     item = list.appendItem(&quot;&quot;, &quot;&quot;);</span>
<a href="#l37.476"></a><span id="l37.476">     if (item)</span>
<a href="#l37.477"></a><span id="l37.477">       item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l37.478"></a><span id="l37.478">   }</span>
<a href="#l37.479"></a><span id="l37.479"> }</span>
<a href="#l37.480"></a><span id="l37.480"> </span>
<a href="#l37.481"></a><span id="l37.481" class="difflineminus">-function SetReplaceEnable()</span>
<a href="#l37.482"></a><span id="l37.482" class="difflineminus">-{</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineplus">+function SetReplaceEnable() {</span>
<a href="#l37.484"></a><span id="l37.484">   // Enable &quot;Change...&quot; buttons only if new word is different than misspelled</span>
<a href="#l37.485"></a><span id="l37.485">   var newWord = gDialog.ReplaceWordInput.value;</span>
<a href="#l37.486"></a><span id="l37.486">   var enable = newWord.length &gt; 0 &amp;&amp; newWord != gMisspelledWord;</span>
<a href="#l37.487"></a><span id="l37.487">   SetElementEnabledById(&quot;Replace&quot;, enable);</span>
<a href="#l37.488"></a><span id="l37.488">   SetElementEnabledById(&quot;ReplaceAll&quot;, enable);</span>
<a href="#l37.489"></a><span id="l37.489" class="difflineminus">-  if (enable)</span>
<a href="#l37.490"></a><span id="l37.490" class="difflineminus">-  {</span>
<a href="#l37.491"></a><span id="l37.491" class="difflineminus">-    gDialog.ReplaceButton.setAttribute(&quot;default&quot;,&quot;true&quot;);</span>
<a href="#l37.492"></a><span id="l37.492" class="difflineplus">+  if (enable) {</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineplus">+    gDialog.ReplaceButton.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l37.494"></a><span id="l37.494">     gDialog.IgnoreButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l37.495"></a><span id="l37.495" class="difflineminus">-  }</span>
<a href="#l37.496"></a><span id="l37.496" class="difflineminus">-  else</span>
<a href="#l37.497"></a><span id="l37.497" class="difflineminus">-  {</span>
<a href="#l37.498"></a><span id="l37.498" class="difflineminus">-    gDialog.IgnoreButton.setAttribute(&quot;default&quot;,&quot;true&quot;);</span>
<a href="#l37.499"></a><span id="l37.499" class="difflineplus">+  } else {</span>
<a href="#l37.500"></a><span id="l37.500" class="difflineplus">+    gDialog.IgnoreButton.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l37.501"></a><span id="l37.501">     gDialog.ReplaceButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l37.502"></a><span id="l37.502">   }</span>
<a href="#l37.503"></a><span id="l37.503"> }</span>
<a href="#l37.504"></a><span id="l37.504"> </span>
<a href="#l37.505"></a><span id="l37.505" class="difflineminus">-function doDefault(event)</span>
<a href="#l37.506"></a><span id="l37.506" class="difflineminus">-{</span>
<a href="#l37.507"></a><span id="l37.507" class="difflineplus">+function doDefault(event) {</span>
<a href="#l37.508"></a><span id="l37.508">   if (gDialog.ReplaceButton.getAttribute(&quot;default&quot;) == &quot;true&quot;)</span>
<a href="#l37.509"></a><span id="l37.509">     Replace(gDialog.ReplaceWordInput.value);</span>
<a href="#l37.510"></a><span id="l37.510">   else if (gDialog.IgnoreButton.getAttribute(&quot;default&quot;) == &quot;true&quot;)</span>
<a href="#l37.511"></a><span id="l37.511">     Ignore();</span>
<a href="#l37.512"></a><span id="l37.512">   else if (gDialog.CloseButton.getAttribute(&quot;default&quot;) == &quot;true&quot;)</span>
<a href="#l37.513"></a><span id="l37.513">     onClose();</span>
<a href="#l37.514"></a><span id="l37.514"> </span>
<a href="#l37.515"></a><span id="l37.515">   event.preventDefault();</span>
<a href="#l37.516"></a><span id="l37.516"> }</span>
<a href="#l37.517"></a><span id="l37.517"> </span>
<a href="#l37.518"></a><span id="l37.518" class="difflineminus">-function ExitSpellChecker()</span>
<a href="#l37.519"></a><span id="l37.519" class="difflineminus">-{</span>
<a href="#l37.520"></a><span id="l37.520" class="difflineminus">-  if (gSpellChecker)</span>
<a href="#l37.521"></a><span id="l37.521" class="difflineminus">-  {</span>
<a href="#l37.522"></a><span id="l37.522" class="difflineminus">-    try</span>
<a href="#l37.523"></a><span id="l37.523" class="difflineminus">-    {</span>
<a href="#l37.524"></a><span id="l37.524" class="difflineplus">+function ExitSpellChecker() {</span>
<a href="#l37.525"></a><span id="l37.525" class="difflineplus">+  if (gSpellChecker) {</span>
<a href="#l37.526"></a><span id="l37.526" class="difflineplus">+    try {</span>
<a href="#l37.527"></a><span id="l37.527">       gSpellChecker.UninitSpellChecker();</span>
<a href="#l37.528"></a><span id="l37.528">       // now check the document over again with the new dictionary</span>
<a href="#l37.529"></a><span id="l37.529">       // if we have an inline spellchecker</span>
<a href="#l37.530"></a><span id="l37.530">       if ((&quot;InlineSpellCheckerUI&quot; in window.opener) &amp;&amp;</span>
<a href="#l37.531"></a><span id="l37.531">           window.opener.InlineSpellCheckerUI.enabled)</span>
<a href="#l37.532"></a><span id="l37.532">         window.opener.InlineSpellCheckerUI.mInlineSpellChecker.spellCheckRange(null);</span>
<a href="#l37.533"></a><span id="l37.533" class="difflineminus">-    }</span>
<a href="#l37.534"></a><span id="l37.534" class="difflineminus">-    finally</span>
<a href="#l37.535"></a><span id="l37.535" class="difflineminus">-    {</span>
<a href="#l37.536"></a><span id="l37.536" class="difflineplus">+    } finally {</span>
<a href="#l37.537"></a><span id="l37.537">       gSpellChecker = null;</span>
<a href="#l37.538"></a><span id="l37.538">     }</span>
<a href="#l37.539"></a><span id="l37.539">   }</span>
<a href="#l37.540"></a><span id="l37.540"> }</span>
<a href="#l37.541"></a><span id="l37.541"> </span>
<a href="#l37.542"></a><span id="l37.542" class="difflineminus">-function CancelSpellCheck()</span>
<a href="#l37.543"></a><span id="l37.543" class="difflineminus">-{</span>
<a href="#l37.544"></a><span id="l37.544" class="difflineplus">+function CancelSpellCheck() {</span>
<a href="#l37.545"></a><span id="l37.545">   ExitSpellChecker();</span>
<a href="#l37.546"></a><span id="l37.546"> </span>
<a href="#l37.547"></a><span id="l37.547">   // Signal to calling window that we canceled</span>
<a href="#l37.548"></a><span id="l37.548">   window.opener.cancelSendMessage = true;</span>
<a href="#l37.549"></a><span id="l37.549"> }</span>
<a href="#l37.550"></a><span id="l37.550"> </span>
<a href="#l37.551"></a><span id="l37.551" class="difflineminus">-function onClose()</span>
<a href="#l37.552"></a><span id="l37.552" class="difflineminus">-{</span>
<a href="#l37.553"></a><span id="l37.553" class="difflineplus">+function onClose() {</span>
<a href="#l37.554"></a><span id="l37.554">   ExitSpellChecker();</span>
<a href="#l37.555"></a><span id="l37.555"> </span>
<a href="#l37.556"></a><span id="l37.556">   window.opener.cancelSendMessage = false;</span>
<a href="#l37.557"></a><span id="l37.557">   window.close();</span>
<a href="#l37.558"></a><span id="l37.558"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdTableProps.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdTableProps.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l38.4"></a><span id="l38.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.5"></a><span id="l38.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.6"></a><span id="l38.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.7"></a><span id="l38.7"> </span>
<a href="#l38.8"></a><span id="l38.8" class="difflineminus">-//Cancel() is in EdDialogCommon.js</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+// Cancel() is in EdDialogCommon.js</span>
<a href="#l38.10"></a><span id="l38.10"> </span>
<a href="#l38.11"></a><span id="l38.11"> var gTableElement;</span>
<a href="#l38.12"></a><span id="l38.12"> var gCellElement;</span>
<a href="#l38.13"></a><span id="l38.13"> var gTableCaptionElement;</span>
<a href="#l38.14"></a><span id="l38.14"> var globalCellElement;</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-var globalTableElement</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+var globalTableElement;</span>
<a href="#l38.17"></a><span id="l38.17"> var gValidateTab;</span>
<a href="#l38.18"></a><span id="l38.18"> const defHAlign =   &quot;left&quot;;</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-const centerStr =   &quot;center&quot;;  //Index=1</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+const centerStr =   &quot;center&quot;;  // Index=1</span>
<a href="#l38.21"></a><span id="l38.21"> const rightStr =    &quot;right&quot;;   // 2</span>
<a href="#l38.22"></a><span id="l38.22"> const justifyStr =  &quot;justify&quot;; // 3</span>
<a href="#l38.23"></a><span id="l38.23"> const charStr =     &quot;char&quot;;    // 4</span>
<a href="#l38.24"></a><span id="l38.24"> const defVAlign =   &quot;middle&quot;;</span>
<a href="#l38.25"></a><span id="l38.25"> const topStr =      &quot;top&quot;;</span>
<a href="#l38.26"></a><span id="l38.26"> const bottomStr =   &quot;bottom&quot;;</span>
<a href="#l38.27"></a><span id="l38.27"> const bgcolor = &quot;bgcolor&quot;;</span>
<a href="#l38.28"></a><span id="l38.28"> var gTableColor;</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineat">@@ -33,18 +33,18 @@ var gNewColCount;</span>
<a href="#l38.30"></a><span id="l38.30"> var gCurRowIndex;</span>
<a href="#l38.31"></a><span id="l38.31"> var gCurColIndex;</span>
<a href="#l38.32"></a><span id="l38.32"> var gCurColSpan;</span>
<a href="#l38.33"></a><span id="l38.33"> var gSelectedCellsType = 1;</span>
<a href="#l38.34"></a><span id="l38.34"> const SELECT_CELL = 1;</span>
<a href="#l38.35"></a><span id="l38.35"> const SELECT_ROW = 2;</span>
<a href="#l38.36"></a><span id="l38.36"> const SELECT_COLUMN = 3;</span>
<a href="#l38.37"></a><span id="l38.37"> const RESET_SELECTION = 0;</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineminus">-var gCellData = { value:null, startRowIndex:0, startColIndex:0, rowSpan:0, colSpan:0,</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineminus">-                 actualRowSpan:0, actualColSpan:0, isSelected:false</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+var gCellData = { value: null, startRowIndex: 0, startColIndex: 0, rowSpan: 0, colSpan: 0,</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+                 actualRowSpan: 0, actualColSpan: 0, isSelected: false,</span>
<a href="#l38.42"></a><span id="l38.42">                };</span>
<a href="#l38.43"></a><span id="l38.43"> var gAdvancedEditUsed;</span>
<a href="#l38.44"></a><span id="l38.44"> var gAlignWasChar = false;</span>
<a href="#l38.45"></a><span id="l38.45"> </span>
<a href="#l38.46"></a><span id="l38.46"> /*</span>
<a href="#l38.47"></a><span id="l38.47"> From C++:</span>
<a href="#l38.48"></a><span id="l38.48">  0 TABLESELECTION_TABLE</span>
<a href="#l38.49"></a><span id="l38.49">  1 TABLESELECTION_CELL   There are 1 or more cells selected</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineat">@@ -64,21 +64,19 @@ var gUseCSS = true;</span>
<a href="#l38.51"></a><span id="l38.51"> var gActiveEditor;</span>
<a href="#l38.52"></a><span id="l38.52"> </span>
<a href="#l38.53"></a><span id="l38.53"> // dialog initialization code</span>
<a href="#l38.54"></a><span id="l38.54"> </span>
<a href="#l38.55"></a><span id="l38.55"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l38.56"></a><span id="l38.56"> document.addEventListener(&quot;dialogextra1&quot;, Apply);</span>
<a href="#l38.57"></a><span id="l38.57"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l38.58"></a><span id="l38.58"> </span>
<a href="#l38.59"></a><span id="l38.59" class="difflineminus">-function Startup()</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineminus">-{</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+function Startup() {</span>
<a href="#l38.62"></a><span id="l38.62">   gActiveEditor = GetCurrentTableEditor();</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-  if (!gActiveEditor)</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineminus">-  {</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+  if (!gActiveEditor) {</span>
<a href="#l38.66"></a><span id="l38.66">     window.close();</span>
<a href="#l38.67"></a><span id="l38.67">     return;</span>
<a href="#l38.68"></a><span id="l38.68">   }</span>
<a href="#l38.69"></a><span id="l38.69"> </span>
<a href="#l38.70"></a><span id="l38.70">   try {</span>
<a href="#l38.71"></a><span id="l38.71">     gSelection = gActiveEditor.selection;</span>
<a href="#l38.72"></a><span id="l38.72">   } catch (e) {}</span>
<a href="#l38.73"></a><span id="l38.73">   if (!gSelection) return;</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineat">@@ -86,18 +84,17 @@ function Startup()</span>
<a href="#l38.75"></a><span id="l38.75">   // Get dialog widgets - Table Panel</span>
<a href="#l38.76"></a><span id="l38.76">   gDialog.TableRowsInput = document.getElementById(&quot;TableRowsInput&quot;);</span>
<a href="#l38.77"></a><span id="l38.77">   gDialog.TableColumnsInput = document.getElementById(&quot;TableColumnsInput&quot;);</span>
<a href="#l38.78"></a><span id="l38.78">   gDialog.TableWidthInput = document.getElementById(&quot;TableWidthInput&quot;);</span>
<a href="#l38.79"></a><span id="l38.79">   gDialog.TableWidthUnits = document.getElementById(&quot;TableWidthUnits&quot;);</span>
<a href="#l38.80"></a><span id="l38.80">   gDialog.TableHeightInput = document.getElementById(&quot;TableHeightInput&quot;);</span>
<a href="#l38.81"></a><span id="l38.81">   gDialog.TableHeightUnits = document.getElementById(&quot;TableHeightUnits&quot;);</span>
<a href="#l38.82"></a><span id="l38.82">   try {</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineminus">-    if (!Services.prefs.getBoolPref(&quot;editor.use_css&quot;) || (gActiveEditor.flags &amp; 1))</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineminus">-    {</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+    if (!Services.prefs.getBoolPref(&quot;editor.use_css&quot;) || (gActiveEditor.flags &amp; 1)) {</span>
<a href="#l38.86"></a><span id="l38.86">       gUseCSS = false;</span>
<a href="#l38.87"></a><span id="l38.87">       var tableHeightLabel = document.getElementById(&quot;TableHeightLabel&quot;);</span>
<a href="#l38.88"></a><span id="l38.88">       tableHeightLabel.remove();</span>
<a href="#l38.89"></a><span id="l38.89">       gDialog.TableHeightInput.remove();</span>
<a href="#l38.90"></a><span id="l38.90">       gDialog.TableHeightUnits.remove();</span>
<a href="#l38.91"></a><span id="l38.91">     }</span>
<a href="#l38.92"></a><span id="l38.92">   } catch (e) {}</span>
<a href="#l38.93"></a><span id="l38.93">   gDialog.BorderWidthInput = document.getElementById(&quot;BorderWidthInput&quot;);</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineat">@@ -109,18 +106,18 @@ function Startup()</span>
<a href="#l38.95"></a><span id="l38.95">   gDialog.TabBox =  document.getElementById(&quot;TabBox&quot;);</span>
<a href="#l38.96"></a><span id="l38.96"> </span>
<a href="#l38.97"></a><span id="l38.97">   // Cell Panel</span>
<a href="#l38.98"></a><span id="l38.98">   gDialog.SelectionList = document.getElementById(&quot;SelectionList&quot;);</span>
<a href="#l38.99"></a><span id="l38.99">   gDialog.PreviousButton = document.getElementById(&quot;PreviousButton&quot;);</span>
<a href="#l38.100"></a><span id="l38.100">   gDialog.NextButton = document.getElementById(&quot;NextButton&quot;);</span>
<a href="#l38.101"></a><span id="l38.101">   // Currently, we always apply changes and load new attributes when changing selection</span>
<a href="#l38.102"></a><span id="l38.102">   // (Let's keep this for possible future use)</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineminus">-  //gDialog.ApplyBeforeMove =  document.getElementById(&quot;ApplyBeforeMove&quot;);</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineminus">-  //gDialog.KeepCurrentData = document.getElementById(&quot;KeepCurrentData&quot;);</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+  // gDialog.ApplyBeforeMove =  document.getElementById(&quot;ApplyBeforeMove&quot;);</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+  // gDialog.KeepCurrentData = document.getElementById(&quot;KeepCurrentData&quot;);</span>
<a href="#l38.107"></a><span id="l38.107"> </span>
<a href="#l38.108"></a><span id="l38.108">   gDialog.CellHeightInput = document.getElementById(&quot;CellHeightInput&quot;);</span>
<a href="#l38.109"></a><span id="l38.109">   gDialog.CellHeightUnits = document.getElementById(&quot;CellHeightUnits&quot;);</span>
<a href="#l38.110"></a><span id="l38.110">   gDialog.CellWidthInput = document.getElementById(&quot;CellWidthInput&quot;);</span>
<a href="#l38.111"></a><span id="l38.111">   gDialog.CellWidthUnits = document.getElementById(&quot;CellWidthUnits&quot;);</span>
<a href="#l38.112"></a><span id="l38.112">   gDialog.CellHAlignList = document.getElementById(&quot;CellHAlignList&quot;);</span>
<a href="#l38.113"></a><span id="l38.113">   gDialog.CellVAlignList = document.getElementById(&quot;CellVAlignList&quot;);</span>
<a href="#l38.114"></a><span id="l38.114">   gDialog.CellInheritColor = document.getElementById(&quot;CellInheritColor&quot;);</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineat">@@ -141,33 +138,31 @@ function Startup()</span>
<a href="#l38.116"></a><span id="l38.116">   gDialog.CellTab = document.getElementById(&quot;CellTab&quot;);</span>
<a href="#l38.117"></a><span id="l38.117">   gDialog.AdvancedEditCell = document.getElementById(&quot;AdvancedEditButton2&quot;);</span>
<a href="#l38.118"></a><span id="l38.118">   // Save &quot;normal&quot; tooltip message for Advanced Edit button</span>
<a href="#l38.119"></a><span id="l38.119">   gDialog.AdvancedEditCellToolTipText = gDialog.AdvancedEditCell.getAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l38.120"></a><span id="l38.120"> </span>
<a href="#l38.121"></a><span id="l38.121">   try {</span>
<a href="#l38.122"></a><span id="l38.122">     gTableElement = gActiveEditor.getElementOrParentByTagName(&quot;table&quot;, null);</span>
<a href="#l38.123"></a><span id="l38.123">   } catch (e) {}</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineminus">-  if(!gTableElement)</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineminus">-  {</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineplus">+  if (!gTableElement) {</span>
<a href="#l38.127"></a><span id="l38.127">     dump(&quot;Failed to get table element!\n&quot;);</span>
<a href="#l38.128"></a><span id="l38.128">     window.close();</span>
<a href="#l38.129"></a><span id="l38.129">     return;</span>
<a href="#l38.130"></a><span id="l38.130">   }</span>
<a href="#l38.131"></a><span id="l38.131">   globalTableElement = gTableElement.cloneNode(false);</span>
<a href="#l38.132"></a><span id="l38.132"> </span>
<a href="#l38.133"></a><span id="l38.133">   var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineminus">-  var countObj = { value : 0 };</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+  var countObj = { value: 0 };</span>
<a href="#l38.136"></a><span id="l38.136">   var tableOrCellElement;</span>
<a href="#l38.137"></a><span id="l38.137">   try {</span>
<a href="#l38.138"></a><span id="l38.138">    tableOrCellElement = gActiveEditor.getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l38.139"></a><span id="l38.139">   } catch (e) {}</span>
<a href="#l38.140"></a><span id="l38.140"> </span>
<a href="#l38.141"></a><span id="l38.141" class="difflineminus">-  if (tagNameObj.value == &quot;td&quot;)</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineminus">-  {</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineplus">+  if (tagNameObj.value == &quot;td&quot;) {</span>
<a href="#l38.144"></a><span id="l38.144">     // We are in a cell</span>
<a href="#l38.145"></a><span id="l38.145">     gSelectedCellCount = countObj.value;</span>
<a href="#l38.146"></a><span id="l38.146">     gCellElement = tableOrCellElement;</span>
<a href="#l38.147"></a><span id="l38.147">     globalCellElement = gCellElement.cloneNode(false);</span>
<a href="#l38.148"></a><span id="l38.148"> </span>
<a href="#l38.149"></a><span id="l38.149">     // Tells us whether cell, row, or column is selected</span>
<a href="#l38.150"></a><span id="l38.150">     try {</span>
<a href="#l38.151"></a><span id="l38.151">       gSelectedCellsType = gActiveEditor.getSelectedCellsType(gTableElement);</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineat">@@ -196,42 +191,40 @@ function Startup()</span>
<a href="#l38.153"></a><span id="l38.153">     if (GetCellData(gCurRowIndex, gCurColIndex))</span>
<a href="#l38.154"></a><span id="l38.154">       gCurColSpan = gCellData.colSpan;</span>
<a href="#l38.155"></a><span id="l38.155"> </span>
<a href="#l38.156"></a><span id="l38.156">     // Starting TabPanel name is passed in</span>
<a href="#l38.157"></a><span id="l38.157">     if (window.arguments[1] == &quot;CellPanel&quot;)</span>
<a href="#l38.158"></a><span id="l38.158">       gDialog.TabBox.selectedTab = gDialog.CellTab;</span>
<a href="#l38.159"></a><span id="l38.159">   }</span>
<a href="#l38.160"></a><span id="l38.160"> </span>
<a href="#l38.161"></a><span id="l38.161" class="difflineminus">-  if (gDialog.TabBox.selectedTab == gDialog.TableTab)</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineminus">-  {</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineplus">+  if (gDialog.TabBox.selectedTab == gDialog.TableTab) {</span>
<a href="#l38.164"></a><span id="l38.164">     // We may call this with table selected, but no cell,</span>
<a href="#l38.165"></a><span id="l38.165">     //  so disable the Cell Properties tab</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineminus">-    if(!gCellElement)</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineminus">-    {</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineplus">+    if (!gCellElement) {</span>
<a href="#l38.169"></a><span id="l38.169">       // XXX: Disabling of tabs is currently broken, so for</span>
<a href="#l38.170"></a><span id="l38.170">       //      now we'll just remove the tab completely.</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineminus">-      //gDialog.CellTab.disabled = true;</span>
<a href="#l38.172"></a><span id="l38.172" class="difflineplus">+      // gDialog.CellTab.disabled = true;</span>
<a href="#l38.173"></a><span id="l38.173">       gDialog.CellTab.remove();</span>
<a href="#l38.174"></a><span id="l38.174">     }</span>
<a href="#l38.175"></a><span id="l38.175">   }</span>
<a href="#l38.176"></a><span id="l38.176"> </span>
<a href="#l38.177"></a><span id="l38.177">   // Note: we must use gTableElement, not globalTableElement for these,</span>
<a href="#l38.178"></a><span id="l38.178">   //  thus we should not put this in InitDialog.</span>
<a href="#l38.179"></a><span id="l38.179">   // Instead, monitor desired counts with separate globals</span>
<a href="#l38.180"></a><span id="l38.180">   var rowCountObj = { value: 0 };</span>
<a href="#l38.181"></a><span id="l38.181">   var colCountObj = { value: 0 };</span>
<a href="#l38.182"></a><span id="l38.182">   try {</span>
<a href="#l38.183"></a><span id="l38.183">     gActiveEditor.getTableSize(gTableElement, rowCountObj, colCountObj);</span>
<a href="#l38.184"></a><span id="l38.184">   } catch (e) {}</span>
<a href="#l38.185"></a><span id="l38.185"> </span>
<a href="#l38.186"></a><span id="l38.186">   gRowCount = rowCountObj.value;</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineminus">-  gLastRowIndex = gRowCount-1;</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineplus">+  gLastRowIndex = gRowCount - 1;</span>
<a href="#l38.189"></a><span id="l38.189">   gColCount = colCountObj.value;</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineminus">-  gLastColIndex = gColCount-1;</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineplus">+  gLastColIndex = gColCount - 1;</span>
<a href="#l38.192"></a><span id="l38.192"> </span>
<a href="#l38.193"></a><span id="l38.193"> </span>
<a href="#l38.194"></a><span id="l38.194">   // Set appropriate icons and enable state for the Previous/Next buttons</span>
<a href="#l38.195"></a><span id="l38.195">   SetSelectionButtons();</span>
<a href="#l38.196"></a><span id="l38.196"> </span>
<a href="#l38.197"></a><span id="l38.197">   // If only one cell in table, disable change-selection widgets</span>
<a href="#l38.198"></a><span id="l38.198">   if (gRowCount == 1 &amp;&amp; gColCount == 1)</span>
<a href="#l38.199"></a><span id="l38.199">     gDialog.SelectionList.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineat">@@ -249,18 +242,17 @@ function Startup()</span>
<a href="#l38.201"></a><span id="l38.201"> </span>
<a href="#l38.202"></a><span id="l38.202">   // If first initializing, we really aren't changing anything</span>
<a href="#l38.203"></a><span id="l38.203">   gCellDataChanged = false;</span>
<a href="#l38.204"></a><span id="l38.204"> </span>
<a href="#l38.205"></a><span id="l38.205">   SetWindowLocation();</span>
<a href="#l38.206"></a><span id="l38.206"> }</span>
<a href="#l38.207"></a><span id="l38.207"> </span>
<a href="#l38.208"></a><span id="l38.208"> </span>
<a href="#l38.209"></a><span id="l38.209" class="difflineminus">-function InitDialog()</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineminus">-{</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineplus">+function InitDialog() {</span>
<a href="#l38.212"></a><span id="l38.212">   // Get Table attributes</span>
<a href="#l38.213"></a><span id="l38.213">   gDialog.TableRowsInput.value = gRowCount;</span>
<a href="#l38.214"></a><span id="l38.214">   gDialog.TableColumnsInput.value = gColCount;</span>
<a href="#l38.215"></a><span id="l38.215">   gDialog.TableWidthInput.value = InitPixelOrPercentMenulist(globalTableElement, gTableElement, &quot;width&quot;, &quot;TableWidthUnits&quot;, gPercent);</span>
<a href="#l38.216"></a><span id="l38.216">   if (gUseCSS) {</span>
<a href="#l38.217"></a><span id="l38.217">     gDialog.TableHeightInput.value = InitPixelOrPercentMenulist(globalTableElement, gTableElement, &quot;height&quot;,</span>
<a href="#l38.218"></a><span id="l38.218">                                                                 &quot;TableHeightUnits&quot;, gPercent);</span>
<a href="#l38.219"></a><span id="l38.219">   }</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineat">@@ -275,44 +267,41 @@ function InitDialog()</span>
<a href="#l38.221"></a><span id="l38.221">     gDialog.TableAlignList.value = &quot;center&quot;;</span>
<a href="#l38.222"></a><span id="l38.222">   else if (halign == &quot;right right&quot; || halign == &quot;auto 0px&quot;)</span>
<a href="#l38.223"></a><span id="l38.223">     gDialog.TableAlignList.value = &quot;right&quot;;</span>
<a href="#l38.224"></a><span id="l38.224">   else // Default = left</span>
<a href="#l38.225"></a><span id="l38.225">     gDialog.TableAlignList.value = &quot;left&quot;;</span>
<a href="#l38.226"></a><span id="l38.226"> </span>
<a href="#l38.227"></a><span id="l38.227">   // Be sure to get caption from table in doc, not the copied &quot;globalTableElement&quot;</span>
<a href="#l38.228"></a><span id="l38.228">   gTableCaptionElement = gTableElement.caption;</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineminus">-  if (gTableCaptionElement)</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineminus">-  {</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineplus">+  if (gTableCaptionElement) {</span>
<a href="#l38.232"></a><span id="l38.232">     var align = GetHTMLOrCSSStyleValue(gTableCaptionElement, &quot;align&quot;, &quot;caption-side&quot;);</span>
<a href="#l38.233"></a><span id="l38.233">     if (align != &quot;bottom&quot; &amp;&amp; align != &quot;left&quot; &amp;&amp; align != &quot;right&quot;)</span>
<a href="#l38.234"></a><span id="l38.234">       align = &quot;top&quot;;</span>
<a href="#l38.235"></a><span id="l38.235">     gDialog.TableCaptionList.value = align;</span>
<a href="#l38.236"></a><span id="l38.236">   }</span>
<a href="#l38.237"></a><span id="l38.237"> </span>
<a href="#l38.238"></a><span id="l38.238">   gTableColor = GetHTMLOrCSSStyleValue(globalTableElement, bgcolor, cssBackgroundColorStr);</span>
<a href="#l38.239"></a><span id="l38.239">   gTableColor = ConvertRGBColorIntoHEXColor(gTableColor);</span>
<a href="#l38.240"></a><span id="l38.240">   SetColor(&quot;tableBackgroundCW&quot;, gTableColor);</span>
<a href="#l38.241"></a><span id="l38.241"> </span>
<a href="#l38.242"></a><span id="l38.242">   InitCellPanel();</span>
<a href="#l38.243"></a><span id="l38.243"> }</span>
<a href="#l38.244"></a><span id="l38.244"> </span>
<a href="#l38.245"></a><span id="l38.245" class="difflineminus">-function InitCellPanel()</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineminus">-{</span>
<a href="#l38.247"></a><span id="l38.247" class="difflineplus">+function InitCellPanel() {</span>
<a href="#l38.248"></a><span id="l38.248">   // Get cell attributes</span>
<a href="#l38.249"></a><span id="l38.249" class="difflineminus">-  if (globalCellElement)</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineminus">-  {</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineplus">+  if (globalCellElement) {</span>
<a href="#l38.252"></a><span id="l38.252">     // This assumes order of items is Cell, Row, Column</span>
<a href="#l38.253"></a><span id="l38.253">     gDialog.SelectionList.value = gSelectedCellsType;</span>
<a href="#l38.254"></a><span id="l38.254"> </span>
<a href="#l38.255"></a><span id="l38.255">     var previousValue = gDialog.CellHeightInput.value;</span>
<a href="#l38.256"></a><span id="l38.256">     gDialog.CellHeightInput.value = InitPixelOrPercentMenulist(globalCellElement, gCellElement, &quot;height&quot;, &quot;CellHeightUnits&quot;, gPixel);</span>
<a href="#l38.257"></a><span id="l38.257">     gDialog.CellHeightCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousValue != gDialog.CellHeightInput.value;</span>
<a href="#l38.258"></a><span id="l38.258"> </span>
<a href="#l38.259"></a><span id="l38.259" class="difflineminus">-    previousValue= gDialog.CellWidthInput.value;</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineplus">+    previousValue = gDialog.CellWidthInput.value;</span>
<a href="#l38.261"></a><span id="l38.261">     gDialog.CellWidthInput.value = InitPixelOrPercentMenulist(globalCellElement, gCellElement, &quot;width&quot;, &quot;CellWidthUnits&quot;, gPixel);</span>
<a href="#l38.262"></a><span id="l38.262">     gDialog.CellWidthCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousValue != gDialog.CellWidthInput.value;</span>
<a href="#l38.263"></a><span id="l38.263"> </span>
<a href="#l38.264"></a><span id="l38.264">     var previousIndex = gDialog.CellVAlignList.selectedIndex;</span>
<a href="#l38.265"></a><span id="l38.265">     var valign = GetHTMLOrCSSStyleValue(globalCellElement, &quot;valign&quot;, &quot;vertical-align&quot;).toLowerCase();</span>
<a href="#l38.266"></a><span id="l38.266">     if (valign == topStr || valign == bottomStr)</span>
<a href="#l38.267"></a><span id="l38.267">       gDialog.CellVAlignList.value = valign;</span>
<a href="#l38.268"></a><span id="l38.268">     else // Default = middle</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineat">@@ -320,18 +309,17 @@ function InitCellPanel()</span>
<a href="#l38.270"></a><span id="l38.270"> </span>
<a href="#l38.271"></a><span id="l38.271">     gDialog.CellVAlignCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousIndex != gDialog.CellVAlignList.selectedIndex;</span>
<a href="#l38.272"></a><span id="l38.272"> </span>
<a href="#l38.273"></a><span id="l38.273">     previousIndex = gDialog.CellHAlignList.selectedIndex;</span>
<a href="#l38.274"></a><span id="l38.274"> </span>
<a href="#l38.275"></a><span id="l38.275">     gAlignWasChar = false;</span>
<a href="#l38.276"></a><span id="l38.276"> </span>
<a href="#l38.277"></a><span id="l38.277">     var halign = GetHTMLOrCSSStyleValue(globalCellElement, &quot;align&quot;, &quot;text-align&quot;).toLowerCase();</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineminus">-    switch (halign)</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineminus">-    {</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineplus">+    switch (halign) {</span>
<a href="#l38.281"></a><span id="l38.281">       case centerStr:</span>
<a href="#l38.282"></a><span id="l38.282">       case rightStr:</span>
<a href="#l38.283"></a><span id="l38.283">       case justifyStr:</span>
<a href="#l38.284"></a><span id="l38.284">         gDialog.CellHAlignList.value = halign;</span>
<a href="#l38.285"></a><span id="l38.285">         break;</span>
<a href="#l38.286"></a><span id="l38.286">       case charStr:</span>
<a href="#l38.287"></a><span id="l38.287">         // We don't support UI for this because layout doesn't work: bug 2212.</span>
<a href="#l38.288"></a><span id="l38.288">         // Remember that's what they had so we don't change it</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineat">@@ -366,18 +354,17 @@ function InitCellPanel()</span>
<a href="#l38.290"></a><span id="l38.290">     gDialog.CellColorCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousValue != gCellColor;</span>
<a href="#l38.291"></a><span id="l38.291"> </span>
<a href="#l38.292"></a><span id="l38.292">     // We want to set this true in case changes came</span>
<a href="#l38.293"></a><span id="l38.293">     //   from Advanced Edit dialog session (must assume something changed)</span>
<a href="#l38.294"></a><span id="l38.294">     gCellDataChanged = true;</span>
<a href="#l38.295"></a><span id="l38.295">   }</span>
<a href="#l38.296"></a><span id="l38.296"> }</span>
<a href="#l38.297"></a><span id="l38.297"> </span>
<a href="#l38.298"></a><span id="l38.298" class="difflineminus">-function GetCellData(rowIndex, colIndex)</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineminus">-{</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineplus">+function GetCellData(rowIndex, colIndex) {</span>
<a href="#l38.301"></a><span id="l38.301">   // Get actual rowspan and colspan</span>
<a href="#l38.302"></a><span id="l38.302">   var startRowIndexObj = { value: 0 };</span>
<a href="#l38.303"></a><span id="l38.303">   var startColIndexObj = { value: 0 };</span>
<a href="#l38.304"></a><span id="l38.304">   var rowSpanObj = { value: 0 };</span>
<a href="#l38.305"></a><span id="l38.305">   var colSpanObj = { value: 0 };</span>
<a href="#l38.306"></a><span id="l38.306">   var actualRowSpanObj = { value: 0 };</span>
<a href="#l38.307"></a><span id="l38.307">   var actualColSpanObj = { value: 0 };</span>
<a href="#l38.308"></a><span id="l38.308">   var isSelectedObj = { value: false };</span>
<a href="#l38.309"></a><span id="l38.309" class="difflineat">@@ -385,266 +372,231 @@ function GetCellData(rowIndex, colIndex)</span>
<a href="#l38.310"></a><span id="l38.310">   try {</span>
<a href="#l38.311"></a><span id="l38.311">     gActiveEditor.getCellDataAt(gTableElement, rowIndex, colIndex,</span>
<a href="#l38.312"></a><span id="l38.312">                          gCellData,</span>
<a href="#l38.313"></a><span id="l38.313">                          startRowIndexObj, startColIndexObj,</span>
<a href="#l38.314"></a><span id="l38.314">                          rowSpanObj, colSpanObj,</span>
<a href="#l38.315"></a><span id="l38.315">                          actualRowSpanObj, actualColSpanObj, isSelectedObj);</span>
<a href="#l38.316"></a><span id="l38.316">     // We didn't find a cell</span>
<a href="#l38.317"></a><span id="l38.317">     if (!gCellData.value) return false;</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineminus">-  }</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineminus">-  catch(ex) {</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineplus">+  } catch (ex) {</span>
<a href="#l38.321"></a><span id="l38.321">     return false;</span>
<a href="#l38.322"></a><span id="l38.322">   }</span>
<a href="#l38.323"></a><span id="l38.323"> </span>
<a href="#l38.324"></a><span id="l38.324">   gCellData.startRowIndex = startRowIndexObj.value;</span>
<a href="#l38.325"></a><span id="l38.325">   gCellData.startColIndex = startColIndexObj.value;</span>
<a href="#l38.326"></a><span id="l38.326">   gCellData.rowSpan = rowSpanObj.value;</span>
<a href="#l38.327"></a><span id="l38.327">   gCellData.colSpan = colSpanObj.value;</span>
<a href="#l38.328"></a><span id="l38.328">   gCellData.actualRowSpan = actualRowSpanObj.value;</span>
<a href="#l38.329"></a><span id="l38.329">   gCellData.actualColSpan = actualColSpanObj.value;</span>
<a href="#l38.330"></a><span id="l38.330">   gCellData.isSelected = isSelectedObj.value;</span>
<a href="#l38.331"></a><span id="l38.331">   return true;</span>
<a href="#l38.332"></a><span id="l38.332"> }</span>
<a href="#l38.333"></a><span id="l38.333"> </span>
<a href="#l38.334"></a><span id="l38.334" class="difflineminus">-function SelectCellHAlign()</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineminus">-{</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineplus">+function SelectCellHAlign() {</span>
<a href="#l38.337"></a><span id="l38.337">   SetCheckbox(&quot;CellHAlignCheckbox&quot;);</span>
<a href="#l38.338"></a><span id="l38.338">   // Once user changes the alignment,</span>
<a href="#l38.339"></a><span id="l38.339">   //  we lose their original &quot;CharAt&quot; alignment&quot;</span>
<a href="#l38.340"></a><span id="l38.340">   gAlignWasChar = false;</span>
<a href="#l38.341"></a><span id="l38.341"> }</span>
<a href="#l38.342"></a><span id="l38.342"> </span>
<a href="#l38.343"></a><span id="l38.343" class="difflineminus">-function GetColorAndUpdate(ColorWellID)</span>
<a href="#l38.344"></a><span id="l38.344" class="difflineminus">-{</span>
<a href="#l38.345"></a><span id="l38.345" class="difflineplus">+function GetColorAndUpdate(ColorWellID) {</span>
<a href="#l38.346"></a><span id="l38.346">   var colorWell = document.getElementById(ColorWellID);</span>
<a href="#l38.347"></a><span id="l38.347">   if (!colorWell) return;</span>
<a href="#l38.348"></a><span id="l38.348"> </span>
<a href="#l38.349"></a><span id="l38.349" class="difflineminus">-  var colorObj = { Type:&quot;&quot;, TableColor:0, CellColor:0, NoDefault:false, Cancel:false, BackgroundColor:0 };</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineplus">+  var colorObj = { Type: &quot;&quot;, TableColor: 0, CellColor: 0, NoDefault: false, Cancel: false, BackgroundColor: 0 };</span>
<a href="#l38.351"></a><span id="l38.351"> </span>
<a href="#l38.352"></a><span id="l38.352" class="difflineminus">-  switch( ColorWellID )</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineminus">-  {</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineplus">+  switch (ColorWellID) {</span>
<a href="#l38.355"></a><span id="l38.355">     case &quot;tableBackgroundCW&quot;:</span>
<a href="#l38.356"></a><span id="l38.356">       colorObj.Type = &quot;Table&quot;;</span>
<a href="#l38.357"></a><span id="l38.357">       colorObj.TableColor = gTableColor;</span>
<a href="#l38.358"></a><span id="l38.358">       break;</span>
<a href="#l38.359"></a><span id="l38.359">     case &quot;cellBackgroundCW&quot;:</span>
<a href="#l38.360"></a><span id="l38.360">       colorObj.Type = &quot;Cell&quot;;</span>
<a href="#l38.361"></a><span id="l38.361">       colorObj.CellColor = gCellColor;</span>
<a href="#l38.362"></a><span id="l38.362">       break;</span>
<a href="#l38.363"></a><span id="l38.363">   }</span>
<a href="#l38.364"></a><span id="l38.364">   window.openDialog(&quot;chrome://editor/content/EdColorPicker.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, colorObj);</span>
<a href="#l38.365"></a><span id="l38.365"> </span>
<a href="#l38.366"></a><span id="l38.366">   // User canceled the dialog</span>
<a href="#l38.367"></a><span id="l38.367">   if (colorObj.Cancel)</span>
<a href="#l38.368"></a><span id="l38.368">     return;</span>
<a href="#l38.369"></a><span id="l38.369"> </span>
<a href="#l38.370"></a><span id="l38.370" class="difflineminus">-  switch( ColorWellID )</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineminus">-  {</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineplus">+  switch (ColorWellID) {</span>
<a href="#l38.373"></a><span id="l38.373">     case &quot;tableBackgroundCW&quot;:</span>
<a href="#l38.374"></a><span id="l38.374">       gTableColor = colorObj.BackgroundColor;</span>
<a href="#l38.375"></a><span id="l38.375">       SetColor(ColorWellID, gTableColor);</span>
<a href="#l38.376"></a><span id="l38.376">       break;</span>
<a href="#l38.377"></a><span id="l38.377">     case &quot;cellBackgroundCW&quot;:</span>
<a href="#l38.378"></a><span id="l38.378">       gCellColor = colorObj.BackgroundColor;</span>
<a href="#l38.379"></a><span id="l38.379">       SetColor(ColorWellID, gCellColor);</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-      SetCheckbox('CellColorCheckbox');</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineplus">+      SetCheckbox(&quot;CellColorCheckbox&quot;);</span>
<a href="#l38.382"></a><span id="l38.382">       break;</span>
<a href="#l38.383"></a><span id="l38.383">   }</span>
<a href="#l38.384"></a><span id="l38.384"> }</span>
<a href="#l38.385"></a><span id="l38.385"> </span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-function SetColor(ColorWellID, color)</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineminus">-{</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineplus">+function SetColor(ColorWellID, color) {</span>
<a href="#l38.389"></a><span id="l38.389">   // Save the color</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineminus">-  if (ColorWellID == &quot;cellBackgroundCW&quot;)</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineminus">-  {</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineminus">-    if (color)</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineminus">-    {</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineplus">+  if (ColorWellID == &quot;cellBackgroundCW&quot;) {</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineplus">+    if (color) {</span>
<a href="#l38.396"></a><span id="l38.396">       try {</span>
<a href="#l38.397"></a><span id="l38.397">         gActiveEditor.setAttributeOrEquivalent(globalCellElement, bgcolor,</span>
<a href="#l38.398"></a><span id="l38.398">                                                color, true);</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.401"></a><span id="l38.401">       gDialog.CellInheritColor.collapsed = true;</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineminus">-    }</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineminus">-    else</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineminus">-    {</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineplus">+    } else {</span>
<a href="#l38.406"></a><span id="l38.406">       try {</span>
<a href="#l38.407"></a><span id="l38.407">         gActiveEditor.removeAttributeOrEquivalent(globalCellElement, bgcolor, true);</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.410"></a><span id="l38.410">       // Reveal addition message explaining &quot;default&quot; color</span>
<a href="#l38.411"></a><span id="l38.411">       gDialog.CellInheritColor.collapsed = false;</span>
<a href="#l38.412"></a><span id="l38.412">     }</span>
<a href="#l38.413"></a><span id="l38.413" class="difflineminus">-  }</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineminus">-  else</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineminus">-  {</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineminus">-    if (color)</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineminus">-    {</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineplus">+  } else {</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineplus">+    if (color) {</span>
<a href="#l38.420"></a><span id="l38.420">       try {</span>
<a href="#l38.421"></a><span id="l38.421">         gActiveEditor.setAttributeOrEquivalent(globalTableElement, bgcolor,</span>
<a href="#l38.422"></a><span id="l38.422">                                                color, true);</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.424"></a><span id="l38.424" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.425"></a><span id="l38.425">       gDialog.TableInheritColor.collapsed = true;</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineminus">-    }</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineminus">-    else</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineminus">-    {</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineplus">+    } else {</span>
<a href="#l38.430"></a><span id="l38.430">       try {</span>
<a href="#l38.431"></a><span id="l38.431">         gActiveEditor.removeAttributeOrEquivalent(globalTableElement, bgcolor, true);</span>
<a href="#l38.432"></a><span id="l38.432" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.434"></a><span id="l38.434">       gDialog.TableInheritColor.collapsed = false;</span>
<a href="#l38.435"></a><span id="l38.435">     }</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineminus">-    SetCheckbox('CellColorCheckbox');</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineplus">+    SetCheckbox(&quot;CellColorCheckbox&quot;);</span>
<a href="#l38.438"></a><span id="l38.438">   }</span>
<a href="#l38.439"></a><span id="l38.439"> </span>
<a href="#l38.440"></a><span id="l38.440">   setColorWell(ColorWellID, color);</span>
<a href="#l38.441"></a><span id="l38.441"> }</span>
<a href="#l38.442"></a><span id="l38.442"> </span>
<a href="#l38.443"></a><span id="l38.443" class="difflineminus">-function ChangeSelectionToFirstCell()</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineminus">-{</span>
<a href="#l38.445"></a><span id="l38.445" class="difflineminus">-  if (!GetCellData(0,0))</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineminus">-  {</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineplus">+function ChangeSelectionToFirstCell() {</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineplus">+  if (!GetCellData(0, 0)) {</span>
<a href="#l38.449"></a><span id="l38.449">     dump(&quot;Can't find first cell in table!\n&quot;);</span>
<a href="#l38.450"></a><span id="l38.450">     return;</span>
<a href="#l38.451"></a><span id="l38.451">   }</span>
<a href="#l38.452"></a><span id="l38.452">   gCellElement = gCellData.value;</span>
<a href="#l38.453"></a><span id="l38.453">   globalCellElement = gCellElement;</span>
<a href="#l38.454"></a><span id="l38.454"> </span>
<a href="#l38.455"></a><span id="l38.455">   gCurRowIndex = 0;</span>
<a href="#l38.456"></a><span id="l38.456">   gCurColIndex = 0;</span>
<a href="#l38.457"></a><span id="l38.457">   ChangeSelection(RESET_SELECTION);</span>
<a href="#l38.458"></a><span id="l38.458"> }</span>
<a href="#l38.459"></a><span id="l38.459"> </span>
<a href="#l38.460"></a><span id="l38.460" class="difflineminus">-function ChangeSelection(newType)</span>
<a href="#l38.461"></a><span id="l38.461" class="difflineminus">-{</span>
<a href="#l38.462"></a><span id="l38.462" class="difflineplus">+function ChangeSelection(newType) {</span>
<a href="#l38.463"></a><span id="l38.463">   newType = Number(newType);</span>
<a href="#l38.464"></a><span id="l38.464"> </span>
<a href="#l38.465"></a><span id="l38.465">   if (gSelectedCellsType == newType)</span>
<a href="#l38.466"></a><span id="l38.466">     return;</span>
<a href="#l38.467"></a><span id="l38.467"> </span>
<a href="#l38.468"></a><span id="l38.468">   if (newType == RESET_SELECTION)</span>
<a href="#l38.469"></a><span id="l38.469">     // Restore selection to existing focus cell</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineminus">-    gSelection.collapse(gCellElement,0);</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineplus">+    gSelection.collapse(gCellElement, 0);</span>
<a href="#l38.472"></a><span id="l38.472">   else</span>
<a href="#l38.473"></a><span id="l38.473">     gSelectedCellsType = newType;</span>
<a href="#l38.474"></a><span id="l38.474"> </span>
<a href="#l38.475"></a><span id="l38.475">   // Keep the same focus gCellElement, just change the type</span>
<a href="#l38.476"></a><span id="l38.476">   DoCellSelection();</span>
<a href="#l38.477"></a><span id="l38.477">   SetSelectionButtons();</span>
<a href="#l38.478"></a><span id="l38.478"> </span>
<a href="#l38.479"></a><span id="l38.479">   // Note: globalCellElement should still be a clone of gCellElement</span>
<a href="#l38.480"></a><span id="l38.480"> }</span>
<a href="#l38.481"></a><span id="l38.481"> </span>
<a href="#l38.482"></a><span id="l38.482" class="difflineminus">-function MoveSelection(forward)</span>
<a href="#l38.483"></a><span id="l38.483" class="difflineminus">-{</span>
<a href="#l38.484"></a><span id="l38.484" class="difflineplus">+function MoveSelection(forward) {</span>
<a href="#l38.485"></a><span id="l38.485">   var newRowIndex = gCurRowIndex;</span>
<a href="#l38.486"></a><span id="l38.486">   var newColIndex = gCurColIndex;</span>
<a href="#l38.487"></a><span id="l38.487">   var focusCell;</span>
<a href="#l38.488"></a><span id="l38.488">   var inRow = false;</span>
<a href="#l38.489"></a><span id="l38.489"> </span>
<a href="#l38.490"></a><span id="l38.490" class="difflineminus">-  if (gSelectedCellsType == SELECT_ROW)</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-  {</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineplus">+  if (gSelectedCellsType == SELECT_ROW) {</span>
<a href="#l38.493"></a><span id="l38.493">     newRowIndex += (forward ? 1 : -1);</span>
<a href="#l38.494"></a><span id="l38.494"> </span>
<a href="#l38.495"></a><span id="l38.495">     // Wrap around if before first or after last row</span>
<a href="#l38.496"></a><span id="l38.496">     if (newRowIndex &lt; 0)</span>
<a href="#l38.497"></a><span id="l38.497">       newRowIndex = gLastRowIndex;</span>
<a href="#l38.498"></a><span id="l38.498">     else if (newRowIndex &gt; gLastRowIndex)</span>
<a href="#l38.499"></a><span id="l38.499">       newRowIndex = 0;</span>
<a href="#l38.500"></a><span id="l38.500">     inRow = true;</span>
<a href="#l38.501"></a><span id="l38.501"> </span>
<a href="#l38.502"></a><span id="l38.502">     // Use first cell in row for focus cell</span>
<a href="#l38.503"></a><span id="l38.503">     newColIndex = 0;</span>
<a href="#l38.504"></a><span id="l38.504" class="difflineminus">-  }</span>
<a href="#l38.505"></a><span id="l38.505" class="difflineminus">-  else</span>
<a href="#l38.506"></a><span id="l38.506" class="difflineminus">-  {</span>
<a href="#l38.507"></a><span id="l38.507" class="difflineplus">+  } else {</span>
<a href="#l38.508"></a><span id="l38.508">     // Cell or column:</span>
<a href="#l38.509"></a><span id="l38.509">     if (!forward)</span>
<a href="#l38.510"></a><span id="l38.510">       newColIndex--;</span>
<a href="#l38.511"></a><span id="l38.511"> </span>
<a href="#l38.512"></a><span id="l38.512" class="difflineminus">-    if (gSelectedCellsType == SELECT_CELL)</span>
<a href="#l38.513"></a><span id="l38.513" class="difflineminus">-    {</span>
<a href="#l38.514"></a><span id="l38.514" class="difflineplus">+    if (gSelectedCellsType == SELECT_CELL) {</span>
<a href="#l38.515"></a><span id="l38.515">       // Skip to next cell</span>
<a href="#l38.516"></a><span id="l38.516">       if (forward)</span>
<a href="#l38.517"></a><span id="l38.517">         newColIndex += gCurColSpan;</span>
<a href="#l38.518"></a><span id="l38.518" class="difflineminus">-    }</span>
<a href="#l38.519"></a><span id="l38.519" class="difflineminus">-    else  // SELECT_COLUMN</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineplus">+    } else  // SELECT_COLUMN</span>
<a href="#l38.521"></a><span id="l38.521">     {</span>
<a href="#l38.522"></a><span id="l38.522">       // Use first cell in column for focus cell</span>
<a href="#l38.523"></a><span id="l38.523">       newRowIndex = 0;</span>
<a href="#l38.524"></a><span id="l38.524"> </span>
<a href="#l38.525"></a><span id="l38.525">       // Don't skip by colspan,</span>
<a href="#l38.526"></a><span id="l38.526">       //  but find first cell in next cellmap column</span>
<a href="#l38.527"></a><span id="l38.527">       if (forward)</span>
<a href="#l38.528"></a><span id="l38.528">         newColIndex++;</span>
<a href="#l38.529"></a><span id="l38.529">     }</span>
<a href="#l38.530"></a><span id="l38.530"> </span>
<a href="#l38.531"></a><span id="l38.531" class="difflineminus">-    if (newColIndex &lt; 0)</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineminus">-    {</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineplus">+    if (newColIndex &lt; 0) {</span>
<a href="#l38.534"></a><span id="l38.534">       // Request is before the first cell in column</span>
<a href="#l38.535"></a><span id="l38.535"> </span>
<a href="#l38.536"></a><span id="l38.536">       // Wrap to last cell in column</span>
<a href="#l38.537"></a><span id="l38.537">       newColIndex = gLastColIndex;</span>
<a href="#l38.538"></a><span id="l38.538"> </span>
<a href="#l38.539"></a><span id="l38.539" class="difflineminus">-      if (gSelectedCellsType == SELECT_CELL)</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineminus">-      {</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineplus">+      if (gSelectedCellsType == SELECT_CELL) {</span>
<a href="#l38.542"></a><span id="l38.542">         // If moving by cell, also wrap to previous...</span>
<a href="#l38.543"></a><span id="l38.543">         if (newRowIndex &gt; 0)</span>
<a href="#l38.544"></a><span id="l38.544">           newRowIndex -= 1;</span>
<a href="#l38.545"></a><span id="l38.545">         else</span>
<a href="#l38.546"></a><span id="l38.546">           // ...or the last row</span>
<a href="#l38.547"></a><span id="l38.547">           newRowIndex = gLastRowIndex;</span>
<a href="#l38.548"></a><span id="l38.548"> </span>
<a href="#l38.549"></a><span id="l38.549">         inRow = true;</span>
<a href="#l38.550"></a><span id="l38.550">       }</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineminus">-    }</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineminus">-    else if (newColIndex &gt; gLastColIndex)</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineminus">-    {</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineplus">+    } else if (newColIndex &gt; gLastColIndex) {</span>
<a href="#l38.555"></a><span id="l38.555">       // Request is after the last cell in column</span>
<a href="#l38.556"></a><span id="l38.556"> </span>
<a href="#l38.557"></a><span id="l38.557">       // Wrap to first cell in column</span>
<a href="#l38.558"></a><span id="l38.558">       newColIndex = 0;</span>
<a href="#l38.559"></a><span id="l38.559"> </span>
<a href="#l38.560"></a><span id="l38.560" class="difflineminus">-      if (gSelectedCellsType == SELECT_CELL)</span>
<a href="#l38.561"></a><span id="l38.561" class="difflineminus">-      {</span>
<a href="#l38.562"></a><span id="l38.562" class="difflineplus">+      if (gSelectedCellsType == SELECT_CELL) {</span>
<a href="#l38.563"></a><span id="l38.563">         // If moving by cell, also wrap to next...</span>
<a href="#l38.564"></a><span id="l38.564">         if (newRowIndex &lt; gLastRowIndex)</span>
<a href="#l38.565"></a><span id="l38.565">           newRowIndex++;</span>
<a href="#l38.566"></a><span id="l38.566">         else</span>
<a href="#l38.567"></a><span id="l38.567">           // ...or the first row</span>
<a href="#l38.568"></a><span id="l38.568">           newRowIndex = 0;</span>
<a href="#l38.569"></a><span id="l38.569"> </span>
<a href="#l38.570"></a><span id="l38.570">         inRow = true;</span>
<a href="#l38.571"></a><span id="l38.571">       }</span>
<a href="#l38.572"></a><span id="l38.572">     }</span>
<a href="#l38.573"></a><span id="l38.573">   }</span>
<a href="#l38.574"></a><span id="l38.574"> </span>
<a href="#l38.575"></a><span id="l38.575">   // Get the cell at the new location</span>
<a href="#l38.576"></a><span id="l38.576">   do {</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineminus">-    if (!GetCellData(newRowIndex, newColIndex))</span>
<a href="#l38.578"></a><span id="l38.578" class="difflineminus">-    {</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineplus">+    if (!GetCellData(newRowIndex, newColIndex)) {</span>
<a href="#l38.580"></a><span id="l38.580">       dump(&quot;MoveSelection: CELL NOT FOUND\n&quot;);</span>
<a href="#l38.581"></a><span id="l38.581">       return;</span>
<a href="#l38.582"></a><span id="l38.582">     }</span>
<a href="#l38.583"></a><span id="l38.583" class="difflineminus">-    if (inRow)</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineminus">-    {</span>
<a href="#l38.585"></a><span id="l38.585" class="difflineplus">+    if (inRow) {</span>
<a href="#l38.586"></a><span id="l38.586">       if (gCellData.startRowIndex == newRowIndex)</span>
<a href="#l38.587"></a><span id="l38.587">         break;</span>
<a href="#l38.588"></a><span id="l38.588">       else</span>
<a href="#l38.589"></a><span id="l38.589">         // Cell spans from a row above, look for the next cell in row</span>
<a href="#l38.590"></a><span id="l38.590">         newRowIndex += gCellData.actualRowSpan;</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineminus">-    }</span>
<a href="#l38.592"></a><span id="l38.592" class="difflineminus">-    else</span>
<a href="#l38.593"></a><span id="l38.593" class="difflineminus">-    {</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineminus">-      if (gCellData.startColIndex == newColIndex)</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineplus">+    } else if (gCellData.startColIndex == newColIndex)</span>
<a href="#l38.596"></a><span id="l38.596">         break;</span>
<a href="#l38.597"></a><span id="l38.597">       else</span>
<a href="#l38.598"></a><span id="l38.598">         // Cell spans from a Col above, look for the next cell in column</span>
<a href="#l38.599"></a><span id="l38.599">         newColIndex += gCellData.actualColSpan;</span>
<a href="#l38.600"></a><span id="l38.600" class="difflineminus">-    }</span>
<a href="#l38.601"></a><span id="l38.601">   }</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineminus">-  while(true);</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineplus">+  while (true);</span>
<a href="#l38.604"></a><span id="l38.604"> </span>
<a href="#l38.605"></a><span id="l38.605">   // Save data for current selection before changing</span>
<a href="#l38.606"></a><span id="l38.606">   if (gCellDataChanged) // &amp;&amp; gDialog.ApplyBeforeMove.checked)</span>
<a href="#l38.607"></a><span id="l38.607">   {</span>
<a href="#l38.608"></a><span id="l38.608">     if (!ValidateCellData())</span>
<a href="#l38.609"></a><span id="l38.609">       return;</span>
<a href="#l38.610"></a><span id="l38.610"> </span>
<a href="#l38.611"></a><span id="l38.611">     gActiveEditor.beginTransaction();</span>
<a href="#l38.612"></a><span id="l38.612" class="difflineat">@@ -681,30 +633,28 @@ function MoveSelection(forward)</span>
<a href="#l38.613"></a><span id="l38.613"> //  if (!gDialog.KeepCurrentData.checked)</span>
<a href="#l38.614"></a><span id="l38.614">   // Setting this false unchecks all &quot;set attributes&quot; checkboxes</span>
<a href="#l38.615"></a><span id="l38.615">   gAdvancedEditUsed = false;</span>
<a href="#l38.616"></a><span id="l38.616">   InitCellPanel();</span>
<a href="#l38.617"></a><span id="l38.617">   gAdvancedEditUsed = true;</span>
<a href="#l38.618"></a><span id="l38.618"> }</span>
<a href="#l38.619"></a><span id="l38.619"> </span>
<a href="#l38.620"></a><span id="l38.620"> </span>
<a href="#l38.621"></a><span id="l38.621" class="difflineminus">-function DoCellSelection()</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineminus">-{</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineplus">+function DoCellSelection() {</span>
<a href="#l38.624"></a><span id="l38.624">   // Collapse selection into to the focus cell</span>
<a href="#l38.625"></a><span id="l38.625">   //  so editor uses that as start cell</span>
<a href="#l38.626"></a><span id="l38.626">   gSelection.collapse(gCellElement, 0);</span>
<a href="#l38.627"></a><span id="l38.627"> </span>
<a href="#l38.628"></a><span id="l38.628">   var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l38.629"></a><span id="l38.629">   var countObj = { value: 0 };</span>
<a href="#l38.630"></a><span id="l38.630">   try {</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineminus">-    switch (gSelectedCellsType)</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineminus">-    {</span>
<a href="#l38.633"></a><span id="l38.633" class="difflineplus">+    switch (gSelectedCellsType) {</span>
<a href="#l38.634"></a><span id="l38.634">       case SELECT_CELL:</span>
<a href="#l38.635"></a><span id="l38.635">         gActiveEditor.selectTableCell();</span>
<a href="#l38.636"></a><span id="l38.636" class="difflineminus">-        break</span>
<a href="#l38.637"></a><span id="l38.637" class="difflineplus">+        break;</span>
<a href="#l38.638"></a><span id="l38.638">       case SELECT_ROW:</span>
<a href="#l38.639"></a><span id="l38.639">         gActiveEditor.selectTableRow();</span>
<a href="#l38.640"></a><span id="l38.640">         break;</span>
<a href="#l38.641"></a><span id="l38.641">       default:</span>
<a href="#l38.642"></a><span id="l38.642">         gActiveEditor.selectTableColumn();</span>
<a href="#l38.643"></a><span id="l38.643">         break;</span>
<a href="#l38.644"></a><span id="l38.644">     }</span>
<a href="#l38.645"></a><span id="l38.645">     // Get number of cells selected</span>
<a href="#l38.646"></a><span id="l38.646" class="difflineat">@@ -720,87 +670,72 @@ function DoCellSelection()</span>
<a href="#l38.647"></a><span id="l38.647">   //   else we ignore CSS, JS, and HTML attributes not already in dialog</span>
<a href="#l38.648"></a><span id="l38.648">   SetElementEnabled(gDialog.AdvancedEditCell, gSelectedCellCount == 1);</span>
<a href="#l38.649"></a><span id="l38.649"> </span>
<a href="#l38.650"></a><span id="l38.650">   gDialog.AdvancedEditCell.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l38.651"></a><span id="l38.651">     gSelectedCellCount &gt; 1 ? GetString(&quot;AdvancedEditForCellMsg&quot;) :</span>
<a href="#l38.652"></a><span id="l38.652">                              gDialog.AdvancedEditCellToolTipText);</span>
<a href="#l38.653"></a><span id="l38.653"> }</span>
<a href="#l38.654"></a><span id="l38.654"> </span>
<a href="#l38.655"></a><span id="l38.655" class="difflineminus">-function SetSelectionButtons()</span>
<a href="#l38.656"></a><span id="l38.656" class="difflineminus">-{</span>
<a href="#l38.657"></a><span id="l38.657" class="difflineminus">-  if (gSelectedCellsType == SELECT_ROW)</span>
<a href="#l38.658"></a><span id="l38.658" class="difflineminus">-  {</span>
<a href="#l38.659"></a><span id="l38.659" class="difflineplus">+function SetSelectionButtons() {</span>
<a href="#l38.660"></a><span id="l38.660" class="difflineplus">+  if (gSelectedCellsType == SELECT_ROW) {</span>
<a href="#l38.661"></a><span id="l38.661">     // Trigger CSS to set images of up and down arrows</span>
<a href="#l38.662"></a><span id="l38.662" class="difflineminus">-    gDialog.PreviousButton.setAttribute(&quot;type&quot;,&quot;row&quot;);</span>
<a href="#l38.663"></a><span id="l38.663" class="difflineminus">-    gDialog.NextButton.setAttribute(&quot;type&quot;,&quot;row&quot;);</span>
<a href="#l38.664"></a><span id="l38.664" class="difflineminus">-  }</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineminus">-  else</span>
<a href="#l38.666"></a><span id="l38.666" class="difflineminus">-  {</span>
<a href="#l38.667"></a><span id="l38.667" class="difflineplus">+    gDialog.PreviousButton.setAttribute(&quot;type&quot;, &quot;row&quot;);</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineplus">+    gDialog.NextButton.setAttribute(&quot;type&quot;, &quot;row&quot;);</span>
<a href="#l38.669"></a><span id="l38.669" class="difflineplus">+  } else {</span>
<a href="#l38.670"></a><span id="l38.670">     // or images of left and right arrows</span>
<a href="#l38.671"></a><span id="l38.671" class="difflineminus">-    gDialog.PreviousButton.setAttribute(&quot;type&quot;,&quot;col&quot;);</span>
<a href="#l38.672"></a><span id="l38.672" class="difflineminus">-    gDialog.NextButton.setAttribute(&quot;type&quot;,&quot;col&quot;);</span>
<a href="#l38.673"></a><span id="l38.673" class="difflineplus">+    gDialog.PreviousButton.setAttribute(&quot;type&quot;, &quot;col&quot;);</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineplus">+    gDialog.NextButton.setAttribute(&quot;type&quot;, &quot;col&quot;);</span>
<a href="#l38.675"></a><span id="l38.675">   }</span>
<a href="#l38.676"></a><span id="l38.676">   DisableSelectionButtons((gSelectedCellsType == SELECT_ROW &amp;&amp; gRowCount == 1) ||</span>
<a href="#l38.677"></a><span id="l38.677">                           (gSelectedCellsType == SELECT_COLUMN &amp;&amp; gColCount == 1) ||</span>
<a href="#l38.678"></a><span id="l38.678">                           (gRowCount == 1 &amp;&amp; gColCount == 1));</span>
<a href="#l38.679"></a><span id="l38.679"> }</span>
<a href="#l38.680"></a><span id="l38.680"> </span>
<a href="#l38.681"></a><span id="l38.681" class="difflineminus">-function DisableSelectionButtons( disable )</span>
<a href="#l38.682"></a><span id="l38.682" class="difflineminus">-{</span>
<a href="#l38.683"></a><span id="l38.683" class="difflineplus">+function DisableSelectionButtons(disable) {</span>
<a href="#l38.684"></a><span id="l38.684">   gDialog.PreviousButton.setAttribute(&quot;disabled&quot;, disable ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l38.685"></a><span id="l38.685">   gDialog.NextButton.setAttribute(&quot;disabled&quot;, disable ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l38.686"></a><span id="l38.686"> }</span>
<a href="#l38.687"></a><span id="l38.687"> </span>
<a href="#l38.688"></a><span id="l38.688" class="difflineminus">-function SwitchToValidatePanel()</span>
<a href="#l38.689"></a><span id="l38.689" class="difflineminus">-{</span>
<a href="#l38.690"></a><span id="l38.690" class="difflineplus">+function SwitchToValidatePanel() {</span>
<a href="#l38.691"></a><span id="l38.691">   if (gDialog.TabBox.selectedTab != gValidateTab)</span>
<a href="#l38.692"></a><span id="l38.692">     gDialog.TabBox.selectedTab = gValidateTab;</span>
<a href="#l38.693"></a><span id="l38.693"> }</span>
<a href="#l38.694"></a><span id="l38.694"> </span>
<a href="#l38.695"></a><span id="l38.695" class="difflineminus">-function SetAlign(listID, defaultValue, element, attName)</span>
<a href="#l38.696"></a><span id="l38.696" class="difflineminus">-{</span>
<a href="#l38.697"></a><span id="l38.697" class="difflineplus">+function SetAlign(listID, defaultValue, element, attName) {</span>
<a href="#l38.698"></a><span id="l38.698">   var value = document.getElementById(listID).value;</span>
<a href="#l38.699"></a><span id="l38.699" class="difflineminus">-  if (value == defaultValue)</span>
<a href="#l38.700"></a><span id="l38.700" class="difflineminus">-  {</span>
<a href="#l38.701"></a><span id="l38.701" class="difflineplus">+  if (value == defaultValue) {</span>
<a href="#l38.702"></a><span id="l38.702">     try {</span>
<a href="#l38.703"></a><span id="l38.703">       gActiveEditor.removeAttributeOrEquivalent(element, attName, true);</span>
<a href="#l38.704"></a><span id="l38.704" class="difflineminus">-    } catch(e) {}</span>
<a href="#l38.705"></a><span id="l38.705" class="difflineminus">-  }</span>
<a href="#l38.706"></a><span id="l38.706" class="difflineminus">-  else</span>
<a href="#l38.707"></a><span id="l38.707" class="difflineminus">-  {</span>
<a href="#l38.708"></a><span id="l38.708" class="difflineplus">+    } catch (e) {}</span>
<a href="#l38.709"></a><span id="l38.709" class="difflineplus">+  } else {</span>
<a href="#l38.710"></a><span id="l38.710">     try {</span>
<a href="#l38.711"></a><span id="l38.711">       gActiveEditor.setAttributeOrEquivalent(element, attName, value, true);</span>
<a href="#l38.712"></a><span id="l38.712" class="difflineminus">-    } catch(e) {}</span>
<a href="#l38.713"></a><span id="l38.713" class="difflineplus">+    } catch (e) {}</span>
<a href="#l38.714"></a><span id="l38.714">   }</span>
<a href="#l38.715"></a><span id="l38.715"> }</span>
<a href="#l38.716"></a><span id="l38.716"> </span>
<a href="#l38.717"></a><span id="l38.717" class="difflineminus">-function ValidateTableData()</span>
<a href="#l38.718"></a><span id="l38.718" class="difflineminus">-{</span>
<a href="#l38.719"></a><span id="l38.719" class="difflineplus">+function ValidateTableData() {</span>
<a href="#l38.720"></a><span id="l38.720">   gValidateTab = gDialog.TableTab;</span>
<a href="#l38.721"></a><span id="l38.721">   gNewRowCount = Number(ValidateNumber(gDialog.TableRowsInput, null, 1, gMaxRows, null, true, true));</span>
<a href="#l38.722"></a><span id="l38.722">   if (gValidationError) return false;</span>
<a href="#l38.723"></a><span id="l38.723"> </span>
<a href="#l38.724"></a><span id="l38.724">   gNewColCount = Number(ValidateNumber(gDialog.TableColumnsInput, null, 1, gMaxColumns, null, true, true));</span>
<a href="#l38.725"></a><span id="l38.725">   if (gValidationError) return false;</span>
<a href="#l38.726"></a><span id="l38.726"> </span>
<a href="#l38.727"></a><span id="l38.727">   // If user is deleting any cells, get confirmation</span>
<a href="#l38.728"></a><span id="l38.728">   // (This is a global to the dialog and we ask only once per dialog session)</span>
<a href="#l38.729"></a><span id="l38.729" class="difflineminus">-  if ( !gCanDelete &amp;&amp;</span>
<a href="#l38.730"></a><span id="l38.730" class="difflineplus">+  if (!gCanDelete &amp;&amp;</span>
<a href="#l38.731"></a><span id="l38.731">         (gNewRowCount &lt; gRowCount ||</span>
<a href="#l38.732"></a><span id="l38.732" class="difflineminus">-         gNewColCount &lt; gColCount) )</span>
<a href="#l38.733"></a><span id="l38.733" class="difflineminus">-  {</span>
<a href="#l38.734"></a><span id="l38.734" class="difflineplus">+         gNewColCount &lt; gColCount)) {</span>
<a href="#l38.735"></a><span id="l38.735">     if (ConfirmWithTitle(GetString(&quot;DeleteTableTitle&quot;),</span>
<a href="#l38.736"></a><span id="l38.736">                          GetString(&quot;DeleteTableMsg&quot;),</span>
<a href="#l38.737"></a><span id="l38.737" class="difflineminus">-                         GetString(&quot;DeleteCells&quot;)) )</span>
<a href="#l38.738"></a><span id="l38.738" class="difflineminus">-    {</span>
<a href="#l38.739"></a><span id="l38.739" class="difflineplus">+                         GetString(&quot;DeleteCells&quot;))) {</span>
<a href="#l38.740"></a><span id="l38.740">       gCanDelete = true;</span>
<a href="#l38.741"></a><span id="l38.741" class="difflineminus">-    }</span>
<a href="#l38.742"></a><span id="l38.742" class="difflineminus">-    else</span>
<a href="#l38.743"></a><span id="l38.743" class="difflineminus">-    {</span>
<a href="#l38.744"></a><span id="l38.744" class="difflineplus">+    } else {</span>
<a href="#l38.745"></a><span id="l38.745">       SetTextboxFocus(gNewRowCount &lt; gRowCount ? gDialog.TableRowsInput : gDialog.TableColumnsInput);</span>
<a href="#l38.746"></a><span id="l38.746">       return false;</span>
<a href="#l38.747"></a><span id="l38.747">     }</span>
<a href="#l38.748"></a><span id="l38.748">   }</span>
<a href="#l38.749"></a><span id="l38.749"> </span>
<a href="#l38.750"></a><span id="l38.750">   ValidateNumber(gDialog.TableWidthInput, gDialog.TableWidthUnits,</span>
<a href="#l38.751"></a><span id="l38.751">                  1, gMaxTableSize, globalTableElement, &quot;width&quot;);</span>
<a href="#l38.752"></a><span id="l38.752">   if (gValidationError) return false;</span>
<a href="#l38.753"></a><span id="l38.753" class="difflineat">@@ -822,458 +757,397 @@ function ValidateTableData()</span>
<a href="#l38.754"></a><span id="l38.754">   if (gValidationError) return false;</span>
<a href="#l38.755"></a><span id="l38.755"> </span>
<a href="#l38.756"></a><span id="l38.756">   SetAlign(&quot;TableAlignList&quot;, defHAlign, globalTableElement, &quot;align&quot;);</span>
<a href="#l38.757"></a><span id="l38.757"> </span>
<a href="#l38.758"></a><span id="l38.758">   // Color is set on globalCellElement immediately</span>
<a href="#l38.759"></a><span id="l38.759">   return true;</span>
<a href="#l38.760"></a><span id="l38.760"> }</span>
<a href="#l38.761"></a><span id="l38.761"> </span>
<a href="#l38.762"></a><span id="l38.762" class="difflineminus">-function ValidateCellData()</span>
<a href="#l38.763"></a><span id="l38.763" class="difflineminus">-{</span>
<a href="#l38.764"></a><span id="l38.764" class="difflineminus">-</span>
<a href="#l38.765"></a><span id="l38.765" class="difflineplus">+function ValidateCellData() {</span>
<a href="#l38.766"></a><span id="l38.766">   gValidateTab = gDialog.CellTab;</span>
<a href="#l38.767"></a><span id="l38.767"> </span>
<a href="#l38.768"></a><span id="l38.768" class="difflineminus">-  if (gDialog.CellHeightCheckbox.checked)</span>
<a href="#l38.769"></a><span id="l38.769" class="difflineminus">-  {</span>
<a href="#l38.770"></a><span id="l38.770" class="difflineplus">+  if (gDialog.CellHeightCheckbox.checked) {</span>
<a href="#l38.771"></a><span id="l38.771">     ValidateNumber(gDialog.CellHeightInput, gDialog.CellHeightUnits,</span>
<a href="#l38.772"></a><span id="l38.772">                     1, gMaxTableSize, globalCellElement, &quot;height&quot;);</span>
<a href="#l38.773"></a><span id="l38.773">     if (gValidationError) return false;</span>
<a href="#l38.774"></a><span id="l38.774">   }</span>
<a href="#l38.775"></a><span id="l38.775"> </span>
<a href="#l38.776"></a><span id="l38.776" class="difflineminus">-  if (gDialog.CellWidthCheckbox.checked)</span>
<a href="#l38.777"></a><span id="l38.777" class="difflineminus">-  {</span>
<a href="#l38.778"></a><span id="l38.778" class="difflineplus">+  if (gDialog.CellWidthCheckbox.checked) {</span>
<a href="#l38.779"></a><span id="l38.779">     ValidateNumber(gDialog.CellWidthInput, gDialog.CellWidthUnits,</span>
<a href="#l38.780"></a><span id="l38.780">                    1, gMaxTableSize, globalCellElement, &quot;width&quot;);</span>
<a href="#l38.781"></a><span id="l38.781">     if (gValidationError) return false;</span>
<a href="#l38.782"></a><span id="l38.782">   }</span>
<a href="#l38.783"></a><span id="l38.783"> </span>
<a href="#l38.784"></a><span id="l38.784" class="difflineminus">-  if (gDialog.CellHAlignCheckbox.checked)</span>
<a href="#l38.785"></a><span id="l38.785" class="difflineminus">-  {</span>
<a href="#l38.786"></a><span id="l38.786" class="difflineplus">+  if (gDialog.CellHAlignCheckbox.checked) {</span>
<a href="#l38.787"></a><span id="l38.787">     var hAlign = gDialog.CellHAlignList.value;</span>
<a href="#l38.788"></a><span id="l38.788"> </span>
<a href="#l38.789"></a><span id="l38.789">     // Horizontal alignment is complicated by &quot;char&quot; type</span>
<a href="#l38.790"></a><span id="l38.790">     // We don't change current values if user didn't edit alignment</span>
<a href="#l38.791"></a><span id="l38.791" class="difflineminus">-    if (!gAlignWasChar)</span>
<a href="#l38.792"></a><span id="l38.792" class="difflineminus">-    {</span>
<a href="#l38.793"></a><span id="l38.793" class="difflineplus">+    if (!gAlignWasChar) {</span>
<a href="#l38.794"></a><span id="l38.794">       globalCellElement.removeAttribute(charStr);</span>
<a href="#l38.795"></a><span id="l38.795"> </span>
<a href="#l38.796"></a><span id="l38.796">       // Always set &quot;align&quot; attribute,</span>
<a href="#l38.797"></a><span id="l38.797">       //  so the default &quot;left&quot; is effective in a cell</span>
<a href="#l38.798"></a><span id="l38.798">       //  when parent row has align set.</span>
<a href="#l38.799"></a><span id="l38.799">       globalCellElement.setAttribute(&quot;align&quot;, hAlign);</span>
<a href="#l38.800"></a><span id="l38.800">     }</span>
<a href="#l38.801"></a><span id="l38.801">   }</span>
<a href="#l38.802"></a><span id="l38.802"> </span>
<a href="#l38.803"></a><span id="l38.803" class="difflineminus">-  if (gDialog.CellVAlignCheckbox.checked)</span>
<a href="#l38.804"></a><span id="l38.804" class="difflineminus">-  {</span>
<a href="#l38.805"></a><span id="l38.805" class="difflineplus">+  if (gDialog.CellVAlignCheckbox.checked) {</span>
<a href="#l38.806"></a><span id="l38.806">     // Always set valign (no default in 2nd param) so</span>
<a href="#l38.807"></a><span id="l38.807">     //  the default &quot;middle&quot; is effective in a cell</span>
<a href="#l38.808"></a><span id="l38.808">     //  when parent row has valign set.</span>
<a href="#l38.809"></a><span id="l38.809">     SetAlign(&quot;CellVAlignList&quot;, &quot;&quot;, globalCellElement, &quot;valign&quot;);</span>
<a href="#l38.810"></a><span id="l38.810">   }</span>
<a href="#l38.811"></a><span id="l38.811"> </span>
<a href="#l38.812"></a><span id="l38.812" class="difflineminus">-  if (gDialog.TextWrapCheckbox.checked)</span>
<a href="#l38.813"></a><span id="l38.813" class="difflineminus">-  {</span>
<a href="#l38.814"></a><span id="l38.814" class="difflineplus">+  if (gDialog.TextWrapCheckbox.checked) {</span>
<a href="#l38.815"></a><span id="l38.815">     if (gDialog.TextWrapList.value == &quot;nowrap&quot;)</span>
<a href="#l38.816"></a><span id="l38.816">       try {</span>
<a href="#l38.817"></a><span id="l38.817">         gActiveEditor.setAttributeOrEquivalent(globalCellElement, &quot;nowrap&quot;,</span>
<a href="#l38.818"></a><span id="l38.818">                                                &quot;nowrap&quot;, true);</span>
<a href="#l38.819"></a><span id="l38.819" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.820"></a><span id="l38.820" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.821"></a><span id="l38.821">     else</span>
<a href="#l38.822"></a><span id="l38.822">       try {</span>
<a href="#l38.823"></a><span id="l38.823">         gActiveEditor.removeAttributeOrEquivalent(globalCellElement, &quot;nowrap&quot;, true);</span>
<a href="#l38.824"></a><span id="l38.824" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.825"></a><span id="l38.825" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.826"></a><span id="l38.826">   }</span>
<a href="#l38.827"></a><span id="l38.827"> </span>
<a href="#l38.828"></a><span id="l38.828">   return true;</span>
<a href="#l38.829"></a><span id="l38.829"> }</span>
<a href="#l38.830"></a><span id="l38.830"> </span>
<a href="#l38.831"></a><span id="l38.831" class="difflineminus">-function ValidateData()</span>
<a href="#l38.832"></a><span id="l38.832" class="difflineminus">-{</span>
<a href="#l38.833"></a><span id="l38.833" class="difflineplus">+function ValidateData() {</span>
<a href="#l38.834"></a><span id="l38.834">   var result;</span>
<a href="#l38.835"></a><span id="l38.835"> </span>
<a href="#l38.836"></a><span id="l38.836">   // Validate current panel first</span>
<a href="#l38.837"></a><span id="l38.837" class="difflineminus">-  if (gDialog.TabBox.selectedTab == gDialog.TableTab)</span>
<a href="#l38.838"></a><span id="l38.838" class="difflineminus">-  {</span>
<a href="#l38.839"></a><span id="l38.839" class="difflineplus">+  if (gDialog.TabBox.selectedTab == gDialog.TableTab) {</span>
<a href="#l38.840"></a><span id="l38.840">     result = ValidateTableData();</span>
<a href="#l38.841"></a><span id="l38.841">     if (result)</span>
<a href="#l38.842"></a><span id="l38.842">       result = ValidateCellData();</span>
<a href="#l38.843"></a><span id="l38.843">   } else {</span>
<a href="#l38.844"></a><span id="l38.844">     result = ValidateCellData();</span>
<a href="#l38.845"></a><span id="l38.845">     if (result)</span>
<a href="#l38.846"></a><span id="l38.846">       result = ValidateTableData();</span>
<a href="#l38.847"></a><span id="l38.847">   }</span>
<a href="#l38.848"></a><span id="l38.848" class="difflineminus">-  if(!result) return false;</span>
<a href="#l38.849"></a><span id="l38.849" class="difflineplus">+  if (!result) return false;</span>
<a href="#l38.850"></a><span id="l38.850"> </span>
<a href="#l38.851"></a><span id="l38.851">   // Set global element for AdvancedEdit</span>
<a href="#l38.852"></a><span id="l38.852" class="difflineminus">-  if(gDialog.TabBox.selectedTab == gDialog.TableTab)</span>
<a href="#l38.853"></a><span id="l38.853" class="difflineplus">+  if (gDialog.TabBox.selectedTab == gDialog.TableTab)</span>
<a href="#l38.854"></a><span id="l38.854">     globalElement = globalTableElement;</span>
<a href="#l38.855"></a><span id="l38.855">   else</span>
<a href="#l38.856"></a><span id="l38.856">     globalElement = globalCellElement;</span>
<a href="#l38.857"></a><span id="l38.857"> </span>
<a href="#l38.858"></a><span id="l38.858">   return true;</span>
<a href="#l38.859"></a><span id="l38.859"> }</span>
<a href="#l38.860"></a><span id="l38.860"> </span>
<a href="#l38.861"></a><span id="l38.861" class="difflineminus">-function ChangeCellTextbox(textboxID)</span>
<a href="#l38.862"></a><span id="l38.862" class="difflineminus">-{</span>
<a href="#l38.863"></a><span id="l38.863" class="difflineplus">+function ChangeCellTextbox(textboxID) {</span>
<a href="#l38.864"></a><span id="l38.864">   // Filter input for just integers</span>
<a href="#l38.865"></a><span id="l38.865">   forceInteger(textboxID);</span>
<a href="#l38.866"></a><span id="l38.866"> </span>
<a href="#l38.867"></a><span id="l38.867">   if (gDialog.TabBox.selectedTab == gDialog.CellTab)</span>
<a href="#l38.868"></a><span id="l38.868">     gCellDataChanged = true;</span>
<a href="#l38.869"></a><span id="l38.869"> }</span>
<a href="#l38.870"></a><span id="l38.870"> </span>
<a href="#l38.871"></a><span id="l38.871"> // Call this when a textbox or menulist is changed</span>
<a href="#l38.872"></a><span id="l38.872"> //   so the checkbox is automatically set</span>
<a href="#l38.873"></a><span id="l38.873" class="difflineminus">-function SetCheckbox(checkboxID)</span>
<a href="#l38.874"></a><span id="l38.874" class="difflineminus">-{</span>
<a href="#l38.875"></a><span id="l38.875" class="difflineminus">-  if (checkboxID &amp;&amp; checkboxID.length &gt; 0)</span>
<a href="#l38.876"></a><span id="l38.876" class="difflineminus">-  {</span>
<a href="#l38.877"></a><span id="l38.877" class="difflineplus">+function SetCheckbox(checkboxID) {</span>
<a href="#l38.878"></a><span id="l38.878" class="difflineplus">+  if (checkboxID &amp;&amp; checkboxID.length &gt; 0) {</span>
<a href="#l38.879"></a><span id="l38.879">     // Set associated checkbox</span>
<a href="#l38.880"></a><span id="l38.880">     document.getElementById(checkboxID).checked = true;</span>
<a href="#l38.881"></a><span id="l38.881">   }</span>
<a href="#l38.882"></a><span id="l38.882">   gCellDataChanged = true;</span>
<a href="#l38.883"></a><span id="l38.883"> }</span>
<a href="#l38.884"></a><span id="l38.884"> </span>
<a href="#l38.885"></a><span id="l38.885" class="difflineminus">-function ChangeIntTextbox(textboxID, checkboxID)</span>
<a href="#l38.886"></a><span id="l38.886" class="difflineminus">-{</span>
<a href="#l38.887"></a><span id="l38.887" class="difflineplus">+function ChangeIntTextbox(textboxID, checkboxID) {</span>
<a href="#l38.888"></a><span id="l38.888">   // Filter input for just integers</span>
<a href="#l38.889"></a><span id="l38.889">   forceInteger(textboxID);</span>
<a href="#l38.890"></a><span id="l38.890"> </span>
<a href="#l38.891"></a><span id="l38.891">   // Set associated checkbox</span>
<a href="#l38.892"></a><span id="l38.892">   SetCheckbox(checkboxID);</span>
<a href="#l38.893"></a><span id="l38.893"> }</span>
<a href="#l38.894"></a><span id="l38.894"> </span>
<a href="#l38.895"></a><span id="l38.895" class="difflineminus">-function CloneAttribute(destElement, srcElement, attr)</span>
<a href="#l38.896"></a><span id="l38.896" class="difflineminus">-{</span>
<a href="#l38.897"></a><span id="l38.897" class="difflineplus">+function CloneAttribute(destElement, srcElement, attr) {</span>
<a href="#l38.898"></a><span id="l38.898">   var value = srcElement.getAttribute(attr);</span>
<a href="#l38.899"></a><span id="l38.899">   // Use editor methods since we are always</span>
<a href="#l38.900"></a><span id="l38.900">   //  modifying a table in the document and</span>
<a href="#l38.901"></a><span id="l38.901">   //  we need transaction system for undo</span>
<a href="#l38.902"></a><span id="l38.902">   try {</span>
<a href="#l38.903"></a><span id="l38.903">     if (!value || value.length == 0)</span>
<a href="#l38.904"></a><span id="l38.904">       gActiveEditor.removeAttributeOrEquivalent(destElement, attr, false);</span>
<a href="#l38.905"></a><span id="l38.905">     else</span>
<a href="#l38.906"></a><span id="l38.906">       gActiveEditor.setAttributeOrEquivalent(destElement, attr, value, false);</span>
<a href="#l38.907"></a><span id="l38.907" class="difflineminus">-  } catch(e) {}</span>
<a href="#l38.908"></a><span id="l38.908" class="difflineplus">+  } catch (e) {}</span>
<a href="#l38.909"></a><span id="l38.909"> }</span>
<a href="#l38.910"></a><span id="l38.910"> </span>
<a href="#l38.911"></a><span id="l38.911" class="difflineminus">-function ApplyTableAttributes()</span>
<a href="#l38.912"></a><span id="l38.912" class="difflineminus">-{</span>
<a href="#l38.913"></a><span id="l38.913" class="difflineplus">+function ApplyTableAttributes() {</span>
<a href="#l38.914"></a><span id="l38.914">   var newAlign = gDialog.TableCaptionList.value;</span>
<a href="#l38.915"></a><span id="l38.915">   if (!newAlign) newAlign = &quot;&quot;;</span>
<a href="#l38.916"></a><span id="l38.916"> </span>
<a href="#l38.917"></a><span id="l38.917" class="difflineminus">-  if (gTableCaptionElement)</span>
<a href="#l38.918"></a><span id="l38.918" class="difflineminus">-  {</span>
<a href="#l38.919"></a><span id="l38.919" class="difflineplus">+  if (gTableCaptionElement) {</span>
<a href="#l38.920"></a><span id="l38.920">     // Get current alignment</span>
<a href="#l38.921"></a><span id="l38.921">     var align = GetHTMLOrCSSStyleValue(gTableCaptionElement, &quot;align&quot;, &quot;caption-side&quot;).toLowerCase();</span>
<a href="#l38.922"></a><span id="l38.922">     // This is the default</span>
<a href="#l38.923"></a><span id="l38.923">     if (!align) align = &quot;top&quot;;</span>
<a href="#l38.924"></a><span id="l38.924"> </span>
<a href="#l38.925"></a><span id="l38.925" class="difflineminus">-    if (newAlign == &quot;&quot;)</span>
<a href="#l38.926"></a><span id="l38.926" class="difflineminus">-    {</span>
<a href="#l38.927"></a><span id="l38.927" class="difflineplus">+    if (newAlign == &quot;&quot;) {</span>
<a href="#l38.928"></a><span id="l38.928">       // Remove existing caption</span>
<a href="#l38.929"></a><span id="l38.929">       try {</span>
<a href="#l38.930"></a><span id="l38.930">         gActiveEditor.deleteNode(gTableCaptionElement);</span>
<a href="#l38.931"></a><span id="l38.931" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.932"></a><span id="l38.932" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.933"></a><span id="l38.933">       gTableCaptionElement = null;</span>
<a href="#l38.934"></a><span id="l38.934" class="difflineminus">-    }</span>
<a href="#l38.935"></a><span id="l38.935" class="difflineminus">-    else if(newAlign != align)</span>
<a href="#l38.936"></a><span id="l38.936" class="difflineminus">-    {</span>
<a href="#l38.937"></a><span id="l38.937" class="difflineplus">+    } else if (newAlign != align) {</span>
<a href="#l38.938"></a><span id="l38.938">       try {</span>
<a href="#l38.939"></a><span id="l38.939">         if (newAlign == &quot;top&quot;) // This is default, so don't explicitly set it</span>
<a href="#l38.940"></a><span id="l38.940">           gActiveEditor.removeAttributeOrEquivalent(gTableCaptionElement, &quot;align&quot;, false);</span>
<a href="#l38.941"></a><span id="l38.941">         else</span>
<a href="#l38.942"></a><span id="l38.942">           gActiveEditor.setAttributeOrEquivalent(gTableCaptionElement, &quot;align&quot;, newAlign, false);</span>
<a href="#l38.943"></a><span id="l38.943" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.944"></a><span id="l38.944" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.945"></a><span id="l38.945">     }</span>
<a href="#l38.946"></a><span id="l38.946" class="difflineminus">-  }</span>
<a href="#l38.947"></a><span id="l38.947" class="difflineminus">-  else if (newAlign != &quot;&quot;)</span>
<a href="#l38.948"></a><span id="l38.948" class="difflineminus">-  {</span>
<a href="#l38.949"></a><span id="l38.949" class="difflineplus">+  } else if (newAlign != &quot;&quot;) {</span>
<a href="#l38.950"></a><span id="l38.950">     // Create and insert a caption:</span>
<a href="#l38.951"></a><span id="l38.951">     try {</span>
<a href="#l38.952"></a><span id="l38.952">       gTableCaptionElement = gActiveEditor.createElementWithDefaults(&quot;caption&quot;);</span>
<a href="#l38.953"></a><span id="l38.953">     } catch (e) {}</span>
<a href="#l38.954"></a><span id="l38.954" class="difflineminus">-    if (gTableCaptionElement)</span>
<a href="#l38.955"></a><span id="l38.955" class="difflineminus">-    {</span>
<a href="#l38.956"></a><span id="l38.956" class="difflineplus">+    if (gTableCaptionElement) {</span>
<a href="#l38.957"></a><span id="l38.957">       if (newAlign != &quot;top&quot;)</span>
<a href="#l38.958"></a><span id="l38.958">         gTableCaptionElement.setAttribute(&quot;align&quot;, newAlign);</span>
<a href="#l38.959"></a><span id="l38.959"> </span>
<a href="#l38.960"></a><span id="l38.960">       // Insert it into the table - caption is always inserted as first child</span>
<a href="#l38.961"></a><span id="l38.961">       try {</span>
<a href="#l38.962"></a><span id="l38.962">         gActiveEditor.insertNode(gTableCaptionElement, gTableElement, 0);</span>
<a href="#l38.963"></a><span id="l38.963" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.964"></a><span id="l38.964" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.965"></a><span id="l38.965"> </span>
<a href="#l38.966"></a><span id="l38.966">       // Put selection back where it was</span>
<a href="#l38.967"></a><span id="l38.967">       ChangeSelection(RESET_SELECTION);</span>
<a href="#l38.968"></a><span id="l38.968">     }</span>
<a href="#l38.969"></a><span id="l38.969">   }</span>
<a href="#l38.970"></a><span id="l38.970"> </span>
<a href="#l38.971"></a><span id="l38.971">   var countDelta;</span>
<a href="#l38.972"></a><span id="l38.972">   var foundCell;</span>
<a href="#l38.973"></a><span id="l38.973">   var i;</span>
<a href="#l38.974"></a><span id="l38.974"> </span>
<a href="#l38.975"></a><span id="l38.975" class="difflineminus">-  if (gNewRowCount != gRowCount)</span>
<a href="#l38.976"></a><span id="l38.976" class="difflineminus">-  {</span>
<a href="#l38.977"></a><span id="l38.977" class="difflineplus">+  if (gNewRowCount != gRowCount) {</span>
<a href="#l38.978"></a><span id="l38.978">     countDelta = gNewRowCount - gRowCount;</span>
<a href="#l38.979"></a><span id="l38.979" class="difflineminus">-    if (gNewRowCount &gt; gRowCount)</span>
<a href="#l38.980"></a><span id="l38.980" class="difflineminus">-    {</span>
<a href="#l38.981"></a><span id="l38.981" class="difflineplus">+    if (gNewRowCount &gt; gRowCount) {</span>
<a href="#l38.982"></a><span id="l38.982">       // Append new rows</span>
<a href="#l38.983"></a><span id="l38.983">       // Find first cell in last row</span>
<a href="#l38.984"></a><span id="l38.984" class="difflineminus">-      if(GetCellData(gLastRowIndex, 0))</span>
<a href="#l38.985"></a><span id="l38.985" class="difflineminus">-      {</span>
<a href="#l38.986"></a><span id="l38.986" class="difflineplus">+      if (GetCellData(gLastRowIndex, 0)) {</span>
<a href="#l38.987"></a><span id="l38.987">         try {</span>
<a href="#l38.988"></a><span id="l38.988">           // Move selection to the last cell</span>
<a href="#l38.989"></a><span id="l38.989" class="difflineminus">-          gSelection.collapse(gCellData.value,0);</span>
<a href="#l38.990"></a><span id="l38.990" class="difflineplus">+          gSelection.collapse(gCellData.value, 0);</span>
<a href="#l38.991"></a><span id="l38.991">           // Insert new rows after it</span>
<a href="#l38.992"></a><span id="l38.992">           gActiveEditor.insertTableRow(countDelta, true);</span>
<a href="#l38.993"></a><span id="l38.993">           gRowCount = gNewRowCount;</span>
<a href="#l38.994"></a><span id="l38.994">           gLastRowIndex = gRowCount - 1;</span>
<a href="#l38.995"></a><span id="l38.995">           // Put selection back where it was</span>
<a href="#l38.996"></a><span id="l38.996">           ChangeSelection(RESET_SELECTION);</span>
<a href="#l38.997"></a><span id="l38.997" class="difflineminus">-        }</span>
<a href="#l38.998"></a><span id="l38.998" class="difflineminus">-        catch(ex) {</span>
<a href="#l38.999"></a><span id="l38.999" class="difflineplus">+        } catch (ex) {</span>
<a href="#l38.1000"></a><span id="l38.1000">           dump(&quot;FAILED TO FIND FIRST CELL IN LAST ROW\n&quot;);</span>
<a href="#l38.1001"></a><span id="l38.1001">         }</span>
<a href="#l38.1002"></a><span id="l38.1002">       }</span>
<a href="#l38.1003"></a><span id="l38.1003" class="difflineminus">-    }</span>
<a href="#l38.1004"></a><span id="l38.1004" class="difflineminus">-    else</span>
<a href="#l38.1005"></a><span id="l38.1005" class="difflineminus">-    {</span>
<a href="#l38.1006"></a><span id="l38.1006" class="difflineplus">+    } else {</span>
<a href="#l38.1007"></a><span id="l38.1007">       // Delete rows</span>
<a href="#l38.1008"></a><span id="l38.1008" class="difflineminus">-      if (gCanDelete)</span>
<a href="#l38.1009"></a><span id="l38.1009" class="difflineminus">-      {</span>
<a href="#l38.1010"></a><span id="l38.1010" class="difflineplus">+      if (gCanDelete) {</span>
<a href="#l38.1011"></a><span id="l38.1011">         // Find first cell starting in first row we delete</span>
<a href="#l38.1012"></a><span id="l38.1012">         var firstDeleteRow = gRowCount + countDelta;</span>
<a href="#l38.1013"></a><span id="l38.1013">         foundCell = false;</span>
<a href="#l38.1014"></a><span id="l38.1014" class="difflineminus">-        for ( i = 0; i &lt;= gLastColIndex; i++)</span>
<a href="#l38.1015"></a><span id="l38.1015" class="difflineminus">-        {</span>
<a href="#l38.1016"></a><span id="l38.1016" class="difflineplus">+        for (i = 0; i &lt;= gLastColIndex; i++) {</span>
<a href="#l38.1017"></a><span id="l38.1017">           if (!GetCellData(firstDeleteRow, i))</span>
<a href="#l38.1018"></a><span id="l38.1018">             break; // We failed to find a cell</span>
<a href="#l38.1019"></a><span id="l38.1019"> </span>
<a href="#l38.1020"></a><span id="l38.1020" class="difflineminus">-          if (gCellData.startRowIndex == firstDeleteRow)</span>
<a href="#l38.1021"></a><span id="l38.1021" class="difflineminus">-          {</span>
<a href="#l38.1022"></a><span id="l38.1022" class="difflineplus">+          if (gCellData.startRowIndex == firstDeleteRow) {</span>
<a href="#l38.1023"></a><span id="l38.1023">             foundCell = true;</span>
<a href="#l38.1024"></a><span id="l38.1024">             break;</span>
<a href="#l38.1025"></a><span id="l38.1025">           }</span>
<a href="#l38.1026"></a><span id="l38.1026" class="difflineminus">-        };</span>
<a href="#l38.1027"></a><span id="l38.1027" class="difflineminus">-        if (foundCell)</span>
<a href="#l38.1028"></a><span id="l38.1028" class="difflineminus">-        {</span>
<a href="#l38.1029"></a><span id="l38.1029" class="difflineplus">+        }</span>
<a href="#l38.1030"></a><span id="l38.1030" class="difflineplus">+        if (foundCell) {</span>
<a href="#l38.1031"></a><span id="l38.1031">           try {</span>
<a href="#l38.1032"></a><span id="l38.1032">             // Move selection to the cell we found</span>
<a href="#l38.1033"></a><span id="l38.1033">             gSelection.collapse(gCellData.value, 0);</span>
<a href="#l38.1034"></a><span id="l38.1034">             gActiveEditor.deleteTableRow(-countDelta);</span>
<a href="#l38.1035"></a><span id="l38.1035">             gRowCount = gNewRowCount;</span>
<a href="#l38.1036"></a><span id="l38.1036">             gLastRowIndex = gRowCount - 1;</span>
<a href="#l38.1037"></a><span id="l38.1037">             if (gCurRowIndex &gt; gLastRowIndex)</span>
<a href="#l38.1038"></a><span id="l38.1038">               // We are deleting our selection</span>
<a href="#l38.1039"></a><span id="l38.1039">               // move it to start of table</span>
<a href="#l38.1040"></a><span id="l38.1040" class="difflineminus">-              ChangeSelectionToFirstCell()</span>
<a href="#l38.1041"></a><span id="l38.1041" class="difflineplus">+              ChangeSelectionToFirstCell();</span>
<a href="#l38.1042"></a><span id="l38.1042">             else</span>
<a href="#l38.1043"></a><span id="l38.1043">               // Put selection back where it was</span>
<a href="#l38.1044"></a><span id="l38.1044">               ChangeSelection(RESET_SELECTION);</span>
<a href="#l38.1045"></a><span id="l38.1045" class="difflineminus">-          }</span>
<a href="#l38.1046"></a><span id="l38.1046" class="difflineminus">-          catch(ex) {</span>
<a href="#l38.1047"></a><span id="l38.1047" class="difflineplus">+          } catch (ex) {</span>
<a href="#l38.1048"></a><span id="l38.1048">             dump(&quot;FAILED TO FIND FIRST CELL IN LAST ROW\n&quot;);</span>
<a href="#l38.1049"></a><span id="l38.1049">           }</span>
<a href="#l38.1050"></a><span id="l38.1050">         }</span>
<a href="#l38.1051"></a><span id="l38.1051">       }</span>
<a href="#l38.1052"></a><span id="l38.1052">     }</span>
<a href="#l38.1053"></a><span id="l38.1053">   }</span>
<a href="#l38.1054"></a><span id="l38.1054"> </span>
<a href="#l38.1055"></a><span id="l38.1055" class="difflineminus">-  if (gNewColCount != gColCount)</span>
<a href="#l38.1056"></a><span id="l38.1056" class="difflineminus">-  {</span>
<a href="#l38.1057"></a><span id="l38.1057" class="difflineplus">+  if (gNewColCount != gColCount) {</span>
<a href="#l38.1058"></a><span id="l38.1058">     countDelta = gNewColCount - gColCount;</span>
<a href="#l38.1059"></a><span id="l38.1059"> </span>
<a href="#l38.1060"></a><span id="l38.1060" class="difflineminus">-    if (gNewColCount &gt; gColCount)</span>
<a href="#l38.1061"></a><span id="l38.1061" class="difflineminus">-    {</span>
<a href="#l38.1062"></a><span id="l38.1062" class="difflineplus">+    if (gNewColCount &gt; gColCount) {</span>
<a href="#l38.1063"></a><span id="l38.1063">       // Append new columns</span>
<a href="#l38.1064"></a><span id="l38.1064">       // Find last cell in first column</span>
<a href="#l38.1065"></a><span id="l38.1065" class="difflineminus">-      if(GetCellData(0, gLastColIndex))</span>
<a href="#l38.1066"></a><span id="l38.1066" class="difflineminus">-      {</span>
<a href="#l38.1067"></a><span id="l38.1067" class="difflineplus">+      if (GetCellData(0, gLastColIndex)) {</span>
<a href="#l38.1068"></a><span id="l38.1068">         try {</span>
<a href="#l38.1069"></a><span id="l38.1069">           // Move selection to the last cell</span>
<a href="#l38.1070"></a><span id="l38.1070" class="difflineminus">-          gSelection.collapse(gCellData.value,0);</span>
<a href="#l38.1071"></a><span id="l38.1071" class="difflineplus">+          gSelection.collapse(gCellData.value, 0);</span>
<a href="#l38.1072"></a><span id="l38.1072">           gActiveEditor.insertTableColumn(countDelta, true);</span>
<a href="#l38.1073"></a><span id="l38.1073">           gColCount = gNewColCount;</span>
<a href="#l38.1074"></a><span id="l38.1074" class="difflineminus">-          gLastColIndex = gColCount-1;</span>
<a href="#l38.1075"></a><span id="l38.1075" class="difflineplus">+          gLastColIndex = gColCount - 1;</span>
<a href="#l38.1076"></a><span id="l38.1076">           // Restore selection</span>
<a href="#l38.1077"></a><span id="l38.1077">           ChangeSelection(RESET_SELECTION);</span>
<a href="#l38.1078"></a><span id="l38.1078" class="difflineminus">-        }</span>
<a href="#l38.1079"></a><span id="l38.1079" class="difflineminus">-        catch(ex) {</span>
<a href="#l38.1080"></a><span id="l38.1080" class="difflineplus">+        } catch (ex) {</span>
<a href="#l38.1081"></a><span id="l38.1081">           dump(&quot;FAILED TO FIND FIRST CELL IN LAST COLUMN\n&quot;);</span>
<a href="#l38.1082"></a><span id="l38.1082">         }</span>
<a href="#l38.1083"></a><span id="l38.1083">       }</span>
<a href="#l38.1084"></a><span id="l38.1084" class="difflineminus">-    }</span>
<a href="#l38.1085"></a><span id="l38.1085" class="difflineminus">-    else</span>
<a href="#l38.1086"></a><span id="l38.1086" class="difflineminus">-    {</span>
<a href="#l38.1087"></a><span id="l38.1087" class="difflineplus">+    } else {</span>
<a href="#l38.1088"></a><span id="l38.1088">       // Delete columns</span>
<a href="#l38.1089"></a><span id="l38.1089" class="difflineminus">-      if (gCanDelete)</span>
<a href="#l38.1090"></a><span id="l38.1090" class="difflineminus">-      {</span>
<a href="#l38.1091"></a><span id="l38.1091" class="difflineplus">+      if (gCanDelete) {</span>
<a href="#l38.1092"></a><span id="l38.1092">         var firstDeleteCol = gColCount + countDelta;</span>
<a href="#l38.1093"></a><span id="l38.1093">         foundCell = false;</span>
<a href="#l38.1094"></a><span id="l38.1094" class="difflineminus">-        for ( i = 0; i &lt;= gLastRowIndex; i++)</span>
<a href="#l38.1095"></a><span id="l38.1095" class="difflineminus">-        {</span>
<a href="#l38.1096"></a><span id="l38.1096" class="difflineplus">+        for (i = 0; i &lt;= gLastRowIndex; i++) {</span>
<a href="#l38.1097"></a><span id="l38.1097">           // Find first cell starting in first column we delete</span>
<a href="#l38.1098"></a><span id="l38.1098">           if (!GetCellData(i, firstDeleteCol))</span>
<a href="#l38.1099"></a><span id="l38.1099">             break; // We failed to find a cell</span>
<a href="#l38.1100"></a><span id="l38.1100"> </span>
<a href="#l38.1101"></a><span id="l38.1101" class="difflineminus">-          if (gCellData.startColIndex == firstDeleteCol)</span>
<a href="#l38.1102"></a><span id="l38.1102" class="difflineminus">-          {</span>
<a href="#l38.1103"></a><span id="l38.1103" class="difflineplus">+          if (gCellData.startColIndex == firstDeleteCol) {</span>
<a href="#l38.1104"></a><span id="l38.1104">             foundCell = true;</span>
<a href="#l38.1105"></a><span id="l38.1105">             break;</span>
<a href="#l38.1106"></a><span id="l38.1106">           }</span>
<a href="#l38.1107"></a><span id="l38.1107" class="difflineminus">-        };</span>
<a href="#l38.1108"></a><span id="l38.1108" class="difflineminus">-        if (foundCell)</span>
<a href="#l38.1109"></a><span id="l38.1109" class="difflineminus">-        {</span>
<a href="#l38.1110"></a><span id="l38.1110" class="difflineplus">+        }</span>
<a href="#l38.1111"></a><span id="l38.1111" class="difflineplus">+        if (foundCell) {</span>
<a href="#l38.1112"></a><span id="l38.1112">           try {</span>
<a href="#l38.1113"></a><span id="l38.1113">             // Move selection to the cell we found</span>
<a href="#l38.1114"></a><span id="l38.1114">             gSelection.collapse(gCellData.value, 0);</span>
<a href="#l38.1115"></a><span id="l38.1115">             gActiveEditor.deleteTableColumn(-countDelta);</span>
<a href="#l38.1116"></a><span id="l38.1116">             gColCount = gNewColCount;</span>
<a href="#l38.1117"></a><span id="l38.1117" class="difflineminus">-            gLastColIndex = gColCount-1;</span>
<a href="#l38.1118"></a><span id="l38.1118" class="difflineplus">+            gLastColIndex = gColCount - 1;</span>
<a href="#l38.1119"></a><span id="l38.1119">             if (gCurColIndex &gt; gLastColIndex)</span>
<a href="#l38.1120"></a><span id="l38.1120" class="difflineminus">-              ChangeSelectionToFirstCell()</span>
<a href="#l38.1121"></a><span id="l38.1121" class="difflineplus">+              ChangeSelectionToFirstCell();</span>
<a href="#l38.1122"></a><span id="l38.1122">             else</span>
<a href="#l38.1123"></a><span id="l38.1123">               ChangeSelection(RESET_SELECTION);</span>
<a href="#l38.1124"></a><span id="l38.1124" class="difflineminus">-          }</span>
<a href="#l38.1125"></a><span id="l38.1125" class="difflineminus">-          catch(ex) {</span>
<a href="#l38.1126"></a><span id="l38.1126" class="difflineplus">+          } catch (ex) {</span>
<a href="#l38.1127"></a><span id="l38.1127">             dump(&quot;FAILED TO FIND FIRST CELL IN LAST ROW\n&quot;);</span>
<a href="#l38.1128"></a><span id="l38.1128">           }</span>
<a href="#l38.1129"></a><span id="l38.1129">         }</span>
<a href="#l38.1130"></a><span id="l38.1130">       }</span>
<a href="#l38.1131"></a><span id="l38.1131">     }</span>
<a href="#l38.1132"></a><span id="l38.1132">   }</span>
<a href="#l38.1133"></a><span id="l38.1133"> </span>
<a href="#l38.1134"></a><span id="l38.1134">   // Clone all remaining attributes to pick up</span>
<a href="#l38.1135"></a><span id="l38.1135">   //  anything changed by Advanced Edit Dialog</span>
<a href="#l38.1136"></a><span id="l38.1136">   try {</span>
<a href="#l38.1137"></a><span id="l38.1137">     gActiveEditor.cloneAttributes(gTableElement, globalTableElement);</span>
<a href="#l38.1138"></a><span id="l38.1138" class="difflineminus">-  } catch(e) {}</span>
<a href="#l38.1139"></a><span id="l38.1139" class="difflineplus">+  } catch (e) {}</span>
<a href="#l38.1140"></a><span id="l38.1140"> }</span>
<a href="#l38.1141"></a><span id="l38.1141"> </span>
<a href="#l38.1142"></a><span id="l38.1142" class="difflineminus">-function ApplyCellAttributes()</span>
<a href="#l38.1143"></a><span id="l38.1143" class="difflineminus">-{</span>
<a href="#l38.1144"></a><span id="l38.1144" class="difflineplus">+function ApplyCellAttributes() {</span>
<a href="#l38.1145"></a><span id="l38.1145">   var rangeObj = { value: null };</span>
<a href="#l38.1146"></a><span id="l38.1146">   var selectedCell;</span>
<a href="#l38.1147"></a><span id="l38.1147">   try {</span>
<a href="#l38.1148"></a><span id="l38.1148">     selectedCell = gActiveEditor.getFirstSelectedCell(rangeObj);</span>
<a href="#l38.1149"></a><span id="l38.1149" class="difflineminus">-  } catch(e) {}</span>
<a href="#l38.1150"></a><span id="l38.1150" class="difflineplus">+  } catch (e) {}</span>
<a href="#l38.1151"></a><span id="l38.1151"> </span>
<a href="#l38.1152"></a><span id="l38.1152">   if (!selectedCell)</span>
<a href="#l38.1153"></a><span id="l38.1153">     return;</span>
<a href="#l38.1154"></a><span id="l38.1154"> </span>
<a href="#l38.1155"></a><span id="l38.1155" class="difflineminus">-  if (gSelectedCellCount == 1)</span>
<a href="#l38.1156"></a><span id="l38.1156" class="difflineminus">-  {</span>
<a href="#l38.1157"></a><span id="l38.1157" class="difflineplus">+  if (gSelectedCellCount == 1) {</span>
<a href="#l38.1158"></a><span id="l38.1158">     // When only one cell is selected, simply clone entire element,</span>
<a href="#l38.1159"></a><span id="l38.1159">     //  thus CSS and JS from Advanced edit is copied</span>
<a href="#l38.1160"></a><span id="l38.1160">     try {</span>
<a href="#l38.1161"></a><span id="l38.1161">       gActiveEditor.cloneAttributes(selectedCell, globalCellElement);</span>
<a href="#l38.1162"></a><span id="l38.1162" class="difflineminus">-    } catch(e) {}</span>
<a href="#l38.1163"></a><span id="l38.1163" class="difflineplus">+    } catch (e) {}</span>
<a href="#l38.1164"></a><span id="l38.1164"> </span>
<a href="#l38.1165"></a><span id="l38.1165" class="difflineminus">-    if (gDialog.CellStyleCheckbox.checked)</span>
<a href="#l38.1166"></a><span id="l38.1166" class="difflineminus">-    {</span>
<a href="#l38.1167"></a><span id="l38.1167" class="difflineplus">+    if (gDialog.CellStyleCheckbox.checked) {</span>
<a href="#l38.1168"></a><span id="l38.1168">       var currentStyleIndex = (selectedCell.nodeName.toLowerCase() == &quot;th&quot;) ? 1 : 0;</span>
<a href="#l38.1169"></a><span id="l38.1169" class="difflineminus">-      if (gDialog.CellStyleList.selectedIndex != currentStyleIndex)</span>
<a href="#l38.1170"></a><span id="l38.1170" class="difflineminus">-      {</span>
<a href="#l38.1171"></a><span id="l38.1171" class="difflineplus">+      if (gDialog.CellStyleList.selectedIndex != currentStyleIndex) {</span>
<a href="#l38.1172"></a><span id="l38.1172">         // Switch cell types</span>
<a href="#l38.1173"></a><span id="l38.1173">         // (replaces with new cell and copies attributes and contents)</span>
<a href="#l38.1174"></a><span id="l38.1174">         try {</span>
<a href="#l38.1175"></a><span id="l38.1175">           selectedCell = gActiveEditor.switchTableCellHeaderType(selectedCell);</span>
<a href="#l38.1176"></a><span id="l38.1176" class="difflineminus">-        } catch(e) {}</span>
<a href="#l38.1177"></a><span id="l38.1177" class="difflineplus">+        } catch (e) {}</span>
<a href="#l38.1178"></a><span id="l38.1178">       }</span>
<a href="#l38.1179"></a><span id="l38.1179">     }</span>
<a href="#l38.1180"></a><span id="l38.1180" class="difflineminus">-  }</span>
<a href="#l38.1181"></a><span id="l38.1181" class="difflineminus">-  else</span>
<a href="#l38.1182"></a><span id="l38.1182" class="difflineminus">-  {</span>
<a href="#l38.1183"></a><span id="l38.1183" class="difflineplus">+  } else {</span>
<a href="#l38.1184"></a><span id="l38.1184">     // Apply changes to all selected cells</span>
<a href="#l38.1185"></a><span id="l38.1185" class="difflineminus">-    //XXX THIS DOESN'T COPY ADVANCED EDIT CHANGES!</span>
<a href="#l38.1186"></a><span id="l38.1186" class="difflineplus">+    // XXX THIS DOESN'T COPY ADVANCED EDIT CHANGES!</span>
<a href="#l38.1187"></a><span id="l38.1187">     try {</span>
<a href="#l38.1188"></a><span id="l38.1188" class="difflineminus">-      while (selectedCell)</span>
<a href="#l38.1189"></a><span id="l38.1189" class="difflineminus">-      {</span>
<a href="#l38.1190"></a><span id="l38.1190" class="difflineplus">+      while (selectedCell) {</span>
<a href="#l38.1191"></a><span id="l38.1191">         ApplyAttributesToOneCell(selectedCell);</span>
<a href="#l38.1192"></a><span id="l38.1192">         selectedCell = gActiveEditor.getNextSelectedCell(rangeObj);</span>
<a href="#l38.1193"></a><span id="l38.1193">       }</span>
<a href="#l38.1194"></a><span id="l38.1194" class="difflineminus">-    } catch(e) {}</span>
<a href="#l38.1195"></a><span id="l38.1195" class="difflineplus">+    } catch (e) {}</span>
<a href="#l38.1196"></a><span id="l38.1196">   }</span>
<a href="#l38.1197"></a><span id="l38.1197">   gCellDataChanged = false;</span>
<a href="#l38.1198"></a><span id="l38.1198"> }</span>
<a href="#l38.1199"></a><span id="l38.1199"> </span>
<a href="#l38.1200"></a><span id="l38.1200" class="difflineminus">-function ApplyAttributesToOneCell(destElement)</span>
<a href="#l38.1201"></a><span id="l38.1201" class="difflineminus">-{</span>
<a href="#l38.1202"></a><span id="l38.1202" class="difflineplus">+function ApplyAttributesToOneCell(destElement) {</span>
<a href="#l38.1203"></a><span id="l38.1203">   if (gDialog.CellHeightCheckbox.checked)</span>
<a href="#l38.1204"></a><span id="l38.1204">     CloneAttribute(destElement, globalCellElement, &quot;height&quot;);</span>
<a href="#l38.1205"></a><span id="l38.1205"> </span>
<a href="#l38.1206"></a><span id="l38.1206">   if (gDialog.CellWidthCheckbox.checked)</span>
<a href="#l38.1207"></a><span id="l38.1207">     CloneAttribute(destElement, globalCellElement, &quot;width&quot;);</span>
<a href="#l38.1208"></a><span id="l38.1208"> </span>
<a href="#l38.1209"></a><span id="l38.1209" class="difflineminus">-  if (gDialog.CellHAlignCheckbox.checked)</span>
<a href="#l38.1210"></a><span id="l38.1210" class="difflineminus">-  {</span>
<a href="#l38.1211"></a><span id="l38.1211" class="difflineplus">+  if (gDialog.CellHAlignCheckbox.checked) {</span>
<a href="#l38.1212"></a><span id="l38.1212">     CloneAttribute(destElement, globalCellElement, &quot;align&quot;);</span>
<a href="#l38.1213"></a><span id="l38.1213">     CloneAttribute(destElement, globalCellElement, charStr);</span>
<a href="#l38.1214"></a><span id="l38.1214">   }</span>
<a href="#l38.1215"></a><span id="l38.1215"> </span>
<a href="#l38.1216"></a><span id="l38.1216">   if (gDialog.CellVAlignCheckbox.checked)</span>
<a href="#l38.1217"></a><span id="l38.1217">     CloneAttribute(destElement, globalCellElement, &quot;valign&quot;);</span>
<a href="#l38.1218"></a><span id="l38.1218"> </span>
<a href="#l38.1219"></a><span id="l38.1219">   if (gDialog.TextWrapCheckbox.checked)</span>
<a href="#l38.1220"></a><span id="l38.1220">     CloneAttribute(destElement, globalCellElement, &quot;nowrap&quot;);</span>
<a href="#l38.1221"></a><span id="l38.1221"> </span>
<a href="#l38.1222"></a><span id="l38.1222" class="difflineminus">-  if (gDialog.CellStyleCheckbox.checked)</span>
<a href="#l38.1223"></a><span id="l38.1223" class="difflineminus">-  {</span>
<a href="#l38.1224"></a><span id="l38.1224" class="difflineplus">+  if (gDialog.CellStyleCheckbox.checked) {</span>
<a href="#l38.1225"></a><span id="l38.1225">     var newStyleIndex = gDialog.CellStyleList.selectedIndex;</span>
<a href="#l38.1226"></a><span id="l38.1226">     var currentStyleIndex = (destElement.nodeName.toLowerCase() == &quot;th&quot;) ? 1 : 0;</span>
<a href="#l38.1227"></a><span id="l38.1227"> </span>
<a href="#l38.1228"></a><span id="l38.1228" class="difflineminus">-    if (newStyleIndex != currentStyleIndex)</span>
<a href="#l38.1229"></a><span id="l38.1229" class="difflineminus">-    {</span>
<a href="#l38.1230"></a><span id="l38.1230" class="difflineplus">+    if (newStyleIndex != currentStyleIndex) {</span>
<a href="#l38.1231"></a><span id="l38.1231">       // Switch cell types</span>
<a href="#l38.1232"></a><span id="l38.1232">       // (replaces with new cell and copies attributes and contents)</span>
<a href="#l38.1233"></a><span id="l38.1233">       try {</span>
<a href="#l38.1234"></a><span id="l38.1234">         destElement = gActiveEditor.switchTableCellHeaderType(destElement);</span>
<a href="#l38.1235"></a><span id="l38.1235" class="difflineminus">-      } catch(e) {}</span>
<a href="#l38.1236"></a><span id="l38.1236" class="difflineplus">+      } catch (e) {}</span>
<a href="#l38.1237"></a><span id="l38.1237">     }</span>
<a href="#l38.1238"></a><span id="l38.1238">   }</span>
<a href="#l38.1239"></a><span id="l38.1239"> </span>
<a href="#l38.1240"></a><span id="l38.1240">   if (gDialog.CellColorCheckbox.checked)</span>
<a href="#l38.1241"></a><span id="l38.1241">     CloneAttribute(destElement, globalCellElement, &quot;bgcolor&quot;);</span>
<a href="#l38.1242"></a><span id="l38.1242"> }</span>
<a href="#l38.1243"></a><span id="l38.1243"> </span>
<a href="#l38.1244"></a><span id="l38.1244" class="difflineminus">-function SetCloseButton()</span>
<a href="#l38.1245"></a><span id="l38.1245" class="difflineminus">-{</span>
<a href="#l38.1246"></a><span id="l38.1246" class="difflineplus">+function SetCloseButton() {</span>
<a href="#l38.1247"></a><span id="l38.1247">   // Change text on &quot;Cancel&quot; button after Apply is used</span>
<a href="#l38.1248"></a><span id="l38.1248" class="difflineminus">-  if (!gApplyUsed)</span>
<a href="#l38.1249"></a><span id="l38.1249" class="difflineminus">-  {</span>
<a href="#l38.1250"></a><span id="l38.1250" class="difflineplus">+  if (!gApplyUsed) {</span>
<a href="#l38.1251"></a><span id="l38.1251">     document.documentElement.setAttribute(&quot;buttonlabelcancel&quot;,</span>
<a href="#l38.1252"></a><span id="l38.1252">       document.documentElement.getAttribute(&quot;buttonlabelclose&quot;));</span>
<a href="#l38.1253"></a><span id="l38.1253">     gApplyUsed = true;</span>
<a href="#l38.1254"></a><span id="l38.1254">   }</span>
<a href="#l38.1255"></a><span id="l38.1255"> }</span>
<a href="#l38.1256"></a><span id="l38.1256"> </span>
<a href="#l38.1257"></a><span id="l38.1257" class="difflineminus">-function Apply()</span>
<a href="#l38.1258"></a><span id="l38.1258" class="difflineminus">-{</span>
<a href="#l38.1259"></a><span id="l38.1259" class="difflineminus">-  if (ValidateData())</span>
<a href="#l38.1260"></a><span id="l38.1260" class="difflineminus">-  {</span>
<a href="#l38.1261"></a><span id="l38.1261" class="difflineplus">+function Apply() {</span>
<a href="#l38.1262"></a><span id="l38.1262" class="difflineplus">+  if (ValidateData()) {</span>
<a href="#l38.1263"></a><span id="l38.1263">     gActiveEditor.beginTransaction();</span>
<a href="#l38.1264"></a><span id="l38.1264"> </span>
<a href="#l38.1265"></a><span id="l38.1265">     ApplyTableAttributes();</span>
<a href="#l38.1266"></a><span id="l38.1266"> </span>
<a href="#l38.1267"></a><span id="l38.1267">     // We may have just a table, so check for cell element</span>
<a href="#l38.1268"></a><span id="l38.1268">     if (globalCellElement)</span>
<a href="#l38.1269"></a><span id="l38.1269">       ApplyCellAttributes();</span>
<a href="#l38.1270"></a><span id="l38.1270"> </span>
<a href="#l38.1271"></a><span id="l38.1271">     gActiveEditor.endTransaction();</span>
<a href="#l38.1272"></a><span id="l38.1272"> </span>
<a href="#l38.1273"></a><span id="l38.1273">     SetCloseButton();</span>
<a href="#l38.1274"></a><span id="l38.1274">     return true;</span>
<a href="#l38.1275"></a><span id="l38.1275">   }</span>
<a href="#l38.1276"></a><span id="l38.1276">   return false;</span>
<a href="#l38.1277"></a><span id="l38.1277"> }</span>
<a href="#l38.1278"></a><span id="l38.1278"> </span>
<a href="#l38.1279"></a><span id="l38.1279" class="difflineminus">-function onAccept(event)</span>
<a href="#l38.1280"></a><span id="l38.1280" class="difflineminus">-{</span>
<a href="#l38.1281"></a><span id="l38.1281" class="difflineplus">+function onAccept(event) {</span>
<a href="#l38.1282"></a><span id="l38.1282">   // Do same as Apply and close window if ValidateData succeeded</span>
<a href="#l38.1283"></a><span id="l38.1283">   var retVal = Apply();</span>
<a href="#l38.1284"></a><span id="l38.1284">   if (retVal) {</span>
<a href="#l38.1285"></a><span id="l38.1285">     SaveWindowLocation();</span>
<a href="#l38.1286"></a><span id="l38.1286">   } else {</span>
<a href="#l38.1287"></a><span id="l38.1287">     event.preventDefault();</span>
<a href="#l38.1288"></a><span id="l38.1288">   }</span>
<a href="#l38.1289"></a><span id="l38.1289"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdTextAreaProps.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdTextAreaProps.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -5,21 +5,19 @@</span>
<a href="#l39.4"></a><span id="l39.4"> var insertNew;</span>
<a href="#l39.5"></a><span id="l39.5"> var textareaElement;</span>
<a href="#l39.6"></a><span id="l39.6"> </span>
<a href="#l39.7"></a><span id="l39.7"> // dialog initialization code</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l39.10"></a><span id="l39.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-function Startup()</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-{</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+function Startup() {</span>
<a href="#l39.15"></a><span id="l39.15">   var editor = GetCurrentEditor();</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-  if (!editor)</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-  {</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+  if (!editor) {</span>
<a href="#l39.19"></a><span id="l39.19">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l39.20"></a><span id="l39.20">     window.close();</span>
<a href="#l39.21"></a><span id="l39.21">     return;</span>
<a href="#l39.22"></a><span id="l39.22">   }</span>
<a href="#l39.23"></a><span id="l39.23"> </span>
<a href="#l39.24"></a><span id="l39.24">   gDialog = {</span>
<a href="#l39.25"></a><span id="l39.25">     accept:             document.documentElement.getButton(&quot;accept&quot;),</span>
<a href="#l39.26"></a><span id="l39.26">     textareaName:       document.getElementById(&quot;TextAreaName&quot;),</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineat">@@ -27,116 +25,106 @@ function Startup()</span>
<a href="#l39.28"></a><span id="l39.28">     textareaCols:       document.getElementById(&quot;TextAreaCols&quot;),</span>
<a href="#l39.29"></a><span id="l39.29">     textareaWrap:       document.getElementById(&quot;TextAreaWrap&quot;),</span>
<a href="#l39.30"></a><span id="l39.30">     textareaReadOnly:   document.getElementById(&quot;TextAreaReadOnly&quot;),</span>
<a href="#l39.31"></a><span id="l39.31">     textareaDisabled:   document.getElementById(&quot;TextAreaDisabled&quot;),</span>
<a href="#l39.32"></a><span id="l39.32">     textareaTabIndex:   document.getElementById(&quot;TextAreaTabIndex&quot;),</span>
<a href="#l39.33"></a><span id="l39.33">     textareaAccessKey:  document.getElementById(&quot;TextAreaAccessKey&quot;),</span>
<a href="#l39.34"></a><span id="l39.34">     textareaValue:      document.getElementById(&quot;TextAreaValue&quot;),</span>
<a href="#l39.35"></a><span id="l39.35">     MoreSection:        document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineminus">-    MoreFewerButton:    document.getElementById(&quot;MoreFewerButton&quot;)</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+    MoreFewerButton:    document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l39.38"></a><span id="l39.38">   };</span>
<a href="#l39.39"></a><span id="l39.39"> </span>
<a href="#l39.40"></a><span id="l39.40">   // Get a single selected text area element</span>
<a href="#l39.41"></a><span id="l39.41">   const kTagName = &quot;textarea&quot;;</span>
<a href="#l39.42"></a><span id="l39.42">   try {</span>
<a href="#l39.43"></a><span id="l39.43">     textareaElement = editor.getSelectedElement(kTagName);</span>
<a href="#l39.44"></a><span id="l39.44">   } catch (e) {}</span>
<a href="#l39.45"></a><span id="l39.45"> </span>
<a href="#l39.46"></a><span id="l39.46">   if (textareaElement) {</span>
<a href="#l39.47"></a><span id="l39.47">     // We found an element and don't need to insert one</span>
<a href="#l39.48"></a><span id="l39.48">     insertNew = false;</span>
<a href="#l39.49"></a><span id="l39.49"> </span>
<a href="#l39.50"></a><span id="l39.50">     gDialog.textareaValue.value = textareaElement.value;</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">-  }</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">-  else</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineminus">-  {</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+  } else {</span>
<a href="#l39.55"></a><span id="l39.55">     insertNew = true;</span>
<a href="#l39.56"></a><span id="l39.56"> </span>
<a href="#l39.57"></a><span id="l39.57">     // We don't have an element selected,</span>
<a href="#l39.58"></a><span id="l39.58">     //  so create one with default attributes</span>
<a href="#l39.59"></a><span id="l39.59">     try {</span>
<a href="#l39.60"></a><span id="l39.60">       textareaElement = editor.createElementWithDefaults(kTagName);</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-    } catch(e) {}</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+    } catch (e) {}</span>
<a href="#l39.63"></a><span id="l39.63"> </span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-    if (!textareaElement)</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineminus">-    {</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+    if (!textareaElement) {</span>
<a href="#l39.67"></a><span id="l39.67">       dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l39.68"></a><span id="l39.68">       window.close();</span>
<a href="#l39.69"></a><span id="l39.69">       return;</span>
<a href="#l39.70"></a><span id="l39.70">     }</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineminus">-    else</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineminus">-      gDialog.textareaValue.value = GetSelectionAsText();</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+    gDialog.textareaValue.value = GetSelectionAsText();</span>
<a href="#l39.74"></a><span id="l39.74">   }</span>
<a href="#l39.75"></a><span id="l39.75"> </span>
<a href="#l39.76"></a><span id="l39.76">   // Make a copy to use for AdvancedEdit</span>
<a href="#l39.77"></a><span id="l39.77">   globalElement = textareaElement.cloneNode(false);</span>
<a href="#l39.78"></a><span id="l39.78"> </span>
<a href="#l39.79"></a><span id="l39.79">   InitDialog();</span>
<a href="#l39.80"></a><span id="l39.80"> </span>
<a href="#l39.81"></a><span id="l39.81">   InitMoreFewer();</span>
<a href="#l39.82"></a><span id="l39.82"> </span>
<a href="#l39.83"></a><span id="l39.83">   SetTextboxFocus(gDialog.textareaName);</span>
<a href="#l39.84"></a><span id="l39.84"> </span>
<a href="#l39.85"></a><span id="l39.85">   SetWindowLocation();</span>
<a href="#l39.86"></a><span id="l39.86"> }</span>
<a href="#l39.87"></a><span id="l39.87"> </span>
<a href="#l39.88"></a><span id="l39.88" class="difflineminus">-function InitDialog()</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineminus">-{</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+function InitDialog() {</span>
<a href="#l39.91"></a><span id="l39.91">   gDialog.textareaName.value = globalElement.getAttribute(&quot;name&quot;);</span>
<a href="#l39.92"></a><span id="l39.92">   gDialog.textareaRows.value = globalElement.getAttribute(&quot;rows&quot;);</span>
<a href="#l39.93"></a><span id="l39.93">   gDialog.textareaCols.value = globalElement.getAttribute(&quot;cols&quot;);</span>
<a href="#l39.94"></a><span id="l39.94">   gDialog.textareaWrap.value = GetHTMLOrCSSStyleValue(globalElement, &quot;wrap&quot;, &quot;white-space&quot;);</span>
<a href="#l39.95"></a><span id="l39.95">   gDialog.textareaReadOnly.checked = globalElement.hasAttribute(&quot;readonly&quot;);</span>
<a href="#l39.96"></a><span id="l39.96">   gDialog.textareaDisabled.checked = globalElement.hasAttribute(&quot;disabled&quot;);</span>
<a href="#l39.97"></a><span id="l39.97">   gDialog.textareaTabIndex.value = globalElement.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l39.98"></a><span id="l39.98">   gDialog.textareaAccessKey.value = globalElement.getAttribute(&quot;accesskey&quot;);</span>
<a href="#l39.99"></a><span id="l39.99">   onInput();</span>
<a href="#l39.100"></a><span id="l39.100"> }</span>
<a href="#l39.101"></a><span id="l39.101"> </span>
<a href="#l39.102"></a><span id="l39.102" class="difflineminus">-function onInput()</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineminus">-{</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+function onInput() {</span>
<a href="#l39.105"></a><span id="l39.105">   var disabled = !gDialog.textareaName.value || !gDialog.textareaRows.value || !gDialog.textareaCols.value;</span>
<a href="#l39.106"></a><span id="l39.106">   if (gDialog.accept.disabled != disabled)</span>
<a href="#l39.107"></a><span id="l39.107">     gDialog.accept.disabled = disabled;</span>
<a href="#l39.108"></a><span id="l39.108"> }</span>
<a href="#l39.109"></a><span id="l39.109"> </span>
<a href="#l39.110"></a><span id="l39.110" class="difflineminus">-function ValidateData()</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineminus">-{</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+function ValidateData() {</span>
<a href="#l39.113"></a><span id="l39.113">   var attributes = {</span>
<a href="#l39.114"></a><span id="l39.114">     name: gDialog.textareaName.value,</span>
<a href="#l39.115"></a><span id="l39.115">     rows: gDialog.textareaRows.value,</span>
<a href="#l39.116"></a><span id="l39.116">     cols: gDialog.textareaCols.value,</span>
<a href="#l39.117"></a><span id="l39.117">     wrap: gDialog.textareaWrap.value,</span>
<a href="#l39.118"></a><span id="l39.118">     tabindex: gDialog.textareaTabIndex.value,</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineminus">-    accesskey: gDialog.textareaAccessKey.value</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+    accesskey: gDialog.textareaAccessKey.value,</span>
<a href="#l39.121"></a><span id="l39.121">   };</span>
<a href="#l39.122"></a><span id="l39.122">   var flags = {</span>
<a href="#l39.123"></a><span id="l39.123">     readonly: gDialog.textareaReadOnly.checked,</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineminus">-    disabled: gDialog.textareaDisabled.checked</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineplus">+    disabled: gDialog.textareaDisabled.checked,</span>
<a href="#l39.126"></a><span id="l39.126">   };</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineminus">-  for (var a in attributes)</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineminus">-  {</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+  for (var a in attributes) {</span>
<a href="#l39.130"></a><span id="l39.130">     if (attributes[a])</span>
<a href="#l39.131"></a><span id="l39.131">       globalElement.setAttribute(a, attributes[a]);</span>
<a href="#l39.132"></a><span id="l39.132">     else</span>
<a href="#l39.133"></a><span id="l39.133">       globalElement.removeAttribute(a);</span>
<a href="#l39.134"></a><span id="l39.134">   }</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineminus">-  for (var f in flags)</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineminus">-  {</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+  for (var f in flags) {</span>
<a href="#l39.138"></a><span id="l39.138">     if (flags[f])</span>
<a href="#l39.139"></a><span id="l39.139">       globalElement.setAttribute(f, &quot;&quot;);</span>
<a href="#l39.140"></a><span id="l39.140">     else</span>
<a href="#l39.141"></a><span id="l39.141">       globalElement.removeAttribute(f);</span>
<a href="#l39.142"></a><span id="l39.142">   }</span>
<a href="#l39.143"></a><span id="l39.143">   return true;</span>
<a href="#l39.144"></a><span id="l39.144"> }</span>
<a href="#l39.145"></a><span id="l39.145"> </span>
<a href="#l39.146"></a><span id="l39.146" class="difflineminus">-function onAccept()</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineminus">-{</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineplus">+function onAccept() {</span>
<a href="#l39.149"></a><span id="l39.149">   // All values are valid - copy to actual element in doc or</span>
<a href="#l39.150"></a><span id="l39.150">   //   element created to insert</span>
<a href="#l39.151"></a><span id="l39.151">   ValidateData();</span>
<a href="#l39.152"></a><span id="l39.152"> </span>
<a href="#l39.153"></a><span id="l39.153">   var editor = GetCurrentEditor();</span>
<a href="#l39.154"></a><span id="l39.154"> </span>
<a href="#l39.155"></a><span id="l39.155">   editor.beginTransaction();</span>
<a href="#l39.156"></a><span id="l39.156"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/editor/ui/editorUtilities.jsm</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/editor/ui/editorUtilities.jsm</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -2,12 +2,11 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.5"></a><span id="l40.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.6"></a><span id="l40.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8"> var EXPORTED_SYMBOLS = [&quot;GetNextUntitledValue&quot;];</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10"> var sUntitledCount = 1;</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-function GetNextUntitledValue()</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-{</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+function GetNextUntitledValue() {</span>
<a href="#l40.15"></a><span id="l40.15">   return sUntitledCount++;</span>
<a href="#l40.16"></a><span id="l40.16"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/editor/ui/nsComposerCmdLineHandler.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/editor/ui/nsComposerCmdLineHandler.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -14,44 +14,42 @@ nsComposerCmdLineHandler.prototype = {</span>
<a href="#l41.4"></a><span id="l41.4">   get wrappedJSObject() {</span>
<a href="#l41.5"></a><span id="l41.5">     return this;</span>
<a href="#l41.6"></a><span id="l41.6">   },</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8">   /* nsISupports */</span>
<a href="#l41.9"></a><span id="l41.9">   QueryInterface: ChromeUtils.generateQI([nsICommandLineHandler]),</span>
<a href="#l41.10"></a><span id="l41.10"> </span>
<a href="#l41.11"></a><span id="l41.11">   /* nsICommandLineHandler */</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  handle : function handle(cmdLine) {</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+  handle: function handle(cmdLine) {</span>
<a href="#l41.14"></a><span id="l41.14">     var args = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l41.15"></a><span id="l41.15">                  .createInstance(nsISupportsString);</span>
<a href="#l41.16"></a><span id="l41.16">     try {</span>
<a href="#l41.17"></a><span id="l41.17">       var uristr = cmdLine.handleFlagWithParam(&quot;edit&quot;, false);</span>
<a href="#l41.18"></a><span id="l41.18">       if (uristr == null) {</span>
<a href="#l41.19"></a><span id="l41.19">         // Try the editor flag (used for general.startup.* prefs)</span>
<a href="#l41.20"></a><span id="l41.20">         uristr = cmdLine.handleFlagWithParam(&quot;editor&quot;, false);</span>
<a href="#l41.21"></a><span id="l41.21">         if (uristr == null)</span>
<a href="#l41.22"></a><span id="l41.22">           return;</span>
<a href="#l41.23"></a><span id="l41.23">       }</span>
<a href="#l41.24"></a><span id="l41.24"> </span>
<a href="#l41.25"></a><span id="l41.25">       try {</span>
<a href="#l41.26"></a><span id="l41.26">         args.data = cmdLine.resolveURI(uristr).spec;</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-      }</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-      catch (e) {</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+      } catch (e) {</span>
<a href="#l41.30"></a><span id="l41.30">         return;</span>
<a href="#l41.31"></a><span id="l41.31">       }</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-    }</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-    catch (e) {</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+    } catch (e) {</span>
<a href="#l41.35"></a><span id="l41.35">       // One of the flags is present but no data, so set default arg.</span>
<a href="#l41.36"></a><span id="l41.36">       args.data = &quot;about:blank&quot;;</span>
<a href="#l41.37"></a><span id="l41.37">     }</span>
<a href="#l41.38"></a><span id="l41.38"> </span>
<a href="#l41.39"></a><span id="l41.39">     Services.ww.openWindow(null, &quot;chrome://editor/content&quot;, &quot;_blank&quot;,</span>
<a href="#l41.40"></a><span id="l41.40">                            &quot;chrome,dialog=no,all&quot;, args);</span>
<a href="#l41.41"></a><span id="l41.41">     cmdLine.preventDefault = true;</span>
<a href="#l41.42"></a><span id="l41.42">   },</span>
<a href="#l41.43"></a><span id="l41.43"> </span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-  helpInfo : &quot;  -edit &lt;url&gt;        Open Composer.\n&quot;,</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineplus">+  helpInfo: &quot;  -edit &lt;url&gt;        Open Composer.\n&quot;,</span>
<a href="#l41.46"></a><span id="l41.46"> </span>
<a href="#l41.47"></a><span id="l41.47">   /* XPCOMUtils */</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-  classID: Components.ID(&quot;{f7d8db95-ab5d-4393-a796-9112fe758cfa}&quot;)</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+  classID: Components.ID(&quot;{f7d8db95-ab5d-4393-a796-9112fe758cfa}&quot;),</span>
<a href="#l41.50"></a><span id="l41.50"> };</span>
<a href="#l41.51"></a><span id="l41.51"> </span>
<a href="#l41.52"></a><span id="l41.52"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([nsComposerCmdLineHandler]);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

