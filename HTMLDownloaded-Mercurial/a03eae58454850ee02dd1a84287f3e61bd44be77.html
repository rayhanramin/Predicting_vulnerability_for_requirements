<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5210:a03eae58454850ee02dd1a84287f3e61bd44be77</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a03eae58454850ee02dd1a84287f3e61bd44be77" />
<meta property="og:url" content="/comm-central/rev/a03eae58454850ee02dd1a84287f3e61bd44be77" />
<meta property="og:description" content="Fetch mail server config directly from ISP. Bug 534722, r=bwinton, ui-r=clarkbw" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a03eae58454850ee02dd1a84287f3e61bd44be77 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a03eae58454850ee02dd1a84287f3e61bd44be77">shortlog</a> |
<a href="/comm-central/log/a03eae58454850ee02dd1a84287f3e61bd44be77">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a03eae58454850ee02dd1a84287f3e61bd44be77">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a03eae58454850ee02dd1a84287f3e61bd44be77">files</a> |
changeset |
<a href="/comm-central/raw-rev/a03eae58454850ee02dd1a84287f3e61bd44be77">raw</a>  | <a href="/comm-central/archive/a03eae58454850ee02dd1a84287f3e61bd44be77.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fetch mail server config directly from ISP. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534722">Bug 534722</a>, r=bwinton, ui-r=clarkbw
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 19 Mar 2010 22:00:22 +0100</td></tr>

<tr>
 <td>changeset 5210</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a03eae58454850ee02dd1a84287f3e61bd44be77">a03eae58454850ee02dd1a84287f3e61bd44be77</a></td>
</tr>



<tr>
<td>parent 5209</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/47d93faea82a862c7308eceb3be6efc07f182797">47d93faea82a862c7308eceb3be6efc07f182797</a>
</td>
</tr>

<tr>
<td>child 5211</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/895928822eb3ea5a70c6294e71df940f61af84f5">895928822eb3ea5a70c6294e71df940f61af84f5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a03eae58454850ee02dd1a84287f3e61bd44be77">4022</a></td></tr>
<tr><td>push user</td><td>mozilla.BenB@bucksch.org</td></tr>
<tr><td>push date</td><td class="date age">Fri, 19 Mar 2010 21:00:59 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a03eae584548 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a03eae58454850ee02dd1a84287f3e61bd44be77">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a03eae58454850ee02dd1a84287f3e61bd44be77&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a03eae58454850ee02dd1a84287f3e61bd44be77&newProject=comm-central&newRevision=a03eae58454850ee02dd1a84287f3e61bd44be77&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a03eae58454850ee02dd1a84287f3e61bd44be77&newProject=comm-central&newRevision=a03eae58454850ee02dd1a84287f3e61bd44be77&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a03eae58454850ee02dd1a84287f3e61bd44be77&newProject=comm-central&newRevision=a03eae58454850ee02dd1a84287f3e61bd44be77&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a>, <a href="/comm-central/log?rev=reviewer%28clarkbw%29&revcount=50">clarkbw</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534722">534722</a></td></tr>




</table></div>

<div class="page_body description">Fetch mail server config directly from ISP. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534722">Bug 534722</a>, r=bwinton, ui-r=clarkbw</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a03eae58454850ee02dd1a84287f3e61bd44be77/mail/locales/en-US/chrome/messenger/accountCreation.properties">mail/locales/en-US/chrome/messenger/accountCreation.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a03eae58454850ee02dd1a84287f3e61bd44be77/mail/locales/en-US/chrome/messenger/accountCreation.properties">file</a> |
<a href="/comm-central/annotate/a03eae58454850ee02dd1a84287f3e61bd44be77/mail/locales/en-US/chrome/messenger/accountCreation.properties">annotate</a> |
<a href="/comm-central/diff/a03eae58454850ee02dd1a84287f3e61bd44be77/mail/locales/en-US/chrome/messenger/accountCreation.properties">diff</a> |
<a href="/comm-central/comparison/a03eae58454850ee02dd1a84287f3e61bd44be77/mail/locales/en-US/chrome/messenger/accountCreation.properties">comparison</a> |
<a href="/comm-central/log/a03eae58454850ee02dd1a84287f3e61bd44be77/mail/locales/en-US/chrome/messenger/accountCreation.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/emailWizard.js">mailnews/base/prefs/content/accountcreation/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/emailWizard.js">file</a> |
<a href="/comm-central/annotate/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/emailWizard.js">comparison</a> |
<a href="/comm-central/log/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/fetchConfig.js">mailnews/base/prefs/content/accountcreation/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/util.js">mailnews/base/prefs/content/accountcreation/util.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/util.js">file</a> |
<a href="/comm-central/annotate/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/util.js">annotate</a> |
<a href="/comm-central/diff/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/util.js">diff</a> |
<a href="/comm-central/comparison/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/util.js">comparison</a> |
<a href="/comm-central/log/a03eae58454850ee02dd1a84287f3e61bd44be77/mailnews/base/prefs/content/accountcreation/util.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/accountCreation.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/accountCreation.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -6,23 +6,33 @@ cleartext_warning=%1$S does not use encr</span>
<a href="#l1.4"></a><span id="l1.4"> selfsigned_warning=%1$S does not use a trusted certificate.</span>
<a href="#l1.5"></a><span id="l1.5"> selfsigned_details=Normally, a secure mail server will present a trusted certificate to prove that it is really the server it claims to be. The connection to the mail server will be encrypted but cannot be validated as being the correct server.</span>
<a href="#l1.6"></a><span id="l1.6"> cleartext_details=Insecure mail servers do not use encrypted connections to protect your passwords and private information. By connecting to this server you could expose your password and private information.</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # LOCALIZATION NOTE(default_server_tag): Used to indicate the default smtp server in the server dropdown list.</span>
<a href="#l1.9"></a><span id="l1.9"> default_server_tag= (default)</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> # config titles</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-# LOCALIZATION NOTE(looking_up_settings): %1$S will be the brandShortName.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-looking_up_settings=%1$S is looking up the settings for your email account.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-manually_edit_config=Editing Config</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-# LOCALIZATION NOTE(found_settings): %1$S will be the brandShortName.</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-found_settings=%1$S has found the settings for your email account.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+# LOCALIZATION NOTE(looking_up_settings_disk): Referring to Thunderbird installation folder on user's harddisk</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+looking_up_settings_disk=Looking up configuration: Thunderbird installation</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+looking_up_settings_isp=Looking up configuration: Email provider</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+# LOCALIZATION NOTE(looking_up_settings_db): Do not translate or replace Mozilla. It stands for the public project mozilla.org, not Mozilla Messaging. The database is a generic, public domain facility usable by any client.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+looking_up_settings_db=Looking up configuration: Mozilla ISP database</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+# LOCALIZATION NOTE(looking_up_settings_guess): We are checking common server names like pop., pop3., smtp., mail., without knowing whether they exist or really serve this email account. If a server responds, we try to talk to it via POP/IMAP/SMTP protocols and query its capabilities. If that succeeds, we assume we found a configuration. Of course, it may still be wrong, but it often works.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+looking_up_settings_guess=Looking up configuration: Trying common server names</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+# LOCALIZATION NOTE(found_settings_disk): Referring to Thunderbird installation folder on user's harddisk</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+found_settings_disk=The following settings were found on: Thunderbird installation</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+found_settings_isp=The following settings were found from: Email provider</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+# LOCALIZATION NOTE(found_settings_db): Do not translate or replace Mozilla. It stands for the public project mozilla.org, not Mozilla Messaging. The database is a generic, public domain facility usable by any client.</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+found_settings_db=The following settings were found from: Mozilla ISP database</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+# LOCALIZATION NOTE(found_settings_guess): We tried common mail server names and we found a mail server and talked to it and it responded properly, so we think we found a suitable configuration, but we are only about 80% certain that it is the correct setting for this email address. There's a chance that email address may not actually be served by this server and it won't work, or that there is a better server.</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+found_settings_guess=The following settings were found by trying common server names</span>
<a href="#l1.31"></a><span id="l1.31"> # LOCALIZATION NOTE(failed_to_find_settings): %1$S will be the brandShortName.</span>
<a href="#l1.32"></a><span id="l1.32"> failed_to_find_settings=%1$S failed to find the settings for your email account.</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+manually_edit_config=Editing Config</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35"> # config subtitles</span>
<a href="#l1.36"></a><span id="l1.36"> check_preconfig=checking for pre-configuration…</span>
<a href="#l1.37"></a><span id="l1.37"> found_preconfig=found pre-configuration</span>
<a href="#l1.38"></a><span id="l1.38"> checking_config=checking configuration…</span>
<a href="#l1.39"></a><span id="l1.39"> found_config=Found configuration of your account</span>
<a href="#l1.40"></a><span id="l1.40"> checking_mozilla_config=checking Mozilla Community configurations…</span>
<a href="#l1.41"></a><span id="l1.41"> found_isp_config=found a configuration</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineat">@@ -40,14 +50,15 @@ password_ok=Password ok!</span>
<a href="#l1.43"></a><span id="l1.43"> user_pass_invalid=Username or password invalid</span>
<a href="#l1.44"></a><span id="l1.44"> check_server_details=Checking server details</span>
<a href="#l1.45"></a><span id="l1.45"> check_in_server_details=Checking incoming server details</span>
<a href="#l1.46"></a><span id="l1.46"> check_out_server_details=Checking outgoing server details</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48"> error_creating_account=Error Creating Account</span>
<a href="#l1.49"></a><span id="l1.49"> incoming_server_exists=Incoming server already exists.</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+# LOCALIZATION NOTE(no_encryption): Neither SSL/TLS nor STARTTLS. Transmission of emails in cleartext over the Internet.</span>
<a href="#l1.52"></a><span id="l1.52"> no_encryption=No encryption</span>
<a href="#l1.53"></a><span id="l1.53"> ssl_tls=SSL/TLS</span>
<a href="#l1.54"></a><span id="l1.54"> starttls=STARTTLS</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56"> please_enter_name=Please enter your name.</span>
<a href="#l1.57"></a><span id="l1.57"> double_check_email=Double check this email address!</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -411,55 +411,64 @@ EmailConfigWizard.prototype =</span>
<a href="#l2.4"></a><span id="l2.4">     }</span>
<a href="#l2.5"></a><span id="l2.5">     else</span>
<a href="#l2.6"></a><span id="l2.6">       rememberPasswordElt.disabled = false;</span>
<a href="#l2.7"></a><span id="l2.7">   },</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   findConfig : function(domain, email)</span>
<a href="#l2.10"></a><span id="l2.10">   {</span>
<a href="#l2.11"></a><span id="l2.11">     gEmailWizardLogger.info(&quot;findConfig()&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    this.startSpinner(&quot;all&quot;, &quot;looking_up_settings&quot;);</span>
<a href="#l2.13"></a><span id="l2.13">     if (this._probeAbortable)</span>
<a href="#l2.14"></a><span id="l2.14">     {</span>
<a href="#l2.15"></a><span id="l2.15">       gEmailWizardLogger.info(&quot;aborting existing config search&quot;);</span>
<a href="#l2.16"></a><span id="l2.16">       this._probeAbortable.cancel();</span>
<a href="#l2.17"></a><span id="l2.17">     }</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    this.startSpinner(&quot;all&quot;, &quot;looking_up_settings_disk&quot;);</span>
<a href="#l2.19"></a><span id="l2.19">     var me = this;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    this._probeAbortable = </span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-      fetchConfigFromDisk(</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-        domain,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-        function(config) // success</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-        {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-          me.foundConfig(config);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-          me.stopSpinner(&quot;found_settings&quot;);</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-          me._probeAbortable = null;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-        },</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-        function(e) // fetchConfigFromDisk failed</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-        {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-          gEmailWizardLogger.info(&quot;fetchConfigFromDisk failed: &quot; + e);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-          me.startSpinner(&quot;all&quot;, &quot;looking_up_settings&quot;);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-          me._probeAbortable = </span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-            fetchConfigFromDB(</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-              domain,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    this._probeAbortable = fetchConfigFromDisk(domain,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+      function(config) // success</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+      {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+        me.foundConfig(config);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+        me.stopSpinner(&quot;found_settings_disk&quot;);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+        me._probeAbortable = null;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+      },</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+      function(e) // fetchConfigFromDisk failed</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+      {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+        gEmailWizardLogger.info(&quot;fetchConfigFromDisk failed: &quot; + e);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+        me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_isp&quot;);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+        me._probeAbortable = fetchConfigFromISP(domain, email,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+          function(config) // success</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+          {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+            me.foundConfig(config);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+            me.stopSpinner(&quot;found_settings_isp&quot;);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+            me.showEditButton();</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+            me._probeAbortable = null;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+          },</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+          function(e) // fetchConfigFromISP failed</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+          {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+            gEmailWizardLogger.info(&quot;fetchConfigFromISP failed: &quot; + e);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+            me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_db&quot;);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+            me._probeAbortable = fetchConfigFromDB(domain,</span>
<a href="#l2.60"></a><span id="l2.60">               function(config) // success</span>
<a href="#l2.61"></a><span id="l2.61">               {</span>
<a href="#l2.62"></a><span id="l2.62">                 me.foundConfig(config);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-                me.stopSpinner(&quot;found_settings&quot;);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+                me.stopSpinner(&quot;found_settings_db&quot;);</span>
<a href="#l2.65"></a><span id="l2.65">                 me.showEditButton();</span>
<a href="#l2.66"></a><span id="l2.66">                 me._probeAbortable = null;</span>
<a href="#l2.67"></a><span id="l2.67">               },</span>
<a href="#l2.68"></a><span id="l2.68">               function(e) // fetchConfigFromDB failed</span>
<a href="#l2.69"></a><span id="l2.69">               {</span>
<a href="#l2.70"></a><span id="l2.70">                 gEmailWizardLogger.info(&quot;fetchConfigFromDB failed: &quot; + e);</span>
<a href="#l2.71"></a><span id="l2.71">                 var initialConfig = new AccountConfig();</span>
<a href="#l2.72"></a><span id="l2.72">                 me._prefillConfig(initialConfig);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-                me.startSpinner(&quot;all&quot;, &quot;looking_up_settings&quot;)</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-                me._guessConfig(domain, initialConfig, 'both');</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+                me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_guess&quot;)</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+                me._guessConfig(domain, initialConfig, &quot;both&quot;);</span>
<a href="#l2.77"></a><span id="l2.77">               });</span>
<a href="#l2.78"></a><span id="l2.78">           });</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+      });</span>
<a href="#l2.80"></a><span id="l2.80">   },</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">   _guessConfig : function(domain, initialConfig, which)</span>
<a href="#l2.83"></a><span id="l2.83">   {</span>
<a href="#l2.84"></a><span id="l2.84">     let me = this;</span>
<a href="#l2.85"></a><span id="l2.85">     // guessConfig takes several callback functions, which we define inline.</span>
<a href="#l2.86"></a><span id="l2.86">     me._probeAbortable = guessConfig(domain,</span>
<a href="#l2.87"></a><span id="l2.87">           function(type, hostname, port, ssl, done, config) // progress</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineat">@@ -486,34 +495,34 @@ EmailConfigWizard.prototype =</span>
<a href="#l2.89"></a><span id="l2.89">           function(config) // success</span>
<a href="#l2.90"></a><span id="l2.90">           {</span>
<a href="#l2.91"></a><span id="l2.91">             me.foundConfig(config);</span>
<a href="#l2.92"></a><span id="l2.92">             gEmailWizardLogger.info(&quot;in success, incomingState = &quot; +</span>
<a href="#l2.93"></a><span id="l2.93">                                     me._incomingState + &quot; outgoingState = &quot; +</span>
<a href="#l2.94"></a><span id="l2.94">                                     me._outgoingState);</span>
<a href="#l2.95"></a><span id="l2.95">             if (me._incomingState == 'done' &amp;&amp; me._outgoingState == 'done')</span>
<a href="#l2.96"></a><span id="l2.96">             {</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-              me.stopSpinner(&quot;found_settings&quot;);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+              me.stopSpinner(&quot;found_settings_guess&quot;);</span>
<a href="#l2.99"></a><span id="l2.99">               _hide(&quot;stop_button&quot;);</span>
<a href="#l2.100"></a><span id="l2.100">               _show(&quot;edit_button&quot;);</span>
<a href="#l2.101"></a><span id="l2.101">             }</span>
<a href="#l2.102"></a><span id="l2.102">             else if (me._incomingState == 'done' &amp;&amp; me._outgoingState != 'probing')</span>
<a href="#l2.103"></a><span id="l2.103">             {</span>
<a href="#l2.104"></a><span id="l2.104">               if (me._outgoingState == &quot;failed&quot;)</span>
<a href="#l2.105"></a><span id="l2.105">                 me.stopSpinner(&quot;failed_to_find_settings&quot;);</span>
<a href="#l2.106"></a><span id="l2.106">               else</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-                me.stopSpinner(&quot;found_settings&quot;);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+                me.stopSpinner(&quot;found_settings_guess&quot;);</span>
<a href="#l2.109"></a><span id="l2.109">               me.editConfigDetails();</span>
<a href="#l2.110"></a><span id="l2.110">             }</span>
<a href="#l2.111"></a><span id="l2.111">             else if (me._outgoingState == 'done' &amp;&amp; me._incomingState != 'probing')</span>
<a href="#l2.112"></a><span id="l2.112">             {</span>
<a href="#l2.113"></a><span id="l2.113">               if (me._incomingState == &quot;failed&quot;)</span>
<a href="#l2.114"></a><span id="l2.114">                 me.stopSpinner(&quot;failed_to_find_settings&quot;);</span>
<a href="#l2.115"></a><span id="l2.115">               else</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-                me.stopSpinner(&quot;found_settings&quot;);</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+                me.stopSpinner(&quot;found_settings_guess&quot;);</span>
<a href="#l2.118"></a><span id="l2.118">               me.editConfigDetails();</span>
<a href="#l2.119"></a><span id="l2.119">             }</span>
<a href="#l2.120"></a><span id="l2.120">             if (me._outgoingState != 'probing' &amp;&amp;</span>
<a href="#l2.121"></a><span id="l2.121">                 me._incomingState != 'probing')</span>
<a href="#l2.122"></a><span id="l2.122">               me._probeAbortable = null;</span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124">           },</span>
<a href="#l2.125"></a><span id="l2.125">           function(e, config) // guessconfig failed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -65,30 +65,55 @@ function fetchConfigFromDisk(domain, suc</span>
<a href="#l3.4"></a><span id="l3.4">  *         will be called when we could retrieve a configuration.</span>
<a href="#l3.5"></a><span id="l3.5">  *         The AccountConfig object will be passed in as first parameter.</span>
<a href="#l3.6"></a><span id="l3.6">  * @param errorCallback {Function(ex)}   A callback that</span>
<a href="#l3.7"></a><span id="l3.7">  *         will be called when we could not retrieve a configuration,</span>
<a href="#l3.8"></a><span id="l3.8">  *         for whatever reason. This is expected (e.g. when there's no config</span>
<a href="#l3.9"></a><span id="l3.9">  *         for this domain at this location), so do not unconditionally show this to the user.</span>
<a href="#l3.10"></a><span id="l3.10">  *         The first paramter will be an exception object or error string.</span>
<a href="#l3.11"></a><span id="l3.11">  */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13"> function fetchConfigFromISP(domain, emailAddress, successCallback,</span>
<a href="#l3.14"></a><span id="l3.14">                             errorCallback)</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  let url = &quot;https://autoconfig.&quot; + sanitize.hostname(domain) +</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-            &quot;/mail/mozilla.xml&quot;;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  let fetch = new FetchHTTP(url, { emailaddress: emailAddress }, false,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-                            function(result)</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-                            {</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-                              successCallback(readFromXML(result));</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-                            },</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-                            errorCallback);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  fetch.start();</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-  return fetch;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  let url1 = &quot;http://autoconfig.&quot; + sanitize.hostname(domain) +</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+             &quot;/mail/config-v1.xml&quot;;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  // .well-known/ &lt;http://tools.ietf.org/html/draft-nottingham-site-meta-04&gt;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  let url2 = &quot;http://&quot; + sanitize.hostname(domain) +</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+             &quot;/.well-known/autoconfig/mail/config-v1.xml&quot;;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  let sucAbortable = new SuccessiveAbortable();</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  var time = Date.now();</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  let fetch1 = new FetchHTTP(</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+    url1, { emailaddress: emailAddress }, false,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    function(result)</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+      successCallback(readFromXML(result));</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    },</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    function(e1) // fetch1 failed</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+    {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      ddump(&quot;fetchisp 1 &lt;&quot; + url1 + &quot;&gt; took &quot; + (Date.now() - time) +</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+          &quot;ms and failed with &quot; + e1);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+      time = Date.now();</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+      let fetch2 = new FetchHTTP(</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+        url2, { emailaddress: emailAddress }, false,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+        function(result)</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+        {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+          successCallback(readFromXML(result));</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+        },</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+        function(e2)</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+        {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+          ddump(&quot;fetchisp 2 &lt;&quot; + url2 + &quot;&gt; took &quot; + (Date.now() - time) +</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+              &quot;ms and failed with &quot; + e2);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+          errorCallback(e1); // return error for primary call</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+        });</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+      sucAbortable.current = fetch2;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+      fetch2.start();</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    });</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  sucAbortable.current = fetch1;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  fetch1.start();</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  return sucAbortable;</span>
<a href="#l3.62"></a><span id="l3.62"> }</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64"> /**</span>
<a href="#l3.65"></a><span id="l3.65">  * Tries to get a configuration for this ISP from a central database at</span>
<a href="#l3.66"></a><span id="l3.66">  * Mozilla servers.</span>
<a href="#l3.67"></a><span id="l3.67">  * Params @see fetchConfigFromISP()</span>
<a href="#l3.68"></a><span id="l3.68">  */</span>
<a href="#l3.69"></a><span id="l3.69"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/util.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/util.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -232,16 +232,43 @@ IntervalAbortable.prototype =</span>
<a href="#l4.4"></a><span id="l4.4"> {</span>
<a href="#l4.5"></a><span id="l4.5">   cancel : function()</span>
<a href="#l4.6"></a><span id="l4.6">   {</span>
<a href="#l4.7"></a><span id="l4.7">     clearInterval(this._id);</span>
<a href="#l4.8"></a><span id="l4.8">   }</span>
<a href="#l4.9"></a><span id="l4.9"> }</span>
<a href="#l4.10"></a><span id="l4.10"> extend(IntervalAbortable, Abortable);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+// Allows you to make several network calls, but return only one Abortable object.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+function SuccessiveAbortable()</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+{</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  this._current = null;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+}</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+SuccessiveAbortable.prototype =</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+{</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  set current(abortable)</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+    assert(abortable instanceof Abortable || abortable == null,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+        &quot;need an Abortable object (or null)&quot;);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+    this._current = abortable;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  },</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  get current()</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  {</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+    return this._current;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  },</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  cancel : function()</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    if (this._current)</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+      this._current.cancel();</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  },</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+}</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+extend(SuccessiveAbortable, Abortable);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+</span>
<a href="#l4.39"></a><span id="l4.39"> function deepCopy(org)</span>
<a href="#l4.40"></a><span id="l4.40"> {</span>
<a href="#l4.41"></a><span id="l4.41">   if (typeof(org) == &quot;undefined&quot;)</span>
<a href="#l4.42"></a><span id="l4.42">     return undefined;</span>
<a href="#l4.43"></a><span id="l4.43">   if (org == null)</span>
<a href="#l4.44"></a><span id="l4.44">     return null;</span>
<a href="#l4.45"></a><span id="l4.45">   if (typeof(org) == &quot;string&quot;)</span>
<a href="#l4.46"></a><span id="l4.46">     return org;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

