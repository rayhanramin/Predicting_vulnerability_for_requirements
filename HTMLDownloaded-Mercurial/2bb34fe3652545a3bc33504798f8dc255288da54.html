<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22219:2bb34fe3652545a3bc33504798f8dc255288da54</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2bb34fe3652545a3bc33504798f8dc255288da54" />
<meta property="og:url" content="/comm-central/rev/2bb34fe3652545a3bc33504798f8dc255288da54" />
<meta property="og:description" content="Bug 1403393: Backed out changeset 8747679c08a4. a=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2bb34fe3652545a3bc33504798f8dc255288da54 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2bb34fe3652545a3bc33504798f8dc255288da54">shortlog</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2bb34fe3652545a3bc33504798f8dc255288da54">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54">files</a> |
changeset |
<a href="/comm-central/raw-rev/2bb34fe3652545a3bc33504798f8dc255288da54">raw</a>  | <a href="/comm-central/archive/2bb34fe3652545a3bc33504798f8dc255288da54.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1403393">Bug 1403393</a>: Backed out changeset 8747679c08a4. a=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 27 Sep 2017 07:58:29 +0200</td></tr>

<tr>
 <td>changeset 22219</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2bb34fe3652545a3bc33504798f8dc255288da54">2bb34fe3652545a3bc33504798f8dc255288da54</a></td>
</tr>



<tr>
<td>parent 22218</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/523f36e9ebc57c20886693d71bf936c45fa1f9df">523f36e9ebc57c20886693d71bf936c45fa1f9df</a>
</td>
</tr>

<tr>
<td>child 22220</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5b7dc947139e10f256ae3ff40877bf6a67d37207">5b7dc947139e10f256ae3ff40877bf6a67d37207</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2bb34fe3652545a3bc33504798f8dc255288da54">13557</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 27 Sep 2017 11:23:51 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5b7dc947139e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5b7dc947139e10f256ae3ff40877bf6a67d37207">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5b7dc947139e10f256ae3ff40877bf6a67d37207&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5b7dc947139e10f256ae3ff40877bf6a67d37207&newProject=comm-central&newRevision=2bb34fe3652545a3bc33504798f8dc255288da54&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5b7dc947139e10f256ae3ff40877bf6a67d37207&newProject=comm-central&newRevision=2bb34fe3652545a3bc33504798f8dc255288da54&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5b7dc947139e10f256ae3ff40877bf6a67d37207&newProject=comm-central&newRevision=2bb34fe3652545a3bc33504798f8dc255288da54&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1403393">1403393</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1403393">Bug 1403393</a>: Backed out changeset 8747679c08a4. a=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/moz.build">mailnews/base/public/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/moz.build">file</a> |
<a href="/comm-central/annotate/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/moz.build">annotate</a> |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/moz.build">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/moz.build">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsIStreamTransportService2.idl">mailnews/base/public/nsIStreamTransportService2.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsIStreamTransportService2.idl">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsIStreamTransportService2.idl">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsIStreamTransportService2.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsMsgBaseCID.h">mailnews/base/public/nsMsgBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsMsgBaseCID.h">file</a> |
<a href="/comm-central/annotate/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsMsgBaseCID.h">annotate</a> |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsMsgBaseCID.h">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsMsgBaseCID.h">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/public/nsMsgBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/ServiceList.h">mailnews/base/util/ServiceList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/ServiceList.h">file</a> |
<a href="/comm-central/annotate/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/ServiceList.h">annotate</a> |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/ServiceList.h">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/ServiceList.h">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/ServiceList.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/Services.cpp">mailnews/base/util/Services.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/Services.cpp">file</a> |
<a href="/comm-central/annotate/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/Services.cpp">annotate</a> |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/Services.cpp">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/Services.cpp">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/Services.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/moz.build">mailnews/base/util/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/moz.build">file</a> |
<a href="/comm-central/annotate/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/moz.build">annotate</a> |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/moz.build">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/moz.build">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsStreamTransportService2.cpp">mailnews/base/util/nsStreamTransportService2.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsStreamTransportService2.cpp">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsStreamTransportService2.cpp">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsStreamTransportService2.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsStreamTransportService2.h">mailnews/base/util/nsStreamTransportService2.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsStreamTransportService2.h">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsStreamTransportService2.h">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/base/util/nsStreamTransportService2.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/local/src/nsMailboxProtocol.cpp">mailnews/local/src/nsMailboxProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/local/src/nsMailboxProtocol.cpp">file</a> |
<a href="/comm-central/annotate/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/local/src/nsMailboxProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/local/src/nsMailboxProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/local/src/nsMailboxProtocol.cpp">comparison</a> |
<a href="/comm-central/log/2bb34fe3652545a3bc33504798f8dc255288da54/mailnews/local/src/nsMailboxProtocol.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/moz.build</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/moz.build</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -52,17 +52,16 @@ XPIDL_SOURCES += [</span>
<a href="#l1.4"></a><span id="l1.4">     'nsIMsgStatusFeedback.idl',</span>
<a href="#l1.5"></a><span id="l1.5">     'nsIMsgTagService.idl',</span>
<a href="#l1.6"></a><span id="l1.6">     'nsIMsgThread.idl',</span>
<a href="#l1.7"></a><span id="l1.7">     'nsIMsgUserFeedbackListener.idl',</span>
<a href="#l1.8"></a><span id="l1.8">     'nsIMsgWindow.idl',</span>
<a href="#l1.9"></a><span id="l1.9">     'nsISpamSettings.idl',</span>
<a href="#l1.10"></a><span id="l1.10">     'nsIStatusBarBiffManager.idl',</span>
<a href="#l1.11"></a><span id="l1.11">     'nsIStopwatch.idl',</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    'nsIStreamTransportService2.idl',</span>
<a href="#l1.13"></a><span id="l1.13">     'nsISubscribableServer.idl',</span>
<a href="#l1.14"></a><span id="l1.14">     'nsIUrlListener.idl',</span>
<a href="#l1.15"></a><span id="l1.15">     'nsMsgFolderFlags.idl',</span>
<a href="#l1.16"></a><span id="l1.16">     'nsMsgMessageFlags.idl',</span>
<a href="#l1.17"></a><span id="l1.17"> ]</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> XPIDL_MODULE = 'msgbase'</span>
<a href="#l1.20"></a><span id="l1.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/mailnews/base/public/nsIStreamTransportService2.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,43 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">-</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-interface nsITransport;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-interface nsIInputStream;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-/**</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">- * This service read/writes a stream on a background thread.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">- *</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">- * Use this service to transform any blocking stream (e.g., file stream)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">- * into a fully asynchronous stream that can be read/written without </span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">- * blocking the main thread.</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">- */</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-[builtinclass, scriptable, uuid(80f305e1-a04b-4795-97af-72a86681c76c)]</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-interface nsIStreamTransportService2 : nsISupports</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-{</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    /**</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-     * CreateInputTransport</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-     *</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-     * @param aStream</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-     *        The input stream that will be read on a background thread.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-     *        This stream must implement &quot;blocking&quot; stream semantics.</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-     * @param aStartOffset</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-     *        The input stream will be read starting from this offset.  Pass</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-     *        -1 to read from the current stream offset.  NOTE: this parameter</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-     *        is ignored if the stream does not support nsISeekableStream.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-     * @param aReadLimit</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-     *        This parameter limits the number of bytes that will be read from</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-     *        the input stream.  Pass -1 to read everything.</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-     * @param aCloseWhenDone</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-     *        Specify this flag to have the input stream closed once its</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-     *        contents have been completely read.</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-     *</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-     * @return nsITransport instance.</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-     */</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    nsITransport createInputTransport(in nsIInputStream aStream,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-                                      in long long aStartOffset,</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-                                      in long long aReadLimit,</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-                                      in boolean aCloseWhenDone);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/public/nsMsgBaseCID.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/public/nsMsgBaseCID.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -528,23 +528,9 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #define MOZ_NEWMAILNOTIFICATIONSERVICE_CID \</span>
<a href="#l3.5"></a><span id="l3.5"> { /* 740880E6-E299-4165-B82F-DF1DCAB3AE22 */ \</span>
<a href="#l3.6"></a><span id="l3.6">   0x740880E6, 0xE299, 0x4165, \</span>
<a href="#l3.7"></a><span id="l3.7">     { 0xB8, 0x2F, 0xDF, 0x1D, 0xCA, 0xB3, 0xAE, 0x22 }}</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> #define MOZ_NEWMAILNOTIFICATIONSERVICE_CONTRACTID \</span>
<a href="#l3.10"></a><span id="l3.10">   &quot;@mozilla.org/newMailNotificationService;1&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-//</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-// Service implementing nsIStreamTransportService2,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-// forked from nsIStreamTransportService.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-//</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-#define NS_STREAMTRANSPORTSERVICE2_CONTRACTID \</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    &quot;@mozilla.org/mailnews/stream-transport-service2;1&quot;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-#define NS_STREAMTRANSPORTSERVICE2_CID \</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-{ /* 80f305e1-a04b-4795-97af-72a86681c76c */         \</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    0x80f305e1,                                      \</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    0xa04b,                                          \</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    0x4795,                                          \</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    {0x97, 0xaf, 0x72, 0xa8, 0x66, 0x81, 0xc7, 0x6c} \</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-}</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-</span>
<a href="#l3.26"></a><span id="l3.26"> #endif // nsMessageBaseCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/ServiceList.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/ServiceList.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -25,18 +25,16 @@ MOZ_SERVICE(ImportService,     nsIImport</span>
<a href="#l4.4"></a><span id="l4.4"> MOZ_SERVICE(MailNotifyService, mozINewMailNotificationService,</span>
<a href="#l4.5"></a><span id="l4.5">             &quot;@mozilla.org/newMailNotificationService;1&quot;)</span>
<a href="#l4.6"></a><span id="l4.6"> MOZ_SERVICE(MailSession,       nsIMsgMailSession,</span>
<a href="#l4.7"></a><span id="l4.7">             &quot;@mozilla.org/messenger/services/session;1&quot;)</span>
<a href="#l4.8"></a><span id="l4.8"> MOZ_SERVICE(MimeConverter,     nsIMimeConverter,</span>
<a href="#l4.9"></a><span id="l4.9">             &quot;@mozilla.org/messenger/mimeconverter;1&quot;)</span>
<a href="#l4.10"></a><span id="l4.10"> MOZ_SERVICE(MFNService,        nsIMsgFolderNotificationService,</span>
<a href="#l4.11"></a><span id="l4.11">             &quot;@mozilla.org/messenger/msgnotificationservice;1&quot;)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-MOZ_SERVICE(StreamTransportService2, nsIStreamTransportService2,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-            &quot;@mozilla.org/mailnews/stream-transport-service2;1&quot;)</span>
<a href="#l4.14"></a><span id="l4.14"> MOZ_SERVICE(NntpService,       nsINntpService,</span>
<a href="#l4.15"></a><span id="l4.15">             &quot;@mozilla.org/messenger/nntpservice;1&quot;)</span>
<a href="#l4.16"></a><span id="l4.16"> MOZ_SERVICE(Pop3Service,       nsIPop3Service,</span>
<a href="#l4.17"></a><span id="l4.17">             &quot;@mozilla.org/messenger/popservice;1&quot;)</span>
<a href="#l4.18"></a><span id="l4.18"> MOZ_SERVICE(SmtpService,       nsISmtpService,</span>
<a href="#l4.19"></a><span id="l4.19">             &quot;@mozilla.org/messengercompose/smtp;1&quot;)</span>
<a href="#l4.20"></a><span id="l4.20"> MOZ_SERVICE(TagService,        nsIMsgTagService,</span>
<a href="#l4.21"></a><span id="l4.21">             &quot;@mozilla.org/messenger/tagservice;1&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/Services.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/Services.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -16,17 +16,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIImportService.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIMsgComposeService.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsIStreamTransportService2.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsIMsgTagService.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsINntpService.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsIPop3Service.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsISmtpService.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> namespace mozilla {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/moz.build</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/moz.build</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -14,17 +14,16 @@ EXPORTS += [</span>
<a href="#l6.4"></a><span id="l6.4">     'nsMsgKeyArray.h',</span>
<a href="#l6.5"></a><span id="l6.5">     'nsMsgKeySet.h',</span>
<a href="#l6.6"></a><span id="l6.6">     'nsMsgLineBuffer.h',</span>
<a href="#l6.7"></a><span id="l6.7">     'nsMsgMailNewsUrl.h',</span>
<a href="#l6.8"></a><span id="l6.8">     'nsMsgProtocol.h',</span>
<a href="#l6.9"></a><span id="l6.9">     'nsMsgReadStateTxn.h',</span>
<a href="#l6.10"></a><span id="l6.10">     'nsMsgTxn.h',</span>
<a href="#l6.11"></a><span id="l6.11">     'nsMsgUtils.h',</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    'nsStreamTransportService2.h',</span>
<a href="#l6.13"></a><span id="l6.13"> ]</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> EXPORTS.mozilla.mailnews += [</span>
<a href="#l6.16"></a><span id="l6.16">     'ServiceList.h',</span>
<a href="#l6.17"></a><span id="l6.17">     'Services.h',</span>
<a href="#l6.18"></a><span id="l6.18"> ]</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> SOURCES += [</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -40,17 +39,16 @@ SOURCES += [</span>
<a href="#l6.22"></a><span id="l6.22">     'nsMsgKeySet.cpp',</span>
<a href="#l6.23"></a><span id="l6.23">     'nsMsgLineBuffer.cpp',</span>
<a href="#l6.24"></a><span id="l6.24">     'nsMsgMailNewsUrl.cpp',</span>
<a href="#l6.25"></a><span id="l6.25">     'nsMsgProtocol.cpp',</span>
<a href="#l6.26"></a><span id="l6.26">     'nsMsgReadStateTxn.cpp',</span>
<a href="#l6.27"></a><span id="l6.27">     'nsMsgTxn.cpp',</span>
<a href="#l6.28"></a><span id="l6.28">     'nsMsgUtils.cpp',</span>
<a href="#l6.29"></a><span id="l6.29">     'nsStopwatch.cpp',</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-    'nsStreamTransportService2.cpp',</span>
<a href="#l6.31"></a><span id="l6.31">     'Services.cpp',</span>
<a href="#l6.32"></a><span id="l6.32"> ]</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34"> EXTRA_JS_MODULES += [</span>
<a href="#l6.35"></a><span id="l6.35">     'ABQueryUtils.jsm',</span>
<a href="#l6.36"></a><span id="l6.36">     'errUtils.js',</span>
<a href="#l6.37"></a><span id="l6.37">     'folderUtils.jsm',</span>
<a href="#l6.38"></a><span id="l6.38">     'hostnameUtils.jsm',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsString.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsIStreamTransportService2.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#include &quot;nsIStreamTransportService.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;nsISocketTransportService.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsISocketTransport.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsILoadGroup.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsILoadInfo.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -203,18 +203,18 @@ nsresult nsMsgProtocol::OpenFileSocket(n</span>
<a href="#l7.23"></a><span id="l7.23">   rv = GetFileFromURL(aURL, getter_AddRefs(file));</span>
<a href="#l7.24"></a><span id="l7.24">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26">   nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l7.27"></a><span id="l7.27">   rv = NS_NewLocalFileInputStream(getter_AddRefs(stream), file);</span>
<a href="#l7.28"></a><span id="l7.28">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   // create input stream transport</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  nsCOMPtr&lt;nsIStreamTransportService2&gt; sts =</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-      do_GetService(NS_STREAMTRANSPORTSERVICE2_CONTRACTID, &amp;rv);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  nsCOMPtr&lt;nsIStreamTransportService&gt; sts =</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+      do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.35"></a><span id="l7.35">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37">   rv = sts-&gt;CreateInputTransport(stream, int64_t(aStartPosition),</span>
<a href="#l7.38"></a><span id="l7.38">                                  int64_t(aReadCount), true,</span>
<a href="#l7.39"></a><span id="l7.39">                                  getter_AddRefs(m_transport));</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">   m_socketIsOpen = false;</span>
<a href="#l7.42"></a><span id="l7.42">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mailnews/base/util/nsStreamTransportService2.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,562 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-#include &quot;nsStreamTransportService2.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-#include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-#include &quot;nsNetSegmentUtils.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsTransportUtils.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-#include &quot;nsStreamUtils.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-#include &quot;nsError.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-#include &quot;nsNetCID.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-#include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-#include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-#include &quot;nsISeekableStream.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-#include &quot;nsIPipe.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-#include &quot;nsITransport.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-#include &quot;nsIThreadPool.h&quot;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-namespace mozilla {</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-namespace net {</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-//-----------------------------------------------------------------------------</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-// nsInputStreamTransport2</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-//</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-// Implements nsIInputStream as a wrapper around the real input stream.  This</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-// allows the transport to support seeking, range-limiting, progress reporting,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-// and close-when-done semantics while utilizing NS_AsyncCopy.</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-//-----------------------------------------------------------------------------</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-class nsInputStreamTransport2 : public nsITransport</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-                              , public nsIInputStream</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-{</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-public:</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-    NS_DECL_NSITRANSPORT</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-    NS_DECL_NSIINPUTSTREAM</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-    nsInputStreamTransport2(nsIInputStream *source,</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-                            uint64_t offset,</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-                            uint64_t limit,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-                            bool closeWhenDone)</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-        : mSource(source)</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-        , mOffset(offset)</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-        , mLimit(limit)</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-        , mCloseWhenDone(closeWhenDone)</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-        , mFirstTime(true)</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-        , mInProgress(false)</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-    {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    }</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-private:</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-    virtual ~nsInputStreamTransport2()</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-    {</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-    }</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-    nsCOMPtr&lt;nsIAsyncInputStream&gt;   mPipeIn;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-    // while the copy is active, these members may only be accessed from the</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    // nsIInputStream implementation.</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-    nsCOMPtr&lt;nsITransportEventSink&gt; mEventSink;</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-    nsCOMPtr&lt;nsIInputStream&gt;        mSource;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-    int64_t                         mOffset;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-    int64_t                         mLimit;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-    bool                            mCloseWhenDone;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-    bool                            mFirstTime;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-    // this variable serves as a lock to prevent the state of the transport</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    // from being modified once the copy is in progress.</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    bool                            mInProgress;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-};</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-NS_IMPL_ISUPPORTS(nsInputStreamTransport2,</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-                  nsITransport,</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-                  nsIInputStream)</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-/** nsITransport **/</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-nsInputStreamTransport2::OpenInputStream(uint32_t flags,</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-                                         uint32_t segsize,</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-                                         uint32_t segcount,</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-                                         nsIInputStream **result)</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-{</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-    NS_ENSURE_TRUE(!mInProgress, NS_ERROR_IN_PROGRESS);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-    nsresult rv;</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-    nsCOMPtr&lt;nsIEventTarget&gt; target =</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-            do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-    // XXX if the caller requests an unbuffered stream, then perhaps</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-    //     we'd want to simply return mSource; however, then we would</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-    //     not be reading mSource on a background thread.  is this ok?</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-    bool nonblocking = !(flags &amp; OPEN_BLOCKING);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-    net_ResolveSegmentParams(segsize, segcount);</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-    nsCOMPtr&lt;nsIAsyncOutputStream&gt; pipeOut;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-    rv = NS_NewPipe2(getter_AddRefs(mPipeIn),</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-                     getter_AddRefs(pipeOut),</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-                     nonblocking, true,</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-                     segsize, segcount);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-    mInProgress = true;</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-    // startup async copy process...</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    rv = NS_AsyncCopy(this, pipeOut, target,</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-                      NS_ASYNCCOPY_VIA_WRITESEGMENTS, segsize);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-        NS_ADDREF(*result = mPipeIn);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-    return rv;</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-}</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-nsInputStreamTransport2::OpenOutputStream(uint32_t flags,</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-                                          uint32_t segsize,</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-                                          uint32_t segcount,</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-                                          nsIOutputStream **result)</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-{</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-    // this transport only supports reading!</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-    NS_NOTREACHED(&quot;nsInputStreamTransport2::OpenOutputStream&quot;);</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-}</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-nsInputStreamTransport2::Close(nsresult reason)</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-{</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-    if (NS_SUCCEEDED(reason))</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-        reason = NS_BASE_STREAM_CLOSED;</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-    return mPipeIn-&gt;CloseWithStatus(reason);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-}</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-nsInputStreamTransport2::SetEventSink(nsITransportEventSink *sink,</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-                                      nsIEventTarget *target)</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-{</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-    NS_ENSURE_TRUE(!mInProgress, NS_ERROR_IN_PROGRESS);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-    if (target)</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-        return net_NewTransportEventSinkProxy(getter_AddRefs(mEventSink),</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-                                              sink, target);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-    mEventSink = sink;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-}</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-/** nsIInputStream **/</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-nsInputStreamTransport2::Close()</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-{</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-    if (mCloseWhenDone)</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-        mSource-&gt;Close();</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-    // make additional reads return early...</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    mOffset = mLimit = 0;</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-}</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-nsInputStreamTransport2::Available(uint64_t *result)</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-{</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-}</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-nsInputStreamTransport2::Read(char *buf, uint32_t count, uint32_t *result)</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-{</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-    if (mFirstTime) {</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-        mFirstTime = false;</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-        if (mOffset != 0) {</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-            // read from current position if offset equal to max</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-            if (mOffset != -1) {</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-                nsCOMPtr&lt;nsISeekableStream&gt; seekable = do_QueryInterface(mSource);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-                if (seekable)</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-                    seekable-&gt;Seek(nsISeekableStream::NS_SEEK_SET, mOffset);</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-            }</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-            // reset offset to zero so we can use it to enforce limit</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-            mOffset = 0;</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-        }</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-    }</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-    // limit amount read</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-    uint64_t max = count;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-    if (mLimit != -1) {</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-        max = mLimit - mOffset;</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-        if (max == 0) {</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-            *result = 0;</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-            return NS_OK;</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-        }</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-    }</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-    if (count &gt; max)</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-        count = static_cast&lt;uint32_t&gt;(max);</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-    nsresult rv = mSource-&gt;Read(buf, count, result);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-        mOffset += *result;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-        if (mEventSink)</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-            mEventSink-&gt;OnTransportStatus(this, NS_NET_STATUS_READING, mOffset,</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-                                          mLimit);</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-    }</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-    return rv;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-}</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-nsInputStreamTransport2::ReadSegments(nsWriteSegmentFun writer, void *closure,</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-                                      uint32_t count, uint32_t *result)</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-{</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-}</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-nsInputStreamTransport2::IsNonBlocking(bool *result)</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-{</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-    *result = false;</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-}</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-//-----------------------------------------------------------------------------</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-// nsOutputStreamTransport2</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-//</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-// Implements nsIOutputStream as a wrapper around the real input stream.  This</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-// allows the transport to support seeking, range-limiting, progress reporting,</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-// and close-when-done semantics while utilizing NS_AsyncCopy.</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-//-----------------------------------------------------------------------------</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-class nsOutputStreamTransport2 : public nsITransport</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-                               , public nsIOutputStream</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-{</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-public:</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-    NS_DECL_NSITRANSPORT</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-    NS_DECL_NSIOUTPUTSTREAM</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-    nsOutputStreamTransport2(nsIOutputStream *sink,</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-                             int64_t offset,</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-                             int64_t limit,</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-                             bool closeWhenDone)</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-        : mSink(sink)</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-        , mOffset(offset)</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-        , mLimit(limit)</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-        , mCloseWhenDone(closeWhenDone)</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-        , mFirstTime(true)</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-        , mInProgress(false)</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-    {</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-    }</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineminus">-</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-private:</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-    virtual ~nsOutputStreamTransport2()</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-    {</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-    }</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-    nsCOMPtr&lt;nsIAsyncOutputStream&gt;  mPipeOut;</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-    // while the copy is active, these members may only be accessed from the</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-    // nsIOutputStream implementation.</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-    nsCOMPtr&lt;nsITransportEventSink&gt; mEventSink;</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-    nsCOMPtr&lt;nsIOutputStream&gt;       mSink;</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-    int64_t                         mOffset;</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-    int64_t                         mLimit;</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-    bool                            mCloseWhenDone;</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-    bool                            mFirstTime;</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-    // this variable serves as a lock to prevent the state of the transport</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-    // from being modified once the copy is in progress.</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-    bool                            mInProgress;</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-};</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-NS_IMPL_ISUPPORTS(nsOutputStreamTransport2,</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-                  nsITransport,</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-                  nsIOutputStream)</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-/** nsITransport **/</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-nsOutputStreamTransport2::OpenInputStream(uint32_t flags,</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-                                          uint32_t segsize,</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-                                          uint32_t segcount,</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-                                          nsIInputStream **result)</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-{</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-    // this transport only supports writing!</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-    NS_NOTREACHED(&quot;nsOutputStreamTransport2::OpenInputStream&quot;);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-}</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-nsOutputStreamTransport2::OpenOutputStream(uint32_t flags,</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-                                           uint32_t segsize,</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-                                           uint32_t segcount,</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-                                           nsIOutputStream **result)</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-{</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-    NS_ENSURE_TRUE(!mInProgress, NS_ERROR_IN_PROGRESS);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-    nsresult rv;</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-    nsCOMPtr&lt;nsIEventTarget&gt; target =</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-            do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-    // XXX if the caller requests an unbuffered stream, then perhaps</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-    //     we'd want to simply return mSink; however, then we would</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-    //     not be writing to mSink on a background thread.  is this ok?</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-    bool nonblocking = !(flags &amp; OPEN_BLOCKING);</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-    net_ResolveSegmentParams(segsize, segcount);</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-    nsCOMPtr&lt;nsIAsyncInputStream&gt; pipeIn;</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-    rv = NS_NewPipe2(getter_AddRefs(pipeIn),</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-                     getter_AddRefs(mPipeOut),</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-                     true, nonblocking,</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-                     segsize, segcount);</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-    mInProgress = true;</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-    // startup async copy process...</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-    rv = NS_AsyncCopy(pipeIn, this, target,</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-                      NS_ASYNCCOPY_VIA_READSEGMENTS, segsize);</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-        NS_ADDREF(*result = mPipeOut);</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-    return rv;</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-}</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-nsOutputStreamTransport2::Close(nsresult reason)</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-{</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-    if (NS_SUCCEEDED(reason))</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-        reason = NS_BASE_STREAM_CLOSED;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-    return mPipeOut-&gt;CloseWithStatus(reason);</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-}</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-nsOutputStreamTransport2::SetEventSink(nsITransportEventSink *sink,</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-                                       nsIEventTarget *target)</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-{</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-    NS_ENSURE_TRUE(!mInProgress, NS_ERROR_IN_PROGRESS);</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-    if (target)</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-        return net_NewTransportEventSinkProxy(getter_AddRefs(mEventSink),</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-                                              sink, target);</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-    mEventSink = sink;</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-}</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-/** nsIOutputStream **/</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-nsOutputStreamTransport2::Close()</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-{</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-    if (mCloseWhenDone)</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-        mSink-&gt;Close();</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-    // make additional writes return early...</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-    mOffset = mLimit = 0;</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-}</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-nsOutputStreamTransport2::Flush()</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-{</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-}</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-nsOutputStreamTransport2::Write(const char *buf, uint32_t count, uint32_t *result)</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-{</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-    if (mFirstTime) {</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-        mFirstTime = false;</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-        if (mOffset != 0) {</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">-            // write to current position if offset equal to max</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">-            if (mOffset != -1) {</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-                nsCOMPtr&lt;nsISeekableStream&gt; seekable = do_QueryInterface(mSink);</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-                if (seekable)</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineminus">-                    seekable-&gt;Seek(nsISeekableStream::NS_SEEK_SET, mOffset);</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineminus">-            }</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineminus">-            // reset offset to zero so we can use it to enforce limit</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-            mOffset = 0;</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-        }</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-    }</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-    // limit amount written</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-    uint64_t max = count;</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineminus">-    if (mLimit != -1) {</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-        max = mLimit - mOffset;</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-        if (max == 0) {</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-            *result = 0;</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-            return NS_OK;</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-        }</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineminus">-    }</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-    if (count &gt; max)</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-        count = static_cast&lt;uint32_t&gt;(max);</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-    nsresult rv = mSink-&gt;Write(buf, count, result);</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-        mOffset += *result;</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineminus">-        if (mEventSink)</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineminus">-            mEventSink-&gt;OnTransportStatus(this, NS_NET_STATUS_WRITING, mOffset,</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">-                                          mLimit);</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineminus">-    }</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">-    return rv;</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineminus">-}</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-nsOutputStreamTransport2::WriteSegments(nsReadSegmentFun reader, void *closure,</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-                                        uint32_t count, uint32_t *result)</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-{</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-}</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineminus">-nsOutputStreamTransport2::WriteFrom(nsIInputStream *in, uint32_t count, uint32_t *result)</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-{</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-}</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-nsOutputStreamTransport2::IsNonBlocking(bool *result)</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-{</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-    *result = false;</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-}</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-//-----------------------------------------------------------------------------</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-// nsStreamTransportService2</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">-//-----------------------------------------------------------------------------</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">-</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">-nsStreamTransportService2::~nsStreamTransportService2()</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-{</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-    NS_ASSERTION(!mPool, &quot;thread pool wasn't shutdown&quot;);</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-}</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-nsresult</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-nsStreamTransportService2::Init()</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-{</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-    mPool = do_CreateInstance(NS_THREADPOOL_CONTRACTID);</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-    NS_ENSURE_STATE(mPool);</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineminus">-</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineminus">-    // Configure the pool</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-    mPool-&gt;SetName(NS_LITERAL_CSTRING(&quot;StreamTrans&quot;));</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-    mPool-&gt;SetThreadLimit(25);</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-    mPool-&gt;SetIdleThreadLimit(1);</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-    mPool-&gt;SetIdleThreadTimeout(PR_SecondsToInterval(30));</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; obsSvc =</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-        mozilla::services::GetObserverService();</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-    if (obsSvc)</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-        obsSvc-&gt;AddObserver(this, &quot;xpcom-shutdown-threads&quot;, false);</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">-}</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-NS_IMPL_ISUPPORTS(nsStreamTransportService2,</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-                  nsIStreamTransportService2,</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-                  nsIEventTarget,</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-                  nsIObserver)</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineminus">-</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineminus">-nsStreamTransportService2::DispatchFromScript(nsIRunnable *task, uint32_t flags)</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-{</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-  nsCOMPtr&lt;nsIRunnable&gt; event(task);</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-  return Dispatch(event.forget(), flags);</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-}</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-nsStreamTransportService2::Dispatch(already_AddRefed&lt;nsIRunnable&gt; task, uint32_t flags)</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-{</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-    nsCOMPtr&lt;nsIRunnable&gt; event(task); // so it gets released on failure paths</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-    nsCOMPtr&lt;nsIThreadPool&gt; pool;</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-    {</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-        mozilla::MutexAutoLock lock(mShutdownLock);</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-        if (mIsShutdown) {</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-            return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-        }</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-        pool = mPool;</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-    }</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-    NS_ENSURE_TRUE(pool, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-    return pool-&gt;Dispatch(event.forget(), flags);</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-}</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-nsStreamTransportService2::DelayedDispatch(already_AddRefed&lt;nsIRunnable&gt;, uint32_t)</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-{</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-}</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineminus">-</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineminus">-NS_IMETHODIMP_(bool)</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-nsStreamTransportService2::IsOnCurrentThreadInfallible()</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineminus">-{</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-    nsCOMPtr&lt;nsIThreadPool&gt; pool;</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-    {</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-        mozilla::MutexAutoLock lock(mShutdownLock);</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-        pool = mPool;</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineminus">-    }</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-    if (!pool) {</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-      return false;</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineminus">-    }</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-    return pool-&gt;IsOnCurrentThread();</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-}</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineminus">-</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineminus">-nsStreamTransportService2::IsOnCurrentThread(bool *result)</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-{</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineminus">-    nsCOMPtr&lt;nsIThreadPool&gt; pool;</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-    {</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-        mozilla::MutexAutoLock lock(mShutdownLock);</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-        if (mIsShutdown) {</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-            return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-        }</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-        pool = mPool;</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-    }</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-    NS_ENSURE_TRUE(pool, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineminus">-    return pool-&gt;IsOnCurrentThread(result);</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-}</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-nsStreamTransportService2::CreateInputTransport(nsIInputStream *stream,</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">-                                                int64_t offset,</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-                                                int64_t limit,</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineminus">-                                                bool closeWhenDone,</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineminus">-                                                nsITransport **result)</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineminus">-{</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-    nsInputStreamTransport2 *trans =</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-        new nsInputStreamTransport2(stream, offset, limit, closeWhenDone);</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-    if (!trans)</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-    NS_ADDREF(*result = trans);</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-}</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineminus">-nsStreamTransportService2::Observe(nsISupports *subject, const char *topic,</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineminus">-                                   const char16_t *data)</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineminus">-{</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineminus">-  NS_ASSERTION(strcmp(topic, &quot;xpcom-shutdown-threads&quot;) == 0, &quot;oops&quot;);</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineminus">-</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-  {</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-    mozilla::MutexAutoLock lock(mShutdownLock);</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineminus">-    mIsShutdown = true;</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineminus">-  }</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineminus">-</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-  if (mPool) {</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-    mPool-&gt;Shutdown();</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-    mPool = nullptr;</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineminus">-  }</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-  return NS_OK;</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineminus">-}</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineminus">-</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineminus">-} // namespace net</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/mailnews/base/util/nsStreamTransportService2.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,47 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-#ifndef nsStreamTransportService2_h__</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-#define nsStreamTransportService2_h__</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;nsIStreamTransportService2.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-#include &quot;nsIEventTarget.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-#include &quot;nsIObserver.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-#include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-class nsIThreadPool;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-namespace mozilla {</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-namespace net {</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-class nsStreamTransportService2 final : public nsIStreamTransportService2</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-                                      , public nsIEventTarget</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-                                      , public nsIObserver</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-{</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-public:</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    NS_DECL_NSISTREAMTRANSPORTSERVICE2</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-    NS_DECL_NSIEVENTTARGET_FULL</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-    NS_DECL_NSIOBSERVER</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-    nsresult Init();</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-    nsStreamTransportService2() : mShutdownLock(&quot;nsStreamTransportService2.mShutdownLock&quot;),</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-                                 mIsShutdown(false) {}</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-private:</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    ~nsStreamTransportService2();</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    nsCOMPtr&lt;nsIThreadPool&gt; mPool;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-    mozilla::Mutex mShutdownLock;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-    bool mIsShutdown;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-};</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-} // namespace net</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-} // namespace mozilla</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -92,19 +92,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsMsgContentPolicy.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsCidProtocolHandler.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsRssIncomingServer.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsRssService.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsMsgBrkMBoxStore.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsMsgMaildirStore.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsMsgTagService.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsMsgFolderNotificationService.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &quot;nsIThreadPool.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-#include &quot;nsStreamTransportService2.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-typedef mozilla::net::nsStreamTransportService2 nsStreamTransportService2;</span>
<a href="#l10.15"></a><span id="l10.15"> #include &quot;nsMailDirProvider.h&quot;</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> #ifdef XP_WIN</span>
<a href="#l10.18"></a><span id="l10.18"> #include &quot;nsMessengerWinIntegration.h&quot;</span>
<a href="#l10.19"></a><span id="l10.19"> #endif</span>
<a href="#l10.20"></a><span id="l10.20"> #ifdef XP_MACOSX</span>
<a href="#l10.21"></a><span id="l10.21"> #include &quot;nsMessengerOSXIntegration.h&quot;</span>
<a href="#l10.22"></a><span id="l10.22"> #endif</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -365,17 +362,16 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgSear</span>
<a href="#l10.24"></a><span id="l10.24"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgXFVirtualFolderDBView)</span>
<a href="#l10.25"></a><span id="l10.25"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgQuickSearchDBView)</span>
<a href="#l10.26"></a><span id="l10.26"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgGroupView)</span>
<a href="#l10.27"></a><span id="l10.27"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgOfflineManager)</span>
<a href="#l10.28"></a><span id="l10.28"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgProgress)</span>
<a href="#l10.29"></a><span id="l10.29"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsSpamSettings)</span>
<a href="#l10.30"></a><span id="l10.30"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgTagService)</span>
<a href="#l10.31"></a><span id="l10.31"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgFolderNotificationService)</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsStreamTransportService2, Init)</span>
<a href="#l10.33"></a><span id="l10.33"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsCidProtocolHandler)</span>
<a href="#l10.34"></a><span id="l10.34"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMailDirProvider)</span>
<a href="#l10.35"></a><span id="l10.35"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgShutdownService)</span>
<a href="#l10.36"></a><span id="l10.36"> #ifdef XP_WIN</span>
<a href="#l10.37"></a><span id="l10.37"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMessengerWinIntegration, Init)</span>
<a href="#l10.38"></a><span id="l10.38"> #endif</span>
<a href="#l10.39"></a><span id="l10.39"> #ifdef XP_MACOSX</span>
<a href="#l10.40"></a><span id="l10.40"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMessengerOSXIntegration, Init)</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineat">@@ -429,17 +425,16 @@ NS_DEFINE_NAMED_CID(NS_MSGQUICKSEARCHDBV</span>
<a href="#l10.42"></a><span id="l10.42"> NS_DEFINE_NAMED_CID(NS_MSG_XFVFDBVIEW_CID);</span>
<a href="#l10.43"></a><span id="l10.43"> NS_DEFINE_NAMED_CID(NS_MSG_GROUPDBVIEW_CID);</span>
<a href="#l10.44"></a><span id="l10.44"> NS_DEFINE_NAMED_CID(NS_MSGOFFLINEMANAGER_CID);</span>
<a href="#l10.45"></a><span id="l10.45"> NS_DEFINE_NAMED_CID(NS_MSGPROGRESS_CID);</span>
<a href="#l10.46"></a><span id="l10.46"> NS_DEFINE_NAMED_CID(NS_SPAMSETTINGS_CID);</span>
<a href="#l10.47"></a><span id="l10.47"> NS_DEFINE_NAMED_CID(NS_CIDPROTOCOL_CID);</span>
<a href="#l10.48"></a><span id="l10.48"> NS_DEFINE_NAMED_CID(NS_MSGTAGSERVICE_CID);</span>
<a href="#l10.49"></a><span id="l10.49"> NS_DEFINE_NAMED_CID(NS_MSGNOTIFICATIONSERVICE_CID);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_STREAMTRANSPORTSERVICE2_CID);</span>
<a href="#l10.51"></a><span id="l10.51"> #ifdef XP_WIN</span>
<a href="#l10.52"></a><span id="l10.52"> NS_DEFINE_NAMED_CID(NS_MESSENGERWININTEGRATION_CID);</span>
<a href="#l10.53"></a><span id="l10.53"> #endif</span>
<a href="#l10.54"></a><span id="l10.54"> #ifdef XP_MACOSX</span>
<a href="#l10.55"></a><span id="l10.55"> NS_DEFINE_NAMED_CID(NS_MESSENGEROSXINTEGRATION_CID);</span>
<a href="#l10.56"></a><span id="l10.56"> #endif</span>
<a href="#l10.57"></a><span id="l10.57"> #if defined(MOZ_WIDGET_GTK) || defined(MOZ_WIDGET_GTK2)</span>
<a href="#l10.58"></a><span id="l10.58"> NS_DEFINE_NAMED_CID(NS_MESSENGERUNIXINTEGRATION_CID);</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineat">@@ -902,17 +897,16 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l10.60"></a><span id="l10.60">   { &amp;kNS_MSG_XFVFDBVIEW_CID, false, NULL, nsMsgXFVirtualFolderDBViewConstructor},</span>
<a href="#l10.61"></a><span id="l10.61">   { &amp;kNS_MSG_GROUPDBVIEW_CID, false, NULL, nsMsgGroupViewConstructor},</span>
<a href="#l10.62"></a><span id="l10.62">   { &amp;kNS_MSGOFFLINEMANAGER_CID, false, NULL, nsMsgOfflineManagerConstructor},</span>
<a href="#l10.63"></a><span id="l10.63">   { &amp;kNS_MSGPROGRESS_CID, false, NULL, nsMsgProgressConstructor},</span>
<a href="#l10.64"></a><span id="l10.64">   { &amp;kNS_SPAMSETTINGS_CID, false, NULL, nsSpamSettingsConstructor},</span>
<a href="#l10.65"></a><span id="l10.65">   { &amp;kNS_CIDPROTOCOL_CID, false, NULL, nsCidProtocolHandlerConstructor},</span>
<a href="#l10.66"></a><span id="l10.66">   { &amp;kNS_MSGTAGSERVICE_CID, false, NULL, nsMsgTagServiceConstructor},</span>
<a href="#l10.67"></a><span id="l10.67">   { &amp;kNS_MSGNOTIFICATIONSERVICE_CID, false, NULL, nsMsgFolderNotificationServiceConstructor},</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  { &amp;kNS_STREAMTRANSPORTSERVICE2_CID, false, NULL, nsStreamTransportService2Constructor},</span>
<a href="#l10.69"></a><span id="l10.69"> #ifdef XP_WIN</span>
<a href="#l10.70"></a><span id="l10.70">   { &amp;kNS_MESSENGERWININTEGRATION_CID, false, NULL, nsMessengerWinIntegrationConstructor},</span>
<a href="#l10.71"></a><span id="l10.71"> #endif</span>
<a href="#l10.72"></a><span id="l10.72"> #ifdef XP_MACOSX</span>
<a href="#l10.73"></a><span id="l10.73">   { &amp;kNS_MESSENGEROSXINTEGRATION_CID, false, NULL, nsMessengerOSXIntegrationConstructor},</span>
<a href="#l10.74"></a><span id="l10.74"> #endif</span>
<a href="#l10.75"></a><span id="l10.75"> #if defined(MOZ_WIDGET_GTK) || defined(MOZ_WIDGET_GTK2)</span>
<a href="#l10.76"></a><span id="l10.76">   { &amp;kNS_MESSENGERUNIXINTEGRATION_CID, false, NULL, nsMessengerUnixIntegrationConstructor},</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineat">@@ -1117,17 +1111,16 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l10.78"></a><span id="l10.78">   { NS_MSGXFVFDBVIEW_CONTRACTID, &amp;kNS_MSG_XFVFDBVIEW_CID },</span>
<a href="#l10.79"></a><span id="l10.79">   { NS_MSGGROUPDBVIEW_CONTRACTID, &amp;kNS_MSG_GROUPDBVIEW_CID },</span>
<a href="#l10.80"></a><span id="l10.80">   { NS_MSGOFFLINEMANAGER_CONTRACTID, &amp;kNS_MSGOFFLINEMANAGER_CID },</span>
<a href="#l10.81"></a><span id="l10.81">   { NS_MSGPROGRESS_CONTRACTID, &amp;kNS_MSGPROGRESS_CID },</span>
<a href="#l10.82"></a><span id="l10.82">   { NS_SPAMSETTINGS_CONTRACTID, &amp;kNS_SPAMSETTINGS_CID },</span>
<a href="#l10.83"></a><span id="l10.83">   { NS_CIDPROTOCOLHANDLER_CONTRACTID, &amp;kNS_CIDPROTOCOL_CID },</span>
<a href="#l10.84"></a><span id="l10.84">   { NS_MSGTAGSERVICE_CONTRACTID, &amp;kNS_MSGTAGSERVICE_CID },</span>
<a href="#l10.85"></a><span id="l10.85">   { NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;kNS_MSGNOTIFICATIONSERVICE_CID },</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-  { NS_STREAMTRANSPORTSERVICE2_CONTRACTID, &amp;kNS_STREAMTRANSPORTSERVICE2_CID },</span>
<a href="#l10.87"></a><span id="l10.87"> #ifdef XP_WIN</span>
<a href="#l10.88"></a><span id="l10.88">   { NS_MESSENGEROSINTEGRATION_CONTRACTID, &amp;kNS_MESSENGERWININTEGRATION_CID },</span>
<a href="#l10.89"></a><span id="l10.89"> #endif</span>
<a href="#l10.90"></a><span id="l10.90"> #ifdef XP_MACOSX</span>
<a href="#l10.91"></a><span id="l10.91">   { NS_MESSENGEROSINTEGRATION_CONTRACTID, &amp;kNS_MESSENGEROSXINTEGRATION_CID },</span>
<a href="#l10.92"></a><span id="l10.92"> #endif</span>
<a href="#l10.93"></a><span id="l10.93"> #if defined(MOZ_WIDGET_GTK) || defined(MOZ_WIDGET_GTK2)</span>
<a href="#l10.94"></a><span id="l10.94">   { NS_MESSENGEROSINTEGRATION_CONTRACTID, &amp;kNS_MESSENGERUNIXINTEGRATION_CID },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -7,31 +7,30 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsMailboxProtocol.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nscore.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIInputStreamPump.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;prtime.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> #include &quot;prerror.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;prprf.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> #include &quot;nspr.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> static mozilla::LazyLogModule MAILBOX(&quot;MAILBOX&quot;);</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-#include &quot;nsIStreamTransportService2.h&quot;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+#include &quot;nsIStreamTransportService.h&quot;</span>
<a href="#l11.28"></a><span id="l11.28"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l11.29"></a><span id="l11.29"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l11.30"></a><span id="l11.30"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l11.31"></a><span id="l11.31"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l11.32"></a><span id="l11.32"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l11.33"></a><span id="l11.33"> #include &quot;nsIMimeHeaders.h&quot;</span>
<a href="#l11.34"></a><span id="l11.34"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l11.35"></a><span id="l11.35"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineat">@@ -60,18 +59,18 @@ nsMailboxProtocol::~nsMailboxProtocol()</span>
<a href="#l11.37"></a><span id="l11.37">   // free our local state</span>
<a href="#l11.38"></a><span id="l11.38">   delete m_lineStreamBuffer;</span>
<a href="#l11.39"></a><span id="l11.39"> }</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41"> nsresult nsMailboxProtocol::OpenMultipleMsgTransport(uint64_t offset, int32_t size)</span>
<a href="#l11.42"></a><span id="l11.42"> {</span>
<a href="#l11.43"></a><span id="l11.43">   nsresult rv;</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-  nsCOMPtr&lt;nsIStreamTransportService2&gt; serv =</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-      do_GetService(NS_STREAMTRANSPORTSERVICE2_CONTRACTID, &amp;rv);</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+  nsCOMPtr&lt;nsIStreamTransportService&gt; serv =</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+      do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.49"></a><span id="l11.49">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">   // XXX 64-bit</span>
<a href="#l11.52"></a><span id="l11.52">   rv = serv-&gt;CreateInputTransport(m_multipleMsgMoveCopyStream, int64_t(offset),</span>
<a href="#l11.53"></a><span id="l11.53">                                   int64_t(size), false,</span>
<a href="#l11.54"></a><span id="l11.54">                                   getter_AddRefs(m_transport));</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56">   return rv;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineat">@@ -145,18 +144,18 @@ nsresult nsMailboxProtocol::Initialize(n</span>
<a href="#l11.58"></a><span id="l11.58">               bool reusable = false;</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">               rv = folder-&gt;GetMsgInputStream(msgHdr, &amp;reusable, getter_AddRefs(stream));</span>
<a href="#l11.61"></a><span id="l11.61">               NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.62"></a><span id="l11.62">               nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(stream, &amp;rv));</span>
<a href="#l11.63"></a><span id="l11.63">               NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.64"></a><span id="l11.64">               seekableStream-&gt;Tell(&amp;offset);</span>
<a href="#l11.65"></a><span id="l11.65">               // create input stream transport</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-              nsCOMPtr&lt;nsIStreamTransportService2&gt; sts =</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-                  do_GetService(NS_STREAMTRANSPORTSERVICE2_CONTRACTID, &amp;rv);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+              nsCOMPtr&lt;nsIStreamTransportService&gt; sts =</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+                  do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.70"></a><span id="l11.70">               if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.71"></a><span id="l11.71">               m_readCount = aMsgSize;</span>
<a href="#l11.72"></a><span id="l11.72">               // Save the stream for reuse, but only for multiple URLs.</span>
<a href="#l11.73"></a><span id="l11.73">               if (reusable &amp;&amp; RunningMultipleMsgUrl())</span>
<a href="#l11.74"></a><span id="l11.74">                 m_multipleMsgMoveCopyStream = stream;</span>
<a href="#l11.75"></a><span id="l11.75">               else</span>
<a href="#l11.76"></a><span id="l11.76">                 reusable = false;</span>
<a href="#l11.77"></a><span id="l11.77">               rv = sts-&gt;CreateInputTransport(stream, offset,</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineat">@@ -303,18 +302,18 @@ NS_IMETHODIMP nsMailboxProtocol::OnStopR</span>
<a href="#l11.79"></a><span id="l11.79">                   bool reusable = false;</span>
<a href="#l11.80"></a><span id="l11.80">                   rv = msgFolder-&gt;GetMsgInputStream(nextMsg, &amp;reusable,</span>
<a href="#l11.81"></a><span id="l11.81">                                                     getter_AddRefs(stream));</span>
<a href="#l11.82"></a><span id="l11.82">                   NS_ASSERTION(!reusable, &quot;We thought streams were not reusable!&quot;);</span>
<a href="#l11.83"></a><span id="l11.83"> </span>
<a href="#l11.84"></a><span id="l11.84">                   if (NS_SUCCEEDED(rv))</span>
<a href="#l11.85"></a><span id="l11.85">                   {</span>
<a href="#l11.86"></a><span id="l11.86">                     // create input stream transport</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-                    nsCOMPtr&lt;nsIStreamTransportService2&gt; sts =</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-                        do_GetService(NS_STREAMTRANSPORTSERVICE2_CONTRACTID, &amp;rv);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+                    nsCOMPtr&lt;nsIStreamTransportService&gt; sts =</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+                        do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92">                     if (NS_SUCCEEDED(rv))</span>
<a href="#l11.93"></a><span id="l11.93">                     {</span>
<a href="#l11.94"></a><span id="l11.94">                       m_readCount = msgSize;</span>
<a href="#l11.95"></a><span id="l11.95">                       rv = sts-&gt;CreateInputTransport(stream, msgOffset,</span>
<a href="#l11.96"></a><span id="l11.96">                                                      int64_t(msgSize), true,</span>
<a href="#l11.97"></a><span id="l11.97">                                                      getter_AddRefs(m_transport));</span>
<a href="#l11.98"></a><span id="l11.98">                     }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

