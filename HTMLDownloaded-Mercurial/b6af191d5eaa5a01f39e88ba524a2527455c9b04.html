<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23411:b6af191d5eaa5a01f39e88ba524a2527455c9b04</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b6af191d5eaa5a01f39e88ba524a2527455c9b04" />
<meta property="og:url" content="/comm-central/rev/b6af191d5eaa5a01f39e88ba524a2527455c9b04" />
<meta property="og:description" content="Bug 1440693 - Port 1434163 to C-C: nsIURI attributes are read-only now. r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b6af191d5eaa5a01f39e88ba524a2527455c9b04 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b6af191d5eaa5a01f39e88ba524a2527455c9b04">shortlog</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b6af191d5eaa5a01f39e88ba524a2527455c9b04">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04">files</a> |
changeset |
<a href="/comm-central/raw-rev/b6af191d5eaa5a01f39e88ba524a2527455c9b04">raw</a>  | <a href="/comm-central/archive/b6af191d5eaa5a01f39e88ba524a2527455c9b04.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1440693">Bug 1440693</a> - Port 1434163 to C-C: nsIURI attributes are read-only now. r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 04 Mar 2018 12:12:07 +0100</td></tr>

<tr>
 <td>changeset 23411</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b6af191d5eaa5a01f39e88ba524a2527455c9b04">b6af191d5eaa5a01f39e88ba524a2527455c9b04</a></td>
</tr>



<tr>
<td>parent 23410</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/20758564d6cb90003a142f83df23e2697ca16b45">20758564d6cb90003a142f83df23e2697ca16b45</a>
</td>
</tr>

<tr>
<td>child 23412</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/43ead9ebb0357799820da297c73f7bf94c15c25b">43ead9ebb0357799820da297c73f7bf94c15c25b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b6af191d5eaa5a01f39e88ba524a2527455c9b04">14148</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 04 Mar 2018 11:22:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b6af191d5eaa [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b6af191d5eaa5a01f39e88ba524a2527455c9b04">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b6af191d5eaa5a01f39e88ba524a2527455c9b04&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b6af191d5eaa5a01f39e88ba524a2527455c9b04&newProject=comm-central&newRevision=b6af191d5eaa5a01f39e88ba524a2527455c9b04&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b6af191d5eaa5a01f39e88ba524a2527455c9b04&newProject=comm-central&newRevision=b6af191d5eaa5a01f39e88ba524a2527455c9b04&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b6af191d5eaa5a01f39e88ba524a2527455c9b04&newProject=comm-central&newRevision=b6af191d5eaa5a01f39e88ba524a2527455c9b04&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1440693">1440693</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1434163">1434163</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1440693">Bug 1440693</a> - Port 1434163 to C-C: nsIURI attributes are read-only now. r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.cpp">ldap/xpcom/src/nsLDAPURL.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.h">ldap/xpcom/src/nsLDAPURL.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.h">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.h">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.h">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.h">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/ldap/xpcom/src/nsLDAPURL.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.cpp">mailnews/addrbook/src/nsAddbookUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.h">mailnews/addrbook/src/nsAddbookUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.h">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.h">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.h">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.h">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/addrbook/src/nsAddbookUrl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/public/nsIMsgMailNewsUrl.idl">mailnews/base/public/nsIMsgMailNewsUrl.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/public/nsIMsgMailNewsUrl.idl">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/public/nsIMsgMailNewsUrl.idl">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/public/nsIMsgMailNewsUrl.idl">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/public/nsIMsgMailNewsUrl.idl">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/public/nsIMsgMailNewsUrl.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/src/nsMessengerContentHandler.cpp">mailnews/base/src/nsMessengerContentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/src/nsMessengerContentHandler.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/src/nsMessengerContentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/src/nsMessengerContentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/src/nsMessengerContentHandler.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/src/nsMessengerContentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.cpp">mailnews/base/util/nsMsgMailNewsUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.h">mailnews/base/util/nsMsgMailNewsUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.h">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.h">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.h">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.h">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgMailNewsUrl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgQuote.cpp">mailnews/compose/src/nsMsgQuote.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgQuote.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgQuote.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgQuote.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgQuote.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgQuote.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.cpp">mailnews/compose/src/nsSmtpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.h">mailnews/compose/src/nsSmtpUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.h">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.h">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.h">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.h">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/compose/src/nsSmtpUrl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/public/nsIImapService.idl">mailnews/imap/public/nsIImapService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/public/nsIImapService.idl">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/public/nsIImapService.idl">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/public/nsIImapService.idl">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/public/nsIImapService.idl">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/public/nsIImapService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapUrl.h">mailnews/imap/src/nsImapUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapUrl.h">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapUrl.h">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapUrl.h">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapUrl.h">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/imap/src/nsImapUrl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalUtils.cpp">mailnews/local/src/nsLocalUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalUtils.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalUtils.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalUtils.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalUtils.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsLocalUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsMailboxService.cpp">mailnews/local/src/nsMailboxService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsMailboxService.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsMailboxService.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsMailboxService.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsMailboxService.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsMailboxService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsPop3Service.cpp">mailnews/local/src/nsPop3Service.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsPop3Service.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsPop3Service.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsPop3Service.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsPop3Service.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/local/src/nsPop3Service.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNntpService.cpp">mailnews/news/src/nsNntpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNntpService.cpp">file</a> |
<a href="/comm-central/annotate/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNntpService.cpp">annotate</a> |
<a href="/comm-central/diff/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNntpService.cpp">diff</a> |
<a href="/comm-central/comparison/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNntpService.cpp">comparison</a> |
<a href="/comm-central/log/b6af191d5eaa5a01f39e88ba524a2527455c9b04/mailnews/news/src/nsNntpService.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPURL.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPURL.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -138,34 +138,35 @@ NS_IMETHODIMP</span>
<a href="#l1.4"></a><span id="l1.4"> nsLDAPURL::GetSpec(nsACString &amp;_retval)</span>
<a href="#l1.5"></a><span id="l1.5"> {</span>
<a href="#l1.6"></a><span id="l1.6">   if (!mBaseURL)</span>
<a href="#l1.7"></a><span id="l1.7">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">   return mBaseURL-&gt;GetSpec(_retval);</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-nsresult</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-nsLDAPURL::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+nsresult nsLDAPURL::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l1.15"></a><span id="l1.15"> {</span>
<a href="#l1.16"></a><span id="l1.16">   if (!mBaseURL)</span>
<a href="#l1.17"></a><span id="l1.17">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">   // Cache the original spec in case we don't like what we've been passed and</span>
<a href="#l1.20"></a><span id="l1.20">   // need to reset ourselves.</span>
<a href="#l1.21"></a><span id="l1.21">   nsCString originalSpec;</span>
<a href="#l1.22"></a><span id="l1.22">   nsresult rv = mBaseURL-&gt;GetSpec(originalSpec);</span>
<a href="#l1.23"></a><span id="l1.23">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  rv = mBaseURL-&gt;SetSpecInternal(aSpec);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  rv = NS_MutateURI(mBaseURL).SetSpec(aSpec).Finalize(mBaseURL);</span>
<a href="#l1.27"></a><span id="l1.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">   rv = SetPathInternal(PromiseFlatCString(aSpec));</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    mBaseURL-&gt;SetSpecInternal(originalSpec);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    nsresult rv2 = NS_MutateURI(mBaseURL).SetSpec(originalSpec).Finalize(mBaseURL);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    NS_ENSURE_SUCCESS(rv2, rv2);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  }</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">   return rv;</span>
<a href="#l1.38"></a><span id="l1.38"> }</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40"> NS_IMETHODIMP nsLDAPURL::GetPrePath(nsACString &amp;_retval)</span>
<a href="#l1.41"></a><span id="l1.41"> {</span>
<a href="#l1.42"></a><span id="l1.42">   if (!mBaseURL)</span>
<a href="#l1.43"></a><span id="l1.43">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineat">@@ -176,151 +177,136 @@ NS_IMETHODIMP nsLDAPURL::GetPrePath(nsAC</span>
<a href="#l1.45"></a><span id="l1.45"> NS_IMETHODIMP nsLDAPURL::GetScheme(nsACString &amp;_retval)</span>
<a href="#l1.46"></a><span id="l1.46"> {</span>
<a href="#l1.47"></a><span id="l1.47">   if (!mBaseURL)</span>
<a href="#l1.48"></a><span id="l1.48">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50">   return mBaseURL-&gt;GetScheme(_retval);</span>
<a href="#l1.51"></a><span id="l1.51"> }</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-NS_IMETHODIMP nsLDAPURL::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+nsresult nsLDAPURL::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l1.55"></a><span id="l1.55"> {</span>
<a href="#l1.56"></a><span id="l1.56">   if (!mBaseURL)</span>
<a href="#l1.57"></a><span id="l1.57">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">   if (aScheme.Equals(LDAP_SCHEME, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l1.60"></a><span id="l1.60">     mOptions &amp;= !OPT_SECURE;</span>
<a href="#l1.61"></a><span id="l1.61">   else if (aScheme.Equals(LDAP_SSL_SCHEME,</span>
<a href="#l1.62"></a><span id="l1.62">                           nsCaseInsensitiveCStringComparator()))</span>
<a href="#l1.63"></a><span id="l1.63">     mOptions |= OPT_SECURE;</span>
<a href="#l1.64"></a><span id="l1.64">   else</span>
<a href="#l1.65"></a><span id="l1.65">     return NS_ERROR_MALFORMED_URI;</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-  return mBaseURL-&gt;SetScheme(aScheme);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetScheme(aScheme).Finalize(mBaseURL);</span>
<a href="#l1.69"></a><span id="l1.69"> }</span>
<a href="#l1.70"></a><span id="l1.70"> </span>
<a href="#l1.71"></a><span id="l1.71"> NS_IMETHODIMP</span>
<a href="#l1.72"></a><span id="l1.72"> nsLDAPURL::GetUserPass(nsACString &amp;_retval)</span>
<a href="#l1.73"></a><span id="l1.73"> {</span>
<a href="#l1.74"></a><span id="l1.74">   _retval.Truncate();</span>
<a href="#l1.75"></a><span id="l1.75">   return NS_OK;</span>
<a href="#l1.76"></a><span id="l1.76"> }</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-nsLDAPURL::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+nsresult nsLDAPURL::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l1.81"></a><span id="l1.81"> {</span>
<a href="#l1.82"></a><span id="l1.82">   return NS_OK;</span>
<a href="#l1.83"></a><span id="l1.83"> }</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85"> NS_IMETHODIMP</span>
<a href="#l1.86"></a><span id="l1.86"> nsLDAPURL::GetUsername(nsACString &amp;_retval)</span>
<a href="#l1.87"></a><span id="l1.87"> {</span>
<a href="#l1.88"></a><span id="l1.88">   _retval.Truncate();</span>
<a href="#l1.89"></a><span id="l1.89">   return NS_OK;</span>
<a href="#l1.90"></a><span id="l1.90"> }</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-nsLDAPURL::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+nsresult nsLDAPURL::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l1.95"></a><span id="l1.95"> {</span>
<a href="#l1.96"></a><span id="l1.96">   return NS_OK;</span>
<a href="#l1.97"></a><span id="l1.97"> }</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99"> NS_IMETHODIMP</span>
<a href="#l1.100"></a><span id="l1.100"> nsLDAPURL::GetPassword(nsACString &amp;_retval)</span>
<a href="#l1.101"></a><span id="l1.101"> {</span>
<a href="#l1.102"></a><span id="l1.102">   _retval.Truncate();</span>
<a href="#l1.103"></a><span id="l1.103">   return NS_OK;</span>
<a href="#l1.104"></a><span id="l1.104"> }</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-nsLDAPURL::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+nsresult nsLDAPURL::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l1.109"></a><span id="l1.109"> {</span>
<a href="#l1.110"></a><span id="l1.110">   return NS_OK;</span>
<a href="#l1.111"></a><span id="l1.111"> }</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113"> NS_IMETHODIMP</span>
<a href="#l1.114"></a><span id="l1.114"> nsLDAPURL::GetHostPort(nsACString &amp;_retval)</span>
<a href="#l1.115"></a><span id="l1.115"> {</span>
<a href="#l1.116"></a><span id="l1.116">   if (!mBaseURL)</span>
<a href="#l1.117"></a><span id="l1.117">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.118"></a><span id="l1.118"> </span>
<a href="#l1.119"></a><span id="l1.119">   return mBaseURL-&gt;GetHostPort(_retval);</span>
<a href="#l1.120"></a><span id="l1.120"> }</span>
<a href="#l1.121"></a><span id="l1.121"> </span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-nsLDAPURL::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+nsresult nsLDAPURL::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l1.125"></a><span id="l1.125"> {</span>
<a href="#l1.126"></a><span id="l1.126">   if (!mBaseURL)</span>
<a href="#l1.127"></a><span id="l1.127">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-  return mBaseURL-&gt;SetHostPort(aHostPort);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-}</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-nsLDAPURL::SetHostAndPort(const nsACString &amp;aHostPort)</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-{</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-  if (!mBaseURL)</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-  return mBaseURL-&gt;SetHostAndPort(aHostPort);</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetHostPort(aHostPort).Finalize(mBaseURL);</span>
<a href="#l1.140"></a><span id="l1.140"> }</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142"> NS_IMETHODIMP</span>
<a href="#l1.143"></a><span id="l1.143"> nsLDAPURL::GetHost(nsACString &amp;_retval)</span>
<a href="#l1.144"></a><span id="l1.144"> {</span>
<a href="#l1.145"></a><span id="l1.145">   if (!mBaseURL)</span>
<a href="#l1.146"></a><span id="l1.146">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.147"></a><span id="l1.147"> </span>
<a href="#l1.148"></a><span id="l1.148">   return mBaseURL-&gt;GetHost(_retval);</span>
<a href="#l1.149"></a><span id="l1.149"> }</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-nsLDAPURL::SetHost(const nsACString &amp;aHost)</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+nsresult nsLDAPURL::SetHost(const nsACString &amp;aHost)</span>
<a href="#l1.154"></a><span id="l1.154"> {</span>
<a href="#l1.155"></a><span id="l1.155">   if (!mBaseURL)</span>
<a href="#l1.156"></a><span id="l1.156">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.157"></a><span id="l1.157"> </span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-  return mBaseURL-&gt;SetHost(aHost);</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetHost(aHost).Finalize(mBaseURL);</span>
<a href="#l1.160"></a><span id="l1.160"> }</span>
<a href="#l1.161"></a><span id="l1.161"> </span>
<a href="#l1.162"></a><span id="l1.162"> NS_IMETHODIMP</span>
<a href="#l1.163"></a><span id="l1.163"> nsLDAPURL::GetPort(int32_t *_retval)</span>
<a href="#l1.164"></a><span id="l1.164"> {</span>
<a href="#l1.165"></a><span id="l1.165">   if (!mBaseURL)</span>
<a href="#l1.166"></a><span id="l1.166">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.167"></a><span id="l1.167"> </span>
<a href="#l1.168"></a><span id="l1.168">   return mBaseURL-&gt;GetPort(_retval);</span>
<a href="#l1.169"></a><span id="l1.169"> }</span>
<a href="#l1.170"></a><span id="l1.170"> </span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-nsLDAPURL::SetPort(int32_t aPort)</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+nsresult nsLDAPURL::SetPort(int32_t aPort)</span>
<a href="#l1.174"></a><span id="l1.174"> {</span>
<a href="#l1.175"></a><span id="l1.175">   if (!mBaseURL)</span>
<a href="#l1.176"></a><span id="l1.176">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.177"></a><span id="l1.177"> </span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-  return mBaseURL-&gt;SetPort(aPort);</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetPort(aPort).Finalize(mBaseURL);</span>
<a href="#l1.180"></a><span id="l1.180"> }</span>
<a href="#l1.181"></a><span id="l1.181"> </span>
<a href="#l1.182"></a><span id="l1.182"> NS_IMETHODIMP nsLDAPURL::GetPathQueryRef(nsACString &amp;_retval)</span>
<a href="#l1.183"></a><span id="l1.183"> {</span>
<a href="#l1.184"></a><span id="l1.184">   if (!mBaseURL)</span>
<a href="#l1.185"></a><span id="l1.185">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.186"></a><span id="l1.186"> </span>
<a href="#l1.187"></a><span id="l1.187">   return mBaseURL-&gt;GetPathQueryRef(_retval);</span>
<a href="#l1.188"></a><span id="l1.188"> }</span>
<a href="#l1.189"></a><span id="l1.189"> </span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-NS_IMETHODIMP nsLDAPURL::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+nsresult nsLDAPURL::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l1.192"></a><span id="l1.192"> {</span>
<a href="#l1.193"></a><span id="l1.193">   if (!mBaseURL)</span>
<a href="#l1.194"></a><span id="l1.194">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196">   nsresult rv = SetPathInternal(PromiseFlatCString(aPath));</span>
<a href="#l1.197"></a><span id="l1.197">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.198"></a><span id="l1.198"> </span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  return mBaseURL-&gt;SetPathQueryRef(aPath);</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetPathQueryRef(aPath).Finalize(mBaseURL);</span>
<a href="#l1.201"></a><span id="l1.201"> }</span>
<a href="#l1.202"></a><span id="l1.202"> </span>
<a href="#l1.203"></a><span id="l1.203"> NS_IMETHODIMP nsLDAPURL::GetAsciiSpec(nsACString &amp;_retval)</span>
<a href="#l1.204"></a><span id="l1.204"> {</span>
<a href="#l1.205"></a><span id="l1.205">   if (!mBaseURL)</span>
<a href="#l1.206"></a><span id="l1.206">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.207"></a><span id="l1.207"> </span>
<a href="#l1.208"></a><span id="l1.208">   // XXX handle extra items?</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineat">@@ -459,17 +445,17 @@ NS_IMETHODIMP nsLDAPURL::SetDn(const nsA</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211">   mDN.Assign(aDn);</span>
<a href="#l1.212"></a><span id="l1.212"> </span>
<a href="#l1.213"></a><span id="l1.213">   // Now get the current path</span>
<a href="#l1.214"></a><span id="l1.214">   nsCString newPath;</span>
<a href="#l1.215"></a><span id="l1.215">   GetPathInternal(newPath);</span>
<a href="#l1.216"></a><span id="l1.216"> </span>
<a href="#l1.217"></a><span id="l1.217">   // and update the base url</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-  return mBaseURL-&gt;SetPathQueryRef(newPath);</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetPathQueryRef(newPath).Finalize(mBaseURL);</span>
<a href="#l1.220"></a><span id="l1.220"> }</span>
<a href="#l1.221"></a><span id="l1.221"> </span>
<a href="#l1.222"></a><span id="l1.222"> NS_IMETHODIMP nsLDAPURL::GetAttributes(nsACString &amp;aAttributes)</span>
<a href="#l1.223"></a><span id="l1.223"> {</span>
<a href="#l1.224"></a><span id="l1.224">   if (mAttributes.IsEmpty())</span>
<a href="#l1.225"></a><span id="l1.225">   {</span>
<a href="#l1.226"></a><span id="l1.226">     aAttributes.Truncate();</span>
<a href="#l1.227"></a><span id="l1.227">     return NS_OK;</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineat">@@ -505,17 +491,17 @@ NS_IMETHODIMP nsLDAPURL::SetAttributes(c</span>
<a href="#l1.229"></a><span id="l1.229">       mAttributes.Append(',');</span>
<a href="#l1.230"></a><span id="l1.230">   }</span>
<a href="#l1.231"></a><span id="l1.231"> </span>
<a href="#l1.232"></a><span id="l1.232">   // Now get the current path</span>
<a href="#l1.233"></a><span id="l1.233">   nsCString newPath;</span>
<a href="#l1.234"></a><span id="l1.234">   GetPathInternal(newPath);</span>
<a href="#l1.235"></a><span id="l1.235"> </span>
<a href="#l1.236"></a><span id="l1.236">   // and update the base url</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-  return mBaseURL-&gt;SetPathQueryRef(newPath);</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetPathQueryRef(newPath).Finalize(mBaseURL);</span>
<a href="#l1.239"></a><span id="l1.239"> }</span>
<a href="#l1.240"></a><span id="l1.240"> </span>
<a href="#l1.241"></a><span id="l1.241"> nsresult nsLDAPURL::SetAttributeArray(char** aAttributes)</span>
<a href="#l1.242"></a><span id="l1.242"> {</span>
<a href="#l1.243"></a><span id="l1.243">   mAttributes.Truncate();</span>
<a href="#l1.244"></a><span id="l1.244"> </span>
<a href="#l1.245"></a><span id="l1.245">   while (aAttributes &amp;&amp; *aAttributes)</span>
<a href="#l1.246"></a><span id="l1.246">   {</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineat">@@ -560,17 +546,17 @@ NS_IMETHODIMP nsLDAPURL::AddAttribute(co</span>
<a href="#l1.248"></a><span id="l1.248">     mAttributes.Append(Substring(findAttribute, 1));</span>
<a href="#l1.249"></a><span id="l1.249">   }</span>
<a href="#l1.250"></a><span id="l1.250"> </span>
<a href="#l1.251"></a><span id="l1.251">   // Now get the current path</span>
<a href="#l1.252"></a><span id="l1.252">   nsCString newPath;</span>
<a href="#l1.253"></a><span id="l1.253">   GetPathInternal(newPath);</span>
<a href="#l1.254"></a><span id="l1.254"> </span>
<a href="#l1.255"></a><span id="l1.255">   // and update the base url</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-  return mBaseURL-&gt;SetPathQueryRef(newPath);</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetPathQueryRef(newPath).Finalize(mBaseURL);</span>
<a href="#l1.258"></a><span id="l1.258"> }</span>
<a href="#l1.259"></a><span id="l1.259"> </span>
<a href="#l1.260"></a><span id="l1.260"> NS_IMETHODIMP nsLDAPURL::RemoveAttribute(const nsACString &amp;aAttribute)</span>
<a href="#l1.261"></a><span id="l1.261"> {</span>
<a href="#l1.262"></a><span id="l1.262">   if (!mBaseURL)</span>
<a href="#l1.263"></a><span id="l1.263">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.264"></a><span id="l1.264"> </span>
<a href="#l1.265"></a><span id="l1.265">   if (mAttributes.IsEmpty())</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineat">@@ -591,17 +577,17 @@ NS_IMETHODIMP nsLDAPURL::RemoveAttribute</span>
<a href="#l1.267"></a><span id="l1.267">     mAttributes.Cut(pos, findAttribute.Length() - 1);</span>
<a href="#l1.268"></a><span id="l1.268">   }</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270">   // Now get the current path</span>
<a href="#l1.271"></a><span id="l1.271">   nsCString newPath;</span>
<a href="#l1.272"></a><span id="l1.272">   GetPathInternal(newPath);</span>
<a href="#l1.273"></a><span id="l1.273"> </span>
<a href="#l1.274"></a><span id="l1.274">   // and update the base url</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-  return mBaseURL-&gt;SetPathQueryRef(newPath);</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetPathQueryRef(newPath).Finalize(mBaseURL);</span>
<a href="#l1.277"></a><span id="l1.277"> }</span>
<a href="#l1.278"></a><span id="l1.278"> </span>
<a href="#l1.279"></a><span id="l1.279"> NS_IMETHODIMP nsLDAPURL::HasAttribute(const nsACString &amp;aAttribute,</span>
<a href="#l1.280"></a><span id="l1.280">                                       bool *_retval)</span>
<a href="#l1.281"></a><span id="l1.281"> {</span>
<a href="#l1.282"></a><span id="l1.282">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284">   nsAutoCString findAttribute(&quot;,&quot;);</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineat">@@ -631,17 +617,17 @@ NS_IMETHODIMP nsLDAPURL::SetScope(int32_</span>
<a href="#l1.286"></a><span id="l1.286"> </span>
<a href="#l1.287"></a><span id="l1.287">   mScope = aScope;</span>
<a href="#l1.288"></a><span id="l1.288"> </span>
<a href="#l1.289"></a><span id="l1.289">   // Now get the current path</span>
<a href="#l1.290"></a><span id="l1.290">   nsCString newPath;</span>
<a href="#l1.291"></a><span id="l1.291">   GetPathInternal(newPath);</span>
<a href="#l1.292"></a><span id="l1.292"> </span>
<a href="#l1.293"></a><span id="l1.293">   // and update the base url</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-  return mBaseURL-&gt;SetPathQueryRef(newPath);</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetPathQueryRef(newPath).Finalize(mBaseURL);</span>
<a href="#l1.296"></a><span id="l1.296"> }</span>
<a href="#l1.297"></a><span id="l1.297"> </span>
<a href="#l1.298"></a><span id="l1.298"> NS_IMETHODIMP nsLDAPURL::GetFilter(nsACString&amp; _retval)</span>
<a href="#l1.299"></a><span id="l1.299"> {</span>
<a href="#l1.300"></a><span id="l1.300">     _retval.Assign(mFilter);</span>
<a href="#l1.301"></a><span id="l1.301">     return NS_OK;</span>
<a href="#l1.302"></a><span id="l1.302"> }</span>
<a href="#l1.303"></a><span id="l1.303"> NS_IMETHODIMP nsLDAPURL::SetFilter(const nsACString&amp; aFilter)</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineat">@@ -654,17 +640,17 @@ NS_IMETHODIMP nsLDAPURL::SetFilter(const</span>
<a href="#l1.305"></a><span id="l1.305">   if (mFilter.IsEmpty())</span>
<a href="#l1.306"></a><span id="l1.306">     mFilter.AssignLiteral(&quot;(objectclass=*)&quot;);</span>
<a href="#l1.307"></a><span id="l1.307"> </span>
<a href="#l1.308"></a><span id="l1.308">   // Now get the current path</span>
<a href="#l1.309"></a><span id="l1.309">   nsCString newPath;</span>
<a href="#l1.310"></a><span id="l1.310">   GetPathInternal(newPath);</span>
<a href="#l1.311"></a><span id="l1.311"> </span>
<a href="#l1.312"></a><span id="l1.312">   // and update the base url</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-  return mBaseURL-&gt;SetPathQueryRef(newPath);</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetPathQueryRef(newPath).Finalize(mBaseURL);</span>
<a href="#l1.315"></a><span id="l1.315"> }</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317"> NS_IMETHODIMP nsLDAPURL::GetOptions(uint32_t *_retval)</span>
<a href="#l1.318"></a><span id="l1.318"> {</span>
<a href="#l1.319"></a><span id="l1.319">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.320"></a><span id="l1.320">   *_retval = mOptions;</span>
<a href="#l1.321"></a><span id="l1.321">   return NS_OK;</span>
<a href="#l1.322"></a><span id="l1.322"> }</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineat">@@ -678,19 +664,19 @@ NS_IMETHODIMP nsLDAPURL::SetOptions(uint</span>
<a href="#l1.324"></a><span id="l1.324">   mOptions = aOptions;</span>
<a href="#l1.325"></a><span id="l1.325"> </span>
<a href="#l1.326"></a><span id="l1.326">   if ((aOptions &amp; OPT_SECURE) == OPT_SECURE)</span>
<a href="#l1.327"></a><span id="l1.327">     return SetScheme(LDAP_SSL_SCHEME);</span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329">   return SetScheme(LDAP_SCHEME);</span>
<a href="#l1.330"></a><span id="l1.330"> }</span>
<a href="#l1.331"></a><span id="l1.331"> </span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-NS_IMETHODIMP nsLDAPURL::SetRef(const nsACString &amp;aRef)</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+nsresult nsLDAPURL::SetRef(const nsACString &amp;aRef)</span>
<a href="#l1.334"></a><span id="l1.334"> {</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-  return mBaseURL-&gt;SetRef(aRef);</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetRef(aRef).Finalize(mBaseURL);</span>
<a href="#l1.337"></a><span id="l1.337"> }</span>
<a href="#l1.338"></a><span id="l1.338"> </span>
<a href="#l1.339"></a><span id="l1.339"> NS_IMETHODIMP</span>
<a href="#l1.340"></a><span id="l1.340"> nsLDAPURL::GetRef(nsACString &amp;result)</span>
<a href="#l1.341"></a><span id="l1.341"> {</span>
<a href="#l1.342"></a><span id="l1.342">   return mBaseURL-&gt;GetRef(result);</span>
<a href="#l1.343"></a><span id="l1.343"> }</span>
<a href="#l1.344"></a><span id="l1.344"> </span>
<a href="#l1.345"></a><span id="l1.345" class="difflineat">@@ -736,38 +722,35 @@ nsLDAPURL::GetHasRef(bool *result)</span>
<a href="#l1.346"></a><span id="l1.346"> }</span>
<a href="#l1.347"></a><span id="l1.347"> </span>
<a href="#l1.348"></a><span id="l1.348"> NS_IMETHODIMP</span>
<a href="#l1.349"></a><span id="l1.349"> nsLDAPURL::GetFilePath(nsACString &amp;aFilePath)</span>
<a href="#l1.350"></a><span id="l1.350"> {</span>
<a href="#l1.351"></a><span id="l1.351">   return mBaseURL-&gt;GetFilePath(aFilePath);</span>
<a href="#l1.352"></a><span id="l1.352"> }</span>
<a href="#l1.353"></a><span id="l1.353"> </span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-nsLDAPURL::SetFilePath(const nsACString &amp;aFilePath)</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+nsresult nsLDAPURL::SetFilePath(const nsACString &amp;aFilePath)</span>
<a href="#l1.357"></a><span id="l1.357"> {</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-  return mBaseURL-&gt;SetFilePath(aFilePath);</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetFilePath(aFilePath).Finalize(mBaseURL);</span>
<a href="#l1.360"></a><span id="l1.360"> }</span>
<a href="#l1.361"></a><span id="l1.361"> </span>
<a href="#l1.362"></a><span id="l1.362"> NS_IMETHODIMP</span>
<a href="#l1.363"></a><span id="l1.363"> nsLDAPURL::GetQuery(nsACString &amp;aQuery)</span>
<a href="#l1.364"></a><span id="l1.364"> {</span>
<a href="#l1.365"></a><span id="l1.365">   return mBaseURL-&gt;GetQuery(aQuery);</span>
<a href="#l1.366"></a><span id="l1.366"> }</span>
<a href="#l1.367"></a><span id="l1.367"> </span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-nsLDAPURL::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+nsresult nsLDAPURL::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l1.371"></a><span id="l1.371"> {</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-  return mBaseURL-&gt;SetQuery(aQuery);</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetQuery(aQuery).Finalize(mBaseURL);</span>
<a href="#l1.374"></a><span id="l1.374"> }</span>
<a href="#l1.375"></a><span id="l1.375"> </span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-nsLDAPURL::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineplus">+nsresult nsLDAPURL::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l1.379"></a><span id="l1.379"> {</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-  return mBaseURL-&gt;SetQueryWithEncoding(aQuery, aEncoding);</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineplus">+  return NS_MutateURI(mBaseURL).SetQueryWithEncoding(aQuery, aEncoding).Finalize(mBaseURL);</span>
<a href="#l1.382"></a><span id="l1.382"> }</span>
<a href="#l1.383"></a><span id="l1.383"> </span>
<a href="#l1.384"></a><span id="l1.384"> NS_IMPL_ISUPPORTS(nsLDAPURL::Mutator, nsIURISetters, nsIURIMutator)</span>
<a href="#l1.385"></a><span id="l1.385"> </span>
<a href="#l1.386"></a><span id="l1.386"> NS_IMETHODIMP</span>
<a href="#l1.387"></a><span id="l1.387"> nsLDAPURL::Mutate(nsIURIMutator** aMutator)</span>
<a href="#l1.388"></a><span id="l1.388"> {</span>
<a href="#l1.389"></a><span id="l1.389">   RefPtr&lt;nsLDAPURL::Mutator&gt; mutator = new nsLDAPURL::Mutator();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPURL.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPURL.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -34,16 +34,31 @@ class nsLDAPURL : public nsILDAPURL</span>
<a href="#l2.4"></a><span id="l2.4"> {</span>
<a href="#l2.5"></a><span id="l2.5"> public:</span>
<a href="#l2.6"></a><span id="l2.6">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l2.7"></a><span id="l2.7">   NS_DECL_NSIURI</span>
<a href="#l2.8"></a><span id="l2.8">   NS_DECL_NSILDAPURL</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">   nsLDAPURL();</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+protected:</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  virtual nsresult SetSpecInternal(const nsACString &amp;aSpec);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  virtual nsresult SetScheme(const nsACString &amp;aScheme);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  virtual nsresult SetUserPass(const nsACString &amp;aUserPass);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  virtual nsresult SetUsername(const nsACString &amp;aUsername);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  virtual nsresult SetPassword(const nsACString &amp;aPassword);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  virtual nsresult SetHostPort(const nsACString &amp;aHostPort);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  virtual nsresult SetHost(const nsACString &amp;aHost);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  virtual nsresult SetPort(int32_t aPort);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  virtual nsresult SetPathQueryRef(const nsACString &amp;aPath);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+  virtual nsresult SetRef(const nsACString &amp;aRef);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+  virtual nsresult SetFilePath(const nsACString &amp;aFilePath);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  virtual nsresult SetQuery(const nsACString &amp;aQuery);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+</span>
<a href="#l2.27"></a><span id="l2.27"> public:</span>
<a href="#l2.28"></a><span id="l2.28">   class Mutator</span>
<a href="#l2.29"></a><span id="l2.29">       : public nsIURIMutator</span>
<a href="#l2.30"></a><span id="l2.30">       , public BaseURIMutator&lt;nsLDAPURL&gt;</span>
<a href="#l2.31"></a><span id="l2.31">   {</span>
<a href="#l2.32"></a><span id="l2.32">     NS_DECL_ISUPPORTS</span>
<a href="#l2.33"></a><span id="l2.33">     NS_FORWARD_SAFE_NSIURISETTERS_RET(mURI)</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35" class="difflineat">@@ -60,26 +75,28 @@ public:</span>
<a href="#l2.36"></a><span id="l2.36">     NS_IMETHOD Finalize(nsIURI** aURI) override</span>
<a href="#l2.37"></a><span id="l2.37">     {</span>
<a href="#l2.38"></a><span id="l2.38">       mURI.forget(aURI);</span>
<a href="#l2.39"></a><span id="l2.39">       return NS_OK;</span>
<a href="#l2.40"></a><span id="l2.40">     }</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">     NS_IMETHOD SetSpec(const nsACString &amp; aSpec, nsIURIMutator** aMutator) override</span>
<a href="#l2.43"></a><span id="l2.43">     {</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-      NS_ADDREF(*aMutator = this);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+      if (aMutator)</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+        NS_ADDREF(*aMutator = this);</span>
<a href="#l2.47"></a><span id="l2.47">       return InitFromSpec(aSpec);</span>
<a href="#l2.48"></a><span id="l2.48">     }</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">     explicit Mutator() { }</span>
<a href="#l2.51"></a><span id="l2.51">   private:</span>
<a href="#l2.52"></a><span id="l2.52">     virtual ~Mutator() { }</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">     friend class nsLDAPURL;</span>
<a href="#l2.55"></a><span id="l2.55">   };</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  friend BaseURIMutator&lt;nsLDAPURL&gt;;</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58"> protected:</span>
<a href="#l2.59"></a><span id="l2.59">   enum RefHandlingEnum {</span>
<a href="#l2.60"></a><span id="l2.60">     eIgnoreRef,</span>
<a href="#l2.61"></a><span id="l2.61">     eHonorRef,</span>
<a href="#l2.62"></a><span id="l2.62">     eReplaceRef</span>
<a href="#l2.63"></a><span id="l2.63">   };</span>
<a href="#l2.64"></a><span id="l2.64">   virtual ~nsLDAPURL();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -55,23 +55,20 @@ NS_IMETHODIMP nsAddbookProtocolHandler::</span>
<a href="#l3.4"></a><span id="l3.4"> }</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> NS_IMETHODIMP nsAddbookProtocolHandler::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l3.7"></a><span id="l3.7">                                                const char *aOriginCharset, // ignored</span>
<a href="#l3.8"></a><span id="l3.8">                                                nsIURI *aBaseURI,</span>
<a href="#l3.9"></a><span id="l3.9">                                                nsIURI **_retval)</span>
<a href="#l3.10"></a><span id="l3.10"> {</span>
<a href="#l3.11"></a><span id="l3.11">   nsresult rv;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  nsCOMPtr&lt;nsIAddbookUrl&gt; addbookUrl = do_CreateInstance(NS_ADDBOOKURL_CONTRACTID, &amp;rv);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  rv = addbookUrl-&gt;SetSpecInternal(aSpec);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(addbookUrl, &amp;rv);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  rv = NS_MutateURI(new nsAddbookUrl::Mutator())</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+         .SetSpec(aSpec)</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+         .Finalize(uri);</span>
<a href="#l3.23"></a><span id="l3.23">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">   uri.forget(_retval);</span>
<a href="#l3.26"></a><span id="l3.26">   return NS_OK;</span>
<a href="#l3.27"></a><span id="l3.27"> }</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29"> NS_IMETHODIMP</span>
<a href="#l3.30"></a><span id="l3.30"> nsAddbookProtocolHandler::AllowPort(int32_t port, const char *scheme, bool *_retval)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookUrl.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookUrl.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -26,17 +26,17 @@ nsAddbookUrl::~nsAddbookUrl()</span>
<a href="#l4.4"></a><span id="l4.4"> {</span>
<a href="#l4.5"></a><span id="l4.5"> }</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> NS_IMPL_ISUPPORTS(nsAddbookUrl, nsIAddbookUrl, nsIURI)</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> nsresult</span>
<a href="#l4.10"></a><span id="l4.10"> nsAddbookUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l4.11"></a><span id="l4.11"> {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsresult rv = m_baseURL-&gt;SetSpecInternal(aSpec);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetSpec(aSpec).Finalize(m_baseURL);</span>
<a href="#l4.14"></a><span id="l4.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.15"></a><span id="l4.15">   return ParseUrl();</span>
<a href="#l4.16"></a><span id="l4.16"> }</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> nsresult nsAddbookUrl::ParseUrl()</span>
<a href="#l4.19"></a><span id="l4.19"> {</span>
<a href="#l4.20"></a><span id="l4.20">   nsAutoCString pathStr;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -67,94 +67,90 @@ NS_IMETHODIMP nsAddbookUrl::GetPrePath(n</span>
<a href="#l4.23"></a><span id="l4.23">   return m_baseURL-&gt;GetPrePath(aPrePath);</span>
<a href="#l4.24"></a><span id="l4.24"> }</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26"> NS_IMETHODIMP nsAddbookUrl::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l4.27"></a><span id="l4.27"> {</span>
<a href="#l4.28"></a><span id="l4.28">   return m_baseURL-&gt;GetScheme(aScheme);</span>
<a href="#l4.29"></a><span id="l4.29"> }</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+nsresult nsAddbookUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l4.33"></a><span id="l4.33"> {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  return m_baseURL-&gt;SetScheme(aScheme);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetScheme(aScheme).Finalize(m_baseURL);</span>
<a href="#l4.36"></a><span id="l4.36"> }</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38"> NS_IMETHODIMP nsAddbookUrl::GetUserPass(nsACString &amp;aUserPass)</span>
<a href="#l4.39"></a><span id="l4.39"> {</span>
<a href="#l4.40"></a><span id="l4.40">   return m_baseURL-&gt;GetUserPass(aUserPass);</span>
<a href="#l4.41"></a><span id="l4.41"> }</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+nsresult nsAddbookUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l4.45"></a><span id="l4.45"> {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-  return m_baseURL-&gt;SetUserPass(aUserPass);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetUserPass(aUserPass).Finalize(m_baseURL);</span>
<a href="#l4.48"></a><span id="l4.48"> }</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50"> NS_IMETHODIMP nsAddbookUrl::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l4.51"></a><span id="l4.51"> {</span>
<a href="#l4.52"></a><span id="l4.52">   return m_baseURL-&gt;GetUsername(aUsername);</span>
<a href="#l4.53"></a><span id="l4.53"> }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+nsresult nsAddbookUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l4.57"></a><span id="l4.57"> {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  return m_baseURL-&gt;SetUsername(aUsername);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l4.60"></a><span id="l4.60"> }</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62"> NS_IMETHODIMP nsAddbookUrl::GetPassword(nsACString &amp;aPassword)</span>
<a href="#l4.63"></a><span id="l4.63"> {</span>
<a href="#l4.64"></a><span id="l4.64">   return m_baseURL-&gt;GetPassword(aPassword);</span>
<a href="#l4.65"></a><span id="l4.65"> }</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+nsresult nsAddbookUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l4.69"></a><span id="l4.69"> {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  return m_baseURL-&gt;SetPassword(aPassword);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetPassword(aPassword).Finalize(m_baseURL);</span>
<a href="#l4.72"></a><span id="l4.72"> }</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74"> NS_IMETHODIMP nsAddbookUrl::GetHostPort(nsACString &amp;aHostPort)</span>
<a href="#l4.75"></a><span id="l4.75"> {</span>
<a href="#l4.76"></a><span id="l4.76">   return m_baseURL-&gt;GetHostPort(aHostPort);</span>
<a href="#l4.77"></a><span id="l4.77"> }</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+nsresult nsAddbookUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l4.81"></a><span id="l4.81"> {</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  return m_baseURL-&gt;SetHostPort(aHostPort);</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-}</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetHostAndPort(const nsACString &amp;aHostPort)</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-{</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-  return m_baseURL-&gt;SetHostAndPort(aHostPort);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetHostPort(aHostPort).Finalize(m_baseURL);</span>
<a href="#l4.89"></a><span id="l4.89"> }</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91"> NS_IMETHODIMP nsAddbookUrl::GetHost(nsACString &amp;aHost)</span>
<a href="#l4.92"></a><span id="l4.92"> {</span>
<a href="#l4.93"></a><span id="l4.93">   return m_baseURL-&gt;GetHost(aHost);</span>
<a href="#l4.94"></a><span id="l4.94"> }</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+nsresult nsAddbookUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l4.98"></a><span id="l4.98"> {</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-  return m_baseURL-&gt;SetHost(aHost);</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetHost(aHost).Finalize(m_baseURL);</span>
<a href="#l4.101"></a><span id="l4.101"> }</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103"> NS_IMETHODIMP nsAddbookUrl::GetPort(int32_t *aPort)</span>
<a href="#l4.104"></a><span id="l4.104"> {</span>
<a href="#l4.105"></a><span id="l4.105">   return m_baseURL-&gt;GetPort(aPort);</span>
<a href="#l4.106"></a><span id="l4.106"> }</span>
<a href="#l4.107"></a><span id="l4.107"> </span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetPort(int32_t aPort)</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+nsresult nsAddbookUrl::SetPort(int32_t aPort)</span>
<a href="#l4.110"></a><span id="l4.110"> {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-  return m_baseURL-&gt;SetPort(aPort);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetPort(aPort).Finalize(m_baseURL);</span>
<a href="#l4.113"></a><span id="l4.113"> }</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115"> NS_IMETHODIMP nsAddbookUrl::GetPathQueryRef(nsACString &amp;aPath)</span>
<a href="#l4.116"></a><span id="l4.116"> {</span>
<a href="#l4.117"></a><span id="l4.117">   return m_baseURL-&gt;GetPathQueryRef(aPath);</span>
<a href="#l4.118"></a><span id="l4.118"> }</span>
<a href="#l4.119"></a><span id="l4.119"> </span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+nsresult nsAddbookUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l4.122"></a><span id="l4.122"> {</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-  m_baseURL-&gt;SetPathQueryRef(aPath);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.126"></a><span id="l4.126">   return ParseUrl();</span>
<a href="#l4.127"></a><span id="l4.127"> }</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129"> NS_IMETHODIMP nsAddbookUrl::GetAsciiHost(nsACString &amp;aHostA)</span>
<a href="#l4.130"></a><span id="l4.130"> {</span>
<a href="#l4.131"></a><span id="l4.131">   return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l4.132"></a><span id="l4.132"> }</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134" class="difflineat">@@ -232,51 +228,48 @@ NS_IMETHODIMP nsAddbookUrl::Resolve(cons</span>
<a href="#l4.135"></a><span id="l4.135"> }</span>
<a href="#l4.136"></a><span id="l4.136"> </span>
<a href="#l4.137"></a><span id="l4.137"> NS_IMETHODIMP</span>
<a href="#l4.138"></a><span id="l4.138"> nsAddbookUrl::GetRef(nsACString &amp;result)</span>
<a href="#l4.139"></a><span id="l4.139"> {</span>
<a href="#l4.140"></a><span id="l4.140">   return m_baseURL-&gt;GetRef(result);</span>
<a href="#l4.141"></a><span id="l4.141"> }</span>
<a href="#l4.142"></a><span id="l4.142"> </span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-nsAddbookUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+nsresult nsAddbookUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l4.146"></a><span id="l4.146"> {</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-  m_baseURL-&gt;SetRef(aRef);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetRef(aRef).Finalize(m_baseURL);</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.150"></a><span id="l4.150">   return ParseUrl();</span>
<a href="#l4.151"></a><span id="l4.151"> }</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153"> NS_IMETHODIMP</span>
<a href="#l4.154"></a><span id="l4.154"> nsAddbookUrl::GetFilePath(nsACString &amp;aFilePath)</span>
<a href="#l4.155"></a><span id="l4.155"> {</span>
<a href="#l4.156"></a><span id="l4.156">   return m_baseURL-&gt;GetFilePath(aFilePath);</span>
<a href="#l4.157"></a><span id="l4.157"> }</span>
<a href="#l4.158"></a><span id="l4.158"> </span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-nsAddbookUrl::SetFilePath(const nsACString &amp;aFilePath)</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+nsresult nsAddbookUrl::SetFilePath(const nsACString &amp;aFilePath)</span>
<a href="#l4.162"></a><span id="l4.162"> {</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-  return m_baseURL-&gt;SetFilePath(aFilePath);</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetFilePath(aFilePath).Finalize(m_baseURL);</span>
<a href="#l4.165"></a><span id="l4.165"> }</span>
<a href="#l4.166"></a><span id="l4.166"> </span>
<a href="#l4.167"></a><span id="l4.167"> NS_IMETHODIMP</span>
<a href="#l4.168"></a><span id="l4.168"> nsAddbookUrl::GetQuery(nsACString &amp;aQuery)</span>
<a href="#l4.169"></a><span id="l4.169"> {</span>
<a href="#l4.170"></a><span id="l4.170">   return m_baseURL-&gt;GetQuery(aQuery);</span>
<a href="#l4.171"></a><span id="l4.171"> }</span>
<a href="#l4.172"></a><span id="l4.172"> </span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-nsAddbookUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+nsresult nsAddbookUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l4.176"></a><span id="l4.176"> {</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-  return m_baseURL-&gt;SetQuery(aQuery);</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetQuery(aQuery).Finalize(m_baseURL);</span>
<a href="#l4.179"></a><span id="l4.179"> }</span>
<a href="#l4.180"></a><span id="l4.180"> </span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-nsAddbookUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+nsresult nsAddbookUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l4.184"></a><span id="l4.184"> {</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-  return m_baseURL-&gt;SetQueryWithEncoding(aQuery, aEncoding);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetQueryWithEncoding(aQuery, aEncoding).Finalize(m_baseURL);</span>
<a href="#l4.187"></a><span id="l4.187"> }</span>
<a href="#l4.188"></a><span id="l4.188"> </span>
<a href="#l4.189"></a><span id="l4.189"> NS_IMETHODIMP nsAddbookUrl::EqualsExceptRef(nsIURI *other, bool *_retval)</span>
<a href="#l4.190"></a><span id="l4.190"> {</span>
<a href="#l4.191"></a><span id="l4.191">   // The passed-in URI might be an nsMailtoUrl. Pass our inner URL to its</span>
<a href="#l4.192"></a><span id="l4.192">   // Equals method. The other nsMailtoUrl will then pass its inner URL to</span>
<a href="#l4.193"></a><span id="l4.193">   // to the Equals method of our inner URL. Other URIs will return false.</span>
<a href="#l4.194"></a><span id="l4.194">   if (other)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookUrl.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookUrl.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,16 +15,31 @@ class nsAddbookUrl : public nsIAddbookUr</span>
<a href="#l5.4"></a><span id="l5.4"> {</span>
<a href="#l5.5"></a><span id="l5.5"> public:</span>
<a href="#l5.6"></a><span id="l5.6">     NS_DECL_ISUPPORTS</span>
<a href="#l5.7"></a><span id="l5.7">     NS_DECL_NSIURI</span>
<a href="#l5.8"></a><span id="l5.8">     NS_DECL_NSIADDBOOKURL</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">     nsAddbookUrl();</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+protected:</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  virtual nsresult SetSpecInternal(const nsACString &amp;aSpec);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  virtual nsresult SetScheme(const nsACString &amp;aScheme);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  virtual nsresult SetUserPass(const nsACString &amp;aUserPass);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  virtual nsresult SetUsername(const nsACString &amp;aUsername);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  virtual nsresult SetPassword(const nsACString &amp;aPassword);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  virtual nsresult SetHostPort(const nsACString &amp;aHostPort);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  virtual nsresult SetHost(const nsACString &amp;aHost);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  virtual nsresult SetPort(int32_t aPort);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  virtual nsresult SetPathQueryRef(const nsACString &amp;aPath);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  virtual nsresult SetRef(const nsACString &amp;aRef);</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  virtual nsresult SetFilePath(const nsACString &amp;aFilePath);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  virtual nsresult SetQuery(const nsACString &amp;aQuery);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27"> public:</span>
<a href="#l5.28"></a><span id="l5.28">   class Mutator</span>
<a href="#l5.29"></a><span id="l5.29">       : public nsIURIMutator</span>
<a href="#l5.30"></a><span id="l5.30">       , public BaseURIMutator&lt;nsAddbookUrl&gt;</span>
<a href="#l5.31"></a><span id="l5.31">   {</span>
<a href="#l5.32"></a><span id="l5.32">     NS_DECL_ISUPPORTS</span>
<a href="#l5.33"></a><span id="l5.33">     NS_FORWARD_SAFE_NSIURISETTERS_RET(mURI)</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35" class="difflineat">@@ -41,26 +56,28 @@ public:</span>
<a href="#l5.36"></a><span id="l5.36">     NS_IMETHOD Finalize(nsIURI** aURI) override</span>
<a href="#l5.37"></a><span id="l5.37">     {</span>
<a href="#l5.38"></a><span id="l5.38">       mURI.forget(aURI);</span>
<a href="#l5.39"></a><span id="l5.39">       return NS_OK;</span>
<a href="#l5.40"></a><span id="l5.40">     }</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">     NS_IMETHOD SetSpec(const nsACString &amp; aSpec, nsIURIMutator** aMutator) override</span>
<a href="#l5.43"></a><span id="l5.43">     {</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-      NS_ADDREF(*aMutator = this);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+      if (aMutator)</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+        NS_ADDREF(*aMutator = this);</span>
<a href="#l5.47"></a><span id="l5.47">       return InitFromSpec(aSpec);</span>
<a href="#l5.48"></a><span id="l5.48">     }</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">     explicit Mutator() { }</span>
<a href="#l5.51"></a><span id="l5.51">   private:</span>
<a href="#l5.52"></a><span id="l5.52">     virtual ~Mutator() { }</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">     friend class nsAddbookUrl;</span>
<a href="#l5.55"></a><span id="l5.55">   };</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+  friend BaseURIMutator&lt;nsAddbookUrl&gt;;</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58"> protected:</span>
<a href="#l5.59"></a><span id="l5.59">   enum RefHandlingEnum {</span>
<a href="#l5.60"></a><span id="l5.60">     eIgnoreRef,</span>
<a href="#l5.61"></a><span id="l5.61">     eHonorRef,</span>
<a href="#l5.62"></a><span id="l5.62">     eReplaceRef</span>
<a href="#l5.63"></a><span id="l5.63">   };</span>
<a href="#l5.64"></a><span id="l5.64">   virtual ~nsAddbookUrl();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgMailNewsUrl.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgMailNewsUrl.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -22,16 +22,19 @@ interface nsIMsgDBHdr;</span>
<a href="#l6.4"></a><span id="l6.4"> interface nsIDocShellLoadInfo;</span>
<a href="#l6.5"></a><span id="l6.5"> interface nsIDocShell;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> [scriptable, builtinclass, uuid(995455ba-5bb4-4643-8d70-2b877a2e1320)]</span>
<a href="#l6.8"></a><span id="l6.8"> interface nsIMsgMailNewsUrl : nsIURL {</span>
<a href="#l6.9"></a><span id="l6.9">   [noscript,notxpcom,nostdcall]</span>
<a href="#l6.10"></a><span id="l6.10">   nsresult setFileNameInternal(in ACString aFileName);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  [noscript,notxpcom,nostdcall]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsresult setSpecInternal(in ACString Spec);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.16"></a><span id="l6.16">   // Eventually we'd like to push this type of functionality up into nsIURI.</span>
<a href="#l6.17"></a><span id="l6.17">   // The idea is to allow the &quot;application&quot; (the part of the code which wants to</span>
<a href="#l6.18"></a><span id="l6.18">   // run a url in order to perform some action) to register itself as a listener</span>
<a href="#l6.19"></a><span id="l6.19">   // on url. As a url listener, the app will be informed when the url begins to run</span>
<a href="#l6.20"></a><span id="l6.20">   // and when the url is finished.</span>
<a href="#l6.21"></a><span id="l6.21">   ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.22"></a><span id="l6.22">   void RegisterListener (in nsIUrlListener aUrlListener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerContentHandler.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerContentHandler.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -10,16 +10,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIURL.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsString.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;plstr.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIURL.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> nsMessengerContentHandler::nsMessengerContentHandler()</span>
<a href="#l7.16"></a><span id="l7.16"> {</span>
<a href="#l7.17"></a><span id="l7.17"> }</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> /* the following macro actually implement addref, release and query interface for our component. */</span>
<a href="#l7.20"></a><span id="l7.20"> NS_IMPL_ISUPPORTS(nsMessengerContentHandler, nsIContentHandler)</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -50,17 +51,18 @@ NS_IMETHODIMP nsMessengerContentHandler:</span>
<a href="#l7.22"></a><span id="l7.22">         nsCOMPtr&lt;nsIURL&gt; aUrl = do_QueryInterface(aUri);</span>
<a href="#l7.23"></a><span id="l7.23">         if (aUrl)</span>
<a href="#l7.24"></a><span id="l7.24">         {</span>
<a href="#l7.25"></a><span id="l7.25">           nsAutoCString queryPart;</span>
<a href="#l7.26"></a><span id="l7.26">           aUrl-&gt;GetQuery(queryPart);</span>
<a href="#l7.27"></a><span id="l7.27">           queryPart.Replace(queryPart.Find(&quot;type=message/rfc822&quot;),</span>
<a href="#l7.28"></a><span id="l7.28">                             sizeof(&quot;type=message/rfc822&quot;) - 1,</span>
<a href="#l7.29"></a><span id="l7.29">                             &quot;type=application/x-message-display&quot;);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-          aUrl-&gt;SetQuery(queryPart);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+          rv = NS_MutateURI(aUrl).SetQuery(queryPart).Finalize(aUrl);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.33"></a><span id="l7.33">           rv = OpenWindow(aUri);</span>
<a href="#l7.34"></a><span id="l7.34">         }</span>
<a href="#l7.35"></a><span id="l7.35">       }</span>
<a href="#l7.36"></a><span id="l7.36">     }</span>
<a href="#l7.37"></a><span id="l7.37">   }</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">   return rv;</span>
<a href="#l7.40"></a><span id="l7.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3184,17 +3184,18 @@ nsMsgDBFolder::parseURI(bool needServer)</span>
<a href="#l8.4"></a><span id="l8.4">       nsCString serverType;</span>
<a href="#l8.5"></a><span id="l8.5">       GetIncomingServerType(serverType);</span>
<a href="#l8.6"></a><span id="l8.6">       if (serverType.IsEmpty())</span>
<a href="#l8.7"></a><span id="l8.7">       {</span>
<a href="#l8.8"></a><span id="l8.8">         NS_WARNING(&quot;can't determine folder's server type&quot;);</span>
<a href="#l8.9"></a><span id="l8.9">         return NS_ERROR_FAILURE;</span>
<a href="#l8.10"></a><span id="l8.10">       }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      url-&gt;SetScheme(serverType);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+      rv = NS_MutateURI(url).SetScheme(serverType).Finalize(url);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.15"></a><span id="l8.15">       rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l8.16"></a><span id="l8.16">                                       getter_AddRefs(server));</span>
<a href="#l8.17"></a><span id="l8.17">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.18"></a><span id="l8.18">     }</span>
<a href="#l8.19"></a><span id="l8.19">     mServer = do_GetWeakReference(server);</span>
<a href="#l8.20"></a><span id="l8.20">   } /* !mServer */</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">   // now try to find the local path for this folder</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -212,30 +212,32 @@ NS_IMETHODIMP nsMsgMailNewsUrl::GetServe</span>
<a href="#l9.4"></a><span id="l9.4">   rv = GetScheme(scheme);</span>
<a href="#l9.5"></a><span id="l9.5">   if (NS_SUCCEEDED(rv))</span>
<a href="#l9.6"></a><span id="l9.6">   {</span>
<a href="#l9.7"></a><span id="l9.7">     if (scheme.EqualsLiteral(&quot;pop&quot;))</span>
<a href="#l9.8"></a><span id="l9.8">       scheme.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l9.9"></a><span id="l9.9">     // we use &quot;nntp&quot; in the server list so translate it here.</span>
<a href="#l9.10"></a><span id="l9.10">     if (scheme.EqualsLiteral(&quot;news&quot;))</span>
<a href="#l9.11"></a><span id="l9.11">       scheme.AssignLiteral(&quot;nntp&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    url-&gt;SetScheme(scheme);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    rv = NS_MutateURI(url).SetScheme(scheme).Finalize(url);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.15"></a><span id="l9.15">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l9.16"></a><span id="l9.16">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l9.21"></a><span id="l9.21">     rv = accountManager-&gt;FindServerByURI(url, false, aIncomingServer);</span>
<a href="#l9.22"></a><span id="l9.22">     if (!*aIncomingServer &amp;&amp; scheme.EqualsLiteral(&quot;imap&quot;))</span>
<a href="#l9.23"></a><span id="l9.23">     {</span>
<a href="#l9.24"></a><span id="l9.24">       // look for any imap server with this host name so clicking on</span>
<a href="#l9.25"></a><span id="l9.25">       // other users folder urls will work. We could override this method</span>
<a href="#l9.26"></a><span id="l9.26">       // for imap urls, or we could make caching of servers work and</span>
<a href="#l9.27"></a><span id="l9.27">       // just set the server in the imap code for this case.</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-      url-&gt;SetUserPass(EmptyCString());</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+      rv = NS_MutateURI(url).SetUserPass(EmptyCString()).Finalize(url);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.31"></a><span id="l9.31">       rv = accountManager-&gt;FindServerByURI(url, false, aIncomingServer);</span>
<a href="#l9.32"></a><span id="l9.32">     }</span>
<a href="#l9.33"></a><span id="l9.33">   }</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">   return rv;</span>
<a href="#l9.36"></a><span id="l9.36"> }</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38"> NS_IMETHODIMP nsMsgMailNewsUrl::GetMsgWindow(nsIMsgWindow **aMsgWindow)</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineat">@@ -413,17 +415,17 @@ nsresult nsMsgMailNewsUrl::SetSpecIntern</span>
<a href="#l9.40"></a><span id="l9.40">       mAttachmentFileName = start+FILENAME_PART_LEN;</span>
<a href="#l9.41"></a><span id="l9.41">       *end = '&amp;';</span>
<a href="#l9.42"></a><span id="l9.42">     }</span>
<a href="#l9.43"></a><span id="l9.43">     else</span>
<a href="#l9.44"></a><span id="l9.44">       mAttachmentFileName = start+FILENAME_PART_LEN;</span>
<a href="#l9.45"></a><span id="l9.45">   }</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47">   // Now, set the rest.</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-  nsresult rv = m_baseURL-&gt;SetSpecInternal(aSpec);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetSpec(aSpec).Finalize(m_baseURL);</span>
<a href="#l9.50"></a><span id="l9.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">   // Check whether the URL is in normalised form.</span>
<a href="#l9.53"></a><span id="l9.53">   nsCOMPtr &lt;nsIMsgMessageUrl&gt; msgUrl;</span>
<a href="#l9.54"></a><span id="l9.54">   QueryInterface(NS_GET_IID(nsIMsgMessageUrl), getter_AddRefs(msgUrl));</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56">   nsAutoCString principalSpec;</span>
<a href="#l9.57"></a><span id="l9.57">   if (!msgUrl || NS_FAILED(msgUrl-&gt;GetPrincipalSpec(principalSpec))) {</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineat">@@ -440,96 +442,91 @@ NS_IMETHODIMP nsMsgMailNewsUrl::GetPrePa</span>
<a href="#l9.59"></a><span id="l9.59">   return m_baseURL-&gt;GetPrePath(aPrePath);</span>
<a href="#l9.60"></a><span id="l9.60"> }</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62"> NS_IMETHODIMP nsMsgMailNewsUrl::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l9.63"></a><span id="l9.63"> {</span>
<a href="#l9.64"></a><span id="l9.64">   return m_baseURL-&gt;GetScheme(aScheme);</span>
<a href="#l9.65"></a><span id="l9.65"> }</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l9.69"></a><span id="l9.69"> {</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-  return m_baseURL-&gt;SetScheme(aScheme);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetScheme(aScheme).Finalize(m_baseURL);</span>
<a href="#l9.72"></a><span id="l9.72"> }</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75"> NS_IMETHODIMP nsMsgMailNewsUrl::GetUserPass(nsACString &amp;aUserPass)</span>
<a href="#l9.76"></a><span id="l9.76"> {</span>
<a href="#l9.77"></a><span id="l9.77">   return m_baseURL-&gt;GetUserPass(aUserPass);</span>
<a href="#l9.78"></a><span id="l9.78"> }</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l9.82"></a><span id="l9.82"> {</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-  return m_baseURL-&gt;SetUserPass(aUserPass);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetUserPass(aUserPass).Finalize(m_baseURL);</span>
<a href="#l9.85"></a><span id="l9.85"> }</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87"> NS_IMETHODIMP nsMsgMailNewsUrl::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l9.88"></a><span id="l9.88"> {</span>
<a href="#l9.89"></a><span id="l9.89">   /* note:  this will return an escaped string */</span>
<a href="#l9.90"></a><span id="l9.90">   return m_baseURL-&gt;GetUsername(aUsername);</span>
<a href="#l9.91"></a><span id="l9.91"> }</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l9.95"></a><span id="l9.95"> {</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-  return m_baseURL-&gt;SetUsername(aUsername);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l9.98"></a><span id="l9.98"> }</span>
<a href="#l9.99"></a><span id="l9.99"> </span>
<a href="#l9.100"></a><span id="l9.100"> NS_IMETHODIMP nsMsgMailNewsUrl::GetPassword(nsACString &amp;aPassword)</span>
<a href="#l9.101"></a><span id="l9.101"> {</span>
<a href="#l9.102"></a><span id="l9.102">   return m_baseURL-&gt;GetPassword(aPassword);</span>
<a href="#l9.103"></a><span id="l9.103"> }</span>
<a href="#l9.104"></a><span id="l9.104"> </span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l9.107"></a><span id="l9.107"> {</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-  return m_baseURL-&gt;SetPassword(aPassword);</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetPassword(aPassword).Finalize(m_baseURL);</span>
<a href="#l9.110"></a><span id="l9.110"> }</span>
<a href="#l9.111"></a><span id="l9.111"> </span>
<a href="#l9.112"></a><span id="l9.112"> NS_IMETHODIMP nsMsgMailNewsUrl::GetHostPort(nsACString &amp;aHostPort)</span>
<a href="#l9.113"></a><span id="l9.113"> {</span>
<a href="#l9.114"></a><span id="l9.114">   return m_baseURL-&gt;GetHostPort(aHostPort);</span>
<a href="#l9.115"></a><span id="l9.115"> }</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l9.119"></a><span id="l9.119"> {</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-  return m_baseURL-&gt;SetHostPort(aHostPort);</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-}</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetHostAndPort(const nsACString &amp;aHostPort)</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-{</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-  return m_baseURL-&gt;SetHostAndPort(aHostPort);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetHostPort(aHostPort).Finalize(m_baseURL);</span>
<a href="#l9.127"></a><span id="l9.127"> }</span>
<a href="#l9.128"></a><span id="l9.128"> </span>
<a href="#l9.129"></a><span id="l9.129"> NS_IMETHODIMP nsMsgMailNewsUrl::GetHost(nsACString &amp;aHost)</span>
<a href="#l9.130"></a><span id="l9.130"> {</span>
<a href="#l9.131"></a><span id="l9.131">   return m_baseURL-&gt;GetHost(aHost);</span>
<a href="#l9.132"></a><span id="l9.132"> }</span>
<a href="#l9.133"></a><span id="l9.133"> </span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l9.136"></a><span id="l9.136"> {</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-  return m_baseURL-&gt;SetHost(aHost);</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetHost(aHost).Finalize(m_baseURL);</span>
<a href="#l9.139"></a><span id="l9.139"> }</span>
<a href="#l9.140"></a><span id="l9.140"> </span>
<a href="#l9.141"></a><span id="l9.141"> NS_IMETHODIMP nsMsgMailNewsUrl::GetPort(int32_t *aPort)</span>
<a href="#l9.142"></a><span id="l9.142"> {</span>
<a href="#l9.143"></a><span id="l9.143">   return m_baseURL-&gt;GetPort(aPort);</span>
<a href="#l9.144"></a><span id="l9.144"> }</span>
<a href="#l9.145"></a><span id="l9.145"> </span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetPort(int32_t aPort)</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetPort(int32_t aPort)</span>
<a href="#l9.148"></a><span id="l9.148"> {</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-  return m_baseURL-&gt;SetPort(aPort);</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetPort(aPort).Finalize(m_baseURL);</span>
<a href="#l9.151"></a><span id="l9.151"> }</span>
<a href="#l9.152"></a><span id="l9.152"> </span>
<a href="#l9.153"></a><span id="l9.153"> NS_IMETHODIMP nsMsgMailNewsUrl::GetPathQueryRef(nsACString &amp;aPath)</span>
<a href="#l9.154"></a><span id="l9.154"> {</span>
<a href="#l9.155"></a><span id="l9.155">   return m_baseURL-&gt;GetPathQueryRef(aPath);</span>
<a href="#l9.156"></a><span id="l9.156"> }</span>
<a href="#l9.157"></a><span id="l9.157"> </span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l9.160"></a><span id="l9.160"> {</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-  return m_baseURL-&gt;SetPathQueryRef(aPath);</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l9.163"></a><span id="l9.163"> }</span>
<a href="#l9.164"></a><span id="l9.164"> </span>
<a href="#l9.165"></a><span id="l9.165"> NS_IMETHODIMP nsMsgMailNewsUrl::GetAsciiHost(nsACString &amp;aHostA)</span>
<a href="#l9.166"></a><span id="l9.166"> {</span>
<a href="#l9.167"></a><span id="l9.167">     return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l9.168"></a><span id="l9.168"> }</span>
<a href="#l9.169"></a><span id="l9.169"> </span>
<a href="#l9.170"></a><span id="l9.170"> NS_IMETHODIMP nsMsgMailNewsUrl::GetAsciiHostPort(nsACString &amp;aHostPortA)</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineat">@@ -617,36 +614,38 @@ nsMsgMailNewsUrl::CloneInternal(uint32_t</span>
<a href="#l9.172"></a><span id="l9.172"> {</span>
<a href="#l9.173"></a><span id="l9.173">   nsresult rv;</span>
<a href="#l9.174"></a><span id="l9.174">   nsAutoCString urlSpec;</span>
<a href="#l9.175"></a><span id="l9.175">   nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l9.176"></a><span id="l9.176">     mozilla::services::GetIOService();</span>
<a href="#l9.177"></a><span id="l9.177">   NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l9.178"></a><span id="l9.178">   rv = GetSpec(urlSpec);</span>
<a href="#l9.179"></a><span id="l9.179">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-  rv = ioService-&gt;NewURI(urlSpec, nullptr, nullptr, _retval);</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+  rv = ioService-&gt;NewURI(urlSpec, nullptr, nullptr, getter_AddRefs(newUri));</span>
<a href="#l9.183"></a><span id="l9.183">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.184"></a><span id="l9.184"> </span>
<a href="#l9.185"></a><span id="l9.185">   // add the msg window to the cloned url</span>
<a href="#l9.186"></a><span id="l9.186">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l9.187"></a><span id="l9.187">   if (msgWindow)</span>
<a href="#l9.188"></a><span id="l9.188">   {</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgMailNewsUrl = do_QueryInterface(*_retval, &amp;rv);</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgMailNewsUrl = do_QueryInterface(newUri, &amp;rv);</span>
<a href="#l9.191"></a><span id="l9.191">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.192"></a><span id="l9.192">     msgMailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l9.193"></a><span id="l9.193">   }</span>
<a href="#l9.194"></a><span id="l9.194"> </span>
<a href="#l9.195"></a><span id="l9.195">   if (aRefHandlingMode == nsIMsgMailNewsUrl::REPLACE_REF) {</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-    rv = (*_retval)-&gt;SetRef(newRef);</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+    rv = NS_MutateURI(newUri).SetRef(newRef).Finalize(newUri);</span>
<a href="#l9.198"></a><span id="l9.198">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.199"></a><span id="l9.199">   } else if (aRefHandlingMode == nsIMsgMailNewsUrl::IGNORE_REF) {</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-    rv = (*_retval)-&gt;SetRef(EmptyCString());</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+    rv = NS_MutateURI(newUri).SetRef(EmptyCString()).Finalize(newUri);</span>
<a href="#l9.202"></a><span id="l9.202">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.203"></a><span id="l9.203">   }</span>
<a href="#l9.204"></a><span id="l9.204"> </span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+  newUri.forget(_retval);</span>
<a href="#l9.206"></a><span id="l9.206">   return rv;</span>
<a href="#l9.207"></a><span id="l9.207"> }</span>
<a href="#l9.208"></a><span id="l9.208"> </span>
<a href="#l9.209"></a><span id="l9.209"> NS_IMETHODIMP nsMsgMailNewsUrl::Clone(nsIURI **_retval)</span>
<a href="#l9.210"></a><span id="l9.210"> {</span>
<a href="#l9.211"></a><span id="l9.211">   return CloneInternal(nsIMsgMailNewsUrl::HONOR_REF, EmptyCString(), _retval);</span>
<a href="#l9.212"></a><span id="l9.212"> }</span>
<a href="#l9.213"></a><span id="l9.213"> </span>
<a href="#l9.214"></a><span id="l9.214" class="difflineat">@@ -740,45 +739,44 @@ nsresult nsMsgMailNewsUrl::SetFileNameIn</span>
<a href="#l9.215"></a><span id="l9.215">   return NS_OK;</span>
<a href="#l9.216"></a><span id="l9.216"> }</span>
<a href="#l9.217"></a><span id="l9.217"> </span>
<a href="#l9.218"></a><span id="l9.218"> NS_IMETHODIMP nsMsgMailNewsUrl::GetQuery(nsACString &amp;aQuery)</span>
<a href="#l9.219"></a><span id="l9.219"> {</span>
<a href="#l9.220"></a><span id="l9.220">   return m_baseURL-&gt;GetQuery(aQuery);</span>
<a href="#l9.221"></a><span id="l9.221"> }</span>
<a href="#l9.222"></a><span id="l9.222"> </span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l9.225"></a><span id="l9.225"> {</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-  return m_baseURL-&gt;SetQuery(aQuery);</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetQuery(aQuery).Finalize(m_baseURL);</span>
<a href="#l9.228"></a><span id="l9.228"> }</span>
<a href="#l9.229"></a><span id="l9.229"> </span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-nsMsgMailNewsUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l9.233"></a><span id="l9.233"> {</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-  return m_baseURL-&gt;SetQueryWithEncoding(aQuery, aEncoding);</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetQueryWithEncoding(aQuery, aEncoding).Finalize(m_baseURL);</span>
<a href="#l9.236"></a><span id="l9.236"> }</span>
<a href="#l9.237"></a><span id="l9.237"> </span>
<a href="#l9.238"></a><span id="l9.238"> NS_IMETHODIMP nsMsgMailNewsUrl::GetRef(nsACString &amp;aRef)</span>
<a href="#l9.239"></a><span id="l9.239"> {</span>
<a href="#l9.240"></a><span id="l9.240">   return m_baseURL-&gt;GetRef(aRef);</span>
<a href="#l9.241"></a><span id="l9.241"> }</span>
<a href="#l9.242"></a><span id="l9.242"> </span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l9.245"></a><span id="l9.245"> {</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-  return m_baseURL-&gt;SetRef(aRef);</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetRef(aRef).Finalize(m_baseURL);</span>
<a href="#l9.248"></a><span id="l9.248"> }</span>
<a href="#l9.249"></a><span id="l9.249"> </span>
<a href="#l9.250"></a><span id="l9.250"> NS_IMETHODIMP nsMsgMailNewsUrl::GetFilePath(nsACString &amp;o_DirFile)</span>
<a href="#l9.251"></a><span id="l9.251"> {</span>
<a href="#l9.252"></a><span id="l9.252">   return m_baseURL-&gt;GetFilePath(o_DirFile);</span>
<a href="#l9.253"></a><span id="l9.253"> }</span>
<a href="#l9.254"></a><span id="l9.254"> </span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetFilePath(const nsACString &amp;i_DirFile)</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetFilePath(const nsACString &amp;i_DirFile)</span>
<a href="#l9.257"></a><span id="l9.257"> {</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-  return m_baseURL-&gt;SetFilePath(i_DirFile);</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetFilePath(i_DirFile).Finalize(m_baseURL);</span>
<a href="#l9.260"></a><span id="l9.260"> }</span>
<a href="#l9.261"></a><span id="l9.261"> </span>
<a href="#l9.262"></a><span id="l9.262"> NS_IMETHODIMP nsMsgMailNewsUrl::GetCommonBaseSpec(nsIURI *uri2, nsACString &amp;result)</span>
<a href="#l9.263"></a><span id="l9.263"> {</span>
<a href="#l9.264"></a><span id="l9.264">   return m_baseURL-&gt;GetCommonBaseSpec(uri2, result);</span>
<a href="#l9.265"></a><span id="l9.265"> }</span>
<a href="#l9.266"></a><span id="l9.266"> </span>
<a href="#l9.267"></a><span id="l9.267"> NS_IMETHODIMP nsMsgMailNewsUrl::GetRelativeSpec(nsIURI *uri2, nsACString &amp;result)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -45,16 +45,30 @@ public:</span>
<a href="#l10.4"></a><span id="l10.4">     nsMsgMailNewsUrl();</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">     NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l10.7"></a><span id="l10.7">     NS_DECL_NSIMSGMAILNEWSURL</span>
<a href="#l10.8"></a><span id="l10.8">     NS_DECL_NSIURI</span>
<a href="#l10.9"></a><span id="l10.9">     NS_DECL_NSIURL</span>
<a href="#l10.10"></a><span id="l10.10">     NS_DECL_NSIURIWITHPRINCIPAL</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+protected:</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  virtual nsresult SetScheme(const nsACString &amp;aScheme);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  virtual nsresult SetUserPass(const nsACString &amp;aUserPass);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  virtual nsresult SetUsername(const nsACString &amp;aUsername);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+  virtual nsresult SetPassword(const nsACString &amp;aPassword);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  virtual nsresult SetHostPort(const nsACString &amp;aHostPort);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  virtual nsresult SetHost(const nsACString &amp;aHost);</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+  virtual nsresult SetPort(int32_t aPort);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  virtual nsresult SetPathQueryRef(const nsACString &amp;aPath);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  virtual nsresult SetRef(const nsACString &amp;aRef);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+  virtual nsresult SetFilePath(const nsACString &amp;aFilePath);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  virtual nsresult SetQuery(const nsACString &amp;aQuery);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+</span>
<a href="#l10.26"></a><span id="l10.26"> public:</span>
<a href="#l10.27"></a><span id="l10.27">   class Mutator</span>
<a href="#l10.28"></a><span id="l10.28">       : public nsIURIMutator</span>
<a href="#l10.29"></a><span id="l10.29">       , public BaseURIMutator&lt;nsMsgMailNewsUrl&gt;</span>
<a href="#l10.30"></a><span id="l10.30">   {</span>
<a href="#l10.31"></a><span id="l10.31">     NS_DECL_ISUPPORTS</span>
<a href="#l10.32"></a><span id="l10.32">     NS_FORWARD_SAFE_NSIURISETTERS_RET(mURI)</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34" class="difflineat">@@ -71,26 +85,28 @@ public:</span>
<a href="#l10.35"></a><span id="l10.35">     NS_IMETHOD Finalize(nsIURI** aURI) override</span>
<a href="#l10.36"></a><span id="l10.36">     {</span>
<a href="#l10.37"></a><span id="l10.37">       mURI.forget(aURI);</span>
<a href="#l10.38"></a><span id="l10.38">       return NS_OK;</span>
<a href="#l10.39"></a><span id="l10.39">     }</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41">     NS_IMETHOD SetSpec(const nsACString &amp; aSpec, nsIURIMutator** aMutator) override</span>
<a href="#l10.42"></a><span id="l10.42">     {</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-      NS_ADDREF(*aMutator = this);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+      if (aMutator)</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+        NS_ADDREF(*aMutator = this);</span>
<a href="#l10.46"></a><span id="l10.46">       return InitFromSpec(aSpec);</span>
<a href="#l10.47"></a><span id="l10.47">     }</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49">     explicit Mutator() { }</span>
<a href="#l10.50"></a><span id="l10.50">   private:</span>
<a href="#l10.51"></a><span id="l10.51">     virtual ~Mutator() { }</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">     friend class nsMsgMailNewsUrl;</span>
<a href="#l10.54"></a><span id="l10.54">   };</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  friend BaseURIMutator&lt;nsMsgMailNewsUrl&gt;;</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57"> protected:</span>
<a href="#l10.58"></a><span id="l10.58">   virtual ~nsMsgMailNewsUrl();</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60">   nsCOMPtr&lt;nsIURL&gt; m_baseURL;</span>
<a href="#l10.61"></a><span id="l10.61">   nsCOMPtr&lt;nsIPrincipal&gt; m_principal;</span>
<a href="#l10.62"></a><span id="l10.62">   nsWeakPtr m_statusFeedbackWeak;</span>
<a href="#l10.63"></a><span id="l10.63">   nsWeakPtr m_msgWindowWeak;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -73,16 +73,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIDocumentEncoder.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;locale.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsStringStream.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIInputStreamPump.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> /* for logging to Error Console */</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsIScriptError.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsIConsoleService.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> // Log an error string to the error console</span>
<a href="#l11.19"></a><span id="l11.19"> // (adapted from nsContentUtils::LogSimpleConsoleError).</span>
<a href="#l11.20"></a><span id="l11.20"> // Flag can indicate error, warning or info.</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -173,40 +174,43 @@ nsresult CreateStartupUrl(const char *ur</span>
<a href="#l11.22"></a><span id="l11.22">   if (!uri || !*uri || !aUrl) return rv;</span>
<a href="#l11.23"></a><span id="l11.23">   *aUrl = nullptr;</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">   // XXX fix this, so that base doesn't depend on imap, local or news.</span>
<a href="#l11.26"></a><span id="l11.26">   // we can't do NS_NewURI(uri, aUrl), because these are imap-message://, mailbox-message://, news-message:// uris.</span>
<a href="#l11.27"></a><span id="l11.27">   // I think we should do something like GetMessageServiceFromURI() to get the service, and then have the service create the</span>
<a href="#l11.28"></a><span id="l11.28">   // appropriate nsI*Url, and then QI to nsIURI, and return it.</span>
<a href="#l11.29"></a><span id="l11.29">   // see bug #110689</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; newUri;</span>
<a href="#l11.31"></a><span id="l11.31">   if (PL_strncasecmp(uri, &quot;imap&quot;, 4) == 0)</span>
<a href="#l11.32"></a><span id="l11.32">   {</span>
<a href="#l11.33"></a><span id="l11.33">     nsCOMPtr&lt;nsIImapUrl&gt; imapUrl = do_CreateInstance(kImapUrlCID, &amp;rv);</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35">     if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-      rv = imapUrl-&gt;QueryInterface(NS_GET_IID(nsIURI),</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-      (void**) aUrl);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+      rv = imapUrl-&gt;QueryInterface(NS_GET_IID(nsIMsgMailNewsUrl), getter_AddRefs(newUri));</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    // XXX Consider: NS_MutateURI(new nsImapUrl::Mutator()).SetSpec(nsDependentCString(uri)).Finalize(newUri);</span>
<a href="#l11.41"></a><span id="l11.41">   }</span>
<a href="#l11.42"></a><span id="l11.42">   else if (PL_strncasecmp(uri, &quot;mailbox&quot;, 7) == 0)</span>
<a href="#l11.43"></a><span id="l11.43">   {</span>
<a href="#l11.44"></a><span id="l11.44">     nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl = do_CreateInstance(kCMailboxUrl, &amp;rv);</span>
<a href="#l11.45"></a><span id="l11.45">     if (NS_SUCCEEDED(rv) &amp;&amp; mailboxUrl)</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-      rv = mailboxUrl-&gt;QueryInterface(NS_GET_IID(nsIURI),</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-      (void**) aUrl);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+      rv = mailboxUrl-&gt;QueryInterface(NS_GET_IID(nsIMsgMailNewsUrl), getter_AddRefs(newUri));</span>
<a href="#l11.49"></a><span id="l11.49">   }</span>
<a href="#l11.50"></a><span id="l11.50">   else if (PL_strncasecmp(uri, &quot;news&quot;, 4) == 0)</span>
<a href="#l11.51"></a><span id="l11.51">   {</span>
<a href="#l11.52"></a><span id="l11.52">     nsCOMPtr&lt;nsINntpUrl&gt; nntpUrl = do_CreateInstance(kCNntpUrlCID, &amp;rv);</span>
<a href="#l11.53"></a><span id="l11.53">     if (NS_SUCCEEDED(rv) &amp;&amp; nntpUrl)</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-      rv = nntpUrl-&gt;QueryInterface(NS_GET_IID(nsIURI),</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-      (void**) aUrl);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+      rv = nntpUrl-&gt;QueryInterface(NS_GET_IID(nsIMsgMailNewsUrl), getter_AddRefs(newUri));</span>
<a href="#l11.57"></a><span id="l11.57">   }</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+</span>
<a href="#l11.59"></a><span id="l11.59">   if (*aUrl) // SetSpec can fail, for mailbox urls, but we still have a url.</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    (void)(*aUrl)-&gt;SetSpecInternal(nsDependentCString(uri));</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    (void)newUri-&gt;SetSpecInternal(nsDependentCString(uri));</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  newUri.forget(aUrl);</span>
<a href="#l11.64"></a><span id="l11.64">   return rv;</span>
<a href="#l11.65"></a><span id="l11.65"> }</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68"> // Where should this live? It's a utility used to convert a string priority,</span>
<a href="#l11.69"></a><span id="l11.69"> //  e.g., &quot;High, Low, Normal&quot; to an enum.</span>
<a href="#l11.70"></a><span id="l11.70"> // Perhaps we should have an interface that groups together all these</span>
<a href="#l11.71"></a><span id="l11.71"> //  utilities...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -45,16 +45,18 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsContentCID.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsISelection.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsUTF8Utils.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;mozilla/intl/LineBreaker.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsIArray.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#include &quot;mozilla/Unused.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l12.20"></a><span id="l12.20"> #endif</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -1326,17 +1328,17 @@ nsMsgComposeService::RunMessageThroughMi</span>
<a href="#l12.23"></a><span id="l12.23">   if (fileUrl || PromiseFlatCString(aMsgURI).Find(&quot;&amp;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l12.24"></a><span id="l12.24">     rv = NS_NewURI(getter_AddRefs(url), mailboxUri);</span>
<a href="#l12.25"></a><span id="l12.25">   else</span>
<a href="#l12.26"></a><span id="l12.26">     rv = messageService-&gt;GetUrlForUri(PromiseFlatCString(aMsgURI).get(), getter_AddRefs(url), aMsgWindow);</span>
<a href="#l12.27"></a><span id="l12.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">   // ignore errors here - it's not fatal, and in the case of mailbox messages,</span>
<a href="#l12.30"></a><span id="l12.30">   // we're always passing in an invalid spec...</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  (void)url-&gt;SetSpecInternal(mailboxUri);</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  mozilla::Unused &lt;&lt; NS_MutateURI(url).SetSpec(mailboxUri).Finalize(url);</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34">   // if we are forwarding a message and that message used a charset over ride</span>
<a href="#l12.35"></a><span id="l12.35">   // then use that over ride charset instead of the charset specified in the message</span>
<a href="#l12.36"></a><span id="l12.36">   nsCString mailCharset;</span>
<a href="#l12.37"></a><span id="l12.37">   if (aMsgWindow)</span>
<a href="#l12.38"></a><span id="l12.38">   {</span>
<a href="#l12.39"></a><span id="l12.39">     bool charsetOverride;</span>
<a href="#l12.40"></a><span id="l12.40">     if (NS_SUCCEEDED(aMsgWindow-&gt;GetCharsetOverride(&amp;charsetOverride)) &amp;&amp; charsetOverride)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -109,58 +109,55 @@ nsMsgQuote::QuoteMessage(const char *msg</span>
<a href="#l13.4"></a><span id="l13.4">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">   mQuoteHeaders = quoteHeaders;</span>
<a href="#l13.7"></a><span id="l13.7">   mStreamListener = aQuoteMsgStreamListener;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">   nsAutoCString msgUri(msgURI);</span>
<a href="#l13.10"></a><span id="l13.10">   bool fileUrl = !strncmp(msgURI, &quot;file:&quot;, 5);</span>
<a href="#l13.11"></a><span id="l13.11">   bool forwardedMessage = PL_strstr(msgURI, &quot;&amp;realtype=message/rfc822&quot;) != nullptr;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; aURL;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; newURI;</span>
<a href="#l13.14"></a><span id="l13.14">   if (fileUrl)</span>
<a href="#l13.15"></a><span id="l13.15">   {</span>
<a href="#l13.16"></a><span id="l13.16">     msgUri.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l13.17"></a><span id="l13.17">     msgUri.AppendLiteral(&quot;?number=0&quot;);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-    rv = NS_NewURI(getter_AddRefs(aURL), msgUri);</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMessageUrl&gt; mailUrl(do_QueryInterface(aURL));</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+    rv = NS_NewURI(getter_AddRefs(newURI), msgUri);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMessageUrl&gt; mailUrl(do_QueryInterface(newURI));</span>
<a href="#l13.22"></a><span id="l13.22">     if (mailUrl)</span>
<a href="#l13.23"></a><span id="l13.23">       mailUrl-&gt;SetMessageHeader(aMsgHdr);</span>
<a href="#l13.24"></a><span id="l13.24">   }</span>
<a href="#l13.25"></a><span id="l13.25">   else if (forwardedMessage)</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-    rv = NS_NewURI(getter_AddRefs(aURL), msgURI);</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+    rv = NS_NewURI(getter_AddRefs(newURI), msgURI);</span>
<a href="#l13.28"></a><span id="l13.28">   else</span>
<a href="#l13.29"></a><span id="l13.29">   {</span>
<a href="#l13.30"></a><span id="l13.30">     nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l13.31"></a><span id="l13.31">     rv = GetMessageServiceFromURI(nsDependentCString(msgURI), getter_AddRefs(msgService));</span>
<a href="#l13.32"></a><span id="l13.32">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    rv = msgService-&gt;GetUrlForUri(msgURI, getter_AddRefs(aURL), nullptr);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+    rv = msgService-&gt;GetUrlForUri(msgURI, getter_AddRefs(newURI), nullptr);</span>
<a href="#l13.35"></a><span id="l13.35">   }</span>
<a href="#l13.36"></a><span id="l13.36">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  nsCOMPtr &lt;nsIURL&gt; mailNewsUrl = do_QueryInterface(aURL, &amp;rv);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-</span>
<a href="#l13.41"></a><span id="l13.41">   nsAutoCString queryPart;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  rv = mailNewsUrl-&gt;GetQuery(queryPart);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  rv = newURI-&gt;GetQuery(queryPart);</span>
<a href="#l13.44"></a><span id="l13.44">   if (!queryPart.IsEmpty())</span>
<a href="#l13.45"></a><span id="l13.45">     queryPart.Append('&amp;');</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47">   if (headersOnly) /* We don't need to quote the message body but we still need to extract the headers */</span>
<a href="#l13.48"></a><span id="l13.48">     queryPart.AppendLiteral(&quot;header=only&quot;);</span>
<a href="#l13.49"></a><span id="l13.49">   else if (quoteHeaders)</span>
<a href="#l13.50"></a><span id="l13.50">     queryPart.AppendLiteral(&quot;header=quote&quot;);</span>
<a href="#l13.51"></a><span id="l13.51">   else</span>
<a href="#l13.52"></a><span id="l13.52">     queryPart.AppendLiteral(&quot;header=quotebody&quot;);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-  rv = mailNewsUrl-&gt;SetQuery(queryPart);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  rv = NS_MutateURI(newURI).SetQuery(queryPart).Finalize(newURI);</span>
<a href="#l13.55"></a><span id="l13.55">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57">   // if we were given a non empty charset, then use it</span>
<a href="#l13.58"></a><span id="l13.58">   if (aMsgCharSet &amp;&amp; *aMsgCharSet)</span>
<a href="#l13.59"></a><span id="l13.59">   {</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-    nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nUrl (do_QueryInterface(aURL));</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+    nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nUrl (do_QueryInterface(newURI));</span>
<a href="#l13.62"></a><span id="l13.62">     if (i18nUrl)</span>
<a href="#l13.63"></a><span id="l13.63">       i18nUrl-&gt;SetCharsetOverRide(aMsgCharSet);</span>
<a href="#l13.64"></a><span id="l13.64">   }</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">   mQuoteListener = do_CreateInstance(NS_MSGQUOTELISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l13.67"></a><span id="l13.67">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.68"></a><span id="l13.68">   mQuoteListener-&gt;SetMsgQuote(this);</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70" class="difflineat">@@ -169,26 +166,26 @@ nsMsgQuote::QuoteMessage(const char *msg</span>
<a href="#l13.71"></a><span id="l13.71">   QueryInterface(NS_GET_IID(nsISupports), (void **) &amp;supports);</span>
<a href="#l13.72"></a><span id="l13.72">   nsCOMPtr&lt;nsISupports&gt; quoteSupport = supports;</span>
<a href="#l13.73"></a><span id="l13.73">   NS_IF_RELEASE(supports);</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75">   // now we want to create a necko channel for this url and we want to open it</span>
<a href="#l13.76"></a><span id="l13.76">   mQuoteChannel = nullptr;</span>
<a href="#l13.77"></a><span id="l13.77">   nsCOMPtr&lt;nsIIOService&gt; netService = mozilla::services::GetIOService();</span>
<a href="#l13.78"></a><span id="l13.78">   NS_ENSURE_TRUE(netService, NS_ERROR_UNEXPECTED);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-  rv = netService-&gt;NewChannelFromURI2(aURL,</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+  rv = netService-&gt;NewChannelFromURI2(newURI,</span>
<a href="#l13.81"></a><span id="l13.81">                                       nullptr,</span>
<a href="#l13.82"></a><span id="l13.82">                                       nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l13.83"></a><span id="l13.83">                                       nullptr,</span>
<a href="#l13.84"></a><span id="l13.84">                                       nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l13.85"></a><span id="l13.85">                                       nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l13.86"></a><span id="l13.86">                                       getter_AddRefs(mQuoteChannel));</span>
<a href="#l13.87"></a><span id="l13.87"> </span>
<a href="#l13.88"></a><span id="l13.88">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; ctxt = do_QueryInterface(aURL);</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; ctxt = do_QueryInterface(newURI);</span>
<a href="#l13.91"></a><span id="l13.91"> </span>
<a href="#l13.92"></a><span id="l13.92">   nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverterService =</span>
<a href="#l13.93"></a><span id="l13.93">            do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv);</span>
<a href="#l13.94"></a><span id="l13.94">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96">   nsCOMPtr&lt;nsIStreamListener&gt; convertedListener;</span>
<a href="#l13.97"></a><span id="l13.97">   rv = streamConverterService-&gt;AsyncConvertData(&quot;message/rfc822&quot;,</span>
<a href="#l13.98"></a><span id="l13.98">                                                 &quot;application/vnd.mozilla.xul+xml&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -2072,17 +2072,17 @@ nsMsgComposeAndSend::AddCompFieldLocalAt</span>
<a href="#l14.4"></a><span id="l14.4">                   if (!type.EqualsLiteral(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span>
<a href="#l14.5"></a><span id="l14.5"> #endif</span>
<a href="#l14.6"></a><span id="l14.6">                   m_attachments[newLoc]-&gt;m_type = type;</span>
<a href="#l14.7"></a><span id="l14.7">                 }</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9">                 //Then try using the url if we still haven't figured out the content type</span>
<a href="#l14.10"></a><span id="l14.10">                 if (m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l14.11"></a><span id="l14.11">                 {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                  rv = fileUrl-&gt;SetSpecInternal(url);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+                  rv = NS_MutateURI(fileUrl).SetSpec(url).Finalize(fileUrl);</span>
<a href="#l14.14"></a><span id="l14.14">                   if (NS_SUCCEEDED(rv))</span>
<a href="#l14.15"></a><span id="l14.15">                   {</span>
<a href="#l14.16"></a><span id="l14.16">                     rv = fileUrl-&gt;GetFileExtension(fileExt);</span>
<a href="#l14.17"></a><span id="l14.17">                     if (NS_SUCCEEDED(rv) &amp;&amp; !fileExt.IsEmpty()) {</span>
<a href="#l14.18"></a><span id="l14.18">                       nsAutoCString type;</span>
<a href="#l14.19"></a><span id="l14.19">                       mimeFinder-&gt;GetTypeFromExtension(fileExt, type);</span>
<a href="#l14.20"></a><span id="l14.20">   #ifndef XP_MACOSX</span>
<a href="#l14.21"></a><span id="l14.21">                     if (!type.EqualsLiteral(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -42,17 +42,16 @@ typedef struct _findServerByKeyEntry {</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> typedef struct _findServerByHostnameEntry {</span>
<a href="#l15.6"></a><span id="l15.6">     nsCString hostname;</span>
<a href="#l15.7"></a><span id="l15.7">     nsCString username;</span>
<a href="#l15.8"></a><span id="l15.8">     nsISmtpServer *server;</span>
<a href="#l15.9"></a><span id="l15.9"> } findServerByHostnameEntry;</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> static NS_DEFINE_CID(kCSmtpUrlCID, NS_SMTPURL_CID);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-static NS_DEFINE_CID(kCMailtoUrlCID, NS_MAILTOURL_CID);</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14"> // foward declarations...</span>
<a href="#l15.15"></a><span id="l15.15"> nsresult</span>
<a href="#l15.16"></a><span id="l15.16"> NS_MsgBuildSmtpUrl(nsIFile * aFilePath,</span>
<a href="#l15.17"></a><span id="l15.17">                    nsISmtpServer *aServer,</span>
<a href="#l15.18"></a><span id="l15.18">                    const char* aRecipients,</span>
<a href="#l15.19"></a><span id="l15.19">                    nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l15.20"></a><span id="l15.20">                    const char * aSender,</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -168,20 +167,20 @@ nsresult NS_MsgBuildSmtpUrl(nsIFile * aF</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23">   urlSpec.Append(smtpHostName);</span>
<a href="#l15.24"></a><span id="l15.24">   if (smtpHostName.FindChar(':') == -1)</span>
<a href="#l15.25"></a><span id="l15.25">   {</span>
<a href="#l15.26"></a><span id="l15.26">     urlSpec.Append(':');</span>
<a href="#l15.27"></a><span id="l15.27">     urlSpec.AppendInt(smtpPort);</span>
<a href="#l15.28"></a><span id="l15.28">   }</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url(do_QueryInterface(smtpUrl, &amp;rv));</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl(do_QueryInterface(smtpUrl, &amp;rv));</span>
<a href="#l15.32"></a><span id="l15.32">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  rv = url-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l15.36"></a><span id="l15.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">   smtpUrl-&gt;SetSender(aSender);</span>
<a href="#l15.39"></a><span id="l15.39">   smtpUrl-&gt;SetRecipients(aRecipients);</span>
<a href="#l15.40"></a><span id="l15.40">   smtpUrl-&gt;SetRequestDSN(aRequestDSN);</span>
<a href="#l15.41"></a><span id="l15.41">   smtpUrl-&gt;SetPostMessageFile(aFilePath);</span>
<a href="#l15.42"></a><span id="l15.42">   smtpUrl-&gt;SetSenderIdentity(aSenderIdentity);</span>
<a href="#l15.43"></a><span id="l15.43">   if (aNotificationCallbacks)</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineat">@@ -200,19 +199,19 @@ nsresult NS_MsgBuildSmtpUrl(nsIFile * aF</span>
<a href="#l15.45"></a><span id="l15.45">     if (!smtpAuthPrompt)</span>
<a href="#l15.46"></a><span id="l15.46">       wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(smtpAuthPrompt));</span>
<a href="#l15.47"></a><span id="l15.47">   }</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49">   smtpUrl-&gt;SetPrompt(smtpPrompt);</span>
<a href="#l15.50"></a><span id="l15.50">   smtpUrl-&gt;SetAuthPrompt(smtpAuthPrompt);</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52">   if (aUrlListener)</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-    url-&gt;RegisterListener(aUrlListener);</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+    mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l15.55"></a><span id="l15.55">   if (aStatusFeedback)</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-    url-&gt;SetStatusFeedback(aStatusFeedback);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+    mailnewsurl-&gt;SetStatusFeedback(aStatusFeedback);</span>
<a href="#l15.58"></a><span id="l15.58"> </span>
<a href="#l15.59"></a><span id="l15.59">   return CallQueryInterface(smtpUrl, aUrl);</span>
<a href="#l15.60"></a><span id="l15.60"> }</span>
<a href="#l15.61"></a><span id="l15.61"> </span>
<a href="#l15.62"></a><span id="l15.62"> nsresult NS_MsgLoadSmtpUrl(nsIURI * aUrl, nsISupports * aConsumer, nsIRequest ** aRequest)</span>
<a href="#l15.63"></a><span id="l15.63"> {</span>
<a href="#l15.64"></a><span id="l15.64">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66" class="difflineat">@@ -294,35 +293,40 @@ NS_IMETHODIMP nsSmtpService::GetProtocol</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68"> NS_IMETHODIMP nsSmtpService::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l15.69"></a><span id="l15.69">                                     const char *aOriginCharset,</span>
<a href="#l15.70"></a><span id="l15.70">                                     nsIURI *aBaseURI,</span>
<a href="#l15.71"></a><span id="l15.71">                                     nsIURI **_retval)</span>
<a href="#l15.72"></a><span id="l15.72"> {</span>
<a href="#l15.73"></a><span id="l15.73">   // get a new smtp url</span>
<a href="#l15.74"></a><span id="l15.74">   nsresult rv;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; mailtoUrl = do_CreateInstance(kCMailtoUrlCID, &amp;rv);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.77"></a><span id="l15.77"> </span>
<a href="#l15.78"></a><span id="l15.78">   nsAutoCString utf8Spec;</span>
<a href="#l15.79"></a><span id="l15.79">   if (aOriginCharset)</span>
<a href="#l15.80"></a><span id="l15.80">   {</span>
<a href="#l15.81"></a><span id="l15.81">     nsCOMPtr&lt;nsIUTF8ConverterService&gt;</span>
<a href="#l15.82"></a><span id="l15.82">       utf8Converter(do_GetService(NS_UTF8CONVERTERSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.83"></a><span id="l15.83">     if (NS_SUCCEEDED(rv))</span>
<a href="#l15.84"></a><span id="l15.84">       rv = utf8Converter-&gt;ConvertURISpecToUTF8(aSpec, aOriginCharset, utf8Spec);</span>
<a href="#l15.85"></a><span id="l15.85">   }</span>
<a href="#l15.86"></a><span id="l15.86"> </span>
<a href="#l15.87"></a><span id="l15.87">   // utf8Spec is filled up only when aOriginCharset is specified and</span>
<a href="#l15.88"></a><span id="l15.88">   // the conversion is successful. Otherwise, fall back to aSpec.</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-  if (aOriginCharset &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-    rv = mailtoUrl-&gt;SetSpecInternal(utf8Spec);</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-  else</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-    rv = mailtoUrl-&gt;SetSpecInternal(aSpec);</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; mailtoUrl;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+  if (aOriginCharset &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+    rv = NS_MutateURI(new nsMailtoUrl::Mutator())</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+           .SetSpec(utf8Spec)</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+           .Finalize(mailtoUrl);</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+  } else {</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+    rv = NS_MutateURI(new nsMailtoUrl::Mutator())</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+           .SetSpec(aSpec)</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+           .Finalize(mailtoUrl);</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+  }</span>
<a href="#l15.106"></a><span id="l15.106"> </span>
<a href="#l15.107"></a><span id="l15.107">   mailtoUrl.forget(_retval);</span>
<a href="#l15.108"></a><span id="l15.108">   return NS_OK;</span>
<a href="#l15.109"></a><span id="l15.109"> }</span>
<a href="#l15.110"></a><span id="l15.110"> </span>
<a href="#l15.111"></a><span id="l15.111"> NS_IMETHODIMP nsSmtpService::NewChannel(nsIURI *aURI, nsIChannel **_retval)</span>
<a href="#l15.112"></a><span id="l15.112"> {</span>
<a href="#l15.113"></a><span id="l15.113">   return NewChannel2(aURI, nullptr, _retval);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -260,17 +260,17 @@ nsresult nsMailtoUrl::ParseMailtoUrl(cha</span>
<a href="#l16.4"></a><span id="l16.4">     }</span>
<a href="#l16.5"></a><span id="l16.5">   }</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">   return NS_OK;</span>
<a href="#l16.8"></a><span id="l16.8"> }</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> nsresult nsMailtoUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l16.11"></a><span id="l16.11"> {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  nsresult rv = m_baseURL-&gt;SetSpecInternal(aSpec);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetSpec(aSpec).Finalize(m_baseURL);</span>
<a href="#l16.14"></a><span id="l16.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.15"></a><span id="l16.15">   return ParseUrl();</span>
<a href="#l16.16"></a><span id="l16.16"> }</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> nsresult nsMailtoUrl::CleanupMailtoState()</span>
<a href="#l16.19"></a><span id="l16.19"> {</span>
<a href="#l16.20"></a><span id="l16.20">     m_ccPart = &quot;&quot;;</span>
<a href="#l16.21"></a><span id="l16.21">     m_subjectPart = &quot;&quot;;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -395,102 +395,104 @@ NS_IMETHODIMP nsMailtoUrl::GetPrePath(ns</span>
<a href="#l16.23"></a><span id="l16.23"> 	return m_baseURL-&gt;GetPrePath(aPrePath);</span>
<a href="#l16.24"></a><span id="l16.24"> }</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26"> NS_IMETHODIMP nsMailtoUrl::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l16.27"></a><span id="l16.27"> {</span>
<a href="#l16.28"></a><span id="l16.28"> 	return m_baseURL-&gt;GetScheme(aScheme);</span>
<a href="#l16.29"></a><span id="l16.29"> }</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+nsresult nsMailtoUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l16.33"></a><span id="l16.33"> {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-	m_baseURL-&gt;SetScheme(aScheme);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetScheme(aScheme).Finalize(m_baseURL);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.37"></a><span id="l16.37"> 	return ParseUrl();</span>
<a href="#l16.38"></a><span id="l16.38"> }</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40"> NS_IMETHODIMP nsMailtoUrl::GetUserPass(nsACString &amp;aUserPass)</span>
<a href="#l16.41"></a><span id="l16.41"> {</span>
<a href="#l16.42"></a><span id="l16.42"> 	return m_baseURL-&gt;GetUserPass(aUserPass);</span>
<a href="#l16.43"></a><span id="l16.43"> }</span>
<a href="#l16.44"></a><span id="l16.44"> </span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+nsresult nsMailtoUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l16.47"></a><span id="l16.47"> {</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-	m_baseURL-&gt;SetUserPass(aUserPass);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetUserPass(aUserPass).Finalize(m_baseURL);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.51"></a><span id="l16.51"> 	return ParseUrl();</span>
<a href="#l16.52"></a><span id="l16.52"> }</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54"> NS_IMETHODIMP nsMailtoUrl::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l16.55"></a><span id="l16.55"> {</span>
<a href="#l16.56"></a><span id="l16.56"> 	return m_baseURL-&gt;GetUsername(aUsername);</span>
<a href="#l16.57"></a><span id="l16.57"> }</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+nsresult nsMailtoUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l16.61"></a><span id="l16.61"> {</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-	m_baseURL-&gt;SetUsername(aUsername);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.65"></a><span id="l16.65"> 	return ParseUrl();</span>
<a href="#l16.66"></a><span id="l16.66"> }</span>
<a href="#l16.67"></a><span id="l16.67"> </span>
<a href="#l16.68"></a><span id="l16.68"> NS_IMETHODIMP nsMailtoUrl::GetPassword(nsACString &amp;aPassword)</span>
<a href="#l16.69"></a><span id="l16.69"> {</span>
<a href="#l16.70"></a><span id="l16.70"> 	return m_baseURL-&gt;GetPassword(aPassword);</span>
<a href="#l16.71"></a><span id="l16.71"> }</span>
<a href="#l16.72"></a><span id="l16.72"> </span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+nsresult nsMailtoUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l16.75"></a><span id="l16.75"> {</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-	m_baseURL-&gt;SetPassword(aPassword);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetPassword(aPassword).Finalize(m_baseURL);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.79"></a><span id="l16.79"> 	return ParseUrl();</span>
<a href="#l16.80"></a><span id="l16.80"> }</span>
<a href="#l16.81"></a><span id="l16.81"> </span>
<a href="#l16.82"></a><span id="l16.82"> NS_IMETHODIMP nsMailtoUrl::GetHostPort(nsACString &amp;aHostPort)</span>
<a href="#l16.83"></a><span id="l16.83"> {</span>
<a href="#l16.84"></a><span id="l16.84"> 	return m_baseURL-&gt;GetHost(aHostPort);</span>
<a href="#l16.85"></a><span id="l16.85"> }</span>
<a href="#l16.86"></a><span id="l16.86"> </span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+nsresult nsMailtoUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l16.89"></a><span id="l16.89"> {</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-	m_baseURL-&gt;SetHost(aHostPort);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-	return ParseUrl();</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-}</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetHostAndPort(const nsACString &amp;aHostPort)</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-{</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-	m_baseURL-&gt;SetHostAndPort(aHostPort);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetHostPort(aHostPort).Finalize(m_baseURL);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.99"></a><span id="l16.99"> 	return ParseUrl();</span>
<a href="#l16.100"></a><span id="l16.100"> }</span>
<a href="#l16.101"></a><span id="l16.101"> </span>
<a href="#l16.102"></a><span id="l16.102"> NS_IMETHODIMP nsMailtoUrl::GetHost(nsACString &amp;aHost)</span>
<a href="#l16.103"></a><span id="l16.103"> {</span>
<a href="#l16.104"></a><span id="l16.104"> 	return m_baseURL-&gt;GetHost(aHost);</span>
<a href="#l16.105"></a><span id="l16.105"> }</span>
<a href="#l16.106"></a><span id="l16.106"> </span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+nsresult nsMailtoUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l16.109"></a><span id="l16.109"> {</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-	m_baseURL-&gt;SetHost(aHost);</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetHost(aHost).Finalize(m_baseURL);</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.113"></a><span id="l16.113"> 	return ParseUrl();</span>
<a href="#l16.114"></a><span id="l16.114"> }</span>
<a href="#l16.115"></a><span id="l16.115"> </span>
<a href="#l16.116"></a><span id="l16.116"> NS_IMETHODIMP nsMailtoUrl::GetPort(int32_t *aPort)</span>
<a href="#l16.117"></a><span id="l16.117"> {</span>
<a href="#l16.118"></a><span id="l16.118"> 	return m_baseURL-&gt;GetPort(aPort);</span>
<a href="#l16.119"></a><span id="l16.119"> }</span>
<a href="#l16.120"></a><span id="l16.120"> </span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetPort(int32_t aPort)</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+nsresult nsMailtoUrl::SetPort(int32_t aPort)</span>
<a href="#l16.123"></a><span id="l16.123"> {</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-	m_baseURL-&gt;SetPort(aPort);</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetPort(aPort).Finalize(m_baseURL);</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.127"></a><span id="l16.127"> 	return ParseUrl();</span>
<a href="#l16.128"></a><span id="l16.128"> }</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130"> NS_IMETHODIMP nsMailtoUrl::GetPathQueryRef(nsACString &amp;aPath)</span>
<a href="#l16.131"></a><span id="l16.131"> {</span>
<a href="#l16.132"></a><span id="l16.132"> 	return m_baseURL-&gt;GetPathQueryRef(aPath);</span>
<a href="#l16.133"></a><span id="l16.133"> }</span>
<a href="#l16.134"></a><span id="l16.134"> </span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+nsresult nsMailtoUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l16.137"></a><span id="l16.137"> {</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-	m_baseURL-&gt;SetPathQueryRef(aPath);</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  nsresult rv = NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.141"></a><span id="l16.141"> 	return ParseUrl();</span>
<a href="#l16.142"></a><span id="l16.142"> }</span>
<a href="#l16.143"></a><span id="l16.143"> </span>
<a href="#l16.144"></a><span id="l16.144"> NS_IMETHODIMP nsMailtoUrl::GetAsciiHost(nsACString &amp;aHostA)</span>
<a href="#l16.145"></a><span id="l16.145"> {</span>
<a href="#l16.146"></a><span id="l16.146"> 	return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l16.147"></a><span id="l16.147"> }</span>
<a href="#l16.148"></a><span id="l16.148"> </span>
<a href="#l16.149"></a><span id="l16.149" class="difflineat">@@ -562,19 +564,19 @@ nsMailtoUrl::CloneWithNewRef(const nsACS</span>
<a href="#l16.150"></a><span id="l16.150">   return CloneInternal(eReplaceRef, newRef, _retval);</span>
<a href="#l16.151"></a><span id="l16.151"> }</span>
<a href="#l16.152"></a><span id="l16.152"> </span>
<a href="#l16.153"></a><span id="l16.153"> NS_IMETHODIMP nsMailtoUrl::Resolve(const nsACString &amp;relativePath, nsACString &amp;result)</span>
<a href="#l16.154"></a><span id="l16.154"> {</span>
<a href="#l16.155"></a><span id="l16.155">   return m_baseURL-&gt;Resolve(relativePath, result);</span>
<a href="#l16.156"></a><span id="l16.156"> }</span>
<a href="#l16.157"></a><span id="l16.157"> </span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+nsresult nsMailtoUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l16.160"></a><span id="l16.160"> {</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-  return m_baseURL-&gt;SetRef(aRef);</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetRef(aRef).Finalize(m_baseURL);</span>
<a href="#l16.163"></a><span id="l16.163"> }</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165"> NS_IMETHODIMP</span>
<a href="#l16.166"></a><span id="l16.166"> nsMailtoUrl::GetRef(nsACString &amp;result)</span>
<a href="#l16.167"></a><span id="l16.167"> {</span>
<a href="#l16.168"></a><span id="l16.168">   return m_baseURL-&gt;GetRef(result);</span>
<a href="#l16.169"></a><span id="l16.169"> }</span>
<a href="#l16.170"></a><span id="l16.170"> </span>
<a href="#l16.171"></a><span id="l16.171" class="difflineat">@@ -626,38 +628,35 @@ nsMailtoUrl::GetHasRef(bool *result)</span>
<a href="#l16.172"></a><span id="l16.172"> }</span>
<a href="#l16.173"></a><span id="l16.173"> </span>
<a href="#l16.174"></a><span id="l16.174"> NS_IMETHODIMP</span>
<a href="#l16.175"></a><span id="l16.175"> nsMailtoUrl::GetFilePath(nsACString &amp;aFilePath)</span>
<a href="#l16.176"></a><span id="l16.176"> {</span>
<a href="#l16.177"></a><span id="l16.177">   return m_baseURL-&gt;GetFilePath(aFilePath);</span>
<a href="#l16.178"></a><span id="l16.178"> }</span>
<a href="#l16.179"></a><span id="l16.179"> </span>
<a href="#l16.180"></a><span id="l16.180" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineminus">-nsMailtoUrl::SetFilePath(const nsACString &amp;aFilePath)</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+nsresult nsMailtoUrl::SetFilePath(const nsACString &amp;aFilePath)</span>
<a href="#l16.183"></a><span id="l16.183"> {</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-  return m_baseURL-&gt;SetFilePath(aFilePath);</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetFilePath(aFilePath).Finalize(m_baseURL);</span>
<a href="#l16.186"></a><span id="l16.186"> }</span>
<a href="#l16.187"></a><span id="l16.187"> </span>
<a href="#l16.188"></a><span id="l16.188"> NS_IMETHODIMP</span>
<a href="#l16.189"></a><span id="l16.189"> nsMailtoUrl::GetQuery(nsACString &amp;aQuery)</span>
<a href="#l16.190"></a><span id="l16.190"> {</span>
<a href="#l16.191"></a><span id="l16.191">   return m_baseURL-&gt;GetQuery(aQuery);</span>
<a href="#l16.192"></a><span id="l16.192"> }</span>
<a href="#l16.193"></a><span id="l16.193"> </span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-nsMailtoUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+nsresult nsMailtoUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l16.197"></a><span id="l16.197"> {</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-  return m_baseURL-&gt;SetQuery(aQuery);</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetQuery(aQuery).Finalize(m_baseURL);</span>
<a href="#l16.200"></a><span id="l16.200"> }</span>
<a href="#l16.201"></a><span id="l16.201"> </span>
<a href="#l16.202"></a><span id="l16.202" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">-nsMailtoUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+nsresult nsMailtoUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l16.205"></a><span id="l16.205"> {</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">-  return m_baseURL-&gt;SetQueryWithEncoding(aQuery, aEncoding);</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+  return NS_MutateURI(m_baseURL).SetQueryWithEncoding(aQuery, aEncoding).Finalize(m_baseURL);</span>
<a href="#l16.208"></a><span id="l16.208"> }</span>
<a href="#l16.209"></a><span id="l16.209"> </span>
<a href="#l16.210"></a><span id="l16.210"> NS_IMPL_ISUPPORTS(nsMailtoUrl::Mutator, nsIURISetters, nsIURIMutator)</span>
<a href="#l16.211"></a><span id="l16.211"> </span>
<a href="#l16.212"></a><span id="l16.212"> NS_IMETHODIMP</span>
<a href="#l16.213"></a><span id="l16.213"> nsMailtoUrl::Mutate(nsIURIMutator** aMutator)</span>
<a href="#l16.214"></a><span id="l16.214"> {</span>
<a href="#l16.215"></a><span id="l16.215">   RefPtr&lt;nsMailtoUrl::Mutator&gt; mutator = new nsMailtoUrl::Mutator();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -22,16 +22,31 @@ class nsMailtoUrl : public nsIMailtoUrl,</span>
<a href="#l17.4"></a><span id="l17.4"> {</span>
<a href="#l17.5"></a><span id="l17.5"> public:</span>
<a href="#l17.6"></a><span id="l17.6">     NS_DECL_ISUPPORTS</span>
<a href="#l17.7"></a><span id="l17.7">     NS_DECL_NSIURI</span>
<a href="#l17.8"></a><span id="l17.8">     NS_DECL_NSIMAILTOURL</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10">     nsMailtoUrl();</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+protected:</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  virtual nsresult SetSpecInternal(const nsACString &amp;aSpec);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+  virtual nsresult SetScheme(const nsACString &amp;aScheme);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+  virtual nsresult SetUserPass(const nsACString &amp;aUserPass);</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+  virtual nsresult SetUsername(const nsACString &amp;aUsername);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  virtual nsresult SetPassword(const nsACString &amp;aPassword);</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  virtual nsresult SetHostPort(const nsACString &amp;aHostPort);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+  virtual nsresult SetHost(const nsACString &amp;aHost);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  virtual nsresult SetPort(int32_t aPort);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  virtual nsresult SetPathQueryRef(const nsACString &amp;aPath);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+  virtual nsresult SetRef(const nsACString &amp;aRef);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+  virtual nsresult SetFilePath(const nsACString &amp;aFilePath);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  virtual nsresult SetQuery(const nsACString &amp;aQuery);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding);</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+</span>
<a href="#l17.27"></a><span id="l17.27"> public:</span>
<a href="#l17.28"></a><span id="l17.28">   class Mutator</span>
<a href="#l17.29"></a><span id="l17.29">       : public nsIURIMutator</span>
<a href="#l17.30"></a><span id="l17.30">       , public BaseURIMutator&lt;nsMailtoUrl&gt;</span>
<a href="#l17.31"></a><span id="l17.31">   {</span>
<a href="#l17.32"></a><span id="l17.32">     NS_DECL_ISUPPORTS</span>
<a href="#l17.33"></a><span id="l17.33">     NS_FORWARD_SAFE_NSIURISETTERS_RET(mURI)</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35" class="difflineat">@@ -48,26 +63,28 @@ public:</span>
<a href="#l17.36"></a><span id="l17.36">     NS_IMETHOD Finalize(nsIURI** aURI) override</span>
<a href="#l17.37"></a><span id="l17.37">     {</span>
<a href="#l17.38"></a><span id="l17.38">       mURI.forget(aURI);</span>
<a href="#l17.39"></a><span id="l17.39">       return NS_OK;</span>
<a href="#l17.40"></a><span id="l17.40">     }</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42">     NS_IMETHOD SetSpec(const nsACString &amp; aSpec, nsIURIMutator** aMutator) override</span>
<a href="#l17.43"></a><span id="l17.43">     {</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-      NS_ADDREF(*aMutator = this);</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+      if (aMutator)</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+        NS_ADDREF(*aMutator = this);</span>
<a href="#l17.47"></a><span id="l17.47">       return InitFromSpec(aSpec);</span>
<a href="#l17.48"></a><span id="l17.48">     }</span>
<a href="#l17.49"></a><span id="l17.49"> </span>
<a href="#l17.50"></a><span id="l17.50">     explicit Mutator() { }</span>
<a href="#l17.51"></a><span id="l17.51">   private:</span>
<a href="#l17.52"></a><span id="l17.52">     virtual ~Mutator() { }</span>
<a href="#l17.53"></a><span id="l17.53"> </span>
<a href="#l17.54"></a><span id="l17.54">     friend class nsMailtoUrl;</span>
<a href="#l17.55"></a><span id="l17.55">   };</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+  friend BaseURIMutator&lt;nsMailtoUrl&gt;;</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58"> protected:</span>
<a href="#l17.59"></a><span id="l17.59">   enum RefHandlingEnum {</span>
<a href="#l17.60"></a><span id="l17.60">     eIgnoreRef,</span>
<a href="#l17.61"></a><span id="l17.61">     eHonorRef,</span>
<a href="#l17.62"></a><span id="l17.62">     eReplaceRef</span>
<a href="#l17.63"></a><span id="l17.63">   };</span>
<a href="#l17.64"></a><span id="l17.64">   virtual ~nsMailtoUrl();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -16,16 +16,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsIImapUrl.idl&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> interface nsIImapMessageSink;</span>
<a href="#l18.7"></a><span id="l18.7"> interface nsIUrlListener;</span>
<a href="#l18.8"></a><span id="l18.8"> interface nsIURI;</span>
<a href="#l18.9"></a><span id="l18.9"> interface nsIFile;</span>
<a href="#l18.10"></a><span id="l18.10"> interface nsIMsgFolder;</span>
<a href="#l18.11"></a><span id="l18.11"> interface nsIMsgWindow;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+interface nsIMsgMailNewsUrl;</span>
<a href="#l18.13"></a><span id="l18.13"> interface nsIImapIncomingServer;</span>
<a href="#l18.14"></a><span id="l18.14"> interface nsICacheStorage;</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> [scriptable, uuid(aba44b3d-7a0f-4987-8794-96d2de66d966)]</span>
<a href="#l18.17"></a><span id="l18.17"> interface nsIImapService : nsISupports</span>
<a href="#l18.18"></a><span id="l18.18"> {</span>
<a href="#l18.19"></a><span id="l18.19">   // You can pass in null for the url listener and the url if you don't require either.....</span>
<a href="#l18.20"></a><span id="l18.20">   void selectFolder(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -43,17 +44,17 @@ interface nsIImapService : nsISupports</span>
<a href="#l18.22"></a><span id="l18.22">    * @param aMsgWindow          msg window url is running in, can be null</span>
<a href="#l18.23"></a><span id="l18.23">    *</span>
<a href="#l18.24"></a><span id="l18.24">    * @returns the url created to run the lite select in.</span>
<a href="#l18.25"></a><span id="l18.25">    */</span>
<a href="#l18.26"></a><span id="l18.26">   nsIURI liteSelectFolder(in nsIMsgFolder aImapMailFolder,</span>
<a href="#l18.27"></a><span id="l18.27">                           in nsIUrlListener aUrlListener,</span>
<a href="#l18.28"></a><span id="l18.28">                           in nsIMsgWindow aMsgWindow);</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-  void addImapFetchToUrl(in nsIURI aURL,</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+  void addImapFetchToUrl(in nsIMsgMailNewsUrl aURL,</span>
<a href="#l18.32"></a><span id="l18.32">                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l18.33"></a><span id="l18.33">                          in ACString aMessageIdentifierList,</span>
<a href="#l18.34"></a><span id="l18.34">                          in ACString aAdditionalHeader);</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36">   void fetchMessage(in nsIImapUrl aUrl,</span>
<a href="#l18.37"></a><span id="l18.37">                     in nsImapState aImapAction,</span>
<a href="#l18.38"></a><span id="l18.38">                     in nsIMsgFolder aImapMailFolder,</span>
<a href="#l18.39"></a><span id="l18.39">                     in nsIImapMessageSink aImapMessageSink,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -37,16 +37,17 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> // for the memory cache...</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsICacheEntry.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsICacheStorage.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;nsICacheEntryOpenCallback.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13"> </span>
<a href="#l19.14"></a><span id="l19.14"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16"> #include &quot;nsIDocShellLoadInfo.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17"> #include &quot;nsILoadInfo.h&quot;</span>
<a href="#l19.18"></a><span id="l19.18"> #include &quot;nsIMessengerWindowService.h&quot;</span>
<a href="#l19.19"></a><span id="l19.19"> #include &quot;nsIWindowMediator.h&quot;</span>
<a href="#l19.20"></a><span id="l19.20"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -9301,20 +9302,18 @@ nsresult nsImapMockChannel::OpenCacheEnt</span>
<a href="#l19.22"></a><span id="l19.22">     cacheAccess = nsICacheStorage::OPEN_READONLY;</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24">   // Use the uid validity as part of the cache key, so that if the uid validity</span>
<a href="#l19.25"></a><span id="l19.25">   // changes, we won't re-use the wrong cache entries.</span>
<a href="#l19.26"></a><span id="l19.26">   nsAutoCString extension;</span>
<a href="#l19.27"></a><span id="l19.27">   extension.AppendInt(uidValidity, 16);</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29">   // Open a cache entry where the key is the potentially modified URL.</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  m_url-&gt;Clone(getter_AddRefs(newUri));</span>
<a href="#l19.32"></a><span id="l19.32">   nsAutoCString path;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-  newUri-&gt;GetPathQueryRef(path);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+  m_url-&gt;GetPathQueryRef(path);</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36">   // First we need to &quot;normalise&quot; the URL by extracting ?part= and &amp;filename.</span>
<a href="#l19.37"></a><span id="l19.37">   // The path should only contain: ?part=x.y&amp;filename=file.ext</span>
<a href="#l19.38"></a><span id="l19.38">   // These are seen in the wild:</span>
<a href="#l19.39"></a><span id="l19.39">   // /;section=2?part=1.2&amp;filename=A01.JPG</span>
<a href="#l19.40"></a><span id="l19.40">   // ?section=2?part=1.2&amp;filename=A01.JPG&amp;type=image/jpeg&amp;filename=A01.JPG</span>
<a href="#l19.41"></a><span id="l19.41">   // ?part=1.2&amp;type=image/jpeg&amp;filename=IMG_C0030.jpg</span>
<a href="#l19.42"></a><span id="l19.42">   // ?header=quotebody&amp;part=1.2&amp;filename=lijbmghmkilicioj.png</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineat">@@ -9331,59 +9330,65 @@ nsresult nsImapMockChannel::OpenCacheEnt</span>
<a href="#l19.44"></a><span id="l19.44">   // Truncate path at either /; or ?</span>
<a href="#l19.45"></a><span id="l19.45">   int32_t ind = path.FindChar('?');</span>
<a href="#l19.46"></a><span id="l19.46">   if (ind != kNotFound)</span>
<a href="#l19.47"></a><span id="l19.47">     path.SetLength(ind);</span>
<a href="#l19.48"></a><span id="l19.48">   ind = path.Find(&quot;/;&quot;);</span>
<a href="#l19.49"></a><span id="l19.49">   if (ind != kNotFound)</span>
<a href="#l19.50"></a><span id="l19.50">     path.SetLength(ind);</span>
<a href="#l19.51"></a><span id="l19.51"> </span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l19.53"></a><span id="l19.53">   if (partQuery.IsEmpty())</span>
<a href="#l19.54"></a><span id="l19.54">   {</span>
<a href="#l19.55"></a><span id="l19.55">     // Not looking for a part. That's the easy part.</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-    newUri-&gt;SetPathQueryRef(path);</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+    rv = NS_MutateURI(m_url).SetPathQueryRef(path).Finalize(newUri);</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.59"></a><span id="l19.59">     return cacheStorage-&gt;AsyncOpenURI(newUri, extension, cacheAccess, this);</span>
<a href="#l19.60"></a><span id="l19.60">   }</span>
<a href="#l19.61"></a><span id="l19.61"> </span>
<a href="#l19.62"></a><span id="l19.62">   /**</span>
<a href="#l19.63"></a><span id="l19.63">    * Part processing (rest of this function).</span>
<a href="#l19.64"></a><span id="l19.64">    */</span>
<a href="#l19.65"></a><span id="l19.65">   if (mTryingToReadPart)</span>
<a href="#l19.66"></a><span id="l19.66">   {</span>
<a href="#l19.67"></a><span id="l19.67">     // If mTryingToReadPart is set, we are here for the second time.</span>
<a href="#l19.68"></a><span id="l19.68">     // We tried to read a part from the entire message but the meta data didn't</span>
<a href="#l19.69"></a><span id="l19.69">     // allow it. So we come back here.</span>
<a href="#l19.70"></a><span id="l19.70">     // Now request the part with its full URL.</span>
<a href="#l19.71"></a><span id="l19.71">     mTryingToReadPart = false;</span>
<a href="#l19.72"></a><span id="l19.72"> </span>
<a href="#l19.73"></a><span id="l19.73">     // Note that part extraction was already set the first time.</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-    newUri-&gt;SetPathQueryRef(path + partQuery + filenameQuery);</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+    rv = NS_MutateURI(m_url).SetPathQueryRef(path + partQuery + filenameQuery).Finalize(newUri);</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.77"></a><span id="l19.77">     return cacheStorage-&gt;AsyncOpenURI(newUri, extension, cacheAccess, this);</span>
<a href="#l19.78"></a><span id="l19.78">   }</span>
<a href="#l19.79"></a><span id="l19.79"> </span>
<a href="#l19.80"></a><span id="l19.80">   // First time processing. Set up part extraction.</span>
<a href="#l19.81"></a><span id="l19.81">   SetupPartExtractorListener(imapUrl, m_channelListener);</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83">   // Check whether part is in the cache.</span>
<a href="#l19.84"></a><span id="l19.84">   bool exists = false;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-  newUri-&gt;SetPathQueryRef(path + partQuery + filenameQuery);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+  rv = NS_MutateURI(m_url).SetPathQueryRef(path + partQuery + filenameQuery).Finalize(newUri);</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.88"></a><span id="l19.88">   rv = cacheStorage-&gt;Exists(newUri, extension, &amp;exists);</span>
<a href="#l19.89"></a><span id="l19.89">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.90"></a><span id="l19.90">   if (exists) {</span>
<a href="#l19.91"></a><span id="l19.91">     return cacheStorage-&gt;AsyncOpenURI(newUri, extension, cacheAccess, this);</span>
<a href="#l19.92"></a><span id="l19.92">   }</span>
<a href="#l19.93"></a><span id="l19.93"> </span>
<a href="#l19.94"></a><span id="l19.94">   // Let's see whether we have the entire message instead.</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-  newUri-&gt;SetPathQueryRef(path);</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+  rv = NS_MutateURI(m_url).SetPathQueryRef(path).Finalize(newUri);</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.98"></a><span id="l19.98">   rv = cacheStorage-&gt;Exists(newUri, extension, &amp;exists);</span>
<a href="#l19.99"></a><span id="l19.99">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.100"></a><span id="l19.100"> </span>
<a href="#l19.101"></a><span id="l19.101">   if (!exists) {</span>
<a href="#l19.102"></a><span id="l19.102">     // The entire message is not in the cache. Request the part.</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-    newUri-&gt;SetPathQueryRef(path + partQuery + filenameQuery);</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+    rv = NS_MutateURI(m_url).SetPathQueryRef(path + partQuery + filenameQuery).Finalize(newUri);</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.106"></a><span id="l19.106">     return cacheStorage-&gt;AsyncOpenURI(newUri, extension, cacheAccess, this);</span>
<a href="#l19.107"></a><span id="l19.107">   }</span>
<a href="#l19.108"></a><span id="l19.108"> </span>
<a href="#l19.109"></a><span id="l19.109">   // This is where is gets complicated. The entire message is in the cache,</span>
<a href="#l19.110"></a><span id="l19.110">   // but we don't know whether it's suitable for use. Its meta data</span>
<a href="#l19.111"></a><span id="l19.111">   // might indicate that the message is incomplete.</span>
<a href="#l19.112"></a><span id="l19.112">   mTryingToReadPart = true;</span>
<a href="#l19.113"></a><span id="l19.113">   return cacheStorage-&gt;AsyncOpenURI(newUri, extension, cacheAccess, this);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -269,17 +269,17 @@ NS_IMETHODIMP nsImapService::GetUrlForUr</span>
<a href="#l20.4"></a><span id="l20.4">     urlSpec.AppendLiteral(&quot;fetch&gt;UID&gt;&quot;);</span>
<a href="#l20.5"></a><span id="l20.5">     urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7">     nsAutoCString folderName;</span>
<a href="#l20.8"></a><span id="l20.8">     GetFolderName(folder, folderName);</span>
<a href="#l20.9"></a><span id="l20.9">     urlSpec.Append(folderName);</span>
<a href="#l20.10"></a><span id="l20.10">     urlSpec.Append('&gt;');</span>
<a href="#l20.11"></a><span id="l20.11">     urlSpec.Append(msgKey);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    rv = url-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    rv = mailnewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.14"></a><span id="l20.14">     imapUrl-&gt;QueryInterface(NS_GET_IID(nsIURI), (void **) aURL);</span>
<a href="#l20.15"></a><span id="l20.15">   }</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17">   return rv;</span>
<a href="#l20.18"></a><span id="l20.18"> }</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> NS_IMETHODIMP nsImapService::OpenAttachment(const char *aContentType,</span>
<a href="#l20.21"></a><span id="l20.21">                                             const char *aFileName,</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -350,23 +350,23 @@ NS_IMETHODIMP nsImapService::OpenAttachm</span>
<a href="#l20.23"></a><span id="l20.23">       GetFolderName(folder, folderName);</span>
<a href="#l20.24"></a><span id="l20.24">       urlSpec.Append(folderName);</span>
<a href="#l20.25"></a><span id="l20.25">       urlSpec.Append('&gt;');</span>
<a href="#l20.26"></a><span id="l20.26">       urlSpec.Append(msgKey);</span>
<a href="#l20.27"></a><span id="l20.27">       urlSpec.Append(uriMimePart);</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">       if (!uriMimePart.IsEmpty())</span>
<a href="#l20.30"></a><span id="l20.30">       {</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl (do_QueryInterface(imapUrl));</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-        if (mailUrl)</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl(do_QueryInterface(imapUrl));</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+        if (mailnewsurl)</span>
<a href="#l20.35"></a><span id="l20.35">         {</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-          rv = mailUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+          rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.38"></a><span id="l20.38">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.39"></a><span id="l20.39">           if (aFileName)</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-            mailUrl-&gt;SetFileNameInternal(nsDependentCString(aFileName));</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+            mailnewsurl-&gt;SetFileNameInternal(nsDependentCString(aFileName));</span>
<a href="#l20.42"></a><span id="l20.42">         }</span>
<a href="#l20.43"></a><span id="l20.43">         rv =  FetchMimePart(imapUrl, nsIImapUrl::nsImapOpenMimePart, folder, imapMessageSink,</span>
<a href="#l20.44"></a><span id="l20.44">                             nullptr, aDisplayConsumer, msgKey, uriMimePart);</span>
<a href="#l20.45"></a><span id="l20.45">       }</span>
<a href="#l20.46"></a><span id="l20.46">     } // if we got a message sink</span>
<a href="#l20.47"></a><span id="l20.47">   } // if we parsed the message uri</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49">   return rv;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineat">@@ -471,19 +471,19 @@ NS_IMETHODIMP nsImapService::DisplayMess</span>
<a href="#l20.51"></a><span id="l20.51">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l20.52"></a><span id="l20.52">       nsAutoCString urlSpec;</span>
<a href="#l20.53"></a><span id="l20.53">       char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l20.54"></a><span id="l20.54">       rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.55"></a><span id="l20.55">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.56"></a><span id="l20.56">       if (!mimePart.IsEmpty())</span>
<a href="#l20.57"></a><span id="l20.57">       {</span>
<a href="#l20.58"></a><span id="l20.58">         nsresult rv;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(imapUrl);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-        rv = AddImapFetchToUrl(url, folder, msgKey + mimePart, EmptyCString());</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+        rv = AddImapFetchToUrl(mailnewsurl, folder, msgKey + mimePart, EmptyCString());</span>
<a href="#l20.65"></a><span id="l20.65">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67">         return FetchMimePart(imapUrl, nsIImapUrl::nsImapMsgFetch, folder, imapMessageSink,</span>
<a href="#l20.68"></a><span id="l20.68">                              aURL, aDisplayConsumer, msgKey, mimePart);</span>
<a href="#l20.69"></a><span id="l20.69">       }</span>
<a href="#l20.70"></a><span id="l20.70"> </span>
<a href="#l20.71"></a><span id="l20.71">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l20.72"></a><span id="l20.72">       nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nurl (do_QueryInterface(imapUrl));</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineat">@@ -598,17 +598,17 @@ nsresult nsImapService::FetchMimePart(ns</span>
<a href="#l20.74"></a><span id="l20.74">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.75"></a><span id="l20.75"> </span>
<a href="#l20.76"></a><span id="l20.76">     // rhp: If we are displaying this message for the purpose of printing, we</span>
<a href="#l20.77"></a><span id="l20.77">     // need to append the header=print option.</span>
<a href="#l20.78"></a><span id="l20.78">     //</span>
<a href="#l20.79"></a><span id="l20.79">     if (mPrintingOperation)</span>
<a href="#l20.80"></a><span id="l20.80">       urlSpec.AppendLiteral(&quot;?header=print&quot;);</span>
<a href="#l20.81"></a><span id="l20.81"> </span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-    rv = url-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+    rv = msgurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.84"></a><span id="l20.84">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.85"></a><span id="l20.85"> </span>
<a href="#l20.86"></a><span id="l20.86">     rv = aImapUrl-&gt;SetImapAction(actionToUse /* nsIImapUrl::nsImapMsgFetch */);</span>
<a href="#l20.87"></a><span id="l20.87">     if (aImapMailFolder &amp;&amp; aDisplayConsumer)</span>
<a href="#l20.88"></a><span id="l20.88">     {</span>
<a href="#l20.89"></a><span id="l20.89">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l20.90"></a><span id="l20.90">       rv = aImapMailFolder-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l20.91"></a><span id="l20.91">       if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer)</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineat">@@ -942,17 +942,17 @@ NS_IMETHODIMP nsImapService::SaveMessage</span>
<a href="#l20.93"></a><span id="l20.93">   }</span>
<a href="#l20.94"></a><span id="l20.94">   return rv;</span>
<a href="#l20.95"></a><span id="l20.95"> }</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97"> /* fetching RFC822 messages */</span>
<a href="#l20.98"></a><span id="l20.98"> /* imap4://HOST&gt;fetch&gt;&lt;UID&gt;&gt;MAILBOXPATH&gt;x */</span>
<a href="#l20.99"></a><span id="l20.99"> /*   'x' is the message UID */</span>
<a href="#l20.100"></a><span id="l20.100"> /* will set the 'SEEN' flag */</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-NS_IMETHODIMP nsImapService::AddImapFetchToUrl(nsIURI *aUrl,</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+NS_IMETHODIMP nsImapService::AddImapFetchToUrl(nsIMsgMailNewsUrl *aUrl,</span>
<a href="#l20.103"></a><span id="l20.103">                                                nsIMsgFolder *aImapMailFolder,</span>
<a href="#l20.104"></a><span id="l20.104">                                                const nsACString &amp;aMessageIdentifierList,</span>
<a href="#l20.105"></a><span id="l20.105">                                                const nsACString &amp;aAdditionalHeader)</span>
<a href="#l20.106"></a><span id="l20.106"> {</span>
<a href="#l20.107"></a><span id="l20.107">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">   nsAutoCString urlSpec;</span>
<a href="#l20.110"></a><span id="l20.110">   nsresult rv = aUrl-&gt;GetSpec(urlSpec);</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineat">@@ -990,42 +990,42 @@ NS_IMETHODIMP nsImapService::FetchMessag</span>
<a href="#l20.112"></a><span id="l20.112">                                           const nsACString &amp;aAdditionalHeader,</span>
<a href="#l20.113"></a><span id="l20.113">                                           nsIURI **aURL)</span>
<a href="#l20.114"></a><span id="l20.114"> {</span>
<a href="#l20.115"></a><span id="l20.115">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l20.116"></a><span id="l20.116">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l20.117"></a><span id="l20.117">   NS_ENSURE_ARG_POINTER(aImapMessage);</span>
<a href="#l20.118"></a><span id="l20.118"> </span>
<a href="#l20.119"></a><span id="l20.119">   nsresult rv;</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(aImapUrl);</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-  rv = AddImapFetchToUrl(url, aImapMailFolder, messageIdentifierList, aAdditionalHeader);</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl);</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+  rv = AddImapFetchToUrl(mailnewsurl, aImapMailFolder, messageIdentifierList, aAdditionalHeader);</span>
<a href="#l20.126"></a><span id="l20.126">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.127"></a><span id="l20.127"> </span>
<a href="#l20.128"></a><span id="l20.128">   if (WeAreOffline())</span>
<a href="#l20.129"></a><span id="l20.129">   {</span>
<a href="#l20.130"></a><span id="l20.130">     bool msgIsInCache = false;</span>
<a href="#l20.131"></a><span id="l20.131">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(aImapUrl));</span>
<a href="#l20.132"></a><span id="l20.132">     msgUrl-&gt;GetMsgIsInLocalCache(&amp;msgIsInCache);</span>
<a href="#l20.133"></a><span id="l20.133">     if (!msgIsInCache)</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-      IsMsgInMemCache(url, aImapMailFolder, &amp;msgIsInCache);</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+      IsMsgInMemCache(mailnewsurl, aImapMailFolder, &amp;msgIsInCache);</span>
<a href="#l20.136"></a><span id="l20.136"> </span>
<a href="#l20.137"></a><span id="l20.137">     // Display the &quot;offline&quot; message if we didn't find it in the memory cache either</span>
<a href="#l20.138"></a><span id="l20.138">     if (!msgIsInCache)</span>
<a href="#l20.139"></a><span id="l20.139">     {</span>
<a href="#l20.140"></a><span id="l20.140">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l20.141"></a><span id="l20.141">       rv = aImapMailFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l20.142"></a><span id="l20.142">       if (server &amp;&amp; aDisplayConsumer)</span>
<a href="#l20.143"></a><span id="l20.143">         rv = server-&gt;DisplayOfflineMsg(aMsgWindow);</span>
<a href="#l20.144"></a><span id="l20.144">       return rv;</span>
<a href="#l20.145"></a><span id="l20.145">     }</span>
<a href="#l20.146"></a><span id="l20.146">   }</span>
<a href="#l20.147"></a><span id="l20.147"> </span>
<a href="#l20.148"></a><span id="l20.148">   if (aURL)</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-    NS_IF_ADDREF(*aURL = url);</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+    mailnewsurl.forget(aURL);</span>
<a href="#l20.151"></a><span id="l20.151"> </span>
<a href="#l20.152"></a><span id="l20.152">   return GetMessageFromUrl(aImapUrl, aImapAction, aImapMailFolder, aImapMessage,</span>
<a href="#l20.153"></a><span id="l20.153">                            aMsgWindow, aDisplayConsumer, aConvertDataToText, aURL);</span>
<a href="#l20.154"></a><span id="l20.154"> }</span>
<a href="#l20.155"></a><span id="l20.155"> </span>
<a href="#l20.156"></a><span id="l20.156"> nsresult nsImapService::GetMessageFromUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l20.157"></a><span id="l20.157">                                           nsImapAction aImapAction,</span>
<a href="#l20.158"></a><span id="l20.158">                                           nsIMsgFolder *aImapMailFolder,</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineat">@@ -1155,54 +1155,53 @@ NS_IMETHODIMP nsImapService::StreamMessa</span>
<a href="#l20.160"></a><span id="l20.160">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.161"></a><span id="l20.161">     {</span>
<a href="#l20.162"></a><span id="l20.162">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l20.163"></a><span id="l20.163">       nsAutoCString urlSpec;</span>
<a href="#l20.164"></a><span id="l20.164">       char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l20.165"></a><span id="l20.165">       rv = CreateStartOfImapUrl(nsDependentCString(aMessageURI), getter_AddRefs(imapUrl),</span>
<a href="#l20.166"></a><span id="l20.166">                                 folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.167"></a><span id="l20.167">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; url(do_QueryInterface(imapUrl));</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl(do_QueryInterface(imapUrl));</span>
<a href="#l20.171"></a><span id="l20.171"> </span>
<a href="#l20.172"></a><span id="l20.172">       // This option is used by the JS Mime Emitter, in case we want a cheap</span>
<a href="#l20.173"></a><span id="l20.173">       // streaming, for example, if we just want a quick look at some header,</span>
<a href="#l20.174"></a><span id="l20.174">       // without having to download all the attachments...</span>
<a href="#l20.175"></a><span id="l20.175"> </span>
<a href="#l20.176"></a><span id="l20.176">       uint32_t messageSize = 0;</span>
<a href="#l20.177"></a><span id="l20.177">       imapMessageSink-&gt;GetMessageSizeFromDB(msgKey.get(), &amp;messageSize);</span>
<a href="#l20.178"></a><span id="l20.178">       nsAutoCString additionalHeader(aAdditionalHeader);</span>
<a href="#l20.179"></a><span id="l20.179">       bool fetchOnDemand =</span>
<a href="#l20.180"></a><span id="l20.180">         additionalHeader.Find(&quot;&amp;fetchCompleteMessage=false&quot;) != kNotFound &amp;&amp;</span>
<a href="#l20.181"></a><span id="l20.181">           messageSize &gt; (uint32_t) gMIMEOnDemandThreshold;</span>
<a href="#l20.182"></a><span id="l20.182">       imapUrl-&gt;SetFetchPartsOnDemand(fetchOnDemand);</span>
<a href="#l20.183"></a><span id="l20.183"> </span>
<a href="#l20.184"></a><span id="l20.184">       // We need to add the fetch command here for the cache lookup to behave correctly</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-      rv = AddImapFetchToUrl(url, folder, msgKey, additionalHeader);</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+      rv = AddImapFetchToUrl(mailnewsurl, folder, msgKey, additionalHeader);</span>
<a href="#l20.187"></a><span id="l20.187">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.188"></a><span id="l20.188"> </span>
<a href="#l20.189"></a><span id="l20.189">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l20.190"></a><span id="l20.190"> </span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-      msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-      rv = msgurl-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+      mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+      rv = mailnewsurl-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l20.195"></a><span id="l20.195"> </span>
<a href="#l20.196"></a><span id="l20.196">       // Try to check if the message is offline</span>
<a href="#l20.197"></a><span id="l20.197">       bool hasMsgOffline = false;</span>
<a href="#l20.198"></a><span id="l20.198">       folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-      msgurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+      mailnewsurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l20.201"></a><span id="l20.201">       imapUrl-&gt;SetLocalFetchOnly(aLocalOnly);</span>
<a href="#l20.202"></a><span id="l20.202"> </span>
<a href="#l20.203"></a><span id="l20.203">       // If we don't have the message available locally, and we can't get it over</span>
<a href="#l20.204"></a><span id="l20.204">       // the network, return with an error</span>
<a href="#l20.205"></a><span id="l20.205">       if (aLocalOnly || WeAreOffline())</span>
<a href="#l20.206"></a><span id="l20.206">       {</span>
<a href="#l20.207"></a><span id="l20.207">         bool isMsgInMemCache = false;</span>
<a href="#l20.208"></a><span id="l20.208">         if (!hasMsgOffline)</span>
<a href="#l20.209"></a><span id="l20.209">         {</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-          rv = IsMsgInMemCache(url, folder, &amp;isMsgInMemCache);</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+          rv = IsMsgInMemCache(mailnewsurl, folder, &amp;isMsgInMemCache);</span>
<a href="#l20.212"></a><span id="l20.212">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.213"></a><span id="l20.213"> </span>
<a href="#l20.214"></a><span id="l20.214">           if (!isMsgInMemCache)</span>
<a href="#l20.215"></a><span id="l20.215">             return NS_ERROR_FAILURE;</span>
<a href="#l20.216"></a><span id="l20.216">         }</span>
<a href="#l20.217"></a><span id="l20.217">       }</span>
<a href="#l20.218"></a><span id="l20.218"> </span>
<a href="#l20.219"></a><span id="l20.219">       bool shouldStoreMsgOffline = false;</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineat">@@ -1394,17 +1393,17 @@ NS_IMETHODIMP nsImapService::GetHeaders(</span>
<a href="#l20.221"></a><span id="l20.221">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l20.222"></a><span id="l20.222">   nsAutoCString urlSpec;</span>
<a href="#l20.223"></a><span id="l20.223">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l20.224"></a><span id="l20.224"> </span>
<a href="#l20.225"></a><span id="l20.225">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder,</span>
<a href="#l20.226"></a><span id="l20.226">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.227"></a><span id="l20.227">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.228"></a><span id="l20.228">   {</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l20.231"></a><span id="l20.231"> </span>
<a href="#l20.232"></a><span id="l20.232">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l20.233"></a><span id="l20.233">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l20.234"></a><span id="l20.234"> </span>
<a href="#l20.235"></a><span id="l20.235">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.236"></a><span id="l20.236">     {</span>
<a href="#l20.237"></a><span id="l20.237">       urlSpec.AppendLiteral(&quot;/header&gt;&quot;);</span>
<a href="#l20.238"></a><span id="l20.238">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineat">@@ -1412,17 +1411,17 @@ NS_IMETHODIMP nsImapService::GetHeaders(</span>
<a href="#l20.240"></a><span id="l20.240">       urlSpec.Append(char (hierarchyDelimiter));</span>
<a href="#l20.241"></a><span id="l20.241"> </span>
<a href="#l20.242"></a><span id="l20.242">       nsCString folderName;</span>
<a href="#l20.243"></a><span id="l20.243"> </span>
<a href="#l20.244"></a><span id="l20.244">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l20.245"></a><span id="l20.245">       urlSpec.Append(folderName);</span>
<a href="#l20.246"></a><span id="l20.246">       urlSpec.Append('&gt;');</span>
<a href="#l20.247"></a><span id="l20.247">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineplus">+      rv = mailnewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.250"></a><span id="l20.250"> </span>
<a href="#l20.251"></a><span id="l20.251">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.252"></a><span id="l20.252">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l20.253"></a><span id="l20.253">     }</span>
<a href="#l20.254"></a><span id="l20.254">   }</span>
<a href="#l20.255"></a><span id="l20.255">   return rv;</span>
<a href="#l20.256"></a><span id="l20.256"> }</span>
<a href="#l20.257"></a><span id="l20.257"> </span>
<a href="#l20.258"></a><span id="l20.258" class="difflineat">@@ -1449,31 +1448,31 @@ NS_IMETHODIMP nsImapService::GetBodyStar</span>
<a href="#l20.259"></a><span id="l20.259">     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.260"></a><span id="l20.260">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.261"></a><span id="l20.261">   {</span>
<a href="#l20.262"></a><span id="l20.262">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgPreview);</span>
<a href="#l20.263"></a><span id="l20.263">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l20.264"></a><span id="l20.264"> </span>
<a href="#l20.265"></a><span id="l20.265">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.266"></a><span id="l20.266">     {</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l20.269"></a><span id="l20.269"> </span>
<a href="#l20.270"></a><span id="l20.270">       urlSpec.AppendLiteral(&quot;/previewBody&gt;&quot;);</span>
<a href="#l20.271"></a><span id="l20.271">       urlSpec.Append(uidString);</span>
<a href="#l20.272"></a><span id="l20.272">       urlSpec.Append('&gt;');</span>
<a href="#l20.273"></a><span id="l20.273">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.274"></a><span id="l20.274"> </span>
<a href="#l20.275"></a><span id="l20.275">       nsCString folderName;</span>
<a href="#l20.276"></a><span id="l20.276">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l20.277"></a><span id="l20.277">       urlSpec.Append(folderName);</span>
<a href="#l20.278"></a><span id="l20.278">       urlSpec.Append('&gt;');</span>
<a href="#l20.279"></a><span id="l20.279">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l20.280"></a><span id="l20.280">       urlSpec.Append('&gt;');</span>
<a href="#l20.281"></a><span id="l20.281">       urlSpec.AppendInt(numBytes);</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineplus">+      rv = mailnewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.284"></a><span id="l20.284">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.285"></a><span id="l20.285">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l20.286"></a><span id="l20.286">     }</span>
<a href="#l20.287"></a><span id="l20.287">   }</span>
<a href="#l20.288"></a><span id="l20.288">   return rv;</span>
<a href="#l20.289"></a><span id="l20.289"> }</span>
<a href="#l20.290"></a><span id="l20.290"> </span>
<a href="#l20.291"></a><span id="l20.291"> nsresult nsImapService::FolderCommand(nsIMsgFolder *imapMailFolder,</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineat">@@ -1490,30 +1489,29 @@ nsresult nsImapService::FolderCommand(ns</span>
<a href="#l20.293"></a><span id="l20.293"> </span>
<a href="#l20.294"></a><span id="l20.294">   char hierarchyDelimiter = GetHierarchyDelimiter(imapMailFolder);</span>
<a href="#l20.295"></a><span id="l20.295">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l20.296"></a><span id="l20.296">                                      imapMailFolder, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.297"></a><span id="l20.297">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.298"></a><span id="l20.298">   {</span>
<a href="#l20.299"></a><span id="l20.299">     rv = imapUrl-&gt;SetImapAction(imapAction);</span>
<a href="#l20.300"></a><span id="l20.300">     rv = SetImapUrlSink(imapMailFolder, imapUrl);</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.302"></a><span id="l20.302">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.303"></a><span id="l20.303">     if (mailnewsurl)</span>
<a href="#l20.304"></a><span id="l20.304">       mailnewsurl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l20.305"></a><span id="l20.305"> </span>
<a href="#l20.306"></a><span id="l20.306">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.307"></a><span id="l20.307">     {</span>
<a href="#l20.308"></a><span id="l20.308">       urlSpec.Append(aCommand);</span>
<a href="#l20.309"></a><span id="l20.309">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.310"></a><span id="l20.310"> </span>
<a href="#l20.311"></a><span id="l20.311">       nsCString folderName;</span>
<a href="#l20.312"></a><span id="l20.312">       GetFolderName(imapMailFolder, folderName);</span>
<a href="#l20.313"></a><span id="l20.313">       urlSpec.Append(folderName);</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.316"></a><span id="l20.316">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.317"></a><span id="l20.317">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l20.318"></a><span id="l20.318">     }</span>
<a href="#l20.319"></a><span id="l20.319">   }</span>
<a href="#l20.320"></a><span id="l20.320">   return rv;</span>
<a href="#l20.321"></a><span id="l20.321"> }</span>
<a href="#l20.322"></a><span id="l20.322"> </span>
<a href="#l20.323"></a><span id="l20.323"> NS_IMETHODIMP</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineat">@@ -1523,28 +1521,28 @@ nsImapService::VerifyLogon(nsIMsgFolder </span>
<a href="#l20.325"></a><span id="l20.325">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l20.326"></a><span id="l20.326">   nsAutoCString urlSpec;</span>
<a href="#l20.327"></a><span id="l20.327"> </span>
<a href="#l20.328"></a><span id="l20.328">   char delimiter = '/'; // shouldn't matter what is is.</span>
<a href="#l20.329"></a><span id="l20.329">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aFolder,</span>
<a href="#l20.330"></a><span id="l20.330">                                      aUrlListener, urlSpec, delimiter);</span>
<a href="#l20.331"></a><span id="l20.331">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.332"></a><span id="l20.332">   {</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.335"></a><span id="l20.335"> </span>
<a href="#l20.336"></a><span id="l20.336">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l20.337"></a><span id="l20.337">     mailNewsUrl-&gt;SetSuppressErrorMsgs(true);</span>
<a href="#l20.338"></a><span id="l20.338">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l20.339"></a><span id="l20.339">     rv = SetImapUrlSink(aFolder, imapUrl);</span>
<a href="#l20.340"></a><span id="l20.340">     urlSpec.AppendLiteral(&quot;/verifyLogon&quot;);</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineminus">-    rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineplus">+    rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.343"></a><span id="l20.343">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.344"></a><span id="l20.344">       rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, nullptr);</span>
<a href="#l20.345"></a><span id="l20.345">     if (aURL)</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineminus">-      uri.forget(aURL);</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineplus">+      mailnewsurl.forget(aURL);</span>
<a href="#l20.348"></a><span id="l20.348">   }</span>
<a href="#l20.349"></a><span id="l20.349">   return rv;</span>
<a href="#l20.350"></a><span id="l20.350"> }</span>
<a href="#l20.351"></a><span id="l20.351"> </span>
<a href="#l20.352"></a><span id="l20.352"> // Noop, used to update a folder (causes server to send changes).</span>
<a href="#l20.353"></a><span id="l20.353"> NS_IMETHODIMP nsImapService::Noop(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l20.354"></a><span id="l20.354">                                   nsIUrlListener *aUrlListener,</span>
<a href="#l20.355"></a><span id="l20.355">                                   nsIURI **aURL)</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineat">@@ -1593,28 +1591,28 @@ NS_IMETHODIMP nsImapService::Biff(nsIMsg</span>
<a href="#l20.357"></a><span id="l20.357">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l20.358"></a><span id="l20.358">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l20.359"></a><span id="l20.359">     aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.360"></a><span id="l20.360">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.361"></a><span id="l20.361">   {</span>
<a href="#l20.362"></a><span id="l20.362">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapExpungeFolder);</span>
<a href="#l20.363"></a><span id="l20.363">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l20.364"></a><span id="l20.364"> </span>
<a href="#l20.365"></a><span id="l20.365" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.367"></a><span id="l20.367">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.368"></a><span id="l20.368">     {</span>
<a href="#l20.369"></a><span id="l20.369">       urlSpec.AppendLiteral(&quot;/Biff&gt;&quot;);</span>
<a href="#l20.370"></a><span id="l20.370">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.371"></a><span id="l20.371"> </span>
<a href="#l20.372"></a><span id="l20.372">       nsCString folderName;</span>
<a href="#l20.373"></a><span id="l20.373">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l20.374"></a><span id="l20.374">       urlSpec.Append(folderName);</span>
<a href="#l20.375"></a><span id="l20.375">       urlSpec.Append('&gt;');</span>
<a href="#l20.376"></a><span id="l20.376">       urlSpec.AppendInt(uidHighWater);</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.379"></a><span id="l20.379">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.380"></a><span id="l20.380">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l20.381"></a><span id="l20.381">     }</span>
<a href="#l20.382"></a><span id="l20.382">   }</span>
<a href="#l20.383"></a><span id="l20.383">   return rv;</span>
<a href="#l20.384"></a><span id="l20.384"> }</span>
<a href="#l20.385"></a><span id="l20.385"> </span>
<a href="#l20.386"></a><span id="l20.386"> NS_IMETHODIMP nsImapService::DeleteFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineat">@@ -1660,29 +1658,29 @@ NS_IMETHODIMP nsImapService::DeleteMessa</span>
<a href="#l20.388"></a><span id="l20.388">     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.389"></a><span id="l20.389">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.390"></a><span id="l20.390">   {</span>
<a href="#l20.391"></a><span id="l20.391">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l20.392"></a><span id="l20.392">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l20.393"></a><span id="l20.393"> </span>
<a href="#l20.394"></a><span id="l20.394">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.395"></a><span id="l20.395">     {</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.398"></a><span id="l20.398"> </span>
<a href="#l20.399"></a><span id="l20.399">       urlSpec.AppendLiteral(&quot;/deletemsg&gt;&quot;);</span>
<a href="#l20.400"></a><span id="l20.400">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l20.401"></a><span id="l20.401">       urlSpec.Append('&gt;');</span>
<a href="#l20.402"></a><span id="l20.402">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.403"></a><span id="l20.403"> </span>
<a href="#l20.404"></a><span id="l20.404">       nsCString folderName;</span>
<a href="#l20.405"></a><span id="l20.405">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l20.406"></a><span id="l20.406">       urlSpec.Append(folderName);</span>
<a href="#l20.407"></a><span id="l20.407">       urlSpec.Append('&gt;');</span>
<a href="#l20.408"></a><span id="l20.408">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.411"></a><span id="l20.411">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.412"></a><span id="l20.412">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l20.413"></a><span id="l20.413">     }</span>
<a href="#l20.414"></a><span id="l20.414">   }</span>
<a href="#l20.415"></a><span id="l20.415">   return rv;</span>
<a href="#l20.416"></a><span id="l20.416"> }</span>
<a href="#l20.417"></a><span id="l20.417"> </span>
<a href="#l20.418"></a><span id="l20.418"> // Delete all messages in a folder, used to empty trash</span>
<a href="#l20.419"></a><span id="l20.419" class="difflineat">@@ -1757,32 +1755,32 @@ nsresult nsImapService::DiddleFlags(nsIM</span>
<a href="#l20.420"></a><span id="l20.420">                                      aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.421"></a><span id="l20.421">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.422"></a><span id="l20.422">   {</span>
<a href="#l20.423"></a><span id="l20.423">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l20.424"></a><span id="l20.424">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l20.425"></a><span id="l20.425"> </span>
<a href="#l20.426"></a><span id="l20.426">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.427"></a><span id="l20.427">     {</span>
<a href="#l20.428"></a><span id="l20.428" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.430"></a><span id="l20.430"> </span>
<a href="#l20.431"></a><span id="l20.431">       urlSpec.Append('/');</span>
<a href="#l20.432"></a><span id="l20.432">       urlSpec.Append(howToDiddle);</span>
<a href="#l20.433"></a><span id="l20.433">       urlSpec.Append('&gt;');</span>
<a href="#l20.434"></a><span id="l20.434">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l20.435"></a><span id="l20.435">       urlSpec.Append('&gt;');</span>
<a href="#l20.436"></a><span id="l20.436">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.437"></a><span id="l20.437">       nsCString folderName;</span>
<a href="#l20.438"></a><span id="l20.438">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l20.439"></a><span id="l20.439">       urlSpec.Append(folderName);</span>
<a href="#l20.440"></a><span id="l20.440">       urlSpec.Append('&gt;');</span>
<a href="#l20.441"></a><span id="l20.441">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l20.442"></a><span id="l20.442">       urlSpec.Append('&gt;');</span>
<a href="#l20.443"></a><span id="l20.443">       urlSpec.AppendInt(flags);</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.446"></a><span id="l20.446">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.447"></a><span id="l20.447">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l20.448"></a><span id="l20.448">     }</span>
<a href="#l20.449"></a><span id="l20.449">   }</span>
<a href="#l20.450"></a><span id="l20.450">   return rv;</span>
<a href="#l20.451"></a><span id="l20.451"> }</span>
<a href="#l20.452"></a><span id="l20.452"> </span>
<a href="#l20.453"></a><span id="l20.453"> nsresult nsImapService::SetImapUrlSink(nsIMsgFolder *aMsgFolder, nsIImapUrl *aImapUrl)</span>
<a href="#l20.454"></a><span id="l20.454" class="difflineat">@@ -1830,23 +1828,21 @@ NS_IMETHODIMP nsImapService::DiscoverAll</span>
<a href="#l20.455"></a><span id="l20.455">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder,</span>
<a href="#l20.456"></a><span id="l20.456">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.457"></a><span id="l20.457">   if (NS_SUCCEEDED (rv))</span>
<a href="#l20.458"></a><span id="l20.458">   {</span>
<a href="#l20.459"></a><span id="l20.459">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l20.460"></a><span id="l20.460"> </span>
<a href="#l20.461"></a><span id="l20.461">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.462"></a><span id="l20.462">     {</span>
<a href="#l20.463"></a><span id="l20.463" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.464"></a><span id="l20.464">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.465"></a><span id="l20.465" class="difflineminus">-      if (mailnewsurl)</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-        mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineplus">+      mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l20.468"></a><span id="l20.468">       urlSpec.AppendLiteral(&quot;/discoverallboxes&quot;);</span>
<a href="#l20.469"></a><span id="l20.469">       nsCOMPtr &lt;nsIURI&gt; url = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.471"></a><span id="l20.471" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.472"></a><span id="l20.472">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.473"></a><span id="l20.473">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l20.474"></a><span id="l20.474">     }</span>
<a href="#l20.475"></a><span id="l20.475">   }</span>
<a href="#l20.476"></a><span id="l20.476">   return rv;</span>
<a href="#l20.477"></a><span id="l20.477"> }</span>
<a href="#l20.478"></a><span id="l20.478"> </span>
<a href="#l20.479"></a><span id="l20.479"> NS_IMETHODIMP nsImapService::DiscoverAllAndSubscribedFolders(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l20.480"></a><span id="l20.480" class="difflineat">@@ -1861,19 +1857,19 @@ NS_IMETHODIMP nsImapService::DiscoverAll</span>
<a href="#l20.481"></a><span id="l20.481">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l20.482"></a><span id="l20.482">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder,</span>
<a href="#l20.483"></a><span id="l20.483">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.484"></a><span id="l20.484">   if (NS_SUCCEEDED(rv) &amp;&amp; aImapUrl)</span>
<a href="#l20.485"></a><span id="l20.485">   {</span>
<a href="#l20.486"></a><span id="l20.486">     rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l20.487"></a><span id="l20.487">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.488"></a><span id="l20.488">     {</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(aImapUrl);</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl);</span>
<a href="#l20.491"></a><span id="l20.491">       urlSpec.AppendLiteral(&quot;/discoverallandsubscribedboxes&quot;);</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.494"></a><span id="l20.494">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.495"></a><span id="l20.495">         rv = GetImapConnectionAndLoadUrl(aImapUrl, nullptr, aURL);</span>
<a href="#l20.496"></a><span id="l20.496">     }</span>
<a href="#l20.497"></a><span id="l20.497">   }</span>
<a href="#l20.498"></a><span id="l20.498">   return rv;</span>
<a href="#l20.499"></a><span id="l20.499"> }</span>
<a href="#l20.500"></a><span id="l20.500"> </span>
<a href="#l20.501"></a><span id="l20.501"> NS_IMETHODIMP nsImapService::DiscoverChildren(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l20.502"></a><span id="l20.502" class="difflineat">@@ -1891,21 +1887,21 @@ NS_IMETHODIMP nsImapService::DiscoverChi</span>
<a href="#l20.503"></a><span id="l20.503">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.504"></a><span id="l20.504">   if (NS_SUCCEEDED (rv))</span>
<a href="#l20.505"></a><span id="l20.505">   {</span>
<a href="#l20.506"></a><span id="l20.506">     rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l20.507"></a><span id="l20.507">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.508"></a><span id="l20.508">     {</span>
<a href="#l20.509"></a><span id="l20.509">       if (!folderPath.IsEmpty())</span>
<a href="#l20.510"></a><span id="l20.510">       {</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(aImapUrl);</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl);</span>
<a href="#l20.513"></a><span id="l20.513">         urlSpec.AppendLiteral(&quot;/discoverchildren&gt;&quot;);</span>
<a href="#l20.514"></a><span id="l20.514">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.515"></a><span id="l20.515">         urlSpec.Append(folderPath);</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineminus">-        rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineplus">+        rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.518"></a><span id="l20.518"> </span>
<a href="#l20.519"></a><span id="l20.519">         // Make sure the uri has the same hierarchy separator as the one in msg folder</span>
<a href="#l20.520"></a><span id="l20.520">         // obj if it's not kOnlineHierarchySeparatorUnknown (ie, '^').</span>
<a href="#l20.521"></a><span id="l20.521">         char uriDelimiter;</span>
<a href="#l20.522"></a><span id="l20.522">         nsresult rv1 = aImapUrl-&gt;GetOnlineSubDirSeparator(&amp;uriDelimiter);</span>
<a href="#l20.523"></a><span id="l20.523">         if (NS_SUCCEEDED (rv1) &amp;&amp; hierarchyDelimiter != kOnlineHierarchySeparatorUnknown &amp;&amp;</span>
<a href="#l20.524"></a><span id="l20.524">             uriDelimiter != hierarchyDelimiter)</span>
<a href="#l20.525"></a><span id="l20.525">           aImapUrl-&gt;SetOnlineSubDirSeparator(hierarchyDelimiter);</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineat">@@ -1959,20 +1955,18 @@ NS_IMETHODIMP nsImapService::OnlineMessa</span>
<a href="#l20.527"></a><span id="l20.527"> </span>
<a href="#l20.528"></a><span id="l20.528">   char hierarchyDelimiter = GetHierarchyDelimiter(aSrcFolder);</span>
<a href="#l20.529"></a><span id="l20.529">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aSrcFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.530"></a><span id="l20.530">   if (NS_SUCCEEDED(rv))</span>
<a href="#l20.531"></a><span id="l20.531">   {</span>
<a href="#l20.532"></a><span id="l20.532">     SetImapUrlSink(aSrcFolder, imapUrl);</span>
<a href="#l20.533"></a><span id="l20.533">     imapUrl-&gt;SetCopyState(copyState);</span>
<a href="#l20.534"></a><span id="l20.534"> </span>
<a href="#l20.535"></a><span id="l20.535" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineminus">-</span>
<a href="#l20.537"></a><span id="l20.537" class="difflineminus">-    msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l20.538"></a><span id="l20.538" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.539"></a><span id="l20.539" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl (do_QueryInterface(imapUrl));</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineplus">+    mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l20.541"></a><span id="l20.541"> </span>
<a href="#l20.542"></a><span id="l20.542">     if (isMove)</span>
<a href="#l20.543"></a><span id="l20.543">       urlSpec.AppendLiteral(&quot;/onlinemove&gt;&quot;);</span>
<a href="#l20.544"></a><span id="l20.544">     else</span>
<a href="#l20.545"></a><span id="l20.545">       urlSpec.AppendLiteral(&quot;/onlinecopy&gt;&quot;);</span>
<a href="#l20.546"></a><span id="l20.546">     if (idsAreUids)</span>
<a href="#l20.547"></a><span id="l20.547">       urlSpec.Append(uidString);</span>
<a href="#l20.548"></a><span id="l20.548">     else</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineat">@@ -1986,17 +1980,17 @@ NS_IMETHODIMP nsImapService::OnlineMessa</span>
<a href="#l20.550"></a><span id="l20.550">     urlSpec.Append('&gt;');</span>
<a href="#l20.551"></a><span id="l20.551">     urlSpec.Append(messageIds);</span>
<a href="#l20.552"></a><span id="l20.552">     urlSpec.Append('&gt;');</span>
<a href="#l20.553"></a><span id="l20.553">     urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.554"></a><span id="l20.554">     folderName.Adopt(strdup(&quot;&quot;));</span>
<a href="#l20.555"></a><span id="l20.555">     GetFolderName(aDstFolder, folderName);</span>
<a href="#l20.556"></a><span id="l20.556">     urlSpec.Append(folderName);</span>
<a href="#l20.557"></a><span id="l20.557"> </span>
<a href="#l20.558"></a><span id="l20.558" class="difflineminus">-    rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineplus">+    rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.560"></a><span id="l20.560">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.561"></a><span id="l20.561">       rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l20.562"></a><span id="l20.562">   }</span>
<a href="#l20.563"></a><span id="l20.563">   return rv;</span>
<a href="#l20.564"></a><span id="l20.564"> }</span>
<a href="#l20.565"></a><span id="l20.565"> </span>
<a href="#l20.566"></a><span id="l20.566"> nsresult nsImapService::OfflineAppendFromFile(nsIFile *aFile,</span>
<a href="#l20.567"></a><span id="l20.567">                                               nsIURI *aUrl,</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineat">@@ -2151,17 +2145,17 @@ NS_IMETHODIMP nsImapService::AppendMessa</span>
<a href="#l20.569"></a><span id="l20.569">       // we get the loadGroup from msgWindow</span>
<a href="#l20.570"></a><span id="l20.570">       msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l20.571"></a><span id="l20.571">     }</span>
<a href="#l20.572"></a><span id="l20.572"> </span>
<a href="#l20.573"></a><span id="l20.573">     SetImapUrlSink(aDstFolder, imapUrl);</span>
<a href="#l20.574"></a><span id="l20.574">     imapUrl-&gt;SetMsgFile(aFile);</span>
<a href="#l20.575"></a><span id="l20.575">     imapUrl-&gt;SetCopyState(aCopyState);</span>
<a href="#l20.576"></a><span id="l20.576"> </span>
<a href="#l20.577"></a><span id="l20.577" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.579"></a><span id="l20.579"> </span>
<a href="#l20.580"></a><span id="l20.580">     if (inSelectedState)</span>
<a href="#l20.581"></a><span id="l20.581">       urlSpec.AppendLiteral(&quot;/appenddraftfromfile&gt;&quot;);</span>
<a href="#l20.582"></a><span id="l20.582">     else</span>
<a href="#l20.583"></a><span id="l20.583">       urlSpec.AppendLiteral(&quot;/appendmsgfromfile&gt;&quot;);</span>
<a href="#l20.584"></a><span id="l20.584"> </span>
<a href="#l20.585"></a><span id="l20.585">     urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.586"></a><span id="l20.586"> </span>
<a href="#l20.587"></a><span id="l20.587" class="difflineat">@@ -2176,21 +2170,21 @@ NS_IMETHODIMP nsImapService::AppendMessa</span>
<a href="#l20.588"></a><span id="l20.588">         urlSpec.Append(uidString);</span>
<a href="#l20.589"></a><span id="l20.589">       else</span>
<a href="#l20.590"></a><span id="l20.590">         urlSpec.Append(sequenceString);</span>
<a href="#l20.591"></a><span id="l20.591">       urlSpec.Append('&gt;');</span>
<a href="#l20.592"></a><span id="l20.592">       if (!messageId.IsEmpty())</span>
<a href="#l20.593"></a><span id="l20.593">         urlSpec.Append(messageId);</span>
<a href="#l20.594"></a><span id="l20.594">     }</span>
<a href="#l20.595"></a><span id="l20.595"> </span>
<a href="#l20.596"></a><span id="l20.596" class="difflineminus">-    rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.597"></a><span id="l20.597" class="difflineplus">+    rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.598"></a><span id="l20.598">     if (WeAreOffline())</span>
<a href="#l20.599"></a><span id="l20.599">     {</span>
<a href="#l20.600"></a><span id="l20.600">       // handle offline append to drafts or templates folder here.</span>
<a href="#l20.601"></a><span id="l20.601" class="difflineminus">-      return OfflineAppendFromFile(aFile, uri, aDstFolder, messageId, inSelectedState, aListener, aURL, aCopyState);</span>
<a href="#l20.602"></a><span id="l20.602" class="difflineplus">+      return OfflineAppendFromFile(aFile, mailnewsurl, aDstFolder, messageId, inSelectedState, aListener, aURL, aCopyState);</span>
<a href="#l20.603"></a><span id="l20.603">     }</span>
<a href="#l20.604"></a><span id="l20.604">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.605"></a><span id="l20.605">       rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l20.606"></a><span id="l20.606">   }</span>
<a href="#l20.607"></a><span id="l20.607">   return rv;</span>
<a href="#l20.608"></a><span id="l20.608"> }</span>
<a href="#l20.609"></a><span id="l20.609"> </span>
<a href="#l20.610"></a><span id="l20.610"> nsresult nsImapService::GetImapConnectionAndLoadUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l20.611"></a><span id="l20.611" class="difflineat">@@ -2257,29 +2251,29 @@ NS_IMETHODIMP nsImapService::MoveFolder(</span>
<a href="#l20.612"></a><span id="l20.612">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.613"></a><span id="l20.613">     {</span>
<a href="#l20.614"></a><span id="l20.614">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l20.615"></a><span id="l20.615">       if (mailNewsUrl)</span>
<a href="#l20.616"></a><span id="l20.616">         mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l20.617"></a><span id="l20.617">       char hierarchyDelimiter = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l20.618"></a><span id="l20.618">       nsCString folderName;</span>
<a href="#l20.619"></a><span id="l20.619"> </span>
<a href="#l20.620"></a><span id="l20.620" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.621"></a><span id="l20.621" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.622"></a><span id="l20.622">       GetFolderName(srcFolder, folderName);</span>
<a href="#l20.623"></a><span id="l20.623">       urlSpec.AppendLiteral(&quot;/movefolderhierarchy&gt;&quot;);</span>
<a href="#l20.624"></a><span id="l20.624">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.625"></a><span id="l20.625">       urlSpec.Append(folderName);</span>
<a href="#l20.626"></a><span id="l20.626">       urlSpec.Append('&gt;');</span>
<a href="#l20.627"></a><span id="l20.627">       GetFolderName(dstFolder, folderName);</span>
<a href="#l20.628"></a><span id="l20.628">       if (!folderName.IsEmpty())</span>
<a href="#l20.629"></a><span id="l20.629">       {</span>
<a href="#l20.630"></a><span id="l20.630">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.631"></a><span id="l20.631">         urlSpec.Append(folderName);</span>
<a href="#l20.632"></a><span id="l20.632">       }</span>
<a href="#l20.633"></a><span id="l20.633" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.634"></a><span id="l20.634" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.635"></a><span id="l20.635">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.636"></a><span id="l20.636">       {</span>
<a href="#l20.637"></a><span id="l20.637">         GetFolderName(srcFolder, folderName);</span>
<a href="#l20.638"></a><span id="l20.638">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l20.639"></a><span id="l20.639">       }</span>
<a href="#l20.640"></a><span id="l20.640">     }</span>
<a href="#l20.641"></a><span id="l20.641">   }</span>
<a href="#l20.642"></a><span id="l20.642">   return rv;</span>
<a href="#l20.643"></a><span id="l20.643" class="difflineat">@@ -2299,20 +2293,18 @@ NS_IMETHODIMP nsImapService::RenameLeaf(</span>
<a href="#l20.644"></a><span id="l20.644">   char hierarchyDelimiter = GetHierarchyDelimiter(srcFolder);</span>
<a href="#l20.645"></a><span id="l20.645">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), srcFolder,</span>
<a href="#l20.646"></a><span id="l20.646">                             urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.647"></a><span id="l20.647">   if (NS_SUCCEEDED(rv))</span>
<a href="#l20.648"></a><span id="l20.648">   {</span>
<a href="#l20.649"></a><span id="l20.649">     rv = SetImapUrlSink(srcFolder, imapUrl);</span>
<a href="#l20.650"></a><span id="l20.650">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.651"></a><span id="l20.651">     {</span>
<a href="#l20.652"></a><span id="l20.652" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.653"></a><span id="l20.653">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l20.654"></a><span id="l20.654" class="difflineminus">-      if (mailNewsUrl)</span>
<a href="#l20.655"></a><span id="l20.655" class="difflineminus">-        mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l20.656"></a><span id="l20.656" class="difflineplus">+      mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l20.657"></a><span id="l20.657">       nsCString folderName;</span>
<a href="#l20.658"></a><span id="l20.658">       GetFolderName(srcFolder, folderName);</span>
<a href="#l20.659"></a><span id="l20.659">       urlSpec.AppendLiteral(&quot;/rename&gt;&quot;);</span>
<a href="#l20.660"></a><span id="l20.660">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.661"></a><span id="l20.661">       urlSpec.Append(folderName);</span>
<a href="#l20.662"></a><span id="l20.662">       urlSpec.Append('&gt;');</span>
<a href="#l20.663"></a><span id="l20.663">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.664"></a><span id="l20.664">       nsAutoCString cStrFolderName;</span>
<a href="#l20.665"></a><span id="l20.665" class="difflineat">@@ -2329,21 +2321,21 @@ NS_IMETHODIMP nsImapService::RenameLeaf(</span>
<a href="#l20.666"></a><span id="l20.666">       CopyUTF16toMUTF7(PromiseFlatString(newLeafName), utfNewName);</span>
<a href="#l20.667"></a><span id="l20.667">       nsCString escapedNewName;</span>
<a href="#l20.668"></a><span id="l20.668">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedNewName);</span>
<a href="#l20.669"></a><span id="l20.669">       nsCString escapedSlashName;</span>
<a href="#l20.670"></a><span id="l20.670">       rv = nsImapUrl::EscapeSlashes(escapedNewName.get(), getter_Copies(escapedSlashName));</span>
<a href="#l20.671"></a><span id="l20.671">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.672"></a><span id="l20.672">       urlSpec.Append(escapedSlashName);</span>
<a href="#l20.673"></a><span id="l20.673"> </span>
<a href="#l20.674"></a><span id="l20.674" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.675"></a><span id="l20.675" class="difflineplus">+      rv = mailNewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.676"></a><span id="l20.676">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.677"></a><span id="l20.677">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l20.678"></a><span id="l20.678" class="difflineminus">-    } // if (NS_SUCCEEDED(rv))</span>
<a href="#l20.679"></a><span id="l20.679" class="difflineminus">-  } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.680"></a><span id="l20.680" class="difflineplus">+    }</span>
<a href="#l20.681"></a><span id="l20.681" class="difflineplus">+  }</span>
<a href="#l20.682"></a><span id="l20.682">   return rv;</span>
<a href="#l20.683"></a><span id="l20.683"> }</span>
<a href="#l20.684"></a><span id="l20.684"> </span>
<a href="#l20.685"></a><span id="l20.685"> NS_IMETHODIMP nsImapService::CreateFolder(nsIMsgFolder *parent,</span>
<a href="#l20.686"></a><span id="l20.686">                                           const nsAString &amp;newFolderName,</span>
<a href="#l20.687"></a><span id="l20.687">                                           nsIUrlListener *urlListener,</span>
<a href="#l20.688"></a><span id="l20.688">                                           nsIURI **url)</span>
<a href="#l20.689"></a><span id="l20.689"> {</span>
<a href="#l20.690"></a><span id="l20.690" class="difflineat">@@ -2356,17 +2348,17 @@ NS_IMETHODIMP nsImapService::CreateFolde</span>
<a href="#l20.691"></a><span id="l20.691">   char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l20.692"></a><span id="l20.692">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent,</span>
<a href="#l20.693"></a><span id="l20.693">                             urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.694"></a><span id="l20.694">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.695"></a><span id="l20.695">   {</span>
<a href="#l20.696"></a><span id="l20.696">     rv = SetImapUrlSink(parent, imapUrl);</span>
<a href="#l20.697"></a><span id="l20.697">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.698"></a><span id="l20.698">     {</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.700"></a><span id="l20.700" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.701"></a><span id="l20.701"> </span>
<a href="#l20.702"></a><span id="l20.702">       nsCString folderName;</span>
<a href="#l20.703"></a><span id="l20.703">       GetFolderName(parent, folderName);</span>
<a href="#l20.704"></a><span id="l20.704">       urlSpec.AppendLiteral(&quot;/create&gt;&quot;);</span>
<a href="#l20.705"></a><span id="l20.705">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.706"></a><span id="l20.706">       if (!folderName.IsEmpty())</span>
<a href="#l20.707"></a><span id="l20.707">       {</span>
<a href="#l20.708"></a><span id="l20.708">         nsCString canonicalName;</span>
<a href="#l20.709"></a><span id="l20.709" class="difflineat">@@ -2379,21 +2371,21 @@ NS_IMETHODIMP nsImapService::CreateFolde</span>
<a href="#l20.710"></a><span id="l20.710"> </span>
<a href="#l20.711"></a><span id="l20.711">       nsAutoCString utfNewName;</span>
<a href="#l20.712"></a><span id="l20.712">       rv = CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l20.713"></a><span id="l20.713">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.714"></a><span id="l20.714">       nsCString escapedFolderName;</span>
<a href="#l20.715"></a><span id="l20.715">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l20.716"></a><span id="l20.716">       urlSpec.Append(escapedFolderName);</span>
<a href="#l20.717"></a><span id="l20.717"> </span>
<a href="#l20.718"></a><span id="l20.718" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.719"></a><span id="l20.719" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.720"></a><span id="l20.720">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.721"></a><span id="l20.721">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l20.722"></a><span id="l20.722" class="difflineminus">-    } // if (NS_SUCCEEDED(rv))</span>
<a href="#l20.723"></a><span id="l20.723" class="difflineminus">-  } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.724"></a><span id="l20.724" class="difflineplus">+    }</span>
<a href="#l20.725"></a><span id="l20.725" class="difflineplus">+  }</span>
<a href="#l20.726"></a><span id="l20.726">   return rv;</span>
<a href="#l20.727"></a><span id="l20.727"> }</span>
<a href="#l20.728"></a><span id="l20.728"> </span>
<a href="#l20.729"></a><span id="l20.729"> NS_IMETHODIMP nsImapService::EnsureFolderExists(nsIMsgFolder *parent,</span>
<a href="#l20.730"></a><span id="l20.730">                                                 const nsAString &amp;newFolderName,</span>
<a href="#l20.731"></a><span id="l20.731">                                                 nsIUrlListener *urlListener,</span>
<a href="#l20.732"></a><span id="l20.732">                                                 nsIURI **url)</span>
<a href="#l20.733"></a><span id="l20.733"> {</span>
<a href="#l20.734"></a><span id="l20.734" class="difflineat">@@ -2405,38 +2397,38 @@ NS_IMETHODIMP nsImapService::EnsureFolde</span>
<a href="#l20.735"></a><span id="l20.735"> </span>
<a href="#l20.736"></a><span id="l20.736">   char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l20.737"></a><span id="l20.737">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l20.738"></a><span id="l20.738">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.739"></a><span id="l20.739">   {</span>
<a href="#l20.740"></a><span id="l20.740">     rv = SetImapUrlSink(parent, imapUrl);</span>
<a href="#l20.741"></a><span id="l20.741">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.742"></a><span id="l20.742">     {</span>
<a href="#l20.743"></a><span id="l20.743" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.744"></a><span id="l20.744" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.745"></a><span id="l20.745"> </span>
<a href="#l20.746"></a><span id="l20.746">       nsCString folderName;</span>
<a href="#l20.747"></a><span id="l20.747">       GetFolderName(parent, folderName);</span>
<a href="#l20.748"></a><span id="l20.748">       urlSpec.AppendLiteral(&quot;/ensureExists&gt;&quot;);</span>
<a href="#l20.749"></a><span id="l20.749">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.750"></a><span id="l20.750">       if (!folderName.IsEmpty())</span>
<a href="#l20.751"></a><span id="l20.751">       {</span>
<a href="#l20.752"></a><span id="l20.752">         urlSpec.Append(folderName);</span>
<a href="#l20.753"></a><span id="l20.753">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.754"></a><span id="l20.754">       }</span>
<a href="#l20.755"></a><span id="l20.755">       nsAutoCString utfNewName;</span>
<a href="#l20.756"></a><span id="l20.756">       CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l20.757"></a><span id="l20.757">       nsCString escapedFolderName;</span>
<a href="#l20.758"></a><span id="l20.758">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l20.759"></a><span id="l20.759">       urlSpec.Append(escapedFolderName);</span>
<a href="#l20.760"></a><span id="l20.760"> </span>
<a href="#l20.761"></a><span id="l20.761" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.762"></a><span id="l20.762" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.763"></a><span id="l20.763">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.764"></a><span id="l20.764">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l20.765"></a><span id="l20.765" class="difflineminus">-    } // if (NS_SUCCEEDED(rv))</span>
<a href="#l20.766"></a><span id="l20.766" class="difflineminus">-  } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.767"></a><span id="l20.767" class="difflineplus">+    }</span>
<a href="#l20.768"></a><span id="l20.768" class="difflineplus">+  }</span>
<a href="#l20.769"></a><span id="l20.769">   return rv;</span>
<a href="#l20.770"></a><span id="l20.770"> }</span>
<a href="#l20.771"></a><span id="l20.771"> </span>
<a href="#l20.772"></a><span id="l20.772"> NS_IMETHODIMP nsImapService::ListFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l20.773"></a><span id="l20.773">                                         nsIUrlListener *aUrlListener,</span>
<a href="#l20.774"></a><span id="l20.774">                                         nsIURI **aURL)</span>
<a href="#l20.775"></a><span id="l20.775"> {</span>
<a href="#l20.776"></a><span id="l20.776">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l20.777"></a><span id="l20.777" class="difflineat">@@ -2526,20 +2518,22 @@ nsresult nsImapService::GetServerFromUrl</span>
<a href="#l20.778"></a><span id="l20.778">   // &quot;IMAP://userSharingFolder@server1/SharedFolderName&quot;</span>
<a href="#l20.779"></a><span id="l20.779">   if (NS_FAILED(rv) || !aServer)</span>
<a href="#l20.780"></a><span id="l20.780">   {</span>
<a href="#l20.781"></a><span id="l20.781">     nsAutoCString turl;</span>
<a href="#l20.782"></a><span id="l20.782">     rv = mailnewsUrl-&gt;GetSpec(turl);</span>
<a href="#l20.783"></a><span id="l20.783">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.784"></a><span id="l20.784"> </span>
<a href="#l20.785"></a><span id="l20.785">     nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineminus">-    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(turl).Finalize(url);</span>
<a href="#l20.787"></a><span id="l20.787" class="difflineplus">+    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l20.788"></a><span id="l20.788" class="difflineplus">+           .SetSpec(turl)</span>
<a href="#l20.789"></a><span id="l20.789" class="difflineplus">+           .SetUserPass(EmptyCString())</span>
<a href="#l20.790"></a><span id="l20.790" class="difflineplus">+           .Finalize(url);</span>
<a href="#l20.791"></a><span id="l20.791">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.792"></a><span id="l20.792"> </span>
<a href="#l20.793"></a><span id="l20.793" class="difflineminus">-    url-&gt;SetUserPass(EmptyCString());</span>
<a href="#l20.794"></a><span id="l20.794">     rv = accountManager-&gt;FindServerByURI(url, false, aServer);</span>
<a href="#l20.795"></a><span id="l20.795">     if (*aServer)</span>
<a href="#l20.796"></a><span id="l20.796">       aImapUrl-&gt;SetExternalLinkUrl(true);</span>
<a href="#l20.797"></a><span id="l20.797">   }</span>
<a href="#l20.798"></a><span id="l20.798"> </span>
<a href="#l20.799"></a><span id="l20.799">     // if we can't extract the imap server from this url then give up!!!</span>
<a href="#l20.800"></a><span id="l20.800">   NS_ENSURE_TRUE(*aServer, NS_ERROR_FAILURE);</span>
<a href="#l20.801"></a><span id="l20.801">   return rv;</span>
<a href="#l20.802"></a><span id="l20.802" class="difflineat">@@ -3067,26 +3061,26 @@ nsresult nsImapService::ChangeFolderSubs</span>
<a href="#l20.803"></a><span id="l20.803">   char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l20.804"></a><span id="l20.804">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), folder, urlListener,</span>
<a href="#l20.805"></a><span id="l20.805">                             urlSpec, hierarchyDelimiter);</span>
<a href="#l20.806"></a><span id="l20.806">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l20.807"></a><span id="l20.807">   {</span>
<a href="#l20.808"></a><span id="l20.808">     rv = SetImapUrlSink(folder, imapUrl);</span>
<a href="#l20.809"></a><span id="l20.809">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.810"></a><span id="l20.810">     {</span>
<a href="#l20.811"></a><span id="l20.811" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l20.812"></a><span id="l20.812" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l20.813"></a><span id="l20.813">       urlSpec.Append(command);</span>
<a href="#l20.814"></a><span id="l20.814">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l20.815"></a><span id="l20.815">       nsAutoCString utfFolderName;</span>
<a href="#l20.816"></a><span id="l20.816">       rv = CopyUTF16toMUTF7(PromiseFlatString(folderName), utfFolderName);</span>
<a href="#l20.817"></a><span id="l20.817">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.818"></a><span id="l20.818">       nsCString escapedFolderName;</span>
<a href="#l20.819"></a><span id="l20.819">       MsgEscapeString(utfFolderName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l20.820"></a><span id="l20.820">       urlSpec.Append(escapedFolderName);</span>
<a href="#l20.821"></a><span id="l20.821" class="difflineminus">-      rv = uri-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.822"></a><span id="l20.822" class="difflineplus">+      rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l20.823"></a><span id="l20.823">       if (NS_SUCCEEDED(rv))</span>
<a href="#l20.824"></a><span id="l20.824">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l20.825"></a><span id="l20.825">     }</span>
<a href="#l20.826"></a><span id="l20.826">   }</span>
<a href="#l20.827"></a><span id="l20.827">   return rv;</span>
<a href="#l20.828"></a><span id="l20.828"> }</span>
<a href="#l20.829"></a><span id="l20.829"> </span>
<a href="#l20.830"></a><span id="l20.830"> NS_IMETHODIMP nsImapService::UnsubscribeFolder(nsIMsgFolder *aFolder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -21,19 +21,20 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> class nsImapUrl : public nsIImapUrl, public nsMsgMailNewsUrl, public nsIMsgMessageUrl, public nsIMsgI18NUrl</span>
<a href="#l21.7"></a><span id="l21.7"> {</span>
<a href="#l21.8"></a><span id="l21.8"> public:</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  // nsIURI override</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  // nsIMsgMailNewsUrl override</span>
<a href="#l21.14"></a><span id="l21.14">   nsresult SetSpecInternal(const nsACString &amp;aSpec) override;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-  NS_IMETHOD SetQuery(const nsACString &amp;aQuery) override;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  nsresult SetQuery(const nsACString &amp;aQuery) override;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+  // nsIURI override</span>
<a href="#l21.18"></a><span id="l21.18">   NS_IMETHOD CloneInternal(uint32_t aRefHandlingMode,</span>
<a href="#l21.19"></a><span id="l21.19">                            const nsACString&amp; newRef, nsIURI **_retval) override;</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l21.22"></a><span id="l21.22">   // we support the nsIImapUrl interface</span>
<a href="#l21.23"></a><span id="l21.23">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l21.24"></a><span id="l21.24">   NS_DECL_NSIIMAPURL</span>
<a href="#l21.25"></a><span id="l21.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -3116,39 +3116,43 @@ nsMsgLocalMailFolder::GetIncomingServerT</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l22.6"></a><span id="l22.6">              do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.7"></a><span id="l22.7">     if (NS_FAILED(rv))</span>
<a href="#l22.8"></a><span id="l22.8">       return rv;</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l22.11"></a><span id="l22.11">     // try &quot;none&quot; first</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+    rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;)).Finalize(url);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.15"></a><span id="l22.15">     rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l22.16"></a><span id="l22.16">     if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l22.17"></a><span id="l22.17">       mType.AssignLiteral(&quot;none&quot;);</span>
<a href="#l22.18"></a><span id="l22.18">     else</span>
<a href="#l22.19"></a><span id="l22.19">     {</span>
<a href="#l22.20"></a><span id="l22.20">       // next try &quot;pop3&quot;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-      url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+      rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;)).Finalize(url);</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.24"></a><span id="l22.24">       rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l22.25"></a><span id="l22.25">       if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l22.26"></a><span id="l22.26">         mType.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l22.27"></a><span id="l22.27">       else</span>
<a href="#l22.28"></a><span id="l22.28">       {</span>
<a href="#l22.29"></a><span id="l22.29">         // next try &quot;rss&quot;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-        url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;));</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+        rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;)).Finalize(url);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.33"></a><span id="l22.33">         rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l22.34"></a><span id="l22.34">         if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l22.35"></a><span id="l22.35">           mType.AssignLiteral(&quot;rss&quot;);</span>
<a href="#l22.36"></a><span id="l22.36">         else</span>
<a href="#l22.37"></a><span id="l22.37">         {</span>
<a href="#l22.38"></a><span id="l22.38"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l22.39"></a><span id="l22.39">           // next try &quot;movemail&quot;</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-          url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;));</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+          rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;)).Finalize(url);</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.43"></a><span id="l22.43">           rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l22.44"></a><span id="l22.44">           if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l22.45"></a><span id="l22.45">             mType.AssignLiteral(&quot;movemail&quot;);</span>
<a href="#l22.46"></a><span id="l22.46"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l22.47"></a><span id="l22.47">         }</span>
<a href="#l22.48"></a><span id="l22.48">       }</span>
<a href="#l22.49"></a><span id="l22.49">     }</span>
<a href="#l22.50"></a><span id="l22.50">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUtils.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUtils.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -38,61 +38,66 @@ nsGetMailboxServer(const char *uriStr, n</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5">   // retrieve the AccountManager</span>
<a href="#l23.6"></a><span id="l23.6">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.7"></a><span id="l23.7">     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.8"></a><span id="l23.8">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10">   // find all local mail &quot;no servers&quot; matching the given hostname</span>
<a href="#l23.11"></a><span id="l23.11">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; none_server;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;)).Finalize(url);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.15"></a><span id="l23.15">   // No unescaping of username or hostname done here.</span>
<a href="#l23.16"></a><span id="l23.16">   // The unescaping is done inside of FindServerByURI</span>
<a href="#l23.17"></a><span id="l23.17">   rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l23.18"></a><span id="l23.18">                                   getter_AddRefs(none_server));</span>
<a href="#l23.19"></a><span id="l23.19">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.20"></a><span id="l23.20">     none_server.forget(aResult);</span>
<a href="#l23.21"></a><span id="l23.21">     return rv;</span>
<a href="#l23.22"></a><span id="l23.22">   }</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24">   // if that fails, look for the rss hosts matching the given hostname</span>
<a href="#l23.25"></a><span id="l23.25">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; rss_server;</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-  url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;));</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+  rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;)).Finalize(url);</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.29"></a><span id="l23.29">   rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l23.30"></a><span id="l23.30">                                   getter_AddRefs(rss_server));</span>
<a href="#l23.31"></a><span id="l23.31">   if (NS_SUCCEEDED(rv))</span>
<a href="#l23.32"></a><span id="l23.32">   {</span>
<a href="#l23.33"></a><span id="l23.33">      rss_server.forget(aResult);</span>
<a href="#l23.34"></a><span id="l23.34">      return rv;</span>
<a href="#l23.35"></a><span id="l23.35">   }</span>
<a href="#l23.36"></a><span id="l23.36"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l23.37"></a><span id="l23.37">   // find all movemail &quot;servers&quot; matching the given hostname</span>
<a href="#l23.38"></a><span id="l23.38">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; movemail_server;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-  url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;));</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+  rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;)).Finalize(url);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.42"></a><span id="l23.42">   rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l23.43"></a><span id="l23.43">                                   getter_AddRefs(movemail_server));</span>
<a href="#l23.44"></a><span id="l23.44">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.45"></a><span id="l23.45">     movemail_server.forget(aResult);</span>
<a href="#l23.46"></a><span id="l23.46">     return rv;</span>
<a href="#l23.47"></a><span id="l23.47">   }</span>
<a href="#l23.48"></a><span id="l23.48"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l23.49"></a><span id="l23.49"> </span>
<a href="#l23.50"></a><span id="l23.50">   // if that fails, look for the pop hosts matching the given hostname</span>
<a href="#l23.51"></a><span id="l23.51">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.52"></a><span id="l23.52">   if (NS_FAILED(rv))</span>
<a href="#l23.53"></a><span id="l23.53">   {</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-    url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+    rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;)).Finalize(url);</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.57"></a><span id="l23.57">     rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l23.58"></a><span id="l23.58">                                     getter_AddRefs(server));</span>
<a href="#l23.59"></a><span id="l23.59"> </span>
<a href="#l23.60"></a><span id="l23.60">     // if we can't find a pop server, maybe it's a local message</span>
<a href="#l23.61"></a><span id="l23.61">     // in an imap hierarchy. look for an imap server.</span>
<a href="#l23.62"></a><span id="l23.62">     if (NS_FAILED(rv))</span>
<a href="#l23.63"></a><span id="l23.63">     {</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-      url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+      rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;imap&quot;)).Finalize(url);</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.67"></a><span id="l23.67">       rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l23.68"></a><span id="l23.68">                                     getter_AddRefs(server));</span>
<a href="#l23.69"></a><span id="l23.69">     }</span>
<a href="#l23.70"></a><span id="l23.70">   }</span>
<a href="#l23.71"></a><span id="l23.71">   if (NS_SUCCEEDED(rv))</span>
<a href="#l23.72"></a><span id="l23.72">   {</span>
<a href="#l23.73"></a><span id="l23.73">     server.forget(aResult);</span>
<a href="#l23.74"></a><span id="l23.74">     return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -543,17 +543,17 @@ NS_IMETHODIMP nsMailboxService::GetProto</span>
<a href="#l24.4"></a><span id="l24.4"> NS_IMETHODIMP nsMailboxService::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l24.5"></a><span id="l24.5">                                        const char *aOriginCharset,</span>
<a href="#l24.6"></a><span id="l24.6">                                        nsIURI *aBaseURI,</span>
<a href="#l24.7"></a><span id="l24.7">                                        nsIURI **_retval)</span>
<a href="#l24.8"></a><span id="l24.8"> {</span>
<a href="#l24.9"></a><span id="l24.9">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l24.10"></a><span id="l24.10">   *_retval = 0;</span>
<a href="#l24.11"></a><span id="l24.11">   nsresult rv;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; aMsgUri = do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; aMsgUri = do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l24.14"></a><span id="l24.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.15"></a><span id="l24.15">   // SetSpec calls below may fail if the mailbox url is of the form</span>
<a href="#l24.16"></a><span id="l24.16">   // mailbox://&lt;account&gt;/&lt;mailbox name&gt;?... instead of</span>
<a href="#l24.17"></a><span id="l24.17">   // mailbox://&lt;path to folder&gt;?.... This is the case for pop3 download urls.</span>
<a href="#l24.18"></a><span id="l24.18">   // We know this, and the failure is harmless.</span>
<a href="#l24.19"></a><span id="l24.19">   if (aBaseURI)</span>
<a href="#l24.20"></a><span id="l24.20">   {</span>
<a href="#l24.21"></a><span id="l24.21">     nsAutoCString newSpec;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -212,30 +212,29 @@ nsresult nsPop3Service::BuildPop3Url(con</span>
<a href="#l25.4"></a><span id="l25.4">   pop3Sink-&gt;SetFolder(inbox);</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6">   // now create a pop3 url and a protocol instance to run the url....</span>
<a href="#l25.7"></a><span id="l25.7">   nsCOMPtr&lt;nsIPop3URL&gt; pop3Url = do_CreateInstance(kPop3UrlCID, &amp;rv);</span>
<a href="#l25.8"></a><span id="l25.8">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10">   pop3Url-&gt;SetPop3Sink(pop3Sink);</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  rv = CallQueryInterface(pop3Url, aUrl);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+  rv = pop3Url-&gt;QueryInterface(NS_GET_IID(nsIMsgMailNewsUrl), getter_AddRefs(mailnewsurl));</span>
<a href="#l25.15"></a><span id="l25.15">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-  rv = (*aUrl)-&gt;SetSpecInternal(nsDependentCString(urlSpec));</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+  rv = mailnewsurl-&gt;SetSpecInternal(nsDependentCString(urlSpec));</span>
<a href="#l25.19"></a><span id="l25.19">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(pop3Url);</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-  {</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-    if (aUrlListener)</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-      mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-    if (aMsgWindow)</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-      mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-  }</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+  if (aUrlListener)</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+    mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+  if (aMsgWindow)</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+    mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+  mailnewsurl.forget(aUrl);</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36">   return rv;</span>
<a href="#l25.37"></a><span id="l25.37"> }</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39"> nsresult nsPop3Service::RunPopUrl(nsIMsgIncomingServer *aServer, nsIURI *aUrlToRun)</span>
<a href="#l25.40"></a><span id="l25.40"> {</span>
<a href="#l25.41"></a><span id="l25.41"> </span>
<a href="#l25.42"></a><span id="l25.42">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineat">@@ -380,45 +379,41 @@ NS_IMETHODIMP nsPop3Service::NewURI(cons</span>
<a href="#l25.44"></a><span id="l25.44">     nsCString username;</span>
<a href="#l25.45"></a><span id="l25.45">     server-&gt;GetHostName(hostname);</span>
<a href="#l25.46"></a><span id="l25.46">     server-&gt;GetUsername(username);</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48">     int32_t port;</span>
<a href="#l25.49"></a><span id="l25.49">     server-&gt;GetPort(&amp;port);</span>
<a href="#l25.50"></a><span id="l25.50">     if (port == -1) port = nsIPop3URL::DEFAULT_POP3_PORT;</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-    // we need to escape the username because it may contain</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-    // characters like / % or @</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+    // We need to escape the username before calling SetUsername() because it may</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+    // contain characters like / % or @. GetUsername() will unescape the username.</span>
<a href="#l25.56"></a><span id="l25.56">     nsCString escapedUsername;</span>
<a href="#l25.57"></a><span id="l25.57">     MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l25.58"></a><span id="l25.58"> </span>
<a href="#l25.59"></a><span id="l25.59">     nsAutoCString popSpec(&quot;pop://&quot;);</span>
<a href="#l25.60"></a><span id="l25.60">     popSpec += escapedUsername;</span>
<a href="#l25.61"></a><span id="l25.61">     popSpec += &quot;@&quot;;</span>
<a href="#l25.62"></a><span id="l25.62">     popSpec += hostname;</span>
<a href="#l25.63"></a><span id="l25.63">     popSpec += &quot;:&quot;;</span>
<a href="#l25.64"></a><span id="l25.64">     popSpec.AppendInt(port);</span>
<a href="#l25.65"></a><span id="l25.65">     popSpec += &quot;?&quot;;</span>
<a href="#l25.66"></a><span id="l25.66">     popSpec += uidl;</span>
<a href="#l25.67"></a><span id="l25.67">     nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l25.68"></a><span id="l25.68">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.69"></a><span id="l25.69"> </span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l25.71"></a><span id="l25.71">     rv = BuildPop3Url(popSpec.get(), folder, popServer,</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-                      urlListener, _retval, nullptr);</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+                      urlListener, getter_AddRefs(newUri), nullptr);</span>
<a href="#l25.74"></a><span id="l25.74">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.75"></a><span id="l25.75"> </span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(*_retval, &amp;rv);</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-    {</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-      // escape the username before we call SetUsername().  we do this because GetUsername()</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-      // will unescape the username</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-      mailnewsurl-&gt;SetUsername(escapedUsername);</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-    }</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+    rv = NS_MutateURI(newUri).SetUsername(escapedUsername).Finalize(newUri);</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.85"></a><span id="l25.85"> </span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-    nsCOMPtr&lt;nsIPop3URL&gt; popurl = do_QueryInterface(mailnewsurl, &amp;rv);</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+    nsCOMPtr&lt;nsIPop3URL&gt; popurl = do_QueryInterface(newUri, &amp;rv);</span>
<a href="#l25.88"></a><span id="l25.88">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.89"></a><span id="l25.89"> </span>
<a href="#l25.90"></a><span id="l25.90">     nsAutoCString messageUri (aSpec);</span>
<a href="#l25.91"></a><span id="l25.91">     if (!strncmp(messageUri.get(), &quot;mailbox:&quot;, 8))</span>
<a href="#l25.92"></a><span id="l25.92">       messageUri.Replace(0, 8, &quot;mailbox-message:&quot;);</span>
<a href="#l25.93"></a><span id="l25.93">     offset = messageUri.Find(&quot;?number=&quot;);</span>
<a href="#l25.94"></a><span id="l25.94">     if (offset != kNotFound)</span>
<a href="#l25.95"></a><span id="l25.95">       messageUri.Replace(offset, 8, &quot;#&quot;);</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineat">@@ -427,16 +422,17 @@ NS_IMETHODIMP nsPop3Service::NewURI(cons</span>
<a href="#l25.97"></a><span id="l25.97">       messageUri.SetLength(offset);</span>
<a href="#l25.98"></a><span id="l25.98">     popurl-&gt;SetMessageUri(messageUri.get());</span>
<a href="#l25.99"></a><span id="l25.99">     nsCOMPtr&lt;nsIPop3Sink&gt; pop3Sink;</span>
<a href="#l25.100"></a><span id="l25.100">     rv = popurl-&gt;GetPop3Sink(getter_AddRefs(pop3Sink));</span>
<a href="#l25.101"></a><span id="l25.101">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.102"></a><span id="l25.102"> </span>
<a href="#l25.103"></a><span id="l25.103">     pop3Sink-&gt;SetBuildMessageUri(true);</span>
<a href="#l25.104"></a><span id="l25.104"> </span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+    newUri.forget(_retval);</span>
<a href="#l25.106"></a><span id="l25.106">     return NS_OK;</span>
<a href="#l25.107"></a><span id="l25.107"> }</span>
<a href="#l25.108"></a><span id="l25.108"> </span>
<a href="#l25.109"></a><span id="l25.109"> void nsPop3Service::AlertServerBusy(nsIMsgMailNewsUrl *url)</span>
<a href="#l25.110"></a><span id="l25.110"> {</span>
<a href="#l25.111"></a><span id="l25.111">   nsresult rv;</span>
<a href="#l25.112"></a><span id="l25.112">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l25.113"></a><span id="l25.113">     mozilla::services::GetStringBundleService();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -26,16 +26,17 @@</span>
<a href="#l26.4"></a><span id="l26.4"> #include &quot;prerror.h&quot;</span>
<a href="#l26.5"></a><span id="l26.5"> #include &quot;nsString.h&quot;</span>
<a href="#l26.6"></a><span id="l26.6"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l26.7"></a><span id="l26.7"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l26.8"></a><span id="l26.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l26.9"></a><span id="l26.9"> #include &quot;mozilla/SlicedInputStream.h&quot;</span>
<a href="#l26.10"></a><span id="l26.10"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l26.11"></a><span id="l26.11"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l26.13"></a><span id="l26.13"> </span>
<a href="#l26.14"></a><span id="l26.14"> #include &quot;prprf.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16"> /* include event sink interfaces for news */</span>
<a href="#l26.17"></a><span id="l26.17"> </span>
<a href="#l26.18"></a><span id="l26.18"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l26.19"></a><span id="l26.19"> #include &quot;nsIMsgSearchAdapter.h&quot;</span>
<a href="#l26.20"></a><span id="l26.20"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineat">@@ -342,17 +343,17 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l26.22"></a><span id="l26.22">     rv = server-&gt;GetPort(&amp;port);</span>
<a href="#l26.23"></a><span id="l26.23">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25">     if (port&lt;=0) {</span>
<a href="#l26.26"></a><span id="l26.26">       port = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l26.27"></a><span id="l26.27">              nsINntpUrl::DEFAULT_NNTPS_PORT : nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l26.28"></a><span id="l26.28">     }</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-    rv = m_url-&gt;SetPort(port);</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+    rv = NS_MutateURI(m_url).SetPort(port).Finalize(m_url);</span>
<a href="#l26.32"></a><span id="l26.32">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.33"></a><span id="l26.33">   }</span>
<a href="#l26.34"></a><span id="l26.34"> </span>
<a href="#l26.35"></a><span id="l26.35">   NS_PRECONDITION(m_url, &quot;invalid URL passed into NNTP Protocol&quot;);</span>
<a href="#l26.36"></a><span id="l26.36"> </span>
<a href="#l26.37"></a><span id="l26.37">   m_runningURL = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l26.38"></a><span id="l26.38">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.39"></a><span id="l26.39">   SetIsBusy(true);</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineat">@@ -824,26 +825,27 @@ nsresult nsNNTPProtocol::OpenCacheEntry(</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42">   // Open a cache entry with key = url, no extension.</span>
<a href="#l26.43"></a><span id="l26.43">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l26.44"></a><span id="l26.44">   rv = mailnewsUrl-&gt;GetBaseURI(getter_AddRefs(uri));</span>
<a href="#l26.45"></a><span id="l26.45">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.46"></a><span id="l26.46"> </span>
<a href="#l26.47"></a><span id="l26.47">   // Truncate of the query part so we don't duplicate urls in the cache for</span>
<a href="#l26.48"></a><span id="l26.48">   // various message parts.</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+  nsAutoCString path;</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+  uri-&gt;GetPathQueryRef(path);</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+  int32_t pos = path.FindChar('?');</span>
<a href="#l26.52"></a><span id="l26.52">   nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  uri-&gt;Clone(getter_AddRefs(newUri));</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-  nsAutoCString path;</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-  newUri-&gt;GetPathQueryRef(path);</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-  int32_t pos = path.FindChar('?');</span>
<a href="#l26.57"></a><span id="l26.57">   if (pos != kNotFound) {</span>
<a href="#l26.58"></a><span id="l26.58">     path.SetLength(pos);</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-    newUri-&gt;SetPathQueryRef(path);</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+    rv = NS_MutateURI(uri).SetPathQueryRef(path).Finalize(newUri);</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.62"></a><span id="l26.62">   }</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-  return cacheStorage-&gt;AsyncOpenURI(newUri, EmptyCString(), nsICacheStorage::OPEN_NORMALLY, this);</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+  return cacheStorage-&gt;AsyncOpenURI(newUri ? newUri : uri, EmptyCString(),</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+                                    nsICacheStorage::OPEN_NORMALLY, this);</span>
<a href="#l26.66"></a><span id="l26.66"> }</span>
<a href="#l26.67"></a><span id="l26.67"> </span>
<a href="#l26.68"></a><span id="l26.68"> NS_IMETHODIMP nsNNTPProtocol::AsyncOpen(nsIStreamListener *listener, nsISupports *ctxt)</span>
<a href="#l26.69"></a><span id="l26.69"> {</span>
<a href="#l26.70"></a><span id="l26.70">   nsresult rv;</span>
<a href="#l26.71"></a><span id="l26.71">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l26.72"></a><span id="l26.72">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l26.73"></a><span id="l26.73"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -61,16 +61,17 @@</span>
<a href="#l27.4"></a><span id="l27.4"> #include &quot;nsILoginManager.h&quot;</span>
<a href="#l27.5"></a><span id="l27.5"> #include &quot;nsIPromptService.h&quot;</span>
<a href="#l27.6"></a><span id="l27.6"> #include &quot;nsEmbedCID.h&quot;</span>
<a href="#l27.7"></a><span id="l27.7"> #include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l27.8"></a><span id="l27.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l27.9"></a><span id="l27.9"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l27.10"></a><span id="l27.10"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l27.11"></a><span id="l27.11"> #include &quot;nsMemory.h&quot;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l27.13"></a><span id="l27.13"> </span>
<a href="#l27.14"></a><span id="l27.14"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16"> // ###tw  This really ought to be the most</span>
<a href="#l27.17"></a><span id="l27.17"> // efficient file reading size for the current</span>
<a href="#l27.18"></a><span id="l27.18"> // operating system.</span>
<a href="#l27.19"></a><span id="l27.19"> #define NEWSRC_FILE_BUFFER_SIZE 1024</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21" class="difflineat">@@ -1082,42 +1083,41 @@ NS_IMETHODIMP nsMsgNewsFolder::SetGroupP</span>
<a href="#l27.22"></a><span id="l27.22">   mGroupPassword = aGroupPassword;</span>
<a href="#l27.23"></a><span id="l27.23">   return NS_OK;</span>
<a href="#l27.24"></a><span id="l27.24"> }</span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26"> nsresult nsMsgNewsFolder::CreateNewsgroupUrlForSignon(const char *ref,</span>
<a href="#l27.27"></a><span id="l27.27">     nsAString &amp;result)</span>
<a href="#l27.28"></a><span id="l27.28"> {</span>
<a href="#l27.29"></a><span id="l27.29">   nsresult rv;</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-  nsCOMPtr&lt;nsIURL&gt; url = do_CreateInstance(NS_STANDARDURL_CONTRACTID, &amp;rv);</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l27.32"></a><span id="l27.32"> </span>
<a href="#l27.33"></a><span id="l27.33">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l27.34"></a><span id="l27.34">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l27.35"></a><span id="l27.35">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.36"></a><span id="l27.36"> </span>
<a href="#l27.37"></a><span id="l27.37">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l27.38"></a><span id="l27.38">   rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l27.39"></a><span id="l27.39">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41">   bool singleSignon = true;</span>
<a href="#l27.42"></a><span id="l27.42">   rv = nntpServer-&gt;GetSingleSignon(&amp;singleSignon);</span>
<a href="#l27.43"></a><span id="l27.43"> </span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+  nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l27.45"></a><span id="l27.45">   if (singleSignon)</span>
<a href="#l27.46"></a><span id="l27.46">   {</span>
<a href="#l27.47"></a><span id="l27.47">     nsCString serverURI;</span>
<a href="#l27.48"></a><span id="l27.48">     rv = server-&gt;GetServerURI(serverURI);</span>
<a href="#l27.49"></a><span id="l27.49">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.50"></a><span id="l27.50"> </span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-    rv = url-&gt;SetSpecInternal(serverURI);</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(serverURI).Finalize(url);</span>
<a href="#l27.53"></a><span id="l27.53">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.54"></a><span id="l27.54">   }</span>
<a href="#l27.55"></a><span id="l27.55">   else</span>
<a href="#l27.56"></a><span id="l27.56">   {</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-    rv = url-&gt;SetSpecInternal(mURI);</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(mURI).Finalize(url);</span>
<a href="#l27.59"></a><span id="l27.59">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.60"></a><span id="l27.60">   }</span>
<a href="#l27.61"></a><span id="l27.61"> </span>
<a href="#l27.62"></a><span id="l27.62">   int32_t port = 0;</span>
<a href="#l27.63"></a><span id="l27.63">   rv = url-&gt;GetPort(&amp;port);</span>
<a href="#l27.64"></a><span id="l27.64">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.65"></a><span id="l27.65"> </span>
<a href="#l27.66"></a><span id="l27.66">   if (port &lt;= 0)</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineat">@@ -1130,25 +1130,25 @@ nsresult nsMsgNewsFolder::CreateNewsgrou</span>
<a href="#l27.68"></a><span id="l27.68">     nsresult rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l27.69"></a><span id="l27.69">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.70"></a><span id="l27.70"> </span>
<a href="#l27.71"></a><span id="l27.71">     // Only set this for ssl newsgroups as for non-ssl connections, we don't</span>
<a href="#l27.72"></a><span id="l27.72">     // need to specify the port as it is the default for the protocol and</span>
<a href="#l27.73"></a><span id="l27.73">     // password manager &quot;blanks&quot; those out.</span>
<a href="#l27.74"></a><span id="l27.74">     if (socketType == nsMsgSocketType::SSL)</span>
<a href="#l27.75"></a><span id="l27.75">     {</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineminus">-      rv = url-&gt;SetPort(nsINntpUrl::DEFAULT_NNTPS_PORT);</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+      rv = NS_MutateURI(url).SetPort(nsINntpUrl::DEFAULT_NNTPS_PORT).Finalize(url);</span>
<a href="#l27.78"></a><span id="l27.78">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.79"></a><span id="l27.79">     }</span>
<a href="#l27.80"></a><span id="l27.80">   }</span>
<a href="#l27.81"></a><span id="l27.81"> </span>
<a href="#l27.82"></a><span id="l27.82">   nsCString rawResult;</span>
<a href="#l27.83"></a><span id="l27.83">   if (ref)</span>
<a href="#l27.84"></a><span id="l27.84">   {</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineminus">-    rv = url-&gt;SetRef(nsDependentCString(ref));</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+    rv = NS_MutateURI(url).SetRef(nsDependentCString(ref)).Finalize(url);</span>
<a href="#l27.87"></a><span id="l27.87">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.88"></a><span id="l27.88"> </span>
<a href="#l27.89"></a><span id="l27.89">     rv = url-&gt;GetSpec(rawResult);</span>
<a href="#l27.90"></a><span id="l27.90">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.91"></a><span id="l27.91">   }</span>
<a href="#l27.92"></a><span id="l27.92">   else</span>
<a href="#l27.93"></a><span id="l27.93">   {</span>
<a href="#l27.94"></a><span id="l27.94">     // If the url doesn't have a path, make sure we don't get a '/' on the end</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -48,16 +48,18 @@</span>
<a href="#l28.4"></a><span id="l28.4"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsICommandLine.h&quot;</span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l28.11"></a><span id="l28.11"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+</span>
<a href="#l28.14"></a><span id="l28.14"> #include &quot;../../base/src/MailnewsLoadContextInfo.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15"> </span>
<a href="#l28.16"></a><span id="l28.16"> #undef GetPort  // XXX Windows!</span>
<a href="#l28.17"></a><span id="l28.17"> #undef SetPort  // XXX Windows!</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19"> #define PREF_MAIL_ROOT_NNTP   &quot;mail.root.nntp&quot;        // old - for backward compatibility only</span>
<a href="#l28.20"></a><span id="l28.20"> #define PREF_MAIL_ROOT_NNTP_REL   &quot;mail.root.nntp-rel&quot;</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -227,20 +229,17 @@ nsNntpService::DisplayMessage(const char</span>
<a href="#l28.23"></a><span id="l28.23">   nsNewsAction action = nsINntpUrl::ActionFetchArticle;</span>
<a href="#l28.24"></a><span id="l28.24">   if (mOpenAttachmentOperation)</span>
<a href="#l28.25"></a><span id="l28.25">     action = nsINntpUrl::ActionFetchPart;</span>
<a href="#l28.26"></a><span id="l28.26"> </span>
<a href="#l28.27"></a><span id="l28.27">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l28.28"></a><span id="l28.28">   rv = ConstructNntpUrl(urlStr.get(), aUrlListener, aMsgWindow, aMessageURI, action, getter_AddRefs(url));</span>
<a href="#l28.29"></a><span id="l28.29">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.30"></a><span id="l28.30"> </span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(url,&amp;rv);</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-  nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nurl = do_QueryInterface(msgUrl,&amp;rv);</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+  nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nurl = do_QueryInterface(url, &amp;rv);</span>
<a href="#l28.36"></a><span id="l28.36">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   i18nurl-&gt;SetCharsetOverRide(aCharsetOverride);</span>
<a href="#l28.39"></a><span id="l28.39"> </span>
<a href="#l28.40"></a><span id="l28.40">   bool shouldStoreMsgOffline = false;</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42">   if (folder)</span>
<a href="#l28.43"></a><span id="l28.43">   {</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineat">@@ -262,17 +261,17 @@ nsNntpService::DisplayMessage(const char</span>
<a href="#l28.45"></a><span id="l28.45">         int32_t socketType;</span>
<a href="#l28.46"></a><span id="l28.46">         rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l28.47"></a><span id="l28.47">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.48"></a><span id="l28.48"> </span>
<a href="#l28.49"></a><span id="l28.49">         port = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l28.50"></a><span id="l28.50">                nsINntpUrl::DEFAULT_NNTPS_PORT : nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l28.51"></a><span id="l28.51">       }</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-      rv = url-&gt;SetPort(port);</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+      rv = NS_MutateURI(url).SetPort(port).Finalize(url);</span>
<a href="#l28.55"></a><span id="l28.55">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.56"></a><span id="l28.56">     }</span>
<a href="#l28.57"></a><span id="l28.57"> </span>
<a href="#l28.58"></a><span id="l28.58">     folder-&gt;ShouldStoreMsgOffline(key, &amp;shouldStoreMsgOffline);</span>
<a href="#l28.59"></a><span id="l28.59"> </span>
<a href="#l28.60"></a><span id="l28.60">     // Look for the message in the offline cache</span>
<a href="#l28.61"></a><span id="l28.61">     bool hasMsgOffline = false;</span>
<a href="#l28.62"></a><span id="l28.62">     folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineat">@@ -283,17 +282,19 @@ nsNntpService::DisplayMessage(const char</span>
<a href="#l28.64"></a><span id="l28.64">       rv = IsMsgInMemCache(url, folder, &amp;hasMsgOffline);</span>
<a href="#l28.65"></a><span id="l28.65">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.66"></a><span id="l28.66">     }</span>
<a href="#l28.67"></a><span id="l28.67"> </span>
<a href="#l28.68"></a><span id="l28.68">     // If the message is not found in either, then we might need to return</span>
<a href="#l28.69"></a><span id="l28.69">     if (!hasMsgOffline &amp;&amp; WeAreOffline())</span>
<a href="#l28.70"></a><span id="l28.70">       return server-&gt;DisplayOfflineMsg(aMsgWindow);</span>
<a href="#l28.71"></a><span id="l28.71"> </span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-    msgUrl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(url,&amp;rv);</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+    mailnewsurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l28.76"></a><span id="l28.76"> </span>
<a href="#l28.77"></a><span id="l28.77">     nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l28.78"></a><span id="l28.78">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.79"></a><span id="l28.79">     newsFolder-&gt;SetSaveArticleOffline(shouldStoreMsgOffline);</span>
<a href="#l28.80"></a><span id="l28.80">   }</span>
<a href="#l28.81"></a><span id="l28.81"> </span>
<a href="#l28.82"></a><span id="l28.82">   rv = GetMessageFromUrl(url, aMsgWindow, aDisplayConsumer);</span>
<a href="#l28.83"></a><span id="l28.83">   if (aURL)</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineat">@@ -1204,24 +1205,25 @@ NS_IMETHODIMP nsNntpService::GetProtocol</span>
<a href="#l28.85"></a><span id="l28.85"> </span>
<a href="#l28.86"></a><span id="l28.86"> NS_IMETHODIMP nsNntpService::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l28.87"></a><span id="l28.87">                                     const char *aCharset, // ignored</span>
<a href="#l28.88"></a><span id="l28.88">                                     nsIURI *aBaseURI,</span>
<a href="#l28.89"></a><span id="l28.89">                                     nsIURI **_retval)</span>
<a href="#l28.90"></a><span id="l28.90"> {</span>
<a href="#l28.91"></a><span id="l28.91">     nsresult rv;</span>
<a href="#l28.92"></a><span id="l28.92"> </span>
<a href="#l28.93"></a><span id="l28.93" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; nntpUri = do_CreateInstance(NS_NNTPURL_CONTRACTID, &amp;rv);</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; nntpUri = do_CreateInstance(NS_NNTPURL_CONTRACTID, &amp;rv);</span>
<a href="#l28.95"></a><span id="l28.95">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.96"></a><span id="l28.96"> </span>
<a href="#l28.97"></a><span id="l28.97">     if (aBaseURI)</span>
<a href="#l28.98"></a><span id="l28.98">     {</span>
<a href="#l28.99"></a><span id="l28.99">       nsAutoCString newSpec;</span>
<a href="#l28.100"></a><span id="l28.100">       aBaseURI-&gt;Resolve(aSpec, newSpec);</span>
<a href="#l28.101"></a><span id="l28.101">       rv = nntpUri-&gt;SetSpecInternal(newSpec);</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+      // XXX Consider: rv = NS_MutateURI(new nsNntpUrl::Mutator()).SetSpec(newSpec).Finalize(nntpUri);</span>
<a href="#l28.103"></a><span id="l28.103">     }</span>
<a href="#l28.104"></a><span id="l28.104">     else</span>
<a href="#l28.105"></a><span id="l28.105">     {</span>
<a href="#l28.106"></a><span id="l28.106">       rv = nntpUri-&gt;SetSpecInternal(aSpec);</span>
<a href="#l28.107"></a><span id="l28.107">     }</span>
<a href="#l28.108"></a><span id="l28.108">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.109"></a><span id="l28.109"> </span>
<a href="#l28.110"></a><span id="l28.110">     nntpUri.forget(_retval);</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineat">@@ -1423,40 +1425,44 @@ nsNntpService::StreamMessage(const char </span>
<a href="#l28.112"></a><span id="l28.112">     nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l28.113"></a><span id="l28.113">     rv = ConstructNntpUrl(urlStr.get(), aUrlListener, aMsgWindow, aURIString.get(),</span>
<a href="#l28.114"></a><span id="l28.114">                           action, getter_AddRefs(url));</span>
<a href="#l28.115"></a><span id="l28.115">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.116"></a><span id="l28.116"> </span>
<a href="#l28.117"></a><span id="l28.117">     if (aLocalOnly || WeAreOffline())</span>
<a href="#l28.118"></a><span id="l28.118">     {</span>
<a href="#l28.119"></a><span id="l28.119">       // Check in the offline cache, then in the mem cache</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(url, &amp;rv));</span>
<a href="#l28.121"></a><span id="l28.121">       bool hasMsgOffline = false;</span>
<a href="#l28.122"></a><span id="l28.122">       folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l28.123"></a><span id="l28.123">       if (!hasMsgOffline)</span>
<a href="#l28.124"></a><span id="l28.124">       {</span>
<a href="#l28.125"></a><span id="l28.125">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l28.126"></a><span id="l28.126">         rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l28.127"></a><span id="l28.127">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.128"></a><span id="l28.128"> </span>
<a href="#l28.129"></a><span id="l28.129">         int32_t socketType;</span>
<a href="#l28.130"></a><span id="l28.130">         rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l28.131"></a><span id="l28.131">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.132"></a><span id="l28.132"> </span>
<a href="#l28.133"></a><span id="l28.133" class="difflineminus">-        url-&gt;SetPort((socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineminus">-                     nsINntpUrl::DEFAULT_NNTPS_PORT : nsINntpUrl::DEFAULT_NNTP_PORT);</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+        rv = NS_MutateURI(url)</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+               .SetPort(socketType == nsMsgSocketType::SSL ?</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+                          nsINntpUrl::DEFAULT_NNTPS_PORT :</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+                          nsINntpUrl::DEFAULT_NNTP_PORT)</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineplus">+               .Finalize(url);</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.141"></a><span id="l28.141"> </span>
<a href="#l28.142"></a><span id="l28.142">         rv = IsMsgInMemCache(url, folder, &amp;hasMsgOffline);</span>
<a href="#l28.143"></a><span id="l28.143">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.144"></a><span id="l28.144">       }</span>
<a href="#l28.145"></a><span id="l28.145"> </span>
<a href="#l28.146"></a><span id="l28.146">       // Return with an error if we didn't find it in the memory cache either</span>
<a href="#l28.147"></a><span id="l28.147">       if (!hasMsgOffline)</span>
<a href="#l28.148"></a><span id="l28.148">         return NS_ERROR_FAILURE;</span>
<a href="#l28.149"></a><span id="l28.149"> </span>
<a href="#l28.150"></a><span id="l28.150" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(url, &amp;rv));</span>
<a href="#l28.151"></a><span id="l28.151">       msgUrl-&gt;SetMsgIsInLocalCache(true);</span>
<a href="#l28.152"></a><span id="l28.152">     }</span>
<a href="#l28.153"></a><span id="l28.153"> </span>
<a href="#l28.154"></a><span id="l28.154">     rv = GetMessageFromUrl(url, aMsgWindow, aConsumer);</span>
<a href="#l28.155"></a><span id="l28.155">     if (aURL)</span>
<a href="#l28.156"></a><span id="l28.156">       url.forget(aURL);</span>
<a href="#l28.157"></a><span id="l28.157">     return rv;</span>
<a href="#l28.158"></a><span id="l28.158"> }</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineat">@@ -1504,27 +1510,30 @@ NS_IMETHODIMP nsNntpService::IsMsgInMemC</span>
<a href="#l28.160"></a><span id="l28.160"> {</span>
<a href="#l28.161"></a><span id="l28.161">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l28.162"></a><span id="l28.162">   *aResult = false;</span>
<a href="#l28.163"></a><span id="l28.163">   nsresult rv;</span>
<a href="#l28.164"></a><span id="l28.164"> </span>
<a href="#l28.165"></a><span id="l28.165">   if (mCacheStorage)</span>
<a href="#l28.166"></a><span id="l28.166">   {</span>
<a href="#l28.167"></a><span id="l28.167">     // NNTP urls are truncated at the query part when used as cache keys.</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineminus">-    nsCOMPtr &lt;nsIURI&gt; newUri;</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineminus">-    aUrl-&gt;Clone(getter_AddRefs(newUri));</span>
<a href="#l28.170"></a><span id="l28.170">     nsAutoCString path;</span>
<a href="#l28.171"></a><span id="l28.171" class="difflineminus">-    newUri-&gt;GetPathQueryRef(path);</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineplus">+    aUrl-&gt;GetPathQueryRef(path);</span>
<a href="#l28.173"></a><span id="l28.173">     int32_t pos = path.FindChar('?');</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l28.175"></a><span id="l28.175">     if (pos != kNotFound) {</span>
<a href="#l28.176"></a><span id="l28.176">       path.SetLength(pos);</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineminus">-      newUri-&gt;SetPathQueryRef(path);</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineplus">+      rv = NS_MutateURI(aUrl).SetPathQueryRef(path).Finalize(newUri);</span>
<a href="#l28.179"></a><span id="l28.179" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.180"></a><span id="l28.180">     }</span>
<a href="#l28.181"></a><span id="l28.181">     bool exists;</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineminus">-    rv = mCacheStorage-&gt;Exists(newUri, EmptyCString(), &amp;exists);</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineplus">+    if (newUri)</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineplus">+      rv = mCacheStorage-&gt;Exists(newUri, EmptyCString(), &amp;exists);</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineplus">+    else</span>
<a href="#l28.186"></a><span id="l28.186" class="difflineplus">+      rv = mCacheStorage-&gt;Exists(aUrl, EmptyCString(), &amp;exists);</span>
<a href="#l28.187"></a><span id="l28.187">     if (NS_SUCCEEDED(rv) &amp;&amp; exists) {</span>
<a href="#l28.188"></a><span id="l28.188">       *aResult = true;</span>
<a href="#l28.189"></a><span id="l28.189">     }</span>
<a href="#l28.190"></a><span id="l28.190">   }</span>
<a href="#l28.191"></a><span id="l28.191"> </span>
<a href="#l28.192"></a><span id="l28.192">   return NS_OK;</span>
<a href="#l28.193"></a><span id="l28.193"> }</span>
<a href="#l28.194"></a><span id="l28.194"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

