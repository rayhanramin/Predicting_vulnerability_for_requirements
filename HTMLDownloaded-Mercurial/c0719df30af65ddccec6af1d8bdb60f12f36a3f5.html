<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21115:c0719df30af65ddccec6af1d8bdb60f12f36a3f5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c0719df30af65ddccec6af1d8bdb60f12f36a3f5" />
<meta property="og:url" content="/comm-central/rev/c0719df30af65ddccec6af1d8bdb60f12f36a3f5" />
<meta property="og:description" content="Bug 1332246 - Don't expect kABInstantMessageProperty values to be NSStrings. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c0719df30af65ddccec6af1d8bdb60f12f36a3f5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c0719df30af65ddccec6af1d8bdb60f12f36a3f5">shortlog</a> |
<a href="/comm-central/log/c0719df30af65ddccec6af1d8bdb60f12f36a3f5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c0719df30af65ddccec6af1d8bdb60f12f36a3f5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c0719df30af65ddccec6af1d8bdb60f12f36a3f5">files</a> |
changeset |
<a href="/comm-central/raw-rev/c0719df30af65ddccec6af1d8bdb60f12f36a3f5">raw</a>  | <a href="/comm-central/archive/c0719df30af65ddccec6af1d8bdb60f12f36a3f5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1332246">Bug 1332246</a> - Don't expect kABInstantMessageProperty values to be NSStrings. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#117;&#115;&#32;&#83;&#116;&#97;&#110;&#103;&#101;&#32;&#60;&#109;&#115;&#116;&#97;&#110;&#103;&#101;&#64;&#116;&#104;&#101;&#109;&#97;&#115;&#116;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 05 Feb 2017 19:18:30 -0500</td></tr>

<tr>
 <td>changeset 21115</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c0719df30af65ddccec6af1d8bdb60f12f36a3f5">c0719df30af65ddccec6af1d8bdb60f12f36a3f5</a></td>
</tr>



<tr>
<td>parent 21114</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f9c681da2d3121e7dded4e41044cc895ada64722">f9c681da2d3121e7dded4e41044cc895ada64722</a>
</td>
</tr>

<tr>
<td>child 21116</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/03dfa060aa19752c83105fe63eed57230555d1b1">03dfa060aa19752c83105fe63eed57230555d1b1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c0719df30af65ddccec6af1d8bdb60f12f36a3f5">12827</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 08 Feb 2017 08:36:05 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c0719df30af6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c0719df30af65ddccec6af1d8bdb60f12f36a3f5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c0719df30af65ddccec6af1d8bdb60f12f36a3f5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0719df30af65ddccec6af1d8bdb60f12f36a3f5&newProject=comm-central&newRevision=c0719df30af65ddccec6af1d8bdb60f12f36a3f5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0719df30af65ddccec6af1d8bdb60f12f36a3f5&newProject=comm-central&newRevision=c0719df30af65ddccec6af1d8bdb60f12f36a3f5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0719df30af65ddccec6af1d8bdb60f12f36a3f5&newProject=comm-central&newRevision=c0719df30af65ddccec6af1d8bdb60f12f36a3f5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1332246">1332246</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1332246">Bug 1332246</a> - Don't expect kABInstantMessageProperty values to be NSStrings. r=mconley

In 10.12 on my machine they are NSDictionary values. This patch also respects
the instant messaging service name and assigns the user name to the right
field, or even to multiple fields if multiple IM services are specified.

MozReview-Commit-ID: 4oxg1CXjo0D</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0719df30af65ddccec6af1d8bdb60f12f36a3f5/mailnews/addrbook/src/nsAbOSXCard.mm">mailnews/addrbook/src/nsAbOSXCard.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0719df30af65ddccec6af1d8bdb60f12f36a3f5/mailnews/addrbook/src/nsAbOSXCard.mm">file</a> |
<a href="/comm-central/annotate/c0719df30af65ddccec6af1d8bdb60f12f36a3f5/mailnews/addrbook/src/nsAbOSXCard.mm">annotate</a> |
<a href="/comm-central/diff/c0719df30af65ddccec6af1d8bdb60f12f36a3f5/mailnews/addrbook/src/nsAbOSXCard.mm">diff</a> |
<a href="/comm-central/comparison/c0719df30af65ddccec6af1d8bdb60f12f36a3f5/mailnews/addrbook/src/nsAbOSXCard.mm">comparison</a> |
<a href="/comm-central/log/c0719df30af65ddccec6af1d8bdb60f12f36a3f5/mailnews/addrbook/src/nsAbOSXCard.mm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -129,16 +129,50 @@ MapMultiValue(nsAbOSXCard *aCard, ABReco</span>
<a href="#l1.4"></a><span id="l1.4">   }</span>
<a href="#l1.5"></a><span id="l1.5">   // String wasn't found, set value of card to empty if it was set previously</span>
<a href="#l1.6"></a><span id="l1.6">   SetStringProperty(aCard, EmptyString(), aMap.mPropertyName, aNotify,</span>
<a href="#l1.7"></a><span id="l1.7">                     aAbManager);</span>
<a href="#l1.8"></a><span id="l1.8">   </span>
<a href="#l1.9"></a><span id="l1.9">   return false;</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+// Maps Address Book's instant messenger name to the corresponding nsIAbCard field name.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+static const char*</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+InstantMessengerFieldName(NSString* aInstantMessengerName)</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+{</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  if ([aInstantMessengerName isEqualToString:@&quot;AIMInstant&quot;]) {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    return &quot;_AimScreenName&quot;;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  }</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  if ([aInstantMessengerName isEqualToString:@&quot;GoogleTalkInstant&quot;]) {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    return &quot;_GoogleTalk&quot;;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  }</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  if ([aInstantMessengerName isEqualToString:@&quot;ICQInstant&quot;]) {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    return &quot;_ICQ&quot;;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  }</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+  if ([aInstantMessengerName isEqualToString:@&quot;JabberInstant&quot;]) {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    return &quot;_JabberId&quot;;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+  }</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  if ([aInstantMessengerName isEqualToString:@&quot;MSNInstant&quot;]) {</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    return &quot;_MSN&quot;;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  }</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  if ([aInstantMessengerName isEqualToString:@&quot;QQInstant&quot;]) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    return &quot;_QQ&quot;;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  }</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  if ([aInstantMessengerName isEqualToString:@&quot;SkypeInstant&quot;]) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    return &quot;_Skype&quot;;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  }</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+  if ([aInstantMessengerName isEqualToString:@&quot;YahooInstant&quot;]) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    return &quot;_Yahoo&quot;;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  }</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  // Fall back to AIM for everything else.</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  // We don't have nsIAbCard fields for FacebookInstant and GaduGaduInstant.</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+  return &quot;_AimScreenName&quot;;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+}</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+</span>
<a href="#l1.46"></a><span id="l1.46"> nsresult</span>
<a href="#l1.47"></a><span id="l1.47"> nsAbOSXCard::Init(const char *aUri)</span>
<a href="#l1.48"></a><span id="l1.48"> {</span>
<a href="#l1.49"></a><span id="l1.49">   if (strncmp(aUri, NS_ABOSXCARD_URI_PREFIX,</span>
<a href="#l1.50"></a><span id="l1.50">               sizeof(NS_ABOSXCARD_URI_PREFIX) - 1) != 0)</span>
<a href="#l1.51"></a><span id="l1.51">     return NS_ERROR_FAILURE;</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">   mURI = aUri;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineat">@@ -304,22 +338,29 @@ nsAbOSXCard::Update(bool aNotify)</span>
<a href="#l1.55"></a><span id="l1.55">         }</span>
<a href="#l1.56"></a><span id="l1.56">       }</span>
<a href="#l1.57"></a><span id="l1.57">     }</span>
<a href="#l1.58"></a><span id="l1.58">   }</span>
<a href="#l1.59"></a><span id="l1.59">   // This was kABAIMInstantProperty previously, but it was deprecated in OS X 10.7.</span>
<a href="#l1.60"></a><span id="l1.60">   value = GetMultiValue(card, kABInstantMessageProperty);</span>
<a href="#l1.61"></a><span id="l1.61">   if (value) {</span>
<a href="#l1.62"></a><span id="l1.62">     unsigned int count = [value count];</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-    if (count &gt; 0) {</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-      unsigned int j = [value indexForIdentifier:[value primaryIdentifier]];</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-      </span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-      if (j &lt; count)</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-        SET_STRING([value valueAtIndex:j], AimScreenName, aNotify,</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-                   abManager);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    for (size_t i = 0; i &lt; count; i++) {</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+      id imValue = [value valueAtIndex:i];</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+      // Depending on the macOS version, imValue can be an NSString or an NSDictionary.</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+      if ([imValue isKindOfClass:[NSString class]]) {</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+        if (i == [value indexForIdentifier:[value primaryIdentifier]]) {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+          SET_STRING(imValue, _AimScreenName, aNotify, abManager);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+        }</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+      } else if ([imValue isKindOfClass:[NSDictionary class]]) {</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+        NSString* instantMessageService = [imValue objectForKey:@&quot;InstantMessageService&quot;];</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        const char* fieldName = InstantMessengerFieldName(instantMessageService);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+        NSString* userName = [imValue objectForKey:@&quot;InstantMessageUsername&quot;];</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        SetStringProperty(this, userName, fieldName, aNotify, abManager);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+      }</span>
<a href="#l1.82"></a><span id="l1.82">     }</span>
<a href="#l1.83"></a><span id="l1.83">   }</span>
<a href="#l1.84"></a><span id="l1.84">   </span>
<a href="#l1.85"></a><span id="l1.85"> #define MAP_DATE(_date, _name, _notify, _session) \</span>
<a href="#l1.86"></a><span id="l1.86">   MapDate(this, _date, #_name&quot;Year&quot;, #_name&quot;Month&quot;, #_name&quot;Day&quot;, _notify, \</span>
<a href="#l1.87"></a><span id="l1.87">   _session)</span>
<a href="#l1.88"></a><span id="l1.88">     </span>
<a href="#l1.89"></a><span id="l1.89">     NSDate *date = [card valueForProperty:kABBirthdayProperty];</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

