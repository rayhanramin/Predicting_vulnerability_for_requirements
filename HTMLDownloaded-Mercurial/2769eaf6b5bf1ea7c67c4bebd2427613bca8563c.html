<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10248:2769eaf6b5bf1ea7c67c4bebd2427613bca8563c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2769eaf6b5bf1ea7c67c4bebd2427613bca8563c" />
<meta property="og:url" content="/comm-central/rev/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c" />
<meta property="og:description" content="Fix bug 757332 - Remove e4x usage in the gdata provider (cpg fallout). r=mmecca" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2769eaf6b5bf1ea7c67c4bebd2427613bca8563c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c">shortlog</a> |
<a href="/comm-central/log/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c">files</a> |
changeset |
<a href="/comm-central/raw-rev/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c">raw</a>  | <a href="/comm-central/archive/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=757332">bug 757332</a> - Remove e4x usage in the gdata provider (cpg fallout). r=mmecca
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 24 May 2012 08:31:26 +0700</td></tr>

<tr>
 <td>changeset 10248</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c">2769eaf6b5bf1ea7c67c4bebd2427613bca8563c</a></td>
</tr>



<tr>
<td>parent 10247</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7180e9538d212b2adca4bc61090bee09fe6a7ded">7180e9538d212b2adca4bc61090bee09fe6a7ded</a>
</td>
</tr>

<tr>
<td>child 10249</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ae4c74d92fd19bd371082c2bbd9dd5451b443c79">ae4c74d92fd19bd371082c2bbd9dd5451b443c79</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2769eaf6b5bf1ea7c67c4bebd2427613bca8563c">7769</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Thu, 24 May 2012 01:40:42 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ae4c74d92fd1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ae4c74d92fd19bd371082c2bbd9dd5451b443c79">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ae4c74d92fd19bd371082c2bbd9dd5451b443c79&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ae4c74d92fd19bd371082c2bbd9dd5451b443c79&newProject=comm-central&newRevision=2769eaf6b5bf1ea7c67c4bebd2427613bca8563c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ae4c74d92fd19bd371082c2bbd9dd5451b443c79&newProject=comm-central&newRevision=2769eaf6b5bf1ea7c67c4bebd2427613bca8563c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ae4c74d92fd19bd371082c2bbd9dd5451b443c79&newProject=comm-central&newRevision=2769eaf6b5bf1ea7c67c4bebd2427613bca8563c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mmecca%29&revcount=50">mmecca</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=757332">757332</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=757332">bug 757332</a> - Remove e4x usage in the gdata provider (cpg fallout). r=mmecca</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleRequest.js">calendar/providers/gdata/components/calGoogleRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleRequest.js">file</a> |
<a href="/comm-central/annotate/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleRequest.js">annotate</a> |
<a href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleRequest.js">diff</a> |
<a href="/comm-central/comparison/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleRequest.js">comparison</a> |
<a href="/comm-central/log/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleSession.js">calendar/providers/gdata/components/calGoogleSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleSession.js">file</a> |
<a href="/comm-central/annotate/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleSession.js">annotate</a> |
<a href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleSession.js">diff</a> |
<a href="/comm-central/comparison/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleSession.js">comparison</a> |
<a href="/comm-central/log/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleUtils.js">calendar/providers/gdata/components/calGoogleUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleUtils.js">file</a> |
<a href="/comm-central/annotate/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleUtils.js">annotate</a> |
<a href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleUtils.js">diff</a> |
<a href="/comm-central/comparison/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleUtils.js">comparison</a> |
<a href="/comm-central/log/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/components/calGoogleUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/content/gdata-migration.js">calendar/providers/gdata/content/gdata-migration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/content/gdata-migration.js">file</a> |
<a href="/comm-central/annotate/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/content/gdata-migration.js">annotate</a> |
<a href="/comm-central/diff/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/content/gdata-migration.js">diff</a> |
<a href="/comm-central/comparison/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/content/gdata-migration.js">comparison</a> |
<a href="/comm-central/log/2769eaf6b5bf1ea7c67c4bebd2427613bca8563c/calendar/providers/gdata/content/gdata-migration.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -32,16 +32,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.5"></a><span id="l1.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.6"></a><span id="l1.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.7"></a><span id="l1.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.8"></a><span id="l1.8">  *</span>
<a href="#l1.9"></a><span id="l1.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> /**</span>
<a href="#l1.18"></a><span id="l1.18">  * calGoogleCalendar</span>
<a href="#l1.19"></a><span id="l1.19">  * This Implements a calICalendar Object adapted to the Google Calendar</span>
<a href="#l1.20"></a><span id="l1.20">  * Provider.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -56,17 +57,17 @@ function calGoogleCalendar() {</span>
<a href="#l1.22"></a><span id="l1.22"> calGoogleCalendar.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">     classDescription: &quot;Google Calendar Provider&quot;,</span>
<a href="#l1.26"></a><span id="l1.26">     contractID: &quot;@mozilla.org/calendar/calendar;1?type=gdata&quot;,</span>
<a href="#l1.27"></a><span id="l1.27">     classID:  Components.ID(&quot;{d1a6e988-4b4d-45a5-ba46-43e501ea96e3}&quot;),</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">     getInterfaces: function cI_cGC_getInterfaces (count) {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-        var ifaces = [</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+        let ifaces = [</span>
<a href="#l1.32"></a><span id="l1.32">             Components.interfaces.nsISupports,</span>
<a href="#l1.33"></a><span id="l1.33">             Components.interfaces.calICalendar,</span>
<a href="#l1.34"></a><span id="l1.34">             Components.interfaces.calIGoogleCalendar,</span>
<a href="#l1.35"></a><span id="l1.35">             Components.interfaces.calISchedulingSupport,</span>
<a href="#l1.36"></a><span id="l1.36">             Components.interfaces.calIChangeLog,</span>
<a href="#l1.37"></a><span id="l1.37">             Components.interfaces.nsIClassInfo</span>
<a href="#l1.38"></a><span id="l1.38">         ];</span>
<a href="#l1.39"></a><span id="l1.39">         count.value = ifaces.length;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineat">@@ -168,34 +169,34 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.41"></a><span id="l1.41">      *                               or not</span>
<a href="#l1.42"></a><span id="l1.42">      */</span>
<a href="#l1.43"></a><span id="l1.43">     findSession: function cGC_findSession(aIgnoreExistingSession) {</span>
<a href="#l1.44"></a><span id="l1.44">         if (this.mSession &amp;&amp; !aIgnoreExistingSession) {</span>
<a href="#l1.45"></a><span id="l1.45">             return true;</span>
<a href="#l1.46"></a><span id="l1.46">         }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">         // We need to find out which Google account fits to this calendar.</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-        var sessionMgr = getGoogleSessionManager();</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-        var googleUser = getCalendarPref(this, &quot;googleUser&quot;);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+        let sessionMgr = getGoogleSessionManager();</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+        let googleUser = getCalendarPref(this, &quot;googleUser&quot;);</span>
<a href="#l1.53"></a><span id="l1.53">         if (googleUser) {</span>
<a href="#l1.54"></a><span id="l1.54">             this.mSession = sessionMgr.getSessionByUsername(googleUser, true);</span>
<a href="#l1.55"></a><span id="l1.55">         } else {</span>
<a href="#l1.56"></a><span id="l1.56">             // We have no user, therefore we need to ask the user. Show a</span>
<a href="#l1.57"></a><span id="l1.57">             // user/password prompt and set the session based on those</span>
<a href="#l1.58"></a><span id="l1.58">             // values.</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-            var username = { value: null };</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+            let username = { value: null };</span>
<a href="#l1.62"></a><span id="l1.62">             if (this.isDefaultCalendar) {</span>
<a href="#l1.63"></a><span id="l1.63">                 // Only pre-fill the username if this is the default calendar,</span>
<a href="#l1.64"></a><span id="l1.64">                 // otherwise users might think the cryptic hash is the username</span>
<a href="#l1.65"></a><span id="l1.65">                 // they have to use.</span>
<a href="#l1.66"></a><span id="l1.66">                 username.value = this.mCalendarName;</span>
<a href="#l1.67"></a><span id="l1.67">             }</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-            var password = { value: null };</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-            var persist = { value: false };</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+            let password = { value: null };</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+            let persist = { value: false };</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">             if (getCalendarCredentials(this.mCalendarName,</span>
<a href="#l1.74"></a><span id="l1.74">                                        username,</span>
<a href="#l1.75"></a><span id="l1.75">                                        password,</span>
<a href="#l1.76"></a><span id="l1.76">                                        persist)) {</span>
<a href="#l1.77"></a><span id="l1.77">                 this.mSession = sessionMgr.getSessionByUsername(username.value,</span>
<a href="#l1.78"></a><span id="l1.78">                                                                 true);</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80" class="difflineat">@@ -245,21 +246,21 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.81"></a><span id="l1.81">     },</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">     get fullUri() {</span>
<a href="#l1.84"></a><span id="l1.84">         return this.mFullUri;</span>
<a href="#l1.85"></a><span id="l1.85">     },</span>
<a href="#l1.86"></a><span id="l1.86">     set uri(aUri) {</span>
<a href="#l1.87"></a><span id="l1.87">         // Parse google url, catch private cookies, public calendars,</span>
<a href="#l1.88"></a><span id="l1.88">         // basic and full types, bogus ics file extensions, invalid hostnames</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-        var re = new RegExp(&quot;/calendar/(feeds|ical)/&quot; +</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+        let re = new RegExp(&quot;/calendar/(feeds|ical)/&quot; +</span>
<a href="#l1.91"></a><span id="l1.91">                             &quot;([^/]+)/(public|private)-?([^/]+)?/&quot; +</span>
<a href="#l1.92"></a><span id="l1.92">                             &quot;(full|basic)(.ics)?$&quot;);</span>
<a href="#l1.93"></a><span id="l1.93"> </span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-        var matches = aUri.path.match(re);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+        let matches = aUri.path.match(re);</span>
<a href="#l1.96"></a><span id="l1.96"> </span>
<a href="#l1.97"></a><span id="l1.97">         if (!matches) {</span>
<a href="#l1.98"></a><span id="l1.98">             throw new Components.Exception(aUri, Components.results.NS_ERROR_MALFORMED_URI);</span>
<a href="#l1.99"></a><span id="l1.99">         }</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101">         // Set internal Calendar Name</span>
<a href="#l1.102"></a><span id="l1.102">         this.mCalendarName = decodeURIComponent(matches[2]);</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104" class="difflineat">@@ -344,24 +345,24 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">             // Check if we have a session. If not, then the user has canceled</span>
<a href="#l1.107"></a><span id="l1.107">             // the login prompt.</span>
<a href="#l1.108"></a><span id="l1.108">             this.ensureSession();</span>
<a href="#l1.109"></a><span id="l1.109"> </span>
<a href="#l1.110"></a><span id="l1.110">             // Add the calendar to the item, for later use.</span>
<a href="#l1.111"></a><span id="l1.111">             aItem.calendar = this.superCalendar;</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-            var request = new calGoogleRequest(this);</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-            var xmlEntry = ItemToXMLEntry(aItem, this,</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+            let request = new calGoogleRequest(this);</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+            let xmlEntry = ItemToXMLEntry(aItem, this,</span>
<a href="#l1.117"></a><span id="l1.117">                                           this.session.userName,</span>
<a href="#l1.118"></a><span id="l1.118">                                           this.session.fullName);</span>
<a href="#l1.119"></a><span id="l1.119"> </span>
<a href="#l1.120"></a><span id="l1.120">             request.type = request.ADD;</span>
<a href="#l1.121"></a><span id="l1.121">             request.uri = this.fullUri.spec;</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-            request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, xmlEntry);</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+            request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, cal.xml.serializeDOM(xmlEntry));</span>
<a href="#l1.124"></a><span id="l1.124">             request.operationListener = aListener;</span>
<a href="#l1.125"></a><span id="l1.125">             request.calendar = this;</span>
<a href="#l1.126"></a><span id="l1.126">             request.newItem = aItem;</span>
<a href="#l1.127"></a><span id="l1.127">             request.useCache = useCache;</span>
<a href="#l1.128"></a><span id="l1.128">             request.responseListener = { onResult: this.addItem_response.bind(this) };</span>
<a href="#l1.129"></a><span id="l1.129">             request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131">             this.session.asyncItemRequest(request);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineat">@@ -452,41 +453,41 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.133"></a><span id="l1.133">                                              Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l1.134"></a><span id="l1.134">                                              aNewItem.id,</span>
<a href="#l1.135"></a><span id="l1.135">                                              aNewItem);</span>
<a href="#l1.136"></a><span id="l1.136">                 this.mObservers.notify(&quot;onModifyItem&quot;, [aNewItem, aOldItem]);</span>
<a href="#l1.137"></a><span id="l1.137">                 return null;</span>
<a href="#l1.138"></a><span id="l1.138">             }</span>
<a href="#l1.139"></a><span id="l1.139"> </span>
<a href="#l1.140"></a><span id="l1.140">             // Set up the request</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-            var request = new calGoogleRequest(this.session);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+            let request = new calGoogleRequest(this.session);</span>
<a href="#l1.143"></a><span id="l1.143"> </span>
<a href="#l1.144"></a><span id="l1.144">             // We need to clone the new item, its possible that ItemToXMLEntry</span>
<a href="#l1.145"></a><span id="l1.145">             // will modify the item. For example, if the item is organized by</span>
<a href="#l1.146"></a><span id="l1.146">             // someone else, we cannot save alarms on it and they should</span>
<a href="#l1.147"></a><span id="l1.147">             // therefore not be added in the returned item.</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-            var newItem = aNewItem.clone();</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+            let newItem = aNewItem.clone();</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-            var xmlEntry = ItemToXMLEntry(newItem, this,</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+            let xmlEntry = ItemToXMLEntry(newItem, this,</span>
<a href="#l1.153"></a><span id="l1.153">                                           this.session.userName,</span>
<a href="#l1.154"></a><span id="l1.154">                                           this.session.fullName);</span>
<a href="#l1.155"></a><span id="l1.155"> </span>
<a href="#l1.156"></a><span id="l1.156">             if (aOldItem.parentItem != aOldItem &amp;&amp;</span>
<a href="#l1.157"></a><span id="l1.157">                 !aOldItem.parentItem.recurrenceInfo.getExceptionFor(aOldItem.startDate)) {</span>
<a href="#l1.158"></a><span id="l1.158"> </span>
<a href="#l1.159"></a><span id="l1.159">                 // In this case we are modifying an occurence, not deleting it</span>
<a href="#l1.160"></a><span id="l1.160">                 request.type = request.ADD;</span>
<a href="#l1.161"></a><span id="l1.161">                 request.uri = this.fullUri.spec;</span>
<a href="#l1.162"></a><span id="l1.162">             } else {</span>
<a href="#l1.163"></a><span id="l1.163">                 // We are  making a negative exception or modifying a parent item</span>
<a href="#l1.164"></a><span id="l1.164">                 request.type = request.MODIFY;</span>
<a href="#l1.165"></a><span id="l1.165">                 request.uri = getItemEditURI(aOldItem);</span>
<a href="#l1.166"></a><span id="l1.166">             }</span>
<a href="#l1.167"></a><span id="l1.167"> </span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-            request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, xmlEntry);</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+            request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, cal.xml.serializeDOM(xmlEntry));</span>
<a href="#l1.170"></a><span id="l1.170">             request.responseListener = { onResult: this.modifyItem_response.bind(this) };</span>
<a href="#l1.171"></a><span id="l1.171">             request.operationListener = aListener;</span>
<a href="#l1.172"></a><span id="l1.172">             request.newItem = newItem;</span>
<a href="#l1.173"></a><span id="l1.173">             request.oldItem = aOldItem;</span>
<a href="#l1.174"></a><span id="l1.174">             request.calendar = this;</span>
<a href="#l1.175"></a><span id="l1.175">             request.useCache = useCache;</span>
<a href="#l1.176"></a><span id="l1.176">             request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l1.177"></a><span id="l1.177"> </span>
<a href="#l1.178"></a><span id="l1.178" class="difflineat">@@ -507,17 +508,16 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.179"></a><span id="l1.179">                                          e.result,</span>
<a href="#l1.180"></a><span id="l1.180">                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l1.181"></a><span id="l1.181">                                          null,</span>
<a href="#l1.182"></a><span id="l1.182">                                          e.message);</span>
<a href="#l1.183"></a><span id="l1.183">         }</span>
<a href="#l1.184"></a><span id="l1.184">         return null;</span>
<a href="#l1.185"></a><span id="l1.185">     },</span>
<a href="#l1.186"></a><span id="l1.186"> </span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-</span>
<a href="#l1.188"></a><span id="l1.188">     deleteItem: function cGC_deleteItem(aItem, aListener) {</span>
<a href="#l1.189"></a><span id="l1.189">         if (this.mOfflineStorage) {</span>
<a href="#l1.190"></a><span id="l1.190">             return this.deleteItemOrUseCache(aItem, true, aListener);</span>
<a href="#l1.191"></a><span id="l1.191">         } else {</span>
<a href="#l1.192"></a><span id="l1.192">             return this.doDeleteItem(aItem, false, aListener);</span>
<a href="#l1.193"></a><span id="l1.193">         }</span>
<a href="#l1.194"></a><span id="l1.194">     },</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196" class="difflineat">@@ -559,17 +559,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.197"></a><span id="l1.197">             }</span>
<a href="#l1.198"></a><span id="l1.198"> </span>
<a href="#l1.199"></a><span id="l1.199">             // Check if we have a session. If not, then the user has canceled</span>
<a href="#l1.200"></a><span id="l1.200">             // the login prompt.</span>
<a href="#l1.201"></a><span id="l1.201">             this.ensureSession();</span>
<a href="#l1.202"></a><span id="l1.202"> </span>
<a href="#l1.203"></a><span id="l1.203">             // We need the item in the response, since google dosen't return any</span>
<a href="#l1.204"></a><span id="l1.204">             // item XML data on delete, and we need to call the observers.</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-            var request = new calGoogleRequest(this);</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+            let request = new calGoogleRequest(this);</span>
<a href="#l1.207"></a><span id="l1.207"> </span>
<a href="#l1.208"></a><span id="l1.208">             request.type = request.DELETE;</span>
<a href="#l1.209"></a><span id="l1.209">             request.uri = getItemEditURI(aItem);</span>
<a href="#l1.210"></a><span id="l1.210">             request.operationListener = aListener;</span>
<a href="#l1.211"></a><span id="l1.211">             request.oldItem = aItem;</span>
<a href="#l1.212"></a><span id="l1.212">             request.calendar = this;</span>
<a href="#l1.213"></a><span id="l1.213">             request.useCache = useCache;</span>
<a href="#l1.214"></a><span id="l1.214">             request.responseListener = { onResult: this.deleteItem_response.bind(this) };</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineat">@@ -602,17 +602,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.216"></a><span id="l1.216">         try {</span>
<a href="#l1.217"></a><span id="l1.217"> </span>
<a href="#l1.218"></a><span id="l1.218">             // Check if we have a session. If not, then the user has canceled</span>
<a href="#l1.219"></a><span id="l1.219">             // the login prompt.</span>
<a href="#l1.220"></a><span id="l1.220">             this.ensureSession();</span>
<a href="#l1.221"></a><span id="l1.221"> </span>
<a href="#l1.222"></a><span id="l1.222">             // Set up the request</span>
<a href="#l1.223"></a><span id="l1.223"> </span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-            var request = new calGoogleRequest(this);</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+            let request = new calGoogleRequest(this);</span>
<a href="#l1.226"></a><span id="l1.226"> </span>
<a href="#l1.227"></a><span id="l1.227">             request.itemId = aId;</span>
<a href="#l1.228"></a><span id="l1.228">             request.type = request.GET;</span>
<a href="#l1.229"></a><span id="l1.229">             request.uri = this.fullUri.spec;</span>
<a href="#l1.230"></a><span id="l1.230">             request.operationListener = aListener;</span>
<a href="#l1.231"></a><span id="l1.231">             request.responseListener = { onResult: this.getItem_response.bind(this) };</span>
<a href="#l1.232"></a><span id="l1.232">             request.calendar = this;</span>
<a href="#l1.233"></a><span id="l1.233"> </span>
<a href="#l1.234"></a><span id="l1.234" class="difflineat">@@ -641,22 +641,21 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.235"></a><span id="l1.235">                                     aRangeEnd,</span>
<a href="#l1.236"></a><span id="l1.236">                                     aListener) {</span>
<a href="#l1.237"></a><span id="l1.237">         try {</span>
<a href="#l1.238"></a><span id="l1.238">             // Check if we have a session. If not, then the user has canceled</span>
<a href="#l1.239"></a><span id="l1.239">             // the login prompt.</span>
<a href="#l1.240"></a><span id="l1.240">             this.ensureSession();</span>
<a href="#l1.241"></a><span id="l1.241"> </span>
<a href="#l1.242"></a><span id="l1.242">             // item base type</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-            var wantEvents = ((aItemFilter &amp;</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+            let wantEvents = ((aItemFilter &amp;</span>
<a href="#l1.245"></a><span id="l1.245">                                Components.interfaces.calICalendar.ITEM_FILTER_TYPE_EVENT) != 0);</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-            var wantInvitations = ((aItemFilter &amp;</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+            let wantInvitations = ((aItemFilter &amp;</span>
<a href="#l1.248"></a><span id="l1.248">                  Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION) != 0);</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-</span>
<a href="#l1.251"></a><span id="l1.251">             if (!wantEvents) {</span>
<a href="#l1.252"></a><span id="l1.252">                 // Events are not wanted, nothing to do. The</span>
<a href="#l1.253"></a><span id="l1.253">                 // notifyOperationComplete in the catch block below will catch</span>
<a href="#l1.254"></a><span id="l1.254">                 // this.</span>
<a href="#l1.255"></a><span id="l1.255">                 throw new Components.Exception(&quot;&quot;, Components.results.NS_OK);</span>
<a href="#l1.256"></a><span id="l1.256">             }</span>
<a href="#l1.257"></a><span id="l1.257"> </span>
<a href="#l1.258"></a><span id="l1.258">             // Requesting only a DATE returns items based on UTC. Therefore, we make</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineat">@@ -667,20 +666,20 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.260"></a><span id="l1.260">                 aRangeStart = aRangeStart.clone();</span>
<a href="#l1.261"></a><span id="l1.261">                 aRangeStart.isDate = false;</span>
<a href="#l1.262"></a><span id="l1.262">             }</span>
<a href="#l1.263"></a><span id="l1.263">             if (aRangeEnd) {</span>
<a href="#l1.264"></a><span id="l1.264">                 aRangeEnd = aRangeEnd.clone();</span>
<a href="#l1.265"></a><span id="l1.265">                 aRangeEnd.isDate = false;</span>
<a href="#l1.266"></a><span id="l1.266">             }</span>
<a href="#l1.267"></a><span id="l1.267"> </span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-            var rfcRangeStart = cal.toRFC3339(aRangeStart);</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-            var rfcRangeEnd = cal.toRFC3339(aRangeEnd);</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+            let rfcRangeStart = cal.toRFC3339(aRangeStart);</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+            let rfcRangeEnd = cal.toRFC3339(aRangeEnd);</span>
<a href="#l1.272"></a><span id="l1.272"> </span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-            var request = new calGoogleRequest(this);</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+            let request = new calGoogleRequest(this);</span>
<a href="#l1.275"></a><span id="l1.275"> </span>
<a href="#l1.276"></a><span id="l1.276">             request.type = request.GET;</span>
<a href="#l1.277"></a><span id="l1.277">             request.uri = this.fullUri.spec;</span>
<a href="#l1.278"></a><span id="l1.278">             request.operationListener = aListener;</span>
<a href="#l1.279"></a><span id="l1.279">             request.calendar = this;</span>
<a href="#l1.280"></a><span id="l1.280">             request.itemRangeStart = aRangeStart;</span>
<a href="#l1.281"></a><span id="l1.281">             request.itemRangeEnd = aRangeEnd;</span>
<a href="#l1.282"></a><span id="l1.282">             request.itemFilter = aItemFilter;</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineat">@@ -967,54 +966,42 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.284"></a><span id="l1.284">     getItem_response: function cGC_getItem_response_onResult(aOperation,</span>
<a href="#l1.285"></a><span id="l1.285">                                                              aData) {</span>
<a href="#l1.286"></a><span id="l1.286">         // XXX Due to google issue 399, we need to parse a full feed here.</span>
<a href="#l1.287"></a><span id="l1.287">         try {</span>
<a href="#l1.288"></a><span id="l1.288">             if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l1.289"></a><span id="l1.289">                 throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l1.290"></a><span id="l1.290">             }</span>
<a href="#l1.291"></a><span id="l1.291"> </span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-            // Prepare Namespaces</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-            var gCal = new Namespace(&quot;gCal&quot;,</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-                                     &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-            var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-            var atom = new Namespace(&quot;&quot;, &quot;http://www.w3.org/2005/Atom&quot;);</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-            default xml namespace = atom;</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-</span>
<a href="#l1.299"></a><span id="l1.299">             // A feed was passed back, parse it.</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-            var xml = cal.safeNewXML(aData);</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-            var timezoneString = xml.gCal::timezone.@value.toString() || &quot;UTC&quot;;</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-            var timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-            // This line is needed, otherwise the for each () block will never</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-            // be entered. It may seem strange, but if you don't believe me, try</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-            // it!</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-            xml.link.(@rel);</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+            let xml = cal.xml.parseString(aData);</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+            let timezoneString = gdataXPathFirst(xml, 'atom:feed/gCal:timezone/@value') || &quot;UTC&quot;;</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+            let timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l1.311"></a><span id="l1.311"> </span>
<a href="#l1.312"></a><span id="l1.312">             // We might be able to get the full name through this feed's author</span>
<a href="#l1.313"></a><span id="l1.313">             // tags. We need to make sure we have a session for that.</span>
<a href="#l1.314"></a><span id="l1.314">             this.ensureSession();</span>
<a href="#l1.315"></a><span id="l1.315"> </span>
<a href="#l1.316"></a><span id="l1.316">             // Get the item entry by id.</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-            var itemEntry = xml.entry.(id.substring(id.lastIndexOf('/') + 1) == aOperation.itemId ||</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-                                       gCal::uid.@value == aOperation.itemId);</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-            if (!itemEntry || !itemEntry.length()) {</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+            let itemXPath = 'atom:feed/atom:entry[substring-before(atom:id/text(), &quot;' + aOperation.itemId + '&quot;)!=&quot;&quot; or gCal:uid/@value=&quot;' + aOperation.itemId + '&quot;]';</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+            let itemEntry = gdataXPathFirst(xml, itemXPath);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+            if (!itemEntry) {</span>
<a href="#l1.323"></a><span id="l1.323">                 // Item wasn't found. Skip onGetResult and just complete. Not</span>
<a href="#l1.324"></a><span id="l1.324">                 // finding an item isn't a user-important error, it may be a</span>
<a href="#l1.325"></a><span id="l1.325">                 // wanted case. (i.e itip)</span>
<a href="#l1.326"></a><span id="l1.326">                 cal.LOG(&quot;[calGoogleCalendar] Item &quot; + aOperation.itemId + &quot; not found in calendar &quot; + this.name);</span>
<a href="#l1.327"></a><span id="l1.327">                 throw new Components.Exception(&quot;Item not found&quot;, Components.results.NS_OK);</span>
<a href="#l1.328"></a><span id="l1.328">             }</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-            var item = XMLEntryToItem(itemEntry, timezone, this);</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+            let item = XMLEntryToItem(itemEntry, timezone, this);</span>
<a href="#l1.331"></a><span id="l1.331">             item.calendar = this.superCalendar;</span>
<a href="#l1.332"></a><span id="l1.332"> </span>
<a href="#l1.333"></a><span id="l1.333">             if (item.recurrenceInfo) {</span>
<a href="#l1.334"></a><span id="l1.334">                 // If this item is recurring, get all exceptions for this item.</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-                for each (var entry in xml.entry.gd::originalEvent.(@id == aOperation.itemId)) {</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-                    var excItem = XMLEntryToItem(entry.parent(), timezone, this);</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineplus">+                for each (let entry in gdataXPath(xml, 'atom:feed/atom:entry[gd:originalEvent/@id=&quot;' + aOperation.itemId + '&quot;]')) {</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+                    let excItem = XMLEntryToItem(entry, timezone, this);</span>
<a href="#l1.339"></a><span id="l1.339"> </span>
<a href="#l1.340"></a><span id="l1.340">                     // Google uses the status field to reflect negative</span>
<a href="#l1.341"></a><span id="l1.341">                     // exceptions.</span>
<a href="#l1.342"></a><span id="l1.342">                     if (excItem.status == &quot;CANCELED&quot;) {</span>
<a href="#l1.343"></a><span id="l1.343">                         item.recurrenceInfo.removeOccurrenceAt(excItem.recurrenceId);</span>
<a href="#l1.344"></a><span id="l1.344">                     } else {</span>
<a href="#l1.345"></a><span id="l1.345">                         excItem.calendar = this;</span>
<a href="#l1.346"></a><span id="l1.346">                         item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineat">@@ -1055,101 +1042,87 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.348"></a><span id="l1.348">      *</span>
<a href="#l1.349"></a><span id="l1.349">      * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l1.350"></a><span id="l1.350">      * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l1.351"></a><span id="l1.351">      *                     an XML representation of the added item.</span>
<a href="#l1.352"></a><span id="l1.352">      */</span>
<a href="#l1.353"></a><span id="l1.353">     getItems_response: function cGC_getItems_response(aOperation, aData) {</span>
<a href="#l1.354"></a><span id="l1.354">         // To simplify code, provide a one-stop function to call, independant of</span>
<a href="#l1.355"></a><span id="l1.355">         // if and what type of listener was passed.</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-        var listener = aOperation.operationListener ||</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+        let listener = aOperation.operationListener ||</span>
<a href="#l1.358"></a><span id="l1.358">             { onGetResult: function() {}, onOperationComplete: function() {} };</span>
<a href="#l1.359"></a><span id="l1.359"> </span>
<a href="#l1.360"></a><span id="l1.360">         cal.LOG(&quot;[calGoogleCalendar] Recieved response for &quot; + aOperation.uri);</span>
<a href="#l1.361"></a><span id="l1.361">         try {</span>
<a href="#l1.362"></a><span id="l1.362">             // Check if the call succeeded</span>
<a href="#l1.363"></a><span id="l1.363">             if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l1.364"></a><span id="l1.364">                 throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l1.365"></a><span id="l1.365">             }</span>
<a href="#l1.366"></a><span id="l1.366"> </span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-            // Prepare Namespaces</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-            var gCal = new Namespace(&quot;gCal&quot;,</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-                                     &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-            var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-            var atom = new Namespace(&quot;&quot;, &quot;http://www.w3.org/2005/Atom&quot;);</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-            default xml namespace = atom;</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-</span>
<a href="#l1.374"></a><span id="l1.374">             // A feed was passed back, parse it.</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-            var xml = cal.safeNewXML(aData);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-            var timezoneString = xml.gCal::timezone.@value.toString() || &quot;UTC&quot;;</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-            var timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-            // This line is needed, otherwise the for each () block will never</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-            // be entered. It may seem strange, but if you don't believe me, try</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-            // it!</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-            xml.link.(@rel);</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineplus">+            let xml = cal.xml.parseString(aData);</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineplus">+            let timezoneString = gdataXPathFirst(xml, 'atom:feed/gCal:timezone/@value') || &quot;UTC&quot;;</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+            let timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l1.386"></a><span id="l1.386"> </span>
<a href="#l1.387"></a><span id="l1.387">             // We might be able to get the full name through this feed's author</span>
<a href="#l1.388"></a><span id="l1.388">             // tags. We need to make sure we have a session for that.</span>
<a href="#l1.389"></a><span id="l1.389">             this.ensureSession();</span>
<a href="#l1.390"></a><span id="l1.390"> </span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-            if (xml.author.email == this.mSession.userName) {</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineplus">+            if (gdataXPathFirst(xml, 'atom:feed/atom:author/atom:email/text()') == this.mSession.userName) {</span>
<a href="#l1.393"></a><span id="l1.393">                 // If the current entry contains the user's email, then we can</span>
<a href="#l1.394"></a><span id="l1.394">                 // extract the user's full name also.</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-                this.mSession.fullName = xml.author.name.toString();</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+                this.mSession.fullName = gdataXPathFirst(xml, 'atom:feed/atom:author/atom:name/text()');</span>
<a href="#l1.397"></a><span id="l1.397">             }</span>
<a href="#l1.398"></a><span id="l1.398"> </span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-            var wantInvitations = ((aOperation.itemFilter &amp;</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineplus">+            let wantInvitations = ((aOperation.itemFilter &amp;</span>
<a href="#l1.402"></a><span id="l1.402">                  Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION) != 0);</span>
<a href="#l1.403"></a><span id="l1.403"> </span>
<a href="#l1.404"></a><span id="l1.404">             // Parse all &lt;entry&gt; tags</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineminus">-            for each (var entry in xml.entry) {</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-                if (entry.gd::originalEvent.toString().length) {</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineplus">+            for each (let entry in gdataXPath(xml, 'atom:feed/atom:entry')) {</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+                if (gdataXPathFirst(entry, 'gd:originalEvent')) {</span>
<a href="#l1.409"></a><span id="l1.409">                     // This is an exception. If we are doing an uncached</span>
<a href="#l1.410"></a><span id="l1.410">                     // operation, then skip it for now since it will be parsed</span>
<a href="#l1.411"></a><span id="l1.411">                     // later.</span>
<a href="#l1.412"></a><span id="l1.412">                     continue;</span>
<a href="#l1.413"></a><span id="l1.413">                 }</span>
<a href="#l1.414"></a><span id="l1.414"> </span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-                var item = XMLEntryToItem(entry, timezone, this);</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+                let item = XMLEntryToItem(entry, timezone, this);</span>
<a href="#l1.418"></a><span id="l1.418">                 item.calendar = this.superCalendar;</span>
<a href="#l1.419"></a><span id="l1.419"> </span>
<a href="#l1.420"></a><span id="l1.420">                 if (wantInvitations) {</span>
<a href="#l1.421"></a><span id="l1.421">                     // If invitations are wanted and this is not an invitation,</span>
<a href="#l1.422"></a><span id="l1.422">                     // or if the user is not an attendee, or has already accepted</span>
<a href="#l1.423"></a><span id="l1.423">                     // then this is not an invitation.</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-                    var att = item.getAttendeeById(&quot;mailto:&quot; + this.session.userName);</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineplus">+                    let att = item.getAttendeeById(&quot;mailto:&quot; + this.session.userName);</span>
<a href="#l1.426"></a><span id="l1.426">                     if (!this.isInvitation(item) ||</span>
<a href="#l1.427"></a><span id="l1.427">                         !att ||</span>
<a href="#l1.428"></a><span id="l1.428">                         att.participationStatus != &quot;NEEDS-ACTION&quot;) {</span>
<a href="#l1.429"></a><span id="l1.429">                         continue;</span>
<a href="#l1.430"></a><span id="l1.430">                     }</span>
<a href="#l1.431"></a><span id="l1.431">                 }</span>
<a href="#l1.432"></a><span id="l1.432"> </span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + entry + &quot;\n&quot;);</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + cal.xml.serializeDOM(entry) + &quot;\n&quot;);</span>
<a href="#l1.435"></a><span id="l1.435"> </span>
<a href="#l1.436"></a><span id="l1.436">                 if (item.recurrenceInfo) {</span>
<a href="#l1.437"></a><span id="l1.437">                     // If we are doing an uncached operation, then we need to</span>
<a href="#l1.438"></a><span id="l1.438">                     // gather all exceptions and put them into the item.</span>
<a href="#l1.439"></a><span id="l1.439">                     // Otherwise, our listener will take care of mapping the</span>
<a href="#l1.440"></a><span id="l1.440">                     // exception to the base item.</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-                    for each (var oid in xml.entry.gd::originalEvent.(@id == item.id)) {</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+                    for each (let oid in gdataXPath(xml, 'atom:feed/atom:entry[gd:originalEvent/@id=&quot;' + item.id + '&quot;]')) {</span>
<a href="#l1.443"></a><span id="l1.443">                         // Get specific fields so we can speed up the parsing process</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-                        var status = oid.parent().gd::eventStatus.@value.toString().substring(39);</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+                        let status = gdataXPathFirst(oid, 'gd:eventStatus/@value').substring(39);</span>
<a href="#l1.446"></a><span id="l1.446"> </span>
<a href="#l1.447"></a><span id="l1.447">                         if (status == &quot;canceled&quot;) {</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-                            let rId = oid.gd::when.@startTime.toString();</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineplus">+                            let rId = gdataXPathFirst(oid, 'gd:when/@startTime');</span>
<a href="#l1.450"></a><span id="l1.450">                             let rDate = cal.fromRFC3339(rId, timezone);</span>
<a href="#l1.451"></a><span id="l1.451">                             cal.LOG(&quot;[calGoogleCalendar] Negative exception &quot; + rId + &quot;/&quot; + rDate);</span>
<a href="#l1.452"></a><span id="l1.452">                             item.recurrenceInfo.removeOccurrenceAt(rDate);</span>
<a href="#l1.453"></a><span id="l1.453">                         } else {</span>
<a href="#l1.454"></a><span id="l1.454">                             // Parse the exception and modify the current item</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-                            var excItem = XMLEntryToItem(oid.parent(),</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+                            let excItem = XMLEntryToItem(oid,</span>
<a href="#l1.457"></a><span id="l1.457">                                                          timezone,</span>
<a href="#l1.458"></a><span id="l1.458">                                                          this);</span>
<a href="#l1.459"></a><span id="l1.459">                             if (excItem) {</span>
<a href="#l1.460"></a><span id="l1.460">                                 // Google uses the status field to reflect negative</span>
<a href="#l1.461"></a><span id="l1.461">                                 // exceptions.</span>
<a href="#l1.462"></a><span id="l1.462">                                 excItem.calendar = this;</span>
<a href="#l1.463"></a><span id="l1.463">                                 item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l1.464"></a><span id="l1.464">                             }</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineat">@@ -1157,17 +1130,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.466"></a><span id="l1.466">                     }</span>
<a href="#l1.467"></a><span id="l1.467">                 }</span>
<a href="#l1.468"></a><span id="l1.468"> </span>
<a href="#l1.469"></a><span id="l1.469">                 item.makeImmutable();</span>
<a href="#l1.470"></a><span id="l1.470">                 LOGitem(item);</span>
<a href="#l1.471"></a><span id="l1.471"> </span>
<a href="#l1.472"></a><span id="l1.472">                 // This is an uncached call, expand the item and tell our</span>
<a href="#l1.473"></a><span id="l1.473">                 // get listener about the item.</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-                var expandedItems = expandItems(item, aOperation);</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineplus">+                let expandedItems = expandItems(item, aOperation);</span>
<a href="#l1.476"></a><span id="l1.476">                 listener.onGetResult(this.superCalendar,</span>
<a href="#l1.477"></a><span id="l1.477">                                      Components.results.NS_OK,</span>
<a href="#l1.478"></a><span id="l1.478">                                      Components.interfaces.calIEvent,</span>
<a href="#l1.479"></a><span id="l1.479">                                      null,</span>
<a href="#l1.480"></a><span id="l1.480">                                      expandedItems.length,</span>
<a href="#l1.481"></a><span id="l1.481">                                      expandedItems);</span>
<a href="#l1.482"></a><span id="l1.482">             }</span>
<a href="#l1.483"></a><span id="l1.483">             // Operation Completed successfully.</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineat">@@ -1198,43 +1171,43 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.485"></a><span id="l1.485">     },</span>
<a href="#l1.486"></a><span id="l1.486"> </span>
<a href="#l1.487"></a><span id="l1.487">     resetLog: function cGC_resetLog() {</span>
<a href="#l1.488"></a><span id="l1.488">         cal.LOG(&quot;[calGoogleCalendar] Resetting last updated counter for &quot; + this.name);</span>
<a href="#l1.489"></a><span id="l1.489">         this.deleteProperty(&quot;google.lastUpdated&quot;);</span>
<a href="#l1.490"></a><span id="l1.490">     },</span>
<a href="#l1.491"></a><span id="l1.491"> </span>
<a href="#l1.492"></a><span id="l1.492">     replayChangesOn: function cGC_replayChangesOn(aListener) {</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-        var lastUpdate = this.getProperty(&quot;google.lastUpdated&quot;);</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-        var lastUpdateDateTime;</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+        let lastUpdate = this.getProperty(&quot;google.lastUpdated&quot;);</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+        let lastUpdateDateTime;</span>
<a href="#l1.497"></a><span id="l1.497">         if (lastUpdate) {</span>
<a href="#l1.498"></a><span id="l1.498">             // Set up the last sync stamp</span>
<a href="#l1.499"></a><span id="l1.499">             lastUpdateDateTime = createDateTime();</span>
<a href="#l1.500"></a><span id="l1.500">             lastUpdateDateTime.icalString = lastUpdate;</span>
<a href="#l1.501"></a><span id="l1.501"> </span>
<a href="#l1.502"></a><span id="l1.502">             // Set up last week</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">-            var lastWeek = getCorrectedDate(now().getInTimezone(UTC()));</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineplus">+            let lastWeek = getCorrectedDate(now().getInTimezone(UTC()));</span>
<a href="#l1.505"></a><span id="l1.505">             lastWeek.day -= 7;</span>
<a href="#l1.506"></a><span id="l1.506">             if (lastWeek.compare(lastUpdateDateTime) &gt;= 0) {</span>
<a href="#l1.507"></a><span id="l1.507">                 // The last sync was longer than a week ago. Google requires a full</span>
<a href="#l1.508"></a><span id="l1.508">                 // sync in that case. This call also takes care of calling</span>
<a href="#l1.509"></a><span id="l1.509">                 // resetLog().</span>
<a href="#l1.510"></a><span id="l1.510">                 this.superCalendar.wrappedJSObject.setupCachedCalendar();</span>
<a href="#l1.511"></a><span id="l1.511">                 lastUpdateDateTime = null;</span>
<a href="#l1.512"></a><span id="l1.512">             }</span>
<a href="#l1.513"></a><span id="l1.513">             cal.LOG(&quot;[calGoogleCalendar] The calendar &quot; + this.name + &quot; was last modified: &quot; + lastUpdateDateTime);</span>
<a href="#l1.514"></a><span id="l1.514">         }</span>
<a href="#l1.515"></a><span id="l1.515"> </span>
<a href="#l1.516"></a><span id="l1.516" class="difflineminus">-        var request = new calGoogleRequest(this.mSession);</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+        let request = new calGoogleRequest(this.mSession);</span>
<a href="#l1.518"></a><span id="l1.518"> </span>
<a href="#l1.519"></a><span id="l1.519">         request.type = request.GET;</span>
<a href="#l1.520"></a><span id="l1.520">         request.uri = this.fullUri.spec</span>
<a href="#l1.521"></a><span id="l1.521">         request.destinationCal = this.mOfflineStorage;</span>
<a href="#l1.522"></a><span id="l1.522"> </span>
<a href="#l1.523"></a><span id="l1.523" class="difflineminus">-        var calendar = this;</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+        let calendar = this;</span>
<a href="#l1.525"></a><span id="l1.525">         request.responseListener = { onResult: this.syncItems_response.bind(this, (lastUpdateDateTime == null)) }</span>
<a href="#l1.526"></a><span id="l1.526">         request.operationListener = aListener;</span>
<a href="#l1.527"></a><span id="l1.527">         request.calendar = this;</span>
<a href="#l1.528"></a><span id="l1.528"> </span>
<a href="#l1.529"></a><span id="l1.529">         // Request Parameters</span>
<a href="#l1.530"></a><span id="l1.530">         request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l1.531"></a><span id="l1.531">         request.addQueryParameter(&quot;max-results&quot;, kMANY_EVENTS);</span>
<a href="#l1.532"></a><span id="l1.532">         request.addQueryParameter(&quot;singleevents&quot;, &quot;false&quot;);</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineat">@@ -1262,86 +1235,73 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.534"></a><span id="l1.534">     syncItems_response: function cGC_syncItems_response(aIsFullSync, aOperation, aData) {</span>
<a href="#l1.535"></a><span id="l1.535">         cal.LOG(&quot;[calGoogleCalendar] Recieved response for &quot; + aOperation.uri + (aIsFullSync ? &quot; (full sync)&quot; : &quot;&quot;));</span>
<a href="#l1.536"></a><span id="l1.536">         try {</span>
<a href="#l1.537"></a><span id="l1.537">             // Check if the call succeeded</span>
<a href="#l1.538"></a><span id="l1.538">             if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l1.539"></a><span id="l1.539">                 throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l1.540"></a><span id="l1.540">             }</span>
<a href="#l1.541"></a><span id="l1.541"> </span>
<a href="#l1.542"></a><span id="l1.542" class="difflineminus">-            // Prepare Namespaces</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineminus">-            var gCal = new Namespace(&quot;gCal&quot;,</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-                                     &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineminus">-            var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineminus">-            var atom = new Namespace(&quot;&quot;, &quot;http://www.w3.org/2005/Atom&quot;);</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineminus">-            default xml namespace = atom;</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineminus">-</span>
<a href="#l1.549"></a><span id="l1.549">             // A feed was passed back, parse it.</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineminus">-            var xml = cal.safeNewXML(aData);</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineminus">-            var timezoneString = xml.gCal::timezone.@value.toString() || &quot;UTC&quot;;</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineminus">-            var timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-            // This line is needed, otherwise the for each () block will never</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineminus">-            // be entered. It may seem strange, but if you don't believe me, try</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">-            // it!</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">-            xml.link.(@rel);</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+            let xml = cal.xml.parseString(aData);</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+            let timezoneString = gdataXPathFirst(xml, 'atom:feed/gCal:timezone/@value') || &quot;UTC&quot;;</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+            let timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l1.561"></a><span id="l1.561"> </span>
<a href="#l1.562"></a><span id="l1.562">             // We might be able to get the full name through this feed's author</span>
<a href="#l1.563"></a><span id="l1.563">             // tags. We need to make sure we have a session for that.</span>
<a href="#l1.564"></a><span id="l1.564">             this.ensureSession();</span>
<a href="#l1.565"></a><span id="l1.565"> </span>
<a href="#l1.566"></a><span id="l1.566" class="difflineminus">-            if (xml.author.email == this.mSession.userName) {</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+            if (gdataXPathFirst(xml, 'atom:feed/atom:author/atom:email/text()') == this.mSession.userName) {</span>
<a href="#l1.568"></a><span id="l1.568">                 // If the current entry contains the user's email, then we can</span>
<a href="#l1.569"></a><span id="l1.569">                 // extract the user's full name also.</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineminus">-                this.mSession.fullName = xml.author.name.toString();</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+                this.mSession.fullName = gdataXPathFirst(xml, 'atom:feed/atom:author/atom:name/text()');</span>
<a href="#l1.572"></a><span id="l1.572">             }</span>
<a href="#l1.573"></a><span id="l1.573"> </span>
<a href="#l1.574"></a><span id="l1.574">             // This is the calendar we should sync changes into.</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-            var destinationCal = aOperation.destinationCal;</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineplus">+            let destinationCal = aOperation.destinationCal;</span>
<a href="#l1.577"></a><span id="l1.577"> </span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-            for each (var entry in xml.entry) {</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-                var recurrenceId = getRecurrenceIdFromEntry(entry, timezone);</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineplus">+            for each (let entry in gdataXPath(xml, 'atom:feed/atom:entry')) {</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineplus">+                let recurrenceId = getRecurrenceIdFromEntry(entry, timezone);</span>
<a href="#l1.583"></a><span id="l1.583">                 if (aIsFullSync &amp;&amp; recurrenceId) {</span>
<a href="#l1.584"></a><span id="l1.584">                     // On a full sync, we parse exceptions different.</span>
<a href="#l1.585"></a><span id="l1.585">                     continue;</span>
<a href="#l1.586"></a><span id="l1.586">                 }</span>
<a href="#l1.587"></a><span id="l1.587">                 cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + entry + &quot;\n&quot;);</span>
<a href="#l1.588"></a><span id="l1.588"> </span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-                var referenceItemObj = {}</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineplus">+                let referenceItemObj = {}</span>
<a href="#l1.591"></a><span id="l1.591">                 destinationCal.getItem(getIdFromEntry(entry),</span>
<a href="#l1.592"></a><span id="l1.592">                                        new syncSetter(referenceItemObj));</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-                var referenceItem = referenceItemObj.value &amp;&amp;</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineplus">+                let referenceItem = referenceItemObj.value &amp;&amp;</span>
<a href="#l1.595"></a><span id="l1.595">                                     referenceItemObj.value.clone();</span>
<a href="#l1.596"></a><span id="l1.596"> </span>
<a href="#l1.597"></a><span id="l1.597">                 // Parse the item. If we got a reference item from the storage</span>
<a href="#l1.598"></a><span id="l1.598">                 // calendar, put that in to make sure we get all exceptions and</span>
<a href="#l1.599"></a><span id="l1.599">                 // such.</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineminus">-                var item = XMLEntryToItem(entry,</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineplus">+                let item = XMLEntryToItem(entry,</span>
<a href="#l1.602"></a><span id="l1.602">                                           timezone,</span>
<a href="#l1.603"></a><span id="l1.603">                                           this,</span>
<a href="#l1.604"></a><span id="l1.604">                                           (recurrenceId &amp;&amp; referenceItem ? null : referenceItem));</span>
<a href="#l1.605"></a><span id="l1.605">                 item.calendar = this.superCalendar;</span>
<a href="#l1.606"></a><span id="l1.606"> </span>
<a href="#l1.607"></a><span id="l1.607">                 if (aIsFullSync &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l1.608"></a><span id="l1.608">                     // On a full synchronization, we can go ahead and pre-parse</span>
<a href="#l1.609"></a><span id="l1.609">                     // all exceptions and then add the item at once. This way we</span>
<a href="#l1.610"></a><span id="l1.610">                     // make sure</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-                    for each (var oid in xml.entry.gd::originalEvent.(@id == item.id)) {</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineplus">+                    for each (let oid in gdataXPath(xml, 'atom:feed/atom:entry[gd:originalEvent/@id=&quot;' + item.id + '&quot;]')) {</span>
<a href="#l1.613"></a><span id="l1.613">                         // Get specific fields so we can speed up the parsing process</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineminus">-                        var status = oid.parent().gd::eventStatus.@value.toString().substring(39);</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineplus">+                        let status = gdataXPathFirst(oid, 'atom:entry/gd:eventStatus/@value').substring(39);</span>
<a href="#l1.616"></a><span id="l1.616"> </span>
<a href="#l1.617"></a><span id="l1.617">                         if (status == &quot;canceled&quot;) {</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-                            let rId = oid.gd::when.@startTime.toString();</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+                            let rId = gdataXPathFirst(oid, 'atom:entry/gd:when/@startTime');</span>
<a href="#l1.620"></a><span id="l1.620">                             let rDate = cal.fromRFC3339(rId, timezone);</span>
<a href="#l1.621"></a><span id="l1.621">                             item.recurrenceInfo.removeOccurrenceAt(rDate);</span>
<a href="#l1.622"></a><span id="l1.622">                             cal.LOG(&quot;[calGoogleCalendar] Negative exception &quot; + rId + &quot;/&quot; + rDate);</span>
<a href="#l1.623"></a><span id="l1.623">                         } else {</span>
<a href="#l1.624"></a><span id="l1.624">                             // Parse the exception and modify the current item</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-                            var excItem = XMLEntryToItem(oid.parent(),</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineplus">+                            let excItem = XMLEntryToItem(oid.parent(),</span>
<a href="#l1.627"></a><span id="l1.627">                                                          timezone,</span>
<a href="#l1.628"></a><span id="l1.628">                                                          this);</span>
<a href="#l1.629"></a><span id="l1.629">                             if (excItem) {</span>
<a href="#l1.630"></a><span id="l1.630">                                 // Google uses the status field to reflect negative</span>
<a href="#l1.631"></a><span id="l1.631">                                 // exceptions.</span>
<a href="#l1.632"></a><span id="l1.632">                                 excItem.calendar = this;</span>
<a href="#l1.633"></a><span id="l1.633">                                 item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l1.634"></a><span id="l1.634">                             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -83,17 +83,17 @@ calGoogleRequest.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">     itemId: null,</span>
<a href="#l2.5"></a><span id="l2.5">     calendar: null,</span>
<a href="#l2.6"></a><span id="l2.6">     newItem: null,</span>
<a href="#l2.7"></a><span id="l2.7">     oldItem: null,</span>
<a href="#l2.8"></a><span id="l2.8">     destinationCal: null,</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">     /* nsIClassInfo */</span>
<a href="#l2.11"></a><span id="l2.11">     getInterfaces: function cI_cGR_getInterfaces (aCount) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        var ifaces = [</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        let ifaces = [</span>
<a href="#l2.14"></a><span id="l2.14">             Components.interfaces.nsISupports,</span>
<a href="#l2.15"></a><span id="l2.15">             Components.interfaces.calIGoogleRequest,</span>
<a href="#l2.16"></a><span id="l2.16">             Components.interfaces.calIOperation,</span>
<a href="#l2.17"></a><span id="l2.17">             Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l2.18"></a><span id="l2.18">             Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l2.19"></a><span id="l2.19">             Components.interfaces.nsIChannelEventSink,</span>
<a href="#l2.20"></a><span id="l2.20">             Components.interfaces.nsIClassInfo</span>
<a href="#l2.21"></a><span id="l2.21">         ];</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -214,24 +214,24 @@ calGoogleRequest.prototype = {</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">         try {</span>
<a href="#l2.25"></a><span id="l2.25">             // Set the session to request with</span>
<a href="#l2.26"></a><span id="l2.26">             if (aSession) {</span>
<a href="#l2.27"></a><span id="l2.27">                 this.mSession = aSession;</span>
<a href="#l2.28"></a><span id="l2.28">             }</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">             // create the channel</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-            var ioService = cal.getIOService();</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+            let ioService = cal.getIOService();</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-            var uristring = this.uri;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+            let uristring = this.uri;</span>
<a href="#l2.36"></a><span id="l2.36">             if (this.mQueryParameters.length &gt; 0) {</span>
<a href="#l2.37"></a><span id="l2.37">                 uristring += &quot;?&quot; + this.mQueryParameters.join(&quot;&amp;&quot;);</span>
<a href="#l2.38"></a><span id="l2.38">             }</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-            var uri = ioService.newURI(uristring, null, null);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-            var channel = ioService.newChannelFromURI(uri);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+            let uri = ioService.newURI(uristring, null, null);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+            let channel = ioService.newChannelFromURI(uri);</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">             this.prepareChannel(channel);</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">             channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l2.47"></a><span id="l2.47">             channel.redirectionLimit = 3;</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">             this.mLoader = cal.createStreamLoader();</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51" class="difflineat">@@ -281,21 +281,21 @@ calGoogleRequest.prototype = {</span>
<a href="#l2.52"></a><span id="l2.52">      */</span>
<a href="#l2.53"></a><span id="l2.53">     prepareChannel: function cGR_prepareChannel(aChannel) {</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">         // No caching</span>
<a href="#l2.56"></a><span id="l2.56">         aChannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">         // Set upload Data</span>
<a href="#l2.59"></a><span id="l2.59">         if (this.mUploadData) {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-            var converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+            let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].</span>
<a href="#l2.62"></a><span id="l2.62">                             createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l2.63"></a><span id="l2.63">             converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-            var stream = converter.convertToInputStream(this.mUploadData);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+            let stream = converter.convertToInputStream(this.mUploadData);</span>
<a href="#l2.67"></a><span id="l2.67">             aChannel = aChannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l2.68"></a><span id="l2.68">             aChannel.setUploadStream(stream, this.mUploadContent, -1);</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">             if (this.mType == this.LOGIN) {</span>
<a href="#l2.71"></a><span id="l2.71">                 cal.LOG(&quot;[calGoogleCalendar] Setting upload data for login request (hidden)&quot;);</span>
<a href="#l2.72"></a><span id="l2.72">             } else {</span>
<a href="#l2.73"></a><span id="l2.73">                 cal.LOG(&quot;[calGoogleCalendar] Setting Upload Data (&quot; +</span>
<a href="#l2.74"></a><span id="l2.74">                         this.mUploadContent + &quot;):\n&quot; + this.mUploadData);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineat">@@ -360,29 +360,29 @@ calGoogleRequest.prototype = {</span>
<a href="#l2.76"></a><span id="l2.76">                                                     aStatus,</span>
<a href="#l2.77"></a><span id="l2.77">                                                     aResultLength,</span>
<a href="#l2.78"></a><span id="l2.78">                                                     aResult) {</span>
<a href="#l2.79"></a><span id="l2.79">         if (!aResult || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l2.80"></a><span id="l2.80">             this.fail(aStatus, aResult);</span>
<a href="#l2.81"></a><span id="l2.81">             return;</span>
<a href="#l2.82"></a><span id="l2.82">         }</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-        var httpChannel = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+        let httpChannel = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87">         // Convert the stream, falling back to utf-8 in case its not given.</span>
<a href="#l2.88"></a><span id="l2.88">         let result = cal.convertByteArray(aResult, aResultLength, httpChannel.contentCharset);</span>
<a href="#l2.89"></a><span id="l2.89">         if (result === null) {</span>
<a href="#l2.90"></a><span id="l2.90">             this.fail(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l2.91"></a><span id="l2.91">                       &quot;Could not convert bytestream to Unicode: &quot; + e);</span>
<a href="#l2.92"></a><span id="l2.92">             return;</span>
<a href="#l2.93"></a><span id="l2.93">         }</span>
<a href="#l2.94"></a><span id="l2.94"> </span>
<a href="#l2.95"></a><span id="l2.95">         // Calculate Google Clock Skew</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-        var serverDate = new Date(httpChannel.getResponseHeader(&quot;Date&quot;));</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-        var curDate = new Date();</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+        let serverDate = new Date(httpChannel.getResponseHeader(&quot;Date&quot;));</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+        let curDate = new Date();</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">         // The utility function getCorrectedDate in calGoogleUtils.js recieves</span>
<a href="#l2.102"></a><span id="l2.102">         // its clock skew seconds from here. The clock skew is updated on each</span>
<a href="#l2.103"></a><span id="l2.103">         // request and is therefore quite accurate.</span>
<a href="#l2.104"></a><span id="l2.104">         getCorrectedDate.mClockSkew = curDate.getTime() - serverDate.getTime();</span>
<a href="#l2.105"></a><span id="l2.105"> </span>
<a href="#l2.106"></a><span id="l2.106">         // Remember when this request happened</span>
<a href="#l2.107"></a><span id="l2.107">         this.requestDate = jsDateToDateTime(serverDate);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineat">@@ -450,17 +450,17 @@ calGoogleRequest.prototype = {</span>
<a href="#l2.109"></a><span id="l2.109">             default:</span>
<a href="#l2.110"></a><span id="l2.110">                 // The following codes are caught here:</span>
<a href="#l2.111"></a><span id="l2.111">                 //  500 INTERNAL SERVER ERROR: Internal error. This is the</span>
<a href="#l2.112"></a><span id="l2.112">                 //                             default code that is used for</span>
<a href="#l2.113"></a><span id="l2.113">                 //                             all unrecognized errors.</span>
<a href="#l2.114"></a><span id="l2.114">                 //</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116">                 // Something else went wrong</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-                var error = &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+                let error = &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l2.119"></a><span id="l2.119">                             httpChannel.responseStatus + &quot; &quot; +</span>
<a href="#l2.120"></a><span id="l2.120">                             httpChannel.responseStatusText + &quot; Body: &quot; +</span>
<a href="#l2.121"></a><span id="l2.121">                             result;</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123">                 this.fail(Components.results.NS_ERROR_NOT_AVAILABLE, error);</span>
<a href="#l2.124"></a><span id="l2.124">                 break;</span>
<a href="#l2.125"></a><span id="l2.125">         }</span>
<a href="#l2.126"></a><span id="l2.126">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -30,32 +30,33 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.5"></a><span id="l3.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.6"></a><span id="l3.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.7"></a><span id="l3.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.8"></a><span id="l3.8">  *</span>
<a href="#l3.9"></a><span id="l3.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> // This constant is an arbitrary large number. It is used to tell google to get</span>
<a href="#l3.16"></a><span id="l3.16"> // many events, the exact number is not important.</span>
<a href="#l3.17"></a><span id="l3.17"> const kMANY_EVENTS = 0x7FFFFFFF;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> function calGoogleSessionManager() {</span>
<a href="#l3.20"></a><span id="l3.20">     this.wrappedJSObject = this;</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> }</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24"> calGoogleSessionManager.prototype = {</span>
<a href="#l3.25"></a><span id="l3.25">     mSessionMap: {},</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     getInterfaces: function cI_cGSM_getInterfaces (aCount) {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-        var ifaces = [</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+        const ifaces = [</span>
<a href="#l3.30"></a><span id="l3.30">             Components.interfaces.nsISupports,</span>
<a href="#l3.31"></a><span id="l3.31">             Components.interfaces.calIGoogleSessionManager,</span>
<a href="#l3.32"></a><span id="l3.32">             Components.interfaces.nsIClassInfo</span>
<a href="#l3.33"></a><span id="l3.33">         ];</span>
<a href="#l3.34"></a><span id="l3.34">         aCount.value = ifaces.length;</span>
<a href="#l3.35"></a><span id="l3.35">         return ifaces;</span>
<a href="#l3.36"></a><span id="l3.36">     },</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38" class="difflineat">@@ -269,17 +270,16 @@ calGoogleSession.prototype = {</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">             // We need to have a user and should not be logging in</span>
<a href="#l3.41"></a><span id="l3.41">             ASSERT(!this.mLoggingIn);</span>
<a href="#l3.42"></a><span id="l3.42">             ASSERT(this.mGoogleUser);</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">             // Start logging in</span>
<a href="#l3.45"></a><span id="l3.45">             this.mLoggingIn = true;</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-</span>
<a href="#l3.48"></a><span id="l3.48">             if (this.mGooglePass === undefined) {</span>
<a href="#l3.49"></a><span id="l3.49">                 // This happens only on the first run. Try to get the password</span>
<a href="#l3.50"></a><span id="l3.50">                 // from the password manager.</span>
<a href="#l3.51"></a><span id="l3.51">                 let password = {};</span>
<a href="#l3.52"></a><span id="l3.52">                 passwordManagerGet(this.mGoogleUser, password);</span>
<a href="#l3.53"></a><span id="l3.53">                 if (password.value) {</span>
<a href="#l3.54"></a><span id="l3.54">                     cal.LOG(&quot;Retrieved Password for &quot; + this.mGoogleUser +</span>
<a href="#l3.55"></a><span id="l3.55">                             &quot; from password manager&quot;);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineat">@@ -291,37 +291,37 @@ calGoogleSession.prototype = {</span>
<a href="#l3.57"></a><span id="l3.57">                     // the next block.</span>
<a href="#l3.58"></a><span id="l3.58">                     this.mGooglePass = null;</span>
<a href="#l3.59"></a><span id="l3.59">                 }</span>
<a href="#l3.60"></a><span id="l3.60">             }</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62">             // Check if we have a password. If not, authentication may have</span>
<a href="#l3.63"></a><span id="l3.63">             // failed.</span>
<a href="#l3.64"></a><span id="l3.64">             if (!this.mGooglePass) {</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-                var username = { value: this.mGoogleUser };</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-                var password = { value: null };</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-                var persist = { value: false };</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                let username = { value: this.mGoogleUser };</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+                let password = { value: null };</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+                let persist = { value: false };</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72">                 // Try getting a new password, potentially switching sesssions.</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-                var calendarName = (aCalendar ?</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+                let calendarName = (aCalendar ?</span>
<a href="#l3.75"></a><span id="l3.75">                                     aCalendar.googleCalendarName :</span>
<a href="#l3.76"></a><span id="l3.76">                                     this.mGoogleUser);</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78">                 if (getCalendarCredentials(calendarName,</span>
<a href="#l3.79"></a><span id="l3.79">                                            username,</span>
<a href="#l3.80"></a><span id="l3.80">                                            password,</span>
<a href="#l3.81"></a><span id="l3.81">                                            persist)) {</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">                     cal.LOG(&quot;[calGoogleCalendar] Got the pw from the calendar credentials: &quot; +</span>
<a href="#l3.84"></a><span id="l3.84">                             calendarName);</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86">                     // If a different username was entered, switch sessions</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88">                     if (aCalendar &amp;&amp; username.value != this.mGoogleUser) {</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-                        var newSession = getGoogleSessionManager()</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+                        let newSession = getGoogleSessionManager()</span>
<a href="#l3.91"></a><span id="l3.91">                                          .getSessionByUsername(username.value,</span>
<a href="#l3.92"></a><span id="l3.92">                                                                true);</span>
<a href="#l3.93"></a><span id="l3.93">                         newSession.password = password.value;</span>
<a href="#l3.94"></a><span id="l3.94">                         newSession.persist = persist.value;</span>
<a href="#l3.95"></a><span id="l3.95">                         setCalendarPref(aCalendar,</span>
<a href="#l3.96"></a><span id="l3.96">                                         &quot;googleUser&quot;,</span>
<a href="#l3.97"></a><span id="l3.97">                                         &quot;CHAR&quot;,</span>
<a href="#l3.98"></a><span id="l3.98">                                         username.value);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineat">@@ -387,24 +387,24 @@ calGoogleSession.prototype = {</span>
<a href="#l3.100"></a><span id="l3.100">                     return;</span>
<a href="#l3.101"></a><span id="l3.101">                 }</span>
<a href="#l3.102"></a><span id="l3.102">             }</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104">             // Now we should have a password</span>
<a href="#l3.105"></a><span id="l3.105">             ASSERT(this.mGooglePass);</span>
<a href="#l3.106"></a><span id="l3.106"> </span>
<a href="#l3.107"></a><span id="l3.107">             // Get Version info</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-            var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;].</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+            let appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;].</span>
<a href="#l3.110"></a><span id="l3.110">                           getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-            var source = appInfo.vendor + &quot;-&quot; +</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+            let source = appInfo.vendor + &quot;-&quot; +</span>
<a href="#l3.113"></a><span id="l3.113">                          appInfo.name + &quot;-&quot; +</span>
<a href="#l3.114"></a><span id="l3.114">                          appInfo.version;</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116">             // Request Login</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-            var request = new calGoogleRequest(this);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+            let request = new calGoogleRequest(this);</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120">             request.type = request.LOGIN;</span>
<a href="#l3.121"></a><span id="l3.121">             request.calendar = aCalendar;</span>
<a href="#l3.122"></a><span id="l3.122">             request.responseListener = this;</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">             request.setUploadData(&quot;application/x-www-form-urlencoded&quot;,</span>
<a href="#l3.125"></a><span id="l3.125">                                   &quot;Email=&quot; + encodeURIComponent(this.mGoogleUser) +</span>
<a href="#l3.126"></a><span id="l3.126">                                   &quot;&amp;Passwd=&quot; + encodeURIComponent(this.mGooglePass) +</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineat">@@ -452,17 +452,17 @@ calGoogleSession.prototype = {</span>
<a href="#l3.128"></a><span id="l3.128">                 // If the login failed, then retry the login. This is not an</span>
<a href="#l3.129"></a><span id="l3.129">                 // error that should trigger failing the calICalendar's request.</span>
<a href="#l3.130"></a><span id="l3.130">                 this.loginAndContinue(aOperation.calendar);</span>
<a href="#l3.131"></a><span id="l3.131">             } else {</span>
<a href="#l3.132"></a><span id="l3.132">                 cal.LOG(&quot;[calGoogleCalendar] Failing queue with &quot; + aOperation.status);</span>
<a href="#l3.133"></a><span id="l3.133">                 this.failQueue(aOperation.status);</span>
<a href="#l3.134"></a><span id="l3.134">             }</span>
<a href="#l3.135"></a><span id="l3.135">         } else {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-            var start = aData.indexOf(&quot;Auth=&quot;);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+            let start = aData.indexOf(&quot;Auth=&quot;);</span>
<a href="#l3.138"></a><span id="l3.138">             if (start == -1) {</span>
<a href="#l3.139"></a><span id="l3.139">                 // The Auth token could not be extracted</span>
<a href="#l3.140"></a><span id="l3.140">                 this.mLoggingIn = false;</span>
<a href="#l3.141"></a><span id="l3.141">                 this.invalidate();</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143">                 // Retry login</span>
<a href="#l3.144"></a><span id="l3.144">                 this.loginAndContinue(aOperation.calendar);</span>
<a href="#l3.145"></a><span id="l3.145">             } else {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineat">@@ -477,17 +477,17 @@ calGoogleSession.prototype = {</span>
<a href="#l3.147"></a><span id="l3.147">                     } catch (e) {</span>
<a href="#l3.148"></a><span id="l3.148">                         // This error is non-fatal, but would constrict</span>
<a href="#l3.149"></a><span id="l3.149">                         // functionality</span>
<a href="#l3.150"></a><span id="l3.150">                         cal.LOG(&quot;[calGoogleCalendar] Error adding password to manager&quot;);</span>
<a href="#l3.151"></a><span id="l3.151">                     }</span>
<a href="#l3.152"></a><span id="l3.152">                 }</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154">                 // Process Items that were requested while logging in</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-                var request;</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+                let request;</span>
<a href="#l3.157"></a><span id="l3.157">                 // Extra parentheses to avoid js strict warning.</span>
<a href="#l3.158"></a><span id="l3.158">                 while ((request = this.mItemQueue.shift())) {</span>
<a href="#l3.159"></a><span id="l3.159">                     cal.LOG(&quot;[calGoogleCalendar] Processing Queue Item: &quot; + request.uri);</span>
<a href="#l3.160"></a><span id="l3.160">                     request.commit(this);</span>
<a href="#l3.161"></a><span id="l3.161">                 }</span>
<a href="#l3.162"></a><span id="l3.162">             }</span>
<a href="#l3.163"></a><span id="l3.163">         }</span>
<a href="#l3.164"></a><span id="l3.164">     },</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineat">@@ -562,20 +562,20 @@ calGoogleSession.prototype = {</span>
<a href="#l3.166"></a><span id="l3.166">             aRangeStart = aRangeStart.clone();</span>
<a href="#l3.167"></a><span id="l3.167">             aRangeStart.isDate = false;</span>
<a href="#l3.168"></a><span id="l3.168">         }</span>
<a href="#l3.169"></a><span id="l3.169">         if (aRangeEnd) {</span>
<a href="#l3.170"></a><span id="l3.170">             aRangeEnd = aRangeEnd.clone();</span>
<a href="#l3.171"></a><span id="l3.171">             aRangeEnd.isDate = false;</span>
<a href="#l3.172"></a><span id="l3.172">         }</span>
<a href="#l3.173"></a><span id="l3.173"> </span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-        var rfcRangeStart = cal.toRFC3339(aRangeStart);</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-        var rfcRangeEnd = cal.toRFC3339(aRangeEnd);</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+        let rfcRangeStart = cal.toRFC3339(aRangeStart);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+        let rfcRangeEnd = cal.toRFC3339(aRangeEnd);</span>
<a href="#l3.178"></a><span id="l3.178"> </span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-        var request = new calGoogleRequest(this);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+        let request = new calGoogleRequest(this);</span>
<a href="#l3.181"></a><span id="l3.181"> </span>
<a href="#l3.182"></a><span id="l3.182">         request.type = request.GET;</span>
<a href="#l3.183"></a><span id="l3.183">         request.uri = &quot;https://www.google.com/calendar/feeds/&quot; +</span>
<a href="#l3.184"></a><span id="l3.184">                       encodeURIComponent(aCalId.replace(/^mailto:/i, &quot;&quot;)) +</span>
<a href="#l3.185"></a><span id="l3.185">                       &quot;/private/free-busy&quot;;</span>
<a href="#l3.186"></a><span id="l3.186">         request.operationListener = aListener;</span>
<a href="#l3.187"></a><span id="l3.187">         request.itemRangeStart = aRangeStart;</span>
<a href="#l3.188"></a><span id="l3.188">         request.itemRangeEnd = aRangeEnd;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineat">@@ -583,17 +583,17 @@ calGoogleSession.prototype = {</span>
<a href="#l3.190"></a><span id="l3.190"> </span>
<a href="#l3.191"></a><span id="l3.191">         // Request Parameters</span>
<a href="#l3.192"></a><span id="l3.192">         request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l3.193"></a><span id="l3.193">         request.addQueryParameter(&quot;max-results&quot;, kMANY_EVENTS);</span>
<a href="#l3.194"></a><span id="l3.194">         request.addQueryParameter(&quot;singleevents&quot;, &quot;true&quot;);</span>
<a href="#l3.195"></a><span id="l3.195">         request.addQueryParameter(&quot;start-min&quot;, rfcRangeStart);</span>
<a href="#l3.196"></a><span id="l3.196">         request.addQueryParameter(&quot;start-max&quot;, rfcRangeEnd);</span>
<a href="#l3.197"></a><span id="l3.197"> </span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-        var session = this;</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+        let session = this;</span>
<a href="#l3.200"></a><span id="l3.200">         request.responseListener = {</span>
<a href="#l3.201"></a><span id="l3.201">             onResult: function cGS_getFreeBusyIntervals_onResult(aOperation, aData) {</span>
<a href="#l3.202"></a><span id="l3.202">                 session.getFreeBusyIntervals_response(aOperation,</span>
<a href="#l3.203"></a><span id="l3.203">                                                       aData,</span>
<a href="#l3.204"></a><span id="l3.204">                                                       aCalId,</span>
<a href="#l3.205"></a><span id="l3.205">                                                       aRangeStart,</span>
<a href="#l3.206"></a><span id="l3.206">                                                       aRangeEnd);</span>
<a href="#l3.207"></a><span id="l3.207">             }</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineat">@@ -604,43 +604,32 @@ calGoogleSession.prototype = {</span>
<a href="#l3.209"></a><span id="l3.209">     },</span>
<a href="#l3.210"></a><span id="l3.210"> </span>
<a href="#l3.211"></a><span id="l3.211">     getFreeBusyIntervals_response: function getFreeBusyIntervals_response(aOperation,</span>
<a href="#l3.212"></a><span id="l3.212">                                                                           aData,</span>
<a href="#l3.213"></a><span id="l3.213">                                                                           aCalId,</span>
<a href="#l3.214"></a><span id="l3.214">                                                                           aRangeStart,</span>
<a href="#l3.215"></a><span id="l3.215">                                                                           aRangeEnd) {</span>
<a href="#l3.216"></a><span id="l3.216">         // Prepare Namespaces</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-        var gCal = new Namespace(&quot;gCal&quot;,</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-                                 &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-        var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-        var atom = new Namespace(&quot;&quot;, &quot;http://www.w3.org/2005/Atom&quot;);</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-        default xml namespace = atom;</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-</span>
<a href="#l3.223"></a><span id="l3.223">         if (aOperation.status == kGOOGLE_LOGIN_FAILED ||</span>
<a href="#l3.224"></a><span id="l3.224">             !Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l3.225"></a><span id="l3.225">             aOperation.operationListener.onResult(aOperation, null);</span>
<a href="#l3.226"></a><span id="l3.226">             return;</span>
<a href="#l3.227"></a><span id="l3.227">         }</span>
<a href="#l3.228"></a><span id="l3.228"> </span>
<a href="#l3.229"></a><span id="l3.229">         // A feed was passed back, parse it.</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-        var xml = cal.safeNewXML(aData);</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-        var timezoneString = xml.gCal::timezone.@value.toString() || &quot;UTC&quot;;</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-        var timezone = cal.getTimezoneService().getTimezone(timezoneString);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+        let xml = cal.xml.parseString(aData);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+        let timezoneString = gdataXPathFirst(xml, 'atom:feed/gCal:timezone/@value') || &quot;UTC&quot;;</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+        let timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l3.236"></a><span id="l3.236"> </span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-        // This line is needed, otherwise the for each () block will never</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-        // be entered. It may seem strange, but if you don't believe me, try</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-        // it!</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-        xml.link.(@rel);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-        var intervals = [];</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+        let intervals = [];</span>
<a href="#l3.244"></a><span id="l3.244">         const fbtypes = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-        for each (var entry in xml.entry) {</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-            let start = cal.fromRFC3339(entry.gd::when.@startTime.toString(), timezone);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-            let end = cal.fromRFC3339(entry.gd::when.@endTime.toString(), timezone);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+        for each (let entry in gdataXPath(xml, 'atom:feed/atom:entry')) {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+            let start = cal.fromRFC3339(gdataXPathFirst(entry, 'gd:when/@startTime'), timezone);</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+            let end = cal.fromRFC3339(gdataXPathFirst(entry, 'gd:when/@endTime'), timezone);</span>
<a href="#l3.251"></a><span id="l3.251">             let interval = new cal.FreeBusyInterval(aCalId, fbtypes.BUSY, start, end);</span>
<a href="#l3.252"></a><span id="l3.252">             LOGinterval(interval);</span>
<a href="#l3.253"></a><span id="l3.253">             intervals.push(interval);</span>
<a href="#l3.254"></a><span id="l3.254">         }</span>
<a href="#l3.255"></a><span id="l3.255"> </span>
<a href="#l3.256"></a><span id="l3.256">         aOperation.operationListener.onResult(aOperation, intervals);</span>
<a href="#l3.257"></a><span id="l3.257">     }</span>
<a href="#l3.258"></a><span id="l3.258"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -32,35 +32,55 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.5"></a><span id="l4.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.6"></a><span id="l4.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.7"></a><span id="l4.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.8"></a><span id="l4.8">  *</span>
<a href="#l4.9"></a><span id="l4.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+const atomNS = &quot;http://www.w3.org/2005/Atom&quot;;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+const gdNS = &quot;http://schemas.google.com/g/2005&quot;;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+const gcalNS = &quot;http://schemas.google.com/gCal/2005&quot;;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+function gdataNSResolver(prefix) {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+    const ns = {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+        atom: atomNS,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+        gd: gdNS,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+        gCal: gcalNS</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+    };</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    return ns[prefix] || atomNS;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+}</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+function gdataXPath(aNode, aExpr, aType) {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    return cal.xml.evalXPath(aNode, aExpr, gdataNSResolver, aType);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+}</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+function gdataXPathFirst(aNode, aExpr, aType) {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+    // Different than the caldav/ics functions, this one will return an empty string on null</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    return cal.xml.evalXPathFirst(aNode, aExpr, gdataNSResolver, aType) || &quot;&quot;;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+}</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+</span>
<a href="#l4.38"></a><span id="l4.38"> /**</span>
<a href="#l4.39"></a><span id="l4.39">  * getGoogleSessionManager</span>
<a href="#l4.40"></a><span id="l4.40">  * Shortcut to the google session manager</span>
<a href="#l4.41"></a><span id="l4.41">  */</span>
<a href="#l4.42"></a><span id="l4.42"> function getGoogleSessionManager() {</span>
<a href="#l4.43"></a><span id="l4.43">     if (this.mObject === undefined) {</span>
<a href="#l4.44"></a><span id="l4.44">         this.mObject =</span>
<a href="#l4.45"></a><span id="l4.45">             Components.classes[&quot;@mozilla.org/calendar/providers/gdata/session-manager;1&quot;]</span>
<a href="#l4.46"></a><span id="l4.46">                       .createInstance(Components.interfaces.calIGoogleSessionManager);</span>
<a href="#l4.47"></a><span id="l4.47">     }</span>
<a href="#l4.48"></a><span id="l4.48">     return this.mObject;</span>
<a href="#l4.49"></a><span id="l4.49"> }</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-// Sandbox for evaluating extendedProperties.</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-var gGoogleSandbox;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-</span>
<a href="#l4.54"></a><span id="l4.54"> /**</span>
<a href="#l4.55"></a><span id="l4.55">  * setCalendarPref</span>
<a href="#l4.56"></a><span id="l4.56">  * Helper to set an independant Calendar Preference, since I cannot use the</span>
<a href="#l4.57"></a><span id="l4.57">  * calendar manager because of early initialization Problems.</span>
<a href="#l4.58"></a><span id="l4.58">  *</span>
<a href="#l4.59"></a><span id="l4.59">  * @param aCalendar     The Calendar to set the pref for</span>
<a href="#l4.60"></a><span id="l4.60">  * @param aPrefName     The Preference name</span>
<a href="#l4.61"></a><span id="l4.61">  * @param aPrefType     The type of the preference (&quot;BOOL&quot;, &quot;INT&quot;, &quot;CHAR&quot;)</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineat">@@ -173,17 +193,17 @@ var gdataTimezoneService = {</span>
<a href="#l4.63"></a><span id="l4.63">     getTimezone: function gTS_getTimezone(aTzid) {</span>
<a href="#l4.64"></a><span id="l4.64">         if (aTzid == &quot;Etc/GMT&quot;) {</span>
<a href="#l4.65"></a><span id="l4.65">             // Most timezones are covered by the timezone service, there is one</span>
<a href="#l4.66"></a><span id="l4.66">             // exception I've found out about. GMT without DST is pretty close</span>
<a href="#l4.67"></a><span id="l4.67">             // to UTC, lets take it.</span>
<a href="#l4.68"></a><span id="l4.68">             return UTC();</span>
<a href="#l4.69"></a><span id="l4.69">         }</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-        var baseTZ = this.ctz.getTimezone(aTzid);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+        let baseTZ = this.ctz.getTimezone(aTzid);</span>
<a href="#l4.73"></a><span id="l4.73">         ASSERT(baseTZ, &quot;Unknown Timezone requested: &quot; + aTzid);</span>
<a href="#l4.74"></a><span id="l4.74">         return baseTZ;</span>
<a href="#l4.75"></a><span id="l4.75">     }</span>
<a href="#l4.76"></a><span id="l4.76"> };</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78"> /**</span>
<a href="#l4.79"></a><span id="l4.79">  * passwordManagerSave</span>
<a href="#l4.80"></a><span id="l4.80">  * Helper to insert an entry to the password manager.</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineat">@@ -237,17 +257,17 @@ function resolveConflicts(aOperation, aI</span>
<a href="#l4.82"></a><span id="l4.82">             // the correct sequence number.</span>
<a href="#l4.83"></a><span id="l4.83">             let newItem =  aOperation.newItem.clone();</span>
<a href="#l4.84"></a><span id="l4.84">             let session = aOperation.calendar.session;</span>
<a href="#l4.85"></a><span id="l4.85">             newItem.deleteProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l4.86"></a><span id="l4.86">             let xmlEntry = ItemToXMLEntry(newItem, aOperation.calendar,</span>
<a href="#l4.87"></a><span id="l4.87">                                           session.userName, session.fullName);</span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89">             aOperation.newItem = newItem;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-            aOperation.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, xmlEntry);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+            aOperation.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, cal.xml.serializeDOM(xmlEntry));</span>
<a href="#l4.92"></a><span id="l4.92">             session.asyncItemRequest(aOperation);</span>
<a href="#l4.93"></a><span id="l4.93">             return false;</span>
<a href="#l4.94"></a><span id="l4.94">         } else if (aOperation.status == kGOOGLE_CONFLICT_DELETED &amp;&amp;</span>
<a href="#l4.95"></a><span id="l4.95">                    aOperation.type == aOperation.DELETE) {</span>
<a href="#l4.96"></a><span id="l4.96">             // Deleted on the server and deleted locally. Great!</span>
<a href="#l4.97"></a><span id="l4.97">             return true;</span>
<a href="#l4.98"></a><span id="l4.98">         } else {</span>
<a href="#l4.99"></a><span id="l4.99">             // If a conflict occurred, then prompt</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineat">@@ -306,24 +326,24 @@ function DataToItem(aOperation, aData, a</span>
<a href="#l4.101"></a><span id="l4.101">         if (aData == &quot;SEQUENCE-HACK&quot;) {</span>
<a href="#l4.102"></a><span id="l4.102">             // Working around a Google issue here, see what happens on a 400</span>
<a href="#l4.103"></a><span id="l4.103">             // code in calGoogleRequest.js. This will be processed in</span>
<a href="#l4.104"></a><span id="l4.104">             // resolveConflicts().</span>
<a href="#l4.105"></a><span id="l4.105">             return &quot;SEQUENCE-HACK&quot;;</span>
<a href="#l4.106"></a><span id="l4.106">         }</span>
<a href="#l4.107"></a><span id="l4.107"> </span>
<a href="#l4.108"></a><span id="l4.108">         if (aData &amp;&amp; aData.length) {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-            let xml = cal.safeNewXML(aData);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + xml + &quot;\n&quot;);</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+            let xml = cal.xml.parseString(aData);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + aData + &quot;\n&quot;);</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114">             // Get the local timezone from the preferences</span>
<a href="#l4.115"></a><span id="l4.115">             let timezone = calendarDefaultTimezone();</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117">             // Parse the Item with the given timezone</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-            item = XMLEntryToItem(xml, timezone,</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+            item = XMLEntryToItem(xml.documentElement, timezone,</span>
<a href="#l4.120"></a><span id="l4.120">                                   aGoogleCalendar,</span>
<a href="#l4.121"></a><span id="l4.121">                                   aReferenceItem);</span>
<a href="#l4.122"></a><span id="l4.122">         } else {</span>
<a href="#l4.123"></a><span id="l4.123">             cal.LOG(&quot;[calGoogleCalendar] No content, using reference item instead &quot;);</span>
<a href="#l4.124"></a><span id="l4.124">             // No data happens for example on delete. Just assume the reference</span>
<a href="#l4.125"></a><span id="l4.125">             // item.</span>
<a href="#l4.126"></a><span id="l4.126">             item = aReferenceItem.clone();</span>
<a href="#l4.127"></a><span id="l4.127">         }</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineat">@@ -342,89 +362,91 @@ function DataToItem(aOperation, aData, a</span>
<a href="#l4.129"></a><span id="l4.129">  *</span>
<a href="#l4.130"></a><span id="l4.130">  * @param aItem         The item to convert</span>
<a href="#l4.131"></a><span id="l4.131">  * @param aCalendar     The calendar to use, this must be a calIGoogleCalendar</span>
<a href="#l4.132"></a><span id="l4.132">  * @param aAuthorEmail  The email of the author of the event</span>
<a href="#l4.133"></a><span id="l4.133">  * @param aAuthorName   The full name of the author of the event</span>
<a href="#l4.134"></a><span id="l4.134">  * @return              The xml data of the item</span>
<a href="#l4.135"></a><span id="l4.135">  */</span>
<a href="#l4.136"></a><span id="l4.136"> function ItemToXMLEntry(aItem, aCalendar, aAuthorEmail, aAuthorName) {</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-    var selfIsOrganizer = (!aItem.organizer ||</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    let selfIsOrganizer = (!aItem.organizer ||</span>
<a href="#l4.140"></a><span id="l4.140">                             aItem.organizer.id == &quot;mailto:&quot; + aCalendar.googleCalendarName);</span>
<a href="#l4.141"></a><span id="l4.141"> </span>
<a href="#l4.142"></a><span id="l4.142">     function addExtendedProperty(aName, aValue) {</span>
<a href="#l4.143"></a><span id="l4.143">         if (!selfIsOrganizer || !aValue) {</span>
<a href="#l4.144"></a><span id="l4.144">             // We can't set extended properties if we are not the organizer,</span>
<a href="#l4.145"></a><span id="l4.145">             // discard. Also, if the value is null/false, we can delete the</span>
<a href="#l4.146"></a><span id="l4.146">             // extended property by not adding it.</span>
<a href="#l4.147"></a><span id="l4.147">             return;</span>
<a href="#l4.148"></a><span id="l4.148">         }</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-        var gdExtendedProp = &lt;gd:extendedProperty xmlns:gd={gd}/&gt;;</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-        gdExtendedProp.@name = aName;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-        gdExtendedProp.@value = aValue || &quot;&quot;;</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-        entry.gd::extendedProperty += gdExtendedProp;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+        let gdExtendedProp = document.createElementNS(gdNS, &quot;extendedProperty&quot;);</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+        gdExtendedProp.setAttribute(&quot;name&quot;, aName);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+        gdExtendedProp.setAttribute(&quot;value&quot;, aValue || &quot;&quot;);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+        entry.appendChild(gdExtendedProp);</span>
<a href="#l4.157"></a><span id="l4.157">     }</span>
<a href="#l4.158"></a><span id="l4.158"> </span>
<a href="#l4.159"></a><span id="l4.159">     if (!aItem) {</span>
<a href="#l4.160"></a><span id="l4.160">         throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l4.161"></a><span id="l4.161">     }</span>
<a href="#l4.162"></a><span id="l4.162"> </span>
<a href="#l4.163"></a><span id="l4.163">     const kEVENT_SCHEMA = &quot;http://schemas.google.com/g/2005#event.&quot;;</span>
<a href="#l4.164"></a><span id="l4.164"> </span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-    // Namespace definitions</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-    var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-    var gCal = new Namespace(&quot;gCal&quot;, &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-    var atom = new Namespace(&quot;&quot;, &quot;http://www.w3.org/2005/Atom&quot;);</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-    default xml namespace = atom;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+    // Document creation</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    let document = cal.xml.parseString('&lt;entry xmlns=&quot;' + atomNS + '&quot; xmlns:gd=&quot;' + gdNS + '&quot; xmlns:gCal=&quot;' + gcalNS + '&quot;/&gt;');</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+    let entry = document.documentElement;</span>
<a href="#l4.173"></a><span id="l4.173"> </span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-    var entry = &lt;entry xmlns={atom} xmlns:gd={gd} xmlns:gCal={gCal}/&gt;;</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+    // Helper functions</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    function elemNS(ns, name) document.createElementNS(ns, name);</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+    function addElemNS(ns, name, parent) (parent || entry).appendChild(elemNS(ns, name));</span>
<a href="#l4.178"></a><span id="l4.178"> </span>
<a href="#l4.179"></a><span id="l4.179">     // Basic elements</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-    entry.category.@scheme = &quot;http://schemas.google.com/g/2005#kind&quot;;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-    entry.category.@term = &quot;http://schemas.google.com/g/2005#event&quot;;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+    let kindElement = addElemNS(atomNS, &quot;category&quot;);</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+    kindElement.setAttribute(&quot;scheme&quot;, &quot;http://schemas.google.com/g/2005#kind&quot;);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+    kindElement.setAttribute(&quot;term&quot;, &quot;http://schemas.google.com/g/2005#event&quot;);</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-    entry.title.@type = &quot;text&quot;;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-    entry.title = aItem.title;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+    let titleElement = addElemNS(atomNS, &quot;title&quot;);</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+    titleElement.setAttribute(&quot;type&quot;, &quot;text&quot;);</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+    titleElement.textContent = aItem.title;</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192">     // atom:content</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-    entry.content = aItem.getProperty(&quot;DESCRIPTION&quot;) || &quot;&quot;;</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-    entry.content.@type = &quot;text&quot;;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+    let contentElement = addElemNS(atomNS, &quot;content&quot;);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+    contentElement.setAttribute(&quot;type&quot;, &quot;text&quot;);</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+    contentElement.textContent = aItem.getProperty(&quot;DESCRIPTION&quot;) || &quot;&quot;;</span>
<a href="#l4.198"></a><span id="l4.198"> </span>
<a href="#l4.199"></a><span id="l4.199">     // atom:author</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-    entry.author.name = aAuthorName;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-    entry.author.email = aAuthorEmail;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+    let authorElement = addElemNS(atomNS, &quot;author&quot;);</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+    addElemNS(atomNS, &quot;name&quot;, authorElement).textContent = aAuthorName || aAuthorEmail;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+    addElemNS(atomNS, &quot;email&quot;, authorElement).textContent = aAuthorEmail;</span>
<a href="#l4.205"></a><span id="l4.205"> </span>
<a href="#l4.206"></a><span id="l4.206">     // gd:transparency</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-    var transp = aItem.getProperty(&quot;TRANSP&quot;) || &quot;opaque&quot;;</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-    transp = kEVENT_SCHEMA + transp.toLowerCase();</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-    entry.gd::transparency.@value = transp;</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+    let transpElement = addElemNS(gdNS, &quot;transparency&quot;);</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    let transpValue = aItem.getProperty(&quot;TRANSP&quot;) || &quot;opaque&quot;;</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+    transpElement.setAttribute(&quot;value&quot;, kEVENT_SCHEMA + transpValue.toLowerCase());</span>
<a href="#l4.213"></a><span id="l4.213"> </span>
<a href="#l4.214"></a><span id="l4.214">     // gd:eventStatus</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-    var status = aItem.status || &quot;confirmed&quot;;</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+    let status = aItem.status || &quot;confirmed&quot;;</span>
<a href="#l4.218"></a><span id="l4.218">     if (status == &quot;CANCELLED&quot;) {</span>
<a href="#l4.219"></a><span id="l4.219">         // If the status is canceled, then the event will be deleted. Since the</span>
<a href="#l4.220"></a><span id="l4.220">         // user didn't choose to delete the event, we will protect him and not</span>
<a href="#l4.221"></a><span id="l4.221">         // allow this status to be set</span>
<a href="#l4.222"></a><span id="l4.222">         throw new Components.Exception(&quot;&quot;,</span>
<a href="#l4.223"></a><span id="l4.223">                                        Components.results.NS_ERROR_LOSS_OF_SIGNIFICANT_DATA);</span>
<a href="#l4.224"></a><span id="l4.224">     } else if (status == &quot;NONE&quot;) {</span>
<a href="#l4.225"></a><span id="l4.225">         status = &quot;CONFIRMED&quot;;</span>
<a href="#l4.226"></a><span id="l4.226">     }</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-    entry.gd::eventStatus.@value = kEVENT_SCHEMA + status.toLowerCase();</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    addElemNS(gdNS, &quot;eventStatus&quot;).setAttribute(&quot;value&quot;, kEVENT_SCHEMA + status.toLowerCase());</span>
<a href="#l4.229"></a><span id="l4.229"> </span>
<a href="#l4.230"></a><span id="l4.230">     // gd:where</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-    entry.gd::where.@valueString = aItem.getProperty(&quot;LOCATION&quot;) || &quot;&quot;;</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+    addElemNS(gdNS, &quot;where&quot;).setAttribute(&quot;valueString&quot;, aItem.getProperty(&quot;LOCATION&quot;) || &quot;&quot;);</span>
<a href="#l4.233"></a><span id="l4.233"> </span>
<a href="#l4.234"></a><span id="l4.234">     // gd:who</span>
<a href="#l4.235"></a><span id="l4.235">     if (cal.getPrefSafe(&quot;calendar.google.enableAttendees&quot;, false)) {</span>
<a href="#l4.236"></a><span id="l4.236">         // XXX Only parse attendees if they are enabled, due to bug 407961</span>
<a href="#l4.237"></a><span id="l4.237"> </span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-        var attendees = aItem.getAttendees({});</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+        let attendees = aItem.getAttendees({});</span>
<a href="#l4.240"></a><span id="l4.240">         if (aItem.organizer) {</span>
<a href="#l4.241"></a><span id="l4.241">             // Taking care of the organizer is the same as taking care of any other</span>
<a href="#l4.242"></a><span id="l4.242">             // attendee. Add the organizer to the local attendees list.</span>
<a href="#l4.243"></a><span id="l4.243">             attendees.push(aItem.organizer);</span>
<a href="#l4.244"></a><span id="l4.244">         }</span>
<a href="#l4.245"></a><span id="l4.245"> </span>
<a href="#l4.246"></a><span id="l4.246">         const attendeeStatusMap = {</span>
<a href="#l4.247"></a><span id="l4.247">             &quot;REQ-PARTICIPANT&quot;: &quot;required&quot;,</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineat">@@ -434,211 +456,211 @@ function ItemToXMLEntry(aItem, aCalendar</span>
<a href="#l4.249"></a><span id="l4.249"> </span>
<a href="#l4.250"></a><span id="l4.250">             &quot;NEEDS-ACTION&quot;: &quot;invited&quot;,</span>
<a href="#l4.251"></a><span id="l4.251">             &quot;ACCEPTED&quot;: &quot;accepted&quot;,</span>
<a href="#l4.252"></a><span id="l4.252">             &quot;DECLINED&quot;: &quot;declined&quot;,</span>
<a href="#l4.253"></a><span id="l4.253">             &quot;TENTATIVE&quot;: &quot;tentative&quot;,</span>
<a href="#l4.254"></a><span id="l4.254">             &quot;DELEGATED&quot;: &quot;tentative&quot;</span>
<a href="#l4.255"></a><span id="l4.255">         };</span>
<a href="#l4.256"></a><span id="l4.256"> </span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-        for each (var attendee in attendees) {</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+        for each (let attendee in attendees) {</span>
<a href="#l4.259"></a><span id="l4.259">             if (attendee.userType &amp;&amp; attendee.userType != &quot;INDIVIDUAL&quot;) {</span>
<a href="#l4.260"></a><span id="l4.260">                 // We can only take care of individuals.</span>
<a href="#l4.261"></a><span id="l4.261">                 continue;</span>
<a href="#l4.262"></a><span id="l4.262">             }</span>
<a href="#l4.263"></a><span id="l4.263"> </span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-            var xmlAttendee = &lt;gd:who xmlns:gd={gd}/&gt;;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+            let xmlAttendee = addElemNS(gdNS, &quot;who&quot;);</span>
<a href="#l4.266"></a><span id="l4.266"> </span>
<a href="#l4.267"></a><span id="l4.267">             // Strip &quot;mailto:&quot; part</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-            xmlAttendee.@email = attendee.id.replace(/^mailto:/, &quot;&quot;);</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+            xmlAttendee.setAttribute(&quot;email&quot;, attendee.id.replace(/^mailto:/, &quot;&quot;));</span>
<a href="#l4.270"></a><span id="l4.270"> </span>
<a href="#l4.271"></a><span id="l4.271">             if (attendee.isOrganizer) {</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-                xmlAttendee.@rel = kEVENT_SCHEMA + &quot;organizer&quot;;</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+                xmlAttendee.setAttribute(&quot;rel&quot;, kEVENT_SCHEMA + &quot;organizer&quot;);</span>
<a href="#l4.274"></a><span id="l4.274">             } else {</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-                xmlAttendee.@rel = kEVENT_SCHEMA + &quot;attendee&quot;;</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+                xmlAttendee.setAttribute(&quot;rel&quot;, kEVENT_SCHEMA + &quot;attendee&quot;);</span>
<a href="#l4.277"></a><span id="l4.277">             }</span>
<a href="#l4.278"></a><span id="l4.278"> </span>
<a href="#l4.279"></a><span id="l4.279">             if (attendee.commonName) {</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-                xmlAttendee.@valueString = attendee.commonName;</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+                xmlAttendee.setAttribute(&quot;valueString&quot;, attendee.commonName);</span>
<a href="#l4.282"></a><span id="l4.282">             }</span>
<a href="#l4.283"></a><span id="l4.283"> </span>
<a href="#l4.284"></a><span id="l4.284">             if (attendeeStatusMap[attendee.role]) {</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-                xmlAttendee.gd::attendeeType.@value = kEVENT_SCHEMA +</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-                    attendeeStatusMap[attendee.role];</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+                let attendeeTypeElement = addElemNS(gdNS, &quot;attendeeType&quot;, xmlAttendee);</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+                let attendeeTypeValue = kEVENT_SCHEMA + attendeeStatusMap[attendee.role];</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+                attendeeTypeElement.setAttribute(&quot;value&quot;, attendeeTypeValue);</span>
<a href="#l4.290"></a><span id="l4.290">             }</span>
<a href="#l4.291"></a><span id="l4.291"> </span>
<a href="#l4.292"></a><span id="l4.292">             if (attendeeStatusMap[attendee.participationStatus]) {</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-                xmlAttendee.gd::attendeeStatus.@value = kEVENT_SCHEMA +</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-                    attendeeStatusMap[attendee.participationStatus];</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+                let attendeeStatusElement = addElemNS(gdNS, &quot;attendeeStatus&quot;, xmlAttendee);</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+                let attendeeStatusValue = kEVENT_SCHEMA + attendeeStatusMap[attendee.participationStatus];</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+                attendeeStatusElement.setAttribute(&quot;value&quot;, attendeeStatusValue);</span>
<a href="#l4.298"></a><span id="l4.298">             }</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-            entry.gd::who += xmlAttendee;</span>
<a href="#l4.301"></a><span id="l4.301">         }</span>
<a href="#l4.302"></a><span id="l4.302">     }</span>
<a href="#l4.303"></a><span id="l4.303"> </span>
<a href="#l4.304"></a><span id="l4.304">     // Don't notify attendees by default. Use a preference in case the user</span>
<a href="#l4.305"></a><span id="l4.305">     // wants this to be turned on.</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-    var notify = cal.getPrefSafe(&quot;calendar.google.sendEventNotifications&quot;, false);</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-    entry.gCal::sendEventNotifications.@value = (notify ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+    let notify = cal.getPrefSafe(&quot;calendar.google.sendEventNotifications&quot;, false);</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+    addElemNS(gcalNS, &quot;sendEventNotifications&quot;).setAttribute(&quot;value&quot;, notify ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l4.310"></a><span id="l4.310"> </span>
<a href="#l4.311"></a><span id="l4.311">     // gd:when</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-    var duration = aItem.endDate.subtractDate(aItem.startDate);</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+    let duration = aItem.endDate.subtractDate(aItem.startDate);</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+    let whenElement;</span>
<a href="#l4.315"></a><span id="l4.315">     if (!aItem.recurrenceInfo) {</span>
<a href="#l4.316"></a><span id="l4.316">         // gd:when isn't allowed for recurring items where gd:recurrence is set</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-        entry.gd::when.@startTime = cal.toRFC3339(aItem.startDate);</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-        entry.gd::when.@endTime = cal.toRFC3339(aItem.endDate);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+        whenElement = addElemNS(gdNS, &quot;when&quot;);</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+        whenElement.setAttribute(&quot;startTime&quot;, cal.toRFC3339(aItem.startDate));</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+        whenElement.setAttribute(&quot;endTime&quot;, cal.toRFC3339(aItem.endDate));</span>
<a href="#l4.322"></a><span id="l4.322">     }</span>
<a href="#l4.323"></a><span id="l4.323"> </span>
<a href="#l4.324"></a><span id="l4.324">     // gd:reminder</span>
<a href="#l4.325"></a><span id="l4.325">     let alarms = aItem.getAlarms({});</span>
<a href="#l4.326"></a><span id="l4.326">     let actionMap = {</span>
<a href="#l4.327"></a><span id="l4.327">         DISPLAY: &quot;alert&quot;,</span>
<a href="#l4.328"></a><span id="l4.328">         EMAIL: &quot;email&quot;,</span>
<a href="#l4.329"></a><span id="l4.329">         SMS: &quot;sms&quot;</span>
<a href="#l4.330"></a><span id="l4.330">     };</span>
<a href="#l4.331"></a><span id="l4.331">     if (selfIsOrganizer) {</span>
<a href="#l4.332"></a><span id="l4.332">         for (let i = 0; i &lt; 5 &amp;&amp; i &lt; alarms.length; i++) {</span>
<a href="#l4.333"></a><span id="l4.333">             let alarm = alarms[i];</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-            let gdReminder = &lt;gd:reminder xmlns:gd={gd}/&gt;;</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+            let gdReminder;</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+            if (aItem.recurrenceInfo) {</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+                // On recurring items, set the reminder directly in the &lt;entry&gt; tag.</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+                gdReminder = addElemNS(gdNS, &quot;reminder&quot;);</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+            } else {</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+                // Otherwise, its a child of the gd:when element</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+                gdReminder = addElemNS(gdNS, &quot;reminder&quot;, whenElement);</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+            }</span>
<a href="#l4.343"></a><span id="l4.343">             if (alarm.related == alarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l4.344"></a><span id="l4.344">                 // Setting an absolute date can be done directly. Google will take</span>
<a href="#l4.345"></a><span id="l4.345">                 // care of calculating the offset.</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-                gdReminder.@absoluteTime = cal.toRFC3339(alarm.alarmDate);</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+                gdReminder.setAttribute(&quot;absoluteTime&quot;, cal.toRFC3339(alarm.alarmDate));</span>
<a href="#l4.348"></a><span id="l4.348">             } else {</span>
<a href="#l4.349"></a><span id="l4.349">                 let alarmOffset = alarm.offset;</span>
<a href="#l4.350"></a><span id="l4.350">                 if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l4.351"></a><span id="l4.351">                     // Google always uses an alarm offset related to the start time</span>
<a href="#l4.352"></a><span id="l4.352">                     // for relative alarms.</span>
<a href="#l4.353"></a><span id="l4.353">                     alarmOffset = alarmOffset.clone();</span>
<a href="#l4.354"></a><span id="l4.354">                     alarmOffset.addDuration(duration);</span>
<a href="#l4.355"></a><span id="l4.355">                 }</span>
<a href="#l4.356"></a><span id="l4.356"> </span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-                gdReminder.@minutes = -alarmOffset.inSeconds / 60;</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-                gdReminder.@method = actionMap[alarm.action] || &quot;alert&quot;;</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-            }</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-            if (aItem.recurrenceInfo) {</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-                // On recurring items, set the reminder directly in the &lt;entry&gt; tag.</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-                entry.gd::reminder += gdReminder;</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-            } else {</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-                // Otherwise, its a child of the gd:when element</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-                entry.gd::when.gd::reminder += gdReminder;</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+                gdReminder.setAttribute(&quot;minutes&quot;, -alarmOffset.inSeconds / 60);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+                gdReminder.setAttribute(&quot;method&quot;, actionMap[alarm.action] || &quot;alert&quot;);</span>
<a href="#l4.370"></a><span id="l4.370">             }</span>
<a href="#l4.371"></a><span id="l4.371">         }</span>
<a href="#l4.372"></a><span id="l4.372">     } else if (alarms.length) {</span>
<a href="#l4.373"></a><span id="l4.373">         // We need to reset this so the item gets returned correctly.</span>
<a href="#l4.374"></a><span id="l4.374">         aItem.clearAlarms();</span>
<a href="#l4.375"></a><span id="l4.375">     }</span>
<a href="#l4.376"></a><span id="l4.376"> </span>
<a href="#l4.377"></a><span id="l4.377">     // gd:extendedProperty (alarmLastAck)</span>
<a href="#l4.378"></a><span id="l4.378">     addExtendedProperty(&quot;X-MOZ-LASTACK&quot;, cal.toRFC3339(aItem.alarmLastAck));</span>
<a href="#l4.379"></a><span id="l4.379"> </span>
<a href="#l4.380"></a><span id="l4.380">     // XXX While Google now supports multiple alarms and alarm values, we still</span>
<a href="#l4.381"></a><span id="l4.381">     // need to fix bug 353492 first so we can better take care of finding out</span>
<a href="#l4.382"></a><span id="l4.382">     // what alarm is used for snoozing.</span>
<a href="#l4.383"></a><span id="l4.383"> </span>
<a href="#l4.384"></a><span id="l4.384">     // gd:extendedProperty (snooze time)</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-    var itemSnoozeTime = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-    var icalSnoozeTime = null;</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+    let itemSnoozeTime = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+    let icalSnoozeTime = null;</span>
<a href="#l4.389"></a><span id="l4.389">     if (itemSnoozeTime) {</span>
<a href="#l4.390"></a><span id="l4.390">         // The propery is saved as a string, translate back to calIDateTime.</span>
<a href="#l4.391"></a><span id="l4.391">         icalSnoozeTime = cal.createDateTime();</span>
<a href="#l4.392"></a><span id="l4.392">         icalSnoozeTime.icalString = itemSnoozeTime;</span>
<a href="#l4.393"></a><span id="l4.393">     }</span>
<a href="#l4.394"></a><span id="l4.394">     addExtendedProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, cal.toRFC3339(icalSnoozeTime));</span>
<a href="#l4.395"></a><span id="l4.395"> </span>
<a href="#l4.396"></a><span id="l4.396">     // gd:extendedProperty (snooze recurring alarms)</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-    var snoozeValue = &quot;&quot;;</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+    let snoozeValue = &quot;&quot;;</span>
<a href="#l4.399"></a><span id="l4.399">     if (aItem.recurrenceInfo) {</span>
<a href="#l4.400"></a><span id="l4.400">         // This is an evil workaround since we don't have a really good system</span>
<a href="#l4.401"></a><span id="l4.401">         // to save the snooze time for recurring alarms or even retrieve them</span>
<a href="#l4.402"></a><span id="l4.402">         // from the event. This should change when we have multiple alarms</span>
<a href="#l4.403"></a><span id="l4.403">         // support.</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-        var snoozeObj = {};</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-        var enumerator = aItem.propertyEnumerator;</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+        let snoozeObj = {};</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+        let enumerator = aItem.propertyEnumerator;</span>
<a href="#l4.408"></a><span id="l4.408">         while (enumerator.hasMoreElements()) {</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineminus">-            var prop = enumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+            let prop = enumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l4.411"></a><span id="l4.411">             if (prop.name.substr(0, 18) == &quot;X-MOZ-SNOOZE-TIME-&quot;) {</span>
<a href="#l4.412"></a><span id="l4.412">                 // We have a snooze time for a recurring event, add it to our object</span>
<a href="#l4.413"></a><span id="l4.413">                 snoozeObj[prop.name.substr(18)] = prop.value;</span>
<a href="#l4.414"></a><span id="l4.414">             }</span>
<a href="#l4.415"></a><span id="l4.415">         }</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineminus">-        snoozeValue = snoozeObj.toSource();</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+        snoozeValue = JSON.stringify(snoozeObj);</span>
<a href="#l4.418"></a><span id="l4.418">     }</span>
<a href="#l4.419"></a><span id="l4.419">     // Now save the snooze object in source format as an extended property. Do</span>
<a href="#l4.420"></a><span id="l4.420">     // so always, since its currently impossible to unset extended properties.</span>
<a href="#l4.421"></a><span id="l4.421">     addExtendedProperty(&quot;X-GOOGLE-SNOOZE-RECUR&quot;, snoozeValue);</span>
<a href="#l4.422"></a><span id="l4.422"> </span>
<a href="#l4.423"></a><span id="l4.423">     // gd:visibility</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-    var privacy = aItem.privacy || &quot;default&quot;;</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineminus">-    entry.gd::visibility.@value = kEVENT_SCHEMA + privacy.toLowerCase();</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+    let privacy = aItem.privacy || &quot;default&quot;;</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+    addElemNS(gdNS, &quot;visibility&quot;).setAttribute(&quot;value&quot;, kEVENT_SCHEMA + privacy.toLowerCase());</span>
<a href="#l4.428"></a><span id="l4.428"> </span>
<a href="#l4.429"></a><span id="l4.429">     // categories</span>
<a href="#l4.430"></a><span id="l4.430">     // Google does not support categories natively, but allows us to store data</span>
<a href="#l4.431"></a><span id="l4.431">     // as an &quot;extendedProperty&quot;, so we do here</span>
<a href="#l4.432"></a><span id="l4.432">     addExtendedProperty(&quot;X-MOZ-CATEGORIES&quot;,</span>
<a href="#l4.433"></a><span id="l4.433">                         categoriesArrayToString(aItem.getCategories({})));</span>
<a href="#l4.434"></a><span id="l4.434"> </span>
<a href="#l4.435"></a><span id="l4.435">     // gd:recurrence</span>
<a href="#l4.436"></a><span id="l4.436">     if (aItem.recurrenceInfo) {</span>
<a href="#l4.437"></a><span id="l4.437">         try {</span>
<a href="#l4.438"></a><span id="l4.438">             const kNEWLINE = &quot;\r\n&quot;;</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-            var icalString;</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-            var recurrenceItems = aItem.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+            let icalString;</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+            let recurrenceItems = aItem.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l4.443"></a><span id="l4.443"> </span>
<a href="#l4.444"></a><span id="l4.444">             // Dates of the master event</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-            var startTZID = aItem.startDate.timezone.tzid;</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-            var endTZID = aItem.endDate.timezone.tzid;</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+            let startTZID = aItem.startDate.timezone.tzid;</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+            let endTZID = aItem.endDate.timezone.tzid;</span>
<a href="#l4.449"></a><span id="l4.449">             icalString = &quot;DTSTART;TZID=&quot; + startTZID</span>
<a href="#l4.450"></a><span id="l4.450">                          + &quot;:&quot; + aItem.startDate.icalString + kNEWLINE</span>
<a href="#l4.451"></a><span id="l4.451">                          + &quot;DTEND;TZID=&quot; + endTZID</span>
<a href="#l4.452"></a><span id="l4.452">                          + &quot;:&quot;  + aItem.endDate.icalString + kNEWLINE;</span>
<a href="#l4.453"></a><span id="l4.453"> </span>
<a href="#l4.454"></a><span id="l4.454">             // Add all recurrence items to the ical string</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineminus">-            for each (var ritem in recurrenceItems) {</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-                var prop = ritem.icalProperty;</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+            for each (let ritem in recurrenceItems) {</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+                let prop = ritem.icalProperty;</span>
<a href="#l4.459"></a><span id="l4.459">                 if (calInstanceOf(ritem, Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l4.460"></a><span id="l4.460">                     // EXDATES require special casing, since they might contain</span>
<a href="#l4.461"></a><span id="l4.461">                     // a TZID. To avoid the need for conversion of TZID strings,</span>
<a href="#l4.462"></a><span id="l4.462">                     // convert to UTC before serialization.</span>
<a href="#l4.463"></a><span id="l4.463">                     prop.valueAsDatetime = ritem.date.getInTimezone(UTC());</span>
<a href="#l4.464"></a><span id="l4.464">                 }</span>
<a href="#l4.465"></a><span id="l4.465">                 icalString += prop.icalString;</span>
<a href="#l4.466"></a><span id="l4.466">             }</span>
<a href="#l4.467"></a><span id="l4.467"> </span>
<a href="#l4.468"></a><span id="l4.468">             // Put the ical string in a &lt;gd:recurrence&gt; tag</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-            entry.gd::recurrence = icalString + kNEWLINE;</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+            addElemNS(gdNS, &quot;recurrence&quot;).textContent = icalString + kNEWLINE;</span>
<a href="#l4.471"></a><span id="l4.471">         } catch (e) {</span>
<a href="#l4.472"></a><span id="l4.472">             cal.ERROR(&quot;[calGoogleCalendar] Error: &quot; + e);</span>
<a href="#l4.473"></a><span id="l4.473">         }</span>
<a href="#l4.474"></a><span id="l4.474">     }</span>
<a href="#l4.475"></a><span id="l4.475"> </span>
<a href="#l4.476"></a><span id="l4.476">     // gd:originalEvent</span>
<a href="#l4.477"></a><span id="l4.477">     if (aItem.recurrenceId) {</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-        entry.gd::originalEvent.@id = aItem.parentItem.id;</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-        entry.gd::originalEvent.gd::when.@startTime =</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-            cal.toRFC3339(aItem.recurrenceId.getInTimezone(UTC()));</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+        let originalEvent = addElemNS(gdNS, &quot;originalEvent&quot;);</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+        originalEvent.setAttribute(&quot;id&quot;, aItem.parentItem.id);</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+        let origWhen = addElemNS(gdNS, &quot;when&quot;, originalEvent)</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+        origWhen.setAttribute(&quot;startTime&quot;, cal.toRFC3339(aItem.recurrenceId.getInTimezone(cal.UTC())));</span>
<a href="#l4.486"></a><span id="l4.486">     }</span>
<a href="#l4.487"></a><span id="l4.487"> </span>
<a href="#l4.488"></a><span id="l4.488">     // While it may sometimes not work out, we can always try to set the uid and</span>
<a href="#l4.489"></a><span id="l4.489">     // sequence properties</span>
<a href="#l4.490"></a><span id="l4.490">     let sequence = aItem.getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l4.491"></a><span id="l4.491">     if (sequence) {</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineminus">-        entry.gCal::sequence.@value = sequence;</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+        addElemNS(gcalNS, &quot;sequence&quot;).setAttribute(&quot;value&quot;, sequence);</span>
<a href="#l4.494"></a><span id="l4.494">     }</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineminus">-    entry.gCal::uid.@value = aItem.id || &quot;&quot;;</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineminus">-</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-    // TODO gd:comments: Enhancement tracked in bug 362653</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+    addElemNS(gcalNS, &quot;uid&quot;).setAttribute(&quot;value&quot;, aItem.id || &quot;&quot;);</span>
<a href="#l4.499"></a><span id="l4.499"> </span>
<a href="#l4.500"></a><span id="l4.500">     // XXX Google currently has no priority support. See</span>
<a href="#l4.501"></a><span id="l4.501">     // http://code.google.com/p/google-gdata/issues/detail?id=52</span>
<a href="#l4.502"></a><span id="l4.502">     // for details.</span>
<a href="#l4.503"></a><span id="l4.503"> </span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-    return entry;</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+    return document;</span>
<a href="#l4.506"></a><span id="l4.506"> }</span>
<a href="#l4.507"></a><span id="l4.507"> </span>
<a href="#l4.508"></a><span id="l4.508"> /**</span>
<a href="#l4.509"></a><span id="l4.509">  * relevantFieldsMatch</span>
<a href="#l4.510"></a><span id="l4.510">  * Tests if all google supported fields match</span>
<a href="#l4.511"></a><span id="l4.511">  *</span>
<a href="#l4.512"></a><span id="l4.512">  * @param a The reference item</span>
<a href="#l4.513"></a><span id="l4.513">  * @param b The comparing item</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineat">@@ -769,201 +791,192 @@ function relevantFieldsMatch(a, b) {</span>
<a href="#l4.515"></a><span id="l4.515">  * Helper to get the item's edit URI</span>
<a href="#l4.516"></a><span id="l4.516">  *</span>
<a href="#l4.517"></a><span id="l4.517">  * @param aItem         The item to get it from</span>
<a href="#l4.518"></a><span id="l4.518">  * @return              The edit URI</span>
<a href="#l4.519"></a><span id="l4.519">  */</span>
<a href="#l4.520"></a><span id="l4.520"> function getItemEditURI(aItem) {</span>
<a href="#l4.521"></a><span id="l4.521"> </span>
<a href="#l4.522"></a><span id="l4.522">     ASSERT(aItem);</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-    var edituri = aItem.getProperty(&quot;X-GOOGLE-EDITURL&quot;);</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+    let edituri = aItem.getProperty(&quot;X-GOOGLE-EDITURL&quot;);</span>
<a href="#l4.525"></a><span id="l4.525">     if (!edituri) {</span>
<a href="#l4.526"></a><span id="l4.526">         // If the item has no edit uri, it is read-only</span>
<a href="#l4.527"></a><span id="l4.527">         throw new Components.Exception(&quot;The item is readonly&quot;, Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l4.528"></a><span id="l4.528">     }</span>
<a href="#l4.529"></a><span id="l4.529">     return edituri;</span>
<a href="#l4.530"></a><span id="l4.530"> }</span>
<a href="#l4.531"></a><span id="l4.531"> </span>
<a href="#l4.532"></a><span id="l4.532"> function getIdFromEntry(aXMLEntry) {</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-    var gCal = new Namespace(&quot;gCal&quot;, &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-    var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-    var id = aXMLEntry.gCal::uid.@value.toString();</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+    let id = gdataXPathFirst(aXMLEntry, 'gCal:uid/@value');</span>
<a href="#l4.537"></a><span id="l4.537">     return id.replace(/@google.com/,&quot;&quot;);</span>
<a href="#l4.538"></a><span id="l4.538"> }</span>
<a href="#l4.539"></a><span id="l4.539"> </span>
<a href="#l4.540"></a><span id="l4.540"> function getRecurrenceIdFromEntry(aXMLEntry, aTimezone) {</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-    var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-    if (aXMLEntry.gd::originalEvent.toString().length &gt; 0) {</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-        var rId = aXMLEntry.gd::originalEvent.gd::when.@startTime;</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-        return cal.fromRFC3339(rId.toString(), aTimezone);</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-    }</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineminus">-    return null;</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+    let rId = gdataXPathFirst(aXMLEntry, 'gd:originalEvent/gd:when/@startTime');</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+    return (rId ? cal.fromRFC3339(rId.toString(), aTimezone) : null);</span>
<a href="#l4.549"></a><span id="l4.549"> }</span>
<a href="#l4.550"></a><span id="l4.550"> </span>
<a href="#l4.551"></a><span id="l4.551"> /**</span>
<a href="#l4.552"></a><span id="l4.552">  * XMLEntryToItem</span>
<a href="#l4.553"></a><span id="l4.553">  * Converts a string of xml data to a calIEvent.</span>
<a href="#l4.554"></a><span id="l4.554">  *</span>
<a href="#l4.555"></a><span id="l4.555">  * @param aXMLEntry         The xml data of the item</span>
<a href="#l4.556"></a><span id="l4.556">  * @param aTimezone         The timezone the event is most likely in</span>
<a href="#l4.557"></a><span id="l4.557">  * @param aCalendar         The calendar this item will belong to. This needs to</span>
<a href="#l4.558"></a><span id="l4.558">  *                              be a calIGoogleCalendar instance.</span>
<a href="#l4.559"></a><span id="l4.559">  * @param aReferenceItem    The item to apply the information from the xml to.</span>
<a href="#l4.560"></a><span id="l4.560">  *                              If null, a new item will be used.</span>
<a href="#l4.561"></a><span id="l4.561">  * @return                  The calIEvent with the item data.</span>
<a href="#l4.562"></a><span id="l4.562">  */</span>
<a href="#l4.563"></a><span id="l4.563"> function XMLEntryToItem(aXMLEntry, aTimezone, aCalendar, aReferenceItem) {</span>
<a href="#l4.564"></a><span id="l4.564"> </span>
<a href="#l4.565"></a><span id="l4.565" class="difflineminus">-    if (!aXMLEntry || typeof(aXMLEntry) != &quot;xml&quot; || aXMLEntry.length() == 0) {</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineminus">-        throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineminus">-    }</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+    function getExtendedProperty(x) gdataXPathFirst(aXMLEntry, 'gd:extendedProperty[@name=&quot;' + x + '&quot;]/@value');</span>
<a href="#l4.569"></a><span id="l4.569"> </span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-    var gCal = new Namespace(&quot;gCal&quot;, &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineminus">-    var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineminus">-    var atom = new Namespace(&quot;&quot;, &quot;http://www.w3.org/2005/Atom&quot;);</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineminus">-    default xml namespace = atom;</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+    if (!aXMLEntry) {</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+        throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+    } else if (typeof aXMLEntry == &quot;string&quot;) {</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+        aXMLEntry = cal.xml.parseString(aXMLEntry);</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+    }</span>
<a href="#l4.579"></a><span id="l4.579"> </span>
<a href="#l4.580"></a><span id="l4.580">     let item = (aReferenceItem ? aReferenceItem.clone() : cal.createEvent());</span>
<a href="#l4.581"></a><span id="l4.581"> </span>
<a href="#l4.582"></a><span id="l4.582">     try {</span>
<a href="#l4.583"></a><span id="l4.583">         // id</span>
<a href="#l4.584"></a><span id="l4.584">         item.id = getIdFromEntry(aXMLEntry);</span>
<a href="#l4.585"></a><span id="l4.585"> </span>
<a href="#l4.586"></a><span id="l4.586">         // sequence</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-        item.setProperty(&quot;SEQUENCE&quot;,</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-                         aXMLEntry.gCal::sequence.@value.toString() || 0);</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+        item.setProperty(&quot;SEQUENCE&quot;, gdataXPathFirst(aXMLEntry, 'gCal:sequence/@value') || 0);</span>
<a href="#l4.590"></a><span id="l4.590"> </span>
<a href="#l4.591"></a><span id="l4.591">         // link (edit url)</span>
<a href="#l4.592"></a><span id="l4.592">         // Since Google doesn't set the edit url to be https if the request is</span>
<a href="#l4.593"></a><span id="l4.593">         // https, we need to work around this here.</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineminus">-        var editUrl = aXMLEntry.link.(@rel == 'edit').@href.toString();</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+        let editUrl = gdataXPathFirst(aXMLEntry, 'atom:link[@rel=&quot;edit&quot;]/@href');</span>
<a href="#l4.596"></a><span id="l4.596">         if (aCalendar.uri.schemeIs(&quot;https&quot;)) {</span>
<a href="#l4.597"></a><span id="l4.597">             editUrl = editUrl.replace(/^http:/, &quot;https:&quot;);</span>
<a href="#l4.598"></a><span id="l4.598">         }</span>
<a href="#l4.599"></a><span id="l4.599">         item.setProperty(&quot;X-GOOGLE-EDITURL&quot;, editUrl);</span>
<a href="#l4.600"></a><span id="l4.600"> </span>
<a href="#l4.601"></a><span id="l4.601">         // link (alternative representation, html)</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineminus">-        var htmlUrl = aXMLEntry.link.(@rel == 'alternate').@href.toString();</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+        let htmlUrl = gdataXPathFirst(aXMLEntry, 'atom:link[@rel=&quot;alternate&quot;]/@href');</span>
<a href="#l4.604"></a><span id="l4.604">         if (aCalendar.uri.schemeIs(&quot;https&quot;)) {</span>
<a href="#l4.605"></a><span id="l4.605">             htmlUrl = htmlUrl.replace(/^http:/, &quot;https:&quot;);</span>
<a href="#l4.606"></a><span id="l4.606">         }</span>
<a href="#l4.607"></a><span id="l4.607">         item.setProperty(&quot;URL&quot;, htmlUrl);</span>
<a href="#l4.608"></a><span id="l4.608"> </span>
<a href="#l4.609"></a><span id="l4.609">         // title</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-        item.title = aXMLEntry.title.(@type == 'text');</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+        item.title = gdataXPathFirst(aXMLEntry, 'atom:title[@type=&quot;text&quot;]/text()');</span>
<a href="#l4.612"></a><span id="l4.612"> </span>
<a href="#l4.613"></a><span id="l4.613">         // content</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-        item.setProperty(&quot;DESCRIPTION&quot;,</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineminus">-                         aXMLEntry.content.(@type == 'text').toString());</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+        item.setProperty(&quot;DESCRIPTION&quot;, gdataXPathFirst(aXMLEntry, 'atom:content[@type=&quot;text&quot;]/text()'));</span>
<a href="#l4.617"></a><span id="l4.617"> </span>
<a href="#l4.618"></a><span id="l4.618">         // gd:transparency</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-        item.setProperty(&quot;TRANSP&quot;,</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineminus">-                         aXMLEntry.gd::transparency.@value.toString()</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineminus">-                                  .substring(39).toUpperCase());</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+        item.setProperty(&quot;TRANSP&quot;, gdataXPathFirst(aXMLEntry, 'gd:transparency/@value').substring(39).toUpperCase());</span>
<a href="#l4.623"></a><span id="l4.623"> </span>
<a href="#l4.624"></a><span id="l4.624">         // gd:eventStatus</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineminus">-        item.status = aXMLEntry.gd::eventStatus.@value.toString()</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineminus">-                               .substring(39).toUpperCase();</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+        item.status = gdataXPathFirst(aXMLEntry, 'gd:eventStatus/@value').substring(39).toUpperCase();</span>
<a href="#l4.628"></a><span id="l4.628"> </span>
<a href="#l4.629"></a><span id="l4.629">         // gd:reminder (preparation)</span>
<a href="#l4.630"></a><span id="l4.630">         // If a reference item was passed, it may already contain alarms. Since</span>
<a href="#l4.631"></a><span id="l4.631">         // we have no alarm id or such and the alarms are contained in every</span>
<a href="#l4.632"></a><span id="l4.632">         // feed, we can go ahead and clear the alarms here.</span>
<a href="#l4.633"></a><span id="l4.633">         item.clearAlarms();</span>
<a href="#l4.634"></a><span id="l4.634"> </span>
<a href="#l4.635"></a><span id="l4.635">         /**</span>
<a href="#l4.636"></a><span id="l4.636">          * Helper function to parse all reminders in a tagset.</span>
<a href="#l4.637"></a><span id="l4.637">          *</span>
<a href="#l4.638"></a><span id="l4.638">          * @param reminderTags      The tagset to parse.</span>
<a href="#l4.639"></a><span id="l4.639">          */</span>
<a href="#l4.640"></a><span id="l4.640">         function parseReminders(reminderTags) {</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineminus">-            if (aXMLEntry.gd::who.(@rel.substring(33) == &quot;event.organizer&quot;)</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineminus">-                         .@email.toString() != aCalendar.googleCalendarName) {</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+            let organizerEmail = gdataXPathFirst(aXMLEntry, 'gd:who[@rel=&quot;http://schemas.google.com/g/2005#event.organizer&quot;]/@email');</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+            if (organizerEmail != aCalendar.googleCalendarName) {</span>
<a href="#l4.645"></a><span id="l4.645">                 // We are not the organizer, so its not smart to set alarms on</span>
<a href="#l4.646"></a><span id="l4.646">                 // this event.</span>
<a href="#l4.647"></a><span id="l4.647">                 return;</span>
<a href="#l4.648"></a><span id="l4.648">             }</span>
<a href="#l4.649"></a><span id="l4.649">             const actionMap = {</span>
<a href="#l4.650"></a><span id="l4.650">                 email: &quot;EMAIL&quot;,</span>
<a href="#l4.651"></a><span id="l4.651">                 alert: &quot;DISPLAY&quot;,</span>
<a href="#l4.652"></a><span id="l4.652">                 sms: &quot;SMS&quot;</span>
<a href="#l4.653"></a><span id="l4.653">             };</span>
<a href="#l4.654"></a><span id="l4.654">             for each (let reminderTag in reminderTags) {</span>
<a href="#l4.655"></a><span id="l4.655">                 let alarm = cal.createAlarm();</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineminus">-                alarm.action = actionMap[reminderTag.@method] || &quot;DISPLAY&quot;;</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineminus">-                if (reminderTag.@absoluteTime.toString()) {</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineplus">+                alarm.action = actionMap[reminderTag.getAttribute(&quot;method&quot;)] || &quot;DISPLAY&quot;;</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+                let absoluteTime = reminderTag.getAttribute(&quot;absoluteTime&quot;);</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+                if (absoluteTime) {</span>
<a href="#l4.662"></a><span id="l4.662">                     alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-                    let absolute = cal.fromRFC3339(reminderTag.@absoluteTime,</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineminus">-                                                   aTimezone);</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineminus">-                    alarm.alarmDate = absolute;</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+                    alarm.alarmDate = cal.fromRFC3339(absoluteTime, aTimezone);</span>
<a href="#l4.667"></a><span id="l4.667">                 } else {</span>
<a href="#l4.668"></a><span id="l4.668">                     alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l4.669"></a><span id="l4.669">                     let alarmOffset = cal.createDuration();</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineminus">-                    if (reminderTag.@days.toString()) {</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-                        alarmOffset.days = -reminderTag.@days;</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineminus">-                    } else if (reminderTag.@hours.toString()) {</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineminus">-                        alarmOffset.hours = -reminderTag.@hours;</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineminus">-                    } else if (reminderTag.@minutes.toString()) {</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineminus">-                        alarmOffset.minutes = -reminderTag.@minutes;</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineplus">+                    let days = reminderTag.getAttribute(&quot;days&quot;);</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineplus">+                    let hours = reminderTag.getAttribute(&quot;hours&quot;);</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineplus">+                    let minutes = reminderTag.getAttribute(&quot;minutes&quot;);</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineplus">+</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+                    if (days) {</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineplus">+                        alarmOffset.days = -days;</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+                    } else if (hours) {</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineplus">+                        alarmOffset.hours = -hours;</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+                    } else if (minutes) {</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+                        alarmOffset.minutes = -minutes;</span>
<a href="#l4.686"></a><span id="l4.686">                     } else {</span>
<a href="#l4.687"></a><span id="l4.687">                         // Invalid alarm, skip it</span>
<a href="#l4.688"></a><span id="l4.688">                         continue;</span>
<a href="#l4.689"></a><span id="l4.689">                     }</span>
<a href="#l4.690"></a><span id="l4.690">                     alarmOffset.normalize();</span>
<a href="#l4.691"></a><span id="l4.691">                     alarm.offset = alarmOffset;</span>
<a href="#l4.692"></a><span id="l4.692">                 }</span>
<a href="#l4.693"></a><span id="l4.693">                 item.addAlarm(alarm);</span>
<a href="#l4.694"></a><span id="l4.694">             }</span>
<a href="#l4.695"></a><span id="l4.695">         }</span>
<a href="#l4.696"></a><span id="l4.696"> </span>
<a href="#l4.697"></a><span id="l4.697">         // gd:when</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineminus">-        var recurrenceInfo = aXMLEntry.gd::recurrence.toString();</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-        if (recurrenceInfo.length == 0) {</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineplus">+        let recurrenceInfo = gdataXPathFirst(aXMLEntry, 'gd:recurrence/text()');</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineplus">+        if (!recurrenceInfo || recurrenceInfo.length == 0) {</span>
<a href="#l4.702"></a><span id="l4.702">             // If no recurrence information is given, then there will only be</span>
<a href="#l4.703"></a><span id="l4.703">             // one gd:when tag. Otherwise, we will be parsing the startDate from</span>
<a href="#l4.704"></a><span id="l4.704">             // the recurrence information.</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineminus">-            var when = aXMLEntry.gd::when;</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineminus">-            item.startDate = cal.fromRFC3339(when.@startTime, aTimezone);</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineminus">-            item.endDate = cal.fromRFC3339(when.@endTime, aTimezone);</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineplus">+            item.startDate = cal.fromRFC3339(gdataXPathFirst(aXMLEntry, 'gd:when/@startTime'), aTimezone);</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+            item.endDate = cal.fromRFC3339(gdataXPathFirst(aXMLEntry, 'gd:when/@endTime'), aTimezone);</span>
<a href="#l4.710"></a><span id="l4.710"> </span>
<a href="#l4.711"></a><span id="l4.711">             if (!item.endDate) {</span>
<a href="#l4.712"></a><span id="l4.712">                 // We have a zero-duration event</span>
<a href="#l4.713"></a><span id="l4.713">                 item.endDate = item.startDate.clone();</span>
<a href="#l4.714"></a><span id="l4.714">             }</span>
<a href="#l4.715"></a><span id="l4.715"> </span>
<a href="#l4.716"></a><span id="l4.716">             // gd:reminder</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineminus">-            parseReminders(aXMLEntry.gd::when.gd::reminder);</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineplus">+            parseReminders(gdataXPath(aXMLEntry, 'gd:when/gd:reminder'));</span>
<a href="#l4.719"></a><span id="l4.719">         } else {</span>
<a href="#l4.720"></a><span id="l4.720">             if (!item.recurrenceInfo) {</span>
<a href="#l4.721"></a><span id="l4.721">                 item.recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l4.722"></a><span id="l4.722">             } else {</span>
<a href="#l4.723"></a><span id="l4.723">                 item.recurrenceInfo.clearRecurrenceItems();</span>
<a href="#l4.724"></a><span id="l4.724">             }</span>
<a href="#l4.725"></a><span id="l4.725"> </span>
<a href="#l4.726"></a><span id="l4.726">             // We don't really care about google's timezone info for</span>
<a href="#l4.727"></a><span id="l4.727">             // now. This may change when bug 314339 is fixed. Split out</span>
<a href="#l4.728"></a><span id="l4.728">             // the timezone information so we only have the first bit</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineminus">-            var vevent = recurrenceInfo;</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineminus">-            var splitpos = recurrenceInfo.indexOf(&quot;BEGIN:VTIMEZONE&quot;);</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+            let vevent = recurrenceInfo;</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+            let splitpos = recurrenceInfo.indexOf(&quot;BEGIN:VTIMEZONE&quot;);</span>
<a href="#l4.733"></a><span id="l4.733">             if (splitpos &gt; -1) {</span>
<a href="#l4.734"></a><span id="l4.734">                 // Sometimes (i.e if only DATE values are specified), no</span>
<a href="#l4.735"></a><span id="l4.735">                 // timezone info is contained. Only remove it if it shows up.</span>
<a href="#l4.736"></a><span id="l4.736">                 vevent = recurrenceInfo.substring(0, splitpos);</span>
<a href="#l4.737"></a><span id="l4.737">             }</span>
<a href="#l4.738"></a><span id="l4.738"> </span>
<a href="#l4.739"></a><span id="l4.739">             vevent = &quot;BEGIN:VEVENT\n&quot; + vevent + &quot;END:VEVENT&quot;;</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineminus">-            var icsService = getIcsService();</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineplus">+            let icsService = cal.getIcsService();</span>
<a href="#l4.742"></a><span id="l4.742"> </span>
<a href="#l4.743"></a><span id="l4.743" class="difflineminus">-            var rootComp = icsService.parseICS(vevent, gdataTimezoneService);</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineminus">-            var i = 0;</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineminus">-            var hasRecurringRules = false;</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineplus">+            let rootComp = icsService.parseICS(vevent, gdataTimezoneService);</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineplus">+            let i = 0;</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineplus">+            let hasRecurringRules = false;</span>
<a href="#l4.749"></a><span id="l4.749">             for (let prop in cal.ical.propertyIterator(rootComp)) {</span>
<a href="#l4.750"></a><span id="l4.750">                switch (prop.propertyName) {</span>
<a href="#l4.751"></a><span id="l4.751">                     case &quot;EXDATE&quot;:</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineminus">-                        var recItem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineplus">+                        let recItem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l4.754"></a><span id="l4.754">                                       .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l4.755"></a><span id="l4.755">                         try {</span>
<a href="#l4.756"></a><span id="l4.756">                             recItem.icalProperty = prop;</span>
<a href="#l4.757"></a><span id="l4.757">                             item.recurrenceInfo.appendRecurrenceItem(recItem);</span>
<a href="#l4.758"></a><span id="l4.758">                             hasRecurringRules = true;</span>
<a href="#l4.759"></a><span id="l4.759">                         } catch (e) {</span>
<a href="#l4.760"></a><span id="l4.760">                             Components.utils.reportError(e);</span>
<a href="#l4.761"></a><span id="l4.761">                         }</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineat">@@ -992,72 +1005,66 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l4.763"></a><span id="l4.763">                 // but contain no recurrence rules. Treat the event as a normal</span>
<a href="#l4.764"></a><span id="l4.764">                 // event. See gdata issue 353.</span>
<a href="#l4.765"></a><span id="l4.765">                 item.recurrenceInfo = null;</span>
<a href="#l4.766"></a><span id="l4.766">             }</span>
<a href="#l4.767"></a><span id="l4.767"> </span>
<a href="#l4.768"></a><span id="l4.768">             // gd:reminder (for recurring events)</span>
<a href="#l4.769"></a><span id="l4.769">             // This element is supplied as a direct child to the &lt;entry&gt; element</span>
<a href="#l4.770"></a><span id="l4.770">             // for recurring items.</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineminus">-            parseReminders(aXMLEntry.gd::reminder);</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineplus">+            parseReminders(gdataXPath(aXMLEntry, 'gd:reminder'));</span>
<a href="#l4.773"></a><span id="l4.773">         }</span>
<a href="#l4.774"></a><span id="l4.774"> </span>
<a href="#l4.775"></a><span id="l4.775">         // gd:recurrenceException</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineminus">-        for each (var exception in aXMLEntry.gd::recurrenceException.(@specialized == &quot;true&quot;).gd::entryLink.entry) {</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineplus">+        let exceptions = gdataXPath(aXMLEntry, 'gd:recurrenceException[@specialized=&quot;true&quot;]/gd:entryLink/atom:entry');</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineplus">+        for each (let exception in exceptions) {</span>
<a href="#l4.779"></a><span id="l4.779">             // We only want specialized exceptions, mainly becuase I haven't</span>
<a href="#l4.780"></a><span id="l4.780">             // quite found out if a non-specialized exception also corresponds</span>
<a href="#l4.781"></a><span id="l4.781">             // to a normal exception as libical knows it.</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-            var excItem = XMLEntryToItem(exception, aTimezone, aCalendar);</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineplus">+            let excItem = XMLEntryToItem(exception, aTimezone, aCalendar);</span>
<a href="#l4.784"></a><span id="l4.784"> </span>
<a href="#l4.785"></a><span id="l4.785">             // Google uses the status field to reflect negative exceptions.</span>
<a href="#l4.786"></a><span id="l4.786">             if (excItem.status == &quot;CANCELED&quot;) {</span>
<a href="#l4.787"></a><span id="l4.787">                 item.recurrenceInfo.removeOccurrenceAt(excItem.recurrenceId);</span>
<a href="#l4.788"></a><span id="l4.788">             } else {</span>
<a href="#l4.789"></a><span id="l4.789">                 excItem.calendar = aCalendar.superCalendar;</span>
<a href="#l4.790"></a><span id="l4.790">                 item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l4.791"></a><span id="l4.791">             }</span>
<a href="#l4.792"></a><span id="l4.792">         }</span>
<a href="#l4.793"></a><span id="l4.793"> </span>
<a href="#l4.794"></a><span id="l4.794">         // gd:extendedProperty (alarmLastAck)</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineminus">-        var alarmLastAck = aXMLEntry.gd::extendedProperty</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineminus">-                           .(@name == &quot;X-MOZ-LASTACK&quot;)</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineminus">-                           .@value.toString();</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineminus">-        item.alarmLastAck = cal.fromRFC3339(alarmLastAck, aTimezone);</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineplus">+        item.alarmLastAck = cal.fromRFC3339(getExtendedProperty(&quot;X-MOZ-LASTACK&quot;), aTimezone);</span>
<a href="#l4.800"></a><span id="l4.800"> </span>
<a href="#l4.801"></a><span id="l4.801">         // gd:extendedProperty (snooze time)</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineminus">-        var xmlSnoozeTime = aXMLEntry.gd::extendedProperty</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineminus">-                         .(@name == &quot;X-MOZ-SNOOZE-TIME&quot;).@value.toString();</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineminus">-        var dtSnoozeTime = cal.fromRFC3339(xmlSnoozeTime, aTimezone);</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineminus">-        var snoozeProperty = (dtSnoozeTime ? dtSnoozeTime.icalString : null);</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineplus">+        let dtSnoozeTime = cal.fromRFC3339(getExtendedProperty(&quot;X-MOZ-SNOOZE-TIME&quot;), aTimezone);</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineplus">+        let snoozeProperty = (dtSnoozeTime ? dtSnoozeTime.icalString : null);</span>
<a href="#l4.808"></a><span id="l4.808">         item.setProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, snoozeProperty);</span>
<a href="#l4.809"></a><span id="l4.809"> </span>
<a href="#l4.810"></a><span id="l4.810">         // gd:extendedProperty (snooze recurring alarms)</span>
<a href="#l4.811"></a><span id="l4.811">         if (item.recurrenceInfo) {</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineminus">-            if (!gGoogleSandbox) {</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineminus">-                // Initialize sandbox if it does not already exist</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineminus">-                gGoogleSandbox = Components.utils.Sandbox(&quot;about:blank&quot;);</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineplus">+            // Transform back the string into our snooze properties</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineplus">+            let snoozeObj;</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineplus">+            try {</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineplus">+                let snoozeString = getExtendedProperty(&quot;X-GOOGLE-SNOOZE-RECUR&quot;);</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineplus">+                snoozeObj = JSON.parse(snoozeString);</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineplus">+            } catch (e) {</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineplus">+                // Just swallow parsing errors, not so important.</span>
<a href="#l4.822"></a><span id="l4.822">             }</span>
<a href="#l4.823"></a><span id="l4.823"> </span>
<a href="#l4.824"></a><span id="l4.824" class="difflineminus">-            // Transform back the string into our snooze properties</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineminus">-            var snoozeString = aXMLEntry.gd::extendedProperty</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineminus">-                                        .(@name == &quot;X-GOOGLE-SNOOZE-RECUR&quot;)</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineminus">-                                        .@value.toString();</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineminus">-            var snoozeObj = Components.utils.evalInSandbox(snoozeString,</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineminus">-                                                           gGoogleSandbox);</span>
<a href="#l4.830"></a><span id="l4.830">             if (snoozeObj) {</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineminus">-                for (var rid in snoozeObj) {</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineplus">+                for (let rid in snoozeObj) {</span>
<a href="#l4.833"></a><span id="l4.833">                     item.setProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + rid,</span>
<a href="#l4.834"></a><span id="l4.834">                                      snoozeObj[rid]);</span>
<a href="#l4.835"></a><span id="l4.835">                 }</span>
<a href="#l4.836"></a><span id="l4.836">             }</span>
<a href="#l4.837"></a><span id="l4.837">         }</span>
<a href="#l4.838"></a><span id="l4.838"> </span>
<a href="#l4.839"></a><span id="l4.839">         // gd:where</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineminus">-        item.setProperty(&quot;LOCATION&quot;,</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineminus">-                         aXMLEntry.gd::where.@valueString.toString());</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineplus">+        item.setProperty(&quot;LOCATION&quot;, gdataXPathFirst(aXMLEntry, 'gd:where/@valueString'));</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+</span>
<a href="#l4.844"></a><span id="l4.844">         // gd:who</span>
<a href="#l4.845"></a><span id="l4.845">         if (cal.getPrefSafe(&quot;calendar.google.enableAttendees&quot;, false)) {</span>
<a href="#l4.846"></a><span id="l4.846">             // XXX Only parse attendees if they are enabled, due to bug 407961</span>
<a href="#l4.847"></a><span id="l4.847"> </span>
<a href="#l4.848"></a><span id="l4.848">             // This object can easily translate Google's values to our values.</span>
<a href="#l4.849"></a><span id="l4.849">             const attendeeStatusMap = {</span>
<a href="#l4.850"></a><span id="l4.850">                 // role</span>
<a href="#l4.851"></a><span id="l4.851">                 &quot;event.optional&quot;: &quot;OPT-PARTICIPANT&quot;,</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineat">@@ -1069,25 +1076,24 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l4.853"></a><span id="l4.853">                 &quot;event.invited&quot;: &quot;NEEDS-ACTION&quot;,</span>
<a href="#l4.854"></a><span id="l4.854">                 &quot;event.tentative&quot;: &quot;TENTATIVE&quot;</span>
<a href="#l4.855"></a><span id="l4.855">             };</span>
<a href="#l4.856"></a><span id="l4.856"> </span>
<a href="#l4.857"></a><span id="l4.857">             // Clear all attendees in case a reference item was passed</span>
<a href="#l4.858"></a><span id="l4.858">             item.removeAllAttendees();</span>
<a href="#l4.859"></a><span id="l4.859"> </span>
<a href="#l4.860"></a><span id="l4.860">             // Iterate all attendee tags.</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineminus">-            for each (var who in aXMLEntry.gd::who) {</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineplus">+            for each (let who in gdataXPath(aXMLEntry, 'gd:who')) {</span>
<a href="#l4.863"></a><span id="l4.863">                 let attendee = cal.createAttendee();</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineplus">+                let rel = who.getAttribute(&quot;rel&quot;).substring(33);</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineplus">+                let type = gdataXPathFirst(who, 'gd:attendeeType/@value').substring(33);</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineplus">+                let status = gdataXPathFirst(who, 'gd:attendeeStatus/@value').substring(33);</span>
<a href="#l4.867"></a><span id="l4.867"> </span>
<a href="#l4.868"></a><span id="l4.868" class="difflineminus">-                var rel = who.@rel.toString().substring(33);</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineminus">-                var type = who.gd::attendeeType.@value.toString().substring(33);</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineminus">-                var status = who.gd::attendeeStatus.@value.toString().substring(33);</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineminus">-</span>
<a href="#l4.872"></a><span id="l4.872" class="difflineminus">-                attendee.id = &quot;mailto:&quot; + who.@email.toString();</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineminus">-                attendee.commonName = who.@valueString.toString();</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineplus">+                attendee.id = &quot;mailto:&quot; + who.getAttribute(&quot;email&quot;)</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineplus">+                attendee.commonName = who.getAttribute(&quot;valueString&quot;);</span>
<a href="#l4.876"></a><span id="l4.876">                 attendee.rsvp = &quot;FALSE&quot;;</span>
<a href="#l4.877"></a><span id="l4.877">                 attendee.userType = &quot;INDIVIDUAL&quot;;</span>
<a href="#l4.878"></a><span id="l4.878">                 attendee.isOrganizer = (rel == &quot;event.organizer&quot;);</span>
<a href="#l4.879"></a><span id="l4.879">                 attendee.participationStatus = attendeeStatusMap[status];</span>
<a href="#l4.880"></a><span id="l4.880">                 attendee.role = attendeeStatusMap[type]</span>
<a href="#l4.881"></a><span id="l4.881">                 attendee.makeImmutable();</span>
<a href="#l4.882"></a><span id="l4.882"> </span>
<a href="#l4.883"></a><span id="l4.883">                 if (attendee.isOrganizer) {</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineat">@@ -1097,44 +1103,38 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l4.885"></a><span id="l4.885">                 }</span>
<a href="#l4.886"></a><span id="l4.886">             }</span>
<a href="#l4.887"></a><span id="l4.887">         }</span>
<a href="#l4.888"></a><span id="l4.888"> </span>
<a href="#l4.889"></a><span id="l4.889">         // gd:originalEvent</span>
<a href="#l4.890"></a><span id="l4.890">         item.recurrenceId = getRecurrenceIdFromEntry(aXMLEntry, aTimezone);</span>
<a href="#l4.891"></a><span id="l4.891"> </span>
<a href="#l4.892"></a><span id="l4.892">         // gd:visibility</span>
<a href="#l4.893"></a><span id="l4.893" class="difflineminus">-        item.privacy = aXMLEntry.gd::visibility.@value.toString()</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineminus">-                                .substring(39).toUpperCase();</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineplus">+        item.privacy = gdataXPathFirst(aXMLEntry, &quot;gd:visibility/@value&quot;).substring(39).toUpperCase();</span>
<a href="#l4.896"></a><span id="l4.896"> </span>
<a href="#l4.897"></a><span id="l4.897">         // category</span>
<a href="#l4.898"></a><span id="l4.898">         // Google does not support categories natively, but allows us to store</span>
<a href="#l4.899"></a><span id="l4.899">         // data as an &quot;extendedProperty&quot;, and here it's going to be retrieved</span>
<a href="#l4.900"></a><span id="l4.900">         // again</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineminus">-        var gdCategories = aXMLEntry.gd::extendedProperty</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineminus">-                                    .(@name == &quot;X-MOZ-CATEGORIES&quot;)</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineminus">-                                    .@value.toString();</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineminus">-        var categories = categoriesStringToArray(gdCategories);</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineplus">+        let categories = cal.categoriesStringToArray(getExtendedProperty(&quot;X-MOZ-CATEGORIES&quot;));</span>
<a href="#l4.906"></a><span id="l4.906">         item.setCategories(categories.length, categories);</span>
<a href="#l4.907"></a><span id="l4.907"> </span>
<a href="#l4.908"></a><span id="l4.908">         // published</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineminus">-        item.setProperty(&quot;CREATED&quot;, cal.fromRFC3339(aXMLEntry.published,</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineminus">-                                                    aTimezone));</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineplus">+        let createdText = gdataXPathFirst(aXMLEntry, 'atom:published/text()');</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineplus">+        item.setProperty(&quot;CREATED&quot;, cal.fromRFC3339(createdText, aTimezone));</span>
<a href="#l4.913"></a><span id="l4.913"> </span>
<a href="#l4.914"></a><span id="l4.914">         // updated (This must be set last!)</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineminus">-        item.setProperty(&quot;LAST-MODIFIED&quot;, cal.fromRFC3339(aXMLEntry.updated,</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineminus">-                                                          aTimezone));</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineminus">-</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineminus">-        // TODO gd:comments: Enhancement tracked in bug 362653</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineplus">+        let lastmodText = gdataXPathFirst(aXMLEntry, 'atom:updated/text()');</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineplus">+        item.setProperty(&quot;LAST-MODIFIED&quot;, cal.fromRFC3339(lastmodText, aTimezone));</span>
<a href="#l4.921"></a><span id="l4.921"> </span>
<a href="#l4.922"></a><span id="l4.922">         // XXX Google currently has no priority support. See</span>
<a href="#l4.923"></a><span id="l4.923">         // http://code.google.com/p/google-gdata/issues/detail?id=52</span>
<a href="#l4.924"></a><span id="l4.924">         // for details.</span>
<a href="#l4.925"></a><span id="l4.925">     } catch (e) {</span>
<a href="#l4.926"></a><span id="l4.926" class="difflineminus">-        ERROR(&quot;Error parsing XML stream&quot; + e);</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineplus">+        cal.ERROR(&quot;Error parsing XML stream&quot; + e);</span>
<a href="#l4.928"></a><span id="l4.928">         throw e;</span>
<a href="#l4.929"></a><span id="l4.929">     }</span>
<a href="#l4.930"></a><span id="l4.930">     return item;</span>
<a href="#l4.931"></a><span id="l4.931"> }</span>
<a href="#l4.932"></a><span id="l4.932"> </span>
<a href="#l4.933"></a><span id="l4.933"> /**</span>
<a href="#l4.934"></a><span id="l4.934">  * Expand an item to occurrences, if the operation's item filter requests it.</span>
<a href="#l4.935"></a><span id="l4.935">  * Otherwise returns the item in an array.</span>
<a href="#l4.936"></a><span id="l4.936" class="difflineat">@@ -1240,43 +1240,42 @@ function setTimeout(aFunc, aTimeout, aTh</span>
<a href="#l4.937"></a><span id="l4.937">  * LOGitem</span>
<a href="#l4.938"></a><span id="l4.938">  * Custom logging functions</span>
<a href="#l4.939"></a><span id="l4.939">  */</span>
<a href="#l4.940"></a><span id="l4.940"> function LOGitem(item) {</span>
<a href="#l4.941"></a><span id="l4.941">     if (!item) {</span>
<a href="#l4.942"></a><span id="l4.942">         return;</span>
<a href="#l4.943"></a><span id="l4.943">     }</span>
<a href="#l4.944"></a><span id="l4.944"> </span>
<a href="#l4.945"></a><span id="l4.945" class="difflineminus">-    var attendees = item.getAttendees({});</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineminus">-    var attendeeString = &quot;&quot;;</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineminus">-    for each (var a in attendees) {</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+    let attendees = item.getAttendees({});</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+    let attendeeString = &quot;&quot;;</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineplus">+    for each (let a in attendees) {</span>
<a href="#l4.951"></a><span id="l4.951">         attendeeString += &quot;\n&quot; + LOGattendee(a);</span>
<a href="#l4.952"></a><span id="l4.952">     }</span>
<a href="#l4.953"></a><span id="l4.953"> </span>
<a href="#l4.954"></a><span id="l4.954" class="difflineminus">-    var rstr = &quot;\n&quot;;</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineplus">+    let rstr = &quot;\n&quot;;</span>
<a href="#l4.956"></a><span id="l4.956">     if (item.recurrenceInfo) {</span>
<a href="#l4.957"></a><span id="l4.957" class="difflineminus">-        var ritems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineminus">-        for each (var ritem in ritems) {</span>
<a href="#l4.959"></a><span id="l4.959" class="difflineplus">+        let ritems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l4.960"></a><span id="l4.960" class="difflineplus">+        for each (let ritem in ritems) {</span>
<a href="#l4.961"></a><span id="l4.961">             rstr += &quot;\t\t&quot; + ritem.icalProperty.icalString;</span>
<a href="#l4.962"></a><span id="l4.962">         }</span>
<a href="#l4.963"></a><span id="l4.963"> </span>
<a href="#l4.964"></a><span id="l4.964">         rstr += &quot;\tExceptions:\n&quot;;</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineminus">-        var exids = item.recurrenceInfo.getExceptionIds({});</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineminus">-        for each (var exc in exids) {</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineplus">+        let exids = item.recurrenceInfo.getExceptionIds({});</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineplus">+        for each (let exc in exids) {</span>
<a href="#l4.969"></a><span id="l4.969">             rstr += &quot;\t\t&quot; + exc + &quot;\n&quot;;</span>
<a href="#l4.970"></a><span id="l4.970">         }</span>
<a href="#l4.971"></a><span id="l4.971">     }</span>
<a href="#l4.972"></a><span id="l4.972"> </span>
<a href="#l4.973"></a><span id="l4.973">     let astr = &quot;\n&quot;;</span>
<a href="#l4.974"></a><span id="l4.974">     let alarms = item.getAlarms({});</span>
<a href="#l4.975"></a><span id="l4.975">     for each (let alarm in alarms) {</span>
<a href="#l4.976"></a><span id="l4.976">         astr += &quot;\t\t&quot; + LOGalarm(alarm) + &quot;\n&quot;;</span>
<a href="#l4.977"></a><span id="l4.977">     }</span>
<a href="#l4.978"></a><span id="l4.978"> </span>
<a href="#l4.979"></a><span id="l4.979" class="difflineminus">-</span>
<a href="#l4.980"></a><span id="l4.980">     cal.LOG(&quot;[calGoogleCalendar] Logging calIEvent:&quot; +</span>
<a href="#l4.981"></a><span id="l4.981">         &quot;\n\tid:&quot; + item.id +</span>
<a href="#l4.982"></a><span id="l4.982">         &quot;\n\tediturl:&quot; + item.getProperty(&quot;X-GOOGLE-EDITURL&quot;) +</span>
<a href="#l4.983"></a><span id="l4.983">         &quot;\n\tcreated:&quot; + item.getProperty(&quot;CREATED&quot;) +</span>
<a href="#l4.984"></a><span id="l4.984">         &quot;\n\tupdated:&quot; + item.getProperty(&quot;LAST-MODIFIED&quot;) +</span>
<a href="#l4.985"></a><span id="l4.985">         &quot;\n\ttitle:&quot; + item.title +</span>
<a href="#l4.986"></a><span id="l4.986">         &quot;\n\tcontent:&quot; + item.getProperty(&quot;DESCRIPTION&quot;) +</span>
<a href="#l4.987"></a><span id="l4.987">         &quot;\n\ttransparency:&quot; + item.getProperty(&quot;TRANSP&quot;) +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -35,24 +35,24 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> /**</span>
<a href="#l5.9"></a><span id="l5.9">  * Migrate the calendar selected in the wizard from ics to gdata.</span>
<a href="#l5.10"></a><span id="l5.10">  */</span>
<a href="#l5.11"></a><span id="l5.11"> function migrateSelectedCalendars() {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    var listbox = document.getElementById(&quot;calendars-listbox&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    var calmgr = cal.getCalendarManager();</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    let listbox = document.getElementById(&quot;calendars-listbox&quot;);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    let calmgr = cal.getCalendarManager();</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-    for (var i = 0; i &lt; listbox.childNodes.length; i++) {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-        var item = listbox.childNodes[i];</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+    for (let i = 0; i &lt; listbox.childNodes.length; i++) {</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+        let item = listbox.childNodes[i];</span>
<a href="#l5.21"></a><span id="l5.21">         if (item.checked) {</span>
<a href="#l5.22"></a><span id="l5.22">             // Migrate the calendar to a gdata calendar</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-            var newCal = calmgr.createCalendar(&quot;gdata&quot;, item.calendar.uri);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+            let newCal = calmgr.createCalendar(&quot;gdata&quot;, item.calendar.uri);</span>
<a href="#l5.25"></a><span id="l5.25">             calmgr.unregisterCalendar(item.calendar);</span>
<a href="#l5.26"></a><span id="l5.26">             calmgr.deleteCalendar(item.calendar);</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">             // Copy some properties to the new calendar</span>
<a href="#l5.29"></a><span id="l5.29">             newCal.name = item.calendar.name;</span>
<a href="#l5.30"></a><span id="l5.30">             newCal.setProperty(&quot;color&quot;,</span>
<a href="#l5.31"></a><span id="l5.31">                                item.calendar.getProperty(&quot;color&quot;));</span>
<a href="#l5.32"></a><span id="l5.32">             newCal.setProperty(&quot;disabled&quot;,</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineat">@@ -77,17 +77,17 @@ function migrateSelectedCalendars() {</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35"> /**</span>
<a href="#l5.36"></a><span id="l5.36">  * Get all calendars that are ics and point to a google calendar</span>
<a href="#l5.37"></a><span id="l5.37">  *</span>
<a href="#l5.38"></a><span id="l5.38">  * @return An array of calendars that are migratable</span>
<a href="#l5.39"></a><span id="l5.39">  */</span>
<a href="#l5.40"></a><span id="l5.40"> function getMigratableCalendars() {</span>
<a href="#l5.41"></a><span id="l5.41">     function isMigratable(c) {</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-        var re = new RegExp(&quot;^http[s]?://www\\.google\\.com/calendar/ical/&quot; +</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+        let re = new RegExp(&quot;^http[s]?://www\\.google\\.com/calendar/ical/&quot; +</span>
<a href="#l5.44"></a><span id="l5.44">                             &quot;[^/]+/(private(-[^/]+)?|public)/&quot; +</span>
<a href="#l5.45"></a><span id="l5.45">                             &quot;(full|full-noattendees|composite|&quot; +</span>
<a href="#l5.46"></a><span id="l5.46">                             &quot;attendees-only|free-busy|basic)(\\.ics)?$&quot;);</span>
<a href="#l5.47"></a><span id="l5.47">         return c.type == &quot;ics&quot; &amp;&amp; c.uri.spec.match(re);</span>
<a href="#l5.48"></a><span id="l5.48">     }</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">     return getCalendarManager().getCalendars({}).filter(isMigratable);</span>
<a href="#l5.51"></a><span id="l5.51"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

