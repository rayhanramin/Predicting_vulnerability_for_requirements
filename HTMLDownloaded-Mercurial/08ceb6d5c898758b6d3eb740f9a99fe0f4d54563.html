<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23704:08ceb6d5c898758b6d3eb740f9a99fe0f4d54563</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 08ceb6d5c898758b6d3eb740f9a99fe0f4d54563" />
<meta property="og:url" content="/comm-central/rev/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563" />
<meta property="og:description" content="Bug 796994 - Replace obsolete filepicker.show with filepicker.open in suite. r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 08ceb6d5c898758b6d3eb740f9a99fe0f4d54563 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563">shortlog</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563">files</a> |
changeset |
<a href="/comm-central/raw-rev/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563">raw</a>  | <a href="/comm-central/archive/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=796994">Bug 796994</a> - Replace obsolete filepicker.show with filepicker.open in suite. r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#97;&#110;&#107;&#45;&#82;&#97;&#105;&#110;&#101;&#114;&#32;&#71;&#114;&#97;&#104;&#108;&#32;&#60;&#102;&#114;&#103;&#114;&#97;&#104;&#108;&#64;&#103;&#109;&#120;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 03 Feb 2018 13:19:37 +0100</td></tr>

<tr>
 <td>changeset 23704</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563">08ceb6d5c898758b6d3eb740f9a99fe0f4d54563</a></td>
</tr>



<tr>
<td>parent 23703</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0e10269b8a3abf2fa12d2f5251b308bca97af74f">0e10269b8a3abf2fa12d2f5251b308bca97af74f</a>
</td>
</tr>

<tr>
<td>child 23705</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/25d54026f87c9b351dbec342cbc339db9406c62e">25d54026f87c9b351dbec342cbc339db9406c62e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563">14304</a></td></tr>
<tr><td>push user</td><td>frgrahl@gmx.net</td></tr>
<tr><td>push date</td><td class="date age">Thu, 12 Apr 2018 17:10:18 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@08ceb6d5c898 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563&newProject=comm-central&newRevision=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563&newProject=comm-central&newRevision=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563&newProject=comm-central&newRevision=08ceb6d5c898758b6d3eb740f9a99fe0f4d54563&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=796994">796994</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=796994">Bug 796994</a> - Replace obsolete filepicker.show with filepicker.open in suite. r=IanN</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/navigator.js">suite/browser/navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/navigator.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/navigator.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/navigator.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/navigator.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/navigator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/pageinfo/pageInfo.js">suite/browser/pageinfo/pageInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/pageinfo/pageInfo.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/pageinfo/pageInfo.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/pageinfo/pageInfo.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/pageinfo/pageInfo.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/browser/pageinfo/pageInfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/bookmarks/bookmarksManager.js">suite/common/bookmarks/bookmarksManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/bookmarks/bookmarksManager.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/bookmarks/bookmarksManager.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/bookmarks/bookmarksManager.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/bookmarks/bookmarksManager.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/bookmarks/bookmarksManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/openLocation.js">suite/common/openLocation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/openLocation.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/openLocation.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/openLocation.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/openLocation.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/openLocation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-applications.js">suite/common/pref/pref-applications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-applications.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-applications.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-applications.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-applications.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-applications.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-cache.js">suite/common/pref/pref-cache.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-cache.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-cache.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-cache.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-cache.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-cache.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-download.js">suite/common/pref/pref-download.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-download.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-download.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-download.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-download.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-download.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-navigator.js">suite/common/pref/pref-navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-navigator.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-navigator.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-navigator.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-navigator.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/pref-navigator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/preferences.js">suite/common/pref/preferences.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/preferences.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/preferences.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/preferences.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/preferences.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/pref/preferences.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/sync/syncUtils.js">suite/common/sync/syncUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/sync/syncUtils.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/sync/syncUtils.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/sync/syncUtils.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/sync/syncUtils.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/common/sync/syncUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/components/feeds/FeedWriter.js">suite/components/feeds/FeedWriter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/components/feeds/FeedWriter.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/components/feeds/FeedWriter.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/components/feeds/FeedWriter.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/components/feeds/FeedWriter.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/components/feeds/FeedWriter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/addrbook/abCardOverlay.js">suite/mailnews/addrbook/abCardOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/addrbook/abCardOverlay.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/addrbook/abCardOverlay.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/addrbook/abCardOverlay.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/addrbook/abCardOverlay.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/addrbook/abCardOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/compose/MsgComposeCommands.js">suite/mailnews/compose/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/compose/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/compose/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/compose/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/compose/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/compose/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/mailWindowOverlay.js">suite/mailnews/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/08ceb6d5c898758b6d3eb740f9a99fe0f4d54563/suite/mailnews/mailWindowOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.5"></a><span id="l1.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> ChromeUtils.import(&quot;resource://gre/modules/DownloadTaskbarProgress.jsm&quot;);</span>
<a href="#l1.12"></a><span id="l1.12"> ChromeUtils.import(&quot;resource:///modules/WindowsPreviewPerTab.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> this.__defineGetter__(&quot;PluralForm&quot;, function() {</span>
<a href="#l1.15"></a><span id="l1.15">   ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l1.16"></a><span id="l1.16">   return this.PluralForm;</span>
<a href="#l1.17"></a><span id="l1.17"> });</span>
<a href="#l1.18"></a><span id="l1.18"> this.__defineSetter__(&quot;PluralForm&quot;, function (val) {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineat">@@ -16,16 +17,17 @@ this.__defineSetter__(&quot;PluralForm&quot;, func</span>
<a href="#l1.20"></a><span id="l1.20">   return this.PluralForm = val;</span>
<a href="#l1.21"></a><span id="l1.21"> });</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> ChromeUtils.defineModuleGetter(this, &quot;SafeBrowsing&quot;,</span>
<a href="#l1.24"></a><span id="l1.24">   &quot;resource://gre/modules/SafeBrowsing.jsm&quot;);</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> const REMOTESERVICE_CONTRACTID = &quot;@mozilla.org/toolkit/remote-service;1&quot;;</span>
<a href="#l1.27"></a><span id="l1.27"> const XUL_NS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29"> var gURLBar = null;</span>
<a href="#l1.30"></a><span id="l1.30"> var gProxyButton = null;</span>
<a href="#l1.31"></a><span id="l1.31"> var gProxyFavIcon = null;</span>
<a href="#l1.32"></a><span id="l1.32"> var gProxyDeck = null;</span>
<a href="#l1.33"></a><span id="l1.33"> var gNavigatorBundle;</span>
<a href="#l1.34"></a><span id="l1.34"> var gBrandBundle;</span>
<a href="#l1.35"></a><span id="l1.35"> var gNavigatorRegionBundle;</span>
<a href="#l1.36"></a><span id="l1.36"> var gLastValidURLStr = &quot;&quot;;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineat">@@ -1507,59 +1509,124 @@ function BrowserOpenTab()</span>
<a href="#l1.38"></a><span id="l1.38">       setTimeout(WindowFocusTimerCallback, 0, content);</span>
<a href="#l1.39"></a><span id="l1.39">   }</span>
<a href="#l1.40"></a><span id="l1.40"> }</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42"> function BrowserOpenSyncTabs()</span>
<a href="#l1.43"></a><span id="l1.43"> {</span>
<a href="#l1.44"></a><span id="l1.44">   switchToTabHavingURI(&quot;about:sync-tabs&quot;, true);</span>
<a href="#l1.45"></a><span id="l1.45"> }</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-/* Show file picker dialog configured for opening a file, and return</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">- * the selected nsIFileURL instance. */</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-function selectFileToOpen(label, prefRoot)</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-{</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  var fileURL = null;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+// Class for saving the last directory and filter Index in the prefs.</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+// Used for open file and upload file.</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+class RememberLastDir {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+  // The pref names are constructed from the prefix parameter in the constructor.</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  // The pref names should not be changed later.</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+  constructor(prefPrefix) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    this._prefLastDir = prefPrefix + &quot;.lastDir&quot;;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    this._prefFilterIndex = prefPrefix + &quot;.filterIndex&quot;;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    this._lastDir = null;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    this._lastFilterIndex =  null;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  }</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  get path() {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    if (!this._lastDir || !this._lastDir.exists()) {</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+      try {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+        this._lastDir = Services.prefs.getComplexValue(this._prefLastDir,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+                                                       Ci.nsIFile);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+        if (!this._lastDir.exists()) {</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+          this._lastDir = null;</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+        }</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+      } catch (e) {}</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+    }</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    return this._lastDir;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+  }</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+  set path(val) {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    try {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+      if (!val || !val.isDirectory()) {</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+        return;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+      }</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+    } catch (e) {</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+      return;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+    }</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    this._lastDir = val.clone();</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    // Don't save the last open directory pref inside the Private Browsing mode</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    if (!gPrivate) {</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+      Services.prefs.setComplexValue(this._prefLastDir,</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+                                     Ci.nsIFile,</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+                                     this._lastDir);</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+    }</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+  }</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+  get filterIndex() {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+    if (!this._lastFilterIndex) {</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+      // use a pref to remember the filterIndex selected by the user.</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+      this._lastFilterIndex =</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+        Services.prefs.getIntPref(this._prefFilterIndex, 0);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    }</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+    return this._lastFilterIndex;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+  }</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+  set filterIndex(val) {</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+    // If the default is picked the filter is null.</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    this._lastFilterIndex = val ? val : 0;</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    // Don't save the last filter index inside the Private Browsing mode</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+    if (!gPrivate) {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+      Services.prefs.setIntPref(this._prefFilterIndex,</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+                                this._lastFilterIndex);</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+    }</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  }</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+  // This is currently not used.</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+  reset() {</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    this._lastDir = null;</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+    this._lastFilterIndex = null;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+  }</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+}</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+var gLastOpenDirectory;</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+function BrowserOpenFileWindow() {</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  if (!gLastOpenDirectory) {</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+   gLastOpenDirectory = new RememberLastDir(&quot;browser.open&quot;);</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  };</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131">   // Get filepicker component.</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-  const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  fp.init(window, gNavigatorBundle.getString(label), nsIFilePicker.modeOpen);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-  fp.appendFilters(nsIFilePicker.filterAll | nsIFilePicker.filterText | nsIFilePicker.filterImages |</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-                   nsIFilePicker.filterXML | nsIFilePicker.filterHTML);</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-  const filterIndexPref = prefRoot + &quot;filterIndex&quot;;</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-  const lastDirPref = prefRoot + &quot;dir&quot;;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-  // use a pref to remember the filterIndex selected by the user.</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-  fp.filterIndex = GetIntPref(filterIndexPref, 0);</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-  // use a pref to remember the displayDirectory selected by the user.</span>
<a href="#l1.145"></a><span id="l1.145">   try {</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-    fp.displayDirectory = Services.prefs.getComplexValue(lastDirPref,</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-                              Ci.nsIFile);</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+    const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+    let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+      if (aResult == nsIFilePicker.returnOK) {</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+        try {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+          // Set last path and file index only if file is ok.</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+          if (fp.file) {</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+            gLastOpenDirectory.filterIndex = fp.filterIndex;</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+            gLastOpenDirectory.path =</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+              fp.file.parent.QueryInterface(Ci.nsIFile);</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+          }</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+        } catch (ex) {</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+        }</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+        openUILinkIn(fp.fileURL.spec, &quot;current&quot;);</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+      }</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+    };</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+    fp.init(window, gNavigatorBundle.getString(&quot;openFile&quot;),</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+            nsIFilePicker.modeOpen);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+    fp.appendFilters(nsIFilePicker.filterAll | nsIFilePicker.filterText |</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+                     nsIFilePicker.filterImages | nsIFilePicker.filterXML |</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+                     nsIFilePicker.filterHTML);</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+    fp.filterIndex = gLastOpenDirectory.filterIndex;</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+    fp.displayDirectory = gLastOpenDirectory.path;</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+    fp.open(fpCallback);</span>
<a href="#l1.173"></a><span id="l1.173">   } catch (ex) {</span>
<a href="#l1.174"></a><span id="l1.174">   }</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-  if (fp.show() == nsIFilePicker.returnOK) {</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-    Services.prefs.setIntPref(filterIndexPref, fp.filterIndex);</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    Services.prefs.setComplexValue(lastDirPref,</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-                                   Ci.nsIFile,</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-                                   fp.file.parent);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-    fileURL = fp.fileURL;</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-  }</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-  return fileURL;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-}</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-function BrowserOpenFileWindow()</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-{</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-  try {</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-    openTopWin(selectFileToOpen(&quot;openFile&quot;, &quot;browser.open.&quot;).spec);</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-  } catch (e) {}</span>
<a href="#l1.192"></a><span id="l1.192"> }</span>
<a href="#l1.193"></a><span id="l1.193"> </span>
<a href="#l1.194"></a><span id="l1.194"> function updateCloseItems()</span>
<a href="#l1.195"></a><span id="l1.195"> {</span>
<a href="#l1.196"></a><span id="l1.196">   var browser = getBrowser();</span>
<a href="#l1.197"></a><span id="l1.197"> </span>
<a href="#l1.198"></a><span id="l1.198">   var hideCloseWindow = Services.prefs.getBoolPref(&quot;browser.tabs.closeWindowWithLastTab&quot;) &amp;&amp;</span>
<a href="#l1.199"></a><span id="l1.199">                         (!browser || browser.tabContainer.childNodes.length &lt;= 1);</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineat">@@ -2645,41 +2712,59 @@ function getCurrentURI()</span>
<a href="#l1.201"></a><span id="l1.201">   var focusedWindow = document.commandDispatcher.focusedWindow;</span>
<a href="#l1.202"></a><span id="l1.202">   var contentFrame = isContentFrame(focusedWindow) ? focusedWindow : window.content;</span>
<a href="#l1.203"></a><span id="l1.203"> </span>
<a href="#l1.204"></a><span id="l1.204">   var nav = contentFrame.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l1.205"></a><span id="l1.205">                         .getInterface(Ci.nsIWebNavigation);</span>
<a href="#l1.206"></a><span id="l1.206">   return nav.currentURI;</span>
<a href="#l1.207"></a><span id="l1.207"> }</span>
<a href="#l1.208"></a><span id="l1.208"> </span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-function uploadFile(fileURL)</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-{</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  var targetBaseURI = getCurrentURI();</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-  // generate the target URI.  we use fileURL.file.leafName to get the</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-  // unicode value of the target filename w/o any URI-escaped chars.</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-  // this gives the protocol handler the best chance of generating a</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-  // properly formatted URI spec.  we pass null for the origin charset</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-  // parameter since we want the URI to inherit the origin charset</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-  // property from targetBaseURI.</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-  var leafName = fileURL.QueryInterface(Ci.nsIFileURL).file.leafName;</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-  var targetURI = Services.io.newURI(leafName, null, targetBaseURI);</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-  // ok, start uploading...</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-  openDialog(&quot;chrome://communicator/content/downloads/uploadProgress.xul&quot;, &quot;&quot;,</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-             &quot;titlebar,centerscreen,minimizable,dialog=no&quot;, fileURL, targetURI);</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-}</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+var gLastOpenUploadDirectory;</span>
<a href="#l1.229"></a><span id="l1.229"> </span>
<a href="#l1.230"></a><span id="l1.230"> function BrowserUploadFile()</span>
<a href="#l1.231"></a><span id="l1.231"> {</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-  try {</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-    uploadFile(selectFileToOpen(&quot;uploadFile&quot;, &quot;browser.upload.&quot;));</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-  } catch (e) {}</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+  if (!gLastOpenUploadDirectory) {</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+    gLastOpenUploadDirectory = new RememberLastDir(&quot;browser.upload&quot;);</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+  };</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+  const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+  fp.init(window, gNavigatorBundle.getString(&quot;uploadFile&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+  fp.appendFilters(nsIFilePicker.filterAll | nsIFilePicker.filterText | nsIFilePicker.filterImages |</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+                   nsIFilePicker.filterXML | nsIFilePicker.filterHTML);</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+  // use a pref to remember the filterIndex selected by the user.</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+  fp.filterIndex = gLastOpenUploadDirectory.filterIndex;</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+  // Use a pref to remember the displayDirectory selected by the user.</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+  fp.displayDirectory = gLastOpenUploadDirectory.path;</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+    if (rv != nsIFilePicker.returnOK || !fp.fileURL) {</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+      return;</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+    }</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+    gLastOpenUploadDirectory.filterIndex = fp.filterIndex;</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+    gLastOpenUploadDirectory.path = fp.file.parent.QueryInterface(Ci.nsIFile);</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+    try {</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+      var targetBaseURI = getCurrentURI();</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+      // Generate the target URI. We use fileURL.file.leafName to get the</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+      // unicode value of the target filename w/o any URI-escaped chars.</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+      // this gives the protocol handler the best chance of generating a</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+      // properly formatted URI spec.  we pass null for the origin charset</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+      // parameter since we want the URI to inherit the origin charset</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+      // property from targetBaseURI.</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+      var leafName = fp.fileURL.QueryInterface(Ci.nsIFileURL).file.leafName;</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+      var targetURI = Services.io.newURI(leafName, null, targetBaseURI);</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+       // ok, start uploading...</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+      openDialog(&quot;chrome://communicator/content/downloads/uploadProgress.xul&quot;, &quot;&quot;,</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+               &quot;titlebar,centerscreen,minimizable,dialog=no&quot;, fp.fileURL, targetURI);</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+    } catch (e) {}</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+  });</span>
<a href="#l1.274"></a><span id="l1.274"> }</span>
<a href="#l1.275"></a><span id="l1.275"> </span>
<a href="#l1.276"></a><span id="l1.276"> /* This function is called whenever the file menu is about to be displayed.</span>
<a href="#l1.277"></a><span id="l1.277">  * Enable the upload menu item if appropriate. */</span>
<a href="#l1.278"></a><span id="l1.278"> function updateFileUploadItem()</span>
<a href="#l1.279"></a><span id="l1.279"> {</span>
<a href="#l1.280"></a><span id="l1.280">   var canUpload = false;</span>
<a href="#l1.281"></a><span id="l1.281">   try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/browser/pageinfo/pageInfo.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/browser/pageinfo/pageInfo.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -844,39 +844,42 @@ function getSelectedImage(tree)</span>
<a href="#l2.4"></a><span id="l2.4">     return null;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   // Only works if only one item is selected</span>
<a href="#l2.7"></a><span id="l2.7">   var clickedRow = tree.currentIndex;</span>
<a href="#l2.8"></a><span id="l2.8">   // image-node</span>
<a href="#l2.9"></a><span id="l2.9">   return gImageView.data[clickedRow][COL_IMAGE_NODE];</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function selectSaveFolder()</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+function selectSaveFolder(aCallback) {</span>
<a href="#l2.15"></a><span id="l2.15">   const nsIFile = Ci.nsIFile;</span>
<a href="#l2.16"></a><span id="l2.16">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  let titleText = gBundle.getString(&quot;mediaSelectFolder&quot;);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l2.20"></a><span id="l2.20">              .createInstance(nsIFilePicker);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    if (aResult == nsIFilePicker.returnOK) {</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+      aCallback(fp.file.QueryInterface(nsIFile));</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    } else {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+      aCallback(null);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    }</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+  };</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  var titleText = gBundle.getString(&quot;mediaSelectFolder&quot;);</span>
<a href="#l2.30"></a><span id="l2.30">   fp.init(window, titleText, nsIFilePicker.modeGetFolder);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  var initialDir = GetLocalFilePref(&quot;browser.download.lastDir&quot;);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  if (!initialDir) {</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    let dnldMgr = Cc[&quot;@mozilla.org/download-manager;1&quot;]</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-                    .getService(Ci.nsIDownloadManager);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    initialDir = dnldMgr.userDownloadsDirectory;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  try {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    let prefs = Cc[PREFERENCES_CONTRACTID]</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+                  .getService(Ci.nsIPrefBranch);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    let initialDir = prefs.getComplexValue(&quot;browser.download.dir&quot;, nsIFile);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    if (initialDir) {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+      fp.displayDirectory = initialDir;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    }</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  } catch (ex) {</span>
<a href="#l2.45"></a><span id="l2.45">   }</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-  fp.displayDirectory = initialDir;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-  var ret = fp.show();</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  if (ret == nsIFilePicker.returnOK)</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    return fp.file.QueryInterface(nsIFile);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-  return null;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  fp.open(fpCallback);</span>
<a href="#l2.55"></a><span id="l2.55"> }</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57"> function saveMedia()</span>
<a href="#l2.58"></a><span id="l2.58"> {</span>
<a href="#l2.59"></a><span id="l2.59">   var tree = document.getElementById(&quot;imagetree&quot;);</span>
<a href="#l2.60"></a><span id="l2.60">   var count = tree.view.selection.count;</span>
<a href="#l2.61"></a><span id="l2.61">   if (count == 1) {</span>
<a href="#l2.62"></a><span id="l2.62">     var item = getSelectedImage(tree);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineat">@@ -888,57 +891,53 @@ function saveMedia()</span>
<a href="#l2.64"></a><span id="l2.64">       if (item instanceof HTMLVideoElement)</span>
<a href="#l2.65"></a><span id="l2.65">         titleKey = &quot;SaveVideoTitle&quot;;</span>
<a href="#l2.66"></a><span id="l2.66">       else if (item instanceof HTMLAudioElement)</span>
<a href="#l2.67"></a><span id="l2.67">         titleKey = &quot;SaveAudioTitle&quot;;</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">       saveURL(url, null, titleKey, false, true, makeURI(item.baseURI),</span>
<a href="#l2.70"></a><span id="l2.70">               gDocument);</span>
<a href="#l2.71"></a><span id="l2.71">     }</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-  }</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-  else {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-    var odir  = selectSaveFolder();</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-    var start = { };</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-    var end   = { };</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-    var numRanges = tree.view.selection.getRangeCount();</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  } else {</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+    selectSaveFolder(function(aDirectory) {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+      if (aDirectory) {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+        var saveAnImage = function(aURIString, aChosenData, aBaseURI) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+          uniqueFile(aChosenData.file);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+          internalSave(aURIString, null, null, null, null, false, &quot;SaveImageTitle&quot;,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+                       aChosenData, aBaseURI, null, false, null, gDocument.isContentWindowPrivate);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+        };</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    var rowArray = [ ];</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    for (var t = 0; t &lt; numRanges; t++) {</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-      tree.view.selection.getRangeAt(t, start, end);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-      for (var v = start.value; v &lt;= end.value; v++)</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-        rowArray.push(v);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-    }</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    var saveAnImage = function(aURIString, aChosenData, aBaseURI) {</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-      internalSave(aURIString, null, null, null, null, false, &quot;SaveImageTitle&quot;,</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-                   aChosenData, aBaseURI, gDocument);</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-    }</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+        for (var i = 0; i &lt; rowArray.length; i++) {</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+          let v = rowArray[i];</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+          let dir = aDirectory.clone();</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+          let item = gImageView.data[v][COL_IMAGE_NODE];</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+          let uriString = gImageView.data[v][COL_IMAGE_ADDRESS];</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+          let uri = makeURI(uriString);</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    for (var i = 0; i &lt; rowArray.length; i++) {</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-      var v = rowArray[i];</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-      var dir = odir.clone();</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-      var item = gImageView.data[v][COL_IMAGE_NODE];</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-      var uriString = gImageView.data[v][COL_IMAGE_ADDRESS];</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-      var uri = makeURI(uriString);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+          try {</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+            uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+            dir.append(decodeURIComponent(uri.fileName));</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+          } catch (ex) {</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+            // data:/blob: uris</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+            // Supply a dummy filename, otherwise Download Manager</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+            // will try to delete the base directory on failure.</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+            dir.append(gImageView.data[v][COL_IMAGE_TYPE]);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+          }</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-      try {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-        uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-        dir.append(decodeURIComponent(uri.fileName));</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+          if (i == 0) {</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+            saveAnImage(uriString, new AutoChosen(dir, uri), makeURI(item.baseURI));</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+          } else {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+            // This delay is a hack which prevents the download manager</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+            // from opening many times. See bug 377339.</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+            setTimeout(saveAnImage, 200, uriString, new AutoChosen(dir, uri),</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+                       makeURI(item.baseURI));</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+          }</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+        }</span>
<a href="#l2.133"></a><span id="l2.133">       }</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-      catch(ex) { /* data: uris */ }</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-      if (i == 0)</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-        saveAnImage(uriString, new AutoChosen(dir, uri), makeURI(item.baseURI));</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-      else {</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-        // This delay is a hack which prevents the download manager</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-        // from opening many times. See bug 377339.</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-        setTimeout(saveAnImage, 200, uriString, new AutoChosen(dir, uri),</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-                   makeURI(item.baseURI));</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-      }</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    }</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+    });</span>
<a href="#l2.146"></a><span id="l2.146">   }</span>
<a href="#l2.147"></a><span id="l2.147"> }</span>
<a href="#l2.148"></a><span id="l2.148"> </span>
<a href="#l2.149"></a><span id="l2.149"> function onBlockImage(aChecked)</span>
<a href="#l2.150"></a><span id="l2.150"> {</span>
<a href="#l2.151"></a><span id="l2.151">   var uri = makeURI(document.getElementById(&quot;imageurltext&quot;).value);</span>
<a href="#l2.152"></a><span id="l2.152">   if (aChecked)</span>
<a href="#l2.153"></a><span id="l2.153">     Services.perms.add(uri, &quot;image&quot;, Services.perms.DENY_ACTION);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/common/bookmarks/bookmarksManager.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/common/bookmarks/bookmarksManager.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -319,45 +319,51 @@ var PlacesOrganizer = {</span>
<a href="#l3.4"></a><span id="l3.4">     if (window.fromFile)</span>
<a href="#l3.5"></a><span id="l3.5">       this.importFromFile();</span>
<a href="#l3.6"></a><span id="l3.6">   },</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">   /**</span>
<a href="#l3.9"></a><span id="l3.9">    * Open a file-picker and import the selected file into the bookmarks store</span>
<a href="#l3.10"></a><span id="l3.10">    */</span>
<a href="#l3.11"></a><span id="l3.11">   importFromFile: function PO_importFromFile() {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.14"></a><span id="l3.14">                .createInstance(Ci.nsIFilePicker);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+      if (aResult != Ci.nsIFilePicker.returnCancel &amp;&amp; fp.fileURL) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+        ChromeUtils.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+        BookmarkHTMLUtils.importFromURL(fp.fileURL.spec, false)</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+                         .catch(Cu.reportError);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+      }</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    };</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+</span>
<a href="#l3.23"></a><span id="l3.23">     fp.init(window, PlacesUIUtils.getString(&quot;SelectImport&quot;),</span>
<a href="#l3.24"></a><span id="l3.24">             Ci.nsIFilePicker.modeOpen);</span>
<a href="#l3.25"></a><span id="l3.25">     fp.appendFilters(Ci.nsIFilePicker.filterHTML);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    if (fp.show() != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-      if (fp.fileURL) {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-        ChromeUtils.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-        BookmarkHTMLUtils.importFromURL(fp.fileURL.spec, false)</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-                         .then(null, Cu.reportError);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-      }</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    }</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    fp.open(fpCallback);</span>
<a href="#l3.34"></a><span id="l3.34">   },</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36">   /**</span>
<a href="#l3.37"></a><span id="l3.37">    * Allows simple exporting of bookmarks.</span>
<a href="#l3.38"></a><span id="l3.38">    */</span>
<a href="#l3.39"></a><span id="l3.39">   exportBookmarks: function PO_exportBookmarks() {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.42"></a><span id="l3.42">                .createInstance(Ci.nsIFilePicker);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+      if (aResult != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+        ChromeUtils.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+        BookmarkHTMLUtils.exportToFile(fp.file.path)</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+                         .catch(Cu.reportError);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+      }</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    };</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+</span>
<a href="#l3.51"></a><span id="l3.51">     fp.init(window, PlacesUIUtils.getString(&quot;EnterExport&quot;),</span>
<a href="#l3.52"></a><span id="l3.52">             Ci.nsIFilePicker.modeSave);</span>
<a href="#l3.53"></a><span id="l3.53">     fp.appendFilters(Ci.nsIFilePicker.filterHTML);</span>
<a href="#l3.54"></a><span id="l3.54">     fp.defaultString = &quot;bookmarks.html&quot;;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-    if (fp.show() != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-      ChromeUtils.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-      BookmarkHTMLUtils.exportToFile(fp.file)</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-                       .then(null, Cu.reportError);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-    }</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    fp.open(fpCallback);</span>
<a href="#l3.61"></a><span id="l3.61">   },</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63">   /**</span>
<a href="#l3.64"></a><span id="l3.64">    * Populates the restore menu with the dates of the backups available.</span>
<a href="#l3.65"></a><span id="l3.65">    */</span>
<a href="#l3.66"></a><span id="l3.66">   populateRestoreMenu: function PO_populateRestoreMenu() {</span>
<a href="#l3.67"></a><span id="l3.67">     let restorePopup = document.getElementById(&quot;fileRestorePopup&quot;);</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineat">@@ -405,28 +411,31 @@ var PlacesOrganizer = {</span>
<a href="#l3.70"></a><span id="l3.70">     }</span>
<a href="#l3.71"></a><span id="l3.71">   },</span>
<a href="#l3.72"></a><span id="l3.72"> </span>
<a href="#l3.73"></a><span id="l3.73">   /**</span>
<a href="#l3.74"></a><span id="l3.74">    * Called when 'Choose File...' is selected from the restore menu.</span>
<a href="#l3.75"></a><span id="l3.75">    * Prompts for a file and restores bookmarks to those in the file.</span>
<a href="#l3.76"></a><span id="l3.76">    */</span>
<a href="#l3.77"></a><span id="l3.77">   onRestoreBookmarksFromFile: function PO_onRestoreBookmarksFromFile() {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-    var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.80"></a><span id="l3.80">                .createInstance(Ci.nsIFilePicker);</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    let fpCallback = aResult =&gt; {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+      if (aResult != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+        this.restoreBookmarksFromFile(fp.file);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+      }</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    };</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+</span>
<a href="#l3.87"></a><span id="l3.87">     fp.init(window, PlacesUIUtils.getString(&quot;bookmarksRestoreTitle&quot;),</span>
<a href="#l3.88"></a><span id="l3.88">             Ci.nsIFilePicker.modeOpen);</span>
<a href="#l3.89"></a><span id="l3.89">     fp.appendFilter(PlacesUIUtils.getString(&quot;bookmarksRestoreFilterName&quot;),</span>
<a href="#l3.90"></a><span id="l3.90">                     PlacesUIUtils.getString(&quot;bookmarksRestoreFilterExtension&quot;));</span>
<a href="#l3.91"></a><span id="l3.91">     fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-</span>
<a href="#l3.93"></a><span id="l3.93">     fp.displayDirectory = GetDesktopFolder();</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    if (fp.show() != Ci.nsIFilePicker.returnCancel)</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-      this.restoreBookmarksFromFile(fp.file);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+    fp.open(fpCallback);</span>
<a href="#l3.98"></a><span id="l3.98">   },</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">   /**</span>
<a href="#l3.101"></a><span id="l3.101">    * Restores bookmarks from a JSON file.</span>
<a href="#l3.102"></a><span id="l3.102">    */</span>
<a href="#l3.103"></a><span id="l3.103">   restoreBookmarksFromFile: function PO_restoreBookmarksFromFile(aFile) {</span>
<a href="#l3.104"></a><span id="l3.104">     // check file extension</span>
<a href="#l3.105"></a><span id="l3.105">     if (!/\.json(?:lz4)?$/i.test(aFile.leafName)) {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineat">@@ -453,32 +462,37 @@ var PlacesOrganizer = {</span>
<a href="#l3.107"></a><span id="l3.107">   },</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109">   /**</span>
<a href="#l3.110"></a><span id="l3.110">    * Backup bookmarks to desktop, auto-generate a filename with a date.</span>
<a href="#l3.111"></a><span id="l3.111">    * The file is a JSON serialization of bookmarks, tags and any annotations</span>
<a href="#l3.112"></a><span id="l3.112">    * of those items.</span>
<a href="#l3.113"></a><span id="l3.113">    */</span>
<a href="#l3.114"></a><span id="l3.114">   backupBookmarks: function PO_backupBookmarks() {</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.117"></a><span id="l3.117">                .createInstance(Ci.nsIFilePicker);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+    let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+      if (aResult != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+        // There is no OS.File version of the filepicker yet (Bug 937812).</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+        PlacesBackups.saveBookmarksToJSONFile(fp.file.path);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+      }</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    };</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+</span>
<a href="#l3.125"></a><span id="l3.125">     fp.init(window, PlacesUIUtils.getString(&quot;bookmarksBackupTitle&quot;),</span>
<a href="#l3.126"></a><span id="l3.126">             Ci.nsIFilePicker.modeSave);</span>
<a href="#l3.127"></a><span id="l3.127">     fp.appendFilter(PlacesUIUtils.getString(&quot;bookmarksRestoreFilterName&quot;),</span>
<a href="#l3.128"></a><span id="l3.128">                     PlacesUIUtils.getString(&quot;bookmarksRestoreFilterExtension&quot;));</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130">     var dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l3.131"></a><span id="l3.131">                    .getService(Ci.nsIProperties);</span>
<a href="#l3.132"></a><span id="l3.132">     var backupsDir = dirSvc.get(&quot;Desk&quot;, Ci.nsIFile);</span>
<a href="#l3.133"></a><span id="l3.133">     fp.displayDirectory = backupsDir;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-</span>
<a href="#l3.135"></a><span id="l3.135">     fp.defaultString = PlacesBackups.getFilenameForDate();</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    if (fp.show() != Ci.nsIFilePicker.returnCancel)</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-      PlacesBackups.saveBookmarksToJSONFile(fp.file);</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+    fp.defaultExtension = &quot;json&quot;;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+    fp.open(fpCallback);</span>
<a href="#l3.141"></a><span id="l3.141">   },</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143">   _paneDisabled: false,</span>
<a href="#l3.144"></a><span id="l3.144">   _setDetailsFieldsDisabledState:</span>
<a href="#l3.145"></a><span id="l3.145">   function PO__setDetailsFieldsDisabledState(aDisabled) {</span>
<a href="#l3.146"></a><span id="l3.146">     if (aDisabled) {</span>
<a href="#l3.147"></a><span id="l3.147">       document.getElementById(&quot;paneElementsBroadcaster&quot;)</span>
<a href="#l3.148"></a><span id="l3.148">               .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/common/openLocation.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/common/openLocation.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -87,36 +87,39 @@ function accept()</span>
<a href="#l4.4"></a><span id="l4.4">   }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   SetStringPref(gLastPref, gInput.value);</span>
<a href="#l4.7"></a><span id="l4.7"> }</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> function onChooseFile()</span>
<a href="#l4.10"></a><span id="l4.10"> {</span>
<a href="#l4.11"></a><span id="l4.11">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  try {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    fp.init(window, gBundle.getString(&quot;chooseFileDialogTitle&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    if (window.arguments[0].action != &quot;5&quot; &amp;&amp; gOpenAppList.value == &quot;2&quot;) {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-      // When loading into Composer, direct user to prefer HTML files and text</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-      // files, so we call separately to control the order of the filter list.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-      fp.appendFilters(nsIFilePicker.filterHTML | nsIFilePicker.filterText);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-      fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    }</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-    else {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-      fp.appendFilters(nsIFilePicker.filterHTML | nsIFilePicker.filterText |</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-                       nsIFilePicker.filterAll | nsIFilePicker.filterImages | nsIFilePicker.filterXML);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+             .createInstance(nsIFilePicker);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  fp.init(window, gBundle.getString(&quot;chooseFileDialogTitle&quot;),</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+          nsIFilePicker.modeOpen);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  if (window.arguments[0].action != &quot;5&quot; &amp;&amp; gOpenAppList.value == &quot;2&quot;) {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    // When loading into Composer, direct user to prefer HTML files and text</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+    // files, so we call separately to control the order of the filter list.</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    fp.appendFilters(nsIFilePicker.filterHTML | nsIFilePicker.filterText);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  } else {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+    fp.appendFilters(nsIFilePicker.filterHTML | nsIFilePicker.filterText |</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+                     nsIFilePicker.filterAll | nsIFilePicker.filterImages |</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+                     nsIFilePicker.filterXML);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  }</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+    if (rv == nsIFilePicker.returnOK &amp;&amp; fp.fileURL.spec &amp;&amp; </span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+        fp.fileURL.spec.length &gt; 0) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      gInput.value = fp.fileURL.spec;</span>
<a href="#l4.43"></a><span id="l4.43">     }</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-    if (fp.show() == nsIFilePicker.returnOK &amp;&amp; fp.fileURL.spec &amp;&amp; fp.fileURL.spec.length &gt; 0)</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-      gInput.value = fp.fileURL.spec;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-  }</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-  catch(ex) {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  }</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  doEnabling();</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    doEnabling();</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  });</span>
<a href="#l4.53"></a><span id="l4.53"> }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55"> function useUBHistoryItem(aValue)</span>
<a href="#l4.56"></a><span id="l4.56"> {</span>
<a href="#l4.57"></a><span id="l4.57">   gInput.value = aValue;</span>
<a href="#l4.58"></a><span id="l4.58">   gInput.focus();</span>
<a href="#l4.59"></a><span id="l4.59">   doEnabling();</span>
<a href="#l4.60"></a><span id="l4.60"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/common/pref/pref-applications.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/common/pref/pref-applications.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: Java; tab-width: 2; c-basic-offset: 2; -*-</span>
<a href="#l5.5"></a><span id="l5.5">  *</span>
<a href="#l5.6"></a><span id="l5.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+</span>
<a href="#l5.12"></a><span id="l5.12"> function Startup()</span>
<a href="#l5.13"></a><span id="l5.13"> {</span>
<a href="#l5.14"></a><span id="l5.14">   gApplicationsPane.init();</span>
<a href="#l5.15"></a><span id="l5.15"> }</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> //****************************************************************************//</span>
<a href="#l5.18"></a><span id="l5.18"> // Constants &amp; Enumeration Values</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20" class="difflineat">@@ -1566,87 +1568,93 @@ var gApplicationsPane = {</span>
<a href="#l5.21"></a><span id="l5.21">         typeItem.setAttribute(&quot;actionIcon&quot;, sysIcon);</span>
<a href="#l5.22"></a><span id="l5.22">       else</span>
<a href="#l5.23"></a><span id="l5.23">         typeItem.setAttribute(&quot;appHandlerIcon&quot;, &quot;app&quot;);</span>
<a href="#l5.24"></a><span id="l5.24">     }</span>
<a href="#l5.25"></a><span id="l5.25">   },</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27">   chooseApp: function() {</span>
<a href="#l5.28"></a><span id="l5.28">     var handlerApp;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-    var params = {};</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    var handlerInfo = this._handledTypes[this._list.selectedItem.type];</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-    if (isFeedType(handlerInfo.type)) {</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-      // MIME info will be null, create a temp object.</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-      params.mimeInfo = mimeSvc.getFromTypeAndExtension(handlerInfo.type,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-                                                 handlerInfo.primaryExtension);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    } else {</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-      params.mimeInfo = handlerInfo.wrappedHandlerInfo;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-    }</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-    params.title         = this._prefsBundle.getString(&quot;fpTitleChooseApp&quot;);</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    params.description   = handlerInfo.description;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    params.filename      = null;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    params.handlerApp    = null;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    window.openDialog(&quot;chrome://global/content/appPicker.xul&quot;, null,</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-                      &quot;chrome,modal,centerscreen,titlebar,dialog=yes&quot;,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-                      params);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-    if (this.isValidHandlerApp(params.handlerApp)) {</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-      handlerApp = params.handlerApp;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-      // Add the app to the type's list of possible handlers.</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-      handlerInfo.addPossibleApplicationHandler(handlerApp);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    }</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-#else</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-               .createInstance(nsIFilePicker);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-    var winTitle = this._prefsBundle.getString(&quot;fpTitleChooseApp&quot;);</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-    fp.init(window, winTitle, nsIFilePicker.modeOpen);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-    fp.appendFilters(nsIFilePicker.filterApps);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+    let onSelectionDone = function() {</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+      // Rebuild the actions menu whether the user picked an app or canceled.</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+      // If they picked an app, we want to add the app to the menu and select it.</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+      // If they canceled, we want to go back to their previous selection.</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+      this.rebuildActionsMenu();</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-    // Prompt the user to pick an app.  If they pick one, and it's a valid</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-    // selection, then add it to the list of possible handlers.</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    if (fp.show() == nsIFilePicker.returnOK &amp;&amp; fp.file &amp;&amp;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-        this._isValidHandlerExecutable(fp.file)) {</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-      handlerApp = Cc[&quot;@mozilla.org/uriloader/local-handler-app;1&quot;]</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-                     .createInstance(nsILocalHandlerApp);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-      handlerApp.name = getFileDisplayName(fp.file);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-      handlerApp.executable = fp.file;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-      // Add the app to the type's list of possible handlers.</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-      let handlerInfo = this._handledTypes[this._list.selectedItem.type];</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-      handlerInfo.addPossibleApplicationHandler(handlerApp);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-    }</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-#endif</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    // Rebuild the actions menu whether the user picked an app or canceled.</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-    // If they picked an app, we want to add the app to the menu and select it.</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-    // If they canceled, we want to go back to their previous selection.</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-    this.rebuildActionsMenu();</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-    // If the user picked a new app from the menu, select it.</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-    if (handlerApp) {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-      let typeItem = this._list.selectedItem;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-      var actionsCell =</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-        document.getAnonymousElementByAttribute(typeItem, &quot;anonid&quot;, &quot;action-cell&quot;);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-      var actionsMenu =</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-        document.getAnonymousElementByAttribute(actionsCell, &quot;anonid&quot;, &quot;action-menu&quot;);</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-      let menuItems = actionsMenu.menupopup.childNodes;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-      for (let i = 0; i &lt; menuItems.length; i++) {</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-        let menuItem = menuItems[i];</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-        if (menuItem.handlerApp &amp;&amp; menuItem.handlerApp.equals(handlerApp)) {</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-          actionsMenu.selectedIndex = i;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-          this.onSelectAction(menuItem);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-          break;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+      // If the user picked a new app from the menu, select it.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+      if (handlerApp) {</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+        let typeItem = this._list.selectedItem;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+        var actionsCell =</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+          document.getAnonymousElementByAttribute(typeItem, &quot;anonid&quot;, &quot;action-cell&quot;);</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+        var actionsMenu =</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+          document.getAnonymousElementByAttribute(actionsCell, &quot;anonid&quot;, &quot;action-menu&quot;);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+        let menuItems = actionsMenu.menupopup.childNodes;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+        for (let i = 0; i &lt; menuItems.length; i++) {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+          let menuItem = menuItems[i];</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+          if (menuItem.handlerApp &amp;&amp; menuItem.handlerApp.equals(handlerApp)) {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+            actionsMenu.selectedIndex = i;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+            this.onSelectAction(menuItem);</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+            break;</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+          }</span>
<a href="#l5.118"></a><span id="l5.118">         }</span>
<a href="#l5.119"></a><span id="l5.119">       }</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    }.bind(this);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+    if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+      let params = {};</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+      let handlerInfo = this._handledTypes[this._list.selectedItem.type];</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+      if (isFeedType(handlerInfo.type)) {</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+        // MIME info will be null, create a temp object.</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+        params.mimeInfo = mimeSvc.getFromTypeAndExtension(handlerInfo.type,</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+                                                   handlerInfo.primaryExtension);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+      } else {</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+        params.mimeInfo = handlerInfo.wrappedHandlerInfo;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+      }</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+      params.title         = this._prefsBundle.getString(&quot;fpTitleChooseApp&quot;);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+      params.description   = handlerInfo.description;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+      params.filename      = null;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+      params.handlerApp    = null;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+      window.openDialog(&quot;chrome://global/content/appPicker.xul&quot;, null,</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+                        &quot;chrome,modal,centerscreen,titlebar,dialog=yes&quot;,</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+                        params);</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+      if (this.isValidHandlerApp(params.handlerApp)) {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+        handlerApp = params.handlerApp;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+        // Add the app to the type's list of possible handlers.</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+        handlerInfo.addPossibleApplicationHandler(handlerApp);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+      }</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+      onSelectionDone();</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+    } else {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+      const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+      let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+                 .createInstance(nsIFilePicker);</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+      let winTitle = this._prefsBundle.getString(&quot;fpTitleChooseApp&quot;);</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+      fp.init(window, winTitle, nsIFilePicker.modeOpen);</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+      fp.appendFilters(nsIFilePicker.filterApps);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+      // Prompt the user to pick an app.  If they pick one, and it's a valid</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+      // selection, then add it to the list of possible handlers.</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+      fp.open(rv =&gt; {</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+        if (rv == nsIFilePicker.returnOK &amp;&amp; fp.file &amp;&amp;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+            this._isValidHandlerExecutable(fp.file)) {</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+          handlerApp = Cc[&quot;@mozilla.org/uriloader/local-handler-app;1&quot;]</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+                         .createInstance(Ci.nsILocalHandlerApp);</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+          handlerApp.name = getDisplayNameForFile(fp.file);</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+          handlerApp.executable = fp.file;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+          // Add the app to the type's list of possible handlers.</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+          let handlerInfo = this._handledTypes[this._list.selectedItem.type];</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+          handlerInfo.addPossibleApplicationHandler(handlerApp);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+        }</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+        onSelectionDone();</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+      });</span>
<a href="#l5.174"></a><span id="l5.174">     }</span>
<a href="#l5.175"></a><span id="l5.175">   },</span>
<a href="#l5.176"></a><span id="l5.176"> </span>
<a href="#l5.177"></a><span id="l5.177">   _setIconClassForPreferredAction: function(aHandlerInfo, aElement) {</span>
<a href="#l5.178"></a><span id="l5.178">     // If this returns true, the attribute that CSS sniffs for was set to something</span>
<a href="#l5.179"></a><span id="l5.179">     // so you shouldn't manually set an icon URI.</span>
<a href="#l5.180"></a><span id="l5.180">     // This removes the existing actionIcon attribute if any, even if returning false.</span>
<a href="#l5.181"></a><span id="l5.181">     aElement.removeAttribute(&quot;actionIcon&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/common/pref/pref-cache.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/common/pref/pref-cache.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -52,37 +52,41 @@ function ReadCacheFolder(aField)</span>
<a href="#l6.4"></a><span id="l6.4">     {</span>
<a href="#l6.5"></a><span id="l6.5">       // no disk cache folder pref set; default to profile directory</span>
<a href="#l6.6"></a><span id="l6.6">       file = GetSpecialDirectory(Services.dirsvc.has(&quot;ProfLD&quot;) ? &quot;ProfLD&quot;</span>
<a href="#l6.7"></a><span id="l6.7">                                                                : &quot;ProfD&quot;);</span>
<a href="#l6.8"></a><span id="l6.8">     }</span>
<a href="#l6.9"></a><span id="l6.9">     catch (ex) {}</span>
<a href="#l6.10"></a><span id="l6.10">   }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  if (file)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  if (file) {</span>
<a href="#l6.15"></a><span id="l6.15">     aField.file = file;</span>
<a href="#l6.16"></a><span id="l6.16">     aField.label = (/Mac/.test(navigator.platform)) ? file.leafName : file.path;</span>
<a href="#l6.17"></a><span id="l6.17">   }</span>
<a href="#l6.18"></a><span id="l6.18"> }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> function CacheSelectFolder()</span>
<a href="#l6.21"></a><span id="l6.21"> {</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-  var pref = document.getElementById(&quot;browser.cache.disk.parent_directory&quot;);</span>
<a href="#l6.23"></a><span id="l6.23">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l6.26"></a><span id="l6.26">              .createInstance(nsIFilePicker);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-  var prefutilitiesBundle = document.getElementById(&quot;bundle_prefutilities&quot;);</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-  var title = prefutilitiesBundle.getString(&quot;cachefolder&quot;);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  let title = document.getElementById(&quot;bundle_prefutilities&quot;)</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+                      .getString(&quot;cachefolder&quot;);</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">   fp.init(window, title, nsIFilePicker.modeGetFolder);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  fp.displayDirectory = pref.value;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  fp.displayDirectory = </span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+    document.getElementById(&quot;browser.cache.disk.parent_directory&quot;).value;</span>
<a href="#l6.36"></a><span id="l6.36">   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  if (fp.show() == nsIFilePicker.returnOK)</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    pref.value = fp.file;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    if (rv != nsIFilePicker.returnOK || !fp.file) {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+      return;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+    }</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    document.getElementById(&quot;browser.cache.disk.parent_directory&quot;).value = fp.file;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  });</span>
<a href="#l6.46"></a><span id="l6.46"> }</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48"> function ClearDiskAndMemCache()</span>
<a href="#l6.49"></a><span id="l6.49"> {</span>
<a href="#l6.50"></a><span id="l6.50">   Cc[&quot;@mozilla.org/netwerk/cache-storage-service;1&quot;]</span>
<a href="#l6.51"></a><span id="l6.51">     .getService(Ci.nsICacheStorageService).clear();</span>
<a href="#l6.52"></a><span id="l6.52">   updateActualCacheSize();</span>
<a href="#l6.53"></a><span id="l6.53"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/common/pref/pref-download.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/common/pref/pref-download.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -40,36 +40,38 @@ function ReadUseDownloadDir()</span>
<a href="#l7.4"></a><span id="l7.4"> /**</span>
<a href="#l7.5"></a><span id="l7.5">   * Displays a file picker in which the user can choose the location where</span>
<a href="#l7.6"></a><span id="l7.6">   * downloads are automatically saved, updating preferences and UI in</span>
<a href="#l7.7"></a><span id="l7.7">   * response to the choice, if one is made.</span>
<a href="#l7.8"></a><span id="l7.8">   */</span>
<a href="#l7.9"></a><span id="l7.9"> function ChooseFolder()</span>
<a href="#l7.10"></a><span id="l7.10"> {</span>
<a href="#l7.11"></a><span id="l7.11">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l7.15"></a><span id="l7.15">              .createInstance(nsIFilePicker);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  var prefutilitiesBundle = document.getElementById(&quot;bundle_prefutilities&quot;);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  var title = prefutilitiesBundle.getString(&quot;downloadfolder&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  let title = document.getElementById(&quot;bundle_prefutilities&quot;)</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+                      .getString(&quot;downloadfolder&quot;);</span>
<a href="#l7.20"></a><span id="l7.20">   fp.init(window, title, nsIFilePicker.modeGetFolder);</span>
<a href="#l7.21"></a><span id="l7.21">   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  var folderListPref = document.getElementById(&quot;browser.download.folderList&quot;);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  fp.displayDirectory = IndexToFolder(folderListPref.value); // file</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  if (fp.show() == nsIFilePicker.returnOK) {</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-    var currentDirPref = document.getElementById(&quot;browser.download.dir&quot;);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-    currentDirPref.value = fp.file;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-    folderListPref.value = FolderToIndex(fp.file);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+  fp.displayDirectory = </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+    IndexToFolder(document.getElementById(&quot;browser.download.folderList&quot;)</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+                          .value);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    if (rv != nsIFilePicker.returnOK || !fp.file) {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+      return;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+    }</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    document.getElementById(&quot;browser.download.dir&quot;).value = fp.file;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+    document.getElementById(&quot;browser.download.folderList&quot;).value = </span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+      FolderToIndex(fp.file);</span>
<a href="#l7.40"></a><span id="l7.40">     // Note, the real prefs will not be updated yet, so dnld manager's</span>
<a href="#l7.41"></a><span id="l7.41">     // userDownloadsDirectory may not return the right folder after</span>
<a href="#l7.42"></a><span id="l7.42">     // this code executes. displayDownloadDirPref will be called on</span>
<a href="#l7.43"></a><span id="l7.43">     // the assignment above to update the UI.</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  }</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  });</span>
<a href="#l7.46"></a><span id="l7.46"> }</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48"> /**</span>
<a href="#l7.49"></a><span id="l7.49">   * Initializes the download folder display settings based on the user's</span>
<a href="#l7.50"></a><span id="l7.50">   * preferences.</span>
<a href="#l7.51"></a><span id="l7.51">   */</span>
<a href="#l7.52"></a><span id="l7.52"> function DisplayDownloadDirPref()</span>
<a href="#l7.53"></a><span id="l7.53"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/common/pref/pref-navigator.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/common/pref/pref-navigator.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -196,29 +196,33 @@ function UpdateHomePageList(aSingleURL)</span>
<a href="#l8.4"></a><span id="l8.4">   // write single URL into input box and set it as the list of homepages</span>
<a href="#l8.5"></a><span id="l8.5">   SetHomePageValue(aSingleURL);</span>
<a href="#l8.6"></a><span id="l8.6">   UpdateHomePageListFromInput();</span>
<a href="#l8.7"></a><span id="l8.7"> }</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> function SelectFile()</span>
<a href="#l8.10"></a><span id="l8.10"> {</span>
<a href="#l8.11"></a><span id="l8.11">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l8.14"></a><span id="l8.14">              .createInstance(nsIFilePicker);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-  var prefutilitiesBundle = document.getElementById(&quot;bundle_prefutilities&quot;);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  var title = prefutilitiesBundle.getString(&quot;choosehomepage&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  let title = document.getElementById(&quot;bundle_prefutilities&quot;)</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+                      .getString(&quot;choosehomepage&quot;);</span>
<a href="#l8.19"></a><span id="l8.19">   fp.init(window, title, nsIFilePicker.modeOpen);</span>
<a href="#l8.20"></a><span id="l8.20">   fp.appendFilters(nsIFilePicker.filterAll  |</span>
<a href="#l8.21"></a><span id="l8.21">                    nsIFilePicker.filterText |</span>
<a href="#l8.22"></a><span id="l8.22">                    nsIFilePicker.filterXML  |</span>
<a href="#l8.23"></a><span id="l8.23">                    nsIFilePicker.filterHTML |</span>
<a href="#l8.24"></a><span id="l8.24">                    nsIFilePicker.filterImages);</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  if (fp.show() == nsIFilePicker.returnOK)</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-    UpdateHomePageList(fp.fileURL.spec);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    if (rv == nsIFilePicker.returnOK &amp;&amp; fp.fileURL.spec &amp;&amp; </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+        fp.fileURL.spec.length &gt; 0) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+      UpdateHomePageList(fp.fileURL.spec);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    }</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  });</span>
<a href="#l8.34"></a><span id="l8.34"> }</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36"> function SetHomePageToCurrentPage()</span>
<a href="#l8.37"></a><span id="l8.37"> {</span>
<a href="#l8.38"></a><span id="l8.38">   UpdateHomePageList(GetCurrentPage());</span>
<a href="#l8.39"></a><span id="l8.39"> }</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41"> function SetHomePageToCurrentGroup()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/common/pref/preferences.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/common/pref/preferences.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.5"></a><span id="l9.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> // The content of this file is loaded into the scope of the</span>
<a href="#l9.10"></a><span id="l9.10"> // prefwindow and will be available to all prefpanes!</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14"> function OnLoad()</span>
<a href="#l9.15"></a><span id="l9.15"> {</span>
<a href="#l9.16"></a><span id="l9.16">   // Make sure that the preferences window fits the screen.</span>
<a href="#l9.17"></a><span id="l9.17">   let dialog    = document.documentElement;</span>
<a href="#l9.18"></a><span id="l9.18">   let curHeight = dialog.scrollHeight;</span>
<a href="#l9.19"></a><span id="l9.19">   let curWidth  = dialog.scrollWidth;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   // Leave some space for desktop toolbar and window decoration.</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -45,49 +47,54 @@ function EnableElement(aElement, aEnable</span>
<a href="#l9.23"></a><span id="l9.23"> }</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25"> function WriteSoundField(aField, aValue)</span>
<a href="#l9.26"></a><span id="l9.26"> {</span>
<a href="#l9.27"></a><span id="l9.27">   var file = GetFileFromString(aValue);</span>
<a href="#l9.28"></a><span id="l9.28">   if (file)</span>
<a href="#l9.29"></a><span id="l9.29">   {</span>
<a href="#l9.30"></a><span id="l9.30">     aField.file = file;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    aField.label = (/Mac/.test(navigator.platform)) ? file.leafName : file.path;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    aField.label = (AppConstants.platform == &quot;macosx&quot;) ? file.leafName : file.path;</span>
<a href="#l9.33"></a><span id="l9.33">   }</span>
<a href="#l9.34"></a><span id="l9.34"> }</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36"> function SelectSound(aSoundUrlPref)</span>
<a href="#l9.37"></a><span id="l9.37"> {</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  var soundUrlPref = aSoundUrlPref;</span>
<a href="#l9.39"></a><span id="l9.39">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l9.42"></a><span id="l9.42">              .createInstance(nsIFilePicker);</span>
<a href="#l9.43"></a><span id="l9.43">   var prefutilitiesBundle = document.getElementById(&quot;bundle_prefutilities&quot;);</span>
<a href="#l9.44"></a><span id="l9.44">   fp.init(window, prefutilitiesBundle.getString(&quot;choosesound&quot;),</span>
<a href="#l9.45"></a><span id="l9.45">           nsIFilePicker.modeOpen);</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  var file = GetFileFromString(aSoundUrlPref.value);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  let file = GetFileFromString(soundUrlPref.value);</span>
<a href="#l9.49"></a><span id="l9.49">   if (file &amp;&amp; file.parent &amp;&amp; file.parent.exists())</span>
<a href="#l9.50"></a><span id="l9.50">     fp.displayDirectory = file.parent;</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-  var filterExts = &quot;*.wav; *.wave&quot;;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  let filterExts = &quot;*.wav; *.wave&quot;;</span>
<a href="#l9.54"></a><span id="l9.54">   // On Mac, allow AIFF and CAF files too.</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  if (/Mac/.test(navigator.platform))</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l9.57"></a><span id="l9.57">     filterExts += &quot;; *.aif; *.aiff; *.caf&quot;;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  }</span>
<a href="#l9.59"></a><span id="l9.59">   fp.appendFilter(prefutilitiesBundle.getString(&quot;SoundFiles&quot;), filterExts);</span>
<a href="#l9.60"></a><span id="l9.60">   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  if (fp.show() == nsIFilePicker.returnOK)</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    aSoundUrlPref.value = fp.fileURL.spec;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+    if (rv == nsIFilePicker.returnOK &amp;&amp; fp.fileURL.spec &amp;&amp; </span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+        fp.fileURL.spec.length &gt; 0) {</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+      soundUrlPref.value = fp.fileURL.spec;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    }</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  });</span>
<a href="#l9.70"></a><span id="l9.70"> }</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72"> function PlaySound(aValue, aMail)</span>
<a href="#l9.73"></a><span id="l9.73"> {</span>
<a href="#l9.74"></a><span id="l9.74">   const nsISound = Ci.nsISound;</span>
<a href="#l9.75"></a><span id="l9.75">   var sound = Cc[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l9.76"></a><span id="l9.76">                 .createInstance(nsISound);</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78">   if (aValue)</span>
<a href="#l9.79"></a><span id="l9.79">     sound.play(Services.io.newURI(aValue));</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-  else if (aMail &amp;&amp; !/Mac/.test(navigator.platform))</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  else if (aMail &amp;&amp; (AppConstants.platform != &quot;macosx&quot;))</span>
<a href="#l9.82"></a><span id="l9.82">     sound.playEventSound(nsISound.EVENT_NEW_MAIL_RECEIVED);</span>
<a href="#l9.83"></a><span id="l9.83">   else</span>
<a href="#l9.84"></a><span id="l9.84">     sound.beep();</span>
<a href="#l9.85"></a><span id="l9.85"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/common/sync/syncUtils.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/common/sync/syncUtils.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -150,36 +150,38 @@ var gSyncUtils = {</span>
<a href="#l10.4"></a><span id="l10.4">    * Save passphrase backup document to disk as HTML file.</span>
<a href="#l10.5"></a><span id="l10.5">    *</span>
<a href="#l10.6"></a><span id="l10.6">    * @param elid : ID of the form element containing the passphrase.</span>
<a href="#l10.7"></a><span id="l10.7">    */</span>
<a href="#l10.8"></a><span id="l10.8">   passphraseSave: function(elid) {</span>
<a href="#l10.9"></a><span id="l10.9">     let dialogTitle = this._stringBundle.GetStringFromName(&quot;save.recoverykey.title&quot;);</span>
<a href="#l10.10"></a><span id="l10.10">     let defaultSaveName = this._stringBundle.GetStringFromName(&quot;save.recoverykey.defaultfilename&quot;);</span>
<a href="#l10.11"></a><span id="l10.11">     this._preparePPiframe(elid, function(iframe) {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-      let filepicker = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                         .createInstance(Ci.nsIFilePicker);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-      filepicker.init(window, dialogTitle, Ci.nsIFilePicker.modeSave);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-      filepicker.appendFilters(Ci.nsIFilePicker.filterHTML);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-      filepicker.defaultString = defaultSaveName;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-      let rv = filepicker.show();</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-      if (rv == Ci.nsIFilePicker.returnOK</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-          || rv == Ci.nsIFilePicker.returnReplace) {</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-        let stream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-                       .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-        stream.init(filepicker.file, -1, parseInt(&quot;0600&quot;, 8), 0);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+      let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+      let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+        if (aResult == Ci.nsIFilePicker.returnOK ||</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+            aResult == Ci.nsIFilePicker.returnReplace) {</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+          let stream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+                         .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+          stream.init(filepicker.file, -1, parseInt(&quot;0600&quot;, 8), 0);</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-        let serializer = new XMLSerializer();</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-        let output = serializer.serializeToString(iframe.contentDocument);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-        output = output.replace(/&lt;!DOCTYPE (.|\n)*?]&gt;/,</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-          '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; ' +</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-          '&quot;DTD/xhtml1-strict.dtd&quot;&gt;');</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-        output = Weave.Utils.encodeUTF8(output);</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-        stream.write(output, output.length);</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-      }</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+          let serializer = new XMLSerializer();</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+          let output = serializer.serializeToString(iframe.contentDocument);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+          output = output.replace(/&lt;!DOCTYPE (.|\n)*?]&gt;/,</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+            '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; ' +</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+            '&quot;DTD/xhtml1-strict.dtd&quot;&gt;');</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+          output = Weave.Utils.encodeUTF8(output);</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+          stream.write(output, output.length);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+        }</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+      };</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+      fp.init(window, dialogTitle, Ci.nsIFilePicker.modeSave);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+      fp.appendFilters(Ci.nsIFilePicker.filterHTML);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+      fp.defaultString = defaultSaveName;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+      fp.open(fpCallback);</span>
<a href="#l10.53"></a><span id="l10.53">       return false;</span>
<a href="#l10.54"></a><span id="l10.54">     });</span>
<a href="#l10.55"></a><span id="l10.55">   },</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57">   /**</span>
<a href="#l10.58"></a><span id="l10.58">    * validatePassword</span>
<a href="#l10.59"></a><span id="l10.59">    *</span>
<a href="#l10.60"></a><span id="l10.60">    * @param el1 : the first textbox element in the form</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/components/feeds/FeedWriter.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/components/feeds/FeedWriter.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -636,47 +636,53 @@ FeedWriter.prototype = {</span>
<a href="#l11.4"></a><span id="l11.4">    */</span>
<a href="#l11.5"></a><span id="l11.5">   _getUIElement: function getUIElement(id) {</span>
<a href="#l11.6"></a><span id="l11.6">     return this._document.getAnonymousElementByAttribute(</span>
<a href="#l11.7"></a><span id="l11.7">       this._document.getElementById(&quot;feedSubscribeLine&quot;), &quot;anonid&quot;, id);</span>
<a href="#l11.8"></a><span id="l11.8">   },</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   /**</span>
<a href="#l11.11"></a><span id="l11.11">    * Displays a prompt from which the user may choose a (client) feed reader.</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-   * @return - true if a feed reader was selected, false otherwise.</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+   * @param aCallback the callback method, passes in true if a feed reader was</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+   *        selected, false otherwise.</span>
<a href="#l11.15"></a><span id="l11.15">    */</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-  _chooseClientApp: function chooseClientApp() {</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+  _chooseClientApp: function chooseClientApp(aCallback) {</span>
<a href="#l11.18"></a><span id="l11.18">     try {</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-      var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+      let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l11.21"></a><span id="l11.21">                  .createInstance(Ci.nsIFilePicker);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+      let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+        if (aResult == Ci.nsIFilePicker.returnOK) {</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+          this._selectedApp = fp.file;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+          if (this._selectedApp) {</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+            let file = Services.dirsvc.get(&quot;XREExeF&quot;, Ci.nsIFile);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+            if (fp.file.leafName != file.leafName) {</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+              this._initMenuItemWithFile(this._selectedAppMenuItem,</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+                                         this._selectedApp);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+              // Show and select the selected application menuitem</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+              this._selectedAppMenuItem.hidden = false;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+              this._selectedAppMenuItem.doCommand();</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+              if (aCallback) {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+                aCallback(true);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+                return;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+              }</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+            }</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+          }</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+        }</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+        if (aCallback) {</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+          aCallback(false);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+        }</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+      }.bind(this);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+</span>
<a href="#l11.46"></a><span id="l11.46">       fp.init(this._window,</span>
<a href="#l11.47"></a><span id="l11.47">               this._getString(&quot;chooseApplicationDialogTitle&quot;),</span>
<a href="#l11.48"></a><span id="l11.48">               Ci.nsIFilePicker.modeOpen);</span>
<a href="#l11.49"></a><span id="l11.49">       fp.appendFilters(Ci.nsIFilePicker.filterApps);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-      if (fp.show() == Ci.nsIFilePicker.returnOK) {</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-        this._selectedApp = fp.file;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-        if (this._selectedApp) {</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-          var file = Services.dirsvc.get(&quot;XREExeF&quot;, Ci.nsIFile);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-          if (fp.file.leafName != file.leafName) {</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-            this._initMenuItemWithFile(this._selectedAppMenuItem,</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-                                       this._selectedApp);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-            // Show and select the selected application menuitem</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-            this._selectedAppMenuItem.hidden = false;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-            this._selectedAppMenuItem.doCommand();</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-            return true;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-          }</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-        }</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-      }</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-    }</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-    catch(ex) {</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    }</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    return false;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+      fp.open(fpCallback);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+    } catch(ex) {}</span>
<a href="#l11.73"></a><span id="l11.73">   },</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75">   _setAlwaysUseCheckedState: function setAlwaysUseCheckedState(feedType) {</span>
<a href="#l11.76"></a><span id="l11.76">     var checkbox = this._getUIElement(&quot;alwaysUse&quot;);</span>
<a href="#l11.77"></a><span id="l11.77">     if (checkbox) {</span>
<a href="#l11.78"></a><span id="l11.78">       var alwaysUse = (safeGetCharPref(getPrefActionForType(feedType), &quot;ask&quot;) != &quot;ask&quot;);</span>
<a href="#l11.79"></a><span id="l11.79">       this._setCheckboxCheckedState(checkbox, alwaysUse);</span>
<a href="#l11.80"></a><span id="l11.80">     }</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineat">@@ -742,20 +748,24 @@ FeedWriter.prototype = {</span>
<a href="#l11.82"></a><span id="l11.82">            * Application&quot; item is being selected with the keyboard. We do this</span>
<a href="#l11.83"></a><span id="l11.83">            * by ignoring command events while the dropdown is closed (user</span>
<a href="#l11.84"></a><span id="l11.84">            * arrowing through the combobox), but handling them while the</span>
<a href="#l11.85"></a><span id="l11.85">            * combobox dropdown is open (user pressed enter when an item was</span>
<a href="#l11.86"></a><span id="l11.86">            * selected). If we don't show the filepicker here, it will be shown</span>
<a href="#l11.87"></a><span id="l11.87">            * when clicking &quot;Subscribe Now&quot;.</span>
<a href="#l11.88"></a><span id="l11.88">            */</span>
<a href="#l11.89"></a><span id="l11.89">           var popupbox = this._handlersMenuList.firstChild.boxObject;</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-          if (popupbox.popupState == &quot;hiding&quot; &amp;&amp; !this._chooseClientApp()) {</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-            // Select the (per-prefs) selected handler if no application was</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-            // selected</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-            this._setSelectedHandler(this._getFeedType());</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+          if (popupbox.popupState == &quot;hiding&quot;) {</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+            this._chooseClientApp(function(aResult) {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+              if (!aResult) {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+                // Select the (per-prefs) selected handler if no application</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+                // was selected</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+                this._setSelectedHandler(this._getFeedType());</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+              }</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+            }.bind(this));</span>
<a href="#l11.102"></a><span id="l11.102">           }</span>
<a href="#l11.103"></a><span id="l11.103">           break;</span>
<a href="#l11.104"></a><span id="l11.104">         default:</span>
<a href="#l11.105"></a><span id="l11.105">           this._setAlwaysUseLabel();</span>
<a href="#l11.106"></a><span id="l11.106">       }</span>
<a href="#l11.107"></a><span id="l11.107">     }</span>
<a href="#l11.108"></a><span id="l11.108">   },</span>
<a href="#l11.109"></a><span id="l11.109"> </span>
<a href="#l11.110"></a><span id="l11.110" class="difflineat">@@ -1099,80 +1109,87 @@ FeedWriter.prototype = {</span>
<a href="#l11.111"></a><span id="l11.111">   _subscribe: function subscribe() {</span>
<a href="#l11.112"></a><span id="l11.112">     var feedType = this._getFeedType();</span>
<a href="#l11.113"></a><span id="l11.113"> </span>
<a href="#l11.114"></a><span id="l11.114">     // Subscribe to the feed using the selected handler and save prefs</span>
<a href="#l11.115"></a><span id="l11.115">     var defaultHandler = &quot;reader&quot;;</span>
<a href="#l11.116"></a><span id="l11.116">     var useAsDefault = this._getUIElement(&quot;alwaysUse&quot;).getAttribute(&quot;checked&quot;);</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118">     var selectedItem = this._getSelectedItemFromMenulist(this._handlersMenuList);</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+    let subscribeCallback = function() {</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+      if (selectedItem.hasAttribute(&quot;webhandlerurl&quot;)) {</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+        var webURI = selectedItem.getAttribute(&quot;webhandlerurl&quot;);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+        Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;web&quot;);</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+        Services.prefs.setStringPref(getPrefWebForType(feedType), webURI);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+        var wccr = Cc[&quot;@mozilla.org/embeddor.implemented/web-content-handler-registrar;1&quot;]</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+                     .getService(Ci.nsIWebContentConverterService);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+        var handler = wccr.getWebContentHandlerByURI(this._getMimeTypeForFeedType(feedType), webURI);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+        if (handler) {</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+          if (useAsDefault)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+            wccr.setAutoHandler(this._getMimeTypeForFeedType(feedType), handler);</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+          this._window.location.href = handler.getHandlerURI(this._window.location.href);</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+        }</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+      }</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+      else {</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+        switch (selectedItem.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+          case &quot;selectedAppMenuItem&quot;:</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+            Services.prefs.setComplexValue(getPrefAppForType(feedType), Ci.nsIFile,</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+                                           this._selectedApp);</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+            Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;client&quot;);</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+            break;</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+          case &quot;defaultHandlerMenuItem&quot;:</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+            Services.prefs.setComplexValue(getPrefAppForType(feedType), Ci.nsIFile,</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+                                           this._defaultSystemReader);</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+            Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;client&quot;);</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+            break;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+          case &quot;liveBookmarksMenuItem&quot;:</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+            defaultHandler = &quot;bookmarks&quot;;</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+            Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;bookmarks&quot;);</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+            break;</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+          case &quot;messengerFeedsMenuItem&quot;:</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+            defaultHandler = &quot;messenger&quot;;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+            Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;messenger&quot;);</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+            break;</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+        }</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+        var feedService = Cc[&quot;@mozilla.org/browser/feeds/result-service;1&quot;]</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+                            .getService(Ci.nsIFeedResultService);</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+        // Pull the title and subtitle out of the document</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+        var feedTitle = this._document.getElementById(TITLE_ID).textContent;</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+        var feedSubtitle = this._document.getElementById(SUBTITLE_ID).textContent;</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+        feedService.addToClientReader(this._window.location.href, feedTitle, feedSubtitle, feedType);</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+      }</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+      // If &quot;Always use...&quot; is checked, we should set PREF_*SELECTED_ACTION</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+      // to either &quot;reader&quot; (If a web reader or if an application is selected),</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+      // or to &quot;messenger&quot; (if the messenger feeds option is selected).</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+      // Otherwise, we should set it to &quot;ask&quot;</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+      if (useAsDefault) {</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+        Services.prefs.setCharPref(getPrefActionForType(feedType), defaultHandler);</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+      } else {</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+        Services.prefs.setCharPref(getPrefActionForType(feedType), &quot;ask&quot;);</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+      }</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+    }.bind(this);</span>
<a href="#l11.176"></a><span id="l11.176"> </span>
<a href="#l11.177"></a><span id="l11.177">     // Show the file picker before subscribing if the</span>
<a href="#l11.178"></a><span id="l11.178">     // choose application menuitem was chosen using the keyboard</span>
<a href="#l11.179"></a><span id="l11.179">     if (selectedItem.getAttribute(&quot;anonid&quot;) == &quot;chooseApplicationMenuItem&quot;) {</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-      if (!this._chooseClientApp())</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-        return;</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-      selectedItem = this._getSelectedItemFromMenulist(this._handlersMenuList);</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-    }</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-    if (selectedItem.hasAttribute(&quot;webhandlerurl&quot;)) {</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-      var webURI = selectedItem.getAttribute(&quot;webhandlerurl&quot;);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-      Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;web&quot;);</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-      Services.prefs.setStringPref(getPrefWebForType(feedType), webURI);</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-      var wccr = Cc[&quot;@mozilla.org/embeddor.implemented/web-content-handler-registrar;1&quot;]</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-                   .getService(Ci.nsIWebContentConverterService);</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-      var handler = wccr.getWebContentHandlerByURI(this._getMimeTypeForFeedType(feedType), webURI);</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-      if (handler) {</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-        if (useAsDefault)</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-          wccr.setAutoHandler(this._getMimeTypeForFeedType(feedType), handler);</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-        this._window.location.href = handler.getHandlerURI(this._window.location.href);</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-      }</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+      this._chooseClientApp(function(aResult) {</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+        if (aResult) {</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+          selectedItem =</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+            this._getSelectedItemFromMenulist(this._handlersMenuList);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+          subscribeCallback();</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+        }</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+      }.bind(this));</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+    } else {</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+      subscribeCallback();</span>
<a href="#l11.210"></a><span id="l11.210">     }</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-    else {</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-      switch (selectedItem.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-        case &quot;selectedAppMenuItem&quot;:</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-          Services.prefs.setComplexValue(getPrefAppForType(feedType), Ci.nsIFile,</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-                                         this._selectedApp);</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-          Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;client&quot;);</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-          break;</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-        case &quot;defaultHandlerMenuItem&quot;:</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-          Services.prefs.setComplexValue(getPrefAppForType(feedType), Ci.nsIFile,</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-                                         this._defaultSystemReader);</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-          Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;client&quot;);</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-          break;</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-        case &quot;liveBookmarksMenuItem&quot;:</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-          defaultHandler = &quot;bookmarks&quot;;</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-          Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;bookmarks&quot;);</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-          break;</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-        case &quot;messengerFeedsMenuItem&quot;:</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-          defaultHandler = &quot;messenger&quot;;</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-          Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;messenger&quot;);</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-          break;</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-      }</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-      var feedService = Cc[&quot;@mozilla.org/browser/feeds/result-service;1&quot;]</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-                          .getService(Ci.nsIFeedResultService);</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-      // Pull the title and subtitle out of the document</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-      var feedTitle = this._document.getElementById(TITLE_ID).textContent;</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-      var feedSubtitle = this._document.getElementById(SUBTITLE_ID).textContent;</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-      feedService.addToClientReader(this._window.location.href, feedTitle, feedSubtitle, feedType);</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-    }</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-    // If &quot;Always use...&quot; is checked, we should set PREF_*SELECTED_ACTION</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-    // to either &quot;reader&quot; (If a web reader or if an application is selected),</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-    // or to &quot;messenger&quot; (if the messenger feeds option is selected).</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-    // Otherwise, we should set it to &quot;ask&quot;</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-    if (useAsDefault)</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-      Services.prefs.setCharPref(getPrefActionForType(feedType), defaultHandler);</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-    else</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-      Services.prefs.setCharPref(getPrefActionForType(feedType), &quot;ask&quot;);</span>
<a href="#l11.249"></a><span id="l11.249">   },</span>
<a href="#l11.250"></a><span id="l11.250"> </span>
<a href="#l11.251"></a><span id="l11.251">   // nsIObserver</span>
<a href="#l11.252"></a><span id="l11.252">   observe: function observe(subject, topic, data) {</span>
<a href="#l11.253"></a><span id="l11.253">     if (!this._window) {</span>
<a href="#l11.254"></a><span id="l11.254">       // this._window is null unless this.init was called with a trusted</span>
<a href="#l11.255"></a><span id="l11.255">       // window object.</span>
<a href="#l11.256"></a><span id="l11.256">       return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/suite/mailnews/addrbook/abCardOverlay.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/suite/mailnews/addrbook/abCardOverlay.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -929,35 +929,34 @@ function removePhoto(aName) {</span>
<a href="#l12.4"></a><span id="l12.4">   catch (e) {}</span>
<a href="#l12.5"></a><span id="l12.5">   return false;</span>
<a href="#l12.6"></a><span id="l12.6"> }</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> /**</span>
<a href="#l12.9"></a><span id="l12.9">  * Opens a file picker with image filters to look for a contact photo.</span>
<a href="#l12.10"></a><span id="l12.10">  * If the user selects a file and clicks OK then the PhotoURI textbox is set</span>
<a href="#l12.11"></a><span id="l12.11">  * with a file URI pointing to that file and updatePhoto is called.</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">- *</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">- * @return true if the OK button was clicked and a photo was chosen</span>
<a href="#l12.14"></a><span id="l12.14">  */</span>
<a href="#l12.15"></a><span id="l12.15"> function browsePhoto() {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-  var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-	                   .createInstance(nsIFilePicker);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+  let nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+             .createInstance(nsIFilePicker);</span>
<a href="#l12.22"></a><span id="l12.22">   fp.init(window, gAddressBookBundle.getString(&quot;browsePhoto&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24">   // Add All Files &amp; Image Files filters and select the latter</span>
<a href="#l12.25"></a><span id="l12.25">   fp.appendFilters(nsIFilePicker.filterImages);</span>
<a href="#l12.26"></a><span id="l12.26">   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  if (fp.show() == nsIFilePicker.returnOK) {</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+    if (rv != nsIFilePicker.returnOK) {</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+      return;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+    }</span>
<a href="#l12.33"></a><span id="l12.33">     document.getElementById(&quot;PhotoFile&quot;).file = fp.file;</span>
<a href="#l12.34"></a><span id="l12.34">     onSwitchPhotoType(document.getElementById(&quot;FilePhotoType&quot;).value);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-    return true;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  }</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  return false;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  });</span>
<a href="#l12.39"></a><span id="l12.39"> }</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41"> /* A photo handler defines the behaviour of the contact editor</span>
<a href="#l12.42"></a><span id="l12.42">  * for a particular photo type. Each photo handler must implement</span>
<a href="#l12.43"></a><span id="l12.43">  * the following interface:</span>
<a href="#l12.44"></a><span id="l12.44">  *</span>
<a href="#l12.45"></a><span id="l12.45">  * onLoad: function(aCard, aDocument):</span>
<a href="#l12.46"></a><span id="l12.46">  *   Called when the editor wants to populate the contact editor</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -2403,34 +2403,40 @@ function SetLastAttachDirectory(attached</span>
<a href="#l13.4"></a><span id="l13.4">   catch (ex) {</span>
<a href="#l13.5"></a><span id="l13.5">     dump(&quot;error: SetLastAttachDirectory failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l13.6"></a><span id="l13.6">   }</span>
<a href="#l13.7"></a><span id="l13.7"> }</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> function AttachFile()</span>
<a href="#l13.10"></a><span id="l13.10"> {</span>
<a href="#l13.11"></a><span id="l13.11">   //Get file using nsIFilePicker and convert to URL</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  try {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-      var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-      fp.init(window, sComposeMsgsBundle.getString(&quot;chooseFileToAttach&quot;), nsIFilePicker.modeOpenMultiple);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-      var lastDirectory = GetLocalFilePref(kComposeAttachDirPrefName);</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-      if (lastDirectory)</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-        fp.displayDirectory = lastDirectory;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-      fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-      if (fp.show() == nsIFilePicker.returnOK) {</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-        var firstAttachedFile = AttachFiles(fp.files);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-        if (firstAttachedFile)</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-          SetLastAttachDirectory(firstAttachedFile);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+  const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+             .createInstance(nsIFilePicker);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  fp.init(window, sComposeMsgsBundle.getString(&quot;chooseFileToAttach&quot;),</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+          nsIFilePicker.modeOpenMultiple);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  let lastDirectory = GetLocalFilePref(kComposeAttachDirPrefName);</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  if (lastDirectory)</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+    fp.displayDirectory = lastDirectory;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+    if (rv != nsIFilePicker.returnOK || !fp.files) {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+      return;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+    }</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+    try {</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+      let firstAttachedFile = AttachFiles(fp.files);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+      if (firstAttachedFile) {</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+        SetLastAttachDirectory(firstAttachedFile);</span>
<a href="#l13.43"></a><span id="l13.43">       }</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  }</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-  catch (ex) {</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-    dump(&quot;failed to get attachments: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-  }</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+    }</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+    catch (ex) {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+      dump(&quot;failed to get attachments: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    }</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  });</span>
<a href="#l13.53"></a><span id="l13.53"> }</span>
<a href="#l13.54"></a><span id="l13.54"> </span>
<a href="#l13.55"></a><span id="l13.55"> function AttachFiles(attachments)</span>
<a href="#l13.56"></a><span id="l13.56"> {</span>
<a href="#l13.57"></a><span id="l13.57">   if (!attachments || !attachments.hasMoreElements())</span>
<a href="#l13.58"></a><span id="l13.58">     return null;</span>
<a href="#l13.59"></a><span id="l13.59"> </span>
<a href="#l13.60"></a><span id="l13.60">   var firstAttachedFile = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/suite/mailnews/mailWindowOverlay.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/suite/mailnews/mailWindowOverlay.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1578,45 +1578,41 @@ function MsgSaveAsFile()</span>
<a href="#l14.4"></a><span id="l14.4">   SaveAsFile(gFolderDisplay.selectedMessageUris);</span>
<a href="#l14.5"></a><span id="l14.5"> }</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> function MsgSaveAsTemplate()</span>
<a href="#l14.8"></a><span id="l14.8"> {</span>
<a href="#l14.9"></a><span id="l14.9">   SaveAsTemplate(gFolderDisplay.selectedMessageUris);</span>
<a href="#l14.10"></a><span id="l14.10"> }</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-</span>
<a href="#l14.14"></a><span id="l14.14"> function MsgOpenFromFile()</span>
<a href="#l14.15"></a><span id="l14.15"> {</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+  const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+             .createInstance(nsIFilePicker);</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">   var filterLabel = gMessengerBundle.getString(&quot;EMLFiles&quot;);</span>
<a href="#l14.22"></a><span id="l14.22">   var windowTitle = gMessengerBundle.getString(&quot;OpenEMLFiles&quot;);</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-   fp.init(window, windowTitle, nsIFilePicker.modeOpen);</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-   fp.appendFilter(filterLabel, &quot;*.eml; *.msg&quot;);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-   // Default or last filter is &quot;All Files&quot;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-  try {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-     var ret = fp.show();</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-     if (ret == nsIFilePicker.returnCancel)</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-       return;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-   }</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-   catch (ex) {</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-     dump(&quot;filePicker.chooseInputFile threw an exception\n&quot;);</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-     return;</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-   }</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  var uri = fp.fileURL.QueryInterface(Ci.nsIURL);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  uri.query = &quot;type=application/x-message-display&quot;;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  window.openDialog( &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, uri, null, null );</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  fp.init(window, windowTitle, nsIFilePicker.modeOpen);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  fp.appendFilter(filterLabel, &quot;*.eml; *.msg&quot;);</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+  // Default or last filter is &quot;All Files&quot;.</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  fp.open(rv =&gt; {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+    if (rv != nsIFilePicker.returnOK || !fp.file) {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+      return;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    }</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+    let uri = fp.fileURL.QueryInterface(Ci.nsIURL);</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+    uri.query = &quot;type=application/x-message-display&quot;;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+                    &quot;all,chrome,dialog=no,status,toolbar&quot;, uri);</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  });</span>
<a href="#l14.60"></a><span id="l14.60"> }</span>
<a href="#l14.61"></a><span id="l14.61"> </span>
<a href="#l14.62"></a><span id="l14.62"> function MsgOpenNewWindowForMsgHdr(hdr)</span>
<a href="#l14.63"></a><span id="l14.63"> {</span>
<a href="#l14.64"></a><span id="l14.64">   MsgOpenNewWindowForFolder(hdr.folder.URI, hdr.messageKey);</span>
<a href="#l14.65"></a><span id="l14.65"> }</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67"> function MsgOpenNewWindowForFolder(uri, key)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

