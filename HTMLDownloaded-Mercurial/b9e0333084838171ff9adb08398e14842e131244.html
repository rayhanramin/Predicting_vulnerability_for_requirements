<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26937:b9e0333084838171ff9adb08398e14842e131244</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b9e0333084838171ff9adb08398e14842e131244" />
<meta property="og:url" content="/comm-central/rev/b9e0333084838171ff9adb08398e14842e131244" />
<meta property="og:description" content="Bug 1096006 - Adapt mozmill tests to Account Manager being in the Preferences tab. r=darktrojan" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b9e0333084838171ff9adb08398e14842e131244 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b9e0333084838171ff9adb08398e14842e131244">shortlog</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b9e0333084838171ff9adb08398e14842e131244">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244">files</a> |
changeset |
<a href="/comm-central/raw-rev/b9e0333084838171ff9adb08398e14842e131244">raw</a>  | <a href="/comm-central/archive/b9e0333084838171ff9adb08398e14842e131244.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1096006">Bug 1096006</a> - Adapt mozmill tests to Account Manager being in the Preferences tab. r=darktrojan
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 20 Jun 2019 07:13:41 +0200</td></tr>

<tr>
 <td>changeset 26937</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b9e0333084838171ff9adb08398e14842e131244">b9e0333084838171ff9adb08398e14842e131244</a></td>
</tr>



<tr>
<td>parent 26936</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2b61ea9688aab7271c591137e543e999340dbfe9">2b61ea9688aab7271c591137e543e999340dbfe9</a>
</td>
</tr>

<tr>
<td>child 26938</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9c86704d0b9de9c9f017302294fba65e2015093c">9c86704d0b9de9c9f017302294fba65e2015093c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b9e0333084838171ff9adb08398e14842e131244">16073</a></td></tr>
<tr><td>push user</td><td>acelists@atlas.sk</td></tr>
<tr><td>push date</td><td class="date age">Thu, 20 Jun 2019 05:14:29 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b9e033308483 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9e0333084838171ff9adb08398e14842e131244">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9e0333084838171ff9adb08398e14842e131244&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e0333084838171ff9adb08398e14842e131244&newProject=comm-central&newRevision=2b61ea9688aab7271c591137e543e999340dbfe9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e0333084838171ff9adb08398e14842e131244&newProject=comm-central&newRevision=2b61ea9688aab7271c591137e543e999340dbfe9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e0333084838171ff9adb08398e14842e131244&newProject=comm-central&newRevision=2b61ea9688aab7271c591137e543e999340dbfe9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1096006">1096006</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1096006">Bug 1096006</a> - Adapt mozmill tests to Account Manager being in the Preferences tab. r=darktrojan</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-ab-whitelist.js">mail/test/mozmill/account/test-ab-whitelist.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-ab-whitelist.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-ab-whitelist.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-ab-whitelist.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-ab-whitelist.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-ab-whitelist.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-actions.js">mail/test/mozmill/account/test-account-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-actions.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-actions.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-actions.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-actions.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-actions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-deletion.js">mail/test/mozmill/account/test-account-deletion.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-deletion.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-deletion.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-deletion.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-deletion.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-deletion.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-port-setting.js">mail/test/mozmill/account/test-account-port-setting.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-port-setting.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-port-setting.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-port-setting.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-port-setting.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-port-setting.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-settings-infrastructure.js">mail/test/mozmill/account/test-account-settings-infrastructure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-settings-infrastructure.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-settings-infrastructure.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-settings-infrastructure.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-settings-infrastructure.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-settings-infrastructure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-tree.js">mail/test/mozmill/account/test-account-tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-tree.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-tree.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-tree.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-tree.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-tree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-values.js">mail/test/mozmill/account/test-account-values.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-values.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-values.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-values.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-values.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-account-values.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-archive-options.js">mail/test/mozmill/account/test-archive-options.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-archive-options.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-archive-options.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-archive-options.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-archive-options.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-archive-options.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-mail-account-setup-wizard.js">mail/test/mozmill/account/test-mail-account-setup-wizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-mail-account-setup-wizard.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-mail-account-setup-wizard.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-mail-account-setup-wizard.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-mail-account-setup-wizard.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-mail-account-setup-wizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-retest-config.js">mail/test/mozmill/account/test-retest-config.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-retest-config.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-retest-config.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-retest-config.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-retest-config.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/account/test-retest-config.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">mail/test/mozmill/shared-modules/test-account-manager-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">mail/test/mozmill/shared-modules/test-pref-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">file</a> |
<a href="/comm-central/annotate/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">comparison</a> |
<a href="/comm-central/log/b9e0333084838171ff9adb08398e14842e131244/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/mozmill/account/test-ab-whitelist.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-ab-whitelist.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,44 +1,45 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> &quot;use strict&quot;;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> /* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l1.12"></a><span id="l1.12"> /* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l1.13"></a><span id="l1.13"> /* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l1.15"></a><span id="l1.15"> /* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> var MODULE_NAME = &quot;test-ab-whitelist&quot;;</span>
<a href="#l1.18"></a><span id="l1.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l1.19"></a><span id="l1.19"> var MODULE_REQUIRES = [</span>
<a href="#l1.20"></a><span id="l1.20">   &quot;folder-display-helpers&quot;,</span>
<a href="#l1.21"></a><span id="l1.21">   &quot;window-helpers&quot;,</span>
<a href="#l1.22"></a><span id="l1.22">   &quot;account-manager-helpers&quot;,</span>
<a href="#l1.23"></a><span id="l1.23">   &quot;keyboard-helpers&quot;,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l1.26"></a><span id="l1.26"> ];</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28"> var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l1.29"></a><span id="l1.29"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l1.30"></a><span id="l1.30"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32"> var gOldWhiteList = null;</span>
<a href="#l1.33"></a><span id="l1.33"> var gKeyString = null;</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35"> var gAccount = null;</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37"> function setupModule(module) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-  wh.installInto(module);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  fdh.installInto(module);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  let amh = collector.getModule(&quot;account-manager-helpers&quot;);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-  amh.installInto(module);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+    collector.getModule(lib).installInto(module);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+  }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">   let server = MailServices.accounts</span>
<a href="#l1.49"></a><span id="l1.49">                            .FindServer(&quot;tinderbox&quot;, FAKE_SERVER_HOSTNAME, &quot;pop3&quot;);</span>
<a href="#l1.50"></a><span id="l1.50">   gAccount = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l1.51"></a><span id="l1.51">   let serverKey = server.key;</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">   gKeyString = &quot;mail.server.&quot; + serverKey + &quot;.whiteListAbURI&quot;;</span>
<a href="#l1.54"></a><span id="l1.54">   gOldWhiteList = Services.prefs.getCharPref(gKeyString);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineat">@@ -48,75 +49,78 @@ function setupModule(module) {</span>
<a href="#l1.56"></a><span id="l1.56"> function teardownModule(module) {</span>
<a href="#l1.57"></a><span id="l1.57">   Services.prefs.setCharPref(gKeyString, gOldWhiteList);</span>
<a href="#l1.58"></a><span id="l1.58"> }</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60"> /* First, test that when we initially load the account manager, that</span>
<a href="#l1.61"></a><span id="l1.61">  * we're not whitelisting any address books.  Then, we'll check all</span>
<a href="#l1.62"></a><span id="l1.62">  * address books and save.</span>
<a href="#l1.63"></a><span id="l1.63">  */</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-function subtest_check_whitelist_init_and_save(amc) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+function test_check_whitelist_init_and_save() {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l1.67"></a><span id="l1.67">   // Ok, the advanced settings window is open.  Let's choose</span>
<a href="#l1.68"></a><span id="l1.68">   // the junkmail settings.</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-  let doc = amc.window.document.getElementById(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  let doc = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l1.76"></a><span id="l1.76"> </span>
<a href="#l1.77"></a><span id="l1.77">   // At this point, we shouldn't have anything checked, but we should have</span>
<a href="#l1.78"></a><span id="l1.78">   // the two default address books (Personal and Collected) displayed</span>
<a href="#l1.79"></a><span id="l1.79">   let list = doc.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l1.80"></a><span id="l1.80">   assert_equals(2, list.getRowCount(),</span>
<a href="#l1.81"></a><span id="l1.81">                 &quot;There was an unexpected number of address books&quot;);</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">   // Now we'll check both address books</span>
<a href="#l1.84"></a><span id="l1.84">   for (let i = 0; i &lt; list.getRowCount(); i++) {</span>
<a href="#l1.85"></a><span id="l1.85">     let abNode = list.getItemAtIndex(i);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-    amc.click(new elib.Elem(abNode.firstChild));</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+    mc.click(new elib.Elem(abNode.firstChild));</span>
<a href="#l1.88"></a><span id="l1.88">   }</span>
<a href="#l1.89"></a><span id="l1.89"> </span>
<a href="#l1.90"></a><span id="l1.90">   // And close the dialog</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-  amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l1.93"></a><span id="l1.93"> }</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95"> /* Next, we'll make sure that the address books we checked in</span>
<a href="#l1.96"></a><span id="l1.96">  * subtest_check_whitelist_init_and_save were properly saved.</span>
<a href="#l1.97"></a><span id="l1.97">  * Then, we'll clear the address books and save.</span>
<a href="#l1.98"></a><span id="l1.98">  */</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-function subtest_check_whitelist_load_and_clear(amc) {</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+function test_check_whitelist_load_and_clear() {</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-  let doc = amc.window.document.getElementById(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+  let doc = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l1.109"></a><span id="l1.109">   let list = doc.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l1.110"></a><span id="l1.110">   let whiteListURIs = Services.prefs.getCharPref(gKeyString).split(&quot; &quot;);</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112">   for (let i = 0; i &lt; list.getRowCount(); i++) {</span>
<a href="#l1.113"></a><span id="l1.113">     let abNode = list.getItemAtIndex(i);</span>
<a href="#l1.114"></a><span id="l1.114">     assert_equals(&quot;true&quot;, abNode.firstChild.getAttribute(&quot;checked&quot;),</span>
<a href="#l1.115"></a><span id="l1.115">                   &quot;Should have been checked&quot;);</span>
<a href="#l1.116"></a><span id="l1.116">     // Also ensure that the address book URI was properly saved in the</span>
<a href="#l1.117"></a><span id="l1.117">     // prefs</span>
<a href="#l1.118"></a><span id="l1.118">     assert_true(whiteListURIs.includes(abNode.getAttribute(&quot;value&quot;)));</span>
<a href="#l1.119"></a><span id="l1.119">     // Now un-check that address book</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-    amc.click(new elib.Elem(abNode.firstChild));</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    mc.click(new elib.Elem(abNode.firstChild));</span>
<a href="#l1.122"></a><span id="l1.122">   }</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124">   // And close the dialog</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l1.127"></a><span id="l1.127"> }</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129"> /* Finally, we'll make sure that the address books we cleared</span>
<a href="#l1.130"></a><span id="l1.130">  * were actually cleared.</span>
<a href="#l1.131"></a><span id="l1.131">  */</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-function subtest_check_whitelist_load_cleared(amc) {</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+function test_check_whitelist_load_cleared() {</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l1.139"></a><span id="l1.139"> </span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-  let doc = amc.window.document.getElementById(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  let doc = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l1.142"></a><span id="l1.142">   let list = doc.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l1.143"></a><span id="l1.143">   let whiteListURIs = &quot;&quot;;</span>
<a href="#l1.144"></a><span id="l1.144"> </span>
<a href="#l1.145"></a><span id="l1.145">   try {</span>
<a href="#l1.146"></a><span id="l1.146">     whiteListURIs = Services.prefs.getCharPref(gKeyString);</span>
<a href="#l1.147"></a><span id="l1.147">     // We should have failed here, because the pref should have been cleared</span>
<a href="#l1.148"></a><span id="l1.148">     // out.</span>
<a href="#l1.149"></a><span id="l1.149">     throw Error(&quot;The whitelist preference for this server wasn't properly &quot;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineat">@@ -129,16 +133,10 @@ function subtest_check_whitelist_load_cl</span>
<a href="#l1.151"></a><span id="l1.151">     assert_equals(&quot;false&quot;, abNode.firstChild.getAttribute(&quot;checked&quot;),</span>
<a href="#l1.152"></a><span id="l1.152">                   &quot;Should not have been checked&quot;);</span>
<a href="#l1.153"></a><span id="l1.153">     // Also ensure that the address book URI was properly cleared in the</span>
<a href="#l1.154"></a><span id="l1.154">     // prefs</span>
<a href="#l1.155"></a><span id="l1.155">     assert_false(whiteListURIs.includes(abNode.getAttribute(&quot;value&quot;)));</span>
<a href="#l1.156"></a><span id="l1.156">   }</span>
<a href="#l1.157"></a><span id="l1.157"> </span>
<a href="#l1.158"></a><span id="l1.158">   // And close the dialog</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-  amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l1.161"></a><span id="l1.161"> }</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-function test_address_book_whitelist() {</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-  open_advanced_settings(subtest_check_whitelist_init_and_save);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-  open_advanced_settings(subtest_check_whitelist_load_and_clear);</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-  open_advanced_settings(subtest_check_whitelist_load_cleared);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-actions.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-actions.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,28 +1,36 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l2.6"></a><span id="l2.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> &quot;use strict&quot;;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> /* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l2.12"></a><span id="l2.12"> /* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l2.14"></a><span id="l2.14"> /* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> var MODULE_NAME = &quot;test-account-actions&quot;;</span>
<a href="#l2.17"></a><span id="l2.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+];</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> var imapAccount, nntpAccount, originalAccountCount;</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29"> function setupModule(module) {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  collector.getModule(&quot;account-manager-helpers&quot;).installInto(module);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    collector.getModule(lib).installInto(module);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  }</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   // There may be pre-existing accounts from other tests.</span>
<a href="#l2.38"></a><span id="l2.38">   originalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l2.39"></a><span id="l2.39">   // There already should be a Local Folders account created.</span>
<a href="#l2.40"></a><span id="l2.40">   // It is needed for this test.</span>
<a href="#l2.41"></a><span id="l2.41">   assert_true(MailServices.accounts.localFoldersServer);</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   // Create an IMAP server</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineat">@@ -58,104 +66,93 @@ function teardownModule(module) {</span>
<a href="#l2.45"></a><span id="l2.45">   MailServices.accounts.removeAccount(imapAccount);</span>
<a href="#l2.46"></a><span id="l2.46">   // There should be only the original accounts left.</span>
<a href="#l2.47"></a><span id="l2.47">   assert_equals(MailServices.accounts.allServers.length, originalAccountCount);</span>
<a href="#l2.48"></a><span id="l2.48"> }</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50"> /**</span>
<a href="#l2.51"></a><span id="l2.51">  * Check that the account actions for the account are enabled or disabled appropriately.</span>
<a href="#l2.52"></a><span id="l2.52">  *</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">- * @param amc          the account options controller</span>
<a href="#l2.54"></a><span id="l2.54">  * @param aAccountKey  the key of the account to select</span>
<a href="#l2.55"></a><span id="l2.55">  * @param aIsSetAsDefaultEnabled  true if the menuitem should be enabled, false otherwise</span>
<a href="#l2.56"></a><span id="l2.56">  * @param aIsRemoveEnabled        true if the menuitem should be enabled, false otherwise</span>
<a href="#l2.57"></a><span id="l2.57">  * @param aIsAddAccountEnabled    true if the menuitems (Add Mail Account+Add Other Account)</span>
<a href="#l2.58"></a><span id="l2.58">  *                                should be enabled, false otherwise</span>
<a href="#l2.59"></a><span id="l2.59">  */</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-function subtest_check_account_actions(amc, aAccountKey, aIsSetAsDefaultEnabled,</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+function subtest_check_account_actions(aAccountKey, aIsSetAsDefaultEnabled,</span>
<a href="#l2.62"></a><span id="l2.62">                                        aIsRemoveEnabled, aIsAddAccountEnabled) {</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  let accountRow = get_account_tree_row(aAccountKey, null, amc);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  let accountRow = get_account_tree_row(aAccountKey, null, tab);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">   // click the Actions Button to bring up the popup with menuitems to test</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-  amc.click(amc.eid(&quot;accountActionsButton&quot;), 5, 5);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  wait_for_popup_to_open(amc.e(&quot;accountActionsDropdown&quot;));</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  mc.click(content_tab_eid(tab, &quot;accountActionsButton&quot;), 5, 5);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  wait_for_popup_to_open(content_tab_e(tab, &quot;accountActionsDropdown&quot;));</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-  let actionAddMailAccount = amc.e(&quot;accountActionsAddMailAccount&quot;);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  let actionAddMailAccount = content_tab_e(tab, &quot;accountActionsAddMailAccount&quot;);</span>
<a href="#l2.77"></a><span id="l2.77">   assert_not_equals(actionAddMailAccount, undefined);</span>
<a href="#l2.78"></a><span id="l2.78">   assert_equals(!actionAddMailAccount.getAttribute(&quot;disabled&quot;), aIsAddAccountEnabled);</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  let actionAddOtherAccount = amc.e(&quot;accountActionsAddOtherAccount&quot;);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  let actionAddOtherAccount = content_tab_e(tab, &quot;accountActionsAddOtherAccount&quot;);</span>
<a href="#l2.82"></a><span id="l2.82">   assert_not_equals(actionAddOtherAccount, undefined);</span>
<a href="#l2.83"></a><span id="l2.83">   assert_equals(!actionAddOtherAccount.getAttribute(&quot;disabled&quot;), aIsAddAccountEnabled);</span>
<a href="#l2.84"></a><span id="l2.84"> </span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-  let actionSetDefault = amc.e(&quot;accountActionsDropdownSetDefault&quot;);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+  let actionSetDefault = content_tab_e(tab, &quot;accountActionsDropdownSetDefault&quot;);</span>
<a href="#l2.87"></a><span id="l2.87">   assert_not_equals(actionSetDefault, undefined);</span>
<a href="#l2.88"></a><span id="l2.88">   assert_equals(!actionSetDefault.getAttribute(&quot;disabled&quot;), aIsSetAsDefaultEnabled);</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-  let actionRemove = amc.e(&quot;accountActionsDropdownRemove&quot;);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  let actionRemove = content_tab_e(tab, &quot;accountActionsDropdownRemove&quot;);</span>
<a href="#l2.92"></a><span id="l2.92">   assert_not_equals(actionRemove, undefined);</span>
<a href="#l2.93"></a><span id="l2.93">   assert_equals(!actionRemove.getAttribute(&quot;disabled&quot;), aIsRemoveEnabled);</span>
<a href="#l2.94"></a><span id="l2.94"> </span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-  close_popup(amc, amc.eid(&quot;accountActionsDropdown&quot;));</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  close_popup(mc, content_tab_eid(tab, &quot;accountActionsDropdown&quot;));</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l2.99"></a><span id="l2.99"> }</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101"> function test_account_actions() {</span>
<a href="#l2.102"></a><span id="l2.102">   // IMAP account: can be default, can be removed.</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    subtest_check_account_actions(amc, imapAccount.key, true, true, true);</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-  });</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  subtest_check_account_actions(imapAccount.key, true, true, true);</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108">   // NNTP (News) account: can't be default, can be removed.</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    subtest_check_account_actions(amc, nntpAccount.key, false, true, true);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-  });</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  subtest_check_account_actions(nntpAccount.key, false, true, true);</span>
<a href="#l2.113"></a><span id="l2.113"> </span>
<a href="#l2.114"></a><span id="l2.114">   // Local Folders account: can't be removed, can't be default.</span>
<a href="#l2.115"></a><span id="l2.115">   var localFoldersAccount = MailServices.accounts.FindAccountForServer(MailServices.accounts.localFoldersServer);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-    subtest_check_account_actions(amc, localFoldersAccount.key, false, false, true);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-  });</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  subtest_check_account_actions(localFoldersAccount.key, false, false, true);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+</span>
<a href="#l2.121"></a><span id="l2.121">   // SMTP server row: can't be removed, can't be default.</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-    subtest_check_account_actions(amc, null, false, false, true);</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-  });</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  subtest_check_account_actions(null, false, false, true);</span>
<a href="#l2.126"></a><span id="l2.126"> </span>
<a href="#l2.127"></a><span id="l2.127">   // on the IMAP account, disable Delete Account menu item</span>
<a href="#l2.128"></a><span id="l2.128">   let disableItemPref = &quot;mail.disable_button.delete_account&quot;;</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130">   // Set the pref on the default branch, otherwise .getBoolPref on it throws.</span>
<a href="#l2.131"></a><span id="l2.131">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(disableItemPref, true);</span>
<a href="#l2.132"></a><span id="l2.132">   Services.prefs.lockPref(disableItemPref);</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-    subtest_check_account_actions(amc, imapAccount.key, true, false, true);</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-  });</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+  subtest_check_account_actions(imapAccount.key, true, false, true);</span>
<a href="#l2.138"></a><span id="l2.138"> </span>
<a href="#l2.139"></a><span id="l2.139">   Services.prefs.unlockPref(disableItemPref);</span>
<a href="#l2.140"></a><span id="l2.140">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(disableItemPref);</span>
<a href="#l2.141"></a><span id="l2.141"> </span>
<a href="#l2.142"></a><span id="l2.142">   // on the IMAP account, disable Set as Default menu item</span>
<a href="#l2.143"></a><span id="l2.143">   disableItemPref = &quot;mail.disable_button.set_default_account&quot;;</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(disableItemPref, true);</span>
<a href="#l2.146"></a><span id="l2.146">   Services.prefs.lockPref(disableItemPref);</span>
<a href="#l2.147"></a><span id="l2.147"> </span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-    subtest_check_account_actions(amc, imapAccount.key, false, true, true);</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-  });</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+  subtest_check_account_actions(imapAccount.key, false, true, true);</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153">   Services.prefs.unlockPref(disableItemPref);</span>
<a href="#l2.154"></a><span id="l2.154">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(disableItemPref);</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156">   // on the IMAP account, disable Add new Account menu items</span>
<a href="#l2.157"></a><span id="l2.157">   disableItemPref = &quot;mail.disable_new_account_addition&quot;;</span>
<a href="#l2.158"></a><span id="l2.158"> </span>
<a href="#l2.159"></a><span id="l2.159">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(disableItemPref, true);</span>
<a href="#l2.160"></a><span id="l2.160">   Services.prefs.lockPref(disableItemPref);</span>
<a href="#l2.161"></a><span id="l2.161"> </span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-    subtest_check_account_actions(amc, imapAccount.key, true, true, false);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-  });</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+  subtest_check_account_actions(imapAccount.key, true, true, false);</span>
<a href="#l2.166"></a><span id="l2.166"> </span>
<a href="#l2.167"></a><span id="l2.167">   Services.prefs.unlockPref(disableItemPref);</span>
<a href="#l2.168"></a><span id="l2.168">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(disableItemPref);</span>
<a href="#l2.169"></a><span id="l2.169"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-deletion.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-deletion.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -4,22 +4,30 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> /**</span>
<a href="#l3.6"></a><span id="l3.6">  * This test checks proper deletion of an account from the Account manager.</span>
<a href="#l3.7"></a><span id="l3.7">  */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> &quot;use strict&quot;;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> /* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l3.13"></a><span id="l3.13"> /* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l3.15"></a><span id="l3.15"> /* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> var MODULE_NAME = &quot;test-account-deletion&quot;;</span>
<a href="#l3.18"></a><span id="l3.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+];</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28"> var gPopAccount, gImapAccount, gNntpAccount, gOriginalAccountCount;</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30"> function setupModule(module) {</span>
<a href="#l3.31"></a><span id="l3.31">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l3.32"></a><span id="l3.32">     collector.getModule(lib).installInto(module);</span>
<a href="#l3.33"></a><span id="l3.33">   }</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35" class="difflineat">@@ -53,55 +61,51 @@ function setupModule(module) {</span>
<a href="#l3.36"></a><span id="l3.36">   assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount + 2);</span>
<a href="#l3.37"></a><span id="l3.37"> }</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39"> function teardownModule(module) {</span>
<a href="#l3.40"></a><span id="l3.40">   // There should be only the original accounts left.</span>
<a href="#l3.41"></a><span id="l3.41">   assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l3.42"></a><span id="l3.42"> }</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-function test_account_data_deletion() {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-    subtest_account_data_deletion1(amc);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  });</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    subtest_account_data_deletion2(amc);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-  });</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-}</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-</span>
<a href="#l3.54"></a><span id="l3.54"> /**</span>
<a href="#l3.55"></a><span id="l3.55">  * Bug 274452</span>
<a href="#l3.56"></a><span id="l3.56">  * Check if files of an account are preserved.</span>
<a href="#l3.57"></a><span id="l3.57">  *</span>
<a href="#l3.58"></a><span id="l3.58">  * @param amc  The account options controller.</span>
<a href="#l3.59"></a><span id="l3.59">  */</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-function subtest_account_data_deletion1(amc) {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+function test_account_data_deletion1() {</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l3.63"></a><span id="l3.63">   let accountDir = gPopAccount.incomingServer.localPath;</span>
<a href="#l3.64"></a><span id="l3.64">   assert_true(accountDir.isDirectory());</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66">   // Get some existing file in the POP3 account data dir.</span>
<a href="#l3.67"></a><span id="l3.67">   let inboxFile = accountDir.clone();</span>
<a href="#l3.68"></a><span id="l3.68">   inboxFile.append(&quot;Inbox.msf&quot;);</span>
<a href="#l3.69"></a><span id="l3.69">   assert_true(inboxFile.isFile());</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-  remove_account(gPopAccount, amc, true, false);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  remove_account(gPopAccount, tab, true, false);</span>
<a href="#l3.73"></a><span id="l3.73">   assert_true(accountDir.exists());</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l3.76"></a><span id="l3.76"> }</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78"> /**</span>
<a href="#l3.79"></a><span id="l3.79">  * Bug 274452</span>
<a href="#l3.80"></a><span id="l3.80">  * Check if files of an account can be deleted.</span>
<a href="#l3.81"></a><span id="l3.81">  *</span>
<a href="#l3.82"></a><span id="l3.82">  * @param amc  The account options controller.</span>
<a href="#l3.83"></a><span id="l3.83">  */</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-function subtest_account_data_deletion2(amc) {</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+function test_account_data_deletion2() {</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l3.87"></a><span id="l3.87">   let accountDir = gImapAccount.incomingServer.localPath;</span>
<a href="#l3.88"></a><span id="l3.88">   assert_true(accountDir.isDirectory());</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90">   // Get some file in the IMAP account data dir.</span>
<a href="#l3.91"></a><span id="l3.91">   let inboxFile = accountDir.clone();</span>
<a href="#l3.92"></a><span id="l3.92">   inboxFile.append(&quot;INBOX.msf&quot;);</span>
<a href="#l3.93"></a><span id="l3.93">   assert_true(inboxFile.isFile());</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-  remove_account(gImapAccount, amc, true, true);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+  remove_account(gImapAccount, tab, true, true);</span>
<a href="#l3.97"></a><span id="l3.97">   assert_false(accountDir.exists());</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l3.100"></a><span id="l3.100"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-port-setting.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-port-setting.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,78 +1,79 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> &quot;use strict&quot;;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> /* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l4.12"></a><span id="l4.12"> /* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l4.13"></a><span id="l4.13"> /* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l4.15"></a><span id="l4.15"> /* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> var MODULE_NAME = &quot;test-account-port-setting&quot;;</span>
<a href="#l4.18"></a><span id="l4.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l4.19"></a><span id="l4.19"> var MODULE_REQUIRES = [</span>
<a href="#l4.20"></a><span id="l4.20">   &quot;folder-display-helpers&quot;,</span>
<a href="#l4.21"></a><span id="l4.21">   &quot;window-helpers&quot;,</span>
<a href="#l4.22"></a><span id="l4.22">   &quot;account-manager-helpers&quot;,</span>
<a href="#l4.23"></a><span id="l4.23">   &quot;keyboard-helpers&quot;,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l4.26"></a><span id="l4.26"> ];</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30"> var PORT_NUMBERS_TO_TEST =</span>
<a href="#l4.31"></a><span id="l4.31">   [</span>
<a href="#l4.32"></a><span id="l4.32">     &quot;110&quot;, // The original port number. We don't input this though.</span>
<a href="#l4.33"></a><span id="l4.33">     &quot;456&quot;, // Random port number.</span>
<a href="#l4.34"></a><span id="l4.34">     &quot;995&quot;, // The SSL port number.</span>
<a href="#l4.35"></a><span id="l4.35">     &quot;110&quot;, // Back to the original.</span>
<a href="#l4.36"></a><span id="l4.36">   ];</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38"> var gTestNumber;</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-function subtest_check_set_port_number(amc, aDontSet) {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+function setupModule(module) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    collector.getModule(lib).installInto(module);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  }</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+}</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+function subtest_check_set_port_number(aDontSet) {</span>
<a href="#l4.48"></a><span id="l4.48">   // This test expects the following POP account to exist by default</span>
<a href="#l4.49"></a><span id="l4.49">   // with port number 110 and no security.</span>
<a href="#l4.50"></a><span id="l4.50">   let server = MailServices.accounts</span>
<a href="#l4.51"></a><span id="l4.51">                            .FindServer(&quot;tinderbox&quot;, FAKE_SERVER_HOSTNAME, &quot;pop3&quot;);</span>
<a href="#l4.52"></a><span id="l4.52">   let account = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  let accountRow = get_account_tree_row(account.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  let accountRow = get_account_tree_row(account.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l4.62"></a><span id="l4.62">   let portElem = iframe.contentDocument.getElementById(&quot;server.port&quot;);</span>
<a href="#l4.63"></a><span id="l4.63">   portElem.focus();</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">   if (portElem.value != PORT_NUMBERS_TO_TEST[gTestNumber - 1])</span>
<a href="#l4.66"></a><span id="l4.66">     throw new Error(&quot;Port Value is not &quot; +</span>
<a href="#l4.67"></a><span id="l4.67">                     PORT_NUMBERS_TO_TEST[gTestNumber - 1] +</span>
<a href="#l4.68"></a><span id="l4.68">                     &quot; as expected, it is: &quot; + portElem.value);</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70">   if (!aDontSet) {</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    delete_all_existing(amc, new elib.Elem(portElem));</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    input_value(amc, PORT_NUMBERS_TO_TEST[gTestNumber]);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    delete_all_existing(mc, new elib.Elem(portElem));</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+    input_value(mc, PORT_NUMBERS_TO_TEST[gTestNumber]);</span>
<a href="#l4.75"></a><span id="l4.75"> </span>
<a href="#l4.76"></a><span id="l4.76">     mc.sleep(0);</span>
<a href="#l4.77"></a><span id="l4.77">   }</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-  mc.click(new elib.Elem(amc.window.document.getElementById(&quot;accountManager&quot;).getButton(&quot;accept&quot;)));</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-}</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-function subtest_check_port_number(amc) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-  subtest_check_set_port_number(amc, true);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-}</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-function setupModule(module) {</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-    collector.getModule(lib).installInto(module);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-  }</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l4.91"></a><span id="l4.91"> }</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93"> function test_account_port_setting() {</span>
<a href="#l4.94"></a><span id="l4.94">   for (gTestNumber = 1; gTestNumber &lt; PORT_NUMBERS_TO_TEST.length; ++gTestNumber) {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    open_advanced_settings(subtest_check_set_port_number);</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+    subtest_check_set_port_number(false);</span>
<a href="#l4.97"></a><span id="l4.97">   }</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-  open_advanced_settings(subtest_check_port_number);</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  subtest_check_set_port_number(true);</span>
<a href="#l4.101"></a><span id="l4.101"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-settings-infrastructure.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-settings-infrastructure.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -8,31 +8,39 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * panes are switched.</span>
<a href="#l5.5"></a><span id="l5.5">  *</span>
<a href="#l5.6"></a><span id="l5.6">  * New checks can be added to it as needed.</span>
<a href="#l5.7"></a><span id="l5.7">  */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> &quot;use strict&quot;;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> /* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l5.13"></a><span id="l5.13"> /* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l5.15"></a><span id="l5.15"> /* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> var MODULE_NAME = &quot;test-account-settings-infrastructure&quot;;</span>
<a href="#l5.18"></a><span id="l5.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+];</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30"> var gPopAccount, gImapAccount, gOriginalAccountCount;</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32"> function setupModule(module) {</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-  collector.getModule(&quot;account-manager-helpers&quot;).installInto(module);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+    collector.getModule(lib).installInto(module);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  }</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   // There may be pre-existing accounts from other tests.</span>
<a href="#l5.41"></a><span id="l5.41">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">   // Create a POP server</span>
<a href="#l5.44"></a><span id="l5.44">   let popServer = MailServices.accounts</span>
<a href="#l5.45"></a><span id="l5.45">     .createIncomingServer(&quot;nobody&quot;, &quot;pop.invalid&quot;, &quot;pop3&quot;)</span>
<a href="#l5.46"></a><span id="l5.46">     .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineat">@@ -68,151 +76,133 @@ function teardownModule(module) {</span>
<a href="#l5.48"></a><span id="l5.48">   // There should be only the original accounts left.</span>
<a href="#l5.49"></a><span id="l5.49">   assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l5.50"></a><span id="l5.50"> }</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52"> /**</span>
<a href="#l5.53"></a><span id="l5.53">  * Bug 525024.</span>
<a href="#l5.54"></a><span id="l5.54">  * Check that the options in the server pane are properly preserved across</span>
<a href="#l5.55"></a><span id="l5.55">  * pane switches.</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">- */</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-function test_account_dot_IDs() {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-    subtest_check_account_dot_IDs(amc);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-  });</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-}</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-/**</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+ *</span>
<a href="#l5.65"></a><span id="l5.65">  * Check that the options in the server pane are stored even if the id</span>
<a href="#l5.66"></a><span id="l5.66">  * of the element contains multiple dots (not used in standard TB yet</span>
<a href="#l5.67"></a><span id="l5.67">  * but extensions may want it).</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">- *</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l5.70"></a><span id="l5.70">  */</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-function subtest_check_account_dot_IDs(amc) {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+function test_account_dot_IDs() {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-  let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.81"></a><span id="l5.81">   // Check whether a standard element with &quot;server.loginAtStartUp&quot; stores its</span>
<a href="#l5.82"></a><span id="l5.82">   // value properly.</span>
<a href="#l5.83"></a><span id="l5.83">   let loginCheck = iframe.getElementById(&quot;server.loginAtStartUp&quot;);</span>
<a href="#l5.84"></a><span id="l5.84">   assert_false(loginCheck.checked);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-  amc.check(new elib.Elem(loginCheck), true);</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  mc.check(new elib.Elem(loginCheck), true);</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l5.99"></a><span id="l5.99">   // (uses loadURI to load a new document).</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-  iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  iframe = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.102"></a><span id="l5.102"> </span>
<a href="#l5.103"></a><span id="l5.103">   // Check by element properties.</span>
<a href="#l5.104"></a><span id="l5.104">   loginCheck = iframe.getElementById(&quot;server.loginAtStartUp&quot;);</span>
<a href="#l5.105"></a><span id="l5.105">   assert_true(loginCheck.checked);</span>
<a href="#l5.106"></a><span id="l5.106"> </span>
<a href="#l5.107"></a><span id="l5.107">   // Check for correct value in the accountValues array, that will be saved into prefs.</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-  let rawCheckValue = amc.window.getAccountValue(gPopAccount,</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-                                                 amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-                                                 &quot;server&quot;, &quot;loginAtStartUp&quot;,</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-                                                 null, false);</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  let rawCheckValue = tab.browser.contentWindow.getAccountValue(gPopAccount,</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+                        tab.browser.contentWindow.getValueArrayFor(gPopAccount),</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+                        &quot;server&quot;, &quot;loginAtStartUp&quot;,</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+                        null, false);</span>
<a href="#l5.116"></a><span id="l5.116"> </span>
<a href="#l5.117"></a><span id="l5.117">   assert_true(rawCheckValue);</span>
<a href="#l5.118"></a><span id="l5.118"> </span>
<a href="#l5.119"></a><span id="l5.119">   // The &quot;server.login.At.StartUp&quot; value does not exist yet, so the value should be 'null'.</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-  rawCheckValue = amc.window.getAccountValue(gPopAccount,</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-                                             amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-                                             &quot;server&quot;, &quot;login.At.StartUp&quot;,</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-                                             null, false);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+  rawCheckValue = tab.browser.contentWindow.getAccountValue(gPopAccount,</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+                    tab.browser.contentWindow.getValueArrayFor(gPopAccount),</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+                    &quot;server&quot;, &quot;login.At.StartUp&quot;,</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+                    null, false);</span>
<a href="#l5.128"></a><span id="l5.128">   assert_equals(rawCheckValue, null);</span>
<a href="#l5.129"></a><span id="l5.129"> </span>
<a href="#l5.130"></a><span id="l5.130">   // Change the ID so that &quot;server.login.At.StartUp&quot; exists now.</span>
<a href="#l5.131"></a><span id="l5.131">   loginCheck.id = &quot;server.login.At.StartUp&quot;;</span>
<a href="#l5.132"></a><span id="l5.132"> </span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.137"></a><span id="l5.137"> </span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.142"></a><span id="l5.142"> </span>
<a href="#l5.143"></a><span id="l5.143">   // Check for correct value in the accountValues array, that will be saved into prefs.</span>
<a href="#l5.144"></a><span id="l5.144">   // We can't check by element property here, because the am-server.xul pane was</span>
<a href="#l5.145"></a><span id="l5.145">   // reloaded and the element now has the original ID of &quot;server.loginAtStartUp&quot;.</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-  rawCheckValue = amc.window.getAccountValue(gPopAccount,</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-                                             amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-                                             &quot;server&quot;, &quot;login.At.StartUp&quot;,</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-                                             null, false);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+  rawCheckValue = tab.browser.contentWindow.getAccountValue(gPopAccount,</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+                    tab.browser.contentWindow.getValueArrayFor(gPopAccount),</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+                    &quot;server&quot;, &quot;login.At.StartUp&quot;,</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+                    null, false);</span>
<a href="#l5.154"></a><span id="l5.154"> </span>
<a href="#l5.155"></a><span id="l5.155">   assert_true(rawCheckValue);</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l5.158"></a><span id="l5.158"> }</span>
<a href="#l5.159"></a><span id="l5.159"> </span>
<a href="#l5.160"></a><span id="l5.160"> /**</span>
<a href="#l5.161"></a><span id="l5.161">  * Test for bug 807101.</span>
<a href="#l5.162"></a><span id="l5.162">  * Check if form controls are properly disabled when their attached prefs are locked.</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">- */</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-function test_account_locked_prefs() {</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-    subtest_check_locked_prefs_addressing(amc);</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-  });</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-    subtest_check_locked_prefs_server(amc);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-  });</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-}</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-/**</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+ *</span>
<a href="#l5.176"></a><span id="l5.176">  * Check that the LDAP server selection elements (radio group) are properly</span>
<a href="#l5.177"></a><span id="l5.177">  * disabled when their attached pref (prefstring attribute) is locked.</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">- *</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l5.180"></a><span id="l5.180">  */</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-function subtest_check_locked_prefs_addressing(amc) {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-addressing.xul&quot;, amc);</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+function test_locked_prefs_addressing() {</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-addressing.xul&quot;, tab);</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.188"></a><span id="l5.188"> </span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-  let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.191"></a><span id="l5.191"> </span>
<a href="#l5.192"></a><span id="l5.192">   // By default, 'use global LDAP server preferences' is set, not the</span>
<a href="#l5.193"></a><span id="l5.193">   // 'different LDAP server'.</span>
<a href="#l5.194"></a><span id="l5.194">   let useLDAPdirectory = iframe.getElementById(&quot;directories&quot;);</span>
<a href="#l5.195"></a><span id="l5.195">   assert_false(useLDAPdirectory.selected);</span>
<a href="#l5.196"></a><span id="l5.196"> </span>
<a href="#l5.197"></a><span id="l5.197">   // So the server selector is disabled.</span>
<a href="#l5.198"></a><span id="l5.198">   let LDAPdirectory = iframe.getElementById(&quot;identity.directoryServer&quot;);</span>
<a href="#l5.199"></a><span id="l5.199">   assert_true(LDAPdirectory.disabled);</span>
<a href="#l5.200"></a><span id="l5.200"> </span>
<a href="#l5.201"></a><span id="l5.201">   // And the Edit button too.</span>
<a href="#l5.202"></a><span id="l5.202">   let LDAPeditButton = iframe.getElementById(&quot;editButton&quot;);</span>
<a href="#l5.203"></a><span id="l5.203">   assert_true(LDAPeditButton.disabled);</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205">   // Now toggle the 'different LDAP server' on. The server selector</span>
<a href="#l5.206"></a><span id="l5.206">   // and edit button should enable.</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-  amc.radio(new elib.Elem(useLDAPdirectory));</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+  mc.radio(new elib.Elem(useLDAPdirectory));</span>
<a href="#l5.209"></a><span id="l5.209">   assert_false(LDAPdirectory.disabled);</span>
<a href="#l5.210"></a><span id="l5.210">   assert_false(LDAPeditButton.disabled);</span>
<a href="#l5.211"></a><span id="l5.211"> </span>
<a href="#l5.212"></a><span id="l5.212">   // Lock the pref for the server selector.</span>
<a href="#l5.213"></a><span id="l5.213">   let prefstring = LDAPdirectory.getAttribute(&quot;prefstring&quot;);</span>
<a href="#l5.214"></a><span id="l5.214">   let controlPref = prefstring.replace(&quot;%identitykey%&quot;, gPopAccount.defaultIdentity.key);</span>
<a href="#l5.215"></a><span id="l5.215">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(controlPref, &quot;xxx&quot;);</span>
<a href="#l5.216"></a><span id="l5.216">   Services.prefs.lockPref(controlPref);</span>
<a href="#l5.217"></a><span id="l5.217"> </span>
<a href="#l5.218"></a><span id="l5.218">   // Refresh the pane by switching to another one.</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.223"></a><span id="l5.223"> </span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-addressing.xul&quot;, amc);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-addressing.xul&quot;, tab);</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.228"></a><span id="l5.228"> </span>
<a href="#l5.229"></a><span id="l5.229">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l5.230"></a><span id="l5.230">   // (uses loadURI to load a new document).</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-  iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+  iframe = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.233"></a><span id="l5.233"> </span>
<a href="#l5.234"></a><span id="l5.234">   // We are now back and the 'different LDAP server' should still be selected</span>
<a href="#l5.235"></a><span id="l5.235">   // (the setting was saved).</span>
<a href="#l5.236"></a><span id="l5.236">   useLDAPdirectory = iframe.getElementById(&quot;directories&quot;);</span>
<a href="#l5.237"></a><span id="l5.237">   assert_true(useLDAPdirectory.selected);</span>
<a href="#l5.238"></a><span id="l5.238"> </span>
<a href="#l5.239"></a><span id="l5.239">   // But now the server selector should be disabled due to locked pref.</span>
<a href="#l5.240"></a><span id="l5.240">   LDAPdirectory = iframe.getElementById(&quot;identity.directoryServer&quot;);</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineat">@@ -220,72 +210,76 @@ function subtest_check_locked_prefs_addr</span>
<a href="#l5.242"></a><span id="l5.242"> </span>
<a href="#l5.243"></a><span id="l5.243">   // The edit button still enabled (does not depend on the same pref lock)</span>
<a href="#l5.244"></a><span id="l5.244">   LDAPeditButton = iframe.getElementById(&quot;editButton&quot;);</span>
<a href="#l5.245"></a><span id="l5.245">   assert_false(LDAPeditButton.disabled);</span>
<a href="#l5.246"></a><span id="l5.246"> </span>
<a href="#l5.247"></a><span id="l5.247">   // Unlock the pref to clean up.</span>
<a href="#l5.248"></a><span id="l5.248">   Services.prefs.unlockPref(controlPref);</span>
<a href="#l5.249"></a><span id="l5.249">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(controlPref);</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l5.252"></a><span id="l5.252"> }</span>
<a href="#l5.253"></a><span id="l5.253"> </span>
<a href="#l5.254"></a><span id="l5.254"> /**</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+ * Test for bug 807101.</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+ * Check if form controls are properly disabled when their attached prefs are locked.</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+ *</span>
<a href="#l5.258"></a><span id="l5.258">  * Check that the POP3 'keep on server' settings elements (2-level</span>
<a href="#l5.259"></a><span id="l5.259">  * checkboxes + textbox) are properly disabled when their attached pref</span>
<a href="#l5.260"></a><span id="l5.260">  * (prefstring attribute) is locked.</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">- *</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l5.263"></a><span id="l5.263">  */</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-function subtest_check_locked_prefs_server(amc) {</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+function test_locked_prefs_server() {</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.271"></a><span id="l5.271"> </span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-  let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.274"></a><span id="l5.274"> </span>
<a href="#l5.275"></a><span id="l5.275">   // Top level leaveOnServer checkbox, disabled by default.</span>
<a href="#l5.276"></a><span id="l5.276">   let leaveOnServer = iframe.getElementById(&quot;pop3.leaveMessagesOnServer&quot;);</span>
<a href="#l5.277"></a><span id="l5.277">   assert_false(leaveOnServer.disabled);</span>
<a href="#l5.278"></a><span id="l5.278">   assert_false(leaveOnServer.checked);</span>
<a href="#l5.279"></a><span id="l5.279"> </span>
<a href="#l5.280"></a><span id="l5.280">   // Second level deleteByAge checkbox, disabled by default.</span>
<a href="#l5.281"></a><span id="l5.281">   let deleteByAge = iframe.getElementById(&quot;pop3.deleteByAgeFromServer&quot;);</span>
<a href="#l5.282"></a><span id="l5.282">   assert_true(deleteByAge.disabled);</span>
<a href="#l5.283"></a><span id="l5.283">   assert_false(deleteByAge.checked);</span>
<a href="#l5.284"></a><span id="l5.284"> </span>
<a href="#l5.285"></a><span id="l5.285">   // Third level daysToLeave textbox, disabled by default.</span>
<a href="#l5.286"></a><span id="l5.286">   let daysToLeave = iframe.getElementById(&quot;pop3.numDaysToLeaveOnServer&quot;);</span>
<a href="#l5.287"></a><span id="l5.287">   assert_true(daysToLeave.disabled);</span>
<a href="#l5.288"></a><span id="l5.288"> </span>
<a href="#l5.289"></a><span id="l5.289">   // When leaveOnServer is checked, only deleteByAge will get enabled.</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-  amc.check(new elib.Elem(leaveOnServer), true);</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+  mc.check(new elib.Elem(leaveOnServer), true);</span>
<a href="#l5.292"></a><span id="l5.292">   assert_true(leaveOnServer.checked);</span>
<a href="#l5.293"></a><span id="l5.293">   assert_false(deleteByAge.disabled);</span>
<a href="#l5.294"></a><span id="l5.294">   assert_true(daysToLeave.disabled);</span>
<a href="#l5.295"></a><span id="l5.295"> </span>
<a href="#l5.296"></a><span id="l5.296">   // When deleteByAge is checked, daysToLeave will get enabled.</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-  amc.check(new elib.Elem(deleteByAge), true);</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+  mc.check(new elib.Elem(deleteByAge), true);</span>
<a href="#l5.299"></a><span id="l5.299">   assert_true(deleteByAge.checked);</span>
<a href="#l5.300"></a><span id="l5.300">   assert_false(daysToLeave.disabled);</span>
<a href="#l5.301"></a><span id="l5.301"> </span>
<a href="#l5.302"></a><span id="l5.302">   // Lock the pref deleteByAge checkbox (middle of the element hierarchy).</span>
<a href="#l5.303"></a><span id="l5.303">   let prefstring = deleteByAge.getAttribute(&quot;prefstring&quot;);</span>
<a href="#l5.304"></a><span id="l5.304">   let controlPref = prefstring.replace(&quot;%serverkey%&quot;, gPopAccount.incomingServer.key);</span>
<a href="#l5.305"></a><span id="l5.305">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(controlPref, true);</span>
<a href="#l5.306"></a><span id="l5.306">   Services.prefs.lockPref(controlPref);</span>
<a href="#l5.307"></a><span id="l5.307"> </span>
<a href="#l5.308"></a><span id="l5.308">   // Refresh the pane by switching to another one.</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.313"></a><span id="l5.313"> </span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.318"></a><span id="l5.318"> </span>
<a href="#l5.319"></a><span id="l5.319">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l5.320"></a><span id="l5.320">   // (uses loadURI to load a new document).</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-  iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+  iframe = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.323"></a><span id="l5.323"> </span>
<a href="#l5.324"></a><span id="l5.324">   // Now leaveOnServer was preserved as checked.</span>
<a href="#l5.325"></a><span id="l5.325">   leaveOnServer = iframe.getElementById(&quot;pop3.leaveMessagesOnServer&quot;);</span>
<a href="#l5.326"></a><span id="l5.326">   assert_false(leaveOnServer.disabled);</span>
<a href="#l5.327"></a><span id="l5.327">   assert_true(leaveOnServer.checked);</span>
<a href="#l5.328"></a><span id="l5.328"> </span>
<a href="#l5.329"></a><span id="l5.329">   // Now deleteByAge was preserved as checked but is locked/disabled.</span>
<a href="#l5.330"></a><span id="l5.330">   deleteByAge = iframe.getElementById(&quot;pop3.deleteByAgeFromServer&quot;);</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineat">@@ -293,114 +287,101 @@ function subtest_check_locked_prefs_serv</span>
<a href="#l5.332"></a><span id="l5.332">   assert_true(deleteByAge.checked);</span>
<a href="#l5.333"></a><span id="l5.333"> </span>
<a href="#l5.334"></a><span id="l5.334">   // Because deleteByAge is checked, daysToLeave should be enabled.</span>
<a href="#l5.335"></a><span id="l5.335">   daysToLeave = iframe.getElementById(&quot;pop3.numDaysToLeaveOnServer&quot;);</span>
<a href="#l5.336"></a><span id="l5.336">   assert_false(daysToLeave.disabled);</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338">   // When leaveOnserver is unchecked, both of deleteByAge and daysToLeave</span>
<a href="#l5.339"></a><span id="l5.339">   // should get disabled.</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-  amc.check(new elib.Elem(leaveOnServer), false);</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+  mc.check(new elib.Elem(leaveOnServer), false);</span>
<a href="#l5.342"></a><span id="l5.342">   assert_false(leaveOnServer.disabled);</span>
<a href="#l5.343"></a><span id="l5.343">   assert_false(leaveOnServer.checked);</span>
<a href="#l5.344"></a><span id="l5.344"> </span>
<a href="#l5.345"></a><span id="l5.345">   assert_true(deleteByAge.disabled);</span>
<a href="#l5.346"></a><span id="l5.346">   assert_true(deleteByAge.checked);</span>
<a href="#l5.347"></a><span id="l5.347">   assert_true(daysToLeave.disabled);</span>
<a href="#l5.348"></a><span id="l5.348"> </span>
<a href="#l5.349"></a><span id="l5.349">   // Unlock the pref to clean up.</span>
<a href="#l5.350"></a><span id="l5.350">   Services.prefs.unlockPref(controlPref);</span>
<a href="#l5.351"></a><span id="l5.351">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(controlPref);</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l5.354"></a><span id="l5.354"> }</span>
<a href="#l5.355"></a><span id="l5.355"> </span>
<a href="#l5.356"></a><span id="l5.356"> /**</span>
<a href="#l5.357"></a><span id="l5.357">  * Bug 530142.</span>
<a href="#l5.358"></a><span id="l5.358">  * Check that that if one field is set to a value, switching directly to another</span>
<a href="#l5.359"></a><span id="l5.359">  * account pane showing the same field really loads the value from the new account,</span>
<a href="#l5.360"></a><span id="l5.360">  * even when empty. This is tested on the Reply-To field.</span>
<a href="#l5.361"></a><span id="l5.361">  */</span>
<a href="#l5.362"></a><span id="l5.362"> function test_replyTo_leak() {</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-    subtest_check_replyTo_leak(amc);</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineminus">-  });</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-}</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, null, tab);</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.370"></a><span id="l5.370"> </span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-/**</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">- */</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-function subtest_check_replyTo_leak(amc) {</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l5.380"></a><span id="l5.380"> </span>
<a href="#l5.381"></a><span id="l5.381">   // The Reply-To field should be empty.</span>
<a href="#l5.382"></a><span id="l5.382">   let replyAddress = iframe.contentDocument.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l5.383"></a><span id="l5.383">   assert_equals(replyAddress.value, &quot;&quot;);</span>
<a href="#l5.384"></a><span id="l5.384"> </span>
<a href="#l5.385"></a><span id="l5.385">   // Now we set a value into it and switch to another account, the main pane.</span>
<a href="#l5.386"></a><span id="l5.386">   replyAddress.value = &quot;somewhere@else.com&quot;;</span>
<a href="#l5.387"></a><span id="l5.387"> </span>
<a href="#l5.388"></a><span id="l5.388">   // This test expects the following POP account to exist by default</span>
<a href="#l5.389"></a><span id="l5.389">   // in the test profile with port number 110 and no security.</span>
<a href="#l5.390"></a><span id="l5.390">   let firstServer = MailServices.accounts</span>
<a href="#l5.391"></a><span id="l5.391">                                 .FindServer(&quot;tinderbox&quot;, FAKE_SERVER_HOSTNAME, &quot;pop3&quot;);</span>
<a href="#l5.392"></a><span id="l5.392">   let firstAccount = MailServices.accounts.FindAccountForServer(firstServer);</span>
<a href="#l5.393"></a><span id="l5.393"> </span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-  accountRow = get_account_tree_row(firstAccount.key, null, amc);</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+  accountRow = get_account_tree_row(firstAccount.key, null, tab);</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.398"></a><span id="l5.398"> </span>
<a href="#l5.399"></a><span id="l5.399">   // the Reply-To field should be empty as this account does not have it set.</span>
<a href="#l5.400"></a><span id="l5.400">   replyAddress = iframe.contentDocument.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l5.401"></a><span id="l5.401">   assert_equals(replyAddress.value, &quot;&quot;);</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l5.404"></a><span id="l5.404"> }</span>
<a href="#l5.405"></a><span id="l5.405"> </span>
<a href="#l5.406"></a><span id="l5.406"> /**</span>
<a href="#l5.407"></a><span id="l5.407">  * Test for bug 804091.</span>
<a href="#l5.408"></a><span id="l5.408">  * Check if onchange handlers are properly executed when panes are switched.</span>
<a href="#l5.409"></a><span id="l5.409">  */</span>
<a href="#l5.410"></a><span id="l5.410"> function test_account_onchange_handler() {</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-    subtest_check_onchange_handler(amc);</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-  });</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-}</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+  let accountRow = get_account_tree_row(gImapAccount.key, &quot;am-offline.xul&quot;, tab);</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.418"></a><span id="l5.418"> </span>
<a href="#l5.419"></a><span id="l5.419" class="difflineminus">-/**</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineminus">- * Check if onchange handlers are properly executed when panes are switched.</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineminus">- *</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineminus">- */</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-function subtest_check_onchange_handler(amc) {</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-  let accountRow = get_account_tree_row(gImapAccount.key, &quot;am-offline.xul&quot;, amc);</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-  let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.430"></a><span id="l5.430"> </span>
<a href="#l5.431"></a><span id="l5.431">   let autoSync = iframe.getElementById(&quot;autosyncValue&quot;);</span>
<a href="#l5.432"></a><span id="l5.432">   // 30 is the default value so check if we are in clean state.</span>
<a href="#l5.433"></a><span id="l5.433">   assert_equals(autoSync.value, 30);</span>
<a href="#l5.434"></a><span id="l5.434"> </span>
<a href="#l5.435"></a><span id="l5.435">   let autoSyncInterval = iframe.getElementById(&quot;autosyncInterval&quot;);</span>
<a href="#l5.436"></a><span id="l5.436">   // 1 is the default value and means the 30 is in days.</span>
<a href="#l5.437"></a><span id="l5.437">   assert_equals(autoSyncInterval.value, 1);</span>
<a href="#l5.438"></a><span id="l5.438"> </span>
<a href="#l5.439"></a><span id="l5.439">   // Now type in 35 (days).</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineminus">-  amc.radio(new elib.ID(iframe, &quot;useAutosync.ByAge&quot;));</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+  mc.radio(new elib.ID(iframe, &quot;useAutosync.ByAge&quot;));</span>
<a href="#l5.442"></a><span id="l5.442">   autoSync.select();</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-  amc.type(new elib.Elem(autoSync), &quot;35&quot;);</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+  mc.type(new elib.Elem(autoSync), &quot;35&quot;);</span>
<a href="#l5.445"></a><span id="l5.445"> </span>
<a href="#l5.446"></a><span id="l5.446">   // Immediately switch to another pane and back.</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-  accountRow = get_account_tree_row(gImapAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+  accountRow = get_account_tree_row(gImapAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.451"></a><span id="l5.451"> </span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-  accountRow = get_account_tree_row(gImapAccount.key, &quot;am-offline.xul&quot;, amc);</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+  accountRow = get_account_tree_row(gImapAccount.key, &quot;am-offline.xul&quot;, tab);</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l5.456"></a><span id="l5.456"> </span>
<a href="#l5.457"></a><span id="l5.457" class="difflineminus">-  iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+  iframe = content_tab_e(tab, &quot;contentFrame&quot;).contentDocument;</span>
<a href="#l5.459"></a><span id="l5.459"> </span>
<a href="#l5.460"></a><span id="l5.460">   // The pane optimized the entered value a bit. So now we should find 5.</span>
<a href="#l5.461"></a><span id="l5.461">   autoSync = iframe.getElementById(&quot;autosyncValue&quot;);</span>
<a href="#l5.462"></a><span id="l5.462">   assert_equals(autoSync.value, 5);</span>
<a href="#l5.463"></a><span id="l5.463"> </span>
<a href="#l5.464"></a><span id="l5.464">   // And the unit is 7 days = week.</span>
<a href="#l5.465"></a><span id="l5.465">   autoSyncInterval = iframe.getElementById(&quot;autosyncInterval&quot;);</span>
<a href="#l5.466"></a><span id="l5.466">   assert_equals(autoSyncInterval.value, 7);</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l5.468"></a><span id="l5.468"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-tree.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-tree.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,29 +4,37 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> /**</span>
<a href="#l6.6"></a><span id="l6.6">  * This test checks proper operation of the account tree in the Account manager.</span>
<a href="#l6.7"></a><span id="l6.7">  */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> &quot;use strict&quot;;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> /* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l6.13"></a><span id="l6.13"> /* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l6.15"></a><span id="l6.15"> /* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> var MODULE_NAME = &quot;test-account-tree&quot;;</span>
<a href="#l6.18"></a><span id="l6.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+];</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> function setupModule(module) {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  collector.getModule(&quot;account-manager-helpers&quot;).installInto(module);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+    collector.getModule(lib).installInto(module);</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  }</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   // There may be pre-existing accounts from other tests.</span>
<a href="#l6.39"></a><span id="l6.39">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">   // Create a POP server</span>
<a href="#l6.42"></a><span id="l6.42">   let popServer = MailServices.accounts</span>
<a href="#l6.43"></a><span id="l6.43">     .createIncomingServer(&quot;nobody&quot;, &quot;foo.invalid&quot;, &quot;pop3&quot;)</span>
<a href="#l6.44"></a><span id="l6.44">     .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineat">@@ -49,131 +57,114 @@ function teardownModule(module) {</span>
<a href="#l6.46"></a><span id="l6.46">   assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l6.47"></a><span id="l6.47"> }</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49"> /**</span>
<a href="#l6.50"></a><span id="l6.50">  * Test for bug 536248.</span>
<a href="#l6.51"></a><span id="l6.51">  * Check if the account manager dialog remembers the open state of accounts.</span>
<a href="#l6.52"></a><span id="l6.52">  */</span>
<a href="#l6.53"></a><span id="l6.53"> function test_account_open_state() {</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-    subtest_check_account_open_state(amc, true);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  });</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    subtest_check_account_open_state(amc, false);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-  });</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  subtest_check_account_open_state(true);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  subtest_check_account_open_state(false);</span>
<a href="#l6.63"></a><span id="l6.63">   // After this test all the accounts must be &quot;open&quot;.</span>
<a href="#l6.64"></a><span id="l6.64"> }</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66"> /**</span>
<a href="#l6.67"></a><span id="l6.67">  * Check if the open state of accounts is in the wished state.</span>
<a href="#l6.68"></a><span id="l6.68">  *</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">- * @param amc           The account options controller.</span>
<a href="#l6.70"></a><span id="l6.70">  * @param aWishedState  The open state in which the account row should be found (bool).</span>
<a href="#l6.71"></a><span id="l6.71">  */</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-function subtest_check_account_open_state(amc, aWishedState) {</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+function subtest_check_account_open_state(aWishedState) {</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, null, tab);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80">   // See if the account row is in the wished open state.</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  let accountTree = content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l6.83"></a><span id="l6.83">   assert_equals(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l6.84"></a><span id="l6.84">   assert_equals(accountTree.view.isContainerOpen(accountRow), aWishedState);</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86">   accountTree.view.toggleOpenState(accountRow);</span>
<a href="#l6.87"></a><span id="l6.87">   assert_equals(accountTree.view.isContainerOpen(accountRow), !aWishedState);</span>
<a href="#l6.88"></a><span id="l6.88"> </span>
<a href="#l6.89"></a><span id="l6.89">   // Whatever the open state of the account was, selecting one of its subpanes</span>
<a href="#l6.90"></a><span id="l6.90">   // must open it.</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-  amc.window.selectServer(gPopAccount.incomingServer, &quot;am-junk.xul&quot;);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+  tab.browser.contentWindow.selectServer(gPopAccount.incomingServer, &quot;am-junk.xul&quot;);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  wait_for_account_tree_selection(tab);</span>
<a href="#l6.94"></a><span id="l6.94">   assert_true(accountTree.view.isContainerOpen(accountRow));</span>
<a href="#l6.95"></a><span id="l6.95"> </span>
<a href="#l6.96"></a><span id="l6.96">   // Set the proper state again for continuation of the test.</span>
<a href="#l6.97"></a><span id="l6.97">   accountTree.view.getItemAtIndex(accountRow).setAttribute(&quot;open&quot;, !aWishedState);</span>
<a href="#l6.98"></a><span id="l6.98">   assert_equals(accountTree.view.isContainerOpen(accountRow), !aWishedState);</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l6.100"></a><span id="l6.100"> }</span>
<a href="#l6.101"></a><span id="l6.101"> </span>
<a href="#l6.102"></a><span id="l6.102"> /**</span>
<a href="#l6.103"></a><span id="l6.103">  * Bug 740617.</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">- * Check if the default account is styled in bold.</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">- *</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+ * Check if the default account is styled in bold and another account is not.</span>
<a href="#l6.107"></a><span id="l6.107">  */</span>
<a href="#l6.108"></a><span id="l6.108"> function test_default_account_highlight() {</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-    subtest_check_default_account_highlight(amc);</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-  });</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-}</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  // Select the default account.</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+  let accountRow = get_account_tree_row(MailServices.accounts.defaultAccount.key, null, tab);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-/**</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">- * Check if the default account is styled in bold and another account is not.</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">- *</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">- * @param amc           The account options controller.</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">- */</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-function subtest_check_default_account_highlight(amc) {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-  // Select the default account.</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-  let accountRow = get_account_tree_row(MailServices.accounts.defaultAccount.key, null, amc);</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-  let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  let accountTree = content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l6.130"></a><span id="l6.130">   assert_equals(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l6.131"></a><span id="l6.131">   let cell = accountTree.view.getItemAtIndex(accountRow).firstChild.firstChild;</span>
<a href="#l6.132"></a><span id="l6.132">   assert_equals(cell.tagName, &quot;treecell&quot;);</span>
<a href="#l6.133"></a><span id="l6.133"> </span>
<a href="#l6.134"></a><span id="l6.134">   // We can't read the computed style of the tree cell directly, so at least see</span>
<a href="#l6.135"></a><span id="l6.135">   // if the isDefaultServer-true property is set on it. Hopefully the proper style</span>
<a href="#l6.136"></a><span id="l6.136">   // is attached to this property.</span>
<a href="#l6.137"></a><span id="l6.137">   let propArray = accountTree.view</span>
<a href="#l6.138"></a><span id="l6.138">     .getCellProperties(accountRow, accountTree.columns.getColumnAt(0)).split(&quot; &quot;);</span>
<a href="#l6.139"></a><span id="l6.139">   assert_true(propArray.includes(&quot;isDefaultServer-true&quot;));</span>
<a href="#l6.140"></a><span id="l6.140"> </span>
<a href="#l6.141"></a><span id="l6.141">   // Now select another account that is not default.</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, null, tab);</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l6.146"></a><span id="l6.146"> </span>
<a href="#l6.147"></a><span id="l6.147">   // There should isDefaultServer-true on its tree cell.</span>
<a href="#l6.148"></a><span id="l6.148">   propArray = accountTree.view</span>
<a href="#l6.149"></a><span id="l6.149">     .getCellProperties(accountRow, accountTree.columns.getColumnAt(0)).split(&quot; &quot;);</span>
<a href="#l6.150"></a><span id="l6.150">   assert_false(propArray.includes(&quot;isDefaultServer-true&quot;));</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l6.152"></a><span id="l6.152"> }</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+</span>
<a href="#l6.154"></a><span id="l6.154"> /**</span>
<a href="#l6.155"></a><span id="l6.155">  * Bug 58713.</span>
<a href="#l6.156"></a><span id="l6.156">  * Check if after deleting an account the next one is selected.</span>
<a href="#l6.157"></a><span id="l6.157">  *</span>
<a href="#l6.158"></a><span id="l6.158">  * This test should always be the last one as it removes our specially</span>
<a href="#l6.159"></a><span id="l6.159">  * created gPopAccount.</span>
<a href="#l6.160"></a><span id="l6.160">  */</span>
<a href="#l6.161"></a><span id="l6.161"> function test_selection_after_account_deletion() {</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-    subtest_check_selection_after_account_deletion(amc);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-  });</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-}</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-/**</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">- * Check if after deleting an account the next one is selected.</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">- *</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">- * @param amc           The account options controller.</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">- */</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-function subtest_check_selection_after_account_deletion(amc) {</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l6.174"></a><span id="l6.174">   let accountList = [];</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-  let accountTreeNode = amc.e(&quot;account-tree-children&quot;);</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+  let accountTreeNode = content_tab_e(tab, &quot;account-tree-children&quot;);</span>
<a href="#l6.177"></a><span id="l6.177">   // Build the list of accounts in the account tree (order is important).</span>
<a href="#l6.178"></a><span id="l6.178">   for (let i = 0; i &lt; accountTreeNode.childNodes.length; i++) {</span>
<a href="#l6.179"></a><span id="l6.179">     if (&quot;_account&quot; in accountTreeNode.childNodes[i]) {</span>
<a href="#l6.180"></a><span id="l6.180">       let curAccount = accountTreeNode.childNodes[i]._account;</span>
<a href="#l6.181"></a><span id="l6.181">       if (!accountList.includes(curAccount))</span>
<a href="#l6.182"></a><span id="l6.182">         accountList.push(curAccount);</span>
<a href="#l6.183"></a><span id="l6.183">     }</span>
<a href="#l6.184"></a><span id="l6.184">   }</span>
<a href="#l6.185"></a><span id="l6.185"> </span>
<a href="#l6.186"></a><span id="l6.186">   // Get position of the current account in the account list.</span>
<a href="#l6.187"></a><span id="l6.187">   let accountIndex = accountList.indexOf(gPopAccount);</span>
<a href="#l6.188"></a><span id="l6.188"> </span>
<a href="#l6.189"></a><span id="l6.189">   // Remove our account.</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-  remove_account(gPopAccount, amc);</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+  remove_account(gPopAccount, tab);</span>
<a href="#l6.192"></a><span id="l6.192">   // Now there should be only the original accounts left.</span>
<a href="#l6.193"></a><span id="l6.193">   assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l6.194"></a><span id="l6.194"> </span>
<a href="#l6.195"></a><span id="l6.195">   // See if the currently selected account is the one next in the account list.</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-  let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+  let accountTree = content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l6.198"></a><span id="l6.198">   let accountRow = accountTree.view.selection.currentIndex;</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+  wait_for_account_tree_selection(tab, accountRow);</span>
<a href="#l6.200"></a><span id="l6.200">   assert_equals(accountTree.view.getItemAtIndex(accountRow)._account,</span>
<a href="#l6.201"></a><span id="l6.201">                 accountList[accountIndex + 1]);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l6.204"></a><span id="l6.204"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-values.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-values.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -5,27 +5,31 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /**</span>
<a href="#l7.5"></a><span id="l7.5">  * This test checks proper operation of the account settings panes</span>
<a href="#l7.6"></a><span id="l7.6">  * when certain special or invalid values are entered into the fields.</span>
<a href="#l7.7"></a><span id="l7.7">  */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> &quot;use strict&quot;;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> /* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l7.13"></a><span id="l7.13"> /* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l7.14"></a><span id="l7.14"> /* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l7.16"></a><span id="l7.16"> /* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> var MODULE_NAME = &quot;test-account-values&quot;;</span>
<a href="#l7.19"></a><span id="l7.19"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l7.20"></a><span id="l7.20"> var MODULE_REQUIRES = [</span>
<a href="#l7.21"></a><span id="l7.21">   &quot;folder-display-helpers&quot;,</span>
<a href="#l7.22"></a><span id="l7.22">   &quot;window-helpers&quot;,</span>
<a href="#l7.23"></a><span id="l7.23">   &quot;account-manager-helpers&quot;,</span>
<a href="#l7.24"></a><span id="l7.24">   &quot;keyboard-helpers&quot;,</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l7.27"></a><span id="l7.27"> ];</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33"> function setupModule(module) {</span>
<a href="#l7.34"></a><span id="l7.34">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineat">@@ -59,53 +63,43 @@ function teardownModule(module) {</span>
<a href="#l7.36"></a><span id="l7.36"> }</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> /**</span>
<a href="#l7.39"></a><span id="l7.39">  * Bug 208628.</span>
<a href="#l7.40"></a><span id="l7.40">  * Check that if the CC field is empty, enabling CC will automatically</span>
<a href="#l7.41"></a><span id="l7.41">  * prefill the currently default email address.</span>
<a href="#l7.42"></a><span id="l7.42">  */</span>
<a href="#l7.43"></a><span id="l7.43"> function test_default_CC_address() {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-    subtest_check_default_CC_address(amc);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-  });</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-}</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-copies.xul&quot;, tab);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-/**</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">- * Check that if the CC field is empty, enabling CC will automatically</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">- * prefill the currently default email address.</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">- *</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">- */</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-function subtest_check_default_CC_address(amc) {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-copies.xul&quot;, amc);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">   let defaultAddress = iframe.contentDocument.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l7.66"></a><span id="l7.66">   let ccCheck = iframe.contentDocument.getElementById(&quot;identity.doCc&quot;);</span>
<a href="#l7.67"></a><span id="l7.67">   let ccAddress = iframe.contentDocument.getElementById(&quot;identity.doCcList&quot;);</span>
<a href="#l7.68"></a><span id="l7.68">   // The CC checkbox is not enabled and the address value is empty.</span>
<a href="#l7.69"></a><span id="l7.69">   assert_false(ccCheck.checked);</span>
<a href="#l7.70"></a><span id="l7.70">   assert_equals(ccAddress.value, &quot;&quot;);</span>
<a href="#l7.71"></a><span id="l7.71">   // After ticking the CC checkbox the default address should be prefilled.</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  amc.check(new elib.Elem(ccCheck), true);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  mc.check(new elib.Elem(ccCheck), true);</span>
<a href="#l7.74"></a><span id="l7.74">   assert_equals(ccAddress.value, defaultAddress);</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76">   let bccCheck = iframe.contentDocument.getElementById(&quot;identity.doBcc&quot;);</span>
<a href="#l7.77"></a><span id="l7.77">   let bccAddress = iframe.contentDocument.getElementById(&quot;identity.doBccList&quot;);</span>
<a href="#l7.78"></a><span id="l7.78">   // The BCC checkbox is not enabled but we set the address value to something.</span>
<a href="#l7.79"></a><span id="l7.79">   assert_false(bccCheck.checked);</span>
<a href="#l7.80"></a><span id="l7.80">   assert_equals(bccAddress.value, &quot;&quot;);</span>
<a href="#l7.81"></a><span id="l7.81">   let bccUserAddress = &quot;somebody@else.invalid&quot;;</span>
<a href="#l7.82"></a><span id="l7.82">   bccAddress.value = bccUserAddress;</span>
<a href="#l7.83"></a><span id="l7.83">   // After ticking the BCC checkbox the current value of the address should not change.</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  amc.check(new elib.Elem(bccCheck), true);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  mc.check(new elib.Elem(bccCheck), true);</span>
<a href="#l7.86"></a><span id="l7.86">   assert_equals(bccAddress.value, bccUserAddress);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l7.88"></a><span id="l7.88"> }</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90"> /**</span>
<a href="#l7.91"></a><span id="l7.91">  * Bug 720199.</span>
<a href="#l7.92"></a><span id="l7.92">  * Check if the account name automatically changes when the user changes</span>
<a href="#l7.93"></a><span id="l7.93">  * the username or hostname.</span>
<a href="#l7.94"></a><span id="l7.94">  */</span>
<a href="#l7.95"></a><span id="l7.95"> function test_account_name() {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineat">@@ -128,79 +122,69 @@ function test_account_name() {</span>
<a href="#l7.97"></a><span id="l7.97">   // The automatic account name update works only if the name is</span>
<a href="#l7.98"></a><span id="l7.98">   // in the form of user@host.</span>
<a href="#l7.99"></a><span id="l7.99">   gPopAccount.incomingServer.prettyName = &quot;nobody@example.invalid&quot;;</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101">   let newHost = &quot;some.host.invalid&quot;;</span>
<a href="#l7.102"></a><span id="l7.102">   let newUser = &quot;somebody&quot;;</span>
<a href="#l7.103"></a><span id="l7.103"> </span>
<a href="#l7.104"></a><span id="l7.104">   // On NNTP there is no user name so just set new hostname.</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-    subtest_check_account_name(nntpAccount, newHost, null, amc);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-  });</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  subtest_check_account_name(nntpAccount, newHost, null);</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110">   // And see if the account name is updated to it.</span>
<a href="#l7.111"></a><span id="l7.111">   assert_equals(nntpAccount.incomingServer.prettyName, newHost);</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">   // On POP3 there is both user name and host name.</span>
<a href="#l7.114"></a><span id="l7.114">   // Set new host name first.</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-    subtest_check_account_name(gPopAccount, newHost, null, amc);</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-  });</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  subtest_check_account_name(gPopAccount, newHost, null);</span>
<a href="#l7.119"></a><span id="l7.119"> </span>
<a href="#l7.120"></a><span id="l7.120">   // And see if in the account name the host part is updated to it.</span>
<a href="#l7.121"></a><span id="l7.121">   assert_equals(gPopAccount.incomingServer.prettyName, &quot;nobody@&quot; + newHost);</span>
<a href="#l7.122"></a><span id="l7.122"> </span>
<a href="#l7.123"></a><span id="l7.123">   // Set new host name first.</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-    subtest_check_account_name(gPopAccount, null, newUser, amc);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-  });</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  subtest_check_account_name(gPopAccount, null, newUser);</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129">   // And see if in the account name the user part is updated.</span>
<a href="#l7.130"></a><span id="l7.130">   assert_equals(gPopAccount.incomingServer.prettyName, newUser + &quot;@&quot; + newHost);</span>
<a href="#l7.131"></a><span id="l7.131"> </span>
<a href="#l7.132"></a><span id="l7.132">   newHost = &quot;another.host.invalid&quot;;</span>
<a href="#l7.133"></a><span id="l7.133">   newUser = &quot;anotherbody&quot;;</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135">   // Set user name and host name at once.</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-    subtest_check_account_name(gPopAccount, newHost, newUser, amc);</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-  });</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+  subtest_check_account_name(gPopAccount, newHost, newUser);</span>
<a href="#l7.140"></a><span id="l7.140"> </span>
<a href="#l7.141"></a><span id="l7.141">   // And see if in the account name the host part is updated to it.</span>
<a href="#l7.142"></a><span id="l7.142">   assert_equals(gPopAccount.incomingServer.prettyName, newUser + &quot;@&quot; + newHost);</span>
<a href="#l7.143"></a><span id="l7.143"> </span>
<a href="#l7.144"></a><span id="l7.144">   // Now have an account name where the name does not match the hostname.</span>
<a href="#l7.145"></a><span id="l7.145">   gPopAccount.incomingServer.prettyName = newUser + &quot;@example.invalid&quot;;</span>
<a href="#l7.146"></a><span id="l7.146"> </span>
<a href="#l7.147"></a><span id="l7.147">   newHost = &quot;third.host.invalid&quot;;</span>
<a href="#l7.148"></a><span id="l7.148">   // Set the host name again.</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-    subtest_check_account_name(gPopAccount, newHost, null, amc);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-  });</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  subtest_check_account_name(gPopAccount, newHost, null);</span>
<a href="#l7.153"></a><span id="l7.153"> </span>
<a href="#l7.154"></a><span id="l7.154">   // And the account name should not be touched.</span>
<a href="#l7.155"></a><span id="l7.155">   assert_equals(gPopAccount.incomingServer.prettyName, newUser + &quot;@example.invalid&quot;);</span>
<a href="#l7.156"></a><span id="l7.156"> </span>
<a href="#l7.157"></a><span id="l7.157">   MailServices.accounts.removeAccount(nntpAccount);</span>
<a href="#l7.158"></a><span id="l7.158"> }</span>
<a href="#l7.159"></a><span id="l7.159"> </span>
<a href="#l7.160"></a><span id="l7.160"> /**</span>
<a href="#l7.161"></a><span id="l7.161">  * Changes the user name and hostname to the supplied values.</span>
<a href="#l7.162"></a><span id="l7.162">  *</span>
<a href="#l7.163"></a><span id="l7.163">  * @param aAccount      the account to change</span>
<a href="#l7.164"></a><span id="l7.164">  * @param aNewHostname  the hostname value to set</span>
<a href="#l7.165"></a><span id="l7.165">  * @param aNewUsername  the username value to set</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">- * @param amc           the account options controller</span>
<a href="#l7.167"></a><span id="l7.167">  */</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-function subtest_check_account_name(aAccount, aNewHostname, aNewUsername, amc) {</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-  let accountRow = get_account_tree_row(aAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+function subtest_check_account_name(aAccount, aNewHostname, aNewUsername) {</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  let accountRow = get_account_tree_row(aAccount.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l7.175"></a><span id="l7.175"> </span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l7.178"></a><span id="l7.178"> </span>
<a href="#l7.179"></a><span id="l7.179">   if (aNewHostname) {</span>
<a href="#l7.180"></a><span id="l7.180">     let hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l7.181"></a><span id="l7.181">     assert_equals(hostname.value, aAccount.incomingServer.realHostName);</span>
<a href="#l7.182"></a><span id="l7.182"> </span>
<a href="#l7.183"></a><span id="l7.183">     // Now change the server host name.</span>
<a href="#l7.184"></a><span id="l7.184">     hostname.value = aNewHostname;</span>
<a href="#l7.185"></a><span id="l7.185">   }</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineat">@@ -215,155 +199,155 @@ function subtest_check_account_name(aAcc</span>
<a href="#l7.187"></a><span id="l7.187"> </span>
<a href="#l7.188"></a><span id="l7.188">   if (aNewUsername) {</span>
<a href="#l7.189"></a><span id="l7.189">     // If username has changed, we get a confirmation dialog.</span>
<a href="#l7.190"></a><span id="l7.190">     plan_for_modal_dialog(&quot;commonDialog&quot;, function(cdc) {</span>
<a href="#l7.191"></a><span id="l7.191">       // Just dismiss it.</span>
<a href="#l7.192"></a><span id="l7.192">       cdc.window.document.documentElement.acceptDialog();</span>
<a href="#l7.193"></a><span id="l7.193">     });</span>
<a href="#l7.194"></a><span id="l7.194">   }</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-  // We really need to save the new values so click OK on the Account settings.</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  amc.window.document.documentElement.acceptDialog();</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  // We really need to save the new values.</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+</span>
<a href="#l7.200"></a><span id="l7.200">   if (aNewUsername)</span>
<a href="#l7.201"></a><span id="l7.201">     wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l7.202"></a><span id="l7.202"> }</span>
<a href="#l7.203"></a><span id="l7.203"> </span>
<a href="#l7.204"></a><span id="l7.204"> /**</span>
<a href="#l7.205"></a><span id="l7.205">  * Bug 536768.</span>
<a href="#l7.206"></a><span id="l7.206">  * Check if invalid junk target settings (folders) are fixed to sane values.</span>
<a href="#l7.207"></a><span id="l7.207">  */</span>
<a href="#l7.208"></a><span id="l7.208"> function test_invalid_junk_target() {</span>
<a href="#l7.209"></a><span id="l7.209">   // Set the junk target prefs to invalid values.</span>
<a href="#l7.210"></a><span id="l7.210">   let branch = Services.prefs.getBranch(&quot;mail.server.&quot; + gPopAccount.incomingServer.key + &quot;.&quot;);</span>
<a href="#l7.211"></a><span id="l7.211">   branch.setCharPref(&quot;spamActionTargetAccount&quot;, &quot;some random non-existent URI&quot;);</span>
<a href="#l7.212"></a><span id="l7.212">   branch.setCharPref(&quot;spamActionTargetFolder&quot;, &quot;some random non-existent URI&quot;);</span>
<a href="#l7.213"></a><span id="l7.213">   let moveOnSpam = true;</span>
<a href="#l7.214"></a><span id="l7.214">   branch.setBoolPref(&quot;moveOnSpam&quot;, moveOnSpam);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-    subtest_check_invalid_junk_target(amc);</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-  });</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+  subtest_check_invalid_junk_target();</span>
<a href="#l7.219"></a><span id="l7.219"> </span>
<a href="#l7.220"></a><span id="l7.220">   // The pref has no default so its non-existence means it was cleared.</span>
<a href="#l7.221"></a><span id="l7.221">   moveOnSpam = branch.getBoolPref(&quot;moveOnSpam&quot;, false);</span>
<a href="#l7.222"></a><span id="l7.222">   assert_false(moveOnSpam);</span>
<a href="#l7.223"></a><span id="l7.223">   // The targets should point to the same pop account now.</span>
<a href="#l7.224"></a><span id="l7.224">   let targetAccount = branch.getCharPref(&quot;spamActionTargetAccount&quot;);</span>
<a href="#l7.225"></a><span id="l7.225">   assert_equals(targetAccount, gPopAccount.incomingServer.serverURI);</span>
<a href="#l7.226"></a><span id="l7.226">   let targetFolder = branch.getCharPref(&quot;spamActionTargetFolder&quot;);</span>
<a href="#l7.227"></a><span id="l7.227">   assert_equals(targetFolder, gPopAccount.incomingServer.serverURI + &quot;/Junk&quot;);</span>
<a href="#l7.228"></a><span id="l7.228"> }</span>
<a href="#l7.229"></a><span id="l7.229"> </span>
<a href="#l7.230"></a><span id="l7.230"> /**</span>
<a href="#l7.231"></a><span id="l7.231">  * Just show the Junk settings pane and let it fix the values.</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">- *</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l7.234"></a><span id="l7.234">  */</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-function subtest_check_invalid_junk_target(amc) {</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+function subtest_check_invalid_junk_target() {</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l7.242"></a><span id="l7.242"> </span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-  // We need to save the new fixed values so click OK on the Account settings.</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-  amc.window.document.documentElement.acceptDialog();</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+  // We need to save the new fixed values.</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l7.247"></a><span id="l7.247"> }</span>
<a href="#l7.248"></a><span id="l7.248"> </span>
<a href="#l7.249"></a><span id="l7.249"> /**</span>
<a href="#l7.250"></a><span id="l7.250">  * Bug 327812.</span>
<a href="#l7.251"></a><span id="l7.251">  * Checks if invalid server hostnames are not accepted.</span>
<a href="#l7.252"></a><span id="l7.252">  */</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+test_invalid_hostname.__force_skip__ = true; // disabled temporarily, bug 1096006</span>
<a href="#l7.254"></a><span id="l7.254"> function test_invalid_hostname() {</span>
<a href="#l7.255"></a><span id="l7.255">   let branch = Services.prefs.getBranch(&quot;mail.server.&quot; + gPopAccount.incomingServer.key + &quot;.&quot;);</span>
<a href="#l7.256"></a><span id="l7.256">   let origHostname = branch.getCharPref(&quot;realhostname&quot;);</span>
<a href="#l7.257"></a><span id="l7.257"> </span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-    subtest_check_invalid_hostname(amc, false, origHostname);</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-  });</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-    subtest_check_invalid_hostname(amc, true, origHostname);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-  });</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+  subtest_check_invalid_hostname(false, origHostname);</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+  subtest_check_invalid_hostname(true, origHostname);</span>
<a href="#l7.266"></a><span id="l7.266"> </span>
<a href="#l7.267"></a><span id="l7.267">   // The new bad hostname should not have been saved.</span>
<a href="#l7.268"></a><span id="l7.268">   let newHostname = branch.getCharPref(&quot;realhostname&quot;);</span>
<a href="#l7.269"></a><span id="l7.269">   assert_equals(origHostname, newHostname);</span>
<a href="#l7.270"></a><span id="l7.270"> }</span>
<a href="#l7.271"></a><span id="l7.271"> </span>
<a href="#l7.272"></a><span id="l7.272"> /**</span>
<a href="#l7.273"></a><span id="l7.273">  * Set the hostname to an invalid value and check if it gets fixed.</span>
<a href="#l7.274"></a><span id="l7.274">  *</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">- * @param amc                the account options controller</span>
<a href="#l7.276"></a><span id="l7.276">  * @param aExitSettings      Attempt to close the Account settings dialog.</span>
<a href="#l7.277"></a><span id="l7.277">  * @param aOriginalHostname  Original hostname of this server.</span>
<a href="#l7.278"></a><span id="l7.278">  */</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-function subtest_check_invalid_hostname(amc, aExitSettings, aOriginalHostname) {</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+function subtest_check_invalid_hostname(aExitSettings, aOriginalHostname) {</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l7.286"></a><span id="l7.286"> </span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l7.289"></a><span id="l7.289">   let hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l7.290"></a><span id="l7.290">   assert_equals(hostname.value, aOriginalHostname);</span>
<a href="#l7.291"></a><span id="l7.291"> </span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-  hostname.value = &quot;some_invalid+host&amp;domain*in&gt;invalid&quot;;</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+  delete_all_existing(mc, new elib.Elem(hostname));</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+  input_value(mc, &quot;some_invalid+host&amp;domain*in&gt;invalid&quot;, new elib.Elem(hostname));</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+  // As the hostname is bad, we should get a warning dialog.</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+  plan_for_modal_dialog(&quot;commonDialog&quot;, function(cdc) {</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+    // Just dismiss it.</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+    cdc.window.document.documentElement.acceptDialog();</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+  });</span>
<a href="#l7.301"></a><span id="l7.301"> </span>
<a href="#l7.302"></a><span id="l7.302">   if (!aExitSettings) {</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-    accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-    click_account_tree_row(amc, accountRow);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+    let newAccountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, tab);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+    click_account_tree_row(tab, newAccountRow, false);</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+    wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+    // The load of am-junk was prevented and we are back on the same pane.</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+    mc.waitFor(() =&gt; tab.browser.contentWindow.pendingAccount == null,</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+               &quot;Timeout waiting for pendingAccount to become null&quot;);</span>
<a href="#l7.311"></a><span id="l7.311"> </span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-    // The invalid hostname should be set back to previous value at this point...</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-    accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-    click_account_tree_row(amc, accountRow);</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-    // ...let's check that:</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-    iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+    let tree = content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+    wait_for_frame_load(content_tab_e(tab, &quot;contentFrame&quot;),</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+      tab.browser.contentWindow.pageURL(tree.view.getItemAtIndex(accountRow)</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+                               .getAttribute(&quot;PageTag&quot;)));</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+    assert_equals(tab.browser.contentWindow.currentPageId, &quot;am-server.xul&quot;);</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+    iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+    // Revert the changes to be able to close AM without warning.</span>
<a href="#l7.325"></a><span id="l7.325">     hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-    assert_equals(hostname.value, aOriginalHostname);</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+    delete_all_existing(mc, new elib.Elem(hostname));</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+    input_value(mc, aOriginalHostname, new elib.Elem(hostname));</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+    close_advanced_settings(tab);</span>
<a href="#l7.330"></a><span id="l7.330">   } else {</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-    // If the hostname is bad, we should get a warning dialog.</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-    plan_for_modal_dialog(&quot;commonDialog&quot;, function(cdc) {</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-      // Just dismiss it.</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-      cdc.window.document.documentElement.acceptDialog();</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-    });</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-    // Click OK on the Account settings.</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-    amc.window.document.documentElement.acceptDialog();</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+    // Close the tab to save the changes.</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+    // The bad hostname should be automatically reverted.</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+    close_advanced_settings(tab);</span>
<a href="#l7.343"></a><span id="l7.343">     wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l7.344"></a><span id="l7.344">   }</span>
<a href="#l7.345"></a><span id="l7.345"> }</span>
<a href="#l7.346"></a><span id="l7.346"> </span>
<a href="#l7.347"></a><span id="l7.347"> /**</span>
<a href="#l7.348"></a><span id="l7.348">  * Bug 1426328.</span>
<a href="#l7.349"></a><span id="l7.349">  * Check that the AM will trim user added spaces around text values.</span>
<a href="#l7.350"></a><span id="l7.350">  */</span>
<a href="#l7.351"></a><span id="l7.351"> const badName = &quot;trailing  space &quot;;</span>
<a href="#l7.352"></a><span id="l7.352"> const badEmail = &quot; leading_space@example.com&quot;;</span>
<a href="#l7.353"></a><span id="l7.353"> </span>
<a href="#l7.354"></a><span id="l7.354"> function test_trailing_spaces() {</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-    subtest_check_trailing_spaces(amc);</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-  });</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+  subtest_check_trailing_spaces();</span>
<a href="#l7.359"></a><span id="l7.359">   assert_equals(gPopAccount.incomingServer.prettyName, badName.trim());</span>
<a href="#l7.360"></a><span id="l7.360">   assert_equals(gPopAccount.defaultIdentity.email, badEmail.trim());</span>
<a href="#l7.361"></a><span id="l7.361"> }</span>
<a href="#l7.362"></a><span id="l7.362"> </span>
<a href="#l7.363"></a><span id="l7.363"> /**</span>
<a href="#l7.364"></a><span id="l7.364">  * Check that the AM will trim user added spaces around text values</span>
<a href="#l7.365"></a><span id="l7.365">  * when storing them into the account.</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">- *</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l7.368"></a><span id="l7.368">  */</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-function subtest_check_trailing_spaces(amc) {</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+function subtest_check_trailing_spaces() {</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, null, tab);</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l7.376"></a><span id="l7.376"> </span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l7.379"></a><span id="l7.379"> </span>
<a href="#l7.380"></a><span id="l7.380">   let accountName = iframe.contentDocument.getElementById(&quot;server.prettyName&quot;);</span>
<a href="#l7.381"></a><span id="l7.381">   let defaultAddress = iframe.contentDocument.getElementById(&quot;identity.email&quot;);</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-  delete_all_existing(amc, new elib.Elem(accountName));</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-  delete_all_existing(amc, new elib.Elem(defaultAddress));</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-  input_value(amc, badName, new elib.Elem(accountName));</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-  input_value(amc, badEmail, new elib.Elem(defaultAddress));</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+  delete_all_existing(mc, new elib.Elem(accountName));</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+  delete_all_existing(mc, new elib.Elem(defaultAddress));</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+  input_value(mc, badName, new elib.Elem(accountName));</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+  input_value(mc, badEmail, new elib.Elem(defaultAddress));</span>
<a href="#l7.390"></a><span id="l7.390"> </span>
<a href="#l7.391"></a><span id="l7.391">   assert_equals(accountName.value, badName);</span>
<a href="#l7.392"></a><span id="l7.392">   assert_equals(defaultAddress.value, badEmail);</span>
<a href="#l7.393"></a><span id="l7.393"> </span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-  // We really need to save the new values so click OK on the Account settings.</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-  amc.window.document.documentElement.acceptDialog();</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+  // We really need to save the new values.</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l7.398"></a><span id="l7.398"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/account/test-archive-options.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-archive-options.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2,53 +2,59 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> &quot;use strict&quot;;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> /* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l8.10"></a><span id="l8.10"> /* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l8.11"></a><span id="l8.11"> /* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> var MODULE_NAME = &quot;test-archive-options&quot;;</span>
<a href="#l8.16"></a><span id="l8.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+];</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26"> var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l8.27"></a><span id="l8.27"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l8.28"></a><span id="l8.28"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30"> var defaultIdentity;</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32"> function setupModule(module) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  wh.installInto(module);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  fdh.installInto(module);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  let amh = collector.getModule(&quot;account-manager-helpers&quot;);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  amh.installInto(module);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+    collector.getModule(lib).installInto(module);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  }</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43">   defaultIdentity = MailServices.accounts.defaultAccount.defaultIdentity;</span>
<a href="#l8.44"></a><span id="l8.44"> }</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46"> /**</span>
<a href="#l8.47"></a><span id="l8.47">  * Check that the archive options button is enabled or disabled appropriately.</span>
<a href="#l8.48"></a><span id="l8.48">  *</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">- * @param amc          the account options controller</span>
<a href="#l8.50"></a><span id="l8.50">  * @param aAccountKey  key of the account the check</span>
<a href="#l8.51"></a><span id="l8.51">  * @param isEnabled    true if the button should be enabled, false otherwise</span>
<a href="#l8.52"></a><span id="l8.52">  */</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-function subtest_check_archive_options_enabled(amc, aAccountKey, isEnabled) {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  let accountRow = get_account_tree_row(aAccountKey, &quot;am-copies.xul&quot;, amc);</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+function subtest_check_archive_options_enabled(aAccountKey, isEnabled) {</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  let accountRow = get_account_tree_row(aAccountKey, &quot;am-copies.xul&quot;, tab);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l8.63"></a><span id="l8.63">   let button = iframe.contentDocument.getElementById(&quot;archiveHierarchyButton&quot;);</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65">   assert_equals(button.disabled, !isEnabled);</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l8.67"></a><span id="l8.67"> }</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69"> function test_archive_options_enabled() {</span>
<a href="#l8.70"></a><span id="l8.70">   let defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l8.71"></a><span id="l8.71">   // First, create an IMAP server</span>
<a href="#l8.72"></a><span id="l8.72">   let imapServer = MailServices.accounts</span>
<a href="#l8.73"></a><span id="l8.73">     .createIncomingServer(&quot;nobody&quot;, &quot;example.com&quot;, &quot;imap&quot;)</span>
<a href="#l8.74"></a><span id="l8.74">     .QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineat">@@ -64,30 +70,22 @@ function test_archive_options_enabled() </span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">   // Let the default identity archive to our IMAP folder, to ensure that the</span>
<a href="#l8.78"></a><span id="l8.78">   // archive folder's server is used to determine the enabled/disabled state</span>
<a href="#l8.79"></a><span id="l8.79">   // of the &quot;archive options&quot; button, *not* the incoming server for that</span>
<a href="#l8.80"></a><span id="l8.80">   // identity.</span>
<a href="#l8.81"></a><span id="l8.81">   defaultIdentity.archiveFolder = imapServer.rootFolder.URI;</span>
<a href="#l8.82"></a><span id="l8.82"> </span>
<a href="#l8.83"></a><span id="l8.83">   imapServer.isGMailServer = false;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    subtest_check_archive_options_enabled(amc, account.key, true);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-  });</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    subtest_check_archive_options_enabled(amc, defaultAccount.key, true);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-  });</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  subtest_check_archive_options_enabled(account.key, true);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+  subtest_check_archive_options_enabled(defaultAccount.key, true);</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93">   imapServer.isGMailServer = true;</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-    subtest_check_archive_options_enabled(amc, account.key, false);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-  });</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-    subtest_check_archive_options_enabled(amc, defaultAccount.key, false);</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-  });</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  subtest_check_archive_options_enabled(account.key, false);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  subtest_check_archive_options_enabled(defaultAccount.key, false);</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103">   MailServices.accounts.removeAccount(account);</span>
<a href="#l8.104"></a><span id="l8.104"> }</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106"> function subtest_initial_state(identity) {</span>
<a href="#l8.107"></a><span id="l8.107">   plan_for_modal_dialog(&quot;archive-options&quot;, function(ac) {</span>
<a href="#l8.108"></a><span id="l8.108">     assert_equals(ac.e(&quot;archiveGranularity&quot;).selectedIndex,</span>
<a href="#l8.109"></a><span id="l8.109">                   identity.archiveGranularity);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineat">@@ -126,53 +124,51 @@ function test_save_archive_options() {</span>
<a href="#l8.111"></a><span id="l8.111">   defaultIdentity.archiveGranularity = 0;</span>
<a href="#l8.112"></a><span id="l8.112">   defaultIdentity.archiveKeepFolderStructure = false;</span>
<a href="#l8.113"></a><span id="l8.113">   subtest_save_state(defaultIdentity, 1, true);</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">   assert_equals(defaultIdentity.archiveGranularity, 1);</span>
<a href="#l8.116"></a><span id="l8.116">   assert_equals(defaultIdentity.archiveKeepFolderStructure, true);</span>
<a href="#l8.117"></a><span id="l8.117"> }</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-function subtest_check_archive_enabled(amc, archiveEnabled) {</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+function subtest_check_archive_enabled(archiveEnabled) {</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l8.122"></a><span id="l8.122">   defaultIdentity.archiveEnabled = archiveEnabled;</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-  click_account_tree_row(amc, 2);</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+  click_account_tree_row(tab, 2);</span>
<a href="#l8.126"></a><span id="l8.126"> </span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l8.129"></a><span id="l8.129">   let checkbox = iframe.contentDocument.getElementById(&quot;identity.archiveEnabled&quot;);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-</span>
<a href="#l8.131"></a><span id="l8.131">   assert_equals(checkbox.checked, archiveEnabled);</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l8.133"></a><span id="l8.133"> }</span>
<a href="#l8.134"></a><span id="l8.134"> </span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+test_archive_enabled.__force_skip__ = true; // disabled temporarily, bug 1096006</span>
<a href="#l8.136"></a><span id="l8.136"> function test_archive_enabled() {</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-    subtest_check_archive_enabled(amc, true);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-  });</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+  subtest_check_archive_enabled(true);</span>
<a href="#l8.141"></a><span id="l8.141"> </span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-    subtest_check_archive_enabled(amc, false);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-  });</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+  subtest_check_archive_enabled(false);</span>
<a href="#l8.146"></a><span id="l8.146"> }</span>
<a href="#l8.147"></a><span id="l8.147"> </span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-function subtest_disable_archive(amc) {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+test_disable_archive.__force_skip__ = true; // disabled temporarily, bug 1096006</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+function test_disable_archive() {</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+  let tab = open_advanced_settings();</span>
<a href="#l8.152"></a><span id="l8.152">   defaultIdentity.archiveEnabled = true;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-  click_account_tree_row(amc, 2);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  click_account_tree_row(tab, 2);</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+  let iframe = content_tab_e(tab, &quot;contentFrame&quot;);</span>
<a href="#l8.158"></a><span id="l8.158">   let checkbox = iframe.contentDocument.getElementById(&quot;identity.archiveEnabled&quot;);</span>
<a href="#l8.159"></a><span id="l8.159"> </span>
<a href="#l8.160"></a><span id="l8.160">   assert_true(checkbox.checked);</span>
<a href="#l8.161"></a><span id="l8.161">   assert_false(checkbox.disabled);</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-  amc.click(new elib.Elem(checkbox));</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+  mc.click(new elib.Elem(checkbox));</span>
<a href="#l8.164"></a><span id="l8.164">   utils.waitFor(() =&gt; !checkbox.checked, &quot;Archive checkbox didn't toggle to unchecked&quot;);</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-  plan_for_window_close(amc);</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-  amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  plan_for_window_close(mc);</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+  mc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l8.169"></a><span id="l8.169">   wait_for_window_close();</span>
<a href="#l8.170"></a><span id="l8.170"> </span>
<a href="#l8.171"></a><span id="l8.171">   assert_false(defaultIdentity.archiveEnabled);</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  close_advanced_settings(tab);</span>
<a href="#l8.173"></a><span id="l8.173"> }</span>
<a href="#l8.174"></a><span id="l8.174"> </span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-function test_disable_archive() {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-  open_advanced_settings(subtest_disable_archive);</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-}</span>
<a href="#l8.178"></a><span id="l8.178"> // Disable test on Windows since for some yet unknown reason clicking the checkbox</span>
<a href="#l8.179"></a><span id="l8.179"> // doesn't have the desired result. See bug 1461173 for details.</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-test_disable_archive.EXCLUDED_PLATFORMS = [&quot;winnt&quot;];</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+// test_disable_archive.EXCLUDED_PLATFORMS = [&quot;winnt&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -33,18 +33,18 @@ var user = {</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> function setupModule(module) {</span>
<a href="#l9.6"></a><span id="l9.6">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l9.7"></a><span id="l9.7">     collector.getModule(lib).installInto(module);</span>
<a href="#l9.8"></a><span id="l9.8">   }</span>
<a href="#l9.9"></a><span id="l9.9"> }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> // Remove an account in the Account Manager, but not via the UI.</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-function remove_account_internal(amc, aAccount, aOutgoing) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  let win = amc.window;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+function remove_account_internal(tab, aAccount, aOutgoing) {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  let win = tab.browser.contentWindow;</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">   try {</span>
<a href="#l9.18"></a><span id="l9.18">     // Remove the account and incoming server</span>
<a href="#l9.19"></a><span id="l9.19">     let serverId = aAccount.incomingServer.serverURI;</span>
<a href="#l9.20"></a><span id="l9.20">     MailServices.accounts.removeAccount(aAccount);</span>
<a href="#l9.21"></a><span id="l9.21">     if (serverId in win.accountArray)</span>
<a href="#l9.22"></a><span id="l9.22">       delete win.accountArray[serverId];</span>
<a href="#l9.23"></a><span id="l9.23">     win.selectServer(null, null);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -85,27 +85,26 @@ function test_mail_account_setup() {</span>
<a href="#l9.25"></a><span id="l9.25">     // XXX: This should probably use a notification, once we fix bug 561143.</span>
<a href="#l9.26"></a><span id="l9.26">     awc.waitFor(() =&gt; awc.window.gEmailConfigWizard._currentConfig != null,</span>
<a href="#l9.27"></a><span id="l9.27">                 &quot;Timeout waiting for current config to become non-null&quot;,</span>
<a href="#l9.28"></a><span id="l9.28">                 8000, 600);</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">     // Open the advanced settings (Account Manager) to create the account</span>
<a href="#l9.31"></a><span id="l9.31">     // immediately.  We use an invalid email/password so the setup will fail</span>
<a href="#l9.32"></a><span id="l9.32">     // anyway.</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-    open_advanced_settings_from_account_wizard(subtest_verify_account, awc);</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    let tab = open_advanced_settings_from_account_wizard(awc);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+    subtest_verify_account(tab);</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37">     // Clean up</span>
<a href="#l9.38"></a><span id="l9.38">     Services.prefs.clearUserPref(pref_name);</span>
<a href="#l9.39"></a><span id="l9.39">   });</span>
<a href="#l9.40"></a><span id="l9.40"> }</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-function subtest_verify_account(amc) {</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-  amc.waitFor(() =&gt; amc.window.currentAccount != null,</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-              &quot;Timeout waiting for currentAccount to become non-null&quot;);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-  let account = amc.window.currentAccount;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+function subtest_verify_account(tab) {</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  let account = tab.browser.contentWindow.currentAccount;</span>
<a href="#l9.48"></a><span id="l9.48">   let identity = account.defaultIdentity;</span>
<a href="#l9.49"></a><span id="l9.49">   let incoming = account.incomingServer;</span>
<a href="#l9.50"></a><span id="l9.50">   let outgoing = MailServices.smtp.getServerByKey(identity.smtpServerKey);</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">   let config = {</span>
<a href="#l9.53"></a><span id="l9.53">     &quot;incoming server username&quot;: {</span>
<a href="#l9.54"></a><span id="l9.54">       actual: incoming.username, expected: user.email.split(&quot;@&quot;)[0],</span>
<a href="#l9.55"></a><span id="l9.55">     },</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineat">@@ -127,17 +126,17 @@ function subtest_verify_account(amc) {</span>
<a href="#l9.57"></a><span id="l9.57">   try {</span>
<a href="#l9.58"></a><span id="l9.58">     for (let i in config) {</span>
<a href="#l9.59"></a><span id="l9.59">       if (config[i].actual != config[i].expected) {</span>
<a href="#l9.60"></a><span id="l9.60">         throw new Error(&quot;Configured &quot; + i + &quot; is &quot; + config[i].actual +</span>
<a href="#l9.61"></a><span id="l9.61">                         &quot;. It should be &quot; + config[i].expected + &quot;.&quot;);</span>
<a href="#l9.62"></a><span id="l9.62">       }</span>
<a href="#l9.63"></a><span id="l9.63">     }</span>
<a href="#l9.64"></a><span id="l9.64">   } finally {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-    remove_account_internal(amc, account, outgoing);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    remove_account_internal(tab, account, outgoing);</span>
<a href="#l9.67"></a><span id="l9.67">   }</span>
<a href="#l9.68"></a><span id="l9.68"> }</span>
<a href="#l9.69"></a><span id="l9.69"> </span>
<a href="#l9.70"></a><span id="l9.70"> /**</span>
<a href="#l9.71"></a><span id="l9.71">  * Make sure that we don't re-set the information we get from the config</span>
<a href="#l9.72"></a><span id="l9.72">  * file if the password is incorrect.</span>
<a href="#l9.73"></a><span id="l9.73">  */</span>
<a href="#l9.74"></a><span id="l9.74"> function test_bad_password_uses_old_settings() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -96,9 +96,8 @@ function test_re_test_config() {</span>
<a href="#l10.4"></a><span id="l10.4">     assert_true(!awc.e(&quot;manual-edit_button&quot;).hidden,</span>
<a href="#l10.5"></a><span id="l10.5">       &quot;We're not back to the original state!&quot;);</span>
<a href="#l10.6"></a><span id="l10.6">     assert_true(awc.e(&quot;advanced-setup_button&quot;).hidden,</span>
<a href="#l10.7"></a><span id="l10.7">       &quot;We're not back to the original state!&quot;);</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9">     close_window(awc);</span>
<a href="#l10.10"></a><span id="l10.10">   });</span>
<a href="#l10.11"></a><span id="l10.11"> }</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,66 +1,104 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> &quot;use strict&quot;;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> var MODULE_NAME = &quot;account-manager-helpers&quot;;</span>
<a href="#l11.11"></a><span id="l11.11"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+                       &quot;pref-window-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l11.17"></a><span id="l11.17"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-var wh, fdh, mc;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+var wh, fdh, pwh, cth, mc;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> function setupModule() {</span>
<a href="#l11.23"></a><span id="l11.23">   fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l11.24"></a><span id="l11.24">   mc = fdh.mc;</span>
<a href="#l11.25"></a><span id="l11.25">   wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  pwh = collector.getModule(&quot;pref-window-helpers&quot;);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+  cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l11.28"></a><span id="l11.28"> }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30"> function installInto(module) {</span>
<a href="#l11.31"></a><span id="l11.31">   setupModule();</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">   // Now copy helper functions</span>
<a href="#l11.34"></a><span id="l11.34">   module.open_advanced_settings = open_advanced_settings;</span>
<a href="#l11.35"></a><span id="l11.35">   module.open_advanced_settings_from_account_wizard =</span>
<a href="#l11.36"></a><span id="l11.36">     open_advanced_settings_from_account_wizard;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  module.close_advanced_settings = close_advanced_settings;</span>
<a href="#l11.38"></a><span id="l11.38">   module.open_mail_account_setup_wizard = open_mail_account_setup_wizard;</span>
<a href="#l11.39"></a><span id="l11.39">   module.click_account_tree_row = click_account_tree_row;</span>
<a href="#l11.40"></a><span id="l11.40">   module.get_account_tree_row = get_account_tree_row;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  module.wait_for_account_tree_load = wait_for_account_tree_load;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  module.wait_for_account_tree_selection = wait_for_account_tree_selection;</span>
<a href="#l11.43"></a><span id="l11.43">   module.remove_account = remove_account;</span>
<a href="#l11.44"></a><span id="l11.44"> }</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46"> /**</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">- * Opens the Account Manager.</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">- *</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">- * @param callback Callback for the modal dialog that is opened.</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+ * Waits until the Account Manager tree fully loads after first open.</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+ */</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+function wait_for_account_tree_load(tab) {</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  mc.waitFor(() =&gt; tab.browser.contentWindow.currentAccount != null,</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+              &quot;Timeout waiting for currentAccount to become non-null&quot;);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  var tree = cth.content_tab_e(tab, &quot;account-tree-children&quot;);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  mc.waitFor(() =&gt; tree.hasAttribute(&quot;tree-loaded&quot;),</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+              &quot;Timeout waiting for account tree build&quot;);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+}</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+/**</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+ * Ensure the page is fully loaded (e.g. onInit functions).</span>
<a href="#l11.62"></a><span id="l11.62">  */</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-function open_advanced_settings(aCallback, aController) {</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    aController = mc;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+function wait_for_account_tree_selection(tab, index = -1) {</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  utils.waitFor(() =&gt; tab.browser.contentWindow.pendingAccount == null,</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+                &quot;Timeout waiting for pendingAccount to become null&quot;);</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  wh.plan_for_modal_dialog(&quot;mailnews:accountmanager&quot;, aCallback);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-  aController.click(mc.eid(&quot;menu_accountmgr&quot;));</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-  return wh.wait_for_modal_dialog(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  var tree = cth.content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  if (index &lt; 0)</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+    index = tree.view.selection.currentIndex;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  wh.wait_for_frame_load(cth.content_tab_e(tab, &quot;contentFrame&quot;),</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+    tab.browser.contentWindow.pageURL(tree.view.getItemAtIndex(index)</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+                             .getAttribute(&quot;PageTag&quot;)));</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+}</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+/**</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+ * Opens the Account Manager pane in pre Preferences tab.</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+ */</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+function open_advanced_settings() {</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+  var tab = pwh.open_pref_tab(&quot;paneAccount&quot;);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+  wait_for_account_tree_load(tab);</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  return tab;</span>
<a href="#l11.88"></a><span id="l11.88"> }</span>
<a href="#l11.89"></a><span id="l11.89"> </span>
<a href="#l11.90"></a><span id="l11.90"> /**</span>
<a href="#l11.91"></a><span id="l11.91">  * Opens the Account Manager from the mail account setup wizard.</span>
<a href="#l11.92"></a><span id="l11.92">  *</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">- * @param callback Callback for the modal dialog that is opened.</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+ * @param aController Controller of the Account Wizard window.</span>
<a href="#l11.95"></a><span id="l11.95">  */</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-function open_advanced_settings_from_account_wizard(aCallback, aController) {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-  wh.plan_for_modal_dialog(&quot;mailnews:accountmanager&quot;, aCallback);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+function open_advanced_settings_from_account_wizard(aController) {</span>
<a href="#l11.99"></a><span id="l11.99">   aController.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l11.100"></a><span id="l11.100">   aController.e(&quot;advanced-setup_button&quot;).click();</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  return wh.wait_for_modal_dialog(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  var tabmail = mc.e(&quot;tabmail&quot;);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+  tabmail.selectTabByMode(&quot;preferencesTab&quot;);</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  var tab;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+  mc.waitFor(</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+    () =&gt; (tab = tabmail.getTabInfoForCurrentOrFirstModeInstance(</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+           tabmail.tabModes.preferencesTab)) != null,</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+             &quot;Couldn't find the Preferences tab with the Account manager&quot;);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  wait_for_account_tree_load(tab);</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  return tab;</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+}</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+function close_advanced_settings(tab) {</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+  pwh.close_pref_tab(tab);</span>
<a href="#l11.115"></a><span id="l11.115"> }</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117"> /**</span>
<a href="#l11.118"></a><span id="l11.118">  * Use File &gt; New &gt; Mail Account to open the Mail Account Setup Wizard.</span>
<a href="#l11.119"></a><span id="l11.119">  *</span>
<a href="#l11.120"></a><span id="l11.120">  * @param aCallback  Function to run once the dialog is open. The function</span>
<a href="#l11.121"></a><span id="l11.121">  *                   gets the new window controller passed as first argument.</span>
<a href="#l11.122"></a><span id="l11.122">  */</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineat">@@ -68,52 +106,51 @@ function open_mail_account_setup_wizard(</span>
<a href="#l11.124"></a><span id="l11.124">   wh.plan_for_modal_dialog(&quot;mail:autoconfig&quot;, aCallback);</span>
<a href="#l11.125"></a><span id="l11.125">   mc.click(new elib.Elem(mc.menus.menu_File.menu_New.newMailAccountMenuItem));</span>
<a href="#l11.126"></a><span id="l11.126">   return wh.wait_for_modal_dialog(&quot;mail:autoconfig&quot;, 30000);</span>
<a href="#l11.127"></a><span id="l11.127"> }</span>
<a href="#l11.128"></a><span id="l11.128"> </span>
<a href="#l11.129"></a><span id="l11.129"> /**</span>
<a href="#l11.130"></a><span id="l11.130">  * Click a row in the account settings tree</span>
<a href="#l11.131"></a><span id="l11.131">  *</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">- * @param controller the Mozmill controller for the account settings dialog</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">- * @param rowIndex the row to click</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+ * @param tab       the account settings tab</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+ * @param rowIndex  the row to click</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+ * @param wait      whether to wait for finishing the load</span>
<a href="#l11.137"></a><span id="l11.137">  */</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-function click_account_tree_row(controller, rowIndex) {</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-  utils.waitFor(() =&gt; controller.window.currentAccount != null,</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+function click_account_tree_row(tab, rowIndex, wait = true) {</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+  utils.waitFor(() =&gt; tab.browser.contentWindow.getCurrentAccount() != null,</span>
<a href="#l11.142"></a><span id="l11.142">                 &quot;Timeout waiting for currentAccount to become non-null&quot;);</span>
<a href="#l11.143"></a><span id="l11.143"> </span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-  let tree = controller.window.document.getElementById(&quot;accounttree&quot;);</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+  let tree = cth.content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l11.146"></a><span id="l11.146"> </span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-  fdh.click_tree_row(tree, rowIndex, controller);</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+  fdh.click_tree_row(tree, rowIndex, mc);</span>
<a href="#l11.149"></a><span id="l11.149"> </span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-  utils.waitFor(() =&gt; controller.window.pendingAccount == null,</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-                &quot;Timeout waiting for pendingAccount to become null&quot;);</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+  if (!wait)</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+    return;</span>
<a href="#l11.154"></a><span id="l11.154"> </span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-  // Ensure the page is fully loaded (e.g. onInit functions).</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-  wh.wait_for_frame_load(controller.e(&quot;contentFrame&quot;),</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-    controller.window.pageURL(tree.view.getItemAtIndex(rowIndex)</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-                                              .getAttribute(&quot;PageTag&quot;)));</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+  wait_for_account_tree_selection(tab, rowIndex);</span>
<a href="#l11.160"></a><span id="l11.160"> }</span>
<a href="#l11.161"></a><span id="l11.161"> </span>
<a href="#l11.162"></a><span id="l11.162"> /**</span>
<a href="#l11.163"></a><span id="l11.163">  * Returns the index of the row in account tree corresponding to the wanted</span>
<a href="#l11.164"></a><span id="l11.164">  * account and its settings pane.</span>
<a href="#l11.165"></a><span id="l11.165">  *</span>
<a href="#l11.166"></a><span id="l11.166">  * @param aAccountKey  The key of the account to return.</span>
<a href="#l11.167"></a><span id="l11.167">  *                     If 'null', the SMTP pane is returned.</span>
<a href="#l11.168"></a><span id="l11.168">  * @param aPaneId      The ID of the account settings pane to select.</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+ * @param tab          the account settings tab</span>
<a href="#l11.170"></a><span id="l11.170">  *</span>
<a href="#l11.171"></a><span id="l11.171">  * @return  The row index of the account and pane. If it was not found return -1.</span>
<a href="#l11.172"></a><span id="l11.172">  *          Do not throw as callers may intentionally just check if a row exists.</span>
<a href="#l11.173"></a><span id="l11.173">  *          Just dump into the log so that a subsequent throw in</span>
<a href="#l11.174"></a><span id="l11.174">  *          click_account_tree_row has a useful context.</span>
<a href="#l11.175"></a><span id="l11.175">  */</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-function get_account_tree_row(aAccountKey, aPaneId, aController) {</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+function get_account_tree_row(aAccountKey, aPaneId, tab) {</span>
<a href="#l11.178"></a><span id="l11.178">   let rowIndex = 0;</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-  let accountTreeNode = aController.e(&quot;account-tree-children&quot;);</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+  let accountTreeNode = cth.content_tab_e(tab, &quot;account-tree-children&quot;);</span>
<a href="#l11.181"></a><span id="l11.181"> </span>
<a href="#l11.182"></a><span id="l11.182">   for (let i = 0; i &lt; accountTreeNode.childNodes.length; i++) {</span>
<a href="#l11.183"></a><span id="l11.183">     if (&quot;_account&quot; in accountTreeNode.childNodes[i]) {</span>
<a href="#l11.184"></a><span id="l11.184">       let accountHead = accountTreeNode.childNodes[i];</span>
<a href="#l11.185"></a><span id="l11.185">       if (aAccountKey == accountHead._account.key) {</span>
<a href="#l11.186"></a><span id="l11.186">         // If this is the wanted account, find the wanted settings pane.</span>
<a href="#l11.187"></a><span id="l11.187">         let accountBlock = accountHead.querySelectorAll(&quot;[PageTag]&quot;);</span>
<a href="#l11.188"></a><span id="l11.188">         // A null aPaneId means the main pane.</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineat">@@ -143,37 +180,43 @@ function get_account_tree_row(aAccountKe</span>
<a href="#l11.190"></a><span id="l11.190">   dump(&quot;The treerow for account &quot; + aAccountKey + &quot; was not found!\n&quot;);</span>
<a href="#l11.191"></a><span id="l11.191">   return -1;</span>
<a href="#l11.192"></a><span id="l11.192"> }</span>
<a href="#l11.193"></a><span id="l11.193"> </span>
<a href="#l11.194"></a><span id="l11.194"> /**</span>
<a href="#l11.195"></a><span id="l11.195">  * Remove an account via the account manager UI.</span>
<a href="#l11.196"></a><span id="l11.196">  *</span>
<a href="#l11.197"></a><span id="l11.197">  * @param aAccount        The account to remove.</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">- * @param aController     The controller of the account manager window.</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+ * @param tab             The account settings tab.</span>
<a href="#l11.200"></a><span id="l11.200">  * @param aRemoveAccount  Remove the account itself.</span>
<a href="#l11.201"></a><span id="l11.201">  * @param aRemoveData     Remove the message data of the account.</span>
<a href="#l11.202"></a><span id="l11.202">  */</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-function remove_account(aAccount, aController, aRemoveAccount = true, aRemoveData = false) {</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-  let accountRow = get_account_tree_row(aAccount.key, &quot;am-server.xul&quot;, aController);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-  click_account_tree_row(aController, accountRow);</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+function remove_account(aAccount, tab, aRemoveAccount = true, aRemoveData = false) {</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+  let accountRow = get_account_tree_row(aAccount.key, &quot;am-server.xul&quot;, tab);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l11.209"></a><span id="l11.209"> </span>
<a href="#l11.210"></a><span id="l11.210">   wh.plan_for_modal_dialog(&quot;removeAccountDialog&quot;, function(cdc) {</span>
<a href="#l11.211"></a><span id="l11.211">     // Account removal confirmation dialog. Select what to remove.</span>
<a href="#l11.212"></a><span id="l11.212">     if (aRemoveAccount)</span>
<a href="#l11.213"></a><span id="l11.213">       cdc.click(new elib.Elem(cdc.window.document.getElementById(&quot;removeAccount&quot;)));</span>
<a href="#l11.214"></a><span id="l11.214">     if (aRemoveData)</span>
<a href="#l11.215"></a><span id="l11.215">       cdc.click(new elib.Elem(cdc.window.document.getElementById(&quot;removeData&quot;)));</span>
<a href="#l11.216"></a><span id="l11.216"> </span>
<a href="#l11.217"></a><span id="l11.217">     cdc.window.document.documentElement.acceptDialog();</span>
<a href="#l11.218"></a><span id="l11.218">     cdc.waitFor(() =&gt; !cdc.window.document.documentElement.getButton(&quot;accept&quot;).disabled,</span>
<a href="#l11.219"></a><span id="l11.219">                 &quot;Timeout waiting for finish of account removal&quot;,</span>
<a href="#l11.220"></a><span id="l11.220">                 5000, 100);</span>
<a href="#l11.221"></a><span id="l11.221">     cdc.window.document.documentElement.acceptDialog();</span>
<a href="#l11.222"></a><span id="l11.222">   });</span>
<a href="#l11.223"></a><span id="l11.223"> </span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+  let treeBuilt = false;</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+  cth.content_tab_e(tab, &quot;account-tree-children&quot;)</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+     .addEventListener(&quot;account-tree-built&quot;, () =&gt; { treeBuilt = true; },</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+                       {once: true});</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+</span>
<a href="#l11.229"></a><span id="l11.229">   // Use the Remove item in the Account actions menu.</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-  aController.click(aController.eid(&quot;accountActionsButton&quot;));</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-  aController.click_menus_in_sequence(aController.e(&quot;accountActionsDropdown&quot;),</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+  mc.click(cth.content_tab_eid(tab, &quot;accountActionsButton&quot;));</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+  mc.click_menus_in_sequence(cth.content_tab_e(tab, &quot;accountActionsDropdown&quot;),</span>
<a href="#l11.234"></a><span id="l11.234">                                       [ {id: &quot;accountActionsDropdownRemove&quot;} ]);</span>
<a href="#l11.235"></a><span id="l11.235">   wh.wait_for_modal_dialog(&quot;removeAccountDialog&quot;);</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-  // TODO: For unknown reason this also closes the whole account manager.</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+  mc.waitFor(() =&gt; treeBuilt, &quot;Timeout waiting for account tree rebuild&quot;);</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+  wait_for_account_tree_selection(tab);</span>
<a href="#l11.239"></a><span id="l11.239"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-pref-window-helpers.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -47,10 +47,11 @@ function open_pref_tab(aPaneID) {</span>
<a href="#l12.4"></a><span id="l12.4"> }</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> /**</span>
<a href="#l12.7"></a><span id="l12.7">  * Close the preferences tab.</span>
<a href="#l12.8"></a><span id="l12.8">  *</span>
<a href="#l12.9"></a><span id="l12.9">  * @param aTab  The content tab to close.</span>
<a href="#l12.10"></a><span id="l12.10">  */</span>
<a href="#l12.11"></a><span id="l12.11"> function close_pref_tab(aTab) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+  fdh.assert_true(aTab, &quot;No Preferences tab specified for closing&quot;);</span>
<a href="#l12.13"></a><span id="l12.13">   fdh.mc.tabmail.closeTab(aTab);</span>
<a href="#l12.14"></a><span id="l12.14"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

