<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28990:98aa0bf2e719d22931edfe3e942f66d32ee0e80f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 98aa0bf2e719d22931edfe3e942f66d32ee0e80f" />
<meta property="og:url" content="/comm-central/rev/98aa0bf2e719d22931edfe3e942f66d32ee0e80f" />
<meta property="og:description" content="Bug 1603359 - Add pref mail.sanitize_date_header that if set converts date to UTC and rounds to closest minute. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 98aa0bf2e719d22931edfe3e942f66d32ee0e80f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/98aa0bf2e719d22931edfe3e942f66d32ee0e80f">shortlog</a> |
<a href="/comm-central/log/98aa0bf2e719d22931edfe3e942f66d32ee0e80f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/98aa0bf2e719d22931edfe3e942f66d32ee0e80f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/98aa0bf2e719d22931edfe3e942f66d32ee0e80f">files</a> |
changeset |
<a href="/comm-central/raw-rev/98aa0bf2e719d22931edfe3e942f66d32ee0e80f">raw</a>  | <a href="/comm-central/archive/98aa0bf2e719d22931edfe3e942f66d32ee0e80f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1603359">Bug 1603359</a> - Add pref mail.sanitize_date_header that if set converts date to UTC and rounds to closest minute. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#115;&#101;&#103;&#102;&#97;&#117;&#108;&#116;&#32;&#60;&#115;&#101;&#103;&#102;&#97;&#117;&#108;&#116;&#64;&#114;&#105;&#115;&#101;&#117;&#112;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 14 Mar 2020 14:21:03 +0200</td></tr>

<tr>
 <td>changeset 28990</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/98aa0bf2e719d22931edfe3e942f66d32ee0e80f">98aa0bf2e719d22931edfe3e942f66d32ee0e80f</a></td>
</tr>



<tr>
<td>parent 28989</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/73dac954fb5be34175dfe3fbd36231963b199326">73dac954fb5be34175dfe3fbd36231963b199326</a>
</td>
</tr>

<tr>
<td>child 28991</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c84838d1d59664681b4abd35f5ee9f7c0dad6769">c84838d1d59664681b4abd35f5ee9f7c0dad6769</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=98aa0bf2e719d22931edfe3e942f66d32ee0e80f">17141</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 15 Mar 2020 22:47:13 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@98aa0bf2e719 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=98aa0bf2e719d22931edfe3e942f66d32ee0e80f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=98aa0bf2e719d22931edfe3e942f66d32ee0e80f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=98aa0bf2e719d22931edfe3e942f66d32ee0e80f&newProject=comm-central&newRevision=98aa0bf2e719d22931edfe3e942f66d32ee0e80f&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=98aa0bf2e719d22931edfe3e942f66d32ee0e80f&newProject=comm-central&newRevision=98aa0bf2e719d22931edfe3e942f66d32ee0e80f&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=98aa0bf2e719d22931edfe3e942f66d32ee0e80f&newProject=comm-central&newRevision=98aa0bf2e719d22931edfe3e942f66d32ee0e80f&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1603359">1603359</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1603359">Bug 1603359</a> - Add pref mail.sanitize_date_header that if set converts date to UTC and rounds to closest minute. r=mkmelin

If the preference is enabled, the date header is sanitized
by doing the following:

1. Convert the date to UTC, to prevent leaking the local time zone.
2. Round the date down to the most recent whole minute, to prevent
   fingerprinting of small clock offsets.

The intended use case is to prevent to prevent local time disclosure, e.g. in Tor usage.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/jsmime/jsmime.js">mailnews/mime/jsmime/jsmime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/jsmime/jsmime.js">file</a> |
<a href="/comm-central/annotate/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/jsmime/jsmime.js">annotate</a> |
<a href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/jsmime/jsmime.js">diff</a> |
<a href="/comm-central/comparison/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/jsmime/jsmime.js">comparison</a> |
<a href="/comm-central/log/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/jsmime/jsmime.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/public/msgIStructuredHeaders.idl">mailnews/mime/public/msgIStructuredHeaders.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/public/msgIStructuredHeaders.idl">file</a> |
<a href="/comm-central/annotate/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/public/msgIStructuredHeaders.idl">annotate</a> |
<a href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/public/msgIStructuredHeaders.idl">diff</a> |
<a href="/comm-central/comparison/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/public/msgIStructuredHeaders.idl">comparison</a> |
<a href="/comm-central/log/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/public/msgIStructuredHeaders.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/src/MimeJSComponents.jsm">mailnews/mime/src/MimeJSComponents.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/src/MimeJSComponents.jsm">file</a> |
<a href="/comm-central/annotate/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/src/MimeJSComponents.jsm">annotate</a> |
<a href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/src/MimeJSComponents.jsm">diff</a> |
<a href="/comm-central/comparison/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/src/MimeJSComponents.jsm">comparison</a> |
<a href="/comm-central/log/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/src/MimeJSComponents.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/test/unit/test_structured_headers.js">mailnews/mime/test/unit/test_structured_headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/test/unit/test_structured_headers.js">file</a> |
<a href="/comm-central/annotate/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/test/unit/test_structured_headers.js">annotate</a> |
<a href="/comm-central/diff/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/test/unit/test_structured_headers.js">diff</a> |
<a href="/comm-central/comparison/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/test/unit/test_structured_headers.js">comparison</a> |
<a href="/comm-central/log/98aa0bf2e719d22931edfe3e942f66d32ee0e80f/mailnews/mime/test/unit/test_structured_headers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -711,17 +711,18 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l1.4"></a><span id="l1.4">   {</span>
<a href="#l1.5"></a><span id="l1.5">     nsCOMPtr&lt;msgIWritableStructuredHeaders&gt; outputHeaders =</span>
<a href="#l1.6"></a><span id="l1.6">         do_CreateInstance(NS_ISTRUCTUREDHEADERS_CONTRACTID);</span>
<a href="#l1.7"></a><span id="l1.7">     status = mime_generate_headers(mCompFields, m_deliver_mode, outputHeaders);</span>
<a href="#l1.8"></a><span id="l1.8">     if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">     // Convert the blocks of headers into a single string for emission.</span>
<a href="#l1.11"></a><span id="l1.11">     nsAutoCString headers;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    outputHeaders-&gt;BuildMimeText(headers);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    outputHeaders-&gt;BuildMimeText(</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        Preferences::GetBool(&quot;mail.sanitize_date_header&quot;, false), headers);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">     // If we converted HTML into plaintext, the plaintext part (plainpart)</span>
<a href="#l1.17"></a><span id="l1.17">     // already has its content-type and content-transfer-encoding (&quot;other&quot;)</span>
<a href="#l1.18"></a><span id="l1.18">     // headers set.</span>
<a href="#l1.19"></a><span id="l1.19">     //</span>
<a href="#l1.20"></a><span id="l1.20">     // In the specific case where such a plaintext part is the top-level message</span>
<a href="#l1.21"></a><span id="l1.21">     // part (iff an HTML message is being sent as text only and no other</span>
<a href="#l1.22"></a><span id="l1.22">     // attachments exist) we want to preserve the original plainpart headers,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -18,16 +18,21 @@ pref(&quot;mail.inline_attachments.text&quot;,    </span>
<a href="#l2.4"></a><span id="l2.4"> pref(&quot;mail.reply_quote_inline&quot;,             false);</span>
<a href="#l2.5"></a><span id="l2.5"> // When in a message the List-Post header contains the content of the Reply-To</span>
<a href="#l2.6"></a><span id="l2.6"> // (which is called &quot;Reply-To Munging&quot;) we override the Reply-To header with</span>
<a href="#l2.7"></a><span id="l2.7"> // the From header.</span>
<a href="#l2.8"></a><span id="l2.8"> pref(&quot;mail.override_list_reply_to&quot;, true);</span>
<a href="#l2.9"></a><span id="l2.9"> // hidden pref for controlling if the Content-Language header</span>
<a href="#l2.10"></a><span id="l2.10"> // should be set.</span>
<a href="#l2.11"></a><span id="l2.11"> pref(&quot;mail.suppress_content_language&quot;, false);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+// Pref for controlling if the Date header is sanitized, by:</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+// 1. Converting the date to UTC, to prevent leaking the local time zone.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+// 2. Rounding the date down to the most recent whole minute, to prevent</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+//    fingerprinting of small clock offsets.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+pref(&quot;mail.sanitize_date_header&quot;, false);</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> // hidden pref for controlling if the user agent string</span>
<a href="#l2.19"></a><span id="l2.19"> // is displayed in the message pane or not...</span>
<a href="#l2.20"></a><span id="l2.20"> pref(&quot;mailnews.headers.showUserAgent&quot;,       false);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> // hidden pref for controlling if the organization string</span>
<a href="#l2.23"></a><span id="l2.23"> // is displayed in the message pane or not...</span>
<a href="#l2.24"></a><span id="l2.24"> pref(&quot;mailnews.headers.showOrganization&quot;,    false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/mime/jsmime/jsmime.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/mime/jsmime/jsmime.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2849,16 +2849,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">      *     an error will be thrown and encoding will not be possible.</span>
<a href="#l3.5"></a><span id="l3.5">      *   @param [options.useASCII=true] {Boolean}</span>
<a href="#l3.6"></a><span id="l3.6">      *     If true, then RFC 2047 and RFC 2231 encoding of headers will be performed</span>
<a href="#l3.7"></a><span id="l3.7">      *     as needed to retain headers as ASCII.</span>
<a href="#l3.8"></a><span id="l3.8">      */</span>
<a href="#l3.9"></a><span id="l3.9">     function HeaderEmitter(handler, options) {</span>
<a href="#l3.10"></a><span id="l3.10">       // The inferred value of options.useASCII</span>
<a href="#l3.11"></a><span id="l3.11">       this._useASCII = options.useASCII === undefined ? true : options.useASCII;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+      this._sanitizeDate =</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        options.sanitizeDate === undefined ? false : options.sanitizeDate;</span>
<a href="#l3.14"></a><span id="l3.14">       // The handler to use.</span>
<a href="#l3.15"></a><span id="l3.15">       this._handler = handler;</span>
<a href="#l3.16"></a><span id="l3.16">       /**</span>
<a href="#l3.17"></a><span id="l3.17">        * The current line being built; note that we may insert a line break in the</span>
<a href="#l3.18"></a><span id="l3.18">        * middle to keep under the maximum line length.</span>
<a href="#l3.19"></a><span id="l3.19">        *</span>
<a href="#l3.20"></a><span id="l3.20">        * @type String</span>
<a href="#l3.21"></a><span id="l3.21">        * @private</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -3453,46 +3455,76 @@</span>
<a href="#l3.23"></a><span id="l3.23">      */</span>
<a href="#l3.24"></a><span id="l3.24">     HeaderEmitter.prototype.addDate = function(date) {</span>
<a href="#l3.25"></a><span id="l3.25">       // Rather than make a header plastered with NaN values, throw an error on</span>
<a href="#l3.26"></a><span id="l3.26">       // specific invalid dates.</span>
<a href="#l3.27"></a><span id="l3.27">       if (isNaN(date.getTime())) {</span>
<a href="#l3.28"></a><span id="l3.28">         throw new Error(&quot;Cannot encode an invalid date&quot;);</span>
<a href="#l3.29"></a><span id="l3.29">       }</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+      let fullYear,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+        month,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+        dayOfMonth,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+        dayOfWeek,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        hours,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+        minutes,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        seconds,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+        tzOffset;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      if (this._sanitizeDate) {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+        fullYear = date.getUTCFullYear();</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+        month = date.getUTCMonth();</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+        dayOfMonth = date.getUTCDate();</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+        dayOfWeek = date.getUTCDay();</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+        hours = date.getUTCHours();</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+        minutes = date.getUTCMinutes();</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+        // To reduce the chance of fingerprinting the clock offset,</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+        // round the time down to the nearest minute.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+        seconds = 0;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+        tzOffset = 0;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+      } else {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+        fullYear = date.getFullYear();</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+        month = date.getMonth();</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+        dayOfMonth = date.getDate();</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+        dayOfWeek = date.getDay();</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+        hours = date.getHours();</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+        minutes = date.getMinutes();</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+        seconds = date.getSeconds();</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+        tzOffset = date.getTimezoneOffset();</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+      }</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62">       // RFC 5322 says years can't be before 1900. The after 9999 is a bit that</span>
<a href="#l3.63"></a><span id="l3.63">       // derives from the specification saying that years have 4 digits.</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-      if (date.getFullYear() &lt; 1900 || date.getFullYear() &gt; 9999) {</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+      if (fullYear &lt; 1900 || fullYear &gt; 9999) {</span>
<a href="#l3.66"></a><span id="l3.66">         throw new Error(&quot;Date year is out of encodable range&quot;);</span>
<a href="#l3.67"></a><span id="l3.67">       }</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69">       // Start by computing the timezone offset for a day. We lack a good format, so</span>
<a href="#l3.70"></a><span id="l3.70">       // the the 0-padding is done by hand. Note that the tzoffset we output is in</span>
<a href="#l3.71"></a><span id="l3.71">       // the form ±hhmm, so we need to separate the offset (in minutes) into an hour</span>
<a href="#l3.72"></a><span id="l3.72">       // and minute pair.</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-      let tzOffset = date.getTimezoneOffset();</span>
<a href="#l3.74"></a><span id="l3.74">       let tzOffHours = Math.abs(Math.trunc(tzOffset / 60));</span>
<a href="#l3.75"></a><span id="l3.75">       let tzOffMinutes = Math.abs(tzOffset) % 60;</span>
<a href="#l3.76"></a><span id="l3.76">       let tzOffsetStr =</span>
<a href="#l3.77"></a><span id="l3.77">         (tzOffset &gt; 0 ? &quot;-&quot; : &quot;+&quot;) +</span>
<a href="#l3.78"></a><span id="l3.78">         padTo2Digits(tzOffHours) +</span>
<a href="#l3.79"></a><span id="l3.79">         padTo2Digits(tzOffMinutes);</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81">       // Convert the day-time figure into a single value to avoid unwanted line</span>
<a href="#l3.82"></a><span id="l3.82">       // breaks in the middle.</span>
<a href="#l3.83"></a><span id="l3.83">       let dayTime = [</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-        kDaysOfWeek[date.getDay()] + &quot;,&quot;,</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-        date.getDate(),</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-        mimeutils.kMonthNames[date.getMonth()],</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-        date.getFullYear(),</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-        padTo2Digits(date.getHours()) +</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+        kDaysOfWeek[dayOfWeek] + &quot;,&quot;,</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+        dayOfMonth,</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+        mimeutils.kMonthNames[month],</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+        fullYear,</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+        padTo2Digits(hours) +</span>
<a href="#l3.94"></a><span id="l3.94">           &quot;:&quot; +</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-          padTo2Digits(date.getMinutes()) +</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+          padTo2Digits(minutes) +</span>
<a href="#l3.97"></a><span id="l3.97">           &quot;:&quot; +</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-          padTo2Digits(date.getSeconds()),</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+          padTo2Digits(seconds),</span>
<a href="#l3.100"></a><span id="l3.100">         tzOffsetStr,</span>
<a href="#l3.101"></a><span id="l3.101">       ].join(&quot; &quot;);</span>
<a href="#l3.102"></a><span id="l3.102">       this.addText(dayTime, false);</span>
<a href="#l3.103"></a><span id="l3.103">     };</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105">     /**</span>
<a href="#l3.106"></a><span id="l3.106">      * Signal that the current header has been finished encoding.</span>
<a href="#l3.107"></a><span id="l3.107">      *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/public/msgIStructuredHeaders.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/public/msgIStructuredHeaders.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -101,18 +101,20 @@ interface msgIStructuredHeaders : nsISup</span>
<a href="#l4.4"></a><span id="l4.4">    *</span>
<a href="#l4.5"></a><span id="l4.5">    * The header values are emitted in an ASCII form, unless internationalized</span>
<a href="#l4.6"></a><span id="l4.6">    * email addresses are involved. The extra CRLF indicating the end of headers</span>
<a href="#l4.7"></a><span id="l4.7">    * is not included in this representation.</span>
<a href="#l4.8"></a><span id="l4.8">    *</span>
<a href="#l4.9"></a><span id="l4.9">    * This accessor is provided mainly for the benefit of C++ consumers of this</span>
<a href="#l4.10"></a><span id="l4.10">    * interface, since the JSMime headeremitter functionality allows more</span>
<a href="#l4.11"></a><span id="l4.11">    * fine-grained customization of the results.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+   *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+   * @param sanitizeDate    If true convert the date to UTC and round to closest minute.</span>
<a href="#l4.14"></a><span id="l4.14">    */</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-   AUTF8String buildMimeText();</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+   AUTF8String buildMimeText([optional] in boolean sanitizeDate);</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> };</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> /**</span>
<a href="#l4.21"></a><span id="l4.21">  * An interface that enhances msgIStructuredHeaders by allowing the values of</span>
<a href="#l4.22"></a><span id="l4.22">  * headers to be modified.</span>
<a href="#l4.23"></a><span id="l4.23">  */</span>
<a href="#l4.24"></a><span id="l4.24"> [scriptable, uuid(5dcbbef6-2356-45d8-86d7-b3e73f9c9a0c)]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/src/MimeJSComponents.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/src/MimeJSComponents.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -122,23 +122,24 @@ MimeStructuredHeaders.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">     value = value.replace(/\r\n/g, &quot;&quot;);</span>
<a href="#l5.5"></a><span id="l5.5">     return value;</span>
<a href="#l5.6"></a><span id="l5.6">   },</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">   get headerNames() {</span>
<a href="#l5.9"></a><span id="l5.9">     return new StringEnumerator(this._headers.keys());</span>
<a href="#l5.10"></a><span id="l5.10">   },</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  buildMimeText() {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  buildMimeText(sanitizeDate) {</span>
<a href="#l5.14"></a><span id="l5.14">     if (this._headers.size == 0) {</span>
<a href="#l5.15"></a><span id="l5.15">       return &quot;&quot;;</span>
<a href="#l5.16"></a><span id="l5.16">     }</span>
<a href="#l5.17"></a><span id="l5.17">     let handler = new HeaderHandler();</span>
<a href="#l5.18"></a><span id="l5.18">     let emitter = jsmime.headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l5.19"></a><span id="l5.19">       useASCII: true,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+      sanitizeDate,</span>
<a href="#l5.21"></a><span id="l5.21">     });</span>
<a href="#l5.22"></a><span id="l5.22">     for (let [value, header] of this._headers) {</span>
<a href="#l5.23"></a><span id="l5.23">       emitter.addStructuredHeader(value, header);</span>
<a href="#l5.24"></a><span id="l5.24">     }</span>
<a href="#l5.25"></a><span id="l5.25">     emitter.finish();</span>
<a href="#l5.26"></a><span id="l5.26">     return handler.value;</span>
<a href="#l5.27"></a><span id="l5.27">   },</span>
<a href="#l5.28"></a><span id="l5.28"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_structured_headers.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_structured_headers.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -230,9 +230,15 @@ add_task(async function checkBuildMimeTe</span>
<a href="#l6.4"></a><span id="l6.4">   let utf8Text = mimeText.replace(&quot;☃&quot;, &quot;\xe2\x98\x83&quot;);</span>
<a href="#l6.5"></a><span id="l6.5">   let mimeHeaders = Cc[&quot;@mozilla.org/messenger/mimeheaders;1&quot;].createInstance(</span>
<a href="#l6.6"></a><span id="l6.6">     Ci.nsIMimeHeaders</span>
<a href="#l6.7"></a><span id="l6.7">   );</span>
<a href="#l6.8"></a><span id="l6.8">   mimeHeaders.initialize(utf8Text);</span>
<a href="#l6.9"></a><span id="l6.9">   Assert.equal(mimeHeaders.getHeader(&quot;To&quot;)[0].email, &quot;user@☃.invalid&quot;);</span>
<a href="#l6.10"></a><span id="l6.10">   Assert.equal(mimeHeaders.buildMimeText(), mimeText);</span>
<a href="#l6.11"></a><span id="l6.11">   Assert.equal(mimeHeaders.allHeaders, utf8Text);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  // Check date header sanitization</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  headers = new StructuredHeaders();</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  headers.setHeader(&quot;Date&quot;, new Date(&quot;Fri, 6 Mar 2020 00:12:34 +0100&quot;));</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  mimeText = &quot;Date: Thu, 5 Mar 2020 23:12:00 +0000\r\n&quot;;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  Assert.equal(headers.buildMimeText(true), mimeText);</span>
<a href="#l6.18"></a><span id="l6.18"> });</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

