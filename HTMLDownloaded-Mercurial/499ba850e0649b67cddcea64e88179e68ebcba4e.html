<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29714:499ba850e0649b67cddcea64e88179e68ebcba4e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 499ba850e0649b67cddcea64e88179e68ebcba4e" />
<meta property="og:url" content="/comm-central/rev/499ba850e0649b67cddcea64e88179e68ebcba4e" />
<meta property="og:description" content="Bug 1518025 - Implemented handling of catchAll mail identities. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 499ba850e0649b67cddcea64e88179e68ebcba4e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/499ba850e0649b67cddcea64e88179e68ebcba4e">shortlog</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/499ba850e0649b67cddcea64e88179e68ebcba4e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e">files</a> |
changeset |
<a href="/comm-central/raw-rev/499ba850e0649b67cddcea64e88179e68ebcba4e">raw</a>  | <a href="/comm-central/archive/499ba850e0649b67cddcea64e88179e68ebcba4e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518025">Bug 1518025</a> - Implemented handling of catchAll mail identities. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#114;&#101;&#110;&#101;&#32;&#60;&#106;&#117;&#115;&#116;&#64;&#97;&#98;&#115;&#111;&#114;&#98;&#46;&#105;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 31 May 2020 13:53:23 +0300</td></tr>

<tr>
 <td>changeset 29714</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/499ba850e0649b67cddcea64e88179e68ebcba4e">499ba850e0649b67cddcea64e88179e68ebcba4e</a></td>
</tr>



<tr>
<td>parent 29713</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/255933b1225df282885afc07b0e6ef50b434f720">255933b1225df282885afc07b0e6ef50b434f720</a>
</td>
</tr>

<tr>
<td>child 29715</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/59a341e3a12ea8ea7b9c3e4b1369a207f461a957">59a341e3a12ea8ea7b9c3e4b1369a207f461a957</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=499ba850e0649b67cddcea64e88179e68ebcba4e">17498</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Sun, 31 May 2020 10:55:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@59a341e3a12e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=59a341e3a12ea8ea7b9c3e4b1369a207f461a957">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=59a341e3a12ea8ea7b9c3e4b1369a207f461a957&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=59a341e3a12ea8ea7b9c3e4b1369a207f461a957&newProject=comm-central&newRevision=255933b1225df282885afc07b0e6ef50b434f720&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=59a341e3a12ea8ea7b9c3e4b1369a207f461a957&newProject=comm-central&newRevision=255933b1225df282885afc07b0e6ef50b434f720&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=59a341e3a12ea8ea7b9c3e4b1369a207f461a957&newProject=comm-central&newRevision=255933b1225df282885afc07b0e6ef50b434f720&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518025">1518025</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518025">Bug 1518025</a> - Implemented handling of catchAll mail identities. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/calendar/lightning/content/lightning-item-panel.js">calendar/lightning/content/lightning-item-panel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/calendar/lightning/content/lightning-item-panel.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/calendar/lightning/content/lightning-item-panel.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/calendar/lightning/content/lightning-item-panel.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/calendar/lightning/content/lightning-item-panel.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/calendar/lightning/content/lightning-item-panel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/macMessengerMenu.js">mail/base/content/macMessengerMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/macMessengerMenu.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/macMessengerMenu.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/macMessengerMenu.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/macMessengerMenu.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/macMessengerMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MailUtils.jsm">mail/base/modules/MailUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MailUtils.jsm">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MailUtils.jsm">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MailUtils.jsm">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MailUtils.jsm">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MailUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MessageArchiver.jsm">mail/base/modules/MessageArchiver.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MessageArchiver.jsm">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MessageArchiver.jsm">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MessageArchiver.jsm">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MessageArchiver.jsm">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/base/modules/MessageArchiver.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/extensions/parent/ext-compose.js">mail/components/extensions/parent/ext-compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/extensions/parent/ext-compose.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/extensions/parent/ext-compose.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/extensions/parent/ext-compose.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/extensions/parent/ext-compose.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/extensions/parent/ext-compose.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/newmailaccount/content/accountProvisioner.js">mail/components/newmailaccount/content/accountProvisioner.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/newmailaccount/content/accountProvisioner.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/newmailaccount/content/accountProvisioner.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/newmailaccount/content/accountProvisioner.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/newmailaccount/content/accountProvisioner.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/components/newmailaccount/content/accountProvisioner.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/am-main.dtd">mail/locales/en-US/chrome/messenger/am-main.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/am-main.dtd">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/am-main.dtd">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/am-main.dtd">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/am-main.dtd">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/am-main.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/prefs.properties">mail/locales/en-US/chrome/messenger/prefs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/prefs.properties">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/prefs.properties">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/prefs.properties">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/prefs.properties">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/locales/en-US/chrome/messenger/prefs.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser.ini">mail/test/browser/composition/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser.ini">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser.ini">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser.ini">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser.ini">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser_replyCatchAll.js">mail/test/browser/composition/browser_replyCatchAll.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser_replyCatchAll.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser_replyCatchAll.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser_replyCatchAll.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser_replyCatchAll.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mail/test/browser/composition/browser_replyCatchAll.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.js">mailnews/base/prefs/content/am-identity-edit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.xhtml">mailnews/base/prefs/content/am-identity-edit.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.xhtml">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.xhtml">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.xhtml">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.xhtml">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-identity-edit.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.js">mailnews/base/prefs/content/am-main.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.xhtml">mailnews/base/prefs/content/am-main.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.xhtml">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.xhtml">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.xhtml">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.xhtml">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/prefs/content/am-main.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/public/nsIMsgIdentity.idl">mailnews/base/public/nsIMsgIdentity.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/public/nsIMsgIdentity.idl">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/public/nsIMsgIdentity.idl">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/public/nsIMsgIdentity.idl">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/public/nsIMsgIdentity.idl">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/public/nsIMsgIdentity.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/util/nsMsgIdentity.cpp">mailnews/base/util/nsMsgIdentity.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/util/nsMsgIdentity.cpp">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/util/nsMsgIdentity.cpp">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/util/nsMsgIdentity.cpp">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/util/nsMsgIdentity.cpp">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/base/util/nsMsgIdentity.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/public/nsIMsgComposeService.idl">mailnews/compose/public/nsIMsgComposeService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/public/nsIMsgComposeService.idl">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/public/nsIMsgComposeService.idl">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/public/nsIMsgComposeService.idl">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/public/nsIMsgComposeService.idl">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/public/nsIMsgComposeService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/extensions/newsblog/content/newsblogOverlay.js">mailnews/extensions/newsblog/content/newsblogOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/extensions/newsblog/content/newsblogOverlay.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/extensions/newsblog/content/newsblogOverlay.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/extensions/newsblog/content/newsblogOverlay.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/extensions/newsblog/content/newsblogOverlay.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/extensions/newsblog/content/newsblogOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/browser/mailNavigatorOverlay.js">suite/browser/mailNavigatorOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/browser/mailNavigatorOverlay.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/browser/mailNavigatorOverlay.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/browser/mailNavigatorOverlay.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/browser/mailNavigatorOverlay.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/browser/mailNavigatorOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailCommands.js">suite/mailnews/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailOverlay.js">suite/mailnews/content/mailOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailOverlay.js">file</a> |
<a href="/comm-central/annotate/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailOverlay.js">annotate</a> |
<a href="/comm-central/diff/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailOverlay.js">diff</a> |
<a href="/comm-central/comparison/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailOverlay.js">comparison</a> |
<a href="/comm-central/log/499ba850e0649b67cddcea64e88179e68ebcba4e/suite/mailnews/content/mailOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-panel.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-panel.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -470,16 +470,17 @@ function openNewTask() {</span>
<a href="#l1.4"></a><span id="l1.4"> function openNewMessage() {</span>
<a href="#l1.5"></a><span id="l1.5">   MailServices.compose.OpenComposeWindow(</span>
<a href="#l1.6"></a><span id="l1.6">     null,</span>
<a href="#l1.7"></a><span id="l1.7">     null,</span>
<a href="#l1.8"></a><span id="l1.8">     null,</span>
<a href="#l1.9"></a><span id="l1.9">     Ci.nsIMsgCompType.New,</span>
<a href="#l1.10"></a><span id="l1.10">     Ci.nsIMsgCompFormat.Default,</span>
<a href="#l1.11"></a><span id="l1.11">     null,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    null,</span>
<a href="#l1.13"></a><span id="l1.13">     null</span>
<a href="#l1.14"></a><span id="l1.14">   );</span>
<a href="#l1.15"></a><span id="l1.15"> }</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> /**</span>
<a href="#l1.18"></a><span id="l1.18">  * Open a new addressbook window</span>
<a href="#l1.19"></a><span id="l1.19">  */</span>
<a href="#l1.20"></a><span id="l1.20"> function openNewCardDialog() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2291,17 +2291,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">         }</span>
<a href="#l2.5"></a><span id="l2.5">         // If we get here it's a mixture, so have to examine all the messages.</span>
<a href="#l2.6"></a><span id="l2.6">       }</span>
<a href="#l2.7"></a><span id="l2.7">     }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">     // Either we've selected a small number of messages or we just can't</span>
<a href="#l2.10"></a><span id="l2.10">     // fast-path the result; examine all the messages.</span>
<a href="#l2.11"></a><span id="l2.11">     return this.selectedMessages.every(function(msg) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      let identity = MailUtils.getIdentityForHeader(msg);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      let [identity] = MailUtils.getIdentityForHeader(msg);</span>
<a href="#l2.14"></a><span id="l2.14">       return Boolean(identity &amp;&amp; identity.archiveEnabled);</span>
<a href="#l2.15"></a><span id="l2.15">     });</span>
<a href="#l2.16"></a><span id="l2.16">   },</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   /**</span>
<a href="#l2.19"></a><span id="l2.19">    * @return true if all the selected messages can be deleted from their</span>
<a href="#l2.20"></a><span id="l2.20">    * folders, false otherwise.</span>
<a href="#l2.21"></a><span id="l2.21">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/macMessengerMenu.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/macMessengerMenu.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -82,16 +82,17 @@ function writeNewMessageDock() {</span>
<a href="#l3.4"></a><span id="l3.4">   // Default identity will be used as sender for the new message.</span>
<a href="#l3.5"></a><span id="l3.5">   MailServices.compose.OpenComposeWindow(</span>
<a href="#l3.6"></a><span id="l3.6">     null,</span>
<a href="#l3.7"></a><span id="l3.7">     null,</span>
<a href="#l3.8"></a><span id="l3.8">     null,</span>
<a href="#l3.9"></a><span id="l3.9">     Ci.nsIMsgCompType.New,</span>
<a href="#l3.10"></a><span id="l3.10">     Ci.nsIMsgCompFormat.Default,</span>
<a href="#l3.11"></a><span id="l3.11">     null,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    null,</span>
<a href="#l3.13"></a><span id="l3.13">     null</span>
<a href="#l3.14"></a><span id="l3.14">   );</span>
<a href="#l3.15"></a><span id="l3.15"> }</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> /**</span>
<a href="#l3.18"></a><span id="l3.18">  * Open the address book window</span>
<a href="#l3.19"></a><span id="l3.19">  */</span>
<a href="#l3.20"></a><span id="l3.20"> function openAddressBookDock() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1323,17 +1323,17 @@ function IsSendUnsentMsgsEnabled(unsentM</span>
<a href="#l4.4"></a><span id="l4.4">     return unsentMsgsFolder.getTotalMessages(false) &gt; 0;</span>
<a href="#l4.5"></a><span id="l4.5">   }</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   // Otherwise, we don't know where we are, so use the current identity and</span>
<a href="#l4.8"></a><span id="l4.8">   // find out if we have messages or not via that.</span>
<a href="#l4.9"></a><span id="l4.9">   let identity;</span>
<a href="#l4.10"></a><span id="l4.10">   let folders = GetSelectedMsgFolders();</span>
<a href="#l4.11"></a><span id="l4.11">   if (folders.length &gt; 0) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    identity = MailUtils.getIdentityForServer(folders[0].server);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    [identity] = MailUtils.getIdentityForServer(folders[0].server);</span>
<a href="#l4.14"></a><span id="l4.14">   }</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">   if (!identity) {</span>
<a href="#l4.17"></a><span id="l4.17">     let defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l4.18"></a><span id="l4.18">     if (defaultAccount) {</span>
<a href="#l4.19"></a><span id="l4.19">       identity = defaultAccount.defaultIdentity;</span>
<a href="#l4.20"></a><span id="l4.20">     }</span>
<a href="#l4.21"></a><span id="l4.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -153,17 +153,17 @@ function ComposeMessage(type, format, fo</span>
<a href="#l5.4"></a><span id="l5.4">         type == msgComposeType.New</span>
<a href="#l5.5"></a><span id="l5.5">       ) {</span>
<a href="#l5.6"></a><span id="l5.6">         type = msgComposeType.NewsPost;</span>
<a href="#l5.7"></a><span id="l5.7">         newsgroup = folder.folderURL;</span>
<a href="#l5.8"></a><span id="l5.8">       }</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">       identity = folder.customIdentity;</span>
<a href="#l5.11"></a><span id="l5.11">       if (!identity) {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        identity = MailUtils.getIdentityForServer(server);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+        [identity] = MailUtils.getIdentityForServer(server);</span>
<a href="#l5.14"></a><span id="l5.14">       }</span>
<a href="#l5.15"></a><span id="l5.15">       // dump(&quot;identity = &quot; + identity + &quot;\n&quot;);</span>
<a href="#l5.16"></a><span id="l5.16">     }</span>
<a href="#l5.17"></a><span id="l5.17">   } catch (ex) {</span>
<a href="#l5.18"></a><span id="l5.18">     dump(&quot;failed to get an identity to pre-select: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l5.19"></a><span id="l5.19">   }</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   // dump(&quot;\nComposeMessage from XUL: &quot; + identity + &quot;\n&quot;);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -174,28 +174,30 @@ function ComposeMessage(type, format, fo</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">       MailServices.compose.OpenComposeWindow(</span>
<a href="#l5.25"></a><span id="l5.25">         null,</span>
<a href="#l5.26"></a><span id="l5.26">         null,</span>
<a href="#l5.27"></a><span id="l5.27">         null,</span>
<a href="#l5.28"></a><span id="l5.28">         type,</span>
<a href="#l5.29"></a><span id="l5.29">         format,</span>
<a href="#l5.30"></a><span id="l5.30">         identity,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+        null,</span>
<a href="#l5.32"></a><span id="l5.32">         msgWindow</span>
<a href="#l5.33"></a><span id="l5.33">       );</span>
<a href="#l5.34"></a><span id="l5.34">       return;</span>
<a href="#l5.35"></a><span id="l5.35">     case msgComposeType.NewsPost:</span>
<a href="#l5.36"></a><span id="l5.36">       // dump(&quot;OpenComposeWindow with &quot; + identity + &quot; and &quot; + newsgroup + &quot;\n&quot;);</span>
<a href="#l5.37"></a><span id="l5.37">       MailServices.compose.OpenComposeWindow(</span>
<a href="#l5.38"></a><span id="l5.38">         null,</span>
<a href="#l5.39"></a><span id="l5.39">         null,</span>
<a href="#l5.40"></a><span id="l5.40">         newsgroup,</span>
<a href="#l5.41"></a><span id="l5.41">         type,</span>
<a href="#l5.42"></a><span id="l5.42">         format,</span>
<a href="#l5.43"></a><span id="l5.43">         identity,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+        null,</span>
<a href="#l5.45"></a><span id="l5.45">         msgWindow</span>
<a href="#l5.46"></a><span id="l5.46">       );</span>
<a href="#l5.47"></a><span id="l5.47">       return;</span>
<a href="#l5.48"></a><span id="l5.48">     case msgComposeType.ForwardAsAttachment:</span>
<a href="#l5.49"></a><span id="l5.49">       if (messageArray &amp;&amp; messageArray.length) {</span>
<a href="#l5.50"></a><span id="l5.50">         // If we have more than one ForwardAsAttachment then pass null instead</span>
<a href="#l5.51"></a><span id="l5.51">         // of the header to tell the compose service to work out the attachment</span>
<a href="#l5.52"></a><span id="l5.52">         // subjects from the URIs.</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineat">@@ -205,16 +207,17 @@ function ComposeMessage(type, format, fo</span>
<a href="#l5.54"></a><span id="l5.54">             : messenger.msgHdrFromURI(messageArray[0]);</span>
<a href="#l5.55"></a><span id="l5.55">         MailServices.compose.OpenComposeWindow(</span>
<a href="#l5.56"></a><span id="l5.56">           null,</span>
<a href="#l5.57"></a><span id="l5.57">           hdr,</span>
<a href="#l5.58"></a><span id="l5.58">           messageArray.join(&quot;,&quot;),</span>
<a href="#l5.59"></a><span id="l5.59">           type,</span>
<a href="#l5.60"></a><span id="l5.60">           format,</span>
<a href="#l5.61"></a><span id="l5.61">           identity,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+          null,</span>
<a href="#l5.63"></a><span id="l5.63">           msgWindow</span>
<a href="#l5.64"></a><span id="l5.64">         );</span>
<a href="#l5.65"></a><span id="l5.65">       }</span>
<a href="#l5.66"></a><span id="l5.66">       return;</span>
<a href="#l5.67"></a><span id="l5.67">     default:</span>
<a href="#l5.68"></a><span id="l5.68">       if (!messageArray) {</span>
<a href="#l5.69"></a><span id="l5.69">         return;</span>
<a href="#l5.70"></a><span id="l5.70">       }</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineat">@@ -237,34 +240,125 @@ function ComposeMessage(type, format, fo</span>
<a href="#l5.72"></a><span id="l5.72">             messageUri,</span>
<a href="#l5.73"></a><span id="l5.73">             type,</span>
<a href="#l5.74"></a><span id="l5.74">             format,</span>
<a href="#l5.75"></a><span id="l5.75">             identity,</span>
<a href="#l5.76"></a><span id="l5.76">             msgWindow</span>
<a href="#l5.77"></a><span id="l5.77">           );</span>
<a href="#l5.78"></a><span id="l5.78">         } else {</span>
<a href="#l5.79"></a><span id="l5.79">           // Replies come here.</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-          let hdrIdentity = MailUtils.getIdentityForHeader(</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-            hdr,</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-            type,</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-            findDeliveredToIdentityEmail(hdr)</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-          );</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-          if (ignoreQuote) {</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-            type += msgComposeType.ReplyIgnoreQuote;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+          let useCatchAll = false;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+          // Check if we are using catchAll on any identity. If current</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+          // folder has some customIdentity set, ignore catchAll settings.</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+          if (!(hdr.folder &amp;&amp; hdr.folder.customIdentity)) {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+            useCatchAll = MailServices.accounts.allIdentities.some(</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+              identity =&gt; identity.catchAll</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+            );</span>
<a href="#l5.94"></a><span id="l5.94">           }</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-          MailServices.compose.OpenComposeWindow(</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-            null,</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-            hdr,</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-            messageUri,</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-            type,</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-            format,</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-            hdrIdentity,</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-            msgWindow</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-          );</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+          if (useCatchAll) {</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+            // If we use catchAll, we need to get all headers</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+            // MsgHdr retrieval is asynchronous, do everything in the callback.</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+            MsgHdrToMimeMessage(</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+              hdr,</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+              null,</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+              function(hdr, aMimeMsg) {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+                let catchAllHeaders = Services.prefs.getStringPref(</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+                  &quot;mail.compose.catchAllHeaders&quot;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+                ).split(&quot;,&quot;).map(header =&gt; header.toLowerCase().trim());</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+                // Collect probable senders addresses from given headers.</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+                let collectedHeaderAddresses = &quot;&quot;;</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+                for (let header of catchAllHeaders) {</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+                  if (aMimeMsg.has(header)) {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+                    for (let mimeMsgHeader of aMimeMsg.headers[header]) {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+                      collectedHeaderAddresses +=</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+                        MailServices.headerParser</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+                          .parseEncodedHeaderW(mimeMsgHeader)</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+                          .toString() + &quot;,&quot;;</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+                    }</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+                  }</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+                }</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+                let [identity, matchingHint] = MailUtils.getIdentityForHeader(</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+                  hdr,</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+                  type,</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+                  collectedHeaderAddresses</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+                );</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+                // The found identity might have no catchAll enabled.</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+                if (</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+                  identity.catchAll &amp;&amp;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+                  matchingHint</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+                ) {</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+                  // If name is not set in matchingHint, search trough other hints.</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+                  if (</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+                    matchingHint.email &amp;&amp;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+                    !matchingHint.name</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+                  ) {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+                    let hints = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+                      hdr.recipients +</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+                        &quot;,&quot; +</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+                        hdr.ccList +</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+                        &quot;,&quot; +</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+                        collectedHeaderAddresses</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+                    );</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+                    for (let hint of hints) {</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+                      if (</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+                        hint.name &amp;&amp;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+                        hint.email.toLowerCase() ==</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+                          matchingHint.email.toLowerCase()</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+                      ) {</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+                        matchingHint = MailServices.headerParser.makeMailboxObject(</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+                          hint.name,</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+                          matchingHint.email</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+                        );</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+                        break;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+                      }</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+                    }</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+                  }</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+                } else {</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+                  matchingHint = MailServices.headerParser.makeMailboxObject(</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+                    &quot;&quot;,</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+                    &quot;&quot;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+                  );</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+                }</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+                // Now open compose window and use matching hint as reply sender.</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+                MailServices.compose.OpenComposeWindow(</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+                  null,</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+                  hdr,</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+                  messageUri,</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+                  type,</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+                  format,</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+                  identity,</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+                  matchingHint.toString(),</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+                  msgWindow</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+                );</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+              },</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+              true,</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+              { saneBodySize: true, partsOnDemand: true }</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+            );</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+          } else {</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+            // Fall back to traditional behavior.</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+            let [hdrIdentity] = MailUtils.getIdentityForHeader(</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+              hdr,</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+              type,</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+              findDeliveredToIdentityEmail(hdr)</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+            );</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+            MailServices.compose.OpenComposeWindow(</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+              null,</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+              hdr,</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+              messageUri,</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+              type,</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+              format,</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+              hdrIdentity,</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+              null,</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+              msgWindow</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+            );</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+          }</span>
<a href="#l5.205"></a><span id="l5.205">         }</span>
<a href="#l5.206"></a><span id="l5.206">       }</span>
<a href="#l5.207"></a><span id="l5.207">   }</span>
<a href="#l5.208"></a><span id="l5.208"> }</span>
<a href="#l5.209"></a><span id="l5.209"> /* eslint-enable complexity */</span>
<a href="#l5.210"></a><span id="l5.210"> </span>
<a href="#l5.211"></a><span id="l5.211"> function Subscribe(preselectedMsgFolder) {</span>
<a href="#l5.212"></a><span id="l5.212">   window.openDialog(</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineat">@@ -386,17 +480,17 @@ saveAsUrlListener.prototype = {</span>
<a href="#l5.214"></a><span id="l5.214">   OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l5.215"></a><span id="l5.215">     messenger.saveAs(this.uri, false, this.identity, null);</span>
<a href="#l5.216"></a><span id="l5.216">   },</span>
<a href="#l5.217"></a><span id="l5.217"> };</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219"> function SaveAsTemplate(uri) {</span>
<a href="#l5.220"></a><span id="l5.220">   if (uri) {</span>
<a href="#l5.221"></a><span id="l5.221">     let hdr = messenger.msgHdrFromURI(uri);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-    let identity = MailUtils.getIdentityForHeader(</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+    let [identity] = MailUtils.getIdentityForHeader(</span>
<a href="#l5.224"></a><span id="l5.224">       hdr,</span>
<a href="#l5.225"></a><span id="l5.225">       Ci.nsIMsgCompType.Template</span>
<a href="#l5.226"></a><span id="l5.226">     );</span>
<a href="#l5.227"></a><span id="l5.227">     let templates = MailUtils.getOrCreateFolder(identity.stationeryFolder);</span>
<a href="#l5.228"></a><span id="l5.228">     if (!templates.parent) {</span>
<a href="#l5.229"></a><span id="l5.229">       templates.setFlag(Ci.nsMsgFolderFlags.Templates);</span>
<a href="#l5.230"></a><span id="l5.230">       let isAsync = templates.server.protocolInfo.foldersCreatedAsync;</span>
<a href="#l5.231"></a><span id="l5.231">       templates.createStorageIfMissing(new saveAsUrlListener(uri, identity));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1653,17 +1653,17 @@ function IsReplyAllEnabled() {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   // If we've got any BCCed addresses (because we sent the message), add</span>
<a href="#l6.6"></a><span id="l6.6">   // them as well.</span>
<a href="#l6.7"></a><span id="l6.7">   if (&quot;bcc&quot; in currentHeaderData) {</span>
<a href="#l6.8"></a><span id="l6.8">     addresses += currentHeaderData.bcc.headerValue;</span>
<a href="#l6.9"></a><span id="l6.9">   }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   // Check to see if my email address is in the list of addresses.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  let myIdentity = MailUtils.getIdentityForHeader(msgHdr);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  let [myIdentity] = MailUtils.getIdentityForHeader(msgHdr);</span>
<a href="#l6.14"></a><span id="l6.14">   let myEmail = myIdentity ? myIdentity.email : null;</span>
<a href="#l6.15"></a><span id="l6.15">   // We aren't guaranteed to have an email address, so guard against that.</span>
<a href="#l6.16"></a><span id="l6.16">   let imInAddresses =</span>
<a href="#l6.17"></a><span id="l6.17">     myEmail &amp;&amp; addresses.toLowerCase().includes(myEmail.toLowerCase());</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   // Now, let's get the number of unique addresses.</span>
<a href="#l6.20"></a><span id="l6.20">   let uniqueAddresses = MailServices.headerParser.removeDuplicateAddresses(</span>
<a href="#l6.21"></a><span id="l6.21">     addresses,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/modules/MailUtils.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/modules/MailUtils.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -415,75 +415,99 @@ var MailUtils = {</span>
<a href="#l7.4"></a><span id="l7.4">   /**</span>
<a href="#l7.5"></a><span id="l7.5">    * Get the identity that most likely is the best one to use, given the hint.</span>
<a href="#l7.6"></a><span id="l7.6">    * @param {nsIMsgIdentity[]} identities - The candidates to pick from.</span>
<a href="#l7.7"></a><span id="l7.7">    * @param {String} [optionalHint] - String containing comma separated mailboxes.</span>
<a href="#l7.8"></a><span id="l7.8">    * @param {Boolean} useDefault - If true, use the default identity of the</span>
<a href="#l7.9"></a><span id="l7.9">    *   account as last choice. This is useful when all default account as last</span>
<a href="#l7.10"></a><span id="l7.10">    *   choice. This is useful when all identities are passed in. Otherwise, use</span>
<a href="#l7.11"></a><span id="l7.11">    *   the first entity in the list.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+   * @returns {Array} - An array of two elements, [identity, matchingHint].</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+   *   identity is an nsIMsgIdentity and matchingHint is a string.</span>
<a href="#l7.14"></a><span id="l7.14">    */</span>
<a href="#l7.15"></a><span id="l7.15">   getBestIdentity(identities, optionalHint, useDefault = false) {</span>
<a href="#l7.16"></a><span id="l7.16">     let identityCount = identities.length;</span>
<a href="#l7.17"></a><span id="l7.17">     if (identityCount &lt; 1) {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-      return null;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+      return [ null, null ];</span>
<a href="#l7.20"></a><span id="l7.20">     }</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-    // If we have more than one identity and a hint to help us pick one.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-    if (identityCount &gt; 1 &amp;&amp; optionalHint) {</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-      // Normalize case on the optional hint to improve our chances of</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-      // finding a match.</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-      optionalHint = optionalHint.toLowerCase();</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-      let hints = optionalHint.toLowerCase().split(&quot;,&quot;);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+    // If we have a hint to help us pick one identity, search for a match.</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+    // Even if we only have one identity, check which hint might match.</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    if (optionalHint) {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+      let hints = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+        optionalHint</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+      );</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-      for (let i = 0; i &lt; hints.length; i++) {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+      for (let hint of hints) {</span>
<a href="#l7.37"></a><span id="l7.37">         for (let identity of identities) {</span>
<a href="#l7.38"></a><span id="l7.38">           if (!identity.email) {</span>
<a href="#l7.39"></a><span id="l7.39">             continue;</span>
<a href="#l7.40"></a><span id="l7.40">           }</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-          if (</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-            hints[i].trim() == identity.email.toLowerCase() ||</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-            hints[i].includes(&quot;&lt;&quot; + identity.email.toLowerCase() + &quot;&gt;&quot;)</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-          ) {</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-            return identity;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+          if (hint.email.toLowerCase() == identity.email.toLowerCase()) {</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+            return [ identity, hint ];</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+          }</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+        }</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+      }</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+      // Lets search again, this time for a matching domain if</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+      // catchAll is enabled.</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+      for (let hint of hints) {</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+        let hintParts = hint.email.split(&quot;@&quot;);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+        if (hintParts.length != 2) {</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+          continue;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+        }</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+        let hintDomain = hintParts[1].trim().toLowerCase();</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+        for (let identity of identities) {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+          if (!identity.email || !identity.catchAll) {</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+            continue;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+          }</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+          let emailParts = identity.email.split(&quot;@&quot;);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+          if (emailParts.length != 2) {</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+            continue;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+          }</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+          if (hintDomain == emailParts[1].trim().toLowerCase()) {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+            return [ identity, hint ];</span>
<a href="#l7.70"></a><span id="l7.70">           }</span>
<a href="#l7.71"></a><span id="l7.71">         }</span>
<a href="#l7.72"></a><span id="l7.72">       }</span>
<a href="#l7.73"></a><span id="l7.73">     }</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75">     // Still no matches? Give up and pick the default or the first one.</span>
<a href="#l7.76"></a><span id="l7.76">     if (useDefault) {</span>
<a href="#l7.77"></a><span id="l7.77">       let defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l7.78"></a><span id="l7.78">       if (defaultAccount &amp;&amp; defaultAccount.defaultIdentity) {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-        return defaultAccount.defaultIdentity;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+        return [ defaultAccount.defaultIdentity, null ];</span>
<a href="#l7.81"></a><span id="l7.81">       }</span>
<a href="#l7.82"></a><span id="l7.82">     }</span>
<a href="#l7.83"></a><span id="l7.83"> </span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-    return identities[0];</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    return [ identities[0], null ];</span>
<a href="#l7.86"></a><span id="l7.86">   },</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88">   getIdentityForServer(server, optionalHint) {</span>
<a href="#l7.89"></a><span id="l7.89">     let identities = MailServices.accounts.getIdentitiesForServer(server);</span>
<a href="#l7.90"></a><span id="l7.90">     return this.getBestIdentity(identities, optionalHint);</span>
<a href="#l7.91"></a><span id="l7.91">   },</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93">   /**</span>
<a href="#l7.94"></a><span id="l7.94">    * Get the identity for the given header.</span>
<a href="#l7.95"></a><span id="l7.95">    * @param hdr nsIMsgHdr message header</span>
<a href="#l7.96"></a><span id="l7.96">    * @param type nsIMsgCompType compose type the identity is used for.</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+   * @returns {Array} - An array of two elements, [identity, matchingHint].</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+   *   identity is an nsIMsgIdentity and matchingHint is a string.</span>
<a href="#l7.99"></a><span id="l7.99">    */</span>
<a href="#l7.100"></a><span id="l7.100">   getIdentityForHeader(hdr, type, hint = &quot;&quot;) {</span>
<a href="#l7.101"></a><span id="l7.101">     let server = null;</span>
<a href="#l7.102"></a><span id="l7.102">     let identity = null;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    let matchingHint = null;</span>
<a href="#l7.104"></a><span id="l7.104">     let folder = hdr.folder;</span>
<a href="#l7.105"></a><span id="l7.105">     if (folder) {</span>
<a href="#l7.106"></a><span id="l7.106">       server = folder.server;</span>
<a href="#l7.107"></a><span id="l7.107">       identity = folder.customIdentity;</span>
<a href="#l7.108"></a><span id="l7.108">       if (identity) {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-        return identity;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+        return [identity, null];</span>
<a href="#l7.111"></a><span id="l7.111">       }</span>
<a href="#l7.112"></a><span id="l7.112">     }</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114">     if (!server) {</span>
<a href="#l7.115"></a><span id="l7.115">       let accountKey = hdr.accountKey;</span>
<a href="#l7.116"></a><span id="l7.116">       if (accountKey) {</span>
<a href="#l7.117"></a><span id="l7.117">         let account = MailServices.accounts.getAccount(accountKey);</span>
<a href="#l7.118"></a><span id="l7.118">         if (account) {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineat">@@ -501,27 +525,27 @@ var MailUtils = {</span>
<a href="#l7.120"></a><span id="l7.120">       type == Ci.nsIMsgCompType.EditAsNew</span>
<a href="#l7.121"></a><span id="l7.121">     ) {</span>
<a href="#l7.122"></a><span id="l7.122">       hintForIdentity = hdr.author;</span>
<a href="#l7.123"></a><span id="l7.123">     } else {</span>
<a href="#l7.124"></a><span id="l7.124">       hintForIdentity = hdr.recipients + &quot;,&quot; + hdr.ccList + &quot;,&quot; + hint;</span>
<a href="#l7.125"></a><span id="l7.125">     }</span>
<a href="#l7.126"></a><span id="l7.126"> </span>
<a href="#l7.127"></a><span id="l7.127">     if (server) {</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-      identity = this.getIdentityForServer(server, hintForIdentity);</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+      [identity, matchingHint] = this.getIdentityForServer(server, hintForIdentity);</span>
<a href="#l7.130"></a><span id="l7.130">     }</span>
<a href="#l7.131"></a><span id="l7.131"> </span>
<a href="#l7.132"></a><span id="l7.132">     if (!identity) {</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-      identity = this.getBestIdentity(</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+      [identity, matchingHint] = this.getBestIdentity(</span>
<a href="#l7.135"></a><span id="l7.135">         MailServices.accounts.allIdentities,</span>
<a href="#l7.136"></a><span id="l7.136">         hintForIdentity,</span>
<a href="#l7.137"></a><span id="l7.137">         true</span>
<a href="#l7.138"></a><span id="l7.138">       );</span>
<a href="#l7.139"></a><span id="l7.139">     }</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    return identity;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    return [identity, matchingHint];</span>
<a href="#l7.142"></a><span id="l7.142">   },</span>
<a href="#l7.143"></a><span id="l7.143"> </span>
<a href="#l7.144"></a><span id="l7.144">   getInboxFolder(server) {</span>
<a href="#l7.145"></a><span id="l7.145">     try {</span>
<a href="#l7.146"></a><span id="l7.146">       var rootMsgFolder = server.rootMsgFolder;</span>
<a href="#l7.147"></a><span id="l7.147"> </span>
<a href="#l7.148"></a><span id="l7.148">       // Now find the Inbox.</span>
<a href="#l7.149"></a><span id="l7.149">       return rootMsgFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/modules/MessageArchiver.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/modules/MessageArchiver.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -40,17 +40,17 @@ MessageArchiver.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4">       let msgYear = msgDate.getFullYear().toString();</span>
<a href="#l8.5"></a><span id="l8.5">       let monthFolderName =</span>
<a href="#l8.6"></a><span id="l8.6">         msgYear + &quot;-&quot; + (msgDate.getMonth() + 1).toString().padStart(2, &quot;0&quot;);</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">       let archiveFolderURI;</span>
<a href="#l8.9"></a><span id="l8.9">       let archiveGranularity;</span>
<a href="#l8.10"></a><span id="l8.10">       let archiveKeepFolderStructure;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      let identity = MailUtils.getIdentityForHeader(msgHdr);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+      let [identity] = MailUtils.getIdentityForHeader(msgHdr);</span>
<a href="#l8.14"></a><span id="l8.14">       if (!identity || msgHdr.folder.server.type == &quot;rss&quot;) {</span>
<a href="#l8.15"></a><span id="l8.15">         // If no identity, or a server (RSS) which doesn't have an identity</span>
<a href="#l8.16"></a><span id="l8.16">         // and doesn't want the default unrelated identity value, figure</span>
<a href="#l8.17"></a><span id="l8.17">         // this out based on the default identity prefs.</span>
<a href="#l8.18"></a><span id="l8.18">         let enabled = Services.prefs.getBoolPref(</span>
<a href="#l8.19"></a><span id="l8.19">           &quot;mail.identity.default.archive_enabled&quot;</span>
<a href="#l8.20"></a><span id="l8.20">         );</span>
<a href="#l8.21"></a><span id="l8.21">         if (!enabled) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1453,16 +1453,17 @@ function goOpenNewMessage(aEvent) {</span>
<a href="#l9.4"></a><span id="l9.4">   let identity = getCurrentIdentity();</span>
<a href="#l9.5"></a><span id="l9.5">   MailServices.compose.OpenComposeWindow(</span>
<a href="#l9.6"></a><span id="l9.6">     null,</span>
<a href="#l9.7"></a><span id="l9.7">     null,</span>
<a href="#l9.8"></a><span id="l9.8">     null,</span>
<a href="#l9.9"></a><span id="l9.9">     Ci.nsIMsgCompType.New,</span>
<a href="#l9.10"></a><span id="l9.10">     msgCompFormat,</span>
<a href="#l9.11"></a><span id="l9.11">     identity,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    null,</span>
<a href="#l9.13"></a><span id="l9.13">     null</span>
<a href="#l9.14"></a><span id="l9.14">   );</span>
<a href="#l9.15"></a><span id="l9.15"> }</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> function QuoteSelectedMessage() {</span>
<a href="#l9.18"></a><span id="l9.18">   var selectedURIs = GetSelectedMessages();</span>
<a href="#l9.19"></a><span id="l9.19">   if (selectedURIs) {</span>
<a href="#l9.20"></a><span id="l9.20">     for (let i = 0; i &lt; selectedURIs.length; i++) {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -3487,18 +3488,27 @@ function ComposeStartup(aParams) {</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">   identityList.selectedItem = identityList.getElementsByAttribute(</span>
<a href="#l9.24"></a><span id="l9.24">     &quot;identitykey&quot;,</span>
<a href="#l9.25"></a><span id="l9.25">     params.identity.key</span>
<a href="#l9.26"></a><span id="l9.26">   )[0];</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28">   // Here we set the From from the original message, be it a draft or another</span>
<a href="#l9.29"></a><span id="l9.29">   // message, for example a template, we want to &quot;edit as new&quot;.</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-  // Only do this if the message is our own draft or template.</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  if (params.composeFields.creatorIdentityKey &amp;&amp; params.composeFields.from) {</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  // Only do this if the message is our own draft or template or any type of reply.</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  if (</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    params.composeFields.from &amp;&amp;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+    (params.composeFields.creatorIdentityKey ||</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+      gComposeType == Ci.nsIMsgCompType.Reply ||</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+      gComposeType == Ci.nsIMsgCompType.ReplyAll ||</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+      gComposeType == Ci.nsIMsgCompType.ReplyToSender ||</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+      gComposeType == Ci.nsIMsgCompType.ReplyToGroup ||</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+      gComposeType == Ci.nsIMsgCompType.ReplyToSenderAndGroup ||</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+      gComposeType == Ci.nsIMsgCompType.ReplyToList)</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  ) {</span>
<a href="#l9.43"></a><span id="l9.43">     let from = MailServices.headerParser</span>
<a href="#l9.44"></a><span id="l9.44">       .parseEncodedHeader(params.composeFields.from, null)</span>
<a href="#l9.45"></a><span id="l9.45">       .join(&quot;, &quot;);</span>
<a href="#l9.46"></a><span id="l9.46">     if (from != identityList.value) {</span>
<a href="#l9.47"></a><span id="l9.47">       MakeFromFieldEditable(true);</span>
<a href="#l9.48"></a><span id="l9.48">       identityList.value = from;</span>
<a href="#l9.49"></a><span id="l9.49">     }</span>
<a href="#l9.50"></a><span id="l9.50">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-compose.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-compose.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -78,16 +78,17 @@ async function openComposeWindow(related</span>
<a href="#l10.4"></a><span id="l10.4">     let newWindowPromise = waitForWindow();</span>
<a href="#l10.5"></a><span id="l10.5">     MailServices.compose.OpenComposeWindow(</span>
<a href="#l10.6"></a><span id="l10.6">       null,</span>
<a href="#l10.7"></a><span id="l10.7">       msgHdr,</span>
<a href="#l10.8"></a><span id="l10.8">       msgURI,</span>
<a href="#l10.9"></a><span id="l10.9">       type,</span>
<a href="#l10.10"></a><span id="l10.10">       0,</span>
<a href="#l10.11"></a><span id="l10.11">       hdrIdentity,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+      null,</span>
<a href="#l10.13"></a><span id="l10.13">       null</span>
<a href="#l10.14"></a><span id="l10.14">     );</span>
<a href="#l10.15"></a><span id="l10.15">     return newWindowPromise;</span>
<a href="#l10.16"></a><span id="l10.16">   }</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   let params = Cc[</span>
<a href="#l10.19"></a><span id="l10.19">     &quot;@mozilla.org/messengercompose/composeparams;1&quot;</span>
<a href="#l10.20"></a><span id="l10.20">   ].createInstance(Ci.nsIMsgComposeParams);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/newmailaccount/content/accountProvisioner.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/accountProvisioner.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -190,16 +190,17 @@ var EmailAccountProvisioner = {</span>
<a href="#l11.4"></a><span id="l11.4">       .addEventListener(&quot;click&quot;, function() {</span>
<a href="#l11.5"></a><span id="l11.5">         MailServices.compose.OpenComposeWindow(</span>
<a href="#l11.6"></a><span id="l11.6">           null,</span>
<a href="#l11.7"></a><span id="l11.7">           null,</span>
<a href="#l11.8"></a><span id="l11.8">           null,</span>
<a href="#l11.9"></a><span id="l11.9">           Ci.nsIMsgCompType.New,</span>
<a href="#l11.10"></a><span id="l11.10">           Ci.nsIMsgCompFormat.Default,</span>
<a href="#l11.11"></a><span id="l11.11">           account.defaultIdentity,</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+          null,</span>
<a href="#l11.13"></a><span id="l11.13">           null</span>
<a href="#l11.14"></a><span id="l11.14">         );</span>
<a href="#l11.15"></a><span id="l11.15">       });</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17">     document</span>
<a href="#l11.18"></a><span id="l11.18">       .getElementById(&quot;success-addons&quot;)</span>
<a href="#l11.19"></a><span id="l11.19">       .addEventListener(&quot;click&quot;, function() {</span>
<a href="#l11.20"></a><span id="l11.20">         EmailAccountProvisioner.openAddonsMgr();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/stdlib/msgHdrUtils.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -314,17 +314,17 @@ function msgHdrsArchive(msgHdrs) {</span>
<a href="#l12.4"></a><span id="l12.4">    * BatchMessageMover.</span>
<a href="#l12.5"></a><span id="l12.5">    * */</span>
<a href="#l12.6"></a><span id="l12.6">   let mail3PaneWindow = getMail3Pane();</span>
<a href="#l12.7"></a><span id="l12.7">   let batchMover = new mail3PaneWindow.BatchMessageMover();</span>
<a href="#l12.8"></a><span id="l12.8">   batchMover.archiveMessages(</span>
<a href="#l12.9"></a><span id="l12.9">     msgHdrs.filter(</span>
<a href="#l12.10"></a><span id="l12.10">       x =&gt;</span>
<a href="#l12.11"></a><span id="l12.11">         !msgHdrIsArchive(x) &amp;&amp;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        getMail3Pane().getIdentityForHeader(x).archiveEnabled</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+        getMail3Pane().getIdentityForHeader(x)[0].archiveEnabled</span>
<a href="#l12.14"></a><span id="l12.14">     )</span>
<a href="#l12.15"></a><span id="l12.15">   );</span>
<a href="#l12.16"></a><span id="l12.16"> }</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> /**</span>
<a href="#l12.19"></a><span id="l12.19">  * Tell if a message is an RSS feed iteme</span>
<a href="#l12.20"></a><span id="l12.20">  * @param {nsIMsgDbHdr} msgHdr The message header</span>
<a href="#l12.21"></a><span id="l12.21">  * @return {Bool}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/am-main.dtd</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/am-main.dtd</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -8,16 +8,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> &lt;!ENTITY accountName.label &quot;Account Name:&quot;&gt;</span>
<a href="#l13.5"></a><span id="l13.5"> &lt;!ENTITY accountName.accesskey &quot;N&quot;&gt;</span>
<a href="#l13.6"></a><span id="l13.6"> &lt;!ENTITY identityTitle.label &quot;Default Identity&quot;&gt;</span>
<a href="#l13.7"></a><span id="l13.7"> &lt;!ENTITY identityDesc.label &quot;Each account has an identity, which is the information that other people see when they read your messages.&quot;&gt;</span>
<a href="#l13.8"></a><span id="l13.8"> &lt;!ENTITY name.label &quot;Your Name:&quot;&gt;</span>
<a href="#l13.9"></a><span id="l13.9"> &lt;!ENTITY name.accesskey &quot;Y&quot;&gt;</span>
<a href="#l13.10"></a><span id="l13.10"> &lt;!ENTITY email.label &quot;Email Address:&quot;&gt;</span>
<a href="#l13.11"></a><span id="l13.11"> &lt;!ENTITY email.accesskey &quot;E&quot;&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+&lt;!ENTITY catchAll.accesskey &quot;D&quot;&gt;</span>
<a href="#l13.13"></a><span id="l13.13"> &lt;!ENTITY replyTo.label &quot;Reply-to Address:&quot;&gt;</span>
<a href="#l13.14"></a><span id="l13.14"> &lt;!ENTITY replyTo.accesskey &quot;s&quot;&gt;</span>
<a href="#l13.15"></a><span id="l13.15"> &lt;!ENTITY replyTo.placeholder &quot;Recipients will reply to this other address&quot;&gt;</span>
<a href="#l13.16"></a><span id="l13.16"> &lt;!ENTITY organization.label &quot;Organization:&quot;&gt;</span>
<a href="#l13.17"></a><span id="l13.17"> &lt;!ENTITY organization.accesskey &quot;O&quot;&gt;</span>
<a href="#l13.18"></a><span id="l13.18"> &lt;!ENTITY signatureText.label &quot;Signature text:&quot;&gt;</span>
<a href="#l13.19"></a><span id="l13.19"> &lt;!ENTITY signatureText.accesskey &quot;x&quot;&gt;</span>
<a href="#l13.20"></a><span id="l13.20"> &lt;!ENTITY signatureHtml.label &quot;Use HTML (e.g., &amp;lt;b&amp;gt;bold&amp;lt;/b&amp;gt;)&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/prefs.properties</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/prefs.properties</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -65,16 +65,19 @@ identity-list-title=Identities for %1$S</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> identityDialogTitleAdd=New Identity</span>
<a href="#l14.6"></a><span id="l14.6"> ## LOCALIZATION NOTE (identityDialogTitleEdit): %S is the identity name</span>
<a href="#l14.7"></a><span id="l14.7"> identityDialogTitleEdit=Edit %S</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> identity-edit-req=You must specify a valid email address for this identity.</span>
<a href="#l14.10"></a><span id="l14.10"> identity-edit-req-title=Error Creating Identity</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+## LOCALIZATION NOTE (identityCatchAll): %S is the domain part of the email address</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+identityCatchAll=Reply from this identity when a message does not match any other identity and the recipient matches %S</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+</span>
<a href="#l14.15"></a><span id="l14.15"> ## LOCALIZATION NOTE (identity-delete-confirm): %S is the identity name</span>
<a href="#l14.16"></a><span id="l14.16"> # and should be put on a new line. The new line is produced with the &quot;\n&quot; string.</span>
<a href="#l14.17"></a><span id="l14.17"> identity-delete-confirm=Are you sure you want to delete the identity\n%S?</span>
<a href="#l14.18"></a><span id="l14.18"> ## LOCALIZATION NOTE (identity-delete-confirm-title): %S is the account name</span>
<a href="#l14.19"></a><span id="l14.19"> identity-delete-confirm-title=Deleting identity for %S</span>
<a href="#l14.20"></a><span id="l14.20"> identity-delete-confirm-button=Delete</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22"> choosefile=Choose a file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/browser/composition/browser.ini</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/browser/composition/browser.ini</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -66,16 +66,17 @@ reason = See bug 1413851.</span>
<a href="#l15.4"></a><span id="l15.4"> [browser_forwardedContent.js]</span>
<a href="#l15.5"></a><span id="l15.5"> [browser_forwardedEmlActions.js]</span>
<a href="#l15.6"></a><span id="l15.6"> [browser_imageDisplay.js]</span>
<a href="#l15.7"></a><span id="l15.7"> [browser_imageInsertionDialog.js]</span>
<a href="#l15.8"></a><span id="l15.8"> [browser_multipartRelated.js]</span>
<a href="#l15.9"></a><span id="l15.9"> [browser_newmsgComposeIdentity.js]</span>
<a href="#l15.10"></a><span id="l15.10"> [browser_replyAddresses.js]</span>
<a href="#l15.11"></a><span id="l15.11"> skip-if = debug # Bug 1601591</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+[browser_replyCatchAll.js]</span>
<a href="#l15.13"></a><span id="l15.13"> [browser_replyFormatFlowed.js]</span>
<a href="#l15.14"></a><span id="l15.14"> [browser_replyMultipartCharset.js]</span>
<a href="#l15.15"></a><span id="l15.15"> skip-if = debug # Bug 1606542</span>
<a href="#l15.16"></a><span id="l15.16"> [browser_replySignature.js]</span>
<a href="#l15.17"></a><span id="l15.17"> [browser_saveChangesOnQuit.js]</span>
<a href="#l15.18"></a><span id="l15.18"> [browser_sendButton.js]</span>
<a href="#l15.19"></a><span id="l15.19"> tags = addrbook</span>
<a href="#l15.20"></a><span id="l15.20"> skip-if = os == 'win' &amp;&amp; bits == 64 &amp;&amp; debug # Bug 1601520</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mail/test/browser/composition/browser_replyCatchAll.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,227 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+/**</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ * Tests that reply messages use the correct identity and sender dependent</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+ * on the catchAll setting.</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ */</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+var {</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  close_compose_window,</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+  open_compose_with_reply,</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+} = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+var {</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+  add_message_to_folder,</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+  assert_selected_and_displayed,</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+  be_in_folder,</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+  create_message,</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+  mc,</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+  press_delete,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+  select_click_row,</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+} = ChromeUtils.import(</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+var {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  assert_notification_displayed,</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+  wait_for_notification_to_show,</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+} = ChromeUtils.import(</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  &quot;resource://testing-common/mozmill/NotificationBoxHelpers.jsm&quot;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+);</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+var { Assert } = ChromeUtils.import(&quot;resource://testing-common/Assert.jsm&quot;);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+var { MailServices } = ChromeUtils.import(</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+  &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+);</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+var i = 0;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+var myIdentityEmail1 = &quot;me@example.com&quot;;</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+var myIdentityEmail2 = &quot;otherme@example.net&quot;;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+var myAdditionalEmail3 = &quot;alsome@example.net&quot;;</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+var notMyEmail = &quot;otherme@example.org&quot;;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+var identity1;</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+var identity2;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+var gAccount;</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+var gFolder;</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+  requestLongerTimeout(4);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+  // Now set up an account with some identities.</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+  let acctMgr = MailServices.accounts;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+  gAccount = acctMgr.createAccount();</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+  gAccount.incomingServer = acctMgr.createIncomingServer(</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+    &quot;nobody&quot;,</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+    &quot;Reply Identity Testing&quot;,</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+    &quot;pop3&quot;</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+  );</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  gFolder = gAccount.incomingServer.rootFolder</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+    .QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+    .createLocalSubfolder(&quot;Msgs4Reply&quot;);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+  identity1 = acctMgr.createIdentity();</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+  identity1.email = myIdentityEmail1;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+  gAccount.addIdentity(identity1);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  identity2 = acctMgr.createIdentity();</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  identity2.email = myIdentityEmail2;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  gAccount.addIdentity(identity2);</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+});</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+/**</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+ * Create and select a new message to do a reply with.</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+ */</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+function create_replyMsg(aTo, aEnvelopeTo) {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+    from: &quot;Tester &lt;test@example.com&gt;&quot;,</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    to: aTo,</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+    subject: &quot;test&quot;,</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+      &quot;envelope-to&quot;: aEnvelopeTo</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+    },</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+  });</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+  add_message_to_folder(gFolder, msg0);</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+  be_in_folder(gFolder);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+}</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+/**</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+ * all the tests</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+ */</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+add_task(function test_reply_identity_selection() {</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  let tests = [</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    // No catchAll, 'From' will be set to recipient.</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+    {</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+      to: myIdentityEmail2, envelopeTo: myIdentityEmail2,</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+      catchAllId1: false, catchAllId2: false,</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+      replyIdKey: identity2.key, replyIdFrom: myIdentityEmail2, warning: false</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+    },</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+    // No catchAll, 'From' will be set to second id's email (without name).</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+    {</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+      to: &quot;Mr.X &lt;&quot; + myIdentityEmail2 + &quot;&gt;&quot;, envelopeTo: &quot;&quot;,</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+      catchAllId1: false, catchAllId2: false,</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+      replyIdKey: identity2.key, replyIdFrom: myIdentityEmail2, warning: false</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+    },</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+    // With catchAll, 'From' will be set to senders address (with name).</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+    {</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+      to: &quot;Mr.X &lt;&quot; + myIdentityEmail2 + &quot;&gt;&quot;, envelopeTo: &quot;&quot;,</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+      catchAllId1: false, catchAllId2: true,</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+      replyIdKey: identity2.key, replyIdFrom: &quot;Mr.X &lt;&quot; + myIdentityEmail2 + &quot;&gt;&quot;,</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+      warning: false</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+    },</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+    // With catchAll, 'From' will be set to senders address (with name).</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+    {</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+      to: myIdentityEmail2, envelopeTo: &quot;Mr.X &lt;&quot; + myIdentityEmail2 + &quot;&gt;&quot;,</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+      catchAllId1: false, catchAllId2: true,</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+      replyIdKey: identity2.key, replyIdFrom: &quot;Mr.X &lt;&quot; + myIdentityEmail2 + &quot;&gt;&quot;,</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+      warning: false</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+    },</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+    // With catchAll, 'From' will be set to second id's email.</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+    {</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+      to: myIdentityEmail2, envelopeTo: myAdditionalEmail3,</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+      catchAllId1: false, catchAllId2: true,</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+      replyIdKey: identity2.key, replyIdFrom: myIdentityEmail2, warning: false</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+    },</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+    // With catchAll, 'From' will be set to myAdditionalEmail3.</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+    {</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+      to: notMyEmail, envelopeTo: myAdditionalEmail3,</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+      catchAllId1: false, catchAllId2: true,</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+      replyIdKey: identity2.key, replyIdFrom: myAdditionalEmail3,</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+      warning: true</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+    },</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+    // Without catchAll, mail to another recipient.</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+    {</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+      to: notMyEmail, envelopeTo: &quot;&quot;,</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+      catchAllId1: false, catchAllId2: false,</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+      replyIdKey: identity1.key, replyIdFrom: myIdentityEmail1,</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+      warning: false</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+    },</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+    // With catchAll, mail to another recipient (domain not matching).</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+    {</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+      to: notMyEmail, envelopeTo: &quot;&quot;,</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+      catchAllId1: true, catchAllId2: true,</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+      replyIdKey: identity1.key, replyIdFrom: myIdentityEmail1,</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+      warning: false</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+    },</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+  ];</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+  for (let test of tests) {</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+    test.replyIndex = create_replyMsg(test.to, test.envelopeTo);</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+    identity1.catchAll = test.catchAllId1;</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+    identity2.catchAll = test.catchAllId2;</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+    let cwc = open_compose_with_reply();</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+    checkCompIdentity(</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+      cwc,</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+      test.replyIdKey,</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+      test.replyIdFrom</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+    );</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+    if (test.warning) {</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+      wait_for_notification_to_show(</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+        cwc,</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+        &quot;compose-notification-bottom&quot;,</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+        &quot;identityWarning&quot;</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+      );</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+    } else {</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+      assert_notification_displayed(</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+        cwc,</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+        &quot;compose-notification-bottom&quot;,</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+        &quot;identityWarning&quot;,</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+        false</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+      );</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+    }</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+    close_compose_window(cwc, false);</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+  }</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+});</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+/**</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+ * Helper to check that a suitable From identity was set up in the given</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+ * composer window.</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+ *</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+ * @param cwc             Compose window controller.</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+ * @param aIdentityKey    The key of the expected identity.</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+ * @param aFrom           The expected displayed From address.</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+ */</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+function checkCompIdentity(cwc, aIdentityKey, aFrom) {</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+  Assert.equal(</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+    cwc.window.getCurrentIdentityKey(),</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+    aIdentityKey,</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+    &quot;The From identity is not correctly selected&quot;</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+  );</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+  Assert.equal(</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+    cwc.window.document.getElementById(&quot;msgIdentity&quot;).value,</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+    aFrom,</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+    &quot;The From value was initialized to an unexpected value&quot;</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+  );</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+}</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+  be_in_folder(gFolder);</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+  let count;</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+  while ((count = gFolder.getTotalMessages(false)) &gt; 0) {</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+    press_delete();</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+    mc.waitFor(() =&gt; gFolder.getTotalMessages(false) &lt; count);</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+  }</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+  gAccount.removeIdentity(identity2);</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+  // The last identity of an account can't be removed so clear all its prefs</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+  // which effectively destroys it.</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+  identity1.clearAllValues();</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+  MailServices.accounts.removeAccount(gAccount);</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+  gAccount = null;</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-identity-edit.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-identity-edit.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -46,16 +46,18 @@ function initIdentityValues(identity) {</span>
<a href="#l17.4"></a><span id="l17.4">     // &quot;use default server&quot; option is used so, if we get that passed in, select</span>
<a href="#l17.5"></a><span id="l17.5">     // the useDefaultItem representing this option by using the value of &quot;&quot;.</span>
<a href="#l17.6"></a><span id="l17.6">     document.getElementById(&quot;identity.smtpServerKey&quot;).value = aServerKey || &quot;&quot;;</span>
<a href="#l17.7"></a><span id="l17.7">   }</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9">   if (identity) {</span>
<a href="#l17.10"></a><span id="l17.10">     document.getElementById(&quot;identity.fullName&quot;).value = identity.fullName;</span>
<a href="#l17.11"></a><span id="l17.11">     document.getElementById(&quot;identity.email&quot;).value = identity.email;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+    document.getElementById(&quot;identity.catchAll&quot;).checked =</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+      identity.catchAll;</span>
<a href="#l17.14"></a><span id="l17.14">     document.getElementById(&quot;identity.replyTo&quot;).value = identity.replyTo;</span>
<a href="#l17.15"></a><span id="l17.15">     document.getElementById(&quot;identity.organization&quot;).value =</span>
<a href="#l17.16"></a><span id="l17.16">       identity.organization;</span>
<a href="#l17.17"></a><span id="l17.17">     document.getElementById(&quot;identity.attachSignature&quot;).checked =</span>
<a href="#l17.18"></a><span id="l17.18">       identity.attachSignature;</span>
<a href="#l17.19"></a><span id="l17.19">     document.getElementById(&quot;identity.htmlSigText&quot;).value =</span>
<a href="#l17.20"></a><span id="l17.20">       identity.htmlSigText;</span>
<a href="#l17.21"></a><span id="l17.21">     document.getElementById(&quot;identity.htmlSigFormat&quot;).checked =</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -78,16 +80,17 @@ function initIdentityValues(identity) {</span>
<a href="#l17.23"></a><span id="l17.23">       idLabel.value = identity.label;</span>
<a href="#l17.24"></a><span id="l17.24">     }</span>
<a href="#l17.25"></a><span id="l17.25">   } else {</span>
<a href="#l17.26"></a><span id="l17.26">     // We're adding an identity, use the best default we have.</span>
<a href="#l17.27"></a><span id="l17.27">     initSmtpServer(gAccount.defaultIdentity.smtpServerKey);</span>
<a href="#l17.28"></a><span id="l17.28">   }</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">   setupSignatureItems();</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  updateCatchAllDomain();</span>
<a href="#l17.32"></a><span id="l17.32"> }</span>
<a href="#l17.33"></a><span id="l17.33"> </span>
<a href="#l17.34"></a><span id="l17.34"> function initCopiesAndFolder(identity) {</span>
<a href="#l17.35"></a><span id="l17.35">   // if we are editing an existing identity, use it...otherwise copy our values from the default identity</span>
<a href="#l17.36"></a><span id="l17.36">   var copiesAndFoldersIdentity = identity ? identity : gAccount.defaultIdentity;</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">   document.getElementById(&quot;identity.fccFolder&quot;).value =</span>
<a href="#l17.39"></a><span id="l17.39">     copiesAndFoldersIdentity.fccFolder;</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineat">@@ -230,16 +233,19 @@ function validEmailAddress() {</span>
<a href="#l17.41"></a><span id="l17.41"> function saveIdentitySettings(identity) {</span>
<a href="#l17.42"></a><span id="l17.42">   if (identity) {</span>
<a href="#l17.43"></a><span id="l17.43">     let idLabel = document.getElementById(&quot;identity.label&quot;);</span>
<a href="#l17.44"></a><span id="l17.44">     if (idLabel) {</span>
<a href="#l17.45"></a><span id="l17.45">       identity.label = idLabel.value;</span>
<a href="#l17.46"></a><span id="l17.46">     }</span>
<a href="#l17.47"></a><span id="l17.47">     identity.fullName = document.getElementById(&quot;identity.fullName&quot;).value;</span>
<a href="#l17.48"></a><span id="l17.48">     identity.email = document.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+    identity.catchAll = document.getElementById(</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+      &quot;identity.catchAll&quot;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+    ).checked;</span>
<a href="#l17.52"></a><span id="l17.52">     identity.replyTo = document.getElementById(&quot;identity.replyTo&quot;).value;</span>
<a href="#l17.53"></a><span id="l17.53">     identity.organization = document.getElementById(</span>
<a href="#l17.54"></a><span id="l17.54">       &quot;identity.organization&quot;</span>
<a href="#l17.55"></a><span id="l17.55">     ).value;</span>
<a href="#l17.56"></a><span id="l17.56">     identity.attachSignature = document.getElementById(</span>
<a href="#l17.57"></a><span id="l17.57">       &quot;identity.attachSignature&quot;</span>
<a href="#l17.58"></a><span id="l17.58">     ).checked;</span>
<a href="#l17.59"></a><span id="l17.59">     identity.htmlSigText = document.getElementById(</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineat">@@ -500,8 +506,33 @@ function editCurrentSMTP() {</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62">   parent.gSubDialog.open(</span>
<a href="#l17.63"></a><span id="l17.63">     &quot;chrome://messenger/content/SmtpServerEdit.xhtml&quot;,</span>
<a href="#l17.64"></a><span id="l17.64">     null,</span>
<a href="#l17.65"></a><span id="l17.65">     args,</span>
<a href="#l17.66"></a><span id="l17.66">     loadSMTPServerList</span>
<a href="#l17.67"></a><span id="l17.67">   );</span>
<a href="#l17.68"></a><span id="l17.68"> }</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+function updateCatchAllDomain() {</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+  let emailAddress = document.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  let atPos = emailAddress.lastIndexOf(&quot;@&quot;);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  let catchAllElem = document.getElementById(&quot;identity.catchAll&quot;);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  let prefBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+  // If email address contains some domain part, use this in the checkbox</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  // description. Else disable the whole field and reset catchAll option.</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  if (atPos &gt; 0 &amp;&amp; atPos + 1 &lt; emailAddress.length) {</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+    catchAllElem.setAttribute(&quot;disabled&quot;, &quot;false&quot;);</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+    catchAllElem.setAttribute(</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+      &quot;label&quot;,</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+      prefBundle.getFormattedString(&quot;identityCatchAll&quot;, [</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+        emailAddress.substr(atPos + 1),</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+      ])</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+    );</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+  } else {</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+    catchAllElem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+    catchAllElem.checked = false;</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+    catchAllElem.setAttribute(</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+      &quot;label&quot;,</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+      prefBundle.getFormattedString(&quot;identityCatchAll&quot;, [ &quot;&quot;])</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+    );</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+  }</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-identity-edit.xhtml</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-identity-edit.xhtml</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -82,16 +82,17 @@</span>
<a href="#l18.4"></a><span id="l18.4">                        value=&quot;&amp;email.label;&quot;</span>
<a href="#l18.5"></a><span id="l18.5">                        control=&quot;identity.email&quot;</span>
<a href="#l18.6"></a><span id="l18.6">                        accesskey=&quot;&amp;email.accesskey;&quot;/&gt;</span>
<a href="#l18.7"></a><span id="l18.7">               &lt;/html:th&gt;</span>
<a href="#l18.8"></a><span id="l18.8">               &lt;html:td&gt;</span>
<a href="#l18.9"></a><span id="l18.9">                 &lt;html:input id=&quot;identity.email&quot;</span>
<a href="#l18.10"></a><span id="l18.10">                             type=&quot;email&quot;</span>
<a href="#l18.11"></a><span id="l18.11">                             class=&quot;uri-element input-inline&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+                            oninput=&quot;updateCatchAllDomain();&quot;</span>
<a href="#l18.13"></a><span id="l18.13">                             aria-labelledby=&quot;identity.email.label&quot;/&gt;</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15">               &lt;/html:td&gt;</span>
<a href="#l18.16"></a><span id="l18.16">             &lt;/html:tr&gt;</span>
<a href="#l18.17"></a><span id="l18.17">             &lt;html:tr&gt;</span>
<a href="#l18.18"></a><span id="l18.18">               &lt;html:th&gt;</span>
<a href="#l18.19"></a><span id="l18.19">                 &lt;label id=&quot;identity.replyTo.label&quot;</span>
<a href="#l18.20"></a><span id="l18.20">                        value=&quot;&amp;replyTo.label;&quot;</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -163,16 +164,24 @@</span>
<a href="#l18.22"></a><span id="l18.22">                     accesskey=&quot;&amp;editVCard.accesskey;&quot; oncommand=&quot;editVCard()&quot;/&gt;</span>
<a href="#l18.23"></a><span id="l18.23">             &lt;label id=&quot;identity.escapedVCard&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l18.24"></a><span id="l18.24">           &lt;/hbox&gt;</span>
<a href="#l18.25"></a><span id="l18.25">         &lt;/html:fieldset&gt;</span>
<a href="#l18.26"></a><span id="l18.26"> </span>
<a href="#l18.27"></a><span id="l18.27">         &lt;html:fieldset&gt;</span>
<a href="#l18.28"></a><span id="l18.28">           &lt;html:legend&gt;&amp;privateData.label;&lt;/html:legend&gt;</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+          &lt;hbox align=&quot;center&quot; class=&quot;input-container&quot;&gt;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+            &lt;checkbox id=&quot;identity.catchAll&quot;</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+                      accesskey=&quot;&amp;catchAll.accesskey;&quot;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+                      style=&quot;width:100%;&quot;/&gt;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+          &lt;/hbox&gt;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+          &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+</span>
<a href="#l18.38"></a><span id="l18.38">           &lt;label value=&quot;&amp;smtpName.label;&quot;</span>
<a href="#l18.39"></a><span id="l18.39">                  control=&quot;identity.smtpServerKey&quot;</span>
<a href="#l18.40"></a><span id="l18.40">                  accesskey=&quot;&amp;smtpName.accesskey;&quot;/&gt;</span>
<a href="#l18.41"></a><span id="l18.41">           &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l18.42"></a><span id="l18.42">             &lt;menulist id=&quot;identity.smtpServerKey&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l18.43"></a><span id="l18.43">               &lt;menupopup id=&quot;smtpPopup&quot;&gt;</span>
<a href="#l18.44"></a><span id="l18.44">                 &lt;menuitem id=&quot;useDefaultItem&quot; value=&quot;&quot;</span>
<a href="#l18.45"></a><span id="l18.45">                           label=&quot;&amp;smtpDefaultServer.label;&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-main.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-main.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -18,16 +18,17 @@ function onInit(aPageId, aServerId) {</span>
<a href="#l19.4"></a><span id="l19.4">   } else {</span>
<a href="#l19.5"></a><span id="l19.5">     titleValue = defaultTitle;</span>
<a href="#l19.6"></a><span id="l19.6">   }</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">   title.setAttribute(&quot;value&quot;, titleValue);</span>
<a href="#l19.9"></a><span id="l19.9">   document.title = titleValue;</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11">   setupSignatureItems();</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  updateCatchAllDomain();</span>
<a href="#l19.13"></a><span id="l19.13"> }</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> function onPreInit(account, accountValues) {</span>
<a href="#l19.16"></a><span id="l19.16">   gAccount = account;</span>
<a href="#l19.17"></a><span id="l19.17">   loadSMTPServerList();</span>
<a href="#l19.18"></a><span id="l19.18"> }</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> function manageIdentities() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-main.xhtml</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-main.xhtml</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -68,16 +68,17 @@</span>
<a href="#l20.4"></a><span id="l20.4">                    control=&quot;identity.email&quot; accesskey=&quot;&amp;email.accesskey;&quot;/&gt;</span>
<a href="#l20.5"></a><span id="l20.5">           &lt;/html:th&gt;</span>
<a href="#l20.6"></a><span id="l20.6">           &lt;html:td&gt;</span>
<a href="#l20.7"></a><span id="l20.7">             &lt;html:input id=&quot;identity.email&quot;</span>
<a href="#l20.8"></a><span id="l20.8">                         type=&quot;email&quot;</span>
<a href="#l20.9"></a><span id="l20.9">                         wsm_persist=&quot;true&quot;</span>
<a href="#l20.10"></a><span id="l20.10">                         prefstring=&quot;mail.identity.%identitykey%.useremail&quot;</span>
<a href="#l20.11"></a><span id="l20.11">                         class=&quot;uri-element input-inline&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+                        oninput=&quot;updateCatchAllDomain();&quot;</span>
<a href="#l20.13"></a><span id="l20.13">                         aria-labelledby=&quot;identity.email.label&quot;/&gt;</span>
<a href="#l20.14"></a><span id="l20.14">           &lt;/html:td&gt;</span>
<a href="#l20.15"></a><span id="l20.15">         &lt;/html:tr&gt;</span>
<a href="#l20.16"></a><span id="l20.16">         &lt;html:tr&gt;</span>
<a href="#l20.17"></a><span id="l20.17">           &lt;html:th&gt;</span>
<a href="#l20.18"></a><span id="l20.18">             &lt;label id=&quot;identity.replyTo.label&quot; value=&quot;&amp;replyTo.label;&quot;</span>
<a href="#l20.19"></a><span id="l20.19">                    control=&quot;identity.replyTo&quot; accesskey=&quot;&amp;replyTo.accesskey;&quot;/&gt;</span>
<a href="#l20.20"></a><span id="l20.20">           &lt;/html:th&gt;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -162,16 +163,27 @@</span>
<a href="#l20.22"></a><span id="l20.22">                 oncommand=&quot;editVCard()&quot;/&gt;</span>
<a href="#l20.23"></a><span id="l20.23">         &lt;label hidden=&quot;true&quot; wsm_persist=&quot;true&quot; id=&quot;identity.escapedVCard&quot;</span>
<a href="#l20.24"></a><span id="l20.24">                   pref=&quot;true&quot; preftype=&quot;string&quot; prefattribute=&quot;value&quot;</span>
<a href="#l20.25"></a><span id="l20.25">                   prefstring=&quot;mail.identity.%identitykey%.escapedVCard&quot;/&gt;</span>
<a href="#l20.26"></a><span id="l20.26">       &lt;/hbox&gt;</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">       &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+      &lt;hbox align=&quot;center&quot; class=&quot;input-container&quot;&gt;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+        &lt;checkbox id=&quot;identity.catchAll&quot;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+                  wsm_persist=&quot;true&quot;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+                  prefattribute=&quot;value&quot;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+                  accesskey=&quot;&amp;catchAll.accesskey;&quot;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+                  style=&quot;width:100%;&quot;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+                  prefstring=&quot;mail.identity.%identitykey%.catchAll&quot;/&gt;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+      &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+</span>
<a href="#l20.41"></a><span id="l20.41">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l20.42"></a><span id="l20.42">         &lt;label value=&quot;&amp;smtpName.label;&quot; control=&quot;identity.smtpServerKey&quot;</span>
<a href="#l20.43"></a><span id="l20.43">                accesskey=&quot;&amp;smtpName.accesskey;&quot;/&gt;</span>
<a href="#l20.44"></a><span id="l20.44">         &lt;menulist wsm_persist=&quot;true&quot; id=&quot;identity.smtpServerKey&quot; flex=&quot;1&quot;</span>
<a href="#l20.45"></a><span id="l20.45">                   pref=&quot;true&quot; preftype=&quot;string&quot; prefattribute=&quot;value&quot;</span>
<a href="#l20.46"></a><span id="l20.46">                   prefstring=&quot;mail.identity.%identitykey%.smtpServer&quot;&gt;</span>
<a href="#l20.47"></a><span id="l20.47">           &lt;menupopup id=&quot;smtpPopup&quot;&gt;</span>
<a href="#l20.48"></a><span id="l20.48">             &lt;menuitem value=&quot;&quot; label=&quot;&amp;smtpDefaultServer.label;&quot; id=&quot;useDefaultItem&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgIdentity.idl</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgIdentity.idl</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -36,16 +36,21 @@ interface nsIMsgIdentity : nsISupports {</span>
<a href="#l21.4"></a><span id="l21.4">   attribute AString fullName;</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6">   /**</span>
<a href="#l21.7"></a><span id="l21.7">    * User's e-mail address, i.e. john@doe.com.</span>
<a href="#l21.8"></a><span id="l21.8">    */</span>
<a href="#l21.9"></a><span id="l21.9">   attribute ACString email;</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11">   /**</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+   * Do we use multiple EMail addresses (like Catch-All) with this identity?</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+   */</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+  attribute boolean catchAll;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  /**</span>
<a href="#l21.17"></a><span id="l21.17">    * Formats fullName and email into the proper string to use as sender:</span>
<a href="#l21.18"></a><span id="l21.18">    * name &lt;email&gt;</span>
<a href="#l21.19"></a><span id="l21.19">    */</span>
<a href="#l21.20"></a><span id="l21.20">   readonly attribute AString fullAddress;</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22">   /**</span>
<a href="#l21.23"></a><span id="l21.23">    * Optional replyTo address, i.e. johnNOSPAM@doe.com.</span>
<a href="#l21.24"></a><span id="l21.24">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIdentity.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIdentity.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -134,16 +134,17 @@ nsMsgIdentity::ClearAllValues() {</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5">   return mPrefBranch-&gt;DeleteBranch(&quot;&quot;);</span>
<a href="#l22.6"></a><span id="l22.6"> }</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> NS_IMPL_IDPREF_STR(EscapedVCard, &quot;escapedVCard&quot;)</span>
<a href="#l22.9"></a><span id="l22.9"> NS_IMPL_IDPREF_STR(SmtpServerKey, &quot;smtpServer&quot;)</span>
<a href="#l22.10"></a><span id="l22.10"> NS_IMPL_IDPREF_WSTR(FullName, &quot;fullName&quot;)</span>
<a href="#l22.11"></a><span id="l22.11"> NS_IMPL_IDPREF_STR(Email, &quot;useremail&quot;)</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+NS_IMPL_IDPREF_BOOL(CatchAll, &quot;catchAll&quot;)</span>
<a href="#l22.13"></a><span id="l22.13"> NS_IMPL_IDPREF_WSTR(Label, &quot;label&quot;)</span>
<a href="#l22.14"></a><span id="l22.14"> NS_IMPL_IDPREF_STR(ReplyTo, &quot;reply_to&quot;)</span>
<a href="#l22.15"></a><span id="l22.15"> NS_IMPL_IDPREF_WSTR(Organization, &quot;organization&quot;)</span>
<a href="#l22.16"></a><span id="l22.16"> NS_IMPL_IDPREF_BOOL(ComposeHtml, &quot;compose_html&quot;)</span>
<a href="#l22.17"></a><span id="l22.17"> NS_IMPL_IDPREF_BOOL(AttachVCard, &quot;attach_vcard&quot;)</span>
<a href="#l22.18"></a><span id="l22.18"> NS_IMPL_IDPREF_BOOL(AttachSignature, &quot;attach_signature&quot;)</span>
<a href="#l22.19"></a><span id="l22.19"> NS_IMPL_IDPREF_WSTR(HtmlSigText, &quot;htmlSigText&quot;)</span>
<a href="#l22.20"></a><span id="l22.20"> NS_IMPL_IDPREF_BOOL(HtmlSigFormat, &quot;htmlSigFormat&quot;)</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineat">@@ -496,16 +497,17 @@ NS_IMETHODIMP nsMsgIdentity::GetIntAttri</span>
<a href="#l22.22"></a><span id="l22.22">   }</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24"> NS_IMETHODIMP</span>
<a href="#l22.25"></a><span id="l22.25"> nsMsgIdentity::Copy(nsIMsgIdentity *identity) {</span>
<a href="#l22.26"></a><span id="l22.26">   NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28">   COPY_IDENTITY_BOOL_VALUE(identity, GetComposeHtml, SetComposeHtml)</span>
<a href="#l22.29"></a><span id="l22.29">   COPY_IDENTITY_STR_VALUE(identity, GetEmail, SetEmail)</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetCatchAll, SetCatchAll)</span>
<a href="#l22.31"></a><span id="l22.31">   COPY_IDENTITY_WSTR_VALUE(identity, GetLabel, SetLabel)</span>
<a href="#l22.32"></a><span id="l22.32">   COPY_IDENTITY_STR_VALUE(identity, GetReplyTo, SetReplyTo)</span>
<a href="#l22.33"></a><span id="l22.33">   COPY_IDENTITY_WSTR_VALUE(identity, GetFullName, SetFullName)</span>
<a href="#l22.34"></a><span id="l22.34">   COPY_IDENTITY_WSTR_VALUE(identity, GetOrganization, SetOrganization)</span>
<a href="#l22.35"></a><span id="l22.35">   COPY_IDENTITY_STR_VALUE(identity, GetDraftFolder, SetDraftFolder)</span>
<a href="#l22.36"></a><span id="l22.36">   COPY_IDENTITY_STR_VALUE(identity, GetArchiveFolder, SetArchiveFolder)</span>
<a href="#l22.37"></a><span id="l22.37">   COPY_IDENTITY_STR_VALUE(identity, GetFccFolder, SetFccFolder)</span>
<a href="#l22.38"></a><span id="l22.38">   COPY_IDENTITY_BOOL_VALUE(identity, GetFccReplyFollowsParent,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgComposeService.idl</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgComposeService.idl</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -21,16 +21,17 @@ interface nsIMsgComposeService : nsISupp</span>
<a href="#l23.4"></a><span id="l23.4">   /* we need a msg window because when we forward inline we may need progress */</span>
<a href="#l23.5"></a><span id="l23.5">   [can_run_script]</span>
<a href="#l23.6"></a><span id="l23.6">   void OpenComposeWindow(in string msgComposeWindowURL,</span>
<a href="#l23.7"></a><span id="l23.7">                          in nsIMsgDBHdr msgHdr,</span>
<a href="#l23.8"></a><span id="l23.8">                          in string originalMsgURI,</span>
<a href="#l23.9"></a><span id="l23.9">                          in MSG_ComposeType type,</span>
<a href="#l23.10"></a><span id="l23.10">                          in MSG_ComposeFormat format,</span>
<a href="#l23.11"></a><span id="l23.11">                          in nsIMsgIdentity identity,</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+                         in AUTF8String from,</span>
<a href="#l23.13"></a><span id="l23.13">                          in nsIMsgWindow aMsgWindow);</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15">   /**</span>
<a href="#l23.16"></a><span id="l23.16">    * Open a compose window given a mailto url and (optionally) an identity.</span>
<a href="#l23.17"></a><span id="l23.17">    *</span>
<a href="#l23.18"></a><span id="l23.18">    * @param aMsgComposeWindowURL Can be null in most cases. If you have your</span>
<a href="#l23.19"></a><span id="l23.19">    *                             own chrome url you want to use in bringing up a</span>
<a href="#l23.20"></a><span id="l23.20">    *                             compose window, pass it in here.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -345,17 +345,17 @@ nsMsgComposeService::GetOrigWindowSelect</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5">   return rv;</span>
<a href="#l24.6"></a><span id="l24.6"> }</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> MOZ_CAN_RUN_SCRIPT_FOR_DEFINITION NS_IMETHODIMP</span>
<a href="#l24.9"></a><span id="l24.9"> nsMsgComposeService::OpenComposeWindow(</span>
<a href="#l24.10"></a><span id="l24.10">     const char *msgComposeWindowURL, nsIMsgDBHdr *origMsgHdr,</span>
<a href="#l24.11"></a><span id="l24.11">     const char *originalMsgURI, MSG_ComposeType type, MSG_ComposeFormat format,</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    nsIMsgIdentity *aIdentity, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    nsIMsgIdentity *aIdentity, const nsACString &amp;from, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l24.14"></a><span id="l24.14">   nsresult rv;</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16">   // Check for any reply type that wants to ignore the quote.</span>
<a href="#l24.17"></a><span id="l24.17">   bool ignoreQuote = false;</span>
<a href="#l24.18"></a><span id="l24.18">   if (type &gt;= nsIMsgCompType::ReplyIgnoreQuote) {</span>
<a href="#l24.19"></a><span id="l24.19">     type -= nsIMsgCompType::ReplyIgnoreQuote;</span>
<a href="#l24.20"></a><span id="l24.20">     ignoreQuote = true;</span>
<a href="#l24.21"></a><span id="l24.21">   }</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -438,16 +438,17 @@ nsMsgComposeService::OpenComposeWindow(</span>
<a href="#l24.23"></a><span id="l24.23">                             nsINetUtil::ESCAPE_URL_FILE_BASENAME |</span>
<a href="#l24.24"></a><span id="l24.24">                                 nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l24.25"></a><span id="l24.25">                             unescapedName);</span>
<a href="#l24.26"></a><span id="l24.26">           pMsgCompFields-&gt;SetNewsgroups(NS_ConvertUTF8toUTF16(unescapedName));</span>
<a href="#l24.27"></a><span id="l24.27">           pMsgCompFields-&gt;SetNewspostUrl(host.get());</span>
<a href="#l24.28"></a><span id="l24.28">         } else {</span>
<a href="#l24.29"></a><span id="l24.29">           pMsgComposeParams-&gt;SetOriginalMsgURI(originalMsgURI);</span>
<a href="#l24.30"></a><span id="l24.30">           pMsgComposeParams-&gt;SetOrigMsgHdr(origMsgHdr);</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+          pMsgCompFields-&gt;SetFrom(NS_ConvertUTF8toUTF16(from));</span>
<a href="#l24.32"></a><span id="l24.32">         }</span>
<a href="#l24.33"></a><span id="l24.33">       }</span>
<a href="#l24.34"></a><span id="l24.34"> </span>
<a href="#l24.35"></a><span id="l24.35">       pMsgComposeParams-&gt;SetComposeFields(pMsgCompFields);</span>
<a href="#l24.36"></a><span id="l24.36"> </span>
<a href="#l24.37"></a><span id="l24.37">       if (mLogComposePerformance) {</span>
<a href="#l24.38"></a><span id="l24.38"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l24.39"></a><span id="l24.39">         // ducarroz, properly fix this in the case of new message (not a reply)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -339,16 +339,17 @@ function openComposeWindowForRSSArticle(</span>
<a href="#l25.4"></a><span id="l25.4">     // The user is viewing the summary.</span>
<a href="#l25.5"></a><span id="l25.5">     MailServices.compose.OpenComposeWindow(</span>
<a href="#l25.6"></a><span id="l25.6">       aMsgComposeWindow,</span>
<a href="#l25.7"></a><span id="l25.7">       aMsgHdr,</span>
<a href="#l25.8"></a><span id="l25.8">       aMessageUri,</span>
<a href="#l25.9"></a><span id="l25.9">       aType,</span>
<a href="#l25.10"></a><span id="l25.10">       aFormat,</span>
<a href="#l25.11"></a><span id="l25.11">       aIdentity,</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+      null,</span>
<a href="#l25.13"></a><span id="l25.13">       aMsgWindow</span>
<a href="#l25.14"></a><span id="l25.14">     );</span>
<a href="#l25.15"></a><span id="l25.15">   } else {</span>
<a href="#l25.16"></a><span id="l25.16">     // Set up the compose message and get the feed message's web page link.</span>
<a href="#l25.17"></a><span id="l25.17">     let msgHdr = aMsgHdr;</span>
<a href="#l25.18"></a><span id="l25.18">     let type = aType;</span>
<a href="#l25.19"></a><span id="l25.19">     let msgComposeType = Ci.nsIMsgCompType;</span>
<a href="#l25.20"></a><span id="l25.20">     let subject = msgHdr.mime2DecodedSubject;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineat">@@ -406,29 +407,31 @@ function openComposeWindowForRSSArticle(</span>
<a href="#l25.22"></a><span id="l25.22">             // No content-base url, use the summary.</span>
<a href="#l25.23"></a><span id="l25.23">             MailServices.compose.OpenComposeWindow(</span>
<a href="#l25.24"></a><span id="l25.24">               aMsgComposeWindow,</span>
<a href="#l25.25"></a><span id="l25.25">               aMsgHdr,</span>
<a href="#l25.26"></a><span id="l25.26">               aMessageUri,</span>
<a href="#l25.27"></a><span id="l25.27">               aType,</span>
<a href="#l25.28"></a><span id="l25.28">               aFormat,</span>
<a href="#l25.29"></a><span id="l25.29">               aIdentity,</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+              null,</span>
<a href="#l25.31"></a><span id="l25.31">               aMsgWindow</span>
<a href="#l25.32"></a><span id="l25.32">             );</span>
<a href="#l25.33"></a><span id="l25.33">           }</span>
<a href="#l25.34"></a><span id="l25.34">         },</span>
<a href="#l25.35"></a><span id="l25.35">         false,</span>
<a href="#l25.36"></a><span id="l25.36">         { saneBodySize: true }</span>
<a href="#l25.37"></a><span id="l25.37">       );</span>
<a href="#l25.38"></a><span id="l25.38">     } catch (ex) {</span>
<a href="#l25.39"></a><span id="l25.39">       // Error getting header, use the summary.</span>
<a href="#l25.40"></a><span id="l25.40">       MailServices.compose.OpenComposeWindow(</span>
<a href="#l25.41"></a><span id="l25.41">         aMsgComposeWindow,</span>
<a href="#l25.42"></a><span id="l25.42">         aMsgHdr,</span>
<a href="#l25.43"></a><span id="l25.43">         aMessageUri,</span>
<a href="#l25.44"></a><span id="l25.44">         aType,</span>
<a href="#l25.45"></a><span id="l25.45">         aFormat,</span>
<a href="#l25.46"></a><span id="l25.46">         aIdentity,</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+        null,</span>
<a href="#l25.48"></a><span id="l25.48">         aMsgWindow</span>
<a href="#l25.49"></a><span id="l25.49">       );</span>
<a href="#l25.50"></a><span id="l25.50">     }</span>
<a href="#l25.51"></a><span id="l25.51">   }</span>
<a href="#l25.52"></a><span id="l25.52"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -871,16 +871,19 @@ pref(&quot;msgcompose.background_color&quot;,     </span>
<a href="#l26.4"></a><span id="l26.4"> // to prevent some mail server to disclose the bcc recipients</span>
<a href="#l26.5"></a><span id="l26.5"> pref(&quot;mail.compose.add_undisclosed_recipients&quot;, true);</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> pref(&quot;mail.compose.dontWarnMail2Newsgroup&quot;, false);</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> // Attach http image resources to composed messages.</span>
<a href="#l26.10"></a><span id="l26.10"> pref(&quot;mail.compose.attach_http_images&quot;, false);</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+// Additional headers to check to find the right sender if catchAll is active.</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+pref(&quot;mail.compose.catchAllHeaders&quot;, &quot;envelope-to, x-original-to&quot;);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+</span>
<a href="#l26.15"></a><span id="l26.15"> // these prefs (in minutes) are here to help QA test this feature</span>
<a href="#l26.16"></a><span id="l26.16"> // &quot;mail.purge.min_delay&quot;, never purge a junk folder more than once every 480 minutes (60 mins/hour * 8 hours)</span>
<a href="#l26.17"></a><span id="l26.17"> // &quot;mail.purge.timer_interval&quot;, fire the purge timer every 5 minutes, starting 5 minutes after we load accounts</span>
<a href="#l26.18"></a><span id="l26.18"> pref(&quot;mail.purge.min_delay&quot;, 480);</span>
<a href="#l26.19"></a><span id="l26.19"> pref(&quot;mail.purge.timer_interval&quot;, 5);</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21"> // Set to false if opening a message in the standalone message window or viewing</span>
<a href="#l26.22"></a><span id="l26.22"> // it in the message pane should never mark it as read.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/suite/browser/mailNavigatorOverlay.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/suite/browser/mailNavigatorOverlay.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -85,17 +85,17 @@ function goOpenNewMessage()</span>
<a href="#l27.4"></a><span id="l27.4">   }</span>
<a href="#l27.5"></a><span id="l27.5">   else</span>
<a href="#l27.6"></a><span id="l27.6">   {</span>
<a href="#l27.7"></a><span id="l27.7">     var msgComposeService = Cc[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l27.8"></a><span id="l27.8">                               .getService(Ci.nsIMsgComposeService);</span>
<a href="#l27.9"></a><span id="l27.9">     msgComposeService.OpenComposeWindow(null, null, null,</span>
<a href="#l27.10"></a><span id="l27.10">                                        Ci.nsIMsgCompType.New,</span>
<a href="#l27.11"></a><span id="l27.11">                                        Ci.nsIMsgCompFormat.Default,</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-                                       null, null);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+                                       null, null, null);</span>
<a href="#l27.14"></a><span id="l27.14">   }</span>
<a href="#l27.15"></a><span id="l27.15"> }</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17"> function sendLink(aURL)</span>
<a href="#l27.18"></a><span id="l27.18"> {</span>
<a href="#l27.19"></a><span id="l27.19">   var title = &quot;&quot;;</span>
<a href="#l27.20"></a><span id="l27.20">   if (!aURL)</span>
<a href="#l27.21"></a><span id="l27.21">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/suite/mailnews/content/mailCommands.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/suite/mailnews/content/mailCommands.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -188,32 +188,32 @@ function ComposeMessage(type, format, fo</span>
<a href="#l28.4"></a><span id="l28.4">       // If the addressbook sidebar panel is open and has focus, get</span>
<a href="#l28.5"></a><span id="l28.5">       // the selected addresses from it.</span>
<a href="#l28.6"></a><span id="l28.6">       if (document.commandDispatcher.focusedWindow &amp;&amp;</span>
<a href="#l28.7"></a><span id="l28.7">           document.commandDispatcher.focusedWindow</span>
<a href="#l28.8"></a><span id="l28.8">                   .document.documentElement.hasAttribute(&quot;selectedaddresses&quot;))</span>
<a href="#l28.9"></a><span id="l28.9">         NewMessageToSelectedAddresses(type, format, identity);</span>
<a href="#l28.10"></a><span id="l28.10">       else</span>
<a href="#l28.11"></a><span id="l28.11">         msgComposeService.OpenComposeWindow(null, null, null, type,</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-                                            format, identity, msgWindow);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+                                            format, identity, null, msgWindow);</span>
<a href="#l28.14"></a><span id="l28.14">       return;</span>
<a href="#l28.15"></a><span id="l28.15">     case msgComposeType.NewsPost:</span>
<a href="#l28.16"></a><span id="l28.16">       // dump(&quot;OpenComposeWindow with &quot; + identity + &quot; and &quot; + newsgroup + &quot;\n&quot;);</span>
<a href="#l28.17"></a><span id="l28.17">       msgComposeService.OpenComposeWindow(null, null, newsgroup, type,</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-                                          format, identity, msgWindow);</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+                                          format, identity, null, msgWindow);</span>
<a href="#l28.20"></a><span id="l28.20">       return;</span>
<a href="#l28.21"></a><span id="l28.21">     case msgComposeType.ForwardAsAttachment:</span>
<a href="#l28.22"></a><span id="l28.22">       if (messageArray &amp;&amp; messageArray.length)</span>
<a href="#l28.23"></a><span id="l28.23">       {</span>
<a href="#l28.24"></a><span id="l28.24">         // If we have more than one ForwardAsAttachment then pass null instead</span>
<a href="#l28.25"></a><span id="l28.25">         // of the header to tell the compose service to work out the attachment</span>
<a href="#l28.26"></a><span id="l28.26">         // subjects from the URIs.</span>
<a href="#l28.27"></a><span id="l28.27">         hdr = messageArray.length &gt; 1 ? null : messenger.msgHdrFromURI(messageArray[0]);</span>
<a href="#l28.28"></a><span id="l28.28">         msgComposeService.OpenComposeWindow(null, hdr, messageArray.join(','),</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-                                            type, format, identity, msgWindow);</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+                                            type, format, identity, null, msgWindow);</span>
<a href="#l28.31"></a><span id="l28.31">         return;</span>
<a href="#l28.32"></a><span id="l28.32">       }</span>
<a href="#l28.33"></a><span id="l28.33">     default:</span>
<a href="#l28.34"></a><span id="l28.34">       if (!messageArray)</span>
<a href="#l28.35"></a><span id="l28.35">         return;</span>
<a href="#l28.36"></a><span id="l28.36"> </span>
<a href="#l28.37"></a><span id="l28.37">       // Limit the number of new compose windows to 8. Why 8 ?</span>
<a href="#l28.38"></a><span id="l28.38">       // I like that number :-)</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineat">@@ -225,17 +225,17 @@ function ComposeMessage(type, format, fo</span>
<a href="#l28.40"></a><span id="l28.40">         var messageUri = messageArray[i];</span>
<a href="#l28.41"></a><span id="l28.41">         hdr = messenger.msgHdrFromURI(messageUri);</span>
<a href="#l28.42"></a><span id="l28.42">         identity = GetIdentityForHeader(hdr, type);</span>
<a href="#l28.43"></a><span id="l28.43">         if (FeedMessageHandler.isFeedMessage(hdr))</span>
<a href="#l28.44"></a><span id="l28.44">           openComposeWindowForRSSArticle(null, hdr, messageUri, type,</span>
<a href="#l28.45"></a><span id="l28.45">                                          format, identity, msgWindow);</span>
<a href="#l28.46"></a><span id="l28.46">         else</span>
<a href="#l28.47"></a><span id="l28.47">           msgComposeService.OpenComposeWindow(null, hdr, messageUri, type,</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-                                              format, identity, msgWindow);</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+                                              format, identity, null, msgWindow);</span>
<a href="#l28.50"></a><span id="l28.50">       }</span>
<a href="#l28.51"></a><span id="l28.51">   }</span>
<a href="#l28.52"></a><span id="l28.52"> }</span>
<a href="#l28.53"></a><span id="l28.53"> </span>
<a href="#l28.54"></a><span id="l28.54"> function NewMessageToSelectedAddresses(type, format, identity) {</span>
<a href="#l28.55"></a><span id="l28.55">   var abSidebarPanel = document.commandDispatcher.focusedWindow;</span>
<a href="#l28.56"></a><span id="l28.56">   var abResultsTree = abSidebarPanel.document.getElementById(&quot;abResultsTree&quot;);</span>
<a href="#l28.57"></a><span id="l28.57">   var abResultsBoxObject = abResultsTree.treeBoxObject;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/suite/mailnews/content/mailOverlay.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/suite/mailnews/content/mailOverlay.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -20,10 +20,10 @@ function goOpenNewMessage()</span>
<a href="#l29.4"></a><span id="l29.4">     return;</span>
<a href="#l29.5"></a><span id="l29.5">   }</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7">   Cc[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l29.8"></a><span id="l29.8">     .getService(Ci.nsIMsgComposeService)</span>
<a href="#l29.9"></a><span id="l29.9">     .OpenComposeWindow(null, null, null,</span>
<a href="#l29.10"></a><span id="l29.10">                                Ci.nsIMsgCompType.New,</span>
<a href="#l29.11"></a><span id="l29.11">                                Ci.nsIMsgCompFormat.Default,</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-                               null, null);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+                               null, null, null);</span>
<a href="#l29.14"></a><span id="l29.14"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

