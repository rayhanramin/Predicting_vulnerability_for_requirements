<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28410:fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2" />
<meta property="og:url" content="/comm-central/rev/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2" />
<meta property="og:description" content="'Bug 1594892 - xpidl [array] removal from nsIMsgDatabase.getNewList(). r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2">shortlog</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2">files</a> |
changeset |
<a href="/comm-central/raw-rev/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2">raw</a>  | <a href="/comm-central/archive/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
'<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594892">Bug 1594892</a> - xpidl [array] removal from nsIMsgDatabase.getNewList(). r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 19 Dec 2019 15:16:42 +0200</td></tr>

<tr>
 <td>changeset 28410</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2">fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2</a></td>
</tr>



<tr>
<td>parent 28409</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8f61543e6276bcef818dc2f5952cb4ecb30d6da9">8f61543e6276bcef818dc2f5952cb4ecb30d6da9</a>
</td>
</tr>

<tr>
<td>child 28411</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e68e4b9259f3dbd6e8015024673b4d7e74d9849f">e68e4b9259f3dbd6e8015024673b4d7e74d9849f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2">16823</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 19 Dec 2019 18:59:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e68e4b9259f3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e68e4b9259f3dbd6e8015024673b4d7e74d9849f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e68e4b9259f3dbd6e8015024673b4d7e74d9849f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e68e4b9259f3dbd6e8015024673b4d7e74d9849f&newProject=comm-central&newRevision=205335c2060659b8df60817d1d2cd2ef6356e700&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e68e4b9259f3dbd6e8015024673b4d7e74d9849f&newProject=comm-central&newRevision=205335c2060659b8df60817d1d2cd2ef6356e700&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e68e4b9259f3dbd6e8015024673b4d7e74d9849f&newProject=comm-central&newRevision=205335c2060659b8df60817d1d2cd2ef6356e700&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594892">1594892</a></td></tr>




</table></div>

<div class="page_body description">'<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594892">Bug 1594892</a> - xpidl [array] removal from nsIMsgDatabase.getNewList(). r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mail/base/content/foldersummary.js">mail/base/content/foldersummary.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mail/base/content/foldersummary.js">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mail/base/content/foldersummary.js">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mail/base/content/foldersummary.js">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mail/base/content/foldersummary.js">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mail/base/content/foldersummary.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerOSXIntegration.mm">mailnews/base/src/nsMessengerOSXIntegration.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerOSXIntegration.mm">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerOSXIntegration.mm">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerOSXIntegration.mm">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerOSXIntegration.mm">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerOSXIntegration.mm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerUnixIntegration.cpp">mailnews/base/src/nsMessengerUnixIntegration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerUnixIntegration.cpp">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerUnixIntegration.cpp">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerUnixIntegration.cpp">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerUnixIntegration.cpp">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/src/nsMessengerUnixIntegration.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/public/nsIMsgDatabase.idl">mailnews/db/msgdb/public/nsIMsgDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/public/nsIMsgDatabase.idl">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/public/nsIMsgDatabase.idl">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/public/nsIMsgDatabase.idl">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/public/nsIMsgDatabase.idl">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/public/nsIMsgDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActions.js">mailnews/imap/test/unit/test_imapFilterActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActions.js">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActions.js">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActions.js">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActions.js">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/suite/mailnews/content/mailWidgets.xml">suite/mailnews/content/mailWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/suite/mailnews/content/mailWidgets.xml">file</a> |
<a href="/comm-central/annotate/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/suite/mailnews/content/mailWidgets.xml">annotate</a> |
<a href="/comm-central/diff/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/suite/mailnews/content/mailWidgets.xml">diff</a> |
<a href="/comm-central/comparison/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/suite/mailnews/content/mailWidgets.xml">comparison</a> |
<a href="/comm-central/log/fb1646d8e45c239e5e94bd3fbdbef16e2650f8f2/suite/mailnews/content/mailWidgets.xml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/foldersummary.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/foldersummary.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -130,30 +130,28 @@</span>
<a href="#l1.4"></a><span id="l1.4">           msgDatabase = folder.msgDatabase;</span>
<a href="#l1.5"></a><span id="l1.5">         } catch (e) {</span>
<a href="#l1.6"></a><span id="l1.6">           // The database for this folder may be missing (e.g. outdated/missing .msf),</span>
<a href="#l1.7"></a><span id="l1.7">           // then just skip this folder.</span>
<a href="#l1.8"></a><span id="l1.8">           continue;</span>
<a href="#l1.9"></a><span id="l1.9">         }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">         folder.msgDatabase = null;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        let msgKeys = {};</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-        let numMsgKeys = {};</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        msgDatabase.getNewList(numMsgKeys, msgKeys);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+        let msgKeys = msgDatabase.getNewList();</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-        if (!numMsgKeys.value) {</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        if (!msgKeys.length) {</span>
<a href="#l1.19"></a><span id="l1.19">           continue;</span>
<a href="#l1.20"></a><span id="l1.20">         }</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">         if (this.showPreview) {</span>
<a href="#l1.23"></a><span id="l1.23">           // fetchMsgPreviewText forces the previewText property to get generated</span>
<a href="#l1.24"></a><span id="l1.24">           // for each of the message keys.</span>
<a href="#l1.25"></a><span id="l1.25">           try {</span>
<a href="#l1.26"></a><span id="l1.26">             outAsync.value = folder.fetchMsgPreviewText(</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-              msgKeys.value,</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+              msgKeys,</span>
<a href="#l1.29"></a><span id="l1.29">               false,</span>
<a href="#l1.30"></a><span id="l1.30">               urlListener</span>
<a href="#l1.31"></a><span id="l1.31">             );</span>
<a href="#l1.32"></a><span id="l1.32">             folder.msgDatabase = null;</span>
<a href="#l1.33"></a><span id="l1.33">           } catch (ex) {</span>
<a href="#l1.34"></a><span id="l1.34">             // fetchMsgPreviewText throws an error when we call it on a news</span>
<a href="#l1.35"></a><span id="l1.35">             // folder</span>
<a href="#l1.36"></a><span id="l1.36">             folder.msgDatabase = null;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineat">@@ -172,23 +170,19 @@</span>
<a href="#l1.38"></a><span id="l1.38">         }</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">         // In the case of async fetching for more than one folder, we may</span>
<a href="#l1.41"></a><span id="l1.41">         //  already have got enough to show (added by another urllistener).</span>
<a href="#l1.42"></a><span id="l1.42">         if (this.children.length &gt;= this.maxMsgHdrsInPopup) {</span>
<a href="#l1.43"></a><span id="l1.43">           return false;</span>
<a href="#l1.44"></a><span id="l1.44">         }</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-        for (</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-          let i = 0;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-          i &lt; this.maxMsgHdrsInPopup &amp;&amp; i &lt; numMsgKeys.value;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-          i++</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-        ) {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+        for (let i = 0; i &lt; this.maxMsgHdrsInPopup &amp;&amp; i &lt; msgKeys.length; i++) {</span>
<a href="#l1.52"></a><span id="l1.52">           let msgBox = createFolderSummaryMessage();</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-          let msgHdr = msgDatabase.GetMsgHdrForKey(msgKeys.value[i]);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+          let msgHdr = msgDatabase.GetMsgHdrForKey(msgKeys[i]);</span>
<a href="#l1.55"></a><span id="l1.55">           msgBox.addEventListener(&quot;click&quot;, event =&gt; {</span>
<a href="#l1.56"></a><span id="l1.56">             if (event.button !== 0) {</span>
<a href="#l1.57"></a><span id="l1.57">               return;</span>
<a href="#l1.58"></a><span id="l1.58">             }</span>
<a href="#l1.59"></a><span id="l1.59">             MailUtils.displayMessageInFolderTab(msgHdr);</span>
<a href="#l1.60"></a><span id="l1.60">             if (gAlertListener) {</span>
<a href="#l1.61"></a><span id="l1.61">               gAlertListener.observe(null, &quot;alertclickcallback&quot;, &quot;&quot;);</span>
<a href="#l1.62"></a><span id="l1.62">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerOSXIntegration.mm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerOSXIntegration.mm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -301,25 +301,23 @@ void nsMessengerOSXIntegration::FillTool</span>
<a href="#l2.4"></a><span id="l2.4">         AutoTArray&lt;nsString, 2&gt; formatStrings = {numNewMsgsText, authors};</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">         if (aNewCount == 1) {</span>
<a href="#l2.7"></a><span id="l2.7">           bundle-&gt;FormatStringFromName(&quot;macBiffNotification_message&quot;, formatStrings, finalText);</span>
<a href="#l2.8"></a><span id="l2.8">           // Since there is only 1 message, use the most recent mail's URI instead of the folder's</span>
<a href="#l2.9"></a><span id="l2.9">           nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.10"></a><span id="l2.10">           rv = aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l2.11"></a><span id="l2.11">           if (NS_SUCCEEDED(rv) &amp;&amp; db) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            uint32_t numNewKeys;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-            uint32_t *newMessageKeys;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-            rv = db-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-            if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+            nsTArray&lt;nsMsgKey&gt; newMessageKeys;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+            rv = db-&gt;GetNewList(newMessageKeys);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; !newMessageKeys.IsEmpty()) {</span>
<a href="#l2.19"></a><span id="l2.19">               nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-              rv = db-&gt;GetMsgHdrForKey(newMessageKeys[numNewKeys - 1], getter_AddRefs(hdr));</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+              rv = db-&gt;GetMsgHdrForKey(newMessageKeys.LastElement(), getter_AddRefs(hdr));</span>
<a href="#l2.22"></a><span id="l2.22">               if (NS_SUCCEEDED(rv) &amp;&amp; hdr) aFolder-&gt;GetUriForMsg(hdr, uri);</span>
<a href="#l2.23"></a><span id="l2.23">             }</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-            free(newMessageKeys);</span>
<a href="#l2.25"></a><span id="l2.25">           }</span>
<a href="#l2.26"></a><span id="l2.26">         } else</span>
<a href="#l2.27"></a><span id="l2.27">           bundle-&gt;FormatStringFromName(&quot;macBiffNotification_messages&quot;, formatStrings, finalText);</span>
<a href="#l2.28"></a><span id="l2.28">       }</span>
<a href="#l2.29"></a><span id="l2.29">       ShowAlertMessage(accountName, finalText, uri);</span>
<a href="#l2.30"></a><span id="l2.30">     }  // if we got a bundle</span>
<a href="#l2.31"></a><span id="l2.31">   }    // if we got a folder</span>
<a href="#l2.32"></a><span id="l2.32"> }</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineat">@@ -498,34 +496,33 @@ nsresult nsMessengerOSXIntegration::GetN</span>
<a href="#l2.34"></a><span id="l2.34">   // are removed, and names are displayed to a set limit</span>
<a href="#l2.35"></a><span id="l2.35">   // (kMaxDisplayCount) with the remaining count being returned in</span>
<a href="#l2.36"></a><span id="l2.36">   // aNotDisplayed. Extension developers can listen for</span>
<a href="#l2.37"></a><span id="l2.37">   // &quot;newmail-notification-requested&quot; and then make a decision about</span>
<a href="#l2.38"></a><span id="l2.38">   // including a given author or not. As a result, it is possible that</span>
<a href="#l2.39"></a><span id="l2.39">   // the resulting length of aAuthors will be 0.</span>
<a href="#l2.40"></a><span id="l2.40">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.41"></a><span id="l2.41">   nsresult rv = aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-  uint32_t numNewKeys = 0;</span>
<a href="#l2.43"></a><span id="l2.43">   if (NS_SUCCEEDED(rv) &amp;&amp; db) {</span>
<a href="#l2.44"></a><span id="l2.44">     nsCOMPtr&lt;nsIObserverService&gt; os = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l2.45"></a><span id="l2.45">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">     // Get proper l10n list separator -- &quot;, &quot; in English</span>
<a href="#l2.48"></a><span id="l2.48">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l2.49"></a><span id="l2.49">     GetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l2.50"></a><span id="l2.50">     if (!bundle) return NS_ERROR_FAILURE;</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    uint32_t *newMessageKeys;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-    rv = db-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    nsTArray&lt;nsMsgKey&gt; newMessageKeys;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    rv = db-&gt;GetNewList(newMessageKeys);</span>
<a href="#l2.56"></a><span id="l2.56">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.57"></a><span id="l2.57">       nsString listSeparator;</span>
<a href="#l2.58"></a><span id="l2.58">       bundle-&gt;GetStringFromName(&quot;macBiffNotification_separator&quot;, listSeparator);</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60">       int32_t displayed = 0;</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-      for (int32_t i = numNewKeys - 1; i &gt;= 0; i--, aNewCount--) {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+      for (int32_t i = newMessageKeys.Length() - 1; i &gt;= 0; i--, aNewCount--) {</span>
<a href="#l2.63"></a><span id="l2.63">         if (0 == aNewCount || displayed == kMaxDisplayCount) break;</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">         nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l2.66"></a><span id="l2.66">         rv = db-&gt;GetMsgHdrForKey(newMessageKeys[i], getter_AddRefs(hdr));</span>
<a href="#l2.67"></a><span id="l2.67">         if (NS_SUCCEEDED(rv) &amp;&amp; hdr) {</span>
<a href="#l2.68"></a><span id="l2.68">           nsString author;</span>
<a href="#l2.69"></a><span id="l2.69">           rv = hdr-&gt;GetMime2DecodedAuthor(author);</span>
<a href="#l2.70"></a><span id="l2.70">           if (NS_FAILED(rv)) continue;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineat">@@ -546,17 +543,16 @@ nsresult nsMessengerOSXIntegration::GetN</span>
<a href="#l2.72"></a><span id="l2.72">           if (includeSender &amp;&amp; aAuthors.Find(name, true) == -1) {</span>
<a href="#l2.73"></a><span id="l2.73">             if (displayed &gt; 0) aAuthors.Append(listSeparator);</span>
<a href="#l2.74"></a><span id="l2.74">             aAuthors.Append(name);</span>
<a href="#l2.75"></a><span id="l2.75">             displayed++;</span>
<a href="#l2.76"></a><span id="l2.76">           }</span>
<a href="#l2.77"></a><span id="l2.77">         }</span>
<a href="#l2.78"></a><span id="l2.78">       }</span>
<a href="#l2.79"></a><span id="l2.79">     }</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-    free(newMessageKeys);</span>
<a href="#l2.81"></a><span id="l2.81">   }</span>
<a href="#l2.82"></a><span id="l2.82">   *aNotDisplayed = aNewCount;</span>
<a href="#l2.83"></a><span id="l2.83">   return rv;</span>
<a href="#l2.84"></a><span id="l2.84"> }</span>
<a href="#l2.85"></a><span id="l2.85"> </span>
<a href="#l2.86"></a><span id="l2.86"> nsresult nsMessengerOSXIntegration::GetFirstFolderWithNewMail(nsIMsgFolder *aFolder,</span>
<a href="#l2.87"></a><span id="l2.87">                                                               nsCString &amp;aFolderURI) {</span>
<a href="#l2.88"></a><span id="l2.88">   // Find the subfolder in aFolder with new mail and return the folderURI</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerUnixIntegration.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerUnixIntegration.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -435,52 +435,46 @@ void nsMessengerUnixIntegration::FillToo</span>
<a href="#l3.4"></a><span id="l3.4">     nsString alertTitle;</span>
<a href="#l3.5"></a><span id="l3.5">     if (!BuildNotificationTitle(folder, bundle, alertTitle)) return;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">     // Let's get the new mail for this folder</span>
<a href="#l3.8"></a><span id="l3.8">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l3.9"></a><span id="l3.9">     if (NS_FAILED(folderWithNewMail-&gt;GetMsgDatabase(getter_AddRefs(db))))</span>
<a href="#l3.10"></a><span id="l3.10">       return;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    uint32_t numNewKeys = 0;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    uint32_t *newMessageKeys;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    db-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    nsTArray&lt;nsMsgKey&gt; newMessageKeys;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    db-&gt;GetNewList(newMessageKeys);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     // If we had new messages, we *should* have new keys, but we'll</span>
<a href="#l3.19"></a><span id="l3.19">     // check just in case.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    if (numNewKeys &lt;= 0) {</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-      free(newMessageKeys);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+    if (newMessageKeys.IsEmpty()) {</span>
<a href="#l3.23"></a><span id="l3.23">       return;</span>
<a href="#l3.24"></a><span id="l3.24">     }</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">     // Find the rootFolder that folder belongs to, and find out</span>
<a href="#l3.27"></a><span id="l3.27">     // what MRUTime it maps to.  Assign this to lastMRUTime.</span>
<a href="#l3.28"></a><span id="l3.28">     uint32_t lastMRUTime = 0;</span>
<a href="#l3.29"></a><span id="l3.29">     if (NS_FAILED(GetMRUTimestampForFolder(folder, &amp;lastMRUTime)))</span>
<a href="#l3.30"></a><span id="l3.30">       lastMRUTime = 0;</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">     // Next, add the new message headers to an nsCOMArray.  We</span>
<a href="#l3.33"></a><span id="l3.33">     // only add message headers that are newer than lastMRUTime.</span>
<a href="#l3.34"></a><span id="l3.34">     nsCOMArray&lt;nsIMsgDBHdr&gt; newMsgHdrs;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    for (unsigned int i = 0; i &lt; numNewKeys; ++i) {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    for (unsigned int i = 0; i &lt; newMessageKeys.Length(); ++i) {</span>
<a href="#l3.37"></a><span id="l3.37">       nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l3.38"></a><span id="l3.38">       if (NS_FAILED(</span>
<a href="#l3.39"></a><span id="l3.39">               db-&gt;GetMsgHdrForKey(newMessageKeys[i], getter_AddRefs(hdr))))</span>
<a href="#l3.40"></a><span id="l3.40">         continue;</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">       uint32_t dateInSeconds = 0;</span>
<a href="#l3.43"></a><span id="l3.43">       hdr-&gt;GetDateInSeconds(&amp;dateInSeconds);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">       if (dateInSeconds &gt; lastMRUTime) newMsgHdrs.AppendObject(hdr);</span>
<a href="#l3.46"></a><span id="l3.46">     }</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-    // At this point, we don't need newMessageKeys any more,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    // so let's free it.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    free(newMessageKeys);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-</span>
<a href="#l3.52"></a><span id="l3.52">     // If we didn't happen to add any message headers, bail out</span>
<a href="#l3.53"></a><span id="l3.53">     if (!newMsgHdrs.Count()) return;</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">     // Sort the message headers by dateInSeconds, in ascending</span>
<a href="#l3.56"></a><span id="l3.56">     // order</span>
<a href="#l3.57"></a><span id="l3.57">     newMsgHdrs.Sort(nsMsgDbHdrTimestampComparator, nullptr);</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59">     nsString alertBody;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -537,24 +537,17 @@ NS_IMETHODIMP nsMsgDBFolder::GetFirstNew</span>
<a href="#l4.4"></a><span id="l4.4"> }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> NS_IMETHODIMP nsMsgDBFolder::ClearNewMessages() {</span>
<a href="#l4.7"></a><span id="l4.7">   nsresult rv = NS_OK;</span>
<a href="#l4.8"></a><span id="l4.8">   bool dbWasCached = mDatabase != nullptr;</span>
<a href="#l4.9"></a><span id="l4.9">   if (!dbWasCached) GetDatabase();</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   if (mDatabase) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    uint32_t numNewKeys;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    nsMsgKey *newMessageKeys;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    rv = mDatabase-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; newMessageKeys) {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-      m_saveNewMsgs.Clear();</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-      m_saveNewMsgs.AppendElements(newMessageKeys, numNewKeys);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-      free(newMessageKeys);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    }</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+    mDatabase-&gt;GetNewList(m_saveNewMsgs);</span>
<a href="#l4.21"></a><span id="l4.21">     mDatabase-&gt;ClearNewList(true);</span>
<a href="#l4.22"></a><span id="l4.22">   }</span>
<a href="#l4.23"></a><span id="l4.23">   if (!dbWasCached) SetMsgDatabase(nullptr);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   m_newMsgs.Clear();</span>
<a href="#l4.26"></a><span id="l4.26">   mNumNewBiffMessages = 0;</span>
<a href="#l4.27"></a><span id="l4.27">   return rv;</span>
<a href="#l4.28"></a><span id="l4.28"> }</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -908,24 +901,17 @@ nsMsgDBFolder::GetMsgDatabase(nsIMsgData</span>
<a href="#l4.30"></a><span id="l4.30"> NS_IMETHODIMP</span>
<a href="#l4.31"></a><span id="l4.31"> nsMsgDBFolder::SetMsgDatabase(nsIMsgDatabase *aMsgDatabase) {</span>
<a href="#l4.32"></a><span id="l4.32">   if (mDatabase) {</span>
<a href="#l4.33"></a><span id="l4.33">     // commit here - db might go away when all these refs are released.</span>
<a href="#l4.34"></a><span id="l4.34">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l4.35"></a><span id="l4.35">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l4.36"></a><span id="l4.36">     mDatabase-&gt;ClearCachedHdrs();</span>
<a href="#l4.37"></a><span id="l4.37">     if (!aMsgDatabase) {</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-      uint32_t numNewKeys;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-      nsMsgKey *newMessageKeys;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-      nsresult rv = mDatabase-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; newMessageKeys) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-        m_newMsgs.Clear();</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-        m_newMsgs.AppendElements(newMessageKeys, numNewKeys);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-      }</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-      free(newMessageKeys);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+      mDatabase-&gt;GetNewList(m_newMsgs);</span>
<a href="#l4.47"></a><span id="l4.47">     }</span>
<a href="#l4.48"></a><span id="l4.48">   }</span>
<a href="#l4.49"></a><span id="l4.49">   mDatabase = aMsgDatabase;</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51">   if (aMsgDatabase) aMsgDatabase-&gt;AddListener(this);</span>
<a href="#l4.52"></a><span id="l4.52">   return NS_OK;</span>
<a href="#l4.53"></a><span id="l4.53"> }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55" class="difflineat">@@ -2443,32 +2429,30 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l4.56"></a><span id="l4.56">   if (!filterForOther &amp;&amp; !filterForJunk &amp;&amp; !filterPostPlugin) {</span>
<a href="#l4.57"></a><span id="l4.57">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;No filters need to be run&quot;));</span>
<a href="#l4.58"></a><span id="l4.58">     NotifyHdrsNotBeingClassified();</span>
<a href="#l4.59"></a><span id="l4.59">     return NS_OK;</span>
<a href="#l4.60"></a><span id="l4.60">   }</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62">   // get the list of new messages</span>
<a href="#l4.63"></a><span id="l4.63">   //</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-  uint32_t numNewKeys;</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-  nsMsgKey *newKeys;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-  rv = database-&gt;GetNewList(&amp;numNewKeys, &amp;newKeys);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; newKeys;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  rv = database-&gt;GetNewList(newKeys);</span>
<a href="#l4.69"></a><span id="l4.69">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-          (&quot;Running filters on %&quot; PRIu32 &quot; new messages&quot;, numNewKeys));</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+          (&quot;Running filters on %&quot; PRIu32 &quot; new messages&quot;,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+           (uint32_t)newKeys.Length()));</span>
<a href="#l4.75"></a><span id="l4.75"> </span>
<a href="#l4.76"></a><span id="l4.76">   nsTArray&lt;nsMsgKey&gt; newMessageKeys;</span>
<a href="#l4.77"></a><span id="l4.77">   // Start from m_saveNewMsgs (and clear its current state).  m_saveNewMsgs is</span>
<a href="#l4.78"></a><span id="l4.78">   // where we stash the list of new messages when we are told to clear the list</span>
<a href="#l4.79"></a><span id="l4.79">   // of new messages by the UI (which purges the list from the nsMsgDatabase).</span>
<a href="#l4.80"></a><span id="l4.80">   newMessageKeys.SwapElements(m_saveNewMsgs);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  if (numNewKeys) newMessageKeys.AppendElements(newKeys, numNewKeys);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-  free(newKeys);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  newMessageKeys.AppendElements(newKeys);</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86">   // build up list of keys to classify</span>
<a href="#l4.87"></a><span id="l4.87">   nsTArray&lt;nsMsgKey&gt; classifyMsgKeys;</span>
<a href="#l4.88"></a><span id="l4.88">   nsCString uri;</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90">   uint32_t numNewMessages = newMessageKeys.Length();</span>
<a href="#l4.91"></a><span id="l4.91">   for (uint32_t i = 0; i &lt; numNewMessages; ++i) {</span>
<a href="#l4.92"></a><span id="l4.92">     nsMsgKey msgKey = newMessageKeys[i];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -535,21 +535,18 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l5.4"></a><span id="l5.4">   readonly attribute nsMsgViewSortTypeValue  defaultSortType;</span>
<a href="#l5.5"></a><span id="l5.5">   readonly attribute nsMsgViewSortOrderValue defaultSortOrder;</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   // for msg hdr hash table allocation. controllable by caller to improve folder loading performance.</span>
<a href="#l5.8"></a><span id="l5.8">   attribute unsigned long msgHdrCacheSize;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   /**</span>
<a href="#l5.11"></a><span id="l5.11">    * The list of messages currently in the NEW state.</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-   *</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-   * If there are no such messages, a null pointer may be returned.</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-   * the caller should free when done using free.</span>
<a href="#l5.15"></a><span id="l5.15">    */</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  void getNewList(out unsigned long count, [array, size_is(count)] out nsMsgKey newKeys);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  Array&lt;nsMsgKey&gt; getNewList();</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   // These are used for caching search hits in a db, to speed up saved search folders.</span>
<a href="#l5.20"></a><span id="l5.20">   nsISimpleEnumerator getCachedHits(in string aSearchFolderUri);</span>
<a href="#l5.21"></a><span id="l5.21">   void refreshCache(in string aSearchFolderUri, in unsigned long aNumKeys, [array, size_is (aNumKeys)] in nsMsgKey aNewHits,</span>
<a href="#l5.22"></a><span id="l5.22">      out unsigned long aNumBadHits, [array, size_is(aNumBadHits)] out nsMsgKey aStaleHits);</span>
<a href="#l5.23"></a><span id="l5.23">   void updateHdrInCache(in string aSearchFolderUri, in nsIMsgDBHdr aHdr, in boolean aAdd);</span>
<a href="#l5.24"></a><span id="l5.24">   boolean hdrIsInCache(in string aSearchFolderUri, in nsIMsgDBHdr aHdr);</span>
<a href="#l5.25"></a><span id="l5.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -5077,36 +5077,19 @@ NS_IMETHODIMP nsMsgDatabase::GetDefaultS</span>
<a href="#l6.4"></a><span id="l6.4"> NS_IMETHODIMP nsMsgDatabase::ResetHdrCacheSize(uint32_t aSize) {</span>
<a href="#l6.5"></a><span id="l6.5">   if (m_cacheSize &gt; aSize) {</span>
<a href="#l6.6"></a><span id="l6.6">     m_cacheSize = aSize;</span>
<a href="#l6.7"></a><span id="l6.7">     ClearHdrCache(false);</span>
<a href="#l6.8"></a><span id="l6.8">   }</span>
<a href="#l6.9"></a><span id="l6.9">   return NS_OK;</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-/**</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  void getNewList(out unsigned long count, [array, size_is(count)] out long</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  newKeys);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">- */</span>
<a href="#l6.16"></a><span id="l6.16"> NS_IMETHODIMP</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-nsMsgDatabase::GetNewList(uint32_t *aCount, nsMsgKey **aNewKeys) {</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aNewKeys);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  *aCount = m_newSet.Length();</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-  if (*aCount &gt; 0) {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-    *aNewKeys =</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-        static_cast&lt;nsMsgKey *&gt;(moz_xmalloc(*aCount * sizeof(nsMsgKey)));</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-    if (!*aNewKeys) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    memcpy(*aNewKeys, m_newSet.Elements(), *aCount * sizeof(nsMsgKey));</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-  }</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  // if there were no new messages, signal this by returning a null pointer</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  //</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  *aNewKeys = nullptr;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+nsMsgDatabase::GetNewList(nsTArray&lt;nsMsgKey&gt; &amp;aNewKeys) {</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  aNewKeys = m_newSet;</span>
<a href="#l6.34"></a><span id="l6.34">   return NS_OK;</span>
<a href="#l6.35"></a><span id="l6.35"> }</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37"> nsresult nsMsgDatabase::GetSearchResultsTable(const char *searchFolderUri,</span>
<a href="#l6.38"></a><span id="l6.38">                                               bool createIfMissing,</span>
<a href="#l6.39"></a><span id="l6.39">                                               nsIMdbTable **table) {</span>
<a href="#l6.40"></a><span id="l6.40">   mdb_kind kindToken;</span>
<a href="#l6.41"></a><span id="l6.41">   mdb_count numTables;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -535,20 +535,18 @@ var gPreviousUnread = 0;</span>
<a href="#l7.4"></a><span id="l7.4"> //  aFolderNewDelta: change in new count for the folder</span>
<a href="#l7.5"></a><span id="l7.5"> //  aDbNewDelta:     change in new count for the database</span>
<a href="#l7.6"></a><span id="l7.6"> //</span>
<a href="#l7.7"></a><span id="l7.7"> function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta) {</span>
<a href="#l7.8"></a><span id="l7.8">   try {</span>
<a href="#l7.9"></a><span id="l7.9">     let folderNew = IMAPPump.inbox.getNumNewMessages(false);</span>
<a href="#l7.10"></a><span id="l7.10">     let hasNew = IMAPPump.inbox.hasNewMessages;</span>
<a href="#l7.11"></a><span id="l7.11">     let unread = IMAPPump.inbox.getNumUnread(false);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    let countOut = {};</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    let arrayOut = {};</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-    db().getNewList(countOut, arrayOut);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-    let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    let arrayOut = db().getNewList();</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    let dbNew = arrayOut.length;</span>
<a href="#l7.18"></a><span id="l7.18">     dump(</span>
<a href="#l7.19"></a><span id="l7.19">       &quot; hasNew: &quot; +</span>
<a href="#l7.20"></a><span id="l7.20">         hasNew +</span>
<a href="#l7.21"></a><span id="l7.21">         &quot; unread: &quot; +</span>
<a href="#l7.22"></a><span id="l7.22">         unread +</span>
<a href="#l7.23"></a><span id="l7.23">         &quot; folderNew: &quot; +</span>
<a href="#l7.24"></a><span id="l7.24">         folderNew +</span>
<a href="#l7.25"></a><span id="l7.25">         &quot; dbNew: &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -367,20 +367,18 @@ var gPreviousUnread;</span>
<a href="#l8.4"></a><span id="l8.4"> //  aFolderNewDelta: change in new count for the folder</span>
<a href="#l8.5"></a><span id="l8.5"> //  aDbNewDelta:     change in new count for the database</span>
<a href="#l8.6"></a><span id="l8.6"> //</span>
<a href="#l8.7"></a><span id="l8.7"> function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta) {</span>
<a href="#l8.8"></a><span id="l8.8">   try {</span>
<a href="#l8.9"></a><span id="l8.9">     let folderNew = IMAPPump.inbox.getNumNewMessages(false);</span>
<a href="#l8.10"></a><span id="l8.10">     let hasNew = IMAPPump.inbox.hasNewMessages;</span>
<a href="#l8.11"></a><span id="l8.11">     let unread = IMAPPump.inbox.getNumUnread(false);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    let countOut = {};</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    let arrayOut = {};</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-    db().getNewList(countOut, arrayOut);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    let arrayOut = db().getNewList();</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+    let dbNew = arrayOut.length;</span>
<a href="#l8.18"></a><span id="l8.18">     dump(</span>
<a href="#l8.19"></a><span id="l8.19">       &quot; hasNew: &quot; +</span>
<a href="#l8.20"></a><span id="l8.20">         hasNew +</span>
<a href="#l8.21"></a><span id="l8.21">         &quot; unread: &quot; +</span>
<a href="#l8.22"></a><span id="l8.22">         unread +</span>
<a href="#l8.23"></a><span id="l8.23">         &quot; folderNew: &quot; +</span>
<a href="#l8.24"></a><span id="l8.24">         folderNew +</span>
<a href="#l8.25"></a><span id="l8.25">         &quot; dbNew: &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/mailnews/content/mailWidgets.xml</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/mailnews/content/mailWidgets.xml</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1891,29 +1891,27 @@</span>
<a href="#l9.4"></a><span id="l9.4">               folderArray[0] = aFolder;</span>
<a href="#l9.5"></a><span id="l9.5">             var foundNewMsg = false;</span>
<a href="#l9.6"></a><span id="l9.6">             for (var folderIndex = 0; folderIndex &lt; folderArray.length; folderIndex++)</span>
<a href="#l9.7"></a><span id="l9.7">             {</span>
<a href="#l9.8"></a><span id="l9.8">               aFolder = folderArray[folderIndex];</span>
<a href="#l9.9"></a><span id="l9.9">               // now get the database</span>
<a href="#l9.10"></a><span id="l9.10">               var msgDatabase = aFolder.msgDatabase;</span>
<a href="#l9.11"></a><span id="l9.11">               aFolder.msgDatabase = null;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-              var msgKeys = {};</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-              var numMsgKeys = {};</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-              msgDatabase.getNewList(numMsgKeys, msgKeys);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+              let msgKeys = msgDatabase.getNewList();</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-              if (!numMsgKeys.value)</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+              if (!msgKeys.length)</span>
<a href="#l9.19"></a><span id="l9.19">                 continue;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">               if (showPreviewText)</span>
<a href="#l9.22"></a><span id="l9.22">               {</span>
<a href="#l9.23"></a><span id="l9.23">                 // fetchMsgPreviewText forces the previewText property to get generated</span>
<a href="#l9.24"></a><span id="l9.24">                 // for each of the message keys.</span>
<a href="#l9.25"></a><span id="l9.25">                 try {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-                  aOutAsync.value = aFolder.fetchMsgPreviewText(msgKeys.value, false, aUrlListener);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+                  aOutAsync.value = aFolder.fetchMsgPreviewText(msgKeys, false, aUrlListener);</span>
<a href="#l9.28"></a><span id="l9.28">                   aFolder.msgDatabase = null;</span>
<a href="#l9.29"></a><span id="l9.29">                 }</span>
<a href="#l9.30"></a><span id="l9.30">                 catch (ex)</span>
<a href="#l9.31"></a><span id="l9.31">                 {</span>
<a href="#l9.32"></a><span id="l9.32">                   // fetchMsgPreviewText throws an error when we call it on a news folder, we should just not show</span>
<a href="#l9.33"></a><span id="l9.33">                   // the tooltip if this method returns an error.</span>
<a href="#l9.34"></a><span id="l9.34">                   aFolder.msgDatabase = null;</span>
<a href="#l9.35"></a><span id="l9.35">                   continue;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineat">@@ -1928,20 +1926,20 @@</span>
<a href="#l9.37"></a><span id="l9.37">               var unicodeConverter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l9.38"></a><span id="l9.38">                                     .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l9.39"></a><span id="l9.39">               unicodeConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l9.40"></a><span id="l9.40">               foundNewMsg = true;</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42">               var index = 0;</span>
<a href="#l9.43"></a><span id="l9.43">               var hdrParser = Cc[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l9.44"></a><span id="l9.44">                                 .getService(Ci.nsIMsgHeaderParser);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-              while (document.getAnonymousNodes(this)[0].childNodes.length &lt; this.mMaxMsgHdrsInPopup &amp;&amp; index &lt; numMsgKeys.value)</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+              while (document.getAnonymousNodes(this)[0].childNodes.length &lt; this.mMaxMsgHdrsInPopup &amp;&amp; index &lt; msgKeys.length)</span>
<a href="#l9.47"></a><span id="l9.47">               {</span>
<a href="#l9.48"></a><span id="l9.48">                 var msgPopup = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;folderSummaryMessage&quot;);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-                var msgHdr = msgDatabase.GetMsgHdrForKey(msgKeys.value[index++]);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+                var msgHdr = msgDatabase.GetMsgHdrForKey(msgKeys[index++]);</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">                 var msgSubject = msgHdr.mime2DecodedSubject;</span>
<a href="#l9.53"></a><span id="l9.53">                 const kMsgFlagHasRe = 0x0010; // MSG_FLAG_HAS_RE</span>
<a href="#l9.54"></a><span id="l9.54">                 if(msgHdr.flags &amp; kMsgFlagHasRe)</span>
<a href="#l9.55"></a><span id="l9.55">                   msgSubject = (msgSubject) ? &quot;Re: &quot; + msgSubject : &quot;Re: &quot;;</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57">                 msgPopup.setAttribute('subject', msgSubject);</span>
<a href="#l9.58"></a><span id="l9.58"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

