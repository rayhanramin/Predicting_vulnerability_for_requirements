<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1017:f21bf34efae5c9f4f091a3b9406b81548c627d1d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f21bf34efae5c9f4f091a3b9406b81548c627d1d" />
<meta property="og:url" content="/comm-central/rev/f21bf34efae5c9f4f091a3b9406b81548c627d1d" />
<meta property="og:description" content="Bug 457203 - iTIP overhaul. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f21bf34efae5c9f4f091a3b9406b81548c627d1d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f21bf34efae5c9f4f091a3b9406b81548c627d1d">shortlog</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f21bf34efae5c9f4f091a3b9406b81548c627d1d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d">files</a> |
changeset |
<a href="/comm-central/raw-rev/f21bf34efae5c9f4f091a3b9406b81548c627d1d">raw</a>  | <a href="/comm-central/archive/f21bf34efae5c9f4f091a3b9406b81548c627d1d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=457203">Bug 457203</a> - iTIP overhaul. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#110;&#105;&#101;&#108;&#32;&#66;&#111;&#101;&#108;&#122;&#108;&#101;&#32;&#91;&#58;&#100;&#98;&#111;&#93;&#32;&#60;&#100;&#97;&#110;&#105;&#101;&#108;&#46;&#98;&#111;&#101;&#108;&#122;&#108;&#101;&#64;&#115;&#117;&#110;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 05 Nov 2008 12:08:51 +0100</td></tr>

<tr>
 <td>changeset 1017</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f21bf34efae5c9f4f091a3b9406b81548c627d1d">f21bf34efae5c9f4f091a3b9406b81548c627d1d</a></td>
</tr>



<tr>
<td>parent 1016</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e5a9765b2d790f91b453997e0db9f9c291935bee">e5a9765b2d790f91b453997e0db9f9c291935bee</a>
</td>
</tr>

<tr>
<td>child 1018</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1fd8c2b56030062b0000c14009bcb91c2d0a0933">1fd8c2b56030062b0000c14009bcb91c2d0a0933</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f21bf34efae5c9f4f091a3b9406b81548c627d1d">756</a></td></tr>
<tr><td>push user</td><td>daniel.boelzle@sun.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 05 Nov 2008 11:15:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f21bf34efae5 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f21bf34efae5c9f4f091a3b9406b81548c627d1d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f21bf34efae5c9f4f091a3b9406b81548c627d1d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f21bf34efae5c9f4f091a3b9406b81548c627d1d&newProject=comm-central&newRevision=f21bf34efae5c9f4f091a3b9406b81548c627d1d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f21bf34efae5c9f4f091a3b9406b81548c627d1d&newProject=comm-central&newRevision=f21bf34efae5c9f4f091a3b9406b81548c627d1d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f21bf34efae5c9f4f091a3b9406b81548c627d1d&newProject=comm-central&newRevision=f21bf34efae5c9f4f091a3b9406b81548c627d1d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=457203">457203</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=457203">Bug 457203</a> - iTIP overhaul. r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/Makefile.in">calendar/base/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/Makefile.in">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/Makefile.in">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-summary-dialog.js">calendar/base/content/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.js">calendar/base/content/dialogs/calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.xul">calendar/base/content/dialogs/calendar-event-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.xul">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.xul">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.xul">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.xul">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-event-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.js">calendar/base/content/dialogs/calendar-invitations-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.xul">calendar/base/content/dialogs/calendar-invitations-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.xul">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.xul">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.xul">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.xul">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/content/dialogs/calendar-invitations-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/Makefile.in">calendar/base/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/Makefile.in">calendar/base/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItemBase.idl">calendar/base/public/calIItemBase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItemBase.idl">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItemBase.idl">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItemBase.idl">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItemBase.idl">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItemBase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipItem.idl">calendar/base/public/calIItipItem.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipItem.idl">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipItem.idl">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipItem.idl">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipItem.idl">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipItem.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipProcessor.idl">calendar/base/public/calIItipProcessor.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipProcessor.idl">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipProcessor.idl">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/public/calIItipProcessor.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/Makefile.in">calendar/base/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calEvent.js">calendar/base/src/calEvent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calEvent.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calEvent.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calEvent.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calEvent.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calEvent.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsSerializer.js">calendar/base/src/calIcsSerializer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsSerializer.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsSerializer.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsSerializer.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsSerializer.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calIcsSerializer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemModule.js">calendar/base/src/calItemModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemModule.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemModule.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemModule.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemModule.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItemModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipItem.js">calendar/base/src/calItipItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipItem.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipItem.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipItem.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipItem.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipItem.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipProcessor.js">calendar/base/src/calItipProcessor.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipProcessor.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipProcessor.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calItipProcessor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.jsm">calendar/base/src/calUtils.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/base/src/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/removed-files.in">calendar/installer/removed-files.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/removed-files.in">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/removed-files.in">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/removed-files.in">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/removed-files.in">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/removed-files.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/windows/packages-static">calendar/installer/windows/packages-static</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/windows/packages-static">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/windows/packages-static">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/windows/packages-static">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/windows/packages-static">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/installer/windows/packages-static">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/parameters.csv">calendar/libical/design-data/parameters.csv</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/parameters.csv">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/parameters.csv">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/parameters.csv">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/parameters.csv">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/parameters.csv">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/params-in-prop.txt">calendar/libical/design-data/params-in-prop.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/params-in-prop.txt">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/params-in-prop.txt">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/params-in-prop.txt">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/params-in-prop.txt">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/libical/design-data/params-in-prop.txt">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/components/lightningTextCalendarConverter.js">calendar/lightning/components/lightningTextCalendarConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/components/lightningTextCalendarConverter.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/components/lightningTextCalendarConverter.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/components/lightningTextCalendarConverter.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/components/lightningTextCalendarConverter.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/components/lightningTextCalendarConverter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/imip-bar.js">calendar/lightning/content/imip-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/imip-bar.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/imip-bar.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/imip-bar.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/imip-bar.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/imip-bar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning-utils.js">calendar/lightning/content/lightning-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning-utils.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning-utils.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning-utils.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning-utils.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning.js">calendar/lightning/content/lightning.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/lightning/content/lightning.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/calendar/calendar.properties">calendar/locales/en-US/chrome/calendar/calendar.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/calendar/calendar.properties">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/calendar/calendar.properties">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/calendar/calendar.properties">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/calendar/calendar.properties">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/calendar/calendar.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/lightning/lightning.properties">calendar/locales/en-US/chrome/lightning/lightning.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/lightning/lightning.properties">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/lightning/lightning.properties">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/lightning/lightning.properties">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/lightning/lightning.properties">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/locales/en-US/chrome/lightning/lightning.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/base/calProviderBase.js">calendar/providers/base/calProviderBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/base/calProviderBase.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/base/calProviderBase.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/base/calProviderBase.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/base/calProviderBase.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/base/calProviderBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/sunbird/app/profile/sunbird.js">calendar/sunbird/app/profile/sunbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/sunbird/app/profile/sunbird.js">file</a> |
<a href="/comm-central/annotate/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/sunbird/app/profile/sunbird.js">annotate</a> |
<a href="/comm-central/diff/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/sunbird/app/profile/sunbird.js">diff</a> |
<a href="/comm-central/comparison/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/sunbird/app/profile/sunbird.js">comparison</a> |
<a href="/comm-central/log/f21bf34efae5c9f4f091a3b9406b81548c627d1d/calendar/sunbird/app/profile/sunbird.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -41,17 +41,17 @@ topsrcdir	= @top_srcdir@</span>
<a href="#l1.4"></a><span id="l1.4"> srcdir		= @srcdir@</span>
<a href="#l1.5"></a><span id="l1.5"> VPATH		= @srcdir@</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> MODULE = calbase</span>
<a href="#l1.10"></a><span id="l1.10"> MODULE_NAME = calBaseModule</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-DIRS = public src build</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+DIRS = public src modules build</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> # Select a theme from which to pull our skin goodness</span>
<a href="#l1.16"></a><span id="l1.16"> # OS X: pinstripe</span>
<a href="#l1.17"></a><span id="l1.17"> # Others: winstripe</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> ifneq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))</span>
<a href="#l1.20"></a><span id="l1.20"> THEME = pinstripe</span>
<a href="#l1.21"></a><span id="l1.21"> else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -31,16 +31,18 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.5"></a><span id="l2.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.6"></a><span id="l2.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.7"></a><span id="l2.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.8"></a><span id="l2.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.9"></a><span id="l2.9">  *</span>
<a href="#l2.10"></a><span id="l2.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calItipUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> var gInvitationsRequestManager = {</span>
<a href="#l2.15"></a><span id="l2.15">     mRequestStatusList: {},</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">     addRequestStatus: function IRM_addRequestStatus(calendar, op) {</span>
<a href="#l2.18"></a><span id="l2.18">         if (op) {</span>
<a href="#l2.19"></a><span id="l2.19">             this.mRequestStatusList[calendar.id] = op;</span>
<a href="#l2.20"></a><span id="l2.20">         }</span>
<a href="#l2.21"></a><span id="l2.21">     },</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -241,17 +243,17 @@ InvitationsManager.prototype = {</span>
<a href="#l2.23"></a><span id="l2.23">         operationListener.prototype = {</span>
<a href="#l2.24"></a><span id="l2.24">             onOperationComplete: function (aCalendar,</span>
<a href="#l2.25"></a><span id="l2.25">                                            aStatus,</span>
<a href="#l2.26"></a><span id="l2.26">                                            aOperationType,</span>
<a href="#l2.27"></a><span id="l2.27">                                            aId,</span>
<a href="#l2.28"></a><span id="l2.28">                                            aDetail) {</span>
<a href="#l2.29"></a><span id="l2.29">                 if (Components.isSuccessCode(aStatus) &amp;&amp;</span>
<a href="#l2.30"></a><span id="l2.30">                     aOperationType == Components.interfaces.calIOperationListener.MODIFY) {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-                    checkAndSendItipMessage(aDetail, aOperationType, this.mOldItem);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+                    cal.itip.checkAndSend(aOperationType, aDetail, this.mOldItem);</span>
<a href="#l2.33"></a><span id="l2.33">                     this.mInvitationsManager.deleteItem(aDetail);</span>
<a href="#l2.34"></a><span id="l2.34">                     this.mInvitationsManager.addItem(aDetail);</span>
<a href="#l2.35"></a><span id="l2.35">                 }</span>
<a href="#l2.36"></a><span id="l2.36">                 this.mInvitationsManager.mJobsPending--;</span>
<a href="#l2.37"></a><span id="l2.37">                 if (this.mInvitationsManager.mJobsPending == 0 &amp;&amp;</span>
<a href="#l2.38"></a><span id="l2.38">                     this.mJobQueueFinishedCallBack) {</span>
<a href="#l2.39"></a><span id="l2.39">                     this.mJobQueueFinishedCallBack();</span>
<a href="#l2.40"></a><span id="l2.40">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -32,45 +32,16 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.5"></a><span id="l3.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.6"></a><span id="l3.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.7"></a><span id="l3.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.8"></a><span id="l3.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.9"></a><span id="l3.9">  *</span>
<a href="#l3.10"></a><span id="l3.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-function opCompleteListener(aOriginalItem, aOuterListener) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    this.mOriginalItem = aOriginalItem;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    this.mOuterListener = aOuterListener;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-}</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-opCompleteListener.prototype = {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    mOriginalItem: null,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    mOuterListener: null,</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    onOperationComplete: function oCL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aItem) {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-        if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-            // we may optionally shift the whole check and send mail messages to</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-            // calProviderBase.notifyOperationComplete (with adding an oldItem parameter).</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-            // I am not yet sure what to do for mixed mode invitations, e.g.</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-            // some users on the attendee list are caldav users and get REQUESTs into their inbox,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-            // other get emailed... For now let's do both.</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-            checkAndSendItipMessage(aItem, aOpType, this.mOriginalItem);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-        }</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-        if (this.mOuterListener) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-            this.mOuterListener.onOperationComplete.apply(this.mOuterListener,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-                                                          arguments);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-        }</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    },</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-    onGetItem: function oCL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-    }</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-};</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-</span>
<a href="#l3.41"></a><span id="l3.41"> /* all params are optional */</span>
<a href="#l3.42"></a><span id="l3.42"> function createEventWithDialog(calendar, startDate, endDate, summary, event, aForceAllday) {</span>
<a href="#l3.43"></a><span id="l3.43">     const kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">     var onNewEvent = function(item, calendar, originalItem, listener) {</span>
<a href="#l3.46"></a><span id="l3.46">         if (item.id) {</span>
<a href="#l3.47"></a><span id="l3.47">             // If the item already has an id, then this is the result of</span>
<a href="#l3.48"></a><span id="l3.48">             // saving the item without closing, and then saving again.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineat">@@ -371,79 +342,28 @@ function promptOccurrenceModification(aI</span>
<a href="#l3.50"></a><span id="l3.50">             // Since we have not set past or futureItem, the return below will</span>
<a href="#l3.51"></a><span id="l3.51">             // take care.</span>
<a href="#l3.52"></a><span id="l3.52">             break;</span>
<a href="#l3.53"></a><span id="l3.53">     }</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">     return [pastItem, futureItem, type];</span>
<a href="#l3.56"></a><span id="l3.56"> }</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-/**</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">- * Read default alarm settings from user preferences and apply them to</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">- * the event/todo passed in.</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">- *</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">- * @param aItem   The event or todo the settings should be applied to.</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">- */</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-function setDefaultAlarmValues(aItem)</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-{</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-    var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-                                .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    var alarmsBranch = prefService.getBranch(&quot;calendar.alarms.&quot;);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    if (isEvent(aItem)) {</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-        try {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-            if (alarmsBranch.getIntPref(&quot;onforevents&quot;) == 1) {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-                var alarmOffset = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-                var units = alarmsBranch.getCharPref(&quot;eventalarmunit&quot;);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-                alarmOffset[units] = alarmsBranch.getIntPref(&quot;eventalarmlen&quot;);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-                alarmOffset.isNegative = true;</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-                aItem.alarmOffset = alarmOffset;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-                aItem.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-            }</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-        } catch (ex) {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-            Components.utils.reportError(</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-                &quot;Failed to apply default alarm settings to event: &quot; + ex);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-        }</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    } else if (isToDo(aItem)) {</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-        try {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-            if (alarmsBranch.getIntPref(&quot;onfortodos&quot;) == 1) {</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-                // You can't have an alarm if the entryDate doesn't exist.</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-                if (!aItem.entryDate) {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-                    aItem.entryDate = getSelectedDay() &amp;&amp;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-                                      getSelectedDay().clone() || now();</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-                }</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-                var alarmOffset = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-                var units = alarmsBranch.getCharPref(&quot;todoalarmunit&quot;);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-                alarmOffset[units] = alarmsBranch.getIntPref(&quot;todoalarmlen&quot;);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-                alarmOffset.isNegative = true;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-                aItem.alarmOffset = alarmOffset;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-                aItem.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-            }</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-        } catch (ex) {</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-            Components.utils.reportError(</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-                &quot;Failed to apply default alarm settings to task: &quot; + ex);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-        }</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-    }</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-}</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-</span>
<a href="#l3.108"></a><span id="l3.108"> // Undo/Redo code</span>
<a href="#l3.109"></a><span id="l3.109"> function getTransactionMgr() {</span>
<a href="#l3.110"></a><span id="l3.110">     return Components.classes[&quot;@mozilla.org/calendar/transactionmanager;1&quot;]</span>
<a href="#l3.111"></a><span id="l3.111">                      .getService(Components.interfaces.calITransactionManager);</span>
<a href="#l3.112"></a><span id="l3.112"> }</span>
<a href="#l3.113"></a><span id="l3.113"> </span>
<a href="#l3.114"></a><span id="l3.114"> function doTransaction(aAction, aItem, aCalendar, aOldItem, aListener) {</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    var innerListener = new opCompleteListener(aOldItem, aListener);</span>
<a href="#l3.116"></a><span id="l3.116">     getTransactionMgr().createAndCommitTxn(aAction,</span>
<a href="#l3.117"></a><span id="l3.117">                                            aItem,</span>
<a href="#l3.118"></a><span id="l3.118">                                            aCalendar,</span>
<a href="#l3.119"></a><span id="l3.119">                                            aOldItem,</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-                                           innerListener);</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+                                           aListener ? aListener : null);</span>
<a href="#l3.122"></a><span id="l3.122">     updateUndoRedoMenu();</span>
<a href="#l3.123"></a><span id="l3.123"> }</span>
<a href="#l3.124"></a><span id="l3.124"> </span>
<a href="#l3.125"></a><span id="l3.125"> function undo() {</span>
<a href="#l3.126"></a><span id="l3.126">     if (canUndo()) {</span>
<a href="#l3.127"></a><span id="l3.127">         getTransactionMgr().undo();</span>
<a href="#l3.128"></a><span id="l3.128">         updateUndoRedoMenu();</span>
<a href="#l3.129"></a><span id="l3.129">     }</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineat">@@ -473,176 +393,8 @@ function canRedo() {</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132"> /**</span>
<a href="#l3.133"></a><span id="l3.133">  * Update the undo and redo menu items</span>
<a href="#l3.134"></a><span id="l3.134">  */</span>
<a href="#l3.135"></a><span id="l3.135"> function updateUndoRedoMenu() {</span>
<a href="#l3.136"></a><span id="l3.136">     goUpdateCommand(&quot;cmd_undo&quot;);</span>
<a href="#l3.137"></a><span id="l3.137">     goUpdateCommand(&quot;cmd_redo&quot;);</span>
<a href="#l3.138"></a><span id="l3.138"> }</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-/**</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">- * Checks to see if the attendees were added or changed between the original</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">- * and new item.  If there is a change, it launches the calIItipTransport</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">- * service and sends the invitations</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">- */</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-function checkAndSendItipMessage(aItem, aOpType, aOriginalItem) {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-    var transport = aItem.calendar.getProperty(&quot;itip.transport&quot;);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-    if (!transport) { // Only send if there's a transport for the calendar</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-        return;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    }</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-    transport = transport.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-    var invitedAttendee = ((calInstanceOf(aItem.calendar, Components.interfaces.calISchedulingSupport) &amp;&amp;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-                            aItem.calendar.isInvitation(aItem))</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-                           ? aItem.calendar.getInvitedAttendee(aItem) : null);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-    if (invitedAttendee) { // actually is an invitation copy, fix attendee list to send REPLY</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-        if (aItem.calendar.canNotify(&quot;REPLY&quot;, aItem)) {</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-            return; // provider does that</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-        }</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-        var origInvitedAttendee = (aOriginalItem &amp;&amp; aOriginalItem.getAttendeeById(invitedAttendee.id));</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-        if (aOpType == Components.interfaces.calIOperationListener.DELETE) {</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-            // in case the attendee has just deleted the item, we want to send out a DECLINED REPLY:</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-            origInvitedAttendee = invitedAttendee;</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-            invitedAttendee = invitedAttendee.clone();</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-            invitedAttendee.participationStatus = &quot;DECLINED&quot;;</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-        }</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-        // has this been a PARTSTAT change?</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-        if (aItem.organizer &amp;&amp;</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-            (!origInvitedAttendee ||</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-             (origInvitedAttendee.participationStatus != invitedAttendee.participationStatus))) {</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-            aItem = aItem.clone();</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-            aItem.removeAllAttendees();</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-            aItem.addAttendee(invitedAttendee);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-            var itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-                                     .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-            itipItem.init(calGetSerializedItem(aItem));</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-            itipItem.targetCalendar = aItem.calendar;</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-            itipItem.autoResponse = Components.interfaces.calIItipItem.USER;</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-            itipItem.responseMethod = &quot;REPLY&quot;;</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-            transport.sendItems(1, [aItem.organizer], itipItem);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-        }</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-        return;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-    }</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    if (aItem.getProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;) != &quot;TRUE&quot;) { // Only send invitations/cancellations</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-                                                                 // if the user checked the checkbox</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-        return;</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-    }</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-    if (aOpType == Components.interfaces.calIOperationListener.DELETE) {</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-        calSendItipMessage(transport, aItem, &quot;CANCEL&quot;, aItem.getAttendees({}));</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-        return;</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    } // else ADD, MODIFY:</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-    var originalAtt = (aOriginalItem ? aOriginalItem.getAttendees({}) : []);</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-    var itemAtt = aItem.getAttendees({});</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-    var canceledAttendees = [];</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-    if (itemAtt.length &gt; 0 || originalAtt.length &gt; 0) {</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-        var attMap = {};</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-        for each (var att in originalAtt) {</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-            attMap[att.id.toLowerCase()] = att;</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-        }</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-        for each (var att in itemAtt) {</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-            if (att.id.toLowerCase() in attMap) {</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-                // Attendee was in original item.</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-                delete attMap[att.id.toLowerCase()];</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-            }</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-        }</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-        for each (var cancAtt in attMap) {</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-            canceledAttendees.push(cancAtt);</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-        }</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    }</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-    var autoResponse = false; // confirm to send email</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-    // Check to see if some part of the item was updated, if so, re-send invites</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-    if (!aOriginalItem || aItem.generation != aOriginalItem.generation) { // REQUEST</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-        var requestItem = aItem.clone();</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-        if (!requestItem.organizer) {</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-            var organizer = Components.classes[&quot;@mozilla.org/calendar/attendee;1&quot;]</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-                                      .createInstance(Components.interfaces.calIAttendee);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-            organizer.id = requestItem.calendar.getProperty(&quot;organizerId&quot;);</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-            organizer.commonName = requestItem.calendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-            organizer.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-            organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-            organizer.isOrganizer = true;</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-            requestItem.organizer = organizer;</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-        }</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-        // Fix up our attendees for invitations using some good defaults</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-        var recipients = [];</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-        var itemAtt = requestItem.getAttendees({});</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-        requestItem.removeAllAttendees();</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-        for each (var attendee in itemAtt) {</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-            attendee = attendee.clone();</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-            attendee.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-            attendee.participationStatus = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-            attendee.rsvp = &quot;TRUE&quot;;</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-            requestItem.addAttendee(attendee);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-            recipients.push(attendee);</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-        }</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-        if (recipients.length &gt; 0) {</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-            calSendItipMessage(transport, requestItem, &quot;REQUEST&quot;, recipients, autoResponse);</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-            autoResponse = true; // don't ask again</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-        }</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-    }</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-    // Cancel the event for all canceled attendees</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-    if (canceledAttendees.length &gt; 0) {</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-        var cancelItem = aOriginalItem.clone();</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-        cancelItem.removeAllAttendees();</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-        for each (var att in canceledAttendees) {</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-            cancelItem.addAttendee(att);</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-        }</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-        calSendItipMessage(transport, cancelItem, &quot;CANCEL&quot;, canceledAttendees, autoResponse);</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-    }</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-}</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-function calSendItipMessage(aTransport, aItem, aMethod, aRecipientsList, autoResponse) {</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-    if (aRecipientsList.length == 0) {</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-        return;</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-    }</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    if (calInstanceOf(aItem.calendar, Components.interfaces.calISchedulingSupport) &amp;&amp;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-        aItem.calendar.canNotify(aMethod, aItem)) {</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-        return; // provider will handle that</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-    }</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-    var itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-                             .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-    // We have to modify our item a little, so we clone it.</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-    var item = aItem.clone();</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-    // We fake Sequence ID support.</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-    item.setProperty(&quot;SEQUENCE&quot;, item.generation);</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-    // Initialize and set our properties on the item</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-    itipItem.init(calGetSerializedItem(item));</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-    itipItem.responseMethod = aMethod;</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-    itipItem.targetCalendar = item.calendar;</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-    itipItem.autoResponse = (autoResponse</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-                             ? Components.interfaces.calIItipItem.AUTO</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-                             : Components.interfaces.calIItipItem.USER);</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-    // XXX I don't know whether the below are used at all, since we don't use the itip processor</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-    itipItem.isSend = true;</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-    // Send it!</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-    aTransport.sendItems(aRecipientsList.length, aRecipientsList, itipItem);</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-}</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-function calGetSerializedItem(aItem) {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-    var serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-                               .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-    serializer.addItems([aItem], 1);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-    return serializer.serializeToString();</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-}</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-summary-dialog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-summary-dialog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -31,16 +31,19 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.5"></a><span id="l4.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.6"></a><span id="l4.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.7"></a><span id="l4.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.8"></a><span id="l4.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.9"></a><span id="l4.9">  *</span>
<a href="#l4.10"></a><span id="l4.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calItipUtils.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15"> function onLoad() {</span>
<a href="#l4.16"></a><span id="l4.16">     var args = window.arguments[0];</span>
<a href="#l4.17"></a><span id="l4.17">     var item = args.calendarEvent;</span>
<a href="#l4.18"></a><span id="l4.18">     item = item.clone(); // use an own copy of the passed item</span>
<a href="#l4.19"></a><span id="l4.19">     var calendar = item.calendar;</span>
<a href="#l4.20"></a><span id="l4.20">     window.item = item;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">     // the calling entity provides us with an object that is responsible</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -69,18 +72,18 @@ function onLoad() {</span>
<a href="#l4.24"></a><span id="l4.24">         }</span>
<a href="#l4.25"></a><span id="l4.25">     }</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">     window.readOnly = calendar.readOnly;</span>
<a href="#l4.28"></a><span id="l4.28">     if (!window.readOnly &amp;&amp; calInstanceOf(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l4.29"></a><span id="l4.29">         var attendee = calendar.getInvitedAttendee(item);</span>
<a href="#l4.30"></a><span id="l4.30">         if (attendee) {</span>
<a href="#l4.31"></a><span id="l4.31">             // if this is an unresponded invitation, preset our default alarm values:</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-            if (attendee.participationStatus == &quot;NEEDS-ACTION&quot;) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-                setDefaultAlarmValues(item);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+            if (!item.alarmOffset &amp;&amp; (attendee.participationStatus == &quot;NEEDS-ACTION&quot;)) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+                cal.setDefaultAlarmValues(item);</span>
<a href="#l4.36"></a><span id="l4.36">             }</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">             window.attendee = attendee.clone();</span>
<a href="#l4.39"></a><span id="l4.39">             // Since we don't have API to update an attendee in place, remove</span>
<a href="#l4.40"></a><span id="l4.40">             // and add again. Also, this is needed if the attendee doesn't exist</span>
<a href="#l4.41"></a><span id="l4.41">             // (i.e REPLY on a mailing list)</span>
<a href="#l4.42"></a><span id="l4.42">             item.removeAttendee(attendee);</span>
<a href="#l4.43"></a><span id="l4.43">             item.addAttendee(window.attendee);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -346,26 +346,26 @@ function loadDialog(item) {</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">     updateDateTime();</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     updateCalendar();</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">     // figure out what the title of the dialog should be and set it</span>
<a href="#l5.10"></a><span id="l5.10">     updateTitle();</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    var sendInvitesCheckbox = document.getElementById(&quot;send-invitations-checkbox&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    let notifyCheckbox = document.getElementById(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l5.14"></a><span id="l5.14">     if (canNotifyAttendees(item.calendar, item)) {</span>
<a href="#l5.15"></a><span id="l5.15">         // visualize that the server will send out mail:</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-        sendInvitesCheckbox.checked = true;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+        notifyCheckbox.checked = true;</span>
<a href="#l5.18"></a><span id="l5.18">     } else {</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-        var itemProp = item.getProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-        sendInvitesCheckbox.checked = (item.calendar.getProperty(&quot;imip.identity&quot;) &amp;&amp;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-                                       ((itemProp === null)</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-                                        ? getPrefSafe(&quot;calendar.itip.notify&quot;, true)</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-                                        : (itemProp == &quot;TRUE&quot;)));</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+        let itemProp = item.getProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+        notifyCheckbox.checked = (item.calendar.getProperty(&quot;imip.identity&quot;) &amp;&amp;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+                                  ((itemProp === null)</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+                                   ? getPrefSafe(&quot;calendar.itip.notify&quot;, true)</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+                                   : (itemProp == &quot;TRUE&quot;)));</span>
<a href="#l5.29"></a><span id="l5.29">     }</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">     updateAttendees();</span>
<a href="#l5.32"></a><span id="l5.32">     updateRepeat();</span>
<a href="#l5.33"></a><span id="l5.33">     updateReminder();</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">     gShowTimeAs = item.getProperty(&quot;TRANSP&quot;);</span>
<a href="#l5.36"></a><span id="l5.36">     updateShowTimeAs();</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineat">@@ -1534,19 +1534,19 @@ function attachmentLinkClicked(event) {</span>
<a href="#l5.38"></a><span id="l5.38"> function updateCalendar() {</span>
<a href="#l5.39"></a><span id="l5.39">     var item = window.calendarItem;</span>
<a href="#l5.40"></a><span id="l5.40">     var calendar = document.getElementById(&quot;item-calendar&quot;)</span>
<a href="#l5.41"></a><span id="l5.41">                            .selectedItem.calendar;</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">     gIsReadOnly = calendar.readOnly;</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">     if (!canNotifyAttendees(calendar, item) &amp;&amp; calendar.getProperty(&quot;imip.identity&quot;)) {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-        enableElement(&quot;send-invitations-checkbox&quot;);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+        enableElement(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l5.48"></a><span id="l5.48">     } else {</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-        disableElement(&quot;send-invitations-checkbox&quot;);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+        disableElement(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l5.51"></a><span id="l5.51">     }</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53">     // update the accept button</span>
<a href="#l5.54"></a><span id="l5.54">     updateAccept();</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56">     // TODO: the code above decided about whether or not the item is readonly.</span>
<a href="#l5.57"></a><span id="l5.57">     // below we enable/disable all controls based on this decision.</span>
<a href="#l5.58"></a><span id="l5.58">     // unfortunately some controls need to be disabled based on some other</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineat">@@ -1884,21 +1884,21 @@ function saveItem() {</span>
<a href="#l5.60"></a><span id="l5.60">     }</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">     item.removeAllAttendees();</span>
<a href="#l5.63"></a><span id="l5.63">     if (window.attendees) {</span>
<a href="#l5.64"></a><span id="l5.64">         for each (var attendee in window.attendees) {</span>
<a href="#l5.65"></a><span id="l5.65">            item.addAttendee(attendee);</span>
<a href="#l5.66"></a><span id="l5.66">         }</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-        var sendInvitesCheckbox = document.getElementById(&quot;send-invitations-checkbox&quot;);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-        if (sendInvitesCheckbox.disabled || document.getElementById(&quot;event-grid-attendee-row-2&quot;).collapsed) {</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+        let notifyCheckbox = document.getElementById(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+        if (notifyCheckbox.disabled || document.getElementById(&quot;event-grid-attendee-row-2&quot;).collapsed) {</span>
<a href="#l5.72"></a><span id="l5.72">             item.deleteProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;);</span>
<a href="#l5.73"></a><span id="l5.73">         } else {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-            item.setProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;, sendInvitesCheckbox.checked ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+            item.setProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;, notifyCheckbox.checked ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l5.76"></a><span id="l5.76">         }</span>
<a href="#l5.77"></a><span id="l5.77">     }</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">     return item;</span>
<a href="#l5.80"></a><span id="l5.80"> }</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82"> function onCommandSave(aIsClosing) {</span>
<a href="#l5.83"></a><span id="l5.83">     var originalItem = window.calendarItem;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.xul</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.xul</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -696,17 +696,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">                      disable-on-readonly=&quot;true&quot;/&gt;</span>
<a href="#l6.5"></a><span id="l6.5">               &lt;label id=&quot;attendee-list&quot;</span>
<a href="#l6.6"></a><span id="l6.6">                      class=&quot;text-link&quot;</span>
<a href="#l6.7"></a><span id="l6.7">                      crop=&quot;right&quot;</span>
<a href="#l6.8"></a><span id="l6.8">                      onclick=&quot;showAttendeePopup(event)&quot;/&gt;</span>
<a href="#l6.9"></a><span id="l6.9">             &lt;/row&gt;</span>
<a href="#l6.10"></a><span id="l6.10">             &lt;row id=&quot;event-grid-attendee-row-2&quot; align=&quot;center&quot;&gt;</span>
<a href="#l6.11"></a><span id="l6.11">               &lt;spacer/&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-              &lt;checkbox id=&quot;send-invitations-checkbox&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+              &lt;checkbox id=&quot;notify-attendees-checkbox&quot;</span>
<a href="#l6.14"></a><span id="l6.14">                         class=&quot;lightning-only&quot;</span>
<a href="#l6.15"></a><span id="l6.15">                         label=&quot;&amp;newevent.attendees.notify.label;&quot;</span>
<a href="#l6.16"></a><span id="l6.16">                         pack=&quot;start&quot;/&gt;</span>
<a href="#l6.17"></a><span id="l6.17">             &lt;/row&gt;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">             &lt;separator class=&quot;groove&quot; id=&quot;event-grid-basic-separator&quot;/&gt;</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">             &lt;!-- All-Day --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -30,16 +30,18 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.5"></a><span id="l7.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.6"></a><span id="l7.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.7"></a><span id="l7.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.8"></a><span id="l7.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.9"></a><span id="l7.9">  *</span>
<a href="#l7.10"></a><span id="l7.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14"> function onLoad() {</span>
<a href="#l7.15"></a><span id="l7.15">     var operationListener = {</span>
<a href="#l7.16"></a><span id="l7.16">         onOperationComplete: function oL_onOperationComplete(aCalendar,</span>
<a href="#l7.17"></a><span id="l7.17">                                                              aStatus,</span>
<a href="#l7.18"></a><span id="l7.18">                                                              aOperationType,</span>
<a href="#l7.19"></a><span id="l7.19">                                                              aId,</span>
<a href="#l7.20"></a><span id="l7.20">                                                              aDetail) {</span>
<a href="#l7.21"></a><span id="l7.21">             var updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -109,18 +111,18 @@ function fillJobQueue(queue) {</span>
<a href="#l7.23"></a><span id="l7.23">         var newStatus = richListItem.participationStatus;</span>
<a href="#l7.24"></a><span id="l7.24">         var oldStatus = richListItem.initialParticipationStatus;</span>
<a href="#l7.25"></a><span id="l7.25">         if (newStatus != oldStatus) {</span>
<a href="#l7.26"></a><span id="l7.26">             var actionString = &quot;modify&quot;;</span>
<a href="#l7.27"></a><span id="l7.27">             var oldCalendarItem = richListItem.calendarItem;</span>
<a href="#l7.28"></a><span id="l7.28">             var newCalendarItem = oldCalendarItem.clone();</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">             // set default alarm on unresponded items that have not been declined:</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-            if (oldStatus == &quot;NEEDS-ACTION&quot; &amp;&amp; newStatus != &quot;DECLINED&quot;) {</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-                setDefaultAlarmValues(newCalendarItem);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+            if (!newCalendarItem.alarmOffset &amp;&amp; (oldStatus == &quot;NEEDS-ACTION&quot;) &amp;&amp; (newStatus != &quot;DECLINED&quot;)) {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+                cal.setDefaultAlarmValues(newCalendarItem);</span>
<a href="#l7.35"></a><span id="l7.35">             }</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37">             richListItem.setCalendarItemParticipationStatus(newCalendarItem,</span>
<a href="#l7.38"></a><span id="l7.38">                 newStatus);</span>
<a href="#l7.39"></a><span id="l7.39">             var job = {</span>
<a href="#l7.40"></a><span id="l7.40">                 action: actionString,</span>
<a href="#l7.41"></a><span id="l7.41">                 oldItem: oldCalendarItem,</span>
<a href="#l7.42"></a><span id="l7.42">                 newItem: newCalendarItem</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-dialog.xul</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-dialog.xul</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -51,19 +51,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">   ondialogcancel=&quot;return onCancel();&quot;</span>
<a href="#l8.5"></a><span id="l8.5">   onload=&quot;return onLoad();&quot;</span>
<a href="#l8.6"></a><span id="l8.6">   onunload=&quot;return onUnload();&quot;</span>
<a href="#l8.7"></a><span id="l8.7">   persist=&quot;screenX screenY width height&quot;</span>
<a href="#l8.8"></a><span id="l8.8">   xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l8.11"></a><span id="l8.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-invitations-dialog.js&quot;/&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l8.13"></a><span id="l8.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-item-editing.js&quot;/&gt;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   &lt;script type=&quot;application/javascript&quot; &gt;</span>
<a href="#l8.17"></a><span id="l8.17">     var invitationsText = &quot;&amp;calendar.invitations.dialog.invitations.text;&quot;;</span>
<a href="#l8.18"></a><span id="l8.18">   &lt;/script&gt;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   &lt;vbox id=&quot;dialog-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l8.21"></a><span id="l8.21">     &lt;stack flex=&quot;1&quot;&gt;</span>
<a href="#l8.22"></a><span id="l8.22">       &lt;calendar-invitations-richlistbox id=&quot;invitations-listbox&quot; flex=&quot;1&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/calendar/base/modules/Makefile.in</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,52 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+#</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+# License.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+#</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+# The Original Code is Sun Microsystems code.</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+#</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+# Sun Microsystems, Inc.</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+#</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+#   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+#</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+#</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+DEPTH     = ../../..</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+topsrcdir = @top_srcdir@</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+srcdir    = @srcdir@</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+VPATH     = @srcdir@</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+MODULE = calbase</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+EXTRA_JS_MODULES = \</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    calUtils.jsm \</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+    calItipUtils.jsm \</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+    $(NULL)</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,781 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ *</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * License.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ *</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+ * The Original Code is Sun Microsystems code.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ *</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+ *   Sun Microsystems, Inc.</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+ *</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+ *   Clint Talbert &lt;ctalbert.moz@gmail.com&gt;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+ *   Matthew Willis &lt;lilmatt@mozilla.com&gt;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ *</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+ *</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/debug.js&quot;);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+/*</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+ * Scheduling and iTIP helper code;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+ * don't use deliberately, because it'll be moved into interfaces/components.</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+ *</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+ * May replace the current calItipProcessor.js code soon.</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+ */</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+cal.itip = {</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+    /**</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+     * Gets the sequence/revision number, either of the passed item or</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+     * the last received one of an attendee; see</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+     * &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.1&gt;.</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+     */</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+     getSequence: function cal_itip_getSequence(item) {</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+        let seq = null;</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+        if (item instanceof Components.interfaces.calIAttendee) {</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+            seq = item.getProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+        } else if (item) {</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+            // Unless the below is standardized, we store the last original</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+            // REQUEST/PUBLISH SEQUENCE in X-MOZ-RECEIVED-SEQUENCE to test against it</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+            // when updates come in:</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+            seq = item.getProperty(&quot;X-MOZ-RECEIVED-SEQUENCE&quot;);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+            if (seq === null) {</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+                seq = item.getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+            }</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+            // Make sure we don't have a pre Outlook 2007 appointment, but if we do</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+            // use Microsoft's Sequence number. I &lt;3 MS</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+            if ((seq === null) || (seq == &quot;0&quot;)) {</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+                seq = item.getProperty(&quot;X-MICROSOFT-CDO-APPT-SEQUENCE&quot;);</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+            }</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+        }</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+        if (seq === null) {</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+            return 0;</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+        } else {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+            seq = parseInt(seq, 10);</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+            return (isNaN(seq) ? 0 : seq);</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+        }</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+    },</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    /**</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+     * Gets the stamp date-time, either of the passed item or</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+     * the last received one of an attendee; see</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+     * &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.2&gt;.</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+     */</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+    getStamp: function cal_itip_getStamp(item) {</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+        let dtstamp = null;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+        if (item instanceof Components.interfaces.calIAttendee) {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+            let st = item.getProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+            if (st) {</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+                dtstamp = cal.createDateTime(st);</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+            }</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+        } else if (item) {</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+            // Unless the below is standardized, we store the last original</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+            // REQUEST/PUBLISH DTSTAMP in X-MOZ-RECEIVED-DTSTAMP to test against it</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+            // when updates come in:</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+            let st = item.getProperty(&quot;X-MOZ-RECEIVED-DTSTAMP&quot;);</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+            if (st) {</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+                dtstamp = cal.createDateTime(st);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+            } else {</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+                // xxx todo: are there similar X-MICROSOFT-CDO properties to be considered here?</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+                dtstamp = item.stampTime;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+            }</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+        }</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+        return dtstamp;</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+    },</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+    /**</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+     * Compares sequences and/or stamps of two parties; returns -1, 0, +1.</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+     */</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+    compare: function cal_itip_compare(item1, item2) {</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+        let seq1 = cal.itip.getSequence(item1);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+        let seq2 = cal.itip.getSequence(item2);</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+        if (seq1 &gt; seq2) {</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+            return 1;</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+        } else if (seq1 &lt; seq2) {</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+            return -1;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+        } else {</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+            let st1 = cal.itip.getStamp(item1);</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+            let st2 = cal.itip.getStamp(item2);</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+            if (st1 &amp;&amp; st2) {</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+                return st1.compare(st2);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+            } else if (!st1 &amp;&amp; st2) {</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+                return -1;</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+            } else if (st1 &amp;&amp; !st2) {</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+                return 1;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+            } else {</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+                return 0;</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+            }</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+        }</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    },</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+    /**</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+     * Scope: iTIP message receiver</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+     *</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+     * Checks the passed iTIP item and calls the passed function with options offered.</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+     *</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+     * @param itipItem iTIP item</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+     * @param optionsFunc function being called with parameters: itipItem, resultCode, actionFunc</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+     *                    The action func has a property |method| showing the options:</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+     *                    * REFRESH -- send the latest item (sent by attendee(s))</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+     *                    * PUBLISH -- initial publish, no reply (sent by organizer)</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+     *                    * PUBLISH:UPDATE -- update of a published item (sent by organizer)</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+     *                    * REQUEST -- initial invitation (sent by organizer)</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+     *                    * REQUEST:UPDATE -- rescheduling invitation, has major change (sent by organizer)</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+     *                    * REQUEST:UPDATE-MINOR -- update of invitation, minor change (sent by organizer)</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+     *                    * REPLY -- invitation reply (sent by attendee(s))</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+     *                    * CANCEL -- invitation cancel (sent by organizer)</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+     */</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+    processItipItem: function cal_itip_processItipItem(itipItem, optionsFunc) {</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+        switch (itipItem.receivedMethod.toUpperCase()) {</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+            case &quot;REFRESH&quot;:</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+            case &quot;PUBLISH&quot;:</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+            case &quot;REQUEST&quot;:</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+            case &quot;CANCEL&quot;:</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+            case &quot;REPLY&quot;: {</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+                // Per iTIP spec (new Draft 4), multiple items in an iTIP message MUST have</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+                // same ID, this simplifies our searching, we can just look for Item[0].id</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+                let itemList = itipItem.getItemList({});</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+                if (itemList.length &gt; 0) {</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+                    itipItem.targetCalendar.getItem(itemList[0].id,</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+                                                    new ItipFindItemListener(itipItem, optionsFunc));</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+                } else if (optionsFunc) {</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+                    optionsFunc(itipItem, Components.results.NS_OK);</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+                }</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+                break;</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+            }</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+            default: {</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+                if (optionsFunc) {</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+                    optionsFunc(itipItem, Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+                }</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+                break;</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+            }</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+        }</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+    },</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+    /**</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+     * Scope: iTIP message sender</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+     *</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+     * Checks to see if e.g. attendees were added/removed or an item has been</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+     * deleted and sends out appropriate iTIP messages.</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+     */</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+    checkAndSend: function cal_itip_checkAndSend(aOpType, aItem, aOriginalItem) {</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+        if (aOriginalItem &amp;&amp; aOriginalItem.recurrenceId &amp;&amp; !aItem.recurrenceId &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+            // sanity check: assure aItem doesn't refer to the master</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+            aItem = aItem.recurrenceInfo.getOccurrenceFor(aOriginalItem.recurrenceId);</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+            cal.ASSERT(aItem, &quot;unexpected!&quot;);</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+            if (!aItem) {</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+                return;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+            }</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+        }</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+        let autoResponse = { value: false }; // controls confirm to send email only once</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+        let invitedAttendee = ((cal.calInstanceOf(aItem.calendar, Components.interfaces.calISchedulingSupport) &amp;&amp;</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+                                aItem.calendar.isInvitation(aItem))</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+                               ? aItem.calendar.getInvitedAttendee(aItem) : null);</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+        if (invitedAttendee) { // actually is an invitation copy, fix attendee list to send REPLY</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+            if (aItem.organizer) {</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+                let origInvitedAttendee = (aOriginalItem &amp;&amp; aOriginalItem.getAttendeeById(invitedAttendee.id));</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+                if (aOpType == Components.interfaces.calIOperationListener.DELETE) {</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+                    // in case the attendee has just deleted the item, we want to send out a DECLINED REPLY:</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+                    origInvitedAttendee = invitedAttendee;</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+                    invitedAttendee = invitedAttendee.clone();</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+                    invitedAttendee.participationStatus = &quot;DECLINED&quot;;</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+                }</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+                // We want to send a REPLY send if:</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+                // - there has been a PARTSTAT change</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+                // - in case of an organizer SEQUENCE bump we'd go and reconfirm our PARTSTAT</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+                if (!origInvitedAttendee ||</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+                    (origInvitedAttendee.participationStatus != invitedAttendee.participationStatus) ||</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+                    (aOriginalItem &amp;&amp; (cal.itip.getSequence(aItem) != cal.itip.getSequence(aOriginalItem)))) {</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+                    aItem = aItem.clone();</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+                    aItem.removeAllAttendees();</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+                    aItem.addAttendee(invitedAttendee);</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+                    sendMessage(aItem, &quot;REPLY&quot;, [aItem.organizer], autoResponse);</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+                }</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+            }</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+            return;</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+        }</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+        if (aItem.getProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;) != &quot;TRUE&quot;) { // Only send invitations/cancellations</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+                                                                     // if the user checked the checkbox</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+            return;</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+        }</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+        if (aOpType == Components.interfaces.calIOperationListener.DELETE) {</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+            sendMessage(aItem, &quot;CANCEL&quot;, aItem.getAttendees({}), autoResponse);</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+            return;</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+        } // else ADD, MODIFY:</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+        let originalAtt = (aOriginalItem ? aOriginalItem.getAttendees({}) : []);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+        let itemAtt = aItem.getAttendees({});</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+        let canceledAttendees = [];</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+        if (itemAtt.length &gt; 0 || originalAtt.length &gt; 0) {</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+            let attMap = {};</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+            for each (let att in originalAtt) {</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+                attMap[att.id.toLowerCase()] = att;</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+            }</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+            for each (let att in itemAtt) {</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+                if (att.id.toLowerCase() in attMap) {</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+                    // Attendee was in original item.</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+                    delete attMap[att.id.toLowerCase()];</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+                }</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+            }</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+            for each (let cancAtt in attMap) {</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+                canceledAttendees.push(cancAtt);</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+            }</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+        }</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+        // Check to see if some part of the item was updated, if so, re-send REQUEST</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+        if (!aOriginalItem || aItem.generation != aOriginalItem.generation) { // REQUEST</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+            let requestItem = aItem.clone();</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+            // check whether it's a simple UPDATE (no SEQUENCE change) or real (RE)REQUEST,</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+            // in case of time or location/description change.</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+            let isUpdate = (aOriginalItem &amp;&amp; (cal.itip.getSequence(aItem) == cal.itip.getSequence(aOriginalItem)));</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+            if (!requestItem.organizer) {</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+                let organizer = createAttendee();</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+                organizer.id = requestItem.calendar.getProperty(&quot;organizerId&quot;);</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+                organizer.commonName = requestItem.calendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+                organizer.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+                organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+                organizer.isOrganizer = true;</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+                requestItem.organizer = organizer;</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+            }</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+            // Fix up our attendees for invitations using some good defaults</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+            let recipients = [];</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+            let itemAtt = requestItem.getAttendees({});</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+            if (!isUpdate) {</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+                requestItem.removeAllAttendees();</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+            }</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+            for each (let attendee in itemAtt) {</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+                if (!isUpdate) {</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+                    attendee = attendee.clone();</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+                    attendee.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+                    attendee.participationStatus = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+                    attendee.rsvp = &quot;TRUE&quot;;</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+                    requestItem.addAttendee(attendee);</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+                }</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+                recipients.push(attendee);</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+            }</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+            if (recipients.length &gt; 0) {</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+                sendMessage(requestItem, &quot;REQUEST&quot;, recipients, autoResponse);</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+            }</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+        }</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+        // Cancel the event for all canceled attendees</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+        if (canceledAttendees.length &gt; 0) {</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+            let cancelItem = aOriginalItem.clone();</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+            cancelItem.removeAllAttendees();</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+            for each (let att in canceledAttendees) {</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+                cancelItem.addAttendee(att);</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+            }</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+            sendMessage(cancelItem, &quot;CANCEL&quot;, canceledAttendees, autoResponse);</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+        }</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+    },</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+    /**</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+     * Bumps the SEQUENCE in case of a major change; XXX todo may need more fine-tuning.</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+     */</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+    prepareSequence: function cal_itip_prepareSequence(newItem, oldItem) {</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+        if (cal.isInvitation(newItem)) {</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+            return newItem; // invitation copies don't bump the SEQUENCE</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+        }</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+        if (newItem.recurrenceId &amp;&amp; !oldItem.recurrenceId &amp;&amp; oldItem.recurrenceInfo) {</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+            // XXX todo: there's still the bug that modifyItem is called with mixed occurrence/parent,</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+            //           find original occurrence</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+            oldItem = oldItem.recurrenceInfo.getOccurrenceFor(newItem.recurrenceId);</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+            cal.ASSERT(oldItem, &quot;unexpected!&quot;);</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+            if (!oldItem) {</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+                return newItem;</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+            }</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+        }</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+        function hashMajorProps(aItem) {</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+            let propStrings = [];</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+            function addProps(item) {</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+                if (item) {</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+                    const majorProps = {</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+                        DTSTART: true,</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+                        DTEND: true,</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+                        DURATION: true,</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+                        DUE: true,</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+                        RDATE: true,</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+                        RRULE: true,</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+                        EXDATE: true,</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+                        STATUS: true,</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineplus">+                        LOCATION: true</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+                    };</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+                    cal.calIterateIcalComponent(</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineplus">+                        item.icalComponent,</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+                        function(subComp) {</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+                            for (let prop = subComp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+                                 prop;</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+                                 prop = subComp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+                                if (majorProps[prop.propertyName]) {</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+                                    propStrings.push(item.recurrenceId + &quot;#&quot; + prop.icalString);</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+                                }</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+                            }</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+                        },</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+                        cal.isEvent(item) ? &quot;VEVENT&quot; : &quot;VTODO&quot;);</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+                }</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+            }</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineplus">+            addProps(aItem);</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+            let rec = (aItem &amp;&amp; aItem.recurrenceInfo);</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+            if (rec) {</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+                rec.getExceptionIds({}).forEach(</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+                    function(rid) {</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+                        addProps(rec.getExceptionFor(rid, false));</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+                    });</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+            }</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineplus">+            propStrings.sort();</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+            return propStrings.join(&quot;&quot;);</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+        }</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+        let h1 = hashMajorProps(newItem);</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+        let h2 = hashMajorProps(oldItem);</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+        if (h1 != h2) {</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+            newItem = newItem.clone();</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+            // bump SEQUENCE, it never decreases (mind undo scenario here)</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+            newItem.setProperty(&quot;SEQUENCE&quot;,</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineplus">+                                String(Math.max(cal.itip.getSequence(oldItem),</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineplus">+                                                cal.itip.getSequence(newItem)) + 1));</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+        }</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+        return newItem;</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+    }</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+};</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+/** local to this module file</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+ * Sets the received info either on the passed attendee or item object.</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineplus">+ *</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineplus">+ * @param item either  calIAttendee or calIItemBase</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineplus">+ * @param itipItemItem received iTIP item</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+ */</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+function setReceivedInfo(item, itipItemItem) {</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+    item.setProperty((item instanceof Components.interfaces.calIAttendee) ? &quot;RECEIVED-SEQUENCE&quot;</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+                                                                          : &quot;X-MOZ-RECEIVED-SEQUENCE&quot;,</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+                     String(cal.itip.getSequence(itipItemItem)));</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+    let dtstamp = cal.itip.getStamp(itipItemItem);</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+    if (dtstamp) {</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+        item.setProperty((item instanceof Components.interfaces.calIAttendee) ? &quot;RECEIVED-DTSTAMP&quot;</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+                                                                              : &quot;X-MOZ-RECEIVED-DTSTAMP&quot;,</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+                         dtstamp.getInTimezone(cal.UTC()).icalString);</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+    }</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+}</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+/** local to this module file</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+ * Creates an organizer calIAttendee object based on the calendar's configured organizer id.</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineplus">+ *</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineplus">+ * @return calIAttendee object</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineplus">+ */</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineplus">+function createOrganizer(aCalendar) {</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineplus">+    let orgId = aCalendar.getProperty(&quot;organizerId&quot;);</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineplus">+    if (!orgId) {</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineplus">+        return null;</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineplus">+    }</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+    let organizer = cal.createAttendee();</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+    organizer.id = orgId;</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+    organizer.commonName = aCalendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+    organizer.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+    organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+    organizer.isOrganizer = true;</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+    return organizer;</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+}</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineplus">+</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineplus">+/** local to this module file</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineplus">+ * Sends an iTIP message using the passed item's calendar transport.</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineplus">+ *</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineplus">+ * @param aItem iTIP item to be sent</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineplus">+ * @param aMethod iTIP method</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineplus">+ * @param aRecipientsList an array of calIAttendee objects the message should be sent to</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineplus">+ * @param autoResponse an inout object whether the transport should ask before sending</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineplus">+ */</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineplus">+function sendMessage(aItem, aMethod, aRecipientsList, autoResponse) {</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineplus">+    if (aRecipientsList.length == 0) {</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineplus">+        return;</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineplus">+    }</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineplus">+    if (cal.calInstanceOf(aItem.calendar, Components.interfaces.calISchedulingSupport) &amp;&amp;</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineplus">+        aItem.calendar.canNotify(aMethod, aItem)) {</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineplus">+        return; // provider will handle that</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineplus">+    }</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineplus">+</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineplus">+    let aTransport = aItem.calendar.getProperty(&quot;itip.transport&quot;);</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineplus">+    if (!aTransport) { // can only send if there's a transport for the calendar</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineplus">+        return;</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineplus">+    }</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineplus">+    aTransport = aTransport.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineplus">+</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineplus">+    let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineplus">+                             .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineplus">+    itipItem.init(cal.getSerializedItem(aItem));</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineplus">+    itipItem.responseMethod = aMethod;</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineplus">+    itipItem.targetCalendar = aItem.calendar;</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineplus">+    itipItem.autoResponse = ((autoResponse &amp;&amp; autoResponse.value) ? Components.interfaces.calIItipItem.AUTO</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineplus">+                                                                  : Components.interfaces.calIItipItem.USER);</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineplus">+    if (autoResponse) {</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineplus">+        autoResponse.value = true; // auto every following</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineplus">+    }</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineplus">+    // XXX I don't know whether the below are used at all, since we don't use the itip processor</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineplus">+    itipItem.isSend = true;</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineplus">+</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineplus">+    aTransport.sendItems(aRecipientsList.length, aRecipientsList, itipItem);</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineplus">+}</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineplus">+</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineplus">+/** local to this module file</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineplus">+ * An operation listener that is used on calendar operations which checks and sends further iTIP</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineplus">+ * messages based on the calendar action.</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+ *</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+ * @param opListener operation listener to forward</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineplus">+ * @param oldItem the previous item before modification (if any) </span>
<a href="#l10.475"></a><span id="l10.475" class="difflineplus">+ */</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+function ItipOpListener(opListener, oldItem) {</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+    this.mOpListener = opListener;</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineplus">+    this.mOldItem = oldItem;</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineplus">+}</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineplus">+ItipOpListener.prototype = {</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineplus">+    onOperationComplete: function ItipOpListener_onOperationComplete(aCalendar,</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineplus">+                                                                     aStatus,</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineplus">+                                                                     aOperationType,</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+                                                                     aId,</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+                                                                     aDetail) {</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+        cal.ASSERT(Components.isSuccessCode(aStatus), &quot;error on iTIP processing&quot;);</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+        if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineplus">+            cal.itip.checkAndSend(aOperationType, aDetail, this.mOldItem);</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineplus">+        }</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineplus">+        if (this.mOpListener) {</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineplus">+            this.mOpListener.onOperationComplete(aCalendar,</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineplus">+                                                 aStatus,</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineplus">+                                                 aOperationType,</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineplus">+                                                 aId,</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineplus">+                                                 aDetail);</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineplus">+        }</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+    },</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineplus">+    onGetResult: function ItipOpListener_onGetResult(aCalendar,</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineplus">+                                                     aStatus,</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineplus">+                                                     aItemType,</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineplus">+                                                     aDetail,</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineplus">+                                                     aCount,</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineplus">+                                                     aItems) {</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineplus">+    }</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineplus">+};</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineplus">+</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineplus">+/** local to this module file</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineplus">+ * An operation listener triggered by cal.itip.processItipItem() for lookup of the sent iTIP item's UID.</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineplus">+ *</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineplus">+ * @param itipItem sent iTIP item</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineplus">+ * @param optionsFunc options func, see cal.itip.processItipItem()</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineplus">+ */</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineplus">+function ItipFindItemListener(itipItem, optionsFunc) {</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineplus">+    this.mItipItem = itipItem;</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineplus">+    this.mOptionsFunc = optionsFunc;</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineplus">+    this.mFoundItems = [];</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineplus">+}</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineplus">+ItipFindItemListener.prototype = {</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineplus">+    mItipItem: null,</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineplus">+    mOptionsFunc: null,</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineplus">+    mFoundItems: null,</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineplus">+</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineplus">+    onOperationComplete: function ItipFindItemListener_onOperationComplete(aCalendar,</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineplus">+                                                                           aStatus,</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineplus">+                                                                           aOperationType,</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineplus">+                                                                           aId,</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineplus">+                                                                           aDetail) {</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineplus">+        let rc = Components.results.NS_OK;</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineplus">+        const method = this.mItipItem.receivedMethod.toUpperCase();</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineplus">+        let actionMethod = method;</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineplus">+        let operations = [];</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineplus">+</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineplus">+        if (this.mFoundItems.length &gt; 0) {</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineplus">+            cal.LOG(&quot;iTIP on &quot; + method + &quot;: found items.&quot;);</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineplus">+            switch (method) {</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineplus">+                // XXX todo: there's still a potential flaw, if multiple PUBLISH/REPLY/REQUEST on</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineplus">+                //           occurrences happen at once; those lead to multiple</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineplus">+                //           occurrence modifications. Since those modifications happen</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineplus">+                //           implicitly on the parent (ics/memory/storage calls modifyException),</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineplus">+                //           the generation check will fail. We should really consider to allow</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineplus">+                //           deletion/modification/addition of occurrences directly on the providers,</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineplus">+                //           which would ease client code a lot.</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineplus">+                case &quot;REFRESH&quot;:</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineplus">+                case &quot;PUBLISH&quot;:</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineplus">+                case &quot;REQUEST&quot;:</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineplus">+                case &quot;REPLY&quot;:</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineplus">+                    for each (let itipItemItem in this.mItipItem.getItemList({})) {</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineplus">+                        for each (let item in this.mFoundItems) {</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineplus">+                            let rid = itipItemItem.recurrenceId; //  XXX todo support multiple</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineplus">+                            if (rid) { // actually a REPLY to single occurrence(s)</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineplus">+                                if (item.recurrenceInfo) {</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineplus">+                                    item = item.recurrenceInfo.getOccurrenceFor(rid);</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineplus">+                                    if (!item) {</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineplus">+                                        continue;</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineplus">+                                    }</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineplus">+                                } else if (item.recurrenceId &amp;&amp; (item.recurrenceId.compare(rid) != 0)) {</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineplus">+                                    // filter out non-parentless occurrences (future)</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineplus">+                                    continue;</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineplus">+                                }</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineplus">+                                if (!itipItemItem.parentItem) { // install parent, if known from previous</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineplus">+                                                                // REQUEST/PUBLISH messages</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineplus">+                                    itipItemItem.parentItem = newItem.parentItem;</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineplus">+                                }</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineplus">+                            }</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineplus">+                            switch (method) {</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineplus">+                                case &quot;REFRESH&quot;: { // xxx todo test</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineplus">+                                    let attendees = itipItemItem.getAttendees({});</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineplus">+                                    cal.ASSERT(attendees.length == 1, &quot;invalid number of attendees in REFRESH!&quot;);</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineplus">+                                    if (attendees.length &gt; 0) {</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineplus">+                                        let action = function(opListener) {</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+                                            if (!item.organizer) {</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineplus">+                                                let org = createOrganizer(item.calendar);</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineplus">+                                                if (org) {</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineplus">+                                                    item = item.clone();</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineplus">+                                                    item.organizer = org;</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineplus">+                                                }</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineplus">+                                            }</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineplus">+                                            sendMessage(item, &quot;REQUEST&quot;, attendees, true /* don't ask */);</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineplus">+                                        };</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineplus">+                                        operations.push(action);</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineplus">+                                    }</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineplus">+                                    break;</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineplus">+                                }</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineplus">+                                case &quot;PUBLISH&quot;:</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineplus">+                                    cal.ASSERT(itipItemItem.getAttendees({}).length == 0,</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineplus">+                                               &quot;invalid number of attendees in PUBLISH!&quot;);</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineplus">+                                    if (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineplus">+                                        cal.itip.compare(itipItemItem, item) &gt; 0) {</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineplus">+                                        let newItem = itipItemItem.clone(); // xxx todo, this is dirty</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineplus">+                                        setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineplus">+                                        newItem.calendar = item.calendar;</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineplus">+                                        newItem.generation = item.generation;</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineplus">+                                        newItem.alarmOffset = item.alarmOffset;</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineplus">+                                        newItem.alarmRelated = item.alarmRelated;</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineplus">+                                        newItem.alarmLastAck = item.alarmLastAck;</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineplus">+                                        let action = function(opListener) {</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineplus">+                                            return newItem.calendar.modifyItem(newItem, item, opListener);</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineplus">+                                        };</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineplus">+                                        actionMethod = method + &quot;:UPDATE&quot;;</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineplus">+                                        operations.push(action);</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineplus">+                                    }</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineplus">+                                    break;</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineplus">+                                case &quot;REQUEST&quot;:</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineplus">+                                    if (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineplus">+                                        cal.itip.compare(itipItemItem, item) &gt; 0) {</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineplus">+                                        let newItem = itipItemItem.clone(); // xxx todo, this is dirty</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineplus">+                                        setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineplus">+                                        newItem.calendar = item.calendar;</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineplus">+                                        newItem.generation = item.generation;</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineplus">+                                        newItem.alarmOffset = item.alarmOffset;</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineplus">+                                        newItem.alarmRelated = item.alarmRelated;</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineplus">+                                        newItem.alarmLastAck = item.alarmLastAck;</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineplus">+                                        let att = cal.getInvitedAttendee(newItem);</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineplus">+                                        if (!att) { // fall back to using configured organizer</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineplus">+                                            att = createOrganizer(newItem.calendar);</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineplus">+                                            if (att) {</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineplus">+                                                att.isOrganizer = false;</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineplus">+                                                newItem.addAttendee(att);</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineplus">+                                            }</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineplus">+                                        }</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineplus">+                                        if (att) {</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineplus">+                                            let action = function(opListener, partStat) {</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineplus">+                                                if (partStat) {</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineplus">+                                                    att.participationStatus = partStat;</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineplus">+                                                }</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineplus">+                                                return newItem.calendar.modifyItem(</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineplus">+                                                    newItem, item, new ItipOpListener(opListener, item));</span>
<a href="#l10.628"></a><span id="l10.628" class="difflineplus">+                                            };</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineplus">+                                            let isMinorUpdate = (cal.itip.getSequence(newItem) ==</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineplus">+                                                                 cal.itip.getSequence(item));</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineplus">+                                            actionMethod = (isMinorUpdate ? method + &quot;:UPDATE-MINOR&quot;</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineplus">+                                                                          : method + &quot;:UPDATE&quot;);</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineplus">+                                            operations.push(action);</span>
<a href="#l10.634"></a><span id="l10.634" class="difflineplus">+                                        }</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineplus">+                                    }</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineplus">+                                    break;</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineplus">+                                case &quot;REPLY&quot;: {</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineplus">+                                    let attendees = itipItemItem.getAttendees({});</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineplus">+                                    cal.ASSERT(attendees.length == 1, &quot;invalid number of attendees in REPLY!&quot;);</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineplus">+                                    if (attendees.length &gt; 0 &amp;&amp;</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineplus">+                                        (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineplus">+                                         (cal.itip.compare(itipItemItem, item.getAttendeeById(attendees[0].id)) &gt; 0))) {</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineplus">+                                        // accepts REPLYs from previously uninvited attendees:</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineplus">+                                        let newItem = item.clone();</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineplus">+                                        let att = (item.getAttendeeById(attendees[0].id) || attendees[0]);</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineplus">+                                        newItem.removeAttendee(att);</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineplus">+                                        att = att.clone();</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineplus">+                                        setReceivedInfo(att, itipItemItem);</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineplus">+                                        att.participationStatus = attendees[0].participationStatus;</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineplus">+                                        newItem.addAttendee(att);</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineplus">+                                        let action = function(opListener) {</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineplus">+                                            return newItem.calendar.modifyItem(</span>
<a href="#l10.653"></a><span id="l10.653" class="difflineplus">+                                                newItem, item,</span>
<a href="#l10.654"></a><span id="l10.654" class="difflineplus">+                                                newItem.calendar.getProperty(&quot;itip.notify-replies&quot;)</span>
<a href="#l10.655"></a><span id="l10.655" class="difflineplus">+                                                ? new ItipOpListener(opListener, item)</span>
<a href="#l10.656"></a><span id="l10.656" class="difflineplus">+                                                : opListener);</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineplus">+                                        };</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineplus">+                                        operations.push(action);</span>
<a href="#l10.659"></a><span id="l10.659" class="difflineplus">+                                    }</span>
<a href="#l10.660"></a><span id="l10.660" class="difflineplus">+                                    break;</span>
<a href="#l10.661"></a><span id="l10.661" class="difflineplus">+                                }</span>
<a href="#l10.662"></a><span id="l10.662" class="difflineplus">+                            }</span>
<a href="#l10.663"></a><span id="l10.663" class="difflineplus">+                        }</span>
<a href="#l10.664"></a><span id="l10.664" class="difflineplus">+                    }</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineplus">+                    break;</span>
<a href="#l10.666"></a><span id="l10.666" class="difflineplus">+                case &quot;CANCEL&quot;: {</span>
<a href="#l10.667"></a><span id="l10.667" class="difflineplus">+                    let modifiedItems = {};</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineplus">+                    for each (let itipItemItem in this.mItipItem.getItemList({})) {</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineplus">+                        for each (let item in this.mFoundItems) {</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineplus">+                            let rid = itipItemItem.recurrenceId; //  XXX todo support multiple</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineplus">+                            if (rid) { // actually a CANCEL of occurrence(s)</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineplus">+                                if (item.recurrenceInfo) {</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineplus">+                                    // collect all occurrence deletions into a single parent modification:</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineplus">+                                    let newItem = modifiedItems[item.id];</span>
<a href="#l10.675"></a><span id="l10.675" class="difflineplus">+                                    if (!newItem) {</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineplus">+                                        newItem = item.clone();</span>
<a href="#l10.677"></a><span id="l10.677" class="difflineplus">+                                        modifiedItems[item.id] = newItem;</span>
<a href="#l10.678"></a><span id="l10.678" class="difflineplus">+                                        operations.push(</span>
<a href="#l10.679"></a><span id="l10.679" class="difflineplus">+                                            function(opListener) {</span>
<a href="#l10.680"></a><span id="l10.680" class="difflineplus">+                                                return newItem.calendar.modifyItem(newItem, item, opListener);</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineplus">+                                            });</span>
<a href="#l10.682"></a><span id="l10.682" class="difflineplus">+                                    }</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineplus">+                                    newItem.recurrenceInfo.removeOccurrenceAt(rid);</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineplus">+                                } else if (item.recurrenceId &amp;&amp; (item.recurrenceId.compare(rid) == 0)) {</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineplus">+                                    // parentless occurrence to be deleted (future)</span>
<a href="#l10.686"></a><span id="l10.686" class="difflineplus">+                                    operations.push(</span>
<a href="#l10.687"></a><span id="l10.687" class="difflineplus">+                                        function(opListener) {</span>
<a href="#l10.688"></a><span id="l10.688" class="difflineplus">+                                            return item.calendar.deleteItem(item, opListener);</span>
<a href="#l10.689"></a><span id="l10.689" class="difflineplus">+                                        });</span>
<a href="#l10.690"></a><span id="l10.690" class="difflineplus">+                                }</span>
<a href="#l10.691"></a><span id="l10.691" class="difflineplus">+                            } else {</span>
<a href="#l10.692"></a><span id="l10.692" class="difflineplus">+                                operations.push(</span>
<a href="#l10.693"></a><span id="l10.693" class="difflineplus">+                                    function(opListener) {</span>
<a href="#l10.694"></a><span id="l10.694" class="difflineplus">+                                        return item.calendar.deleteItem(item, opListener);</span>
<a href="#l10.695"></a><span id="l10.695" class="difflineplus">+                                    });</span>
<a href="#l10.696"></a><span id="l10.696" class="difflineplus">+                            }</span>
<a href="#l10.697"></a><span id="l10.697" class="difflineplus">+                        }</span>
<a href="#l10.698"></a><span id="l10.698" class="difflineplus">+                    }</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineplus">+                    break;</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineplus">+                }</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineplus">+                default:</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineplus">+                    rc = Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.703"></a><span id="l10.703" class="difflineplus">+                    break;</span>
<a href="#l10.704"></a><span id="l10.704" class="difflineplus">+            }</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineplus">+</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineplus">+        } else { // not found:</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineplus">+            cal.LOG(&quot;iTIP on &quot; + method + &quot;: no existing items.&quot;);</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineplus">+</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineplus">+            for each (let itipItemItem in this.mItipItem.getItemList({})) {</span>
<a href="#l10.710"></a><span id="l10.710" class="difflineplus">+                switch (method) {</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineplus">+                    case &quot;REQUEST&quot;:</span>
<a href="#l10.712"></a><span id="l10.712" class="difflineplus">+                    case &quot;PUBLISH&quot;: {</span>
<a href="#l10.713"></a><span id="l10.713" class="difflineplus">+                        let this_ = this;</span>
<a href="#l10.714"></a><span id="l10.714" class="difflineplus">+                        let action = function(opListener, partStat) {</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineplus">+                            let newItem = itipItemItem.clone();</span>
<a href="#l10.716"></a><span id="l10.716" class="difflineplus">+                            setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l10.717"></a><span id="l10.717" class="difflineplus">+                            newItem.calendar = this_.mItipItem.targetCalendar;</span>
<a href="#l10.718"></a><span id="l10.718" class="difflineplus">+                            if (partStat) {</span>
<a href="#l10.719"></a><span id="l10.719" class="difflineplus">+                                if (partStat != &quot;DECLINED&quot;) {</span>
<a href="#l10.720"></a><span id="l10.720" class="difflineplus">+                                    cal.setDefaultAlarmValues(newItem);</span>
<a href="#l10.721"></a><span id="l10.721" class="difflineplus">+                                }</span>
<a href="#l10.722"></a><span id="l10.722" class="difflineplus">+                                let att = cal.getInvitedAttendee(newItem);</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineplus">+                                if (!att) { // fall back to using configured organizer</span>
<a href="#l10.724"></a><span id="l10.724" class="difflineplus">+                                    att = createOrganizer(newItem.calendar);</span>
<a href="#l10.725"></a><span id="l10.725" class="difflineplus">+                                    if (att) {</span>
<a href="#l10.726"></a><span id="l10.726" class="difflineplus">+                                        att.isOrganizer = false;</span>
<a href="#l10.727"></a><span id="l10.727" class="difflineplus">+                                        newItem.addAttendee(att);</span>
<a href="#l10.728"></a><span id="l10.728" class="difflineplus">+                                    }</span>
<a href="#l10.729"></a><span id="l10.729" class="difflineplus">+                                }</span>
<a href="#l10.730"></a><span id="l10.730" class="difflineplus">+                                if (att) {</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineplus">+                                    att.participationStatus = partStat;</span>
<a href="#l10.732"></a><span id="l10.732" class="difflineplus">+                                } else {</span>
<a href="#l10.733"></a><span id="l10.733" class="difflineplus">+                                    cal.ASSERT(att, &quot;no attendee to reply REQUEST!&quot;);</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineplus">+                                    return;</span>
<a href="#l10.735"></a><span id="l10.735" class="difflineplus">+                                }</span>
<a href="#l10.736"></a><span id="l10.736" class="difflineplus">+                            } else {</span>
<a href="#l10.737"></a><span id="l10.737" class="difflineplus">+                                cal.ASSERT(itipItemItem.getAttendees({}).length == 0,</span>
<a href="#l10.738"></a><span id="l10.738" class="difflineplus">+                                           &quot;invalid number of attendees in PUBLISH!&quot;);</span>
<a href="#l10.739"></a><span id="l10.739" class="difflineplus">+                            }</span>
<a href="#l10.740"></a><span id="l10.740" class="difflineplus">+                            return newItem.calendar.addItem(newItem,</span>
<a href="#l10.741"></a><span id="l10.741" class="difflineplus">+                                                            (method == &quot;REQUEST&quot;)</span>
<a href="#l10.742"></a><span id="l10.742" class="difflineplus">+                                                            ? new ItipOpListener(opListener, null)</span>
<a href="#l10.743"></a><span id="l10.743" class="difflineplus">+                                                            : opListener);</span>
<a href="#l10.744"></a><span id="l10.744" class="difflineplus">+                        };</span>
<a href="#l10.745"></a><span id="l10.745" class="difflineplus">+                        operations.push(action);</span>
<a href="#l10.746"></a><span id="l10.746" class="difflineplus">+                        break;</span>
<a href="#l10.747"></a><span id="l10.747" class="difflineplus">+                    }</span>
<a href="#l10.748"></a><span id="l10.748" class="difflineplus">+                    case &quot;CANCEL&quot;: // has already been processed</span>
<a href="#l10.749"></a><span id="l10.749" class="difflineplus">+                        break;</span>
<a href="#l10.750"></a><span id="l10.750" class="difflineplus">+                    default:</span>
<a href="#l10.751"></a><span id="l10.751" class="difflineplus">+                        rc = Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.752"></a><span id="l10.752" class="difflineplus">+                        break;</span>
<a href="#l10.753"></a><span id="l10.753" class="difflineplus">+                }</span>
<a href="#l10.754"></a><span id="l10.754" class="difflineplus">+            }</span>
<a href="#l10.755"></a><span id="l10.755" class="difflineplus">+        }</span>
<a href="#l10.756"></a><span id="l10.756" class="difflineplus">+</span>
<a href="#l10.757"></a><span id="l10.757" class="difflineplus">+        cal.LOG(&quot;iTIP operations: &quot; + operations.length);</span>
<a href="#l10.758"></a><span id="l10.758" class="difflineplus">+        let actionFunc = null;</span>
<a href="#l10.759"></a><span id="l10.759" class="difflineplus">+        if (operations.length &gt; 0) {</span>
<a href="#l10.760"></a><span id="l10.760" class="difflineplus">+            actionFunc = function execOperations(opListener, partStat) {</span>
<a href="#l10.761"></a><span id="l10.761" class="difflineplus">+                for each (let op in operations) {</span>
<a href="#l10.762"></a><span id="l10.762" class="difflineplus">+                    try {</span>
<a href="#l10.763"></a><span id="l10.763" class="difflineplus">+                        op(opListener, partStat);</span>
<a href="#l10.764"></a><span id="l10.764" class="difflineplus">+                    } catch (exc) {</span>
<a href="#l10.765"></a><span id="l10.765" class="difflineplus">+                        cal.ERROR(exc);</span>
<a href="#l10.766"></a><span id="l10.766" class="difflineplus">+                    }</span>
<a href="#l10.767"></a><span id="l10.767" class="difflineplus">+                }</span>
<a href="#l10.768"></a><span id="l10.768" class="difflineplus">+            };</span>
<a href="#l10.769"></a><span id="l10.769" class="difflineplus">+            actionFunc.method = actionMethod;</span>
<a href="#l10.770"></a><span id="l10.770" class="difflineplus">+        }</span>
<a href="#l10.771"></a><span id="l10.771" class="difflineplus">+</span>
<a href="#l10.772"></a><span id="l10.772" class="difflineplus">+        this.mOptionsFunc(this.mItipItem, rc, actionFunc);</span>
<a href="#l10.773"></a><span id="l10.773" class="difflineplus">+    },</span>
<a href="#l10.774"></a><span id="l10.774" class="difflineplus">+</span>
<a href="#l10.775"></a><span id="l10.775" class="difflineplus">+    onGetResult: function ItipFindItemListener_onGetResult(aCalendar,</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineplus">+                                                           aStatus,</span>
<a href="#l10.777"></a><span id="l10.777" class="difflineplus">+                                                           aItemType,</span>
<a href="#l10.778"></a><span id="l10.778" class="difflineplus">+                                                           aDetail,</span>
<a href="#l10.779"></a><span id="l10.779" class="difflineplus">+                                                           aCount,</span>
<a href="#l10.780"></a><span id="l10.780" class="difflineplus">+                                                           aItems) {</span>
<a href="#l10.781"></a><span id="l10.781" class="difflineplus">+        if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l10.782"></a><span id="l10.782" class="difflineplus">+            this.mFoundItems = this.mFoundItems.concat(aItems);</span>
<a href="#l10.783"></a><span id="l10.783" class="difflineplus">+        }</span>
<a href="#l10.784"></a><span id="l10.784" class="difflineplus">+    }</span>
<a href="#l10.785"></a><span id="l10.785" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">rename from calendar/base/src/calUtils.jsm</span>
<a href="#l11.2"></a><span id="l11.2">rename to calendar/base/modules/calUtils.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineminus">--- a/calendar/base/src/calUtils.jsm</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineat">@@ -32,40 +32,41 @@</span>
<a href="#l11.6"></a><span id="l11.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.7"></a><span id="l11.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.8"></a><span id="l11.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.9"></a><span id="l11.9">  *</span>
<a href="#l11.10"></a><span id="l11.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12"> // New code must not load/import calUtils.js, but should use calUtils.jsm.</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l11.16"></a><span id="l11.16"> let cal = {</span>
<a href="#l11.17"></a><span id="l11.17">     // new code should land here,</span>
<a href="#l11.18"></a><span id="l11.18">     // and more code should be moved from calUtils.js into this object to avoid</span>
<a href="#l11.19"></a><span id="l11.19">     // clashes with other extensions</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">     getIOService: generateServiceAccessor(&quot;@mozilla.org/network/io-service;1&quot;,</span>
<a href="#l11.22"></a><span id="l11.22">                                           Components.interfaces.nsIIOService2),</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+    getObserverService: generateServiceAccessor(&quot;@mozilla.org/observer-service;1&quot;,</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+                                                Components.interfaces.nsIObserverService),</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26">     /**</span>
<a href="#l11.27"></a><span id="l11.27">      * Loads an array of calendar scripts into the passed scope.</span>
<a href="#l11.28"></a><span id="l11.28">      *</span>
<a href="#l11.29"></a><span id="l11.29">      * @param scriptNames an array of calendar script names</span>
<a href="#l11.30"></a><span id="l11.30">      * @param scope       scope to load into</span>
<a href="#l11.31"></a><span id="l11.31">      * @param baseDir     base dir; defaults to calendar-js/</span>
<a href="#l11.32"></a><span id="l11.32">      */</span>
<a href="#l11.33"></a><span id="l11.33">     loadScripts: function cal_loadScripts(scriptNames, scope, baseDir) {</span>
<a href="#l11.34"></a><span id="l11.34">         let scriptLoader = Components.classes[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l11.35"></a><span id="l11.35">                                      .createInstance(Components.interfaces.mozIJSSubScriptLoader);</span>
<a href="#l11.36"></a><span id="l11.36">         let ioService = cal.getIOService();</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38">         if (!baseDir) {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-            baseDir = __LOCATION__.parent.parent;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-            baseDir = baseDir.clone();</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+            baseDir = __LOCATION__.parent.parent.clone();</span>
<a href="#l11.42"></a><span id="l11.42">             baseDir.append(&quot;calendar-js&quot;);</span>
<a href="#l11.43"></a><span id="l11.43">         }</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45">         for each (let script in scriptNames) {</span>
<a href="#l11.46"></a><span id="l11.46">             let scriptFile = baseDir.clone();</span>
<a href="#l11.47"></a><span id="l11.47">             scriptFile.append(script);</span>
<a href="#l11.48"></a><span id="l11.48">             try {</span>
<a href="#l11.49"></a><span id="l11.49">                 scriptLoader.loadSubScript(ioService.newFileURI(scriptFile).spec, scope);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineat">@@ -77,16 +78,74 @@ let cal = {</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">     /**</span>
<a href="#l11.53"></a><span id="l11.53">      * Checks whether a timezone lacks a definition.</span>
<a href="#l11.54"></a><span id="l11.54">      */</span>
<a href="#l11.55"></a><span id="l11.55">     isPhantomTimezone: function cal_isPhantomTimezone(tz) {</span>
<a href="#l11.56"></a><span id="l11.56">         return (!tz.icalComponent &amp;&amp; !tz.isUTC &amp;&amp; !tz.isFloating);</span>
<a href="#l11.57"></a><span id="l11.57">     },</span>
<a href="#l11.58"></a><span id="l11.58"> </span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+    /**</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+     * Iterates an array of items, i.e. the passed item including all</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+     * overridden instances of a recurring series.</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+     *</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+     * @param items array of items</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+     */</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    itemIterator: function cal_itemIterator(items) {</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+        return {</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+            __iterator__: function itemIterator_() {</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+                for each (let item in items) {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+                    yield item;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+                    let rec = item.recurrenceInfo;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+                    if (rec) {</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+                        for each (let exid in rec.getExceptionIds({})) {</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+                            yield rec.getExceptionFor(exid, false);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                        }</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+                    }</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+                }</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+            }</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+        };</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+    },</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    /**</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+     * Shortcut function to serialize an item (including all overridden items).</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+     */</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+    getSerializedItem: function cal_getSerializedItem(aItem) {</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+        let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+                                   .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+        serializer.addItems([aItem], 1);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+        return serializer.serializeToString();</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+    },</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+    /**</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+     * Shortcut function to check whether an item is an invitation copy.</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+     */</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+    isInvitation: function cal_isInvitation(aItem) {</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+        let isInvitation = false;</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+        let calendar = aItem.calendar;</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+        if (cal.calInstanceOf(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+            isInvitation = calendar.isInvitation(aItem);</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+        }</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+        return isInvitation;</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+    },</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+    /**</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+     * Shortcut function to get the invited attendee of an item.</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+     */</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+    getInvitedAttendee: function cal_getInvitedAttendee(aItem, aCalendar) {</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+        if (!aCalendar) {</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+            aCalendar = aItem.calendar;</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+        }</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+        let invitedAttendee = null;</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+        if (cal.calInstanceOf(aCalendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+            invitedAttendee = aCalendar.getInvitedAttendee(aItem);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+        }</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+        return invitedAttendee;</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+    },</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+</span>
<a href="#l11.117"></a><span id="l11.117">     // The below functions will move to some different place once the</span>
<a href="#l11.118"></a><span id="l11.118">     // unifinder tress are consolidated.</span>
<a href="#l11.119"></a><span id="l11.119"> </span>
<a href="#l11.120"></a><span id="l11.120">     compareNativeTime: function cal_compareNativeTime(a, b) {</span>
<a href="#l11.121"></a><span id="l11.121">       return (a &lt; b ? -1 :</span>
<a href="#l11.122"></a><span id="l11.122">               a &gt; b ?  1 : 0);</span>
<a href="#l11.123"></a><span id="l11.123">     },</span>
<a href="#l11.124"></a><span id="l11.124"> </span>
<a href="#l11.125"></a><span id="l11.125" class="difflineat">@@ -240,17 +299,16 @@ let cal = {</span>
<a href="#l11.126"></a><span id="l11.126">      * Modifies aStringArray, returning it sorted.</span>
<a href="#l11.127"></a><span id="l11.127">      */</span>
<a href="#l11.128"></a><span id="l11.128">     sortArrayByLocaleCollator: function cal_sortArrayByLocaleCollator(aStringArray) {</span>
<a href="#l11.129"></a><span id="l11.129">         var localeCollator = cal.createLocaleCollator();</span>
<a href="#l11.130"></a><span id="l11.130">         function compare(a, b) { return localeCollator.compareString(0, a, b); }</span>
<a href="#l11.131"></a><span id="l11.131">         aStringArray.sort(compare);</span>
<a href="#l11.132"></a><span id="l11.132">         return aStringArray;</span>
<a href="#l11.133"></a><span id="l11.133">     }</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-</span>
<a href="#l11.135"></a><span id="l11.135"> };</span>
<a href="#l11.136"></a><span id="l11.136"> </span>
<a href="#l11.137"></a><span id="l11.137"> // local to this module;</span>
<a href="#l11.138"></a><span id="l11.138"> // will be used to generate service accessor functions, getIOService()</span>
<a href="#l11.139"></a><span id="l11.139"> function generateServiceAccessor(id, iface) {</span>
<a href="#l11.140"></a><span id="l11.140">     return function this_() {</span>
<a href="#l11.141"></a><span id="l11.141">         if (this_.mService === undefined) {</span>
<a href="#l11.142"></a><span id="l11.142">             this_.mService = Components.classes[id].getService(iface);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/public/Makefile.in</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/public/Makefile.in</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -66,17 +66,16 @@ XPIDLSRCS = calIAlarm.idl \</span>
<a href="#l12.4"></a><span id="l12.4">             calIEvent.idl \</span>
<a href="#l12.5"></a><span id="l12.5">             calIFreeBusyProvider.idl \</span>
<a href="#l12.6"></a><span id="l12.6">             calIIcsParser.idl \</span>
<a href="#l12.7"></a><span id="l12.7">             calIIcsSerializer.idl \</span>
<a href="#l12.8"></a><span id="l12.8">             calIICSService.idl \</span>
<a href="#l12.9"></a><span id="l12.9">             calIImportExport.idl \</span>
<a href="#l12.10"></a><span id="l12.10">             calIItemBase.idl \</span>
<a href="#l12.11"></a><span id="l12.11">             calIItipItem.idl \</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-            calIItipProcessor.idl \</span>
<a href="#l12.13"></a><span id="l12.13">             calIItipTransport.idl \</span>
<a href="#l12.14"></a><span id="l12.14">             calIOperation.idl \</span>
<a href="#l12.15"></a><span id="l12.15">             calIPeriod.idl \</span>
<a href="#l12.16"></a><span id="l12.16">             calIPrintFormatter.idl \</span>
<a href="#l12.17"></a><span id="l12.17">             calIRecurrenceInfo.idl \</span>
<a href="#l12.18"></a><span id="l12.18">             calIRecurrenceDate.idl \</span>
<a href="#l12.19"></a><span id="l12.19">             calIRecurrenceDateSet.idl \</span>
<a href="#l12.20"></a><span id="l12.20">             calIRecurrenceItem.idl \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/public/calIItemBase.idl</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/public/calIItemBase.idl</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -109,19 +109,16 @@ interface calIItemBase : nsISupports</span>
<a href="#l13.4"></a><span id="l13.4">   readonly attribute calIDateTime creationDate;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">   // last time any attribute was modified on this item, in UTC</span>
<a href="#l13.7"></a><span id="l13.7">   readonly attribute calIDateTime lastModifiedTime;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">   // last time a &quot;significant change&quot; was made to this item</span>
<a href="#l13.10"></a><span id="l13.10">   readonly attribute calIDateTime stampTime;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  // indicate such a &quot;significant change&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  void updateStampTime();</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-</span>
<a href="#l13.15"></a><span id="l13.15">   // the calICalendar to which this event belongs</span>
<a href="#l13.16"></a><span id="l13.16">   attribute calICalendar calendar;</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18">   // the ID of this event</span>
<a href="#l13.19"></a><span id="l13.19">   attribute AUTF8String id;</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">   // event title</span>
<a href="#l13.22"></a><span id="l13.22">   attribute AUTF8String title;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/public/calIItipItem.idl</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/public/calIItipItem.idl</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -129,37 +129,14 @@ interface calIItipItem : nsISupports</span>
<a href="#l14.4"></a><span id="l14.4">      * Get the list of items that are encapsulated in this calIItipItem</span>
<a href="#l14.5"></a><span id="l14.5">      * @returns An array of calIItemBase items that are inside this</span>
<a href="#l14.6"></a><span id="l14.6">      *          calIItipItem</span>
<a href="#l14.7"></a><span id="l14.7">      */</span>
<a href="#l14.8"></a><span id="l14.8">     void getItemList(out unsigned long itemCount,</span>
<a href="#l14.9"></a><span id="l14.9">                      [retval, array, size_is(itemCount)] out calIItemBase items);</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">     /**</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-     * Get the first item from the iTIP message</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-     * Bug XXX 351761: Need to find a way to make this use an nsISimpleEnumerator</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-     * @return calIItemBase</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-     </span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-    calIItemBase getFirstItem();</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-*/</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    /**</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-     * Get next item from the iTIP message. If there is no next item then it</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-     * returns NULL</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-     * @return calIItemBase</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-     </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-    calIItemBase getNextItem();</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-*/</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-    /**</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-     * Modifies a calIItemBase that is in the component list. Internally, the</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-     * interface will update the proper component. It does this via the</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-     * UID of the component by calling hasSameIds().</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-     * @param in parameter - item to modify</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-     * @return returns the new calIItemBase object for convienence</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-     */</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-    calIItemBase modifyItem(in calIItemBase item);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-    /**</span>
<a href="#l14.35"></a><span id="l14.35">      * Modifies the state of the given attendee in the item's ics</span>
<a href="#l14.36"></a><span id="l14.36">      * @param attendeeId - AString containing attendee address</span>
<a href="#l14.37"></a><span id="l14.37">      * @param status - AString containing the new attendee status</span>
<a href="#l14.38"></a><span id="l14.38">      */</span>
<a href="#l14.39"></a><span id="l14.39">     void setAttendeeStatus(in AString attendeeId, in AString status);</span>
<a href="#l14.40"></a><span id="l14.40"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/calendar/base/public/calIItipProcessor.idl</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,55 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-/* -*- Mode: idl; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">- *</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">- *</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">- * License.</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">- *</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">- * The Original Code is Simdesk Technologies code.</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">- *</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">- * The Initial Developer of the Original Code is Simdesk Technologies Inc.</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">- *</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">- *   Clint Talbert &lt;ctalbert.moz@gmail.com&gt;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">- *   Eva Or &lt;evaor1012@yahoo.ca&gt;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">- *   Matthew Willis &lt;lilmatt@mozilla.com&gt;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">- *</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">- *</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-interface calIItipItem;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-interface calIOperationListener;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-[scriptable, uuid(9787876b-0780-4464-8282-b7f86fb221e8)]</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-interface calIItipProcessor : nsISupports</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-{</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-    /**</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-     * Processes the given calItipItem based on the settings inside it.</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-     * @param in calIItipItem itipItem  A calItipItem to process.</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-     * @param in calIIOperationListener An operation Listener to report status</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-     * @return PRBool                 Whether processing succeeded or not.</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-     */</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-    boolean processItipItem(in calIItipItem itipItem, in calIOperationListener aListener);</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/src/Makefile.in</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/src/Makefile.in</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -89,35 +89,30 @@ EXTRA_SCRIPTS = \</span>
<a href="#l16.4"></a><span id="l16.4">     calCachedCalendar.js \</span>
<a href="#l16.5"></a><span id="l16.5">     calDateTimeFormatter.js \</span>
<a href="#l16.6"></a><span id="l16.6">     calEvent.js \</span>
<a href="#l16.7"></a><span id="l16.7">     calFilter.js \</span>
<a href="#l16.8"></a><span id="l16.8">     calIcsParser.js \</span>
<a href="#l16.9"></a><span id="l16.9">     calIcsSerializer.js \</span>
<a href="#l16.10"></a><span id="l16.10">     calItemBase.js \</span>
<a href="#l16.11"></a><span id="l16.11">     calItipItem.js \</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    calItipProcessor.js \</span>
<a href="#l16.13"></a><span id="l16.13">     calProtocolHandler.js \</span>
<a href="#l16.14"></a><span id="l16.14">     calRecurrenceInfo.js \</span>
<a href="#l16.15"></a><span id="l16.15">     calRelation.js \</span>
<a href="#l16.16"></a><span id="l16.16">     calTodo.js \</span>
<a href="#l16.17"></a><span id="l16.17">     calUtils.js \</span>
<a href="#l16.18"></a><span id="l16.18">     calAuthUtils.js \</span>
<a href="#l16.19"></a><span id="l16.19">     calProviderUtils.js \</span>
<a href="#l16.20"></a><span id="l16.20">     calWeekInfoService.js \</span>
<a href="#l16.21"></a><span id="l16.21">     calTransactionManager.js \</span>
<a href="#l16.22"></a><span id="l16.22">     calFreeBusyService.js \</span>
<a href="#l16.23"></a><span id="l16.23">     calCalendarSearchService.js \</span>
<a href="#l16.24"></a><span id="l16.24">     calTimezoneService.js \</span>
<a href="#l16.25"></a><span id="l16.25">     $(NULL)</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-EXTRA_JS_MODULES = \</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-    calUtils.jsm \</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-    $(NULL)</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-</span>
<a href="#l16.31"></a><span id="l16.31"> # Use NSINSTALL to make the directory, as there's no mtime to preserve.</span>
<a href="#l16.32"></a><span id="l16.32"> libs:: $(EXTRA_SCRIPTS)</span>
<a href="#l16.33"></a><span id="l16.33"> 	if test ! -d $(FINAL_TARGET)/calendar-js; then $(NSINSTALL) -D $(FINAL_TARGET)/calendar-js; fi</span>
<a href="#l16.34"></a><span id="l16.34"> 	$(INSTALL) $^ $(FINAL_TARGET)/calendar-js</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36"> # The install target must use SYSINSTALL, which is NSINSTALL in copy mode.</span>
<a href="#l16.37"></a><span id="l16.37"> install:: $(EXTRA_SCRIPTS)</span>
<a href="#l16.38"></a><span id="l16.38"> 	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(mozappdir)/calendar-js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/src/calEvent.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/src/calEvent.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,9 +1,8 @@</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l17.5"></a><span id="l17.5"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.6"></a><span id="l17.6">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.7"></a><span id="l17.7">  *</span>
<a href="#l17.8"></a><span id="l17.8">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.9"></a><span id="l17.9">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.10"></a><span id="l17.10">  * the License. You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11">  * http://www.mozilla.org/MPL/</span>
<a href="#l17.12"></a><span id="l17.12">  *</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineat">@@ -46,17 +45,16 @@</span>
<a href="#l17.14"></a><span id="l17.14"> // constructor</span>
<a href="#l17.15"></a><span id="l17.15"> //</span>
<a href="#l17.16"></a><span id="l17.16"> function calEvent() {</span>
<a href="#l17.17"></a><span id="l17.17">     this.initItemBase();</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">     this.eventPromotedProps = {</span>
<a href="#l17.20"></a><span id="l17.20">         &quot;DTSTART&quot;: true,</span>
<a href="#l17.21"></a><span id="l17.21">         &quot;DTEND&quot;: true,</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-        &quot;DTSTAMP&quot;: true,</span>
<a href="#l17.23"></a><span id="l17.23">         __proto__: this.itemBasePromotedProps</span>
<a href="#l17.24"></a><span id="l17.24">     }</span>
<a href="#l17.25"></a><span id="l17.25"> }</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27"> var calEventClassInfo = {</span>
<a href="#l17.28"></a><span id="l17.28">     getInterfaces: function (count) {</span>
<a href="#l17.29"></a><span id="l17.29">         var ifaces = [</span>
<a href="#l17.30"></a><span id="l17.30">             Components.interfaces.nsISupports,</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineat">@@ -169,16 +167,17 @@ calEvent.prototype = {</span>
<a href="#l17.32"></a><span id="l17.32">     set icalComponent(event) {</span>
<a href="#l17.33"></a><span id="l17.33">         this.modify();</span>
<a href="#l17.34"></a><span id="l17.34">         if (event.componentType != &quot;VEVENT&quot;) {</span>
<a href="#l17.35"></a><span id="l17.35">             event = event.getFirstSubcomponent(&quot;VEVENT&quot;);</span>
<a href="#l17.36"></a><span id="l17.36">             if (!event)</span>
<a href="#l17.37"></a><span id="l17.37">                 throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l17.38"></a><span id="l17.38">         }</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+        // xxx todo: Bug 463195 make sure object is properly reset</span>
<a href="#l17.41"></a><span id="l17.41">         this.setItemBaseFromICS(event);</span>
<a href="#l17.42"></a><span id="l17.42">         this.mapPropsFromICS(event, this.icsEventPropMap);</span>
<a href="#l17.43"></a><span id="l17.43"> </span>
<a href="#l17.44"></a><span id="l17.44">         this.importUnpromotedProperties(event, this.eventPromotedProps);</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46">         // Importing didn't really change anything</span>
<a href="#l17.47"></a><span id="l17.47">         this.mDirty = false;</span>
<a href="#l17.48"></a><span id="l17.48">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,10 +1,9 @@</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">- * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.7"></a><span id="l18.7">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.8"></a><span id="l18.8">  *</span>
<a href="#l18.9"></a><span id="l18.9">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.10"></a><span id="l18.10">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.11"></a><span id="l18.11">  * the License. You may obtain a copy of the License at</span>
<a href="#l18.12"></a><span id="l18.12">  * http://www.mozilla.org/MPL/</span>
<a href="#l18.13"></a><span id="l18.13">  *</span>
<a href="#l18.14"></a><span id="l18.14">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineat">@@ -52,30 +51,30 @@ function QueryInterface(aIID) {</span>
<a href="#l18.16"></a><span id="l18.16">         throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l18.17"></a><span id="l18.17">     }</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">     return this;</span>
<a href="#l18.20"></a><span id="l18.20"> };</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22"> calIcsParser.prototype.parseString =</span>
<a href="#l18.23"></a><span id="l18.23"> function ip_parseString(aICSString, aTzProvider) {</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-    var rootComp = getIcsService().parseICS(aICSString, aTzProvider);</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-    var calComp;</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+    let rootComp = getIcsService().parseICS(aICSString, aTzProvider);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+    let calComp;</span>
<a href="#l18.28"></a><span id="l18.28">     // libical returns the vcalendar component if there is just one vcalendar.</span>
<a href="#l18.29"></a><span id="l18.29">     // If there are multiple vcalendars, it returns an xroot component, with</span>
<a href="#l18.30"></a><span id="l18.30">     // those vcalendar children. We need to handle both.</span>
<a href="#l18.31"></a><span id="l18.31">     if (rootComp.componentType == 'VCALENDAR') {</span>
<a href="#l18.32"></a><span id="l18.32">         calComp = rootComp;</span>
<a href="#l18.33"></a><span id="l18.33">     } else {</span>
<a href="#l18.34"></a><span id="l18.34">         calComp = rootComp.getFirstSubcomponent('VCALENDAR');</span>
<a href="#l18.35"></a><span id="l18.35">     }</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-    var unexpandedItems = [];</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-    var uid2parent = {};</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-    var excItems = [];</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+    let uid2parent = {};</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+    let excItems = [];</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+    let fakedParents = {};</span>
<a href="#l18.43"></a><span id="l18.43"> </span>
<a href="#l18.44"></a><span id="l18.44">     let tzErrors = {};</span>
<a href="#l18.45"></a><span id="l18.45">     function checkTimezone(item, dt) {</span>
<a href="#l18.46"></a><span id="l18.46">         if (dt &amp;&amp; cal.isPhantomTimezone(dt.timezone)) {</span>
<a href="#l18.47"></a><span id="l18.47">             let tzid = dt.timezone.tzid;</span>
<a href="#l18.48"></a><span id="l18.48">             let hid = item.hashId + &quot;#&quot; + tzid;</span>
<a href="#l18.49"></a><span id="l18.49">             if (tzErrors[hid] === undefined) {</span>
<a href="#l18.50"></a><span id="l18.50">                 // For now, publish errors to console and alert user.</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineat">@@ -90,34 +89,34 @@ function ip_parseString(aICSString, aTzP</span>
<a href="#l18.52"></a><span id="l18.52">                 tzErrors[hid] = true;</span>
<a href="#l18.53"></a><span id="l18.53">             }</span>
<a href="#l18.54"></a><span id="l18.54">         }</span>
<a href="#l18.55"></a><span id="l18.55">     }</span>
<a href="#l18.56"></a><span id="l18.56"> </span>
<a href="#l18.57"></a><span id="l18.57">     while (calComp) {</span>
<a href="#l18.58"></a><span id="l18.58"> </span>
<a href="#l18.59"></a><span id="l18.59">         // Get unknown properties</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-        var prop = calComp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+        let prop = calComp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l18.62"></a><span id="l18.62">         while (prop) {</span>
<a href="#l18.63"></a><span id="l18.63">             if (prop.propertyName != &quot;VERSION&quot; &amp;&amp;</span>
<a href="#l18.64"></a><span id="l18.64">                 prop.propertyName != &quot;PRODID&quot;) {</span>
<a href="#l18.65"></a><span id="l18.65">                 this.mProperties.push(prop);</span>
<a href="#l18.66"></a><span id="l18.66">             }</span>
<a href="#l18.67"></a><span id="l18.67">             prop = calComp.getNextProperty(&quot;ANY&quot;);</span>
<a href="#l18.68"></a><span id="l18.68">         }</span>
<a href="#l18.69"></a><span id="l18.69"> </span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-        var prodId = calComp.getFirstProperty(&quot;PRODID&quot;);</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-        var isFromOldSunbird;</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+        let prodId = calComp.getFirstProperty(&quot;PRODID&quot;);</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+        let isFromOldSunbird;</span>
<a href="#l18.74"></a><span id="l18.74">         if (prodId) {</span>
<a href="#l18.75"></a><span id="l18.75">             isFromOldSunbird = prodId.value == &quot;-//Mozilla.org/NONSGML Mozilla Calendar V1.0//EN&quot;;</span>
<a href="#l18.76"></a><span id="l18.76">         }</span>
<a href="#l18.77"></a><span id="l18.77"> </span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-        var subComp = calComp.getFirstSubcomponent(&quot;ANY&quot;);</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+        let subComp = calComp.getFirstSubcomponent(&quot;ANY&quot;);</span>
<a href="#l18.80"></a><span id="l18.80">         while (subComp) {</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-            var item = null;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+            let item = null;</span>
<a href="#l18.83"></a><span id="l18.83">             switch (subComp.componentType) {</span>
<a href="#l18.84"></a><span id="l18.84">             case &quot;VEVENT&quot;:</span>
<a href="#l18.85"></a><span id="l18.85">                 item = cal.createEvent();</span>
<a href="#l18.86"></a><span id="l18.86">                 item.icalComponent = subComp;</span>
<a href="#l18.87"></a><span id="l18.87">                 checkTimezone(item, item.startDate);</span>
<a href="#l18.88"></a><span id="l18.88">                 checkTimezone(item, item.endDate);</span>
<a href="#l18.89"></a><span id="l18.89">                 break;</span>
<a href="#l18.90"></a><span id="l18.90">             case &quot;VTODO&quot;:</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineat">@@ -139,47 +138,59 @@ function ip_parseString(aICSString, aTzP</span>
<a href="#l18.92"></a><span id="l18.92">             if (item) {</span>
<a href="#l18.93"></a><span id="l18.93">                 // Only try to fix ICS from Sunbird 0.2 (and earlier) if it</span>
<a href="#l18.94"></a><span id="l18.94">                 // has an EXDATE.</span>
<a href="#l18.95"></a><span id="l18.95">                 hasExdate = subComp.getFirstProperty(&quot;EXDATE&quot;);</span>
<a href="#l18.96"></a><span id="l18.96">                 if (isFromOldSunbird &amp;&amp; hasExdate) {</span>
<a href="#l18.97"></a><span id="l18.97">                     item = fixOldSunbirdExceptions(item);</span>
<a href="#l18.98"></a><span id="l18.98">                 }</span>
<a href="#l18.99"></a><span id="l18.99"> </span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-                var rid = item.recurrenceId;</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+                let rid = item.recurrenceId;</span>
<a href="#l18.102"></a><span id="l18.102">                 if (!rid) {</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-                    unexpandedItems.push(item);</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+                    this.mItems.push(item);</span>
<a href="#l18.105"></a><span id="l18.105">                     if (item.recurrenceInfo) {</span>
<a href="#l18.106"></a><span id="l18.106">                         uid2parent[item.id] = item;</span>
<a href="#l18.107"></a><span id="l18.107">                     }</span>
<a href="#l18.108"></a><span id="l18.108">                 } else {</span>
<a href="#l18.109"></a><span id="l18.109">                     // force no recurrence info:</span>
<a href="#l18.110"></a><span id="l18.110">                     item.recurrenceInfo = null;</span>
<a href="#l18.111"></a><span id="l18.111">                     excItems.push(item);</span>
<a href="#l18.112"></a><span id="l18.112">                 }</span>
<a href="#l18.113"></a><span id="l18.113">             }</span>
<a href="#l18.114"></a><span id="l18.114">             subComp = calComp.getNextSubcomponent(&quot;ANY&quot;);</span>
<a href="#l18.115"></a><span id="l18.115">         }</span>
<a href="#l18.116"></a><span id="l18.116">         calComp = rootComp.getNextSubcomponent(&quot;VCALENDAR&quot;);</span>
<a href="#l18.117"></a><span id="l18.117">     }</span>
<a href="#l18.118"></a><span id="l18.118"> </span>
<a href="#l18.119"></a><span id="l18.119">     // tag &quot;exceptions&quot;, i.e. items with rid:</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-    for each (var item in excItems) {</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-        var parent = uid2parent[item.id];</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-        if (parent) {</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-            parent.recurrenceInfo.modifyException(item, true);</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-        } else { // a parentless one</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+    for each (let item in excItems) {</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+        let parent = uid2parent[item.id];</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+        if (!parent) { // a parentless one, fake a master and override it's occurrence</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+            parent = isEvent(item) ? createEvent() : createTodo();</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+            parent.id = item.id;</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+            parent.setProperty(&quot;DTSTART&quot;, item.recurrenceId);</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+            parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;); // this tag might be useful in the future</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+            parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+            fakedParents[item.id] = true;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+            uid2parent[item.id] = parent;</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+            this.mItems.push(parent);</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+        }</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+        if (item.id in fakedParents) { </span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+            let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+                                  .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+            rdate.date = item.recurrenceId;</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+            parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+            // we'll keep the parentless-API until we switch over using itip-process for import (e.g. in dnd code)</span>
<a href="#l18.144"></a><span id="l18.144">             this.mParentlessItems.push(item);</span>
<a href="#l18.145"></a><span id="l18.145">         }</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+        parent.recurrenceInfo.modifyException(item, true);</span>
<a href="#l18.148"></a><span id="l18.148">     }</span>
<a href="#l18.149"></a><span id="l18.149">     </span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-    for each (var item in unexpandedItems) {</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-        this.mItems.push(item);</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-    }</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-</span>
<a href="#l18.154"></a><span id="l18.154">     for (let e in tzErrors) { // if any error has occurred</span>
<a href="#l18.155"></a><span id="l18.155">         // Use an alert rather than a prompt because problems may appear in</span>
<a href="#l18.156"></a><span id="l18.156">         // remote subscribed calendars the user cannot change.</span>
<a href="#l18.157"></a><span id="l18.157">         if (Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]) {</span>
<a href="#l18.158"></a><span id="l18.158">             let notifier = Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]</span>
<a href="#l18.159"></a><span id="l18.159">                                      .getService(Components.interfaces.nsIAlertsService);</span>
<a href="#l18.160"></a><span id="l18.160">             let title = calGetString(&quot;calendar&quot;, &quot;TimezoneErrorsAlertTitle&quot;)</span>
<a href="#l18.161"></a><span id="l18.161">             let text = calGetString(&quot;calendar&quot;, &quot;TimezoneErrorsSeeConsole&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/src/calIcsSerializer.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/src/calIcsSerializer.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -30,17 +30,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.5"></a><span id="l19.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.6"></a><span id="l19.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.7"></a><span id="l19.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.8"></a><span id="l19.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.9"></a><span id="l19.9">  *</span>
<a href="#l19.10"></a><span id="l19.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-// Import</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> function calIcsSerializer() {</span>
<a href="#l19.16"></a><span id="l19.16">     this.wrappedJSObject = this;</span>
<a href="#l19.17"></a><span id="l19.17">     this.mItems = [];</span>
<a href="#l19.18"></a><span id="l19.18">     this.mProperties = [];</span>
<a href="#l19.19"></a><span id="l19.19">     this.mComponents = [];</span>
<a href="#l19.20"></a><span id="l19.20"> }</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -97,30 +97,24 @@ function is_serializeToStream(aStream) {</span>
<a href="#l19.23"></a><span id="l19.23">     convStream.close();</span>
<a href="#l19.24"></a><span id="l19.24"> };</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26"> calIcsSerializer.prototype.getIcalComponent =</span>
<a href="#l19.27"></a><span id="l19.27"> function is_getIcalComponent() {</span>
<a href="#l19.28"></a><span id="l19.28">     var calComp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l19.29"></a><span id="l19.29">     calSetProdidVersion(calComp);</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+    // xxx todo: think about that the below code doesn't clone the properties/components,</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    //           thus ownership is moved to returned VCALENDAR...</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+</span>
<a href="#l19.34"></a><span id="l19.34">     for each (var prop in this.mProperties) {</span>
<a href="#l19.35"></a><span id="l19.35">         calComp.addProperty(prop);</span>
<a href="#l19.36"></a><span id="l19.36">     }</span>
<a href="#l19.37"></a><span id="l19.37">     for each (var comp in this.mComponents) {</span>
<a href="#l19.38"></a><span id="l19.38">         calComp.addSubcomponent(comp);</span>
<a href="#l19.39"></a><span id="l19.39">     }</span>
<a href="#l19.40"></a><span id="l19.40"> </span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-    for each (var item in this.mItems) {</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+    for each (let item in cal.itemIterator(this.mItems)) {</span>
<a href="#l19.43"></a><span id="l19.43">         calComp.addSubcomponent(item.icalComponent);</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-        var rec = item.recurrenceInfo;</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-        if (rec != null) {</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-            var exceptions = rec.getExceptionIds({});</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-            for each (var exid in exceptions) {</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-                var ex = rec.getExceptionFor(exid, false);</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-                if (ex != null) {</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-                    calComp.addSubcomponent(ex.icalComponent);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-                }</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-            }</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-        }</span>
<a href="#l19.54"></a><span id="l19.54">     }</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+</span>
<a href="#l19.56"></a><span id="l19.56">     return calComp;</span>
<a href="#l19.57"></a><span id="l19.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,9 +1,8 @@</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l20.5"></a><span id="l20.5"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l20.6"></a><span id="l20.6">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l20.7"></a><span id="l20.7">  *</span>
<a href="#l20.8"></a><span id="l20.8">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l20.9"></a><span id="l20.9">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l20.10"></a><span id="l20.10">  * the License. You may obtain a copy of the License at</span>
<a href="#l20.11"></a><span id="l20.11">  * http://www.mozilla.org/MPL/</span>
<a href="#l20.12"></a><span id="l20.12">  *</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineat">@@ -132,25 +131,27 @@ calItemBase.prototype = {</span>
<a href="#l20.14"></a><span id="l20.14">     mDirty: false,</span>
<a href="#l20.15"></a><span id="l20.15">     modify: function() {</span>
<a href="#l20.16"></a><span id="l20.16">         if (this.mImmutable)</span>
<a href="#l20.17"></a><span id="l20.17">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l20.18"></a><span id="l20.18">         this.mDirty = true;</span>
<a href="#l20.19"></a><span id="l20.19">     },</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21">     ensureNotDirty: function() {</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-        if (!this.mDirty)</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+        if (!this.mDirty) {</span>
<a href="#l20.24"></a><span id="l20.24">             return;</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+        }</span>
<a href="#l20.27"></a><span id="l20.27">         if (this.mImmutable) {</span>
<a href="#l20.28"></a><span id="l20.28">             dump (&quot;### Something tried to undirty a dirty immutable event!\n&quot;);</span>
<a href="#l20.29"></a><span id="l20.29">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l20.30"></a><span id="l20.30">         }</span>
<a href="#l20.31"></a><span id="l20.31"> </span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-        this.setProperty(&quot;LAST-MODIFIED&quot;, jsDateToDateTime(new Date()));</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+        var now = jsDateToDateTime(new Date());</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+        this.setProperty(&quot;LAST-MODIFIED&quot;, now);</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+        this.setProperty(&quot;DTSTAMP&quot;, now.clone());</span>
<a href="#l20.36"></a><span id="l20.36">         this.mDirty = false;</span>
<a href="#l20.37"></a><span id="l20.37">     },</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39">     makeItemBaseImmutable: function() {</span>
<a href="#l20.40"></a><span id="l20.40">         if (this.mImmutable) {</span>
<a href="#l20.41"></a><span id="l20.41">             return;</span>
<a href="#l20.42"></a><span id="l20.42">         }</span>
<a href="#l20.43"></a><span id="l20.43"> </span>
<a href="#l20.44"></a><span id="l20.44" class="difflineat">@@ -197,19 +198,17 @@ calItemBase.prototype = {</span>
<a href="#l20.45"></a><span id="l20.45">     // initialize this class's members</span>
<a href="#l20.46"></a><span id="l20.46">     initItemBase: function () {</span>
<a href="#l20.47"></a><span id="l20.47">         this.wrappedJSObject = this;</span>
<a href="#l20.48"></a><span id="l20.48">         var now = jsDateToDateTime(new Date());</span>
<a href="#l20.49"></a><span id="l20.49"> </span>
<a href="#l20.50"></a><span id="l20.50">         this.mProperties = new calPropertyBag();</span>
<a href="#l20.51"></a><span id="l20.51">         this.mPropertyParams = {};</span>
<a href="#l20.52"></a><span id="l20.52"> </span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-        this.setProperty(&quot;CREATED&quot;, now.clone());</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-        this.setProperty(&quot;LAST-MODIFIED&quot;, now.clone());</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-        this.setProperty(&quot;DTSTAMP&quot;, now);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+        this.setProperty(&quot;CREATED&quot;, now);</span>
<a href="#l20.57"></a><span id="l20.57"> </span>
<a href="#l20.58"></a><span id="l20.58">         this.mAttendees = null;</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60">         this.mRecurrenceInfo = null;</span>
<a href="#l20.61"></a><span id="l20.61"> </span>
<a href="#l20.62"></a><span id="l20.62">         this.mAttachments = null;</span>
<a href="#l20.63"></a><span id="l20.63"> </span>
<a href="#l20.64"></a><span id="l20.64">         this.mRelations = null;</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineat">@@ -217,18 +216,16 @@ calItemBase.prototype = {</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67">     clone: function () {</span>
<a href="#l20.68"></a><span id="l20.68">         return this.cloneShallow(this.mParentItem);</span>
<a href="#l20.69"></a><span id="l20.69">     },</span>
<a href="#l20.70"></a><span id="l20.70"> </span>
<a href="#l20.71"></a><span id="l20.71">     // for subclasses to use; copies the ItemBase's values</span>
<a href="#l20.72"></a><span id="l20.72">     // into m. aNewParent is optional</span>
<a href="#l20.73"></a><span id="l20.73">     cloneItemBaseInto: function (m, aNewParent) {</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-        this.ensureNotDirty();</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-</span>
<a href="#l20.76"></a><span id="l20.76">         m.mImmutable = false;</span>
<a href="#l20.77"></a><span id="l20.77">         m.mIsProxy = this.mIsProxy;</span>
<a href="#l20.78"></a><span id="l20.78">         m.mParentItem = (calTryWrappedJSObject(aNewParent) || this.mParentItem);</span>
<a href="#l20.79"></a><span id="l20.79">         m.mHashId = this.mHashId;</span>
<a href="#l20.80"></a><span id="l20.80">         m.mCalendar = this.mCalendar;</span>
<a href="#l20.81"></a><span id="l20.81">         if (this.mRecurrenceInfo) {</span>
<a href="#l20.82"></a><span id="l20.82">             m.mRecurrenceInfo = calTryWrappedJSObject(this.mRecurrenceInfo.clone());</span>
<a href="#l20.83"></a><span id="l20.83">             m.mRecurrenceInfo.item = m;</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineat">@@ -264,18 +261,16 @@ calItemBase.prototype = {</span>
<a href="#l20.85"></a><span id="l20.85">                 var newBucket = {};</span>
<a href="#l20.86"></a><span id="l20.86">                 for (var param in propBucket) {</span>
<a href="#l20.87"></a><span id="l20.87">                     newBucket[param] = propBucket[param];</span>
<a href="#l20.88"></a><span id="l20.88">                 }</span>
<a href="#l20.89"></a><span id="l20.89">                 m.mPropertyParams[name] = newBucket;</span>
<a href="#l20.90"></a><span id="l20.90">             }</span>
<a href="#l20.91"></a><span id="l20.91">         }</span>
<a href="#l20.92"></a><span id="l20.92"> </span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-        m.mDirty = false;</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-</span>
<a href="#l20.95"></a><span id="l20.95">         if (this.mAttachments) {</span>
<a href="#l20.96"></a><span id="l20.96">             m.mAttachments = this.mAttachments.concat([]);</span>
<a href="#l20.97"></a><span id="l20.97">         }</span>
<a href="#l20.98"></a><span id="l20.98"> </span>
<a href="#l20.99"></a><span id="l20.99">         if (this.mRelations) {</span>
<a href="#l20.100"></a><span id="l20.100">             m.mRelations = this.mRelations.concat([]);</span>
<a href="#l20.101"></a><span id="l20.101">         }</span>
<a href="#l20.102"></a><span id="l20.102"> </span>
<a href="#l20.103"></a><span id="l20.103" class="difflineat">@@ -291,16 +286,18 @@ calItemBase.prototype = {</span>
<a href="#l20.104"></a><span id="l20.104">         }</span>
<a href="#l20.105"></a><span id="l20.105">         if (this.alarmLastAck) {</span>
<a href="#l20.106"></a><span id="l20.106">             m.alarmLastAck = this.alarmLastAck.clone();</span>
<a href="#l20.107"></a><span id="l20.107">         } else {</span>
<a href="#l20.108"></a><span id="l20.108">             m.alarmLastAck = null;</span>
<a href="#l20.109"></a><span id="l20.109">         }</span>
<a href="#l20.110"></a><span id="l20.110">         m.alarmRelated = this.alarmRelated;</span>
<a href="#l20.111"></a><span id="l20.111"> </span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+        m.mDirty = this.mDirty;</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+</span>
<a href="#l20.114"></a><span id="l20.114">         return m;</span>
<a href="#l20.115"></a><span id="l20.115">     },</span>
<a href="#l20.116"></a><span id="l20.116"> </span>
<a href="#l20.117"></a><span id="l20.117">     get alarmOffset() {</span>
<a href="#l20.118"></a><span id="l20.118">         if (this.mIsProxy &amp;&amp; (this.mAlarmOffset === undefined)) {</span>
<a href="#l20.119"></a><span id="l20.119">             return this.parentItem.alarmOffset;</span>
<a href="#l20.120"></a><span id="l20.120">         } else {</span>
<a href="#l20.121"></a><span id="l20.121">             return this.mAlarmOffset;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineat">@@ -326,29 +323,18 @@ calItemBase.prototype = {</span>
<a href="#l20.123"></a><span id="l20.123">     },</span>
<a href="#l20.124"></a><span id="l20.124"> </span>
<a href="#l20.125"></a><span id="l20.125">     get lastModifiedTime() {</span>
<a href="#l20.126"></a><span id="l20.126">         this.ensureNotDirty();</span>
<a href="#l20.127"></a><span id="l20.127">         return this.getProperty(&quot;LAST-MODIFIED&quot;);</span>
<a href="#l20.128"></a><span id="l20.128">     },</span>
<a href="#l20.129"></a><span id="l20.129"> </span>
<a href="#l20.130"></a><span id="l20.130">     get stampTime() {</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-        var prop = this.getProperty(&quot;DTSTAMP&quot;);</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-        if (prop &amp;&amp; prop.isValid)</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-            return prop;</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-        return this.getProperty(&quot;LAST-MODIFIED&quot;);</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-    },</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-    updateStampTime: function() {</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-        // can't update the stamp time on an immutable event</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-        if (this.mImmutable)</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-            return;</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-        this.modify();</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-        this.setProperty(&quot;DTSTAMP&quot;, jsDateToDateTime(new Date()));</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+        this.ensureNotDirty();</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+        return this.getProperty(&quot;DTSTAMP&quot;);</span>
<a href="#l20.146"></a><span id="l20.146">     },</span>
<a href="#l20.147"></a><span id="l20.147"> </span>
<a href="#l20.148"></a><span id="l20.148">     get propertyEnumerator() {</span>
<a href="#l20.149"></a><span id="l20.149">         if (this.mIsProxy) {</span>
<a href="#l20.150"></a><span id="l20.150">             ASSERT(this.parentItem != this);</span>
<a href="#l20.151"></a><span id="l20.151">             return { // nsISimpleEnumerator:</span>
<a href="#l20.152"></a><span id="l20.152">                 mProxyEnum: this.mProperties.enumerator,</span>
<a href="#l20.153"></a><span id="l20.153">                 mParentEnum: this.mParentItem.propertyEnumerator,</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineat">@@ -405,36 +391,38 @@ calItemBase.prototype = {</span>
<a href="#l20.155"></a><span id="l20.155">         return aValue;</span>
<a href="#l20.156"></a><span id="l20.156">     },</span>
<a href="#l20.157"></a><span id="l20.157"> </span>
<a href="#l20.158"></a><span id="l20.158">     hasProperty: function (aName) {</span>
<a href="#l20.159"></a><span id="l20.159">         return (this.getProperty(aName.toUpperCase()) != null);</span>
<a href="#l20.160"></a><span id="l20.160">     },</span>
<a href="#l20.161"></a><span id="l20.161"> </span>
<a href="#l20.162"></a><span id="l20.162">     setProperty: function (aName, aValue) {</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-        if (aName == &quot;LAST-MODIFIED&quot;) {</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-            this.mDirty = false;</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-        } else {</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-            this.modify();</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-        }</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+        this.modify();</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+        aName = aName.toUpperCase();</span>
<a href="#l20.170"></a><span id="l20.170">         if (aValue || !isNaN(parseInt(aValue, 10))) {</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-            this.mProperties.setProperty(aName.toUpperCase(), aValue);</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+            this.mProperties.setProperty(aName, aValue);</span>
<a href="#l20.173"></a><span id="l20.173">         } else {</span>
<a href="#l20.174"></a><span id="l20.174">             this.deleteProperty(aName);</span>
<a href="#l20.175"></a><span id="l20.175">         }</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+        if (aName == &quot;LAST-MODIFIED&quot;) {</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+            // setting LAST-MODIFIED cleans/undirties the item, we use this for preserving DTSTAMP</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+            this.mDirty = false;</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+        }</span>
<a href="#l20.180"></a><span id="l20.180">     },</span>
<a href="#l20.181"></a><span id="l20.181"> </span>
<a href="#l20.182"></a><span id="l20.182">     deleteProperty: function (aName) {</span>
<a href="#l20.183"></a><span id="l20.183">         this.modify();</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+        aName = aName.toUpperCase();</span>
<a href="#l20.185"></a><span id="l20.185">         if (this.mIsProxy) {</span>
<a href="#l20.186"></a><span id="l20.186">             // deleting a proxy's property will mark the bag's item as null, so we could</span>
<a href="#l20.187"></a><span id="l20.187">             // distinguish it when enumerating/getting properties from the undefined ones.</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-            this.mProperties.setProperty(aName.toUpperCase(), null);</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+            this.mProperties.setProperty(aName, null);</span>
<a href="#l20.190"></a><span id="l20.190">         } else {</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-            this.mProperties.deleteProperty(aName.toUpperCase());</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+            this.mProperties.deleteProperty(aName);</span>
<a href="#l20.193"></a><span id="l20.193">         }</span>
<a href="#l20.194"></a><span id="l20.194">     },</span>
<a href="#l20.195"></a><span id="l20.195"> </span>
<a href="#l20.196"></a><span id="l20.196">     getPropertyParameter: function getPP(aPropName, aParamName) {</span>
<a href="#l20.197"></a><span id="l20.197">         return this.mPropertyParams[aPropName][aParamName];</span>
<a href="#l20.198"></a><span id="l20.198">     },</span>
<a href="#l20.199"></a><span id="l20.199"> </span>
<a href="#l20.200"></a><span id="l20.200">     getAttendees: function (countObj) {</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineat">@@ -634,17 +622,18 @@ calItemBase.prototype = {</span>
<a href="#l20.202"></a><span id="l20.202">         &quot;DTSTAMP&quot;: true,</span>
<a href="#l20.203"></a><span id="l20.203">         &quot;RRULE&quot;: true,</span>
<a href="#l20.204"></a><span id="l20.204">         &quot;EXDATE&quot;: true,</span>
<a href="#l20.205"></a><span id="l20.205">         &quot;RDATE&quot;: true,</span>
<a href="#l20.206"></a><span id="l20.206">         &quot;ATTENDEE&quot;: true,</span>
<a href="#l20.207"></a><span id="l20.207">         &quot;ATTACH&quot;: true,</span>
<a href="#l20.208"></a><span id="l20.208">         &quot;CATEGORIES&quot;: true,</span>
<a href="#l20.209"></a><span id="l20.209">         &quot;ORGANIZER&quot;: true,</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-        &quot;RECURRENCE-ID&quot;: true</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+        &quot;RECURRENCE-ID&quot;: true,</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineplus">+        &quot;X-MOZ-LASTACK&quot;: true</span>
<a href="#l20.213"></a><span id="l20.213">     },</span>
<a href="#l20.214"></a><span id="l20.214"> </span>
<a href="#l20.215"></a><span id="l20.215">     icsBasePropMap: [</span>
<a href="#l20.216"></a><span id="l20.216">     { cal: &quot;CREATED&quot;, ics: &quot;createdTime&quot; },</span>
<a href="#l20.217"></a><span id="l20.217">     { cal: &quot;LAST-MODIFIED&quot;, ics: &quot;lastModified&quot; },</span>
<a href="#l20.218"></a><span id="l20.218">     { cal: &quot;DTSTAMP&quot;, ics: &quot;stampTime&quot; },</span>
<a href="#l20.219"></a><span id="l20.219">     { cal: &quot;UID&quot;, ics: &quot;uid&quot; },</span>
<a href="#l20.220"></a><span id="l20.220">     { cal: &quot;SUMMARY&quot;, ics: &quot;summary&quot; },</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineat">@@ -818,18 +807,16 @@ calItemBase.prototype = {</span>
<a href="#l20.222"></a><span id="l20.222">     set generation(aValue) {</span>
<a href="#l20.223"></a><span id="l20.223">         this.modify();</span>
<a href="#l20.224"></a><span id="l20.224">         this.mGeneration = aValue;</span>
<a href="#l20.225"></a><span id="l20.225">         this.setProperty(&quot;X-MOZ-GENERATION&quot;, String(aValue));</span>
<a href="#l20.226"></a><span id="l20.226">         return aValue;</span>
<a href="#l20.227"></a><span id="l20.227">     },</span>
<a href="#l20.228"></a><span id="l20.228"> </span>
<a href="#l20.229"></a><span id="l20.229">     fillIcalComponentFromBase: function (icalcomp) {</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineminus">-        // Make sure that the LMT and ST are updated</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineminus">-        this.updateStampTime();</span>
<a href="#l20.232"></a><span id="l20.232">         this.ensureNotDirty();</span>
<a href="#l20.233"></a><span id="l20.233"> </span>
<a href="#l20.234"></a><span id="l20.234">         this.mapPropsToICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l20.235"></a><span id="l20.235"> </span>
<a href="#l20.236"></a><span id="l20.236">         if (this.mOrganizer)</span>
<a href="#l20.237"></a><span id="l20.237">             icalcomp.addProperty(this.mOrganizer.icalProperty);</span>
<a href="#l20.238"></a><span id="l20.238">         var attendees = this.getAttendees({});</span>
<a href="#l20.239"></a><span id="l20.239">         if (attendees.length &gt; 0) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/src/calItemModule.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/src/calItemModule.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -179,21 +179,16 @@ const componentData =</span>
<a href="#l21.4"></a><span id="l21.4">      script: &quot;calWeekInfoService.js&quot;,</span>
<a href="#l21.5"></a><span id="l21.5">      constructor: &quot;calWeekInfoService&quot;},</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7">     {cid: Components.ID(&quot;{f41392ab-dcad-4bad-818f-b3d1631c4d93}&quot;),</span>
<a href="#l21.8"></a><span id="l21.8">      contractid: &quot;@mozilla.org/calendar/itip-item;1&quot;,</span>
<a href="#l21.9"></a><span id="l21.9">      script: &quot;calItipItem.js&quot;,</span>
<a href="#l21.10"></a><span id="l21.10">      constructor: &quot;calItipItem&quot;},</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    {cid: Components.ID(&quot;{9787876b-0780-4464-8282-b7f86fb221e8}&quot;),</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-     contractid: &quot;@mozilla.org/calendar/itip-processor;1&quot;,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-     script: &quot;calItipProcessor.js&quot;,</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-     constructor: &quot;calItipProcessor&quot;},</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-</span>
<a href="#l21.17"></a><span id="l21.17">     {cid: Components.ID(&quot;{1e2fc0e2-bf5f-4d60-9f1e-5e92cf517c0b}&quot;),</span>
<a href="#l21.18"></a><span id="l21.18">      contractid: &quot;@mozilla.org/network/protocol;1?name=webcal&quot;,</span>
<a href="#l21.19"></a><span id="l21.19">      script: &quot;calProtocolHandler.js&quot;,</span>
<a href="#l21.20"></a><span id="l21.20">      constructor: &quot;calProtocolHandler&quot;},</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22">     {cid: Components.ID(&quot;{b2ee6f91-b061-4527-97a1-b85361775fc1}&quot;),</span>
<a href="#l21.23"></a><span id="l21.23">      contractid: &quot;@mozilla.org/network/protocol;1?name=webcals&quot;,</span>
<a href="#l21.24"></a><span id="l21.24">      script: &quot;calProtocolHandler.js&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/src/calItipItem.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/src/calItipItem.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -38,21 +38,23 @@</span>
<a href="#l22.4"></a><span id="l22.4">  *</span>
<a href="#l22.5"></a><span id="l22.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> /**</span>
<a href="#l22.8"></a><span id="l22.8">  * Constructor of calItipItem object</span>
<a href="#l22.9"></a><span id="l22.9">  */</span>
<a href="#l22.10"></a><span id="l22.10"> function calItipItem() {</span>
<a href="#l22.11"></a><span id="l22.11">     this.wrappedJSObject = this;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    this.mIsInitialized = false;</span>
<a href="#l22.13"></a><span id="l22.13">     this.mCurrentItemIndex = 0;</span>
<a href="#l22.14"></a><span id="l22.14"> }</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16"> calItipItem.prototype = {</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+    mIsInitialized: false,</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+    // nsIClassInfo:</span>
<a href="#l22.20"></a><span id="l22.20">     getInterfaces: function ciiGI(count) {</span>
<a href="#l22.21"></a><span id="l22.21">         var ifaces = [</span>
<a href="#l22.22"></a><span id="l22.22">             Components.interfaces.nsIClassInfo,</span>
<a href="#l22.23"></a><span id="l22.23">             Components.interfaces.nsISupports,</span>
<a href="#l22.24"></a><span id="l22.24">             Components.interfaces.calIItipItem</span>
<a href="#l22.25"></a><span id="l22.25">         ];</span>
<a href="#l22.26"></a><span id="l22.26">         count.value = ifaces.length;</span>
<a href="#l22.27"></a><span id="l22.27">         return ifaces;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineat">@@ -63,79 +65,46 @@ calItipItem.prototype = {</span>
<a href="#l22.29"></a><span id="l22.29">     },</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31">     contractID: &quot;@mozilla.org/calendar/itip-item;1&quot;,</span>
<a href="#l22.32"></a><span id="l22.32">     classDescription: &quot;Calendar iTIP item&quot;,</span>
<a href="#l22.33"></a><span id="l22.33">     classID: Components.ID(&quot;{f41392ab-dcad-4bad-818f-b3d1631c4d93}&quot;),</span>
<a href="#l22.34"></a><span id="l22.34">     implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l22.35"></a><span id="l22.35">     flags: 0,</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-    QueryInterface: function ciiQI(aIid) {</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-        if (!aIid.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-            !aIid.equals(Components.interfaces.calIItipItem)) {</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-        }</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-        return this;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+    QueryInterface: function ciiQI(aIID) {</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+        return doQueryInterface(this, calItipItem.prototype, aIID, null, this);</span>
<a href="#l22.46"></a><span id="l22.46">     },</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48">     mIsSend: false,</span>
<a href="#l22.49"></a><span id="l22.49">     get isSend() {</span>
<a href="#l22.50"></a><span id="l22.50">         return this.mIsSend;</span>
<a href="#l22.51"></a><span id="l22.51">     },</span>
<a href="#l22.52"></a><span id="l22.52">     set isSend(aValue) {</span>
<a href="#l22.53"></a><span id="l22.53">         return (this.mIsSend = aValue);</span>
<a href="#l22.54"></a><span id="l22.54">     },</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-    mReceivedMethod: null,</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+    mReceivedMethod: &quot;REQUEST&quot;,</span>
<a href="#l22.58"></a><span id="l22.58">     get receivedMethod() {</span>
<a href="#l22.59"></a><span id="l22.59">         return this.mReceivedMethod;</span>
<a href="#l22.60"></a><span id="l22.60">     },</span>
<a href="#l22.61"></a><span id="l22.61">     set receivedMethod(aMethod) {</span>
<a href="#l22.62"></a><span id="l22.62">         return (this.mReceivedMethod = aMethod.toUpperCase());</span>
<a href="#l22.63"></a><span id="l22.63">     },</span>
<a href="#l22.64"></a><span id="l22.64"> </span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-    mResponseMethod: null,</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+    mResponseMethod: &quot;REPLY&quot;,</span>
<a href="#l22.67"></a><span id="l22.67">     get responseMethod() {</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-        if (this.mIsInitialized) {</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-            var method = null;</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-            for each (var prop in this.mPropertiesList) {</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-                if (prop.propertyName == &quot;METHOD&quot;) {</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-                    method = prop.value;</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-                    break;</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-                }</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-            }</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-            return method;</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-        } else {</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-        }</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-    },</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-    set responseMethod(aMethod) {</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-        this.mResponseMethod = aMethod.toUpperCase();</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-        // Setting this also sets the global method attribute inside the</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-        // encapsulated VCALENDAR.</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-        if (this.mIsInitialized) {</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-            var methodExists = false;</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-            for each (var prop in this.mPropertiesList) {</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-                if (prop.propertyName == &quot;METHOD&quot;) {</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-                    methodExists = true;</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-                    prop.value = this.mResponseMethod;</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-                }</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-            }</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-            if (!methodExists) {</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-                var newProp = { propertyName: &quot;METHOD&quot;,</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-                                value: this.mResponseMethod };</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-                this.mPropertiesList.push(newProp);</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-            }</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-        } else {</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+        if (!this.mIsInitialized) {</span>
<a href="#l22.101"></a><span id="l22.101">             throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l22.102"></a><span id="l22.102">         }</span>
<a href="#l22.103"></a><span id="l22.103">         return this.mResponseMethod;</span>
<a href="#l22.104"></a><span id="l22.104">     },</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+    set responseMethod(aMethod) {</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+        return (this.mResponseMethod = aMethod.toUpperCase());</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+    },</span>
<a href="#l22.108"></a><span id="l22.108"> </span>
<a href="#l22.109"></a><span id="l22.109">     mAutoResponse: null,</span>
<a href="#l22.110"></a><span id="l22.110">     get autoResponse() {</span>
<a href="#l22.111"></a><span id="l22.111">         return this.mAutoResponse;</span>
<a href="#l22.112"></a><span id="l22.112">     },</span>
<a href="#l22.113"></a><span id="l22.113">     set autoResponse(aValue) {</span>
<a href="#l22.114"></a><span id="l22.114">         return (this.mAutoResponse = aValue);</span>
<a href="#l22.115"></a><span id="l22.115">     },</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineat">@@ -159,131 +128,119 @@ calItipItem.prototype = {</span>
<a href="#l22.117"></a><span id="l22.117">     mLocalStatus: null,</span>
<a href="#l22.118"></a><span id="l22.118">     get localStatus() {</span>
<a href="#l22.119"></a><span id="l22.119">         return this.mLocalStatus;</span>
<a href="#l22.120"></a><span id="l22.120">     },</span>
<a href="#l22.121"></a><span id="l22.121">     set localStatus(aValue) {</span>
<a href="#l22.122"></a><span id="l22.122">         return (this.mLocalStatus = aValue);</span>
<a href="#l22.123"></a><span id="l22.123">      },</span>
<a href="#l22.124"></a><span id="l22.124"> </span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-    modifyItem: function ciiMI(item) {</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-        // Bug 348666: This will be used when we support delegation and COUNTER.</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-    },</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-    mItemList: null,</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-    mPropertiesList: null,</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+    mItemList: {},</span>
<a href="#l22.133"></a><span id="l22.133"> </span>
<a href="#l22.134"></a><span id="l22.134">     init: function ciiI(aIcalString) {</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-        var parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;].</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-                     createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineplus">+        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineplus">+                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l22.139"></a><span id="l22.139">         parser.parseString(aIcalString, null);</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-        this.mItemList = parser.getItems({});</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-        this.mPropertiesList = parser.getProperties({});</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineplus">+</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+        // - User specific alarms as well as X-MOZ- properties are irrelevant w.r.t. iTIP messages,</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineplus">+        //   should not be sent out and should not be relevant for incoming messages</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineplus">+        // - faked master items</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineplus">+        // so clean them out:</span>
<a href="#l22.147"></a><span id="l22.147"> </span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-        // User specific alarms as well as X-MOZ- properties are irrelevant w.r.t. iTIP messages,</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-        // should not be sent out and should not be relevant for incoming messages,</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-        // so clean them out:</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-        for each (var item in this.mItemList) {</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+        function cleanItem(item) {</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineplus">+            // the following changes will bump LAST-MODIFIED/DTSTAMP, we want to preserve the originals:</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineplus">+            let stamp = item.stampTime;</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineplus">+            let lastModified = item.lastModifiedTime;</span>
<a href="#l22.156"></a><span id="l22.156">             item.alarmOffset = null;</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-            var propEnum = item.propertyEnumerator;</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineplus">+            item.alarmLastAck = null;</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineplus">+            item.deleteProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+            item.deleteProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineplus">+            let propEnum = item.propertyEnumerator;</span>
<a href="#l22.162"></a><span id="l22.162">             while (propEnum.hasMoreElements()) {</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-                var prop = propEnum.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-                if (prop.name.substr(0, &quot;X-MOZ-&quot;.length) == &quot;X-MOZ-&quot;) {</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+                let prop = propEnum.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+                let pname = prop.name;</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineplus">+                if (pname != &quot;X-MOZ-FAKED-MASTER&quot; &amp;&amp; pname.substr(0, &quot;X-MOZ-&quot;.length) == &quot;X-MOZ-&quot;) {</span>
<a href="#l22.168"></a><span id="l22.168">                     item.deleteProperty(prop.name);</span>
<a href="#l22.169"></a><span id="l22.169">                 }</span>
<a href="#l22.170"></a><span id="l22.170">             }</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineplus">+            // never publish an organizer's RECEIVED params:</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+            item.getAttendees({}).forEach(</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+                function(att) {</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+                    att.deleteProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+                    att.deleteProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+                });</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineplus">+            item.setProperty(&quot;DTSTAMP&quot;, stamp);</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineplus">+            item.setProperty(&quot;LAST-MODIFIED&quot;, lastModified); // need to be last to undirty the item</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+        }</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+        this.mItemList = [];</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+        for each (let item in cal.itemIterator(parser.getItems({}))) {</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+            cleanItem(item);</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+            // only push non-faked master items or</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+            // the overridden instances of faked master items</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+            // to the list:</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+            if (item == item.parentItem) {</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+                if (!item.hasProperty(&quot;X-MOZ-FAKED-MASTER&quot;)) {</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+                    this.mItemList.push(item);</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+                }</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+            } else if (item.parentItem.hasProperty(&quot;X-MOZ-FAKED-MASTER&quot;)) {</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+                this.mItemList.push(item);</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+            }</span>
<a href="#l22.194"></a><span id="l22.194">         }</span>
<a href="#l22.195"></a><span id="l22.195"> </span>
<a href="#l22.196"></a><span id="l22.196">         // We set both methods now for safety's sake. It's the ItipProcessor's</span>
<a href="#l22.197"></a><span id="l22.197">         // responsibility to properly ascertain what the correct response</span>
<a href="#l22.198"></a><span id="l22.198">         // method is (using user feedback, prefs, etc.) for the given</span>
<a href="#l22.199"></a><span id="l22.199">         // receivedMethod.  The RFC tells us to treat items without a METHOD</span>
<a href="#l22.200"></a><span id="l22.200">         // as if they were METHOD:REQUEST.</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineminus">-        var method;</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineminus">-        for each (var prop in this.mPropertiesList) {</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineplus">+        for each (var prop in parser.getProperties({})) {</span>
<a href="#l22.204"></a><span id="l22.204">             if (prop.propertyName == &quot;METHOD&quot;) {</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineminus">-                method = prop.value;</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineplus">+                this.mReceivedMethod = prop.value;</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineplus">+                this.mResponseMethod = prop.value;</span>
<a href="#l22.208"></a><span id="l22.208">                 break;</span>
<a href="#l22.209"></a><span id="l22.209">             }</span>
<a href="#l22.210"></a><span id="l22.210">         }</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineminus">-        this.mReceivedMethod = method;</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineminus">-        this.mResponseMethod = method;</span>
<a href="#l22.213"></a><span id="l22.213"> </span>
<a href="#l22.214"></a><span id="l22.214">         this.mIsInitialized = true;</span>
<a href="#l22.215"></a><span id="l22.215">     },</span>
<a href="#l22.216"></a><span id="l22.216"> </span>
<a href="#l22.217"></a><span id="l22.217">     clone: function ciiC() {</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineminus">-        // Iterate through all the calItems in the original calItipItem to</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineminus">-        // concatenate all the calItems' icalStrings.</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineminus">-        var icalString = &quot;&quot;;</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineminus">-</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineminus">-        var itemList = this.getItemList({ });</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineminus">-        for (var i = 0; i &lt; itemList.length; i++) {</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineminus">-            icalString += itemList[i].icalString;</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineminus">-        }</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineminus">-</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineminus">-        // Create a new calItipItem and initialize it using the icalString</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineminus">-        // from above.</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineminus">-        var newItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;].</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineminus">-                      createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineminus">-        newItem.init(icalString);</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineminus">-</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineminus">-        // Copy over the exposed attributes.</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineminus">-        newItem.receivedMethod = this.receivedMethod;</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineminus">-        newItem.responseMethod = this.responseMethod;</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineminus">-        newItem.autoResponse = this.autoResponse;</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineminus">-        newItem.targetCalendar = this.targetCalendar;</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineminus">-        newItem.identity = this.identity;</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineminus">-        newItem.localStatus = this.localStatus;</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineminus">-        newItem.isSend = this.isSend;</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineminus">-</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineplus">+        let newItem = new calItipItem();</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineplus">+        newItem.mItemList = this.mItemList.map(function(item) { return item.clone(); });</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineplus">+        newItem.mReceivedMethod = this.mReceivedMethod;</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineplus">+        newItem.mResponseMethod = this.mResponseMethod;</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineplus">+        newItem.mAutoResponse = this.mAutoResponse;</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineplus">+        newItem.mTargetCalendar = this.mTargetCalendar;</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineplus">+        newItem.mIdentity = this.mIdentity;</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineplus">+        newItem.mLocalStatus = this.mLocalStatus;</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineplus">+        newItem.mIsSend = this.mIsSend;</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineplus">+        newItem.mIsInitialized = this.mIsInitialized;</span>
<a href="#l22.252"></a><span id="l22.252">         return newItem;</span>
<a href="#l22.253"></a><span id="l22.253">     },</span>
<a href="#l22.254"></a><span id="l22.254"> </span>
<a href="#l22.255"></a><span id="l22.255">     /**</span>
<a href="#l22.256"></a><span id="l22.256">      * This returns both the array and the number of items. An easy way to</span>
<a href="#l22.257"></a><span id="l22.257">      * call it is: var itemArray = itipItem.getItemList({ });</span>
<a href="#l22.258"></a><span id="l22.258">      */</span>
<a href="#l22.259"></a><span id="l22.259">     getItemList: function ciiGIL(itemCountRef) {</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineminus">-        if (!this.mIsInitialized || (this.mItemList.length == 0)) {</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+        if (!this.mIsInitialized) {</span>
<a href="#l22.262"></a><span id="l22.262">             throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l22.263"></a><span id="l22.263">         }</span>
<a href="#l22.264"></a><span id="l22.264">         itemCountRef.value = this.mItemList.length;</span>
<a href="#l22.265"></a><span id="l22.265">         return this.mItemList;</span>
<a href="#l22.266"></a><span id="l22.266">     },</span>
<a href="#l22.267"></a><span id="l22.267"> </span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-    /*getFirstItem: function ciiGFI() {</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineminus">-        if (!this.mIsInitialized || (this.mItemList.length == 0)) {</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineminus">-        }</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineminus">-        this.mCurrentItemIndex = 0;</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineminus">-        return this.mItemList[0];</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineminus">-    },</span>
<a href="#l22.275"></a><span id="l22.275" class="difflineminus">-</span>
<a href="#l22.276"></a><span id="l22.276" class="difflineminus">-    getNextItem: function ciiGNI() {</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineminus">-        if (!this.mIsInitialized || (this.mItemList.length == 0)) {</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l22.279"></a><span id="l22.279" class="difflineminus">-        }</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineminus">-        ++this.mCurrentItemIndex;</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineminus">-        if (this.mCurrentItemIndex &lt; this.mItemList.length) {</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineminus">-            return this.mItemList[this.mCurrentItemIndex];</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineminus">-        } else {</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineminus">-            return null;</span>
<a href="#l22.285"></a><span id="l22.285" class="difflineminus">-        }</span>
<a href="#l22.286"></a><span id="l22.286" class="difflineminus">-    },*/</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineminus">-</span>
<a href="#l22.288"></a><span id="l22.288">     /**</span>
<a href="#l22.289"></a><span id="l22.289">      * Note that this code forces the user to respond to all items in the same</span>
<a href="#l22.290"></a><span id="l22.290">      * way, which is a current limitation of the spec.</span>
<a href="#l22.291"></a><span id="l22.291">      */</span>
<a href="#l22.292"></a><span id="l22.292">     setAttendeeStatus: function ciiSAS(aAttendeeId, aStatus) {</span>
<a href="#l22.293"></a><span id="l22.293">         // Append &quot;mailto:&quot; to the attendee if it is missing it.</span>
<a href="#l22.294"></a><span id="l22.294">         aAttendeeId = aAttendeeId.toLowerCase();</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineminus">-        if (!aAttendeeId.match(/mailto:/i)) {</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineplus">+        if (!aAttendeeId.match(/^mailto:/i)) {</span>
<a href="#l22.297"></a><span id="l22.297">             aAttendeeId = (&quot;mailto:&quot; + aAttendeeId);</span>
<a href="#l22.298"></a><span id="l22.298">         }</span>
<a href="#l22.299"></a><span id="l22.299"> </span>
<a href="#l22.300"></a><span id="l22.300">         for each (var item in this.mItemList) {</span>
<a href="#l22.301"></a><span id="l22.301">             var attendee = item.getAttendeeById(aAttendeeId);</span>
<a href="#l22.302"></a><span id="l22.302">             if (attendee) {</span>
<a href="#l22.303"></a><span id="l22.303">                 // Replies should not have the RSVP property.</span>
<a href="#l22.304"></a><span id="l22.304">                 // XXX BUG 351589: workaround for updating an attendee</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">deleted file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- a/calendar/base/src/calItipProcessor.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ /dev/null</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -1,444 +0,0 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">- *</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">- *</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">- * License.</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">- *</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">- * The Original Code is Simdesk Technologies code.</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">- *</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">- * The Initial Developer of the Original Code is Simdesk Technologies Inc.</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">- *</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">- *   Clint Talbert &lt;ctalbert.moz@gmail.com&gt;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">- *   Eva Or &lt;evaor1012@yahoo.ca&gt;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">- *   Matthew Willis &lt;lilmatt@mozilla.com&gt;</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">- *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">- *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">- *</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">- *</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-// Operations on the calendar</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-const CAL_ITIP_PROC_ADD_OP = 1;</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-const CAL_ITIP_PROC_UPDATE_OP = 2;</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-const CAL_ITIP_PROC_DELETE_OP = 3;</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-/**</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">- * Constructor of calItipItem object</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">- */</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-function calItipProcessor() {</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-    this.wrappedJSObject = this;</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-}</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-calItipProcessor.prototype = {</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-    getInterfaces: function cipGI(count) {</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-        var ifaces = [</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-            Components.interfaces.nsIClassInfo,</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-            Components.interfaces.nsISupports,</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-            Components.interfaces.calIItipProcessor</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-        ];</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-        return ifaces;</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-    },</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-    getHelperForLanguage: function cipGHFL(aLanguage) {</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-        return null;</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-    },</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/itip-processor;1&quot;,</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-    classDescription: &quot;Calendar iTIP processor&quot;,</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineminus">-    classID: Components.ID(&quot;{9787876b-0780-4464-8282-b7f86fb221e8}&quot;),</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-    flags: 0,</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-    QueryInterface: function cipQI(aIid) {</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-        if (!aIid.equals(Components.interfaces.nsIClassInfo) &amp;&amp;</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-            !aIid.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-            !aIid.equals(Components.interfaces.calIItipProcessor))</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-        {</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-        }</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-        return this;</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-    },</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-    mIsUserInvolved: false,</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-    get isUserInvolved() {</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-        return this.mIsUserInvolved;</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-    },</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineminus">-    set isUserInvolved(aValue) {</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-        return (this.mIsUserInvolved = aValue);</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineminus">-    },</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-    /**</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-     * Processes the given calItipItem based on the settings inside it.</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-     * @param calIItipItem  A calItipItem to process.</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-     * @param calIOperationListener A calIOperationListener to return status</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-     * @return boolean  Whether processing succeeded or not.</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-     */</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-    processItipItem: function cipPII(aItipItem, aListener) {</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-        // Sanity check the input</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-        if (!aItipItem) {</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineminus">-            throw new Components.Exception(&quot;processItipItem: &quot; +</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-                                           &quot;Invalid or non-existant &quot; +</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-                                           &quot;itipItem passed in.&quot;,</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-                                           Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-        }</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-        // Clone the passed in itipItem like a sheep.</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-        var respItipItem = aItipItem.clone();</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-        var recvMethod = respItipItem.receivedMethod;</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-        respItipItem.responseMethod = this._suggestResponseMethod(recvMethod);</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-        var respMethod = respItipItem.responseMethod;</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-        var autoResponse = respItipItem.autoResponse;</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-        var targetCalendar = respItipItem.targetCalendar;</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-        // Sanity checks using the first item</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineminus">-        var itemList = respItipItem.getItemList({ });</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineminus">-        var calItem = itemList[0];</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-        if (!calItem) {</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-            throw new Error (&quot;processItipItem: &quot; +</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-                             &quot;getFirstItem() found no items!&quot;);</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-        }</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-        var calItemType = this._getCalItemType(calItem);</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-        if (!calItemType) {</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineminus">-            throw new Error (&quot;processItipItem: &quot; +</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-                             &quot;_getCalItemType() found no item type!&quot;);</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-        }</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-        // Sanity check that mRespMethod is a valid response per the spec.</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-        if (!this._isValidResponseMethod(recvMethod, respMethod, calItemType)) {</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineminus">-            throw new Error (&quot;processItipItem: &quot; +</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-                             &quot;_isValidResponseMethod() found an invalid &quot; +</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-                             &quot;response method: &quot; + respMethod);</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-        }</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineminus">-        // Check to see if we have an existing item or not, then continue</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineminus">-        // processing appropriately</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-        for (var i = 0; i &lt; itemList.length; i++) {</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-            this._isExistingItem(itemList[i], aItipItem, recvMethod, respMethod,</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-                                 targetCalendar, aListener);</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-        }</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-        // Send the appropriate response</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-        // figure out a good way to determine when a response is needed!</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-        if (recvMethod != respMethod) {</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-            // XXX discuss: does it make sense to check targetCalendar.canNotify(respMethod, ...) here?</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineminus">-            //              _isExistingItem will store the item</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-            this._getTransport(targetCalendar).sendItems(1, [calItem.organizer], respItipItem);</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineminus">-        }</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineminus">-    },</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-    /* Continue processing the iTip Item now that we have determined whether</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-     * there is an existing item or not.</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-     */</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-    _continueProcessingItem: function cipCPI(newItem, existingItem, aItipItem,</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-                                             recvMethod, respMethod, calAction,</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-                                             targetCalendar, aListener) {</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-        var invitedAttendee = null;</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-        // we should make calISchedulingSupport mandatory</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-        if (calInstanceOf(newItem.calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-            invitedAttendee = newItem.calendar.getInvitedAttendee(newItem);</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-        }</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-        if (!invitedAttendee &amp;&amp; aItipItem.identity) { // try to fall back to itip item's identity</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-            invitedAttendee = newItem.getAttendeeById(this._getTransport(aItipItem.targetCalendar).scheme + &quot;:&quot; +</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-                                                      aItipItem.identity);</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-        }</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineminus">-</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-        switch (recvMethod) {</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-            case &quot;REQUEST&quot;:</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-                if (invitedAttendee) {</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-                    // Only add to calendar if we accepted invite</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-                    if (invitedAttendee.participationStatus == &quot;DECLINED&quot;) {</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-                        break;</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-                    }</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-                } else {</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-                    LOG(&quot;no attendee found.&quot;);</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-                    return;</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-                } // else fall through</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-            case &quot;PUBLISH&quot;:</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-                if (!this._processCalendarAction(newItem,</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-                                                 existingItem,</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineminus">-                                                 calAction,</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-                                                 targetCalendar,</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-                                                 aListener))</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-                {</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-                    throw new Error (&quot;processItipItem: &quot; +</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-                                     &quot;_processCalendarAction failed!&quot;);</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-                }</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineminus">-                break;</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-            case &quot;REPLY&quot;:</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-            case &quot;REFRESH&quot;:</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-            case &quot;ADD&quot;:</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-            case &quot;CANCEL&quot;:</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineminus">-            case &quot;COUNTER&quot;:</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineminus">-            case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineminus">-                throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineminus">-</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineminus">-            default:</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineminus">-                throw new Error(&quot;processItipItem: &quot; +</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-                                &quot;Received unknown method: &quot; +</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineminus">-                                recvMethod);</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineminus">-        }</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineminus">-        // The below is somehow hard to understand --</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineminus">-        // _isExistingItem modifies the itip item's calendar items, we should change that.</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineminus">-        // Moreover it doesn't work if getItem is performed async.</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineminus">-        // TODO bug 431127: This is email specific -&gt; Move to transport</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineminus">-        // When replying, the reply must only contain the ORGANIZER and the</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineminus">-        // status of the ATTENDEE that represents ourselves. Therefore we must</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineminus">-        // remove all other ATTENDEEs from the itipItem we send back.</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineminus">-        if (respMethod == &quot;REPLY&quot;) {</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineminus">-            // Get the id that represents me.</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineminus">-            newItem.removeAllAttendees();</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineminus">-            ASSERT(invitedAttendee, &quot;attendee unknown!&quot;);</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineminus">-            newItem.addAttendee(invitedAttendee);</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineminus">-        }</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineminus">-    },</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineminus">-</span>
<a href="#l23.228"></a><span id="l23.228" class="difflineminus">-</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineminus">-    /**</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-     * @return integer  The next recommended iTIP state.</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-     */</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineminus">-    _suggestResponseMethod: function cipSRM(aRecvMethod) {</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineminus">-        switch (aRecvMethod) {</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-            case &quot;REQUEST&quot;:</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-                return &quot;REPLY&quot;;</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-            case &quot;REFRESH&quot;:</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-            case &quot;COUNTER&quot;:</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-                return &quot;REQUEST&quot;;</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-            case &quot;PUBLISH&quot;:</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineminus">-            case &quot;REPLY&quot;:</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-            case &quot;ADD&quot;:</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineminus">-            case &quot;CANCEL&quot;:</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineminus">-            case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineminus">-                return aRecvMethod;</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineminus">-</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-            default:</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-                throw new Error(&quot;_suggestResponseMethod: &quot; +</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-                                &quot;Received unknown method: &quot; +</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-                                aRecvMethod);</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineminus">-        }</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-    },</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineminus">-</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineminus">-    /**</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineminus">-     * Given mRecvMethod and mRespMethod, this checks that mRespMethod is</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineminus">-     * valid according to the spec.</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineminus">-     *</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-     * @return boolean  Whether or not mRespMethod is valid.</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineminus">-     */</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-    _isValidResponseMethod: function cipIAR(aRecvMethod,</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineminus">-                                            aRespMethod,</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineminus">-                                            aCalItemType) {</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineminus">-        switch (aRecvMethod) {</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineminus">-            // We set response to ADD automatically, but if the GUI did not</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineminus">-            // find the event the user may set it to REFRESH as per the spec.</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineminus">-            // These are the only two valid responses.</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineminus">-            case &quot;ADD&quot;:</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineminus">-                if (!(aRespMethod == &quot;ADD&quot; ||</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineminus">-                     (aRespMethod == &quot;REFRESH&quot; &amp;&amp;</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineminus">-                     // REFRESH is not a valid response to an ADD for VJOURNAL</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineminus">-                     (aCalItemType == Components.interfaces.calIEvent ||</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineminus">-                      aCalItemType == Components.interfaces.calITodo))))</span>
<a href="#l23.274"></a><span id="l23.274" class="difflineminus">-                {</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineminus">-                    return false;</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineminus">-                }</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineminus">-                break;</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineminus">-</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineminus">-            // Valid responses to COUNTER are REQUEST or DECLINECOUNTER.</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineminus">-            case &quot;COUNTER&quot;:</span>
<a href="#l23.281"></a><span id="l23.281" class="difflineminus">-                if (!(aRespMethod == &quot;REQUEST&quot; ||</span>
<a href="#l23.282"></a><span id="l23.282" class="difflineminus">-                      aRespMethod == &quot;DECLINECOUNTER&quot;))</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineminus">-                {</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineminus">-                    return false;</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineminus">-                }</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineminus">-                break;</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineminus">-</span>
<a href="#l23.288"></a><span id="l23.288" class="difflineminus">-            // Valid responses to REQUEST are:</span>
<a href="#l23.289"></a><span id="l23.289" class="difflineminus">-            //     REPLY   (accept or error)</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-            //     REQUEST (delegation, inviting someone else)</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineminus">-            //     COUNTER (propose a change)</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineminus">-            case &quot;REQUEST&quot;:</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineminus">-                if (!(aRespMethod == &quot;REPLY&quot; ||</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineminus">-                      aRespMethod == &quot;REQUEST&quot; ||</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineminus">-                      aRespMethod == &quot;COUNTER&quot;))</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineminus">-                {</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineminus">-                    return false;</span>
<a href="#l23.298"></a><span id="l23.298" class="difflineminus">-                }</span>
<a href="#l23.299"></a><span id="l23.299" class="difflineminus">-                break;</span>
<a href="#l23.300"></a><span id="l23.300" class="difflineminus">-</span>
<a href="#l23.301"></a><span id="l23.301" class="difflineminus">-            // REFRESH should respond with a request</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineminus">-            case &quot;REFRESH&quot;:</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineminus">-                if (aRespMethod == &quot;REQUEST&quot;) {</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineminus">-                    return false;</span>
<a href="#l23.305"></a><span id="l23.305" class="difflineminus">-                }</span>
<a href="#l23.306"></a><span id="l23.306" class="difflineminus">-                break;</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineminus">-</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineminus">-            // The rest are easiest represented as:</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineminus">-            //     (aRecvMethod != aRespMethod) == return false</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineminus">-            case &quot;PUBLISH&quot;:</span>
<a href="#l23.311"></a><span id="l23.311" class="difflineminus">-            case &quot;CANCEL&quot;:</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineminus">-            case &quot;REPLY&quot;:</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineminus">-            case &quot;PUBLISH&quot;:</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineminus">-            case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineminus">-                if (aRespMethod != aRecvMethod) {</span>
<a href="#l23.316"></a><span id="l23.316" class="difflineminus">-                    return false;</span>
<a href="#l23.317"></a><span id="l23.317" class="difflineminus">-                }</span>
<a href="#l23.318"></a><span id="l23.318" class="difflineminus">-                break;</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineminus">-</span>
<a href="#l23.320"></a><span id="l23.320" class="difflineminus">-            default:</span>
<a href="#l23.321"></a><span id="l23.321" class="difflineminus">-                throw new Error(&quot;_isValidResponseMethod: &quot; +</span>
<a href="#l23.322"></a><span id="l23.322" class="difflineminus">-                                &quot;Received unknown method: &quot; +</span>
<a href="#l23.323"></a><span id="l23.323" class="difflineminus">-                                aRecvMethod);</span>
<a href="#l23.324"></a><span id="l23.324" class="difflineminus">-        }</span>
<a href="#l23.325"></a><span id="l23.325" class="difflineminus">-</span>
<a href="#l23.326"></a><span id="l23.326" class="difflineminus">-        // If we got to here, then the combination is valid.</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineminus">-        return true;</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineminus">-    },</span>
<a href="#l23.329"></a><span id="l23.329" class="difflineminus">-</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineminus">-    /**</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineminus">-     * Helper to return whether an item is an event, todo, etc.</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineminus">-     */</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineminus">-    _getCalItemType: function cipGCIT(aCalItem) {</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineminus">-        if (isEvent(aCalItem)) {</span>
<a href="#l23.335"></a><span id="l23.335" class="difflineminus">-            return Components.interfaces.calIEvent;</span>
<a href="#l23.336"></a><span id="l23.336" class="difflineminus">-        } else if (isToDo(aCalItem)) {</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineminus">-            return Components.interfaces.calITodo;</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineminus">-        }</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineminus">-</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineminus">-        throw new Error (&quot;_getCalItemType: &quot; +</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineminus">-                         &quot;mCalItem item type is unknown&quot;);</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineminus">-    },</span>
<a href="#l23.343"></a><span id="l23.343" class="difflineminus">-</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineminus">-    /**</span>
<a href="#l23.345"></a><span id="l23.345" class="difflineminus">-     * This performs the actual add/update/delete of an event on the user's</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineminus">-     * calendar.</span>
<a href="#l23.347"></a><span id="l23.347" class="difflineminus">-     */</span>
<a href="#l23.348"></a><span id="l23.348" class="difflineminus">-    _processCalendarAction: function cipPCA(aCalItem,</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineminus">-                                            aExistingItem,</span>
<a href="#l23.350"></a><span id="l23.350" class="difflineminus">-                                            aOperation,</span>
<a href="#l23.351"></a><span id="l23.351" class="difflineminus">-                                            aTargetCalendar,</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineminus">-                                            aListener) {</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineminus">-        switch (aOperation) {</span>
<a href="#l23.354"></a><span id="l23.354" class="difflineminus">-            case CAL_ITIP_PROC_ADD_OP:</span>
<a href="#l23.355"></a><span id="l23.355" class="difflineminus">-                aTargetCalendar.addItem(aCalItem, aListener);</span>
<a href="#l23.356"></a><span id="l23.356" class="difflineminus">-</span>
<a href="#l23.357"></a><span id="l23.357" class="difflineminus">-                // XXX Change this to reflect the success or failure of adding</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineminus">-                //     the item to the calendar.</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineminus">-                return true;</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineminus">-</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineminus">-            case CAL_ITIP_PROC_UPDATE_OP:</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineminus">-                // To udpate, we must require the existing item to be set</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineminus">-                if (!aExistingItem)</span>
<a href="#l23.364"></a><span id="l23.364" class="difflineminus">-                    throw new Error(&quot;_processCalendarAction: Item to update not found&quot;);</span>
<a href="#l23.365"></a><span id="l23.365" class="difflineminus">-</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineminus">-                // TODO: Handle generation properly - Bug 418345</span>
<a href="#l23.367"></a><span id="l23.367" class="difflineminus">-                aCalItem.generation = aExistingItem.generation;</span>
<a href="#l23.368"></a><span id="l23.368" class="difflineminus">-                // We also have to ensure that the calendar is set properly on</span>
<a href="#l23.369"></a><span id="l23.369" class="difflineminus">-                // the new item, or items with alarms will throw during the</span>
<a href="#l23.370"></a><span id="l23.370" class="difflineminus">-                // notification process</span>
<a href="#l23.371"></a><span id="l23.371" class="difflineminus">-                aCalItem.calendar = aExistingItem.calendar;</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineminus">-                aTargetCalendar.modifyItem(aCalItem, aExistingItem, aListener);</span>
<a href="#l23.373"></a><span id="l23.373" class="difflineminus">-                return true;</span>
<a href="#l23.374"></a><span id="l23.374" class="difflineminus">-</span>
<a href="#l23.375"></a><span id="l23.375" class="difflineminus">-            case CAL_ITIP_PROC_DELETE_OP:</span>
<a href="#l23.376"></a><span id="l23.376" class="difflineminus">-                throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l23.377"></a><span id="l23.377" class="difflineminus">-</span>
<a href="#l23.378"></a><span id="l23.378" class="difflineminus">-            default:</span>
<a href="#l23.379"></a><span id="l23.379" class="difflineminus">-                throw new Error(&quot;_processCalendarAction: &quot; +</span>
<a href="#l23.380"></a><span id="l23.380" class="difflineminus">-                                &quot;Undefined Operation: &quot; + aOperation);</span>
<a href="#l23.381"></a><span id="l23.381" class="difflineminus">-        }</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineminus">-</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineminus">-        // If you got to here, something went horribly, horribly wrong.</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineminus">-        return false;</span>
<a href="#l23.385"></a><span id="l23.385" class="difflineminus">-    },</span>
<a href="#l23.386"></a><span id="l23.386" class="difflineminus">-</span>
<a href="#l23.387"></a><span id="l23.387" class="difflineminus">-    /**</span>
<a href="#l23.388"></a><span id="l23.388" class="difflineminus">-     * Helper function to determine if this item already exists on this calendar</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineminus">-     * or not.  It then calls _continueProcessingItem setting calAction and</span>
<a href="#l23.390"></a><span id="l23.390" class="difflineminus">-     * existingItem appropirately</span>
<a href="#l23.391"></a><span id="l23.391" class="difflineminus">-     */</span>
<a href="#l23.392"></a><span id="l23.392" class="difflineminus">-    _isExistingItem: function cipIEI(aCalItem, aItipItem, aRecvMethod, aRespMethod,</span>
<a href="#l23.393"></a><span id="l23.393" class="difflineminus">-                                     aTargetCal, aListener) {</span>
<a href="#l23.394"></a><span id="l23.394" class="difflineminus">-        var foundItemListener = {</span>
<a href="#l23.395"></a><span id="l23.395" class="difflineminus">-            itipProcessor: this,</span>
<a href="#l23.396"></a><span id="l23.396" class="difflineminus">-            mFoundItem: null,</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineminus">-            onOperationComplete:</span>
<a href="#l23.398"></a><span id="l23.398" class="difflineminus">-            function (aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineminus">-                if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l23.400"></a><span id="l23.400" class="difflineminus">-                    this.itipProcessor._continueProcessingItem(aCalItem,</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineminus">-                                                               this.mFoundItem,</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineminus">-                                                               aItipItem,</span>
<a href="#l23.403"></a><span id="l23.403" class="difflineminus">-                                                               aRecvMethod,</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineminus">-                                                               aRespMethod,</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineminus">-                                                               (this.mFoundItem</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineminus">-                                                                ? CAL_ITIP_PROC_UPDATE_OP</span>
<a href="#l23.407"></a><span id="l23.407" class="difflineminus">-                                                                : CAL_ITIP_PROC_ADD_OP),</span>
<a href="#l23.408"></a><span id="l23.408" class="difflineminus">-                                                               aTargetCal,</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineminus">-                                                               aListener);</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineminus">-                }</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineminus">-            },</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineminus">-            onGetResult:</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineminus">-            function onget(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineminus">-                if (Components.isSuccessCode(aStatus) &amp;&amp; aCount &amp;&amp; aItems[0]) {</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineminus">-                    this.mFoundItem = aItems[0]; // take any</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineminus">-                }</span>
<a href="#l23.417"></a><span id="l23.417" class="difflineminus">-            }</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineminus">-        };</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineminus">-        if (aTargetCal) {</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineminus">-            aTargetCal.getItem(aCalItem.id, foundItemListener);</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineminus">-        } else {</span>
<a href="#l23.422"></a><span id="l23.422" class="difflineminus">-            // Then we do not have a target calendar to search,</span>
<a href="#l23.423"></a><span id="l23.423" class="difflineminus">-            // this is probably a DECLINE reply or some other such response,</span>
<a href="#l23.424"></a><span id="l23.424" class="difflineminus">-            // allow it to pass through</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineminus">-            this._continueProcessingItem(aCalItem, null, aItipItem, aRecvMethod,</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineminus">-                                         aRespMethod, null, aTargetCal, aListener);</span>
<a href="#l23.427"></a><span id="l23.427" class="difflineminus">-        }</span>
<a href="#l23.428"></a><span id="l23.428" class="difflineminus">-    },</span>
<a href="#l23.429"></a><span id="l23.429" class="difflineminus">-</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineminus">-    /**</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineminus">-     * Centralized location for obtaining the proper transport. If a calendar is</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineminus">-     * specified, the transport is taken from the provider. Otherwise, the</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineminus">-     * default email transport is returned.</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineminus">-     *</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineminus">-     * Its ok to assume there is an itip.transport here, since if it would</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineminus">-     * return null (i.e imip is disabled) then we never get here, since the</span>
<a href="#l23.437"></a><span id="l23.437" class="difflineminus">-     * respective calendar will not be available as a target calendar.</span>
<a href="#l23.438"></a><span id="l23.438" class="difflineminus">-     */</span>
<a href="#l23.439"></a><span id="l23.439" class="difflineminus">-    _getTransport: function cipGT(aCalendar) {</span>
<a href="#l23.440"></a><span id="l23.440" class="difflineminus">-        if (aCalendar) {</span>
<a href="#l23.441"></a><span id="l23.441" class="difflineminus">-            return aCalendar.getProperty(&quot;itip.transport&quot;)</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineminus">-                            .QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l23.443"></a><span id="l23.443" class="difflineminus">-        } else {</span>
<a href="#l23.444"></a><span id="l23.444" class="difflineminus">-            return Components.classes[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;]</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineminus">-                             .getService(Components.interfaces.calIItipTransport);</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineminus">-        }</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineminus">-    }</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -744,17 +744,16 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5">         var itemtoadd;</span>
<a href="#l24.6"></a><span id="l24.6">         if (aTakeOverOwnership &amp;&amp; anItem.isMutable) {</span>
<a href="#l24.7"></a><span id="l24.7">             itemtoadd = anItem;</span>
<a href="#l24.8"></a><span id="l24.8">             itemtoadd.parentItem = this.mBaseItem;</span>
<a href="#l24.9"></a><span id="l24.9">         } else {</span>
<a href="#l24.10"></a><span id="l24.10">             itemtoadd = anItem.cloneShallow(this.mBaseItem);</span>
<a href="#l24.11"></a><span id="l24.11">         }</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-        itemtoadd.makeImmutable();</span>
<a href="#l24.13"></a><span id="l24.13"> </span>
<a href="#l24.14"></a><span id="l24.14">         // we're going to assume that the recurrenceId is valid here,</span>
<a href="#l24.15"></a><span id="l24.15">         // because presumably the item came from one of our functions</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17">         var exKey = getRidKey(itemtoadd.recurrenceId);</span>
<a href="#l24.18"></a><span id="l24.18">         this.mExceptionMap[exKey] = itemtoadd;</span>
<a href="#l24.19"></a><span id="l24.19">     },</span>
<a href="#l24.20"></a><span id="l24.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,9 +1,8 @@</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l25.5"></a><span id="l25.5"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l25.6"></a><span id="l25.6">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l25.7"></a><span id="l25.7">  *</span>
<a href="#l25.8"></a><span id="l25.8">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l25.9"></a><span id="l25.9">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l25.10"></a><span id="l25.10">  * the License. You may obtain a copy of the License at</span>
<a href="#l25.11"></a><span id="l25.11">  * http://www.mozilla.org/MPL/</span>
<a href="#l25.12"></a><span id="l25.12">  *</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineat">@@ -46,17 +45,16 @@</span>
<a href="#l25.14"></a><span id="l25.14"> // constructor</span>
<a href="#l25.15"></a><span id="l25.15"> //</span>
<a href="#l25.16"></a><span id="l25.16"> function calTodo() {</span>
<a href="#l25.17"></a><span id="l25.17">     this.initItemBase();</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19">     this.todoPromotedProps = {</span>
<a href="#l25.20"></a><span id="l25.20">         &quot;DTSTART&quot;: true,</span>
<a href="#l25.21"></a><span id="l25.21">         &quot;DTEND&quot;: true,</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-        &quot;DTSTAMP&quot;: true,</span>
<a href="#l25.23"></a><span id="l25.23">         &quot;DUE&quot;: true,</span>
<a href="#l25.24"></a><span id="l25.24">         &quot;COMPLETED&quot;: true,</span>
<a href="#l25.25"></a><span id="l25.25">         __proto__: this.itemBasePromotedProps</span>
<a href="#l25.26"></a><span id="l25.26">     };</span>
<a href="#l25.27"></a><span id="l25.27"> }</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29"> var calTodoClassInfo = {</span>
<a href="#l25.30"></a><span id="l25.30">     getInterfaces: function (count) {</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineat">@@ -197,16 +195,17 @@ calTodo.prototype = {</span>
<a href="#l25.32"></a><span id="l25.32">     set icalComponent(todo) {</span>
<a href="#l25.33"></a><span id="l25.33">         this.modify();</span>
<a href="#l25.34"></a><span id="l25.34">         if (todo.componentType != &quot;VTODO&quot;) {</span>
<a href="#l25.35"></a><span id="l25.35">             todo = todo.getFirstSubcomponent(&quot;VTODO&quot;);</span>
<a href="#l25.36"></a><span id="l25.36">             if (!todo)</span>
<a href="#l25.37"></a><span id="l25.37">                 throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l25.38"></a><span id="l25.38">         }</span>
<a href="#l25.39"></a><span id="l25.39"> </span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+        // xxx todo: Bug 463195 make sure object is properly reset</span>
<a href="#l25.41"></a><span id="l25.41">         this.setItemBaseFromICS(todo);</span>
<a href="#l25.42"></a><span id="l25.42">         this.mapPropsFromICS(todo, this.icsEventPropMap);</span>
<a href="#l25.43"></a><span id="l25.43">         this.mIsAllDay = this.mStartDate &amp;&amp; this.mStartDate.isDate;</span>
<a href="#l25.44"></a><span id="l25.44"> </span>
<a href="#l25.45"></a><span id="l25.45">         this.importUnpromotedProperties(todo, this.todoPromotedProps);</span>
<a href="#l25.46"></a><span id="l25.46">         // Importing didn't really change anything</span>
<a href="#l25.47"></a><span id="l25.47">         this.mDirty = false;</span>
<a href="#l25.48"></a><span id="l25.48">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -148,23 +148,29 @@ calTransaction.prototype = {</span>
<a href="#l26.4"></a><span id="l26.4">         return this;</span>
<a href="#l26.5"></a><span id="l26.5">     },</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">     onOperationComplete: function cT_onOperationComplete(aCalendar,</span>
<a href="#l26.8"></a><span id="l26.8">                                                          aStatus,</span>
<a href="#l26.9"></a><span id="l26.9">                                                          aOperationType,</span>
<a href="#l26.10"></a><span id="l26.10">                                                          aId,</span>
<a href="#l26.11"></a><span id="l26.11">                                                          aDetail) {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-        if (aStatus == Components.results.NS_OK &amp;&amp;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-            (aOperationType == Components.interfaces.calIOperationListener.ADD ||</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-             aOperationType == Components.interfaces.calIOperationListener.MODIFY)) {</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-            if (this.mIsDoTransaction) {</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-                this.mItem = aDetail;</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-            } else {</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-                this.mOldItem = aDetail;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+        if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+            cal.itip.checkAndSend(aOperationType,</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+                                  aDetail,</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+                                  this.mIsDoTransaction ? this.mOldItem : this.mItem);</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+            if (aOperationType == Components.interfaces.calIOperationListener.ADD ||</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+                aOperationType == Components.interfaces.calIOperationListener.MODIFY) {</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+                if (this.mIsDoTransaction) {</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+                    this.mItem = aDetail;</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+                } else {</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+                    this.mOldItem = aDetail;</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+                }</span>
<a href="#l26.32"></a><span id="l26.32">             }</span>
<a href="#l26.33"></a><span id="l26.33">         }</span>
<a href="#l26.34"></a><span id="l26.34">         if (this.mListener) {</span>
<a href="#l26.35"></a><span id="l26.35">             this.mListener.onOperationComplete(aCalendar,</span>
<a href="#l26.36"></a><span id="l26.36">                                                aStatus,</span>
<a href="#l26.37"></a><span id="l26.37">                                                aOperationType,</span>
<a href="#l26.38"></a><span id="l26.38">                                                aId,</span>
<a href="#l26.39"></a><span id="l26.39">                                                aDetail);</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineat">@@ -194,17 +200,17 @@ calTransaction.prototype = {</span>
<a href="#l26.41"></a><span id="l26.41">                 this.mCalendar.addItem(this.mItem, this);</span>
<a href="#l26.42"></a><span id="l26.42">                 break;</span>
<a href="#l26.43"></a><span id="l26.43">             case 'modify':</span>
<a href="#l26.44"></a><span id="l26.44">                 if (this.mItem.calendar.id != this.mOldItem.calendar.id) {</span>
<a href="#l26.45"></a><span id="l26.45">                     this.mOldCalendar = this.mOldItem.calendar;</span>
<a href="#l26.46"></a><span id="l26.46">                     this.mOldCalendar.deleteItem(this.mOldItem, this);</span>
<a href="#l26.47"></a><span id="l26.47">                     this.mCalendar.addItem(this.mItem, this);</span>
<a href="#l26.48"></a><span id="l26.48">                 } else {</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-                    this.mCalendar.modifyItem(this.mItem,</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+                    this.mCalendar.modifyItem(cal.itip.prepareSequence(this.mItem, this.mOldItem),</span>
<a href="#l26.51"></a><span id="l26.51">                                               this.mOldItem,</span>
<a href="#l26.52"></a><span id="l26.52">                                               this);</span>
<a href="#l26.53"></a><span id="l26.53">                 }</span>
<a href="#l26.54"></a><span id="l26.54">                 break;</span>
<a href="#l26.55"></a><span id="l26.55">             case 'delete':</span>
<a href="#l26.56"></a><span id="l26.56">                 this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l26.57"></a><span id="l26.57">                 break;</span>
<a href="#l26.58"></a><span id="l26.58">             default:</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineat">@@ -220,17 +226,18 @@ calTransaction.prototype = {</span>
<a href="#l26.60"></a><span id="l26.60">             case 'add':</span>
<a href="#l26.61"></a><span id="l26.61">                 this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l26.62"></a><span id="l26.62">                 break;</span>
<a href="#l26.63"></a><span id="l26.63">             case 'modify':</span>
<a href="#l26.64"></a><span id="l26.64">                 if (this.mOldItem.calendar.id != this.mItem.calendar.id) {</span>
<a href="#l26.65"></a><span id="l26.65">                     this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l26.66"></a><span id="l26.66">                     this.mOldCalendar.addItem(this.mOldItem, this);</span>
<a href="#l26.67"></a><span id="l26.67">                 } else {</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-                    this.mCalendar.modifyItem(this.mOldItem, this.mItem, this);</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+                    this.mCalendar.modifyItem(cal.itip.prepareSequence(this.mOldItem, this.mItem),</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+                                              this.mItem, this);</span>
<a href="#l26.71"></a><span id="l26.71">                 }</span>
<a href="#l26.72"></a><span id="l26.72">                 break;</span>
<a href="#l26.73"></a><span id="l26.73">             case 'delete':</span>
<a href="#l26.74"></a><span id="l26.74">                 this.mCalendar.addItem(this.mItem, this);</span>
<a href="#l26.75"></a><span id="l26.75">                 break;</span>
<a href="#l26.76"></a><span id="l26.76">             default:</span>
<a href="#l26.77"></a><span id="l26.77">                 throw new Components.Exception(&quot;Invalid action specified&quot;,</span>
<a href="#l26.78"></a><span id="l26.78">                                                Components.results.NS_ERROR_ILLEGAL_VALUE);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -32,16 +32,18 @@</span>
<a href="#l27.4"></a><span id="l27.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l27.5"></a><span id="l27.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l27.6"></a><span id="l27.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l27.7"></a><span id="l27.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l27.8"></a><span id="l27.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l27.9"></a><span id="l27.9">  *</span>
<a href="#l27.10"></a><span id="l27.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/debug.js&quot;);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+</span>
<a href="#l27.14"></a><span id="l27.14"> /* This file contains commonly used functions in a centralized place so that</span>
<a href="#l27.15"></a><span id="l27.15">  * various components (and other js scopes) don't need to replicate them. Note</span>
<a href="#l27.16"></a><span id="l27.16">  * that loading this file twice in the same scope will throw errors.</span>
<a href="#l27.17"></a><span id="l27.17">  */</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19"> /* Returns a clean new calIEvent */</span>
<a href="#l27.20"></a><span id="l27.20"> function createEvent() {</span>
<a href="#l27.21"></a><span id="l27.21">     return Components.classes[&quot;@mozilla.org/calendar/event;1&quot;].</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -910,16 +912,17 @@ function LOG(aArg) {</span>
<a href="#l27.23"></a><span id="l27.23">         for (var prop in aArg) {</span>
<a href="#l27.24"></a><span id="l27.24">             string += prop + ': ' + aArg[prop] + '\n';</span>
<a href="#l27.25"></a><span id="l27.25">         }</span>
<a href="#l27.26"></a><span id="l27.26">         string += &quot;End object\n&quot;;</span>
<a href="#l27.27"></a><span id="l27.27">     } else {</span>
<a href="#l27.28"></a><span id="l27.28">         string = aArg;</span>
<a href="#l27.29"></a><span id="l27.29">     }</span>
<a href="#l27.30"></a><span id="l27.30"> </span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+    // xxx todo consider using function debug()</span>
<a href="#l27.32"></a><span id="l27.32">     dump(string + '\n');</span>
<a href="#l27.33"></a><span id="l27.33">     getConsoleService().logStringMessage(string);</span>
<a href="#l27.34"></a><span id="l27.34"> }</span>
<a href="#l27.35"></a><span id="l27.35"> </span>
<a href="#l27.36"></a><span id="l27.36"> /**</span>
<a href="#l27.37"></a><span id="l27.37">  * Dumps a warning to both console and js console.</span>
<a href="#l27.38"></a><span id="l27.38">  *</span>
<a href="#l27.39"></a><span id="l27.39">  * @param aMessage warning message</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineat">@@ -980,22 +983,21 @@ function STACK(aDepth, aSkip) {</span>
<a href="#l27.41"></a><span id="l27.41">  *                    if false, code flow will continue</span>
<a href="#l27.42"></a><span id="l27.42">  *                    may be a result code</span>
<a href="#l27.43"></a><span id="l27.43">  */</span>
<a href="#l27.44"></a><span id="l27.44"> function ASSERT(aCondition, aMessage, aCritical) {</span>
<a href="#l27.45"></a><span id="l27.45">     if (aCondition) {</span>
<a href="#l27.46"></a><span id="l27.46">         return;</span>
<a href="#l27.47"></a><span id="l27.47">     }</span>
<a href="#l27.48"></a><span id="l27.48"> </span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-    var string = &quot;Assert failed: &quot; + aMessage + '\n' + STACK(null, 1);</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+    NS_ASSERT(aCondition, aMessage);</span>
<a href="#l27.51"></a><span id="l27.51">     if (aCritical) {</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+        let string = &quot;Assert failed: &quot; + aMessage + '\n' + STACK(null, 1);</span>
<a href="#l27.53"></a><span id="l27.53">         throw new Components.Exception(string,</span>
<a href="#l27.54"></a><span id="l27.54">                                        aCritical === true ? Components.results.NS_ERROR_UNEXPECTED : aCritical);</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-    } else {</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-        Components.utils.reportError(string);</span>
<a href="#l27.57"></a><span id="l27.57">     }</span>
<a href="#l27.58"></a><span id="l27.58"> }</span>
<a href="#l27.59"></a><span id="l27.59"> </span>
<a href="#l27.60"></a><span id="l27.60"> /**</span>
<a href="#l27.61"></a><span id="l27.61">  * Uses the prompt service to display an error message.</span>
<a href="#l27.62"></a><span id="l27.62">  *</span>
<a href="#l27.63"></a><span id="l27.63">  * @param aMsg The message to be shown</span>
<a href="#l27.64"></a><span id="l27.64">  */</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineat">@@ -1403,26 +1405,34 @@ function sameDay(date1, date2) {</span>
<a href="#l27.66"></a><span id="l27.66">         }</span>
<a href="#l27.67"></a><span id="l27.67">     }</span>
<a href="#l27.68"></a><span id="l27.68">     return false;</span>
<a href="#l27.69"></a><span id="l27.69"> }</span>
<a href="#l27.70"></a><span id="l27.70"> </span>
<a href="#l27.71"></a><span id="l27.71"> /**</span>
<a href="#l27.72"></a><span id="l27.72">  * Iterates all components inside the passed ical component and calls the passed function.</span>
<a href="#l27.73"></a><span id="l27.73">  * If the called function returns false, iteration is stopped.</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+ *</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+ * @param icalComp an ICS component</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+ * @param func functor that will be executed on sub components</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+ * @param compType optional component type to filter, defaults to &quot;ANY&quot;</span>
<a href="#l27.78"></a><span id="l27.78">  */</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-function calIterateIcalComponent(icalComp, func) {</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+function calIterateIcalComponent(icalComp, func, compType) {</span>
<a href="#l27.81"></a><span id="l27.81">     if (icalComp) {</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-        if (icalComp.componentType != &quot;VCALENDAR&quot;) {</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-            return func(icalComp);</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+        if (!compType) {</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+            compType = &quot;ANY&quot;;</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+        }</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+        var ctype = icalComp.componentType;</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+        if (ctype != &quot;VCALENDAR&quot;) {</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+            return (ctype == compType ? func(icalComp) : true);</span>
<a href="#l27.90"></a><span id="l27.90">         }</span>
<a href="#l27.91"></a><span id="l27.91">         for (var subComp = icalComp.getFirstSubcomponent(&quot;ANY&quot;);</span>
<a href="#l27.92"></a><span id="l27.92">              subComp;</span>
<a href="#l27.93"></a><span id="l27.93">              subComp = icalComp.getNextSubcomponent(&quot;ANY&quot;)) {</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineminus">-            if (!calIterateIcalComponent(subComp, func)) {</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineplus">+            if (!calIterateIcalComponent(subComp, func, compType)) {</span>
<a href="#l27.96"></a><span id="l27.96">                 return false;</span>
<a href="#l27.97"></a><span id="l27.97">             }</span>
<a href="#l27.98"></a><span id="l27.98">         }</span>
<a href="#l27.99"></a><span id="l27.99">     }</span>
<a href="#l27.100"></a><span id="l27.100">     return true;</span>
<a href="#l27.101"></a><span id="l27.101"> }</span>
<a href="#l27.102"></a><span id="l27.102"> </span>
<a href="#l27.103"></a><span id="l27.103"> /**</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineat">@@ -1863,16 +1873,66 @@ function binaryInsert(itemArray, item, c</span>
<a href="#l27.105"></a><span id="l27.105">                 comptor(itemArray[Math.min(newIndex, itemArray.length - 1)], item) != 0) {</span>
<a href="#l27.106"></a><span id="l27.106">         // Only add the item if duplicates should not be discarded, or if</span>
<a href="#l27.107"></a><span id="l27.107">         // they should and itemArray[newIndex] == item.</span>
<a href="#l27.108"></a><span id="l27.108">         itemArray.splice(newIndex, 0, item);</span>
<a href="#l27.109"></a><span id="l27.109">     }</span>
<a href="#l27.110"></a><span id="l27.110">     return newIndex;</span>
<a href="#l27.111"></a><span id="l27.111"> }</span>
<a href="#l27.112"></a><span id="l27.112"> </span>
<a href="#l27.113"></a><span id="l27.113" class="difflineplus">+/**</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineplus">+ * Read default alarm settings from user preferences and apply them to</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+ * the event/todo passed in.</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineplus">+ *</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineplus">+ * @param aItem   The event or todo the settings should be applied to.</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+ */</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineplus">+function setDefaultAlarmValues(aItem)</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineplus">+{</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineplus">+    var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineplus">+                                .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+    var alarmsBranch = prefService.getBranch(&quot;calendar.alarms.&quot;);</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineplus">+    if (isEvent(aItem)) {</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineplus">+        try {</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+            if (alarmsBranch.getIntPref(&quot;onforevents&quot;) == 1) {</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+                var alarmOffset = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineplus">+                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+                var units = alarmsBranch.getCharPref(&quot;eventalarmunit&quot;);</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+                alarmOffset[units] = alarmsBranch.getIntPref(&quot;eventalarmlen&quot;);</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+                alarmOffset.isNegative = true;</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+                aItem.alarmOffset = alarmOffset;</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineplus">+                aItem.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineplus">+            }</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineplus">+        } catch (ex) {</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineplus">+            Components.utils.reportError(</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineplus">+                &quot;Failed to apply default alarm settings to event: &quot; + ex);</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineplus">+        }</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineplus">+    } else if (isToDo(aItem)) {</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineplus">+        try {</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineplus">+            if (alarmsBranch.getIntPref(&quot;onfortodos&quot;) == 1) {</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineplus">+                // You can't have an alarm if the entryDate doesn't exist.</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineplus">+                if (!aItem.entryDate) {</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineplus">+                    aItem.entryDate = getSelectedDay() &amp;&amp;</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineplus">+                                      getSelectedDay().clone() || now();</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineplus">+                }</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineplus">+                var alarmOffset = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineplus">+                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineplus">+                var units = alarmsBranch.getCharPref(&quot;todoalarmunit&quot;);</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineplus">+                alarmOffset[units] = alarmsBranch.getIntPref(&quot;todoalarmlen&quot;);</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineplus">+                alarmOffset.isNegative = true;</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineplus">+                aItem.alarmOffset = alarmOffset;</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+                aItem.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+            }</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+        } catch (ex) {</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineplus">+            Components.utils.reportError(</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+                &quot;Failed to apply default alarm settings to task: &quot; + ex);</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineplus">+        }</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineplus">+    }</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineplus">+}</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineplus">+</span>
<a href="#l27.163"></a><span id="l27.163"> function getCompositeCalendar() {</span>
<a href="#l27.164"></a><span id="l27.164">     if (getCompositeCalendar.mObject === undefined) {</span>
<a href="#l27.165"></a><span id="l27.165">         getCompositeCalendar.mObject = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l27.166"></a><span id="l27.166">                                                  .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l27.167"></a><span id="l27.167">         getCompositeCalendar.mObject.prefPrefix = 'calendar-main';</span>
<a href="#l27.168"></a><span id="l27.168"> </span>
<a href="#l27.169"></a><span id="l27.169">         try {</span>
<a href="#l27.170"></a><span id="l27.170">             if (gCalendarStatusFeedback) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/installer/removed-files.in</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/installer/removed-files.in</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -355,16 +355,18 @@ res/cmessage.txt</span>
<a href="#l28.4"></a><span id="l28.4"> xpicleanup.exe</span>
<a href="#l28.5"></a><span id="l28.5"> #else</span>
<a href="#l28.6"></a><span id="l28.6"> xpicleanup</span>
<a href="#l28.7"></a><span id="l28.7"> #endif</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> # bug 446366 (renamed interface)</span>
<a href="#l28.10"></a><span id="l28.10"> js/calWeekTitleService.js</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+js/calItipProcessor.js</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+</span>
<a href="#l28.14"></a><span id="l28.14"> # bug 431775 (remove unused gopher images)</span>
<a href="#l28.15"></a><span id="l28.15"> res/html/gopher-audio.gif</span>
<a href="#l28.16"></a><span id="l28.16"> res/html/gopher-binary.gif</span>
<a href="#l28.17"></a><span id="l28.17"> res/html/gopher-find.gif</span>
<a href="#l28.18"></a><span id="l28.18"> res/html/gopher-image.gif</span>
<a href="#l28.19"></a><span id="l28.19"> res/html/gopher-menu.gif</span>
<a href="#l28.20"></a><span id="l28.20"> res/html/gopher-movie.gif</span>
<a href="#l28.21"></a><span id="l28.21"> res/html/gopher-sound.gif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/installer/windows/packages-static</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/installer/windows/packages-static</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -231,17 +231,16 @@ bin\calendar-js\calFilter.js</span>
<a href="#l29.4"></a><span id="l29.4"> bin\calendar-js\calFreeBusyService.js</span>
<a href="#l29.5"></a><span id="l29.5"> bin\calendar-js\calHtmlExport.js</span>
<a href="#l29.6"></a><span id="l29.6"> bin\calendar-js\calICSCalendar.js</span>
<a href="#l29.7"></a><span id="l29.7"> bin\calendar-js\calIcsImportExport.js</span>
<a href="#l29.8"></a><span id="l29.8"> bin\calendar-js\calIcsParser.js</span>
<a href="#l29.9"></a><span id="l29.9"> bin\calendar-js\calIcsSerializer.js</span>
<a href="#l29.10"></a><span id="l29.10"> bin\calendar-js\calItemBase.js</span>
<a href="#l29.11"></a><span id="l29.11"> bin\calendar-js\calItipItem.js</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-bin\calendar-js\calItipProcessor.js</span>
<a href="#l29.13"></a><span id="l29.13"> bin\calendar-js\calListFormatter.js</span>
<a href="#l29.14"></a><span id="l29.14"> bin\calendar-js\calMemoryCalendar.js</span>
<a href="#l29.15"></a><span id="l29.15"> bin\calendar-js\calMonthGridPrinter.js</span>
<a href="#l29.16"></a><span id="l29.16"> bin\calendar-js\calOutlookCSVImportExport.js</span>
<a href="#l29.17"></a><span id="l29.17"> bin\calendar-js\calProtocolHandler.js</span>
<a href="#l29.18"></a><span id="l29.18"> bin\calendar-js\calProviderBase.js</span>
<a href="#l29.19"></a><span id="l29.19"> bin\calendar-js\calProviderUtils.js</span>
<a href="#l29.20"></a><span id="l29.20"> bin\calendar-js\calRecurrenceInfo.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -208,33 +208,19 @@ calItipEmailTransport.prototype = {</span>
<a href="#l30.4"></a><span id="l30.4">             if (identity) {</span>
<a href="#l30.5"></a><span id="l30.5">                 identity = identity.QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l30.6"></a><span id="l30.6">                 account = aItem.targetCalendar.getProperty(&quot;imip.account&quot;)</span>
<a href="#l30.7"></a><span id="l30.7">                                               .QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l30.8"></a><span id="l30.8">             } else {</span>
<a href="#l30.9"></a><span id="l30.9">                 WARN(&quot;No email identity configured for calendar &quot; + aItem.targetCalendar.name);</span>
<a href="#l30.10"></a><span id="l30.10">             }</span>
<a href="#l30.11"></a><span id="l30.11">         }</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-        if (!identity) {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-            if (aItem.identity) {</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-                // try to find proper identity/account for the itipItem's identity:</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-                var itipIdentity = aItem.identity.toLowerCase();</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-                calIterateEmailIdentities(</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-                    function(identity_, account_) {</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-                        if (identity_.email.toLowerCase() == itipIdentity) {</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-                            identity = identity_;</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-                            account = account_;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-                            return false;</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-                        }</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-                        return true;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-                    });</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-            } else { // use some default identity/account:</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-                identity = this.mDefaultIdentity;</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-                account = this.mDefaultAccount;</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-            }</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+        if (!identity) { // use some default identity/account:</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+            identity = this.mDefaultIdentity;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+            account = this.mDefaultAccount;</span>
<a href="#l30.32"></a><span id="l30.32">         }</span>
<a href="#l30.33"></a><span id="l30.33"> </span>
<a href="#l30.34"></a><span id="l30.34">         var compatMode = 0;</span>
<a href="#l30.35"></a><span id="l30.35">         switch (aItem.autoResponse) {</span>
<a href="#l30.36"></a><span id="l30.36">             case (Components.interfaces.calIItipItem.USER): {</span>
<a href="#l30.37"></a><span id="l30.37">                 LOG(&quot;sendXpcomMail: Found USER autoResponse type.\n&quot; +</span>
<a href="#l30.38"></a><span id="l30.38">                     &quot;This type is currently unsupported, the compose API will always enter a text/plain\n&quot; +</span>
<a href="#l30.39"></a><span id="l30.39">                     &quot;or text/html part as first part of the message.\n&quot; +</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineat">@@ -338,17 +324,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l30.41"></a><span id="l30.41">             // Home-grown mail composition; I'd love to use nsIMimeEmitter, but it's not clear to me whether</span>
<a href="#l30.42"></a><span id="l30.42">             // it can cope with nested attachments,</span>
<a href="#l30.43"></a><span id="l30.43">             // like multipart/alternative with enclosed text/calendar and text/plain.</span>
<a href="#l30.44"></a><span id="l30.44">             var mailText = (&quot;MIME-version: 1.0\r\n&quot; +</span>
<a href="#l30.45"></a><span id="l30.45">                             (aIdentity.replyTo</span>
<a href="#l30.46"></a><span id="l30.46">                              ? &quot;Return-path: &quot; + aIdentity.replyTo + &quot;\r\n&quot; : &quot;&quot;) +</span>
<a href="#l30.47"></a><span id="l30.47">                             &quot;From: &quot; + aIdentity.email + &quot;\r\n&quot; +</span>
<a href="#l30.48"></a><span id="l30.48">                             &quot;To: &quot; + aToList + &quot;\r\n&quot; +</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-                            encodeMimeHeader(&quot;Subject: &quot; + aSubject) + &quot;\r\n&quot;);</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+                            encodeMimeHeader(&quot;Subject: &quot; + aSubject.replace(/(\n|\r\n)/, &quot;|&quot;)) + &quot;\r\n&quot;);</span>
<a href="#l30.51"></a><span id="l30.51">             switch (compatMode) {</span>
<a href="#l30.52"></a><span id="l30.52">                 case 1:</span>
<a href="#l30.53"></a><span id="l30.53">                     mailText += (&quot;Content-class: urn:content-classes:calendarmessage\r\n&quot; +</span>
<a href="#l30.54"></a><span id="l30.54">                                  &quot;Content-type: text/calendar; method=&quot; + aItem.responseMethod + &quot;; charset=UTF-8\r\n&quot; +</span>
<a href="#l30.55"></a><span id="l30.55">                                  &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l30.56"></a><span id="l30.56">                                  &quot;\r\n&quot; +</span>
<a href="#l30.57"></a><span id="l30.57">                                  utf8CalText +</span>
<a href="#l30.58"></a><span id="l30.58">                                  &quot;\r\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/libical/design-data/parameters.csv</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/libical/design-data/parameters.csv</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -13,16 +13,18 @@</span>
<a href="#l31.4"></a><span id="l31.4"> &quot;MEMBER&quot;,&quot;const char*&quot;,</span>
<a href="#l31.5"></a><span id="l31.5"> &quot;PARTSTAT&quot;,&quot;icalparameter_partstat&quot;,&quot;NEEDS-ACTION;ACCEPTED;DECLINED;TENTATIVE;DELEGATED;COMPLETED;INPROCESS&quot;</span>
<a href="#l31.6"></a><span id="l31.6"> &quot;RANGE&quot;,&quot;icalparameter_range&quot;,&quot;THISANDPRIOR;THISANDFUTURE&quot;</span>
<a href="#l31.7"></a><span id="l31.7"> &quot;RELATED&quot;,&quot;icalparameter_related&quot;,&quot;START;END&quot;</span>
<a href="#l31.8"></a><span id="l31.8"> &quot;RELTYPE&quot;,&quot;icalparameter_reltype&quot;,&quot;PARENT;CHILD;SIBLING&quot;</span>
<a href="#l31.9"></a><span id="l31.9"> &quot;ROLE&quot;,&quot;icalparameter_role&quot;,&quot;CHAIR;REQ-PARTICIPANT;OPT-PARTICIPANT;NON-PARTICIPANT&quot;</span>
<a href="#l31.10"></a><span id="l31.10"> &quot;RSVP&quot;,&quot;icalparameter_rsvp&quot;,&quot;TRUE;FALSE&quot;</span>
<a href="#l31.11"></a><span id="l31.11"> &quot;SENT-BY&quot;,&quot;const char*&quot;,</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+&quot;RECEIVED-SEQUENCE&quot;,&quot;const char*&quot;,</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+&quot;RECEIVED-DTSTAMP&quot;,&quot;const char*&quot;,</span>
<a href="#l31.14"></a><span id="l31.14"> &quot;TZID&quot;,&quot;const char*&quot;,</span>
<a href="#l31.15"></a><span id="l31.15"> &quot;VALUE&quot;,&quot;icalparameter_value&quot;,&quot;BINARY;BOOLEAN;DATE;DURATION;FLOAT;INTEGER;PERIOD;RECUR;TEXT;URI;ERROR;DATE-TIME;UTC-OFFSET;CAL-ADDRESS&quot;</span>
<a href="#l31.16"></a><span id="l31.16"> &quot;X&quot;,&quot;const char*&quot;,</span>
<a href="#l31.17"></a><span id="l31.17"> &quot;X-LIC-ERRORTYPE&quot;,&quot;icalparameter_xlicerrortype&quot;,&quot;COMPONENT-PARSE-ERROR;PROPERTY-PARSE-ERROR;PARAMETER-NAME-PARSE-ERROR;PARAMETER-VALUE-PARSE-ERROR;VALUE-PARSE-ERROR;INVALID-ITIP;UNKNOWN-VCAL-PROP-ERROR;MIME-PARSE-ERROR;VCAL-PROP-PARSE-ERROR&quot;</span>
<a href="#l31.18"></a><span id="l31.18"> &quot;X-LIC-COMPARETYPE&quot;,&quot;icalparameter_xliccomparetype&quot;,&quot;EQUAL;NOTEQUAL;LESS;GREATER;LESSEQUAL;GREATEREQUAL;REGEX;ISNULL;ISNOTNULL&quot;</span>
<a href="#l31.19"></a><span id="l31.19"> &quot;#CAP Parameters&quot;,&quot;Draft 8&quot;,</span>
<a href="#l31.20"></a><span id="l31.20"> &quot;#this parameter should really be called ACTION, but this conflicts with the ACTION property&quot;</span>
<a href="#l31.21"></a><span id="l31.21"> &quot;ACTIONPARAM&quot;,&quot;icalparameter_action&quot;,&quot;ASK;ABORT&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/libical/design-data/params-in-prop.txt</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/libical/design-data/params-in-prop.txt</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,11 +1,11 @@</span>
<a href="#l32.4"></a><span id="l32.4"> ACTION               VALUE X</span>
<a href="#l32.5"></a><span id="l32.5"> ATTACH               FMTTYPE ENCODING VALUE X</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineminus">-ATTENDEE             CN CUTYPE DELEGATED-FROM DELEGATED-TO DIR LANGUAGE MEMBER PARTSTAT ROLE RSVP SENT-BY X</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineplus">+ATTENDEE             CN CUTYPE DELEGATED-FROM DELEGATED-TO DIR LANGUAGE MEMBER PARTSTAT ROLE RSVP SENT-BY RECEIVED-SEQUENCE RECEIVED-DTSTAMP X</span>
<a href="#l32.8"></a><span id="l32.8"> CALSCALE             X</span>
<a href="#l32.9"></a><span id="l32.9"> CATEGORIES           LANGUAGE X</span>
<a href="#l32.10"></a><span id="l32.10"> CLASS                X</span>
<a href="#l32.11"></a><span id="l32.11"> CMD		     ACTIONPARAM ID LATENCY LOCALIZE OPTIONS X</span>
<a href="#l32.12"></a><span id="l32.12"> COMMENT              ALTREP LANGUAGE X</span>
<a href="#l32.13"></a><span id="l32.13"> COMPLETED            X</span>
<a href="#l32.14"></a><span id="l32.14"> CONTACT              ALTREP LANGUAGE X</span>
<a href="#l32.15"></a><span id="l32.15"> CREATED              X</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -195,33 +195,34 @@ ltnMimeConverter.prototype = {</span>
<a href="#l33.4"></a><span id="l33.4">     get uri() {</span>
<a href="#l33.5"></a><span id="l33.5">         return this.mUri;</span>
<a href="#l33.6"></a><span id="l33.6">     },</span>
<a href="#l33.7"></a><span id="l33.7">     set uri(aUri) {</span>
<a href="#l33.8"></a><span id="l33.8">         return (this.mUri = aUri);</span>
<a href="#l33.9"></a><span id="l33.9">     },</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11">     convertToHTML: function lmcCTH(contentType, data) {</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+        var parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+                               .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+        parser.parseString(data, null);</span>
<a href="#l33.15"></a><span id="l33.15">         var event = null;</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-        calIterateIcalComponent(getIcsService().parseICS(data, null),</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-                                function(icalComp) {</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-                                    if (icalComp.componentType == &quot;VEVENT&quot;) {</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-                                        event = createEvent();</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-                                        event.icalComponent = icalComp;</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-                                    }</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-                                    return (icalComp.componentType != &quot;VEVENT&quot;);</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-                                });</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+        for each (var item in parser.getItems({})) {</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+            if (isEvent(item)) {</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+                event = item;</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+                break;</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+            }</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+        }</span>
<a href="#l33.30"></a><span id="l33.30">         if (!event) {</span>
<a href="#l33.31"></a><span id="l33.31">             return;</span>
<a href="#l33.32"></a><span id="l33.32">         }</span>
<a href="#l33.33"></a><span id="l33.33">         var html = createHtml(event);</span>
<a href="#l33.34"></a><span id="l33.34"> </span>
<a href="#l33.35"></a><span id="l33.35">         try {</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-            var itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;].</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">-                           createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+            var itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+                                     .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l33.40"></a><span id="l33.40">             itipItem.init(data);</span>
<a href="#l33.41"></a><span id="l33.41"> </span>
<a href="#l33.42"></a><span id="l33.42">             // this.mUri is the message URL that we are processing.</span>
<a href="#l33.43"></a><span id="l33.43">             // We use it to get the nsMsgHeaderSink to store the calItipItem.</span>
<a href="#l33.44"></a><span id="l33.44">             if (this.mUri) {</span>
<a href="#l33.45"></a><span id="l33.45">                 var msgUrl = this.mUri.QueryInterface(Components.interfaces.nsIMsgMailNewsUrl);</span>
<a href="#l33.46"></a><span id="l33.46">                 var sinkProps = msgUrl.msgWindow.msgHeaderSink.properties;</span>
<a href="#l33.47"></a><span id="l33.47">                 sinkProps.setPropertyAsInterface(&quot;itipItem&quot;, itipItem);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -32,340 +32,51 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l34.5"></a><span id="l34.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l34.6"></a><span id="l34.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l34.7"></a><span id="l34.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.8"></a><span id="l34.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.9"></a><span id="l34.9">  *</span>
<a href="#l34.10"></a><span id="l34.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calItipUtils.jsm&quot;);</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+</span>
<a href="#l34.15"></a><span id="l34.15"> /**</span>
<a href="#l34.16"></a><span id="l34.16">  * This bar lives inside the message window.</span>
<a href="#l34.17"></a><span id="l34.17">  * Its lifetime is the lifetime of the main thunderbird message window.</span>
<a href="#l34.18"></a><span id="l34.18">  */</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-var gItipItem;</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-var gCalItemsArrayFound = [];</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-const onItipItem = {</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-    observe: function observe(subject, topic, state) {</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-        if (topic == &quot;onItipItemCreation&quot;) {</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-            checkForItipItem(subject);</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-        }</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-    }</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-};</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-/**</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">- * Function to get a composite calendar of all registered read-write calendars.</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">- *</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">- * @return composite calendar</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">- */</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-function createItipCompositeCalendar() {</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-    var compCal = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-                            .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-    getCalendarManager().getCalendars({}).filter(isCalendarWritable).forEach(</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineminus">-        function(cal) {</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-            compCal.addCalendar(cal);</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-        });</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-    return compCal;</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-}</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-function checkForItipItem(subject) {</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">-    var itipItem;</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineminus">-    try {</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineminus">-        if (!subject) {</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineminus">-            var msgUri = GetLoadedMessage();</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineminus">-            var sinkProps = msgWindow.msgHeaderSink.properties;</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineminus">-            // This property was set by LightningTextCalendarConverter.js</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineminus">-            itipItem = sinkProps.getPropertyAsInterface(&quot;itipItem&quot;,</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-                                                        Components.interfaces.calIItipItem);</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-        }</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineminus">-    } catch (e) {</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-        // This will throw on every message viewed that doesn't have the</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-        // itipItem property set on it. So we eat the errors and move on.</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-        // XXX TODO: Only swallow the errors we need to. Throw all others.</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-        return;</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-    }</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-    // Get the recipient identity and save it with the itip item.</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-    itipItem.identity = getMsgRecipient();</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-    // We are only called upon receipt of an invite, so ensure that isSend</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-    // is false.</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-    itipItem.isSend = false;</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineminus">-</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-    // XXX Get these from preferences</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-    itipItem.autoResponse = Components.interfaces.calIItipItem.USER;</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-    var imipMethod = getMsgImipMethod();</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-    if (imipMethod &amp;&amp;</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-        imipMethod.length != 0 &amp;&amp;</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-        imipMethod.toLowerCase() != &quot;nomethod&quot;)</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineminus">-    {</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-        itipItem.receivedMethod = imipMethod;</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-    } else {</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-        // There is no METHOD in the content-type header (spec violation).</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-        // Fall back to using the one from the itipItem's ICS.</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-        imipMethod = itipItem.receivedMethod;</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineminus">-    }</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineminus">-</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-    gItipItem = itipItem;</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineminus">-    // XXX Bug 351742: no S/MIME or spoofing protection yet</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineminus">-    // handleImipSecurity(imipMethod);</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineminus">-</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineminus">-    setupBar(imipMethod);</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-}</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineminus">-addEventListener(&quot;messagepane-loaded&quot;, imipOnLoad, true);</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineminus">-addEventListener(&quot;messagepane-unloaded&quot;, imipOnUnload, true);</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineminus">-</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineminus">-/**</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineminus">- * Add self to gMessageListeners defined in msgHdrViewOverlay.js</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">- */</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-function imipOnLoad() {</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineminus">-    var listener = {};</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineminus">-    listener.onStartHeaders = onImipStartHeaders;</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineminus">-    listener.onEndHeaders = onImipEndHeaders;</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineminus">-    gMessageListeners.push(listener);</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineminus">-</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineminus">-    // Set up our observers</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineminus">-    var observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineminus">-                                .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineminus">-    observerSvc.addObserver(onItipItem, &quot;onItipItemCreation&quot;, false);</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-}</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-function imipOnUnload() {</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-    removeEventListener(&quot;messagepane-loaded&quot;, imipOnLoad, true);</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-    removeEventListener(&quot;messagepane-unloaded&quot;, imipOnUnload, true);</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineminus">-    var observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-                                .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-    observerSvc.removeObserver(onItipItem, &quot;onItipItemCreation&quot;);</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineminus">-    gItipItem = null;</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-    gCalItemsArrayFound = [];</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineminus">-}</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineminus">-</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineminus">-function onImipStartHeaders() {</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineminus">-    var imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineminus">-    imipBar.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineminus">-    hideElement(&quot;imip-button1&quot;);</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineminus">-    hideElement(&quot;imip-button2&quot;);</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineminus">-    hideElement(&quot;imip-button3&quot;);</span>
<a href="#l34.130"></a><span id="l34.130" class="difflineminus">-</span>
<a href="#l34.131"></a><span id="l34.131" class="difflineminus">-    // A new message is starting.</span>
<a href="#l34.132"></a><span id="l34.132" class="difflineminus">-    // Clear our iMIP/iTIP stuff so it doesn't contain stale information.</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-    imipMethod = &quot;&quot;;</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-    gItipItem = null;</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineminus">-}</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-/**</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">- * Required by MessageListener. no-op</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineminus">- */</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineminus">-function onImipEndHeaders() {</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineminus">-    // no-op</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-}</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineminus">-function setupBar(imipMethod) {</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineminus">-    // XXX - Bug 348666 - Currently we only do REQUEST requests</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineminus">-    // In the future this function will set up the proper actions</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineminus">-    // and attributes for the buttons as based on the iMIP Method</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineminus">-    var imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-    imipBar.setAttribute(&quot;collapsed&quot;, &quot;false&quot;);</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineminus">-</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineminus">-    if (imipMethod.toUpperCase() == &quot;REQUEST&quot;) {</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-        // Check if this is an update or initial request and display things accordingly</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-        processRequestMsg();</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineminus">-    } else if (imipMethod.toUpperCase() == &quot;REPLY&quot;) {</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineminus">-        // Check if this is an reply and display things accordingly</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineminus">-        processReplyMsg();</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineminus">-    } else if (imipMethod.toUpperCase() == &quot;CANCEL&quot;) {</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineminus">-        // Check if this is an cancel and display things accordingly</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineminus">-        processCancelMsg();</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineminus">-    } else if (imipMethod.toUpperCase() == &quot;PUBLISH&quot;) {</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineminus">-        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarRequestText&quot;));</span>
<a href="#l34.162"></a><span id="l34.162" class="difflineminus">-</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineminus">-        var button = document.getElementById(&quot;imip-button1&quot;);</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-        showElement(button);</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineminus">-        button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAddToCalendar.label&quot;));</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineminus">-        button.setAttribute(&quot;oncommand&quot;, &quot;setAttendeeResponse('PUBLISH', '');&quot;);</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineminus">-    } else {</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineminus">-        // Bug xxxx TBD: Something went wrong or we found a message we don't</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineminus">-        // support yet. We can show a &quot;This method is not supported in this</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineminus">-        // version&quot; or simply hide the iMIP bar at this point</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineminus">-        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarUnsupportedText&quot;));</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineminus">-        Components.utils.reportError(&quot;Unknown imipMethod: &quot; + imipMethod);</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineminus">-    }</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineminus">-}</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineminus">-</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineminus">-function processCancelMsg() {</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineminus">-    var imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.178"></a><span id="l34.178" class="difflineminus">-    imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarCancelText&quot;));</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineminus">-</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineminus">-    var compCal = createItipCompositeCalendar();</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineminus">-    // Per iTIP spec (new Draft 4), multiple items in an iTIP message MUST have</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineminus">-    // same ID, this simplifies our searching, we can just look for Item[0].id</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineminus">-    var itemList = gItipItem.getItemList({});</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineminus">-    var onFindItemListener = {</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineminus">-        onOperationComplete: function ooc(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineminus">-            if (gCalItemsArrayFound.length &gt; 0) {</span>
<a href="#l34.187"></a><span id="l34.187" class="difflineminus">-                displayCancel();</span>
<a href="#l34.188"></a><span id="l34.188" class="difflineminus">-            }</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineminus">-        },</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineminus">-</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineminus">-        onGetResult: function ogr(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineminus">-            for each (var item in aItems) {</span>
<a href="#l34.193"></a><span id="l34.193" class="difflineminus">-                gCalItemsArrayFound.push(aItems[0]);</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineminus">-            }</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-        }</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineminus">-    }</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineminus">-    gCalItemsArrayFound = [];</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-    // Search for item:</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-    compCal.getItem(itemList[0].id, onFindItemListener);</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-}</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineminus">-</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineminus">-function processReplyMsg() {</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineminus">-    var imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineminus">-    imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarReplyText&quot;));</span>
<a href="#l34.205"></a><span id="l34.205" class="difflineminus">-</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineminus">-    var compCal = createItipCompositeCalendar();</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineminus">-    // Per iTIP spec (new Draft 4), multiple items in an iTIP message MUST have</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineminus">-    // same ID, this simplifies our searching, we can just look for Item[0].id</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineminus">-    var itemList = gItipItem.getItemList({});</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineminus">-    var itipItemDate = itemList[0].stampTime;</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineminus">-    // check if ITIP DTSTAMP is in the future</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineminus">-    var nowDate = jsDateToDateTime(new Date());</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineminus">-    if (itipItemDate.compare(nowDate) &gt; 0) {</span>
<a href="#l34.214"></a><span id="l34.214" class="difflineminus">-        itipItemDate = nowDate;</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineminus">-    }</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineminus">-</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-    var onFindItemListener = {</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineminus">-        onOperationComplete: function ooc(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineminus">-            if (gCalItemsArrayFound.length &gt; 0) {</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineminus">-                displayReply();</span>
<a href="#l34.221"></a><span id="l34.221" class="difflineminus">-            }</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineminus">-        },</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineminus">-</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineminus">-        onGetResult: function ogr(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineminus">-            for each (var item in aItems) {</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineminus">-                if (aCalendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineminus">-                    itipItemDate.compare(item.stampTime) &gt; 0) {</span>
<a href="#l34.228"></a><span id="l34.228" class="difflineminus">-                    gCalItemsArrayFound.push(aItems[0]);</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineminus">-                }</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineminus">-            }</span>
<a href="#l34.231"></a><span id="l34.231" class="difflineminus">-        }</span>
<a href="#l34.232"></a><span id="l34.232" class="difflineminus">-    };</span>
<a href="#l34.233"></a><span id="l34.233" class="difflineminus">-    gCalItemsArrayFound = [];</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineminus">-    // Search for item:</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineminus">-    compCal.getItem(itemList[0].id, onFindItemListener);</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineminus">-}</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineminus">-</span>
<a href="#l34.238"></a><span id="l34.238" class="difflineminus">-function displayCancel() {</span>
<a href="#l34.239"></a><span id="l34.239" class="difflineminus">-    var button = document.getElementById(&quot;imip-button1&quot;);</span>
<a href="#l34.240"></a><span id="l34.240" class="difflineminus">-    showElement(button);</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineminus">-    button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipCancelInvitation.label&quot;));</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineminus">-    button.setAttribute(&quot;oncommand&quot;, &quot;deleteItemFromCancel()&quot;);</span>
<a href="#l34.243"></a><span id="l34.243" class="difflineminus">-}</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineminus">-</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineminus">-function displayReply() {</span>
<a href="#l34.246"></a><span id="l34.246" class="difflineminus">-    var button = document.getElementById(&quot;imip-button1&quot;);</span>
<a href="#l34.247"></a><span id="l34.247" class="difflineminus">-    showElement(button);</span>
<a href="#l34.248"></a><span id="l34.248" class="difflineminus">-    button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipUpdateInvitation.label&quot;));</span>
<a href="#l34.249"></a><span id="l34.249" class="difflineminus">-    button.setAttribute(&quot;oncommand&quot;, &quot;updateItemStatusFromReply()&quot;);</span>
<a href="#l34.250"></a><span id="l34.250" class="difflineminus">-}</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineminus">-</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineminus">-function deleteItemFromCancel() {</span>
<a href="#l34.253"></a><span id="l34.253" class="difflineminus">-    var operationListener = {</span>
<a href="#l34.254"></a><span id="l34.254" class="difflineminus">-        onOperationComplete: function ooc(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineminus">-            // Call finishItipAction to set the status of the operation</span>
<a href="#l34.256"></a><span id="l34.256" class="difflineminus">-            finishItipAction(aOperationType, aStatus, aDetail);</span>
<a href="#l34.257"></a><span id="l34.257" class="difflineminus">-        },</span>
<a href="#l34.258"></a><span id="l34.258" class="difflineminus">-</span>
<a href="#l34.259"></a><span id="l34.259" class="difflineminus">-        onGetResult: function ogr(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l34.260"></a><span id="l34.260" class="difflineminus">-        }</span>
<a href="#l34.261"></a><span id="l34.261" class="difflineminus">-    };</span>
<a href="#l34.262"></a><span id="l34.262" class="difflineminus">-</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineminus">-    var itemArray = gItipItem.getItemList({});</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineminus">-    for each (var calItemFound in gCalItemsArrayFound) {</span>
<a href="#l34.265"></a><span id="l34.265" class="difflineminus">-        calItemFound.calendar.deleteItem(calItemFound, operationListener);</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineminus">-    }</span>
<a href="#l34.267"></a><span id="l34.267" class="difflineminus">-</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineminus">-    return true;</span>
<a href="#l34.269"></a><span id="l34.269" class="difflineminus">-}</span>
<a href="#l34.270"></a><span id="l34.270" class="difflineminus">-</span>
<a href="#l34.271"></a><span id="l34.271" class="difflineminus">-function updateItemStatusFromReply() {</span>
<a href="#l34.272"></a><span id="l34.272" class="difflineminus">-    var operationListener = {</span>
<a href="#l34.273"></a><span id="l34.273" class="difflineminus">-        onOperationComplete: function ooc(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l34.274"></a><span id="l34.274" class="difflineminus">-            // Call finishItipAction to set the status of the operation</span>
<a href="#l34.275"></a><span id="l34.275" class="difflineminus">-            finishItipAction(aOperationType, aStatus, aDetail);</span>
<a href="#l34.276"></a><span id="l34.276" class="difflineminus">-        },</span>
<a href="#l34.277"></a><span id="l34.277" class="difflineminus">-</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineminus">-        onGetResult: function ogr(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l34.279"></a><span id="l34.279" class="difflineminus">-        }</span>
<a href="#l34.280"></a><span id="l34.280" class="difflineminus">-    };</span>
<a href="#l34.281"></a><span id="l34.281" class="difflineminus">-</span>
<a href="#l34.282"></a><span id="l34.282" class="difflineminus">-    // Per iTIP spec (new Draft 4), multiple items in an iTIP message MUST have</span>
<a href="#l34.283"></a><span id="l34.283" class="difflineminus">-    // same ID, this simplifies our searching, we can just look for Item[0].id</span>
<a href="#l34.284"></a><span id="l34.284" class="difflineminus">-    var itemArray = gItipItem.getItemList({});</span>
<a href="#l34.285"></a><span id="l34.285" class="difflineminus">-    var itipItem = itemArray[0];</span>
<a href="#l34.286"></a><span id="l34.286" class="difflineminus">-    for each (var calItemFound in gCalItemsArrayFound) {</span>
<a href="#l34.287"></a><span id="l34.287" class="difflineminus">-        var newItem = calItemFound.clone();</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineminus">-        for each (var itipAttendee in itipItem.getAttendees({})) {</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineminus">-            var att = newItem.getAttendeeById(itipAttendee.id);</span>
<a href="#l34.290"></a><span id="l34.290" class="difflineminus">-            if (att) {</span>
<a href="#l34.291"></a><span id="l34.291" class="difflineminus">-                var newAtt = att.clone();</span>
<a href="#l34.292"></a><span id="l34.292" class="difflineminus">-                newItem.removeAttendee(att);</span>
<a href="#l34.293"></a><span id="l34.293" class="difflineminus">-                newAtt.participationStatus = itipAttendee.participationStatus;</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineminus">-                newItem.addAttendee(newAtt);</span>
<a href="#l34.295"></a><span id="l34.295" class="difflineminus">-            }</span>
<a href="#l34.296"></a><span id="l34.296" class="difflineminus">-        }</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineminus">-        newItem.calendar.modifyItem(newItem, calItemFound, operationListener);</span>
<a href="#l34.298"></a><span id="l34.298" class="difflineminus">-    }</span>
<a href="#l34.299"></a><span id="l34.299" class="difflineminus">-</span>
<a href="#l34.300"></a><span id="l34.300" class="difflineminus">-    return true;</span>
<a href="#l34.301"></a><span id="l34.301" class="difflineminus">-}</span>
<a href="#l34.302"></a><span id="l34.302" class="difflineminus">-</span>
<a href="#l34.303"></a><span id="l34.303" class="difflineminus">-function getMsgImipMethod() {</span>
<a href="#l34.304"></a><span id="l34.304" class="difflineminus">-    return messenger.msgHdrFromURI(GetLoadedMessage()).getStringProperty(&quot;imip_method&quot;);</span>
<a href="#l34.305"></a><span id="l34.305" class="difflineminus">-}</span>
<a href="#l34.306"></a><span id="l34.306" class="difflineminus">-</span>
<a href="#l34.307"></a><span id="l34.307" class="difflineminus">-function getMsgRecipient() {</span>
<a href="#l34.308"></a><span id="l34.308" class="difflineminus">-    var imipRecipient = &quot;&quot;;</span>
<a href="#l34.309"></a><span id="l34.309" class="difflineplus">+function ltnGetMsgRecipient() {</span>
<a href="#l34.310"></a><span id="l34.310">     var msgURI = GetLoadedMessage();</span>
<a href="#l34.311"></a><span id="l34.311">     var msgHdr = messenger.msgHdrFromURI(msgURI);</span>
<a href="#l34.312"></a><span id="l34.312">     if (!msgHdr) {</span>
<a href="#l34.313"></a><span id="l34.313">         return null;</span>
<a href="#l34.314"></a><span id="l34.314">     }</span>
<a href="#l34.315"></a><span id="l34.315"> </span>
<a href="#l34.316"></a><span id="l34.316" class="difflineminus">-    var acctmgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l34.317"></a><span id="l34.317" class="difflineminus">-                            .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l34.318"></a><span id="l34.318">     var identities;</span>
<a href="#l34.319"></a><span id="l34.319">     if (msgHdr.accountKey) {</span>
<a href="#l34.320"></a><span id="l34.320">         // First, check if the message has an account key. If so, we can use the</span>
<a href="#l34.321"></a><span id="l34.321">         // account identities to find the correct recipient</span>
<a href="#l34.322"></a><span id="l34.322" class="difflineminus">-        identities = acctmgr.getAccount(msgHdr.accountKey).identities;</span>
<a href="#l34.323"></a><span id="l34.323" class="difflineplus">+        identities = getAccountManager().getAccount(msgHdr.accountKey).identities;</span>
<a href="#l34.324"></a><span id="l34.324">     } else {</span>
<a href="#l34.325"></a><span id="l34.325">         // Without an account key, we have to revert back to using the server</span>
<a href="#l34.326"></a><span id="l34.326" class="difflineminus">-        identities = acctmgr.GetIdentitiesForServer(msgHdr.folder.server);</span>
<a href="#l34.327"></a><span id="l34.327" class="difflineplus">+        identities = getAccountManager().GetIdentitiesForServer(msgHdr.folder.server);</span>
<a href="#l34.328"></a><span id="l34.328">     }</span>
<a href="#l34.329"></a><span id="l34.329"> </span>
<a href="#l34.330"></a><span id="l34.330">     var emailMap = {};</span>
<a href="#l34.331"></a><span id="l34.331">     if (identities.Count() == 0) {</span>
<a href="#l34.332"></a><span id="l34.332">         // If we were not able to retrieve identities above, then we have no</span>
<a href="#l34.333"></a><span id="l34.333">         // choice but to revert to the default identity</span>
<a href="#l34.334"></a><span id="l34.334" class="difflineminus">-        var acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l34.335"></a><span id="l34.335" class="difflineminus">-                                .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l34.336"></a><span id="l34.336" class="difflineminus">-        var identity = acctMgr.defaultAccount.defaultIdentity;</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineplus">+        var identity = getAccountManager().defaultAccount.defaultIdentity;</span>
<a href="#l34.338"></a><span id="l34.338">         if (!identity) {</span>
<a href="#l34.339"></a><span id="l34.339">             // If there isn't a default identity (i.e Local Folders is your</span>
<a href="#l34.340"></a><span id="l34.340">             // default identity), then go ahead and use the first available</span>
<a href="#l34.341"></a><span id="l34.341">             // identity.</span>
<a href="#l34.342"></a><span id="l34.342" class="difflineminus">-            var allIdentities = acctMgr.allIdentities;</span>
<a href="#l34.343"></a><span id="l34.343" class="difflineplus">+            var allIdentities = getAccountManager().allIdentities;</span>
<a href="#l34.344"></a><span id="l34.344">             if (allIdentities.Count() &gt; 0) {</span>
<a href="#l34.345"></a><span id="l34.345">                 identity = allIdentities.GetElementAt(0)</span>
<a href="#l34.346"></a><span id="l34.346">                                         .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l34.347"></a><span id="l34.347">             } else {</span>
<a href="#l34.348"></a><span id="l34.348">                 // If there are no identities at all, we cannot get a recipient.</span>
<a href="#l34.349"></a><span id="l34.349">                 return null;</span>
<a href="#l34.350"></a><span id="l34.350">             }</span>
<a href="#l34.351"></a><span id="l34.351">         }</span>
<a href="#l34.352"></a><span id="l34.352" class="difflineat">@@ -401,337 +112,301 @@ function getMsgRecipient() {</span>
<a href="#l34.353"></a><span id="l34.353">             return recipient;</span>
<a href="#l34.354"></a><span id="l34.354">         }</span>
<a href="#l34.355"></a><span id="l34.355">     }</span>
<a href="#l34.356"></a><span id="l34.356"> </span>
<a href="#l34.357"></a><span id="l34.357">     // Hrmpf. Looks like delegation or maybe Bcc.</span>
<a href="#l34.358"></a><span id="l34.358">     return null;</span>
<a href="#l34.359"></a><span id="l34.359"> }</span>
<a href="#l34.360"></a><span id="l34.360"> </span>
<a href="#l34.361"></a><span id="l34.361" class="difflineplus">+function ltnIsSchedulingCalendar(cal) {</span>
<a href="#l34.362"></a><span id="l34.362" class="difflineplus">+    return (isCalendarWritable(cal) &amp;&amp;</span>
<a href="#l34.363"></a><span id="l34.363" class="difflineplus">+            cal.getProperty(&quot;organizerId&quot;) &amp;&amp;</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineplus">+            cal.getProperty(&quot;itip.transport&quot;));</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineplus">+}</span>
<a href="#l34.366"></a><span id="l34.366" class="difflineplus">+</span>
<a href="#l34.367"></a><span id="l34.367" class="difflineplus">+const ltnOnItipItem = {</span>
<a href="#l34.368"></a><span id="l34.368" class="difflineplus">+    observe: function ltnOnItipItem_observe(subject, topic, state) {</span>
<a href="#l34.369"></a><span id="l34.369" class="difflineplus">+        if (topic == &quot;onItipItemCreation&quot;) {</span>
<a href="#l34.370"></a><span id="l34.370" class="difflineplus">+            let itipItem = null;</span>
<a href="#l34.371"></a><span id="l34.371" class="difflineplus">+            try {</span>
<a href="#l34.372"></a><span id="l34.372" class="difflineplus">+                if (!subject) {</span>
<a href="#l34.373"></a><span id="l34.373" class="difflineplus">+                    let sinkProps = msgWindow.msgHeaderSink.properties;</span>
<a href="#l34.374"></a><span id="l34.374" class="difflineplus">+                    // This property was set by lightningTextCalendarConverter.js</span>
<a href="#l34.375"></a><span id="l34.375" class="difflineplus">+                    itipItem = sinkProps.getPropertyAsInterface(&quot;itipItem&quot;, Components.interfaces.calIItipItem);</span>
<a href="#l34.376"></a><span id="l34.376" class="difflineplus">+                }</span>
<a href="#l34.377"></a><span id="l34.377" class="difflineplus">+            } catch (e) {</span>
<a href="#l34.378"></a><span id="l34.378" class="difflineplus">+                // This will throw on every message viewed that doesn't have the</span>
<a href="#l34.379"></a><span id="l34.379" class="difflineplus">+                // itipItem property set on it. So we eat the errors and move on.</span>
<a href="#l34.380"></a><span id="l34.380" class="difflineplus">+                </span>
<a href="#l34.381"></a><span id="l34.381" class="difflineplus">+                // XXX TODO: Only swallow the errors we need to. Throw all others.</span>
<a href="#l34.382"></a><span id="l34.382" class="difflineplus">+            }</span>
<a href="#l34.383"></a><span id="l34.383" class="difflineplus">+            if (!itipItem) {</span>
<a href="#l34.384"></a><span id="l34.384" class="difflineplus">+                return;</span>
<a href="#l34.385"></a><span id="l34.385" class="difflineplus">+            }</span>
<a href="#l34.386"></a><span id="l34.386" class="difflineplus">+</span>
<a href="#l34.387"></a><span id="l34.387" class="difflineplus">+            // Get the recipient identity and save it with the itip item.</span>
<a href="#l34.388"></a><span id="l34.388" class="difflineplus">+            itipItem.identity = ltnGetMsgRecipient();</span>
<a href="#l34.389"></a><span id="l34.389" class="difflineplus">+</span>
<a href="#l34.390"></a><span id="l34.390" class="difflineplus">+            // We are only called upon receipt of an invite, so ensure that isSend</span>
<a href="#l34.391"></a><span id="l34.391" class="difflineplus">+            // is false.</span>
<a href="#l34.392"></a><span id="l34.392" class="difflineplus">+            itipItem.isSend = false;</span>
<a href="#l34.393"></a><span id="l34.393" class="difflineplus">+</span>
<a href="#l34.394"></a><span id="l34.394" class="difflineplus">+            // XXX Get these from preferences</span>
<a href="#l34.395"></a><span id="l34.395" class="difflineplus">+            itipItem.autoResponse = Components.interfaces.calIItipItem.USER;</span>
<a href="#l34.396"></a><span id="l34.396" class="difflineplus">+</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineplus">+            let imipMethod = messenger.msgHdrFromURI(GetLoadedMessage()).getStringProperty(&quot;imip_method&quot;);</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineplus">+            if (imipMethod &amp;&amp; imipMethod.length != 0 &amp;&amp; imipMethod.toLowerCase() != &quot;nomethod&quot;) {</span>
<a href="#l34.399"></a><span id="l34.399" class="difflineplus">+                itipItem.receivedMethod = imipMethod.toUpperCase();</span>
<a href="#l34.400"></a><span id="l34.400" class="difflineplus">+            } else { // There is no METHOD in the content-type header (spec violation).</span>
<a href="#l34.401"></a><span id="l34.401" class="difflineplus">+                     // Fall back to using the one from the itipItem's ICS.</span>
<a href="#l34.402"></a><span id="l34.402" class="difflineplus">+                imipMethod = itipItem.receivedMethod;</span>
<a href="#l34.403"></a><span id="l34.403" class="difflineplus">+            }</span>
<a href="#l34.404"></a><span id="l34.404" class="difflineplus">+            cal.LOG(&quot;iTIP method: &quot; + imipMethod);</span>
<a href="#l34.405"></a><span id="l34.405" class="difflineplus">+</span>
<a href="#l34.406"></a><span id="l34.406" class="difflineplus">+            let writableCalendars = getCalendarManager().getCalendars({}).filter(ltnIsSchedulingCalendar);</span>
<a href="#l34.407"></a><span id="l34.407" class="difflineplus">+            if (writableCalendars.length &gt; 0) {</span>
<a href="#l34.408"></a><span id="l34.408" class="difflineplus">+                let compCal = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l34.409"></a><span id="l34.409" class="difflineplus">+                                        .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l34.410"></a><span id="l34.410" class="difflineplus">+                writableCalendars.forEach(compCal.addCalendar, compCal);</span>
<a href="#l34.411"></a><span id="l34.411" class="difflineplus">+                itipItem.targetCalendar = compCal;</span>
<a href="#l34.412"></a><span id="l34.412" class="difflineplus">+</span>
<a href="#l34.413"></a><span id="l34.413" class="difflineplus">+                let imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.414"></a><span id="l34.414" class="difflineplus">+                imipBar.setAttribute(&quot;collapsed&quot;, &quot;false&quot;);</span>
<a href="#l34.415"></a><span id="l34.415" class="difflineplus">+                switch (itipItem.receivedMethod) {</span>
<a href="#l34.416"></a><span id="l34.416" class="difflineplus">+                    case &quot;REFRESH&quot;:</span>
<a href="#l34.417"></a><span id="l34.417" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarRefreshText&quot;));</span>
<a href="#l34.418"></a><span id="l34.418" class="difflineplus">+                        break;</span>
<a href="#l34.419"></a><span id="l34.419" class="difflineplus">+                    case &quot;REQUEST&quot;:</span>
<a href="#l34.420"></a><span id="l34.420" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarRequestText&quot;));</span>
<a href="#l34.421"></a><span id="l34.421" class="difflineplus">+                        break;</span>
<a href="#l34.422"></a><span id="l34.422" class="difflineplus">+                    case &quot;PUBLISH&quot;:</span>
<a href="#l34.423"></a><span id="l34.423" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarPublishText&quot;));</span>
<a href="#l34.424"></a><span id="l34.424" class="difflineplus">+                        break;</span>
<a href="#l34.425"></a><span id="l34.425" class="difflineplus">+                    case &quot;CANCEL&quot;:</span>
<a href="#l34.426"></a><span id="l34.426" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarCancelText&quot;));</span>
<a href="#l34.427"></a><span id="l34.427" class="difflineplus">+                        break;</span>
<a href="#l34.428"></a><span id="l34.428" class="difflineplus">+                    case &quot;REPLY&quot;:</span>
<a href="#l34.429"></a><span id="l34.429" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarReplyText&quot;));</span>
<a href="#l34.430"></a><span id="l34.430" class="difflineplus">+                        break;</span>
<a href="#l34.431"></a><span id="l34.431" class="difflineplus">+                    default:</span>
<a href="#l34.432"></a><span id="l34.432" class="difflineplus">+                        // Bug xxxx TBD: Something went wrong or we found a message we don't</span>
<a href="#l34.433"></a><span id="l34.433" class="difflineplus">+                        // support yet. We can show a &quot;This method is not supported in this</span>
<a href="#l34.434"></a><span id="l34.434" class="difflineplus">+                        // version&quot; or simply hide the iMIP bar at this point</span>
<a href="#l34.435"></a><span id="l34.435" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarUnsupportedText&quot;));</span>
<a href="#l34.436"></a><span id="l34.436" class="difflineplus">+                        cal.ERROR(&quot;Unknown iTIP method: &quot; + itipItem.receivedMethod);</span>
<a href="#l34.437"></a><span id="l34.437" class="difflineplus">+                        return;</span>
<a href="#l34.438"></a><span id="l34.438" class="difflineplus">+                }</span>
<a href="#l34.439"></a><span id="l34.439" class="difflineplus">+                cal.itip.processItipItem(itipItem, ltnItipOptions);</span>
<a href="#l34.440"></a><span id="l34.440" class="difflineplus">+            }</span>
<a href="#l34.441"></a><span id="l34.441" class="difflineplus">+        }</span>
<a href="#l34.442"></a><span id="l34.442" class="difflineplus">+    }</span>
<a href="#l34.443"></a><span id="l34.443" class="difflineplus">+};</span>
<a href="#l34.444"></a><span id="l34.444" class="difflineplus">+</span>
<a href="#l34.445"></a><span id="l34.445"> /**</span>
<a href="#l34.446"></a><span id="l34.446" class="difflineminus">- * Call the calendar picker</span>
<a href="#l34.447"></a><span id="l34.447" class="difflineplus">+ * Add self to gMessageListeners defined in msgHdrViewOverlay.js</span>
<a href="#l34.448"></a><span id="l34.448">  */</span>
<a href="#l34.449"></a><span id="l34.449" class="difflineminus">-function getTargetCalendar() {</span>
<a href="#l34.450"></a><span id="l34.450" class="difflineminus">-    function filterCalendars(c) {</span>
<a href="#l34.451"></a><span id="l34.451" class="difflineminus">-        // Only consider calendars that are writable and have a transport.</span>
<a href="#l34.452"></a><span id="l34.452" class="difflineminus">-        return isCalendarWritable(c) &amp;&amp;</span>
<a href="#l34.453"></a><span id="l34.453" class="difflineminus">-               c.getProperty(&quot;itip.transport&quot;) != null;</span>
<a href="#l34.454"></a><span id="l34.454" class="difflineplus">+function ltnImipOnLoad() {</span>
<a href="#l34.455"></a><span id="l34.455" class="difflineplus">+    let listener = {</span>
<a href="#l34.456"></a><span id="l34.456" class="difflineplus">+        onStartHeaders: function onImipStartHeaders() {</span>
<a href="#l34.457"></a><span id="l34.457" class="difflineplus">+            var imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.458"></a><span id="l34.458" class="difflineplus">+            imipBar.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l34.459"></a><span id="l34.459" class="difflineplus">+            hideElement(&quot;imip-button1&quot;);</span>
<a href="#l34.460"></a><span id="l34.460" class="difflineplus">+            hideElement(&quot;imip-button2&quot;);</span>
<a href="#l34.461"></a><span id="l34.461" class="difflineplus">+            hideElement(&quot;imip-button3&quot;);</span>
<a href="#l34.462"></a><span id="l34.462" class="difflineplus">+            // A new message is starting.</span>
<a href="#l34.463"></a><span id="l34.463" class="difflineplus">+            // Clear our iMIP/iTIP stuff so it doesn't contain stale information.</span>
<a href="#l34.464"></a><span id="l34.464" class="difflineplus">+            gItipItem = null;</span>
<a href="#l34.465"></a><span id="l34.465" class="difflineplus">+        },</span>
<a href="#l34.466"></a><span id="l34.466" class="difflineplus">+        onEndHeaders: function onImipEndHeaders() {</span>
<a href="#l34.467"></a><span id="l34.467" class="difflineplus">+        }</span>
<a href="#l34.468"></a><span id="l34.468" class="difflineplus">+    };</span>
<a href="#l34.469"></a><span id="l34.469" class="difflineplus">+    gMessageListeners.push(listener);</span>
<a href="#l34.470"></a><span id="l34.470" class="difflineplus">+</span>
<a href="#l34.471"></a><span id="l34.471" class="difflineplus">+    // Set up our observers</span>
<a href="#l34.472"></a><span id="l34.472" class="difflineplus">+    cal.getObserverService().addObserver(ltnOnItipItem, &quot;onItipItemCreation&quot;, false);</span>
<a href="#l34.473"></a><span id="l34.473" class="difflineplus">+}</span>
<a href="#l34.474"></a><span id="l34.474" class="difflineplus">+</span>
<a href="#l34.475"></a><span id="l34.475" class="difflineplus">+function ltnImipOnUnload() {</span>
<a href="#l34.476"></a><span id="l34.476" class="difflineplus">+    removeEventListener(&quot;messagepane-loaded&quot;, ltnImipOnLoad, true);</span>
<a href="#l34.477"></a><span id="l34.477" class="difflineplus">+    removeEventListener(&quot;messagepane-unloaded&quot;, ltnImipOnUnload, true);</span>
<a href="#l34.478"></a><span id="l34.478" class="difflineplus">+</span>
<a href="#l34.479"></a><span id="l34.479" class="difflineplus">+    cal.getObserverService().removeObserver(ltnOnItipItem, &quot;onItipItemCreation&quot;);</span>
<a href="#l34.480"></a><span id="l34.480" class="difflineplus">+</span>
<a href="#l34.481"></a><span id="l34.481" class="difflineplus">+    gItipItem = null;</span>
<a href="#l34.482"></a><span id="l34.482" class="difflineplus">+    gCalItemsArrayFound = [];</span>
<a href="#l34.483"></a><span id="l34.483" class="difflineplus">+}</span>
<a href="#l34.484"></a><span id="l34.484" class="difflineplus">+</span>
<a href="#l34.485"></a><span id="l34.485" class="difflineplus">+addEventListener(&quot;messagepane-loaded&quot;, ltnImipOnLoad, true);</span>
<a href="#l34.486"></a><span id="l34.486" class="difflineplus">+addEventListener(&quot;messagepane-unloaded&quot;, ltnImipOnUnload, true);</span>
<a href="#l34.487"></a><span id="l34.487" class="difflineplus">+</span>
<a href="#l34.488"></a><span id="l34.488" class="difflineplus">+var gItipItem = null;</span>
<a href="#l34.489"></a><span id="l34.489" class="difflineplus">+var gActionFunc = null;</span>
<a href="#l34.490"></a><span id="l34.490" class="difflineplus">+</span>
<a href="#l34.491"></a><span id="l34.491" class="difflineplus">+function ltnExecAction(partStat) {</span>
<a href="#l34.492"></a><span id="l34.492" class="difflineplus">+    switch (gActionFunc.method) {</span>
<a href="#l34.493"></a><span id="l34.493" class="difflineplus">+        // methods that don't require the calendar chooser:</span>
<a href="#l34.494"></a><span id="l34.494" class="difflineplus">+        case &quot;REFRESH&quot;:</span>
<a href="#l34.495"></a><span id="l34.495" class="difflineplus">+        case &quot;PUBLISH:UPDATE&quot;:</span>
<a href="#l34.496"></a><span id="l34.496" class="difflineplus">+        case &quot;REPLY&quot;:</span>
<a href="#l34.497"></a><span id="l34.497" class="difflineplus">+        case &quot;CANCEL&quot;:</span>
<a href="#l34.498"></a><span id="l34.498" class="difflineplus">+            break;</span>
<a href="#l34.499"></a><span id="l34.499" class="difflineplus">+        default: {</span>
<a href="#l34.500"></a><span id="l34.500" class="difflineplus">+            let cal = ltnGetTargetCalendar(gItipItem);</span>
<a href="#l34.501"></a><span id="l34.501" class="difflineplus">+            if (!cal) {</span>
<a href="#l34.502"></a><span id="l34.502" class="difflineplus">+                return true; // cancelled</span>
<a href="#l34.503"></a><span id="l34.503" class="difflineplus">+            }</span>
<a href="#l34.504"></a><span id="l34.504" class="difflineplus">+            gItipItem.targetCalendar = cal;</span>
<a href="#l34.505"></a><span id="l34.505" class="difflineplus">+            break;</span>
<a href="#l34.506"></a><span id="l34.506" class="difflineplus">+        }</span>
<a href="#l34.507"></a><span id="l34.507">     }</span>
<a href="#l34.508"></a><span id="l34.508"> </span>
<a href="#l34.509"></a><span id="l34.509" class="difflineminus">-    var calendarToReturn;</span>
<a href="#l34.510"></a><span id="l34.510" class="difflineminus">-    var calendars = getCalendarManager().getCalendars({}).filter(filterCalendars);</span>
<a href="#l34.511"></a><span id="l34.511" class="difflineminus">-    // XXXNeed an error message if there is no writable calendar</span>
<a href="#l34.512"></a><span id="l34.512" class="difflineplus">+    // hide the buttons now, to disable pressing them twice...</span>
<a href="#l34.513"></a><span id="l34.513" class="difflineplus">+    hideElement(&quot;imip-button1&quot;);</span>
<a href="#l34.514"></a><span id="l34.514" class="difflineplus">+    hideElement(&quot;imip-button2&quot;);</span>
<a href="#l34.515"></a><span id="l34.515" class="difflineplus">+    hideElement(&quot;imip-button3&quot;);</span>
<a href="#l34.516"></a><span id="l34.516" class="difflineplus">+</span>
<a href="#l34.517"></a><span id="l34.517" class="difflineplus">+    let opListener = {</span>
<a href="#l34.518"></a><span id="l34.518" class="difflineplus">+        onOperationComplete: function ltnItipActionListener_onOperationComplete(aCalendar,</span>
<a href="#l34.519"></a><span id="l34.519" class="difflineplus">+                                                                                aStatus,</span>
<a href="#l34.520"></a><span id="l34.520" class="difflineplus">+                                                                                aOperationType,</span>
<a href="#l34.521"></a><span id="l34.521" class="difflineplus">+                                                                                aId,</span>
<a href="#l34.522"></a><span id="l34.522" class="difflineplus">+                                                                                aDetail) {</span>
<a href="#l34.523"></a><span id="l34.523" class="difflineplus">+            // For now, we just state the status for the user something very simple</span>
<a href="#l34.524"></a><span id="l34.524" class="difflineplus">+            let imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.525"></a><span id="l34.525" class="difflineplus">+            if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l34.526"></a><span id="l34.526" class="difflineplus">+                switch (aOperationType) {</span>
<a href="#l34.527"></a><span id="l34.527" class="difflineplus">+                    case Components.interfaces.calIOperationListener.ADD:</span>
<a href="#l34.528"></a><span id="l34.528" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAddedItemToCal&quot;));</span>
<a href="#l34.529"></a><span id="l34.529" class="difflineplus">+                        break;</span>
<a href="#l34.530"></a><span id="l34.530" class="difflineplus">+                    case Components.interfaces.calIOperationListener.MODIFY:</span>
<a href="#l34.531"></a><span id="l34.531" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipUpdatedItem&quot;));</span>
<a href="#l34.532"></a><span id="l34.532" class="difflineplus">+                        break;</span>
<a href="#l34.533"></a><span id="l34.533" class="difflineplus">+                    case Components.interfaces.calIOperationListener.DELETE:</span>
<a href="#l34.534"></a><span id="l34.534" class="difflineplus">+                        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipCanceledItem&quot;));</span>
<a href="#l34.535"></a><span id="l34.535" class="difflineplus">+                        break;</span>
<a href="#l34.536"></a><span id="l34.536" class="difflineplus">+                }</span>
<a href="#l34.537"></a><span id="l34.537" class="difflineplus">+            } else {</span>
<a href="#l34.538"></a><span id="l34.538" class="difflineplus">+                let msg = ltnGetString(&quot;lightning&quot;, &quot;imipBarProcessingFailed&quot;, [aStatus.toString(16)]);</span>
<a href="#l34.539"></a><span id="l34.539" class="difflineplus">+                imipBar.setAttribute(&quot;label&quot;, msg);</span>
<a href="#l34.540"></a><span id="l34.540" class="difflineplus">+                showError(msg);</span>
<a href="#l34.541"></a><span id="l34.541" class="difflineplus">+            }</span>
<a href="#l34.542"></a><span id="l34.542" class="difflineplus">+        },</span>
<a href="#l34.543"></a><span id="l34.543" class="difflineplus">+        onGetResult: function ltnItipActionListener_onGetResult(aCalendar,</span>
<a href="#l34.544"></a><span id="l34.544" class="difflineplus">+                                                                aStatus,</span>
<a href="#l34.545"></a><span id="l34.545" class="difflineplus">+                                                                aItemType,</span>
<a href="#l34.546"></a><span id="l34.546" class="difflineplus">+                                                                aDetail,</span>
<a href="#l34.547"></a><span id="l34.547" class="difflineplus">+                                                                aCount,</span>
<a href="#l34.548"></a><span id="l34.548" class="difflineplus">+                                                                aItems) {</span>
<a href="#l34.549"></a><span id="l34.549" class="difflineplus">+        }</span>
<a href="#l34.550"></a><span id="l34.550" class="difflineplus">+    };</span>
<a href="#l34.551"></a><span id="l34.551" class="difflineplus">+</span>
<a href="#l34.552"></a><span id="l34.552" class="difflineplus">+    try {</span>
<a href="#l34.553"></a><span id="l34.553" class="difflineplus">+        gActionFunc(opListener, partStat);</span>
<a href="#l34.554"></a><span id="l34.554" class="difflineplus">+    } catch (exc) {</span>
<a href="#l34.555"></a><span id="l34.555" class="difflineplus">+        Components.utils.reportError(exc);</span>
<a href="#l34.556"></a><span id="l34.556" class="difflineplus">+    }</span>
<a href="#l34.557"></a><span id="l34.557" class="difflineplus">+</span>
<a href="#l34.558"></a><span id="l34.558" class="difflineplus">+    return true;</span>
<a href="#l34.559"></a><span id="l34.559" class="difflineplus">+}</span>
<a href="#l34.560"></a><span id="l34.560" class="difflineplus">+</span>
<a href="#l34.561"></a><span id="l34.561" class="difflineplus">+function ltnItipOptions(itipItem, rc, actionFunc) {</span>
<a href="#l34.562"></a><span id="l34.562" class="difflineplus">+    var imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.563"></a><span id="l34.563" class="difflineplus">+    if (Components.isSuccessCode(rc)) {</span>
<a href="#l34.564"></a><span id="l34.564" class="difflineplus">+        if (!actionFunc) {</span>
<a href="#l34.565"></a><span id="l34.565" class="difflineplus">+            // This case, they clicked on an old message that has already been</span>
<a href="#l34.566"></a><span id="l34.566" class="difflineplus">+            // added/updated, we want to tell them that.</span>
<a href="#l34.567"></a><span id="l34.567" class="difflineplus">+            imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarAlreadyProcessedText&quot;));</span>
<a href="#l34.568"></a><span id="l34.568" class="difflineplus">+            return;</span>
<a href="#l34.569"></a><span id="l34.569" class="difflineplus">+        }</span>
<a href="#l34.570"></a><span id="l34.570" class="difflineplus">+</span>
<a href="#l34.571"></a><span id="l34.571" class="difflineplus">+        gItipItem = itipItem;</span>
<a href="#l34.572"></a><span id="l34.572" class="difflineplus">+        gActionFunc = actionFunc;</span>
<a href="#l34.573"></a><span id="l34.573"> </span>
<a href="#l34.574"></a><span id="l34.574" class="difflineminus">-    // try to further limit down the list to those calendars that are configured to a matching attendee;</span>
<a href="#l34.575"></a><span id="l34.575" class="difflineminus">-    var item = gItipItem.getItemList({})[0];</span>
<a href="#l34.576"></a><span id="l34.576" class="difflineminus">-    var matchingCals = calendars.filter(</span>
<a href="#l34.577"></a><span id="l34.577" class="difflineminus">-        function(cal) {</span>
<a href="#l34.578"></a><span id="l34.578" class="difflineminus">-            var identity = cal.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l34.579"></a><span id="l34.579" class="difflineminus">-            if (identity !== null) {</span>
<a href="#l34.580"></a><span id="l34.580" class="difflineminus">-                identity = identity.QueryInterface(Components.interfaces.nsIMsgIdentity).email;</span>
<a href="#l34.581"></a><span id="l34.581" class="difflineminus">-                return ((gItipItem.identity &amp;&amp; (identity.toLowerCase() == gItipItem.identity.toLowerCase())) ||</span>
<a href="#l34.582"></a><span id="l34.582" class="difflineminus">-                        item.getAttendeeById(&quot;mailto:&quot; + identity));</span>
<a href="#l34.583"></a><span id="l34.583" class="difflineplus">+        let button1 = document.getElementById(&quot;imip-button1&quot;);</span>
<a href="#l34.584"></a><span id="l34.584" class="difflineplus">+        let button2 = document.getElementById(&quot;imip-button2&quot;);</span>
<a href="#l34.585"></a><span id="l34.585" class="difflineplus">+        let button3 = document.getElementById(&quot;imip-button3&quot;);</span>
<a href="#l34.586"></a><span id="l34.586" class="difflineplus">+        cal.LOG(&quot;iTIP options on: &quot; + actionFunc.method);</span>
<a href="#l34.587"></a><span id="l34.587" class="difflineplus">+        switch (actionFunc.method) {</span>
<a href="#l34.588"></a><span id="l34.588" class="difflineplus">+            case &quot;REPLY&quot;:</span>
<a href="#l34.589"></a><span id="l34.589" class="difflineplus">+                // fall-thru intended</span>
<a href="#l34.590"></a><span id="l34.590" class="difflineplus">+            case &quot;PUBLISH:UPDATE&quot;:</span>
<a href="#l34.591"></a><span id="l34.591" class="difflineplus">+            case &quot;REQUEST:UPDATE-MINOR&quot;:</span>
<a href="#l34.592"></a><span id="l34.592" class="difflineplus">+                imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarUpdateText&quot;));</span>
<a href="#l34.593"></a><span id="l34.593" class="difflineplus">+                button1.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipUpdate.label&quot;));</span>
<a href="#l34.594"></a><span id="l34.594" class="difflineplus">+                button1.setAttribute(&quot;oncommand&quot;, &quot;return ltnExecAction();&quot;);</span>
<a href="#l34.595"></a><span id="l34.595" class="difflineplus">+                showElement(button1);</span>
<a href="#l34.596"></a><span id="l34.596" class="difflineplus">+                break;</span>
<a href="#l34.597"></a><span id="l34.597" class="difflineplus">+            case &quot;PUBLISH&quot;:</span>
<a href="#l34.598"></a><span id="l34.598" class="difflineplus">+                button1.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAddToCalendar.label&quot;));</span>
<a href="#l34.599"></a><span id="l34.599" class="difflineplus">+                button1.setAttribute(&quot;oncommand&quot;, &quot;return ltnExecAction();&quot;);</span>
<a href="#l34.600"></a><span id="l34.600" class="difflineplus">+                showElement(button1);</span>
<a href="#l34.601"></a><span id="l34.601" class="difflineplus">+                break;</span>
<a href="#l34.602"></a><span id="l34.602" class="difflineplus">+            case &quot;REQUEST:UPDATE&quot;:</span>
<a href="#l34.603"></a><span id="l34.603" class="difflineplus">+                imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarUpdateText&quot;));</span>
<a href="#l34.604"></a><span id="l34.604" class="difflineplus">+                // fall-thru intended</span>
<a href="#l34.605"></a><span id="l34.605" class="difflineplus">+            case &quot;REQUEST&quot;: {</span>
<a href="#l34.606"></a><span id="l34.606" class="difflineplus">+                button1.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAcceptInvitation.label&quot;));</span>
<a href="#l34.607"></a><span id="l34.607" class="difflineplus">+                button1.setAttribute(&quot;oncommand&quot;, &quot;return ltnExecAction('ACCEPTED');&quot;);</span>
<a href="#l34.608"></a><span id="l34.608" class="difflineplus">+                button2.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipDeclineInvitation.label&quot;));</span>
<a href="#l34.609"></a><span id="l34.609" class="difflineplus">+                button2.setAttribute(&quot;oncommand&quot;, &quot;return ltnExecAction('DECLINED');&quot;);</span>
<a href="#l34.610"></a><span id="l34.610" class="difflineplus">+                button3.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAcceptTentativeInvitation.label&quot;));</span>
<a href="#l34.611"></a><span id="l34.611" class="difflineplus">+                button3.setAttribute(&quot;oncommand&quot;, &quot;return ltnExecAction('TENTATIVE');&quot;);</span>
<a href="#l34.612"></a><span id="l34.612" class="difflineplus">+                showElement(button1);</span>
<a href="#l34.613"></a><span id="l34.613" class="difflineplus">+                showElement(button2);</span>
<a href="#l34.614"></a><span id="l34.614" class="difflineplus">+                showElement(button3);</span>
<a href="#l34.615"></a><span id="l34.615" class="difflineplus">+                break;</span>
<a href="#l34.616"></a><span id="l34.616">             }</span>
<a href="#l34.617"></a><span id="l34.617" class="difflineminus">-            return false;</span>
<a href="#l34.618"></a><span id="l34.618" class="difflineminus">-        });</span>
<a href="#l34.619"></a><span id="l34.619" class="difflineminus">-    // if there's none, we will show the whole list of calendars:</span>
<a href="#l34.620"></a><span id="l34.620" class="difflineminus">-    if (matchingCals.length &gt; 0) {</span>
<a href="#l34.621"></a><span id="l34.621" class="difflineminus">-        calendars = matchingCals;</span>
<a href="#l34.622"></a><span id="l34.622" class="difflineplus">+            case &quot;CANCEL&quot;: {</span>
<a href="#l34.623"></a><span id="l34.623" class="difflineplus">+                button1.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipCancelInvitation.label&quot;));</span>
<a href="#l34.624"></a><span id="l34.624" class="difflineplus">+                button1.setAttribute(&quot;oncommand&quot;, &quot;return ltnExecAction();&quot;);</span>
<a href="#l34.625"></a><span id="l34.625" class="difflineplus">+                showElement(button1);</span>
<a href="#l34.626"></a><span id="l34.626" class="difflineplus">+                break;</span>
<a href="#l34.627"></a><span id="l34.627" class="difflineplus">+            }</span>
<a href="#l34.628"></a><span id="l34.628" class="difflineplus">+            case &quot;REFRESH&quot;: {</span>
<a href="#l34.629"></a><span id="l34.629" class="difflineplus">+                button1.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipSend.label&quot;));</span>
<a href="#l34.630"></a><span id="l34.630" class="difflineplus">+                button1.setAttribute(&quot;oncommand&quot;, &quot;return ltnExecAction();&quot;);</span>
<a href="#l34.631"></a><span id="l34.631" class="difflineplus">+                showElement(button1);</span>
<a href="#l34.632"></a><span id="l34.632" class="difflineplus">+                break;</span>
<a href="#l34.633"></a><span id="l34.633" class="difflineplus">+            }</span>
<a href="#l34.634"></a><span id="l34.634" class="difflineplus">+            default:</span>
<a href="#l34.635"></a><span id="l34.635" class="difflineplus">+                imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarUnsupportedText&quot;));</span>
<a href="#l34.636"></a><span id="l34.636" class="difflineplus">+                break;</span>
<a href="#l34.637"></a><span id="l34.637" class="difflineplus">+        }</span>
<a href="#l34.638"></a><span id="l34.638" class="difflineplus">+    } else {</span>
<a href="#l34.639"></a><span id="l34.639" class="difflineplus">+        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarUnsupportedText&quot;));</span>
<a href="#l34.640"></a><span id="l34.640" class="difflineplus">+    }</span>
<a href="#l34.641"></a><span id="l34.641" class="difflineplus">+}</span>
<a href="#l34.642"></a><span id="l34.642" class="difflineplus">+</span>
<a href="#l34.643"></a><span id="l34.643" class="difflineplus">+function ltnGetTargetCalendar(itipItem) {</span>
<a href="#l34.644"></a><span id="l34.644" class="difflineplus">+    let calendarToReturn = null;</span>
<a href="#l34.645"></a><span id="l34.645" class="difflineplus">+    let calendars = getCalendarManager().getCalendars({}).filter(ltnIsSchedulingCalendar);</span>
<a href="#l34.646"></a><span id="l34.646" class="difflineplus">+    // XXXNeed an error message if there is no calendar</span>
<a href="#l34.647"></a><span id="l34.647" class="difflineplus">+</span>
<a href="#l34.648"></a><span id="l34.648" class="difflineplus">+    if (itipItem.receivedMethod == &quot;REQUEST&quot;) {</span>
<a href="#l34.649"></a><span id="l34.649" class="difflineplus">+        // try to further limit down the list to those calendars that are configured to a matching attendee;</span>
<a href="#l34.650"></a><span id="l34.650" class="difflineplus">+        let item = itipItem.getItemList({})[0];</span>
<a href="#l34.651"></a><span id="l34.651" class="difflineplus">+        let matchingCals = calendars.filter(</span>
<a href="#l34.652"></a><span id="l34.652" class="difflineplus">+            function(calendar) {</span>
<a href="#l34.653"></a><span id="l34.653" class="difflineplus">+                return (cal.getInvitedAttendee(item, calendar) != null);</span>
<a href="#l34.654"></a><span id="l34.654" class="difflineplus">+            });</span>
<a href="#l34.655"></a><span id="l34.655" class="difflineplus">+        // if there's none, we will show the whole list of calendars:</span>
<a href="#l34.656"></a><span id="l34.656" class="difflineplus">+        if (matchingCals.length &gt; 0) {</span>
<a href="#l34.657"></a><span id="l34.657" class="difflineplus">+            calendars = matchingCals;</span>
<a href="#l34.658"></a><span id="l34.658" class="difflineplus">+        }</span>
<a href="#l34.659"></a><span id="l34.659">     }</span>
<a href="#l34.660"></a><span id="l34.660"> </span>
<a href="#l34.661"></a><span id="l34.661">     if (calendars.length == 1) {</span>
<a href="#l34.662"></a><span id="l34.662">         // There's only one calendar, so it's silly to ask what calendar</span>
<a href="#l34.663"></a><span id="l34.663">         // the user wants to import into.</span>
<a href="#l34.664"></a><span id="l34.664">         calendarToReturn = calendars[0];</span>
<a href="#l34.665"></a><span id="l34.665">     } else {</span>
<a href="#l34.666"></a><span id="l34.666">         // Ask what calendar to import into</span>
<a href="#l34.667"></a><span id="l34.667" class="difflineminus">-        var args = new Object();</span>
<a href="#l34.668"></a><span id="l34.668" class="difflineminus">-        var aCal;</span>
<a href="#l34.669"></a><span id="l34.669" class="difflineplus">+        var args = {};</span>
<a href="#l34.670"></a><span id="l34.670">         args.calendars = calendars;</span>
<a href="#l34.671"></a><span id="l34.671">         args.onOk = function selectCalendar(aCal) { calendarToReturn = aCal; };</span>
<a href="#l34.672"></a><span id="l34.672">         args.promptText = calGetString(&quot;calendar&quot;, &quot;importPrompt&quot;);</span>
<a href="#l34.673"></a><span id="l34.673">         openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l34.674"></a><span id="l34.674">                    &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l34.675"></a><span id="l34.675">     }</span>
<a href="#l34.676"></a><span id="l34.676"> </span>
<a href="#l34.677"></a><span id="l34.677" class="difflineminus">-    if (calendarToReturn) {</span>
<a href="#l34.678"></a><span id="l34.678" class="difflineminus">-        // assure gItipItem.identity is set to the configured email address:</span>
<a href="#l34.679"></a><span id="l34.679" class="difflineminus">-        var identity = calendarToReturn.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l34.680"></a><span id="l34.680" class="difflineminus">-        if (identity) {</span>
<a href="#l34.681"></a><span id="l34.681" class="difflineminus">-            gItipItem.identity = identity.QueryInterface(Components.interfaces.nsIMsgIdentity).email;</span>
<a href="#l34.682"></a><span id="l34.682" class="difflineminus">-        }</span>
<a href="#l34.683"></a><span id="l34.683" class="difflineminus">-    }</span>
<a href="#l34.684"></a><span id="l34.684">     return calendarToReturn;</span>
<a href="#l34.685"></a><span id="l34.685"> }</span>
<a href="#l34.686"></a><span id="l34.686" class="difflineminus">-</span>
<a href="#l34.687"></a><span id="l34.687" class="difflineminus">-/**</span>
<a href="#l34.688"></a><span id="l34.688" class="difflineminus">- * Type is type of response</span>
<a href="#l34.689"></a><span id="l34.689" class="difflineminus">- * event_status is an optional directive to set the Event STATUS property</span>
<a href="#l34.690"></a><span id="l34.690" class="difflineminus">- */</span>
<a href="#l34.691"></a><span id="l34.691" class="difflineminus">-function setAttendeeResponse(type, eventStatus) {</span>
<a href="#l34.692"></a><span id="l34.692" class="difflineminus">-    if (type &amp;&amp; gItipItem) {</span>
<a href="#l34.693"></a><span id="l34.693" class="difflineminus">-        // Some methods need a target calendar. Prompt for it first.</span>
<a href="#l34.694"></a><span id="l34.694" class="difflineminus">-        switch (type) {</span>
<a href="#l34.695"></a><span id="l34.695" class="difflineminus">-            case &quot;ACCEPTED&quot;:</span>
<a href="#l34.696"></a><span id="l34.696" class="difflineminus">-            case &quot;TENTATIVE&quot;:</span>
<a href="#l34.697"></a><span id="l34.697" class="difflineminus">-            case &quot;REPLY&quot;:</span>
<a href="#l34.698"></a><span id="l34.698" class="difflineminus">-            case &quot;PUBLISH&quot;:</span>
<a href="#l34.699"></a><span id="l34.699" class="difflineminus">-                gItipItem.targetCalendar = getTargetCalendar();</span>
<a href="#l34.700"></a><span id="l34.700" class="difflineminus">-                if (!gItipItem.targetCalendar) {</span>
<a href="#l34.701"></a><span id="l34.701" class="difflineminus">-                    // The dialog was canceled, we are done.</span>
<a href="#l34.702"></a><span id="l34.702" class="difflineminus">-                    return;</span>
<a href="#l34.703"></a><span id="l34.703" class="difflineminus">-                }</span>
<a href="#l34.704"></a><span id="l34.704" class="difflineminus">-        }</span>
<a href="#l34.705"></a><span id="l34.705" class="difflineminus">-</span>
<a href="#l34.706"></a><span id="l34.706" class="difflineminus">-        // Now set the attendee status and perform the iTIP action. If the</span>
<a href="#l34.707"></a><span id="l34.707" class="difflineminus">-        // method is not mentioned here, no further action will be taken.</span>
<a href="#l34.708"></a><span id="l34.708" class="difflineminus">-        switch (type) {</span>
<a href="#l34.709"></a><span id="l34.709" class="difflineminus">-            case &quot;ACCEPTED&quot;:</span>
<a href="#l34.710"></a><span id="l34.710" class="difflineminus">-            case &quot;TENTATIVE&quot;:</span>
<a href="#l34.711"></a><span id="l34.711" class="difflineminus">-            case &quot;DECLINED&quot;: {</span>
<a href="#l34.712"></a><span id="l34.712" class="difflineminus">-                var attId = null;</span>
<a href="#l34.713"></a><span id="l34.713" class="difflineminus">-                var attCN = null;</span>
<a href="#l34.714"></a><span id="l34.714" class="difflineminus">-                if (gItipItem.targetCalendar) {</span>
<a href="#l34.715"></a><span id="l34.715" class="difflineminus">-                    var identity = gItipItem.targetCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l34.716"></a><span id="l34.716" class="difflineminus">-                    if (identity) { // configured email supersedes found msg recipient:</span>
<a href="#l34.717"></a><span id="l34.717" class="difflineminus">-                        identity = identity.QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l34.718"></a><span id="l34.718" class="difflineminus">-                        attId = (&quot;mailto:&quot; + identity.email);</span>
<a href="#l34.719"></a><span id="l34.719" class="difflineminus">-                        attCN = identity.fullName;</span>
<a href="#l34.720"></a><span id="l34.720" class="difflineminus">-                    }</span>
<a href="#l34.721"></a><span id="l34.721" class="difflineminus">-                }</span>
<a href="#l34.722"></a><span id="l34.722" class="difflineminus">-                if (!attId &amp;&amp; gItipItem.identity) {</span>
<a href="#l34.723"></a><span id="l34.723" class="difflineminus">-                    attId = (&quot;mailto:&quot; + gItipItem.identity);</span>
<a href="#l34.724"></a><span id="l34.724" class="difflineminus">-                }</span>
<a href="#l34.725"></a><span id="l34.725" class="difflineminus">-                if (!attId) {</span>
<a href="#l34.726"></a><span id="l34.726" class="difflineminus">-                    // Bug 420516 -- we don't support delegation yet TODO: Localize this?</span>
<a href="#l34.727"></a><span id="l34.727" class="difflineminus">-                    throw new Error(&quot;setAttendeeResponse: &quot; +</span>
<a href="#l34.728"></a><span id="l34.728" class="difflineminus">-                                    &quot;You are not on the list of invited attendees, delegation &quot; +</span>
<a href="#l34.729"></a><span id="l34.729" class="difflineminus">-                                    &quot;is not supported yet.  See bug 420516 for details.&quot;);</span>
<a href="#l34.730"></a><span id="l34.730" class="difflineminus">-                }</span>
<a href="#l34.731"></a><span id="l34.731" class="difflineminus">-                for each (var item in gItipItem.getItemList({})) {</span>
<a href="#l34.732"></a><span id="l34.732" class="difflineminus">-                    if (!item.getAttendeeById(attId)) { // add if not existing, e.g. on mailing list REQUEST</span>
<a href="#l34.733"></a><span id="l34.733" class="difflineminus">-                        var att = Components.classes[&quot;@mozilla.org/calendar/attendee;1&quot;]</span>
<a href="#l34.734"></a><span id="l34.734" class="difflineminus">-                                            .createInstance(Components.interfaces.calIAttendee);</span>
<a href="#l34.735"></a><span id="l34.735" class="difflineminus">-                        att.id = attId;</span>
<a href="#l34.736"></a><span id="l34.736" class="difflineminus">-                        att.commonName = attCN;</span>
<a href="#l34.737"></a><span id="l34.737" class="difflineminus">-                        item.addAttendee(att);</span>
<a href="#l34.738"></a><span id="l34.738" class="difflineminus">-                    }</span>
<a href="#l34.739"></a><span id="l34.739" class="difflineminus">-                }</span>
<a href="#l34.740"></a><span id="l34.740" class="difflineminus">-                gItipItem.setAttendeeStatus(attId, type); // workaround for bug 351589 (fixing RSVP)</span>
<a href="#l34.741"></a><span id="l34.741" class="difflineminus">-                // Fall through</span>
<a href="#l34.742"></a><span id="l34.742" class="difflineminus">-            }</span>
<a href="#l34.743"></a><span id="l34.743" class="difflineminus">-            case &quot;REPLY&quot;:</span>
<a href="#l34.744"></a><span id="l34.744" class="difflineminus">-            case &quot;PUBLISH&quot;:</span>
<a href="#l34.745"></a><span id="l34.745" class="difflineminus">-                doResponse(eventStatus);</span>
<a href="#l34.746"></a><span id="l34.746" class="difflineminus">-                break;</span>
<a href="#l34.747"></a><span id="l34.747" class="difflineminus">-        }</span>
<a href="#l34.748"></a><span id="l34.748" class="difflineminus">-    }</span>
<a href="#l34.749"></a><span id="l34.749" class="difflineminus">-}</span>
<a href="#l34.750"></a><span id="l34.750" class="difflineminus">-</span>
<a href="#l34.751"></a><span id="l34.751" class="difflineminus">-/**</span>
<a href="#l34.752"></a><span id="l34.752" class="difflineminus">- * doResponse performs the iTIP action for the current ItipItem that we</span>
<a href="#l34.753"></a><span id="l34.753" class="difflineminus">- * parsed from the email.</span>
<a href="#l34.754"></a><span id="l34.754" class="difflineminus">- * @param  aLocalStatus  optional parameter to set the event STATUS property.</span>
<a href="#l34.755"></a><span id="l34.755" class="difflineminus">- *         aLocalStatus can be empty, &quot;TENTATIVE&quot;, &quot;CONFIRMED&quot;, or &quot;CANCELLED&quot;</span>
<a href="#l34.756"></a><span id="l34.756" class="difflineminus">- */</span>
<a href="#l34.757"></a><span id="l34.757" class="difflineminus">-function doResponse(aLocalStatus) {</span>
<a href="#l34.758"></a><span id="l34.758" class="difflineminus">-    // calIOperationListener so that we can properly return status to the</span>
<a href="#l34.759"></a><span id="l34.759" class="difflineminus">-    // imip-bar</span>
<a href="#l34.760"></a><span id="l34.760" class="difflineminus">-    var operationListener = {</span>
<a href="#l34.761"></a><span id="l34.761" class="difflineminus">-        onOperationComplete:</span>
<a href="#l34.762"></a><span id="l34.762" class="difflineminus">-        function ooc(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l34.763"></a><span id="l34.763" class="difflineminus">-            // Call finishItipAction to set the status of the operation</span>
<a href="#l34.764"></a><span id="l34.764" class="difflineminus">-            finishItipAction(aOperationType, aStatus, aDetail);</span>
<a href="#l34.765"></a><span id="l34.765" class="difflineminus">-        },</span>
<a href="#l34.766"></a><span id="l34.766" class="difflineminus">-</span>
<a href="#l34.767"></a><span id="l34.767" class="difflineminus">-        onGetResult:</span>
<a href="#l34.768"></a><span id="l34.768" class="difflineminus">-        function ogr(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l34.769"></a><span id="l34.769" class="difflineminus">-            // no-op</span>
<a href="#l34.770"></a><span id="l34.770" class="difflineminus">-        }</span>
<a href="#l34.771"></a><span id="l34.771" class="difflineminus">-    };</span>
<a href="#l34.772"></a><span id="l34.772" class="difflineminus">-</span>
<a href="#l34.773"></a><span id="l34.773" class="difflineminus">-    // The spec is unclear if we must add all the items or if the</span>
<a href="#l34.774"></a><span id="l34.774" class="difflineminus">-    // user should get to pick which item gets added.</span>
<a href="#l34.775"></a><span id="l34.775" class="difflineminus">-</span>
<a href="#l34.776"></a><span id="l34.776" class="difflineminus">-    if (aLocalStatus != null) {</span>
<a href="#l34.777"></a><span id="l34.777" class="difflineminus">-        gItipItem.localStatus = aLocalStatus;</span>
<a href="#l34.778"></a><span id="l34.778" class="difflineminus">-    }</span>
<a href="#l34.779"></a><span id="l34.779" class="difflineminus">-</span>
<a href="#l34.780"></a><span id="l34.780" class="difflineminus">-    var itipProc = Components.classes[&quot;@mozilla.org/calendar/itip-processor;1&quot;]</span>
<a href="#l34.781"></a><span id="l34.781" class="difflineminus">-                             .getService(Components.interfaces.calIItipProcessor);</span>
<a href="#l34.782"></a><span id="l34.782" class="difflineminus">-</span>
<a href="#l34.783"></a><span id="l34.783" class="difflineminus">-    itipProc.processItipItem(gItipItem, operationListener);</span>
<a href="#l34.784"></a><span id="l34.784" class="difflineminus">-}</span>
<a href="#l34.785"></a><span id="l34.785" class="difflineminus">-</span>
<a href="#l34.786"></a><span id="l34.786" class="difflineminus">-/**</span>
<a href="#l34.787"></a><span id="l34.787" class="difflineminus">- * Bug 348666 (complete iTIP support) - This gives the user an indication</span>
<a href="#l34.788"></a><span id="l34.788" class="difflineminus">- * that the Action occurred.</span>
<a href="#l34.789"></a><span id="l34.789" class="difflineminus">- *</span>
<a href="#l34.790"></a><span id="l34.790" class="difflineminus">- * In the future, this will store the status of the invitation in the</span>
<a href="#l34.791"></a><span id="l34.791" class="difflineminus">- * invitation manager.  This will enable us to provide the ability to request</span>
<a href="#l34.792"></a><span id="l34.792" class="difflineminus">- * updates from the organizer and to suggest changes to invitations.</span>
<a href="#l34.793"></a><span id="l34.793" class="difflineminus">- *</span>
<a href="#l34.794"></a><span id="l34.794" class="difflineminus">- * Currently, this is called from our calIOperationListener that is sent to</span>
<a href="#l34.795"></a><span id="l34.795" class="difflineminus">- * the ItipProcessor. This conveys the status of the local iTIP processing</span>
<a href="#l34.796"></a><span id="l34.796" class="difflineminus">- * on your calendar. It does not convey the success or failure of sending a</span>
<a href="#l34.797"></a><span id="l34.797" class="difflineminus">- * response to the ItipItem.</span>
<a href="#l34.798"></a><span id="l34.798" class="difflineminus">- */</span>
<a href="#l34.799"></a><span id="l34.799" class="difflineminus">-function finishItipAction(aOperationType, aStatus, aDetail) {</span>
<a href="#l34.800"></a><span id="l34.800" class="difflineminus">-    // For now, we just state the status for the user something very simple</span>
<a href="#l34.801"></a><span id="l34.801" class="difflineminus">-    var imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.802"></a><span id="l34.802" class="difflineminus">-    if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l34.803"></a><span id="l34.803" class="difflineminus">-        if (aOperationType == Components.interfaces.calIOperationListener.ADD) {</span>
<a href="#l34.804"></a><span id="l34.804" class="difflineminus">-            imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAddedItemToCal&quot;));</span>
<a href="#l34.805"></a><span id="l34.805" class="difflineminus">-        } else if (aOperationType == Components.interfaces.calIOperationListener.MODIFY) {</span>
<a href="#l34.806"></a><span id="l34.806" class="difflineminus">-            imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipUpdatedItem&quot;));</span>
<a href="#l34.807"></a><span id="l34.807" class="difflineminus">-        } else if (aOperationType == Components.interfaces.calIOperationListener.DELETE) {</span>
<a href="#l34.808"></a><span id="l34.808" class="difflineminus">-            imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipCanceledItem&quot;));</span>
<a href="#l34.809"></a><span id="l34.809" class="difflineminus">-        }</span>
<a href="#l34.810"></a><span id="l34.810" class="difflineminus">-</span>
<a href="#l34.811"></a><span id="l34.811" class="difflineminus">-        hideElement(&quot;imip-button1&quot;);</span>
<a href="#l34.812"></a><span id="l34.812" class="difflineminus">-        hideElement(&quot;imip-button2&quot;);</span>
<a href="#l34.813"></a><span id="l34.813" class="difflineminus">-        hideElement(&quot;imip-button3&quot;);</span>
<a href="#l34.814"></a><span id="l34.814" class="difflineminus">-    } else {</span>
<a href="#l34.815"></a><span id="l34.815" class="difflineminus">-        // Bug 348666: When we handle more iTIP methods, we need to create</span>
<a href="#l34.816"></a><span id="l34.816" class="difflineminus">-        // more sophisticated error handling.</span>
<a href="#l34.817"></a><span id="l34.817" class="difflineminus">-        // TODO L10N localize</span>
<a href="#l34.818"></a><span id="l34.818" class="difflineminus">-        imipBar.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l34.819"></a><span id="l34.819" class="difflineminus">-        var msg = &quot;Invitation could not be processed. Status: &quot; + aStatus;</span>
<a href="#l34.820"></a><span id="l34.820" class="difflineminus">-        if (aDetail) {</span>
<a href="#l34.821"></a><span id="l34.821" class="difflineminus">-            msg += &quot;\nDetails: &quot; + aDetail;</span>
<a href="#l34.822"></a><span id="l34.822" class="difflineminus">-        }</span>
<a href="#l34.823"></a><span id="l34.823" class="difflineminus">-        showError(msg);</span>
<a href="#l34.824"></a><span id="l34.824" class="difflineminus">-    }</span>
<a href="#l34.825"></a><span id="l34.825" class="difflineminus">-}</span>
<a href="#l34.826"></a><span id="l34.826" class="difflineminus">-</span>
<a href="#l34.827"></a><span id="l34.827" class="difflineminus">-/**</span>
<a href="#l34.828"></a><span id="l34.828" class="difflineminus">- * Walks through the list of events in the iTipItem and discovers whether or not</span>
<a href="#l34.829"></a><span id="l34.829" class="difflineminus">- * these events already exist on a calendar. Calls displayRequestMethod.</span>
<a href="#l34.830"></a><span id="l34.830" class="difflineminus">- */</span>
<a href="#l34.831"></a><span id="l34.831" class="difflineminus">-function processRequestMsg() {</span>
<a href="#l34.832"></a><span id="l34.832" class="difflineminus">-    // According to the specification, we have to determine if the event ID</span>
<a href="#l34.833"></a><span id="l34.833" class="difflineminus">-    // already exists on the calendar of the user - that means we have to search</span>
<a href="#l34.834"></a><span id="l34.834" class="difflineminus">-    // them all. :-(</span>
<a href="#l34.835"></a><span id="l34.835" class="difflineminus">-    var existingItemSequence = -1;</span>
<a href="#l34.836"></a><span id="l34.836" class="difflineminus">-</span>
<a href="#l34.837"></a><span id="l34.837" class="difflineminus">-    var compCal = createItipCompositeCalendar();</span>
<a href="#l34.838"></a><span id="l34.838" class="difflineminus">-</span>
<a href="#l34.839"></a><span id="l34.839" class="difflineminus">-    // Per iTIP spec (new Draft 4), multiple items in an iTIP message MUST have</span>
<a href="#l34.840"></a><span id="l34.840" class="difflineminus">-    // same ID, this simplifies our searching, we can just look for Item[0].id</span>
<a href="#l34.841"></a><span id="l34.841" class="difflineminus">-    var itemList = gItipItem.getItemList({ });</span>
<a href="#l34.842"></a><span id="l34.842" class="difflineminus">-    var newSequence = itemList[0].getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l34.843"></a><span id="l34.843" class="difflineminus">-</span>
<a href="#l34.844"></a><span id="l34.844" class="difflineminus">-    // Make sure we don't have a pre Outlook 2007 appointment, but if we do</span>
<a href="#l34.845"></a><span id="l34.845" class="difflineminus">-    // use Microsoft's Sequence number. I &lt;3 MS</span>
<a href="#l34.846"></a><span id="l34.846" class="difflineminus">-    if ((newSequence == &quot;0&quot;) &amp;&amp;</span>
<a href="#l34.847"></a><span id="l34.847" class="difflineminus">-        itemList[0].hasProperty(&quot;X-MICROSOFT-CDO-APPT-SEQUENCE&quot;)) {</span>
<a href="#l34.848"></a><span id="l34.848" class="difflineminus">-        newSequence = itemList[0].getProperty(&quot;X-MICROSOFT-CDO-APPT-SEQUENCE&quot;);</span>
<a href="#l34.849"></a><span id="l34.849" class="difflineminus">-    }</span>
<a href="#l34.850"></a><span id="l34.850" class="difflineminus">-</span>
<a href="#l34.851"></a><span id="l34.851" class="difflineminus">-    var onFindItemListener = {</span>
<a href="#l34.852"></a><span id="l34.852" class="difflineminus">-        onOperationComplete:</span>
<a href="#l34.853"></a><span id="l34.853" class="difflineminus">-        function ooc(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l34.854"></a><span id="l34.854" class="difflineminus">-            if (!this.processedId){</span>
<a href="#l34.855"></a><span id="l34.855" class="difflineminus">-                // Then the ID doesn't exist, don't call us twice</span>
<a href="#l34.856"></a><span id="l34.856" class="difflineminus">-                this.processedId = true;</span>
<a href="#l34.857"></a><span id="l34.857" class="difflineminus">-                displayRequestMethod(newSequence, -1);</span>
<a href="#l34.858"></a><span id="l34.858" class="difflineminus">-            }</span>
<a href="#l34.859"></a><span id="l34.859" class="difflineminus">-        },</span>
<a href="#l34.860"></a><span id="l34.860" class="difflineminus">-</span>
<a href="#l34.861"></a><span id="l34.861" class="difflineminus">-        onGetResult:</span>
<a href="#l34.862"></a><span id="l34.862" class="difflineminus">-        function ogr(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l34.863"></a><span id="l34.863" class="difflineminus">-            if (aCount &amp;&amp; aItems[0] &amp;&amp; !this.processedId) {</span>
<a href="#l34.864"></a><span id="l34.864" class="difflineminus">-                this.processedId = true;</span>
<a href="#l34.865"></a><span id="l34.865" class="difflineminus">-                var existingSequence = aItems[0].getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l34.866"></a><span id="l34.866" class="difflineminus">-</span>
<a href="#l34.867"></a><span id="l34.867" class="difflineminus">-                // Handle the microsoftism foolishness</span>
<a href="#l34.868"></a><span id="l34.868" class="difflineminus">-                if ((existingSequence == &quot;0&quot;) &amp;&amp;</span>
<a href="#l34.869"></a><span id="l34.869" class="difflineminus">-                    itemList[0].hasProperty(&quot;X-MICROSOFT-CDO-APPT-SEQUENCE&quot;)) {</span>
<a href="#l34.870"></a><span id="l34.870" class="difflineminus">-                    existingSequence = aItems[0].getProperty(&quot;X-MICROSOFT-CDO-APPT-SEQUENCE&quot;);</span>
<a href="#l34.871"></a><span id="l34.871" class="difflineminus">-                }</span>
<a href="#l34.872"></a><span id="l34.872" class="difflineminus">-</span>
<a href="#l34.873"></a><span id="l34.873" class="difflineminus">-                if (aCalendar.getProperty(&quot;itip.disableRevisionChecks&quot;)) {</span>
<a href="#l34.874"></a><span id="l34.874" class="difflineminus">-                    displayRequestMethod(1, 0); // force to be an update</span>
<a href="#l34.875"></a><span id="l34.875" class="difflineminus">-                } else {</span>
<a href="#l34.876"></a><span id="l34.876" class="difflineminus">-                    displayRequestMethod(newSequence, existingSequence);</span>
<a href="#l34.877"></a><span id="l34.877" class="difflineminus">-                }</span>
<a href="#l34.878"></a><span id="l34.878" class="difflineminus">-            }</span>
<a href="#l34.879"></a><span id="l34.879" class="difflineminus">-        }</span>
<a href="#l34.880"></a><span id="l34.880" class="difflineminus">-    };</span>
<a href="#l34.881"></a><span id="l34.881" class="difflineminus">-    // Search</span>
<a href="#l34.882"></a><span id="l34.882" class="difflineminus">-    compCal.getItem(itemList[0].id, onFindItemListener);</span>
<a href="#l34.883"></a><span id="l34.883" class="difflineminus">-}</span>
<a href="#l34.884"></a><span id="l34.884" class="difflineminus">-</span>
<a href="#l34.885"></a><span id="l34.885" class="difflineminus">-function displayRequestMethod(newItemSequence, existingItemSequence) {</span>
<a href="#l34.886"></a><span id="l34.886" class="difflineminus">-</span>
<a href="#l34.887"></a><span id="l34.887" class="difflineminus">-    // Three states here:</span>
<a href="#l34.888"></a><span id="l34.888" class="difflineminus">-    // 0 = the new event does not exist on the calendar (therefore, this is an add)</span>
<a href="#l34.889"></a><span id="l34.889" class="difflineminus">-    //     (Item does not exist yet: existingItemSequence == -1)</span>
<a href="#l34.890"></a><span id="l34.890" class="difflineminus">-    // 1 = the event does exist and contains a proper update (this is an update)</span>
<a href="#l34.891"></a><span id="l34.891" class="difflineminus">-    //     (Item has been updated: newSequence &gt; existingSequence)</span>
<a href="#l34.892"></a><span id="l34.892" class="difflineminus">-    // 2 = the event clicked on is an old update and should NOT be applied</span>
<a href="#l34.893"></a><span id="l34.893" class="difflineminus">-    //     (Item is an old message that has already been added/updated: new &lt;= existing)</span>
<a href="#l34.894"></a><span id="l34.894" class="difflineminus">-    var updateValue = 0;</span>
<a href="#l34.895"></a><span id="l34.895" class="difflineminus">-</span>
<a href="#l34.896"></a><span id="l34.896" class="difflineminus">-    if (existingItemSequence == -1) {</span>
<a href="#l34.897"></a><span id="l34.897" class="difflineminus">-        updateValue = 0;</span>
<a href="#l34.898"></a><span id="l34.898" class="difflineminus">-    } else if (newItemSequence &gt; existingItemSequence) {</span>
<a href="#l34.899"></a><span id="l34.899" class="difflineminus">-        updateValue = 1;</span>
<a href="#l34.900"></a><span id="l34.900" class="difflineminus">-    } else {</span>
<a href="#l34.901"></a><span id="l34.901" class="difflineminus">-        updateValue = 2;</span>
<a href="#l34.902"></a><span id="l34.902" class="difflineminus">-    }</span>
<a href="#l34.903"></a><span id="l34.903" class="difflineminus">-</span>
<a href="#l34.904"></a><span id="l34.904" class="difflineminus">-    // now display the proper message for this update type:</span>
<a href="#l34.905"></a><span id="l34.905" class="difflineminus">-</span>
<a href="#l34.906"></a><span id="l34.906" class="difflineminus">-    var imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l34.907"></a><span id="l34.907" class="difflineminus">-    if (updateValue) {</span>
<a href="#l34.908"></a><span id="l34.908" class="difflineminus">-        // This is a message updating existing event(s). But updateValue could</span>
<a href="#l34.909"></a><span id="l34.909" class="difflineminus">-        // indicate that this update has already been applied, check that first.</span>
<a href="#l34.910"></a><span id="l34.910" class="difflineminus">-        if (updateValue == 2) {</span>
<a href="#l34.911"></a><span id="l34.911" class="difflineminus">-            // This case, they clicked on an old message that has already been</span>
<a href="#l34.912"></a><span id="l34.912" class="difflineminus">-            // added/updated, we want to tell them that.</span>
<a href="#l34.913"></a><span id="l34.913" class="difflineminus">-            imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarAlreadyAddedText&quot;));</span>
<a href="#l34.914"></a><span id="l34.914" class="difflineminus">-</span>
<a href="#l34.915"></a><span id="l34.915" class="difflineminus">-            hideElement(&quot;imip-button1&quot;);</span>
<a href="#l34.916"></a><span id="l34.916" class="difflineminus">-            hideElement(&quot;imip-button2&quot;);</span>
<a href="#l34.917"></a><span id="l34.917" class="difflineminus">-            hideElement(&quot;imip-button3&quot;);</span>
<a href="#l34.918"></a><span id="l34.918" class="difflineminus">-        } else {</span>
<a href="#l34.919"></a><span id="l34.919" class="difflineminus">-            // Legitimate update, let's offer the update path</span>
<a href="#l34.920"></a><span id="l34.920" class="difflineminus">-            imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarUpdateText&quot;));</span>
<a href="#l34.921"></a><span id="l34.921" class="difflineminus">-</span>
<a href="#l34.922"></a><span id="l34.922" class="difflineminus">-            var button = document.getElementById(&quot;imip-button1&quot;);</span>
<a href="#l34.923"></a><span id="l34.923" class="difflineminus">-            showElement(button);</span>
<a href="#l34.924"></a><span id="l34.924" class="difflineminus">-            button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipUpdateInvitation.label&quot;));</span>
<a href="#l34.925"></a><span id="l34.925" class="difflineminus">-            button.setAttribute(&quot;oncommand&quot;, &quot;setAttendeeResponse('ACCEPTED', 'CONFIRMED');&quot;);</span>
<a href="#l34.926"></a><span id="l34.926" class="difflineminus">-</span>
<a href="#l34.927"></a><span id="l34.927" class="difflineminus">-            // Create a DECLINE button (user chooses not to attend the updated event)</span>
<a href="#l34.928"></a><span id="l34.928" class="difflineminus">-            button = document.getElementById(&quot;imip-button2&quot;);</span>
<a href="#l34.929"></a><span id="l34.929" class="difflineminus">-            showElement(button);</span>
<a href="#l34.930"></a><span id="l34.930" class="difflineminus">-            button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipDeclineInvitation.label&quot;));</span>
<a href="#l34.931"></a><span id="l34.931" class="difflineminus">-            button.setAttribute(&quot;oncommand&quot;, &quot;setAttendeeResponse('DECLINED', 'CONFIRMED');&quot;);</span>
<a href="#l34.932"></a><span id="l34.932" class="difflineminus">-</span>
<a href="#l34.933"></a><span id="l34.933" class="difflineminus">-            // Create a ACCEPT TENTATIVE button</span>
<a href="#l34.934"></a><span id="l34.934" class="difflineminus">-            button = document.getElementById(&quot;imip-button3&quot;);</span>
<a href="#l34.935"></a><span id="l34.935" class="difflineminus">-            showElement(button);</span>
<a href="#l34.936"></a><span id="l34.936" class="difflineminus">-            button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAcceptTentativeInvitation.label&quot;));</span>
<a href="#l34.937"></a><span id="l34.937" class="difflineminus">-            button.setAttribute(&quot;oncommand&quot;, &quot;setAttendeeResponse('TENTATIVE', 'CONFIRMED');&quot;);</span>
<a href="#l34.938"></a><span id="l34.938" class="difflineminus">-        }</span>
<a href="#l34.939"></a><span id="l34.939" class="difflineminus">-    } else {</span>
<a href="#l34.940"></a><span id="l34.940" class="difflineminus">-        imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarRequestText&quot;));</span>
<a href="#l34.941"></a><span id="l34.941" class="difflineminus">-</span>
<a href="#l34.942"></a><span id="l34.942" class="difflineminus">-        var button = document.getElementById(&quot;imip-button1&quot;);</span>
<a href="#l34.943"></a><span id="l34.943" class="difflineminus">-        showElement(button);</span>
<a href="#l34.944"></a><span id="l34.944" class="difflineminus">-        button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAcceptInvitation.label&quot;));</span>
<a href="#l34.945"></a><span id="l34.945" class="difflineminus">-        button.setAttribute(&quot;oncommand&quot;, &quot;setAttendeeResponse('ACCEPTED', 'CONFIRMED');&quot;);</span>
<a href="#l34.946"></a><span id="l34.946" class="difflineminus">-</span>
<a href="#l34.947"></a><span id="l34.947" class="difflineminus">-        // Create a DECLINE button</span>
<a href="#l34.948"></a><span id="l34.948" class="difflineminus">-        button = document.getElementById(&quot;imip-button2&quot;);</span>
<a href="#l34.949"></a><span id="l34.949" class="difflineminus">-        showElement(button);</span>
<a href="#l34.950"></a><span id="l34.950" class="difflineminus">-        button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipDeclineInvitation.label&quot;));</span>
<a href="#l34.951"></a><span id="l34.951" class="difflineminus">-        button.setAttribute(&quot;oncommand&quot;, &quot;setAttendeeResponse('DECLINED', 'CONFIRMED');&quot;);</span>
<a href="#l34.952"></a><span id="l34.952" class="difflineminus">-</span>
<a href="#l34.953"></a><span id="l34.953" class="difflineminus">-        // Create a ACCEPT TENTATIVE button</span>
<a href="#l34.954"></a><span id="l34.954" class="difflineminus">-        button = document.getElementById(&quot;imip-button3&quot;);</span>
<a href="#l34.955"></a><span id="l34.955" class="difflineminus">-        showElement(button);</span>
<a href="#l34.956"></a><span id="l34.956" class="difflineminus">-        button.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipAcceptTentativeInvitation.label&quot;));</span>
<a href="#l34.957"></a><span id="l34.957" class="difflineminus">-        button.setAttribute(&quot;oncommand&quot;, &quot;setAttendeeResponse('TENTATIVE', 'CONFIRMED');&quot;);</span>
<a href="#l34.958"></a><span id="l34.958" class="difflineminus">-    }</span>
<a href="#l34.959"></a><span id="l34.959" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/lightning/content/lightning-utils.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-utils.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -33,45 +33,28 @@</span>
<a href="#l35.4"></a><span id="l35.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.5"></a><span id="l35.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l35.6"></a><span id="l35.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l35.7"></a><span id="l35.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l35.8"></a><span id="l35.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l35.9"></a><span id="l35.9">  *</span>
<a href="#l35.10"></a><span id="l35.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+</span>
<a href="#l35.14"></a><span id="l35.14"> /**</span>
<a href="#l35.15"></a><span id="l35.15">  * Gets the value of a string in a .properties file from the lightning bundle</span>
<a href="#l35.16"></a><span id="l35.16">  *</span>
<a href="#l35.17"></a><span id="l35.17">  * @param aBundleName  the name of the properties file.  It is assumed that the</span>
<a href="#l35.18"></a><span id="l35.18">  *                     file lives in chrome://lightning/locale/</span>
<a href="#l35.19"></a><span id="l35.19">  * @param aStringName  the name of the string within the properties file</span>
<a href="#l35.20"></a><span id="l35.20">  * @param aParams      optional array of parameters to format the string</span>
<a href="#l35.21"></a><span id="l35.21">  */</span>
<a href="#l35.22"></a><span id="l35.22"> function ltnGetString(aBundleName, aStringName, aParams) {</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-    if (ltnGetString.mSBS === undefined) {</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-        ltnGetString.mSBS = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">-                            .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineminus">-    }</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineminus">-</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-    try {</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-        var propName = &quot;chrome://lightning/locale/&quot;+aBundleName+&quot;.properties&quot;;</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-        var props = ltnGetString.mSBS.createBundle(propName);</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-        if (aParams &amp;&amp; aParams.length) {</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-            return props.formatStringFromName(aStringName, aParams, aParams.length);</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-        } else {</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-            return props.GetStringFromName(aStringName);</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineminus">-        }</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">-    } catch (ex) {</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">-        var s = &quot;Failed to read '&quot; + aStringName + &quot;' from &quot; +</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">-                &quot;'chrome://lightning/locale/&quot; + aBundleName + &quot;.properties'.&quot;;</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineminus">-        Components.utils.reportError(s + &quot; Error: &quot; + ex);</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-        return s;</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-    }</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+    return cal.calGetString(aBundleName, aStringName, aParams, &quot;lightning&quot;);</span>
<a href="#l35.44"></a><span id="l35.44"> }</span>
<a href="#l35.45"></a><span id="l35.45"> </span>
<a href="#l35.46"></a><span id="l35.46"> // shared by lightning-calendar-properties.js and lightning-calendar-creation.js:</span>
<a href="#l35.47"></a><span id="l35.47"> function ltnInitMailIdentitiesRow() {</span>
<a href="#l35.48"></a><span id="l35.48">     if (!gCalendar) {</span>
<a href="#l35.49"></a><span id="l35.49">         collapseElement(&quot;calendar-email-identity-row&quot;);</span>
<a href="#l35.50"></a><span id="l35.50">     }</span>
<a href="#l35.51"></a><span id="l35.51"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/lightning/content/lightning.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/lightning/content/lightning.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -80,16 +80,19 @@ pref(&quot;calendar.invitations.autorefresh.t</span>
<a href="#l36.4"></a><span id="l36.4"> // 0 -- Outlook 2003 and following with text/plain and application/ics (default)</span>
<a href="#l36.5"></a><span id="l36.5"> // 1 -- all Outlook, but no text/plain nor application/ics</span>
<a href="#l36.6"></a><span id="l36.6"> // We may extend the compat mode if necessary.</span>
<a href="#l36.7"></a><span id="l36.7"> pref(&quot;calendar.itip.compatSendMode&quot;, 0);</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9"> // whether &quot;notify&quot; is checked by default when creating new events/todos with attendees</span>
<a href="#l36.10"></a><span id="l36.10"> pref(&quot;calendar.itip.notify&quot;, true);</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+// whether the organizer propagates replies of attendees to all attendees</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+pref(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+</span>
<a href="#l36.15"></a><span id="l36.15"> // whether CalDAV (experimental) scheduling is enabled or not.</span>
<a href="#l36.16"></a><span id="l36.16"> pref(&quot;calendar.caldav.sched.enabled&quot;, false);</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18"> // 0=Sunday, 1=Monday, 2=Tuesday, etc.  One day we might want to move this to</span>
<a href="#l36.19"></a><span id="l36.19"> // a locale specific file.</span>
<a href="#l36.20"></a><span id="l36.20"> pref(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l36.21"></a><span id="l36.21"> pref(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l36.22"></a><span id="l36.22"> pref(&quot;calendar.previousweeks.inview&quot;, 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/calendar.properties</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/calendar/calendar.properties</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -153,17 +153,17 @@ filepickerTitleExport=Export</span>
<a href="#l37.4"></a><span id="l37.4"> # wildmat used to filter files by extension, such as (*.html; *.htm).</span>
<a href="#l37.5"></a><span id="l37.5"> filterIcs=iCalendar (%1$S)</span>
<a href="#l37.6"></a><span id="l37.6"> filterXml=XML Document (%1$S)</span>
<a href="#l37.7"></a><span id="l37.7"> filterHtml=Web Page (%1$S)</span>
<a href="#l37.8"></a><span id="l37.8"> filterOutlookCsv=Outlook Comma Separated Values (%1$S)</span>
<a href="#l37.9"></a><span id="l37.9"> filterWav=Waveform Audio (%1$S)</span>
<a href="#l37.10"></a><span id="l37.10"> </span>
<a href="#l37.11"></a><span id="l37.11"> # Remote calendar errors</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-errorTitle=Error getting calendar</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+errorTitle=An error has occurred.</span>
<a href="#l37.14"></a><span id="l37.14"> httpPutError=Publishing the calendar file failed.\nStatus code: %1$S: %2$S</span>
<a href="#l37.15"></a><span id="l37.15"> otherPutError=Publishing the calendar file failed.\nStatus code: 0x%1$S</span>
<a href="#l37.16"></a><span id="l37.16"> readOnlyMode=There has been an error reading data for calendar: %1$S. It has been placed in read-only mode, since changes to this calendar will likely result in data-loss.  You may change this setting by choosing 'Edit Calendar'.</span>
<a href="#l37.17"></a><span id="l37.17"> disabledMode=There has been an error reading data for calendar: %1$S. It has been disabled until it is safe to use it.</span>
<a href="#l37.18"></a><span id="l37.18"> minorError=There has been an error reading data for calendar: %1$S.  However, this error is believed to be minor, so the program will attempt to continue.</span>
<a href="#l37.19"></a><span id="l37.19"> stillReadOnlyError=There has been an error reading data for calendar: %1$S.</span>
<a href="#l37.20"></a><span id="l37.20"> utf8DecodeError=An error occured while decoding an iCalendar (ics) file as UTF-8. Check that the file, including symbols and accented letters, is encoded using the UTF-8 character encoding.</span>
<a href="#l37.21"></a><span id="l37.21"> icsMalformedError=Parsing an iCalendar (ics) file failed. Check that the file conforms to iCalendar (ics) file syntax.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/lightning/lightning.properties</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/lightning/lightning.properties</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -52,28 +52,32 @@ imipHtml.organizer=Organizer:</span>
<a href="#l38.4"></a><span id="l38.4"> imipHtml.description=Description:</span>
<a href="#l38.5"></a><span id="l38.5"> imipHtml.comment=Comment:</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> imipAddToCalendar.label=Add To Calendar</span>
<a href="#l38.8"></a><span id="l38.8"> imipAddedItemToCal=Event Added to Calendar</span>
<a href="#l38.9"></a><span id="l38.9"> imipCanceledItem=Event has been deleted</span>
<a href="#l38.10"></a><span id="l38.10"> imipUpdatedItem=Event has been updated</span>
<a href="#l38.11"></a><span id="l38.11"> imipBarCancelText=This message contains an event cancellation.</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+imipBarRefreshText=This message contains an event inquery.</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+imipBarPublishText=This message contains an event.</span>
<a href="#l38.14"></a><span id="l38.14"> imipBarRequestText=This message contains an invitation to an event.</span>
<a href="#l38.15"></a><span id="l38.15"> imipBarUpdateText=This message contains an update to an existing event.</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-imipBarAlreadyAddedText=This message contains an event that has already been added to your calendar.</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+imipBarAlreadyProcessedText=This message contains an event that has already been processed.</span>
<a href="#l38.18"></a><span id="l38.18"> imipBarReplyText=This message contains a reply to an invitation.</span>
<a href="#l38.19"></a><span id="l38.19"> imipBarUnsupportedText=This message contains an event that this version of Lightning cannot process.</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+imipBarProcessingFailed=Processing message failed. Status: %1$S.</span>
<a href="#l38.21"></a><span id="l38.21"> imipAcceptInvitation.label=Accept</span>
<a href="#l38.22"></a><span id="l38.22"> imipCancelInvitation.label=Delete</span>
<a href="#l38.23"></a><span id="l38.23"> imipDeclineInvitation.label=Decline</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-imipUpdateInvitation.label=Update</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+imipUpdate.label=Update</span>
<a href="#l38.26"></a><span id="l38.26"> imipAcceptTentativeInvitation.label=Tentative</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-imipSendMailTitle=Notify Attendees</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-imipSendMail=Would you like to send out notification E-Mails now?</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+imipSend.label=Send</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+imipSendMailTitle=E-Mail Notification</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+imipSendMail=Would you like to send out notification E-Mail now?</span>
<a href="#l38.32"></a><span id="l38.32"> imipSendMailOutlook2000CompatMode=Support Outlook 2000 and Outlook 2002/XP</span>
<a href="#l38.33"></a><span id="l38.33"> imipNoIdentity=None</span>
<a href="#l38.34"></a><span id="l38.34"> </span>
<a href="#l38.35"></a><span id="l38.35"> itipReplySubject=Event Invitation Reply: %1$S</span>
<a href="#l38.36"></a><span id="l38.36"> itipReplyBodyAccept=%1$S has accepted your event invitation.</span>
<a href="#l38.37"></a><span id="l38.37"> itipReplyBodyDecline=%1$S has declined your event invitation.</span>
<a href="#l38.38"></a><span id="l38.38"> itipRequestSubject=Event Invitation: %1$S</span>
<a href="#l38.39"></a><span id="l38.39"> itipRequestBody=%1$S has invited you to %2$S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/providers/base/calProviderBase.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/providers/base/calProviderBase.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -288,18 +288,20 @@ calProviderBase.prototype = {</span>
<a href="#l39.4"></a><span id="l39.4">     },</span>
<a href="#l39.5"></a><span id="l39.5">     set transientProperties cPB_transientProperties(value) {</span>
<a href="#l39.6"></a><span id="l39.6">         return (this.mTransientPropertiesMode = value);</span>
<a href="#l39.7"></a><span id="l39.7">     },</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9">     // nsIVariant getProperty(in AUTF8String aName);</span>
<a href="#l39.10"></a><span id="l39.10">     getProperty: function cPB_getProperty(aName) {</span>
<a href="#l39.11"></a><span id="l39.11">         switch (aName) {</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-            case &quot;itip.transport&quot;: // itip/imip default:</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+            case &quot;itip.transport&quot;: // iTIP/iMIP default:</span>
<a href="#l39.14"></a><span id="l39.14">                 return calGetImipTransport(this);</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+            case &quot;itip.notify-replies&quot;: // iTIP/iMIP default:</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+                 return getPrefSafe(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l39.17"></a><span id="l39.17">             // temporary hack to get the uncached calendar instance:</span>
<a href="#l39.18"></a><span id="l39.18">             case &quot;cache.uncachedCalendar&quot;:</span>
<a href="#l39.19"></a><span id="l39.19">                 return this;</span>
<a href="#l39.20"></a><span id="l39.20">         }</span>
<a href="#l39.21"></a><span id="l39.21"> </span>
<a href="#l39.22"></a><span id="l39.22">         var ret = this.mProperties[aName];</span>
<a href="#l39.23"></a><span id="l39.23">         if (ret === undefined) {</span>
<a href="#l39.24"></a><span id="l39.24">             ret = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -451,17 +451,18 @@ calDavCalendar.prototype = {</span>
<a href="#l40.4"></a><span id="l40.4">             this.notifyOperationComplete(aListener,</span>
<a href="#l40.5"></a><span id="l40.5">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l40.6"></a><span id="l40.6">                                          Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l40.7"></a><span id="l40.7">                                          aItem.id,</span>
<a href="#l40.8"></a><span id="l40.8">                                          &quot;Can't set ID on non-mutable item to addItem&quot;);</span>
<a href="#l40.9"></a><span id="l40.9">             return;</span>
<a href="#l40.10"></a><span id="l40.10">         }</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-        var locationPath = this.getItemLocationPath(aItem);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+        let parentItem = aItem.parentItem;</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+        var locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l40.15"></a><span id="l40.15">         var itemUri = this.makeUri(locationPath);</span>
<a href="#l40.16"></a><span id="l40.16">         LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18">         var addListener = {};</span>
<a href="#l40.19"></a><span id="l40.19">         var thisCalendar = this;</span>
<a href="#l40.20"></a><span id="l40.20">         addListener.onStreamComplete =</span>
<a href="#l40.21"></a><span id="l40.21">             function onPutComplete(aLoader, aContext, aStatus, aResultLength,</span>
<a href="#l40.22"></a><span id="l40.22">                                    aResult) {</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineat">@@ -481,28 +482,27 @@ calDavCalendar.prototype = {</span>
<a href="#l40.24"></a><span id="l40.24">             //</span>
<a href="#l40.25"></a><span id="l40.25">             if (status == 201 || status == 204) {</span>
<a href="#l40.26"></a><span id="l40.26">                 LOG(&quot;CalDAV: Item added successfully&quot;);</span>
<a href="#l40.27"></a><span id="l40.27"> </span>
<a href="#l40.28"></a><span id="l40.28">                 // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l40.29"></a><span id="l40.29">                 // for instance) so we'd best re-fetch in order to know</span>
<a href="#l40.30"></a><span id="l40.30">                 // the current state of the item</span>
<a href="#l40.31"></a><span id="l40.31">                 // Observers will be notified in getUpdatedItem()</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineminus">-                thisCalendar.getUpdatedItem(aItem, aListener);</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+                thisCalendar.getUpdatedItem(parentItem, aListener);</span>
<a href="#l40.34"></a><span id="l40.34">             } else {</span>
<a href="#l40.35"></a><span id="l40.35">                 if (status &gt; 999) {</span>
<a href="#l40.36"></a><span id="l40.36">                     status = &quot;0x&quot; + status.toString(16);</span>
<a href="#l40.37"></a><span id="l40.37">                 }</span>
<a href="#l40.38"></a><span id="l40.38">                 LOG(&quot;CalDAV: Unexpected status adding item: &quot; + status);</span>
<a href="#l40.39"></a><span id="l40.39">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_PUT_ERROR);</span>
<a href="#l40.40"></a><span id="l40.40">             }</span>
<a href="#l40.41"></a><span id="l40.41">         };</span>
<a href="#l40.42"></a><span id="l40.42"> </span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">-        aItem.calendar = this.superCalendar;</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineminus">-        aItem.generation = 1;</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+        parentItem.calendar = this.superCalendar;</span>
<a href="#l40.46"></a><span id="l40.46"> </span>
<a href="#l40.47"></a><span id="l40.47">         var httpchannel = calPrepHttpChannel(itemUri,</span>
<a href="#l40.48"></a><span id="l40.48">                                              this.getSerializedItem(aItem),</span>
<a href="#l40.49"></a><span id="l40.49">                                              &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l40.50"></a><span id="l40.50">                                              this);</span>
<a href="#l40.51"></a><span id="l40.51"> </span>
<a href="#l40.52"></a><span id="l40.52"> </span>
<a href="#l40.53"></a><span id="l40.53">         if (!aIgnoreEtag) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -147,20 +147,21 @@ calMemoryCalendar.prototype = {</span>
<a href="#l41.4"></a><span id="l41.4">                                              Components.interfaces.calIErrors.DUPLICATE_ID,</span>
<a href="#l41.5"></a><span id="l41.5">                                              Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l41.6"></a><span id="l41.6">                                              aItem.id,</span>
<a href="#l41.7"></a><span id="l41.7">                                              &quot;ID already exists for addItem&quot;);</span>
<a href="#l41.8"></a><span id="l41.8">                 return;</span>
<a href="#l41.9"></a><span id="l41.9">             }</span>
<a href="#l41.10"></a><span id="l41.10">         }</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-        aItem.calendar = this.superCalendar;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+        let parentItem = aItem.parentItem</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+        parentItem.calendar = this.superCalendar;</span>
<a href="#l41.15"></a><span id="l41.15"> </span>
<a href="#l41.16"></a><span id="l41.16" class="difflineminus">-        aItem.makeImmutable();</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineminus">-        this.mItems[aItem.id] = aItem;</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+        parentItem.makeImmutable();</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+        this.mItems[aItem.id] = parentItem;</span>
<a href="#l41.20"></a><span id="l41.20"> </span>
<a href="#l41.21"></a><span id="l41.21">         // notify the listener</span>
<a href="#l41.22"></a><span id="l41.22">         this.notifyOperationComplete(aListener,</span>
<a href="#l41.23"></a><span id="l41.23">                                      Components.results.NS_OK,</span>
<a href="#l41.24"></a><span id="l41.24">                                      Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l41.25"></a><span id="l41.25">                                      aItem.id,</span>
<a href="#l41.26"></a><span id="l41.26">                                      aItem);</span>
<a href="#l41.27"></a><span id="l41.27">         // notify observers</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -403,23 +403,16 @@ calStorageCalendar.prototype = {</span>
<a href="#l42.4"></a><span id="l42.4">         if (this.readOnly) {</span>
<a href="#l42.5"></a><span id="l42.5">             this.notifyOperationComplete(aListener,</span>
<a href="#l42.6"></a><span id="l42.6">                                          Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l42.7"></a><span id="l42.7">                                          Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l42.8"></a><span id="l42.8">                                          null,</span>
<a href="#l42.9"></a><span id="l42.9">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l42.10"></a><span id="l42.10">             return;</span>
<a href="#l42.11"></a><span id="l42.11">         }</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-        // Ensure that we're looking at the base item</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-        // if we were given an occurrence.  Later we can</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineminus">-        // optimize this.</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-        if (aItem.parentItem != aItem) {</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineminus">-            aItem.parentItem.recurrenceInfo.modifyException(aItem, false);</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-        }</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineminus">-        aItem = aItem.parentItem;</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20">         if (aItem.id == null) {</span>
<a href="#l42.21"></a><span id="l42.21">             // is this an error?  Or should we generate an IID?</span>
<a href="#l42.22"></a><span id="l42.22">             aItem.id = getUUID();</span>
<a href="#l42.23"></a><span id="l42.23">         } else {</span>
<a href="#l42.24"></a><span id="l42.24">             var olditem = this.getItemById(aItem.id);</span>
<a href="#l42.25"></a><span id="l42.25">             if (olditem) {</span>
<a href="#l42.26"></a><span id="l42.26">                 if (this.relaxedMode) {</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineat">@@ -431,20 +424,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l42.28"></a><span id="l42.28">                                                  Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l42.29"></a><span id="l42.29">                                                  aItem.id,</span>
<a href="#l42.30"></a><span id="l42.30">                                                  &quot;ID already exists for addItem&quot;);</span>
<a href="#l42.31"></a><span id="l42.31">                     return;</span>
<a href="#l42.32"></a><span id="l42.32">                 }</span>
<a href="#l42.33"></a><span id="l42.33">             }</span>
<a href="#l42.34"></a><span id="l42.34">         }</span>
<a href="#l42.35"></a><span id="l42.35"> </span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-        aItem.calendar = this.superCalendar;</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-        aItem.makeImmutable();</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+        let parentItem = aItem.parentItem;</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+        parentItem.calendar = this.superCalendar;</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+        parentItem.makeImmutable();</span>
<a href="#l42.41"></a><span id="l42.41"> </span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-        this.flushItem (aItem, null);</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+        this.flushItem(parentItem, null);</span>
<a href="#l42.44"></a><span id="l42.44"> </span>
<a href="#l42.45"></a><span id="l42.45">         // notify the listener</span>
<a href="#l42.46"></a><span id="l42.46">         this.notifyOperationComplete(aListener,</span>
<a href="#l42.47"></a><span id="l42.47">                                      Components.results.NS_OK,</span>
<a href="#l42.48"></a><span id="l42.48">                                      Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l42.49"></a><span id="l42.49">                                      aItem.id,</span>
<a href="#l42.50"></a><span id="l42.50">                                      aItem);</span>
<a href="#l42.51"></a><span id="l42.51"> </span>
<a href="#l42.52"></a><span id="l42.52" class="difflineat">@@ -2254,19 +2248,20 @@ calStorageCalendar.prototype = {</span>
<a href="#l42.53"></a><span id="l42.53">             ip.time_created = tmp.nativeTime;</span>
<a href="#l42.54"></a><span id="l42.54">         if ((tmp = item.getProperty(&quot;LAST-MODIFIED&quot;)))</span>
<a href="#l42.55"></a><span id="l42.55">             ip.last_modified = tmp.nativeTime;</span>
<a href="#l42.56"></a><span id="l42.56"> </span>
<a href="#l42.57"></a><span id="l42.57">         ip.title = item.getProperty(&quot;SUMMARY&quot;);</span>
<a href="#l42.58"></a><span id="l42.58">         ip.priority = item.getProperty(&quot;PRIORITY&quot;);</span>
<a href="#l42.59"></a><span id="l42.59">         ip.privacy = item.getProperty(&quot;CLASS&quot;);</span>
<a href="#l42.60"></a><span id="l42.60">         ip.ical_status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-        if (!item.parentItem)</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-            ip.event_stamp = item.stampTime.nativeTime;</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+        tmp = item.stampTime;</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+        if (tmp) {</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+            ip.event_stamp = tmp.nativeTime;</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+        }</span>
<a href="#l42.68"></a><span id="l42.68"> </span>
<a href="#l42.69"></a><span id="l42.69">         if (item.alarmOffset) {</span>
<a href="#l42.70"></a><span id="l42.70">             ip.alarm_offset = item.alarmOffset.inSeconds;</span>
<a href="#l42.71"></a><span id="l42.71">             ip.alarm_related = item.alarmRelated;</span>
<a href="#l42.72"></a><span id="l42.72">         }</span>
<a href="#l42.73"></a><span id="l42.73">         if (item.alarmLastAck) {</span>
<a href="#l42.74"></a><span id="l42.74">             ip.alarm_last_ack = item.alarmLastAck.nativeTime;</span>
<a href="#l42.75"></a><span id="l42.75">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/sunbird/app/profile/sunbird.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/sunbird/app/profile/sunbird.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -64,16 +64,22 @@ pref(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l43.4"></a><span id="l43.4"> pref(&quot;calendar.view.dayendhour&quot;, 17);</span>
<a href="#l43.5"></a><span id="l43.5"> pref(&quot;calendar.view.visiblehours&quot;, 9);</span>
<a href="#l43.6"></a><span id="l43.6"> pref(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l43.7"></a><span id="l43.7"> pref(&quot;calendar.previousweeks.inview&quot;, 0);</span>
<a href="#l43.8"></a><span id="l43.8"> </span>
<a href="#l43.9"></a><span id="l43.9"> // default transparency of allday items; could be switched to e.g. &quot;OPAQUE&quot;:</span>
<a href="#l43.10"></a><span id="l43.10"> pref(&quot;calendar.allday.defaultTransparency&quot;, &quot;TRANSPARENT&quot;);</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+// whether &quot;notify&quot; is checked by default when creating new events/todos with attendees</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+pref(&quot;calendar.itip.notify&quot;, true);</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+// whether the organizer propagates replies of attendees</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+pref(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+</span>
<a href="#l43.18"></a><span id="l43.18"> // whether CalDAV (experimental) scheduling is enabled or not.</span>
<a href="#l43.19"></a><span id="l43.19"> pref(&quot;calendar.caldav.sched.enabled&quot;, false);</span>
<a href="#l43.20"></a><span id="l43.20"> </span>
<a href="#l43.21"></a><span id="l43.21"> // pref(&quot;startup.homepage_override_url&quot;,&quot;chrome://browser-region/locale/region.properties&quot;);</span>
<a href="#l43.22"></a><span id="l43.22"> pref(&quot;general.startup.calendar&quot;, true);</span>
<a href="#l43.23"></a><span id="l43.23"> </span>
<a href="#l43.24"></a><span id="l43.24"> pref(&quot;toolkit.defaultChromeURI&quot;,&quot;chrome://sunbird/content/calendar.xul&quot;);</span>
<a href="#l43.25"></a><span id="l43.25"> pref(&quot;browser.hiddenWindowChromeURL&quot;, &quot;chrome://sunbird/content/hiddenWindow.xul&quot;);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

