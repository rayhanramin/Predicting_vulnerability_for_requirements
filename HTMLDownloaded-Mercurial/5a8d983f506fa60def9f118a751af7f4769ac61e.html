<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3997:5a8d983f506fa60def9f118a751af7f4769ac61e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5a8d983f506fa60def9f118a751af7f4769ac61e" />
<meta property="og:url" content="/comm-central/rev/5a8d983f506fa60def9f118a751af7f4769ac61e" />
<meta property="og:description" content="pass along size retrieved when fetching body for offline use, in case size has changed, as it can with Exchange, and truncate offline store when newly downloaded offline msg is too small, r/sr=standard8, 518702" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5a8d983f506fa60def9f118a751af7f4769ac61e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5a8d983f506fa60def9f118a751af7f4769ac61e">shortlog</a> |
<a href="/comm-central/log/5a8d983f506fa60def9f118a751af7f4769ac61e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5a8d983f506fa60def9f118a751af7f4769ac61e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5a8d983f506fa60def9f118a751af7f4769ac61e">files</a> |
changeset |
<a href="/comm-central/raw-rev/5a8d983f506fa60def9f118a751af7f4769ac61e">raw</a>  | <a href="/comm-central/archive/5a8d983f506fa60def9f118a751af7f4769ac61e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
pass along size retrieved when fetching body for offline use, in case size has changed, as it can with Exchange, and truncate offline store when newly downloaded offline msg is too small, r/sr=standard8, 518702
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 30 Sep 2009 06:21:06 -0700</td></tr>

<tr>
 <td>changeset 3997</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5a8d983f506fa60def9f118a751af7f4769ac61e">5a8d983f506fa60def9f118a751af7f4769ac61e</a></td>
</tr>



<tr>
<td>parent 3996</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2e2c7abbb76f093b0523600f9b5b9ac2097f30c4">2e2c7abbb76f093b0523600f9b5b9ac2097f30c4</a>
</td>
</tr>

<tr>
<td>child 3998</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d794b894dbe0dbc19925d6a9767eb40176a748ea">d794b894dbe0dbc19925d6a9767eb40176a748ea</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5a8d983f506fa60def9f118a751af7f4769ac61e">3118</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 30 Sep 2009 13:19:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5a8d983f506f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5a8d983f506fa60def9f118a751af7f4769ac61e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5a8d983f506fa60def9f118a751af7f4769ac61e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5a8d983f506fa60def9f118a751af7f4769ac61e&newProject=comm-central&newRevision=5a8d983f506fa60def9f118a751af7f4769ac61e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5a8d983f506fa60def9f118a751af7f4769ac61e&newProject=comm-central&newRevision=5a8d983f506fa60def9f118a751af7f4769ac61e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5a8d983f506fa60def9f118a751af7f4769ac61e&newProject=comm-central&newRevision=5a8d983f506fa60def9f118a751af7f4769ac61e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=518702">518702</a></td></tr>




</table></div>

<div class="page_body description">pass along size retrieved when fetching body for offline use, in case size has changed, as it can with Exchange, and truncate offline store when newly downloaded offline msg is too small, r/sr=standard8, 518702</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/public/nsIImapMessageSink.idl">mailnews/imap/public/nsIImapMessageSink.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/public/nsIImapMessageSink.idl">file</a> |
<a href="/comm-central/annotate/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/public/nsIImapMessageSink.idl">annotate</a> |
<a href="/comm-central/diff/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/public/nsIImapMessageSink.idl">diff</a> |
<a href="/comm-central/comparison/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/public/nsIImapMessageSink.idl">comparison</a> |
<a href="/comm-central/log/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/public/nsIImapMessageSink.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/5a8d983f506fa60def9f118a751af7f4769ac61e/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapMessageSink.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapMessageSink.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -36,33 +36,34 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsIImapUrl.idl&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIMsgMailNewsUrl;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(33694e58-458b-4bbd-afbf-96d06f90676b)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(b2d287c5-e857-4fa2-9047-351f801fafb2)]</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> interface nsIImapMessageSink : nsISupports {</span>
<a href="#l1.16"></a><span id="l1.16">   // set up messge download output stream</span>
<a href="#l1.17"></a><span id="l1.17">   void setupMsgWriteStream(in nsIFile aFile, in boolean aAppendDummyEnvelope);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">   /**</span>
<a href="#l1.20"></a><span id="l1.20">    * Used by the imap protocol code to notify the core backend code about</span>
<a href="#l1.21"></a><span id="l1.21">    * downloaded imap messages.</span>
<a href="#l1.22"></a><span id="l1.22">    *</span>
<a href="#l1.23"></a><span id="l1.23">    * @param aAdoptedMsgLine  a string with a lot of message lines,</span>
<a href="#l1.24"></a><span id="l1.24">    *                         separated by native line terminators.</span>
<a href="#l1.25"></a><span id="l1.25">    * @param aUidOfMsg        IMAP UID of the fetched message.</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+   * @param aSizeOfMsg       RFC822.Size of the fetched message</span>
<a href="#l1.27"></a><span id="l1.27">    * @param aImapUrl         IMAP Url used to fetch the message.</span>
<a href="#l1.28"></a><span id="l1.28">    */</span>
<a href="#l1.29"></a><span id="l1.29">   void parseAdoptedMsgLine(in string aAdoptedMsgLine, in nsMsgKey aUidOfMsg,</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-                           in nsIImapUrl aImapUrl);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+                           in long aSizeOfMsg, in nsIImapUrl aImapUrl);</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33">   void normalEndMsgWriteStream(in nsMsgKey aUidOfMessage,</span>
<a href="#l1.34"></a><span id="l1.34">                                in boolean aMarkMsgRead, in nsIImapUrl aImapUrl);</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">   void abortMsgWriteStream();</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">   void beginMessageUpload();</span>
<a href="#l1.39"></a><span id="l1.39"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4389,27 +4389,29 @@ NS_IMETHODIMP nsImapMailFolder::Download</span>
<a href="#l2.4"></a><span id="l2.4">   else</span>
<a href="#l2.5"></a><span id="l2.5">     rv = NS_MSG_FOLDER_UNREADABLE;</span>
<a href="#l2.6"></a><span id="l2.6">   return rv;</span>
<a href="#l2.7"></a><span id="l2.7"> }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> NS_IMETHODIMP</span>
<a href="#l2.10"></a><span id="l2.10"> nsImapMailFolder::ParseAdoptedMsgLine(const char *adoptedMessageLine,</span>
<a href="#l2.11"></a><span id="l2.11">                                       nsMsgKey uidOfMessage,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+                                      PRInt32 aMsgSize,</span>
<a href="#l2.13"></a><span id="l2.13">                                       nsIImapUrl *aImapUrl)</span>
<a href="#l2.14"></a><span id="l2.14"> {</span>
<a href="#l2.15"></a><span id="l2.15">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l2.16"></a><span id="l2.16">   PRUint32 count = 0;</span>
<a href="#l2.17"></a><span id="l2.17">   nsresult rv;</span>
<a href="#l2.18"></a><span id="l2.18">   // remember the uid of the message we're downloading.</span>
<a href="#l2.19"></a><span id="l2.19">   m_curMsgUid = uidOfMessage;</span>
<a href="#l2.20"></a><span id="l2.20">   if (!m_offlineHeader)</span>
<a href="#l2.21"></a><span id="l2.21">   {</span>
<a href="#l2.22"></a><span id="l2.22">     GetMessageHeader(uidOfMessage, getter_AddRefs(m_offlineHeader));</span>
<a href="#l2.23"></a><span id="l2.23">     rv = StartNewOfflineMessage();</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    m_offlineHeader-&gt;SetMessageSize(aMsgSize);</span>
<a href="#l2.25"></a><span id="l2.25">   }</span>
<a href="#l2.26"></a><span id="l2.26">   // adoptedMessageLine is actually a string with a lot of message lines, separated by native line terminators</span>
<a href="#l2.27"></a><span id="l2.27">   // we need to count the number of MSG_LINEBREAK's to determine how much to increment m_numOfflineMsgLines by.</span>
<a href="#l2.28"></a><span id="l2.28">   const char *nextLine = adoptedMessageLine;</span>
<a href="#l2.29"></a><span id="l2.29">   do</span>
<a href="#l2.30"></a><span id="l2.30">   {</span>
<a href="#l2.31"></a><span id="l2.31">     m_numOfflineMsgLines++;</span>
<a href="#l2.32"></a><span id="l2.32">     nextLine = PL_strstr(nextLine, MSG_LINEBREAK);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3579,17 +3579,19 @@ nsImapProtocol::PostLineDownLoadEvent(co</span>
<a href="#l3.4"></a><span id="l3.4">           nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l3.5"></a><span id="l3.5">           m_channelListener-&gt;OnDataAvailable(request, m_channelContext, m_channelInputStream, 0, count);</span>
<a href="#l3.6"></a><span id="l3.6">         }</span>
<a href="#l3.7"></a><span id="l3.7">       }</span>
<a href="#l3.8"></a><span id="l3.8">       if (m_runningUrl)</span>
<a href="#l3.9"></a><span id="l3.9">         m_runningUrl-&gt;GetStoreResultsOffline(&amp;echoLineToMessageSink);</span>
<a href="#l3.10"></a><span id="l3.10">     }</span>
<a href="#l3.11"></a><span id="l3.11">     if (m_imapMessageSink &amp;&amp; line &amp;&amp; echoLineToMessageSink &amp;&amp; !GetPseudoInterrupted())</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      m_imapMessageSink-&gt;ParseAdoptedMsgLine(line, uidOfMessage, m_runningUrl);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      m_imapMessageSink-&gt;ParseAdoptedMsgLine(line, uidOfMessage,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+                                             GetServerStateParser().SizeOfMostRecentMessage(),</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                                             m_runningUrl);</span>
<a href="#l3.16"></a><span id="l3.16">   }</span>
<a href="#l3.17"></a><span id="l3.17">   // ***** We need to handle the pseudo interrupt here *****</span>
<a href="#l3.18"></a><span id="l3.18"> }</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> // Handle a line seen by the parser.</span>
<a href="#l3.21"></a><span id="l3.21"> // * The argument |lineCopy| must be nsnull or should contain the same string as</span>
<a href="#l3.22"></a><span id="l3.22"> //   |line|.  |lineCopy| will be modified.</span>
<a href="#l3.23"></a><span id="l3.23"> // * A line may be passed by parts, e.g., &quot;part1 part2\r\n&quot; may be passed as</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

