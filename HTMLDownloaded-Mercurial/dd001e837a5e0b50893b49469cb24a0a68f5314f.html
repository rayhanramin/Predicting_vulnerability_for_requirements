<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26413:dd001e837a5e0b50893b49469cb24a0a68f5314f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dd001e837a5e0b50893b49469cb24a0a68f5314f" />
<meta property="og:url" content="/comm-central/rev/dd001e837a5e0b50893b49469cb24a0a68f5314f" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mail/. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dd001e837a5e0b50893b49469cb24a0a68f5314f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dd001e837a5e0b50893b49469cb24a0a68f5314f">shortlog</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dd001e837a5e0b50893b49469cb24a0a68f5314f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f">files</a> |
changeset |
<a href="/comm-central/raw-rev/dd001e837a5e0b50893b49469cb24a0a68f5314f">raw</a>  | <a href="/comm-central/archive/dd001e837a5e0b50893b49469cb24a0a68f5314f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mail/. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Apr 2019 00:23:53 +0200</td></tr>

<tr>
 <td>changeset 26413</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dd001e837a5e0b50893b49469cb24a0a68f5314f">dd001e837a5e0b50893b49469cb24a0a68f5314f</a></td>
</tr>



<tr>
<td>parent 26412</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ce1d3195faae76e56b12a4f032ce6aa015ea4886">ce1d3195faae76e56b12a4f032ce6aa015ea4886</a>
</td>
</tr>

<tr>
<td>child 26414</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/506e8bcb98739cf13ae0db2257e2e33f25496c2a">506e8bcb98739cf13ae0db2257e2e33f25496c2a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dd001e837a5e0b50893b49469cb24a0a68f5314f">15827</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 23 Apr 2019 22:38:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0c50a354ca18 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f&newProject=comm-central&newRevision=452b1d36e872ac355882048b28139cdf99e1eef8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f&newProject=comm-central&newRevision=452b1d36e872ac355882048b28139cdf99e1eef8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c50a354ca18dd895b9f6d4e1a19a1780927e21f&newProject=comm-central&newRevision=452b1d36e872ac355882048b28139cdf99e1eef8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mail/. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/app/nsMailApp.cpp">mail/app/nsMailApp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/app/nsMailApp.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/app/nsMailApp.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/app/nsMailApp.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/app/nsMailApp.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/app/nsMailApp.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/build/nsMailComps.cpp">mail/components/build/nsMailComps.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/build/nsMailComps.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/build/nsMailComps.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/build/nsMailComps.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/build/nsMailComps.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/build/nsMailComps.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/public/nsMailMigrationCID.h">mail/components/migration/public/nsMailMigrationCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/public/nsMailMigrationCID.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/public/nsMailMigrationCID.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/public/nsMailMigrationCID.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/public/nsMailMigrationCID.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/public/nsMailMigrationCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">mail/components/migration/src/nsMailProfileMigratorUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.h">mail/components/migration/src/nsMailProfileMigratorUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsMailProfileMigratorUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.h">mail/components/migration/src/nsNetscapeProfileMigratorBase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsNetscapeProfileMigratorBase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.cpp">mail/components/migration/src/nsOutlookProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.h">mail/components/migration/src/nsOutlookProfileMigrator.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsOutlookProfileMigrator.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.cpp">mail/components/migration/src/nsProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.h">mail/components/migration/src/nsProfileMigrator.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigrator.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.cpp">mail/components/migration/src/nsProfileMigratorBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.h">mail/components/migration/src/nsProfileMigratorBase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsProfileMigratorBase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.h">mail/components/migration/src/nsSeamonkeyProfileMigrator.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/migration/src/nsSeamonkeyProfileMigrator.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/GetMetadataForFile.c">mail/components/search/mdimporter/GetMetadataForFile.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/GetMetadataForFile.c">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/GetMetadataForFile.c">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/GetMetadataForFile.c">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/GetMetadataForFile.c">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/GetMetadataForFile.c">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/main.c">mail/components/search/mdimporter/main.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/main.c">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/main.c">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/main.c">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/main.c">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/mdimporter/main.c">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.cpp">mail/components/search/nsMailWinSearchHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.h">mail/components/search/nsMailWinSearchHelper.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/nsMailWinSearchHelper.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/wsenable/WSEnable.cpp">mail/components/search/wsenable/WSEnable.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/wsenable/WSEnable.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/wsenable/WSEnable.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/wsenable/WSEnable.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/wsenable/WSEnable.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/search/wsenable/WSEnable.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.cpp">mail/components/shell/DirectoryProvider.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.h">mail/components/shell/DirectoryProvider.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/DirectoryProvider.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.cpp">mail/components/shell/nsGNOMEShellService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.h">mail/components/shell/nsGNOMEShellService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsGNOMEShellService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.cpp">mail/components/shell/nsMacShellService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.h">mail/components/shell/nsMacShellService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsMacShellService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsToolkitShellService.h">mail/components/shell/nsToolkitShellService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsToolkitShellService.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsToolkitShellService.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsToolkitShellService.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsToolkitShellService.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsToolkitShellService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.cpp">mail/components/shell/nsWindowsShellService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.cpp">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.cpp">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.cpp">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.cpp">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.h">mail/components/shell/nsWindowsShellService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.h">file</a> |
<a href="/comm-central/annotate/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.h">annotate</a> |
<a href="/comm-central/diff/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.h">diff</a> |
<a href="/comm-central/comparison/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.h">comparison</a> |
<a href="/comm-central/log/dd001e837a5e0b50893b49469cb24a0a68f5314f/mail/components/shell/nsWindowsShellService.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/nsMailApp.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/nsMailApp.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,177 +3,157 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5"></a><span id="l1.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsXULAppAPI.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;mozilla/XREAppData.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;application.ini.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;mozilla/Bootstrap.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #if defined(XP_WIN)</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-#include &lt;stdlib.h&gt;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+#  include &lt;windows.h&gt;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+#  include &lt;stdlib.h&gt;</span>
<a href="#l1.16"></a><span id="l1.16"> #elif defined(XP_UNIX)</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-#include &lt;sys/resource.h&gt;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-#include &lt;unistd.h&gt;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+#  include &lt;sys/resource.h&gt;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+#  include &lt;unistd.h&gt;</span>
<a href="#l1.21"></a><span id="l1.21"> #endif</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> #include &lt;stdio.h&gt;</span>
<a href="#l1.24"></a><span id="l1.24"> #include &lt;stdarg.h&gt;</span>
<a href="#l1.25"></a><span id="l1.25"> #include &lt;time.h&gt;</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l1.28"></a><span id="l1.28"> #include &quot;nsIFile.h&quot;</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> #ifdef XP_WIN</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-#define XRE_WANT_ENVIRON</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-#define strcasecmp _stricmp</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-#ifdef MOZ_SANDBOX</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-#include &quot;mozilla/sandboxing/SandboxInitialization.h&quot;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-#endif</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+#  define XRE_WANT_ENVIRON</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+#  define strcasecmp _stricmp</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+#  ifdef MOZ_SANDBOX</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+#    include &quot;mozilla/sandboxing/SandboxInitialization.h&quot;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+#  endif</span>
<a href="#l1.41"></a><span id="l1.41"> #endif</span>
<a href="#l1.42"></a><span id="l1.42"> #include &quot;BinaryPath.h&quot;</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-#include &quot;nsXPCOMPrivate.h&quot; // for MAXPATHLEN and XPCOM_DLL</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+#include &quot;nsXPCOMPrivate.h&quot;  // for MAXPATHLEN and XPCOM_DLL</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47"> #include &quot;mozilla/Sprintf.h&quot;</span>
<a href="#l1.48"></a><span id="l1.48"> #include &quot;mozilla/StartupTimeline.h&quot;</span>
<a href="#l1.49"></a><span id="l1.49"> #include &quot;mozilla/WindowsDllBlocklist.h&quot;</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51"> #ifdef LIBFUZZER</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-#include &quot;FuzzerDefs.h&quot;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+#  include &quot;FuzzerDefs.h&quot;</span>
<a href="#l1.54"></a><span id="l1.54"> #endif</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56"> #ifdef MOZ_LINUX_32_SSE2_STARTUP_ERROR</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-#include &lt;cpuid.h&gt;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-#include &quot;mozilla/Unused.h&quot;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+#  include &lt;cpuid.h&gt;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+#  include &quot;mozilla/Unused.h&quot;</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-static bool</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-IsSSE2Available()</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-{</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+static bool IsSSE2Available() {</span>
<a href="#l1.66"></a><span id="l1.66">   // The rest of the app has been compiled to assume that SSE2 is present</span>
<a href="#l1.67"></a><span id="l1.67">   // unconditionally, so we can't use the normal copy of SSE.cpp here.</span>
<a href="#l1.68"></a><span id="l1.68">   // Since SSE.cpp caches the results and we need them only transiently,</span>
<a href="#l1.69"></a><span id="l1.69">   // instead of #including SSE.cpp here, let's just inline the specific check</span>
<a href="#l1.70"></a><span id="l1.70">   // that's needed.</span>
<a href="#l1.71"></a><span id="l1.71">   unsigned int level = 1u;</span>
<a href="#l1.72"></a><span id="l1.72">   unsigned int eax, ebx, ecx, edx;</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-  unsigned int bits = (1u&lt;&lt;26);</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+  unsigned int bits = (1u &lt;&lt; 26);</span>
<a href="#l1.75"></a><span id="l1.75">   unsigned int max = __get_cpuid_max(0, nullptr);</span>
<a href="#l1.76"></a><span id="l1.76">   if (level &gt; max) {</span>
<a href="#l1.77"></a><span id="l1.77">     return false;</span>
<a href="#l1.78"></a><span id="l1.78">   }</span>
<a href="#l1.79"></a><span id="l1.79">   __cpuid_count(level, 0, eax, ebx, ecx, edx);</span>
<a href="#l1.80"></a><span id="l1.80">   return (edx &amp; bits) == bits;</span>
<a href="#l1.81"></a><span id="l1.81"> }</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83"> static const char sSSE2Message[] =</span>
<a href="#l1.84"></a><span id="l1.84">     &quot;This browser version requires a processor with the SSE2 instruction &quot;</span>
<a href="#l1.85"></a><span id="l1.85">     &quot;set extension.\nYou may be able to obtain a version that does not &quot;</span>
<a href="#l1.86"></a><span id="l1.86">     &quot;require SSE2 from your Linux distribution.\n&quot;;</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-__attribute__((constructor))</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-static void</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-SSE2Check()</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-{</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+__attribute__((constructor)) static void SSE2Check() {</span>
<a href="#l1.93"></a><span id="l1.93">   if (IsSSE2Available()) {</span>
<a href="#l1.94"></a><span id="l1.94">     return;</span>
<a href="#l1.95"></a><span id="l1.95">   }</span>
<a href="#l1.96"></a><span id="l1.96">   // Using write() in order to avoid jemalloc-based buffering. Ignoring return</span>
<a href="#l1.97"></a><span id="l1.97">   // values, since there isn't much we could do on failure and there is no</span>
<a href="#l1.98"></a><span id="l1.98">   // point in trying to recover from errors.</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-  MOZ_UNUSED(write(STDERR_FILENO,</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-                   sSSE2Message,</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-                   MOZ_ARRAY_LENGTH(sSSE2Message) - 1));</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+  MOZ_UNUSED(</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+      write(STDERR_FILENO, sSSE2Message, MOZ_ARRAY_LENGTH(sSSE2Message) - 1));</span>
<a href="#l1.104"></a><span id="l1.104">   // _exit() instead of exit() to avoid running the usual &quot;at exit&quot; code.</span>
<a href="#l1.105"></a><span id="l1.105">   _exit(255);</span>
<a href="#l1.106"></a><span id="l1.106"> }</span>
<a href="#l1.107"></a><span id="l1.107"> #endif</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109"> #if !defined(MOZ_WIDGET_COCOA) &amp;&amp; !defined(MOZ_WIDGET_ANDROID)</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-#define MOZ_BROWSER_CAN_BE_CONTENTPROC</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-#include &quot;plugin-container.cpp&quot;</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+#  define MOZ_BROWSER_CAN_BE_CONTENTPROC</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+#  include &quot;plugin-container.cpp&quot;</span>
<a href="#l1.114"></a><span id="l1.114"> #endif</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116"> using namespace mozilla;</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118"> #ifdef XP_MACOSX</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-#define kOSXResourcesFolder &quot;Resources&quot;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+#  define kOSXResourcesFolder &quot;Resources&quot;</span>
<a href="#l1.121"></a><span id="l1.121"> #endif</span>
<a href="#l1.122"></a><span id="l1.122"> #define kDesktopFolder &quot;&quot;</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-static MOZ_FORMAT_PRINTF(1, 2) void Output(const char *fmt, ... )</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-{</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+static MOZ_FORMAT_PRINTF(1, 2) void Output(const char* fmt, ...) {</span>
<a href="#l1.127"></a><span id="l1.127">   va_list ap;</span>
<a href="#l1.128"></a><span id="l1.128">   va_start(ap, fmt);</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130"> #ifndef XP_WIN</span>
<a href="#l1.131"></a><span id="l1.131">   vfprintf(stderr, fmt, ap);</span>
<a href="#l1.132"></a><span id="l1.132"> #else</span>
<a href="#l1.133"></a><span id="l1.133">   char msg[2048];</span>
<a href="#l1.134"></a><span id="l1.134">   vsnprintf_s(msg, _countof(msg), _TRUNCATE, fmt, ap);</span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136">   wchar_t wide_msg[2048];</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-  MultiByteToWideChar(CP_UTF8,</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-                      0,</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-                      msg,</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-                      -1,</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-                      wide_msg,</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-                      _countof(wide_msg));</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-#if MOZ_WINCONSOLE</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+  MultiByteToWideChar(CP_UTF8, 0, msg, -1, wide_msg, _countof(wide_msg));</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+#  if MOZ_WINCONSOLE</span>
<a href="#l1.146"></a><span id="l1.146">   fwprintf_s(stderr, wide_msg);</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-#else</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+#  else</span>
<a href="#l1.149"></a><span id="l1.149">   // Linking user32 at load-time interferes with the DLL blocklist (bug 932100).</span>
<a href="#l1.150"></a><span id="l1.150">   // This is a rare codepath, so we can load user32 at run-time instead.</span>
<a href="#l1.151"></a><span id="l1.151">   HMODULE user32 = LoadLibraryW(L&quot;user32.dll&quot;);</span>
<a href="#l1.152"></a><span id="l1.152">   if (user32) {</span>
<a href="#l1.153"></a><span id="l1.153">     decltype(MessageBoxW)* messageBoxW =</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-      (decltype(MessageBoxW)*) GetProcAddress(user32, &quot;MessageBoxW&quot;);</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+        (decltype(MessageBoxW)*)GetProcAddress(user32, &quot;MessageBoxW&quot;);</span>
<a href="#l1.156"></a><span id="l1.156">     if (messageBoxW) {</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-      messageBoxW(nullptr, wide_msg, L&quot;Thunderbird&quot;, MB_OK</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-                                                   | MB_ICONERROR</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-                                                   | MB_SETFOREGROUND);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+      messageBoxW(nullptr, wide_msg, L&quot;Thunderbird&quot;,</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+                  MB_OK | MB_ICONERROR | MB_SETFOREGROUND);</span>
<a href="#l1.162"></a><span id="l1.162">     }</span>
<a href="#l1.163"></a><span id="l1.163">     FreeLibrary(user32);</span>
<a href="#l1.164"></a><span id="l1.164">   }</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-#endif</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+#  endif</span>
<a href="#l1.167"></a><span id="l1.167"> #endif</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169">   va_end(ap);</span>
<a href="#l1.170"></a><span id="l1.170"> }</span>
<a href="#l1.171"></a><span id="l1.171"> </span>
<a href="#l1.172"></a><span id="l1.172"> /**</span>
<a href="#l1.173"></a><span id="l1.173">  * Return true if |arg| matches the given argument name.</span>
<a href="#l1.174"></a><span id="l1.174">  */</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-static bool IsArg(const char* arg, const char* s)</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-{</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-  if (*arg == '-')</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-  {</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-    if (*++arg == '-')</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-      ++arg;</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+static bool IsArg(const char* arg, const char* s) {</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+  if (*arg == '-') {</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+    if (*++arg == '-') ++arg;</span>
<a href="#l1.184"></a><span id="l1.184">     return !strcasecmp(arg, s);</span>
<a href="#l1.185"></a><span id="l1.185">   }</span>
<a href="#l1.186"></a><span id="l1.186"> </span>
<a href="#l1.187"></a><span id="l1.187"> #if defined(XP_WIN)</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  if (*arg == '/')</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-    return !strcasecmp(++arg, s);</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+  if (*arg == '/') return !strcasecmp(++arg, s);</span>
<a href="#l1.191"></a><span id="l1.191"> #endif</span>
<a href="#l1.192"></a><span id="l1.192"> </span>
<a href="#l1.193"></a><span id="l1.193">   return false;</span>
<a href="#l1.194"></a><span id="l1.194"> }</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196"> Bootstrap::UniquePtr gBootstrap;</span>
<a href="#l1.197"></a><span id="l1.197"> </span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-static int do_main(int argc, char* argv[], char* envp[])</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-{</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+static int do_main(int argc, char* argv[], char* envp[]) {</span>
<a href="#l1.202"></a><span id="l1.202">   // Allow thunderbird.exe to launch XULRunner apps via -app &lt;application.ini&gt;</span>
<a href="#l1.203"></a><span id="l1.203">   // Note that -app must be the *first* argument.</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-  const char *appDataFile = getenv(&quot;XUL_APP_FILE&quot;);</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-  if ((!appDataFile || !*appDataFile) &amp;&amp;</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-      (argc &gt; 1 &amp;&amp; IsArg(argv[1], &quot;app&quot;))) {</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+  const char* appDataFile = getenv(&quot;XUL_APP_FILE&quot;);</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+  if ((!appDataFile || !*appDataFile) &amp;&amp; (argc &gt; 1 &amp;&amp; IsArg(argv[1], &quot;app&quot;))) {</span>
<a href="#l1.209"></a><span id="l1.209">     if (argc == 2) {</span>
<a href="#l1.210"></a><span id="l1.210">       Output(&quot;Incorrect number of arguments passed to -app&quot;);</span>
<a href="#l1.211"></a><span id="l1.211">       return 255;</span>
<a href="#l1.212"></a><span id="l1.212">     }</span>
<a href="#l1.213"></a><span id="l1.213">     appDataFile = argv[2];</span>
<a href="#l1.214"></a><span id="l1.214"> </span>
<a href="#l1.215"></a><span id="l1.215">     char appEnv[MAXPATHLEN];</span>
<a href="#l1.216"></a><span id="l1.216">     SprintfLiteral(appEnv, &quot;XUL_APP_FILE=%s&quot;, argv[2]);</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineat">@@ -187,17 +167,17 @@ static int do_main(int argc, char* argv[</span>
<a href="#l1.218"></a><span id="l1.218">   } else if (argc &gt; 1 &amp;&amp; IsArg(argv[1], &quot;xpcshell&quot;)) {</span>
<a href="#l1.219"></a><span id="l1.219">     for (int i = 1; i &lt; argc; i++) {</span>
<a href="#l1.220"></a><span id="l1.220">       argv[i] = argv[i + 1];</span>
<a href="#l1.221"></a><span id="l1.221">     }</span>
<a href="#l1.222"></a><span id="l1.222"> </span>
<a href="#l1.223"></a><span id="l1.223">     XREShellData shellData;</span>
<a href="#l1.224"></a><span id="l1.224"> #if defined(XP_WIN) &amp;&amp; defined(MOZ_SANDBOX)</span>
<a href="#l1.225"></a><span id="l1.225">     shellData.sandboxBrokerServices =</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-      sandboxing::GetInitializedBrokerServices();</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+        sandboxing::GetInitializedBrokerServices();</span>
<a href="#l1.228"></a><span id="l1.228"> #endif</span>
<a href="#l1.229"></a><span id="l1.229"> </span>
<a href="#l1.230"></a><span id="l1.230">     return gBootstrap-&gt;XRE_XPCShellMain(--argc, argv, envp, &amp;shellData);</span>
<a href="#l1.231"></a><span id="l1.231">   }</span>
<a href="#l1.232"></a><span id="l1.232"> </span>
<a href="#l1.233"></a><span id="l1.233">   BootstrapConfig config;</span>
<a href="#l1.234"></a><span id="l1.234"> </span>
<a href="#l1.235"></a><span id="l1.235">   if (appDataFile &amp;&amp; *appDataFile) {</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineat">@@ -206,38 +186,36 @@ static int do_main(int argc, char* argv[</span>
<a href="#l1.237"></a><span id="l1.237">   } else {</span>
<a href="#l1.238"></a><span id="l1.238">     // no -app flag so we use the compiled-in app data</span>
<a href="#l1.239"></a><span id="l1.239">     config.appData = &amp;sAppData;</span>
<a href="#l1.240"></a><span id="l1.240">     config.appDataPath = kDesktopFolder;</span>
<a href="#l1.241"></a><span id="l1.241">   }</span>
<a href="#l1.242"></a><span id="l1.242"> </span>
<a href="#l1.243"></a><span id="l1.243"> #if defined(XP_WIN) &amp;&amp; defined(MOZ_SANDBOX)</span>
<a href="#l1.244"></a><span id="l1.244">   sandbox::BrokerServices* brokerServices =</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-    sandboxing::GetInitializedBrokerServices();</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+      sandboxing::GetInitializedBrokerServices();</span>
<a href="#l1.247"></a><span id="l1.247">   sandboxing::PermissionsService* permissionsService =</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-    sandboxing::GetPermissionsService();</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+      sandboxing::GetPermissionsService();</span>
<a href="#l1.250"></a><span id="l1.250">   if (!brokerServices) {</span>
<a href="#l1.251"></a><span id="l1.251">     Output(&quot;Couldn't initialize the broker services.\n&quot;);</span>
<a href="#l1.252"></a><span id="l1.252">     return 255;</span>
<a href="#l1.253"></a><span id="l1.253">   }</span>
<a href="#l1.254"></a><span id="l1.254">   config.sandboxBrokerServices = brokerServices;</span>
<a href="#l1.255"></a><span id="l1.255">   config.sandboxPermissionsService = permissionsService;</span>
<a href="#l1.256"></a><span id="l1.256"> #endif</span>
<a href="#l1.257"></a><span id="l1.257"> </span>
<a href="#l1.258"></a><span id="l1.258"> #ifdef LIBFUZZER</span>
<a href="#l1.259"></a><span id="l1.259">   if (getenv(&quot;LIBFUZZER&quot;))</span>
<a href="#l1.260"></a><span id="l1.260">     gBootstrap-&gt;XRE_LibFuzzerSetDriver(fuzzer::FuzzerDriver);</span>
<a href="#l1.261"></a><span id="l1.261"> #endif</span>
<a href="#l1.262"></a><span id="l1.262"> </span>
<a href="#l1.263"></a><span id="l1.263">   return gBootstrap-&gt;XRE_main(argc, argv, config);</span>
<a href="#l1.264"></a><span id="l1.264"> }</span>
<a href="#l1.265"></a><span id="l1.265"> </span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-static nsresult</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-InitXPCOMGlue()</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-{</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+static nsresult InitXPCOMGlue() {</span>
<a href="#l1.270"></a><span id="l1.270">   UniqueFreePtr&lt;char&gt; exePath = BinaryPath::Get();</span>
<a href="#l1.271"></a><span id="l1.271">   if (!exePath) {</span>
<a href="#l1.272"></a><span id="l1.272">     Output(&quot;Couldn't find the application directory.\n&quot;);</span>
<a href="#l1.273"></a><span id="l1.273">     return NS_ERROR_FAILURE;</span>
<a href="#l1.274"></a><span id="l1.274">   }</span>
<a href="#l1.275"></a><span id="l1.275"> </span>
<a href="#l1.276"></a><span id="l1.276">   gBootstrap = mozilla::GetBootstrap(exePath.get());</span>
<a href="#l1.277"></a><span id="l1.277">   if (!gBootstrap) {</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineat">@@ -251,35 +229,34 @@ InitXPCOMGlue()</span>
<a href="#l1.279"></a><span id="l1.279">   return NS_OK;</span>
<a href="#l1.280"></a><span id="l1.280"> }</span>
<a href="#l1.281"></a><span id="l1.281"> </span>
<a href="#l1.282"></a><span id="l1.282"> #ifdef HAS_DLL_BLOCKLIST</span>
<a href="#l1.283"></a><span id="l1.283"> // NB: This must be extern, as this value is checked elsewhere</span>
<a href="#l1.284"></a><span id="l1.284"> uint32_t gBlocklistInitFlags = eDllBlocklistInitFlagDefault;</span>
<a href="#l1.285"></a><span id="l1.285"> #endif</span>
<a href="#l1.286"></a><span id="l1.286"> </span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-int main(int argc, char* argv[], char* envp[])</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-{</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+int main(int argc, char* argv[], char* envp[]) {</span>
<a href="#l1.290"></a><span id="l1.290">   mozilla::TimeStamp start = mozilla::TimeStamp::Now();</span>
<a href="#l1.291"></a><span id="l1.291"> </span>
<a href="#l1.292"></a><span id="l1.292"> #ifdef MOZ_BROWSER_CAN_BE_CONTENTPROC</span>
<a href="#l1.293"></a><span id="l1.293">   // We are launching as a content process, delegate to the appropriate</span>
<a href="#l1.294"></a><span id="l1.294">   // main</span>
<a href="#l1.295"></a><span id="l1.295">   if (argc &gt; 1 &amp;&amp; IsArg(argv[1], &quot;contentproc&quot;)) {</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-#ifdef HAS_DLL_BLOCKLIST</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+#  ifdef HAS_DLL_BLOCKLIST</span>
<a href="#l1.298"></a><span id="l1.298">     DllBlocklist_Initialize(eDllBlocklistInitFlagIsChildProcess);</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-#endif</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-#if defined(XP_WIN) &amp;&amp; defined(MOZ_SANDBOX)</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+#  endif</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+#  if defined(XP_WIN) &amp;&amp; defined(MOZ_SANDBOX)</span>
<a href="#l1.303"></a><span id="l1.303">     // We need to initialize the sandbox TargetServices before InitXPCOMGlue</span>
<a href="#l1.304"></a><span id="l1.304">     // because we might need the sandbox broker to give access to some files.</span>
<a href="#l1.305"></a><span id="l1.305">     if (IsSandboxedProcess() &amp;&amp; !sandboxing::GetInitializedTargetServices()) {</span>
<a href="#l1.306"></a><span id="l1.306">       Output(&quot;Failed to initialize the sandbox target services.&quot;);</span>
<a href="#l1.307"></a><span id="l1.307">       return 255;</span>
<a href="#l1.308"></a><span id="l1.308">     }</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-#endif</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+#  endif</span>
<a href="#l1.311"></a><span id="l1.311"> </span>
<a href="#l1.312"></a><span id="l1.312">     nsresult rv = InitXPCOMGlue();</span>
<a href="#l1.313"></a><span id="l1.313">     if (NS_FAILED(rv)) {</span>
<a href="#l1.314"></a><span id="l1.314">       return 255;</span>
<a href="#l1.315"></a><span id="l1.315">     }</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317">     int result = content_process_main(gBootstrap.get(), argc, argv);</span>
<a href="#l1.318"></a><span id="l1.318"> </span>
<a href="#l1.319"></a><span id="l1.319" class="difflineat">@@ -289,17 +266,16 @@ int main(int argc, char* argv[], char* e</span>
<a href="#l1.320"></a><span id="l1.320">     return result;</span>
<a href="#l1.321"></a><span id="l1.321">   }</span>
<a href="#l1.322"></a><span id="l1.322"> #endif</span>
<a href="#l1.323"></a><span id="l1.323"> </span>
<a href="#l1.324"></a><span id="l1.324"> #ifdef HAS_DLL_BLOCKLIST</span>
<a href="#l1.325"></a><span id="l1.325">   DllBlocklist_Initialize(gBlocklistInitFlags);</span>
<a href="#l1.326"></a><span id="l1.326"> #endif</span>
<a href="#l1.327"></a><span id="l1.327"> </span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-</span>
<a href="#l1.329"></a><span id="l1.329">   nsresult rv = InitXPCOMGlue();</span>
<a href="#l1.330"></a><span id="l1.330">   if (NS_FAILED(rv)) {</span>
<a href="#l1.331"></a><span id="l1.331">     return 255;</span>
<a href="#l1.332"></a><span id="l1.332">   }</span>
<a href="#l1.333"></a><span id="l1.333"> </span>
<a href="#l1.334"></a><span id="l1.334">   gBootstrap-&gt;XRE_StartupTimelineRecord(mozilla::StartupTimeline::START, start);</span>
<a href="#l1.335"></a><span id="l1.335"> </span>
<a href="#l1.336"></a><span id="l1.336"> #ifdef MOZ_BROWSER_CAN_BE_CONTENTPROC</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/build/nsMailComps.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/build/nsMailComps.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -12,94 +12,96 @@</span>
<a href="#l2.4"></a><span id="l2.4"> using namespace mozilla::mail;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> NS_GENERIC_FACTORY_CONSTRUCTOR(DirectoryProvider)</span>
<a href="#l2.7"></a><span id="l2.7"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsProfileMigrator)</span>
<a href="#l2.8"></a><span id="l2.8"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsSeamonkeyProfileMigrator)</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> #ifdef XP_WIN</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsOutlookProfileMigrator.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#  include &quot;nsOutlookProfileMigrator.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsOutlookProfileMigrator)</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-#include &quot;nsWindowsShellService.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+#  include &quot;nsWindowsShellService.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsWindowsShellService, Init)</span>
<a href="#l2.19"></a><span id="l2.19"> #endif</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-#include &quot;nsGNOMEShellService.h&quot;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+#  include &quot;nsGNOMEShellService.h&quot;</span>
<a href="#l2.24"></a><span id="l2.24"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsGNOMEShellService, Init)</span>
<a href="#l2.25"></a><span id="l2.25"> #endif</span>
<a href="#l2.26"></a><span id="l2.26"> #ifdef XP_MACOSX</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-#include &quot;nsMacShellService.h&quot;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+#  include &quot;nsMacShellService.h&quot;</span>
<a href="#l2.29"></a><span id="l2.29"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMacShellService)</span>
<a href="#l2.30"></a><span id="l2.30"> #endif</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32"> #if defined(XP_WIN)</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-#include &quot;nsMailWinSearchHelper.h&quot;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+#  include &quot;nsMailWinSearchHelper.h&quot;</span>
<a href="#l2.35"></a><span id="l2.35"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMailWinSearchHelper, Init)</span>
<a href="#l2.36"></a><span id="l2.36"> #endif</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38"> NS_DEFINE_NAMED_CID(NS_MAILDIRECTORYPROVIDER_CID);</span>
<a href="#l2.39"></a><span id="l2.39"> NS_DEFINE_NAMED_CID(NS_THUNDERBIRD_PROFILEIMPORT_CID);</span>
<a href="#l2.40"></a><span id="l2.40"> NS_DEFINE_NAMED_CID(NS_SEAMONKEYPROFILEMIGRATOR_CID);</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42"> #ifdef XP_WIN</span>
<a href="#l2.43"></a><span id="l2.43"> NS_DEFINE_NAMED_CID(NS_OUTLOOKPROFILEMIGRATOR_CID);</span>
<a href="#l2.44"></a><span id="l2.44"> NS_DEFINE_NAMED_CID(NS_MAILWININTEGRATION_CID);</span>
<a href="#l2.45"></a><span id="l2.45"> NS_DEFINE_NAMED_CID(NS_MAILWINSEARCHHELPER_CID);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-#endif // !XP_WIN</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+#endif  // !XP_WIN</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l2.50"></a><span id="l2.50"> NS_DEFINE_NAMED_CID(NS_MAILGNOMEINTEGRATION_CID);</span>
<a href="#l2.51"></a><span id="l2.51"> #endif</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53"> #ifdef XP_MACOSX</span>
<a href="#l2.54"></a><span id="l2.54"> NS_DEFINE_NAMED_CID(NS_MAILMACINTEGRATION_CID);</span>
<a href="#l2.55"></a><span id="l2.55"> #endif</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57"> const mozilla::Module::CIDEntry kMailCIDs[] = {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  { &amp;kNS_MAILDIRECTORYPROVIDER_CID, false, NULL, DirectoryProviderConstructor },</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-  { &amp;kNS_THUNDERBIRD_PROFILEIMPORT_CID, false, NULL, nsProfileMigratorConstructor },</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  { &amp;kNS_SEAMONKEYPROFILEMIGRATOR_CID, false, NULL, nsSeamonkeyProfileMigratorConstructor },</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    {&amp;kNS_MAILDIRECTORYPROVIDER_CID, false, NULL, DirectoryProviderConstructor},</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+    {&amp;kNS_THUNDERBIRD_PROFILEIMPORT_CID, false, NULL,</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+     nsProfileMigratorConstructor},</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    {&amp;kNS_SEAMONKEYPROFILEMIGRATOR_CID, false, NULL,</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+     nsSeamonkeyProfileMigratorConstructor},</span>
<a href="#l2.66"></a><span id="l2.66"> #ifdef XP_WIN</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-  { &amp;kNS_OUTLOOKPROFILEMIGRATOR_CID, false, NULL, nsOutlookProfileMigratorConstructor },</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  { &amp;kNS_MAILWININTEGRATION_CID, false, NULL, nsWindowsShellServiceConstructor },</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-  { &amp;kNS_MAILWINSEARCHHELPER_CID, false, NULL, nsMailWinSearchHelperConstructor },</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-#endif // !XP_WIN</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    {&amp;kNS_OUTLOOKPROFILEMIGRATOR_CID, false, NULL,</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+     nsOutlookProfileMigratorConstructor},</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    {&amp;kNS_MAILWININTEGRATION_CID, false, NULL,</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+     nsWindowsShellServiceConstructor},</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    {&amp;kNS_MAILWINSEARCHHELPER_CID, false, NULL,</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+     nsMailWinSearchHelperConstructor},</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+#endif  // !XP_WIN</span>
<a href="#l2.78"></a><span id="l2.78"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  { &amp;kNS_MAILGNOMEINTEGRATION_CID, false, NULL, nsGNOMEShellServiceConstructor },</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    {&amp;kNS_MAILGNOMEINTEGRATION_CID, false, NULL,</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+     nsGNOMEShellServiceConstructor},</span>
<a href="#l2.82"></a><span id="l2.82"> #endif</span>
<a href="#l2.83"></a><span id="l2.83"> #ifdef XP_MACOSX</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-  { &amp;kNS_MAILMACINTEGRATION_CID, false, NULL, nsMacShellServiceConstructor },</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+    {&amp;kNS_MAILMACINTEGRATION_CID, false, NULL, nsMacShellServiceConstructor},</span>
<a href="#l2.86"></a><span id="l2.86"> #endif</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  { NULL }</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-};</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+    {NULL}};</span>
<a href="#l2.90"></a><span id="l2.90"> </span>
<a href="#l2.91"></a><span id="l2.91"> const mozilla::Module::ContractIDEntry kMailContracts[] = {</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-  { NS_MAILDIRECTORYPROVIDER_CONTRACTID, &amp;kNS_MAILDIRECTORYPROVIDER_CID },</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-  { NS_PROFILEMIGRATOR_CONTRACTID, &amp;kNS_THUNDERBIRD_PROFILEIMPORT_CID },</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-  { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;seamonkey&quot;, &amp;kNS_SEAMONKEYPROFILEMIGRATOR_CID },</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+    {NS_MAILDIRECTORYPROVIDER_CONTRACTID, &amp;kNS_MAILDIRECTORYPROVIDER_CID},</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    {NS_PROFILEMIGRATOR_CONTRACTID, &amp;kNS_THUNDERBIRD_PROFILEIMPORT_CID},</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+    {NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;seamonkey&quot;,</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+     &amp;kNS_SEAMONKEYPROFILEMIGRATOR_CID},</span>
<a href="#l2.99"></a><span id="l2.99"> #ifdef XP_WIN</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-  { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;outlook&quot;, &amp;kNS_OUTLOOKPROFILEMIGRATOR_CID },</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-  { &quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILWININTEGRATION_CID },</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-  { &quot;@mozilla.org/mail/windows-search-helper;1&quot;, &amp;kNS_MAILWINSEARCHHELPER_CID },</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-#endif // !XP_WIN</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+    {NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;outlook&quot;,</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+     &amp;kNS_OUTLOOKPROFILEMIGRATOR_CID},</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+    {&quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILWININTEGRATION_CID},</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+    {&quot;@mozilla.org/mail/windows-search-helper;1&quot;, &amp;kNS_MAILWINSEARCHHELPER_CID},</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+#endif  // !XP_WIN</span>
<a href="#l2.109"></a><span id="l2.109"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-  { &quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILGNOMEINTEGRATION_CID },</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    {&quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILGNOMEINTEGRATION_CID},</span>
<a href="#l2.112"></a><span id="l2.112"> #endif</span>
<a href="#l2.113"></a><span id="l2.113"> #ifdef XP_MACOSX</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-  { &quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILMACINTEGRATION_CID },</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+    {&quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILMACINTEGRATION_CID},</span>
<a href="#l2.116"></a><span id="l2.116"> #endif</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-  { NULL }</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-};</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+    {NULL}};</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121"> static const mozilla::Module::CategoryEntry kMailCategories[] = {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-  { XPCOM_DIRECTORY_PROVIDER_CATEGORY, &quot;mailcomps-directory-provider&quot;, NS_MAILDIRECTORYPROVIDER_CONTRACTID },</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-  { NULL }</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-};</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+    {XPCOM_DIRECTORY_PROVIDER_CATEGORY, &quot;mailcomps-directory-provider&quot;,</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+     NS_MAILDIRECTORYPROVIDER_CONTRACTID},</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+    {NULL}};</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129"> extern const mozilla::Module kMailCompsModule = {</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-  mozilla::Module::kVersion,</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-  kMailCIDs,</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-  kMailContracts,</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-  kMailCategories</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-};</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+    mozilla::Module::kVersion, kMailCIDs, kMailContracts, kMailCategories};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/migration/public/nsMailMigrationCID.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/migration/public/nsMailMigrationCID.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,11 +1,20 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-#define NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;@mozilla.org/profile/migrator;1?app=mail&amp;type=&quot;</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+#define NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX \</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  &quot;@mozilla.org/profile/migrator;1?app=mail&amp;type=&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#define NS_SEAMONKEYPROFILEMIGRATOR_CID \</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{ 0x62c6e1f9, 0x3dc3, 0x4b68, { 0x9c, 0x39, 0xad, 0x2f, 0x6d, 0x47, 0x1a, 0xc0 } }</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+#define NS_SEAMONKEYPROFILEMIGRATOR_CID              \</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  {                                                  \</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    0x62c6e1f9, 0x3dc3, 0x4b68, {                    \</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      0x9c, 0x39, 0xad, 0x2f, 0x6d, 0x47, 0x1a, 0xc0 \</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    }                                                \</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  }</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-#define NS_OUTLOOKPROFILEMIGRATOR_CID \</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-{ 0x910b6453, 0x719, 0x41e8, { 0xa4, 0xc9, 0x3, 0x19, 0xbb, 0x34, 0xc8, 0xff } }</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+#define NS_OUTLOOKPROFILEMIGRATOR_CID               \</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  {                                                 \</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    0x910b6453, 0x719, 0x41e8, {                    \</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+      0xa4, 0xc9, 0x3, 0x19, 0xbb, 0x34, 0xc8, 0xff \</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    }                                               \</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/migration/src/nsMailProfileMigratorUtils.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/migration/src/nsMailProfileMigratorUtils.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -8,87 +8,79 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIProperties.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsIProfileMigrator.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsXPCOMCID.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> void SetProxyPref(const nsACString&amp; aHostPort, const char* aPref,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                  const char* aPortPref, nsIPrefBranch* aPrefs)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+                  const char* aPortPref, nsIPrefBranch* aPrefs) {</span>
<a href="#l4.15"></a><span id="l4.15">   nsAutoCString hostPort(aHostPort);</span>
<a href="#l4.16"></a><span id="l4.16">   int32_t portDelimOffset = hostPort.RFindChar(':');</span>
<a href="#l4.17"></a><span id="l4.17">   if (portDelimOffset &gt; 0) {</span>
<a href="#l4.18"></a><span id="l4.18">     nsAutoCString host(Substring(hostPort, 0, portDelimOffset));</span>
<a href="#l4.19"></a><span id="l4.19">     nsAutoCString port(Substring(hostPort, portDelimOffset + 1,</span>
<a href="#l4.20"></a><span id="l4.20">                                  hostPort.Length() - (portDelimOffset + 1)));</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">     aPrefs-&gt;SetCharPref(aPref, host);</span>
<a href="#l4.23"></a><span id="l4.23">     nsresult stringErr;</span>
<a href="#l4.24"></a><span id="l4.24">     int32_t portValue = port.ToInteger(&amp;stringErr);</span>
<a href="#l4.25"></a><span id="l4.25">     aPrefs-&gt;SetIntPref(aPortPref, portValue);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-  }</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  else</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  } else</span>
<a href="#l4.29"></a><span id="l4.29">     aPrefs-&gt;SetCharPref(aPref, hostPort);</span>
<a href="#l4.30"></a><span id="l4.30"> }</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-void ParseOverrideServers(const char* aServers, nsIPrefBranch* aBranch)</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-{</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+void ParseOverrideServers(const char* aServers, nsIPrefBranch* aBranch) {</span>
<a href="#l4.35"></a><span id="l4.35">   // Windows (and Opera) formats its proxy override list in the form:</span>
<a href="#l4.36"></a><span id="l4.36">   // server;server;server where server is a server name or ip address,</span>
<a href="#l4.37"></a><span id="l4.37">   // or &quot;&lt;local&gt;&quot;. Mozilla's format is server,server,server, and &lt;local&gt;</span>
<a href="#l4.38"></a><span id="l4.38">   // must be translated to &quot;localhost,127.0.0.1&quot;</span>
<a href="#l4.39"></a><span id="l4.39">   nsAutoCString override(aServers);</span>
<a href="#l4.40"></a><span id="l4.40">   int32_t left = 0, right = 0;</span>
<a href="#l4.41"></a><span id="l4.41">   for (;;) {</span>
<a href="#l4.42"></a><span id="l4.42">     right = override.FindChar(';', right);</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    const nsACString&amp; host = Substring(override, left,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-                                       (right &lt; 0 ? override.Length() : right) - left);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    const nsACString&amp; host = Substring(</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+        override, left, (right &lt; 0 ? override.Length() : right) - left);</span>
<a href="#l4.47"></a><span id="l4.47">     if (host.Equals(&quot;&lt;local&gt;&quot;))</span>
<a href="#l4.48"></a><span id="l4.48">       override.Replace(left, 7, NS_LITERAL_CSTRING(&quot;localhost,127.0.0.1&quot;));</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-    if (right &lt; 0)</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-      break;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    if (right &lt; 0) break;</span>
<a href="#l4.52"></a><span id="l4.52">     left = right + 1;</span>
<a href="#l4.53"></a><span id="l4.53">     override.Replace(right, 1, NS_LITERAL_CSTRING(&quot;,&quot;));</span>
<a href="#l4.54"></a><span id="l4.54">   }</span>
<a href="#l4.55"></a><span id="l4.55">   aBranch-&gt;SetCharPref(&quot;network.proxy.no_proxies_on&quot;, override);</span>
<a href="#l4.56"></a><span id="l4.56"> }</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-void GetMigrateDataFromArray(MigrationData* aDataArray, int32_t aDataArrayLength,</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-                             bool aReplace, nsIFile* aSourceProfile,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-                             uint16_t* aResult)</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-{</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+void GetMigrateDataFromArray(MigrationData* aDataArray,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+                             int32_t aDataArrayLength, bool aReplace,</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+                             nsIFile* aSourceProfile, uint16_t* aResult) {</span>
<a href="#l4.65"></a><span id="l4.65">   nsCOMPtr&lt;nsIFile&gt; sourceFile;</span>
<a href="#l4.66"></a><span id="l4.66">   bool exists;</span>
<a href="#l4.67"></a><span id="l4.67">   MigrationData* cursor;</span>
<a href="#l4.68"></a><span id="l4.68">   MigrationData* end = aDataArray + aDataArrayLength;</span>
<a href="#l4.69"></a><span id="l4.69">   for (cursor = aDataArray; cursor &lt; end &amp;&amp; cursor-&gt;fileName; ++cursor) {</span>
<a href="#l4.70"></a><span id="l4.70">     // When in replace mode, all items can be imported.</span>
<a href="#l4.71"></a><span id="l4.71">     // When in non-replace mode, only items that do not require file replacement</span>
<a href="#l4.72"></a><span id="l4.72">     // can be imported.</span>
<a href="#l4.73"></a><span id="l4.73">     if (aReplace || !cursor-&gt;replaceOnly) {</span>
<a href="#l4.74"></a><span id="l4.74">       aSourceProfile-&gt;Clone(getter_AddRefs(sourceFile));</span>
<a href="#l4.75"></a><span id="l4.75">       sourceFile-&gt;Append(nsDependentString(cursor-&gt;fileName));</span>
<a href="#l4.76"></a><span id="l4.76">       sourceFile-&gt;Exists(&amp;exists);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-      if (exists)</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-        *aResult |= cursor-&gt;sourceFlag;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+      if (exists) *aResult |= cursor-&gt;sourceFlag;</span>
<a href="#l4.80"></a><span id="l4.80">     }</span>
<a href="#l4.81"></a><span id="l4.81">     free(cursor-&gt;fileName);</span>
<a href="#l4.82"></a><span id="l4.82">     cursor-&gt;fileName = nullptr;</span>
<a href="#l4.83"></a><span id="l4.83">   }</span>
<a href="#l4.84"></a><span id="l4.84"> }</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-void</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-GetProfilePath(nsIProfileStartup* aStartup, nsCOMPtr&lt;nsIFile&gt;&amp; aProfileDir)</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-{</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+void GetProfilePath(nsIProfileStartup* aStartup,</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+                    nsCOMPtr&lt;nsIFile&gt;&amp; aProfileDir) {</span>
<a href="#l4.91"></a><span id="l4.91">   if (aStartup) {</span>
<a href="#l4.92"></a><span id="l4.92">     aStartup-&gt;GetDirectory(getter_AddRefs(aProfileDir));</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-  }</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  else {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    nsCOMPtr&lt;nsIProperties&gt; dirSvc</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-      (do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID));</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  } else {</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+    nsCOMPtr&lt;nsIProperties&gt; dirSvc(</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+        do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID));</span>
<a href="#l4.100"></a><span id="l4.100">     if (dirSvc) {</span>
<a href="#l4.101"></a><span id="l4.101">       dirSvc-&gt;Get(NS_APP_USER_PROFILE_50_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l4.102"></a><span id="l4.102">                   getter_AddRefs(aProfileDir));</span>
<a href="#l4.103"></a><span id="l4.103">     }</span>
<a href="#l4.104"></a><span id="l4.104">   }</span>
<a href="#l4.105"></a><span id="l4.105"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/migration/src/nsMailProfileMigratorUtils.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/migration/src/nsMailProfileMigratorUtils.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2,31 +2,31 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> #ifndef mailprofilemigratorutils___h___</span>
<a href="#l5.9"></a><span id="l5.9"> #define mailprofilemigratorutils___h___</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> #define MIGRATION_ITEMBEFOREMIGRATE &quot;Migration:ItemBeforeMigrate&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#define MIGRATION_ITEMAFTERMIGRATE  &quot;Migration:ItemAfterMigrate&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-#define MIGRATION_STARTED           &quot;Migration:Started&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-#define MIGRATION_ENDED             &quot;Migration:Ended&quot;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-#define MIGRATION_PROGRESS          &quot;Migration:Progress&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+#define MIGRATION_ITEMAFTERMIGRATE &quot;Migration:ItemAfterMigrate&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+#define MIGRATION_STARTED &quot;Migration:Started&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+#define MIGRATION_ENDED &quot;Migration:Ended&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+#define MIGRATION_PROGRESS &quot;Migration:Progress&quot;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> #define NOTIFY_OBSERVERS(message, item) \</span>
<a href="#l5.22"></a><span id="l5.22">   mObserverService-&gt;NotifyObservers(nullptr, message, item)</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-#define COPY_DATA(func, replace, itemIndex) \</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; (aItems &amp; itemIndex || !aItems)) { \</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-    nsAutoString index; \</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-    index.AppendInt(itemIndex); \</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+#define COPY_DATA(func, replace, itemIndex)                     \</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; (aItems &amp; itemIndex || !aItems)) {    \</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    nsAutoString index;                                         \</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+    index.AppendInt(itemIndex);                                 \</span>
<a href="#l5.32"></a><span id="l5.32">     NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get()); \</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-    rv = func(replace); \</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-    NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get()); \</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+    rv = func(replace);                                         \</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get());  \</span>
<a href="#l5.37"></a><span id="l5.37">   }</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l5.40"></a><span id="l5.40"> #include &quot;nsIFile.h&quot;</span>
<a href="#l5.41"></a><span id="l5.41"> #include &quot;nsString.h&quot;</span>
<a href="#l5.42"></a><span id="l5.42"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.43"></a><span id="l5.43"> class nsIProfileStartup;</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45" class="difflineat">@@ -38,20 +38,17 @@ void SetProxyPref(const nsACString&amp; aHos</span>
<a href="#l5.46"></a><span id="l5.46"> struct MigrationData {</span>
<a href="#l5.47"></a><span id="l5.47">   char16_t* fileName;</span>
<a href="#l5.48"></a><span id="l5.48">   uint32_t sourceFlag;</span>
<a href="#l5.49"></a><span id="l5.49">   bool replaceOnly;</span>
<a href="#l5.50"></a><span id="l5.50"> };</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52"> class nsIFile;</span>
<a href="#l5.53"></a><span id="l5.53"> void GetMigrateDataFromArray(MigrationData* aDataArray,</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-                             int32_t aDataArrayLength,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-                             bool aReplace,</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-                             nsIFile* aSourceProfile,</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-                             uint16_t* aResult);</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+                             int32_t aDataArrayLength, bool aReplace,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+                             nsIFile* aSourceProfile, uint16_t* aResult);</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62"> // get the base directory of the *target* profile</span>
<a href="#l5.63"></a><span id="l5.63"> // this is already cloned, modify it to your heart's content</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-void GetProfilePath(nsIProfileStartup* aStartup, nsCOMPtr&lt;nsIFile&gt;&amp; aProfileDir);</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+void GetProfilePath(nsIProfileStartup* aStartup,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+                    nsCOMPtr&lt;nsIFile&gt;&amp; aProfileDir);</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68"> #endif</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -18,51 +18,48 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;prtime.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;prprf.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsINIParser.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsMailProfileMigratorUtils.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsIDirectoryEnumerator.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#define MIGRATION_BUNDLE &quot;chrome://messenger/locale/migration/migration.properties&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#define MIGRATION_BUNDLE \</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  &quot;chrome://messenger/locale/migration/migration.properties&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> #define FILE_NAME_PREFS_5X NS_LITERAL_STRING(&quot;prefs.js&quot;)</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.19"></a><span id="l6.19"> // nsNetscapeProfileMigratorBase</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-nsNetscapeProfileMigratorBase::nsNetscapeProfileMigratorBase()</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-{</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+nsNetscapeProfileMigratorBase::nsNetscapeProfileMigratorBase() {</span>
<a href="#l6.23"></a><span id="l6.23">   mObserverService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;);</span>
<a href="#l6.24"></a><span id="l6.24">   mMaxProgress = 0;</span>
<a href="#l6.25"></a><span id="l6.25">   mCurrentProgress = 0;</span>
<a href="#l6.26"></a><span id="l6.26">   mFileCopyTransactionIndex = 0;</span>
<a href="#l6.27"></a><span id="l6.27"> }</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29"> NS_IMPL_ISUPPORTS(nsNetscapeProfileMigratorBase, nsIMailProfileMigrator,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-                   nsITimerCallback)</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+                  nsITimerCallback)</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-nsresult</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-nsNetscapeProfileMigratorBase::GetProfileDataFromProfilesIni(nsIFile* aDataDir,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-                                                             nsIMutableArray* aProfileNames,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-                                                             nsIMutableArray* aProfileLocations)</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-{</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::GetProfileDataFromProfilesIni(</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    nsIFile* aDataDir, nsIMutableArray* aProfileNames,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+    nsIMutableArray* aProfileLocations) {</span>
<a href="#l6.41"></a><span id="l6.41">   nsCOMPtr&lt;nsIFile&gt; profileIni;</span>
<a href="#l6.42"></a><span id="l6.42">   nsresult rv = aDataDir-&gt;Clone(getter_AddRefs(profileIni));</span>
<a href="#l6.43"></a><span id="l6.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">   profileIni-&gt;Append(NS_LITERAL_STRING(&quot;profiles.ini&quot;));</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">   // Does it exist?</span>
<a href="#l6.48"></a><span id="l6.48">   bool profileFileExists = false;</span>
<a href="#l6.49"></a><span id="l6.49">   rv = profileIni-&gt;Exists(&amp;profileFileExists);</span>
<a href="#l6.50"></a><span id="l6.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  if (!profileFileExists)</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  if (!profileFileExists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56">   nsINIParser parser;</span>
<a href="#l6.57"></a><span id="l6.57">   rv = parser.Init(profileIni);</span>
<a href="#l6.58"></a><span id="l6.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">   nsAutoCString buffer, filePath;</span>
<a href="#l6.61"></a><span id="l6.61">   bool isRelative;</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63" class="difflineat">@@ -88,152 +85,133 @@ nsNetscapeProfileMigratorBase::GetProfil</span>
<a href="#l6.64"></a><span id="l6.64">       NS_ERROR(&quot;Malformed profiles.ini: Name= not found&quot;);</span>
<a href="#l6.65"></a><span id="l6.65">       continue;</span>
<a href="#l6.66"></a><span id="l6.66">     }</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">     nsCOMPtr&lt;nsIFile&gt; rootDir;</span>
<a href="#l6.69"></a><span id="l6.69">     rv = NS_NewNativeLocalFile(EmptyCString(), true, getter_AddRefs(rootDir));</span>
<a href="#l6.70"></a><span id="l6.70">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-    rv = isRelative ? rootDir-&gt;SetRelativeDescriptor(aDataDir, filePath) :</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-                      rootDir-&gt;SetPersistentDescriptor(filePath);</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-      continue;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+    rv = isRelative ? rootDir-&gt;SetRelativeDescriptor(aDataDir, filePath)</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+                    : rootDir-&gt;SetPersistentDescriptor(filePath);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80">     bool exists = false;</span>
<a href="#l6.81"></a><span id="l6.81">     rootDir-&gt;Exists(&amp;exists);</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83">     if (exists) {</span>
<a href="#l6.84"></a><span id="l6.84">       aProfileLocations-&gt;AppendElement(rootDir);</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86">       nsCOMPtr&lt;nsISupportsString&gt; profileNameString(</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/supports-string;1&quot;));</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+          do_CreateInstance(&quot;@mozilla.org/supports-string;1&quot;));</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">       profileNameString-&gt;SetData(NS_ConvertUTF8toUTF16(buffer));</span>
<a href="#l6.91"></a><span id="l6.91">       aProfileNames-&gt;AppendElement(profileNameString);</span>
<a href="#l6.92"></a><span id="l6.92">     }</span>
<a href="#l6.93"></a><span id="l6.93">   }</span>
<a href="#l6.94"></a><span id="l6.94">   return NS_OK;</span>
<a href="#l6.95"></a><span id="l6.95"> }</span>
<a href="#l6.96"></a><span id="l6.96"> </span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-#define GETPREF(xform, method, value) \</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+#define GETPREF(xform, method, value)                          \</span>
<a href="#l6.99"></a><span id="l6.99">   nsresult rv = aBranch-&gt;method(xform-&gt;sourcePrefName, value); \</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-  if (NS_SUCCEEDED(rv)) \</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-    xform-&gt;prefHasValue = true; \</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  if (NS_SUCCEEDED(rv)) xform-&gt;prefHasValue = true;            \</span>
<a href="#l6.103"></a><span id="l6.103">   return rv;</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-#define SETPREF(xform, method, value) \</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-  if (xform-&gt;prefHasValue) { \</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-    return aBranch-&gt;method(xform-&gt;targetPrefName ? xform-&gt;targetPrefName : xform-&gt;sourcePrefName, value); \</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-  } \</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+#define SETPREF(xform, method, value)                                          \</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  if (xform-&gt;prefHasValue) {                                                   \</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+    return aBranch-&gt;method(                                                    \</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+        xform-&gt;targetPrefName ? xform-&gt;targetPrefName : xform-&gt;sourcePrefName, \</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+        value);                                                                \</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  }                                                                            \</span>
<a href="#l6.115"></a><span id="l6.115">   return NS_OK;</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-nsresult</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-nsNetscapeProfileMigratorBase::GetString(PrefTransform* aTransform,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-                                         nsIPrefBranch* aBranch)</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-{</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::GetString(PrefTransform* aTransform,</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+                                                  nsIPrefBranch* aBranch) {</span>
<a href="#l6.123"></a><span id="l6.123">   PrefTransform* xform = (PrefTransform*)aTransform;</span>
<a href="#l6.124"></a><span id="l6.124">   nsCString str;</span>
<a href="#l6.125"></a><span id="l6.125">   nsresult rv = aBranch-&gt;GetCharPref(xform-&gt;sourcePrefName, str);</span>
<a href="#l6.126"></a><span id="l6.126">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.127"></a><span id="l6.127">     xform-&gt;prefHasValue = true;</span>
<a href="#l6.128"></a><span id="l6.128">     xform-&gt;stringValue = moz_xstrdup(str.get());</span>
<a href="#l6.129"></a><span id="l6.129">   }</span>
<a href="#l6.130"></a><span id="l6.130">   return rv;</span>
<a href="#l6.131"></a><span id="l6.131"> }</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-nsresult</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-nsNetscapeProfileMigratorBase::SetString(PrefTransform* aTransform,</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-                                         nsIPrefBranch* aBranch)</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-{</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::SetString(PrefTransform* aTransform,</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+                                                  nsIPrefBranch* aBranch) {</span>
<a href="#l6.139"></a><span id="l6.139">   PrefTransform* xform = (PrefTransform*)aTransform;</span>
<a href="#l6.140"></a><span id="l6.140">   SETPREF(xform, SetCharPref, nsDependentCString(xform-&gt;stringValue));</span>
<a href="#l6.141"></a><span id="l6.141"> }</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-nsresult</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-nsNetscapeProfileMigratorBase::GetBool(PrefTransform* aTransform,</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-                                       nsIPrefBranch* aBranch)</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-{</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::GetBool(PrefTransform* aTransform,</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+                                                nsIPrefBranch* aBranch) {</span>
<a href="#l6.149"></a><span id="l6.149">   PrefTransform* xform = (PrefTransform*)aTransform;</span>
<a href="#l6.150"></a><span id="l6.150">   GETPREF(xform, GetBoolPref, &amp;xform-&gt;boolValue);</span>
<a href="#l6.151"></a><span id="l6.151"> }</span>
<a href="#l6.152"></a><span id="l6.152"> </span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-nsresult</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-nsNetscapeProfileMigratorBase::SetBool(PrefTransform* aTransform,</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-                                       nsIPrefBranch* aBranch)</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-{</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::SetBool(PrefTransform* aTransform,</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+                                                nsIPrefBranch* aBranch) {</span>
<a href="#l6.159"></a><span id="l6.159">   PrefTransform* xform = (PrefTransform*)aTransform;</span>
<a href="#l6.160"></a><span id="l6.160">   SETPREF(xform, SetBoolPref, xform-&gt;boolValue);</span>
<a href="#l6.161"></a><span id="l6.161"> }</span>
<a href="#l6.162"></a><span id="l6.162"> </span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-nsresult</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-nsNetscapeProfileMigratorBase::GetInt(PrefTransform* aTransform,</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-                                      nsIPrefBranch* aBranch)</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-{</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::GetInt(PrefTransform* aTransform,</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+                                               nsIPrefBranch* aBranch) {</span>
<a href="#l6.169"></a><span id="l6.169">   PrefTransform* xform = (PrefTransform*)aTransform;</span>
<a href="#l6.170"></a><span id="l6.170">   GETPREF(xform, GetIntPref, &amp;xform-&gt;intValue);</span>
<a href="#l6.171"></a><span id="l6.171"> }</span>
<a href="#l6.172"></a><span id="l6.172"> </span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-nsresult</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-nsNetscapeProfileMigratorBase::SetInt(PrefTransform* aTransform,</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-                                      nsIPrefBranch* aBranch)</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-{</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::SetInt(PrefTransform* aTransform,</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+                                               nsIPrefBranch* aBranch) {</span>
<a href="#l6.179"></a><span id="l6.179">   PrefTransform* xform = (PrefTransform*)aTransform;</span>
<a href="#l6.180"></a><span id="l6.180">   SETPREF(xform, SetIntPref, xform-&gt;intValue);</span>
<a href="#l6.181"></a><span id="l6.181"> }</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-nsresult</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-nsNetscapeProfileMigratorBase::CopyFile(const nsAString&amp; aSourceFileName, const nsAString&amp; aTargetFileName)</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-{</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::CopyFile(</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+    const nsAString&amp; aSourceFileName, const nsAString&amp; aTargetFileName) {</span>
<a href="#l6.188"></a><span id="l6.188">   nsCOMPtr&lt;nsIFile&gt; sourceFile;</span>
<a href="#l6.189"></a><span id="l6.189">   mSourceProfile-&gt;Clone(getter_AddRefs(sourceFile));</span>
<a href="#l6.190"></a><span id="l6.190"> </span>
<a href="#l6.191"></a><span id="l6.191">   sourceFile-&gt;Append(aSourceFileName);</span>
<a href="#l6.192"></a><span id="l6.192">   bool exists = false;</span>
<a href="#l6.193"></a><span id="l6.193">   sourceFile-&gt;Exists(&amp;exists);</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-  if (!exists)</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+  if (!exists) return NS_OK;</span>
<a href="#l6.197"></a><span id="l6.197"> </span>
<a href="#l6.198"></a><span id="l6.198">   nsCOMPtr&lt;nsIFile&gt; targetFile;</span>
<a href="#l6.199"></a><span id="l6.199">   mTargetProfile-&gt;Clone(getter_AddRefs(targetFile));</span>
<a href="#l6.200"></a><span id="l6.200"> </span>
<a href="#l6.201"></a><span id="l6.201">   targetFile-&gt;Append(aTargetFileName);</span>
<a href="#l6.202"></a><span id="l6.202">   targetFile-&gt;Exists(&amp;exists);</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-  if (exists)</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-    targetFile-&gt;Remove(false);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+  if (exists) targetFile-&gt;Remove(false);</span>
<a href="#l6.206"></a><span id="l6.206"> </span>
<a href="#l6.207"></a><span id="l6.207">   return sourceFile-&gt;CopyTo(mTargetProfile, aTargetFileName);</span>
<a href="#l6.208"></a><span id="l6.208"> }</span>
<a href="#l6.209"></a><span id="l6.209"> </span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-nsresult</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-nsNetscapeProfileMigratorBase::GetSignonFileName(bool aReplace, nsACString&amp; aFileName)</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-{</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::GetSignonFileName(</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    bool aReplace, nsACString&amp; aFileName) {</span>
<a href="#l6.215"></a><span id="l6.215">   nsresult rv;</span>
<a href="#l6.216"></a><span id="l6.216">   if (aReplace) {</span>
<a href="#l6.217"></a><span id="l6.217">     // Find out what the signons file was called, this is stored in a pref</span>
<a href="#l6.218"></a><span id="l6.218">     // in Seamonkey.</span>
<a href="#l6.219"></a><span id="l6.219">     nsCOMPtr&lt;nsIPrefService&gt; psvc(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l6.220"></a><span id="l6.220">     psvc-&gt;ResetPrefs();</span>
<a href="#l6.221"></a><span id="l6.221"> </span>
<a href="#l6.222"></a><span id="l6.222">     nsCOMPtr&lt;nsIFile&gt; sourcePrefsName;</span>
<a href="#l6.223"></a><span id="l6.223">     mSourceProfile-&gt;Clone(getter_AddRefs(sourcePrefsName));</span>
<a href="#l6.224"></a><span id="l6.224">     sourcePrefsName-&gt;Append(FILE_NAME_PREFS_5X);</span>
<a href="#l6.225"></a><span id="l6.225">     psvc-&gt;ReadUserPrefsFromFile(sourcePrefsName);</span>
<a href="#l6.226"></a><span id="l6.226"> </span>
<a href="#l6.227"></a><span id="l6.227">     nsCOMPtr&lt;nsIPrefBranch&gt; branch(do_QueryInterface(psvc));</span>
<a href="#l6.228"></a><span id="l6.228">     rv = branch-&gt;GetCharPref(&quot;signon.SignonFileName&quot;, aFileName);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-  }</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-  else</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+  } else</span>
<a href="#l6.232"></a><span id="l6.232">     rv = LocateSignonsFile(aFileName);</span>
<a href="#l6.233"></a><span id="l6.233">   return rv;</span>
<a href="#l6.234"></a><span id="l6.234"> }</span>
<a href="#l6.235"></a><span id="l6.235"> </span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-nsresult</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-nsNetscapeProfileMigratorBase::LocateSignonsFile(nsACString&amp; aResult)</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-{</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::LocateSignonsFile(nsACString&amp; aResult) {</span>
<a href="#l6.240"></a><span id="l6.240">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; entries;</span>
<a href="#l6.241"></a><span id="l6.241">   nsresult rv = mSourceProfile-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l6.242"></a><span id="l6.242">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.243"></a><span id="l6.243"> </span>
<a href="#l6.244"></a><span id="l6.244">   nsAutoCString fileName;</span>
<a href="#l6.245"></a><span id="l6.245">   bool hasMore = false;</span>
<a href="#l6.246"></a><span id="l6.246">   while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l6.247"></a><span id="l6.247">     nsCOMPtr&lt;nsIFile&gt; currFile;</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineat">@@ -257,18 +235,18 @@ nsNetscapeProfileMigratorBase::LocateSig</span>
<a href="#l6.249"></a><span id="l6.249">   aResult = fileName;</span>
<a href="#l6.250"></a><span id="l6.250"> </span>
<a href="#l6.251"></a><span id="l6.251">   return NS_OK;</span>
<a href="#l6.252"></a><span id="l6.252"> }</span>
<a href="#l6.253"></a><span id="l6.253"> </span>
<a href="#l6.254"></a><span id="l6.254"> // helper function, copies the contents of srcDir into destDir.</span>
<a href="#l6.255"></a><span id="l6.255"> // destDir will be created if it doesn't exist.</span>
<a href="#l6.256"></a><span id="l6.256"> </span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-nsresult nsNetscapeProfileMigratorBase::RecursiveCopy(nsIFile* srcDir, nsIFile* destDir)</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-{</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+nsresult nsNetscapeProfileMigratorBase::RecursiveCopy(nsIFile* srcDir,</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+                                                      nsIFile* destDir) {</span>
<a href="#l6.261"></a><span id="l6.261">   nsresult rv;</span>
<a href="#l6.262"></a><span id="l6.262">   bool isDir;</span>
<a href="#l6.263"></a><span id="l6.263"> </span>
<a href="#l6.264"></a><span id="l6.264">   rv = srcDir-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l6.265"></a><span id="l6.265">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.266"></a><span id="l6.266">   if (!isDir) return NS_ERROR_INVALID_ARG;</span>
<a href="#l6.267"></a><span id="l6.267"> </span>
<a href="#l6.268"></a><span id="l6.268">   bool exists;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineat">@@ -277,44 +255,38 @@ nsresult nsNetscapeProfileMigratorBase::</span>
<a href="#l6.270"></a><span id="l6.270">     rv = destDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l6.271"></a><span id="l6.271">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.272"></a><span id="l6.272"> </span>
<a href="#l6.273"></a><span id="l6.273">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; dirIterator;</span>
<a href="#l6.274"></a><span id="l6.274">   rv = srcDir-&gt;GetDirectoryEntries(getter_AddRefs(dirIterator));</span>
<a href="#l6.275"></a><span id="l6.275">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.276"></a><span id="l6.276"> </span>
<a href="#l6.277"></a><span id="l6.277">   bool hasMore = false;</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-  while (NS_SUCCEEDED(dirIterator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-  {</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+  while (NS_SUCCEEDED(dirIterator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l6.281"></a><span id="l6.281">     nsCOMPtr&lt;nsIFile&gt; dirEntry;</span>
<a href="#l6.282"></a><span id="l6.282">     rv = dirIterator-&gt;GetNextFile(getter_AddRefs(dirEntry));</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; dirEntry)</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-    {</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; dirEntry) {</span>
<a href="#l6.286"></a><span id="l6.286">       rv = dirEntry-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-      {</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-        if (isDir)</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-        {</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+        if (isDir) {</span>
<a href="#l6.293"></a><span id="l6.293">           nsCOMPtr&lt;nsIFile&gt; newChild;</span>
<a href="#l6.294"></a><span id="l6.294">           rv = destDir-&gt;Clone(getter_AddRefs(newChild));</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-          {</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.298"></a><span id="l6.298">             nsAutoString leafName;</span>
<a href="#l6.299"></a><span id="l6.299">             dirEntry-&gt;GetLeafName(leafName);</span>
<a href="#l6.300"></a><span id="l6.300">             newChild-&gt;AppendRelativePath(leafName);</span>
<a href="#l6.301"></a><span id="l6.301">             rv = newChild-&gt;Exists(&amp;exists);</span>
<a href="#l6.302"></a><span id="l6.302">             if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l6.303"></a><span id="l6.303">               rv = newChild-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l6.304"></a><span id="l6.304">             rv = RecursiveCopy(dirEntry, newChild);</span>
<a href="#l6.305"></a><span id="l6.305">           }</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-        }</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-        else</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-        {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-          // we aren't going to do any actual file copying here. Instead, add this to our</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-          // file transaction list so we can copy files asynchronously...</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+        } else {</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+          // we aren't going to do any actual file copying here. Instead, add</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+          // this to our file transaction list so we can copy files</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+          // asynchronously...</span>
<a href="#l6.315"></a><span id="l6.315">           fileTransactionEntry fileEntry;</span>
<a href="#l6.316"></a><span id="l6.316">           fileEntry.srcFile = dirEntry;</span>
<a href="#l6.317"></a><span id="l6.317">           fileEntry.destFile = destDir;</span>
<a href="#l6.318"></a><span id="l6.318"> </span>
<a href="#l6.319"></a><span id="l6.319">           mFileCopyTransactions.AppendElement(fileEntry);</span>
<a href="#l6.320"></a><span id="l6.320">         }</span>
<a href="#l6.321"></a><span id="l6.321">       }</span>
<a href="#l6.322"></a><span id="l6.322">     }</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineat">@@ -322,28 +294,25 @@ nsresult nsNetscapeProfileMigratorBase::</span>
<a href="#l6.324"></a><span id="l6.324"> </span>
<a href="#l6.325"></a><span id="l6.325">   return rv;</span>
<a href="#l6.326"></a><span id="l6.326"> }</span>
<a href="#l6.327"></a><span id="l6.327"> </span>
<a href="#l6.328"></a><span id="l6.328"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.329"></a><span id="l6.329"> // nsITimerCallback</span>
<a href="#l6.330"></a><span id="l6.330"> </span>
<a href="#l6.331"></a><span id="l6.331"> NS_IMETHODIMP</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-nsNetscapeProfileMigratorBase::Notify(nsITimer *timer)</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-{</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+nsNetscapeProfileMigratorBase::Notify(nsITimer* timer) {</span>
<a href="#l6.335"></a><span id="l6.335">   CopyNextFolder();</span>
<a href="#l6.336"></a><span id="l6.336">   return NS_OK;</span>
<a href="#l6.337"></a><span id="l6.337"> }</span>
<a href="#l6.338"></a><span id="l6.338"> </span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-void nsNetscapeProfileMigratorBase::CopyNextFolder()</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-{</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-  if (mFileCopyTransactionIndex &lt; mFileCopyTransactions.Length())</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-  {</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+void nsNetscapeProfileMigratorBase::CopyNextFolder() {</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+  if (mFileCopyTransactionIndex &lt; mFileCopyTransactions.Length()) {</span>
<a href="#l6.345"></a><span id="l6.345">     fileTransactionEntry fileTransaction =</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-      mFileCopyTransactions.ElementAt(mFileCopyTransactionIndex++);</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+        mFileCopyTransactions.ElementAt(mFileCopyTransactionIndex++);</span>
<a href="#l6.348"></a><span id="l6.348"> </span>
<a href="#l6.349"></a><span id="l6.349">     // copy the file</span>
<a href="#l6.350"></a><span id="l6.350">     fileTransaction.srcFile-&gt;CopyTo(fileTransaction.destFile,</span>
<a href="#l6.351"></a><span id="l6.351">                                     fileTransaction.newName);</span>
<a href="#l6.352"></a><span id="l6.352"> </span>
<a href="#l6.353"></a><span id="l6.353">     // add to our current progress</span>
<a href="#l6.354"></a><span id="l6.354">     int64_t fileSize;</span>
<a href="#l6.355"></a><span id="l6.355">     fileTransaction.srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineat">@@ -355,61 +324,58 @@ void nsNetscapeProfileMigratorBase::Copy</span>
<a href="#l6.357"></a><span id="l6.357">     index.AppendInt(percentage);</span>
<a href="#l6.358"></a><span id="l6.358"> </span>
<a href="#l6.359"></a><span id="l6.359">     NOTIFY_OBSERVERS(MIGRATION_PROGRESS, index.get());</span>
<a href="#l6.360"></a><span id="l6.360"> </span>
<a href="#l6.361"></a><span id="l6.361">     // fire a timer to handle the next one.</span>
<a href="#l6.362"></a><span id="l6.362">     mFileIOTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l6.363"></a><span id="l6.363"> </span>
<a href="#l6.364"></a><span id="l6.364">     if (mFileIOTimer)</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-      mFileIOTimer-&gt;InitWithCallback(static_cast&lt;nsITimerCallback *&gt;(this), percentage == 100 ? 500 : 0, nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+      mFileIOTimer-&gt;InitWithCallback(static_cast&lt;nsITimerCallback*&gt;(this),</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+                                     percentage == 100 ? 500 : 0,</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+                                     nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l6.369"></a><span id="l6.369">   } else</span>
<a href="#l6.370"></a><span id="l6.370">     EndCopyFolders();</span>
<a href="#l6.371"></a><span id="l6.371"> </span>
<a href="#l6.372"></a><span id="l6.372">   return;</span>
<a href="#l6.373"></a><span id="l6.373"> }</span>
<a href="#l6.374"></a><span id="l6.374"> </span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-void nsNetscapeProfileMigratorBase::EndCopyFolders()</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-{</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+void nsNetscapeProfileMigratorBase::EndCopyFolders() {</span>
<a href="#l6.378"></a><span id="l6.378">   mFileCopyTransactions.Clear();</span>
<a href="#l6.379"></a><span id="l6.379">   mFileCopyTransactionIndex = 0;</span>
<a href="#l6.380"></a><span id="l6.380"> </span>
<a href="#l6.381"></a><span id="l6.381">   // notify the UI that we are done with the migration process</span>
<a href="#l6.382"></a><span id="l6.382">   nsAutoString index;</span>
<a href="#l6.383"></a><span id="l6.383">   index.AppendInt(nsIMailProfileMigrator::MAILDATA);</span>
<a href="#l6.384"></a><span id="l6.384">   NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get());</span>
<a href="#l6.385"></a><span id="l6.385"> </span>
<a href="#l6.386"></a><span id="l6.386">   NOTIFY_OBSERVERS(MIGRATION_ENDED, nullptr);</span>
<a href="#l6.387"></a><span id="l6.387"> }</span>
<a href="#l6.388"></a><span id="l6.388"> </span>
<a href="#l6.389"></a><span id="l6.389"> NS_IMETHODIMP</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-nsNetscapeProfileMigratorBase::GetSourceHasMultipleProfiles(bool* aResult)</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-{</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+nsNetscapeProfileMigratorBase::GetSourceHasMultipleProfiles(bool* aResult) {</span>
<a href="#l6.393"></a><span id="l6.393">   nsCOMPtr&lt;nsIArray&gt; profiles;</span>
<a href="#l6.394"></a><span id="l6.394">   GetSourceProfiles(getter_AddRefs(profiles));</span>
<a href="#l6.395"></a><span id="l6.395"> </span>
<a href="#l6.396"></a><span id="l6.396">   if (profiles) {</span>
<a href="#l6.397"></a><span id="l6.397">     uint32_t count;</span>
<a href="#l6.398"></a><span id="l6.398">     profiles-&gt;GetLength(&amp;count);</span>
<a href="#l6.399"></a><span id="l6.399">     *aResult = count &gt; 1;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-  }</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-  else</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+  } else</span>
<a href="#l6.403"></a><span id="l6.403">     *aResult = false;</span>
<a href="#l6.404"></a><span id="l6.404"> </span>
<a href="#l6.405"></a><span id="l6.405">   return NS_OK;</span>
<a href="#l6.406"></a><span id="l6.406"> }</span>
<a href="#l6.407"></a><span id="l6.407"> </span>
<a href="#l6.408"></a><span id="l6.408"> NS_IMETHODIMP</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-nsNetscapeProfileMigratorBase::GetSourceExists(bool* aResult)</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-{</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+nsNetscapeProfileMigratorBase::GetSourceExists(bool* aResult) {</span>
<a href="#l6.412"></a><span id="l6.412">   nsCOMPtr&lt;nsIArray&gt; profiles;</span>
<a href="#l6.413"></a><span id="l6.413">   GetSourceProfiles(getter_AddRefs(profiles));</span>
<a href="#l6.414"></a><span id="l6.414"> </span>
<a href="#l6.415"></a><span id="l6.415">   if (profiles) {</span>
<a href="#l6.416"></a><span id="l6.416">     uint32_t count;</span>
<a href="#l6.417"></a><span id="l6.417">     profiles-&gt;GetLength(&amp;count);</span>
<a href="#l6.418"></a><span id="l6.418">     *aResult = count &gt; 0;</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-  }</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-  else</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+  } else</span>
<a href="#l6.422"></a><span id="l6.422">     *aResult = false;</span>
<a href="#l6.423"></a><span id="l6.423"> </span>
<a href="#l6.424"></a><span id="l6.424">   return NS_OK;</span>
<a href="#l6.425"></a><span id="l6.425"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/migration/src/nsNetscapeProfileMigratorBase.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/migration/src/nsNetscapeProfileMigratorBase.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -13,89 +13,95 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsITimer.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIMailProfileMigrator.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> class nsIPrefBranch;</span>
<a href="#l7.9"></a><span id="l7.9"> class nsIMutableArray;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> struct fileTransactionEntry {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; srcFile;  // the src path including leaf name</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; destFile; // the destination path</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  nsString newName; // only valid if the file should be renamed after getting copied</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; srcFile;   // the src path including leaf name</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; destFile;  // the destination path</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  nsString</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+      newName;  // only valid if the file should be renamed after getting copied</span>
<a href="#l7.19"></a><span id="l7.19"> };</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> #define F(a) nsNetscapeProfileMigratorBase::a</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-#define MAKEPREFTRANSFORM(pref, newpref, getmethod, setmethod) \</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  { pref, newpref, F(Get##getmethod), F(Set##setmethod), false, { -1 } }</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+#define MAKEPREFTRANSFORM(pref, newpref, getmethod, setmethod)         \</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  {                                                                    \</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+    pref, newpref, F(Get##getmethod), F(Set##setmethod), false, { -1 } \</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  }</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-#define MAKESAMETYPEPREFTRANSFORM(pref, method) \</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  { pref, 0, F(Get##method), F(Set##method), false, { -1 } }</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+#define MAKESAMETYPEPREFTRANSFORM(pref, method)            \</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  {                                                        \</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    pref, 0, F(Get##method), F(Set##method), false, { -1 } \</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  }</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37"> class nsNetscapeProfileMigratorBase : public nsIMailProfileMigrator,</span>
<a href="#l7.38"></a><span id="l7.38">                                       public nsITimerCallback</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40"> {</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-public:</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+ public:</span>
<a href="#l7.43"></a><span id="l7.43">   NS_DECL_ISUPPORTS</span>
<a href="#l7.44"></a><span id="l7.44">   NS_DECL_NSITIMERCALLBACK</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">   nsNetscapeProfileMigratorBase();</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">   NS_IMETHOD GetSourceHasMultipleProfiles(bool* aResult) override;</span>
<a href="#l7.49"></a><span id="l7.49">   NS_IMETHOD GetSourceExists(bool* aResult) override;</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51">   struct PrefTransform;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  typedef nsresult(*prefConverter)(PrefTransform*, nsIPrefBranch*);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  typedef nsresult (*prefConverter)(PrefTransform*, nsIPrefBranch*);</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55">   struct PrefTransform {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    const char*   sourcePrefName;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    const char*   targetPrefName;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    const char* sourcePrefName;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    const char* targetPrefName;</span>
<a href="#l7.60"></a><span id="l7.60">     prefConverter prefGetterFunc;</span>
<a href="#l7.61"></a><span id="l7.61">     prefConverter prefSetterFunc;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    bool          prefHasValue;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+    bool prefHasValue;</span>
<a href="#l7.64"></a><span id="l7.64">     union {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-      int32_t     intValue;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-      bool        boolValue;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-      char*       stringValue;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+      int32_t intValue;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+      bool boolValue;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+      char* stringValue;</span>
<a href="#l7.71"></a><span id="l7.71">     };</span>
<a href="#l7.72"></a><span id="l7.72">   };</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74">   struct PrefBranchStruct {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    char*         prefName;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    int32_t       type;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+    char* prefName;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+    int32_t type;</span>
<a href="#l7.79"></a><span id="l7.79">     union {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-      char*       stringValue;</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-      int32_t     intValue;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-      bool        boolValue;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+      char* stringValue;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+      int32_t intValue;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+      bool boolValue;</span>
<a href="#l7.86"></a><span id="l7.86">     };</span>
<a href="#l7.87"></a><span id="l7.87">   };</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89">   typedef nsTArray&lt;PrefBranchStruct*&gt; PBStructArray;</span>
<a href="#l7.90"></a><span id="l7.90"> </span>
<a href="#l7.91"></a><span id="l7.91">   static nsresult GetString(PrefTransform* aTransform, nsIPrefBranch* aBranch);</span>
<a href="#l7.92"></a><span id="l7.92">   static nsresult SetString(PrefTransform* aTransform, nsIPrefBranch* aBranch);</span>
<a href="#l7.93"></a><span id="l7.93">   static nsresult GetBool(PrefTransform* aTransform, nsIPrefBranch* aBranch);</span>
<a href="#l7.94"></a><span id="l7.94">   static nsresult SetBool(PrefTransform* aTransform, nsIPrefBranch* aBranch);</span>
<a href="#l7.95"></a><span id="l7.95">   static nsresult GetInt(PrefTransform* aTransform, nsIPrefBranch* aBranch);</span>
<a href="#l7.96"></a><span id="l7.96">   static nsresult SetInt(PrefTransform* aTransform, nsIPrefBranch* aBranch);</span>
<a href="#l7.97"></a><span id="l7.97"> </span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-  nsresult RecursiveCopy(nsIFile* srcDir, nsIFile* destDir); // helper routine</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+  nsresult RecursiveCopy(nsIFile* srcDir, nsIFile* destDir);  // helper routine</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-protected:</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+ protected:</span>
<a href="#l7.103"></a><span id="l7.103">   virtual ~nsNetscapeProfileMigratorBase() {}</span>
<a href="#l7.104"></a><span id="l7.104">   void CopyNextFolder();</span>
<a href="#l7.105"></a><span id="l7.105">   void EndCopyFolders();</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107">   nsresult GetProfileDataFromProfilesIni(nsIFile* aDataDir,</span>
<a href="#l7.108"></a><span id="l7.108">                                          nsIMutableArray* aProfileNames,</span>
<a href="#l7.109"></a><span id="l7.109">                                          nsIMutableArray* aProfileLocations);</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-  nsresult CopyFile(const nsAString&amp; aSourceFileName, const nsAString&amp; aTargetFileName);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  nsresult CopyFile(const nsAString&amp; aSourceFileName,</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+                    const nsAString&amp; aTargetFileName);</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115">   nsresult GetSignonFileName(bool aReplace, nsACString&amp; aFileName);</span>
<a href="#l7.116"></a><span id="l7.116">   nsresult LocateSignonsFile(nsACString&amp; aResult);</span>
<a href="#l7.117"></a><span id="l7.117"> </span>
<a href="#l7.118"></a><span id="l7.118">   nsCOMPtr&lt;nsIFile&gt; mSourceProfile;</span>
<a href="#l7.119"></a><span id="l7.119">   nsCOMPtr&lt;nsIFile&gt; mTargetProfile;</span>
<a href="#l7.120"></a><span id="l7.120"> </span>
<a href="#l7.121"></a><span id="l7.121">   // List of src/destination files we still have to copy into the new profile</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/migration/src/nsOutlookProfileMigrator.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/migration/src/nsOutlookProfileMigrator.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -6,125 +6,116 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsMailProfileMigratorUtils.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsOutlookProfileMigrator.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsIProfileMigrator.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIImportSettings.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-NS_IMPL_ISUPPORTS(nsOutlookProfileMigrator, nsIMailProfileMigrator, nsITimerCallback)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+NS_IMPL_ISUPPORTS(nsOutlookProfileMigrator, nsIMailProfileMigrator,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+                  nsITimerCallback)</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-nsOutlookProfileMigrator::nsOutlookProfileMigrator()</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-{</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+nsOutlookProfileMigrator::nsOutlookProfileMigrator() {</span>
<a href="#l8.20"></a><span id="l8.20">   mProcessingMailFolders = false;</span>
<a href="#l8.21"></a><span id="l8.21">   // get the import service</span>
<a href="#l8.22"></a><span id="l8.22">   mImportModule = do_CreateInstance(&quot;@mozilla.org/import/import-outlook;1&quot;);</span>
<a href="#l8.23"></a><span id="l8.23"> }</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-nsOutlookProfileMigrator::~nsOutlookProfileMigrator()</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-{</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-}</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+nsOutlookProfileMigrator::~nsOutlookProfileMigrator() {}</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-nsresult nsOutlookProfileMigrator::ContinueImport()</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-{</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  return Notify(nullptr);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-}</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+nsresult nsOutlookProfileMigrator::ContinueImport() { return Notify(nullptr); }</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.37"></a><span id="l8.37"> // nsITimerCallback</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39"> NS_IMETHODIMP</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-nsOutlookProfileMigrator::Notify(nsITimer *timer)</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-{</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+nsOutlookProfileMigrator::Notify(nsITimer* timer) {</span>
<a href="#l8.43"></a><span id="l8.43">   int32_t progress;</span>
<a href="#l8.44"></a><span id="l8.44">   mGenericImporter-&gt;GetProgress(&amp;progress);</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46">   nsAutoString index;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  index.AppendInt( progress );</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  index.AppendInt(progress);</span>
<a href="#l8.49"></a><span id="l8.49">   NOTIFY_OBSERVERS(MIGRATION_PROGRESS, index.get());</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  if (progress == 100) // are we done yet?</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  if (progress == 100)  // are we done yet?</span>
<a href="#l8.53"></a><span id="l8.53">   {</span>
<a href="#l8.54"></a><span id="l8.54">     if (mProcessingMailFolders)</span>
<a href="#l8.55"></a><span id="l8.55">       return FinishCopyingMailFolders();</span>
<a href="#l8.56"></a><span id="l8.56">     else</span>
<a href="#l8.57"></a><span id="l8.57">       return FinishCopyingAddressBookData();</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-  }</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-  else</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-  {</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  } else {</span>
<a href="#l8.62"></a><span id="l8.62">     // fire a timer to handle the next one.</span>
<a href="#l8.63"></a><span id="l8.63">     mFileIOTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l8.64"></a><span id="l8.64">     if (mFileIOTimer)</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-      mFileIOTimer-&gt;InitWithCallback(static_cast&lt;nsITimerCallback *&gt;(this), 100, nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+      mFileIOTimer-&gt;InitWithCallback(static_cast&lt;nsITimerCallback*&gt;(this), 100,</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+                                     nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l8.68"></a><span id="l8.68">   }</span>
<a href="#l8.69"></a><span id="l8.69">   return NS_OK;</span>
<a href="#l8.70"></a><span id="l8.70"> }</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.73"></a><span id="l8.73"> // nsIMailProfileMigrator</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75"> NS_IMETHODIMP</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-nsOutlookProfileMigrator::Migrate(uint16_t aItems, nsIProfileStartup* aStartup, const char16_t* aProfile)</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-{</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+nsOutlookProfileMigrator::Migrate(uint16_t aItems, nsIProfileStartup* aStartup,</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+                                  const char16_t* aProfile) {</span>
<a href="#l8.80"></a><span id="l8.80">   nsresult rv = NS_OK;</span>
<a href="#l8.81"></a><span id="l8.81"> </span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-  if (aStartup)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  if (aStartup) {</span>
<a href="#l8.85"></a><span id="l8.85">     rv = aStartup-&gt;DoStartup();</span>
<a href="#l8.86"></a><span id="l8.86">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.87"></a><span id="l8.87">   }</span>
<a href="#l8.88"></a><span id="l8.88"> </span>
<a href="#l8.89"></a><span id="l8.89">   NOTIFY_OBSERVERS(MIGRATION_STARTED, nullptr);</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91">   rv = ImportSettings(mImportModule);</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93">   // now import address books</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-  // this routine will asynchronously import address book data and it will then kick off</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-  // the final migration step, copying the mail folders over.</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+  // this routine will asynchronously import address book data and it will then</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  // kick off the final migration step, copying the mail folders over.</span>
<a href="#l8.98"></a><span id="l8.98">   rv = ImportAddressBook(mImportModule);</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-  // don't broadcast an on end migration here. We aren't done until our asynch import process says we are done.</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  // don't broadcast an on end migration here. We aren't done until our asynch</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  // import process says we are done.</span>
<a href="#l8.103"></a><span id="l8.103">   return rv;</span>
<a href="#l8.104"></a><span id="l8.104"> }</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106"> NS_IMETHODIMP</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-nsOutlookProfileMigrator::GetMigrateData(const char16_t* aProfile, bool aReplace, uint16_t* aResult)</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-{</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+nsOutlookProfileMigrator::GetMigrateData(const char16_t* aProfile,</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+                                         bool aReplace, uint16_t* aResult) {</span>
<a href="#l8.111"></a><span id="l8.111">   // There's no harm in assuming everything is available.</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-  *aResult = nsIMailProfileMigrator::ACCOUNT_SETTINGS | nsIMailProfileMigrator::ADDRESSBOOK_DATA |</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  *aResult = nsIMailProfileMigrator::ACCOUNT_SETTINGS |</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+             nsIMailProfileMigrator::ADDRESSBOOK_DATA |</span>
<a href="#l8.115"></a><span id="l8.115">              nsIMailProfileMigrator::MAILDATA;</span>
<a href="#l8.116"></a><span id="l8.116">   return NS_OK;</span>
<a href="#l8.117"></a><span id="l8.117"> }</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119"> NS_IMETHODIMP</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-nsOutlookProfileMigrator::GetSourceExists(bool* aResult)</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-{</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+nsOutlookProfileMigrator::GetSourceExists(bool* aResult) {</span>
<a href="#l8.123"></a><span id="l8.123">   *aResult = false;</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  mImportModule-&gt;GetImportInterface(NS_IMPORT_SETTINGS_STR, getter_AddRefs(supports));</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  mImportModule-&gt;GetImportInterface(NS_IMPORT_SETTINGS_STR,</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+                                    getter_AddRefs(supports));</span>
<a href="#l8.129"></a><span id="l8.129">   nsCOMPtr&lt;nsIImportSettings&gt; importSettings = do_QueryInterface(supports);</span>
<a href="#l8.130"></a><span id="l8.130"> </span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-  if (importSettings)</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-  {</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+  if (importSettings) {</span>
<a href="#l8.134"></a><span id="l8.134">     nsString description;</span>
<a href="#l8.135"></a><span id="l8.135">     nsCOMPtr&lt;nsIFile&gt; location;</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-    importSettings-&gt;AutoLocate(getter_Copies(description), getter_AddRefs(location), aResult);</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+    importSettings-&gt;AutoLocate(getter_Copies(description),</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+                               getter_AddRefs(location), aResult);</span>
<a href="#l8.139"></a><span id="l8.139">   }</span>
<a href="#l8.140"></a><span id="l8.140"> </span>
<a href="#l8.141"></a><span id="l8.141">   return NS_OK;</span>
<a href="#l8.142"></a><span id="l8.142"> }</span>
<a href="#l8.143"></a><span id="l8.143"> </span>
<a href="#l8.144"></a><span id="l8.144"> NS_IMETHODIMP</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-nsOutlookProfileMigrator::GetSourceHasMultipleProfiles(bool* aResult)</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-{</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+nsOutlookProfileMigrator::GetSourceHasMultipleProfiles(bool* aResult) {</span>
<a href="#l8.148"></a><span id="l8.148">   *aResult = false;</span>
<a href="#l8.149"></a><span id="l8.149">   return NS_OK;</span>
<a href="#l8.150"></a><span id="l8.150"> }</span>
<a href="#l8.151"></a><span id="l8.151"> </span>
<a href="#l8.152"></a><span id="l8.152"> NS_IMETHODIMP</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-nsOutlookProfileMigrator::GetSourceProfiles(nsIArray** aResult)</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-{</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+nsOutlookProfileMigrator::GetSourceProfiles(nsIArray** aResult) {</span>
<a href="#l8.156"></a><span id="l8.156">   *aResult = nullptr;</span>
<a href="#l8.157"></a><span id="l8.157">   return NS_OK;</span>
<a href="#l8.158"></a><span id="l8.158"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/migration/src/nsOutlookProfileMigrator.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/migration/src/nsOutlookProfileMigrator.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -7,23 +7,22 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #define outlookprofilemigrator___h___</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIMailProfileMigrator.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsITimer.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsProfileMigratorBase.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> class nsOutlookProfileMigrator : public nsIMailProfileMigrator,</span>
<a href="#l9.11"></a><span id="l9.11">                                  public nsITimerCallback,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                                 public nsProfileMigratorBase</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-public:</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+                                 public nsProfileMigratorBase {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ public:</span>
<a href="#l9.17"></a><span id="l9.17">   NS_DECL_NSIMAILPROFILEMIGRATOR</span>
<a href="#l9.18"></a><span id="l9.18">   NS_DECL_ISUPPORTS</span>
<a href="#l9.19"></a><span id="l9.19">   NS_DECL_NSITIMERCALLBACK</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   nsOutlookProfileMigrator();</span>
<a href="#l9.22"></a><span id="l9.22">   virtual nsresult ContinueImport();</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-private:</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+ private:</span>
<a href="#l9.26"></a><span id="l9.26">   virtual ~nsOutlookProfileMigrator();</span>
<a href="#l9.27"></a><span id="l9.27"> };</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/migration/src/nsProfileMigrator.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/migration/src/nsProfileMigrator.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -16,120 +16,109 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIProperties.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsProfileMigrator.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsMailMigrationCID.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> #ifdef XP_WIN</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#  include &lt;windows.h&gt;</span>
<a href="#l10.14"></a><span id="l10.14"> #else</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-#include &lt;limits.h&gt;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+#  include &lt;limits.h&gt;</span>
<a href="#l10.17"></a><span id="l10.17"> #endif</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> NS_IMPL_ISUPPORTS(nsProfileMigrator, nsIProfileMigrator)</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-#define MIGRATION_WIZARD_FE_URL &quot;chrome://messenger/content/migration/migration.xul&quot;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+#define MIGRATION_WIZARD_FE_URL \</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  &quot;chrome://messenger/content/migration/migration.xul&quot;</span>
<a href="#l10.24"></a><span id="l10.24"> #define MIGRATION_WIZARD_FE_FEATURES &quot;chrome,dialog,modal,centerscreen&quot;</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> NS_IMETHODIMP</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-nsProfileMigrator::Migrate(nsIProfileStartup* aStartup, const nsACString&amp; aKey, const nsACString&amp; aProfileName)</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-{</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+nsProfileMigrator::Migrate(nsIProfileStartup* aStartup, const nsACString&amp; aKey,</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+                           const nsACString&amp; aProfileName) {</span>
<a href="#l10.31"></a><span id="l10.31">   nsAutoCString key;</span>
<a href="#l10.32"></a><span id="l10.32">   nsCOMPtr&lt;nsIMailProfileMigrator&gt; mailMigrator;</span>
<a href="#l10.33"></a><span id="l10.33">   nsresult rv = GetDefaultMailMigratorKey(key, mailMigrator);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv); // abort migration if we failed to get a mailMigrator (if we were supposed to)</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);  // abort migration if we failed to get a</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+                              // mailMigrator (if we were supposed to)</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  nsCOMPtr&lt;nsISupportsCString&gt; cstr (do_CreateInstance(&quot;@mozilla.org/supports-cstring;1&quot;));</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+  nsCOMPtr&lt;nsISupportsCString&gt; cstr(</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/supports-cstring;1&quot;));</span>
<a href="#l10.41"></a><span id="l10.41">   NS_ENSURE_TRUE(cstr, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l10.42"></a><span id="l10.42">   cstr-&gt;SetData(key);</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-  // By opening the Migration FE with a supplied mailMigrator, it will automatically</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  // migrate from it.</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  nsCOMPtr&lt;nsIWindowWatcher&gt; ww (do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; params (do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  // By opening the Migration FE with a supplied mailMigrator, it will</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  // automatically migrate from it.</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  nsCOMPtr&lt;nsIWindowWatcher&gt; ww(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; params(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l10.52"></a><span id="l10.52">   if (!ww || !params) return NS_ERROR_FAILURE;</span>
<a href="#l10.53"></a><span id="l10.53"> </span>
<a href="#l10.54"></a><span id="l10.54">   params-&gt;AppendElement(cstr);</span>
<a href="#l10.55"></a><span id="l10.55">   params-&gt;AppendElement(mailMigrator);</span>
<a href="#l10.56"></a><span id="l10.56">   params-&gt;AppendElement(aStartup);</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; migrateWizard;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  return ww-&gt;OpenWindow(nullptr,</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-                        MIGRATION_WIZARD_FE_URL,</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-                        &quot;_blank&quot;,</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-                        MIGRATION_WIZARD_FE_FEATURES,</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-                        params,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+  return ww-&gt;OpenWindow(nullptr, MIGRATION_WIZARD_FE_URL, &quot;_blank&quot;,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+                        MIGRATION_WIZARD_FE_FEATURES, params,</span>
<a href="#l10.66"></a><span id="l10.66">                         getter_AddRefs(migrateWizard));</span>
<a href="#l10.67"></a><span id="l10.67"> }</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69"> #ifdef XP_WIN</span>
<a href="#l10.70"></a><span id="l10.70"> typedef struct {</span>
<a href="#l10.71"></a><span id="l10.71">   WORD wLanguage;</span>
<a href="#l10.72"></a><span id="l10.72">   WORD wCodePage;</span>
<a href="#l10.73"></a><span id="l10.73"> } LANGANDCODEPAGE;</span>
<a href="#l10.74"></a><span id="l10.74"> </span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-#define INTERNAL_NAME_THUNDERBIRD     &quot;Thunderbird&quot;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-#define INTERNAL_NAME_SEAMONKEY       &quot;Mozilla&quot;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+#  define INTERNAL_NAME_THUNDERBIRD &quot;Thunderbird&quot;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+#  define INTERNAL_NAME_SEAMONKEY &quot;Mozilla&quot;</span>
<a href="#l10.79"></a><span id="l10.79"> #endif</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-nsresult</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-nsProfileMigrator::GetDefaultMailMigratorKey(nsACString&amp; aKey, nsCOMPtr&lt;nsIMailProfileMigrator&gt;&amp; mailMigrator)</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-{</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  // look up the value of profile.force.migration in case we are supposed to force migration using a particular</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-  // migrator....</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+nsresult nsProfileMigrator::GetDefaultMailMigratorKey(</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+    nsACString&amp; aKey, nsCOMPtr&lt;nsIMailProfileMigrator&gt;&amp; mailMigrator) {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  // look up the value of profile.force.migration in case we are supposed to</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+  // force migration using a particular migrator....</span>
<a href="#l10.90"></a><span id="l10.90">   nsresult rv = NS_OK;</span>
<a href="#l10.91"></a><span id="l10.91">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l10.92"></a><span id="l10.92">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94">   nsCString forceMigrationType;</span>
<a href="#l10.95"></a><span id="l10.95">   prefs-&gt;GetCharPref(&quot;profile.force.migration&quot;, forceMigrationType);</span>
<a href="#l10.96"></a><span id="l10.96"> </span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-  // if we are being forced to migrate to a particular migration type, then create an instance of that migrator</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-  // and return it.</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+  // if we are being forced to migrate to a particular migration type, then</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+  // create an instance of that migrator and return it.</span>
<a href="#l10.101"></a><span id="l10.101">   NS_NAMED_LITERAL_CSTRING(migratorPrefix,</span>
<a href="#l10.102"></a><span id="l10.102">                            NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX);</span>
<a href="#l10.103"></a><span id="l10.103">   nsAutoCString migratorID;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-  if (!forceMigrationType.IsEmpty())</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-  {</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+  if (!forceMigrationType.IsEmpty()) {</span>
<a href="#l10.107"></a><span id="l10.107">     bool exists = false;</span>
<a href="#l10.108"></a><span id="l10.108">     migratorID = migratorPrefix;</span>
<a href="#l10.109"></a><span id="l10.109">     migratorID.Append(forceMigrationType);</span>
<a href="#l10.110"></a><span id="l10.110">     mailMigrator = do_CreateInstance(migratorID.get());</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-    if (!mailMigrator)</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-      return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+    if (!mailMigrator) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.114"></a><span id="l10.114"> </span>
<a href="#l10.115"></a><span id="l10.115">     mailMigrator-&gt;GetSourceExists(&amp;exists);</span>
<a href="#l10.116"></a><span id="l10.116">     /* trying to force migration on a source which doesn't</span>
<a href="#l10.117"></a><span id="l10.117">      * have any profiles.</span>
<a href="#l10.118"></a><span id="l10.118">      */</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-    if (!exists)</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-      return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+    if (!exists) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.122"></a><span id="l10.122">     aKey = forceMigrationType;</span>
<a href="#l10.123"></a><span id="l10.123">     return NS_OK;</span>
<a href="#l10.124"></a><span id="l10.124">   }</span>
<a href="#l10.125"></a><span id="l10.125"> </span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-  #define MAX_SOURCE_LENGTH 10</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-  const char sources[][MAX_SOURCE_LENGTH] = {</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-    &quot;seamonkey&quot;,</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-    &quot;outlook&quot;,</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-    &quot;&quot;</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-  };</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-  for (uint32_t i = 0; sources[i][0]; ++i)</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-  {</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+#define MAX_SOURCE_LENGTH 10</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+  const char sources[][MAX_SOURCE_LENGTH] = {&quot;seamonkey&quot;, &quot;outlook&quot;, &quot;&quot;};</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  for (uint32_t i = 0; sources[i][0]; ++i) {</span>
<a href="#l10.137"></a><span id="l10.137">     migratorID = migratorPrefix;</span>
<a href="#l10.138"></a><span id="l10.138">     migratorID.Append(sources[i]);</span>
<a href="#l10.139"></a><span id="l10.139">     mailMigrator = do_CreateInstance(migratorID.get());</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-    if (!mailMigrator)</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-      continue;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+    if (!mailMigrator) continue;</span>
<a href="#l10.143"></a><span id="l10.143"> </span>
<a href="#l10.144"></a><span id="l10.144">     bool exists = false;</span>
<a href="#l10.145"></a><span id="l10.145">     mailMigrator-&gt;GetSourceExists(&amp;exists);</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-    if (exists)</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-    {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+    if (exists) {</span>
<a href="#l10.149"></a><span id="l10.149">       mailMigrator = nullptr;</span>
<a href="#l10.150"></a><span id="l10.150">       return NS_OK;</span>
<a href="#l10.151"></a><span id="l10.151">     }</span>
<a href="#l10.152"></a><span id="l10.152">   }</span>
<a href="#l10.153"></a><span id="l10.153"> </span>
<a href="#l10.154"></a><span id="l10.154">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.155"></a><span id="l10.155"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/migration/src/nsProfileMigrator.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/migration/src/nsProfileMigrator.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -9,24 +9,28 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsIToolkitProfile.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIToolkitProfileService.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsString.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#define NS_THUNDERBIRD_PROFILEIMPORT_CID \</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-{ 0xb3c78baf, 0x3a52, 0x41d2, { 0x97, 0x18, 0xc3, 0x19, 0xbe, 0xf9, 0xaf, 0xfc } }</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+#define NS_THUNDERBIRD_PROFILEIMPORT_CID             \</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  {                                                  \</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+    0xb3c78baf, 0x3a52, 0x41d2, {                    \</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+      0x97, 0x18, 0xc3, 0x19, 0xbe, 0xf9, 0xaf, 0xfc \</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+    }                                                \</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+  }</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-class nsProfileMigrator final : public nsIProfileMigrator</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-{</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-public:</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+class nsProfileMigrator final : public nsIProfileMigrator {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ public:</span>
<a href="#l11.26"></a><span id="l11.26">   NS_DECL_NSIPROFILEMIGRATOR</span>
<a href="#l11.27"></a><span id="l11.27">   NS_DECL_ISUPPORTS</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  nsProfileMigrator() { };</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+  nsProfileMigrator(){};</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-protected:</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  ~nsProfileMigrator() { };</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ protected:</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  ~nsProfileMigrator(){};</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-  nsresult GetDefaultMailMigratorKey(nsACString&amp; key, nsCOMPtr&lt;nsIMailProfileMigrator&gt;&amp; mailMigrator);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+  nsresult GetDefaultMailMigratorKey(</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+      nsACString&amp; key, nsCOMPtr&lt;nsIMailProfileMigrator&gt;&amp; mailMigrator);</span>
<a href="#l11.40"></a><span id="l11.40"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/components/migration/src/nsProfileMigratorBase.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/components/migration/src/nsProfileMigratorBase.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -10,119 +10,120 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsIImportSettings.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIImportFilters.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> #define kPersonalAddressbookUri &quot;moz-abmdbdirectory://abook.mab&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-nsProfileMigratorBase::nsProfileMigratorBase()</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+nsProfileMigratorBase::nsProfileMigratorBase() {</span>
<a href="#l12.15"></a><span id="l12.15">   mObserverService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;);</span>
<a href="#l12.16"></a><span id="l12.16">   mProcessingMailFolders = false;</span>
<a href="#l12.17"></a><span id="l12.17"> }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-nsProfileMigratorBase::~nsProfileMigratorBase()</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-{</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-  if (mFileIOTimer)</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-    mFileIOTimer-&gt;Cancel();</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+nsProfileMigratorBase::~nsProfileMigratorBase() {</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+  if (mFileIOTimer) mFileIOTimer-&gt;Cancel();</span>
<a href="#l12.25"></a><span id="l12.25"> }</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-nsresult nsProfileMigratorBase::ImportSettings(nsIImportModule * aImportModule)</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-{</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+nsresult nsProfileMigratorBase::ImportSettings(nsIImportModule* aImportModule) {</span>
<a href="#l12.30"></a><span id="l12.30">   nsresult rv;</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32">   nsAutoString index;</span>
<a href="#l12.33"></a><span id="l12.33">   index.AppendInt(nsIMailProfileMigrator::ACCOUNT_SETTINGS);</span>
<a href="#l12.34"></a><span id="l12.34">   NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get());</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  rv = aImportModule-&gt;GetImportInterface(NS_IMPORT_SETTINGS_STR, getter_AddRefs(supports));</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  rv = aImportModule-&gt;GetImportInterface(NS_IMPORT_SETTINGS_STR,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+                                         getter_AddRefs(supports));</span>
<a href="#l12.40"></a><span id="l12.40">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42">   nsCOMPtr&lt;nsIImportSettings&gt; importSettings = do_QueryInterface(supports);</span>
<a href="#l12.43"></a><span id="l12.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">   bool importedSettings = false;</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-  rv = importSettings-&gt;Import(getter_AddRefs(mLocalFolderAccount), &amp;importedSettings);</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  rv = importSettings-&gt;Import(getter_AddRefs(mLocalFolderAccount),</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+                              &amp;importedSettings);</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">   NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get());</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53">   return rv;</span>
<a href="#l12.54"></a><span id="l12.54"> }</span>
<a href="#l12.55"></a><span id="l12.55"> </span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-nsresult nsProfileMigratorBase::ImportAddressBook(nsIImportModule * aImportModule)</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-{</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+nsresult nsProfileMigratorBase::ImportAddressBook(</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+    nsIImportModule* aImportModule) {</span>
<a href="#l12.60"></a><span id="l12.60">   nsresult rv;</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62">   nsAutoString index;</span>
<a href="#l12.63"></a><span id="l12.63">   index.AppendInt(nsIMailProfileMigrator::ADDRESSBOOK_DATA);</span>
<a href="#l12.64"></a><span id="l12.64">   NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get());</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-  rv = aImportModule-&gt;GetImportInterface(NS_IMPORT_ADDRESS_STR, getter_AddRefs(supports));</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+  rv = aImportModule-&gt;GetImportInterface(NS_IMPORT_ADDRESS_STR,</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+                                         getter_AddRefs(supports));</span>
<a href="#l12.70"></a><span id="l12.70">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.71"></a><span id="l12.71"> </span>
<a href="#l12.72"></a><span id="l12.72">   mGenericImporter = do_QueryInterface(supports);</span>
<a href="#l12.73"></a><span id="l12.73">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-  nsCOMPtr&lt;nsISupportsCString&gt; pabString = do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID, &amp;rv);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+  nsCOMPtr&lt;nsISupportsCString&gt; pabString =</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+      do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID, &amp;rv);</span>
<a href="#l12.78"></a><span id="l12.78">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.79"></a><span id="l12.79"> </span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-  // we want to migrate the outlook express addressbook into our personal address book</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  // we want to migrate the outlook express addressbook into our personal</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+  // address book</span>
<a href="#l12.83"></a><span id="l12.83">   pabString-&gt;SetData(nsDependentCString(kPersonalAddressbookUri));</span>
<a href="#l12.84"></a><span id="l12.84">   mGenericImporter-&gt;SetData(&quot;addressDestination&quot;, pabString);</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86">   bool importResult;</span>
<a href="#l12.87"></a><span id="l12.87">   bool wantsProgress;</span>
<a href="#l12.88"></a><span id="l12.88">   mGenericImporter-&gt;WantsProgress(&amp;wantsProgress);</span>
<a href="#l12.89"></a><span id="l12.89">   rv = mGenericImporter-&gt;BeginImport(nullptr, nullptr, &amp;importResult);</span>
<a href="#l12.90"></a><span id="l12.90"> </span>
<a href="#l12.91"></a><span id="l12.91">   if (wantsProgress)</span>
<a href="#l12.92"></a><span id="l12.92">     ContinueImport();</span>
<a href="#l12.93"></a><span id="l12.93">   else</span>
<a href="#l12.94"></a><span id="l12.94">     FinishCopyingAddressBookData();</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">   return rv;</span>
<a href="#l12.97"></a><span id="l12.97"> }</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-nsresult nsProfileMigratorBase::FinishCopyingAddressBookData()</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-{</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+nsresult nsProfileMigratorBase::FinishCopyingAddressBookData() {</span>
<a href="#l12.102"></a><span id="l12.102">   nsAutoString index;</span>
<a href="#l12.103"></a><span id="l12.103">   index.AppendInt(nsIMailProfileMigrator::ADDRESSBOOK_DATA);</span>
<a href="#l12.104"></a><span id="l12.104">   NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get());</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106">   // now kick off the mail migration code</span>
<a href="#l12.107"></a><span id="l12.107">   ImportMailData(mImportModule);</span>
<a href="#l12.108"></a><span id="l12.108"> </span>
<a href="#l12.109"></a><span id="l12.109">   return NS_OK;</span>
<a href="#l12.110"></a><span id="l12.110"> }</span>
<a href="#l12.111"></a><span id="l12.111"> </span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-nsresult nsProfileMigratorBase::ImportMailData(nsIImportModule * aImportModule)</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-{</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+nsresult nsProfileMigratorBase::ImportMailData(nsIImportModule* aImportModule) {</span>
<a href="#l12.115"></a><span id="l12.115">   nsresult rv;</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117">   nsAutoString index;</span>
<a href="#l12.118"></a><span id="l12.118">   index.AppendInt(nsIMailProfileMigrator::MAILDATA);</span>
<a href="#l12.119"></a><span id="l12.119">   NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get());</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-  rv = aImportModule-&gt;GetImportInterface(NS_IMPORT_MAIL_STR, getter_AddRefs(supports));</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  rv = aImportModule-&gt;GetImportInterface(NS_IMPORT_MAIL_STR,</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+                                         getter_AddRefs(supports));</span>
<a href="#l12.125"></a><span id="l12.125">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.126"></a><span id="l12.126"> </span>
<a href="#l12.127"></a><span id="l12.127">   mGenericImporter = do_QueryInterface(supports);</span>
<a href="#l12.128"></a><span id="l12.128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.129"></a><span id="l12.129"> </span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-  nsCOMPtr&lt;nsISupportsPRBool&gt; migrating = do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv);</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  nsCOMPtr&lt;nsISupportsPRBool&gt; migrating =</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+      do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv);</span>
<a href="#l12.133"></a><span id="l12.133">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.134"></a><span id="l12.134"> </span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-  // by setting the migration flag, we force the import utility to install local folders from OE</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  // directly into Local Folders and not as a subfolder</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+  // by setting the migration flag, we force the import utility to install local</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+  // folders from OE directly into Local Folders and not as a subfolder</span>
<a href="#l12.139"></a><span id="l12.139">   migrating-&gt;SetData(true);</span>
<a href="#l12.140"></a><span id="l12.140">   mGenericImporter-&gt;SetData(&quot;migration&quot;, migrating);</span>
<a href="#l12.141"></a><span id="l12.141"> </span>
<a href="#l12.142"></a><span id="l12.142">   bool importResult;</span>
<a href="#l12.143"></a><span id="l12.143">   bool wantsProgress;</span>
<a href="#l12.144"></a><span id="l12.144">   mGenericImporter-&gt;WantsProgress(&amp;wantsProgress);</span>
<a href="#l12.145"></a><span id="l12.145">   rv = mGenericImporter-&gt;BeginImport(nullptr, nullptr, &amp;importResult);</span>
<a href="#l12.146"></a><span id="l12.146"> </span>
<a href="#l12.147"></a><span id="l12.147" class="difflineat">@@ -131,36 +132,34 @@ nsresult nsProfileMigratorBase::ImportMa</span>
<a href="#l12.148"></a><span id="l12.148">   if (wantsProgress)</span>
<a href="#l12.149"></a><span id="l12.149">     ContinueImport();</span>
<a href="#l12.150"></a><span id="l12.150">   else</span>
<a href="#l12.151"></a><span id="l12.151">     FinishCopyingMailFolders();</span>
<a href="#l12.152"></a><span id="l12.152"> </span>
<a href="#l12.153"></a><span id="l12.153">   return rv;</span>
<a href="#l12.154"></a><span id="l12.154"> }</span>
<a href="#l12.155"></a><span id="l12.155"> </span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-nsresult nsProfileMigratorBase::FinishCopyingMailFolders()</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-{</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+nsresult nsProfileMigratorBase::FinishCopyingMailFolders() {</span>
<a href="#l12.159"></a><span id="l12.159">   nsAutoString index;</span>
<a href="#l12.160"></a><span id="l12.160">   index.AppendInt(nsIMailProfileMigrator::MAILDATA);</span>
<a href="#l12.161"></a><span id="l12.161">   NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get());</span>
<a href="#l12.162"></a><span id="l12.162"> </span>
<a href="#l12.163"></a><span id="l12.163">   // now kick off the filters migration code</span>
<a href="#l12.164"></a><span id="l12.164">   return ImportFilters(mImportModule);</span>
<a href="#l12.165"></a><span id="l12.165"> }</span>
<a href="#l12.166"></a><span id="l12.166"> </span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-nsresult nsProfileMigratorBase::ImportFilters(nsIImportModule * aImportModule)</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-{</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+nsresult nsProfileMigratorBase::ImportFilters(nsIImportModule* aImportModule) {</span>
<a href="#l12.170"></a><span id="l12.170">   nsresult rv = NS_OK;</span>
<a href="#l12.171"></a><span id="l12.171"> </span>
<a href="#l12.172"></a><span id="l12.172">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-  nsresult rv2 = aImportModule-&gt;GetImportInterface(NS_IMPORT_FILTERS_STR, getter_AddRefs(supports));</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+  nsresult rv2 = aImportModule-&gt;GetImportInterface(NS_IMPORT_FILTERS_STR,</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+                                                   getter_AddRefs(supports));</span>
<a href="#l12.176"></a><span id="l12.176">   nsCOMPtr&lt;nsIImportFilters&gt; importFilters = do_QueryInterface(supports);</span>
<a href="#l12.177"></a><span id="l12.177"> </span>
<a href="#l12.178"></a><span id="l12.178" class="difflineminus">-  if (NS_SUCCEEDED(rv2) &amp;&amp; importFilters)</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-  {</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+  if (NS_SUCCEEDED(rv2) &amp;&amp; importFilters) {</span>
<a href="#l12.181"></a><span id="l12.181">     nsAutoString index;</span>
<a href="#l12.182"></a><span id="l12.182">     index.AppendInt(nsIMailProfileMigrator::FILTERS);</span>
<a href="#l12.183"></a><span id="l12.183">     NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get());</span>
<a href="#l12.184"></a><span id="l12.184"> </span>
<a href="#l12.185"></a><span id="l12.185">     bool importedFilters = false;</span>
<a href="#l12.186"></a><span id="l12.186">     char16_t* error;</span>
<a href="#l12.187"></a><span id="l12.187"> </span>
<a href="#l12.188"></a><span id="l12.188">     rv = importFilters-&gt;Import(&amp;error, &amp;importedFilters);</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineat">@@ -168,9 +167,8 @@ nsresult nsProfileMigratorBase::ImportFi</span>
<a href="#l12.190"></a><span id="l12.190">     NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get());</span>
<a href="#l12.191"></a><span id="l12.191">   }</span>
<a href="#l12.192"></a><span id="l12.192"> </span>
<a href="#l12.193"></a><span id="l12.193">   // migration is now done...notify the UI.</span>
<a href="#l12.194"></a><span id="l12.194">   NOTIFY_OBSERVERS(MIGRATION_ENDED, nullptr);</span>
<a href="#l12.195"></a><span id="l12.195"> </span>
<a href="#l12.196"></a><span id="l12.196">   return rv;</span>
<a href="#l12.197"></a><span id="l12.197"> }</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/migration/src/nsProfileMigratorBase.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/migration/src/nsProfileMigratorBase.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -8,32 +8,33 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsIFile.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsITimer.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-class nsProfileMigratorBase</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-public:</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+class nsProfileMigratorBase {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ public:</span>
<a href="#l13.17"></a><span id="l13.17">   nsProfileMigratorBase();</span>
<a href="#l13.18"></a><span id="l13.18">   virtual ~nsProfileMigratorBase();</span>
<a href="#l13.19"></a><span id="l13.19">   virtual nsresult ContinueImport() = 0;</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-protected:</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-  nsresult ImportSettings(nsIImportModule * aImportModule);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  nsresult ImportAddressBook(nsIImportModule * aImportModule);</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-  nsresult ImportMailData(nsIImportModule * aImportModule);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-  nsresult ImportFilters(nsIImportModule * aImportModule);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ protected:</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+  nsresult ImportSettings(nsIImportModule* aImportModule);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  nsresult ImportAddressBook(nsIImportModule* aImportModule);</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  nsresult ImportMailData(nsIImportModule* aImportModule);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  nsresult ImportFilters(nsIImportModule* aImportModule);</span>
<a href="#l13.31"></a><span id="l13.31">   nsresult FinishCopyingAddressBookData();</span>
<a href="#l13.32"></a><span id="l13.32">   nsresult FinishCopyingMailFolders();</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34">   nsCOMPtr&lt;nsIObserverService&gt; mObserverService;</span>
<a href="#l13.35"></a><span id="l13.35">   nsCOMPtr&lt;nsITimer&gt; mFileIOTimer;</span>
<a href="#l13.36"></a><span id="l13.36">   nsCOMPtr&lt;nsIImportGeneric&gt; mGenericImporter;</span>
<a href="#l13.37"></a><span id="l13.37">   nsCOMPtr&lt;nsIImportModule&gt; mImportModule;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt; mLocalFolderAccount; // needed for nsIImportSettings::Import</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-  bool mProcessingMailFolders; // we are either asynchronously parsing address books or mail folders</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+      mLocalFolderAccount;      // needed for nsIImportSettings::Import</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  bool mProcessingMailFolders;  // we are either asynchronously parsing address</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+                                // books or mail folders</span>
<a href="#l13.44"></a><span id="l13.44"> };</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -12,229 +12,215 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsSeamonkeyProfileMigrator.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> // Mail specific folder paths</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#define MAIL_DIR_50_NAME             NS_LITERAL_STRING(&quot;Mail&quot;)</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-#define IMAP_MAIL_DIR_50_NAME        NS_LITERAL_STRING(&quot;ImapMail&quot;)</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-#define NEWS_DIR_50_NAME             NS_LITERAL_STRING(&quot;News&quot;)</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+#define MAIL_DIR_50_NAME NS_LITERAL_STRING(&quot;Mail&quot;)</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+#define IMAP_MAIL_DIR_50_NAME NS_LITERAL_STRING(&quot;ImapMail&quot;)</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+#define NEWS_DIR_50_NAME NS_LITERAL_STRING(&quot;News&quot;)</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.21"></a><span id="l14.21"> // nsSeamonkeyProfileMigrator</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-#define FILE_NAME_JUNKTRAINING    NS_LITERAL_STRING(&quot;training.dat&quot;)</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+#define FILE_NAME_JUNKTRAINING NS_LITERAL_STRING(&quot;training.dat&quot;)</span>
<a href="#l14.24"></a><span id="l14.24"> #define FILE_NAME_PERSONALDICTIONARY NS_LITERAL_STRING(&quot;persdict.dat&quot;)</span>
<a href="#l14.25"></a><span id="l14.25"> #define FILE_NAME_PERSONAL_ADDRESSBOOK NS_LITERAL_STRING(&quot;abook.mab&quot;)</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-#define FILE_NAME_MAILVIEWS       NS_LITERAL_STRING(&quot;mailviews.dat&quot;)</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-#define FILE_NAME_CERT8DB         NS_LITERAL_STRING(&quot;cert8.db&quot;)</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-#define FILE_NAME_KEY3DB          NS_LITERAL_STRING(&quot;key3.db&quot;)</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-#define FILE_NAME_SECMODDB        NS_LITERAL_STRING(&quot;secmod.db&quot;)</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-#define FILE_NAME_PREFS           NS_LITERAL_STRING(&quot;prefs.js&quot;)</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-#define FILE_NAME_USER_PREFS      NS_LITERAL_STRING(&quot;user.js&quot;)</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+#define FILE_NAME_MAILVIEWS NS_LITERAL_STRING(&quot;mailviews.dat&quot;)</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+#define FILE_NAME_CERT8DB NS_LITERAL_STRING(&quot;cert8.db&quot;)</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+#define FILE_NAME_KEY3DB NS_LITERAL_STRING(&quot;key3.db&quot;)</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+#define FILE_NAME_SECMODDB NS_LITERAL_STRING(&quot;secmod.db&quot;)</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+#define FILE_NAME_PREFS NS_LITERAL_STRING(&quot;prefs.js&quot;)</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+#define FILE_NAME_USER_PREFS NS_LITERAL_STRING(&quot;user.js&quot;)</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39"> struct PrefBranchStruct {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  char*         prefName;</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  int32_t       type;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  char* prefName;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  int32_t type;</span>
<a href="#l14.44"></a><span id="l14.44">   union {</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-    char*       stringValue;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-    int32_t     intValue;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-    bool        boolValue;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    char16_t*  wstringValue;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    char* stringValue;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+    int32_t intValue;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+    bool boolValue;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+    char16_t* wstringValue;</span>
<a href="#l14.53"></a><span id="l14.53">   };</span>
<a href="#l14.54"></a><span id="l14.54"> };</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-NS_IMPL_ISUPPORTS(nsSeamonkeyProfileMigrator, nsIMailProfileMigrator, nsITimerCallback)</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+NS_IMPL_ISUPPORTS(nsSeamonkeyProfileMigrator, nsIMailProfileMigrator,</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+                  nsITimerCallback)</span>
<a href="#l14.60"></a><span id="l14.60"> </span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-nsSeamonkeyProfileMigrator::nsSeamonkeyProfileMigrator()</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-{</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-}</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+nsSeamonkeyProfileMigrator::nsSeamonkeyProfileMigrator() {}</span>
<a href="#l14.65"></a><span id="l14.65"> </span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-nsSeamonkeyProfileMigrator::~nsSeamonkeyProfileMigrator()</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-{</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-}</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+nsSeamonkeyProfileMigrator::~nsSeamonkeyProfileMigrator() {}</span>
<a href="#l14.70"></a><span id="l14.70"> </span>
<a href="#l14.71"></a><span id="l14.71"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.72"></a><span id="l14.72"> // nsIMailProfileMigrator</span>
<a href="#l14.73"></a><span id="l14.73"> </span>
<a href="#l14.74"></a><span id="l14.74"> NS_IMETHODIMP</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-nsSeamonkeyProfileMigrator::Migrate(uint16_t aItems, nsIProfileStartup* aStartup, const char16_t* aProfile)</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-{</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+nsSeamonkeyProfileMigrator::Migrate(uint16_t aItems,</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+                                    nsIProfileStartup* aStartup,</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+                                    const char16_t* aProfile) {</span>
<a href="#l14.80"></a><span id="l14.80">   nsresult rv = NS_OK;</span>
<a href="#l14.81"></a><span id="l14.81">   bool aReplace = aStartup ? true : false;</span>
<a href="#l14.82"></a><span id="l14.82"> </span>
<a href="#l14.83"></a><span id="l14.83">   if (!mTargetProfile) {</span>
<a href="#l14.84"></a><span id="l14.84">     GetProfilePath(aStartup, mTargetProfile);</span>
<a href="#l14.85"></a><span id="l14.85">     if (!mTargetProfile) return NS_ERROR_FAILURE;</span>
<a href="#l14.86"></a><span id="l14.86">   }</span>
<a href="#l14.87"></a><span id="l14.87">   if (!mSourceProfile) {</span>
<a href="#l14.88"></a><span id="l14.88">     GetSourceProfile(aProfile);</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-    if (!mSourceProfile)</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+    if (!mSourceProfile) return NS_ERROR_FAILURE;</span>
<a href="#l14.92"></a><span id="l14.92">   }</span>
<a href="#l14.93"></a><span id="l14.93"> </span>
<a href="#l14.94"></a><span id="l14.94">   NOTIFY_OBSERVERS(MIGRATION_STARTED, nullptr);</span>
<a href="#l14.95"></a><span id="l14.95"> </span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-  COPY_DATA(CopyPreferences,  aReplace, nsIMailProfileMigrator::SETTINGS);</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+  COPY_DATA(CopyPreferences, aReplace, nsIMailProfileMigrator::SETTINGS);</span>
<a href="#l14.98"></a><span id="l14.98"> </span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-  // fake notifications for things we've already imported as part of CopyPreferences</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-  COPY_DATA(DummyCopyRoutine, aReplace, nsIMailProfileMigrator::ACCOUNT_SETTINGS);</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+  // fake notifications for things we've already imported as part of</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  // CopyPreferences</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  COPY_DATA(DummyCopyRoutine, aReplace,</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+            nsIMailProfileMigrator::ACCOUNT_SETTINGS);</span>
<a href="#l14.105"></a><span id="l14.105">   COPY_DATA(DummyCopyRoutine, aReplace, nsIMailProfileMigrator::NEWSDATA);</span>
<a href="#l14.106"></a><span id="l14.106"> </span>
<a href="#l14.107"></a><span id="l14.107">   // copy junk mail training file</span>
<a href="#l14.108"></a><span id="l14.108">   COPY_DATA(CopyJunkTraining, aReplace, nsIMailProfileMigrator::JUNKTRAINING);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-  COPY_DATA(CopyPasswords,    aReplace, nsIMailProfileMigrator::PASSWORDS);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+  COPY_DATA(CopyPasswords, aReplace, nsIMailProfileMigrator::PASSWORDS);</span>
<a href="#l14.111"></a><span id="l14.111"> </span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-  // the last thing to do is to actually copy over any mail folders we have marked for copying</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-  // we want to do this last and it will be asynchronous so the UI doesn't freeze up while we perform</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-  // this potentially very long operation.</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  // the last thing to do is to actually copy over any mail folders we have</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  // marked for copying we want to do this last and it will be asynchronous so</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  // the UI doesn't freeze up while we perform this potentially very long</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+  // operation.</span>
<a href="#l14.119"></a><span id="l14.119"> </span>
<a href="#l14.120"></a><span id="l14.120">   nsAutoString index;</span>
<a href="#l14.121"></a><span id="l14.121">   index.AppendInt(nsIMailProfileMigrator::MAILDATA);</span>
<a href="#l14.122"></a><span id="l14.122">   NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get());</span>
<a href="#l14.123"></a><span id="l14.123"> </span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  // Generate the max progress value now that we know all of the files we need to copy</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+  // Generate the max progress value now that we know all of the files we need</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+  // to copy</span>
<a href="#l14.127"></a><span id="l14.127">   uint32_t count = mFileCopyTransactions.Length();</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-  {</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l14.131"></a><span id="l14.131">     fileTransactionEntry fileTransaction = mFileCopyTransactions.ElementAt(i);</span>
<a href="#l14.132"></a><span id="l14.132">     int64_t fileSize;</span>
<a href="#l14.133"></a><span id="l14.133">     fileTransaction.srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l14.134"></a><span id="l14.134">     mMaxProgress += fileSize;</span>
<a href="#l14.135"></a><span id="l14.135">   }</span>
<a href="#l14.136"></a><span id="l14.136"> </span>
<a href="#l14.137"></a><span id="l14.137">   CopyNextFolder();</span>
<a href="#l14.138"></a><span id="l14.138"> </span>
<a href="#l14.139"></a><span id="l14.139">   return rv;</span>
<a href="#l14.140"></a><span id="l14.140"> }</span>
<a href="#l14.141"></a><span id="l14.141"> </span>
<a href="#l14.142"></a><span id="l14.142"> NS_IMETHODIMP</span>
<a href="#l14.143"></a><span id="l14.143"> nsSeamonkeyProfileMigrator::GetMigrateData(const char16_t* aProfile,</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-                                           bool aReplace,</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-                                           uint16_t* aResult)</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-{</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+                                           bool aReplace, uint16_t* aResult) {</span>
<a href="#l14.148"></a><span id="l14.148">   *aResult = 0;</span>
<a href="#l14.149"></a><span id="l14.149"> </span>
<a href="#l14.150"></a><span id="l14.150">   if (!mSourceProfile) {</span>
<a href="#l14.151"></a><span id="l14.151">     GetSourceProfile(aProfile);</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-    if (!mSourceProfile)</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-      return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+    if (!mSourceProfile) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l14.155"></a><span id="l14.155">   }</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-  MigrationData data[] = { { ToNewUnicode(FILE_NAME_PREFS),</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-                             nsIMailProfileMigrator::SETTINGS,</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-                             true },</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-                           { ToNewUnicode(FILE_NAME_JUNKTRAINING),</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-                             nsIMailProfileMigrator::JUNKTRAINING,</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-                             true },</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-                          };</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+  MigrationData data[] = {</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+      {ToNewUnicode(FILE_NAME_PREFS), nsIMailProfileMigrator::SETTINGS, true},</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+      {ToNewUnicode(FILE_NAME_JUNKTRAINING),</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+       nsIMailProfileMigrator::JUNKTRAINING, true},</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+  };</span>
<a href="#l14.169"></a><span id="l14.169"> </span>
<a href="#l14.170"></a><span id="l14.170">   // Frees file name strings allocated above.</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-  GetMigrateDataFromArray(data, sizeof(data)/sizeof(MigrationData),</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-                          aReplace, mSourceProfile, aResult);</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+  GetMigrateDataFromArray(data, sizeof(data) / sizeof(MigrationData), aReplace,</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+                          mSourceProfile, aResult);</span>
<a href="#l14.175"></a><span id="l14.175"> </span>
<a href="#l14.176"></a><span id="l14.176">   // Now locate passwords</span>
<a href="#l14.177"></a><span id="l14.177">   nsCString signonsFileName;</span>
<a href="#l14.178"></a><span id="l14.178">   GetSignonFileName(aReplace, signonsFileName);</span>
<a href="#l14.179"></a><span id="l14.179"> </span>
<a href="#l14.180"></a><span id="l14.180">   if (!signonsFileName.IsEmpty()) {</span>
<a href="#l14.181"></a><span id="l14.181">     nsAutoString fileName;</span>
<a href="#l14.182"></a><span id="l14.182">     CopyASCIItoUTF16(signonsFileName, fileName);</span>
<a href="#l14.183"></a><span id="l14.183">     nsCOMPtr&lt;nsIFile&gt; sourcePasswordsFile;</span>
<a href="#l14.184"></a><span id="l14.184">     mSourceProfile-&gt;Clone(getter_AddRefs(sourcePasswordsFile));</span>
<a href="#l14.185"></a><span id="l14.185">     sourcePasswordsFile-&gt;Append(fileName);</span>
<a href="#l14.186"></a><span id="l14.186"> </span>
<a href="#l14.187"></a><span id="l14.187">     bool exists;</span>
<a href="#l14.188"></a><span id="l14.188">     sourcePasswordsFile-&gt;Exists(&amp;exists);</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-    if (exists)</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-      *aResult |= nsIMailProfileMigrator::PASSWORDS;</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+    if (exists) *aResult |= nsIMailProfileMigrator::PASSWORDS;</span>
<a href="#l14.192"></a><span id="l14.192">   }</span>
<a href="#l14.193"></a><span id="l14.193"> </span>
<a href="#l14.194"></a><span id="l14.194">   // add some extra migration fields for things we also migrate</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-  *aResult |= nsIMailProfileMigrator::ACCOUNT_SETTINGS</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-           | nsIMailProfileMigrator::MAILDATA</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-           | nsIMailProfileMigrator::NEWSDATA</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-           | nsIMailProfileMigrator::ADDRESSBOOK_DATA;</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+  *aResult |= nsIMailProfileMigrator::ACCOUNT_SETTINGS |</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+              nsIMailProfileMigrator::MAILDATA |</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+              nsIMailProfileMigrator::NEWSDATA |</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+              nsIMailProfileMigrator::ADDRESSBOOK_DATA;</span>
<a href="#l14.203"></a><span id="l14.203"> </span>
<a href="#l14.204"></a><span id="l14.204">   return NS_OK;</span>
<a href="#l14.205"></a><span id="l14.205"> }</span>
<a href="#l14.206"></a><span id="l14.206"> </span>
<a href="#l14.207"></a><span id="l14.207"> NS_IMETHODIMP</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-nsSeamonkeyProfileMigrator::GetSourceProfiles(nsIArray** aResult)</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-{</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+nsSeamonkeyProfileMigrator::GetSourceProfiles(nsIArray** aResult) {</span>
<a href="#l14.211"></a><span id="l14.211">   if (!mProfileNames &amp;&amp; !mProfileLocations) {</span>
<a href="#l14.212"></a><span id="l14.212">     nsresult rv;</span>
<a href="#l14.213"></a><span id="l14.213">     mProfileNames = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-      return rv;</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l14.217"></a><span id="l14.217"> </span>
<a href="#l14.218"></a><span id="l14.218">     mProfileLocations = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-      return rv;</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l14.222"></a><span id="l14.222"> </span>
<a href="#l14.223"></a><span id="l14.223">     // Fills mProfileNames and mProfileLocations</span>
<a href="#l14.224"></a><span id="l14.224">     FillProfileDataFromSeamonkeyRegistry();</span>
<a href="#l14.225"></a><span id="l14.225">   }</span>
<a href="#l14.226"></a><span id="l14.226"> </span>
<a href="#l14.227"></a><span id="l14.227">   NS_IF_ADDREF(*aResult = mProfileNames);</span>
<a href="#l14.228"></a><span id="l14.228">   return NS_OK;</span>
<a href="#l14.229"></a><span id="l14.229"> }</span>
<a href="#l14.230"></a><span id="l14.230"> </span>
<a href="#l14.231"></a><span id="l14.231"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.232"></a><span id="l14.232"> // nsSeamonkeyProfileMigrator</span>
<a href="#l14.233"></a><span id="l14.233"> </span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-nsresult</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-nsSeamonkeyProfileMigrator::GetSourceProfile(const char16_t* aProfile)</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-{</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::GetSourceProfile(</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+    const char16_t* aProfile) {</span>
<a href="#l14.239"></a><span id="l14.239">   uint32_t count;</span>
<a href="#l14.240"></a><span id="l14.240">   mProfileNames-&gt;GetLength(&amp;count);</span>
<a href="#l14.241"></a><span id="l14.241">   for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l14.242"></a><span id="l14.242">     nsCOMPtr&lt;nsISupportsString&gt; str(do_QueryElementAt(mProfileNames, i));</span>
<a href="#l14.243"></a><span id="l14.243">     nsString profileName;</span>
<a href="#l14.244"></a><span id="l14.244">     str-&gt;GetData(profileName);</span>
<a href="#l14.245"></a><span id="l14.245">     if (profileName.Equals(aProfile)) {</span>
<a href="#l14.246"></a><span id="l14.246">       mSourceProfile = do_QueryElementAt(mProfileLocations, i);</span>
<a href="#l14.247"></a><span id="l14.247">       break;</span>
<a href="#l14.248"></a><span id="l14.248">     }</span>
<a href="#l14.249"></a><span id="l14.249">   }</span>
<a href="#l14.250"></a><span id="l14.250"> </span>
<a href="#l14.251"></a><span id="l14.251">   return NS_OK;</span>
<a href="#l14.252"></a><span id="l14.252"> }</span>
<a href="#l14.253"></a><span id="l14.253"> </span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-nsresult</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-nsSeamonkeyProfileMigrator::FillProfileDataFromSeamonkeyRegistry()</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-{</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::FillProfileDataFromSeamonkeyRegistry() {</span>
<a href="#l14.258"></a><span id="l14.258">   // Find the Seamonkey Registry</span>
<a href="#l14.259"></a><span id="l14.259">   nsCOMPtr&lt;nsIProperties&gt; fileLocator(</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-    do_GetService(&quot;@mozilla.org/file/directory_service;1&quot;));</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+      do_GetService(&quot;@mozilla.org/file/directory_service;1&quot;));</span>
<a href="#l14.262"></a><span id="l14.262">   nsCOMPtr&lt;nsIFile&gt; seamonkeyData;</span>
<a href="#l14.263"></a><span id="l14.263"> #undef EXTRA_PREPEND</span>
<a href="#l14.264"></a><span id="l14.264"> </span>
<a href="#l14.265"></a><span id="l14.265"> #ifdef XP_WIN</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-#define NEW_FOLDER &quot;SeaMonkey&quot;</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-#define EXTRA_PREPEND &quot;Mozilla&quot;</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+#  define NEW_FOLDER &quot;SeaMonkey&quot;</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+#  define EXTRA_PREPEND &quot;Mozilla&quot;</span>
<a href="#l14.270"></a><span id="l14.270"> </span>
<a href="#l14.271"></a><span id="l14.271">   fileLocator-&gt;Get(NS_WIN_APPDATA_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l14.272"></a><span id="l14.272">                    getter_AddRefs(seamonkeyData));</span>
<a href="#l14.273"></a><span id="l14.273">   NS_ENSURE_TRUE(seamonkeyData, NS_ERROR_FAILURE);</span>
<a href="#l14.274"></a><span id="l14.274"> </span>
<a href="#l14.275"></a><span id="l14.275"> #elif defined(XP_MACOSX)</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-#define NEW_FOLDER &quot;SeaMonkey&quot;</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-#define EXTRA_PREPEND &quot;Application Support&quot;</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+#  define NEW_FOLDER &quot;SeaMonkey&quot;</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+#  define EXTRA_PREPEND &quot;Application Support&quot;</span>
<a href="#l14.280"></a><span id="l14.280">   fileLocator-&gt;Get(NS_MAC_USER_LIB_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l14.281"></a><span id="l14.281">                    getter_AddRefs(seamonkeyData));</span>
<a href="#l14.282"></a><span id="l14.282">   NS_ENSURE_TRUE(seamonkeyData, NS_ERROR_FAILURE);</span>
<a href="#l14.283"></a><span id="l14.283"> </span>
<a href="#l14.284"></a><span id="l14.284"> #elif defined(XP_UNIX)</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-#define NEW_FOLDER &quot;seamonkey&quot;</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-#define EXTRA_PREPEND &quot;.mozilla&quot;</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+#  define NEW_FOLDER &quot;seamonkey&quot;</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+#  define EXTRA_PREPEND &quot;.mozilla&quot;</span>
<a href="#l14.289"></a><span id="l14.289">   fileLocator-&gt;Get(NS_UNIX_HOME_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l14.290"></a><span id="l14.290">                    getter_AddRefs(seamonkeyData));</span>
<a href="#l14.291"></a><span id="l14.291">   NS_ENSURE_TRUE(seamonkeyData, NS_ERROR_FAILURE);</span>
<a href="#l14.292"></a><span id="l14.292"> </span>
<a href="#l14.293"></a><span id="l14.293"> #else</span>
<a href="#l14.294"></a><span id="l14.294">   // On other OS just abort.</span>
<a href="#l14.295"></a><span id="l14.295">   return NS_ERROR_FAILURE;</span>
<a href="#l14.296"></a><span id="l14.296"> #endif</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineat">@@ -243,106 +229,96 @@ nsSeamonkeyProfileMigrator::FillProfileD</span>
<a href="#l14.298"></a><span id="l14.298">   seamonkeyData-&gt;Clone(getter_AddRefs(newSeamonkeyData));</span>
<a href="#l14.299"></a><span id="l14.299">   NS_ENSURE_TRUE(newSeamonkeyData, NS_ERROR_FAILURE);</span>
<a href="#l14.300"></a><span id="l14.300"> </span>
<a href="#l14.301"></a><span id="l14.301"> #ifdef EXTRA_PREPEND</span>
<a href="#l14.302"></a><span id="l14.302">   newSeamonkeyData-&gt;Append(NS_LITERAL_STRING(EXTRA_PREPEND));</span>
<a href="#l14.303"></a><span id="l14.303"> #endif</span>
<a href="#l14.304"></a><span id="l14.304">   newSeamonkeyData-&gt;Append(NS_LITERAL_STRING(NEW_FOLDER));</span>
<a href="#l14.305"></a><span id="l14.305"> </span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-  nsresult rv = GetProfileDataFromProfilesIni(newSeamonkeyData,</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-                                              mProfileNames,</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+  nsresult rv = GetProfileDataFromProfilesIni(newSeamonkeyData, mProfileNames,</span>
<a href="#l14.309"></a><span id="l14.309">                                               mProfileLocations);</span>
<a href="#l14.310"></a><span id="l14.310"> </span>
<a href="#l14.311"></a><span id="l14.311">   return rv;</span>
<a href="#l14.312"></a><span id="l14.312"> }</span>
<a href="#l14.313"></a><span id="l14.313"> </span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-static</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineminus">-nsSeamonkeyProfileMigrator::PrefTransform gTransforms[] = {</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineminus">-</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineplus">+static nsSeamonkeyProfileMigrator::PrefTransform gTransforms[] = {</span>
<a href="#l14.318"></a><span id="l14.318"> </span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;signon.SignonFileName&quot;,                    String),</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.headers.showUserAgent&quot;,           Bool),</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.headers.showOrganization&quot;,        Bool),</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.collect_addressbook&quot;,                 String),</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.collect_email_address_outgoing&quot;,      Bool),</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.wrap_long_lines&quot;,                     Bool),</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.customHeaders&quot;,                   String),</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.default_html_action&quot;,                 Int),</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.forward_message_mode&quot;,                Int),</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.SpellCheckBeforeSend&quot;,                Bool),</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.warn_on_send_accel_key&quot;,              Bool),</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.html_domains&quot;,                    String),</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.plaintext_domains&quot;,               String),</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.headers.showUserAgent&quot;,           Bool),</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.headers.showOrganization&quot;,        Bool),</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.biff.play_sound&quot;,                     Bool),</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.biff.play_sound.type&quot;,                Int),</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.biff.play_sound.url&quot;,                 String),</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.biff.show_alert&quot;,                     Bool),</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.type&quot;,                       Int),</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.http&quot;,                       String),</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.http_port&quot;,                  Int),</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.ftp&quot;,                        String),</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.ftp_port&quot;,                   Int),</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.ssl&quot;,                        String),</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.ssl_port&quot;,                   Int),</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.socks&quot;,                      String),</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.socks_port&quot;,                 Int),</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.no_proxies_on&quot;,              String),</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.autoconfig_url&quot;,             String),</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;signon.SignonFileName&quot;, String),</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.headers.showUserAgent&quot;, Bool),</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.headers.showOrganization&quot;, Bool),</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.collect_addressbook&quot;, String),</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.collect_email_address_outgoing&quot;, Bool),</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.wrap_long_lines&quot;, Bool),</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.customHeaders&quot;, String),</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.default_html_action&quot;, Int),</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.forward_message_mode&quot;, Int),</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.SpellCheckBeforeSend&quot;, Bool),</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.warn_on_send_accel_key&quot;, Bool),</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.html_domains&quot;, String),</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.plaintext_domains&quot;, String),</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.headers.showUserAgent&quot;, Bool),</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mailnews.headers.showOrganization&quot;, Bool),</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.biff.play_sound&quot;, Bool),</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.biff.play_sound.type&quot;, Int),</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.biff.play_sound.url&quot;, String),</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.biff.show_alert&quot;, Bool),</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.type&quot;, Int),</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.http&quot;, String),</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.http_port&quot;, Int),</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.ftp&quot;, String),</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.ftp_port&quot;, Int),</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.ssl&quot;, String),</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.ssl_port&quot;, Int),</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.socks&quot;, String),</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.socks_port&quot;, Int),</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.no_proxies_on&quot;, String),</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;network.proxy.autoconfig_url&quot;, String),</span>
<a href="#l14.379"></a><span id="l14.379"> </span>
<a href="#l14.380"></a><span id="l14.380" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.accountmanager.accounts&quot;,             String),</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.accountmanager.defaultaccount&quot;,       String),</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.accountmanager.localfoldersserver&quot;,   String),</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.smtp.defaultserver&quot;,                  String),</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.smtpservers&quot;,                         String),</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineminus">-</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;msgcompose.font_face&quot;,                     String),</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;msgcompose.font_size&quot;,                     String),</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;msgcompose.text_color&quot;,                    String),</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;msgcompose.background_color&quot;,              String),</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.accountmanager.accounts&quot;, String),</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.accountmanager.defaultaccount&quot;, String),</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.accountmanager.localfoldersserver&quot;, String),</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.smtp.defaultserver&quot;, String),</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;mail.smtpservers&quot;, String),</span>
<a href="#l14.395"></a><span id="l14.395"> </span>
<a href="#l14.396"></a><span id="l14.396" class="difflineminus">-  MAKEPREFTRANSFORM(&quot;mail.pane_config&quot;,&quot;mail.pane_config.dynamic&quot;, Int, Int)</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-};</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;msgcompose.font_face&quot;, String),</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;msgcompose.font_size&quot;, String),</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;msgcompose.text_color&quot;, String),</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+    MAKESAMETYPEPREFTRANSFORM(&quot;msgcompose.background_color&quot;, String),</span>
<a href="#l14.403"></a><span id="l14.403"> </span>
<a href="#l14.404"></a><span id="l14.404" class="difflineminus">-nsresult</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineminus">-nsSeamonkeyProfileMigrator::TransformPreferences(const nsAString&amp; aSourcePrefFileName,</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineminus">-                                                 const nsAString&amp; aTargetPrefFileName)</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineminus">-{</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+    MAKEPREFTRANSFORM(&quot;mail.pane_config&quot;, &quot;mail.pane_config.dynamic&quot;, Int,</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineplus">+                      Int)};</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::TransformPreferences(</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineplus">+    const nsAString&amp; aSourcePrefFileName,</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineplus">+    const nsAString&amp; aTargetPrefFileName) {</span>
<a href="#l14.414"></a><span id="l14.414">   PrefTransform* transform;</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineminus">-  PrefTransform* end = gTransforms + sizeof(gTransforms)/sizeof(PrefTransform);</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+  PrefTransform* end =</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineplus">+      gTransforms + sizeof(gTransforms) / sizeof(PrefTransform);</span>
<a href="#l14.418"></a><span id="l14.418"> </span>
<a href="#l14.419"></a><span id="l14.419">   // Load the source pref file</span>
<a href="#l14.420"></a><span id="l14.420">   nsCOMPtr&lt;nsIPrefService&gt; psvc(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l14.421"></a><span id="l14.421">   psvc-&gt;ResetPrefs();</span>
<a href="#l14.422"></a><span id="l14.422"> </span>
<a href="#l14.423"></a><span id="l14.423">   nsCOMPtr&lt;nsIFile&gt; sourcePrefsFile;</span>
<a href="#l14.424"></a><span id="l14.424">   mSourceProfile-&gt;Clone(getter_AddRefs(sourcePrefsFile));</span>
<a href="#l14.425"></a><span id="l14.425">   sourcePrefsFile-&gt;Append(aSourcePrefFileName);</span>
<a href="#l14.426"></a><span id="l14.426">   psvc-&gt;ReadUserPrefsFromFile(sourcePrefsFile);</span>
<a href="#l14.427"></a><span id="l14.427"> </span>
<a href="#l14.428"></a><span id="l14.428">   nsCOMPtr&lt;nsIPrefBranch&gt; branch(do_QueryInterface(psvc));</span>
<a href="#l14.429"></a><span id="l14.429">   for (transform = gTransforms; transform &lt; end; ++transform)</span>
<a href="#l14.430"></a><span id="l14.430">     transform-&gt;prefGetterFunc(transform, branch);</span>
<a href="#l14.431"></a><span id="l14.431"> </span>
<a href="#l14.432"></a><span id="l14.432" class="difflineminus">-  static const char* branchNames[] =</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineminus">-  {</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineminus">-    // Keep the three below first, or change the indexes below</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineminus">-    &quot;mail.identity.&quot;,</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineminus">-    &quot;mail.server.&quot;,</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineminus">-    &quot;ldap_2.&quot;,</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineminus">-    &quot;mail.account.&quot;,</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineminus">-    &quot;mail.smtpserver.&quot;,</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineminus">-    &quot;mailnews.labels.&quot;,</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineminus">-    &quot;mailnews.tags.&quot;</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineminus">-  };</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineplus">+  static const char* branchNames[] = {</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineplus">+      // Keep the three below first, or change the indexes below</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineplus">+      &quot;mail.identity.&quot;,   &quot;mail.server.&quot;,     &quot;ldap_2.&quot;,       &quot;mail.account.&quot;,</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineplus">+      &quot;mail.smtpserver.&quot;, &quot;mailnews.labels.&quot;, &quot;mailnews.tags.&quot;};</span>
<a href="#l14.447"></a><span id="l14.447"> </span>
<a href="#l14.448"></a><span id="l14.448" class="difflineminus">-  // read in the various pref branch trees for accounts, identities, servers, etc.</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineplus">+  // read in the various pref branch trees for accounts, identities, servers,</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+  // etc.</span>
<a href="#l14.451"></a><span id="l14.451">   PBStructArray branches[MOZ_ARRAY_LENGTH(branchNames)];</span>
<a href="#l14.452"></a><span id="l14.452">   uint32_t i;</span>
<a href="#l14.453"></a><span id="l14.453">   for (i = 0; i &lt; MOZ_ARRAY_LENGTH(branchNames); ++i)</span>
<a href="#l14.454"></a><span id="l14.454">     ReadBranch(branchNames[i], psvc, branches[i]);</span>
<a href="#l14.455"></a><span id="l14.455"> </span>
<a href="#l14.456"></a><span id="l14.456">   // The signature file prefs may be paths to files in the seamonkey profile</span>
<a href="#l14.457"></a><span id="l14.457">   // path so we need to copy them over and fix these paths up before we write</span>
<a href="#l14.458"></a><span id="l14.458">   // them out to the new prefs.js.</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineat">@@ -370,232 +346,216 @@ nsSeamonkeyProfileMigrator::TransformPre</span>
<a href="#l14.460"></a><span id="l14.460">   nsCOMPtr&lt;nsIFile&gt; targetPrefsFile;</span>
<a href="#l14.461"></a><span id="l14.461">   mTargetProfile-&gt;Clone(getter_AddRefs(targetPrefsFile));</span>
<a href="#l14.462"></a><span id="l14.462">   targetPrefsFile-&gt;Append(aTargetPrefFileName);</span>
<a href="#l14.463"></a><span id="l14.463">   psvc-&gt;SavePrefFile(targetPrefsFile);</span>
<a href="#l14.464"></a><span id="l14.464"> </span>
<a href="#l14.465"></a><span id="l14.465">   return NS_OK;</span>
<a href="#l14.466"></a><span id="l14.466"> }</span>
<a href="#l14.467"></a><span id="l14.467"> </span>
<a href="#l14.468"></a><span id="l14.468" class="difflineminus">-nsresult</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineminus">-nsSeamonkeyProfileMigrator::CopyAddressBookDirectories(PBStructArray &amp;aLdapServers,</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineminus">-                                                       nsIPrefService* aPrefService)</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineminus">-{</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineminus">-  // each server has a pref ending with .filename. The value of that pref points to a profile which we</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineminus">-  // need to migrate.</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::CopyAddressBookDirectories(</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineplus">+    PBStructArray&amp; aLdapServers, nsIPrefService* aPrefService) {</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineplus">+  // each server has a pref ending with .filename. The value of that pref points</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineplus">+  // to a profile which we need to migrate.</span>
<a href="#l14.478"></a><span id="l14.478">   nsAutoString index;</span>
<a href="#l14.479"></a><span id="l14.479">   index.AppendInt(nsIMailProfileMigrator::ADDRESSBOOK_DATA);</span>
<a href="#l14.480"></a><span id="l14.480">   NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get());</span>
<a href="#l14.481"></a><span id="l14.481"> </span>
<a href="#l14.482"></a><span id="l14.482">   uint32_t count = aLdapServers.Length();</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l14.484"></a><span id="l14.484" class="difflineminus">-  {</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l14.486"></a><span id="l14.486">     PrefBranchStruct* pref = aLdapServers.ElementAt(i);</span>
<a href="#l14.487"></a><span id="l14.487">     nsDependentCString prefName(pref-&gt;prefName);</span>
<a href="#l14.488"></a><span id="l14.488"> </span>
<a href="#l14.489"></a><span id="l14.489" class="difflineminus">-    if (StringEndsWith(prefName, nsDependentCString(&quot;.filename&quot;)))</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineminus">-    {</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineplus">+    if (StringEndsWith(prefName, nsDependentCString(&quot;.filename&quot;))) {</span>
<a href="#l14.492"></a><span id="l14.492">       NS_ConvertUTF8toUTF16 fileName(pref-&gt;stringValue);</span>
<a href="#l14.493"></a><span id="l14.493">       CopyFile(fileName, fileName);</span>
<a href="#l14.494"></a><span id="l14.494">     }</span>
<a href="#l14.495"></a><span id="l14.495">     // we don't need to do anything to the fileName pref itself</span>
<a href="#l14.496"></a><span id="l14.496">   }</span>
<a href="#l14.497"></a><span id="l14.497"> </span>
<a href="#l14.498"></a><span id="l14.498">   NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get());</span>
<a href="#l14.499"></a><span id="l14.499"> </span>
<a href="#l14.500"></a><span id="l14.500">   return NS_OK;</span>
<a href="#l14.501"></a><span id="l14.501"> }</span>
<a href="#l14.502"></a><span id="l14.502"> </span>
<a href="#l14.503"></a><span id="l14.503" class="difflineminus">-</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineminus">-nsresult</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineminus">-nsSeamonkeyProfileMigrator::CopySignatureFiles(PBStructArray &amp;aIdentities,</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineminus">-                                               nsIPrefService* aPrefService)</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineminus">-{</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::CopySignatureFiles(</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+    PBStructArray&amp; aIdentities, nsIPrefService* aPrefService) {</span>
<a href="#l14.510"></a><span id="l14.510">   nsresult rv = NS_OK;</span>
<a href="#l14.511"></a><span id="l14.511"> </span>
<a href="#l14.512"></a><span id="l14.512">   uint32_t count = aIdentities.Length();</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineminus">-  {</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l14.516"></a><span id="l14.516">     PrefBranchStruct* pref = aIdentities.ElementAt(i);</span>
<a href="#l14.517"></a><span id="l14.517">     nsDependentCString prefName(pref-&gt;prefName);</span>
<a href="#l14.518"></a><span id="l14.518"> </span>
<a href="#l14.519"></a><span id="l14.519">     // a partial fix for bug #255043</span>
<a href="#l14.520"></a><span id="l14.520">     // if the user's signature file from seamonkey lives in the</span>
<a href="#l14.521"></a><span id="l14.521">     // seamonkey profile root, we'll copy it over to the new</span>
<a href="#l14.522"></a><span id="l14.522">     // thunderbird profile root and thenn set the pref to the new value</span>
<a href="#l14.523"></a><span id="l14.523">     // note, this doesn't work for multiple signatures that live</span>
<a href="#l14.524"></a><span id="l14.524">     // below the seamonkey profile root</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineminus">-    if (StringEndsWith(prefName, nsDependentCString(&quot;.sig_file&quot;)))</span>
<a href="#l14.526"></a><span id="l14.526" class="difflineminus">-    {</span>
<a href="#l14.527"></a><span id="l14.527" class="difflineplus">+    if (StringEndsWith(prefName, nsDependentCString(&quot;.sig_file&quot;))) {</span>
<a href="#l14.528"></a><span id="l14.528">       // turn the pref into a nsIFile</span>
<a href="#l14.529"></a><span id="l14.529">       nsCOMPtr&lt;nsIFile&gt; srcSigFile =</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineminus">-        do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l14.531"></a><span id="l14.531" class="difflineminus">-      rv = srcSigFile-&gt;SetPersistentDescriptor(nsDependentCString(pref-&gt;stringValue));</span>
<a href="#l14.532"></a><span id="l14.532" class="difflineplus">+          do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineplus">+      rv = srcSigFile-&gt;SetPersistentDescriptor(</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineplus">+          nsDependentCString(pref-&gt;stringValue));</span>
<a href="#l14.535"></a><span id="l14.535">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.536"></a><span id="l14.536"> </span>
<a href="#l14.537"></a><span id="l14.537">       nsCOMPtr&lt;nsIFile&gt; targetSigFile;</span>
<a href="#l14.538"></a><span id="l14.538">       rv = mTargetProfile-&gt;Clone(getter_AddRefs(targetSigFile));</span>
<a href="#l14.539"></a><span id="l14.539">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.540"></a><span id="l14.540"> </span>
<a href="#l14.541"></a><span id="l14.541">       // now make the copy</span>
<a href="#l14.542"></a><span id="l14.542">       bool exists;</span>
<a href="#l14.543"></a><span id="l14.543">       srcSigFile-&gt;Exists(&amp;exists);</span>
<a href="#l14.544"></a><span id="l14.544" class="difflineminus">-      if (exists)</span>
<a href="#l14.545"></a><span id="l14.545" class="difflineminus">-      {</span>
<a href="#l14.546"></a><span id="l14.546" class="difflineplus">+      if (exists) {</span>
<a href="#l14.547"></a><span id="l14.547">         nsAutoString leafName;</span>
<a href="#l14.548"></a><span id="l14.548">         srcSigFile-&gt;GetLeafName(leafName);</span>
<a href="#l14.549"></a><span id="l14.549" class="difflineminus">-        srcSigFile-&gt;CopyTo(targetSigFile,leafName); // will fail if we've already copied a sig file here</span>
<a href="#l14.550"></a><span id="l14.550" class="difflineplus">+        srcSigFile-&gt;CopyTo(</span>
<a href="#l14.551"></a><span id="l14.551" class="difflineplus">+            targetSigFile,</span>
<a href="#l14.552"></a><span id="l14.552" class="difflineplus">+            leafName);  // will fail if we've already copied a sig file here</span>
<a href="#l14.553"></a><span id="l14.553">         targetSigFile-&gt;Append(leafName);</span>
<a href="#l14.554"></a><span id="l14.554"> </span>
<a href="#l14.555"></a><span id="l14.555">         // now write out the new descriptor</span>
<a href="#l14.556"></a><span id="l14.556">         nsAutoCString descriptorString;</span>
<a href="#l14.557"></a><span id="l14.557">         rv = targetSigFile-&gt;GetPersistentDescriptor(descriptorString);</span>
<a href="#l14.558"></a><span id="l14.558">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.559"></a><span id="l14.559">         free(pref-&gt;stringValue);</span>
<a href="#l14.560"></a><span id="l14.560">         pref-&gt;stringValue = ToNewCString(descriptorString);</span>
<a href="#l14.561"></a><span id="l14.561">       }</span>
<a href="#l14.562"></a><span id="l14.562">     }</span>
<a href="#l14.563"></a><span id="l14.563">   }</span>
<a href="#l14.564"></a><span id="l14.564">   return NS_OK;</span>
<a href="#l14.565"></a><span id="l14.565"> }</span>
<a href="#l14.566"></a><span id="l14.566"> </span>
<a href="#l14.567"></a><span id="l14.567" class="difflineminus">-nsresult</span>
<a href="#l14.568"></a><span id="l14.568" class="difflineminus">-nsSeamonkeyProfileMigrator::CopyMailFolders(PBStructArray &amp;aMailServers,</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineminus">-                                            nsIPrefService* aPrefService)</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineminus">-{</span>
<a href="#l14.571"></a><span id="l14.571" class="difflineminus">-  // Each server has a .directory pref which points to the location of the mail data</span>
<a href="#l14.572"></a><span id="l14.572" class="difflineminus">-  // for that server. We need to do two things for that case...</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineminus">-  // (1) Fix up the directory path for the new profile</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineminus">-  // (2) copy the mail folder data from the source directory pref to the destination directory pref</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::CopyMailFolders(</span>
<a href="#l14.576"></a><span id="l14.576" class="difflineplus">+    PBStructArray&amp; aMailServers, nsIPrefService* aPrefService) {</span>
<a href="#l14.577"></a><span id="l14.577" class="difflineplus">+  // Each server has a .directory pref which points to the location of the mail</span>
<a href="#l14.578"></a><span id="l14.578" class="difflineplus">+  // data for that server. We need to do two things for that case... (1) Fix up</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineplus">+  // the directory path for the new profile (2) copy the mail folder data from</span>
<a href="#l14.580"></a><span id="l14.580" class="difflineplus">+  // the source directory pref to the destination directory pref</span>
<a href="#l14.581"></a><span id="l14.581"> </span>
<a href="#l14.582"></a><span id="l14.582">   nsresult rv;</span>
<a href="#l14.583"></a><span id="l14.583">   uint32_t count = aMailServers.Length();</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineminus">-  {</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l14.587"></a><span id="l14.587">     PrefBranchStruct* pref = aMailServers.ElementAt(i);</span>
<a href="#l14.588"></a><span id="l14.588">     nsDependentCString prefName(pref-&gt;prefName);</span>
<a href="#l14.589"></a><span id="l14.589"> </span>
<a href="#l14.590"></a><span id="l14.590">     if (StringEndsWith(prefName, NS_LITERAL_CSTRING(&quot;.directory-rel&quot;))) {</span>
<a href="#l14.591"></a><span id="l14.591">       // When the directories are modified below, we may change the .directory</span>
<a href="#l14.592"></a><span id="l14.592">       // pref. As we don't have a pref branch to modify at this stage and set</span>
<a href="#l14.593"></a><span id="l14.593">       // up the relative folders properly, we'll just remove all the</span>
<a href="#l14.594"></a><span id="l14.594">       // *.directory-rel prefs. Mailnews will cope with this, creating them</span>
<a href="#l14.595"></a><span id="l14.595">       // when it first needs them.</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineminus">-      if (pref-&gt;type == nsIPrefBranch::PREF_STRING)</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineminus">-        free(pref-&gt;stringValue);</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineplus">+      if (pref-&gt;type == nsIPrefBranch::PREF_STRING) free(pref-&gt;stringValue);</span>
<a href="#l14.599"></a><span id="l14.599"> </span>
<a href="#l14.600"></a><span id="l14.600">       aMailServers.RemoveElementAt(i);</span>
<a href="#l14.601"></a><span id="l14.601">       // Now decrease i and count to match the removed element</span>
<a href="#l14.602"></a><span id="l14.602">       --i;</span>
<a href="#l14.603"></a><span id="l14.603">       --count;</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineminus">-    }</span>
<a href="#l14.605"></a><span id="l14.605" class="difflineminus">-    else if (StringEndsWith(prefName, nsDependentCString(&quot;.directory&quot;)))</span>
<a href="#l14.606"></a><span id="l14.606" class="difflineminus">-    {</span>
<a href="#l14.607"></a><span id="l14.607" class="difflineplus">+    } else if (StringEndsWith(prefName, nsDependentCString(&quot;.directory&quot;))) {</span>
<a href="#l14.608"></a><span id="l14.608">       // let's try to get a branch for this particular server to simplify things</span>
<a href="#l14.609"></a><span id="l14.609" class="difflineminus">-      prefName.Cut( prefName.Length() - strlen(&quot;directory&quot;), strlen(&quot;directory&quot;));</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineplus">+      prefName.Cut(prefName.Length() - strlen(&quot;directory&quot;),</span>
<a href="#l14.611"></a><span id="l14.611" class="difflineplus">+                   strlen(&quot;directory&quot;));</span>
<a href="#l14.612"></a><span id="l14.612">       prefName.Insert(&quot;mail.server.&quot;, 0);</span>
<a href="#l14.613"></a><span id="l14.613"> </span>
<a href="#l14.614"></a><span id="l14.614">       nsCOMPtr&lt;nsIPrefBranch&gt; serverBranch;</span>
<a href="#l14.615"></a><span id="l14.615">       aPrefService-&gt;GetBranch(prefName.get(), getter_AddRefs(serverBranch));</span>
<a href="#l14.616"></a><span id="l14.616"> </span>
<a href="#l14.617"></a><span id="l14.617">       if (!serverBranch)</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineminus">-        break; // should we clear out this server pref from aMailServers?</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineplus">+        break;  // should we clear out this server pref from aMailServers?</span>
<a href="#l14.620"></a><span id="l14.620"> </span>
<a href="#l14.621"></a><span id="l14.621">       nsCString serverType;</span>
<a href="#l14.622"></a><span id="l14.622">       serverBranch-&gt;GetCharPref(&quot;type&quot;, serverType);</span>
<a href="#l14.623"></a><span id="l14.623"> </span>
<a href="#l14.624"></a><span id="l14.624">       nsCOMPtr&lt;nsIFile&gt; sourceMailFolder;</span>
<a href="#l14.625"></a><span id="l14.625" class="difflineminus">-      serverBranch-&gt;GetComplexValue(&quot;directory&quot;, NS_GET_IID(nsIFile), getter_AddRefs(sourceMailFolder));</span>
<a href="#l14.626"></a><span id="l14.626" class="difflineplus">+      serverBranch-&gt;GetComplexValue(&quot;directory&quot;, NS_GET_IID(nsIFile),</span>
<a href="#l14.627"></a><span id="l14.627" class="difflineplus">+                                    getter_AddRefs(sourceMailFolder));</span>
<a href="#l14.628"></a><span id="l14.628"> </span>
<a href="#l14.629"></a><span id="l14.629" class="difflineminus">-      // now based on type, we need to build a new destination path for the mail folders for this server</span>
<a href="#l14.630"></a><span id="l14.630" class="difflineplus">+      // now based on type, we need to build a new destination path for the mail</span>
<a href="#l14.631"></a><span id="l14.631" class="difflineplus">+      // folders for this server</span>
<a href="#l14.632"></a><span id="l14.632">       nsCOMPtr&lt;nsIFile&gt; targetMailFolder;</span>
<a href="#l14.633"></a><span id="l14.633" class="difflineminus">-      if (serverType.Equals(&quot;imap&quot;))</span>
<a href="#l14.634"></a><span id="l14.634" class="difflineminus">-      {</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineplus">+      if (serverType.Equals(&quot;imap&quot;)) {</span>
<a href="#l14.636"></a><span id="l14.636">         mTargetProfile-&gt;Clone(getter_AddRefs(targetMailFolder));</span>
<a href="#l14.637"></a><span id="l14.637">         targetMailFolder-&gt;Append(IMAP_MAIL_DIR_50_NAME);</span>
<a href="#l14.638"></a><span id="l14.638" class="difflineminus">-      }</span>
<a href="#l14.639"></a><span id="l14.639" class="difflineminus">-      else if (serverType.Equals(&quot;none&quot;) || serverType.Equals(&quot;pop3&quot;))</span>
<a href="#l14.640"></a><span id="l14.640" class="difflineminus">-      {</span>
<a href="#l14.641"></a><span id="l14.641" class="difflineplus">+      } else if (serverType.Equals(&quot;none&quot;) || serverType.Equals(&quot;pop3&quot;)) {</span>
<a href="#l14.642"></a><span id="l14.642">         // local folders and POP3 servers go under &lt;profile&gt;\Mail</span>
<a href="#l14.643"></a><span id="l14.643">         mTargetProfile-&gt;Clone(getter_AddRefs(targetMailFolder));</span>
<a href="#l14.644"></a><span id="l14.644">         targetMailFolder-&gt;Append(MAIL_DIR_50_NAME);</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineminus">-      }</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineminus">-      else if (serverType.Equals(&quot;nntp&quot;))</span>
<a href="#l14.647"></a><span id="l14.647" class="difflineminus">-      {</span>
<a href="#l14.648"></a><span id="l14.648" class="difflineplus">+      } else if (serverType.Equals(&quot;nntp&quot;)) {</span>
<a href="#l14.649"></a><span id="l14.649">         mTargetProfile-&gt;Clone(getter_AddRefs(targetMailFolder));</span>
<a href="#l14.650"></a><span id="l14.650">         targetMailFolder-&gt;Append(NEWS_DIR_50_NAME);</span>
<a href="#l14.651"></a><span id="l14.651">       }</span>
<a href="#l14.652"></a><span id="l14.652"> </span>
<a href="#l14.653"></a><span id="l14.653" class="difflineminus">-      if (targetMailFolder)</span>
<a href="#l14.654"></a><span id="l14.654" class="difflineminus">-      {</span>
<a href="#l14.655"></a><span id="l14.655" class="difflineminus">-        // for all of our server types, append the host name to the directory as part of the new location</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineplus">+      if (targetMailFolder) {</span>
<a href="#l14.657"></a><span id="l14.657" class="difflineplus">+        // for all of our server types, append the host name to the directory as</span>
<a href="#l14.658"></a><span id="l14.658" class="difflineplus">+        // part of the new location</span>
<a href="#l14.659"></a><span id="l14.659">         nsCString hostName;</span>
<a href="#l14.660"></a><span id="l14.660">         serverBranch-&gt;GetCharPref(&quot;hostname&quot;, hostName);</span>
<a href="#l14.661"></a><span id="l14.661">         targetMailFolder-&gt;Append(NS_ConvertASCIItoUTF16(hostName));</span>
<a href="#l14.662"></a><span id="l14.662"> </span>
<a href="#l14.663"></a><span id="l14.663" class="difflineminus">-        // we should make sure the host name based directory we are going to migrate</span>
<a href="#l14.664"></a><span id="l14.664" class="difflineminus">-        // the accounts into is unique. This protects against the case where the user</span>
<a href="#l14.665"></a><span id="l14.665" class="difflineminus">-        // has multiple servers with the same host name.</span>
<a href="#l14.666"></a><span id="l14.666" class="difflineplus">+        // we should make sure the host name based directory we are going to</span>
<a href="#l14.667"></a><span id="l14.667" class="difflineplus">+        // migrate the accounts into is unique. This protects against the case</span>
<a href="#l14.668"></a><span id="l14.668" class="difflineplus">+        // where the user has multiple servers with the same host name.</span>
<a href="#l14.669"></a><span id="l14.669">         rv = targetMailFolder-&gt;CreateUnique(nsIFile::DIRECTORY_TYPE, 0777);</span>
<a href="#l14.670"></a><span id="l14.670">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.671"></a><span id="l14.671"> </span>
<a href="#l14.672"></a><span id="l14.672" class="difflineminus">-        (void) RecursiveCopy(sourceMailFolder, targetMailFolder);</span>
<a href="#l14.673"></a><span id="l14.673" class="difflineplus">+        (void)RecursiveCopy(sourceMailFolder, targetMailFolder);</span>
<a href="#l14.674"></a><span id="l14.674">         // now we want to make sure the actual directory pref that gets</span>
<a href="#l14.675"></a><span id="l14.675">         // transformed into the new profile's pref.js has the right file</span>
<a href="#l14.676"></a><span id="l14.676">         // location.</span>
<a href="#l14.677"></a><span id="l14.677">         nsAutoCString descriptorString;</span>
<a href="#l14.678"></a><span id="l14.678">         rv = targetMailFolder-&gt;GetPersistentDescriptor(descriptorString);</span>
<a href="#l14.679"></a><span id="l14.679">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.680"></a><span id="l14.680">         free(pref-&gt;stringValue);</span>
<a href="#l14.681"></a><span id="l14.681">         pref-&gt;stringValue = ToNewCString(descriptorString);</span>
<a href="#l14.682"></a><span id="l14.682">       }</span>
<a href="#l14.683"></a><span id="l14.683" class="difflineminus">-    }</span>
<a href="#l14.684"></a><span id="l14.684" class="difflineminus">-    else if (StringEndsWith(prefName, nsDependentCString(&quot;.newsrc.file&quot;)))</span>
<a href="#l14.685"></a><span id="l14.685" class="difflineminus">-    {</span>
<a href="#l14.686"></a><span id="l14.686" class="difflineminus">-      // copy the news RC file into \News. this won't work if the user has different newsrc files for each account</span>
<a href="#l14.687"></a><span id="l14.687" class="difflineminus">-      // I don't know what to do in that situation.</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineplus">+    } else if (StringEndsWith(prefName, nsDependentCString(&quot;.newsrc.file&quot;))) {</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineplus">+      // copy the news RC file into \News. this won't work if the user has</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineplus">+      // different newsrc files for each account I don't know what to do in that</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineplus">+      // situation.</span>
<a href="#l14.692"></a><span id="l14.692"> </span>
<a href="#l14.693"></a><span id="l14.693">       nsCOMPtr&lt;nsIFile&gt; targetNewsRCFile;</span>
<a href="#l14.694"></a><span id="l14.694">       mTargetProfile-&gt;Clone(getter_AddRefs(targetNewsRCFile));</span>
<a href="#l14.695"></a><span id="l14.695">       targetNewsRCFile-&gt;Append(NEWS_DIR_50_NAME);</span>
<a href="#l14.696"></a><span id="l14.696"> </span>
<a href="#l14.697"></a><span id="l14.697">       // turn the pref into a nsIFile</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineminus">-      nsCOMPtr&lt;nsIFile&gt; srcNewsRCFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l14.699"></a><span id="l14.699" class="difflineminus">-      rv = srcNewsRCFile-&gt;SetPersistentDescriptor(nsDependentCString(pref-&gt;stringValue));</span>
<a href="#l14.700"></a><span id="l14.700" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; srcNewsRCFile =</span>
<a href="#l14.701"></a><span id="l14.701" class="difflineplus">+          do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l14.702"></a><span id="l14.702" class="difflineplus">+      rv = srcNewsRCFile-&gt;SetPersistentDescriptor(</span>
<a href="#l14.703"></a><span id="l14.703" class="difflineplus">+          nsDependentCString(pref-&gt;stringValue));</span>
<a href="#l14.704"></a><span id="l14.704">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.705"></a><span id="l14.705"> </span>
<a href="#l14.706"></a><span id="l14.706">       // now make the copy</span>
<a href="#l14.707"></a><span id="l14.707">       bool exists;</span>
<a href="#l14.708"></a><span id="l14.708">       srcNewsRCFile-&gt;Exists(&amp;exists);</span>
<a href="#l14.709"></a><span id="l14.709" class="difflineminus">-      if (exists)</span>
<a href="#l14.710"></a><span id="l14.710" class="difflineminus">-      {</span>
<a href="#l14.711"></a><span id="l14.711" class="difflineplus">+      if (exists) {</span>
<a href="#l14.712"></a><span id="l14.712">         nsAutoString leafName;</span>
<a href="#l14.713"></a><span id="l14.713">         srcNewsRCFile-&gt;GetLeafName(leafName);</span>
<a href="#l14.714"></a><span id="l14.714" class="difflineminus">-        srcNewsRCFile-&gt;CopyTo(targetNewsRCFile,leafName); // will fail if we've already copied a newsrc file here</span>
<a href="#l14.715"></a><span id="l14.715" class="difflineplus">+        srcNewsRCFile-&gt;CopyTo(</span>
<a href="#l14.716"></a><span id="l14.716" class="difflineplus">+            targetNewsRCFile,</span>
<a href="#l14.717"></a><span id="l14.717" class="difflineplus">+            leafName);  // will fail if we've already copied a newsrc file here</span>
<a href="#l14.718"></a><span id="l14.718">         targetNewsRCFile-&gt;Append(leafName);</span>
<a href="#l14.719"></a><span id="l14.719"> </span>
<a href="#l14.720"></a><span id="l14.720">         // now write out the new descriptor</span>
<a href="#l14.721"></a><span id="l14.721">         nsAutoCString descriptorString;</span>
<a href="#l14.722"></a><span id="l14.722">         rv = targetNewsRCFile-&gt;GetPersistentDescriptor(descriptorString);</span>
<a href="#l14.723"></a><span id="l14.723">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.724"></a><span id="l14.724">         free(pref-&gt;stringValue);</span>
<a href="#l14.725"></a><span id="l14.725">         pref-&gt;stringValue = ToNewCString(descriptorString);</span>
<a href="#l14.726"></a><span id="l14.726">       }</span>
<a href="#l14.727"></a><span id="l14.727">     }</span>
<a href="#l14.728"></a><span id="l14.728">   }</span>
<a href="#l14.729"></a><span id="l14.729"> </span>
<a href="#l14.730"></a><span id="l14.730">   return NS_OK;</span>
<a href="#l14.731"></a><span id="l14.731"> }</span>
<a href="#l14.732"></a><span id="l14.732"> </span>
<a href="#l14.733"></a><span id="l14.733" class="difflineminus">-nsresult</span>
<a href="#l14.734"></a><span id="l14.734" class="difflineminus">-nsSeamonkeyProfileMigrator::CopyPreferences(bool aReplace)</span>
<a href="#l14.735"></a><span id="l14.735" class="difflineminus">-{</span>
<a href="#l14.736"></a><span id="l14.736" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::CopyPreferences(bool aReplace) {</span>
<a href="#l14.737"></a><span id="l14.737">   nsresult rv = NS_OK;</span>
<a href="#l14.738"></a><span id="l14.738" class="difflineminus">-  if (!aReplace)</span>
<a href="#l14.739"></a><span id="l14.739" class="difflineminus">-    return rv;</span>
<a href="#l14.740"></a><span id="l14.740" class="difflineplus">+  if (!aReplace) return rv;</span>
<a href="#l14.741"></a><span id="l14.741"> </span>
<a href="#l14.742"></a><span id="l14.742">   nsresult tmp = TransformPreferences(FILE_NAME_PREFS, FILE_NAME_PREFS);</span>
<a href="#l14.743"></a><span id="l14.743">   if (NS_FAILED(tmp)) {</span>
<a href="#l14.744"></a><span id="l14.744">     rv = tmp;</span>
<a href="#l14.745"></a><span id="l14.745">   }</span>
<a href="#l14.746"></a><span id="l14.746">   tmp = CopyFile(FILE_NAME_USER_PREFS, FILE_NAME_USER_PREFS);</span>
<a href="#l14.747"></a><span id="l14.747">   if (NS_FAILED(tmp)) {</span>
<a href="#l14.748"></a><span id="l14.748">     rv = tmp;</span>
<a href="#l14.749"></a><span id="l14.749" class="difflineat">@@ -621,123 +581,115 @@ nsSeamonkeyProfileMigrator::CopyPreferen</span>
<a href="#l14.750"></a><span id="l14.750">   }</span>
<a href="#l14.751"></a><span id="l14.751">   tmp = CopyFile(FILE_NAME_MAILVIEWS, FILE_NAME_MAILVIEWS);</span>
<a href="#l14.752"></a><span id="l14.752">   if (NS_FAILED(tmp)) {</span>
<a href="#l14.753"></a><span id="l14.753">     rv = tmp;</span>
<a href="#l14.754"></a><span id="l14.754">   }</span>
<a href="#l14.755"></a><span id="l14.755">   return rv;</span>
<a href="#l14.756"></a><span id="l14.756"> }</span>
<a href="#l14.757"></a><span id="l14.757"> </span>
<a href="#l14.758"></a><span id="l14.758" class="difflineminus">-void</span>
<a href="#l14.759"></a><span id="l14.759" class="difflineminus">-nsSeamonkeyProfileMigrator::ReadBranch(const char *branchName,</span>
<a href="#l14.760"></a><span id="l14.760" class="difflineminus">-                                       nsIPrefService* aPrefService,</span>
<a href="#l14.761"></a><span id="l14.761" class="difflineminus">-                                       PBStructArray &amp;aPrefs)</span>
<a href="#l14.762"></a><span id="l14.762" class="difflineminus">-{</span>
<a href="#l14.763"></a><span id="l14.763" class="difflineplus">+void nsSeamonkeyProfileMigrator::ReadBranch(const char* branchName,</span>
<a href="#l14.764"></a><span id="l14.764" class="difflineplus">+                                            nsIPrefService* aPrefService,</span>
<a href="#l14.765"></a><span id="l14.765" class="difflineplus">+                                            PBStructArray&amp; aPrefs) {</span>
<a href="#l14.766"></a><span id="l14.766">   // Enumerate the branch</span>
<a href="#l14.767"></a><span id="l14.767">   nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span>
<a href="#l14.768"></a><span id="l14.768">   aPrefService-&gt;GetBranch(branchName, getter_AddRefs(branch));</span>
<a href="#l14.769"></a><span id="l14.769"> </span>
<a href="#l14.770"></a><span id="l14.770">   uint32_t count;</span>
<a href="#l14.771"></a><span id="l14.771">   char** prefs = nullptr;</span>
<a href="#l14.772"></a><span id="l14.772">   nsresult rv = branch-&gt;GetChildList(&quot;&quot;, &amp;count, &amp;prefs);</span>
<a href="#l14.773"></a><span id="l14.773" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l14.774"></a><span id="l14.774" class="difflineminus">-    return;</span>
<a href="#l14.775"></a><span id="l14.775" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l14.776"></a><span id="l14.776"> </span>
<a href="#l14.777"></a><span id="l14.777">   for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l14.778"></a><span id="l14.778">     // Save each pref's value into an array</span>
<a href="#l14.779"></a><span id="l14.779">     char* currPref = prefs[i];</span>
<a href="#l14.780"></a><span id="l14.780">     int32_t type;</span>
<a href="#l14.781"></a><span id="l14.781">     branch-&gt;GetPrefType(currPref, &amp;type);</span>
<a href="#l14.782"></a><span id="l14.782">     PrefBranchStruct* pref = new PrefBranchStruct;</span>
<a href="#l14.783"></a><span id="l14.783">     pref-&gt;prefName = currPref;</span>
<a href="#l14.784"></a><span id="l14.784">     pref-&gt;type = type;</span>
<a href="#l14.785"></a><span id="l14.785">     switch (type) {</span>
<a href="#l14.786"></a><span id="l14.786" class="difflineminus">-    case nsIPrefBranch::PREF_STRING: {</span>
<a href="#l14.787"></a><span id="l14.787" class="difflineminus">-      nsCString str;</span>
<a href="#l14.788"></a><span id="l14.788" class="difflineminus">-      rv = branch-&gt;GetCharPref(currPref, str);</span>
<a href="#l14.789"></a><span id="l14.789" class="difflineminus">-      pref-&gt;stringValue = moz_xstrdup(str.get());</span>
<a href="#l14.790"></a><span id="l14.790" class="difflineminus">-      break;</span>
<a href="#l14.791"></a><span id="l14.791" class="difflineminus">-    }</span>
<a href="#l14.792"></a><span id="l14.792" class="difflineminus">-    case nsIPrefBranch::PREF_BOOL:</span>
<a href="#l14.793"></a><span id="l14.793" class="difflineminus">-      rv = branch-&gt;GetBoolPref(currPref, &amp;pref-&gt;boolValue);</span>
<a href="#l14.794"></a><span id="l14.794" class="difflineminus">-      break;</span>
<a href="#l14.795"></a><span id="l14.795" class="difflineminus">-    case nsIPrefBranch::PREF_INT:</span>
<a href="#l14.796"></a><span id="l14.796" class="difflineminus">-      rv = branch-&gt;GetIntPref(currPref, &amp;pref-&gt;intValue);</span>
<a href="#l14.797"></a><span id="l14.797" class="difflineminus">-      break;</span>
<a href="#l14.798"></a><span id="l14.798" class="difflineminus">-    default:</span>
<a href="#l14.799"></a><span id="l14.799" class="difflineminus">-      NS_WARNING(&quot;Invalid Pref Type in &quot;</span>
<a href="#l14.800"></a><span id="l14.800" class="difflineminus">-                 &quot;nsNetscapeProfileMigratorBase::ReadBranch\n&quot;);</span>
<a href="#l14.801"></a><span id="l14.801" class="difflineminus">-      break;</span>
<a href="#l14.802"></a><span id="l14.802" class="difflineplus">+      case nsIPrefBranch::PREF_STRING: {</span>
<a href="#l14.803"></a><span id="l14.803" class="difflineplus">+        nsCString str;</span>
<a href="#l14.804"></a><span id="l14.804" class="difflineplus">+        rv = branch-&gt;GetCharPref(currPref, str);</span>
<a href="#l14.805"></a><span id="l14.805" class="difflineplus">+        pref-&gt;stringValue = moz_xstrdup(str.get());</span>
<a href="#l14.806"></a><span id="l14.806" class="difflineplus">+        break;</span>
<a href="#l14.807"></a><span id="l14.807" class="difflineplus">+      }</span>
<a href="#l14.808"></a><span id="l14.808" class="difflineplus">+      case nsIPrefBranch::PREF_BOOL:</span>
<a href="#l14.809"></a><span id="l14.809" class="difflineplus">+        rv = branch-&gt;GetBoolPref(currPref, &amp;pref-&gt;boolValue);</span>
<a href="#l14.810"></a><span id="l14.810" class="difflineplus">+        break;</span>
<a href="#l14.811"></a><span id="l14.811" class="difflineplus">+      case nsIPrefBranch::PREF_INT:</span>
<a href="#l14.812"></a><span id="l14.812" class="difflineplus">+        rv = branch-&gt;GetIntPref(currPref, &amp;pref-&gt;intValue);</span>
<a href="#l14.813"></a><span id="l14.813" class="difflineplus">+        break;</span>
<a href="#l14.814"></a><span id="l14.814" class="difflineplus">+      default:</span>
<a href="#l14.815"></a><span id="l14.815" class="difflineplus">+        NS_WARNING(</span>
<a href="#l14.816"></a><span id="l14.816" class="difflineplus">+            &quot;Invalid Pref Type in &quot;</span>
<a href="#l14.817"></a><span id="l14.817" class="difflineplus">+            &quot;nsNetscapeProfileMigratorBase::ReadBranch\n&quot;);</span>
<a href="#l14.818"></a><span id="l14.818" class="difflineplus">+        break;</span>
<a href="#l14.819"></a><span id="l14.819">     }</span>
<a href="#l14.820"></a><span id="l14.820"> </span>
<a href="#l14.821"></a><span id="l14.821" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l14.822"></a><span id="l14.822" class="difflineminus">-      aPrefs.AppendElement(pref);</span>
<a href="#l14.823"></a><span id="l14.823" class="difflineplus">+    if (NS_SUCCEEDED(rv)) aPrefs.AppendElement(pref);</span>
<a href="#l14.824"></a><span id="l14.824">   }</span>
<a href="#l14.825"></a><span id="l14.825"> }</span>
<a href="#l14.826"></a><span id="l14.826"> </span>
<a href="#l14.827"></a><span id="l14.827" class="difflineminus">-void</span>
<a href="#l14.828"></a><span id="l14.828" class="difflineminus">-nsSeamonkeyProfileMigrator::WriteBranch(const char *branchName,</span>
<a href="#l14.829"></a><span id="l14.829" class="difflineminus">-                                        nsIPrefService* aPrefService,</span>
<a href="#l14.830"></a><span id="l14.830" class="difflineminus">-                                        PBStructArray &amp;aPrefs)</span>
<a href="#l14.831"></a><span id="l14.831" class="difflineminus">-{</span>
<a href="#l14.832"></a><span id="l14.832" class="difflineplus">+void nsSeamonkeyProfileMigrator::WriteBranch(const char* branchName,</span>
<a href="#l14.833"></a><span id="l14.833" class="difflineplus">+                                             nsIPrefService* aPrefService,</span>
<a href="#l14.834"></a><span id="l14.834" class="difflineplus">+                                             PBStructArray&amp; aPrefs) {</span>
<a href="#l14.835"></a><span id="l14.835">   // Enumerate the branch</span>
<a href="#l14.836"></a><span id="l14.836">   nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span>
<a href="#l14.837"></a><span id="l14.837">   aPrefService-&gt;GetBranch(branchName, getter_AddRefs(branch));</span>
<a href="#l14.838"></a><span id="l14.838"> </span>
<a href="#l14.839"></a><span id="l14.839">   uint32_t count = aPrefs.Length();</span>
<a href="#l14.840"></a><span id="l14.840">   for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l14.841"></a><span id="l14.841">     PrefBranchStruct* pref = aPrefs.ElementAt(i);</span>
<a href="#l14.842"></a><span id="l14.842">     switch (pref-&gt;type) {</span>
<a href="#l14.843"></a><span id="l14.843" class="difflineminus">-    case nsIPrefBranch::PREF_STRING:</span>
<a href="#l14.844"></a><span id="l14.844" class="difflineminus">-      (void) branch-&gt;SetCharPref(pref-&gt;prefName,</span>
<a href="#l14.845"></a><span id="l14.845" class="difflineminus">-                                 nsDependentCString(pref-&gt;stringValue));</span>
<a href="#l14.846"></a><span id="l14.846" class="difflineminus">-      free(pref-&gt;stringValue);</span>
<a href="#l14.847"></a><span id="l14.847" class="difflineminus">-      pref-&gt;stringValue = nullptr;</span>
<a href="#l14.848"></a><span id="l14.848" class="difflineminus">-      break;</span>
<a href="#l14.849"></a><span id="l14.849" class="difflineminus">-    case nsIPrefBranch::PREF_BOOL:</span>
<a href="#l14.850"></a><span id="l14.850" class="difflineminus">-      (void) branch-&gt;SetBoolPref(pref-&gt;prefName, pref-&gt;boolValue);</span>
<a href="#l14.851"></a><span id="l14.851" class="difflineminus">-      break;</span>
<a href="#l14.852"></a><span id="l14.852" class="difflineminus">-    case nsIPrefBranch::PREF_INT:</span>
<a href="#l14.853"></a><span id="l14.853" class="difflineminus">-      (void) branch-&gt;SetIntPref(pref-&gt;prefName, pref-&gt;intValue);</span>
<a href="#l14.854"></a><span id="l14.854" class="difflineminus">-      break;</span>
<a href="#l14.855"></a><span id="l14.855" class="difflineminus">-    default:</span>
<a href="#l14.856"></a><span id="l14.856" class="difflineminus">-      NS_WARNING(&quot;Invalid Pref Type in &quot;</span>
<a href="#l14.857"></a><span id="l14.857" class="difflineminus">-                 &quot;nsNetscapeProfileMigratorBase::WriteBranch\n&quot;);</span>
<a href="#l14.858"></a><span id="l14.858" class="difflineminus">-      break;</span>
<a href="#l14.859"></a><span id="l14.859" class="difflineplus">+      case nsIPrefBranch::PREF_STRING:</span>
<a href="#l14.860"></a><span id="l14.860" class="difflineplus">+        (void)branch-&gt;SetCharPref(pref-&gt;prefName,</span>
<a href="#l14.861"></a><span id="l14.861" class="difflineplus">+                                  nsDependentCString(pref-&gt;stringValue));</span>
<a href="#l14.862"></a><span id="l14.862" class="difflineplus">+        free(pref-&gt;stringValue);</span>
<a href="#l14.863"></a><span id="l14.863" class="difflineplus">+        pref-&gt;stringValue = nullptr;</span>
<a href="#l14.864"></a><span id="l14.864" class="difflineplus">+        break;</span>
<a href="#l14.865"></a><span id="l14.865" class="difflineplus">+      case nsIPrefBranch::PREF_BOOL:</span>
<a href="#l14.866"></a><span id="l14.866" class="difflineplus">+        (void)branch-&gt;SetBoolPref(pref-&gt;prefName, pref-&gt;boolValue);</span>
<a href="#l14.867"></a><span id="l14.867" class="difflineplus">+        break;</span>
<a href="#l14.868"></a><span id="l14.868" class="difflineplus">+      case nsIPrefBranch::PREF_INT:</span>
<a href="#l14.869"></a><span id="l14.869" class="difflineplus">+        (void)branch-&gt;SetIntPref(pref-&gt;prefName, pref-&gt;intValue);</span>
<a href="#l14.870"></a><span id="l14.870" class="difflineplus">+        break;</span>
<a href="#l14.871"></a><span id="l14.871" class="difflineplus">+      default:</span>
<a href="#l14.872"></a><span id="l14.872" class="difflineplus">+        NS_WARNING(</span>
<a href="#l14.873"></a><span id="l14.873" class="difflineplus">+            &quot;Invalid Pref Type in &quot;</span>
<a href="#l14.874"></a><span id="l14.874" class="difflineplus">+            &quot;nsNetscapeProfileMigratorBase::WriteBranch\n&quot;);</span>
<a href="#l14.875"></a><span id="l14.875" class="difflineplus">+        break;</span>
<a href="#l14.876"></a><span id="l14.876">     }</span>
<a href="#l14.877"></a><span id="l14.877">     free(pref-&gt;prefName);</span>
<a href="#l14.878"></a><span id="l14.878">     pref-&gt;prefName = nullptr;</span>
<a href="#l14.879"></a><span id="l14.879">     delete pref;</span>
<a href="#l14.880"></a><span id="l14.880">     pref = nullptr;</span>
<a href="#l14.881"></a><span id="l14.881">   }</span>
<a href="#l14.882"></a><span id="l14.882">   aPrefs.Clear();</span>
<a href="#l14.883"></a><span id="l14.883"> }</span>
<a href="#l14.884"></a><span id="l14.884"> </span>
<a href="#l14.885"></a><span id="l14.885" class="difflineminus">-nsresult nsSeamonkeyProfileMigrator::DummyCopyRoutine(bool aReplace)</span>
<a href="#l14.886"></a><span id="l14.886" class="difflineminus">-{</span>
<a href="#l14.887"></a><span id="l14.887" class="difflineminus">-  // place holder function only to fake the UI out into showing some migration process.</span>
<a href="#l14.888"></a><span id="l14.888" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::DummyCopyRoutine(bool aReplace) {</span>
<a href="#l14.889"></a><span id="l14.889" class="difflineplus">+  // place holder function only to fake the UI out into showing some migration</span>
<a href="#l14.890"></a><span id="l14.890" class="difflineplus">+  // process.</span>
<a href="#l14.891"></a><span id="l14.891">   return NS_OK;</span>
<a href="#l14.892"></a><span id="l14.892"> }</span>
<a href="#l14.893"></a><span id="l14.893"> </span>
<a href="#l14.894"></a><span id="l14.894" class="difflineminus">-nsresult</span>
<a href="#l14.895"></a><span id="l14.895" class="difflineminus">-nsSeamonkeyProfileMigrator::CopyJunkTraining(bool aReplace)</span>
<a href="#l14.896"></a><span id="l14.896" class="difflineminus">-{</span>
<a href="#l14.897"></a><span id="l14.897" class="difflineminus">-  return aReplace ? CopyFile(FILE_NAME_JUNKTRAINING, FILE_NAME_JUNKTRAINING) : NS_OK;</span>
<a href="#l14.898"></a><span id="l14.898" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::CopyJunkTraining(bool aReplace) {</span>
<a href="#l14.899"></a><span id="l14.899" class="difflineplus">+  return aReplace ? CopyFile(FILE_NAME_JUNKTRAINING, FILE_NAME_JUNKTRAINING)</span>
<a href="#l14.900"></a><span id="l14.900" class="difflineplus">+                  : NS_OK;</span>
<a href="#l14.901"></a><span id="l14.901"> }</span>
<a href="#l14.902"></a><span id="l14.902"> </span>
<a href="#l14.903"></a><span id="l14.903" class="difflineminus">-nsresult</span>
<a href="#l14.904"></a><span id="l14.904" class="difflineminus">-nsSeamonkeyProfileMigrator::CopyPasswords(bool aReplace)</span>
<a href="#l14.905"></a><span id="l14.905" class="difflineminus">-{</span>
<a href="#l14.906"></a><span id="l14.906" class="difflineplus">+nsresult nsSeamonkeyProfileMigrator::CopyPasswords(bool aReplace) {</span>
<a href="#l14.907"></a><span id="l14.907">   nsresult rv = NS_OK;</span>
<a href="#l14.908"></a><span id="l14.908"> </span>
<a href="#l14.909"></a><span id="l14.909">   nsCString signonsFileName;</span>
<a href="#l14.910"></a><span id="l14.910">   GetSignonFileName(aReplace, signonsFileName);</span>
<a href="#l14.911"></a><span id="l14.911"> </span>
<a href="#l14.912"></a><span id="l14.912" class="difflineminus">-  if (signonsFileName.IsEmpty())</span>
<a href="#l14.913"></a><span id="l14.913" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l14.914"></a><span id="l14.914" class="difflineplus">+  if (signonsFileName.IsEmpty()) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l14.915"></a><span id="l14.915"> </span>
<a href="#l14.916"></a><span id="l14.916">   nsAutoString fileName;</span>
<a href="#l14.917"></a><span id="l14.917">   CopyASCIItoUTF16(signonsFileName, fileName);</span>
<a href="#l14.918"></a><span id="l14.918">   if (aReplace)</span>
<a href="#l14.919"></a><span id="l14.919">     rv = CopyFile(fileName, fileName);</span>
<a href="#l14.920"></a><span id="l14.920">   else {</span>
<a href="#l14.921"></a><span id="l14.921">     // don't do anything right now</span>
<a href="#l14.922"></a><span id="l14.922">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/components/migration/src/nsSeamonkeyProfileMigrator.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/components/migration/src/nsSeamonkeyProfileMigrator.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -8,52 +8,51 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsIMailProfileMigrator.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsNetscapeProfileMigratorBase.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> class nsIPrefBranch;</span>
<a href="#l15.10"></a><span id="l15.10"> class nsIPrefService;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-class nsSeamonkeyProfileMigrator : public nsNetscapeProfileMigratorBase</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-public:</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+class nsSeamonkeyProfileMigrator : public nsNetscapeProfileMigratorBase {</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ public:</span>
<a href="#l15.17"></a><span id="l15.17">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">   nsSeamonkeyProfileMigrator();</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21">   // nsIMailProfileMigrator methods</span>
<a href="#l15.22"></a><span id="l15.22">   NS_IMETHOD Migrate(uint16_t aItems, nsIProfileStartup* aStartup,</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-                        const char16_t* aProfile) override;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+                     const char16_t* aProfile) override;</span>
<a href="#l15.25"></a><span id="l15.25">   NS_IMETHOD GetMigrateData(const char16_t* aProfile, bool aReplace,</span>
<a href="#l15.26"></a><span id="l15.26">                             uint16_t* aResult) override;</span>
<a href="#l15.27"></a><span id="l15.27">   NS_IMETHOD GetSourceProfiles(nsIArray** aResult) override;</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-protected:</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+ protected:</span>
<a href="#l15.31"></a><span id="l15.31">   virtual ~nsSeamonkeyProfileMigrator();</span>
<a href="#l15.32"></a><span id="l15.32">   nsresult FillProfileDataFromSeamonkeyRegistry();</span>
<a href="#l15.33"></a><span id="l15.33">   nsresult GetSourceProfile(const char16_t* aProfile);</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">   nsresult CopyPreferences(bool aReplace);</span>
<a href="#l15.36"></a><span id="l15.36">   nsresult TransformPreferences(const nsAString&amp; aSourcePrefFileName,</span>
<a href="#l15.37"></a><span id="l15.37">                                 const nsAString&amp; aTargetPrefFileName);</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39">   nsresult DummyCopyRoutine(bool aReplace);</span>
<a href="#l15.40"></a><span id="l15.40">   nsresult CopyJunkTraining(bool aReplace);</span>
<a href="#l15.41"></a><span id="l15.41">   nsresult CopyPasswords(bool aReplace);</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-  nsresult CopyMailFolders(PBStructArray &amp;aMailServers,</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+  nsresult CopyMailFolders(PBStructArray&amp; aMailServers,</span>
<a href="#l15.44"></a><span id="l15.44">                            nsIPrefService* aPrefBranch);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-  nsresult CopyAddressBookDirectories(PBStructArray &amp;aLdapServers,</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  nsresult CopyAddressBookDirectories(PBStructArray&amp; aLdapServers,</span>
<a href="#l15.47"></a><span id="l15.47">                                       nsIPrefService* aPrefService);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  nsresult CopySignatureFiles(PBStructArray &amp;aIdentities,</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  nsresult CopySignatureFiles(PBStructArray&amp; aIdentities,</span>
<a href="#l15.50"></a><span id="l15.50">                               nsIPrefService* aPrefBranch);</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-  void ReadBranch(const char *branchName,  nsIPrefService *aPrefService,</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-                  PBStructArray &amp;aPrefs);</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-  void WriteBranch(const char *branchName, nsIPrefService *aPrefService,</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-                   PBStructArray &amp;aPrefs);</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  void ReadBranch(const char* branchName, nsIPrefService* aPrefService,</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+                  PBStructArray&amp; aPrefs);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+  void WriteBranch(const char* branchName, nsIPrefService* aPrefService,</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+                   PBStructArray&amp; aPrefs);</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-private:</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+ private:</span>
<a href="#l15.63"></a><span id="l15.63">   nsCOMPtr&lt;nsIMutableArray&gt; mProfileNames;</span>
<a href="#l15.64"></a><span id="l15.64">   nsCOMPtr&lt;nsIMutableArray&gt; mProfileLocations;</span>
<a href="#l15.65"></a><span id="l15.65"> };</span>
<a href="#l15.66"></a><span id="l15.66"> </span>
<a href="#l15.67"></a><span id="l15.67"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/search/mdimporter/GetMetadataForFile.c</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/search/mdimporter/GetMetadataForFile.c</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,86 +1,76 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: C; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.5"></a><span id="l16.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-* License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">-* file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12"> #include &lt;CoreFoundation/CoreFoundation.h&gt;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &lt;CoreServices/CoreServices.h&gt;</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-</span>
<a href="#l16.16"></a><span id="l16.16"> /* -----------------------------------------------------------------------------</span>
<a href="#l16.17"></a><span id="l16.17">     Get metadata attributes from file</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">    This function's job is to extract useful information from the .mozeml file</span>
<a href="#l16.20"></a><span id="l16.20">    and return it as a dictionary</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-   ----------------------------------------------------------------------------- */</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+   -----------------------------------------------------------------------------</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+ */</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25"> Boolean GetMetadataForFile(void* thisInterface,</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-			   CFMutableDictionaryRef attributes,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-			   CFStringRef contentTypeUTI,</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-			   CFStringRef pathToFile)</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-{</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-    /* Pull any available metadata from the file at the specified path */</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-    /* Return the attribute keys and attribute values in the dict */</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-    /* Return TRUE if successful, FALSE if there was no data provided */</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+                           CFMutableDictionaryRef attributes,</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+                           CFStringRef contentTypeUTI, CFStringRef pathToFile) {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  /* Pull any available metadata from the file at the specified path */</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  /* Return the attribute keys and attribute values in the dict */</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+  /* Return TRUE if successful, FALSE if there was no data provided */</span>
<a href="#l16.38"></a><span id="l16.38">   Boolean success;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-  CFURLRef fileURL = CFURLCreateWithFileSystemPath(kCFAllocatorDefault, pathToFile, kCFURLPOSIXPathStyle, false);</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-  CFReadStreamRef stream = CFReadStreamCreateWithFile(kCFAllocatorDefault, fileURL);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+  CFURLRef fileURL = CFURLCreateWithFileSystemPath(</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+      kCFAllocatorDefault, pathToFile, kCFURLPOSIXPathStyle, false);</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+  CFReadStreamRef stream =</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+      CFReadStreamCreateWithFile(kCFAllocatorDefault, fileURL);</span>
<a href="#l16.45"></a><span id="l16.45">   CFReadStreamOpen(stream);</span>
<a href="#l16.46"></a><span id="l16.46"> </span>
<a href="#l16.47"></a><span id="l16.47">   CFErrorRef err = NULL;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-  CFPropertyListRef ticket = CFPropertyListCreateWithStream(kCFAllocatorDefault,</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-                             stream,</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-                             /*streamLength*/ 0,</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-                             kCFPropertyListImmutable,</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-                             NULL,</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-                             &amp;err</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-                             );</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-   if (err != NULL)</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-   {</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-       CFStringRef errorString = CFErrorCopyDescription(err);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-       if (errorString != NULL) {</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-         printf(&quot;failed creating property list from stream\n&quot;);</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-         printf(&quot;error = %s\n&quot;, (const char*) errorString);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-       }</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-       CFRelease (err);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-       success = FALSE;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-   }</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-  else</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  {</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+  CFPropertyListRef ticket = CFPropertyListCreateWithStream(</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+      kCFAllocatorDefault, stream,</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+      /*streamLength*/ 0, kCFPropertyListImmutable, NULL, &amp;err);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+  if (err != NULL) {</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+    CFStringRef errorString = CFErrorCopyDescription(err);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+    if (errorString != NULL) {</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+      printf(&quot;failed creating property list from stream\n&quot;);</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+      printf(&quot;error = %s\n&quot;, (const char*)errorString);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+    }</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+    CFRelease(err);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+    success = FALSE;</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  } else {</span>
<a href="#l16.79"></a><span id="l16.79">     CFTypeRef value;</span>
<a href="#l16.80"></a><span id="l16.80">     value = CFDictionaryGetValue(ticket, kMDItemTitle);</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-     if (value)</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-     {</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-       CFDictionarySetValue(attributes, kMDItemTitle, value);</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-     }</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-     value = CFDictionaryGetValue(ticket, kMDItemTextContent);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-     if (value)</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-     {</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-       CFDictionarySetValue(attributes, kMDItemTextContent, value);</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-     }</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-     value = CFDictionaryGetValue(ticket, kMDItemDisplayName);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-     if (value)</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-       CFDictionarySetValue(attributes, kMDItemDisplayName, value);</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+    if (value) {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+      CFDictionarySetValue(attributes, kMDItemTitle, value);</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    }</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+    value = CFDictionaryGetValue(ticket, kMDItemTextContent);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+    if (value) {</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+      CFDictionarySetValue(attributes, kMDItemTextContent, value);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+    }</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+    value = CFDictionaryGetValue(ticket, kMDItemDisplayName);</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+    if (value) CFDictionarySetValue(attributes, kMDItemDisplayName, value);</span>
<a href="#l16.102"></a><span id="l16.102"> </span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-     CFDateFormatterRef dateFormatter = CFDateFormatterCreate(NULL, NULL, kCFDateFormatterLongStyle, kCFDateFormatterLongStyle);</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+    CFDateFormatterRef dateFormatter = CFDateFormatterCreate(</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+        NULL, NULL, kCFDateFormatterLongStyle, kCFDateFormatterLongStyle);</span>
<a href="#l16.106"></a><span id="l16.106"> </span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-     value = CFDictionaryGetValue(ticket, kMDItemLastUsedDate);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+    value = CFDictionaryGetValue(ticket, kMDItemLastUsedDate);</span>
<a href="#l16.109"></a><span id="l16.109"> </span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-     if (value &amp;&amp; dateFormatter)</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-     {</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-       printf(&quot;trying to parse date \n&quot;);</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-       CFDateRef curDate = CFDateFormatterCreateDateFromString(NULL, dateFormatter, value, NULL);</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-       printf(&quot;got cur date\n&quot;);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-       if (curDate)</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-         CFDictionarySetValue(attributes, kMDItemLastUsedDate, curDate);</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-     }</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-     success = TRUE;</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+    if (value &amp;&amp; dateFormatter) {</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+      printf(&quot;trying to parse date \n&quot;);</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+      CFDateRef curDate =</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+          CFDateFormatterCreateDateFromString(NULL, dateFormatter, value, NULL);</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+      printf(&quot;got cur date\n&quot;);</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+      if (curDate)</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+        CFDictionarySetValue(attributes, kMDItemLastUsedDate, curDate);</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+    }</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+    success = TRUE;</span>
<a href="#l16.128"></a><span id="l16.128">   }</span>
<a href="#l16.129"></a><span id="l16.129">   // contents are kMDItemTextContent</span>
<a href="#l16.130"></a><span id="l16.130"> </span>
<a href="#l16.131"></a><span id="l16.131">   CFReadStreamClose(stream);</span>
<a href="#l16.132"></a><span id="l16.132">   CFRelease(stream);</span>
<a href="#l16.133"></a><span id="l16.133">   CFRelease(fileURL);</span>
<a href="#l16.134"></a><span id="l16.134">   return success;</span>
<a href="#l16.135"></a><span id="l16.135"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/search/mdimporter/main.c</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/search/mdimporter/main.c</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,217 +1,208 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* -*- Mode: C; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l17.5"></a><span id="l17.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-* License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">-* file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.12"></a><span id="l17.12"> </span>
<a href="#l17.13"></a><span id="l17.13"> //==============================================================================</span>
<a href="#l17.14"></a><span id="l17.14"> //</span>
<a href="#l17.15"></a><span id="l17.15"> //	DO NO MODIFY THE CONTENT OF THIS FILE</span>
<a href="#l17.16"></a><span id="l17.16"> //</span>
<a href="#l17.17"></a><span id="l17.17"> //	This file contains the generic CFPlug-in code necessary for TB Spotlight</span>
<a href="#l17.18"></a><span id="l17.18"> //	The actual importer is implemented in GetMetadataForFile.c</span>
<a href="#l17.19"></a><span id="l17.19"> //</span>
<a href="#l17.20"></a><span id="l17.20"> //==============================================================================</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-</span>
<a href="#l17.24"></a><span id="l17.24"> #include &lt;CoreFoundation/CoreFoundation.h&gt;</span>
<a href="#l17.25"></a><span id="l17.25"> #include &lt;CoreFoundation/CFPlugInCOM.h&gt;</span>
<a href="#l17.26"></a><span id="l17.26"> #include &lt;CoreServices/CoreServices.h&gt;</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28"> // -----------------------------------------------------------------------------</span>
<a href="#l17.29"></a><span id="l17.29"> //	constants</span>
<a href="#l17.30"></a><span id="l17.30"> // -----------------------------------------------------------------------------</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-</span>
<a href="#l17.33"></a><span id="l17.33"> #define PLUGIN_ID &quot;37401ADE-1058-42DB-BBE5-F2AAB9D7C13E&quot;</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35"> //</span>
<a href="#l17.36"></a><span id="l17.36"> // Below is the generic glue code for all plug-ins.</span>
<a href="#l17.37"></a><span id="l17.37"> //</span>
<a href="#l17.38"></a><span id="l17.38"> // You should not have to modify this code aside from changing</span>
<a href="#l17.39"></a><span id="l17.39"> // names if you decide to change the names defined in the Info.plist</span>
<a href="#l17.40"></a><span id="l17.40"> //</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-</span>
<a href="#l17.43"></a><span id="l17.43"> // -----------------------------------------------------------------------------</span>
<a href="#l17.44"></a><span id="l17.44"> //	typedefs</span>
<a href="#l17.45"></a><span id="l17.45"> // -----------------------------------------------------------------------------</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47"> // The import function to be implemented in GetMetadataForFile.c</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-Boolean GetMetadataForFile(void *thisInterface, </span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-			   CFMutableDictionaryRef attributes, </span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-			   CFStringRef contentTypeUTI,</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-			   CFStringRef pathToFile);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-			   </span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-// The layout for an instance of MetaDataImporterPlugIn </span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-typedef struct __MetadataImporterPluginType</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-{</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-    MDImporterInterfaceStruct *conduitInterface;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-    CFUUIDRef                 factoryID;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-    UInt32                    refCount;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+Boolean GetMetadataForFile(void *thisInterface,</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+                           CFMutableDictionaryRef attributes,</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+                           CFStringRef contentTypeUTI, CFStringRef pathToFile);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+// The layout for an instance of MetaDataImporterPlugIn</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+typedef struct __MetadataImporterPluginType {</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  MDImporterInterfaceStruct *conduitInterface;</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+  CFUUIDRef factoryID;</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  UInt32 refCount;</span>
<a href="#l17.68"></a><span id="l17.68"> } MetadataImporterPluginType;</span>
<a href="#l17.69"></a><span id="l17.69"> </span>
<a href="#l17.70"></a><span id="l17.70"> // -----------------------------------------------------------------------------</span>
<a href="#l17.71"></a><span id="l17.71"> //	prototypes</span>
<a href="#l17.72"></a><span id="l17.72"> // -----------------------------------------------------------------------------</span>
<a href="#l17.73"></a><span id="l17.73"> //	Forward declaration for the IUnknown implementation.</span>
<a href="#l17.74"></a><span id="l17.74"> //</span>
<a href="#l17.75"></a><span id="l17.75"> </span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-MetadataImporterPluginType  *AllocMetadataImporterPluginType(CFUUIDRef inFactoryID);</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-void                      DeallocMetadataImporterPluginType(MetadataImporterPluginType *thisInstance);</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-HRESULT                   MetadataImporterQueryInterface(void *thisInstance,REFIID iid,LPVOID *ppv);</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-void                     *MetadataImporterPluginFactory(CFAllocatorRef allocator,CFUUIDRef typeID);</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-ULONG                     MetadataImporterPluginAddRef(void *thisInstance);</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-ULONG                     MetadataImporterPluginRelease(void *thisInstance);</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+MetadataImporterPluginType *AllocMetadataImporterPluginType(</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+    CFUUIDRef inFactoryID);</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+void DeallocMetadataImporterPluginType(</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+    MetadataImporterPluginType *thisInstance);</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+HRESULT MetadataImporterQueryInterface(void *thisInstance, REFIID iid,</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+                                       LPVOID *ppv);</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+void *MetadataImporterPluginFactory(CFAllocatorRef allocator, CFUUIDRef typeID);</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+ULONG MetadataImporterPluginAddRef(void *thisInstance);</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+ULONG MetadataImporterPluginRelease(void *thisInstance);</span>
<a href="#l17.91"></a><span id="l17.91"> // -----------------------------------------------------------------------------</span>
<a href="#l17.92"></a><span id="l17.92"> //	testInterfaceFtbl	definition</span>
<a href="#l17.93"></a><span id="l17.93"> // -----------------------------------------------------------------------------</span>
<a href="#l17.94"></a><span id="l17.94"> //	The TestInterface function table.</span>
<a href="#l17.95"></a><span id="l17.95"> //</span>
<a href="#l17.96"></a><span id="l17.96"> </span>
<a href="#l17.97"></a><span id="l17.97"> static MDImporterInterfaceStruct testInterfaceFtbl = {</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-    NULL,</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-    MetadataImporterQueryInterface,</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-    MetadataImporterPluginAddRef,</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-    MetadataImporterPluginRelease,</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-    GetMetadataForFile</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-};</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+    NULL, MetadataImporterQueryInterface, MetadataImporterPluginAddRef,</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+    MetadataImporterPluginRelease, GetMetadataForFile};</span>
<a href="#l17.107"></a><span id="l17.107"> </span>
<a href="#l17.108"></a><span id="l17.108"> // -----------------------------------------------------------------------------</span>
<a href="#l17.109"></a><span id="l17.109"> //	AllocMetadataImporterPluginType</span>
<a href="#l17.110"></a><span id="l17.110"> // -----------------------------------------------------------------------------</span>
<a href="#l17.111"></a><span id="l17.111"> //	Utility function that allocates a new instance.</span>
<a href="#l17.112"></a><span id="l17.112"> //      You can do some initial setup for the importer here if you wish</span>
<a href="#l17.113"></a><span id="l17.113"> //      like allocating globals etc...</span>
<a href="#l17.114"></a><span id="l17.114"> //</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-MetadataImporterPluginType *AllocMetadataImporterPluginType(CFUUIDRef inFactoryID)</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-{</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-    MetadataImporterPluginType *theNewInstance;</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+MetadataImporterPluginType *AllocMetadataImporterPluginType(</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+    CFUUIDRef inFactoryID) {</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+  MetadataImporterPluginType *theNewInstance;</span>
<a href="#l17.121"></a><span id="l17.121"> </span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-    theNewInstance = (MetadataImporterPluginType *)malloc(sizeof(MetadataImporterPluginType));</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-    memset(theNewInstance,0,sizeof(MetadataImporterPluginType));</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+  theNewInstance =</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+      (MetadataImporterPluginType *)malloc(sizeof(MetadataImporterPluginType));</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+  memset(theNewInstance, 0, sizeof(MetadataImporterPluginType));</span>
<a href="#l17.127"></a><span id="l17.127"> </span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-        /* Point to the function table */</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-    theNewInstance-&gt;conduitInterface = &amp;testInterfaceFtbl;</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+  /* Point to the function table */</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+  theNewInstance-&gt;conduitInterface = &amp;testInterfaceFtbl;</span>
<a href="#l17.132"></a><span id="l17.132"> </span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-        /*  Retain and keep an open instance refcount for each factory. */</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-    theNewInstance-&gt;factoryID = CFRetain(inFactoryID);</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-    CFPlugInAddInstanceForFactory(inFactoryID);</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+  /*  Retain and keep an open instance refcount for each factory. */</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+  theNewInstance-&gt;factoryID = CFRetain(inFactoryID);</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+  CFPlugInAddInstanceForFactory(inFactoryID);</span>
<a href="#l17.139"></a><span id="l17.139"> </span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-        /* This function returns the IUnknown interface so set the refCount to one. */</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-    theNewInstance-&gt;refCount = 1;</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-    return theNewInstance;</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+  /* This function returns the IUnknown interface so set the refCount to one. */</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+  theNewInstance-&gt;refCount = 1;</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+  return theNewInstance;</span>
<a href="#l17.146"></a><span id="l17.146"> }</span>
<a href="#l17.147"></a><span id="l17.147"> </span>
<a href="#l17.148"></a><span id="l17.148"> // -----------------------------------------------------------------------------</span>
<a href="#l17.149"></a><span id="l17.149"> //	DeallocTBSpotlightMDImporterPluginType</span>
<a href="#l17.150"></a><span id="l17.150"> // -----------------------------------------------------------------------------</span>
<a href="#l17.151"></a><span id="l17.151"> //	Utility function that deallocates the instance when</span>
<a href="#l17.152"></a><span id="l17.152"> //	the refCount goes to zero.</span>
<a href="#l17.153"></a><span id="l17.153"> //      In the current implementation importer interfaces are never deallocated</span>
<a href="#l17.154"></a><span id="l17.154"> //      but implement this as this might change in the future</span>
<a href="#l17.155"></a><span id="l17.155"> //</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-void DeallocMetadataImporterPluginType(MetadataImporterPluginType *thisInstance)</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-{</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-    CFUUIDRef theFactoryID;</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+void DeallocMetadataImporterPluginType(</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+    MetadataImporterPluginType *thisInstance) {</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+  CFUUIDRef theFactoryID;</span>
<a href="#l17.162"></a><span id="l17.162"> </span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-    theFactoryID = thisInstance-&gt;factoryID;</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-    free(thisInstance);</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-    if (theFactoryID){</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineminus">-        CFPlugInRemoveInstanceForFactory(theFactoryID);</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-        CFRelease(theFactoryID);</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-    }</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+  theFactoryID = thisInstance-&gt;factoryID;</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+  free(thisInstance);</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+  if (theFactoryID) {</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+    CFPlugInRemoveInstanceForFactory(theFactoryID);</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+    CFRelease(theFactoryID);</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+  }</span>
<a href="#l17.175"></a><span id="l17.175"> }</span>
<a href="#l17.176"></a><span id="l17.176"> </span>
<a href="#l17.177"></a><span id="l17.177"> // -----------------------------------------------------------------------------</span>
<a href="#l17.178"></a><span id="l17.178"> //	MetadataImporterQueryInterface</span>
<a href="#l17.179"></a><span id="l17.179"> // -----------------------------------------------------------------------------</span>
<a href="#l17.180"></a><span id="l17.180"> //	Implementation of the IUnknown QueryInterface function.</span>
<a href="#l17.181"></a><span id="l17.181"> //</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-HRESULT MetadataImporterQueryInterface(void *thisInstance,REFIID iid,LPVOID *ppv)</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-{</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-    CFUUIDRef interfaceID;</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+HRESULT MetadataImporterQueryInterface(void *thisInstance, REFIID iid,</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+                                       LPVOID *ppv) {</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+  CFUUIDRef interfaceID;</span>
<a href="#l17.188"></a><span id="l17.188"> </span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-    interfaceID = CFUUIDCreateFromUUIDBytes(kCFAllocatorDefault,iid);</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+  interfaceID = CFUUIDCreateFromUUIDBytes(kCFAllocatorDefault, iid);</span>
<a href="#l17.191"></a><span id="l17.191"> </span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-    if (CFEqual(interfaceID,kMDImporterInterfaceID)){</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-            /* If the Right interface was requested, bump the ref count,</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineminus">-             * set the ppv parameter equal to the instance, and</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-             * return good status.</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-             */</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-        ((MetadataImporterPluginType*)thisInstance)-&gt;conduitInterface-&gt;AddRef(thisInstance);</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-        *ppv = thisInstance;</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-        CFRelease(interfaceID);</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-        return S_OK;</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-    }else{</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-        if (CFEqual(interfaceID,IUnknownUUID)){</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-                /* If the IUnknown interface was requested, same as above. */</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-            ((MetadataImporterPluginType*)thisInstance )-&gt;conduitInterface-&gt;AddRef(thisInstance);</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-            *ppv = thisInstance;</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-            CFRelease(interfaceID);</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-            return S_OK;</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-        }else{</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineminus">-                /* Requested interface unknown, bail with error. */</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-            *ppv = NULL;</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-            CFRelease(interfaceID);</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-            return E_NOINTERFACE;</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-        }</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+  if (CFEqual(interfaceID, kMDImporterInterfaceID)) {</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+    /* If the Right interface was requested, bump the ref count,</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+     * set the ppv parameter equal to the instance, and</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+     * return good status.</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+     */</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+    ((MetadataImporterPluginType *)thisInstance)</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+        -&gt;conduitInterface-&gt;AddRef(thisInstance);</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+    *ppv = thisInstance;</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+    CFRelease(interfaceID);</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+    return S_OK;</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+  } else {</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+    if (CFEqual(interfaceID, IUnknownUUID)) {</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+      /* If the IUnknown interface was requested, same as above. */</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+      ((MetadataImporterPluginType *)thisInstance)</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+          -&gt;conduitInterface-&gt;AddRef(thisInstance);</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+      *ppv = thisInstance;</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineplus">+      CFRelease(interfaceID);</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+      return S_OK;</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineplus">+    } else {</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+      /* Requested interface unknown, bail with error. */</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+      *ppv = NULL;</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+      CFRelease(interfaceID);</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+      return E_NOINTERFACE;</span>
<a href="#l17.237"></a><span id="l17.237">     }</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+  }</span>
<a href="#l17.239"></a><span id="l17.239"> }</span>
<a href="#l17.240"></a><span id="l17.240"> </span>
<a href="#l17.241"></a><span id="l17.241"> // -----------------------------------------------------------------------------</span>
<a href="#l17.242"></a><span id="l17.242"> //	MetadataImporterPluginAddRef</span>
<a href="#l17.243"></a><span id="l17.243"> // -----------------------------------------------------------------------------</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-//	Implementation of reference counting for this type. Whenever an interface</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-//	is requested, bump the refCount for the instance. NOTE: returning the</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-//	refcount is a convention but is not required so don't rely on it.</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+//	Implementation of reference counting for this type. Whenever an</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+//interface 	is requested, bump the refCount for the instance. NOTE: returning</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+//the 	refcount is a convention but is not required so don't rely on it.</span>
<a href="#l17.250"></a><span id="l17.250"> //</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineminus">-ULONG MetadataImporterPluginAddRef(void *thisInstance)</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineminus">-{</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineminus">-    ((MetadataImporterPluginType *)thisInstance )-&gt;refCount += 1;</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineminus">-    return ((MetadataImporterPluginType*) thisInstance)-&gt;refCount;</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+ULONG MetadataImporterPluginAddRef(void *thisInstance) {</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+  ((MetadataImporterPluginType *)thisInstance)-&gt;refCount += 1;</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+  return ((MetadataImporterPluginType *)thisInstance)-&gt;refCount;</span>
<a href="#l17.258"></a><span id="l17.258"> }</span>
<a href="#l17.259"></a><span id="l17.259"> </span>
<a href="#l17.260"></a><span id="l17.260"> // -----------------------------------------------------------------------------</span>
<a href="#l17.261"></a><span id="l17.261"> // SampleCMPluginRelease</span>
<a href="#l17.262"></a><span id="l17.262"> // -----------------------------------------------------------------------------</span>
<a href="#l17.263"></a><span id="l17.263"> //	When an interface is released, decrement the refCount.</span>
<a href="#l17.264"></a><span id="l17.264"> //	If the refCount goes to zero, deallocate the instance.</span>
<a href="#l17.265"></a><span id="l17.265"> //</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-ULONG MetadataImporterPluginRelease(void *thisInstance)</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-{</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-    ((MetadataImporterPluginType*)thisInstance)-&gt;refCount -= 1;</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-    if (((MetadataImporterPluginType*)thisInstance)-&gt;refCount == 0){</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-        DeallocMetadataImporterPluginType((MetadataImporterPluginType*)thisInstance );</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineminus">-        return 0;</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineminus">-    }else{</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineminus">-        return ((MetadataImporterPluginType*) thisInstance )-&gt;refCount;</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineminus">-    }</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineplus">+ULONG MetadataImporterPluginRelease(void *thisInstance) {</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+  ((MetadataImporterPluginType *)thisInstance)-&gt;refCount -= 1;</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+  if (((MetadataImporterPluginType *)thisInstance)-&gt;refCount == 0) {</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+    DeallocMetadataImporterPluginType(</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+        (MetadataImporterPluginType *)thisInstance);</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineplus">+    return 0;</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+  } else {</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+    return ((MetadataImporterPluginType *)thisInstance)-&gt;refCount;</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineplus">+  }</span>
<a href="#l17.284"></a><span id="l17.284"> }</span>
<a href="#l17.285"></a><span id="l17.285"> </span>
<a href="#l17.286"></a><span id="l17.286"> // -----------------------------------------------------------------------------</span>
<a href="#l17.287"></a><span id="l17.287"> //	TBSpotlightMDImporterPluginFactory</span>
<a href="#l17.288"></a><span id="l17.288"> // -----------------------------------------------------------------------------</span>
<a href="#l17.289"></a><span id="l17.289"> //	Implementation of the factory function for this type.</span>
<a href="#l17.290"></a><span id="l17.290"> //</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineminus">-void *MetadataImporterPluginFactory(CFAllocatorRef allocator,CFUUIDRef typeID)</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineminus">-{</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineminus">-    MetadataImporterPluginType *result;</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineminus">-    CFUUIDRef                 uuid;</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+void *MetadataImporterPluginFactory(CFAllocatorRef allocator,</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineplus">+                                    CFUUIDRef typeID) {</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+  MetadataImporterPluginType *result;</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+  CFUUIDRef uuid;</span>
<a href="#l17.299"></a><span id="l17.299"> </span>
<a href="#l17.300"></a><span id="l17.300" class="difflineminus">-        /* If correct type is being requested, allocate an</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineminus">-         * instance of TestType and return the IUnknown interface.</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineminus">-         */</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineminus">-    if (CFEqual(typeID,kMDImporterTypeID)){</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineminus">-        uuid = CFUUIDCreateFromString(kCFAllocatorDefault,CFSTR(PLUGIN_ID));</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineminus">-        result = AllocMetadataImporterPluginType(uuid);</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineminus">-        CFRelease(uuid);</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineminus">-        return result;</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-    }</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineminus">-        /* If the requested type is incorrect, return NULL. */</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-    return NULL;</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+  /* If correct type is being requested, allocate an</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+   * instance of TestType and return the IUnknown interface.</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineplus">+   */</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+  if (CFEqual(typeID, kMDImporterTypeID)) {</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineplus">+    uuid = CFUUIDCreateFromString(kCFAllocatorDefault, CFSTR(PLUGIN_ID));</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+    result = AllocMetadataImporterPluginType(uuid);</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineplus">+    CFRelease(uuid);</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineplus">+    return result;</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineplus">+  }</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineplus">+  /* If the requested type is incorrect, return NULL. */</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+  return NULL;</span>
<a href="#l17.322"></a><span id="l17.322"> }</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/components/search/nsMailWinSearchHelper.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/components/search/nsMailWinSearchHelper.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -6,81 +6,79 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsMailWinSearchHelper.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsString.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsIDirectoryEnumerator.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> #ifdef _WIN32_WINNT</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#undef _WIN32_WINNT</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+#  undef _WIN32_WINNT</span>
<a href="#l18.14"></a><span id="l18.14"> #endif</span>
<a href="#l18.15"></a><span id="l18.15"> #define _WIN32_WINNT 0x0600</span>
<a href="#l18.16"></a><span id="l18.16"> #include &lt;SearchAPI.h&gt;</span>
<a href="#l18.17"></a><span id="l18.17"> #include &lt;winsvc.h&gt;</span>
<a href="#l18.18"></a><span id="l18.18"> #include &lt;ShellAPI.h&gt;</span>
<a href="#l18.19"></a><span id="l18.19"> #include &lt;shlobj.h&gt;</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-static const CLSID CLSID_CSearchManager = {0x7d096c5f, 0xac08, 0x4f1f, {0xbe, 0xb7, 0x5c, 0x22, 0xc5, 0x17, 0xce, 0x39}};</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-static const IID IID_ISearchManager = {0xab310581, 0xac80, 0x11d1, {0x8d, 0xf3, 0x00, 0xc0, 0x4f, 0xb6, 0xef, 0x69}};</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+static const CLSID CLSID_CSearchManager = {</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+    0x7d096c5f,</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+    0xac08,</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+    0x4f1f,</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+    {0xbe, 0xb7, 0x5c, 0x22, 0xc5, 0x17, 0xce, 0x39}};</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+static const IID IID_ISearchManager = {</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+    0xab310581,</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+    0xac80,</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+    0x11d1,</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+    {0x8d, 0xf3, 0x00, 0xc0, 0x4f, 0xb6, 0xef, 0x69}};</span>
<a href="#l18.33"></a><span id="l18.33"> </span>
<a href="#l18.34"></a><span id="l18.34"> static const char* const sFoldersToIndex[] = {&quot;Mail&quot;, &quot;ImapMail&quot;, &quot;News&quot;};</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36"> // APP_REG_NAME_MAIL should be kept in synch with AppRegNameMail</span>
<a href="#l18.37"></a><span id="l18.37"> // in the installer file: defines.nsi.in</span>
<a href="#l18.38"></a><span id="l18.38"> #define APP_REG_NAME_MAIL L&quot;Thunderbird&quot;</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-nsMailWinSearchHelper::nsMailWinSearchHelper()</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-{</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-}</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+nsMailWinSearchHelper::nsMailWinSearchHelper() {}</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-nsresult nsMailWinSearchHelper::Init()</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-{</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+nsresult nsMailWinSearchHelper::Init() {</span>
<a href="#l18.48"></a><span id="l18.48">   CoInitialize(NULL);</span>
<a href="#l18.49"></a><span id="l18.49">   return NS_GetSpecialDirectory(&quot;ProfD&quot;, getter_AddRefs(mProfD));</span>
<a href="#l18.50"></a><span id="l18.50"> }</span>
<a href="#l18.51"></a><span id="l18.51"> </span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-nsMailWinSearchHelper::~nsMailWinSearchHelper()</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-{</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-  CoUninitialize();</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-}</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+nsMailWinSearchHelper::~nsMailWinSearchHelper() { CoUninitialize(); }</span>
<a href="#l18.57"></a><span id="l18.57"> </span>
<a href="#l18.58"></a><span id="l18.58"> NS_IMPL_ISUPPORTS(nsMailWinSearchHelper, nsIMailWinSearchHelper)</span>
<a href="#l18.59"></a><span id="l18.59"> </span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-NS_IMETHODIMP nsMailWinSearchHelper::GetFoldersInCrawlScope(bool* aResult)</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-{</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+NS_IMETHODIMP nsMailWinSearchHelper::GetFoldersInCrawlScope(bool* aResult) {</span>
<a href="#l18.64"></a><span id="l18.64">   *aResult = false;</span>
<a href="#l18.65"></a><span id="l18.65">   NS_ENSURE_ARG_POINTER(mProfD);</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67">   // If the service isn't present or running, we shouldn't proceed.</span>
<a href="#l18.68"></a><span id="l18.68">   bool serviceRunning;</span>
<a href="#l18.69"></a><span id="l18.69">   nsresult rv = GetServiceRunning(&amp;serviceRunning);</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-  if (!serviceRunning || NS_FAILED(rv))</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-    return rv;</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  if (!serviceRunning || NS_FAILED(rv)) return rv;</span>
<a href="#l18.73"></a><span id="l18.73"> </span>
<a href="#l18.74"></a><span id="l18.74">   // We need to do this every time so that we have the latest data</span>
<a href="#l18.75"></a><span id="l18.75">   RefPtr&lt;ISearchManager&gt; searchManager;</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-  HRESULT hr = CoCreateInstance(CLSID_CSearchManager, NULL, CLSCTX_ALL, IID_ISearchManager, getter_AddRefs(searchManager));</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-  if (FAILED(hr))</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+  HRESULT hr =</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+      CoCreateInstance(CLSID_CSearchManager, NULL, CLSCTX_ALL,</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+                       IID_ISearchManager, getter_AddRefs(searchManager));</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  if (FAILED(hr)) return NS_ERROR_FAILURE;</span>
<a href="#l18.83"></a><span id="l18.83"> </span>
<a href="#l18.84"></a><span id="l18.84">   RefPtr&lt;ISearchCatalogManager&gt; catalogManager;</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-  hr = searchManager-&gt;GetCatalog(L&quot;SystemIndex&quot;, getter_AddRefs(catalogManager));</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-  if (FAILED(hr))</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+  hr =</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+      searchManager-&gt;GetCatalog(L&quot;SystemIndex&quot;, getter_AddRefs(catalogManager));</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  if (FAILED(hr)) return NS_ERROR_FAILURE;</span>
<a href="#l18.91"></a><span id="l18.91"> </span>
<a href="#l18.92"></a><span id="l18.92">   RefPtr&lt;ISearchCrawlScopeManager&gt; crawlScopeManager;</span>
<a href="#l18.93"></a><span id="l18.93">   hr = catalogManager-&gt;GetCrawlScopeManager(getter_AddRefs(crawlScopeManager));</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-  if (FAILED(hr))</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+  if (FAILED(hr)) return NS_ERROR_FAILURE;</span>
<a href="#l18.97"></a><span id="l18.97"> </span>
<a href="#l18.98"></a><span id="l18.98">   // We need to create appropriate URLs to check with the crawl scope manager.</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-  for (uint32_t i = 0; i &lt; MOZ_ARRAY_LENGTH(sFoldersToIndex); i++)</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-  {</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+  for (uint32_t i = 0; i &lt; MOZ_ARRAY_LENGTH(sFoldersToIndex); i++) {</span>
<a href="#l18.102"></a><span id="l18.102">     nsCOMPtr&lt;nsIFile&gt; subdir;</span>
<a href="#l18.103"></a><span id="l18.103">     rv = mProfD-&gt;Clone(getter_AddRefs(subdir));</span>
<a href="#l18.104"></a><span id="l18.104">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.105"></a><span id="l18.105"> </span>
<a href="#l18.106"></a><span id="l18.106">     nsDependentCString relativeStr(sFoldersToIndex[i]);</span>
<a href="#l18.107"></a><span id="l18.107">     rv = subdir-&gt;AppendNative(relativeStr);</span>
<a href="#l18.108"></a><span id="l18.108">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110" class="difflineat">@@ -89,156 +87,143 @@ NS_IMETHODIMP nsMailWinSearchHelper::Get</span>
<a href="#l18.111"></a><span id="l18.111">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.112"></a><span id="l18.112"> </span>
<a href="#l18.113"></a><span id="l18.113">     // Form a URL as required by the crawl scope manager</span>
<a href="#l18.114"></a><span id="l18.114">     nsString subdirURL(NS_LITERAL_STRING(&quot;file:///&quot;));</span>
<a href="#l18.115"></a><span id="l18.115">     subdirURL.Append(subdirPath);</span>
<a href="#l18.116"></a><span id="l18.116">     subdirURL.Append('\\');</span>
<a href="#l18.117"></a><span id="l18.117"> </span>
<a href="#l18.118"></a><span id="l18.118">     BOOL included;</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-    if (FAILED(crawlScopeManager-&gt;IncludedInCrawlScope(subdirURL.get(), &amp;included)))</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+    if (FAILED(crawlScopeManager-&gt;IncludedInCrawlScope(subdirURL.get(),</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+                                                       &amp;included)))</span>
<a href="#l18.122"></a><span id="l18.122">       return NS_ERROR_FAILURE;</span>
<a href="#l18.123"></a><span id="l18.123"> </span>
<a href="#l18.124"></a><span id="l18.124">     // If even one of the folders isn't there, we return false</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-    if (!included)</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-      return NS_OK;</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+    if (!included) return NS_OK;</span>
<a href="#l18.128"></a><span id="l18.128">   }</span>
<a href="#l18.129"></a><span id="l18.129">   *aResult = true;</span>
<a href="#l18.130"></a><span id="l18.130">   return NS_OK;</span>
<a href="#l18.131"></a><span id="l18.131"> }</span>
<a href="#l18.132"></a><span id="l18.132"> </span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-NS_IMETHODIMP nsMailWinSearchHelper::GetServiceRunning(bool* aResult)</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-{</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+NS_IMETHODIMP nsMailWinSearchHelper::GetServiceRunning(bool* aResult) {</span>
<a href="#l18.136"></a><span id="l18.136">   *aResult = false;</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-  SC_HANDLE hSCManager = OpenSCManager(nullptr, SERVICES_ACTIVE_DATABASE, SERVICE_QUERY_STATUS);</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-  if (!hSCManager)</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+  SC_HANDLE hSCManager =</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+      OpenSCManager(nullptr, SERVICES_ACTIVE_DATABASE, SERVICE_QUERY_STATUS);</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+  if (!hSCManager) return NS_ERROR_FAILURE;</span>
<a href="#l18.143"></a><span id="l18.143"> </span>
<a href="#l18.144"></a><span id="l18.144">   SC_HANDLE hService = OpenService(hSCManager, &quot;wsearch&quot;, SERVICE_QUERY_STATUS);</span>
<a href="#l18.145"></a><span id="l18.145">   CloseServiceHandle(hSCManager);</span>
<a href="#l18.146"></a><span id="l18.146">   if (!hService)</span>
<a href="#l18.147"></a><span id="l18.147">     // The service isn't present. Never mind.</span>
<a href="#l18.148"></a><span id="l18.148">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l18.149"></a><span id="l18.149"> </span>
<a href="#l18.150"></a><span id="l18.150">   SERVICE_STATUS status;</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-  if (!QueryServiceStatus(hService, &amp;status))</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-  {</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+  if (!QueryServiceStatus(hService, &amp;status)) {</span>
<a href="#l18.154"></a><span id="l18.154">     CloseServiceHandle(hService);</span>
<a href="#l18.155"></a><span id="l18.155">     return NS_ERROR_FAILURE;</span>
<a href="#l18.156"></a><span id="l18.156">   }</span>
<a href="#l18.157"></a><span id="l18.157"> </span>
<a href="#l18.158"></a><span id="l18.158">   *aResult = (status.dwCurrentState == SERVICE_RUNNING);</span>
<a href="#l18.159"></a><span id="l18.159">   CloseServiceHandle(hService);</span>
<a href="#l18.160"></a><span id="l18.160">   return NS_OK;</span>
<a href="#l18.161"></a><span id="l18.161"> }</span>
<a href="#l18.162"></a><span id="l18.162"> </span>
<a href="#l18.163"></a><span id="l18.163" class="difflineminus">-NS_IMETHODIMP nsMailWinSearchHelper::SetFANCIBit(nsIFile* aFile, bool aBit, bool aRecurse)</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineminus">-{</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+NS_IMETHODIMP nsMailWinSearchHelper::SetFANCIBit(nsIFile* aFile, bool aBit,</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+                                                 bool aRecurse) {</span>
<a href="#l18.167"></a><span id="l18.167">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l18.168"></a><span id="l18.168"> </span>
<a href="#l18.169"></a><span id="l18.169">   bool exists;</span>
<a href="#l18.170"></a><span id="l18.170">   nsresult rv = aFile-&gt;Exists(&amp;exists);</span>
<a href="#l18.171"></a><span id="l18.171">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-  if (!exists)</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l18.175"></a><span id="l18.175"> </span>
<a href="#l18.176"></a><span id="l18.176">   nsString filePath;</span>
<a href="#l18.177"></a><span id="l18.177">   rv = aFile-&gt;GetPath(filePath);</span>
<a href="#l18.178"></a><span id="l18.178">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.179"></a><span id="l18.179">   LPCWSTR pathStr = filePath.get();</span>
<a href="#l18.180"></a><span id="l18.180"> </span>
<a href="#l18.181"></a><span id="l18.181">   // We should set the file attribute only if it isn't already set.</span>
<a href="#l18.182"></a><span id="l18.182">   DWORD dwAttrs = GetFileAttributesW(pathStr);</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-  if (dwAttrs == INVALID_FILE_ATTRIBUTES)</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+  if (dwAttrs == INVALID_FILE_ATTRIBUTES) return NS_ERROR_FAILURE;</span>
<a href="#l18.186"></a><span id="l18.186"> </span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-  if (aBit)</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineminus">-  {</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineplus">+  if (aBit) {</span>
<a href="#l18.190"></a><span id="l18.190">     if (!(dwAttrs &amp; FILE_ATTRIBUTE_NOT_CONTENT_INDEXED))</span>
<a href="#l18.191"></a><span id="l18.191">       SetFileAttributesW(pathStr, dwAttrs | FILE_ATTRIBUTE_NOT_CONTENT_INDEXED);</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-  }</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-  else</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-  {</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+  } else {</span>
<a href="#l18.196"></a><span id="l18.196">     if (dwAttrs &amp; FILE_ATTRIBUTE_NOT_CONTENT_INDEXED)</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-      SetFileAttributesW(pathStr, dwAttrs &amp; ~FILE_ATTRIBUTE_NOT_CONTENT_INDEXED);</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+      SetFileAttributesW(pathStr,</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+                         dwAttrs &amp; ~FILE_ATTRIBUTE_NOT_CONTENT_INDEXED);</span>
<a href="#l18.200"></a><span id="l18.200">   }</span>
<a href="#l18.201"></a><span id="l18.201"> </span>
<a href="#l18.202"></a><span id="l18.202">   // We should only try to recurse if it's a directory</span>
<a href="#l18.203"></a><span id="l18.203">   bool isDirectory;</span>
<a href="#l18.204"></a><span id="l18.204">   rv = aFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l18.205"></a><span id="l18.205">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-  if (aRecurse &amp;&amp; isDirectory)</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineminus">-  {</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+  if (aRecurse &amp;&amp; isDirectory) {</span>
<a href="#l18.209"></a><span id="l18.209">     nsCOMPtr&lt;nsIDirectoryEnumerator&gt; children;</span>
<a href="#l18.210"></a><span id="l18.210">     rv = aFile-&gt;GetDirectoryEntries(getter_AddRefs(children));</span>
<a href="#l18.211"></a><span id="l18.211">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.212"></a><span id="l18.212"> </span>
<a href="#l18.213"></a><span id="l18.213">     bool hasMore = false;</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-    while (NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-    {</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+    while (NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l18.217"></a><span id="l18.217">       nsCOMPtr&lt;nsIFile&gt; childFile;</span>
<a href="#l18.218"></a><span id="l18.218">       rv = children-&gt;GetNextFile(getter_AddRefs(childFile));</span>
<a href="#l18.219"></a><span id="l18.219">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.220"></a><span id="l18.220">       rv = SetFANCIBit(childFile, aBit, aRecurse);</span>
<a href="#l18.221"></a><span id="l18.221">     }</span>
<a href="#l18.222"></a><span id="l18.222">   }</span>
<a href="#l18.223"></a><span id="l18.223">   return rv;</span>
<a href="#l18.224"></a><span id="l18.224"> }</span>
<a href="#l18.225"></a><span id="l18.225"> </span>
<a href="#l18.226"></a><span id="l18.226" class="difflineminus">-NS_IMETHODIMP nsMailWinSearchHelper::GetIsFileAssociationSet(bool *aResult)</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineminus">-{</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+NS_IMETHODIMP nsMailWinSearchHelper::GetIsFileAssociationSet(bool* aResult) {</span>
<a href="#l18.229"></a><span id="l18.229">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.230"></a><span id="l18.230"> </span>
<a href="#l18.231"></a><span id="l18.231">   // We'll use the Vista method here</span>
<a href="#l18.232"></a><span id="l18.232">   RefPtr&lt;IApplicationAssociationRegistration&gt; pAAR;</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineminus">-  HRESULT hr = CoCreateInstance(CLSID_ApplicationAssociationRegistration,</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineminus">-                                NULL,</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineminus">-                                CLSCTX_INPROC,</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineminus">-                                IID_IApplicationAssociationRegistration,</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineminus">-                                getter_AddRefs(pAAR));</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+  HRESULT hr = CoCreateInstance(</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineplus">+      CLSID_ApplicationAssociationRegistration, NULL, CLSCTX_INPROC,</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineplus">+      IID_IApplicationAssociationRegistration, getter_AddRefs(pAAR));</span>
<a href="#l18.241"></a><span id="l18.241"> </span>
<a href="#l18.242"></a><span id="l18.242">   BOOL res = false;</span>
<a href="#l18.243"></a><span id="l18.243">   if (SUCCEEDED(hr))</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">-    pAAR-&gt;QueryAppIsDefault(L&quot;.wdseml&quot;, AT_FILEEXTENSION, AL_EFFECTIVE, APP_REG_NAME_MAIL, &amp;res);</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineplus">+    pAAR-&gt;QueryAppIsDefault(L&quot;.wdseml&quot;, AT_FILEEXTENSION, AL_EFFECTIVE,</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineplus">+                            APP_REG_NAME_MAIL, &amp;res);</span>
<a href="#l18.247"></a><span id="l18.247">   *aResult = res;</span>
<a href="#l18.248"></a><span id="l18.248"> </span>
<a href="#l18.249"></a><span id="l18.249">   return NS_OK;</span>
<a href="#l18.250"></a><span id="l18.250"> }</span>
<a href="#l18.251"></a><span id="l18.251"> </span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-NS_IMETHODIMP nsMailWinSearchHelper::SetFileAssociation()</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">-{</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+NS_IMETHODIMP nsMailWinSearchHelper::SetFileAssociation() {</span>
<a href="#l18.255"></a><span id="l18.255">   RefPtr&lt;IApplicationAssociationRegistration&gt; pAAR;</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineminus">-  HRESULT hr = CoCreateInstance(CLSID_ApplicationAssociationRegistration,</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineminus">-                                NULL,</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineminus">-                                CLSCTX_INPROC,</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineminus">-                                IID_IApplicationAssociationRegistration,</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineminus">-                                getter_AddRefs(pAAR));</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineplus">+  HRESULT hr = CoCreateInstance(</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineplus">+      CLSID_ApplicationAssociationRegistration, NULL, CLSCTX_INPROC,</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineplus">+      IID_IApplicationAssociationRegistration, getter_AddRefs(pAAR));</span>
<a href="#l18.264"></a><span id="l18.264">   if (SUCCEEDED(hr))</span>
<a href="#l18.265"></a><span id="l18.265">     hr = pAAR-&gt;SetAppAsDefault(APP_REG_NAME_MAIL, L&quot;.wdseml&quot;, AT_FILEEXTENSION);</span>
<a href="#l18.266"></a><span id="l18.266"> </span>
<a href="#l18.267"></a><span id="l18.267">   return SUCCEEDED(hr) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l18.268"></a><span id="l18.268"> }</span>
<a href="#l18.269"></a><span id="l18.269"> </span>
<a href="#l18.270"></a><span id="l18.270" class="difflineminus">-NS_IMETHODIMP nsMailWinSearchHelper::RunSetup(bool aEnable)</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineminus">-{</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineplus">+NS_IMETHODIMP nsMailWinSearchHelper::RunSetup(bool aEnable) {</span>
<a href="#l18.273"></a><span id="l18.273">   nsresult rv;</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-  if (!mCurProcD)</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineminus">-  {</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineplus">+  if (!mCurProcD) {</span>
<a href="#l18.277"></a><span id="l18.277">     rv = NS_GetSpecialDirectory(&quot;CurProcD&quot;, getter_AddRefs(mCurProcD));</span>
<a href="#l18.278"></a><span id="l18.278">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.279"></a><span id="l18.279">     rv = mCurProcD-&gt;Append(NS_LITERAL_STRING(&quot;WSEnable.exe&quot;));</span>
<a href="#l18.280"></a><span id="l18.280">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.281"></a><span id="l18.281">   }</span>
<a href="#l18.282"></a><span id="l18.282"> </span>
<a href="#l18.283"></a><span id="l18.283">   nsAutoString filePath;</span>
<a href="#l18.284"></a><span id="l18.284">   rv = mCurProcD-&gt;GetPath(filePath);</span>
<a href="#l18.285"></a><span id="l18.285">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.286"></a><span id="l18.286"> </span>
<a href="#l18.287"></a><span id="l18.287" class="difflineminus">-  // The parameters are of the format &quot;1 &lt;path&gt;&quot; for enabling and &quot;0 &lt;path&gt;&quot; for disabling</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineminus">-  nsAutoString params(aEnable ? NS_LITERAL_STRING(&quot;1 \&quot;&quot;) : NS_LITERAL_STRING(&quot;0 \&quot;&quot;));</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineplus">+  // The parameters are of the format &quot;1 &lt;path&gt;&quot; for enabling and &quot;0 &lt;path&gt;&quot; for</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineplus">+  // disabling</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineplus">+  nsAutoString params(aEnable ? NS_LITERAL_STRING(&quot;1 \&quot;&quot;)</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineplus">+                              : NS_LITERAL_STRING(&quot;0 \&quot;&quot;));</span>
<a href="#l18.293"></a><span id="l18.293">   nsAutoString profDPath;</span>
<a href="#l18.294"></a><span id="l18.294">   rv = mProfD-&gt;GetPath(profDPath);</span>
<a href="#l18.295"></a><span id="l18.295">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.296"></a><span id="l18.296">   params.Append(profDPath);</span>
<a href="#l18.297"></a><span id="l18.297">   params.Append(NS_LITERAL_STRING(&quot;\&quot;&quot;));</span>
<a href="#l18.298"></a><span id="l18.298"> </span>
<a href="#l18.299"></a><span id="l18.299">   // We need an hWnd to cause UAC to pop up immediately</span>
<a href="#l18.300"></a><span id="l18.300">   // If GetForegroundWindow returns NULL, then the UAC prompt will still appear,</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineat">@@ -252,21 +237,19 @@ NS_IMETHODIMP nsMailWinSearchHelper::Run</span>
<a href="#l18.302"></a><span id="l18.302">   executeInfo.fMask = SEE_MASK_NOCLOSEPROCESS;</span>
<a href="#l18.303"></a><span id="l18.303">   executeInfo.lpDirectory = NULL;</span>
<a href="#l18.304"></a><span id="l18.304">   executeInfo.lpFile = filePath.get();</span>
<a href="#l18.305"></a><span id="l18.305">   executeInfo.lpParameters = params.get();</span>
<a href="#l18.306"></a><span id="l18.306">   executeInfo.nShow = SW_SHOWNORMAL;</span>
<a href="#l18.307"></a><span id="l18.307"> </span>
<a href="#l18.308"></a><span id="l18.308">   DWORD dwRet = ERROR_SUCCESS;</span>
<a href="#l18.309"></a><span id="l18.309"> </span>
<a href="#l18.310"></a><span id="l18.310" class="difflineminus">-  if (ShellExecuteExW(&amp;executeInfo))</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineminus">-  {</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineplus">+  if (ShellExecuteExW(&amp;executeInfo)) {</span>
<a href="#l18.313"></a><span id="l18.313">     // We want to block until the program exits</span>
<a href="#l18.314"></a><span id="l18.314">     DWORD dwSignaled = WaitForSingleObject(executeInfo.hProcess, INFINITE);</span>
<a href="#l18.315"></a><span id="l18.315">     if (dwSignaled == WAIT_OBJECT_0)</span>
<a href="#l18.316"></a><span id="l18.316">       if (!GetExitCodeProcess(executeInfo.hProcess, &amp;dwRet))</span>
<a href="#l18.317"></a><span id="l18.317">         dwRet = GetLastError();</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineminus">-  }</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineminus">-  else</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+  } else</span>
<a href="#l18.321"></a><span id="l18.321">     return NS_ERROR_ABORT;</span>
<a href="#l18.322"></a><span id="l18.322"> </span>
<a href="#l18.323"></a><span id="l18.323">   return SUCCEEDED(HRESULT_FROM_WIN32(dwRet)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l18.324"></a><span id="l18.324"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/components/search/nsMailWinSearchHelper.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/components/search/nsMailWinSearchHelper.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -5,27 +5,30 @@</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> #ifndef nsMailWinSearchHelper_h_</span>
<a href="#l19.6"></a><span id="l19.6"> #define nsMailWinSearchHelper_h_</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIMailWinSearchHelper.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#define NS_MAILWINSEARCHHELPER_CID \</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-{0x5dd31c99, 0x8c7, 0x4a3b, {0xae, 0xb3, 0xd2, 0xe6, 0x6, 0x65, 0xa3, 0x1a}}</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+#define NS_MAILWINSEARCHHELPER_CID                  \</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+  {                                                 \</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+    0x5dd31c99, 0x8c7, 0x4a3b, {                    \</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+      0xae, 0xb3, 0xd2, 0xe6, 0x6, 0x65, 0xa3, 0x1a \</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+    }                                               \</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  }</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-class nsMailWinSearchHelper : public nsIMailWinSearchHelper</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-{</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-public:</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+class nsMailWinSearchHelper : public nsIMailWinSearchHelper {</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+ public:</span>
<a href="#l19.26"></a><span id="l19.26">   NS_DECL_ISUPPORTS</span>
<a href="#l19.27"></a><span id="l19.27">   NS_DECL_NSIMAILWINSEARCHHELPER</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29">   NS_HIDDEN_(nsresult) Init();</span>
<a href="#l19.30"></a><span id="l19.30">   nsMailWinSearchHelper();</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-private:</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+ private:</span>
<a href="#l19.34"></a><span id="l19.34">   virtual ~nsMailWinSearchHelper();</span>
<a href="#l19.35"></a><span id="l19.35">   nsCOMPtr&lt;nsIFile&gt; mProfD;</span>
<a href="#l19.36"></a><span id="l19.36">   nsCOMPtr&lt;nsIFile&gt; mCurProcD;</span>
<a href="#l19.37"></a><span id="l19.37"> };</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/components/search/wsenable/WSEnable.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/components/search/wsenable/WSEnable.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -3,147 +3,136 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.5"></a><span id="l20.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> #include &lt;SearchAPI.h&gt;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &lt;shellapi.h&gt;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &lt;objbase.h&gt;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &lt;string&gt;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-static const CLSID CLSID_CSearchManager = {0x7d096c5f, 0xac08, 0x4f1f, {0xbe, 0xb7, 0x5c, 0x22, 0xc5, 0x17, 0xce, 0x39}};</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-static const IID IID_ISearchManager = {0xab310581, 0xac80, 0x11d1, {0x8d, 0xf3, 0x00, 0xc0, 0x4f, 0xb6, 0xef, 0x69}};</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+static const CLSID CLSID_CSearchManager = {</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+    0x7d096c5f,</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+    0xac08,</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+    0x4f1f,</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+    {0xbe, 0xb7, 0x5c, 0x22, 0xc5, 0x17, 0xce, 0x39}};</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+static const IID IID_ISearchManager = {</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+    0xab310581,</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+    0xac80,</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+    0x11d1,</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+    {0x8d, 0xf3, 0x00, 0xc0, 0x4f, 0xb6, 0xef, 0x69}};</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-static const WCHAR* const sFoldersToIndex[] = {L&quot;\\Mail\\&quot;, L&quot;\\ImapMail\\&quot;, L&quot;\\News\\&quot;};</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+static const WCHAR* const sFoldersToIndex[] = {L&quot;\\Mail\\&quot;, L&quot;\\ImapMail\\&quot;,</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+                                               L&quot;\\News\\&quot;};</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-struct RegKey</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-{</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+struct RegKey {</span>
<a href="#l20.32"></a><span id="l20.32">   HKEY mRoot;</span>
<a href="#l20.33"></a><span id="l20.33">   const LPWSTR mSubKey;</span>
<a href="#l20.34"></a><span id="l20.34">   const LPWSTR mName;</span>
<a href="#l20.35"></a><span id="l20.35">   const LPWSTR mValue;</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37">   RegKey(HKEY aRoot, LPWSTR aSubKey, LPWSTR aName, LPWSTR aValue)</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-    : mRoot(aRoot), mSubKey(aSubKey), mName(aName), mValue(aValue) {}</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+      : mRoot(aRoot), mSubKey(aSubKey), mName(aName), mValue(aValue) {}</span>
<a href="#l20.40"></a><span id="l20.40"> };</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-static const RegKey* const sRegKeys[] =</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-{</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-  new RegKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-             L&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PropertySystem\\PropertyHandlers\\.wdseml&quot;,</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-             L&quot;&quot;,</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-             L&quot;{5FA29220-36A1-40f9-89C6-F4B384B7642E}&quot;),</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-  new RegKey(HKEY_CLASSES_ROOT,</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-             L&quot;.wdseml&quot;,</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-             L&quot;Content Type&quot;,</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-             L&quot;message/rfc822&quot;),</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-  new RegKey(HKEY_CLASSES_ROOT,</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-             L&quot;.wdseml\\PersistentHandler&quot;,</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-             L&quot;&quot;,</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-             L&quot;{5645c8c4-e277-11cf-8fda-00aa00a14f93}&quot;),</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-  new RegKey(HKEY_CLASSES_ROOT,</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-             L&quot;.wdseml\\shellex\\{8895B1C6-B41F-4C1C-A562-0D564250836F}&quot;,</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-             L&quot;&quot;,</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-             L&quot;{b9815375-5d7f-4ce2-9245-c9d4da436930}&quot;),</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-  new RegKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-             L&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\explorer\\KindMap&quot;,</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-             L&quot;.wdseml&quot;,</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-             L&quot;email;communication&quot;)</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-};</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+static const RegKey* const sRegKeys[] = {</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+    new RegKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+               L&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PropertySystem\\&quot;</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+               L&quot;PropertyHandlers\\.wdseml&quot;,</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+               L&quot;&quot;, L&quot;{5FA29220-36A1-40f9-89C6-F4B384B7642E}&quot;),</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+    new RegKey(HKEY_CLASSES_ROOT, L&quot;.wdseml&quot;, L&quot;Content Type&quot;,</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+               L&quot;message/rfc822&quot;),</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+    new RegKey(HKEY_CLASSES_ROOT, L&quot;.wdseml\\PersistentHandler&quot;, L&quot;&quot;,</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+               L&quot;{5645c8c4-e277-11cf-8fda-00aa00a14f93}&quot;),</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+    new RegKey(HKEY_CLASSES_ROOT,</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+               L&quot;.wdseml\\shellex\\{8895B1C6-B41F-4C1C-A562-0D564250836F}&quot;, L&quot;&quot;,</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+               L&quot;{b9815375-5d7f-4ce2-9245-c9d4da436930}&quot;),</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+    new RegKey(</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+        HKEY_LOCAL_MACHINE,</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+        L&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\explorer\\KindMap&quot;,</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+        L&quot;.wdseml&quot;, L&quot;email;communication&quot;)};</span>
<a href="#l20.81"></a><span id="l20.81"> </span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-HRESULT GetCrawlScopeManager(ISearchCrawlScopeManager **aCrawlScopeManager)</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-{</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+HRESULT GetCrawlScopeManager(ISearchCrawlScopeManager** aCrawlScopeManager) {</span>
<a href="#l20.85"></a><span id="l20.85">   *aCrawlScopeManager = NULL;</span>
<a href="#l20.86"></a><span id="l20.86"> </span>
<a href="#l20.87"></a><span id="l20.87">   ISearchManager* searchManager;</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-  HRESULT hr = CoCreateInstance(CLSID_CSearchManager, NULL, CLSCTX_ALL, IID_ISearchManager, (void**)&amp;searchManager);</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-  if (SUCCEEDED(hr))</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-  {</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+  HRESULT hr = CoCreateInstance(CLSID_CSearchManager, NULL, CLSCTX_ALL,</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+                                IID_ISearchManager, (void**)&amp;searchManager);</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+  if (SUCCEEDED(hr)) {</span>
<a href="#l20.94"></a><span id="l20.94">     ISearchCatalogManager* catalogManager;</span>
<a href="#l20.95"></a><span id="l20.95">     hr = searchManager-&gt;GetCatalog(L&quot;SystemIndex&quot;, &amp;catalogManager);</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-    if (SUCCEEDED(hr))</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-    {</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+    if (SUCCEEDED(hr)) {</span>
<a href="#l20.99"></a><span id="l20.99">       hr = catalogManager-&gt;GetCrawlScopeManager(aCrawlScopeManager);</span>
<a href="#l20.100"></a><span id="l20.100">       catalogManager-&gt;Release();</span>
<a href="#l20.101"></a><span id="l20.101">     }</span>
<a href="#l20.102"></a><span id="l20.102">     searchManager-&gt;Release();</span>
<a href="#l20.103"></a><span id="l20.103">   }</span>
<a href="#l20.104"></a><span id="l20.104">   return hr;</span>
<a href="#l20.105"></a><span id="l20.105"> }</span>
<a href="#l20.106"></a><span id="l20.106"> </span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-LSTATUS SetRegistryKeys()</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-{</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+LSTATUS SetRegistryKeys() {</span>
<a href="#l20.110"></a><span id="l20.110">   LSTATUS rv = ERROR_SUCCESS;</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineminus">-  for (int i = 0; rv == ERROR_SUCCESS &amp;&amp; i &lt; _countof(sRegKeys); i++)</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-  {</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-    const RegKey *key = sRegKeys[i];</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+  for (int i = 0; rv == ERROR_SUCCESS &amp;&amp; i &lt; _countof(sRegKeys); i++) {</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+    const RegKey* key = sRegKeys[i];</span>
<a href="#l20.116"></a><span id="l20.116">     HKEY subKey;</span>
<a href="#l20.117"></a><span id="l20.117">     // Since we're administrator, we should be able to do this just fine</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-    rv = RegCreateKeyExW(key-&gt;mRoot, key-&gt;mSubKey, 0, NULL, REG_OPTION_NON_VOLATILE,</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-          KEY_ALL_ACCESS | KEY_WOW64_64KEY, NULL, &amp;subKey, NULL);</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+    rv = RegCreateKeyExW(key-&gt;mRoot, key-&gt;mSubKey, 0, NULL,</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+                         REG_OPTION_NON_VOLATILE,</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+                         KEY_ALL_ACCESS | KEY_WOW64_64KEY, NULL, &amp;subKey, NULL);</span>
<a href="#l20.123"></a><span id="l20.123">     if (rv == ERROR_SUCCESS)</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-      rv = RegSetValueExW(subKey, key-&gt;mName, 0, REG_SZ, (LPBYTE) key-&gt;mValue,</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-            (lstrlenW(key-&gt;mValue) + 1) * sizeof(WCHAR));</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+      rv = RegSetValueExW(subKey, key-&gt;mName, 0, REG_SZ, (LPBYTE)key-&gt;mValue,</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+                          (lstrlenW(key-&gt;mValue) + 1) * sizeof(WCHAR));</span>
<a href="#l20.128"></a><span id="l20.128">     RegCloseKey(subKey);</span>
<a href="#l20.129"></a><span id="l20.129">   }</span>
<a href="#l20.130"></a><span id="l20.130"> </span>
<a href="#l20.131"></a><span id="l20.131">   return rv;</span>
<a href="#l20.132"></a><span id="l20.132"> }</span>
<a href="#l20.133"></a><span id="l20.133"> </span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-int APIENTRY wWinMain(HINSTANCE hInstance,</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-                      HINSTANCE hPrevInstance,</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-                      LPWSTR    lpCmdLine,</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-                      int       nCmdShow)</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-{</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+int APIENTRY wWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+                      LPWSTR lpCmdLine, int nCmdShow) {</span>
<a href="#l20.141"></a><span id="l20.141">   UNREFERENCED_PARAMETER(lpCmdLine);</span>
<a href="#l20.142"></a><span id="l20.142"> </span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-  HRESULT hr = CoInitializeEx(NULL, COINIT_APARTMENTTHREADED | COINIT_DISABLE_OLE1DDE);</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-  if (SUCCEEDED(hr))</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">-  {</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+  HRESULT hr =</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+      CoInitializeEx(NULL, COINIT_APARTMENTTHREADED | COINIT_DISABLE_OLE1DDE);</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+  if (SUCCEEDED(hr)) {</span>
<a href="#l20.149"></a><span id="l20.149">     int argc;</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-    LPWSTR *argv = CommandLineToArgvW(lpCmdLine, &amp;argc);</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-    if (argc != 2)</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-      hr = E_INVALIDARG;</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-    if (SUCCEEDED(hr))</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-    {</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+    LPWSTR* argv = CommandLineToArgvW(lpCmdLine, &amp;argc);</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+    if (argc != 2) hr = E_INVALIDARG;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+    if (SUCCEEDED(hr)) {</span>
<a href="#l20.158"></a><span id="l20.158">       ISearchCrawlScopeManager* crawlScopeManager;</span>
<a href="#l20.159"></a><span id="l20.159">       hr = GetCrawlScopeManager(&amp;crawlScopeManager);</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-      if (SUCCEEDED(hr))</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-      {</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-        if (*argv[0] == L'1')</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-        {</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+      if (SUCCEEDED(hr)) {</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+        if (*argv[0] == L'1') {</span>
<a href="#l20.166"></a><span id="l20.166">           // We first add the required registry entries</span>
<a href="#l20.167"></a><span id="l20.167">           LSTATUS rv = SetRegistryKeys();</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-          if (rv != ERROR_SUCCESS)</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-            hr = E_FAIL;</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+          if (rv != ERROR_SUCCESS) hr = E_FAIL;</span>
<a href="#l20.171"></a><span id="l20.171"> </span>
<a href="#l20.172"></a><span id="l20.172">           // Next, we add rules for each of the three folders</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-          for (int i = 0; SUCCEEDED(hr) &amp;&amp; i &lt; _countof(sFoldersToIndex); i++)</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-          {</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+          for (int i = 0; SUCCEEDED(hr) &amp;&amp; i &lt; _countof(sFoldersToIndex); i++) {</span>
<a href="#l20.176"></a><span id="l20.176">             std::wstring path = L&quot;file:///&quot;;</span>
<a href="#l20.177"></a><span id="l20.177">             path.append(argv[1]);</span>
<a href="#l20.178"></a><span id="l20.178">             path.append(sFoldersToIndex[i]);</span>
<a href="#l20.179"></a><span id="l20.179">             // Add only if the rule isn't already there</span>
<a href="#l20.180"></a><span id="l20.180">             BOOL isIncluded = FALSE;</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-            hr = crawlScopeManager-&gt;IncludedInCrawlScope(path.c_str(), &amp;isIncluded);</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+            hr = crawlScopeManager-&gt;IncludedInCrawlScope(path.c_str(),</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+                                                         &amp;isIncluded);</span>
<a href="#l20.184"></a><span id="l20.184">             if (SUCCEEDED(hr) &amp;&amp; !isIncluded)</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-              hr = crawlScopeManager-&gt;AddUserScopeRule(path.c_str(), TRUE, TRUE, TRUE);</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+              hr = crawlScopeManager-&gt;AddUserScopeRule(path.c_str(), TRUE, TRUE,</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+                                                       TRUE);</span>
<a href="#l20.188"></a><span id="l20.188">           }</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-        }</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-        else if (*argv[0] == L'0')</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-        {</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-          // This is simple, we just exclude the profile dir and override children</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+        } else if (*argv[0] == L'0') {</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+          // This is simple, we just exclude the profile dir and override</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+          // children</span>
<a href="#l20.196"></a><span id="l20.196">           std::wstring path = L&quot;file:///&quot;;</span>
<a href="#l20.197"></a><span id="l20.197">           path.append(argv[1]);</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineminus">-          hr = crawlScopeManager-&gt;AddUserScopeRule(path.c_str(), FALSE, TRUE, TRUE);</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-        }</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineminus">-        else</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+          hr = crawlScopeManager-&gt;AddUserScopeRule(path.c_str(), FALSE, TRUE,</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineplus">+                                                   TRUE);</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineplus">+        } else</span>
<a href="#l20.204"></a><span id="l20.204">           hr = E_INVALIDARG;</span>
<a href="#l20.205"></a><span id="l20.205"> </span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-        if (SUCCEEDED(hr))</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-        {</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+        if (SUCCEEDED(hr)) {</span>
<a href="#l20.209"></a><span id="l20.209">           hr = crawlScopeManager-&gt;SaveAll();</span>
<a href="#l20.210"></a><span id="l20.210">         }</span>
<a href="#l20.211"></a><span id="l20.211">         crawlScopeManager-&gt;Release();</span>
<a href="#l20.212"></a><span id="l20.212">       }</span>
<a href="#l20.213"></a><span id="l20.213">     }</span>
<a href="#l20.214"></a><span id="l20.214">     LocalFree(argv);</span>
<a href="#l20.215"></a><span id="l20.215">   }</span>
<a href="#l20.216"></a><span id="l20.216"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/components/shell/DirectoryProvider.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/components/shell/DirectoryProvider.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -20,23 +20,22 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsString.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsXULAppAPI.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;mozilla/intl/LocaleService.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> namespace mozilla {</span>
<a href="#l21.10"></a><span id="l21.10"> namespace mail {</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-NS_IMPL_ISUPPORTS(DirectoryProvider,</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-                   nsIDirectoryServiceProvider,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-                   nsIDirectoryServiceProvider2)</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+NS_IMPL_ISUPPORTS(DirectoryProvider, nsIDirectoryServiceProvider,</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+                  nsIDirectoryServiceProvider2)</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18"> NS_IMETHODIMP</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-DirectoryProvider::GetFile(const char *aKey, bool *aPersist, nsIFile* *aResult)</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-{</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+DirectoryProvider::GetFile(const char *aKey, bool *aPersist,</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+                           nsIFile **aResult) {</span>
<a href="#l21.23"></a><span id="l21.23">   // Not supported.</span>
<a href="#l21.24"></a><span id="l21.24">   return NS_ERROR_FAILURE;</span>
<a href="#l21.25"></a><span id="l21.25"> }</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27"> // Appends the distribution-specific search engine directories to the</span>
<a href="#l21.28"></a><span id="l21.28"> // array.  The directory structure is as follows:</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30"> // appdir/</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineat">@@ -48,159 +47,135 @@ DirectoryProvider::GetFile(const char *a</span>
<a href="#l21.32"></a><span id="l21.32"> //          ...</span>
<a href="#l21.33"></a><span id="l21.33"> //          \- &lt;locale N&gt;/</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35"> // common engines are loaded for all locales.  If there is no locale</span>
<a href="#l21.36"></a><span id="l21.36"> // directory for the current locale, there is a pref:</span>
<a href="#l21.37"></a><span id="l21.37"> // &quot;distribution.searchplugins.defaultLocale&quot;</span>
<a href="#l21.38"></a><span id="l21.38"> // which specifies a default locale to use.</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-static void</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-AppendDistroSearchDirs(nsIProperties* aDirSvc, nsCOMArray&lt;nsIFile&gt; &amp;array)</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-{</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+static void AppendDistroSearchDirs(nsIProperties *aDirSvc,</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+                                   nsCOMArray&lt;nsIFile&gt; &amp;array) {</span>
<a href="#l21.45"></a><span id="l21.45">   nsCOMPtr&lt;nsIFile&gt; searchPlugins;</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-  nsresult rv = aDirSvc-&gt;Get(XRE_APP_DISTRIBUTION_DIR,</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-                             NS_GET_IID(nsIFile),</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+  nsresult rv = aDirSvc-&gt;Get(XRE_APP_DISTRIBUTION_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l21.49"></a><span id="l21.49">                              getter_AddRefs(searchPlugins));</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-    return;</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l21.53"></a><span id="l21.53">   searchPlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;searchplugins&quot;));</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">   bool exists;</span>
<a href="#l21.56"></a><span id="l21.56">   rv = searchPlugins-&gt;Exists(&amp;exists);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-    return;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+  if (NS_FAILED(rv) || !exists) return;</span>
<a href="#l21.60"></a><span id="l21.60"> </span>
<a href="#l21.61"></a><span id="l21.61">   nsCOMPtr&lt;nsIFile&gt; commonPlugins;</span>
<a href="#l21.62"></a><span id="l21.62">   rv = searchPlugins-&gt;Clone(getter_AddRefs(commonPlugins));</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  {</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l21.66"></a><span id="l21.66">     commonPlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;common&quot;));</span>
<a href="#l21.67"></a><span id="l21.67">     rv = commonPlugins-&gt;Exists(&amp;exists);</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-    {</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-        array.AppendObject(commonPlugins);</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; exists) {</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+      array.AppendObject(commonPlugins);</span>
<a href="#l21.73"></a><span id="l21.73">     }</span>
<a href="#l21.74"></a><span id="l21.74">   }</span>
<a href="#l21.75"></a><span id="l21.75"> </span>
<a href="#l21.76"></a><span id="l21.76">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-  if (prefs)</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-  {</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+  if (prefs) {</span>
<a href="#l21.80"></a><span id="l21.80">     nsCOMPtr&lt;nsIFile&gt; localePlugins;</span>
<a href="#l21.81"></a><span id="l21.81">     rv = searchPlugins-&gt;Clone(getter_AddRefs(localePlugins));</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-      return;</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+    if (NS_FAILED(rv)) return;</span>
<a href="#l21.85"></a><span id="l21.85"> </span>
<a href="#l21.86"></a><span id="l21.86">     localePlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;locale&quot;));</span>
<a href="#l21.87"></a><span id="l21.87"> </span>
<a href="#l21.88"></a><span id="l21.88">     AutoTArray&lt;nsCString, 10&gt; requestedLocales;</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-    mozilla::intl::LocaleService::GetInstance()-&gt;GetRequestedLocales(requestedLocales);</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+    mozilla::intl::LocaleService::GetInstance()-&gt;GetRequestedLocales(</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+        requestedLocales);</span>
<a href="#l21.92"></a><span id="l21.92">     nsAutoCString locale(requestedLocales[0]);</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94">     nsCOMPtr&lt;nsIFile&gt; curLocalePlugins;</span>
<a href="#l21.95"></a><span id="l21.95">     rv = localePlugins-&gt;Clone(getter_AddRefs(curLocalePlugins));</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-    {</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l21.99"></a><span id="l21.99">       curLocalePlugins-&gt;AppendNative(locale);</span>
<a href="#l21.100"></a><span id="l21.100">       rv = curLocalePlugins-&gt;Exists(&amp;exists);</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-      {</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; exists) {</span>
<a href="#l21.104"></a><span id="l21.104">         array.AppendObject(curLocalePlugins);</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-        return; // all done</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+        return;  // all done</span>
<a href="#l21.107"></a><span id="l21.107">       }</span>
<a href="#l21.108"></a><span id="l21.108">     }</span>
<a href="#l21.109"></a><span id="l21.109"> </span>
<a href="#l21.110"></a><span id="l21.110">     // we didn't append the locale dir - try the default one</span>
<a href="#l21.111"></a><span id="l21.111">     nsCString defLocale;</span>
<a href="#l21.112"></a><span id="l21.112">     rv = prefs-&gt;GetCharPref(&quot;distribution.searchplugins.defaultLocale&quot;,</span>
<a href="#l21.113"></a><span id="l21.113">                             defLocale);</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineminus">-    {</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l21.117"></a><span id="l21.117">       nsCOMPtr&lt;nsIFile&gt; defLocalePlugins;</span>
<a href="#l21.118"></a><span id="l21.118">       rv = localePlugins-&gt;Clone(getter_AddRefs(defLocalePlugins));</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-      {</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l21.122"></a><span id="l21.122">         defLocalePlugins-&gt;AppendNative(defLocale);</span>
<a href="#l21.123"></a><span id="l21.123">         rv = defLocalePlugins-&gt;Exists(&amp;exists);</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-          array.AppendObject(defLocalePlugins);</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; exists) array.AppendObject(defLocalePlugins);</span>
<a href="#l21.127"></a><span id="l21.127">       }</span>
<a href="#l21.128"></a><span id="l21.128">     }</span>
<a href="#l21.129"></a><span id="l21.129">   }</span>
<a href="#l21.130"></a><span id="l21.130"> }</span>
<a href="#l21.131"></a><span id="l21.131"> </span>
<a href="#l21.132"></a><span id="l21.132"> NS_IMETHODIMP</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineminus">-DirectoryProvider::GetFiles(const char *aKey, nsISimpleEnumerator* *aResult)</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineminus">-{</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineplus">+DirectoryProvider::GetFiles(const char *aKey, nsISimpleEnumerator **aResult) {</span>
<a href="#l21.136"></a><span id="l21.136">   if (!strcmp(aKey, NS_APP_DISTRIBUTION_SEARCH_DIR_LIST)) {</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineminus">-    nsCOMPtr&lt;nsIProperties&gt; dirSvc</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineminus">-      (do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID));</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineminus">-    if (!dirSvc)</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+    nsCOMPtr&lt;nsIProperties&gt; dirSvc(</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineplus">+        do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID));</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineplus">+    if (!dirSvc) return NS_ERROR_FAILURE;</span>
<a href="#l21.144"></a><span id="l21.144"> </span>
<a href="#l21.145"></a><span id="l21.145">     nsCOMArray&lt;nsIFile&gt; distroFiles;</span>
<a href="#l21.146"></a><span id="l21.146">     AppendDistroSearchDirs(dirSvc, distroFiles);</span>
<a href="#l21.147"></a><span id="l21.147"> </span>
<a href="#l21.148"></a><span id="l21.148">     return NS_NewArrayEnumerator(aResult, distroFiles, NS_GET_IID(nsIFile));</span>
<a href="#l21.149"></a><span id="l21.149">   }</span>
<a href="#l21.150"></a><span id="l21.150"> </span>
<a href="#l21.151"></a><span id="l21.151">   return NS_ERROR_FAILURE;</span>
<a href="#l21.152"></a><span id="l21.152"> }</span>
<a href="#l21.153"></a><span id="l21.153"> </span>
<a href="#l21.154"></a><span id="l21.154"> NS_IMETHODIMP</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineminus">-DirectoryProvider::AppendingEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineminus">-{</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineplus">+DirectoryProvider::AppendingEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l21.158"></a><span id="l21.158">   *aResult = mNext ? true : false;</span>
<a href="#l21.159"></a><span id="l21.159">   return NS_OK;</span>
<a href="#l21.160"></a><span id="l21.160"> }</span>
<a href="#l21.161"></a><span id="l21.161"> </span>
<a href="#l21.162"></a><span id="l21.162"> NS_IMETHODIMP</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-DirectoryProvider::AppendingEnumerator::GetNext(nsISupports* *aResult)</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-{</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineminus">-  if (aResult)</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineminus">-    NS_ADDREF(*aResult = mNext);</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineplus">+DirectoryProvider::AppendingEnumerator::GetNext(nsISupports **aResult) {</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineplus">+  if (aResult) NS_ADDREF(*aResult = mNext);</span>
<a href="#l21.169"></a><span id="l21.169"> </span>
<a href="#l21.170"></a><span id="l21.170">   mNext = nullptr;</span>
<a href="#l21.171"></a><span id="l21.171"> </span>
<a href="#l21.172"></a><span id="l21.172">   nsresult rv;</span>
<a href="#l21.173"></a><span id="l21.173">   bool more;</span>
<a href="#l21.174"></a><span id="l21.174">   while (NS_SUCCEEDED(mBase-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l21.175"></a><span id="l21.175">     nsCOMPtr&lt;nsISupports&gt; nextbasesupp;</span>
<a href="#l21.176"></a><span id="l21.176">     mBase-&gt;GetNext(getter_AddRefs(nextbasesupp));</span>
<a href="#l21.177"></a><span id="l21.177"> </span>
<a href="#l21.178"></a><span id="l21.178">     nsCOMPtr&lt;nsIFile&gt; nextbase(do_QueryInterface(nextbasesupp));</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineminus">-    if (!nextbase)</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-      continue;</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+    if (!nextbase) continue;</span>
<a href="#l21.182"></a><span id="l21.182"> </span>
<a href="#l21.183"></a><span id="l21.183">     nextbase-&gt;Clone(getter_AddRefs(mNext));</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineminus">-    if (!mNext)</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineminus">-      continue;</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineplus">+    if (!mNext) continue;</span>
<a href="#l21.187"></a><span id="l21.187"> </span>
<a href="#l21.188"></a><span id="l21.188" class="difflineminus">-    char const *const * i = mAppendList;</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineminus">-    while (*i)</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineminus">-    {</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineplus">+    char const *const *i = mAppendList;</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineplus">+    while (*i) {</span>
<a href="#l21.193"></a><span id="l21.193">       mNext-&gt;AppendNative(nsDependentCString(*i));</span>
<a href="#l21.194"></a><span id="l21.194">       ++i;</span>
<a href="#l21.195"></a><span id="l21.195">     }</span>
<a href="#l21.196"></a><span id="l21.196"> </span>
<a href="#l21.197"></a><span id="l21.197">     bool exists;</span>
<a href="#l21.198"></a><span id="l21.198">     rv = mNext-&gt;Exists(&amp;exists);</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineminus">-      break;</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; exists) break;</span>
<a href="#l21.202"></a><span id="l21.202"> </span>
<a href="#l21.203"></a><span id="l21.203">     mNext = nullptr;</span>
<a href="#l21.204"></a><span id="l21.204">   }</span>
<a href="#l21.205"></a><span id="l21.205"> </span>
<a href="#l21.206"></a><span id="l21.206">   return NS_OK;</span>
<a href="#l21.207"></a><span id="l21.207"> }</span>
<a href="#l21.208"></a><span id="l21.208"> </span>
<a href="#l21.209"></a><span id="l21.209" class="difflineminus">-DirectoryProvider::AppendingEnumerator::AppendingEnumerator</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-    (nsISimpleEnumerator* aBase,</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-     char const *const *aAppendList) :</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-  mBase(aBase),</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineminus">-  mAppendList(aAppendList)</span>
<a href="#l21.214"></a><span id="l21.214" class="difflineminus">-{</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineplus">+DirectoryProvider::AppendingEnumerator::AppendingEnumerator(</span>
<a href="#l21.216"></a><span id="l21.216" class="difflineplus">+    nsISimpleEnumerator *aBase, char const *const *aAppendList)</span>
<a href="#l21.217"></a><span id="l21.217" class="difflineplus">+    : mBase(aBase), mAppendList(aAppendList) {</span>
<a href="#l21.218"></a><span id="l21.218">   // Initialize mNext to begin.</span>
<a href="#l21.219"></a><span id="l21.219">   GetNext(nullptr);</span>
<a href="#l21.220"></a><span id="l21.220"> }</span>
<a href="#l21.221"></a><span id="l21.221"> </span>
<a href="#l21.222"></a><span id="l21.222" class="difflineminus">-} // namespace mail</span>
<a href="#l21.223"></a><span id="l21.223" class="difflineminus">-} // namespace mozilla</span>
<a href="#l21.224"></a><span id="l21.224" class="difflineplus">+}  // namespace mail</span>
<a href="#l21.225"></a><span id="l21.225" class="difflineplus">+}  // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/components/shell/DirectoryProvider.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/components/shell/DirectoryProvider.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -8,55 +8,55 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsIDirectoryService.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> #define NS_MAILDIRECTORYPROVIDER_CONTRACTID \</span>
<a href="#l22.10"></a><span id="l22.10">   &quot;@mozilla.org/mail/directory-provider;1&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#define NS_MAILDIRECTORYPROVIDER_CID \</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-  { 0xa7e8e047, 0xd36e, 0x4605, { 0xa5, 0xab, 0x1a, 0x62, 0x29, 0x03, 0x85, 0x99 }}</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+#define NS_MAILDIRECTORYPROVIDER_CID                 \</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+  {                                                  \</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+    0xa7e8e047, 0xd36e, 0x4605, {                    \</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+      0xa5, 0xab, 0x1a, 0x62, 0x29, 0x03, 0x85, 0x99 \</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+    }                                                \</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+  }</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21"> namespace mozilla {</span>
<a href="#l22.22"></a><span id="l22.22"> namespace mail {</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24"> /**</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">- * Ideally this would be a javascript class, however, when we do so, this somehow breaks</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">- * our xpcshell-tests due to various errors probably because of the xpconnect process.</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">- * For now, we'll work around it with c++ until we can fix those issues. See bug 733802</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">- * for more details.</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+ * Ideally this would be a javascript class, however, when we do so, this</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+ * somehow breaks our xpcshell-tests due to various errors probably because of</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+ * the xpconnect process. For now, we'll work around it with c++ until we can</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+ * fix those issues. See bug 733802 for more details.</span>
<a href="#l22.33"></a><span id="l22.33">  */</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-class DirectoryProvider : public nsIDirectoryServiceProvider2</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-{</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-public:</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+class DirectoryProvider : public nsIDirectoryServiceProvider2 {</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+ public:</span>
<a href="#l22.39"></a><span id="l22.39">   NS_DECL_ISUPPORTS</span>
<a href="#l22.40"></a><span id="l22.40">   NS_DECL_NSIDIRECTORYSERVICEPROVIDER</span>
<a href="#l22.41"></a><span id="l22.41">   NS_DECL_NSIDIRECTORYSERVICEPROVIDER2</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43">   DirectoryProvider() {}</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-private:</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+ private:</span>
<a href="#l22.47"></a><span id="l22.47">   virtual ~DirectoryProvider() {}</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-  class AppendingEnumerator : public nsSimpleEnumerator</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-  {</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-  public:</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+  class AppendingEnumerator : public nsSimpleEnumerator {</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+   public:</span>
<a href="#l22.53"></a><span id="l22.53">     NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l22.54"></a><span id="l22.54"> </span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-    {</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-      return NS_GET_IID(nsIFile);</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-    }</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+    const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIFile); }</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-    AppendingEnumerator(nsISimpleEnumerator* aBase,</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+    AppendingEnumerator(nsISimpleEnumerator *aBase,</span>
<a href="#l22.63"></a><span id="l22.63">                         char const *const *aAppendList);</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-  private:</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+   private:</span>
<a href="#l22.67"></a><span id="l22.67">     ~AppendingEnumerator() override = default;</span>
<a href="#l22.68"></a><span id="l22.68">     nsCOMPtr&lt;nsISimpleEnumerator&gt; mBase;</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-    char const *const *const      mAppendList;</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt;             mNext;</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+    char const *const *const mAppendList;</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; mNext;</span>
<a href="#l22.73"></a><span id="l22.73">   };</span>
<a href="#l22.74"></a><span id="l22.74"> };</span>
<a href="#l22.75"></a><span id="l22.75"> </span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-} // namespace mail</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-} // namespace mozilla</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+}  // namespace mail</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l22.80"></a><span id="l22.80"> </span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-#endif // DirectoryProvider_h__</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+#endif  // DirectoryProvider_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/components/shell/nsGNOMEShellService.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/components/shell/nsGNOMEShellService.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -20,222 +20,189 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> #include &lt;glib.h&gt;</span>
<a href="#l23.7"></a><span id="l23.7"> #include &lt;limits.h&gt;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &lt;stdlib.h&gt;</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10"> using mozilla::ArrayLength;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-static const char* const sMailProtocols[] = {</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  &quot;mailto&quot;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-};</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+static const char *const sMailProtocols[] = {&quot;mailto&quot;};</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-static const char* const sNewsProtocols[] = {</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-  &quot;news&quot;,</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-  &quot;snews&quot;,</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-  &quot;nntp&quot;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-};</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+static const char *const sNewsProtocols[] = {&quot;news&quot;, &quot;snews&quot;, &quot;nntp&quot;};</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-static const char* const sFeedProtocols[] = {</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-  &quot;feed&quot;</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-};</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+static const char *const sFeedProtocols[] = {&quot;feed&quot;};</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29"> struct AppTypeAssociation {</span>
<a href="#l23.30"></a><span id="l23.30">   uint16_t type;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-  const char * const *protocols;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+  const char *const *protocols;</span>
<a href="#l23.33"></a><span id="l23.33">   unsigned int protocolsLength;</span>
<a href="#l23.34"></a><span id="l23.34">   const char *mimeType;</span>
<a href="#l23.35"></a><span id="l23.35">   const char *extensions;</span>
<a href="#l23.36"></a><span id="l23.36"> };</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38"> static const AppTypeAssociation sAppTypes[] = {</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-  {</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-    nsIShellService::MAIL, sMailProtocols, ArrayLength(sMailProtocols),</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-    &quot;message/rfc822&quot;,</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-    nullptr // don't associate .eml extension, as that breaks printing those</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-  },</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  {</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-    nsIShellService::NEWS, sNewsProtocols, ArrayLength(sNewsProtocols),</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-    nullptr, nullptr</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-  },</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-  {</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-    nsIShellService::RSS, sFeedProtocols, ArrayLength(sFeedProtocols),</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-    &quot;application/rss+xml&quot;, &quot;rss&quot;</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-  }</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-};</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+    {</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+        nsIShellService::MAIL, sMailProtocols, ArrayLength(sMailProtocols),</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+        &quot;message/rfc822&quot;,</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+        nullptr  // don't associate .eml extension, as that breaks printing</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+                 // those</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+    },</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+    {nsIShellService::NEWS, sNewsProtocols, ArrayLength(sNewsProtocols),</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+     nullptr, nullptr},</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+    {nsIShellService::RSS, sFeedProtocols, ArrayLength(sFeedProtocols),</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+     &quot;application/rss+xml&quot;, &quot;rss&quot;}};</span>
<a href="#l23.63"></a><span id="l23.63"> </span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-nsGNOMEShellService::nsGNOMEShellService():</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-                          mCheckedThisSession(false),</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-                          mAppIsInPath(false)</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-{}</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+nsGNOMEShellService::nsGNOMEShellService()</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+    : mCheckedThisSession(false), mAppIsInPath(false) {}</span>
<a href="#l23.70"></a><span id="l23.70"> </span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-nsresult</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-nsGNOMEShellService::Init()</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-{</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+nsresult nsGNOMEShellService::Init() {</span>
<a href="#l23.75"></a><span id="l23.75">   nsresult rv;</span>
<a href="#l23.76"></a><span id="l23.76"> </span>
<a href="#l23.77"></a><span id="l23.77">   nsCOMPtr&lt;nsIGIOService&gt; giovfs = do_GetService(NS_GIOSERVICE_CONTRACTID);</span>
<a href="#l23.78"></a><span id="l23.78"> </span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-  if (!giovfs)</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+  if (!giovfs) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l23.82"></a><span id="l23.82"> </span>
<a href="#l23.83"></a><span id="l23.83">   // Check G_BROKEN_FILENAMES.  If it's set, then filenames in glib use</span>
<a href="#l23.84"></a><span id="l23.84">   // the locale encoding.  If it's not set, they use UTF-8.</span>
<a href="#l23.85"></a><span id="l23.85">   mUseLocaleFilenames = PR_GetEnv(&quot;G_BROKEN_FILENAMES&quot;) != nullptr;</span>
<a href="#l23.86"></a><span id="l23.86"> </span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-  if (GetAppPathFromLauncher())</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-      return NS_OK;</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+  if (GetAppPathFromLauncher()) return NS_OK;</span>
<a href="#l23.90"></a><span id="l23.90"> </span>
<a href="#l23.91"></a><span id="l23.91">   nsCOMPtr&lt;nsIFile&gt; appPath;</span>
<a href="#l23.92"></a><span id="l23.92">   rv = NS_GetSpecialDirectory(NS_XPCOM_CURRENT_PROCESS_DIR,</span>
<a href="#l23.93"></a><span id="l23.93">                               getter_AddRefs(appPath));</span>
<a href="#l23.94"></a><span id="l23.94">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.95"></a><span id="l23.95"> </span>
<a href="#l23.96"></a><span id="l23.96">   rv = appPath-&gt;AppendNative(NS_LITERAL_CSTRING(MOZ_APP_NAME));</span>
<a href="#l23.97"></a><span id="l23.97">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.98"></a><span id="l23.98"> </span>
<a href="#l23.99"></a><span id="l23.99">   rv = appPath-&gt;GetNativePath(mAppPath);</span>
<a href="#l23.100"></a><span id="l23.100">   return rv;</span>
<a href="#l23.101"></a><span id="l23.101"> }</span>
<a href="#l23.102"></a><span id="l23.102"> </span>
<a href="#l23.103"></a><span id="l23.103"> NS_IMPL_ISUPPORTS(nsGNOMEShellService, nsIShellService, nsIToolkitShellService)</span>
<a href="#l23.104"></a><span id="l23.104"> </span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-bool</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-nsGNOMEShellService::GetAppPathFromLauncher()</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-{</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+bool nsGNOMEShellService::GetAppPathFromLauncher() {</span>
<a href="#l23.109"></a><span id="l23.109">   gchar *tmp;</span>
<a href="#l23.110"></a><span id="l23.110"> </span>
<a href="#l23.111"></a><span id="l23.111">   const char *launcher = PR_GetEnv(&quot;MOZ_APP_LAUNCHER&quot;);</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-  if (!launcher)</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-    return false;</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+  if (!launcher) return false;</span>
<a href="#l23.115"></a><span id="l23.115"> </span>
<a href="#l23.116"></a><span id="l23.116">   if (g_path_is_absolute(launcher)) {</span>
<a href="#l23.117"></a><span id="l23.117">     mAppPath = launcher;</span>
<a href="#l23.118"></a><span id="l23.118">     tmp = g_path_get_basename(launcher);</span>
<a href="#l23.119"></a><span id="l23.119">     gchar *fullpath = g_find_program_in_path(tmp);</span>
<a href="#l23.120"></a><span id="l23.120">     if (fullpath &amp;&amp; mAppPath.Equals(fullpath)) {</span>
<a href="#l23.121"></a><span id="l23.121">       mAppIsInPath = true;</span>
<a href="#l23.122"></a><span id="l23.122">     }</span>
<a href="#l23.123"></a><span id="l23.123">     g_free(fullpath);</span>
<a href="#l23.124"></a><span id="l23.124">   } else {</span>
<a href="#l23.125"></a><span id="l23.125">     tmp = g_find_program_in_path(launcher);</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-    if (!tmp)</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-      return false;</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+    if (!tmp) return false;</span>
<a href="#l23.129"></a><span id="l23.129">     mAppPath = tmp;</span>
<a href="#l23.130"></a><span id="l23.130">     mAppIsInPath = true;</span>
<a href="#l23.131"></a><span id="l23.131">   }</span>
<a href="#l23.132"></a><span id="l23.132"> </span>
<a href="#l23.133"></a><span id="l23.133">   g_free(tmp);</span>
<a href="#l23.134"></a><span id="l23.134">   return true;</span>
<a href="#l23.135"></a><span id="l23.135"> }</span>
<a href="#l23.136"></a><span id="l23.136"> </span>
<a href="#l23.137"></a><span id="l23.137"> NS_IMETHODIMP</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-nsGNOMEShellService::IsDefaultClient(bool aStartupCheck, uint16_t aApps, bool * aIsDefaultClient)</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineminus">-{</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+nsGNOMEShellService::IsDefaultClient(bool aStartupCheck, uint16_t aApps,</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+                                     bool *aIsDefaultClient) {</span>
<a href="#l23.142"></a><span id="l23.142">   *aIsDefaultClient = true;</span>
<a href="#l23.143"></a><span id="l23.143"> </span>
<a href="#l23.144"></a><span id="l23.144">   for (unsigned int i = 0; i &lt; MOZ_ARRAY_LENGTH(sAppTypes); i++) {</span>
<a href="#l23.145"></a><span id="l23.145">     if (aApps &amp; sAppTypes[i].type)</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-      *aIsDefaultClient &amp;= checkDefault(sAppTypes[i].protocols,</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-                                        sAppTypes[i].protocolsLength);</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineplus">+      *aIsDefaultClient &amp;=</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineplus">+          checkDefault(sAppTypes[i].protocols, sAppTypes[i].protocolsLength);</span>
<a href="#l23.150"></a><span id="l23.150">   }</span>
<a href="#l23.151"></a><span id="l23.151"> </span>
<a href="#l23.152"></a><span id="l23.152">   // If this is the first mail window, maintain internal state that we've</span>
<a href="#l23.153"></a><span id="l23.153">   // checked this session (so that subsequent window opens don't show the</span>
<a href="#l23.154"></a><span id="l23.154">   // default client dialog).</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineminus">-  if (aStartupCheck)</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-    mCheckedThisSession = true;</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+  if (aStartupCheck) mCheckedThisSession = true;</span>
<a href="#l23.158"></a><span id="l23.158">   return NS_OK;</span>
<a href="#l23.159"></a><span id="l23.159"> }</span>
<a href="#l23.160"></a><span id="l23.160"> </span>
<a href="#l23.161"></a><span id="l23.161"> NS_IMETHODIMP</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-nsGNOMEShellService::SetDefaultClient(bool aForAllUsers, uint16_t aApps)</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-{</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineplus">+nsGNOMEShellService::SetDefaultClient(bool aForAllUsers, uint16_t aApps) {</span>
<a href="#l23.165"></a><span id="l23.165">   nsresult rv = NS_OK;</span>
<a href="#l23.166"></a><span id="l23.166">   for (unsigned int i = 0; i &lt; MOZ_ARRAY_LENGTH(sAppTypes); i++) {</span>
<a href="#l23.167"></a><span id="l23.167">     if (aApps &amp; sAppTypes[i].type) {</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-      nsresult tmp = MakeDefault(sAppTypes[i].protocols,</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-                                 sAppTypes[i].protocolsLength,</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-                                 sAppTypes[i].mimeType,</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-                                 sAppTypes[i].extensions);</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineplus">+      nsresult tmp =</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineplus">+          MakeDefault(sAppTypes[i].protocols, sAppTypes[i].protocolsLength,</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineplus">+                      sAppTypes[i].mimeType, sAppTypes[i].extensions);</span>
<a href="#l23.175"></a><span id="l23.175">       if (NS_FAILED(tmp)) {</span>
<a href="#l23.176"></a><span id="l23.176">         rv = tmp;</span>
<a href="#l23.177"></a><span id="l23.177">       }</span>
<a href="#l23.178"></a><span id="l23.178">     }</span>
<a href="#l23.179"></a><span id="l23.179">   }</span>
<a href="#l23.180"></a><span id="l23.180"> </span>
<a href="#l23.181"></a><span id="l23.181">   return rv;</span>
<a href="#l23.182"></a><span id="l23.182"> }</span>
<a href="#l23.183"></a><span id="l23.183"> </span>
<a href="#l23.184"></a><span id="l23.184"> NS_IMETHODIMP</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-nsGNOMEShellService::GetShouldCheckDefaultClient(bool* aResult)</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-{</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-  if (mCheckedThisSession)</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-  {</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineplus">+nsGNOMEShellService::GetShouldCheckDefaultClient(bool *aResult) {</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineplus">+  if (mCheckedThisSession) {</span>
<a href="#l23.191"></a><span id="l23.191">     *aResult = false;</span>
<a href="#l23.192"></a><span id="l23.192">     return NS_OK;</span>
<a href="#l23.193"></a><span id="l23.193">   }</span>
<a href="#l23.194"></a><span id="l23.194"> </span>
<a href="#l23.195"></a><span id="l23.195">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l23.196"></a><span id="l23.196">   return prefs-&gt;GetBoolPref(&quot;mail.shell.checkDefaultClient&quot;, aResult);</span>
<a href="#l23.197"></a><span id="l23.197"> }</span>
<a href="#l23.198"></a><span id="l23.198"> </span>
<a href="#l23.199"></a><span id="l23.199"> NS_IMETHODIMP</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-nsGNOMEShellService::SetShouldCheckDefaultClient(bool aShouldCheck)</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-{</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineplus">+nsGNOMEShellService::SetShouldCheckDefaultClient(bool aShouldCheck) {</span>
<a href="#l23.203"></a><span id="l23.203">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l23.204"></a><span id="l23.204">   return prefs-&gt;SetBoolPref(&quot;mail.shell.checkDefaultClient&quot;, aShouldCheck);</span>
<a href="#l23.205"></a><span id="l23.205"> }</span>
<a href="#l23.206"></a><span id="l23.206"> </span>
<a href="#l23.207"></a><span id="l23.207" class="difflineminus">-bool</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-nsGNOMEShellService::KeyMatchesAppName(const char *aKeyValue) const</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineminus">-{</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineplus">+bool nsGNOMEShellService::KeyMatchesAppName(const char *aKeyValue) const {</span>
<a href="#l23.211"></a><span id="l23.211">   gchar *commandPath;</span>
<a href="#l23.212"></a><span id="l23.212">   if (mUseLocaleFilenames) {</span>
<a href="#l23.213"></a><span id="l23.213">     gchar *nativePath = g_filename_from_utf8(aKeyValue, -1, NULL, NULL, NULL);</span>
<a href="#l23.214"></a><span id="l23.214">     if (!nativePath) {</span>
<a href="#l23.215"></a><span id="l23.215">       NS_ERROR(&quot;Error converting path to filesystem encoding&quot;);</span>
<a href="#l23.216"></a><span id="l23.216">       return false;</span>
<a href="#l23.217"></a><span id="l23.217">     }</span>
<a href="#l23.218"></a><span id="l23.218"> </span>
<a href="#l23.219"></a><span id="l23.219">     commandPath = g_find_program_in_path(nativePath);</span>
<a href="#l23.220"></a><span id="l23.220">     g_free(nativePath);</span>
<a href="#l23.221"></a><span id="l23.221">   } else {</span>
<a href="#l23.222"></a><span id="l23.222">     commandPath = g_find_program_in_path(aKeyValue);</span>
<a href="#l23.223"></a><span id="l23.223">   }</span>
<a href="#l23.224"></a><span id="l23.224"> </span>
<a href="#l23.225"></a><span id="l23.225" class="difflineminus">-  if (!commandPath)</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineminus">-    return false;</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineplus">+  if (!commandPath) return false;</span>
<a href="#l23.228"></a><span id="l23.228"> </span>
<a href="#l23.229"></a><span id="l23.229">   bool matches = mAppPath.Equals(commandPath);</span>
<a href="#l23.230"></a><span id="l23.230">   g_free(commandPath);</span>
<a href="#l23.231"></a><span id="l23.231">   return matches;</span>
<a href="#l23.232"></a><span id="l23.232"> }</span>
<a href="#l23.233"></a><span id="l23.233"> </span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-bool</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-nsGNOMEShellService::CheckHandlerMatchesAppName(const nsACString &amp;handler) const</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-{</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineplus">+bool nsGNOMEShellService::CheckHandlerMatchesAppName(</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineplus">+    const nsACString &amp;handler) const {</span>
<a href="#l23.239"></a><span id="l23.239">   gint argc;</span>
<a href="#l23.240"></a><span id="l23.240">   gchar **argv;</span>
<a href="#l23.241"></a><span id="l23.241">   nsAutoCString command(handler);</span>
<a href="#l23.242"></a><span id="l23.242"> </span>
<a href="#l23.243"></a><span id="l23.243">   if (g_shell_parse_argv(command.get(), &amp;argc, &amp;argv, NULL)) {</span>
<a href="#l23.244"></a><span id="l23.244">     command.Assign(argv[0]);</span>
<a href="#l23.245"></a><span id="l23.245">     g_strfreev(argv);</span>
<a href="#l23.246"></a><span id="l23.246">   } else {</span>
<a href="#l23.247"></a><span id="l23.247">     return false;</span>
<a href="#l23.248"></a><span id="l23.248">   }</span>
<a href="#l23.249"></a><span id="l23.249"> </span>
<a href="#l23.250"></a><span id="l23.250">   return KeyMatchesAppName(command.get());</span>
<a href="#l23.251"></a><span id="l23.251"> }</span>
<a href="#l23.252"></a><span id="l23.252"> </span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-bool</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineminus">-nsGNOMEShellService::checkDefault(const char* const *aProtocols, unsigned int aLength)</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineminus">-{</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineplus">+bool nsGNOMEShellService::checkDefault(const char *const *aProtocols,</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineplus">+                                       unsigned int aLength) {</span>
<a href="#l23.258"></a><span id="l23.258">   nsCOMPtr&lt;nsIGIOService&gt; giovfs = do_GetService(NS_GIOSERVICE_CONTRACTID);</span>
<a href="#l23.259"></a><span id="l23.259"> </span>
<a href="#l23.260"></a><span id="l23.260">   nsAutoCString handler;</span>
<a href="#l23.261"></a><span id="l23.261">   nsresult rv;</span>
<a href="#l23.262"></a><span id="l23.262"> </span>
<a href="#l23.263"></a><span id="l23.263">   for (unsigned int i = 0; i &lt; aLength; ++i) {</span>
<a href="#l23.264"></a><span id="l23.264">     if (giovfs) {</span>
<a href="#l23.265"></a><span id="l23.265">       handler.Truncate();</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineat">@@ -251,43 +218,42 @@ nsGNOMEShellService::checkDefault(const </span>
<a href="#l23.267"></a><span id="l23.267">         return false;</span>
<a href="#l23.268"></a><span id="l23.268">       }</span>
<a href="#l23.269"></a><span id="l23.269">     }</span>
<a href="#l23.270"></a><span id="l23.270">   }</span>
<a href="#l23.271"></a><span id="l23.271"> </span>
<a href="#l23.272"></a><span id="l23.272">   return true;</span>
<a href="#l23.273"></a><span id="l23.273"> }</span>
<a href="#l23.274"></a><span id="l23.274"> </span>
<a href="#l23.275"></a><span id="l23.275" class="difflineminus">-nsresult</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineminus">-nsGNOMEShellService::MakeDefault(const char* const *aProtocols,</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineminus">-                                    unsigned int aProtocolsLength,</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineminus">-                                    const char *aMimeType,</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineminus">-                                    const char *aExtensions)</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineminus">-{</span>
<a href="#l23.281"></a><span id="l23.281" class="difflineplus">+nsresult nsGNOMEShellService::MakeDefault(const char *const *aProtocols,</span>
<a href="#l23.282"></a><span id="l23.282" class="difflineplus">+                                          unsigned int aProtocolsLength,</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineplus">+                                          const char *aMimeType,</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineplus">+                                          const char *aExtensions) {</span>
<a href="#l23.285"></a><span id="l23.285">   nsAutoCString appKeyValue;</span>
<a href="#l23.286"></a><span id="l23.286">   nsCOMPtr&lt;nsIGIOService&gt; giovfs = do_GetService(NS_GIOSERVICE_CONTRACTID);</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineminus">-  if(mAppIsInPath) {</span>
<a href="#l23.288"></a><span id="l23.288" class="difflineplus">+  if (mAppIsInPath) {</span>
<a href="#l23.289"></a><span id="l23.289">     // mAppPath is in the users path, so use only the basename as the launcher</span>
<a href="#l23.290"></a><span id="l23.290">     gchar *tmp = g_path_get_basename(mAppPath.get());</span>
<a href="#l23.291"></a><span id="l23.291">     appKeyValue = tmp;</span>
<a href="#l23.292"></a><span id="l23.292">     g_free(tmp);</span>
<a href="#l23.293"></a><span id="l23.293">   } else {</span>
<a href="#l23.294"></a><span id="l23.294">     appKeyValue = mAppPath;</span>
<a href="#l23.295"></a><span id="l23.295">   }</span>
<a href="#l23.296"></a><span id="l23.296"> </span>
<a href="#l23.297"></a><span id="l23.297">   appKeyValue.AppendLiteral(&quot; %s&quot;);</span>
<a href="#l23.298"></a><span id="l23.298"> </span>
<a href="#l23.299"></a><span id="l23.299">   nsresult rv;</span>
<a href="#l23.300"></a><span id="l23.300">   if (giovfs) {</span>
<a href="#l23.301"></a><span id="l23.301">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l23.304"></a><span id="l23.304">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l23.305"></a><span id="l23.305"> </span>
<a href="#l23.306"></a><span id="l23.306">     nsCOMPtr&lt;nsIStringBundle&gt; brandBundle;</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(BRAND_PROPERTIES, getter_AddRefs(brandBundle));</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(BRAND_PROPERTIES,</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineplus">+                                     getter_AddRefs(brandBundle));</span>
<a href="#l23.310"></a><span id="l23.310">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.311"></a><span id="l23.311"> </span>
<a href="#l23.312"></a><span id="l23.312">     nsString brandShortName;</span>
<a href="#l23.313"></a><span id="l23.313">     brandBundle-&gt;GetStringFromName(&quot;brandShortName&quot;, brandShortName);</span>
<a href="#l23.314"></a><span id="l23.314"> </span>
<a href="#l23.315"></a><span id="l23.315">     // use brandShortName as the application id.</span>
<a href="#l23.316"></a><span id="l23.316">     NS_ConvertUTF16toUTF8 id(brandShortName);</span>
<a href="#l23.317"></a><span id="l23.317"> </span>
<a href="#l23.318"></a><span id="l23.318" class="difflineat">@@ -297,15 +263,16 @@ nsGNOMEShellService::MakeDefault(const c</span>
<a href="#l23.319"></a><span id="l23.319"> </span>
<a href="#l23.320"></a><span id="l23.320">     for (unsigned int i = 0; i &lt; aProtocolsLength; ++i) {</span>
<a href="#l23.321"></a><span id="l23.321">       rv = app-&gt;SetAsDefaultForURIScheme(nsDependentCString(aProtocols[i]));</span>
<a href="#l23.322"></a><span id="l23.322">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.323"></a><span id="l23.323">       if (aMimeType)</span>
<a href="#l23.324"></a><span id="l23.324">         rv = app-&gt;SetAsDefaultForMimeType(nsDependentCString(aMimeType));</span>
<a href="#l23.325"></a><span id="l23.325">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.326"></a><span id="l23.326">       if (aExtensions)</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineminus">-        rv = app-&gt;SetAsDefaultForFileExtensions(nsDependentCString(aExtensions));</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineplus">+        rv =</span>
<a href="#l23.329"></a><span id="l23.329" class="difflineplus">+            app-&gt;SetAsDefaultForFileExtensions(nsDependentCString(aExtensions));</span>
<a href="#l23.330"></a><span id="l23.330">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.331"></a><span id="l23.331">     }</span>
<a href="#l23.332"></a><span id="l23.332">   }</span>
<a href="#l23.333"></a><span id="l23.333"> </span>
<a href="#l23.334"></a><span id="l23.334">   return NS_OK;</span>
<a href="#l23.335"></a><span id="l23.335"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/components/shell/nsGNOMEShellService.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/components/shell/nsGNOMEShellService.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -7,39 +7,43 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #define nsGNOMEShellService_h_</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsIShellService.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsString.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsToolkitShellService.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> #define BRAND_PROPERTIES &quot;chrome://branding/locale/brand.properties&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#define NS_MAILGNOMEINTEGRATION_CID \</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-{0xbddef0f4, 0x5e2d, 0x4846, {0xbd, 0xec, 0x86, 0xd0, 0x78, 0x1d, 0x8d, 0xed}}</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+#define NS_MAILGNOMEINTEGRATION_CID                  \</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+  {                                                  \</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+    0xbddef0f4, 0x5e2d, 0x4846, {                    \</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+      0xbd, 0xec, 0x86, 0xd0, 0x78, 0x1d, 0x8d, 0xed \</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+    }                                                \</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+  }</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-class nsGNOMEShellService : public nsIShellService, public nsToolkitShellService</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-{</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-public:</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+class nsGNOMEShellService : public nsIShellService,</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+                            public nsToolkitShellService {</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+ public:</span>
<a href="#l24.27"></a><span id="l24.27">   NS_DECL_ISUPPORTS</span>
<a href="#l24.28"></a><span id="l24.28">   NS_DECL_NSISHELLSERVICE</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30">   NS_HIDDEN_(nsresult) Init();</span>
<a href="#l24.31"></a><span id="l24.31">   nsGNOMEShellService();</span>
<a href="#l24.32"></a><span id="l24.32"> </span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-protected:</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  virtual ~nsGNOMEShellService() {};</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+ protected:</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+  virtual ~nsGNOMEShellService(){};</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38">   bool KeyMatchesAppName(const char *aKeyValue) const;</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-  bool checkDefault(const char* const *aProtocols, unsigned int aLength);</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-  nsresult MakeDefault(const char* const *aProtocols,</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-                       unsigned int aProtocolsLength,</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-                       const char *mimeType,</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+  bool checkDefault(const char *const *aProtocols, unsigned int aLength);</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+  nsresult MakeDefault(const char *const *aProtocols,</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+                       unsigned int aProtocolsLength, const char *mimeType,</span>
<a href="#l24.46"></a><span id="l24.46">                        const char *extensions);</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-private:</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+ private:</span>
<a href="#l24.50"></a><span id="l24.50">   bool GetAppPathFromLauncher();</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-  bool CheckHandlerMatchesAppName(const nsACString&amp; handler) const;</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+  bool CheckHandlerMatchesAppName(const nsACString &amp;handler) const;</span>
<a href="#l24.53"></a><span id="l24.53">   bool mUseLocaleFilenames;</span>
<a href="#l24.54"></a><span id="l24.54">   bool mCheckedThisSession;</span>
<a href="#l24.55"></a><span id="l24.55">   nsCString mAppPath;</span>
<a href="#l24.56"></a><span id="l24.56">   bool mAppIsInPath;</span>
<a href="#l24.57"></a><span id="l24.57"> };</span>
<a href="#l24.58"></a><span id="l24.58"> </span>
<a href="#l24.59"></a><span id="l24.59"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/components/shell/nsMacShellService.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/components/shell/nsMacShellService.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -11,87 +11,79 @@</span>
<a href="#l25.4"></a><span id="l25.4"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l25.5"></a><span id="l25.5"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l25.6"></a><span id="l25.6"> #include &quot;nsString.h&quot;</span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsEmbedCID.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9"> // These Launch Services functions are undocumented. We're using them since</span>
<a href="#l25.10"></a><span id="l25.10"> // they're the only way to set the default opener for URLs</span>
<a href="#l25.11"></a><span id="l25.11"> extern &quot;C&quot; {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  // Returns the CFURL for application currently set as the default opener for</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  // the given URL scheme. appURL must be released by the caller.</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-  extern OSStatus _LSCopyDefaultSchemeHandlerURL(CFStringRef scheme,</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-                                                 CFURLRef *appURL);</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-  extern OSStatus _LSSetDefaultSchemeHandlerURL(CFStringRef scheme,</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-                                                CFURLRef appURL);</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-  extern OSStatus _LSSaveAndRefresh(void);</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+// Returns the CFURL for application currently set as the default opener for</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+// the given URL scheme. appURL must be released by the caller.</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+extern OSStatus _LSCopyDefaultSchemeHandlerURL(CFStringRef scheme,</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+                                               CFURLRef* appURL);</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+extern OSStatus _LSSetDefaultSchemeHandlerURL(CFStringRef scheme,</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+                                              CFURLRef appURL);</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+extern OSStatus _LSSaveAndRefresh(void);</span>
<a href="#l25.26"></a><span id="l25.26"> }</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28"> NS_IMPL_ISUPPORTS(nsMacShellService, nsIShellService, nsIToolkitShellService)</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-nsMacShellService::nsMacShellService(): mCheckedThisSession(false)</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-{}</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+nsMacShellService::nsMacShellService() : mCheckedThisSession(false) {}</span>
<a href="#l25.33"></a><span id="l25.33"> </span>
<a href="#l25.34"></a><span id="l25.34"> NS_IMETHODIMP</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-nsMacShellService::IsDefaultClient(bool aStartupCheck, uint16_t aApps, bool * aIsDefaultClient)</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-{</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+nsMacShellService::IsDefaultClient(bool aStartupCheck, uint16_t aApps,</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+                                   bool* aIsDefaultClient) {</span>
<a href="#l25.39"></a><span id="l25.39">   *aIsDefaultClient = true;</span>
<a href="#l25.40"></a><span id="l25.40">   if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l25.41"></a><span id="l25.41">     *aIsDefaultClient &amp;= isDefaultHandlerForProtocol(CFSTR(&quot;mailto&quot;));</span>
<a href="#l25.42"></a><span id="l25.42">   if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l25.43"></a><span id="l25.43">     *aIsDefaultClient &amp;= isDefaultHandlerForProtocol(CFSTR(&quot;news&quot;));</span>
<a href="#l25.44"></a><span id="l25.44">   if (aApps &amp; nsIShellService::RSS)</span>
<a href="#l25.45"></a><span id="l25.45">     *aIsDefaultClient &amp;= isDefaultHandlerForProtocol(CFSTR(&quot;feed&quot;));</span>
<a href="#l25.46"></a><span id="l25.46"> </span>
<a href="#l25.47"></a><span id="l25.47">   // if this is the first mail window, maintain internal state that we've</span>
<a href="#l25.48"></a><span id="l25.48">   // checked this session (so that subsequent window opens don't show the</span>
<a href="#l25.49"></a><span id="l25.49">   // default client dialog.</span>
<a href="#l25.50"></a><span id="l25.50"> </span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-  if (aStartupCheck)</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-    mCheckedThisSession = true;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+  if (aStartupCheck) mCheckedThisSession = true;</span>
<a href="#l25.54"></a><span id="l25.54">   return NS_OK;</span>
<a href="#l25.55"></a><span id="l25.55"> }</span>
<a href="#l25.56"></a><span id="l25.56"> </span>
<a href="#l25.57"></a><span id="l25.57"> NS_IMETHODIMP</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-nsMacShellService::SetDefaultClient(bool aForAllUsers, uint16_t aApps)</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-{</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+nsMacShellService::SetDefaultClient(bool aForAllUsers, uint16_t aApps) {</span>
<a href="#l25.61"></a><span id="l25.61">   nsresult rv = NS_OK;</span>
<a href="#l25.62"></a><span id="l25.62">   if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l25.63"></a><span id="l25.63">     rv = setAsDefaultHandlerForProtocol(CFSTR(&quot;mailto&quot;));</span>
<a href="#l25.64"></a><span id="l25.64">   if (NS_SUCCEEDED(rv) &amp;&amp; aApps &amp; nsIShellService::NEWS)</span>
<a href="#l25.65"></a><span id="l25.65">     rv = setAsDefaultHandlerForProtocol(CFSTR(&quot;news&quot;));</span>
<a href="#l25.66"></a><span id="l25.66">   if (NS_SUCCEEDED(rv) &amp;&amp; aApps &amp; nsIShellService::RSS)</span>
<a href="#l25.67"></a><span id="l25.67">     rv = setAsDefaultHandlerForProtocol(CFSTR(&quot;feed&quot;));</span>
<a href="#l25.68"></a><span id="l25.68"> </span>
<a href="#l25.69"></a><span id="l25.69">   return rv;</span>
<a href="#l25.70"></a><span id="l25.70"> }</span>
<a href="#l25.71"></a><span id="l25.71"> </span>
<a href="#l25.72"></a><span id="l25.72"> NS_IMETHODIMP</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-nsMacShellService::GetShouldCheckDefaultClient(bool* aResult)</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-{</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-  if (mCheckedThisSession)</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-  {</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+nsMacShellService::GetShouldCheckDefaultClient(bool* aResult) {</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+  if (mCheckedThisSession) {</span>
<a href="#l25.79"></a><span id="l25.79">     *aResult = false;</span>
<a href="#l25.80"></a><span id="l25.80">     return NS_OK;</span>
<a href="#l25.81"></a><span id="l25.81">   }</span>
<a href="#l25.82"></a><span id="l25.82"> </span>
<a href="#l25.83"></a><span id="l25.83">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l25.84"></a><span id="l25.84">   return prefs-&gt;GetBoolPref(&quot;mail.shell.checkDefaultClient&quot;, aResult);</span>
<a href="#l25.85"></a><span id="l25.85"> }</span>
<a href="#l25.86"></a><span id="l25.86"> </span>
<a href="#l25.87"></a><span id="l25.87"> NS_IMETHODIMP</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-nsMacShellService::SetShouldCheckDefaultClient(bool aShouldCheck)</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-{</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+nsMacShellService::SetShouldCheckDefaultClient(bool aShouldCheck) {</span>
<a href="#l25.91"></a><span id="l25.91">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l25.92"></a><span id="l25.92">   return prefs-&gt;SetBoolPref(&quot;mail.shell.checkDefaultClient&quot;, aShouldCheck);</span>
<a href="#l25.93"></a><span id="l25.93"> }</span>
<a href="#l25.94"></a><span id="l25.94"> </span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-bool</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-nsMacShellService::isDefaultHandlerForProtocol(CFStringRef aScheme)</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-{</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+bool nsMacShellService::isDefaultHandlerForProtocol(CFStringRef aScheme) {</span>
<a href="#l25.99"></a><span id="l25.99">   bool isDefault = false;</span>
<a href="#l25.100"></a><span id="l25.100">   // Since neither Launch Services nor Internet Config actually differ between</span>
<a href="#l25.101"></a><span id="l25.101">   // bundles which have the same bundle identifier (That is, if we set our</span>
<a href="#l25.102"></a><span id="l25.102">   // URL of our bundle as the default handler for the given protocol,</span>
<a href="#l25.103"></a><span id="l25.103">   // Launch Service might return the URL of another thunderbird bundle as the</span>
<a href="#l25.104"></a><span id="l25.104">   // default handler for that protocol), we are comparing the identifiers of the</span>
<a href="#l25.105"></a><span id="l25.105">   // bundles rather than their URLs.</span>
<a href="#l25.106"></a><span id="l25.106"> </span>
<a href="#l25.107"></a><span id="l25.107" class="difflineat">@@ -102,60 +94,53 @@ nsMacShellService::isDefaultHandlerForPr</span>
<a href="#l25.108"></a><span id="l25.108">     // that means a failure, since our bundle does have an identifier.</span>
<a href="#l25.109"></a><span id="l25.109">     return isDefault;</span>
<a href="#l25.110"></a><span id="l25.110">   }</span>
<a href="#l25.111"></a><span id="l25.111"> </span>
<a href="#l25.112"></a><span id="l25.112">   ::CFRetain(tbirdID);</span>
<a href="#l25.113"></a><span id="l25.113"> </span>
<a href="#l25.114"></a><span id="l25.114">   // Get the default handler URL of the given protocol</span>
<a href="#l25.115"></a><span id="l25.115">   CFURLRef defaultHandlerURL;</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-  OSStatus err = ::_LSCopyDefaultSchemeHandlerURL(aScheme,</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-                                                  &amp;defaultHandlerURL);</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineplus">+  OSStatus err = ::_LSCopyDefaultSchemeHandlerURL(aScheme, &amp;defaultHandlerURL);</span>
<a href="#l25.119"></a><span id="l25.119"> </span>
<a href="#l25.120"></a><span id="l25.120">   if (err == noErr) {</span>
<a href="#l25.121"></a><span id="l25.121">     // Get a reference to the bundle (based on its URL)</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-    CFBundleRef defaultHandlerBundle = ::CFBundleCreate(NULL,</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-                                                        defaultHandlerURL);</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+    CFBundleRef defaultHandlerBundle =</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+        ::CFBundleCreate(NULL, defaultHandlerURL);</span>
<a href="#l25.126"></a><span id="l25.126">     if (defaultHandlerBundle) {</span>
<a href="#l25.127"></a><span id="l25.127">       CFStringRef defaultHandlerID =</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-        ::CFBundleGetIdentifier(defaultHandlerBundle);</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+          ::CFBundleGetIdentifier(defaultHandlerBundle);</span>
<a href="#l25.130"></a><span id="l25.130">       if (defaultHandlerID) {</span>
<a href="#l25.131"></a><span id="l25.131">         ::CFRetain(defaultHandlerID);</span>
<a href="#l25.132"></a><span id="l25.132">         // and compare it to our bundle identifier</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-        isDefault = ::CFStringCompare(tbirdID, defaultHandlerID, 0)</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-                       == kCFCompareEqualTo;</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+        isDefault = ::CFStringCompare(tbirdID, defaultHandlerID, 0) ==</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineplus">+                    kCFCompareEqualTo;</span>
<a href="#l25.137"></a><span id="l25.137">         ::CFRelease(defaultHandlerID);</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-      }</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-      else {</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineplus">+      } else {</span>
<a href="#l25.141"></a><span id="l25.141">         // If the bundle doesn't have an identifier in its info property list,</span>
<a href="#l25.142"></a><span id="l25.142">         // it's not our bundle.</span>
<a href="#l25.143"></a><span id="l25.143">         isDefault = false;</span>
<a href="#l25.144"></a><span id="l25.144">       }</span>
<a href="#l25.145"></a><span id="l25.145"> </span>
<a href="#l25.146"></a><span id="l25.146">       ::CFRelease(defaultHandlerBundle);</span>
<a href="#l25.147"></a><span id="l25.147">     }</span>
<a href="#l25.148"></a><span id="l25.148"> </span>
<a href="#l25.149"></a><span id="l25.149">     ::CFRelease(defaultHandlerURL);</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineminus">-  }</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-  else {</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+  } else {</span>
<a href="#l25.153"></a><span id="l25.153">     // If |_LSCopyDefaultSchemeHandlerURL| failed, there's no default</span>
<a href="#l25.154"></a><span id="l25.154">     // handler for the given protocol</span>
<a href="#l25.155"></a><span id="l25.155">     isDefault = false;</span>
<a href="#l25.156"></a><span id="l25.156">   }</span>
<a href="#l25.157"></a><span id="l25.157"> </span>
<a href="#l25.158"></a><span id="l25.158">   ::CFRelease(tbirdID);</span>
<a href="#l25.159"></a><span id="l25.159">   return isDefault;</span>
<a href="#l25.160"></a><span id="l25.160"> }</span>
<a href="#l25.161"></a><span id="l25.161"> </span>
<a href="#l25.162"></a><span id="l25.162" class="difflineminus">-nsresult</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineminus">-nsMacShellService::setAsDefaultHandlerForProtocol(CFStringRef aScheme)</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineminus">-{</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineplus">+nsresult nsMacShellService::setAsDefaultHandlerForProtocol(</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+    CFStringRef aScheme) {</span>
<a href="#l25.167"></a><span id="l25.167">   CFURLRef tbirdURL = ::CFBundleCopyBundleURL(CFBundleGetMainBundle());</span>
<a href="#l25.168"></a><span id="l25.168"> </span>
<a href="#l25.169"></a><span id="l25.169">   ::_LSSetDefaultSchemeHandlerURL(aScheme, tbirdURL);</span>
<a href="#l25.170"></a><span id="l25.170">   ::_LSSaveAndRefresh();</span>
<a href="#l25.171"></a><span id="l25.171">   ::CFRelease(tbirdURL);</span>
<a href="#l25.172"></a><span id="l25.172"> </span>
<a href="#l25.173"></a><span id="l25.173">   return NS_OK;</span>
<a href="#l25.174"></a><span id="l25.174"> }</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/components/shell/nsMacShellService.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/components/shell/nsMacShellService.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -7,27 +7,30 @@</span>
<a href="#l26.4"></a><span id="l26.4"> #define nsMacShellService_h_</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> #include &quot;nsIShellService.h&quot;</span>
<a href="#l26.7"></a><span id="l26.7"> #include &quot;nsString.h&quot;</span>
<a href="#l26.8"></a><span id="l26.8"> #include &quot;nsToolkitShellService.h&quot;</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> #include &lt;CoreFoundation/CoreFoundation.h&gt;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-#define NS_MAILMACINTEGRATION_CID \</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-{0x85a27035, 0xb970, 0x4079, {0xb9, 0xd2, 0xe2, 0x1f, 0x69, 0xe6, 0xb2, 0x1f}}</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+#define NS_MAILMACINTEGRATION_CID                    \</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+  {                                                  \</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+    0x85a27035, 0xb970, 0x4079, {                    \</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+      0xb9, 0xd2, 0xe2, 0x1f, 0x69, 0xe6, 0xb2, 0x1f \</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+    }                                                \</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+  }</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-class nsMacShellService : public nsIShellService, public nsToolkitShellService</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-{</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-public:</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+class nsMacShellService : public nsIShellService, public nsToolkitShellService {</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+ public:</span>
<a href="#l26.26"></a><span id="l26.26">   NS_DECL_ISUPPORTS</span>
<a href="#l26.27"></a><span id="l26.27">   NS_DECL_NSISHELLSERVICE</span>
<a href="#l26.28"></a><span id="l26.28">   nsMacShellService();</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-protected:</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+ protected:</span>
<a href="#l26.32"></a><span id="l26.32">   bool isDefaultHandlerForProtocol(CFStringRef aScheme);</span>
<a href="#l26.33"></a><span id="l26.33">   nsresult setAsDefaultHandlerForProtocol(CFStringRef aScheme);</span>
<a href="#l26.34"></a><span id="l26.34"> </span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-private:</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-  virtual ~nsMacShellService() {};</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+ private:</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+  virtual ~nsMacShellService(){};</span>
<a href="#l26.39"></a><span id="l26.39">   bool mCheckedThisSession;</span>
<a href="#l26.40"></a><span id="l26.40"> };</span>
<a href="#l26.41"></a><span id="l26.41"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/components/shell/nsToolkitShellService.h</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/components/shell/nsToolkitShellService.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -5,20 +5,19 @@</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> #ifndef nstoolkitshellservice_h____</span>
<a href="#l27.6"></a><span id="l27.6"> #define nstoolkitshellservice_h____</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> #include &quot;nsIToolkitShellService.h&quot;</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> class nsToolkitShellService : public nsIToolkitShellService {</span>
<a href="#l27.11"></a><span id="l27.11">  public:</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  NS_IMETHOD IsDefaultClient(bool aStartupCheck,</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-                             uint16_t aApps,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+  NS_IMETHOD IsDefaultClient(bool aStartupCheck, uint16_t aApps,</span>
<a href="#l27.15"></a><span id="l27.15">                              bool* aIsDefaultClient) = 0;</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17">   NS_IMETHODIMP IsDefaultApplication(bool* aIsDefaultClient) {</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-    // This does some OS-specific checking: GConf on Linux, mailto/news protocol handler on Mac,</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-    // registry and application association checks on Windows.</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+    // This does some OS-specific checking: GConf on Linux, mailto/news protocol</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+    // handler on Mac, registry and application association checks on Windows.</span>
<a href="#l27.22"></a><span id="l27.22">     return IsDefaultClient(false, nsIShellService::MAIL, aIsDefaultClient);</span>
<a href="#l27.23"></a><span id="l27.23">   }</span>
<a href="#l27.24"></a><span id="l27.24"> };</span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26"> #endif  // nstoolkitshellservice_h____</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/components/shell/nsWindowsShellService.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/components/shell/nsWindowsShellService.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -14,125 +14,121 @@</span>
<a href="#l28.4"></a><span id="l28.4"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;nsIProperties.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsString.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11"> #ifdef _WIN32_WINNT</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-#undef _WIN32_WINNT</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+#  undef _WIN32_WINNT</span>
<a href="#l28.14"></a><span id="l28.14"> #endif</span>
<a href="#l28.15"></a><span id="l28.15"> #define _WIN32_WINNT 0x0600</span>
<a href="#l28.16"></a><span id="l28.16"> #define INITGUID</span>
<a href="#l28.17"></a><span id="l28.17"> #include &lt;shlobj.h&gt;</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19"> #include &lt;mbstring.h&gt;</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21"> #ifndef MAX_BUF</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-#define MAX_BUF 4096</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+#  define MAX_BUF 4096</span>
<a href="#l28.24"></a><span id="l28.24"> #endif</span>
<a href="#l28.25"></a><span id="l28.25"> </span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-#define REG_FAILED(val) \</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-  (val != ERROR_SUCCESS)</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-NS_IMPL_ISUPPORTS(nsWindowsShellService, nsIShellService, nsIToolkitShellService)</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+#define REG_FAILED(val) (val != ERROR_SUCCESS)</span>
<a href="#l28.31"></a><span id="l28.31"> </span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-static nsresult</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-OpenKeyForReading(HKEY aKeyRoot, const nsAString&amp; aKeyName, HKEY* aKey)</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-{</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-  const nsString &amp;flatName = PromiseFlatString(aKeyName);</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+NS_IMPL_ISUPPORTS(nsWindowsShellService, nsIShellService,</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+                  nsIToolkitShellService)</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+static nsresult OpenKeyForReading(HKEY aKeyRoot, const nsAString&amp; aKeyName,</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+                                  HKEY* aKey) {</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+  const nsString&amp; flatName = PromiseFlatString(aKeyName);</span>
<a href="#l28.42"></a><span id="l28.42"> </span>
<a href="#l28.43"></a><span id="l28.43">   DWORD res = ::RegOpenKeyExW(aKeyRoot, flatName.get(), 0, KEY_READ, aKey);</span>
<a href="#l28.44"></a><span id="l28.44">   switch (res) {</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-  case ERROR_SUCCESS:</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-    break;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-  case ERROR_ACCESS_DENIED:</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-    return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-  case ERROR_FILE_NOT_FOUND:</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+    case ERROR_SUCCESS:</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+      break;</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+    case ERROR_ACCESS_DENIED:</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+      return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+    case ERROR_FILE_NOT_FOUND:</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+      return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.57"></a><span id="l28.57">   }</span>
<a href="#l28.58"></a><span id="l28.58"> </span>
<a href="#l28.59"></a><span id="l28.59">   return NS_OK;</span>
<a href="#l28.60"></a><span id="l28.60"> }</span>
<a href="#l28.61"></a><span id="l28.61"> </span>
<a href="#l28.62"></a><span id="l28.62"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.63"></a><span id="l28.63"> // Default Mail Registry Settings</span>
<a href="#l28.64"></a><span id="l28.64"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.65"></a><span id="l28.65"> </span>
<a href="#l28.66"></a><span id="l28.66"> typedef enum {</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-  NO_SUBSTITUTION    = 0x00,</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-  APP_PATH_SUBSTITUTION  = 0x01</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+  NO_SUBSTITUTION = 0x00,</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+  APP_PATH_SUBSTITUTION = 0x01</span>
<a href="#l28.71"></a><span id="l28.71"> } SettingFlags;</span>
<a href="#l28.72"></a><span id="l28.72"> </span>
<a href="#l28.73"></a><span id="l28.73"> // APP_REG_NAME_MAIL and APP_REG_NAME_NEWS should be kept in synch with</span>
<a href="#l28.74"></a><span id="l28.74"> // AppRegNameMail and AppRegNameNews in the installer file: defines.nsi.in</span>
<a href="#l28.75"></a><span id="l28.75"> #define APP_REG_NAME_MAIL L&quot;Thunderbird&quot;</span>
<a href="#l28.76"></a><span id="l28.76"> #define APP_REG_NAME_NEWS L&quot;Thunderbird (News)&quot;</span>
<a href="#l28.77"></a><span id="l28.77"> #define CLS_EML &quot;ThunderbirdEML&quot;</span>
<a href="#l28.78"></a><span id="l28.78"> #define CLS_MAILTOURL &quot;Thunderbird.Url.mailto&quot;</span>
<a href="#l28.79"></a><span id="l28.79"> #define CLS_NEWSURL &quot;Thunderbird.Url.news&quot;</span>
<a href="#l28.80"></a><span id="l28.80"> #define CLS_FEEDURL &quot;Thunderbird.Url.feed&quot;</span>
<a href="#l28.81"></a><span id="l28.81"> #define SOP &quot;\\shell\\open\\command&quot;</span>
<a href="#l28.82"></a><span id="l28.82"> #define VAL_OPEN &quot;\&quot;%APPPATH%\&quot; \&quot;%1\&quot;&quot;</span>
<a href="#l28.83"></a><span id="l28.83"> #define VAL_MAIL_OPEN &quot;\&quot;%APPPATH%\&quot; -osint -mail \&quot;%1\&quot;&quot;</span>
<a href="#l28.84"></a><span id="l28.84"> #define VAL_COMPOSE_OPEN &quot;\&quot;%APPPATH%\&quot; -osint -compose \&quot;%1\&quot;&quot;</span>
<a href="#l28.85"></a><span id="l28.85"> </span>
<a href="#l28.86"></a><span id="l28.86" class="difflineminus">-#define MAKE_KEY_NAME1(PREFIX, MID) \</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineminus">-  PREFIX MID</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+#define MAKE_KEY_NAME1(PREFIX, MID) PREFIX MID</span>
<a href="#l28.89"></a><span id="l28.89"> </span>
<a href="#l28.90"></a><span id="l28.90"> static SETTING gMailSettings[] = {</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-  // File Extension Class</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineminus">-  { &quot;.eml&quot;, &quot;&quot;,  CLS_EML, NO_SUBSTITUTION },</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+    // File Extension Class</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+    {&quot;.eml&quot;, &quot;&quot;, CLS_EML, NO_SUBSTITUTION},</span>
<a href="#l28.95"></a><span id="l28.95"> </span>
<a href="#l28.96"></a><span id="l28.96" class="difflineminus">-  // File Extension Class</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineminus">-  { MAKE_KEY_NAME1(CLS_EML, SOP), &quot;&quot;,  VAL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineplus">+    // File Extension Class</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+    {MAKE_KEY_NAME1(CLS_EML, SOP), &quot;&quot;, VAL_OPEN, APP_PATH_SUBSTITUTION},</span>
<a href="#l28.100"></a><span id="l28.100"> </span>
<a href="#l28.101"></a><span id="l28.101" class="difflineminus">-  // Protocol Handler Class - for Vista and above</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineminus">-  { MAKE_KEY_NAME1(CLS_MAILTOURL, SOP), &quot;&quot;, VAL_COMPOSE_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineplus">+    // Protocol Handler Class - for Vista and above</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+    {MAKE_KEY_NAME1(CLS_MAILTOURL, SOP), &quot;&quot;, VAL_COMPOSE_OPEN,</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+     APP_PATH_SUBSTITUTION},</span>
<a href="#l28.106"></a><span id="l28.106"> </span>
<a href="#l28.107"></a><span id="l28.107" class="difflineminus">-  // Protocol Handlers</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineminus">-  { MAKE_KEY_NAME1(&quot;mailto&quot;, SOP), &quot;&quot;, VAL_COMPOSE_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+    // Protocol Handlers</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+    {MAKE_KEY_NAME1(&quot;mailto&quot;, SOP), &quot;&quot;, VAL_COMPOSE_OPEN,</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineplus">+     APP_PATH_SUBSTITUTION},</span>
<a href="#l28.112"></a><span id="l28.112"> };</span>
<a href="#l28.113"></a><span id="l28.113"> </span>
<a href="#l28.114"></a><span id="l28.114"> static SETTING gNewsSettings[] = {</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineminus">-   // Protocol Handler Class - for Vista and above</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineminus">-  { MAKE_KEY_NAME1(CLS_NEWSURL, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+    // Protocol Handler Class - for Vista and above</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+    {MAKE_KEY_NAME1(CLS_NEWSURL, SOP), &quot;&quot;, VAL_MAIL_OPEN,</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+     APP_PATH_SUBSTITUTION},</span>
<a href="#l28.120"></a><span id="l28.120"> </span>
<a href="#l28.121"></a><span id="l28.121" class="difflineminus">-  // Protocol Handlers</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineminus">-  { MAKE_KEY_NAME1(&quot;news&quot;, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineminus">-  { MAKE_KEY_NAME1(&quot;nntp&quot;, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+    // Protocol Handlers</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+    {MAKE_KEY_NAME1(&quot;news&quot;, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION},</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineplus">+    {MAKE_KEY_NAME1(&quot;nntp&quot;, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION},</span>
<a href="#l28.127"></a><span id="l28.127"> };</span>
<a href="#l28.128"></a><span id="l28.128"> </span>
<a href="#l28.129"></a><span id="l28.129" class="difflineminus">-nsresult</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineminus">-GetHelperPath(nsAutoString&amp; aPath)</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineminus">-{</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineplus">+nsresult GetHelperPath(nsAutoString&amp; aPath) {</span>
<a href="#l28.133"></a><span id="l28.133">   nsresult rv;</span>
<a href="#l28.134"></a><span id="l28.134">   nsCOMPtr&lt;nsIProperties&gt; directoryService =</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineminus">-    do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+      do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l28.137"></a><span id="l28.137">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.138"></a><span id="l28.138"> </span>
<a href="#l28.139"></a><span id="l28.139">   nsCOMPtr&lt;nsIFile&gt; appHelper;</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineminus">-  rv = directoryService-&gt;Get(NS_XPCOM_CURRENT_PROCESS_DIR,</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineminus">-                             NS_GET_IID(nsIFile),</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineplus">+  rv = directoryService-&gt;Get(NS_XPCOM_CURRENT_PROCESS_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l28.143"></a><span id="l28.143">                              getter_AddRefs(appHelper));</span>
<a href="#l28.144"></a><span id="l28.144">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.145"></a><span id="l28.145"> </span>
<a href="#l28.146"></a><span id="l28.146">   rv = appHelper-&gt;Append(NS_LITERAL_STRING(&quot;uninstall&quot;));</span>
<a href="#l28.147"></a><span id="l28.147">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.148"></a><span id="l28.148"> </span>
<a href="#l28.149"></a><span id="l28.149">   rv = appHelper-&gt;Append(NS_LITERAL_STRING(&quot;helper.exe&quot;));</span>
<a href="#l28.150"></a><span id="l28.150">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.151"></a><span id="l28.151"> </span>
<a href="#l28.152"></a><span id="l28.152">   return appHelper-&gt;GetPath(aPath);</span>
<a href="#l28.153"></a><span id="l28.153"> }</span>
<a href="#l28.154"></a><span id="l28.154"> </span>
<a href="#l28.155"></a><span id="l28.155" class="difflineminus">-nsresult</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineminus">-LaunchHelper(nsAutoString&amp; aPath, nsAutoString&amp; aParams)</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineminus">-{</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineplus">+nsresult LaunchHelper(nsAutoString&amp; aPath, nsAutoString&amp; aParams) {</span>
<a href="#l28.159"></a><span id="l28.159">   SHELLEXECUTEINFOW executeInfo = {0};</span>
<a href="#l28.160"></a><span id="l28.160"> </span>
<a href="#l28.161"></a><span id="l28.161">   executeInfo.cbSize = sizeof(SHELLEXECUTEINFOW);</span>
<a href="#l28.162"></a><span id="l28.162">   executeInfo.hwnd = NULL;</span>
<a href="#l28.163"></a><span id="l28.163">   executeInfo.fMask = SEE_MASK_NOCLOSEPROCESS;</span>
<a href="#l28.164"></a><span id="l28.164">   executeInfo.lpDirectory = NULL;</span>
<a href="#l28.165"></a><span id="l28.165">   executeInfo.lpFile = aPath.get();</span>
<a href="#l28.166"></a><span id="l28.166">   executeInfo.lpParameters = aParams.get();</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineat">@@ -144,182 +140,157 @@ LaunchHelper(nsAutoString&amp; aPath, nsAuto</span>
<a href="#l28.168"></a><span id="l28.168">   else</span>
<a href="#l28.169"></a><span id="l28.169">     return NS_ERROR_ABORT;</span>
<a href="#l28.170"></a><span id="l28.170"> </span>
<a href="#l28.171"></a><span id="l28.171">   // We're going to ignore errors here since there's nothing we can do about</span>
<a href="#l28.172"></a><span id="l28.172">   // them, and helper.exe seems to return non-zero ret on success.</span>
<a href="#l28.173"></a><span id="l28.173">   return NS_OK;</span>
<a href="#l28.174"></a><span id="l28.174"> }</span>
<a href="#l28.175"></a><span id="l28.175"> </span>
<a href="#l28.176"></a><span id="l28.176" class="difflineminus">-nsresult nsWindowsShellService::Init()</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineminus">-{</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineplus">+nsresult nsWindowsShellService::Init() {</span>
<a href="#l28.179"></a><span id="l28.179">   WCHAR appPath[MAX_BUF];</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineminus">-  if (!::GetModuleFileNameW(0, appPath, MAX_BUF))</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineplus">+  if (!::GetModuleFileNameW(0, appPath, MAX_BUF)) return NS_ERROR_FAILURE;</span>
<a href="#l28.183"></a><span id="l28.183"> </span>
<a href="#l28.184"></a><span id="l28.184">   // Convert the path to a long path since GetModuleFileNameW returns the path</span>
<a href="#l28.185"></a><span id="l28.185">   // that was used to launch the app which is not necessarily a long path.</span>
<a href="#l28.186"></a><span id="l28.186" class="difflineminus">-  if (!::GetLongPathNameW(appPath, appPath, MAX_BUF))</span>
<a href="#l28.187"></a><span id="l28.187" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineplus">+  if (!::GetLongPathNameW(appPath, appPath, MAX_BUF)) return NS_ERROR_FAILURE;</span>
<a href="#l28.189"></a><span id="l28.189"> </span>
<a href="#l28.190"></a><span id="l28.190">   mAppLongPath = appPath;</span>
<a href="#l28.191"></a><span id="l28.191"> </span>
<a href="#l28.192"></a><span id="l28.192">   return NS_OK;</span>
<a href="#l28.193"></a><span id="l28.193"> }</span>
<a href="#l28.194"></a><span id="l28.194"> </span>
<a href="#l28.195"></a><span id="l28.195" class="difflineminus">-nsWindowsShellService::nsWindowsShellService()</span>
<a href="#l28.196"></a><span id="l28.196" class="difflineminus">-:mCheckedThisSession(false)</span>
<a href="#l28.197"></a><span id="l28.197" class="difflineminus">-{</span>
<a href="#l28.198"></a><span id="l28.198" class="difflineminus">-}</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineplus">+nsWindowsShellService::nsWindowsShellService() : mCheckedThisSession(false) {}</span>
<a href="#l28.200"></a><span id="l28.200"> </span>
<a href="#l28.201"></a><span id="l28.201"> NS_IMETHODIMP</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineminus">-nsWindowsShellService::IsDefaultClient(bool aStartupCheck, uint16_t aApps, bool *aIsDefaultClient)</span>
<a href="#l28.203"></a><span id="l28.203" class="difflineminus">-{</span>
<a href="#l28.204"></a><span id="l28.204" class="difflineplus">+nsWindowsShellService::IsDefaultClient(bool aStartupCheck, uint16_t aApps,</span>
<a href="#l28.205"></a><span id="l28.205" class="difflineplus">+                                       bool* aIsDefaultClient) {</span>
<a href="#l28.206"></a><span id="l28.206">   // If this is the first mail window, maintain internal state that we've</span>
<a href="#l28.207"></a><span id="l28.207">   // checked this session (so that subsequent window opens don't show the</span>
<a href="#l28.208"></a><span id="l28.208">   // default client dialog).</span>
<a href="#l28.209"></a><span id="l28.209" class="difflineminus">-  if (aStartupCheck)</span>
<a href="#l28.210"></a><span id="l28.210" class="difflineminus">-    mCheckedThisSession = true;</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineplus">+  if (aStartupCheck) mCheckedThisSession = true;</span>
<a href="#l28.212"></a><span id="l28.212"> </span>
<a href="#l28.213"></a><span id="l28.213">   *aIsDefaultClient = true;</span>
<a href="#l28.214"></a><span id="l28.214"> </span>
<a href="#l28.215"></a><span id="l28.215">   // for each type,</span>
<a href="#l28.216"></a><span id="l28.216" class="difflineminus">-  if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineminus">-  {</span>
<a href="#l28.218"></a><span id="l28.218" class="difflineminus">-    *aIsDefaultClient &amp;= TestForDefault(gMailSettings, sizeof(gMailSettings)/sizeof(SETTING));</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineplus">+  if (aApps &amp; nsIShellService::MAIL) {</span>
<a href="#l28.220"></a><span id="l28.220" class="difflineplus">+    *aIsDefaultClient &amp;=</span>
<a href="#l28.221"></a><span id="l28.221" class="difflineplus">+        TestForDefault(gMailSettings, sizeof(gMailSettings) / sizeof(SETTING));</span>
<a href="#l28.222"></a><span id="l28.222">     // Only check if this app is default on Vista if the previous checks</span>
<a href="#l28.223"></a><span id="l28.223">     // indicate that this app is the default.</span>
<a href="#l28.224"></a><span id="l28.224">     if (*aIsDefaultClient)</span>
<a href="#l28.225"></a><span id="l28.225">       IsDefaultClientVista(nsIShellService::MAIL, aIsDefaultClient);</span>
<a href="#l28.226"></a><span id="l28.226">   }</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineminus">-  if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineminus">-  {</span>
<a href="#l28.229"></a><span id="l28.229" class="difflineminus">-    *aIsDefaultClient &amp;= TestForDefault(gNewsSettings, sizeof(gNewsSettings)/sizeof(SETTING));</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineplus">+  if (aApps &amp; nsIShellService::NEWS) {</span>
<a href="#l28.231"></a><span id="l28.231" class="difflineplus">+    *aIsDefaultClient &amp;=</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineplus">+        TestForDefault(gNewsSettings, sizeof(gNewsSettings) / sizeof(SETTING));</span>
<a href="#l28.233"></a><span id="l28.233">     // Only check if this app is default on Vista if the previous checks</span>
<a href="#l28.234"></a><span id="l28.234">     // indicate that this app is the default.</span>
<a href="#l28.235"></a><span id="l28.235">     if (*aIsDefaultClient)</span>
<a href="#l28.236"></a><span id="l28.236">       IsDefaultClientVista(nsIShellService::NEWS, aIsDefaultClient);</span>
<a href="#l28.237"></a><span id="l28.237">   }</span>
<a href="#l28.238"></a><span id="l28.238">   // RSS / feed protocol shell integration is not working so return true</span>
<a href="#l28.239"></a><span id="l28.239">   // until it is fixed (bug 445823).</span>
<a href="#l28.240"></a><span id="l28.240" class="difflineminus">-  if (aApps &amp; nsIShellService::RSS)</span>
<a href="#l28.241"></a><span id="l28.241" class="difflineminus">-    *aIsDefaultClient &amp;= true;</span>
<a href="#l28.242"></a><span id="l28.242" class="difflineplus">+  if (aApps &amp; nsIShellService::RSS) *aIsDefaultClient &amp;= true;</span>
<a href="#l28.243"></a><span id="l28.243"> </span>
<a href="#l28.244"></a><span id="l28.244">   return NS_OK;</span>
<a href="#l28.245"></a><span id="l28.245"> }</span>
<a href="#l28.246"></a><span id="l28.246"> </span>
<a href="#l28.247"></a><span id="l28.247"> NS_IMETHODIMP</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineminus">-nsWindowsShellService::SetDefaultClient(bool aForAllUsers, uint16_t aApps)</span>
<a href="#l28.249"></a><span id="l28.249" class="difflineminus">-{</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineplus">+nsWindowsShellService::SetDefaultClient(bool aForAllUsers, uint16_t aApps) {</span>
<a href="#l28.251"></a><span id="l28.251">   nsAutoString appHelperPath;</span>
<a href="#l28.252"></a><span id="l28.252" class="difflineminus">-  if (NS_FAILED(GetHelperPath(appHelperPath)))</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineplus">+  if (NS_FAILED(GetHelperPath(appHelperPath))) return NS_ERROR_FAILURE;</span>
<a href="#l28.255"></a><span id="l28.255"> </span>
<a href="#l28.256"></a><span id="l28.256">   nsAutoString params;</span>
<a href="#l28.257"></a><span id="l28.257" class="difflineminus">-  if (aForAllUsers)</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineminus">-  {</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineplus">+  if (aForAllUsers) {</span>
<a href="#l28.260"></a><span id="l28.260">     params.AppendLiteral(&quot; /SetAsDefaultAppGlobal&quot;);</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineminus">-  }</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineminus">-  else</span>
<a href="#l28.263"></a><span id="l28.263" class="difflineminus">-  {</span>
<a href="#l28.264"></a><span id="l28.264" class="difflineplus">+  } else {</span>
<a href="#l28.265"></a><span id="l28.265">     params.AppendLiteral(&quot; /SetAsDefaultAppUser&quot;);</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineminus">-    if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l28.267"></a><span id="l28.267" class="difflineminus">-      params.AppendLiteral(&quot; Mail&quot;);</span>
<a href="#l28.268"></a><span id="l28.268" class="difflineplus">+    if (aApps &amp; nsIShellService::MAIL) params.AppendLiteral(&quot; Mail&quot;);</span>
<a href="#l28.269"></a><span id="l28.269"> </span>
<a href="#l28.270"></a><span id="l28.270" class="difflineminus">-    if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineminus">-      params.AppendLiteral(&quot; News&quot;);</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineplus">+    if (aApps &amp; nsIShellService::NEWS) params.AppendLiteral(&quot; News&quot;);</span>
<a href="#l28.273"></a><span id="l28.273">   }</span>
<a href="#l28.274"></a><span id="l28.274"> </span>
<a href="#l28.275"></a><span id="l28.275">   return LaunchHelper(appHelperPath, params);</span>
<a href="#l28.276"></a><span id="l28.276"> }</span>
<a href="#l28.277"></a><span id="l28.277"> </span>
<a href="#l28.278"></a><span id="l28.278"> NS_IMETHODIMP</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineminus">-nsWindowsShellService::GetShouldCheckDefaultClient(bool* aResult)</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineminus">-{</span>
<a href="#l28.281"></a><span id="l28.281" class="difflineminus">-  if (mCheckedThisSession)</span>
<a href="#l28.282"></a><span id="l28.282" class="difflineminus">-  {</span>
<a href="#l28.283"></a><span id="l28.283" class="difflineplus">+nsWindowsShellService::GetShouldCheckDefaultClient(bool* aResult) {</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineplus">+  if (mCheckedThisSession) {</span>
<a href="#l28.285"></a><span id="l28.285">     *aResult = false;</span>
<a href="#l28.286"></a><span id="l28.286">     return NS_OK;</span>
<a href="#l28.287"></a><span id="l28.287">   }</span>
<a href="#l28.288"></a><span id="l28.288"> </span>
<a href="#l28.289"></a><span id="l28.289">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l28.290"></a><span id="l28.290">   return prefs-&gt;GetBoolPref(&quot;mail.shell.checkDefaultClient&quot;, aResult);</span>
<a href="#l28.291"></a><span id="l28.291"> }</span>
<a href="#l28.292"></a><span id="l28.292"> </span>
<a href="#l28.293"></a><span id="l28.293"> NS_IMETHODIMP</span>
<a href="#l28.294"></a><span id="l28.294" class="difflineminus">-nsWindowsShellService::SetShouldCheckDefaultClient(bool aShouldCheck)</span>
<a href="#l28.295"></a><span id="l28.295" class="difflineminus">-{</span>
<a href="#l28.296"></a><span id="l28.296" class="difflineplus">+nsWindowsShellService::SetShouldCheckDefaultClient(bool aShouldCheck) {</span>
<a href="#l28.297"></a><span id="l28.297">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l28.298"></a><span id="l28.298">   return prefs-&gt;SetBoolPref(&quot;mail.shell.checkDefaultClient&quot;, aShouldCheck);</span>
<a href="#l28.299"></a><span id="l28.299"> }</span>
<a href="#l28.300"></a><span id="l28.300"> </span>
<a href="#l28.301"></a><span id="l28.301"> /* helper routine. Iterate over the passed in settings object. */</span>
<a href="#l28.302"></a><span id="l28.302" class="difflineminus">-bool</span>
<a href="#l28.303"></a><span id="l28.303" class="difflineminus">-nsWindowsShellService::TestForDefault(SETTING aSettings[], int32_t aSize)</span>
<a href="#l28.304"></a><span id="l28.304" class="difflineminus">-{</span>
<a href="#l28.305"></a><span id="l28.305" class="difflineplus">+bool nsWindowsShellService::TestForDefault(SETTING aSettings[], int32_t aSize) {</span>
<a href="#l28.306"></a><span id="l28.306">   bool isDefault = true;</span>
<a href="#l28.307"></a><span id="l28.307">   char16_t currValue[MAX_BUF];</span>
<a href="#l28.308"></a><span id="l28.308">   SETTING* end = aSettings + aSize;</span>
<a href="#l28.309"></a><span id="l28.309" class="difflineminus">-  for (SETTING * settings = aSettings; settings &lt; end; ++settings)</span>
<a href="#l28.310"></a><span id="l28.310" class="difflineminus">-  {</span>
<a href="#l28.311"></a><span id="l28.311" class="difflineplus">+  for (SETTING* settings = aSettings; settings &lt; end; ++settings) {</span>
<a href="#l28.312"></a><span id="l28.312">     NS_ConvertUTF8toUTF16 dataLongPath(settings-&gt;valueData);</span>
<a href="#l28.313"></a><span id="l28.313">     NS_ConvertUTF8toUTF16 key(settings-&gt;keyName);</span>
<a href="#l28.314"></a><span id="l28.314">     NS_ConvertUTF8toUTF16 value(settings-&gt;valueName);</span>
<a href="#l28.315"></a><span id="l28.315" class="difflineminus">-    if (settings-&gt;flags &amp; APP_PATH_SUBSTITUTION)</span>
<a href="#l28.316"></a><span id="l28.316" class="difflineminus">-    {</span>
<a href="#l28.317"></a><span id="l28.317" class="difflineplus">+    if (settings-&gt;flags &amp; APP_PATH_SUBSTITUTION) {</span>
<a href="#l28.318"></a><span id="l28.318">       int32_t offset = dataLongPath.Find(&quot;%APPPATH%&quot;);</span>
<a href="#l28.319"></a><span id="l28.319">       dataLongPath.Replace(offset, 9, mAppLongPath);</span>
<a href="#l28.320"></a><span id="l28.320">     }</span>
<a href="#l28.321"></a><span id="l28.321"> </span>
<a href="#l28.322"></a><span id="l28.322">     ::ZeroMemory(currValue, sizeof(currValue));</span>
<a href="#l28.323"></a><span id="l28.323">     HKEY theKey;</span>
<a href="#l28.324"></a><span id="l28.324">     nsresult rv = OpenKeyForReading(HKEY_CLASSES_ROOT, key, &amp;theKey);</span>
<a href="#l28.325"></a><span id="l28.325" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l28.326"></a><span id="l28.326" class="difflineminus">-    {</span>
<a href="#l28.327"></a><span id="l28.327" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l28.328"></a><span id="l28.328">       // Key doesn't exist</span>
<a href="#l28.329"></a><span id="l28.329">       isDefault = false;</span>
<a href="#l28.330"></a><span id="l28.330">       break;</span>
<a href="#l28.331"></a><span id="l28.331">     }</span>
<a href="#l28.332"></a><span id="l28.332"> </span>
<a href="#l28.333"></a><span id="l28.333">     DWORD len = sizeof currValue;</span>
<a href="#l28.334"></a><span id="l28.334" class="difflineminus">-    DWORD result = ::RegQueryValueExW(theKey, value.get(),</span>
<a href="#l28.335"></a><span id="l28.335" class="difflineminus">-                                      NULL, NULL, (LPBYTE)currValue, &amp;len);</span>
<a href="#l28.336"></a><span id="l28.336" class="difflineplus">+    DWORD result = ::RegQueryValueExW(theKey, value.get(), NULL, NULL,</span>
<a href="#l28.337"></a><span id="l28.337" class="difflineplus">+                                      (LPBYTE)currValue, &amp;len);</span>
<a href="#l28.338"></a><span id="l28.338">     // Close the key we opened.</span>
<a href="#l28.339"></a><span id="l28.339">     ::RegCloseKey(theKey);</span>
<a href="#l28.340"></a><span id="l28.340">     if (REG_FAILED(result) ||</span>
<a href="#l28.341"></a><span id="l28.341" class="difflineminus">-        !dataLongPath.Equals(currValue, nsCaseInsensitiveStringComparator()))</span>
<a href="#l28.342"></a><span id="l28.342" class="difflineminus">-    {</span>
<a href="#l28.343"></a><span id="l28.343" class="difflineminus">-      // Key wasn't set, or was set to something else (something else became the default client)</span>
<a href="#l28.344"></a><span id="l28.344" class="difflineplus">+        !dataLongPath.Equals(currValue, nsCaseInsensitiveStringComparator())) {</span>
<a href="#l28.345"></a><span id="l28.345" class="difflineplus">+      // Key wasn't set, or was set to something else (something else became the</span>
<a href="#l28.346"></a><span id="l28.346" class="difflineplus">+      // default client)</span>
<a href="#l28.347"></a><span id="l28.347">       isDefault = false;</span>
<a href="#l28.348"></a><span id="l28.348">       break;</span>
<a href="#l28.349"></a><span id="l28.349">     }</span>
<a href="#l28.350"></a><span id="l28.350">   }  // for each registry key we want to look at</span>
<a href="#l28.351"></a><span id="l28.351"> </span>
<a href="#l28.352"></a><span id="l28.352">   return isDefault;</span>
<a href="#l28.353"></a><span id="l28.353"> }</span>
<a href="#l28.354"></a><span id="l28.354"> </span>
<a href="#l28.355"></a><span id="l28.355" class="difflineminus">-bool</span>
<a href="#l28.356"></a><span id="l28.356" class="difflineminus">-nsWindowsShellService::IsDefaultClientVista(uint16_t aApps, bool* aIsDefaultClient)</span>
<a href="#l28.357"></a><span id="l28.357" class="difflineminus">-{</span>
<a href="#l28.358"></a><span id="l28.358" class="difflineplus">+bool nsWindowsShellService::IsDefaultClientVista(uint16_t aApps,</span>
<a href="#l28.359"></a><span id="l28.359" class="difflineplus">+                                                 bool* aIsDefaultClient) {</span>
<a href="#l28.360"></a><span id="l28.360">   IApplicationAssociationRegistration* pAAR;</span>
<a href="#l28.361"></a><span id="l28.361"> </span>
<a href="#l28.362"></a><span id="l28.362" class="difflineminus">-  HRESULT hr = CoCreateInstance (CLSID_ApplicationAssociationRegistration,</span>
<a href="#l28.363"></a><span id="l28.363" class="difflineminus">-                                 NULL,</span>
<a href="#l28.364"></a><span id="l28.364" class="difflineminus">-                                 CLSCTX_INPROC,</span>
<a href="#l28.365"></a><span id="l28.365" class="difflineminus">-                                 IID_IApplicationAssociationRegistration,</span>
<a href="#l28.366"></a><span id="l28.366" class="difflineminus">-                                 (void**)&amp;pAAR);</span>
<a href="#l28.367"></a><span id="l28.367" class="difflineplus">+  HRESULT hr = CoCreateInstance(</span>
<a href="#l28.368"></a><span id="l28.368" class="difflineplus">+      CLSID_ApplicationAssociationRegistration, NULL, CLSCTX_INPROC,</span>
<a href="#l28.369"></a><span id="l28.369" class="difflineplus">+      IID_IApplicationAssociationRegistration, (void**)&amp;pAAR);</span>
<a href="#l28.370"></a><span id="l28.370"> </span>
<a href="#l28.371"></a><span id="l28.371" class="difflineminus">-  if (SUCCEEDED(hr))</span>
<a href="#l28.372"></a><span id="l28.372" class="difflineminus">-  {</span>
<a href="#l28.373"></a><span id="l28.373" class="difflineplus">+  if (SUCCEEDED(hr)) {</span>
<a href="#l28.374"></a><span id="l28.374">     BOOL isDefaultMail = true;</span>
<a href="#l28.375"></a><span id="l28.375">     BOOL isDefaultNews = true;</span>
<a href="#l28.376"></a><span id="l28.376">     if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l28.377"></a><span id="l28.377" class="difflineminus">-      pAAR-&gt;QueryAppIsDefaultAll(AL_EFFECTIVE, APP_REG_NAME_MAIL, &amp;isDefaultMail);</span>
<a href="#l28.378"></a><span id="l28.378" class="difflineplus">+      pAAR-&gt;QueryAppIsDefaultAll(AL_EFFECTIVE, APP_REG_NAME_MAIL,</span>
<a href="#l28.379"></a><span id="l28.379" class="difflineplus">+                                 &amp;isDefaultMail);</span>
<a href="#l28.380"></a><span id="l28.380">     if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l28.381"></a><span id="l28.381" class="difflineminus">-      pAAR-&gt;QueryAppIsDefaultAll(AL_EFFECTIVE, APP_REG_NAME_NEWS, &amp;isDefaultNews);</span>
<a href="#l28.382"></a><span id="l28.382" class="difflineplus">+      pAAR-&gt;QueryAppIsDefaultAll(AL_EFFECTIVE, APP_REG_NAME_NEWS,</span>
<a href="#l28.383"></a><span id="l28.383" class="difflineplus">+                                 &amp;isDefaultNews);</span>
<a href="#l28.384"></a><span id="l28.384"> </span>
<a href="#l28.385"></a><span id="l28.385">     *aIsDefaultClient = isDefaultNews &amp;&amp; isDefaultMail;</span>
<a href="#l28.386"></a><span id="l28.386"> </span>
<a href="#l28.387"></a><span id="l28.387">     pAAR-&gt;Release();</span>
<a href="#l28.388"></a><span id="l28.388">     return true;</span>
<a href="#l28.389"></a><span id="l28.389">   }</span>
<a href="#l28.390"></a><span id="l28.390">   return false;</span>
<a href="#l28.391"></a><span id="l28.391"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/components/shell/nsWindowsShellService.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/components/shell/nsWindowsShellService.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -9,39 +9,43 @@</span>
<a href="#l29.4"></a><span id="l29.4"> #include &quot;nsIShellService.h&quot;</span>
<a href="#l29.5"></a><span id="l29.5"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l29.6"></a><span id="l29.6"> #include &quot;nsString.h&quot;</span>
<a href="#l29.7"></a><span id="l29.7"> #include &quot;nsToolkitShellService.h&quot;</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9"> #include &lt;ole2.h&gt;</span>
<a href="#l29.10"></a><span id="l29.10"> #include &lt;windows.h&gt;</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-#define NS_MAILWININTEGRATION_CID \</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-{0x2ebbe84, 0xc179, 0x4598, {0xaf, 0x18, 0x1b, 0xf2, 0xc4, 0xbc, 0x1d, 0xf9}}</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+#define NS_MAILWININTEGRATION_CID                    \</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+  {                                                  \</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+    0x2ebbe84, 0xc179, 0x4598, {                     \</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+      0xaf, 0x18, 0x1b, 0xf2, 0xc4, 0xbc, 0x1d, 0xf9 \</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+    }                                                \</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+  }</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21"> typedef struct {</span>
<a href="#l29.22"></a><span id="l29.22">   const char* keyName;</span>
<a href="#l29.23"></a><span id="l29.23">   const char* valueName;</span>
<a href="#l29.24"></a><span id="l29.24">   const char* valueData;</span>
<a href="#l29.25"></a><span id="l29.25"> </span>
<a href="#l29.26"></a><span id="l29.26">   int32_t flags;</span>
<a href="#l29.27"></a><span id="l29.27"> } SETTING;</span>
<a href="#l29.28"></a><span id="l29.28"> </span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-class nsWindowsShellService : public nsIShellService, public nsToolkitShellService</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-{</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-public:</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+class nsWindowsShellService : public nsIShellService,</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+                              public nsToolkitShellService {</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+ public:</span>
<a href="#l29.35"></a><span id="l29.35">   nsWindowsShellService();</span>
<a href="#l29.36"></a><span id="l29.36">   NS_HIDDEN_(nsresult) Init();</span>
<a href="#l29.37"></a><span id="l29.37"> </span>
<a href="#l29.38"></a><span id="l29.38">   NS_DECL_ISUPPORTS</span>
<a href="#l29.39"></a><span id="l29.39">   NS_DECL_NSISHELLSERVICE</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-protected:</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+ protected:</span>
<a href="#l29.43"></a><span id="l29.43">   bool TestForDefault(SETTING aSettings[], int32_t aSize);</span>
<a href="#l29.44"></a><span id="l29.44">   bool IsDefaultClientVista(uint16_t aApps, bool* aIsDefaultClient);</span>
<a href="#l29.45"></a><span id="l29.45"> </span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-private:</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-  virtual ~nsWindowsShellService() {};</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+ private:</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+  virtual ~nsWindowsShellService(){};</span>
<a href="#l29.50"></a><span id="l29.50">   bool mCheckedThisSession;</span>
<a href="#l29.51"></a><span id="l29.51">   nsAutoString mAppLongPath;</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">- };</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+};</span>
<a href="#l29.54"></a><span id="l29.54"> </span>
<a href="#l29.55"></a><span id="l29.55"> #endif</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

