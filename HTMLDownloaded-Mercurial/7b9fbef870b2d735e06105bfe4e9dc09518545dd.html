<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 19846:7b9fbef870b2d735e06105bfe4e9dc09518545dd</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7b9fbef870b2d735e06105bfe4e9dc09518545dd" />
<meta property="og:url" content="/comm-central/rev/7b9fbef870b2d735e06105bfe4e9dc09518545dd" />
<meta property="og:description" content="Bug 1292569 - convert functions containing yield to standard generators (function*) to fix mozmill tests. f=mkmelin, r=jorgk, a=jorgk CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7b9fbef870b2d735e06105bfe4e9dc09518545dd 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7b9fbef870b2d735e06105bfe4e9dc09518545dd">shortlog</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7b9fbef870b2d735e06105bfe4e9dc09518545dd">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd">files</a> |
changeset |
<a href="/comm-central/raw-rev/7b9fbef870b2d735e06105bfe4e9dc09518545dd">raw</a>  | <a href="/comm-central/archive/7b9fbef870b2d735e06105bfe4e9dc09518545dd.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1292569">Bug 1292569</a> - convert functions containing yield to standard generators (function*) to fix mozmill tests. f=mkmelin, r=jorgk, a=jorgk CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 07 Aug 2016 23:08:36 +0200</td></tr>

<tr>
 <td>changeset 19846</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7b9fbef870b2d735e06105bfe4e9dc09518545dd">7b9fbef870b2d735e06105bfe4e9dc09518545dd</a></td>
</tr>



<tr>
<td>parent 19845</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8bd73f4824eeb3c471f11d3b6f6820ebf2dbbc79">8bd73f4824eeb3c471f11d3b6f6820ebf2dbbc79</a>
</td>
</tr>

<tr>
<td>child 19847</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f7e1f4d6f62f32de5d8156001283664ecb621072">f7e1f4d6f62f32de5d8156001283664ecb621072</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7b9fbef870b2d735e06105bfe4e9dc09518545dd">12154</a></td></tr>
<tr><td>push user</td><td>acelists@atlas.sk</td></tr>
<tr><td>push date</td><td class="date age">Sun, 07 Aug 2016 21:09:03 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7b9fbef870b2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7b9fbef870b2d735e06105bfe4e9dc09518545dd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7b9fbef870b2d735e06105bfe4e9dc09518545dd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7b9fbef870b2d735e06105bfe4e9dc09518545dd&newProject=comm-central&newRevision=7b9fbef870b2d735e06105bfe4e9dc09518545dd&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7b9fbef870b2d735e06105bfe4e9dc09518545dd&newProject=comm-central&newRevision=7b9fbef870b2d735e06105bfe4e9dc09518545dd&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7b9fbef870b2d735e06105bfe4e9dc09518545dd&newProject=comm-central&newRevision=7b9fbef870b2d735e06105bfe4e9dc09518545dd&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a>, <a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1292569">1292569</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1292569">Bug 1292569</a> - convert functions containing yield to standard generators (function*) to fix mozmill tests. f=mkmelin, r=jorgk, a=jorgk CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/modules/MailUtils.js">mail/base/modules/MailUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/modules/MailUtils.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/modules/MailUtils.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/modules/MailUtils.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/modules/MailUtils.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/modules/MailUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/test/unit/resources/viewWrapperTestUtils.js">mail/base/test/unit/resources/viewWrapperTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/test/unit/resources/viewWrapperTestUtils.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/test/unit/resources/viewWrapperTestUtils.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/test/unit/resources/viewWrapperTestUtils.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/test/unit/resources/viewWrapperTestUtils.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/base/test/unit/resources/viewWrapperTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/cloudFileAccounts.js">mail/components/cloudfile/cloudFileAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/cloudFileAccounts.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/cloudFileAccounts.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/cloudFileAccounts.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/cloudFileAccounts.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/cloudFileAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/content/addAccountDialog.js">mail/components/cloudfile/content/addAccountDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/content/addAccountDialog.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/content/addAccountDialog.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/content/addAccountDialog.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/content/addAccountDialog.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/cloudfile/content/addAccountDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/am-im.js">mail/components/im/content/am-im.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/am-im.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/am-im.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/am-im.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/am-im.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/am-im.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccountWizard.js">mail/components/im/content/imAccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccountWizard.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccountWizard.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccountWizard.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccountWizard.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccounts.js">mail/components/im/content/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccounts.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccounts.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/content/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/modules/index_im.js">mail/components/im/modules/index_im.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/modules/index_im.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/modules/index_im.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/modules/index_im.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/modules/index_im.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/im/modules/index_im.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/search/content/searchCommon.js">mail/components/search/content/searchCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/search/content/searchCommon.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/search/content/searchCommon.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/search/content/searchCommon.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/search/content/searchCommon.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/components/search/content/searchCommon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/downloads/test-about-downloads.js">mail/test/mozmill/downloads/test-about-downloads.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/downloads/test-about-downloads.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/downloads/test-about-downloads.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/downloads/test-about-downloads.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/downloads/test-about-downloads.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/downloads/test-about-downloads.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datamodel.js">mailnews/db/gloda/modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datastore.js">mailnews/db/gloda/modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/explattr.js">mailnews/db/gloda/modules/explattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/explattr.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/explattr.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/explattr.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/explattr.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/explattr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/fundattr.js">mailnews/db/gloda/modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/gloda.js">mailnews/db/gloda/modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_ab.js">mailnews/db/gloda/modules/index_ab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_ab.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_ab.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_ab.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_ab.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_ab.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_msg.js">mailnews/db/gloda/modules/index_msg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_msg.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_msg.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_msg.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_msg.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/index_msg.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/indexer.js">mailnews/db/gloda/modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/modules/indexer.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js">mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/extensions/newsblog/content/FeedUtils.jsm">mailnews/extensions/newsblog/content/FeedUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/extensions/newsblog/content/FeedUtils.jsm">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/extensions/newsblog/content/FeedUtils.jsm">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/extensions/newsblog/content/FeedUtils.jsm">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/extensions/newsblog/content/FeedUtils.jsm">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/extensions/newsblog/content/FeedUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/asyncTestUtils.js">mailnews/test/resources/asyncTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/asyncTestUtils.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/asyncTestUtils.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/asyncTestUtils.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/asyncTestUtils.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/asyncTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageInjection.js">mailnews/test/resources/messageInjection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageInjection.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageInjection.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageInjection.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageInjection.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageInjection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageModifier.js">mailnews/test/resources/messageModifier.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageModifier.js">file</a> |
<a href="/comm-central/annotate/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageModifier.js">annotate</a> |
<a href="/comm-central/diff/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageModifier.js">diff</a> |
<a href="/comm-central/comparison/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageModifier.js">comparison</a> |
<a href="/comm-central/log/7b9fbef870b2d735e06105bfe4e9dc09518545dd/mailnews/test/resources/messageModifier.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/modules/MailUtils.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/modules/MailUtils.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -346,41 +346,44 @@ var MailUtils =</span>
<a href="#l1.4"></a><span id="l1.4">                                                                  aFolder,</span>
<a href="#l1.5"></a><span id="l1.5">                                                                  aCallback) {</span>
<a href="#l1.6"></a><span id="l1.6">     // We need to add the base folder as it does not get added by ListDescendants.</span>
<a href="#l1.7"></a><span id="l1.7">     let allFolders = toXPCOMArray([aFolder], Ci.nsIMutableArray);</span>
<a href="#l1.8"></a><span id="l1.8">     // - get all the descendants</span>
<a href="#l1.9"></a><span id="l1.9">     aFolder.ListDescendants(allFolders);</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     // - worker function</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    function folder_string_setter_worker() {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    function* folder_string_setter_worker() {</span>
<a href="#l1.14"></a><span id="l1.14">       for (let folder in fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l1.15"></a><span id="l1.15">         // set the property; this may open the database...</span>
<a href="#l1.16"></a><span id="l1.16">         let value = (typeof aPropertyValue == &quot;function&quot; ?</span>
<a href="#l1.17"></a><span id="l1.17">                      aPropertyValue(folder) : aPropertyValue);</span>
<a href="#l1.18"></a><span id="l1.18">         folder.setStringProperty(aPropertyName, value);</span>
<a href="#l1.19"></a><span id="l1.19">         // force the reference to be forgotten.</span>
<a href="#l1.20"></a><span id="l1.20">         folder.msgDatabase = null;</span>
<a href="#l1.21"></a><span id="l1.21">         yield undefined;</span>
<a href="#l1.22"></a><span id="l1.22">       }</span>
<a href="#l1.23"></a><span id="l1.23">     }</span>
<a href="#l1.24"></a><span id="l1.24">     let worker = folder_string_setter_worker();</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">     // - driver logic</span>
<a href="#l1.27"></a><span id="l1.27">     let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l1.28"></a><span id="l1.28">     function folder_string_setter_driver() {</span>
<a href="#l1.29"></a><span id="l1.29">       try {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-        worker.next();</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+        if (worker.next().done) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+          timer.cancel();</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+          if (aCallback)</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+            aCallback(true);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+        }</span>
<a href="#l1.36"></a><span id="l1.36">       }</span>
<a href="#l1.37"></a><span id="l1.37">       catch (ex) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-        // Any type of exception kills the generator, but only StopIteration</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-        // indicates success.</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+        // Any type of exception kills the generator.</span>
<a href="#l1.41"></a><span id="l1.41">         timer.cancel();</span>
<a href="#l1.42"></a><span id="l1.42">         if (aCallback)</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-          aCallback(ex == StopIteration);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+          aCallback(false);</span>
<a href="#l1.45"></a><span id="l1.45">       }</span>
<a href="#l1.46"></a><span id="l1.46">     }</span>
<a href="#l1.47"></a><span id="l1.47">     // make sure there is at least 100 ms of not us between doing things.</span>
<a href="#l1.48"></a><span id="l1.48">     timer.initWithCallback(folder_string_setter_driver,</span>
<a href="#l1.49"></a><span id="l1.49">                            this.INTER_FOLDER_PROCESSING_DELAY_MS,</span>
<a href="#l1.50"></a><span id="l1.50">                            Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l1.51"></a><span id="l1.51">   },</span>
<a href="#l1.52"></a><span id="l1.52"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/test/unit/resources/viewWrapperTestUtils.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/test/unit/resources/viewWrapperTestUtils.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -381,17 +381,17 @@ function dump_view_state(aViewWrapper, a</span>
<a href="#l2.4"></a><span id="l2.4"> function verify_messages_in_view(aSynSets, aViewWrapper) {</span>
<a href="#l2.5"></a><span id="l2.5">   if (!('length' in aSynSets))</span>
<a href="#l2.6"></a><span id="l2.6">     aSynSets = [aSynSets];</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">   // - Iterate over all the message sets, retrieving the message header.  Use</span>
<a href="#l2.9"></a><span id="l2.9">   //  this to construct a URI to populate a dictionary mapping.</span>
<a href="#l2.10"></a><span id="l2.10">   let synMessageURIs = {}; // map URI to message header</span>
<a href="#l2.11"></a><span id="l2.11">   for (let messageSet of aSynSets) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    for (let msgHdr of messageSet.msgHdrs) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    for (let msgHdr of messageSet.msgHdrs()) {</span>
<a href="#l2.14"></a><span id="l2.14">       synMessageURIs[msgHdr.folder.getUriForMsg(msgHdr)] = msgHdr;</span>
<a href="#l2.15"></a><span id="l2.15">     }</span>
<a href="#l2.16"></a><span id="l2.16">   }</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   // - Iterate over the contents of the view, nulling out values in</span>
<a href="#l2.19"></a><span id="l2.19">   //  synMessageURIs for found messages, and exploding for missing ones.</span>
<a href="#l2.20"></a><span id="l2.20">   let dbView = aViewWrapper.dbView;</span>
<a href="#l2.21"></a><span id="l2.21">   let treeView = aViewWrapper.dbView.QueryInterface(Ci.nsITreeView);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -137,18 +137,17 @@ var cloudFileAccounts = {</span>
<a href="#l3.4"></a><span id="l3.4">       }</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">       let func = kFuncMap[type];</span>
<a href="#l3.7"></a><span id="l3.7">       Services.prefs[func](ACCOUNT_ROOT + aAccountKey + &quot;.&quot; + prefKey,</span>
<a href="#l3.8"></a><span id="l3.8">                            value);</span>
<a href="#l3.9"></a><span id="l3.9">     }</span>
<a href="#l3.10"></a><span id="l3.10">   },</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  enumerateProviders: function() {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    let providerList = [];</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  enumerateProviders: function*() {</span>
<a href="#l3.15"></a><span id="l3.15">     for (let entry in fixIterator(categoryManager.enumerateCategory(CATEGORY),</span>
<a href="#l3.16"></a><span id="l3.16">                                   Ci.nsISupportsCString)) {</span>
<a href="#l3.17"></a><span id="l3.17">       let provider = this.getProviderForType(entry.data);</span>
<a href="#l3.18"></a><span id="l3.18">       yield [entry.data, provider];</span>
<a href="#l3.19"></a><span id="l3.19">     }</span>
<a href="#l3.20"></a><span id="l3.20">   },</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">   getAccount: function(aKey) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/cloudfile/content/addAccountDialog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/cloudfile/content/addAccountDialog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -158,17 +158,17 @@ var addAccountDialog = {</span>
<a href="#l4.4"></a><span id="l4.4">     let menuitem = this._accountType.querySelector('menuitem[value=&quot;&quot;]');</span>
<a href="#l4.5"></a><span id="l4.5">     if (menuitem) {</span>
<a href="#l4.6"></a><span id="l4.6">       let index = this._accountType.getIndexOfItem(menuitem);</span>
<a href="#l4.7"></a><span id="l4.7">       this._accountType.removeItemAt(index);</span>
<a href="#l4.8"></a><span id="l4.8">     }</span>
<a href="#l4.9"></a><span id="l4.9">   },</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   addAccountTypes: function AAD_addAccountTypes() {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    for (let [key, provider] in cloudFileAccounts.enumerateProviders()) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    for (let [key, provider] of cloudFileAccounts.enumerateProviders()) {</span>
<a href="#l4.14"></a><span id="l4.14">       // If we already have an account for this type, don't add it to the list.</span>
<a href="#l4.15"></a><span id="l4.15">       // This limitation will hopefully be removed in the future.</span>
<a href="#l4.16"></a><span id="l4.16">       if (cloudFileAccounts.getAccountsForType(key).length &gt; 0)</span>
<a href="#l4.17"></a><span id="l4.17">         continue;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">       if (this._blacklist.has(key))</span>
<a href="#l4.20"></a><span id="l4.20">         continue;</span>
<a href="#l4.21"></a><span id="l4.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/im/content/am-im.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/im/content/am-im.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -53,17 +53,17 @@ var account = {</span>
<a href="#l5.4"></a><span id="l5.4">     else</span>
<a href="#l5.5"></a><span id="l5.5">       autojoin.removeAttribute(&quot;wsm_persist&quot;);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     this.prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l5.8"></a><span id="l5.8">                                           this.account.id + &quot;.options.&quot;);</span>
<a href="#l5.9"></a><span id="l5.9">     this.populateProtoSpecificBox();</span>
<a href="#l5.10"></a><span id="l5.10">   },</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  getProtoOptions: function account_getProtoOptions() {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  getProtoOptions: function* account_getProtoOptions() {</span>
<a href="#l5.14"></a><span id="l5.14">     let options = this.proto.getOptions();</span>
<a href="#l5.15"></a><span id="l5.15">     while (options.hasMoreElements())</span>
<a href="#l5.16"></a><span id="l5.16">       yield options.getNext();</span>
<a href="#l5.17"></a><span id="l5.17">   },</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   populateProtoSpecificBox: function account_populate() {</span>
<a href="#l5.20"></a><span id="l5.20">     let attributes = {};</span>
<a href="#l5.21"></a><span id="l5.21">     attributes[Ci.prplIPref.typeBool] = [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/im/content/imAccountWizard.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/im/content/imAccountWizard.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -344,17 +344,17 @@ var accountWizard = {</span>
<a href="#l6.4"></a><span id="l6.4">     if (&quot;value&quot; in elt)</span>
<a href="#l6.5"></a><span id="l6.5">       return elt.value;</span>
<a href="#l6.6"></a><span id="l6.6">     // If the groupbox has never been opened, the binding isn't attached</span>
<a href="#l6.7"></a><span id="l6.7">     // so the attributes don't exist. The calling code in showSummary</span>
<a href="#l6.8"></a><span id="l6.8">     // has a special handling of the undefined value for this case.</span>
<a href="#l6.9"></a><span id="l6.9">     return undefined;</span>
<a href="#l6.10"></a><span id="l6.10">   },</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  getIter: function(aEnumerator) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  getIter: function*(aEnumerator) {</span>
<a href="#l6.14"></a><span id="l6.14">     while (aEnumerator.hasMoreElements())</span>
<a href="#l6.15"></a><span id="l6.15">       yield aEnumerator.getNext();</span>
<a href="#l6.16"></a><span id="l6.16">   },</span>
<a href="#l6.17"></a><span id="l6.17">   getProtocols: function aw_getProtocols() {</span>
<a href="#l6.18"></a><span id="l6.18">     return this.getIter(Services.core.getProtocols());</span>
<a href="#l6.19"></a><span id="l6.19">   },</span>
<a href="#l6.20"></a><span id="l6.20">   getProtoOptions: function aw_getProtoOptions() {</span>
<a href="#l6.21"></a><span id="l6.21">     return this.getIter(this.proto.getOptions());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/im/content/imAccounts.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/im/content/imAccounts.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -459,17 +459,17 @@ var gAccountManager = {</span>
<a href="#l7.4"></a><span id="l7.4">       newIndex = 0;</span>
<a href="#l7.5"></a><span id="l7.5">     else if (newIndex &gt;= accountList.itemCount)</span>
<a href="#l7.6"></a><span id="l7.6">       newIndex = accountList.itemCount - 1;</span>
<a href="#l7.7"></a><span id="l7.7">     array.splice(newIndex, 0, selectedID);</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">     Services.prefs.setCharPref(&quot;messenger.accounts&quot;, array.join(&quot;,&quot;));</span>
<a href="#l7.10"></a><span id="l7.10">   },</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  getAccounts: function am_getAccounts() {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  getAccounts: function* am_getAccounts() {</span>
<a href="#l7.14"></a><span id="l7.14">     let accounts = Services.accounts.getAccounts();</span>
<a href="#l7.15"></a><span id="l7.15">     while (accounts.hasMoreElements())</span>
<a href="#l7.16"></a><span id="l7.16">       yield accounts.getNext();</span>
<a href="#l7.17"></a><span id="l7.17">   },</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   openDialog: function am_openDialog(aUrl, aArgs) {</span>
<a href="#l7.20"></a><span id="l7.20">     this.modalDialog = true;</span>
<a href="#l7.21"></a><span id="l7.21">     window.openDialog(aUrl, &quot;&quot;, &quot;chrome,modal,titlebar,centerscreen&quot;, aArgs);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/im/modules/index_im.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/im/modules/index_im.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -110,17 +110,17 @@ GlodaIMConversation.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">   // for glodaFacetView.js _removeDupes</span>
<a href="#l8.6"></a><span id="l8.6">   get headerMessageID() { return this.id; }</span>
<a href="#l8.7"></a><span id="l8.7"> };</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> // FIXME</span>
<a href="#l8.10"></a><span id="l8.10"> var WidgetProvider = {</span>
<a href="#l8.11"></a><span id="l8.11">   providerName: &quot;widget&quot;,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  process: function () {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  process: function*() {</span>
<a href="#l8.14"></a><span id="l8.14">     //XXX What is this supposed to do?</span>
<a href="#l8.15"></a><span id="l8.15">     yield Gloda.kWorkDone;</span>
<a href="#l8.16"></a><span id="l8.16">   }</span>
<a href="#l8.17"></a><span id="l8.17"> };</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> var IMConversationNoun = {</span>
<a href="#l8.20"></a><span id="l8.20">   name: &quot;im-conversation&quot;,</span>
<a href="#l8.21"></a><span id="l8.21">   clazz: GlodaIMConversation,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -610,17 +610,17 @@ var GlodaIMIndexer = {</span>
<a href="#l8.23"></a><span id="l8.23">     if (!aLastModifiedTime)</span>
<a href="#l8.24"></a><span id="l8.24">       Cu.reportError(&quot;indexIMConversation called without lastModifiedTime parameter.&quot;);</span>
<a href="#l8.25"></a><span id="l8.25">     aCache[fileName] = aLastModifiedTime || 1;</span>
<a href="#l8.26"></a><span id="l8.26">     this._scheduleCacheSave();</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">     return rv;</span>
<a href="#l8.29"></a><span id="l8.29">   }),</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  _worker_indexIMConversation: function(aJob, aCallbackHandle) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  _worker_indexIMConversation: function*(aJob, aCallbackHandle) {</span>
<a href="#l8.33"></a><span id="l8.33">     let glodaConv = {};</span>
<a href="#l8.34"></a><span id="l8.34">     let existingGlodaConv = aJob.conversation.glodaConv;</span>
<a href="#l8.35"></a><span id="l8.35">     if (existingGlodaConv &amp;&amp;</span>
<a href="#l8.36"></a><span id="l8.36">         existingGlodaConv.path == this._getRelativePath(aJob.path))</span>
<a href="#l8.37"></a><span id="l8.37">       glodaConv.value = aJob.conversation.glodaConv;</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">     // indexIMConversation may initiate an async grokNounItem sub-job.</span>
<a href="#l8.40"></a><span id="l8.40">     this.indexIMConversation(aCallbackHandle, aJob.path, aJob.lastModifiedTime,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -676,17 +676,17 @@ var GlodaIMIndexer = {</span>
<a href="#l8.42"></a><span id="l8.42">           job.folder = conv;</span>
<a href="#l8.43"></a><span id="l8.43">           job.convObj = accountObj[convName];</span>
<a href="#l8.44"></a><span id="l8.44">           GlodaIndexer.indexJob(job);</span>
<a href="#l8.45"></a><span id="l8.45">         }</span>
<a href="#l8.46"></a><span id="l8.46">       }</span>
<a href="#l8.47"></a><span id="l8.47">     }</span>
<a href="#l8.48"></a><span id="l8.48">   },</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  _worker_convFolderSweep: function(aJob, aCallbackHandle) {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  _worker_convFolderSweep: function*(aJob, aCallbackHandle) {</span>
<a href="#l8.52"></a><span id="l8.52">     let folder = aJob.folder;</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54">     let sessions = folder.directoryEntries;</span>
<a href="#l8.55"></a><span id="l8.55">     while (sessions.hasMoreElements()) {</span>
<a href="#l8.56"></a><span id="l8.56">       let file = sessions.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l8.57"></a><span id="l8.57">       let fileName = file.leafName;</span>
<a href="#l8.58"></a><span id="l8.58">       if (!file.isFile() || !file.isReadable() || !fileName.endsWith(&quot;.json&quot;) ||</span>
<a href="#l8.59"></a><span id="l8.59">           (Object.prototype.hasOwnProperty.call(aJob.convObj, fileName) &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/search/content/searchCommon.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/search/content/searchCommon.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -295,17 +295,17 @@ var SearchSupport =</span>
<a href="#l9.4"></a><span id="l9.4">    *</span>
<a href="#l9.5"></a><span id="l9.5">    * Next, it looks for the next folder after the lastFolderIndexedUri. If it is</span>
<a href="#l9.6"></a><span id="l9.6">    * in such a folder, it'll yield return that folder, then set the</span>
<a href="#l9.7"></a><span id="l9.7">    * lastFolderIndexedUrl to the URI of that folder.</span>
<a href="#l9.8"></a><span id="l9.8">    *</span>
<a href="#l9.9"></a><span id="l9.9">    * It resets lastFolderIndexedUri to an empty string, then yield returns null</span>
<a href="#l9.10"></a><span id="l9.10">    * once iteration across all folders is complete.</span>
<a href="#l9.11"></a><span id="l9.11">    */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  _foldersToIndexGenerator: function search_find_next_folder()</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  _foldersToIndexGenerator: function* search_find_next_folder()</span>
<a href="#l9.14"></a><span id="l9.14">   {</span>
<a href="#l9.15"></a><span id="l9.15">     let servers = MailServices.accounts.allServers;</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">     // Stores whether we're after the last folder indexed or before that --</span>
<a href="#l9.18"></a><span id="l9.18">     // if the last folder indexed is empty, this needs to be true initially</span>
<a href="#l9.19"></a><span id="l9.19">     let afterLastFolderIndexed = (this._lastFolderIndexedUri.length == 0);</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">     for (var server in fixIterator(servers, Ci.nsIMsgIncomingServer))</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -475,17 +475,17 @@ var SearchSupport =</span>
<a href="#l9.23"></a><span id="l9.23">   {</span>
<a href="#l9.24"></a><span id="l9.24">     let msgHdrAndReindexTime = null;</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">     if (this.__backgroundIndexingDone)</span>
<a href="#l9.27"></a><span id="l9.27">       return;</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29">     // find the current folder we're working on</span>
<a href="#l9.30"></a><span id="l9.30">     if (!this._currentFolderToIndex)</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-      this._currentFolderToIndex = this._foldersToIndex.next();</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+      this._currentFolderToIndex = this._foldersToIndex.next().value;</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">     // we'd like to index more than one message on each timer fire,</span>
<a href="#l9.35"></a><span id="l9.35">     // but since streaming is async, it's hard to know how long</span>
<a href="#l9.36"></a><span id="l9.36">     // it's going to take to stream any particular message.</span>
<a href="#l9.37"></a><span id="l9.37">     if (this._currentFolderToIndex)</span>
<a href="#l9.38"></a><span id="l9.38">       msgHdrAndReindexTime = this._findNextHdrToIndex();</span>
<a href="#l9.39"></a><span id="l9.39">     else</span>
<a href="#l9.40"></a><span id="l9.40">       // we've cycled through all the folders, we should take a break</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/mozmill/downloads/test-about-downloads.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/mozmill/downloads/test-about-downloads.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -47,17 +47,17 @@ var downloadsView = {</span>
<a href="#l10.4"></a><span id="l10.4">   onDownloadChanged(aDownload) {</span>
<a href="#l10.5"></a><span id="l10.5">   },</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">   onDownloadRemoved(aDownload) {</span>
<a href="#l10.8"></a><span id="l10.8">     this.removedItems.push(aDownload.target.path);</span>
<a href="#l10.9"></a><span id="l10.9">     this.items.delete(aDownload);</span>
<a href="#l10.10"></a><span id="l10.10">   },</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  waitForFinish() {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  waitForFinish: function*() {</span>
<a href="#l10.14"></a><span id="l10.14">     for (let download of this.items.keys()) {</span>
<a href="#l10.15"></a><span id="l10.15">       let succeededPromise = download.whenSucceeded();</span>
<a href="#l10.16"></a><span id="l10.16">       yield succeededPromise;</span>
<a href="#l10.17"></a><span id="l10.17">     }</span>
<a href="#l10.18"></a><span id="l10.18">   }</span>
<a href="#l10.19"></a><span id="l10.19"> };</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> function prepare_messages() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -22,17 +22,17 @@ var folderC;</span>
<a href="#l11.4"></a><span id="l11.4"> var folderTab;</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> var msgHdrsInFolderA = [], msgHdrsInFolderB = [];</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> // The number of messages in folderA/folderB.</span>
<a href="#l11.9"></a><span id="l11.9"> var NUM_MESSAGES_IN_FOLDER = 10;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> // A generator for indexes to load test.</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-function _generateIndexes() {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+function* _generateIndexes() {</span>
<a href="#l11.14"></a><span id="l11.14">   let index = 0;</span>
<a href="#l11.15"></a><span id="l11.15">   while (true) {</span>
<a href="#l11.16"></a><span id="l11.16">     yield index;</span>
<a href="#l11.17"></a><span id="l11.17">     index = (index + 1) % NUM_MESSAGES_IN_FOLDER;</span>
<a href="#l11.18"></a><span id="l11.18">   }</span>
<a href="#l11.19"></a><span id="l11.19"> }</span>
<a href="#l11.20"></a><span id="l11.20"> var indexes = _generateIndexes();</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -139,70 +139,70 @@ function _verify_display_in_existing_tab</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24"> /**</span>
<a href="#l11.25"></a><span id="l11.25">  * Test displaying a message with the same folder already open.</span>
<a href="#l11.26"></a><span id="l11.26">  */</span>
<a href="#l11.27"></a><span id="l11.27"> function test_display_message_in_same_folder() {</span>
<a href="#l11.28"></a><span id="l11.28">   be_in_folder(folderA);</span>
<a href="#l11.29"></a><span id="l11.29">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  let msgHdr = msgHdrsInFolderA[indexes.next()];</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  let msgHdr = msgHdrsInFolderA[indexes.next().value];</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.35"></a><span id="l11.35">   // Verify</span>
<a href="#l11.36"></a><span id="l11.36">   _verify_display_in_existing_tab(preCount, folderA, msgHdr);</span>
<a href="#l11.37"></a><span id="l11.37"> }</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39"> /**</span>
<a href="#l11.40"></a><span id="l11.40">  * Test displaying a message with a different folder open.</span>
<a href="#l11.41"></a><span id="l11.41">  */</span>
<a href="#l11.42"></a><span id="l11.42"> function test_display_message_in_different_folder() {</span>
<a href="#l11.43"></a><span id="l11.43">   be_in_folder(folderB);</span>
<a href="#l11.44"></a><span id="l11.44">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  let msgHdr = msgHdrsInFolderA[indexes.next()];</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+  let msgHdr = msgHdrsInFolderA[indexes.next().value];</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.50"></a><span id="l11.50">   // Verify</span>
<a href="#l11.51"></a><span id="l11.51">   _verify_display_in_existing_tab(preCount, folderA, msgHdr);</span>
<a href="#l11.52"></a><span id="l11.52"> }</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54"> /**</span>
<a href="#l11.55"></a><span id="l11.55">  * Test displaying a message with a message tab active.</span>
<a href="#l11.56"></a><span id="l11.56">  */</span>
<a href="#l11.57"></a><span id="l11.57"> function test_display_message_in_same_folder_with_message_tab_active() {</span>
<a href="#l11.58"></a><span id="l11.58">   be_in_folder(folderA);</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-  let indexToOpen = indexes.next();</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  let indexToOpen = indexes.next().value;</span>
<a href="#l11.62"></a><span id="l11.62">   select_click_row(indexToOpen);</span>
<a href="#l11.63"></a><span id="l11.63">   let messageTab = open_selected_message_in_new_tab(false);</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-  let msgHdr = msgHdrsInFolderA[indexes.next()];</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  let msgHdr = msgHdrsInFolderA[indexes.next().value];</span>
<a href="#l11.68"></a><span id="l11.68">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.69"></a><span id="l11.69">   // Verify</span>
<a href="#l11.70"></a><span id="l11.70">   _verify_display_in_existing_tab(preCount, folderA, msgHdr);</span>
<a href="#l11.71"></a><span id="l11.71"> </span>
<a href="#l11.72"></a><span id="l11.72">   // Clean up, close the message tab</span>
<a href="#l11.73"></a><span id="l11.73">   close_tab(messageTab);</span>
<a href="#l11.74"></a><span id="l11.74"> }</span>
<a href="#l11.75"></a><span id="l11.75"> </span>
<a href="#l11.76"></a><span id="l11.76"> /**</span>
<a href="#l11.77"></a><span id="l11.77">  * Test displaying a message with a different folder open and a message tab</span>
<a href="#l11.78"></a><span id="l11.78">  * active.</span>
<a href="#l11.79"></a><span id="l11.79">  */</span>
<a href="#l11.80"></a><span id="l11.80"> function test_display_message_in_different_folder_with_message_tab_active() {</span>
<a href="#l11.81"></a><span id="l11.81">   be_in_folder(folderA);</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  let indexToOpen = indexes.next();</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+  let indexToOpen = indexes.next().value;</span>
<a href="#l11.85"></a><span id="l11.85">   select_click_row(indexToOpen);</span>
<a href="#l11.86"></a><span id="l11.86">   let messageTab = open_selected_message_in_new_tab(false);</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-  let msgHdr = msgHdrsInFolderB[indexes.next()];</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  let msgHdr = msgHdrsInFolderB[indexes.next().value];</span>
<a href="#l11.91"></a><span id="l11.91">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.92"></a><span id="l11.92">   // Verify</span>
<a href="#l11.93"></a><span id="l11.93">   _verify_display_in_existing_tab(preCount, folderB, msgHdr);</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95">   // Clean up, close the message tab</span>
<a href="#l11.96"></a><span id="l11.96">   close_tab(messageTab);</span>
<a href="#l11.97"></a><span id="l11.97"> }</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99" class="difflineat">@@ -211,17 +211,17 @@ function test_display_message_in_differe</span>
<a href="#l11.100"></a><span id="l11.100">  */</span>
<a href="#l11.101"></a><span id="l11.101"> function test_display_message_in_same_folder_filtered() {</span>
<a href="#l11.102"></a><span id="l11.102">   be_in_folder(folderA);</span>
<a href="#l11.103"></a><span id="l11.103">   set_mail_view(MailViewConstants.kViewItemTags, &quot;$label1&quot;);</span>
<a href="#l11.104"></a><span id="l11.104">   // Make sure all the messages have actually disappeared</span>
<a href="#l11.105"></a><span id="l11.105">   assert_messages_not_in_view(msgHdrsInFolderA);</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-  let msgHdr = msgHdrsInFolderA[indexes.next()];</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  let msgHdr = msgHdrsInFolderA[indexes.next().value];</span>
<a href="#l11.110"></a><span id="l11.110">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.111"></a><span id="l11.111">   // Verify</span>
<a href="#l11.112"></a><span id="l11.112">   _verify_display_in_existing_tab(preCount, folderA, msgHdr);</span>
<a href="#l11.113"></a><span id="l11.113"> </span>
<a href="#l11.114"></a><span id="l11.114">   // Reset the mail view</span>
<a href="#l11.115"></a><span id="l11.115">   set_mail_view(MailViewConstants.kViewItemAll, null);</span>
<a href="#l11.116"></a><span id="l11.116"> }</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118" class="difflineat">@@ -235,17 +235,17 @@ function test_display_message_in_differe</span>
<a href="#l11.119"></a><span id="l11.119">   assert_messages_not_in_view(msgHdrsInFolderB);</span>
<a href="#l11.120"></a><span id="l11.120"> </span>
<a href="#l11.121"></a><span id="l11.121">   // Do the same for folder A</span>
<a href="#l11.122"></a><span id="l11.122">   be_in_folder(folderA);</span>
<a href="#l11.123"></a><span id="l11.123">   set_mail_view(MailViewConstants.kViewItemTags, &quot;$label2&quot;);</span>
<a href="#l11.124"></a><span id="l11.124">   assert_messages_not_in_view(msgHdrsInFolderA);</span>
<a href="#l11.125"></a><span id="l11.125"> </span>
<a href="#l11.126"></a><span id="l11.126">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-  let msgHdr = msgHdrsInFolderB[indexes.next()];</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+  let msgHdr = msgHdrsInFolderB[indexes.next().value];</span>
<a href="#l11.129"></a><span id="l11.129">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.130"></a><span id="l11.130">   // Verify</span>
<a href="#l11.131"></a><span id="l11.131">   _verify_display_in_existing_tab(preCount, folderB, msgHdr);</span>
<a href="#l11.132"></a><span id="l11.132">   // Reset folder B's state</span>
<a href="#l11.133"></a><span id="l11.133">   be_in_folder(folderB);</span>
<a href="#l11.134"></a><span id="l11.134">   set_mail_view(MailViewConstants.kViewItemAll, null);</span>
<a href="#l11.135"></a><span id="l11.135"> </span>
<a href="#l11.136"></a><span id="l11.136">   // Now get back to folder A, and check that its state hasn't changed</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineat">@@ -256,28 +256,28 @@ function test_display_message_in_differe</span>
<a href="#l11.138"></a><span id="l11.138"> }</span>
<a href="#l11.139"></a><span id="l11.139"> </span>
<a href="#l11.140"></a><span id="l11.140"> /**</span>
<a href="#l11.141"></a><span id="l11.141">  * Test displaying a message with the folder filtered and a message tab active.</span>
<a href="#l11.142"></a><span id="l11.142">  */</span>
<a href="#l11.143"></a><span id="l11.143"> function test_display_message_in_same_folder_filtered_with_message_tab_active() {</span>
<a href="#l11.144"></a><span id="l11.144">   be_in_folder(folderB);</span>
<a href="#l11.145"></a><span id="l11.145"> </span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-  let indexToOpen = indexes.next();</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+  let indexToOpen = indexes.next().value;</span>
<a href="#l11.148"></a><span id="l11.148">   select_click_row(indexToOpen);</span>
<a href="#l11.149"></a><span id="l11.149">   let messageTab = open_selected_message_in_new_tab(false);</span>
<a href="#l11.150"></a><span id="l11.150"> </span>
<a href="#l11.151"></a><span id="l11.151">   switch_tab(folderTab);</span>
<a href="#l11.152"></a><span id="l11.152">   set_mail_view(MailViewConstants.kViewItemTags, &quot;$label1&quot;);</span>
<a href="#l11.153"></a><span id="l11.153">   // Make sure all the messages have actually disappeared</span>
<a href="#l11.154"></a><span id="l11.154">   assert_messages_not_in_view(msgHdrsInFolderB);</span>
<a href="#l11.155"></a><span id="l11.155">   switch_tab(messageTab);</span>
<a href="#l11.156"></a><span id="l11.156"> </span>
<a href="#l11.157"></a><span id="l11.157">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-  let msgHdr = msgHdrsInFolderB[indexes.next()];</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+  let msgHdr = msgHdrsInFolderB[indexes.next().value];</span>
<a href="#l11.160"></a><span id="l11.160">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.161"></a><span id="l11.161">   // Verify</span>
<a href="#l11.162"></a><span id="l11.162">   _verify_display_in_existing_tab(preCount, folderB, msgHdr);</span>
<a href="#l11.163"></a><span id="l11.163"> </span>
<a href="#l11.164"></a><span id="l11.164">   // Clean up, close the message tab and reset the mail view</span>
<a href="#l11.165"></a><span id="l11.165">   close_tab(messageTab);</span>
<a href="#l11.166"></a><span id="l11.166">   set_mail_view(MailViewConstants.kViewItemAll, null);</span>
<a href="#l11.167"></a><span id="l11.167"> }</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineat">@@ -295,17 +295,17 @@ function</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170">   be_in_folder(folderB);</span>
<a href="#l11.171"></a><span id="l11.171">   set_mail_view(MailViewConstants.kViewItemTags, &quot;$label3&quot;);</span>
<a href="#l11.172"></a><span id="l11.172">   // There should be one message in here</span>
<a href="#l11.173"></a><span id="l11.173">   select_click_row(0);</span>
<a href="#l11.174"></a><span id="l11.174">   let messageTab = open_selected_message_in_new_tab(false);</span>
<a href="#l11.175"></a><span id="l11.175"> </span>
<a href="#l11.176"></a><span id="l11.176">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-  let msgHdr = msgHdrsInFolderA[indexes.next()];</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+  let msgHdr = msgHdrsInFolderA[indexes.next().value];</span>
<a href="#l11.179"></a><span id="l11.179">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.180"></a><span id="l11.180">   // Verify</span>
<a href="#l11.181"></a><span id="l11.181">   _verify_display_in_existing_tab(preCount, folderA, msgHdr);</span>
<a href="#l11.182"></a><span id="l11.182">   // Close the message tab</span>
<a href="#l11.183"></a><span id="l11.183">   close_tab(messageTab);</span>
<a href="#l11.184"></a><span id="l11.184">   // Reset folder A's state</span>
<a href="#l11.185"></a><span id="l11.185">   be_in_folder(folderA);</span>
<a href="#l11.186"></a><span id="l11.186">   set_mail_view(MailViewConstants.kViewItemAll, null);</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineat">@@ -322,17 +322,17 @@ function</span>
<a href="#l11.188"></a><span id="l11.188">  */</span>
<a href="#l11.189"></a><span id="l11.189"> function test_display_message_in_same_folder_unread() {</span>
<a href="#l11.190"></a><span id="l11.190">   be_in_folder(folderB);</span>
<a href="#l11.191"></a><span id="l11.191">   set_show_unread_only(true);</span>
<a href="#l11.192"></a><span id="l11.192">   // Make sure all the messages have actually disappeared</span>
<a href="#l11.193"></a><span id="l11.193">   assert_messages_not_in_view(msgHdrsInFolderB);</span>
<a href="#l11.194"></a><span id="l11.194"> </span>
<a href="#l11.195"></a><span id="l11.195">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-  let msgHdr = msgHdrsInFolderB[indexes.next()];</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+  let msgHdr = msgHdrsInFolderB[indexes.next().value];</span>
<a href="#l11.198"></a><span id="l11.198">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.199"></a><span id="l11.199">   // Verify</span>
<a href="#l11.200"></a><span id="l11.200">   _verify_display_in_existing_tab(preCount, folderB, msgHdr);</span>
<a href="#l11.201"></a><span id="l11.201">   // Reset the state</span>
<a href="#l11.202"></a><span id="l11.202">   be_in_folder(folderB);</span>
<a href="#l11.203"></a><span id="l11.203">   set_show_unread_only(false);</span>
<a href="#l11.204"></a><span id="l11.204"> }</span>
<a href="#l11.205"></a><span id="l11.205"> </span>
<a href="#l11.206"></a><span id="l11.206" class="difflineat">@@ -347,17 +347,17 @@ function test_display_message_in_differe</span>
<a href="#l11.207"></a><span id="l11.207">   assert_messages_not_in_view(msgHdrsInFolderA);</span>
<a href="#l11.208"></a><span id="l11.208"> </span>
<a href="#l11.209"></a><span id="l11.209">   // Do the same for folder B</span>
<a href="#l11.210"></a><span id="l11.210">   be_in_folder(folderB);</span>
<a href="#l11.211"></a><span id="l11.211">   set_show_unread_only(true);</span>
<a href="#l11.212"></a><span id="l11.212">   assert_messages_not_in_view(msgHdrsInFolderB);</span>
<a href="#l11.213"></a><span id="l11.213"> </span>
<a href="#l11.214"></a><span id="l11.214">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-  let msgHdr = msgHdrsInFolderA[indexes.next()];</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+  let msgHdr = msgHdrsInFolderA[indexes.next().value];</span>
<a href="#l11.217"></a><span id="l11.217">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l11.218"></a><span id="l11.218">   // Verify</span>
<a href="#l11.219"></a><span id="l11.219">   _verify_display_in_existing_tab(preCount, folderA, msgHdr);</span>
<a href="#l11.220"></a><span id="l11.220">   // Reset folder A's state</span>
<a href="#l11.221"></a><span id="l11.221">   be_in_folder(folderA);</span>
<a href="#l11.222"></a><span id="l11.222">   set_show_unread_only(false);</span>
<a href="#l11.223"></a><span id="l11.223"> </span>
<a href="#l11.224"></a><span id="l11.224">   // Now get back to folder B, and check that its state hasn't changed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -885,19 +885,17 @@ function select_none(aController) {</span>
<a href="#l12.4"></a><span id="l12.4">  * @param aViewIndex An absolute index (integer &gt;= 0), slice-style index (&lt; 0),</span>
<a href="#l12.5"></a><span id="l12.5">  *     or a SyntheticMessageSet (we only care about the first message in it).</span>
<a href="#l12.6"></a><span id="l12.6">  */</span>
<a href="#l12.7"></a><span id="l12.7"> function _normalize_view_index(aViewIndex, aController) {</span>
<a href="#l12.8"></a><span id="l12.8">   if (aController == null)</span>
<a href="#l12.9"></a><span id="l12.9">     aController = mc;</span>
<a href="#l12.10"></a><span id="l12.10">   // SyntheticMessageSet special-case</span>
<a href="#l12.11"></a><span id="l12.11">   if (typeof(aViewIndex) != &quot;number&quot;) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    let msgHdrIter = aViewIndex.msgHdrs;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-    let msgHdr = msgHdrIter.next();</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-    msgHdrIter.close();</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+    let msgHdr = aViewIndex.msgHdrs().next().value;</span>
<a href="#l12.16"></a><span id="l12.16">     // do not expand</span>
<a href="#l12.17"></a><span id="l12.17">     aViewIndex = aController.dbView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l12.18"></a><span id="l12.18">   }</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   if (aViewIndex &lt; 0)</span>
<a href="#l12.21"></a><span id="l12.21">     return aController.dbView.QueryInterface(Ci.nsITreeView).rowCount +</span>
<a href="#l12.22"></a><span id="l12.22">       aViewIndex;</span>
<a href="#l12.23"></a><span id="l12.23">   return aViewIndex;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineat">@@ -1884,17 +1882,17 @@ function _process_row_message_arguments(</span>
<a href="#l12.25"></a><span id="l12.25">           throw_and_dump_view_state(</span>
<a href="#l12.26"></a><span id="l12.26">             &quot;Message not present in view that should be there. &quot; +</span>
<a href="#l12.27"></a><span id="l12.27">              &quot;(&quot; + msgHdr.messageKey + &quot;: &quot; + msgHdr.mime2DecodedSubject + &quot;)&quot;);</span>
<a href="#l12.28"></a><span id="l12.28">         desiredIndices.push(viewIndex);</span>
<a href="#l12.29"></a><span id="l12.29">       }</span>
<a href="#l12.30"></a><span id="l12.30">     }</span>
<a href="#l12.31"></a><span id="l12.31">     // SyntheticMessageSet</span>
<a href="#l12.32"></a><span id="l12.32">     else if (arg.synMessages) {</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-      for (let msgHdr of arg.msgHdrs) {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+      for (let msgHdr of arg.msgHdrs()) {</span>
<a href="#l12.35"></a><span id="l12.35">         let viewIndex = troller.dbView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l12.36"></a><span id="l12.36">         if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l12.37"></a><span id="l12.37">           throw_and_dump_view_state(</span>
<a href="#l12.38"></a><span id="l12.38">             &quot;Message not present in view that should be there. &quot; +</span>
<a href="#l12.39"></a><span id="l12.39">              &quot;(&quot; + msgHdr.messageKey + &quot;: &quot; + msgHdr.mime2DecodedSubject + &quot;)&quot;);</span>
<a href="#l12.40"></a><span id="l12.40">         desiredIndices.push(viewIndex);</span>
<a href="#l12.41"></a><span id="l12.41">       }</span>
<a href="#l12.42"></a><span id="l12.42">     }</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineat">@@ -2126,17 +2124,17 @@ function assert_messages_summarized(aCon</span>
<a href="#l12.44"></a><span id="l12.44">   //  actually gotten a chance to run.</span>
<a href="#l12.45"></a><span id="l12.45">   controller.sleep(0);</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47">   // - Verify summary object knows about right messages</span>
<a href="#l12.48"></a><span id="l12.48">   if (aSelectedMessages == null)</span>
<a href="#l12.49"></a><span id="l12.49">     aSelectedMessages = aController.folderDisplay.selectedMessages;</span>
<a href="#l12.50"></a><span id="l12.50">   // if it's a synthetic message set, we want the headers...</span>
<a href="#l12.51"></a><span id="l12.51">   if (aSelectedMessages.synMessages)</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    aSelectedMessages = Array.from(aSelectedMessages.msgHdrs);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    aSelectedMessages = Array.from(aSelectedMessages.msgHdrs());</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">   let summaryFrame = aController.window.gSummaryFrameManager.iframe;</span>
<a href="#l12.56"></a><span id="l12.56">   let summary = summaryFrame.contentWindow.gMessageSummary;</span>
<a href="#l12.57"></a><span id="l12.57">   let summarizedKeys = Object.keys(summary._msgNodes);</span>
<a href="#l12.58"></a><span id="l12.58">   if (aSelectedMessages.length != summarizedKeys.length) {</span>
<a href="#l12.59"></a><span id="l12.59">     let elaboration = &quot;Summary contains &quot; + summarizedKeys.length +</span>
<a href="#l12.60"></a><span id="l12.60">                       &quot; messages, expected &quot; + aSelectedMessages.length + &quot;.&quot;;</span>
<a href="#l12.61"></a><span id="l12.61">     throw new Error(&quot;Summary does not contain the right set of messages. &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -113,17 +113,17 @@ GlodaAttributeDBDef.prototype = {</span>
<a href="#l13.4"></a><span id="l13.4">   },</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">   toString: function() {</span>
<a href="#l13.7"></a><span id="l13.7">     return this._compoundName;</span>
<a href="#l13.8"></a><span id="l13.8">   }</span>
<a href="#l13.9"></a><span id="l13.9"> };</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> var GlodaHasAttributesMixIn = {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  enumerateAttributes: function gloda_attrix_enumerateAttributes() {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  enumerateAttributes: function* gloda_attrix_enumerateAttributes() {</span>
<a href="#l13.14"></a><span id="l13.14">     let nounDef = this.NOUN_DEF;</span>
<a href="#l13.15"></a><span id="l13.15">     for (let key in this) {</span>
<a href="#l13.16"></a><span id="l13.16">       let value = this[key];</span>
<a href="#l13.17"></a><span id="l13.17">       let attrDef = nounDef.attribsByBoundName[key];</span>
<a href="#l13.18"></a><span id="l13.18">       // we expect to not have attributes for underscore prefixed values (those</span>
<a href="#l13.19"></a><span id="l13.19">       //  are managed by the instance's logic.  we also want to not explode</span>
<a href="#l13.20"></a><span id="l13.20">       //  should someone crap other values in there, we get both birds with this</span>
<a href="#l13.21"></a><span id="l13.21">       //  one stone.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3159,18 +3159,18 @@ var GlodaDatastore = {</span>
<a href="#l14.4"></a><span id="l14.4">    */</span>
<a href="#l14.5"></a><span id="l14.5">   get _escapeLikeStatement() {</span>
<a href="#l14.6"></a><span id="l14.6">     let statement = this._createAsyncStatement(&quot;SELECT 0&quot;);</span>
<a href="#l14.7"></a><span id="l14.7">     this.__defineGetter__(&quot;_escapeLikeStatement&quot;, () =&gt; statement);</span>
<a href="#l14.8"></a><span id="l14.8">     return this._escapeLikeStatement;</span>
<a href="#l14.9"></a><span id="l14.9">   },</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">   _convertToDBValuesAndGroupByAttributeID:</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    function gloda_ds__convertToDBValuesAndGroupByAttributeID(aAttrDef,</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                                                              aValues) {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+    function* gloda_ds__convertToDBValuesAndGroupByAttributeID(aAttrDef,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+                                                               aValues) {</span>
<a href="#l14.16"></a><span id="l14.16">     let objectNounDef = aAttrDef.objectNounDef;</span>
<a href="#l14.17"></a><span id="l14.17">     if (!objectNounDef.usesParameter) {</span>
<a href="#l14.18"></a><span id="l14.18">       let dbValues = [];</span>
<a href="#l14.19"></a><span id="l14.19">       for (let iValue = 0; iValue &lt; aValues.length; iValue++) {</span>
<a href="#l14.20"></a><span id="l14.20">         let value = aValues[iValue];</span>
<a href="#l14.21"></a><span id="l14.21">         // If the empty set is significant and it's an empty signifier, emit</span>
<a href="#l14.22"></a><span id="l14.22">         //  the appropriate dbvalue.</span>
<a href="#l14.23"></a><span id="l14.23">         if (value == null &amp;&amp; aAttrDef.emptySetIsSignificant) {</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineat">@@ -3226,17 +3226,17 @@ var GlodaDatastore = {</span>
<a href="#l14.25"></a><span id="l14.25">           dbValues = [];</span>
<a href="#l14.26"></a><span id="l14.26">       }</span>
<a href="#l14.27"></a><span id="l14.27">     }</span>
<a href="#l14.28"></a><span id="l14.28">     if (dbValues !== undefined)</span>
<a href="#l14.29"></a><span id="l14.29">       yield [attrID, dbValues];</span>
<a href="#l14.30"></a><span id="l14.30">   },</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32">   _convertRangesToDBStringsAndGroupByAttributeID:</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-    function gloda_ds__convertRangesToDBStringsAndGroupByAttributeID(aAttrDef,</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    function* gloda_ds__convertRangesToDBStringsAndGroupByAttributeID(aAttrDef,</span>
<a href="#l14.35"></a><span id="l14.35">       aValues, aValueColumnName) {</span>
<a href="#l14.36"></a><span id="l14.36">     let objectNounDef = aAttrDef.objectNounDef;</span>
<a href="#l14.37"></a><span id="l14.37">     if (!objectNounDef.usesParameter) {</span>
<a href="#l14.38"></a><span id="l14.38">       let dbStrings = [];</span>
<a href="#l14.39"></a><span id="l14.39">       for (let iValue = 0; iValue &lt; aValues.length; iValue++) {</span>
<a href="#l14.40"></a><span id="l14.40">         let [lowerVal, upperVal] = aValues[iValue];</span>
<a href="#l14.41"></a><span id="l14.41">         // they both can't be null.  that is the law.</span>
<a href="#l14.42"></a><span id="l14.42">         if (lowerVal == null)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/db/gloda/modules/explattr.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/explattr.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -129,18 +129,18 @@ var GlodaExplicitAttr = {</span>
<a href="#l15.4"></a><span id="l15.4">       attributeName: &quot;forwarded&quot;,</span>
<a href="#l15.5"></a><span id="l15.5">       singular: true,</span>
<a href="#l15.6"></a><span id="l15.6">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l15.7"></a><span id="l15.7">       objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l15.8"></a><span id="l15.8">       parameterNoun: null,</span>
<a href="#l15.9"></a><span id="l15.9">     }); // tested-by: test_attributes_explicit</span>
<a href="#l15.10"></a><span id="l15.10">   },</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  process: function Gloda_explattr_process(aGlodaMessage, aRawReps, aIsNew,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                                           aCallbackHandle) {</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  process: function* Gloda_explattr_process(aGlodaMessage, aRawReps, aIsNew,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+                                            aCallbackHandle) {</span>
<a href="#l15.16"></a><span id="l15.16">     let aMsgHdr = aRawReps.header;</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">     aGlodaMessage.starred = aMsgHdr.isFlagged;</span>
<a href="#l15.19"></a><span id="l15.19">     if (aGlodaMessage.starred)</span>
<a href="#l15.20"></a><span id="l15.20">       aGlodaMessage.notability += this.NOTABILITY_STARRED;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22">     aGlodaMessage.read = aMsgHdr.isRead;</span>
<a href="#l15.23"></a><span id="l15.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -460,18 +460,18 @@ var GlodaFundAttr = {</span>
<a href="#l16.4"></a><span id="l16.4">    * Specializations:</span>
<a href="#l16.5"></a><span id="l16.5">    * - Mailing Lists.  Replies to a message on a mailing list frequently only</span>
<a href="#l16.6"></a><span id="l16.6">    *   have the list-serve as the 'to', so we try to generate a synthetic 'to'</span>
<a href="#l16.7"></a><span id="l16.7">    *   based on the author of the parent message when possible.  (The 'possible'</span>
<a href="#l16.8"></a><span id="l16.8">    *   part is that we may not have a copy of the parent message at the time of</span>
<a href="#l16.9"></a><span id="l16.9">    *   processing.)</span>
<a href="#l16.10"></a><span id="l16.10">    * - Newsgroups.  Same deal as mailing lists.</span>
<a href="#l16.11"></a><span id="l16.11">    */</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  process: function gloda_fundattr_process(aGlodaMessage, aRawReps,</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-                                           aIsNew, aCallbackHandle) {</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+  process: function* gloda_fundattr_process(aGlodaMessage, aRawReps,</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+                                            aIsNew, aCallbackHandle) {</span>
<a href="#l16.16"></a><span id="l16.16">     let aMsgHdr = aRawReps.header;</span>
<a href="#l16.17"></a><span id="l16.17">     let aMimeMsg = aRawReps.mime;</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">     // -- From</span>
<a href="#l16.20"></a><span id="l16.20">     // Let's use replyTo if available.</span>
<a href="#l16.21"></a><span id="l16.21">     // er, since we are just dealing with mailing lists for now, forget the</span>
<a href="#l16.22"></a><span id="l16.22">     //  reply-to...</span>
<a href="#l16.23"></a><span id="l16.23">     // TODO: deal with default charset issues</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineat">@@ -608,18 +608,18 @@ var GlodaFundAttr = {</span>
<a href="#l16.25"></a><span id="l16.25">                                aAtt.name,</span>
<a href="#l16.26"></a><span id="l16.26">                                aAtt.contentType,</span>
<a href="#l16.27"></a><span id="l16.27">                                aAtt.size,</span>
<a href="#l16.28"></a><span id="l16.28">                                part,</span>
<a href="#l16.29"></a><span id="l16.29">                                externalUrl,</span>
<a href="#l16.30"></a><span id="l16.30">                                aAtt.isExternal);</span>
<a href="#l16.31"></a><span id="l16.31">   },</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-  optimize: function gloda_fundattr_optimize(aGlodaMessage, aRawReps,</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-      aIsNew, aCallbackHandle) {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  optimize: function* gloda_fundattr_optimize(aGlodaMessage, aRawReps,</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+                                              aIsNew, aCallbackHandle) {</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38">     let aMsgHdr = aRawReps.header;</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40">     // for simplicity this is used for both involves and recipients</span>
<a href="#l16.41"></a><span id="l16.41">     let involvesIdentities = {};</span>
<a href="#l16.42"></a><span id="l16.42">     let involves = aGlodaMessage.involves || [];</span>
<a href="#l16.43"></a><span id="l16.43">     let recipients = aGlodaMessage.recipients || [];</span>
<a href="#l16.44"></a><span id="l16.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -376,17 +376,17 @@ var Gloda = {</span>
<a href="#l17.4"></a><span id="l17.4">    *   '&quot;Bob Smith&quot; &lt;bob@example.com&gt;' is an address with display name.  Mime</span>
<a href="#l17.5"></a><span id="l17.5">    *   header decoding is performed, but is ignorant of any folder-level</span>
<a href="#l17.6"></a><span id="l17.6">    *   character set overrides.</span>
<a href="#l17.7"></a><span id="l17.7">    * @returns via the callback handle mechanism, a list containing one sub-list</span>
<a href="#l17.8"></a><span id="l17.8">    *   for each string argument passed.  Each sub-list containts zero or more</span>
<a href="#l17.9"></a><span id="l17.9">    *   GlodaIdentity instances corresponding to the addresses provided.</span>
<a href="#l17.10"></a><span id="l17.10">    */</span>
<a href="#l17.11"></a><span id="l17.11">   getOrCreateMailIdentities:</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-      function gloda_ns_getOrCreateMailIdentities(aCallbackHandle) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+      function* gloda_ns_getOrCreateMailIdentities(aCallbackHandle) {</span>
<a href="#l17.14"></a><span id="l17.14">     let addresses = {};</span>
<a href="#l17.15"></a><span id="l17.15">     let resultLists = [];</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17">     // parse the strings</span>
<a href="#l17.18"></a><span id="l17.18">     for (let iArg = 1; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l17.19"></a><span id="l17.19">       let aMailAddresses = arguments[iArg];</span>
<a href="#l17.20"></a><span id="l17.20">       let parsed = GlodaUtils.parseMailAddresses(aMailAddresses);</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -1978,17 +1978,17 @@ var Gloda = {</span>
<a href="#l17.23"></a><span id="l17.23">    *     with messages where we may have a ghost, the ghost message is not a</span>
<a href="#l17.24"></a><span id="l17.24">    *     new record, but is conceptually new.</span>
<a href="#l17.25"></a><span id="l17.25">    * @param aCallbackHandle The GlodaIndexer-style callback handle that is being</span>
<a href="#l17.26"></a><span id="l17.26">    *     used to drive this processing in an async fashion.  (See</span>
<a href="#l17.27"></a><span id="l17.27">    *     GlodaIndexer._callbackHandle).</span>
<a href="#l17.28"></a><span id="l17.28">    * @param aDoCache Should we allow this item to be contributed to its noun</span>
<a href="#l17.29"></a><span id="l17.29">    *     cache?</span>
<a href="#l17.30"></a><span id="l17.30">    */</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-  grokNounItem: function gloda_ns_grokNounItem(aItem, aRawReps,</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  grokNounItem: function* gloda_ns_grokNounItem(aItem, aRawReps,</span>
<a href="#l17.33"></a><span id="l17.33">       aIsConceptuallyNew, aIsRecordNew, aCallbackHandle, aDoCache) {</span>
<a href="#l17.34"></a><span id="l17.34">     let itemNounDef = aItem.NOUN_DEF;</span>
<a href="#l17.35"></a><span id="l17.35">     let attribsByBoundName = itemNounDef.attribsByBoundName;</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">     this._log.info(&quot; ** grokNounItem: &quot; + itemNounDef.name);</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39">     let addDBAttribs = [];</span>
<a href="#l17.40"></a><span id="l17.40">     let removeDBAttribs = [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/db/gloda/modules/index_ab.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/index_ab.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -249,17 +249,17 @@ var GlodaABAttrs = {</span>
<a href="#l18.4"></a><span id="l18.4">     if (&quot;parameterBindings&quot; in this._attrFreeTag) {</span>
<a href="#l18.5"></a><span id="l18.5">       for (let freeTagName in this._attrFreeTag.parameterBindings) {</span>
<a href="#l18.6"></a><span id="l18.6">         this._log.debug(&quot;Telling FreeTagNoun about: &quot; + freeTagName);</span>
<a href="#l18.7"></a><span id="l18.7">         FreeTagNoun.getFreeTag(freeTagName);</span>
<a href="#l18.8"></a><span id="l18.8">       }</span>
<a href="#l18.9"></a><span id="l18.9">     }</span>
<a href="#l18.10"></a><span id="l18.10">   },</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  process: function(aContact, aRawReps, aIsNew, aCallbackHandle) {</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  process: function*(aContact, aRawReps, aIsNew, aCallbackHandle) {</span>
<a href="#l18.14"></a><span id="l18.14">     let card = aRawReps.card;</span>
<a href="#l18.15"></a><span id="l18.15">     if (aContact.NOUN_ID != Gloda.NOUN_CONTACT) {</span>
<a href="#l18.16"></a><span id="l18.16">       this._log.warn(&quot;Somehow got a non-contact: &quot; + aContact);</span>
<a href="#l18.17"></a><span id="l18.17">       return; // this will produce an exception; we like.</span>
<a href="#l18.18"></a><span id="l18.18">     }</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20">     // update the name</span>
<a href="#l18.21"></a><span id="l18.21">     if (card.displayName &amp;&amp; card.displayName != aContact.name)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/db/gloda/modules/index_msg.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/index_msg.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -89,17 +89,17 @@ var nsMsgProcessingFlags = Ci.nsMsgProce</span>
<a href="#l19.4"></a><span id="l19.4">  *  reported to us via msgsClassified.  If it has one of these flags, it is</span>
<a href="#l19.5"></a><span id="l19.5">  *  still being processed.</span>
<a href="#l19.6"></a><span id="l19.6">  */</span>
<a href="#l19.7"></a><span id="l19.7"> var NOT_YET_REPORTED_PROCESSING_FLAGS =</span>
<a href="#l19.8"></a><span id="l19.8">   nsMsgProcessingFlags.NotReportedClassified |</span>
<a href="#l19.9"></a><span id="l19.9">   nsMsgProcessingFlags.ClassifyJunk;</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> // for list comprehension fun</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-function range(begin, end) {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+function* range(begin, end) {</span>
<a href="#l19.14"></a><span id="l19.14">   for (let i = begin; i &lt; end; ++i) {</span>
<a href="#l19.15"></a><span id="l19.15">     yield i;</span>
<a href="#l19.16"></a><span id="l19.16">   }</span>
<a href="#l19.17"></a><span id="l19.17"> }</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19"> /**</span>
<a href="#l19.20"></a><span id="l19.20">  * We do not set properties on the messages until we perform a DB commit; this</span>
<a href="#l19.21"></a><span id="l19.21">  *  helper class tracks messages that we have indexed but are not yet marked</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -984,17 +984,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l19.23"></a><span id="l19.23">    *  retrieve the list of servers and folders each time want to find a new</span>
<a href="#l19.24"></a><span id="l19.24">    *  folder to index.  This avoids needing to maintain a perfect model of the</span>
<a href="#l19.25"></a><span id="l19.25">    *  folder hierarchy at all times.  (We may eventually want to do that, but</span>
<a href="#l19.26"></a><span id="l19.26">    *  this is sufficient and safe for now.)  Although our use of dirty flags on</span>
<a href="#l19.27"></a><span id="l19.27">    *  the folders allows us to avoid tracking the 'last folder' we processed,</span>
<a href="#l19.28"></a><span id="l19.28">    *  we do so to avoid getting 'trapped' in a folder with a high rate of</span>
<a href="#l19.29"></a><span id="l19.29">    *  changes.</span>
<a href="#l19.30"></a><span id="l19.30">    */</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  _worker_indexingSweep: function gloda_worker_indexingSweep(aJob) {</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+  _worker_indexingSweep: function* gloda_worker_indexingSweep(aJob) {</span>
<a href="#l19.33"></a><span id="l19.33">     if (!aJob.mappedFolders) {</span>
<a href="#l19.34"></a><span id="l19.34">       // Walk the folders and make sure all the folders we would want to index</span>
<a href="#l19.35"></a><span id="l19.35">       //  are mapped.  Build up a list of GlodaFolders as we go, so that we can</span>
<a href="#l19.36"></a><span id="l19.36">       //  sort them by their indexing priority.</span>
<a href="#l19.37"></a><span id="l19.37">       let foldersToProcess = aJob.foldersToProcess = [];</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39">       let allFolders = MailServices.accounts.allFolders;</span>
<a href="#l19.40"></a><span id="l19.40">       for (let folder in fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineat">@@ -1123,17 +1123,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l19.42"></a><span id="l19.42">    *  our database updates.  Since compaction of message key K results in a new</span>
<a href="#l19.43"></a><span id="l19.43">    *  message key K' such that K' &lt;= K, we can reliably issue database</span>
<a href="#l19.44"></a><span id="l19.44">    *  updates for all values &lt;= K.  Which means our feet are safe no matter</span>
<a href="#l19.45"></a><span id="l19.45">    *  when we issue the update command.  For maximum cache benefit, we issue</span>
<a href="#l19.46"></a><span id="l19.46">    *  our updates prior to our new query since they should still be maximally</span>
<a href="#l19.47"></a><span id="l19.47">    *  hot at that point.</span>
<a href="#l19.48"></a><span id="l19.48">    */</span>
<a href="#l19.49"></a><span id="l19.49">   _worker_folderCompactionPass:</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-      function gloda_worker_folderCompactionPass(aJob, aCallbackHandle) {</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+      function* gloda_worker_folderCompactionPass(aJob, aCallbackHandle) {</span>
<a href="#l19.52"></a><span id="l19.52">     yield this._indexerEnterFolder(aJob.id);</span>
<a href="#l19.53"></a><span id="l19.53"> </span>
<a href="#l19.54"></a><span id="l19.54">     // It's conceivable that with a folder sweep we might end up trying to</span>
<a href="#l19.55"></a><span id="l19.55">     //  compact a folder twice.  Bail early in this case.</span>
<a href="#l19.56"></a><span id="l19.56">     if (!this._indexingGlodaFolder.compacted)</span>
<a href="#l19.57"></a><span id="l19.57">       yield this.kWorkDone;</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59">     // this is a forward enumeration (sometimes we reverse enumerate; not here)</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineat">@@ -1324,17 +1324,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l19.61"></a><span id="l19.61">     this._indexerLeaveFolder();</span>
<a href="#l19.62"></a><span id="l19.62">     yield this.kWorkDone;</span>
<a href="#l19.63"></a><span id="l19.63">   },</span>
<a href="#l19.64"></a><span id="l19.64"> </span>
<a href="#l19.65"></a><span id="l19.65">   /**</span>
<a href="#l19.66"></a><span id="l19.66">    * Index the contents of a folder.</span>
<a href="#l19.67"></a><span id="l19.67">    */</span>
<a href="#l19.68"></a><span id="l19.68">   _worker_folderIndex:</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-      function gloda_worker_folderIndex(aJob, aCallbackHandle) {</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+      function* gloda_worker_folderIndex(aJob, aCallbackHandle) {</span>
<a href="#l19.71"></a><span id="l19.71">     let logDebug = this._log.level &lt;= Log4Moz.Level.Debug;</span>
<a href="#l19.72"></a><span id="l19.72">     yield this._indexerEnterFolder(aJob.id);</span>
<a href="#l19.73"></a><span id="l19.73"> </span>
<a href="#l19.74"></a><span id="l19.74">     if (!this.shouldIndexFolder(this._indexingFolder)) {</span>
<a href="#l19.75"></a><span id="l19.75">       aJob.safelyInvokeCallback(true);</span>
<a href="#l19.76"></a><span id="l19.76">       yield this.kWorkDone;</span>
<a href="#l19.77"></a><span id="l19.77">     }</span>
<a href="#l19.78"></a><span id="l19.78"> </span>
<a href="#l19.79"></a><span id="l19.79" class="difflineat">@@ -1501,17 +1501,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l19.80"></a><span id="l19.80">   },</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83">   /**</span>
<a href="#l19.84"></a><span id="l19.84">    * Index a specific list of messages that we know to index from</span>
<a href="#l19.85"></a><span id="l19.85">    *  event-notification hints.</span>
<a href="#l19.86"></a><span id="l19.86">    */</span>
<a href="#l19.87"></a><span id="l19.87">   _worker_messageIndex:</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-      function gloda_worker_messageIndex(aJob, aCallbackHandle) {</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+      function* gloda_worker_messageIndex(aJob, aCallbackHandle) {</span>
<a href="#l19.90"></a><span id="l19.90">     // if we are already in the correct folder, our &quot;get in the folder&quot; clause</span>
<a href="#l19.91"></a><span id="l19.91">     //  will not execute, so we need to make sure this value is accurate in</span>
<a href="#l19.92"></a><span id="l19.92">     //  that case.  (and we want to avoid multiple checks...)</span>
<a href="#l19.93"></a><span id="l19.93">     for (; aJob.offset &lt; aJob.items.length; aJob.offset++) {</span>
<a href="#l19.94"></a><span id="l19.94">       let item = aJob.items[aJob.offset];</span>
<a href="#l19.95"></a><span id="l19.95">       // item is either [folder ID, message key] or</span>
<a href="#l19.96"></a><span id="l19.96">       //                [folder ID, message ID]</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98" class="difflineat">@@ -1637,17 +1637,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l19.99"></a><span id="l19.99">    * Maximum number of deleted messages to process at a time.  Arbitrary; there</span>
<a href="#l19.100"></a><span id="l19.100">    *  are no real known performance constraints at this point.</span>
<a href="#l19.101"></a><span id="l19.101">    */</span>
<a href="#l19.102"></a><span id="l19.102">   DELETED_MESSAGE_BLOCK_SIZE: 32,</span>
<a href="#l19.103"></a><span id="l19.103"> </span>
<a href="#l19.104"></a><span id="l19.104">   /**</span>
<a href="#l19.105"></a><span id="l19.105">    * Process pending deletes...</span>
<a href="#l19.106"></a><span id="l19.106">    */</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-  _worker_processDeletes: function gloda_worker_processDeletes(aJob,</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+  _worker_processDeletes: function* gloda_worker_processDeletes(aJob,</span>
<a href="#l19.109"></a><span id="l19.109">       aCallbackHandle) {</span>
<a href="#l19.110"></a><span id="l19.110"> </span>
<a href="#l19.111"></a><span id="l19.111">     // Count the number of messages we will eventually process.  People freak</span>
<a href="#l19.112"></a><span id="l19.112">     //  out when the number is constantly increasing because they think gloda</span>
<a href="#l19.113"></a><span id="l19.113">     //  has gone rogue.  (Note: new deletions can still accumulate during</span>
<a href="#l19.114"></a><span id="l19.114">     //  our execution, so we may 'expand' our count a little still.)</span>
<a href="#l19.115"></a><span id="l19.115">     this._datastore.countDeletedMessages(aCallbackHandle.wrappedCallback);</span>
<a href="#l19.116"></a><span id="l19.116">     aJob.goal = yield this.kWorkAsync;</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineat">@@ -1682,17 +1682,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l19.118"></a><span id="l19.118">       deletedCollection = query.getCollection(aCallbackHandle);</span>
<a href="#l19.119"></a><span id="l19.119">       yield this.kWorkAsync;</span>
<a href="#l19.120"></a><span id="l19.120">     }</span>
<a href="#l19.121"></a><span id="l19.121">     this.pendingDeletions = false;</span>
<a href="#l19.122"></a><span id="l19.122"> </span>
<a href="#l19.123"></a><span id="l19.123">     yield this.kWorkDone;</span>
<a href="#l19.124"></a><span id="l19.124">   },</span>
<a href="#l19.125"></a><span id="l19.125"> </span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-  _worker_fixMissingContacts: function(aJob, aCallbackHandle) {</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+  _worker_fixMissingContacts: function*(aJob, aCallbackHandle) {</span>
<a href="#l19.128"></a><span id="l19.128">     let identityContactInfos = [], fixedContacts = {};</span>
<a href="#l19.129"></a><span id="l19.129"> </span>
<a href="#l19.130"></a><span id="l19.130">     // -- asynchronously get a list of all identities without contacts</span>
<a href="#l19.131"></a><span id="l19.131">     // The upper bound on the number of messed up contacts is the number of</span>
<a href="#l19.132"></a><span id="l19.132">     //  contacts in the user's address book.  This should be small enough</span>
<a href="#l19.133"></a><span id="l19.133">     //  (and the data size small enough) that this won't explode thunderbird.</span>
<a href="#l19.134"></a><span id="l19.134">     let queryStmt = GlodaDatastore._createAsyncStatement(</span>
<a href="#l19.135"></a><span id="l19.135">       &quot;SELECT identities.id, identities.contactID, identities.value &quot; +</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineat">@@ -2958,17 +2958,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l19.137"></a><span id="l19.137">    *</span>
<a href="#l19.138"></a><span id="l19.138">    * Prior to calling this method, the caller must have invoked</span>
<a href="#l19.139"></a><span id="l19.139">    *  |_indexerEnterFolder|, leaving us with the following true invariants</span>
<a href="#l19.140"></a><span id="l19.140">    *  below.</span>
<a href="#l19.141"></a><span id="l19.141">    *</span>
<a href="#l19.142"></a><span id="l19.142">    * @pre aMsgHdr.folder == this._indexingFolder</span>
<a href="#l19.143"></a><span id="l19.143">    * @pre aMsgHdr.folder.msgDatabase == this._indexingDatabase</span>
<a href="#l19.144"></a><span id="l19.144">    */</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-  _indexMessage: function gloda_indexMessage(aMsgHdr, aCallbackHandle) {</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+  _indexMessage: function* gloda_indexMessage(aMsgHdr, aCallbackHandle) {</span>
<a href="#l19.147"></a><span id="l19.147">     let logDebug = this._log.level &lt;= Log4Moz.Level.Debug;</span>
<a href="#l19.148"></a><span id="l19.148">     if (logDebug)</span>
<a href="#l19.149"></a><span id="l19.149">       this._log.debug(&quot;*** Indexing message: &quot; + aMsgHdr.messageKey + &quot; : &quot; +</span>
<a href="#l19.150"></a><span id="l19.150">                       aMsgHdr.subject);</span>
<a href="#l19.151"></a><span id="l19.151"> </span>
<a href="#l19.152"></a><span id="l19.152">     // If the message is offline, then get the message body as well</span>
<a href="#l19.153"></a><span id="l19.153">     let isMsgOffline = false;</span>
<a href="#l19.154"></a><span id="l19.154">     let aMimeMsg;</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineat">@@ -3225,18 +3225,18 @@ var GlodaMsgIndexer = {</span>
<a href="#l19.156"></a><span id="l19.156">    *  collecting up all the attributes that accept a message as their object</span>
<a href="#l19.157"></a><span id="l19.157">    *  type and issuing a delete against that.  For example, delete (*, [1,2,3],</span>
<a href="#l19.158"></a><span id="l19.158">    *  message id).</span>
<a href="#l19.159"></a><span id="l19.159">    * (We are punting because we haven't implemented support for generating</span>
<a href="#l19.160"></a><span id="l19.160">    *  attributes like that yet.)</span>
<a href="#l19.161"></a><span id="l19.161">    *</span>
<a href="#l19.162"></a><span id="l19.162">    * @TODO: implement deletion of attributes that reference (deleted) messages</span>
<a href="#l19.163"></a><span id="l19.163">    */</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-  _deleteMessage: function gloda_index_deleteMessage(aMessage,</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-                                                     aCallbackHandle) {</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+  _deleteMessage: function* gloda_index_deleteMessage(aMessage,</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+                                                      aCallbackHandle) {</span>
<a href="#l19.168"></a><span id="l19.168">     let logDebug = this._log.level &lt;= Log4Moz.Level.Debug;</span>
<a href="#l19.169"></a><span id="l19.169">     if (logDebug)</span>
<a href="#l19.170"></a><span id="l19.170">       this._log.debug(&quot;*** Deleting message: &quot; + aMessage);</span>
<a href="#l19.171"></a><span id="l19.171"> </span>
<a href="#l19.172"></a><span id="l19.172">     // -- delete our attributes</span>
<a href="#l19.173"></a><span id="l19.173">     // delete the message's attributes (if we implement the cascade delete, that</span>
<a href="#l19.174"></a><span id="l19.174">     //  could do the honors for us... right now we define the trigger in our</span>
<a href="#l19.175"></a><span id="l19.175">     //  schema but the back-end ignores it)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -812,17 +812,17 @@ var GlodaIndexer = {</span>
<a href="#l20.4"></a><span id="l20.4">         args = this._savedCallbackArgs;</span>
<a href="#l20.5"></a><span id="l20.5">         this._savedCallbackArgs = null;</span>
<a href="#l20.6"></a><span id="l20.6">       }</span>
<a href="#l20.7"></a><span id="l20.7">       else</span>
<a href="#l20.8"></a><span id="l20.8">         args = arguments; //Array.slice.call(arguments);</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10">       let result;</span>
<a href="#l20.11"></a><span id="l20.11">       if (args.length == 0)</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-        result = this._batch.next();</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+        result = this._batch.next().value;</span>
<a href="#l20.14"></a><span id="l20.14">       else if (args.length == 1)</span>
<a href="#l20.15"></a><span id="l20.15">         result = this._batch.send(args[0]);</span>
<a href="#l20.16"></a><span id="l20.16">       else // arguments works with destructuring assignment</span>
<a href="#l20.17"></a><span id="l20.17">         result = this._batch.send(args);</span>
<a href="#l20.18"></a><span id="l20.18">       switch (result) {</span>
<a href="#l20.19"></a><span id="l20.19">         // job's done, close the batch and re-schedule ourselves if there's more</span>
<a href="#l20.20"></a><span id="l20.20">         //  to do.</span>
<a href="#l20.21"></a><span id="l20.21">         case this.kWorkDone:</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -958,17 +958,17 @@ var GlodaIndexer = {</span>
<a href="#l20.23"></a><span id="l20.23">    *  the database transaction and keeping track of &quot;tokens&quot;.  It drives the</span>
<a href="#l20.24"></a><span id="l20.24">    *  activeIterator generator which is doing the work.</span>
<a href="#l20.25"></a><span id="l20.25">    * workBatch will only produce kWorkAsync, kWorkPause, and kWorkDone</span>
<a href="#l20.26"></a><span id="l20.26">    *  notifications.  If activeIterator returns kWorkSync and there are still</span>
<a href="#l20.27"></a><span id="l20.27">    *  tokens available, workBatch will keep driving the activeIterator until it</span>
<a href="#l20.28"></a><span id="l20.28">    *  encounters a kWorkAsync (which workBatch will yield to callbackDriver), or</span>
<a href="#l20.29"></a><span id="l20.29">    *  it runs out of tokens and yields a kWorkPause or kWorkDone.</span>
<a href="#l20.30"></a><span id="l20.30">    */</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  workBatch: function gloda_index_workBatch() {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+  workBatch: function* gloda_index_workBatch() {</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34">     // Do we still have an open transaction? If not, start a new one.</span>
<a href="#l20.35"></a><span id="l20.35">     if (!this._idleToCommit)</span>
<a href="#l20.36"></a><span id="l20.36">       GlodaDatastore._beginTransaction();</span>
<a href="#l20.37"></a><span id="l20.37">     else</span>
<a href="#l20.38"></a><span id="l20.38">       // We'll manage commit ourself while this routine is active.</span>
<a href="#l20.39"></a><span id="l20.39">       this._idleToCommit = false;</span>
<a href="#l20.40"></a><span id="l20.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/resources/asyncCallbackHandler.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -17,19 +17,19 @@ var asyncCallbackHandle = {</span>
<a href="#l21.4"></a><span id="l21.4">   pushAndGo: function asyncCallbackHandle_push(aIterator, aContext) {</span>
<a href="#l21.5"></a><span id="l21.5">     asyncGeneratorStack.push([</span>
<a href="#l21.6"></a><span id="l21.6">       _asyncCallbackHandle_glodaWorkerAdapter(aIterator),</span>
<a href="#l21.7"></a><span id="l21.7">       &quot;callbackHandler pushAndGo&quot;]);</span>
<a href="#l21.8"></a><span id="l21.8">     return async_driver();</span>
<a href="#l21.9"></a><span id="l21.9">   }</span>
<a href="#l21.10"></a><span id="l21.10"> };</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-function _asyncCallbackHandle_glodaWorkerAdapter(aIter) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+function* _asyncCallbackHandle_glodaWorkerAdapter(aIter) {</span>
<a href="#l21.14"></a><span id="l21.14">   while(true) {</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-    switch(aIter.next()) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+    switch(aIter.next().value) {</span>
<a href="#l21.17"></a><span id="l21.17">       case GlodaIndexer.kWorkSync:</span>
<a href="#l21.18"></a><span id="l21.18">         yield true;</span>
<a href="#l21.19"></a><span id="l21.19">         break;</span>
<a href="#l21.20"></a><span id="l21.20">       case GlodaIndexer.kWorkDone:</span>
<a href="#l21.21"></a><span id="l21.21">       case GlodaIndexer.kWorkDoneWithResult:</span>
<a href="#l21.22"></a><span id="l21.22">         return;</span>
<a href="#l21.23"></a><span id="l21.23">       default:</span>
<a href="#l21.24"></a><span id="l21.24">         yield false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -231,17 +231,17 @@ var FeedUtils = {</span>
<a href="#l22.4"></a><span id="l22.4">       // Add the base folder; it does not get returned by ListDescendants. Do not</span>
<a href="#l22.5"></a><span id="l22.5">       // add the account folder as it doesn't have the feedUrl property or even</span>
<a href="#l22.6"></a><span id="l22.6">       // a msgDatabase necessarily.</span>
<a href="#l22.7"></a><span id="l22.7">       allFolders.appendElement(aFolder, false);</span>
<a href="#l22.8"></a><span id="l22.8">     }</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10">     aFolder.ListDescendants(allFolders);</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    function feeder() {</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+    function* feeder() {</span>
<a href="#l22.14"></a><span id="l22.14">       let folder;</span>
<a href="#l22.15"></a><span id="l22.15">       let numFolders = allFolders.length;</span>
<a href="#l22.16"></a><span id="l22.16">       for (let i = 0; i &lt; numFolders; i++) {</span>
<a href="#l22.17"></a><span id="l22.17">         folder = allFolders.queryElementAt(i, Ci.nsIMsgFolder);</span>
<a href="#l22.18"></a><span id="l22.18">         FeedUtils.log.debug(&quot;downloadFeed: START x/# foldername:uri - &quot; +</span>
<a href="#l22.19"></a><span id="l22.19">                             (i+1) + &quot;/&quot; + numFolders + &quot; &quot; +</span>
<a href="#l22.20"></a><span id="l22.20">                             folder.name + &quot;:&quot; + folder.URI);</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -273,58 +273,50 @@ var FeedUtils = {</span>
<a href="#l22.23"></a><span id="l22.23">           feed.folder = folder;</span>
<a href="#l22.24"></a><span id="l22.24">           // Bump our pending feed download count.</span>
<a href="#l22.25"></a><span id="l22.25">           FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l22.26"></a><span id="l22.26">           feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l22.27"></a><span id="l22.27">           FeedUtils.log.debug(&quot;downloadFeed: DOWNLOAD feed url - &quot; + url);</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29">           Services.tm.mainThread.dispatch(function() {</span>
<a href="#l22.30"></a><span id="l22.30">             try {</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-              getFeed.next();</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-            }</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-            catch (ex) {</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-              if (ex instanceof StopIteration)</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-              {</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+              let done = getFeed.next().done;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+              if (done) {</span>
<a href="#l22.38"></a><span id="l22.38">                 // Finished with all feeds in base folder and its subfolders.</span>
<a href="#l22.39"></a><span id="l22.39">                 FeedUtils.log.debug(&quot;downloadFeed: Finished with folder - &quot; +</span>
<a href="#l22.40"></a><span id="l22.40">                                     aFolder.name);</span>
<a href="#l22.41"></a><span id="l22.41">                 folder = null;</span>
<a href="#l22.42"></a><span id="l22.42">                 allFolders = null;</span>
<a href="#l22.43"></a><span id="l22.43">               }</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-              else</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-              {</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-                FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-                FeedUtils.progressNotifier.downloaded({name: folder.name}, 0);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-              }</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+            }</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+            catch (ex) {</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+              FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+              FeedUtils.progressNotifier.downloaded({name: folder.name}, 0);</span>
<a href="#l22.53"></a><span id="l22.53">             }</span>
<a href="#l22.54"></a><span id="l22.54">           }, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">           yield undefined;</span>
<a href="#l22.57"></a><span id="l22.57">         }</span>
<a href="#l22.58"></a><span id="l22.58">       }</span>
<a href="#l22.59"></a><span id="l22.59">     }</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61">     let getFeed = feeder();</span>
<a href="#l22.62"></a><span id="l22.62">     try {</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-      getFeed.next();</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-    }</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-    catch (ex) {</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-      if (ex instanceof StopIteration)</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-      {</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+      let done = getFeed.next().done;</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+      if (done) {</span>
<a href="#l22.70"></a><span id="l22.70">         // Nothing to do.</span>
<a href="#l22.71"></a><span id="l22.71">         FeedUtils.log.debug(&quot;downloadFeed: Nothing to do in folder - &quot; +</span>
<a href="#l22.72"></a><span id="l22.72">                             aFolder.name);</span>
<a href="#l22.73"></a><span id="l22.73">         folder = null;</span>
<a href="#l22.74"></a><span id="l22.74">         allFolders = null;</span>
<a href="#l22.75"></a><span id="l22.75">       }</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-      else</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-      {</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-        FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-        FeedUtils.progressNotifier.downloaded({name: aFolder.name}, 0);</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-      }</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+    }</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+    catch (ex) {</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+      FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+      FeedUtils.progressNotifier.downloaded({name: aFolder.name}, 0);</span>
<a href="#l22.85"></a><span id="l22.85">     }</span>
<a href="#l22.86"></a><span id="l22.86">   },</span>
<a href="#l22.87"></a><span id="l22.87"> </span>
<a href="#l22.88"></a><span id="l22.88"> /**</span>
<a href="#l22.89"></a><span id="l22.89">  * Subscribe a new feed url.</span>
<a href="#l22.90"></a><span id="l22.90">  *</span>
<a href="#l22.91"></a><span id="l22.91">  * @param   string aUrl              - feed url</span>
<a href="#l22.92"></a><span id="l22.92">  * @param   nsIMsgFolder aFolder     - folder</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/test/resources/asyncTestUtils.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/test/resources/asyncTestUtils.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -249,17 +249,17 @@ function async_run_tests(aTests, aLonges</span>
<a href="#l23.4"></a><span id="l23.4">   do_timeout(aLongestTestRunTimeConceivableInSecs * 1000,</span>
<a href="#l23.5"></a><span id="l23.5">       _async_test_runner_timeout);</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7">   do_test_pending();</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">   async_run({func: _async_test_runner, args: [aTests]});</span>
<a href="#l23.10"></a><span id="l23.10"> }</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-function _async_test_runner(aTests) {</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+function* _async_test_runner(aTests) {</span>
<a href="#l23.14"></a><span id="l23.14">   for (let test of aTests) {</span>
<a href="#l23.15"></a><span id="l23.15">     // parameterized?</span>
<a href="#l23.16"></a><span id="l23.16">     if (test.length) {</span>
<a href="#l23.17"></a><span id="l23.17">       let [testFunc, parameters] = test;</span>
<a href="#l23.18"></a><span id="l23.18">       for (let parameter of parameters) {</span>
<a href="#l23.19"></a><span id="l23.19">         let paramDesc, args;</span>
<a href="#l23.20"></a><span id="l23.20">         if (typeof(parameter) == &quot;object&quot;) {</span>
<a href="#l23.21"></a><span id="l23.21">           if (parameter.length) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/test/resources/messageInjection.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/test/resources/messageInjection.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -564,17 +564,17 @@ function make_new_sets_in_folders(aMsgFo</span>
<a href="#l24.4"></a><span id="l24.4"> /** singular folder alias for single-folder users' readability */</span>
<a href="#l24.5"></a><span id="l24.5"> var make_new_sets_in_folder = make_new_sets_in_folders;</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> /**</span>
<a href="#l24.8"></a><span id="l24.8">  * An iterator that generates an infinite sequence of its argument.  So</span>
<a href="#l24.9"></a><span id="l24.9">  *  _looperator(1, 2, 3) will generate the iteration stream: [1, 2, 3, 1, 2, 3,</span>
<a href="#l24.10"></a><span id="l24.10">  *  1, 2, 3, ...].  For use by add_sets_across_folders.</span>
<a href="#l24.11"></a><span id="l24.11">  */</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-function _looperator(aList) {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+function* _looperator(aList) {</span>
<a href="#l24.14"></a><span id="l24.14">   if (aList.length == 0)</span>
<a href="#l24.15"></a><span id="l24.15">     throw Exception(&quot;aList must have at least one item!&quot;);</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17">   let i = 0, length = aList.length;</span>
<a href="#l24.18"></a><span id="l24.18">   while (true) {</span>
<a href="#l24.19"></a><span id="l24.19">     yield aList[i];</span>
<a href="#l24.20"></a><span id="l24.20">     i = (i + 1) % length;</span>
<a href="#l24.21"></a><span id="l24.21">   }</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -654,41 +654,41 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l24.23"></a><span id="l24.23">   }</span>
<a href="#l24.24"></a><span id="l24.24"> </span>
<a href="#l24.25"></a><span id="l24.25">   if (mis.injectionConfig.mode == &quot;local&quot;) {</span>
<a href="#l24.26"></a><span id="l24.26">     // Note: in order to cut down on excessive fsync()s, we do a two-pass</span>
<a href="#l24.27"></a><span id="l24.27">     //  approach.  In the first pass we just allocate messages to the folder</span>
<a href="#l24.28"></a><span id="l24.28">     //  we are going to insert them into.  In the second pass we insert the</span>
<a href="#l24.29"></a><span id="l24.29">     //  messages into folders in batches and perform any mutations.</span>
<a href="#l24.30"></a><span id="l24.30">     let folderBatches = aMsgFolders.map(folder =&gt;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-                         new Object({folder: folder, messages: []}));</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-    iterFolders = _looperator(folderBatches);</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-    let iPerSet = 0, folderBatch = iterFolders.next();</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+                                        new Object({folder: folder, messages: []}));</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+    iterFolders = _looperator([...folderBatches.keys()]);</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+    let iPerSet = 0, folderNext = iterFolders.next();</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38">     // - allocate messages to folders</span>
<a href="#l24.39"></a><span id="l24.39">     // loop, incrementing our subscript until all message sets are out of messages</span>
<a href="#l24.40"></a><span id="l24.40">     let didSomething;</span>
<a href="#l24.41"></a><span id="l24.41">     do {</span>
<a href="#l24.42"></a><span id="l24.42">       didSomething = false;</span>
<a href="#l24.43"></a><span id="l24.43">       // for each message set, if it is not out of messages, add the message</span>
<a href="#l24.44"></a><span id="l24.44">       for (let messageSet of aMessageSets) {</span>
<a href="#l24.45"></a><span id="l24.45">         if (iPerSet &lt; messageSet.synMessages.length) {</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-          let synMsg = messageSet._trackMessageAddition(folderBatch.folder,</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+          let synMsg = messageSet._trackMessageAddition(folderBatches[folderNext.value].folder,</span>
<a href="#l24.48"></a><span id="l24.48">                                                         iPerSet);</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-          folderBatch.messages.push({ messageSet: messageSet, synMsg: synMsg,</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-                                      index: iPerSet });</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+          folderBatches[folderNext.value].messages.push({ messageSet: messageSet, synMsg: synMsg,</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+                                    index: iPerSet });</span>
<a href="#l24.53"></a><span id="l24.53">           didSomething = true;</span>
<a href="#l24.54"></a><span id="l24.54">         }</span>
<a href="#l24.55"></a><span id="l24.55">       }</span>
<a href="#l24.56"></a><span id="l24.56">       iPerSet++;</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-      folderBatch = iterFolders.next();</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+      folderNext = iterFolders.next();</span>
<a href="#l24.59"></a><span id="l24.59">     } while (didSomething);</span>
<a href="#l24.60"></a><span id="l24.60"> </span>
<a href="#l24.61"></a><span id="l24.61">     // - inject messages</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-    for (folderBatch of folderBatches) {</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+    for (let folderBatch of folderBatches) {</span>
<a href="#l24.64"></a><span id="l24.64">       // it is conceivable some folders might not get any messages, skip them.</span>
<a href="#l24.65"></a><span id="l24.65">       if (!folderBatch.messages.length)</span>
<a href="#l24.66"></a><span id="l24.66">         continue;</span>
<a href="#l24.67"></a><span id="l24.67"> </span>
<a href="#l24.68"></a><span id="l24.68">       let folder = folderBatch.folder;</span>
<a href="#l24.69"></a><span id="l24.69">       folder.gettingNewMessages = true;</span>
<a href="#l24.70"></a><span id="l24.70">       let messageStrings = folderBatch.messages.map(message =&gt;</span>
<a href="#l24.71"></a><span id="l24.71">                              message.synMsg.toMboxString());</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineat">@@ -729,29 +729,29 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l24.73"></a><span id="l24.73">     for (let folder of aMsgFolders) {</span>
<a href="#l24.74"></a><span id="l24.74">       folder.callFilterPlugins(null);</span>
<a href="#l24.75"></a><span id="l24.75">     }</span>
<a href="#l24.76"></a><span id="l24.76">   }</span>
<a href="#l24.77"></a><span id="l24.77">   else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l24.78"></a><span id="l24.78">     iterFolders = _looperator(aMsgFolders);</span>
<a href="#l24.79"></a><span id="l24.79">     // we need to call updateFolder on all the folders, not just the first</span>
<a href="#l24.80"></a><span id="l24.80">     //  one...</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-    return async_run({func: function() {</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+    return async_run({func: function*() {</span>
<a href="#l24.83"></a><span id="l24.83">       yield wait_for_async_promises();</span>
<a href="#l24.84"></a><span id="l24.84"> </span>
<a href="#l24.85"></a><span id="l24.85">       let iPerSet = 0, folder = iterFolders.next();</span>
<a href="#l24.86"></a><span id="l24.86">       let didSomething;</span>
<a href="#l24.87"></a><span id="l24.87">       do {</span>
<a href="#l24.88"></a><span id="l24.88">         didSomething = false;</span>
<a href="#l24.89"></a><span id="l24.89">         for (let messageSet of aMessageSets) {</span>
<a href="#l24.90"></a><span id="l24.90">           if (iPerSet &lt; messageSet.synMessages.length) {</span>
<a href="#l24.91"></a><span id="l24.91">             didSomething = true;</span>
<a href="#l24.92"></a><span id="l24.92"> </span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-            let realFolder = mis.handleUriToRealFolder[folder];</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-            let fakeFolder = mis.handleUriToFakeFolder[folder];</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+            let realFolder = mis.handleUriToRealFolder[folder.value];</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+            let fakeFolder = mis.handleUriToFakeFolder[folder.value];</span>
<a href="#l24.97"></a><span id="l24.97">             let synMsg = messageSet._trackMessageAddition(realFolder, iPerSet);</span>
<a href="#l24.98"></a><span id="l24.98">             let msgURI =</span>
<a href="#l24.99"></a><span id="l24.99">               Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l24.100"></a><span id="l24.100">                                  btoa(synMsg.toMessageString()),</span>
<a href="#l24.101"></a><span id="l24.101">                                  null, null);</span>
<a href="#l24.102"></a><span id="l24.102">             let imapMsg = new imapMessage(msgURI.spec, fakeFolder.uidnext++, []);</span>
<a href="#l24.103"></a><span id="l24.103">             // If the message's meta-state indicates it is junk, set that flag.</span>
<a href="#l24.104"></a><span id="l24.104">             // There is also a NotJunk flag, but we're not playing with that</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineat">@@ -795,17 +795,17 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l24.106"></a><span id="l24.106">     let iPerSet = 0, folder = iterFolders.next();</span>
<a href="#l24.107"></a><span id="l24.107">     // loop, incrementing our subscript until all message sets are out of messages</span>
<a href="#l24.108"></a><span id="l24.108">     let didSomething;</span>
<a href="#l24.109"></a><span id="l24.109">     do {</span>
<a href="#l24.110"></a><span id="l24.110">       didSomething = false;</span>
<a href="#l24.111"></a><span id="l24.111">       // for each message set, if it is not out of messages, add the message</span>
<a href="#l24.112"></a><span id="l24.112">       for (let messageSet of aMessageSets) {</span>
<a href="#l24.113"></a><span id="l24.113">         if (iPerSet &lt; messageSet.synMessages.length) {</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-          popMessages.push(messageSet._trackMessageAddition(folder, iPerSet));</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+          popMessages.push(messageSet._trackMessageAddition(folder.value, iPerSet));</span>
<a href="#l24.116"></a><span id="l24.116">           didSomething = true;</span>
<a href="#l24.117"></a><span id="l24.117">         }</span>
<a href="#l24.118"></a><span id="l24.118">       }</span>
<a href="#l24.119"></a><span id="l24.119">       iPerSet++;</span>
<a href="#l24.120"></a><span id="l24.120">       folder = iterFolders.next();</span>
<a href="#l24.121"></a><span id="l24.121">     } while (didSomething);</span>
<a href="#l24.122"></a><span id="l24.122"> </span>
<a href="#l24.123"></a><span id="l24.123">     ims.daemon.setMessages(_synthMessagesToFakeRep(popMessages));</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineat">@@ -862,24 +862,24 @@ function wait_for_message_injection() {</span>
<a href="#l24.125"></a><span id="l24.125">  * @param aDestFolder The target folder.</span>
<a href="#l24.126"></a><span id="l24.126">  * @param [aAllowUndo=false] Should we generate undo operations and, as a</span>
<a href="#l24.127"></a><span id="l24.127">  *     side-effect, offline operations?  (The code uses undo operations as</span>
<a href="#l24.128"></a><span id="l24.128">  *     a proxy-indicator for it coming from the UI and therefore performing</span>
<a href="#l24.129"></a><span id="l24.129">  *     pseudo-offline operations instead of trying to do things online.)</span>
<a href="#l24.130"></a><span id="l24.130">  */</span>
<a href="#l24.131"></a><span id="l24.131"> function async_move_messages(aSynMessageSet, aDestFolder, aAllowUndo) {</span>
<a href="#l24.132"></a><span id="l24.132">   mark_action(&quot;messageInjection&quot;, &quot;moving messages&quot;, aSynMessageSet.msgHdrList);</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-  return async_run({func: function () {</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+  return async_run({func: function*() {</span>
<a href="#l24.135"></a><span id="l24.135">       // we need to make sure all folder promises are fulfilled</span>
<a href="#l24.136"></a><span id="l24.136">       yield wait_for_async_promises();</span>
<a href="#l24.137"></a><span id="l24.137">       // and then we can make sure we have the actual folder</span>
<a href="#l24.138"></a><span id="l24.138">       let realDestFolder = get_real_injection_folder(aDestFolder);</span>
<a href="#l24.139"></a><span id="l24.139"> </span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-      for (let [folder, xpcomHdrArray] in</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-           aSynMessageSet.foldersWithXpcomHdrArrays) {</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+      for (let [folder, xpcomHdrArray] of</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+           aSynMessageSet.foldersWithXpcomHdrArrays()) {</span>
<a href="#l24.144"></a><span id="l24.144">         mark_action(&quot;messageInjection&quot;,</span>
<a href="#l24.145"></a><span id="l24.145">                     &quot;moving messages&quot;,</span>
<a href="#l24.146"></a><span id="l24.146">                     [&quot;from&quot;, folder, &quot;to&quot;, realDestFolder]);</span>
<a href="#l24.147"></a><span id="l24.147"> </span>
<a href="#l24.148"></a><span id="l24.148">         // In the IMAP case tell listeners we are moving messages without</span>
<a href="#l24.149"></a><span id="l24.149">         //  destination headers.</span>
<a href="#l24.150"></a><span id="l24.150">         if (!message_injection_is_local())</span>
<a href="#l24.151"></a><span id="l24.151">           _messageInjectionSetup.notifyListeners(</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineat">@@ -928,19 +928,19 @@ function async_move_messages(aSynMessage</span>
<a href="#l24.153"></a><span id="l24.153">  *</span>
<a href="#l24.154"></a><span id="l24.154">  * @param aSynMessageSet The set of messages to trash.  The messages do not all</span>
<a href="#l24.155"></a><span id="l24.155">  *     have to be in the same folder, but we have to trash them folder by</span>
<a href="#l24.156"></a><span id="l24.156">  *     folder if they are not.</span>
<a href="#l24.157"></a><span id="l24.157">  */</span>
<a href="#l24.158"></a><span id="l24.158"> function async_trash_messages(aSynMessageSet) {</span>
<a href="#l24.159"></a><span id="l24.159">   mark_action(&quot;messageInjection&quot;, &quot;trashing messages&quot;,</span>
<a href="#l24.160"></a><span id="l24.160">               aSynMessageSet.msgHdrList);</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-  return async_run({func: function () {</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-      for (let [folder, xpcomHdrArray] in</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-           aSynMessageSet.foldersWithXpcomHdrArrays) {</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+  return async_run({func: function*() {</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+      for (let [folder, xpcomHdrArray] of</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineplus">+           aSynMessageSet.foldersWithXpcomHdrArrays()) {</span>
<a href="#l24.167"></a><span id="l24.167">         mark_action(&quot;messageInjection&quot;, &quot;trashing messages in folder&quot;,</span>
<a href="#l24.168"></a><span id="l24.168">                     [folder]);</span>
<a href="#l24.169"></a><span id="l24.169">         // In the IMAP case tell listeners we are moving messages without</span>
<a href="#l24.170"></a><span id="l24.170">         //  destination headers, since that's what trashing amounts to.</span>
<a href="#l24.171"></a><span id="l24.171">         if (!message_injection_is_local())</span>
<a href="#l24.172"></a><span id="l24.172">           _messageInjectionSetup.notifyListeners(</span>
<a href="#l24.173"></a><span id="l24.173">             &quot;onMovingMessagesWithoutDestHeaders&quot;, []);</span>
<a href="#l24.174"></a><span id="l24.174">         folder.deleteMessages(xpcomHdrArray, null, false, true,</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineat">@@ -989,34 +989,34 @@ function async_trash_messages(aSynMessag</span>
<a href="#l24.176"></a><span id="l24.176">  *</span>
<a href="#l24.177"></a><span id="l24.177">  * @param aSynMessageSet The set of messages to delete.  The messages do not all</span>
<a href="#l24.178"></a><span id="l24.178">  *     have to be in the same folder, but we have to delete them folder by</span>
<a href="#l24.179"></a><span id="l24.179">  *     folder if they are not.</span>
<a href="#l24.180"></a><span id="l24.180">  */</span>
<a href="#l24.181"></a><span id="l24.181"> function async_delete_messages(aSynMessageSet) {</span>
<a href="#l24.182"></a><span id="l24.182">   mark_action(&quot;messageInjection&quot;, &quot;deleting messages&quot;,</span>
<a href="#l24.183"></a><span id="l24.183">               aSynMessageSet.msgHdrList);</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineminus">-  for (let [folder, xpcomHdrArray] in</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-       aSynMessageSet.foldersWithXpcomHdrArrays) {</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+  for (let [folder, xpcomHdrArray] of</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineplus">+       aSynMessageSet.foldersWithXpcomHdrArrays()) {</span>
<a href="#l24.188"></a><span id="l24.188">     mark_action(&quot;messageInjection&quot;, &quot;deleting messages in folder&quot;,</span>
<a href="#l24.189"></a><span id="l24.189">                 [folder]);</span>
<a href="#l24.190"></a><span id="l24.190">     folder.deleteMessages(xpcomHdrArray, null,</span>
<a href="#l24.191"></a><span id="l24.191">                           /* delete storage */ true,</span>
<a href="#l24.192"></a><span id="l24.192">                           /* is move? */ false,</span>
<a href="#l24.193"></a><span id="l24.193">                           asyncCopyListener,</span>
<a href="#l24.194"></a><span id="l24.194">                           /* do not allow undo, currently leaks */ false);</span>
<a href="#l24.195"></a><span id="l24.195">   }</span>
<a href="#l24.196"></a><span id="l24.196">   return true;</span>
<a href="#l24.197"></a><span id="l24.197"> }</span>
<a href="#l24.198"></a><span id="l24.198"> </span>
<a href="#l24.199"></a><span id="l24.199"> /**</span>
<a href="#l24.200"></a><span id="l24.200">  * Empty the trash.</span>
<a href="#l24.201"></a><span id="l24.201">  */</span>
<a href="#l24.202"></a><span id="l24.202"> function async_empty_trash() {</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineminus">-  return async_run({func: function() {</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineplus">+  return async_run({func: function*() {</span>
<a href="#l24.205"></a><span id="l24.205">     let trashHandle = get_trash_folder();</span>
<a href="#l24.206"></a><span id="l24.206">     yield wait_for_async_promises();</span>
<a href="#l24.207"></a><span id="l24.207">     let trashFolder = get_real_injection_folder(trashHandle);</span>
<a href="#l24.208"></a><span id="l24.208">     trashFolder.emptyTrash(null, asyncUrlListener);</span>
<a href="#l24.209"></a><span id="l24.209">     yield false;</span>
<a href="#l24.210"></a><span id="l24.210">   }});</span>
<a href="#l24.211"></a><span id="l24.211"> }</span>
<a href="#l24.212"></a><span id="l24.212"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/test/resources/messageModifier.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/test/resources/messageModifier.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -119,38 +119,38 @@ SyntheticMessageSet.prototype = {</span>
<a href="#l25.4"></a><span id="l25.4">     let msgHdr = this.getMsgHdr(aIndex);</span>
<a href="#l25.5"></a><span id="l25.5">     return msgHdr.folder.getUriForMsg(msgHdr);</span>
<a href="#l25.6"></a><span id="l25.6">   },</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   /**</span>
<a href="#l25.9"></a><span id="l25.9">    * @return a JS iterator of the message headers for all messages inserted into</span>
<a href="#l25.10"></a><span id="l25.10">    *     a folder.</span>
<a href="#l25.11"></a><span id="l25.11">    */</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  get msgHdrs() {</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  msgHdrs: function*() {</span>
<a href="#l25.14"></a><span id="l25.14">     // get the databases</span>
<a href="#l25.15"></a><span id="l25.15">     let msgDatabases = this.msgFolders.map(folder =&gt; folder.msgDatabase);</span>
<a href="#l25.16"></a><span id="l25.16">     for (let [iMsg, synMsg] in Iterator(this.synMessages)) {</span>
<a href="#l25.17"></a><span id="l25.17">       let folderIndex = this.folderIndices[iMsg];</span>
<a href="#l25.18"></a><span id="l25.18">       if (folderIndex != null)</span>
<a href="#l25.19"></a><span id="l25.19">         yield msgDatabases[folderIndex].getMsgHdrForMessageID(synMsg.messageId);</span>
<a href="#l25.20"></a><span id="l25.20">     }</span>
<a href="#l25.21"></a><span id="l25.21">   },</span>
<a href="#l25.22"></a><span id="l25.22">   /**</span>
<a href="#l25.23"></a><span id="l25.23">    * @return a JS list of the message headers for all messages inserted into a</span>
<a href="#l25.24"></a><span id="l25.24">    *     folder.</span>
<a href="#l25.25"></a><span id="l25.25">    */</span>
<a href="#l25.26"></a><span id="l25.26">   get msgHdrList() {</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-    return Array.from(this.msgHdrs);</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+    return Array.from(this.msgHdrs());</span>
<a href="#l25.29"></a><span id="l25.29">   },</span>
<a href="#l25.30"></a><span id="l25.30">   /**</span>
<a href="#l25.31"></a><span id="l25.31">    * @return an nsIMutableArray of the message headers for all messages inserted</span>
<a href="#l25.32"></a><span id="l25.32">    *     into a folder.</span>
<a href="#l25.33"></a><span id="l25.33">    */</span>
<a href="#l25.34"></a><span id="l25.34">   get xpcomHdrArray() {</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-    return toXPCOMArray(this.msgHdrs,</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+    return toXPCOMArray(this.msgHdrs(),</span>
<a href="#l25.37"></a><span id="l25.37">                         Components.interfaces.nsIMutableArray);</span>
<a href="#l25.38"></a><span id="l25.38">   },</span>
<a href="#l25.39"></a><span id="l25.39">   /**</span>
<a href="#l25.40"></a><span id="l25.40">    * @return a list where each item is a list with two elements; the first is</span>
<a href="#l25.41"></a><span id="l25.41">    *     an nsIMsgFolder, and the second is a list of all of the nsIMsgDBHdrs</span>
<a href="#l25.42"></a><span id="l25.42">    *     for the synthetic messages in the set inserted into that folder.</span>
<a href="#l25.43"></a><span id="l25.43">    */</span>
<a href="#l25.44"></a><span id="l25.44">   get foldersWithMsgHdrs() {</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineat">@@ -163,18 +163,18 @@ SyntheticMessageSet.prototype = {</span>
<a href="#l25.46"></a><span id="l25.46">       }</span>
<a href="#l25.47"></a><span id="l25.47">     }</span>
<a href="#l25.48"></a><span id="l25.48">     return results;</span>
<a href="#l25.49"></a><span id="l25.49">   },</span>
<a href="#l25.50"></a><span id="l25.50">   /**</span>
<a href="#l25.51"></a><span id="l25.51">    * @return a generator that yields [nsIMsgFolder, nsIMutableArray of the</span>
<a href="#l25.52"></a><span id="l25.52">    *     messages from the set in that folder].</span>
<a href="#l25.53"></a><span id="l25.53">    */</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-  get foldersWithXpcomHdrArrays() {</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-    for (let [, [folder, msgHdrs]] in Iterator(this.foldersWithMsgHdrs)) {</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+  foldersWithXpcomHdrArrays: function*() {</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+    for (let [folder, msgHdrs] of this.foldersWithMsgHdrs) {</span>
<a href="#l25.58"></a><span id="l25.58">       yield [folder, toXPCOMArray(msgHdrs,</span>
<a href="#l25.59"></a><span id="l25.59">                                   Components.interfaces.nsIMutableArray)];</span>
<a href="#l25.60"></a><span id="l25.60">     }</span>
<a href="#l25.61"></a><span id="l25.61">   },</span>
<a href="#l25.62"></a><span id="l25.62">   /**</span>
<a href="#l25.63"></a><span id="l25.63">    * Sets the status of the messages to read/unread.</span>
<a href="#l25.64"></a><span id="l25.64">    *</span>
<a href="#l25.65"></a><span id="l25.65">    * @param aRead    true/false to set messages as read/unread</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineat">@@ -183,27 +183,27 @@ SyntheticMessageSet.prototype = {</span>
<a href="#l25.67"></a><span id="l25.67">    */</span>
<a href="#l25.68"></a><span id="l25.68">   setRead: function(aRead, aMsgHdr) {</span>
<a href="#l25.69"></a><span id="l25.69">     let msgHdrs = aMsgHdr ? [aMsgHdr] : this.msgHdrList;</span>
<a href="#l25.70"></a><span id="l25.70">     for (let msgHdr of msgHdrs) {</span>
<a href="#l25.71"></a><span id="l25.71">       msgHdr.markRead(aRead);</span>
<a href="#l25.72"></a><span id="l25.72">     }</span>
<a href="#l25.73"></a><span id="l25.73">   },</span>
<a href="#l25.74"></a><span id="l25.74">   setStarred: function(aStarred) {</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-    for (let msgHdr of this.msgHdrs) {</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+    for (let msgHdr of this.msgHdrs()) {</span>
<a href="#l25.77"></a><span id="l25.77">       msgHdr.markFlagged(aStarred);</span>
<a href="#l25.78"></a><span id="l25.78">     }</span>
<a href="#l25.79"></a><span id="l25.79">   },</span>
<a href="#l25.80"></a><span id="l25.80">   addTag: function(aTagName) {</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-    for (let [folder, xpcomHdrArray] in this.foldersWithXpcomHdrArrays) {</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+    for (let [folder, xpcomHdrArray] of this.foldersWithXpcomHdrArrays()) {</span>
<a href="#l25.83"></a><span id="l25.83">       folder.addKeywordsToMessages(xpcomHdrArray, aTagName);</span>
<a href="#l25.84"></a><span id="l25.84">     }</span>
<a href="#l25.85"></a><span id="l25.85">   },</span>
<a href="#l25.86"></a><span id="l25.86">   removeTag: function(aTagName) {</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-    for (let [folder, xpcomHdrArray] in this.foldersWithXpcomHdrArrays) {</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+    for (let [folder, xpcomHdrArray] of this.foldersWithXpcomHdrArrays()) {</span>
<a href="#l25.89"></a><span id="l25.89">       folder.removeKeywordsFromMessages(xpcomHdrArray, aTagName);</span>
<a href="#l25.90"></a><span id="l25.90">     }</span>
<a href="#l25.91"></a><span id="l25.91">   },</span>
<a href="#l25.92"></a><span id="l25.92">   /**</span>
<a href="#l25.93"></a><span id="l25.93">    * Sets the junk score for the messages to junk/non-junk.  It does not</span>
<a href="#l25.94"></a><span id="l25.94">    *  involve the bayesian classifier because we really don't want it</span>
<a href="#l25.95"></a><span id="l25.95">    *  affecting our unit tests!  (Unless we were testing the bayesian</span>
<a href="#l25.96"></a><span id="l25.96">    *  classifier.  Which I'm conveniently not.  Feel free to add a</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

