<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 310:77d59259d30251b0d6021348fec6a7607b1f2471</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 77d59259d30251b0d6021348fec6a7607b1f2471" />
<meta property="og:url" content="/comm-central/rev/77d59259d30251b0d6021348fec6a7607b1f2471" />
<meta property="og:description" content="backend work for auto config verify logon, r=standard8, sr=neil, 422814" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 77d59259d30251b0d6021348fec6a7607b1f2471 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/77d59259d30251b0d6021348fec6a7607b1f2471">shortlog</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/77d59259d30251b0d6021348fec6a7607b1f2471">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471">files</a> |
changeset |
<a href="/comm-central/raw-rev/77d59259d30251b0d6021348fec6a7607b1f2471">raw</a>  | <a href="/comm-central/archive/77d59259d30251b0d6021348fec6a7607b1f2471.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
backend work for auto config verify logon, r=standard8, sr=neil, 422814
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 10 Sep 2008 14:23:15 -0700</td></tr>

<tr>
 <td>changeset 310</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/77d59259d30251b0d6021348fec6a7607b1f2471">77d59259d30251b0d6021348fec6a7607b1f2471</a></td>
</tr>



<tr>
<td>parent 309</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5dcdfc0e376b5be6e1e082a354f977dcb91e80e7">5dcdfc0e376b5be6e1e082a354f977dcb91e80e7</a>
</td>
</tr>

<tr>
<td>child 311</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/572833185ccf2ca6f7d063ebe5e822333bd8d907">572833185ccf2ca6f7d063ebe5e822333bd8d907</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=77d59259d30251b0d6021348fec6a7607b1f2471">280</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 10 Sep 2008 21:23:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@77d59259d302 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=77d59259d30251b0d6021348fec6a7607b1f2471">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=77d59259d30251b0d6021348fec6a7607b1f2471&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=77d59259d30251b0d6021348fec6a7607b1f2471&newProject=comm-central&newRevision=77d59259d30251b0d6021348fec6a7607b1f2471&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=77d59259d30251b0d6021348fec6a7607b1f2471&newProject=comm-central&newRevision=77d59259d30251b0d6021348fec6a7607b1f2471&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=77d59259d30251b0d6021348fec6a7607b1f2471&newProject=comm-central&newRevision=77d59259d30251b0d6021348fec6a7607b1f2471&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28422814%29&revcount=50">422814</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=422814">422814</a></td></tr>




</table></div>

<div class="page_body description">backend work for auto config verify logon, r=standard8, sr=neil, 422814</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgAccountManager.idl">mailnews/base/public/nsIMsgAccountManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgAccountManager.idl">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgAccountManager.idl">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgAccountManager.idl">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgAccountManager.idl">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgAccountManager.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgIncomingServer.idl">mailnews/base/public/nsIMsgIncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgIncomingServer.idl">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgIncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgIncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgIncomingServer.idl">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/public/nsIMsgIncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.h">mailnews/base/src/nsMsgAccountManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.h">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.h">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.h">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.h">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/src/nsMsgAccountManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgMailNewsUrl.cpp">mailnews/base/util/nsMsgMailNewsUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgMailNewsUrl.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgMailNewsUrl.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgMailNewsUrl.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgMailNewsUrl.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/base/util/nsMsgMailNewsUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpServer.idl">mailnews/compose/public/nsISmtpServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpServer.idl">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpServer.idl">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpServer.idl">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpServer.idl">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpService.idl">mailnews/compose/public/nsISmtpService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpService.idl">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpService.idl">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpService.idl">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpService.idl">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpUrl.idl">mailnews/compose/public/nsISmtpUrl.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpUrl.idl">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpUrl.idl">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpUrl.idl">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpUrl.idl">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/public/nsISmtpUrl.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.h">mailnews/compose/src/nsSmtpProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.h">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.h">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.h">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.h">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpServer.cpp">mailnews/compose/src/nsSmtpServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpServer.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpServer.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpServer.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpServer.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.cpp">mailnews/compose/src/nsSmtpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.h">mailnews/compose/src/nsSmtpUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.h">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.h">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.h">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.h">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/compose/src/nsSmtpUrl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapService.idl">mailnews/imap/public/nsIImapService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapService.idl">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapService.idl">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapService.idl">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapService.idl">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapUrl.idl">mailnews/imap/public/nsIImapUrl.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapUrl.idl">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapUrl.idl">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapUrl.idl">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapUrl.idl">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/public/nsIImapUrl.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.h">mailnews/imap/src/nsImapIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.h">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.h">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapUrl.cpp">mailnews/imap/src/nsImapUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapUrl.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapUrl.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapUrl.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapUrl.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/imap/src/nsImapUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/public/nsIPop3Service.idl">mailnews/local/public/nsIPop3Service.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/public/nsIPop3Service.idl">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/public/nsIPop3Service.idl">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/public/nsIPop3Service.idl">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/public/nsIPop3Service.idl">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/public/nsIPop3Service.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.cpp">mailnews/local/src/nsPop3IncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.h">mailnews/local/src/nsPop3IncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.h">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.h">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.h">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.h">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3IncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.h">mailnews/local/src/nsPop3Protocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.h">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.h">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.h">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.h">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Protocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Service.cpp">mailnews/local/src/nsPop3Service.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Service.cpp">file</a> |
<a href="/comm-central/annotate/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Service.cpp">annotate</a> |
<a href="/comm-central/diff/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Service.cpp">diff</a> |
<a href="/comm-central/comparison/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Service.cpp">comparison</a> |
<a href="/comm-central/log/77d59259d30251b0d6021348fec6a7607b1f2471/mailnews/local/src/nsPop3Service.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -42,17 +42,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIMsgIncomingServer.idl&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsIIncomingServerListener.idl&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIMsgFolder.idl&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> interface nsISupportsArray;</span>
<a href="#l1.9"></a><span id="l1.9"> interface nsIMsgFolderCache;</span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIFolderListener;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(8129D2AD-6093-479D-884C-D8E79FA29B46)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(d0e03f59-ee44-40ab-a444-3d61aaf6da59)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgAccountManager : nsISupports {</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   nsIMsgAccount createAccount();</span>
<a href="#l1.17"></a><span id="l1.17">   /*</span>
<a href="#l1.18"></a><span id="l1.18">    * Return the account with the provided key, or null if none found.</span>
<a href="#l1.19"></a><span id="l1.19">    */</span>
<a href="#l1.20"></a><span id="l1.20">   nsIMsgAccount getAccount(in ACString key);</span>
<a href="#l1.21"></a><span id="l1.21">     </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -63,21 +63,34 @@ interface nsIMsgAccountManager : nsISupp</span>
<a href="#l1.23"></a><span id="l1.23">   /*</span>
<a href="#l1.24"></a><span id="l1.24">    * creates a new identity and assigns it a new, unique &quot;key&quot;</span>
<a href="#l1.25"></a><span id="l1.25">    */</span>
<a href="#l1.26"></a><span id="l1.26">   nsIMsgIdentity createIdentity();</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">   /*</span>
<a href="#l1.29"></a><span id="l1.29">    * creates a new server and assigns it a new, unique &quot;key&quot;</span>
<a href="#l1.30"></a><span id="l1.30">    * the given type will be used to construct a ContractID</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+   *</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+   *  @param type &quot;imap&quot;, &quot;pop3&quot;, &quot;nntp&quot;, &quot;movemail&quot;, &quot;none&quot;, &quot;rss&quot;, &quot;generic&quot;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+   * (suffix of contract ID @mozilla.org/messenger/server;1?type= )</span>
<a href="#l1.34"></a><span id="l1.34">    */</span>
<a href="#l1.35"></a><span id="l1.35">   nsIMsgIncomingServer createIncomingServer(in ACString username,</span>
<a href="#l1.36"></a><span id="l1.36">                                             in ACString hostname,</span>
<a href="#l1.37"></a><span id="l1.37">                                             in ACString type);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  </span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  /**</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+   * Removes the server from the list of servers</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+   * </span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+   * @param aServer        server to remove</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+   * @param aCleanupFiles  remove directory from profile</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+   *</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+   * @throws NS_ERROR_FAILURE if server not found </span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+   */</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  void removeIncomingServer(in nsIMsgIncomingServer aServer, </span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+                            in boolean aCleanupFiles);</span>
<a href="#l1.50"></a><span id="l1.50">   /*</span>
<a href="#l1.51"></a><span id="l1.51">    * get the identity with the given key</span>
<a href="#l1.52"></a><span id="l1.52">    * if the identity does not exist, it will be created</span>
<a href="#l1.53"></a><span id="l1.53">    */</span>
<a href="#l1.54"></a><span id="l1.54">   nsIMsgIdentity getIdentity(in ACString key);</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56">   /*</span>
<a href="#l1.57"></a><span id="l1.57">    * Gets the existing incoming server with the given key</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -52,17 +52,17 @@ interface nsIMsgDBHdr;</span>
<a href="#l2.4"></a><span id="l2.4"> interface nsILocalFile;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> /*</span>
<a href="#l2.7"></a><span id="l2.7">  * Interface for incoming mail/news host</span>
<a href="#l2.8"></a><span id="l2.8">  * this is the base interface for all mail server types (imap, pop, nntp, etc)</span>
<a href="#l2.9"></a><span id="l2.9">  * often you will want to add extra interfaces that give you server-specific</span>
<a href="#l2.10"></a><span id="l2.10">  * attributes and methods.</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(15087bf7-f63f-42c3-8f60-a0cd11aaca53)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(e84541a9-98a7-47b3-8037-2cf83b4c242b)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgIncomingServer : nsISupports {</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   /**</span>
<a href="#l2.17"></a><span id="l2.17">    * internal pref key - guaranteed to be unique across all servers</span>
<a href="#l2.18"></a><span id="l2.18">    */</span>
<a href="#l2.19"></a><span id="l2.19">   attribute ACString key;</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   /**</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -168,17 +168,21 @@ interface nsIMsgIncomingServer : nsISupp</span>
<a href="#l2.23"></a><span id="l2.23">      - if account is deferred, root folder of deferred-to account */</span>
<a href="#l2.24"></a><span id="l2.24">   readonly attribute nsIMsgFolder rootMsgFolder;</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   /* are we already getting new Messages on the current server..</span>
<a href="#l2.27"></a><span id="l2.27">      This is used to help us prevent multiple get new msg commands from</span>
<a href="#l2.28"></a><span id="l2.28">      going off at the same time. */</span>
<a href="#l2.29"></a><span id="l2.29">   attribute boolean serverBusy;</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  /* should we use a secure channel? */</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  /**</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   * Should we use a SSL/TLS?</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   * If not, set this to false and socketType to defaultSocket.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   * If SSL/TLS, set this to true and socketType to the right SSL type.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   */</span>
<a href="#l2.37"></a><span id="l2.37">   attribute boolean isSecure;</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39">   /* should we use secure authentication? */</span>
<a href="#l2.40"></a><span id="l2.40">   attribute boolean useSecAuth;</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">   const long defaultSocket = 0;</span>
<a href="#l2.43"></a><span id="l2.43">   const long tryTLS = 1;</span>
<a href="#l2.44"></a><span id="l2.44">   const long alwaysUseTLS = 2;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineat">@@ -187,31 +191,39 @@ interface nsIMsgIncomingServer : nsISupp</span>
<a href="#l2.46"></a><span id="l2.46">   /* use above values */</span>
<a href="#l2.47"></a><span id="l2.47">   attribute long socketType;</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">   /* if a logon mechanism fails, should we fallback to a different</span>
<a href="#l2.50"></a><span id="l2.50">      mechanism?</span>
<a href="#l2.51"></a><span id="l2.51">   */</span>
<a href="#l2.52"></a><span id="l2.52">   attribute boolean logonFallback;</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-  /* can server support a secure channel? */</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  /* dead code. */</span>
<a href="#l2.56"></a><span id="l2.56">   readonly attribute boolean isSecureServer;</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">   /* empty trash on exit */</span>
<a href="#l2.59"></a><span id="l2.59">   attribute boolean emptyTrashOnExit;</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">   /* get filter list */</span>
<a href="#l2.62"></a><span id="l2.62">   nsIMsgFilterList getFilterList(in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">   /* set filter list */</span>
<a href="#l2.65"></a><span id="l2.65">   void setFilterList(in nsIMsgFilterList aFilterList);</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67">   /* we use this to set the default local path.  we use this when migrating prefs */</span>
<a href="#l2.68"></a><span id="l2.68">   void setDefaultLocalPath(in nsILocalFile aDefaultLocalPath);</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  /**</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+   * Verify that we can logon </span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+   * </span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+   * @param  aUrlListener - gets called back with success or failure.</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+   *</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+   */</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  void verifyLogon(in nsIUrlListener aUrlListener);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+</span>
<a href="#l2.78"></a><span id="l2.78">   /* do a biff */</span>
<a href="#l2.79"></a><span id="l2.79">   void performBiff(in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.80"></a><span id="l2.80">   </span>
<a href="#l2.81"></a><span id="l2.81">   /* get new messages */</span>
<a href="#l2.82"></a><span id="l2.82">   void getNewMessages(in nsIMsgFolder aFolder, in nsIMsgWindow aMsgWindow, </span>
<a href="#l2.83"></a><span id="l2.83">                       in nsIUrlListener aUrlListener);</span>
<a href="#l2.84"></a><span id="l2.84">   /* this checks if a server needs a password to do biff */</span>
<a href="#l2.85"></a><span id="l2.85">   readonly attribute boolean serverRequiresPasswordForBiff;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -451,16 +451,67 @@ nsMsgAccountManager::GetIncomingServer(c</span>
<a href="#l3.4"></a><span id="l3.4">   nsCString hostname;</span>
<a href="#l3.5"></a><span id="l3.5">   rv = m_prefs-&gt;GetCharPref(serverPref.get(), getter_Copies(hostname));</span>
<a href="#l3.6"></a><span id="l3.6">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">     // the server type doesn't exist. That's bad.</span>
<a href="#l3.9"></a><span id="l3.9">   return createKeyedServer(key, username, hostname, serverType, _retval);</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+nsMsgAccountManager::RemoveIncomingServer(nsIMsgIncomingServer *aServer, </span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+                                          PRBool aCleanupFiles)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+{</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  nsCString serverKey;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  nsresult rv = aServer-&gt;GetKey(serverKey);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  LogoutOfServer(aServer); // close cached connections and forget session password</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  // invalidate the FindServer() cache if we are removing the cached server</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  if (m_lastFindServerResult == aServer)</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    SetLastServerFound(nsnull, EmptyCString(), EmptyCString(), 0, EmptyCString());</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  m_incomingServers.Remove(serverKey);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  nsCOMPtr&lt;nsISupportsArray&gt; allDescendents;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  rv = aServer-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  rv = NS_NewISupportsArray(getter_AddRefs(allDescendents));</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  rootFolder-&gt;ListDescendents(allDescendents);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  PRUint32 cnt = 0;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  rv = allDescendents-&gt;Count(&amp;cnt);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  for (PRUint32 i = 0; i &lt; cnt; i++)</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(allDescendents, i);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    if (folder)</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+      folder-&gt;ForceDBClosed();</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  }</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  mFolderListeners-&gt;EnumerateForwards(removeListenerFromFolder, (void*)rootFolder);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  NotifyServerUnloaded(aServer);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  if (aCleanupFiles)</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    rv = aServer-&gt;RemoveFiles();</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  }</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+  // now clear out the server once and for all.</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  // watch out! could be scary</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  aServer-&gt;ClearAllValues();</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  rootFolder-&gt;Shutdown(PR_TRUE);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  return rv;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+}</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+</span>
<a href="#l3.63"></a><span id="l3.63"> /*</span>
<a href="#l3.64"></a><span id="l3.64">  * create a server when you know the key and the type</span>
<a href="#l3.65"></a><span id="l3.65">  */</span>
<a href="#l3.66"></a><span id="l3.66"> nsresult</span>
<a href="#l3.67"></a><span id="l3.67"> nsMsgAccountManager::createKeyedServer(const nsACString&amp; key,</span>
<a href="#l3.68"></a><span id="l3.68">                                        const nsACString&amp; username,</span>
<a href="#l3.69"></a><span id="l3.69">                                        const nsACString&amp; hostname,</span>
<a href="#l3.70"></a><span id="l3.70">                                        const nsACString&amp; type,</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineat">@@ -560,59 +611,18 @@ nsMsgAccountManager::RemoveAccount(nsIMs</span>
<a href="#l3.72"></a><span id="l3.72">     SetDefaultAccount(nsnull);</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">   // XXX - need to figure out if this is the last time this server is</span>
<a href="#l3.75"></a><span id="l3.75">   // being used, and only send notification then.</span>
<a href="#l3.76"></a><span id="l3.76">   // (and only remove from hashtable then too!)</span>
<a href="#l3.77"></a><span id="l3.77">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.78"></a><span id="l3.78">   rv = aAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.79"></a><span id="l3.79">   if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-    nsCString serverKey;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    rv = server-&gt;GetKey(serverKey);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    LogoutOfServer(server); // close cached connections and forget session password</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    // invalidate the FindServer() cache if we are removing the cached server</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-    if (m_lastFindServerResult) {</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-      nsCString cachedServerKey;</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-      rv = m_lastFindServerResult-&gt;GetKey(cachedServerKey);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-      if (serverKey.Equals(cachedServerKey)) {</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-        rv = SetLastServerFound(nsnull, EmptyCString(), EmptyCString(), 0, EmptyCString());</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-      }</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    }</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-    m_incomingServers.Remove(serverKey);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-    server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; allDescendents;</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-    NS_NewISupportsArray(getter_AddRefs(allDescendents));</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-    rootFolder-&gt;ListDescendents(allDescendents);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-    PRUint32 cnt =0;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-    rv = allDescendents-&gt;Count(&amp;cnt);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+    rv = RemoveIncomingServer(server, PR_FALSE);</span>
<a href="#l3.108"></a><span id="l3.108">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-    for (PRUint32 i = 0; i &lt; cnt;i++)</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-    {</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(allDescendents, i, &amp;rv);</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-      folder-&gt;ForceDBClosed();</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-    }</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    mFolderListeners-&gt;EnumerateForwards(removeListenerFromFolder, (void*)rootFolder);</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-    NotifyServerUnloaded(server);</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-    rv = server-&gt;RemoveFiles();</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-    // now clear out the server once and for all.</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-    // watch out! could be scary</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-    server-&gt;ClearAllValues();</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-    rootFolder-&gt;Shutdown(PR_TRUE);</span>
<a href="#l3.124"></a><span id="l3.124">   }</span>
<a href="#l3.125"></a><span id="l3.125"> </span>
<a href="#l3.126"></a><span id="l3.126">   nsCOMPtr&lt;nsISupportsArray&gt; identityArray;</span>
<a href="#l3.127"></a><span id="l3.127">   rv = aAccount-&gt;GetIdentities(getter_AddRefs(identityArray));</span>
<a href="#l3.128"></a><span id="l3.128">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.129"></a><span id="l3.129">     PRUint32 count=0;</span>
<a href="#l3.130"></a><span id="l3.130">     identityArray-&gt;Count(&amp;count);</span>
<a href="#l3.131"></a><span id="l3.131">     PRUint32 i;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineat">@@ -1681,18 +1691,17 @@ nsMsgAccountManager::FindServerByURI(nsI</span>
<a href="#l3.133"></a><span id="l3.133">   serverInfo.useRealSetting = aRealFlag;</span>
<a href="#l3.134"></a><span id="l3.134">   serverInfo.server = *aResult = nsnull;</span>
<a href="#l3.135"></a><span id="l3.135">   servers-&gt;EnumerateForwards(findServerUrl, (void *)&amp;serverInfo);</span>
<a href="#l3.136"></a><span id="l3.136"> </span>
<a href="#l3.137"></a><span id="l3.137">   if (!serverInfo.server)</span>
<a href="#l3.138"></a><span id="l3.138">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140">   // cache for next time</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-  rv = SetLastServerFound(serverInfo.server, hostname, username, port, type);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+  SetLastServerFound(serverInfo.server, hostname, username, port, type);</span>
<a href="#l3.144"></a><span id="l3.144">   NS_ADDREF(*aResult = serverInfo.server);</span>
<a href="#l3.145"></a><span id="l3.145">   return NS_OK;</span>
<a href="#l3.146"></a><span id="l3.146"> }</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148"> NS_IMETHODIMP</span>
<a href="#l3.149"></a><span id="l3.149"> nsMsgAccountManager::FindServer(const nsACString&amp; username,</span>
<a href="#l3.150"></a><span id="l3.150">                                 const nsACString&amp; hostname,</span>
<a href="#l3.151"></a><span id="l3.151">                                 const nsACString&amp; type,</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineat">@@ -1727,18 +1736,17 @@ nsMsgAccountManager::FindServer(const ns</span>
<a href="#l3.153"></a><span id="l3.153">   serverInfo.server = *aResult = nsnull;</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155">   servers-&gt;EnumerateForwards(findServer, (void *)&amp;serverInfo);</span>
<a href="#l3.156"></a><span id="l3.156"> </span>
<a href="#l3.157"></a><span id="l3.157">   if (!serverInfo.server)</span>
<a href="#l3.158"></a><span id="l3.158">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.159"></a><span id="l3.159"> </span>
<a href="#l3.160"></a><span id="l3.160">   // cache for next time</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-  rv = SetLastServerFound(serverInfo.server, hostname, username, 0, type);</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+  SetLastServerFound(serverInfo.server, hostname, username, 0, type);</span>
<a href="#l3.164"></a><span id="l3.164"> </span>
<a href="#l3.165"></a><span id="l3.165">   NS_ADDREF(*aResult = serverInfo.server);</span>
<a href="#l3.166"></a><span id="l3.166">   return NS_OK;</span>
<a href="#l3.167"></a><span id="l3.167"> }</span>
<a href="#l3.168"></a><span id="l3.168"> </span>
<a href="#l3.169"></a><span id="l3.169"> // Interface called by UI js only (always return true).</span>
<a href="#l3.170"></a><span id="l3.170"> NS_IMETHODIMP</span>
<a href="#l3.171"></a><span id="l3.171"> nsMsgAccountManager::FindRealServer(const nsACString&amp; username,</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineat">@@ -2309,26 +2317,25 @@ nsMsgAccountManager::SetFolderDoingClean</span>
<a href="#l3.173"></a><span id="l3.173"> NS_IMETHODIMP</span>
<a href="#l3.174"></a><span id="l3.174"> nsMsgAccountManager::GetCleanupInboxInProgress(PRBool *bVal)</span>
<a href="#l3.175"></a><span id="l3.175"> {</span>
<a href="#l3.176"></a><span id="l3.176">   NS_ENSURE_ARG_POINTER(bVal);</span>
<a href="#l3.177"></a><span id="l3.177">   *bVal = m_cleanupInboxInProgress;</span>
<a href="#l3.178"></a><span id="l3.178">   return NS_OK;</span>
<a href="#l3.179"></a><span id="l3.179"> }</span>
<a href="#l3.180"></a><span id="l3.180"> </span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-nsresult</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+void</span>
<a href="#l3.183"></a><span id="l3.183"> nsMsgAccountManager::SetLastServerFound(nsIMsgIncomingServer *server, const nsACString&amp; hostname, </span>
<a href="#l3.184"></a><span id="l3.184">                                         const nsACString&amp; username, const PRInt32 port, const nsACString&amp; type)</span>
<a href="#l3.185"></a><span id="l3.185"> {</span>
<a href="#l3.186"></a><span id="l3.186">   m_lastFindServerResult = server;</span>
<a href="#l3.187"></a><span id="l3.187">   m_lastFindServerHostName = hostname;</span>
<a href="#l3.188"></a><span id="l3.188">   m_lastFindServerUserName = username;</span>
<a href="#l3.189"></a><span id="l3.189">   m_lastFindServerPort = port;</span>
<a href="#l3.190"></a><span id="l3.190">   m_lastFindServerType = type;</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.192"></a><span id="l3.192"> }</span>
<a href="#l3.193"></a><span id="l3.193"> </span>
<a href="#l3.194"></a><span id="l3.194"> NS_IMETHODIMP</span>
<a href="#l3.195"></a><span id="l3.195"> nsMsgAccountManager::SaveAccountInfo()</span>
<a href="#l3.196"></a><span id="l3.196"> {</span>
<a href="#l3.197"></a><span id="l3.197">   nsresult rv;</span>
<a href="#l3.198"></a><span id="l3.198">   nsCOMPtr&lt;nsIPrefService&gt; pref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.199"></a><span id="l3.199">   NS_ENSURE_SUCCESS(rv,rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -109,18 +109,18 @@ private:</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">   /* we call FindServer() a lot.  so cache the last server found */</span>
<a href="#l4.6"></a><span id="l4.6">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; m_lastFindServerResult;</span>
<a href="#l4.7"></a><span id="l4.7">   nsCString m_lastFindServerHostName;</span>
<a href="#l4.8"></a><span id="l4.8">   nsCString m_lastFindServerUserName;</span>
<a href="#l4.9"></a><span id="l4.9">   PRInt32 m_lastFindServerPort;</span>
<a href="#l4.10"></a><span id="l4.10">   nsCString m_lastFindServerType;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsresult SetLastServerFound(nsIMsgIncomingServer *server, const nsACString&amp; hostname,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                              const nsACString&amp; username, const PRInt32 port, const nsACString&amp; type);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  void SetLastServerFound(nsIMsgIncomingServer *server, const nsACString&amp; hostname,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+                          const nsACString&amp; username, const PRInt32 port, const nsACString&amp; type);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">   /* internal creation routines - updates m_identities and m_incomingServers */</span>
<a href="#l4.18"></a><span id="l4.18">   nsresult createKeyedAccount(const nsCString&amp; key,</span>
<a href="#l4.19"></a><span id="l4.19">                               nsIMsgAccount **_retval);</span>
<a href="#l4.20"></a><span id="l4.20">   nsresult createKeyedServer(const nsACString&amp; key,</span>
<a href="#l4.21"></a><span id="l4.21">                              const nsACString&amp; username,</span>
<a href="#l4.22"></a><span id="l4.22">                              const nsACString&amp; password,</span>
<a href="#l4.23"></a><span id="l4.23">                              const nsACString&amp; type,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -181,16 +181,22 @@ nsMsgIncomingServer::GetRootMsgFolder(ns</span>
<a href="#l5.4"></a><span id="l5.4"> NS_IMETHODIMP</span>
<a href="#l5.5"></a><span id="l5.5"> nsMsgIncomingServer::PerformExpand(nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.6"></a><span id="l5.6"> {</span>
<a href="#l5.7"></a><span id="l5.7">   return NS_OK;</span>
<a href="#l5.8"></a><span id="l5.8"> }</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> NS_IMETHODIMP</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+nsMsgIncomingServer::VerifyLogon(nsIUrlListener *aUrlListener)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+}</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.18"></a><span id="l5.18"> nsMsgIncomingServer::PerformBiff(nsIMsgWindow* aMsgWindow)</span>
<a href="#l5.19"></a><span id="l5.19"> {</span>
<a href="#l5.20"></a><span id="l5.20">   //This has to be implemented in the derived class, but in case someone doesn't implement it</span>
<a href="#l5.21"></a><span id="l5.21">   //just return not implemented.</span>
<a href="#l5.22"></a><span id="l5.22">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.23"></a><span id="l5.23"> }</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> NS_IMETHODIMP</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -742,24 +748,16 @@ nsMsgIncomingServer::GetPasswordWithUI(c</span>
<a href="#l5.27"></a><span id="l5.27">     {</span>
<a href="#l5.28"></a><span id="l5.28">       // prompt the user for the password</span>
<a href="#l5.29"></a><span id="l5.29">       nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l5.30"></a><span id="l5.30">       rv = aMsgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l5.31"></a><span id="l5.31">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.32"></a><span id="l5.32">       dialog = do_GetInterface(docShell, &amp;rv);</span>
<a href="#l5.33"></a><span id="l5.33">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.34"></a><span id="l5.34">     }</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    else</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-    {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-      nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-      if (wwatch)</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-        wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-      NS_ENSURE_TRUE(dialog, NS_ERROR_FAILURE);</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-    }</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-    </span>
<a href="#l5.43"></a><span id="l5.43">     if (dialog)</span>
<a href="#l5.44"></a><span id="l5.44">     {</span>
<a href="#l5.45"></a><span id="l5.45">       nsCString serverUri;</span>
<a href="#l5.46"></a><span id="l5.46">       rv = GetServerURI(serverUri);</span>
<a href="#l5.47"></a><span id="l5.47">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49">       // we pass in the previously used password, if any, into PromptPassword</span>
<a href="#l5.50"></a><span id="l5.50">       // so that it will appear as ******. This means we can't use an nsString</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineat">@@ -995,17 +993,29 @@ NS_IMETHODIMP</span>
<a href="#l5.52"></a><span id="l5.52"> nsMsgIncomingServer::RemoveFiles()</span>
<a href="#l5.53"></a><span id="l5.53"> {</span>
<a href="#l5.54"></a><span id="l5.54">   // IMPORTANT, see bug #77652</span>
<a href="#l5.55"></a><span id="l5.55">   // don't turn this code on yet.  we don't inform the user that</span>
<a href="#l5.56"></a><span id="l5.56">   // we are going to be deleting the directory, and they might have</span>
<a href="#l5.57"></a><span id="l5.57">   // tweaked their localPath pref for this server to point to</span>
<a href="#l5.58"></a><span id="l5.58">   // somewhere they didn't want deleted.</span>
<a href="#l5.59"></a><span id="l5.59">   // until we tell them, we shouldn't do the delete.</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+  nsCString deferredToAccount;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+  GetCharValue(&quot;deferred_to_account&quot;, deferredToAccount);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  PRBool isDeferredTo = PR_TRUE;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  GetIsDeferredTo(&amp;isDeferredTo);</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+  if (!deferredToAccount.IsEmpty() || isDeferredTo)</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  {</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+    NS_ASSERTION(PR_FALSE, &quot;shouldn't remove files for a deferred account&quot;);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  }</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  nsCOMPtr &lt;nsILocalFile&gt; localPath;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  nsresult rv = GetLocalPath(getter_AddRefs(localPath));</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  return localPath-&gt;Remove(PR_TRUE);</span>
<a href="#l5.74"></a><span id="l5.74"> }</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76"> NS_IMETHODIMP</span>
<a href="#l5.77"></a><span id="l5.77"> nsMsgIncomingServer::SetFilterList(nsIMsgFilterList *aFilterList)</span>
<a href="#l5.78"></a><span id="l5.78"> {</span>
<a href="#l5.79"></a><span id="l5.79">   mFilterList = aFilterList;</span>
<a href="#l5.80"></a><span id="l5.80">   return NS_OK;</span>
<a href="#l5.81"></a><span id="l5.81"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -197,21 +197,19 @@ NS_IMETHODIMP nsMsgMailNewsUrl::GetServe</span>
<a href="#l6.4"></a><span id="l6.4">     return rv;</span>
<a href="#l6.5"></a><span id="l6.5"> }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> NS_IMETHODIMP nsMsgMailNewsUrl::GetMsgWindow(nsIMsgWindow **aMsgWindow)</span>
<a href="#l6.8"></a><span id="l6.8"> {</span>
<a href="#l6.9"></a><span id="l6.9">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l6.10"></a><span id="l6.10">   *aMsgWindow = nsnull;</span>
<a href="#l6.11"></a><span id="l6.11">   </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  // note: it is okay to return a null msg window and not return an error</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  // it's possible the url really doesn't have msg window</span>
<a href="#l6.14"></a><span id="l6.14">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l6.15"></a><span id="l6.15">   msgWindow.swap(*aMsgWindow);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  return *aMsgWindow ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l6.18"></a><span id="l6.18"> }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> NS_IMETHODIMP nsMsgMailNewsUrl::SetMsgWindow(nsIMsgWindow *aMsgWindow)</span>
<a href="#l6.21"></a><span id="l6.21"> {</span>
<a href="#l6.22"></a><span id="l6.22">   if (aMsgWindow)</span>
<a href="#l6.23"></a><span id="l6.23">     m_msgWindowWeak = do_GetWeakReference(aMsgWindow);</span>
<a href="#l6.24"></a><span id="l6.24">   return NS_OK;</span>
<a href="#l6.25"></a><span id="l6.25"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/public/nsISmtpServer.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/public/nsISmtpServer.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -34,25 +34,26 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.5"></a><span id="l7.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> interface nsIAuthPrompt;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+interface nsIUrlListener;</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> /**</span>
<a href="#l7.15"></a><span id="l7.15">  * This interface represents a single SMTP Server. A SMTP server instance may be</span>
<a href="#l7.16"></a><span id="l7.16">  * created/obtained from nsIMsgAccountManager.</span>
<a href="#l7.17"></a><span id="l7.17">  *</span>
<a href="#l7.18"></a><span id="l7.18">  * Most of the attributes will set/get preferences from the main preferences</span>
<a href="#l7.19"></a><span id="l7.19">  * file.</span>
<a href="#l7.20"></a><span id="l7.20">  */</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-[scriptable, uuid(1d449933-b0b7-4bbf-a8a4-cc4bb9b545c5)]</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+[scriptable, uuid(71f5d415-094d-4a32-899b-2256c2de6876)]</span>
<a href="#l7.23"></a><span id="l7.23"> interface nsISmtpServer : nsISupports {</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   /// A unique identifier for the server.</span>
<a href="#l7.26"></a><span id="l7.26">   attribute string key;</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">   /// A user supplied description for the server.</span>
<a href="#l7.29"></a><span id="l7.29">   attribute AUTF8String description;</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineat">@@ -67,17 +68,17 @@ interface nsISmtpServer : nsISupports {</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33">   /**</span>
<a href="#l7.34"></a><span id="l7.34">    * The password to access the server with (if required).</span>
<a href="#l7.35"></a><span id="l7.35">    *</span>
<a href="#l7.36"></a><span id="l7.36">    * @note this is stored within the server instance but not within preferences.</span>
<a href="#l7.37"></a><span id="l7.37">    * It can be specified/saved here to avoid prompting the user constantly for</span>
<a href="#l7.38"></a><span id="l7.38">    * the sending password.</span>
<a href="#l7.39"></a><span id="l7.39">    */</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  attribute string password;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  attribute ACString password;</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">   /// Returns a displayname of the format hostname:port or just hostname</span>
<a href="#l7.44"></a><span id="l7.44">   readonly attribute string displayname;</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">   /**</span>
<a href="#l7.47"></a><span id="l7.47">    * Whether or not to use authentication for this server.</span>
<a href="#l7.48"></a><span id="l7.48">    * 0 = no authentication, 1 = use authentication.</span>
<a href="#l7.49"></a><span id="l7.49">    * Reflects the mail.smtpserver.*.auth_method pref (default has value 1).</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineat">@@ -85,17 +86,24 @@ interface nsISmtpServer : nsISupports {</span>
<a href="#l7.51"></a><span id="l7.51">   attribute long authMethod;</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53">   /// Should we always use secure authentication?</span>
<a href="#l7.54"></a><span id="l7.54">   attribute boolean useSecAuth;</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56">   /// Should we attempt to use secure authentication if the server supports it?</span>
<a href="#l7.57"></a><span id="l7.57">   attribute boolean trySecAuth;</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-  /// Should we try to use SSL for this connection?</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  /**</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+   * Should we use SSL for this connection?</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+   * 0 = never</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+   * 1 = STARTTLS, if available (discouraged, insecure)</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+   * 2 = TLS (STARTTLS) always</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+   * 3 = SSL (SMTPS) always</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+   * @see nsSmtpProtocol.h line 115 and nsSmtpProtocol.cpp line 331</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+   */</span>
<a href="#l7.68"></a><span id="l7.68">   attribute long trySSL;</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">   /**</span>
<a href="#l7.71"></a><span id="l7.71">    * May contain an alternative argument to EHLO or HELO to provide to the</span>
<a href="#l7.72"></a><span id="l7.72">    * server. Reflects the value of the mail.smtpserver.*.hello_argument pref.</span>
<a href="#l7.73"></a><span id="l7.73">    * This is mainly useful where ISPs don't bother providing PTR records for</span>
<a href="#l7.74"></a><span id="l7.74">    * their servers and therefore users get an error on sending. See bug 244030</span>
<a href="#l7.75"></a><span id="l7.75">    * for more discussion.</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineat">@@ -111,38 +119,48 @@ interface nsISmtpServer : nsISupports {</span>
<a href="#l7.77"></a><span id="l7.77">    * @param promptString  The string to prompt the user with when asking for</span>
<a href="#l7.78"></a><span id="l7.78">    *                      the password.</span>
<a href="#l7.79"></a><span id="l7.79">    * @param promptTitle   The title of the prompt.</span>
<a href="#l7.80"></a><span id="l7.80">    * @param netPrompt     An nsIAuthPrompt instance to use for the password</span>
<a href="#l7.81"></a><span id="l7.81">    *                      prompt.</span>
<a href="#l7.82"></a><span id="l7.82">    * @return              The password to use (may be null if no password was</span>
<a href="#l7.83"></a><span id="l7.83">    *                      obtained).</span>
<a href="#l7.84"></a><span id="l7.84">    */  </span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  string getPasswordWithUI(in wstring promptString, in wstring promptTitle,</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  ACString getPasswordWithUI(in wstring promptString, in wstring promptTitle,</span>
<a href="#l7.87"></a><span id="l7.87">                            in nsIAuthPrompt netPrompt);</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89">   /**</span>
<a href="#l7.90"></a><span id="l7.90">    * Gets a username and password for this server, using a UI prompt if</span>
<a href="#l7.91"></a><span id="l7.91">    * necessary.</span>
<a href="#l7.92"></a><span id="l7.92">    *</span>
<a href="#l7.93"></a><span id="l7.93">    * @param promptString  The string to prompt the user with when asking for</span>
<a href="#l7.94"></a><span id="l7.94">    *                      the password.</span>
<a href="#l7.95"></a><span id="l7.95">    * @param promptTitle   The title of the prompt.</span>
<a href="#l7.96"></a><span id="l7.96">    * @param netPrompt     An nsIAuthPrompt instance to use for the password</span>
<a href="#l7.97"></a><span id="l7.97">    *                      prompt.</span>
<a href="#l7.98"></a><span id="l7.98">    * @param userid        The username to use (may be null if no password was</span>
<a href="#l7.99"></a><span id="l7.99">    *                      obtained).</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-   * @param password      The password to use (may be null if no password was</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+   * @param password      The password to use (may be empty if no password was</span>
<a href="#l7.102"></a><span id="l7.102">    *                      obtained).</span>
<a href="#l7.103"></a><span id="l7.103">    */  </span>
<a href="#l7.104"></a><span id="l7.104">   void getUsernamePasswordWithUI(in wstring promptString, in wstring promptTitle,</span>
<a href="#l7.105"></a><span id="l7.105">                                  in nsIAuthPrompt netPrompt, out string userid,</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-                                 out string password);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+                                 out ACString password);</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109">   /**</span>
<a href="#l7.110"></a><span id="l7.110">    * Calling this will *remove* the saved password for this server from the</span>
<a href="#l7.111"></a><span id="l7.111">    * password manager and from the stored value.</span>
<a href="#l7.112"></a><span id="l7.112">    */</span>
<a href="#l7.113"></a><span id="l7.113">   void forgetPassword();</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+    /**</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+   * Verify that we can logon </span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+   * </span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+   * @param  aPassword - password to use</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+   * @param  aUrlListener - gets called back with success or failure.</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+   *</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+   */</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  void verifyLogon(in nsIUrlListener aUrlListener);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+</span>
<a href="#l7.125"></a><span id="l7.125">   /// Call this to clear all preference values for this server.</span>
<a href="#l7.126"></a><span id="l7.126">   void clearAllValues();</span>
<a href="#l7.127"></a><span id="l7.127"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/public/nsISmtpService.idl</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/public/nsISmtpService.idl</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -43,17 +43,17 @@ interface nsIURI;</span>
<a href="#l8.4"></a><span id="l8.4"> interface nsIUrlListener;</span>
<a href="#l8.5"></a><span id="l8.5"> interface nsIMsgIdentity;</span>
<a href="#l8.6"></a><span id="l8.6"> interface nsIInterfaceRequestor;</span>
<a href="#l8.7"></a><span id="l8.7"> interface nsIFile;</span>
<a href="#l8.8"></a><span id="l8.8"> interface nsIMsgStatusFeedback;</span>
<a href="#l8.9"></a><span id="l8.9"> interface nsIRequest;</span>
<a href="#l8.10"></a><span id="l8.10"> interface nsISimpleEnumerator;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-[scriptable, uuid(8e9a7c57-cee1-46f2-a03b-14fac3086706)]</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+[scriptable, uuid(7b1c1604-7aad-451e-ae55-a7984c1fd0d9)]</span>
<a href="#l8.14"></a><span id="l8.14"> interface nsISmtpService : nsISupports {</span>
<a href="#l8.15"></a><span id="l8.15">   /**</span>
<a href="#l8.16"></a><span id="l8.16">    * Sends a mail message via the given parameters. This function builds an</span>
<a href="#l8.17"></a><span id="l8.17">    * SMTP URL and makes an SMTP connection, and then runs the url.</span>
<a href="#l8.18"></a><span id="l8.18">    * The SMTP server defined</span>
<a href="#l8.19"></a><span id="l8.19">    * in the aSenderIdentity object (see nsIMsgIdentity) will be used to send</span>
<a href="#l8.20"></a><span id="l8.20">    * the message. If there is no SMTP server defined in aSenderIdentity, the</span>
<a href="#l8.21"></a><span id="l8.21">    * default SMTP server will be used.</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -90,16 +90,25 @@ interface nsISmtpService : nsISupports {</span>
<a href="#l8.23"></a><span id="l8.23">                        in nsIUrlListener aUrlListener, </span>
<a href="#l8.24"></a><span id="l8.24">                        in nsIMsgStatusFeedback aStatusListener, </span>
<a href="#l8.25"></a><span id="l8.25">                        in nsIInterfaceRequestor aNotificationCallbacks,</span>
<a href="#l8.26"></a><span id="l8.26">                        in boolean aRequestDSN,</span>
<a href="#l8.27"></a><span id="l8.27">                        out nsIURI aURL,</span>
<a href="#l8.28"></a><span id="l8.28">                        out nsIRequest aRequest);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30">   /**</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+   * Verifies that we can logon to the server with given password</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+   *</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+   * @param  aSmtpServer       Server to try to logon to.</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+   * @param  aUrlListener      Listener that will get notified whether logon</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+   *                           was successful or not.</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+   */</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+  void verifyLogon(in nsISmtpServer aServer, in nsIUrlListener aListener);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  /**</span>
<a href="#l8.40"></a><span id="l8.40">    * Return the SMTP server that is associated with an identity.</span>
<a href="#l8.41"></a><span id="l8.41">    */</span>
<a href="#l8.42"></a><span id="l8.42">   void GetSmtpServerByIdentity(in nsIMsgIdentity aSenderIdentity,</span>
<a href="#l8.43"></a><span id="l8.43">                                out nsISmtpServer aServer);</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   /**</span>
<a href="#l8.46"></a><span id="l8.46">    * A copy of the array of SMTP servers, as stored in the preferences</span>
<a href="#l8.47"></a><span id="l8.47">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/public/nsISmtpUrl.idl</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/public/nsISmtpUrl.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -41,17 +41,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> interface nsIMsgIdentity;</span>
<a href="#l9.6"></a><span id="l9.6"> interface nsIPrompt;</span>
<a href="#l9.7"></a><span id="l9.7"> interface nsIAuthPrompt;</span>
<a href="#l9.8"></a><span id="l9.8"> interface nsISmtpServer;</span>
<a href="#l9.9"></a><span id="l9.9"> interface nsIInterfaceRequestor;</span>
<a href="#l9.10"></a><span id="l9.10"> interface nsIFile;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-[scriptable, uuid(b167bf57-51c0-41ae-b331-bd7025c01a20)]</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+[scriptable, uuid(ffc85194-21cc-42a2-9844-34068888a117)]</span>
<a href="#l9.14"></a><span id="l9.14"> interface nsISmtpUrl : nsISupports {</span>
<a href="#l9.15"></a><span id="l9.15">   /**</span>
<a href="#l9.16"></a><span id="l9.16">    * SMTP Parse specific getters.</span>
<a href="#l9.17"></a><span id="l9.17">    * These retrieve various parts from the url.</span>
<a href="#l9.18"></a><span id="l9.18">    */</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   /**</span>
<a href="#l9.21"></a><span id="l9.21">    * This list is a list of all recipients to send the email to.</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -89,16 +89,18 @@ interface nsISmtpUrl : nsISupports {</span>
<a href="#l9.23"></a><span id="l9.23">    * NOTE:  the SMTP username and SMTP server are in the smtp url</span>
<a href="#l9.24"></a><span id="l9.24">    * smtp://sspitzer@tintin/...</span>
<a href="#l9.25"></a><span id="l9.25">    */</span>
<a href="#l9.26"></a><span id="l9.26">   attribute nsIMsgIdentity senderIdentity;</span>
<a href="#l9.27"></a><span id="l9.27">   attribute nsIPrompt prompt;</span>
<a href="#l9.28"></a><span id="l9.28">   attribute nsIAuthPrompt authPrompt;</span>
<a href="#l9.29"></a><span id="l9.29">   attribute nsIInterfaceRequestor notificationCallbacks;</span>
<a href="#l9.30"></a><span id="l9.30">   attribute nsISmtpServer smtpServer;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  attribute boolean verifyLogon; // we're just verifying the ability to logon</span>
<a href="#l9.33"></a><span id="l9.33">     </span>
<a href="#l9.34"></a><span id="l9.34">   const PRInt32 DEFAULT_SMTP_PORT = 25;</span>
<a href="#l9.35"></a><span id="l9.35">   const PRInt32 DEFAULT_SMTPS_PORT = 465;</span>
<a href="#l9.36"></a><span id="l9.36"> };</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38"> [scriptable, uuid(5EE2AFF7-9C6F-11d3-98A3-001083010E9B)]</span>
<a href="#l9.39"></a><span id="l9.39"> interface nsIMailtoUrl : nsISupports {</span>
<a href="#l9.40"></a><span id="l9.40">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -567,26 +567,34 @@ PRInt32 nsSmtpProtocol::SendHeloResponse</span>
<a href="#l10.4"></a><span id="l10.4"> {</span>
<a href="#l10.5"></a><span id="l10.5">   PRInt32 status = 0;</span>
<a href="#l10.6"></a><span id="l10.6">   nsCAutoString buffer;</span>
<a href="#l10.7"></a><span id="l10.7">   nsresult rv;</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9">   if (m_responseCode != 250)</span>
<a href="#l10.10"></a><span id="l10.10">   {</span>
<a href="#l10.11"></a><span id="l10.11"> #ifdef DEBUG</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    nsresult rv =</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    rv =</span>
<a href="#l10.14"></a><span id="l10.14"> #endif</span>
<a href="#l10.15"></a><span id="l10.15">     nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_SERVER_ERROR,</span>
<a href="#l10.16"></a><span id="l10.16">                           m_responseText.get());</span>
<a href="#l10.17"></a><span id="l10.17">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l10.20"></a><span id="l10.20">     return(NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER);</span>
<a href="#l10.21"></a><span id="l10.21">   }</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  // check if we're just verifying the ability to logon</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+  PRBool verifyingLogon = PR_FALSE;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  smtpUrl-&gt;GetVerifyLogon(&amp;verifyingLogon);</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+  if (verifyingLogon)</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    return SendQuit();</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+</span>
<a href="#l10.31"></a><span id="l10.31">   // extract the email address from the identity</span>
<a href="#l10.32"></a><span id="l10.32">   nsCString emailAddress;</span>
<a href="#l10.33"></a><span id="l10.33">   nsCOMPtr &lt;nsIMsgIdentity&gt; senderIdentity;</span>
<a href="#l10.34"></a><span id="l10.34">   rv = m_runningURL-&gt;GetSenderIdentity(getter_AddRefs(senderIdentity));</span>
<a href="#l10.35"></a><span id="l10.35">   if (NS_FAILED(rv) || !senderIdentity)</span>
<a href="#l10.36"></a><span id="l10.36">   {</span>
<a href="#l10.37"></a><span id="l10.37">     m_urlErrorState = NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS;</span>
<a href="#l10.38"></a><span id="l10.38">     return(NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS);</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineat">@@ -1154,23 +1162,23 @@ PRInt32 nsSmtpProtocol::AuthLoginStep1()</span>
<a href="#l10.40"></a><span id="l10.40">   nsCAutoString password;</span>
<a href="#l10.41"></a><span id="l10.41">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l10.42"></a><span id="l10.42">   rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l10.43"></a><span id="l10.43">   if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45">   rv = smtpServer-&gt;GetUsername(getter_Copies(username));</span>
<a href="#l10.46"></a><span id="l10.46">   if (username.IsEmpty())</span>
<a href="#l10.47"></a><span id="l10.47">   {</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-    rv = GetUsernamePassword(getter_Copies(username), getter_Copies(password));</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    rv = GetUsernamePassword(getter_Copies(username), password);</span>
<a href="#l10.50"></a><span id="l10.50">     m_usernamePrompted = PR_TRUE;</span>
<a href="#l10.51"></a><span id="l10.51">     if (username.IsEmpty() || password.IsEmpty())</span>
<a href="#l10.52"></a><span id="l10.52">       return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l10.53"></a><span id="l10.53">   }</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  GetPassword(getter_Copies(password));</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  GetPassword(password);</span>
<a href="#l10.57"></a><span id="l10.57">   if (password.IsEmpty())</span>
<a href="#l10.58"></a><span id="l10.58">   {</span>
<a href="#l10.59"></a><span id="l10.59">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l10.60"></a><span id="l10.60">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l10.61"></a><span id="l10.61">   }</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">   if (TestFlag(SMTP_AUTH_CRAM_MD5_ENABLED))</span>
<a href="#l10.64"></a><span id="l10.64">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH CRAM-MD5&quot; CRLF);</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineat">@@ -1225,17 +1233,17 @@ PRInt32 nsSmtpProtocol::AuthLoginStep2()</span>
<a href="#l10.66"></a><span id="l10.66">   * if not then use cached pop password</span>
<a href="#l10.67"></a><span id="l10.67">   * if pop password undefined</span>
<a href="#l10.68"></a><span id="l10.68">   * sync with smtp password</span>
<a href="#l10.69"></a><span id="l10.69">   */</span>
<a href="#l10.70"></a><span id="l10.70">   PRInt32 status = 0;</span>
<a href="#l10.71"></a><span id="l10.71">   nsresult rv;</span>
<a href="#l10.72"></a><span id="l10.72">   nsCAutoString password;</span>
<a href="#l10.73"></a><span id="l10.73"> </span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-  GetPassword(getter_Copies(password));</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  GetPassword(password);</span>
<a href="#l10.76"></a><span id="l10.76">   if (password.IsEmpty())</span>
<a href="#l10.77"></a><span id="l10.77">   {</span>
<a href="#l10.78"></a><span id="l10.78">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l10.79"></a><span id="l10.79">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l10.80"></a><span id="l10.80">   }</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82">   if (!password.IsEmpty())</span>
<a href="#l10.83"></a><span id="l10.83">   {</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineat">@@ -1489,31 +1497,29 @@ PRInt32 nsSmtpProtocol::SendDataResponse</span>
<a href="#l10.85"></a><span id="l10.85"> </span>
<a href="#l10.86"></a><span id="l10.86">   if (m_responseCode != 354)</span>
<a href="#l10.87"></a><span id="l10.87">   {</span>
<a href="#l10.88"></a><span id="l10.88">     nsresult rv = nsExplainErrorDetails(m_runningURL, NS_ERROR_SENDING_DATA_COMMAND, m_responseText.get());</span>
<a href="#l10.89"></a><span id="l10.89">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l10.90"></a><span id="l10.90"> </span>
<a href="#l10.91"></a><span id="l10.91">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l10.92"></a><span id="l10.92">     return(NS_ERROR_SENDING_DATA_COMMAND);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-    }</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+  }</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-    PR_FREEIF(command);</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+  PR_FREEIF(command);</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    m_nextState = SMTP_SEND_POST_DATA;</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    ClearFlag(SMTP_PAUSE_FOR_READ);   /* send data directly */</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+  m_nextState = SMTP_SEND_POST_DATA;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+  ClearFlag(SMTP_PAUSE_FOR_READ);   /* send data directly */</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-    UpdateStatus(SMTP_DELIV_MAIL);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+  UpdateStatus(SMTP_DELIV_MAIL);</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-    {</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+  {</span>
<a href="#l10.109"></a><span id="l10.109"> //      m_runningURL-&gt;GetBodySize(&amp;m_totalMessageSize);</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-    }</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-    return(status);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  }</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+  return(status);</span>
<a href="#l10.116"></a><span id="l10.116"> }</span>
<a href="#l10.117"></a><span id="l10.117"> </span>
<a href="#l10.118"></a><span id="l10.118"> PRInt32 nsSmtpProtocol::SendMessageInFile()</span>
<a href="#l10.119"></a><span id="l10.119"> {</span>
<a href="#l10.120"></a><span id="l10.120">   nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l10.121"></a><span id="l10.121">   nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l10.122"></a><span id="l10.122">   m_runningURL-&gt;GetPostMessageFile(getter_AddRefs(file));</span>
<a href="#l10.123"></a><span id="l10.123">   if (url &amp;&amp; file)</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineat">@@ -1571,25 +1577,29 @@ PRInt32 nsSmtpProtocol::SendMessageRespo</span>
<a href="#l10.125"></a><span id="l10.125">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l10.126"></a><span id="l10.126"> </span>
<a href="#l10.127"></a><span id="l10.127">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l10.128"></a><span id="l10.128">     return(NS_ERROR_SENDING_MESSAGE);</span>
<a href="#l10.129"></a><span id="l10.129">   }</span>
<a href="#l10.130"></a><span id="l10.130"> </span>
<a href="#l10.131"></a><span id="l10.131">   UpdateStatus(SMTP_PROGRESS_MAILSENT);</span>
<a href="#l10.132"></a><span id="l10.132"> </span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-    /* else */</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-    m_sendDone = PR_TRUE;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-       SendData(url, &quot;QUIT&quot;CRLF); // send a quit command to close the connection with the server.</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-    m_nextState = SMTP_RESPONSE;</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-    m_nextStateAfterResponse = SMTP_DONE;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-    return(0);</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  /* else */</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+  return SendQuit();</span>
<a href="#l10.142"></a><span id="l10.142"> }</span>
<a href="#l10.143"></a><span id="l10.143"> </span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+PRInt32 nsSmtpProtocol::SendQuit()</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+{</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+  m_sendDone = PR_TRUE;</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+  SendData(url, &quot;QUIT&quot;CRLF); // send a quit command to close the connection with the server.</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+  m_nextState = SMTP_RESPONSE;</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+  m_nextStateAfterResponse = SMTP_DONE;</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+  return(0);</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+}</span>
<a href="#l10.153"></a><span id="l10.153"> </span>
<a href="#l10.154"></a><span id="l10.154"> nsresult nsSmtpProtocol::LoadUrl(nsIURI * aURL, nsISupports * aConsumer )</span>
<a href="#l10.155"></a><span id="l10.155"> {</span>
<a href="#l10.156"></a><span id="l10.156">   nsresult rv = NS_OK;</span>
<a href="#l10.157"></a><span id="l10.157"> </span>
<a href="#l10.158"></a><span id="l10.158">   PRInt32 status = 0;</span>
<a href="#l10.159"></a><span id="l10.159"> 	m_continuationResponse = -1;  /* init */</span>
<a href="#l10.160"></a><span id="l10.160"> 	if (aURL)</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineat">@@ -1850,38 +1860,33 @@ nsresult nsSmtpProtocol::LoadUrl(nsIURI </span>
<a href="#l10.162"></a><span id="l10.162">     }</span>
<a href="#l10.163"></a><span id="l10.163">     }</span>
<a href="#l10.164"></a><span id="l10.164">   } /* while(!SMTP_PAUSE_FOR_READ) */</span>
<a href="#l10.165"></a><span id="l10.165"> </span>
<a href="#l10.166"></a><span id="l10.166">   return NS_OK;</span>
<a href="#l10.167"></a><span id="l10.167"> }</span>
<a href="#l10.168"></a><span id="l10.168"> </span>
<a href="#l10.169"></a><span id="l10.169"> nsresult</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-nsSmtpProtocol::GetPassword(char **aPassword)</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+nsSmtpProtocol::GetPassword(nsCString &amp;aPassword)</span>
<a href="#l10.172"></a><span id="l10.172"> {</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aPassword);</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-</span>
<a href="#l10.175"></a><span id="l10.175">     nsresult rv;</span>
<a href="#l10.176"></a><span id="l10.176">     nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l10.177"></a><span id="l10.177">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.178"></a><span id="l10.178"> </span>
<a href="#l10.179"></a><span id="l10.179">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l10.180"></a><span id="l10.180">     rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l10.181"></a><span id="l10.181">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.182"></a><span id="l10.182"> </span>
<a href="#l10.183"></a><span id="l10.183">     rv = smtpServer-&gt;GetPassword(aPassword);</span>
<a href="#l10.184"></a><span id="l10.184">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.185"></a><span id="l10.185"> </span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-    if (*aPassword &amp;&amp; **aPassword)</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+    if (!aPassword.IsEmpty())</span>
<a href="#l10.188"></a><span id="l10.188">         return rv;</span>
<a href="#l10.189"></a><span id="l10.189">     // empty password</span>
<a href="#l10.190"></a><span id="l10.190"> </span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-    NS_Free(*aPassword);</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-    *aPassword = nsnull;</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-</span>
<a href="#l10.194"></a><span id="l10.194">     nsCOMPtr &lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.195"></a><span id="l10.195">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.196"></a><span id="l10.196"> </span>
<a href="#l10.197"></a><span id="l10.197">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l10.198"></a><span id="l10.198">     rv = prefs-&gt;GetBranch(nsnull, getter_AddRefs(prefBranch));</span>
<a href="#l10.199"></a><span id="l10.199">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.200"></a><span id="l10.200"> </span>
<a href="#l10.201"></a><span id="l10.201">     nsCString username;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineat">@@ -1904,17 +1909,17 @@ nsSmtpProtocol::GetPassword(char **aPass</span>
<a href="#l10.203"></a><span id="l10.203">     formatStrings[1] = hostnameUTF16.get();</span>
<a href="#l10.204"></a><span id="l10.204"> </span>
<a href="#l10.205"></a><span id="l10.205">     rv = PromptForPassword(smtpServer, smtpUrl, formatStrings, aPassword);</span>
<a href="#l10.206"></a><span id="l10.206">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.207"></a><span id="l10.207">     return rv;</span>
<a href="#l10.208"></a><span id="l10.208"> }</span>
<a href="#l10.209"></a><span id="l10.209"> </span>
<a href="#l10.210"></a><span id="l10.210"> nsresult</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-nsSmtpProtocol::PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl, const PRUnichar **formatStrings, char **aPassword)</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+nsSmtpProtocol::PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl, const PRUnichar **formatStrings, nsACString &amp;aPassword)</span>
<a href="#l10.213"></a><span id="l10.213"> {</span>
<a href="#l10.214"></a><span id="l10.214">   nsresult rv;</span>
<a href="#l10.215"></a><span id="l10.215">   nsCOMPtr&lt;nsIStringBundleService&gt; stringService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l10.216"></a><span id="l10.216">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.217"></a><span id="l10.217"> </span>
<a href="#l10.218"></a><span id="l10.218">   nsCOMPtr&lt;nsIStringBundle&gt; composeStringBundle;</span>
<a href="#l10.219"></a><span id="l10.219">   rv = stringService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(composeStringBundle));</span>
<a href="#l10.220"></a><span id="l10.220">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineat">@@ -1940,47 +1945,46 @@ nsSmtpProtocol::PromptForPassword(nsISmt</span>
<a href="#l10.222"></a><span id="l10.222"> </span>
<a href="#l10.223"></a><span id="l10.223">   rv = aSmtpServer-&gt;GetPasswordWithUI(passwordPromptString.get(), passwordTitle.get(),</span>
<a href="#l10.224"></a><span id="l10.224">     netPrompt, aPassword);</span>
<a href="#l10.225"></a><span id="l10.225">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.226"></a><span id="l10.226">   return rv;</span>
<a href="#l10.227"></a><span id="l10.227"> }</span>
<a href="#l10.228"></a><span id="l10.228"> </span>
<a href="#l10.229"></a><span id="l10.229"> nsresult</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-nsSmtpProtocol::GetUsernamePassword(char **aUsername, char **aPassword)</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+nsSmtpProtocol::GetUsernamePassword(char **aUsername, nsACString &amp;aPassword)</span>
<a href="#l10.232"></a><span id="l10.232"> {</span>
<a href="#l10.233"></a><span id="l10.233">     NS_ENSURE_ARG_POINTER(aUsername);</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aPassword);</span>
<a href="#l10.235"></a><span id="l10.235"> </span>
<a href="#l10.236"></a><span id="l10.236">     nsresult rv;</span>
<a href="#l10.237"></a><span id="l10.237">     nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l10.238"></a><span id="l10.238">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.239"></a><span id="l10.239"> </span>
<a href="#l10.240"></a><span id="l10.240">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l10.241"></a><span id="l10.241">     rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l10.242"></a><span id="l10.242">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.243"></a><span id="l10.243"> </span>
<a href="#l10.244"></a><span id="l10.244">     rv = smtpServer-&gt;GetPassword(aPassword);</span>
<a href="#l10.245"></a><span id="l10.245">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.246"></a><span id="l10.246"> </span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-    if (*aPassword &amp;&amp; **aPassword) {</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+    if (!aPassword.IsEmpty())</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+    {</span>
<a href="#l10.250"></a><span id="l10.250">         rv = smtpServer-&gt;GetUsername(aUsername);</span>
<a href="#l10.251"></a><span id="l10.251">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.252"></a><span id="l10.252"> </span>
<a href="#l10.253"></a><span id="l10.253">         if (*aUsername &amp;&amp; **aUsername)</span>
<a href="#l10.254"></a><span id="l10.254">             return rv;</span>
<a href="#l10.255"></a><span id="l10.255"> </span>
<a href="#l10.256"></a><span id="l10.256">         // empty username</span>
<a href="#l10.257"></a><span id="l10.257">         NS_Free(*aUsername);</span>
<a href="#l10.258"></a><span id="l10.258">         *aUsername = 0;</span>
<a href="#l10.259"></a><span id="l10.259">     }</span>
<a href="#l10.260"></a><span id="l10.260">     // empty password</span>
<a href="#l10.261"></a><span id="l10.261"> </span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-    NS_Free(*aPassword);</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-    *aPassword = 0;</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+    aPassword.Truncate();</span>
<a href="#l10.265"></a><span id="l10.265"> </span>
<a href="#l10.266"></a><span id="l10.266">     nsCString hostname;</span>
<a href="#l10.267"></a><span id="l10.267">     rv = smtpServer-&gt;GetHostname(getter_Copies(hostname));</span>
<a href="#l10.268"></a><span id="l10.268">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.269"></a><span id="l10.269"> </span>
<a href="#l10.270"></a><span id="l10.270">     const PRUnichar *formatStrings[] =</span>
<a href="#l10.271"></a><span id="l10.271">     {</span>
<a href="#l10.272"></a><span id="l10.272">       NS_ConvertASCIItoUTF16(hostname).get(),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -211,16 +211,17 @@ private:</span>
<a href="#l11.4"></a><span id="l11.4">     //						designed to re-act to the current &quot;state&quot;. I've attempted to </span>
<a href="#l11.5"></a><span id="l11.5">     //						group them together based on functionality. </span>
<a href="#l11.6"></a><span id="l11.6">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">     PRInt32 SmtpResponse(nsIInputStream * inputStream, PRUint32 length); </span>
<a href="#l11.9"></a><span id="l11.9">     PRInt32 ExtensionLoginResponse(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l11.10"></a><span id="l11.10">     PRInt32 SendHeloResponse(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l11.11"></a><span id="l11.11">     PRInt32 SendEhloResponse(nsIInputStream * inputStream, PRUint32 length);	</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    PRInt32 SendQuit();</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14">     PRInt32 AuthGSSAPIFirst();</span>
<a href="#l11.15"></a><span id="l11.15">     PRInt32 AuthGSSAPIStep();</span>
<a href="#l11.16"></a><span id="l11.16">     PRInt32 AuthLoginStep0();</span>
<a href="#l11.17"></a><span id="l11.17">     PRInt32 AuthLoginStep0Response();</span>
<a href="#l11.18"></a><span id="l11.18">     PRInt32 AuthLoginStep1();</span>
<a href="#l11.19"></a><span id="l11.19">     PRInt32 AuthLoginStep2();</span>
<a href="#l11.20"></a><span id="l11.20">     PRInt32 AuthLoginResponse(nsIInputStream * stream, PRUint32 length);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -238,18 +239,20 @@ private:</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.24"></a><span id="l11.24">     // End of Protocol Methods</span>
<a href="#l11.25"></a><span id="l11.25">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27">     PRInt32 SendMessageInFile();</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29">     void AppendHelloArgument(nsACString&amp; aResult);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-    nsresult GetPassword(char **aPassword);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    nsresult GetUsernamePassword(char **aUsername, char **aPassword);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-    nsresult PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl, const PRUnichar **formatStrings, char **aPassword);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+    nsresult GetPassword(nsCString &amp;aPassword);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+    nsresult GetUsernamePassword(char **aUsername, nsACString &amp;aPassword);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+    nsresult PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl, </span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+                               const PRUnichar **formatStrings, </span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+                               nsACString &amp;aPassword);</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">     void BackupAuthFlags();</span>
<a href="#l11.40"></a><span id="l11.40">     void RestoreAuthFlags();</span>
<a href="#l11.41"></a><span id="l11.41">     PRInt32 m_origAuthFlags;</span>
<a href="#l11.42"></a><span id="l11.42"> };</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44"> #endif  // nsSmtpProtocol_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -31,29 +31,31 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.5"></a><span id="l12.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.6"></a><span id="l12.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.7"></a><span id="l12.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.8"></a><span id="l12.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.9"></a><span id="l12.9">  *</span>
<a href="#l12.10"></a><span id="l12.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;nsEscape.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> #include &quot;nsSmtpServer.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l12.20"></a><span id="l12.20"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l12.21"></a><span id="l12.21"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l12.22"></a><span id="l12.22"> #include &quot;nsISmtpUrl.h&quot;</span>
<a href="#l12.23"></a><span id="l12.23"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l12.24"></a><span id="l12.24"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l12.25"></a><span id="l12.25"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+#include &quot;nsISmtpService.h&quot;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+#include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29"> NS_IMPL_ADDREF(nsSmtpServer)</span>
<a href="#l12.30"></a><span id="l12.30"> NS_IMPL_RELEASE(nsSmtpServer)</span>
<a href="#l12.31"></a><span id="l12.31"> NS_INTERFACE_MAP_BEGIN(nsSmtpServer)</span>
<a href="#l12.32"></a><span id="l12.32">     NS_INTERFACE_MAP_ENTRY(nsISmtpServer)</span>
<a href="#l12.33"></a><span id="l12.33">     NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)</span>
<a href="#l12.34"></a><span id="l12.34">     NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsISmtpServer)</span>
<a href="#l12.35"></a><span id="l12.35"> NS_INTERFACE_MAP_END</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineat">@@ -312,19 +314,18 @@ nsSmtpServer::SetUsername(const char * a</span>
<a href="#l12.37"></a><span id="l12.37">     if (aUsername)</span>
<a href="#l12.38"></a><span id="l12.38">         return mPrefBranch-&gt;SetCharPref(&quot;username&quot;, aUsername);</span>
<a href="#l12.39"></a><span id="l12.39">     else</span>
<a href="#l12.40"></a><span id="l12.40">         mPrefBranch-&gt;ClearUserPref(&quot;username&quot;);</span>
<a href="#l12.41"></a><span id="l12.41">     return NS_OK;</span>
<a href="#l12.42"></a><span id="l12.42"> }</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44"> NS_IMETHODIMP</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-nsSmtpServer::GetPassword(char * *aPassword)</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+nsSmtpServer::GetPassword(nsACString&amp; aPassword)</span>
<a href="#l12.47"></a><span id="l12.47"> {</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aPassword);</span>
<a href="#l12.49"></a><span id="l12.49">     if (m_password.IsEmpty() &amp;&amp; !m_logonFailed)</span>
<a href="#l12.50"></a><span id="l12.50">     {</span>
<a href="#l12.51"></a><span id="l12.51">       // try to avoid prompting the user for another password. If the user has set</span>
<a href="#l12.52"></a><span id="l12.52">       // the appropriate pref, we'll use the password from an incoming server, if</span>
<a href="#l12.53"></a><span id="l12.53">       // the user has already logged onto that server.</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">       // if this is set, we'll only use this, and not the other prefs</span>
<a href="#l12.56"></a><span id="l12.56">       // user_pref(&quot;mail.smtpserver.smtp1.incomingAccount&quot;, &quot;server1&quot;);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineat">@@ -401,44 +402,46 @@ nsSmtpServer::GetPassword(char * *aPassw</span>
<a href="#l12.58"></a><span id="l12.58">                   }</span>
<a href="#l12.59"></a><span id="l12.59">                 }</span>
<a href="#l12.60"></a><span id="l12.60">               }</span>
<a href="#l12.61"></a><span id="l12.61">             }</span>
<a href="#l12.62"></a><span id="l12.62">           }</span>
<a href="#l12.63"></a><span id="l12.63">         }</span>
<a href="#l12.64"></a><span id="l12.64">       }</span>
<a href="#l12.65"></a><span id="l12.65">       if (incomingServerToUse)</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-      {</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-        nsCString tmpPassword;</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-        nsresult rv = incomingServerToUse-&gt;GetPassword(tmpPassword);</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-        *aPassword = ToNewCString(tmpPassword);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-        return rv;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-      }</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+        return incomingServerToUse-&gt;GetPassword(aPassword);</span>
<a href="#l12.73"></a><span id="l12.73">     }</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-    *aPassword = ToNewCString(m_password);</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+    aPassword = m_password;</span>
<a href="#l12.76"></a><span id="l12.76">     return NS_OK;</span>
<a href="#l12.77"></a><span id="l12.77"> }</span>
<a href="#l12.78"></a><span id="l12.78"> </span>
<a href="#l12.79"></a><span id="l12.79"> NS_IMETHODIMP</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-nsSmtpServer::SetPassword(const char * aPassword)</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+nsSmtpServer::VerifyLogon(nsIUrlListener *aUrlListener)</span>
<a href="#l12.82"></a><span id="l12.82"> {</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-    m_password = aPassword;</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  nsresult rv;</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  return smtpService-&gt;VerifyLogon(this, aUrlListener);</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+}</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+nsSmtpServer::SetPassword(const nsACString&amp; aPassword)</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+{</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+  m_password = aPassword;</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.97"></a><span id="l12.97"> }</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99"> NS_IMETHODIMP</span>
<a href="#l12.100"></a><span id="l12.100"> nsSmtpServer::GetPasswordWithUI(const PRUnichar * aPromptMessage, const</span>
<a href="#l12.101"></a><span id="l12.101">                                 PRUnichar *aPromptTitle,</span>
<a href="#l12.102"></a><span id="l12.102">                                 nsIAuthPrompt* aDialog,</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-                                char **aPassword)</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+                                nsACString &amp;aPassword)</span>
<a href="#l12.105"></a><span id="l12.105"> {</span>
<a href="#l12.106"></a><span id="l12.106">     nsresult rv = NS_OK;</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aPassword);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-</span>
<a href="#l12.110"></a><span id="l12.110">     if (m_password.IsEmpty())</span>
<a href="#l12.111"></a><span id="l12.111">     {</span>
<a href="#l12.112"></a><span id="l12.112">         NS_ENSURE_ARG_POINTER(aDialog);</span>
<a href="#l12.113"></a><span id="l12.113"> </span>
<a href="#l12.114"></a><span id="l12.114">         // prompt the user for the password</span>
<a href="#l12.115"></a><span id="l12.115">         if (NS_SUCCEEDED(rv))</span>
<a href="#l12.116"></a><span id="l12.116">         {</span>
<a href="#l12.117"></a><span id="l12.117">             nsString uniPassword;</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineat">@@ -456,44 +459,42 @@ nsSmtpServer::GetPasswordWithUI(const PR</span>
<a href="#l12.119"></a><span id="l12.119">             rv = aDialog-&gt;PromptPassword(aPromptTitle, aPromptMessage,</span>
<a href="#l12.120"></a><span id="l12.120">                     NS_ConvertASCIItoUTF16(serverUri).get(), savePasswordType,</span>
<a href="#l12.121"></a><span id="l12.121">                     getter_Copies(uniPassword), &amp;okayValue);</span>
<a href="#l12.122"></a><span id="l12.122">             if (NS_FAILED(rv))</span>
<a href="#l12.123"></a><span id="l12.123">                 return rv;</span>
<a href="#l12.124"></a><span id="l12.124"> </span>
<a href="#l12.125"></a><span id="l12.125">             if (!okayValue) // if the user pressed cancel, just return NULL;</span>
<a href="#l12.126"></a><span id="l12.126">             {</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-                *aPassword = nsnull;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+                aPassword.Truncate();</span>
<a href="#l12.129"></a><span id="l12.129">                 return rv;</span>
<a href="#l12.130"></a><span id="l12.130">             }</span>
<a href="#l12.131"></a><span id="l12.131"> </span>
<a href="#l12.132"></a><span id="l12.132">             // we got a password back...so remember it</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-            nsCString aCStr; LossyCopyUTF16toASCII(uniPassword, aCStr);</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+            nsCString aCStr;</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+            LossyCopyUTF16toASCII(uniPassword, aCStr);</span>
<a href="#l12.136"></a><span id="l12.136"> </span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-            rv = SetPassword(aCStr.get());</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+            rv = SetPassword(aCStr);</span>
<a href="#l12.139"></a><span id="l12.139">             if (NS_FAILED(rv))</span>
<a href="#l12.140"></a><span id="l12.140">                 return rv;</span>
<a href="#l12.141"></a><span id="l12.141">         } // if we got a prompt dialog</span>
<a href="#l12.142"></a><span id="l12.142">     } // if the password is empty</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-    rv = GetPassword(aPassword);</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-    return rv;</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+    return GetPassword(aPassword);</span>
<a href="#l12.147"></a><span id="l12.147"> }</span>
<a href="#l12.148"></a><span id="l12.148"> </span>
<a href="#l12.149"></a><span id="l12.149"> NS_IMETHODIMP</span>
<a href="#l12.150"></a><span id="l12.150"> nsSmtpServer::GetUsernamePasswordWithUI(const PRUnichar * aPromptMessage, const</span>
<a href="#l12.151"></a><span id="l12.151">                                 PRUnichar *aPromptTitle,</span>
<a href="#l12.152"></a><span id="l12.152">                                 nsIAuthPrompt* aDialog,</span>
<a href="#l12.153"></a><span id="l12.153">                                 char **aUsername,</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-                                char **aPassword)</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+                                nsACString &amp;aPassword)</span>
<a href="#l12.156"></a><span id="l12.156"> {</span>
<a href="#l12.157"></a><span id="l12.157">     nsresult rv = NS_OK;</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-</span>
<a href="#l12.159"></a><span id="l12.159">     NS_ENSURE_ARG_POINTER(aUsername);</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aPassword);</span>
<a href="#l12.161"></a><span id="l12.161"> </span>
<a href="#l12.162"></a><span id="l12.162">     if (m_password.IsEmpty()) {</span>
<a href="#l12.163"></a><span id="l12.163">         NS_ENSURE_ARG_POINTER(aDialog);</span>
<a href="#l12.164"></a><span id="l12.164">         // prompt the user for the password</span>
<a href="#l12.165"></a><span id="l12.165">         if (NS_SUCCEEDED(rv))</span>
<a href="#l12.166"></a><span id="l12.166">         {</span>
<a href="#l12.167"></a><span id="l12.167">             nsString uniUsername;</span>
<a href="#l12.168"></a><span id="l12.168">             nsString uniPassword;</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineat">@@ -506,40 +507,39 @@ nsSmtpServer::GetUsernamePasswordWithUI(</span>
<a href="#l12.170"></a><span id="l12.170">                                          NS_ConvertASCIItoUTF16(serverUri).get(), nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l12.171"></a><span id="l12.171">                                          getter_Copies(uniUsername), getter_Copies(uniPassword), &amp;okayValue);</span>
<a href="#l12.172"></a><span id="l12.172">             if (NS_FAILED(rv))</span>
<a href="#l12.173"></a><span id="l12.173">                 return rv;</span>
<a href="#l12.174"></a><span id="l12.174"> </span>
<a href="#l12.175"></a><span id="l12.175">             if (!okayValue) // if the user pressed cancel, just return NULL;</span>
<a href="#l12.176"></a><span id="l12.176">             {</span>
<a href="#l12.177"></a><span id="l12.177">                 *aUsername = nsnull;</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineminus">-                *aPassword = nsnull;</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+                aPassword.Truncate();</span>
<a href="#l12.180"></a><span id="l12.180">                 return rv;</span>
<a href="#l12.181"></a><span id="l12.181">             }</span>
<a href="#l12.182"></a><span id="l12.182"> </span>
<a href="#l12.183"></a><span id="l12.183">             // we got a userid and password back...so remember it</span>
<a href="#l12.184"></a><span id="l12.184">             nsCString aCStr;</span>
<a href="#l12.185"></a><span id="l12.185"> </span>
<a href="#l12.186"></a><span id="l12.186">             LossyCopyUTF16toASCII(uniUsername, aCStr);</span>
<a href="#l12.187"></a><span id="l12.187">             rv = SetUsername(aCStr.get());</span>
<a href="#l12.188"></a><span id="l12.188">             if (NS_FAILED(rv))</span>
<a href="#l12.189"></a><span id="l12.189">                 return rv;</span>
<a href="#l12.190"></a><span id="l12.190"> </span>
<a href="#l12.191"></a><span id="l12.191">             LossyCopyUTF16toASCII(uniPassword, aCStr);</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-            rv = SetPassword(aCStr.get());</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+            rv = SetPassword(aCStr);</span>
<a href="#l12.194"></a><span id="l12.194">             if (NS_FAILED(rv))</span>
<a href="#l12.195"></a><span id="l12.195">                 return rv;</span>
<a href="#l12.196"></a><span id="l12.196">         } // if we got a prompt dialog</span>
<a href="#l12.197"></a><span id="l12.197">     } // if the password is empty</span>
<a href="#l12.198"></a><span id="l12.198"> </span>
<a href="#l12.199"></a><span id="l12.199">     rv = GetUsername(aUsername);</span>
<a href="#l12.200"></a><span id="l12.200">     if (NS_FAILED(rv))</span>
<a href="#l12.201"></a><span id="l12.201">         return rv;</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-    rv = GetPassword(aPassword);</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-    return rv;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+    return GetPassword(aPassword);</span>
<a href="#l12.205"></a><span id="l12.205"> }</span>
<a href="#l12.206"></a><span id="l12.206"> </span>
<a href="#l12.207"></a><span id="l12.207"> NS_IMETHODIMP</span>
<a href="#l12.208"></a><span id="l12.208"> nsSmtpServer::ForgetPassword()</span>
<a href="#l12.209"></a><span id="l12.209"> {</span>
<a href="#l12.210"></a><span id="l12.210">     nsresult rv;</span>
<a href="#l12.211"></a><span id="l12.211">     nsCOMPtr&lt;nsIObserverService&gt; observerService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l12.212"></a><span id="l12.212">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineat">@@ -554,17 +554,17 @@ nsSmtpServer::ForgetPassword()</span>
<a href="#l12.214"></a><span id="l12.214"> </span>
<a href="#l12.215"></a><span id="l12.215">     //this is need to make sure wallet service has been created</span>
<a href="#l12.216"></a><span id="l12.216">     rv = CreateServicesForPasswordManager();</span>
<a href="#l12.217"></a><span id="l12.217">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.218"></a><span id="l12.218"> </span>
<a href="#l12.219"></a><span id="l12.219">     rv = observerService-&gt;NotifyObservers(uri, &quot;login-failed&quot;, nsnull);</span>
<a href="#l12.220"></a><span id="l12.220">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.221"></a><span id="l12.221"> </span>
<a href="#l12.222"></a><span id="l12.222" class="difflineminus">-    rv = SetPassword(&quot;&quot;);</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+    rv = SetPassword(EmptyCString());</span>
<a href="#l12.224"></a><span id="l12.224">     m_logonFailed = PR_TRUE;</span>
<a href="#l12.225"></a><span id="l12.225">     return rv;</span>
<a href="#l12.226"></a><span id="l12.226"> }</span>
<a href="#l12.227"></a><span id="l12.227"> </span>
<a href="#l12.228"></a><span id="l12.228"> NS_IMETHODIMP</span>
<a href="#l12.229"></a><span id="l12.229"> nsSmtpServer::GetServerURI(char **aResult)</span>
<a href="#l12.230"></a><span id="l12.230"> {</span>
<a href="#l12.231"></a><span id="l12.231">     NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineat">@@ -574,19 +574,17 @@ nsSmtpServer::GetServerURI(char **aResul</span>
<a href="#l12.233"></a><span id="l12.233">     uri += &quot;smtp&quot;;</span>
<a href="#l12.234"></a><span id="l12.234">     uri += &quot;://&quot;;</span>
<a href="#l12.235"></a><span id="l12.235"> </span>
<a href="#l12.236"></a><span id="l12.236">     nsCString username;</span>
<a href="#l12.237"></a><span id="l12.237">     rv = GetUsername(getter_Copies(username));</span>
<a href="#l12.238"></a><span id="l12.238"> </span>
<a href="#l12.239"></a><span id="l12.239">     if (NS_SUCCEEDED(rv) &amp;&amp; !username.IsEmpty()) {</span>
<a href="#l12.240"></a><span id="l12.240">         nsCString escapedUsername;</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-        *((char **)getter_Copies(escapedUsername)) =</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-            nsEscape(username.get(), url_XAlphas);</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-//            nsEscape(username, url_Path);</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+        MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l12.245"></a><span id="l12.245">         // not all servers have a username</span>
<a href="#l12.246"></a><span id="l12.246">         uri.Append(escapedUsername);</span>
<a href="#l12.247"></a><span id="l12.247">         uri += '@';</span>
<a href="#l12.248"></a><span id="l12.248">     }</span>
<a href="#l12.249"></a><span id="l12.249"> </span>
<a href="#l12.250"></a><span id="l12.250">     nsCString hostname;</span>
<a href="#l12.251"></a><span id="l12.251">     rv = GetHostname(getter_Copies(hostname));</span>
<a href="#l12.252"></a><span id="l12.252"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -82,19 +82,17 @@ typedef struct _findServerByHostnameEntr</span>
<a href="#l13.4"></a><span id="l13.4"> } findServerByHostnameEntry;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> static NS_DEFINE_CID(kCSmtpUrlCID, NS_SMTPURL_CID);</span>
<a href="#l13.7"></a><span id="l13.7"> static NS_DEFINE_CID(kCMailtoUrlCID, NS_MAILTOURL_CID);</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> // foward declarations...</span>
<a href="#l13.10"></a><span id="l13.10"> nsresult</span>
<a href="#l13.11"></a><span id="l13.11"> NS_MsgBuildSmtpUrl(nsIFile * aFilePath,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-                   const nsCString &amp;aSmtpHostName, </span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                   PRInt32 aSmtpPort,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-                   const nsCString &amp;aSmtpUserName, </span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+                   nsISmtpServer *aServer,</span>
<a href="#l13.16"></a><span id="l13.16">                    const char* aRecipients, </span>
<a href="#l13.17"></a><span id="l13.17">                    nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l13.18"></a><span id="l13.18">                    nsIUrlListener * aUrlListener,</span>
<a href="#l13.19"></a><span id="l13.19">                    nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l13.20"></a><span id="l13.20">                    nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l13.21"></a><span id="l13.21">                    nsIURI ** aUrl,</span>
<a href="#l13.22"></a><span id="l13.22">                    PRBool aRequestDSN);</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24" class="difflineat">@@ -109,17 +107,17 @@ nsSmtpService::~nsSmtpService()</span>
<a href="#l13.25"></a><span id="l13.25"> {</span>
<a href="#l13.26"></a><span id="l13.26">     // save the SMTP servers to disk</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> }</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30"> NS_IMPL_ISUPPORTS2(nsSmtpService, nsISmtpService, nsIProtocolHandler)</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-nsresult nsSmtpService::SendMailMessage(nsIFile * aFilePath,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+NS_IMETHODIMP nsSmtpService::SendMailMessage(nsIFile * aFilePath,</span>
<a href="#l13.35"></a><span id="l13.35">                                         const char * aRecipients, </span>
<a href="#l13.36"></a><span id="l13.36">                                         nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l13.37"></a><span id="l13.37">                                         const char * aPassword,</span>
<a href="#l13.38"></a><span id="l13.38">                                         nsIUrlListener * aUrlListener, </span>
<a href="#l13.39"></a><span id="l13.39">                                         nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l13.40"></a><span id="l13.40">                                         nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l13.41"></a><span id="l13.41">                                         PRBool aRequestDSN,</span>
<a href="#l13.42"></a><span id="l13.42">                                         nsIURI ** aURL,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineat">@@ -129,48 +127,25 @@ nsresult nsSmtpService::SendMailMessage(</span>
<a href="#l13.44"></a><span id="l13.44">   nsresult rv = NS_OK;</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l13.47"></a><span id="l13.47">   rv = GetSmtpServerByIdentity(aSenderIdentity, getter_AddRefs(smtpServer));</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer)</span>
<a href="#l13.50"></a><span id="l13.50">   {</span>
<a href="#l13.51"></a><span id="l13.51">     if (aPassword &amp;&amp; *aPassword)</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-      smtpServer-&gt;SetPassword(aPassword);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-    nsCString smtpHostName;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-    nsCString smtpUserName;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-    PRInt32 smtpPort;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    PRInt32 trySSL;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-    smtpServer-&gt;GetHostname(getter_Copies(smtpHostName));</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-    smtpServer-&gt;GetUsername(getter_Copies(smtpUserName));</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-    smtpServer-&gt;GetPort(&amp;smtpPort);</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-    smtpServer-&gt;GetTrySSL(&amp;trySSL);</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+      smtpServer-&gt;SetPassword(nsDependentCString(aPassword));</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-    if (smtpPort == 0)</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+    if (!CHECK_SIMULATED_ERROR(SIMULATED_SEND_ERROR_10)) </span>
<a href="#l13.67"></a><span id="l13.67">     {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-        if (trySSL == PREF_SECURE_ALWAYS_SMTPS)</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-            smtpPort = nsISmtpUrl::DEFAULT_SMTPS_PORT;</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-        else</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-            smtpPort = nsISmtpUrl::DEFAULT_SMTP_PORT;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-    }</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-    if (!smtpHostName.IsEmpty() &amp;&amp; !CHECK_SIMULATED_ERROR(SIMULATED_SEND_ERROR_10)) </span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-    {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-      rv = NS_MsgBuildSmtpUrl(aFilePath, smtpHostName, smtpPort, smtpUserName,</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+      rv = NS_MsgBuildSmtpUrl(aFilePath, smtpServer,</span>
<a href="#l13.78"></a><span id="l13.78">                               aRecipients, aSenderIdentity, aUrlListener, aStatusFeedback, </span>
<a href="#l13.79"></a><span id="l13.79">                               aNotificationCallbacks, &amp;urlToRun, aRequestDSN); // this ref counts urlToRun</span>
<a href="#l13.80"></a><span id="l13.80">       if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun)	</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-      {</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-        nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(urlToRun, &amp;rv);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-            smtpUrl-&gt;SetSmtpServer(smtpServer);</span>
<a href="#l13.85"></a><span id="l13.85">         rv = NS_MsgLoadSmtpUrl(urlToRun, nsnull, aRequest);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-      }</span>
<a href="#l13.87"></a><span id="l13.87"> </span>
<a href="#l13.88"></a><span id="l13.88">       if (aURL) // does the caller want a handle on the url?</span>
<a href="#l13.89"></a><span id="l13.89">         *aURL = urlToRun; // transfer our ref count to the caller....</span>
<a href="#l13.90"></a><span id="l13.90">       else</span>
<a href="#l13.91"></a><span id="l13.91">         NS_IF_RELEASE(urlToRun);</span>
<a href="#l13.92"></a><span id="l13.92">     }</span>
<a href="#l13.93"></a><span id="l13.93">     else</span>
<a href="#l13.94"></a><span id="l13.94">       rv = NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER;</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineat">@@ -179,63 +154,76 @@ nsresult nsSmtpService::SendMailMessage(</span>
<a href="#l13.96"></a><span id="l13.96">   return rv;</span>
<a href="#l13.97"></a><span id="l13.97"> }</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99"> </span>
<a href="#l13.100"></a><span id="l13.100"> // The following are two convience functions I'm using to help expedite building and running a mail to url...</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102"> // short cut function for creating a mailto url...</span>
<a href="#l13.103"></a><span id="l13.103"> nsresult NS_MsgBuildSmtpUrl(nsIFile * aFilePath,</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-                            const nsCString &amp;aSmtpHostName,</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-                            PRInt32 aSmtpPort,</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-                            const nsCString &amp;aSmtpUserName,</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+                            nsISmtpServer *aSmtpServer,</span>
<a href="#l13.108"></a><span id="l13.108">                             const char * aRecipients, </span>
<a href="#l13.109"></a><span id="l13.109">                             nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l13.110"></a><span id="l13.110">                             nsIUrlListener * aUrlListener, </span>
<a href="#l13.111"></a><span id="l13.111">                             nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l13.112"></a><span id="l13.112">                             nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l13.113"></a><span id="l13.113">                             nsIURI ** aUrl,</span>
<a href="#l13.114"></a><span id="l13.114">                             PRBool aRequestDSN)</span>
<a href="#l13.115"></a><span id="l13.115"> {</span>
<a href="#l13.116"></a><span id="l13.116">   // mscott: this function is a convience hack until netlib actually dispatches</span>
<a href="#l13.117"></a><span id="l13.117">   // smtp urls. in addition until we have a session to get a password, host and</span>
<a href="#l13.118"></a><span id="l13.118">   // other stuff from, we need to use default values....</span>
<a href="#l13.119"></a><span id="l13.119">   // ..for testing purposes....</span>
<a href="#l13.120"></a><span id="l13.120"> </span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+    nsCString smtpHostName;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+    nsCString smtpUserName;</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+    PRInt32 smtpPort;</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+    PRInt32 trySSL;</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+    aSmtpServer-&gt;GetHostname(getter_Copies(smtpHostName));</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+    aSmtpServer-&gt;GetUsername(getter_Copies(smtpUserName));</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+    aSmtpServer-&gt;GetPort(&amp;smtpPort);</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+    aSmtpServer-&gt;GetTrySSL(&amp;trySSL);</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+    if (!smtpPort)</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+      smtpPort = (trySSL == PREF_SECURE_ALWAYS_SMTPS) ? </span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+        nsISmtpUrl::DEFAULT_SMTPS_PORT :  nsISmtpUrl::DEFAULT_SMTP_PORT;</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+</span>
<a href="#l13.135"></a><span id="l13.135">   nsresult rv;</span>
<a href="#l13.136"></a><span id="l13.136">   nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_CreateInstance(kCSmtpUrlCID, &amp;rv));</span>
<a href="#l13.137"></a><span id="l13.137">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.138"></a><span id="l13.138"> </span>
<a href="#l13.139"></a><span id="l13.139">   nsCAutoString urlSpec(&quot;smtp://&quot;);</span>
<a href="#l13.140"></a><span id="l13.140"> </span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-  if (!aSmtpUserName.IsEmpty())</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+  if (!smtpUserName.IsEmpty())</span>
<a href="#l13.143"></a><span id="l13.143">   {</span>
<a href="#l13.144"></a><span id="l13.144">     nsCString escapedUsername;</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-    MsgEscapeString(aSmtpUserName, nsINetUtil::ESCAPE_XALPHAS,</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+    MsgEscapeString(smtpUserName, nsINetUtil::ESCAPE_XALPHAS,</span>
<a href="#l13.147"></a><span id="l13.147">                     escapedUsername);</span>
<a href="#l13.148"></a><span id="l13.148">     urlSpec.Append(escapedUsername);</span>
<a href="#l13.149"></a><span id="l13.149">     urlSpec.Append('@');</span>
<a href="#l13.150"></a><span id="l13.150">   }</span>
<a href="#l13.151"></a><span id="l13.151"> </span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-  urlSpec.Append(aSmtpHostName);</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-  if (aSmtpHostName.FindChar(':') == -1)</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+  urlSpec.Append(smtpHostName);</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+  if (smtpHostName.FindChar(':') == -1)</span>
<a href="#l13.156"></a><span id="l13.156">   {</span>
<a href="#l13.157"></a><span id="l13.157">     urlSpec.Append(':');</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-    urlSpec.AppendInt(aSmtpPort);</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+    urlSpec.AppendInt(smtpPort);</span>
<a href="#l13.160"></a><span id="l13.160">   }</span>
<a href="#l13.161"></a><span id="l13.161"> </span>
<a href="#l13.162"></a><span id="l13.162">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url(do_QueryInterface(smtpUrl, &amp;rv));</span>
<a href="#l13.163"></a><span id="l13.163">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.164"></a><span id="l13.164"> </span>
<a href="#l13.165"></a><span id="l13.165">   url-&gt;SetSpec(urlSpec);</span>
<a href="#l13.166"></a><span id="l13.166">   smtpUrl-&gt;SetRecipients(aRecipients);</span>
<a href="#l13.167"></a><span id="l13.167">   smtpUrl-&gt;SetRequestDSN(aRequestDSN);</span>
<a href="#l13.168"></a><span id="l13.168">   smtpUrl-&gt;SetPostMessageFile(aFilePath);</span>
<a href="#l13.169"></a><span id="l13.169">   smtpUrl-&gt;SetSenderIdentity(aSenderIdentity);</span>
<a href="#l13.170"></a><span id="l13.170">   smtpUrl-&gt;SetNotificationCallbacks(aNotificationCallbacks);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+  smtpUrl-&gt;SetSmtpServer(aSmtpServer);</span>
<a href="#l13.172"></a><span id="l13.172"> </span>
<a href="#l13.173"></a><span id="l13.173">   nsCOMPtr&lt;nsIPrompt&gt; smtpPrompt(do_GetInterface(aNotificationCallbacks));</span>
<a href="#l13.174"></a><span id="l13.174">   nsCOMPtr&lt;nsIAuthPrompt&gt; smtpAuthPrompt(do_GetInterface(aNotificationCallbacks));</span>
<a href="#l13.175"></a><span id="l13.175">   if (!smtpPrompt || !smtpAuthPrompt)</span>
<a href="#l13.176"></a><span id="l13.176">   {</span>
<a href="#l13.177"></a><span id="l13.177">     nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l13.178"></a><span id="l13.178">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.179"></a><span id="l13.179"> </span>
<a href="#l13.180"></a><span id="l13.180" class="difflineat">@@ -278,16 +266,32 @@ nsresult NS_MsgLoadSmtpUrl(nsIURI * aUrl</span>
<a href="#l13.181"></a><span id="l13.181">         rv = smtpProtocol-&gt;LoadUrl(aUrl, aConsumer); // protocol will get destroyed when url is completed...</span>
<a href="#l13.182"></a><span id="l13.182">         smtpProtocol-&gt;QueryInterface(NS_GET_IID(nsIRequest), (void **) aRequest);</span>
<a href="#l13.183"></a><span id="l13.183">         NS_RELEASE(smtpProtocol);</span>
<a href="#l13.184"></a><span id="l13.184">     }</span>
<a href="#l13.185"></a><span id="l13.185"> </span>
<a href="#l13.186"></a><span id="l13.186">     return rv;</span>
<a href="#l13.187"></a><span id="l13.187"> }</span>
<a href="#l13.188"></a><span id="l13.188"> </span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+NS_IMETHODIMP nsSmtpService::VerifyLogon(nsISmtpServer *aServer,</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+                                         nsIUrlListener *aUrlListener)</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+{</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+  nsCString popHost;</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+  nsCString popUser;</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+  nsCOMPtr &lt;nsIURI&gt; urlToRun;</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+  nsresult rv = NS_MsgBuildSmtpUrl(nsnull, aServer,</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+                          nsnull, nsnull, aUrlListener, nsnull, </span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+                          nsnull , getter_AddRefs(urlToRun), PR_FALSE);</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun)	</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+    rv = NS_MsgLoadSmtpUrl(urlToRun, nsnull, nsnull /* aRequest */);</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+  return rv;</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+}</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+</span>
<a href="#l13.205"></a><span id="l13.205"> NS_IMETHODIMP nsSmtpService::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l13.206"></a><span id="l13.206"> {</span>
<a href="#l13.207"></a><span id="l13.207">     aScheme = &quot;mailto&quot;;</span>
<a href="#l13.208"></a><span id="l13.208">     return NS_OK; </span>
<a href="#l13.209"></a><span id="l13.209"> }</span>
<a href="#l13.210"></a><span id="l13.210"> </span>
<a href="#l13.211"></a><span id="l13.211"> NS_IMETHODIMP nsSmtpService::GetDefaultPort(PRInt32 *aDefaultPort)</span>
<a href="#l13.212"></a><span id="l13.212"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -308,17 +308,17 @@ nsresult nsMailtoUrl::ParseMailtoUrl(cha</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5">   return NS_OK;</span>
<a href="#l14.6"></a><span id="l14.6"> }</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> NS_IMETHODIMP nsMailtoUrl::SetSpec(const nsACString &amp;aSpec)</span>
<a href="#l14.10"></a><span id="l14.10"> {</span>
<a href="#l14.11"></a><span id="l14.11">   m_baseURL-&gt;SetSpec(aSpec);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-	return ParseUrl();</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  return ParseUrl();</span>
<a href="#l14.14"></a><span id="l14.14"> }</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> nsresult nsMailtoUrl::CleanupMailtoState()</span>
<a href="#l14.17"></a><span id="l14.17"> {</span>
<a href="#l14.18"></a><span id="l14.18">     m_ccPart = &quot;&quot;;</span>
<a href="#l14.19"></a><span id="l14.19">     m_subjectPart = &quot;&quot;;</span>
<a href="#l14.20"></a><span id="l14.20">     m_newsgroupPart = &quot;&quot;;</span>
<a href="#l14.21"></a><span id="l14.21">     m_newsHostPart = &quot;&quot;; </span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -576,16 +576,17 @@ NS_IMETHODIMP nsMailtoUrl::Resolve(const</span>
<a href="#l14.23"></a><span id="l14.23"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25"> nsSmtpUrl::nsSmtpUrl() : nsMsgMailNewsUrl()</span>
<a href="#l14.26"></a><span id="l14.26"> {</span>
<a href="#l14.27"></a><span id="l14.27">   // nsISmtpUrl specific state...</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">   m_isPostMessage = PR_TRUE;</span>
<a href="#l14.30"></a><span id="l14.30">   m_requestDSN = PR_FALSE;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  m_verifyLogon = PR_FALSE;</span>
<a href="#l14.32"></a><span id="l14.32"> }</span>
<a href="#l14.33"></a><span id="l14.33">  </span>
<a href="#l14.34"></a><span id="l14.34"> nsSmtpUrl::~nsSmtpUrl()</span>
<a href="#l14.35"></a><span id="l14.35"> {</span>
<a href="#l14.36"></a><span id="l14.36"> }</span>
<a href="#l14.37"></a><span id="l14.37">   </span>
<a href="#l14.38"></a><span id="l14.38"> NS_IMPL_ISUPPORTS_INHERITED1(nsSmtpUrl, nsMsgMailNewsUrl, nsISmtpUrl)  </span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40" class="difflineat">@@ -603,23 +604,25 @@ nsSmtpUrl::SetRecipients(const char * aR</span>
<a href="#l14.41"></a><span id="l14.41">     nsUnescape(m_toPart.BeginWriting());</span>
<a href="#l14.42"></a><span id="l14.42">   return NS_OK;</span>
<a href="#l14.43"></a><span id="l14.43"> }</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45"> NS_IMETHODIMP</span>
<a href="#l14.46"></a><span id="l14.46"> nsSmtpUrl::GetRecipients(char ** aRecipientsList)</span>
<a href="#l14.47"></a><span id="l14.47"> {</span>
<a href="#l14.48"></a><span id="l14.48">   NS_ENSURE_ARG_POINTER(aRecipientsList);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-	if (aRecipientsList)</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-		*aRecipientsList = ToNewCString(m_toPart);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-	return NS_OK;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  if (aRecipientsList)</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    *aRecipientsList = ToNewCString(m_toPart);</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.55"></a><span id="l14.55"> }</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57"> NS_IMPL_GETSET(nsSmtpUrl, PostMessage, PRBool, m_isPostMessage)</span>
<a href="#l14.58"></a><span id="l14.58"> </span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+NS_IMPL_GETSET(nsSmtpUrl, VerifyLogon, PRBool, m_verifyLogon)</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+</span>
<a href="#l14.61"></a><span id="l14.61"> // the message can be stored in a file....allow accessors for getting and setting</span>
<a href="#l14.62"></a><span id="l14.62"> // the file name to post...</span>
<a href="#l14.63"></a><span id="l14.63"> NS_IMETHODIMP nsSmtpUrl::SetPostMessageFile(nsIFile * aFile)</span>
<a href="#l14.64"></a><span id="l14.64"> {</span>
<a href="#l14.65"></a><span id="l14.65">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l14.66"></a><span id="l14.66">   m_fileName = aFile;</span>
<a href="#l14.67"></a><span id="l14.67">   return NS_OK;</span>
<a href="#l14.68"></a><span id="l14.68"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -64,53 +64,54 @@ protected:</span>
<a href="#l15.4"></a><span id="l15.4">   nsresult ParseUrl();</span>
<a href="#l15.5"></a><span id="l15.5">   nsresult CleanupMailtoState();</span>
<a href="#l15.6"></a><span id="l15.6">   nsresult ParseMailtoUrl(char * searchPart);</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8">   nsCOMPtr&lt;nsIURI&gt; m_baseURL;</span>
<a href="#l15.9"></a><span id="l15.9">     </span>
<a href="#l15.10"></a><span id="l15.10">   // data retrieved from parsing the url: (Note the url could be a post from file or it could be in the url)</span>
<a href="#l15.11"></a><span id="l15.11">   nsCString m_toPart;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-	nsCString m_ccPart;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-	nsCString	m_subjectPart;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-	nsCString	m_newsgroupPart;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-	nsCString	m_newsHostPart;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-	nsCString	m_referencePart;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-	nsCString	m_bodyPart;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-	nsCString	m_bccPart;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-	nsCString	m_followUpToPart;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-	nsCString	m_fromPart;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-	nsCString	m_htmlPart;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-	nsCString	m_organizationPart;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-	nsCString	m_replyToPart;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-	nsCString	m_priorityPart;</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+  nsCString m_ccPart;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+  nsCString m_subjectPart;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+  nsCString m_newsgroupPart;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  nsCString m_newsHostPart;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  nsCString m_referencePart;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  nsCString m_bodyPart;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  nsCString m_bccPart;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  nsCString m_followUpToPart;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  nsCString m_fromPart;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  nsCString m_htmlPart;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  nsCString m_organizationPart;</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+  nsCString m_replyToPart;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  nsCString m_priorityPart;</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39">   MSG_ComposeFormat mFormat;</span>
<a href="#l15.40"></a><span id="l15.40"> };</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42"> class nsSmtpUrl : public nsISmtpUrl, public nsMsgMailNewsUrl</span>
<a href="#l15.43"></a><span id="l15.43"> {</span>
<a href="#l15.44"></a><span id="l15.44"> public:</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-	NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l15.47"></a><span id="l15.47"> </span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-	// From nsISmtpUrl</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-	NS_DECL_NSISMTPURL</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  // From nsISmtpUrl</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+  NS_DECL_NSISMTPURL</span>
<a href="#l15.52"></a><span id="l15.52"> </span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-	// nsSmtpUrl</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-    nsSmtpUrl();</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+  // nsSmtpUrl</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  nsSmtpUrl();</span>
<a href="#l15.57"></a><span id="l15.57"> </span>
<a href="#l15.58"></a><span id="l15.58"> protected:</span>
<a href="#l15.59"></a><span id="l15.59">   virtual ~nsSmtpUrl();</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">   // data retrieved from parsing the url: (Note the url could be a post from</span>
<a href="#l15.62"></a><span id="l15.62">   // file or it could be in the url)</span>
<a href="#l15.63"></a><span id="l15.63">   nsCString m_toPart;</span>
<a href="#l15.64"></a><span id="l15.64"> </span>
<a href="#l15.65"></a><span id="l15.65">   PRBool m_isPostMessage;</span>
<a href="#l15.66"></a><span id="l15.66">   PRBool m_requestDSN;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+  PRBool m_verifyLogon;</span>
<a href="#l15.68"></a><span id="l15.68"> </span>
<a href="#l15.69"></a><span id="l15.69">   // Smtp specific event sinks</span>
<a href="#l15.70"></a><span id="l15.70">   nsCOMPtr&lt;nsIFile&gt; m_fileName;</span>
<a href="#l15.71"></a><span id="l15.71">   nsCOMPtr&lt;nsIMsgIdentity&gt; m_senderIdentity;</span>
<a href="#l15.72"></a><span id="l15.72">   nsCOMPtr&lt;nsIPrompt&gt; m_netPrompt;</span>
<a href="#l15.73"></a><span id="l15.73">   nsCOMPtr&lt;nsIAuthPrompt&gt; m_netAuthPrompt;</span>
<a href="#l15.74"></a><span id="l15.74">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; m_callbacks;</span>
<a href="#l15.75"></a><span id="l15.75">   nsCOMPtr&lt;nsISmtpServer&gt; m_smtpServer;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -53,23 +53,21 @@ interface nsIUrlListener;</span>
<a href="#l16.4"></a><span id="l16.4"> interface nsIURI;</span>
<a href="#l16.5"></a><span id="l16.5"> interface nsIEventTarget;</span>
<a href="#l16.6"></a><span id="l16.6"> interface nsIFile;</span>
<a href="#l16.7"></a><span id="l16.7"> interface nsIMsgFolder;</span>
<a href="#l16.8"></a><span id="l16.8"> interface nsIMsgWindow;</span>
<a href="#l16.9"></a><span id="l16.9"> interface nsIImapIncomingServer;</span>
<a href="#l16.10"></a><span id="l16.10"> interface nsICacheSession;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-[scriptable, uuid(cb905844-b1e1-4850-96c7-407c166319f2)]</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+[scriptable, uuid(55ebf0c5-0492-43f4-a17c-56f87cfab5f9)]</span>
<a href="#l16.14"></a><span id="l16.14"> interface nsIImapService : nsISupports</span>
<a href="#l16.15"></a><span id="l16.15"> {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-	// As always, you can pass in null for the url listener and the url if you don't require either.....</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-	// aClientEventTarget is the event queue of the event sinks. We post events into this queue.</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-	// mscott -- eventually this function will take in the account (identity/incoming server) associated with </span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-	// the request</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+  // You can pass in null for the url listener and the url if you don't require either.....</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+  // aClientEventTarget is the event queue of the event sinks. We post events into this queue.</span>
<a href="#l16.22"></a><span id="l16.22">   void selectFolder(in nsIEventTarget aClientEventTarget, </span>
<a href="#l16.23"></a><span id="l16.23">                     in nsIMsgFolder aImapMailFolder,</span>
<a href="#l16.24"></a><span id="l16.24">                     in nsIUrlListener aUrlListener,</span>
<a href="#l16.25"></a><span id="l16.25">                     in nsIMsgWindow   aMsgWindow,</span>
<a href="#l16.26"></a><span id="l16.26">                     out nsIURI aURL);</span>
<a href="#l16.27"></a><span id="l16.27">   </span>
<a href="#l16.28"></a><span id="l16.28">   void liteSelectFolder(in nsIEventTarget aClientEventTarget, </span>
<a href="#l16.29"></a><span id="l16.29">                         in nsIMsgFolder aImapMailFolder,</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineat">@@ -109,16 +107,19 @@ interface nsIImapService : nsISupports</span>
<a href="#l16.31"></a><span id="l16.31">                in nsIMsgFolder aImapMailFolder,</span>
<a href="#l16.32"></a><span id="l16.32">                in nsIUrlListener aUrlListener,</span>
<a href="#l16.33"></a><span id="l16.33">                out nsIURI aURL);</span>
<a href="#l16.34"></a><span id="l16.34">   </span>
<a href="#l16.35"></a><span id="l16.35">   nsIURI updateFolderStatus(in nsIEventTarget aClientEventTarget, </span>
<a href="#l16.36"></a><span id="l16.36">                in nsIMsgFolder aImapMailFolder,</span>
<a href="#l16.37"></a><span id="l16.37">                in nsIUrlListener aUrlListener);</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  void verifyLogon(in nsIMsgFolder aImapMailFolder, </span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+                   in nsIUrlListener aUrlListener);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+</span>
<a href="#l16.42"></a><span id="l16.42">   void biff(in nsIEventTarget aClientEventTarget, </span>
<a href="#l16.43"></a><span id="l16.43">             in nsIMsgFolder aImapMailFolder,</span>
<a href="#l16.44"></a><span id="l16.44">             in nsIUrlListener aUrlListener,</span>
<a href="#l16.45"></a><span id="l16.45">             out nsIURI aURL,</span>
<a href="#l16.46"></a><span id="l16.46">             in unsigned long aUidHighWater);</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48">   void deleteMessages(in nsIEventTarget aClientEventTarget, </span>
<a href="#l16.49"></a><span id="l16.49">                       in nsIMsgFolder aImapMailFolder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapUrl.idl</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapUrl.idl</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -55,17 +55,17 @@ typedef long nsImapContentModifiedType;</span>
<a href="#l17.4"></a><span id="l17.4"> interface nsImapContentModifiedTypes</span>
<a href="#l17.5"></a><span id="l17.5"> {</span>
<a href="#l17.6"></a><span id="l17.6">   const long IMAP_CONTENT_NOT_MODIFIED = 0;</span>
<a href="#l17.7"></a><span id="l17.7">   const long IMAP_CONTENT_MODIFIED_VIEW_INLINE = 1;</span>
<a href="#l17.8"></a><span id="l17.8">   const long IMAP_CONTENT_MODIFIED_VIEW_AS_LINKS = 2;</span>
<a href="#l17.9"></a><span id="l17.9">   const long IMAP_CONTENT_FORCE_CONTENT_NOT_MODIFIED = 3;</span>
<a href="#l17.10"></a><span id="l17.10"> } ;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-[scriptable, uuid(2065D454-2459-4204-B76F-0650C6FB8683)]</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+[scriptable, uuid(be01aef6-f8c1-49b5-ae98-7f2be1977e50)]</span>
<a href="#l17.14"></a><span id="l17.14"> interface nsIImapUrl : nsISupports</span>
<a href="#l17.15"></a><span id="l17.15"> {</span>
<a href="#l17.16"></a><span id="l17.16">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.17"></a><span id="l17.17">   // Getters and Setters for the imap specific event sinks to bind to to the url</span>
<a href="#l17.18"></a><span id="l17.18">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.19"></a><span id="l17.19">   attribute nsIImapMailFolderSink imapMailFolderSink;</span>
<a href="#l17.20"></a><span id="l17.20">   attribute nsIImapMessageSink imapMessageSink;</span>
<a href="#l17.21"></a><span id="l17.21">   attribute nsIImapServerSink imapServerSink;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -146,16 +146,17 @@ interface nsIImapUrl : nsISupports</span>
<a href="#l17.23"></a><span id="l17.23">   const long nsImapRefreshAllACLs  = 0x00000013;</span>
<a href="#l17.24"></a><span id="l17.24">   const long nsImapListFolder  = 0x00000014;</span>
<a href="#l17.25"></a><span id="l17.25">   const long nsImapUpgradeToSubscription = 0x00000015;</span>
<a href="#l17.26"></a><span id="l17.26">   const long nsImapFolderStatus  = 0x00000016;</span>
<a href="#l17.27"></a><span id="l17.27">   const long nsImapRefreshFolderUrls = 0x00000017;</span>
<a href="#l17.28"></a><span id="l17.28">   const long nsImapEnsureExistsFolder = 0x00000018;</span>
<a href="#l17.29"></a><span id="l17.29">   const long nsImapOfflineToOnlineCopy = 0x00000019;</span>
<a href="#l17.30"></a><span id="l17.30">   const long nsImapOfflineToOnlineMove = 0x0000001A;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  const long nsImapVerifylogon = 0x0000001B;</span>
<a href="#l17.32"></a><span id="l17.32">   // it's okay to add more imap actions that require us to</span>
<a href="#l17.33"></a><span id="l17.33">   // be in the authenticated state here without renumbering</span>
<a href="#l17.34"></a><span id="l17.34">   // the imap selected state url actions. just make sure you don't</span>
<a href="#l17.35"></a><span id="l17.35">   // set the high bit...</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">   // nsImapSelectedState urls. Note, the high bit is always set for</span>
<a href="#l17.38"></a><span id="l17.38">   // imap actions which require us to be in the selected state</span>
<a href="#l17.39"></a><span id="l17.39">   const long nsImapSelectFolder  = 0x10000002;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -85,17 +85,16 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsITimer.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> #define PREF_TRASH_FOLDER_NAME &quot;trash_folder_name&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #define DEFAULT_TRASH_FOLDER_NAME &quot;Trash&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> static NS_DEFINE_CID(kImapProtocolCID, NS_IMAPPROTOCOL_CID);</span>
<a href="#l18.11"></a><span id="l18.11"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-static NS_DEFINE_CID(kImapServiceCID, NS_IMAPSERVICE_CID);</span>
<a href="#l18.13"></a><span id="l18.13"> static NS_DEFINE_CID(kSubscribableServerCID, NS_SUBSCRIBABLESERVER_CID);</span>
<a href="#l18.14"></a><span id="l18.14"> static NS_DEFINE_CID(kCImapHostSessionListCID, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> NS_IMPL_ADDREF_INHERITED(nsImapIncomingServer, nsMsgIncomingServer)</span>
<a href="#l18.17"></a><span id="l18.17"> NS_IMPL_RELEASE_INHERITED(nsImapIncomingServer, nsMsgIncomingServer)</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> NS_INTERFACE_MAP_BEGIN(nsImapIncomingServer)</span>
<a href="#l18.20"></a><span id="l18.20">   NS_INTERFACE_MAP_ENTRY(nsIImapServerSink)</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -929,25 +928,39 @@ nsImapIncomingServer::PerformExpand(nsIM</span>
<a href="#l18.22"></a><span id="l18.22">   rv = ResetFoldersToUnverified(nsnull);</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l18.25"></a><span id="l18.25">   rv = GetRootFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l18.26"></a><span id="l18.26">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.27"></a><span id="l18.27">   </span>
<a href="#l18.28"></a><span id="l18.28">   if (!rootMsgFolder) return NS_ERROR_FAILURE;</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(kImapServiceCID, &amp;rv);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.32"></a><span id="l18.32">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  if (!imapService)</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l18.35"></a><span id="l18.35">   rv = imapService-&gt;DiscoverAllFolders(NS_GetCurrentThread(), rootMsgFolder,</span>
<a href="#l18.36"></a><span id="l18.36">                                        this, aMsgWindow, nsnull);</span>
<a href="#l18.37"></a><span id="l18.37">   return rv;</span>
<a href="#l18.38"></a><span id="l18.38"> }</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+nsImapIncomingServer::VerifyLogon(nsIUrlListener *aUrlListener)</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+{</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  nsresult rv;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+  // this will create the resource if it doesn't exist, but it shouldn't</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+  // do anything on disk.</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+  rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  return imapService-&gt;VerifyLogon(rootFolder, aUrlListener);</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+}</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+</span>
<a href="#l18.56"></a><span id="l18.56"> NS_IMETHODIMP nsImapIncomingServer::PerformBiff(nsIMsgWindow* aMsgWindow)</span>
<a href="#l18.57"></a><span id="l18.57"> {</span>
<a href="#l18.58"></a><span id="l18.58">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l18.59"></a><span id="l18.59">   nsresult rv = GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l18.60"></a><span id="l18.60">   if(NS_SUCCEEDED(rv))</span>
<a href="#l18.61"></a><span id="l18.61">   {</span>
<a href="#l18.62"></a><span id="l18.62">     SetPerformingBiff(PR_TRUE);</span>
<a href="#l18.63"></a><span id="l18.63">     rv = rootMsgFolder-&gt;GetNewMessages(aMsgWindow, nsnull);</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineat">@@ -2080,17 +2093,17 @@ nsImapIncomingServer::StartPopulatingWit</span>
<a href="#l18.65"></a><span id="l18.65"> </span>
<a href="#l18.66"></a><span id="l18.66">   rv = SetShowFullName(PR_FALSE);</span>
<a href="#l18.67"></a><span id="l18.67">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.68"></a><span id="l18.68"> </span>
<a href="#l18.69"></a><span id="l18.69">   nsCString serverUri;</span>
<a href="#l18.70"></a><span id="l18.70">   rv = GetServerURI(serverUri);</span>
<a href="#l18.71"></a><span id="l18.71">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(kImapServiceCID, &amp;rv);</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.75"></a><span id="l18.75">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77"> /*</span>
<a href="#l18.78"></a><span id="l18.78">     if uri = imap://user@host/foo/bar, the serverUri is imap://user@host</span>
<a href="#l18.79"></a><span id="l18.79">     to get path from uri, skip over imap://user@host + 1 (for the /)</span>
<a href="#l18.80"></a><span id="l18.80"> */</span>
<a href="#l18.81"></a><span id="l18.81">   const char *path = uri + serverUri.Length() + 1;</span>
<a href="#l18.82"></a><span id="l18.82">   return imapService-&gt;GetListOfFoldersWithPath(this, aMsgWindow, nsDependentCString(path));</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineat">@@ -2109,17 +2122,17 @@ nsImapIncomingServer::StartPopulating(ns</span>
<a href="#l18.84"></a><span id="l18.84"> </span>
<a href="#l18.85"></a><span id="l18.85">   // imap always uses the canonical delimiter form of paths for subscribe ui.</span>
<a href="#l18.86"></a><span id="l18.86">   rv = SetDelimiter('/');</span>
<a href="#l18.87"></a><span id="l18.87">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.88"></a><span id="l18.88"> </span>
<a href="#l18.89"></a><span id="l18.89">   rv = SetShowFullName(PR_FALSE);</span>
<a href="#l18.90"></a><span id="l18.90">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.91"></a><span id="l18.91"> </span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(kImapServiceCID, &amp;rv);</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.94"></a><span id="l18.94">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.95"></a><span id="l18.95">   return imapService-&gt;GetListOfFoldersOnServer(this, aMsgWindow);</span>
<a href="#l18.96"></a><span id="l18.96"> }</span>
<a href="#l18.97"></a><span id="l18.97"> </span>
<a href="#l18.98"></a><span id="l18.98"> NS_IMETHODIMP</span>
<a href="#l18.99"></a><span id="l18.99"> nsImapIncomingServer::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l18.100"></a><span id="l18.100"> {</span>
<a href="#l18.101"></a><span id="l18.101">   return NS_OK;</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineat">@@ -2279,17 +2292,17 @@ nsImapIncomingServer::Unsubscribe(const </span>
<a href="#l18.103"></a><span id="l18.103"> {</span>
<a href="#l18.104"></a><span id="l18.104">   return SubscribeToFolder(nsDependentString(aName), PR_FALSE, nsnull);</span>
<a href="#l18.105"></a><span id="l18.105"> }</span>
<a href="#l18.106"></a><span id="l18.106"> </span>
<a href="#l18.107"></a><span id="l18.107"> NS_IMETHODIMP</span>
<a href="#l18.108"></a><span id="l18.108"> nsImapIncomingServer::SubscribeToFolder(const nsAString&amp; aName, PRBool subscribe, nsIURI **aUri)</span>
<a href="#l18.109"></a><span id="l18.109"> {</span>
<a href="#l18.110"></a><span id="l18.110">   nsresult rv;</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(kImapServiceCID, &amp;rv);</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.113"></a><span id="l18.113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.114"></a><span id="l18.114"> </span>
<a href="#l18.115"></a><span id="l18.115">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l18.116"></a><span id="l18.116">   rv = GetRootFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l18.117"></a><span id="l18.117">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.118"></a><span id="l18.118"> </span>
<a href="#l18.119"></a><span id="l18.119">   // Locate the folder so that the correct hierarchical delimiter is used in the</span>
<a href="#l18.120"></a><span id="l18.120">   // folder pathnames, otherwise root's (ie, '^') is used and this is wrong.</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineat">@@ -2683,24 +2696,17 @@ nsImapIncomingServer::GetFormattedString</span>
<a href="#l18.122"></a><span id="l18.122">                                 getter_Copies(aResult));</span>
<a href="#l18.123"></a><span id="l18.123">   }</span>
<a href="#l18.124"></a><span id="l18.124">   return rv;</span>
<a href="#l18.125"></a><span id="l18.125"> }</span>
<a href="#l18.126"></a><span id="l18.126"> </span>
<a href="#l18.127"></a><span id="l18.127"> nsresult</span>
<a href="#l18.128"></a><span id="l18.128"> nsImapIncomingServer::GetPrefForServerAttribute(const char *prefSuffix, PRBool *prefValue)</span>
<a href="#l18.129"></a><span id="l18.129"> {</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-  NS_ENSURE_ARG_POINTER(prefSuffix);</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-  nsresult rv;</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-  nsCAutoString prefName;</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-  // Time to check if this server has the pref</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-  // (mail.server.&lt;serverkey&gt;.prefSuffix) already set</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-  return mPrefBranch-&gt;GetBoolPref(prefName.get(), prefValue);</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+  return GetBoolValue(prefSuffix, prefValue);</span>
<a href="#l18.139"></a><span id="l18.139"> }</span>
<a href="#l18.140"></a><span id="l18.140"> </span>
<a href="#l18.141"></a><span id="l18.141"> NS_IMETHODIMP</span>
<a href="#l18.142"></a><span id="l18.142"> nsImapIncomingServer::GetCanFileMessagesOnServer(PRBool *aCanFileMessagesOnServer)</span>
<a href="#l18.143"></a><span id="l18.143"> {</span>
<a href="#l18.144"></a><span id="l18.144">   NS_ENSURE_ARG_POINTER(aCanFileMessagesOnServer);</span>
<a href="#l18.145"></a><span id="l18.145">   // Initialize aCanFileMessagesOnServer true, a default value for IMAP</span>
<a href="#l18.146"></a><span id="l18.146">   *aCanFileMessagesOnServer = PR_TRUE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -92,16 +92,17 @@ public:</span>
<a href="#l19.4"></a><span id="l19.4">   NS_IMETHOD GetFilterScope(nsMsgSearchScopeValue *filterScope);</span>
<a href="#l19.5"></a><span id="l19.5">   NS_IMETHOD GetSearchScope(nsMsgSearchScopeValue *searchScope);</span>
<a href="#l19.6"></a><span id="l19.6">   NS_IMETHOD GetServerRequiresPasswordForBiff(PRBool *aServerRequiresPasswordForBiff);</span>
<a href="#l19.7"></a><span id="l19.7">   NS_IMETHOD OnUserOrHostNameChanged(const nsACString&amp; oldName, const nsACString&amp; newName);</span>
<a href="#l19.8"></a><span id="l19.8">   NS_IMETHOD GetNumIdleConnections(PRInt32 *aNumIdleConnections);</span>
<a href="#l19.9"></a><span id="l19.9">   NS_IMETHOD ForgetSessionPassword();</span>
<a href="#l19.10"></a><span id="l19.10">   NS_IMETHOD GetMsgFolderFromURI(nsIMsgFolder *aFolderResource, const nsACString&amp; aURI, nsIMsgFolder **aFolder);</span>
<a href="#l19.11"></a><span id="l19.11">   NS_IMETHOD SetSocketType(PRInt32 aSocketType);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  NS_IMETHOD VerifyLogon(nsIUrlListener *aUrlListener);</span>
<a href="#l19.13"></a><span id="l19.13"> </span>
<a href="#l19.14"></a><span id="l19.14"> protected:</span>
<a href="#l19.15"></a><span id="l19.15">   nsresult GetFolder(const nsACString&amp; name, nsIMsgFolder** pFolder);</span>
<a href="#l19.16"></a><span id="l19.16">   nsresult ResetFoldersToUnverified(nsIMsgFolder *parentFolder);</span>
<a href="#l19.17"></a><span id="l19.17">   void GetUnverifiedSubFolders(nsIMsgFolder *parentFolder,</span>
<a href="#l19.18"></a><span id="l19.18">                                nsCOMArray&lt;nsIMsgImapMailFolder&gt; &amp;aFoldersArray);</span>
<a href="#l19.19"></a><span id="l19.19">   void GetUnverifiedFolders(nsCOMArray&lt;nsIMsgImapMailFolder&gt; &amp;aFolderArray);</span>
<a href="#l19.20"></a><span id="l19.20">   nsresult DeleteNonVerifiedFolders(nsIMsgFolder *parentFolder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1550,17 +1550,17 @@ PRBool nsImapProtocol::ProcessCurrentURL</span>
<a href="#l20.4"></a><span id="l20.4">          HandleCurrentUrlError();</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6">   }</span>
<a href="#l20.7"></a><span id="l20.7">   else if (!logonFailed)</span>
<a href="#l20.8"></a><span id="l20.8">       HandleCurrentUrlError();</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10">   if (mailnewsurl &amp;&amp; m_imapMailFolderSink)</span>
<a href="#l20.11"></a><span id="l20.11">   {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-      rv = GetServerStateParser().LastCommandSuccessful()</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+      rv = GetServerStateParser().LastCommandSuccessful() &amp;&amp; !logonFailed</span>
<a href="#l20.14"></a><span id="l20.14">             ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l20.15"></a><span id="l20.15">       // we are done with this url.</span>
<a href="#l20.16"></a><span id="l20.16">       m_imapMailFolderSink-&gt;SetUrlState(this, mailnewsurl, PR_FALSE, rv);</span>
<a href="#l20.17"></a><span id="l20.17">        // doom the cache entry</span>
<a href="#l20.18"></a><span id="l20.18">       if (NS_FAILED(rv) &amp;&amp; DeathSignalReceived() &amp;&amp; m_mockChannel)</span>
<a href="#l20.19"></a><span id="l20.19">         m_mockChannel-&gt;Cancel(rv);</span>
<a href="#l20.20"></a><span id="l20.20">   }</span>
<a href="#l20.21"></a><span id="l20.21">   else</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -4727,19 +4727,28 @@ nsImapProtocol::AlertUserEventUsingId(PR</span>
<a href="#l20.23"></a><span id="l20.23">   }</span>
<a href="#l20.24"></a><span id="l20.24"> }</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26"> void</span>
<a href="#l20.27"></a><span id="l20.27"> nsImapProtocol::AlertUserEvent(const char * message)</span>
<a href="#l20.28"></a><span id="l20.28"> {</span>
<a href="#l20.29"></a><span id="l20.29">   if (m_imapServerSink)</span>
<a href="#l20.30"></a><span id="l20.30">   {</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-    GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-    m_imapServerSink-&gt;FEAlert(NS_ConvertASCIItoUTF16(message), msgWindow);</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+    PRBool suppressErrorMsg = PR_FALSE;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+    if (mailnewsUrl)</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+      mailnewsUrl-&gt;GetSuppressErrorMsgs(&amp;suppressErrorMsg);</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+    if (!suppressErrorMsg)</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+    {</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+      nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+      GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+      m_imapServerSink-&gt;FEAlert(NS_ConvertASCIItoUTF16(message), msgWindow);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+    }</span>
<a href="#l20.46"></a><span id="l20.46">   }</span>
<a href="#l20.47"></a><span id="l20.47"> }</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49"> void</span>
<a href="#l20.50"></a><span id="l20.50"> nsImapProtocol::AlertUserEventFromServer(const char * aServerEvent)</span>
<a href="#l20.51"></a><span id="l20.51"> {</span>
<a href="#l20.52"></a><span id="l20.52">     if (m_imapServerSink)</span>
<a href="#l20.53"></a><span id="l20.53">     {</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineat">@@ -7434,20 +7443,21 @@ void nsImapProtocol::ProcessAuthenticate</span>
<a href="#l20.55"></a><span id="l20.55">     case nsIImapUrl::nsImapRenameFolder:</span>
<a href="#l20.56"></a><span id="l20.56">       sourceMailbox = OnCreateServerSourceFolderPathString();</span>
<a href="#l20.57"></a><span id="l20.57">       OnRenameFolder(sourceMailbox);</span>
<a href="#l20.58"></a><span id="l20.58">       break;</span>
<a href="#l20.59"></a><span id="l20.59">     case nsIImapUrl::nsImapMoveFolderHierarchy:</span>
<a href="#l20.60"></a><span id="l20.60">       sourceMailbox = OnCreateServerSourceFolderPathString();</span>
<a href="#l20.61"></a><span id="l20.61">       OnMoveFolderHierarchy(sourceMailbox);</span>
<a href="#l20.62"></a><span id="l20.62">       break;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+    case nsIImapUrl::nsImapVerifylogon:</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+      break;</span>
<a href="#l20.65"></a><span id="l20.65">     default:</span>
<a href="#l20.66"></a><span id="l20.66">       break;</span>
<a href="#l20.67"></a><span id="l20.67">   }</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-</span>
<a href="#l20.69"></a><span id="l20.69">   PR_Free(sourceMailbox);</span>
<a href="#l20.70"></a><span id="l20.70"> }</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72"> void nsImapProtocol::ProcessAfterAuthenticated()</span>
<a href="#l20.73"></a><span id="l20.73"> {</span>
<a href="#l20.74"></a><span id="l20.74">   // if we're a netscape server, and we haven't got the admin url, get it</span>
<a href="#l20.75"></a><span id="l20.75">   PRBool hasAdminUrl = PR_TRUE;</span>
<a href="#l20.76"></a><span id="l20.76"> </span>
<a href="#l20.77"></a><span id="l20.77" class="difflineat">@@ -7616,18 +7626,17 @@ void nsImapProtocol::Check()</span>
<a href="#l20.78"></a><span id="l20.78"> }</span>
<a href="#l20.79"></a><span id="l20.79"> </span>
<a href="#l20.80"></a><span id="l20.80"> nsresult nsImapProtocol::GetMsgWindow(nsIMsgWindow **aMsgWindow)</span>
<a href="#l20.81"></a><span id="l20.81"> {</span>
<a href="#l20.82"></a><span id="l20.82">     nsresult rv = NS_OK;</span>
<a href="#l20.83"></a><span id="l20.83">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl =</span>
<a href="#l20.84"></a><span id="l20.84">         do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l20.85"></a><span id="l20.85">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-    rv = mailnewsUrl-&gt;GetMsgWindow(aMsgWindow);</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-    return rv;</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+    return mailnewsUrl-&gt;GetMsgWindow(aMsgWindow);</span>
<a href="#l20.89"></a><span id="l20.89"> }</span>
<a href="#l20.90"></a><span id="l20.90"> </span>
<a href="#l20.91"></a><span id="l20.91"> nsresult nsImapProtocol::GetPassword(nsCString &amp;password)</span>
<a href="#l20.92"></a><span id="l20.92"> {</span>
<a href="#l20.93"></a><span id="l20.93">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l20.94"></a><span id="l20.94"> </span>
<a href="#l20.95"></a><span id="l20.95">   if (password.IsEmpty() &amp;&amp; m_imapServerSink &amp;&amp;</span>
<a href="#l20.96"></a><span id="l20.96">       !(m_useSecAuth &amp;&amp; GetServerStateParser().GetCapabilityFlag() &amp; kHasAuthGssApiCapability))</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineat">@@ -7755,18 +7764,23 @@ PRBool nsImapProtocol::TryToLogon()</span>
<a href="#l20.98"></a><span id="l20.98">       }</span>
<a href="#l20.99"></a><span id="l20.99"> </span>
<a href="#l20.100"></a><span id="l20.100">       if (!clientSucceeded || !GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l20.101"></a><span id="l20.101">       {</span>
<a href="#l20.102"></a><span id="l20.102">           // login failed!</span>
<a href="#l20.103"></a><span id="l20.103">           // if we failed because of an interrupt, then do not bother the user</span>
<a href="#l20.104"></a><span id="l20.104">           // similarly - if we failed due to a local error, don't bug them</span>
<a href="#l20.105"></a><span id="l20.105">           if (m_imapServerSink &amp;&amp; !DeathSignalReceived() &amp;&amp; clientSucceeded)</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-            rv = m_imapServerSink-&gt;ForgetPassword();</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+          {</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+            nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+            GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+            // if there's no msg window, don't forget the password</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+            if (msgWindow)</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+              rv = m_imapServerSink-&gt;ForgetPassword();</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+          }</span>
<a href="#l20.115"></a><span id="l20.115">           if (!DeathSignalReceived() &amp;&amp; clientSucceeded)</span>
<a href="#l20.116"></a><span id="l20.116">           {</span>
<a href="#l20.117"></a><span id="l20.117">             AlertUserEventUsingId(IMAP_LOGIN_FAILED);</span>
<a href="#l20.118"></a><span id="l20.118">             m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), nsnull);</span>
<a href="#l20.119"></a><span id="l20.119">             m_currentBiffState = nsIMsgFolder::nsMsgBiffState_Unknown;</span>
<a href="#l20.120"></a><span id="l20.120">             SendSetBiffIndicatorEvent(m_currentBiffState);</span>
<a href="#l20.121"></a><span id="l20.121">             password.Truncate();</span>
<a href="#l20.122"></a><span id="l20.122">         } // if we didn't receive the death signal...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1411,16 +1411,42 @@ nsresult nsImapService::FolderCommand(ns</span>
<a href="#l21.4"></a><span id="l21.4">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l21.5"></a><span id="l21.5">       if (NS_SUCCEEDED(rv))</span>
<a href="#l21.6"></a><span id="l21.6">         rv = GetImapConnectionAndLoadUrl(clientEventTarget, imapUrl, nsnull, url);</span>
<a href="#l21.7"></a><span id="l21.7">     }</span>
<a href="#l21.8"></a><span id="l21.8">   }</span>
<a href="#l21.9"></a><span id="l21.9">   return rv;</span>
<a href="#l21.10"></a><span id="l21.10"> }</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+nsImapService::VerifyLogon(nsIMsgFolder *aFolder, nsIUrlListener *aUrlListener)</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+{</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+  nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  nsCAutoString urlSpec;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+  </span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  PRUnichar delimiter = '/'; // shouldn't matter what is is.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aFolder,</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+                                     aUrlListener, urlSpec, delimiter);</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; aImapUrl)</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+  {</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(aImapUrl);</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+    </span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(aImapUrl);</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+    mailNewsUrl-&gt;SetSuppressErrorMsgs(PR_TRUE);</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+    rv = SetImapUrlSink(aFolder, aImapUrl);</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+    urlSpec.Append(&quot;/verifyLogon&quot;);</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+    rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(NS_GetCurrentThread(), aImapUrl, nsnull, nsnull);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+  }</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+  return rv;</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+}</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+</span>
<a href="#l21.38"></a><span id="l21.38"> // Noop, used to update a folder (causes server to send changes).</span>
<a href="#l21.39"></a><span id="l21.39"> NS_IMETHODIMP nsImapService::Noop(nsIEventTarget *aClientEventTarget, </span>
<a href="#l21.40"></a><span id="l21.40">                                   nsIMsgFolder *aImapMailFolder,</span>
<a href="#l21.41"></a><span id="l21.41">                                   nsIUrlListener *aUrlListener, </span>
<a href="#l21.42"></a><span id="l21.42">                                   nsIURI **aURL)</span>
<a href="#l21.43"></a><span id="l21.43"> {</span>
<a href="#l21.44"></a><span id="l21.44">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l21.45"></a><span id="l21.45">                        &quot;/selectnoop&gt;&quot;, nsIImapUrl::nsImapSelectNoopFolder, nsnull, aURL);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -455,17 +455,17 @@ void nsImapUrl::ParseImapPart(char *imap</span>
<a href="#l22.4"></a><span id="l22.4">   {</span>
<a href="#l22.5"></a><span id="l22.5">     m_imapAction  = nsImapMsgFetch;</span>
<a href="#l22.6"></a><span id="l22.6">     ParseUidChoice();</span>
<a href="#l22.7"></a><span id="l22.7">     PR_FREEIF(m_sourceCanonicalFolderPathSubString);</span>
<a href="#l22.8"></a><span id="l22.8">     ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l22.9"></a><span id="l22.9">     ParseListOfMessageIds();</span>
<a href="#l22.10"></a><span id="l22.10">     // if fetched by spam filter, the action will be changed to nsImapMsgFetchPeek</span>
<a href="#l22.11"></a><span id="l22.11">   }</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  else /* if (fInternal) no concept of internal - not sure there will be one */</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  else</span>
<a href="#l22.14"></a><span id="l22.14">   {</span>
<a href="#l22.15"></a><span id="l22.15">     if (!PL_strcasecmp(m_urlidSubString, &quot;header&quot;))</span>
<a href="#l22.16"></a><span id="l22.16">     {</span>
<a href="#l22.17"></a><span id="l22.17">       m_imapAction = nsImapMsgHeader;</span>
<a href="#l22.18"></a><span id="l22.18">       ParseUidChoice();</span>
<a href="#l22.19"></a><span id="l22.19">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l22.20"></a><span id="l22.20">       ParseListOfMessageIds();</span>
<a href="#l22.21"></a><span id="l22.21">     }</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -709,16 +709,20 @@ void nsImapUrl::ParseImapPart(char *imap</span>
<a href="#l22.23"></a><span id="l22.23">       m_imapAction = nsImapUpgradeToSubscription;</span>
<a href="#l22.24"></a><span id="l22.24">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l22.25"></a><span id="l22.25">     }</span>
<a href="#l22.26"></a><span id="l22.26">     else if (!PL_strcasecmp(m_urlidSubString, &quot;folderstatus&quot;))</span>
<a href="#l22.27"></a><span id="l22.27">     {</span>
<a href="#l22.28"></a><span id="l22.28">       m_imapAction = nsImapFolderStatus;</span>
<a href="#l22.29"></a><span id="l22.29">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l22.30"></a><span id="l22.30">     }</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+    else if (!PL_strcasecmp(m_urlidSubString, &quot;verifyLogon&quot;))</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+    {</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+      m_imapAction = nsImapVerifylogon;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    }</span>
<a href="#l22.35"></a><span id="l22.35">     else if (m_imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand)</span>
<a href="#l22.36"></a><span id="l22.36">     {</span>
<a href="#l22.37"></a><span id="l22.37">       m_command = m_urlidSubString; // save this</span>
<a href="#l22.38"></a><span id="l22.38">       ParseUidChoice();</span>
<a href="#l22.39"></a><span id="l22.39">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l22.40"></a><span id="l22.40">       ParseListOfMessageIds();</span>
<a href="#l22.41"></a><span id="l22.41">     }</span>
<a href="#l22.42"></a><span id="l22.42">     else if (m_imapAction == nsIImapUrl::nsImapMsgStoreCustomKeywords)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/local/public/nsIPop3Service.idl</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/local/public/nsIPop3Service.idl</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -39,23 +39,22 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;nsIUrlListener.idl&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> #include &quot;nsIPop3IncomingServer.idl&quot;</span>
<a href="#l23.6"></a><span id="l23.6"> #include &quot;nsIMsgFolder.idl&quot;</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> interface nsIURI;</span>
<a href="#l23.9"></a><span id="l23.9"> interface nsIStreamListener;</span>
<a href="#l23.10"></a><span id="l23.10"> interface nsIMsgWindow;</span>
<a href="#l23.11"></a><span id="l23.11"> interface nsIMsgFolder;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+</span>
<a href="#l23.13"></a><span id="l23.13"> /*</span>
<a href="#l23.14"></a><span id="l23.14">  * The Pop3 Service is an interface designed to make building and running</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">- * pop3 urls easier. I'm not sure if this service will go away when the</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">- * new networking model comes on line (as part of the N2 project). So</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">- * I reserve the right to change my mind and take this service away =).</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+ * pop3 urls easier. </span>
<a href="#l23.19"></a><span id="l23.19">  */</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-[scriptable, uuid(3BB459E0-D746-11d2-806A-006008128C4E)]</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+[scriptable, uuid(d3b0eead-a0aa-47bd-a751-aa01e01c1ff7)]</span>
<a href="#l23.22"></a><span id="l23.22"> interface nsIPop3Service : nsISupports {</span>
<a href="#l23.23"></a><span id="l23.23">   /*</span>
<a href="#l23.24"></a><span id="l23.24">    * All of these functions build pop3 urls and run them. If you want</span>
<a href="#l23.25"></a><span id="l23.25">    * a handle on the running task, pass in a valid nsIURI ptr. You can later</span>
<a href="#l23.26"></a><span id="l23.26">    * interrupt this action by asking the netlib service manager to interrupt</span>
<a href="#l23.27"></a><span id="l23.27">    * the url you are given back. Remember to release aURL when you are</span>
<a href="#l23.28"></a><span id="l23.28">    * done with it. Pass nsnull in for aURL if you</span>
<a href="#l23.29"></a><span id="l23.29">    * don't care about the returned URL.</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineat">@@ -64,15 +63,25 @@ interface nsIPop3Service : nsISupports {</span>
<a href="#l23.31"></a><span id="l23.31">   /*</span>
<a href="#l23.32"></a><span id="l23.32">    * right now getting new mail doesn't require any user specific data.</span>
<a href="#l23.33"></a><span id="l23.33">    * We use the default current identity for this information. I suspect that</span>
<a href="#l23.34"></a><span id="l23.34">    * we'll eventually pass in an identity to this call so you can get</span>
<a href="#l23.35"></a><span id="l23.35">    * mail on different pop3 accounts....</span>
<a href="#l23.36"></a><span id="l23.36">    */</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38">   nsIURI GetNewMail(in nsIMsgWindow aMsgWindow, in nsIUrlListener aUrlListener,</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-          in nsIMsgFolder aInbox,</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-                    in nsIPop3IncomingServer popServer);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+                    in nsIMsgFolder aInbox, in nsIPop3IncomingServer popServer);</span>
<a href="#l23.42"></a><span id="l23.42"> </span>
<a href="#l23.43"></a><span id="l23.43">   nsIURI CheckForNewMail(in nsIMsgWindow aMsgWindow, in nsIUrlListener aUrlListener,</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-             in nsIMsgFolder inbox,</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-                         in nsIPop3IncomingServer popServer);</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+                         in nsIMsgFolder inbox, in nsIPop3IncomingServer popServer);</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+  /**</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+   * Verify that we can logon </span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+   * </span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+   * @param  aServer - pop3 server we're logging on to.</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+   * @param  aUrlListener - gets called back with success or failure.</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+   *</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+   */</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+  void verifyLogon(in nsIMsgIncomingServer aServer, </span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+                   in nsIUrlListener aUrlListener);</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+</span>
<a href="#l23.59"></a><span id="l23.59"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -416,16 +416,25 @@ nsPop3IncomingServer::GetCanCreateFolder</span>
<a href="#l24.4"></a><span id="l24.4">   NS_ENSURE_ARG_POINTER(aCanCreateFoldersOnServer);</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6">   nsCString deferredToAccount;</span>
<a href="#l24.7"></a><span id="l24.7">   GetDeferredToAccount(deferredToAccount);</span>
<a href="#l24.8"></a><span id="l24.8">   *aCanCreateFoldersOnServer = deferredToAccount.IsEmpty();</span>
<a href="#l24.9"></a><span id="l24.9">   return NS_OK;</span>
<a href="#l24.10"></a><span id="l24.10"> }</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+nsPop3IncomingServer::VerifyLogon(nsIUrlListener *aUrlListener)</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+{</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+  nsresult rv;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service = do_GetService(kCPop3ServiceCID, &amp;rv);</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+  return pop3Service-&gt;VerifyLogon(this, aUrlListener);</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+}</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+</span>
<a href="#l24.21"></a><span id="l24.21"> NS_IMETHODIMP nsPop3IncomingServer::DownloadMailFromServers(nsISupportsArray *aServers,</span>
<a href="#l24.22"></a><span id="l24.22">                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l24.23"></a><span id="l24.23">                               nsIMsgFolder *aFolder,</span>
<a href="#l24.24"></a><span id="l24.24">                               nsIUrlListener *aUrlListener)</span>
<a href="#l24.25"></a><span id="l24.25"> {</span>
<a href="#l24.26"></a><span id="l24.26">   nsPop3GetMailChainer *getMailChainer = new nsPop3GetMailChainer;</span>
<a href="#l24.27"></a><span id="l24.27">   NS_ENSURE_TRUE(getMailChainer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l24.28"></a><span id="l24.28">   getMailChainer-&gt;AddRef(); // this object owns itself and releases when done.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -63,18 +63,19 @@ public:</span>
<a href="#l25.4"></a><span id="l25.4">   NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow);</span>
<a href="#l25.5"></a><span id="l25.5">   NS_IMETHOD GetDownloadMessagesAtStartup(PRBool *getMessages);</span>
<a href="#l25.6"></a><span id="l25.6">   NS_IMETHOD GetCanBeDefaultServer(PRBool *canBeDefaultServer);</span>
<a href="#l25.7"></a><span id="l25.7">   NS_IMETHOD GetCanSearchMessages(PRBool *canSearchMessages);</span>
<a href="#l25.8"></a><span id="l25.8">   NS_IMETHOD GetOfflineSupportLevel(PRInt32 *aSupportLevel);</span>
<a href="#l25.9"></a><span id="l25.9">   NS_IMETHOD GetRootMsgFolder(nsIMsgFolder **aRootMsgFolder);</span>
<a href="#l25.10"></a><span id="l25.10">   NS_IMETHOD GetCanFileMessagesOnServer(PRBool *aCanFileMessagesOnServer);</span>
<a href="#l25.11"></a><span id="l25.11">   NS_IMETHOD GetCanCreateFoldersOnServer(PRBool *aCanCreateFoldersOnServer);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+  NS_IMETHOD VerifyLogon(nsIUrlListener *aUrlListener);</span>
<a href="#l25.13"></a><span id="l25.13">   NS_IMETHOD GetNewMessages(nsIMsgFolder *aFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-                    nsIUrlListener *aUrlListener);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+                            nsIUrlListener *aUrlListener);</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17"> protected:</span>
<a href="#l25.18"></a><span id="l25.18">   nsresult GetInbox(nsIMsgWindow *msgWindow, nsIMsgFolder **inbox);</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20"> private:</span>
<a href="#l25.21"></a><span id="l25.21">   PRUint32 m_capabilityFlags;</span>
<a href="#l25.22"></a><span id="l25.22">   PRBool m_authenticated;</span>
<a href="#l25.23"></a><span id="l25.23">   nsCOMPtr &lt;nsIPop3Protocol&gt; m_runningProtocol;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -786,21 +786,22 @@ nsresult nsPop3Protocol::LoadUrl(nsIURI*</span>
<a href="#l26.4"></a><span id="l26.4">   rv = NS_CheckPortSafety(port, &quot;pop&quot;);</span>
<a href="#l26.5"></a><span id="l26.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">   nsCAutoString queryPart;</span>
<a href="#l26.8"></a><span id="l26.8">   rv = url-&gt;GetQuery(queryPart);</span>
<a href="#l26.9"></a><span id="l26.9">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get the url spect&quot;);</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11">   m_pop3ConData-&gt;only_check_for_new_mail = (PL_strcasestr(queryPart.get(), &quot;check&quot;) != nsnull);</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+  m_pop3ConData-&gt;verify_logon = (PL_strcasestr(queryPart.get(), &quot;verifyLogon&quot;) != nsnull);</span>
<a href="#l26.13"></a><span id="l26.13">   m_pop3ConData-&gt;get_url = (PL_strcasestr(queryPart.get(), &quot;gurl&quot;) != nsnull);</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15">   PRBool deleteByAgeFromServer = PR_FALSE;</span>
<a href="#l26.16"></a><span id="l26.16">   PRInt32 numDaysToLeaveOnServer = -1;</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-  if (!m_pop3ConData-&gt;only_check_for_new_mail)</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+  if (!m_pop3ConData-&gt;only_check_for_new_mail &amp;&amp; !m_pop3ConData-&gt;verify_logon)</span>
<a href="#l26.19"></a><span id="l26.19">   {</span>
<a href="#l26.20"></a><span id="l26.20">     // Pick up pref setting regarding leave messages on server, message size limit</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22">     m_pop3Server-&gt;GetLeaveMessagesOnServer(&amp;m_pop3ConData-&gt;leave_on_server);</span>
<a href="#l26.23"></a><span id="l26.23">     m_pop3Server-&gt;GetHeadersOnly(&amp;m_pop3ConData-&gt;headers_only);</span>
<a href="#l26.24"></a><span id="l26.24">     PRBool limitMessageSize = PR_FALSE;</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineat">@@ -837,17 +838,19 @@ nsresult nsPop3Protocol::LoadUrl(nsIURI*</span>
<a href="#l26.28"></a><span id="l26.28">   if (server)</span>
<a href="#l26.29"></a><span id="l26.29">   {</span>
<a href="#l26.30"></a><span id="l26.30">     rv = server-&gt;GetLocalPath(getter_AddRefs(mailDirectory));</span>
<a href="#l26.31"></a><span id="l26.31">     server-&gt;SetServerBusy(PR_TRUE); // the server is now busy</span>
<a href="#l26.32"></a><span id="l26.32">     server-&gt;GetHostName(hostName);</span>
<a href="#l26.33"></a><span id="l26.33">     server-&gt;GetUsername(userName);</span>
<a href="#l26.34"></a><span id="l26.34">   }</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-  m_pop3ConData-&gt;uidlinfo = net_pop3_load_state(hostName.get(), userName.get(), mailDirectory);</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+  if (!m_pop3ConData-&gt;verify_logon)</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+    m_pop3ConData-&gt;uidlinfo = net_pop3_load_state(hostName.get(), userName.get(), mailDirectory);</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+</span>
<a href="#l26.40"></a><span id="l26.40">   m_pop3ConData-&gt;biffstate = nsIMsgFolder::nsMsgBiffState_NoMail;</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42">   if (m_pop3ConData-&gt;uidlinfo &amp;&amp; numDaysToLeaveOnServer &gt; 0)</span>
<a href="#l26.43"></a><span id="l26.43">   {</span>
<a href="#l26.44"></a><span id="l26.44">     PRUint32 nowInSeconds = TimeInSecondsFromPRTime(PR_Now());</span>
<a href="#l26.45"></a><span id="l26.45">     PRUint32 cutOffDay = nowInSeconds - (60 * 60 * 24 * numDaysToLeaveOnServer);</span>
<a href="#l26.46"></a><span id="l26.46"> </span>
<a href="#l26.47"></a><span id="l26.47">     PL_HashTableEnumerateEntries(m_pop3ConData-&gt;uidlinfo-&gt;hash, net_pop3_delete_old_msgs_mapper, (void *) cutOffDay);</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineat">@@ -1430,18 +1433,21 @@ void nsPop3Protocol::RestoreAuthFlags()</span>
<a href="#l26.49"></a><span id="l26.49"> </span>
<a href="#l26.50"></a><span id="l26.50"> PRInt32 nsPop3Protocol::AuthFallback()</span>
<a href="#l26.51"></a><span id="l26.51"> {</span>
<a href="#l26.52"></a><span id="l26.52">     if (m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l26.53"></a><span id="l26.53">         if(m_password_already_sent)</span>
<a href="#l26.54"></a><span id="l26.54">         {</span>
<a href="#l26.55"></a><span id="l26.55">             m_nsIPop3Sink-&gt;SetUserAuthenticated(PR_TRUE);</span>
<a href="#l26.56"></a><span id="l26.56">             ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-            m_pop3ConData-&gt;next_state = (m_pop3ConData-&gt;get_url)</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-              ? POP3_SEND_GURL : POP3_SEND_STAT;</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+            if (m_pop3ConData-&gt;verify_logon)</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+              m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+            else</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+              m_pop3ConData-&gt;next_state = (m_pop3ConData-&gt;get_url)</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+                                          ? POP3_SEND_GURL : POP3_SEND_STAT;</span>
<a href="#l26.64"></a><span id="l26.64">         }</span>
<a href="#l26.65"></a><span id="l26.65">         else</span>
<a href="#l26.66"></a><span id="l26.66">             m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l26.67"></a><span id="l26.67">     else</span>
<a href="#l26.68"></a><span id="l26.68">     {</span>
<a href="#l26.69"></a><span id="l26.69">         // response code received shows that login failed not because of</span>
<a href="#l26.70"></a><span id="l26.70">         // wrong credential -&gt; stop login without retry or pw dialog, only alert</span>
<a href="#l26.71"></a><span id="l26.71">         if (TestFlag(POP3_STOPLOGIN))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -230,16 +230,18 @@ typedef struct _Pop3ConData {</span>
<a href="#l27.4"></a><span id="l27.4">     PRInt32 cur_msg_size;</span>
<a href="#l27.5"></a><span id="l27.5">     PRBool truncating_cur_msg;  /* are we using top and uidl? */</span>
<a href="#l27.6"></a><span id="l27.6">     PRBool msg_del_started;     /* True if MSG_BeginMailDel...</span>
<a href="#l27.7"></a><span id="l27.7">                                  * called</span>
<a href="#l27.8"></a><span id="l27.8">                                  */</span>
<a href="#l27.9"></a><span id="l27.9">     PRBool only_check_for_new_mail;</span>
<a href="#l27.10"></a><span id="l27.10">     nsMsgBiffState biffstate;     /* If just checking for, what the answer is. */</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+    PRBool verify_logon;        /* true if we're just seeing if we can logon */</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+</span>
<a href="#l27.14"></a><span id="l27.14">     void *msg_closure;</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16">     PRBool graph_progress_bytes_p; /* whether we should display info about</span>
<a href="#l27.17"></a><span id="l27.17">                                       the bytes transferred (usually we</span>
<a href="#l27.18"></a><span id="l27.18">                                       display info about the number of</span>
<a href="#l27.19"></a><span id="l27.19">                                       messages instead.) */</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21">     Pop3UidlHost *uidlinfo;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -45,16 +45,17 @@</span>
<a href="#l28.4"></a><span id="l28.4"> </span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsPop3URL.h&quot;</span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsPop3Sink.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsPop3Protocol.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l28.11"></a><span id="l28.11"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+#include &quot;nsINetUtil.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13"> </span>
<a href="#l28.14"></a><span id="l28.14"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16"> #include &quot;nsIDirectoryService.h&quot;</span>
<a href="#l28.17"></a><span id="l28.17"> #include &quot;nsMailDirServiceDefs.h&quot;</span>
<a href="#l28.18"></a><span id="l28.18"> #include &quot;prprf.h&quot;</span>
<a href="#l28.19"></a><span id="l28.19"> #include &quot;nsEscape.h&quot;</span>
<a href="#l28.20"></a><span id="l28.20"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineat">@@ -166,16 +167,60 @@ nsresult nsPop3Service::GetMail(PRBool d</span>
<a href="#l28.22"></a><span id="l28.22">     rv = RunPopUrl(server, url);</span>
<a href="#l28.23"></a><span id="l28.23"> </span>
<a href="#l28.24"></a><span id="l28.24">   if (aURL &amp;&amp; url) // we already have a ref count on pop3url...</span>
<a href="#l28.25"></a><span id="l28.25">     NS_IF_ADDREF(*aURL = url);</span>
<a href="#l28.26"></a><span id="l28.26"> </span>
<a href="#l28.27"></a><span id="l28.27">   return rv;</span>
<a href="#l28.28"></a><span id="l28.28"> }</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+NS_IMETHODIMP nsPop3Service::VerifyLogon(nsIMsgIncomingServer *aServer,</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+                                         nsIUrlListener *aUrlListener)</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+{</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+  nsCString popHost;</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+  nsCString popUser;</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+  PRInt32 popPort = -1;</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+  nsresult rv = aServer-&gt;GetHostName(popHost);</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+  if (popHost.IsEmpty())</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+    return NS_MSG_INVALID_OR_MISSING_SERVER;</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+  rv = aServer-&gt;GetPort(&amp;popPort);</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+  rv = aServer-&gt;GetUsername(popUser);</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+  if (popUser.IsEmpty())</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+    return NS_MSG_SERVER_USERNAME_MISSING;</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+  nsCString escapedUsername;</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+  MsgEscapeString(popUser, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+  nsCOMPtr &lt;nsIPop3IncomingServer&gt; popServer = do_QueryInterface(aServer, &amp;rv);</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+  // now construct a pop3 url...</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+  // we need to escape the username because it may contain</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+  // characters like / % or @</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+  char * urlSpec = PR_smprintf(&quot;pop3://%s@%s:%d/?verifyLogon&quot;, </span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+                              escapedUsername.get(), popHost.get(), popPort);</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+  if (!urlSpec)</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+  rv = BuildPop3Url(urlSpec, nsnull, popServer, aUrlListener, </span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+                    getter_AddRefs(url), nsnull);</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineplus">+  PR_smprintf_free(urlSpec);</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; url)</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+    rv = RunPopUrl(aServer, url);</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+  return rv;</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+}</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+</span>
<a href="#l28.74"></a><span id="l28.74"> nsresult nsPop3Service::BuildPop3Url(const char * urlSpec,</span>
<a href="#l28.75"></a><span id="l28.75">                                      nsIMsgFolder *inbox,</span>
<a href="#l28.76"></a><span id="l28.76">                                      nsIPop3IncomingServer *server,</span>
<a href="#l28.77"></a><span id="l28.77">                                      nsIUrlListener * aUrlListener,</span>
<a href="#l28.78"></a><span id="l28.78">                                      nsIURI ** aUrl,</span>
<a href="#l28.79"></a><span id="l28.79">                                      nsIMsgWindow *aMsgWindow)</span>
<a href="#l28.80"></a><span id="l28.80"> {</span>
<a href="#l28.81"></a><span id="l28.81">   nsresult rv;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

