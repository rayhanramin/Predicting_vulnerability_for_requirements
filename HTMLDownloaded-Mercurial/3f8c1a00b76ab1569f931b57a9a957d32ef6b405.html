<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 16876:3f8c1a00b76ab1569f931b57a9a957d32ef6b405</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 3f8c1a00b76ab1569f931b57a9a957d32ef6b405" />
<meta property="og:url" content="/comm-central/rev/3f8c1a00b76ab1569f931b57a9a957d32ef6b405" />
<meta property="og:description" content="Bug 1005413: Import JSMime from revision 8626a9039d66570124a9d1d7e54683d50f0f6570, r=irving." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 3f8c1a00b76ab1569f931b57a9a957d32ef6b405 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/3f8c1a00b76ab1569f931b57a9a957d32ef6b405">shortlog</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/3f8c1a00b76ab1569f931b57a9a957d32ef6b405">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405">files</a> |
changeset |
<a href="/comm-central/raw-rev/3f8c1a00b76ab1569f931b57a9a957d32ef6b405">raw</a>  | <a href="/comm-central/archive/3f8c1a00b76ab1569f931b57a9a957d32ef6b405.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1005413">Bug 1005413</a>: Import JSMime from revision 8626a9039d66570124a9d1d7e54683d50f0f6570, r=irving.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 13 Oct 2014 18:43:49 -0500</td></tr>

<tr>
 <td>changeset 16876</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/3f8c1a00b76ab1569f931b57a9a957d32ef6b405">3f8c1a00b76ab1569f931b57a9a957d32ef6b405</a></td>
</tr>



<tr>
<td>parent 16875</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/35295a033274825a5a12f60b363ffdfa06d3a7e1">35295a033274825a5a12f60b363ffdfa06d3a7e1</a>
</td>
</tr>

<tr>
<td>child 16877</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b1570c0200ffd2826033a1cccbf936d60612bb87">b1570c0200ffd2826033a1cccbf936d60612bb87</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=3f8c1a00b76ab1569f931b57a9a957d32ef6b405">10500</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 14 Oct 2014 04:33:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b1570c0200ff [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b1570c0200ffd2826033a1cccbf936d60612bb87">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b1570c0200ffd2826033a1cccbf936d60612bb87&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b1570c0200ffd2826033a1cccbf936d60612bb87&newProject=comm-central&newRevision=3f8c1a00b76ab1569f931b57a9a957d32ef6b405&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b1570c0200ffd2826033a1cccbf936d60612bb87&newProject=comm-central&newRevision=3f8c1a00b76ab1569f931b57a9a957d32ef6b405&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b1570c0200ffd2826033a1cccbf936d60612bb87&newProject=comm-central&newRevision=3f8c1a00b76ab1569f931b57a9a957d32ef6b405&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28irving%29&revcount=50">irving</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1005413">1005413</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1005413">Bug 1005413</a>: Import JSMime from revision 8626a9039d66570124a9d1d7e54683d50f0f6570, r=irving.

Individual JSMime patches were reviewed by both irving and asuth.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/jsmime.js">mailnews/mime/jsmime/jsmime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/jsmime.js">file</a> |
<a href="/comm-central/annotate/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/jsmime.js">annotate</a> |
<a href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/jsmime.js">diff</a> |
<a href="/comm-central/comparison/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/jsmime.js">comparison</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/jsmime.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/head_xpcshell_glue.js">mailnews/mime/jsmime/test/head_xpcshell_glue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/head_xpcshell_glue.js">file</a> |
<a href="/comm-central/annotate/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/head_xpcshell_glue.js">annotate</a> |
<a href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/head_xpcshell_glue.js">diff</a> |
<a href="/comm-central/comparison/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/head_xpcshell_glue.js">comparison</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/head_xpcshell_glue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/mock_date.js">mailnews/mime/jsmime/test/mock_date.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/mock_date.js">file</a> |
<a href="/comm-central/annotate/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/mock_date.js">annotate</a> |
<a href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/mock_date.js">diff</a> |
<a href="/comm-central/comparison/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/mock_date.js">comparison</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/mock_date.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header.js">mailnews/mime/jsmime/test/test_header.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header.js">file</a> |
<a href="/comm-central/annotate/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header.js">annotate</a> |
<a href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header.js">diff</a> |
<a href="/comm-central/comparison/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header.js">comparison</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header_emitter.js">mailnews/mime/jsmime/test/test_header_emitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header_emitter.js">file</a> |
<a href="/comm-central/annotate/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header_emitter.js">annotate</a> |
<a href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header_emitter.js">diff</a> |
<a href="/comm-central/comparison/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header_emitter.js">comparison</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_header_emitter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_header_emitters.js">mailnews/mime/jsmime/test/test_structured_header_emitters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_header_emitters.js">file</a> |
<a href="/comm-central/annotate/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_header_emitters.js">annotate</a> |
<a href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_header_emitters.js">diff</a> |
<a href="/comm-central/comparison/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_header_emitters.js">comparison</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_header_emitters.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_headers.js">mailnews/mime/jsmime/test/test_structured_headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_headers.js">file</a> |
<a href="/comm-central/annotate/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_headers.js">annotate</a> |
<a href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_headers.js">diff</a> |
<a href="/comm-central/comparison/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_headers.js">comparison</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/jsmime/test/test_structured_headers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/moz.build">mailnews/mime/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/moz.build">file</a> |
<a href="/comm-central/annotate/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/moz.build">annotate</a> |
<a href="/comm-central/diff/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/moz.build">diff</a> |
<a href="/comm-central/comparison/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/moz.build">comparison</a> |
<a href="/comm-central/log/3f8c1a00b76ab1569f931b57a9a957d32ef6b405/mailnews/mime/moz.build">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/mime/jsmime/jsmime.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/mime/jsmime/jsmime.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -91,19 +91,24 @@ function stringToTypedArray(buffer) {</span>
<a href="#l1.4"></a><span id="l1.4">  */</span>
<a href="#l1.5"></a><span id="l1.5"> function typedArrayToString(buffer) {</span>
<a href="#l1.6"></a><span id="l1.6">   var string = '';</span>
<a href="#l1.7"></a><span id="l1.7">   for (var i = 0; i &lt; buffer.length; i+= 100)</span>
<a href="#l1.8"></a><span id="l1.8">     string += String.fromCharCode.apply(undefined, buffer.subarray(i, i + 100));</span>
<a href="#l1.9"></a><span id="l1.9">   return string;</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+/** A list of month names for Date parsing. */</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+const kMonthNames = [&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;];</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16"> return {</span>
<a href="#l1.17"></a><span id="l1.17">   decode_base64: decode_base64,</span>
<a href="#l1.18"></a><span id="l1.18">   decode_qp: decode_qp,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  kMonthNames: kMonthNames,</span>
<a href="#l1.20"></a><span id="l1.20">   stringToTypedArray: stringToTypedArray,</span>
<a href="#l1.21"></a><span id="l1.21">   typedArrayToString: typedArrayToString,</span>
<a href="#l1.22"></a><span id="l1.22"> };</span>
<a href="#l1.23"></a><span id="l1.23"> });</span>
<a href="#l1.24"></a><span id="l1.24"> /**</span>
<a href="#l1.25"></a><span id="l1.25">  * This file implements knowledge of how to encode or decode structured headers</span>
<a href="#l1.26"></a><span id="l1.26">  * for several key headers. It is not meant to be used externally to jsmime.</span>
<a href="#l1.27"></a><span id="l1.27">  */</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -200,21 +205,32 @@ function parseUnstructured(values) {</span>
<a href="#l1.29"></a><span id="l1.29"> function writeUnstructured(value) {</span>
<a href="#l1.30"></a><span id="l1.30">   this.addUnstructured(value);</span>
<a href="#l1.31"></a><span id="l1.31"> }</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> // RFC 5322</span>
<a href="#l1.34"></a><span id="l1.34"> addHeader(&quot;Comments&quot;, parseUnstructured, writeUnstructured);</span>
<a href="#l1.35"></a><span id="l1.35"> addHeader(&quot;Keywords&quot;, parseUnstructured, writeUnstructured);</span>
<a href="#l1.36"></a><span id="l1.36"> addHeader(&quot;Subject&quot;, parseUnstructured, writeUnstructured);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-</span>
<a href="#l1.38"></a><span id="l1.38"> // RFC 2045</span>
<a href="#l1.39"></a><span id="l1.39"> addHeader(&quot;Content-Description&quot;, parseUnstructured, writeUnstructured);</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+// Date headers</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+function parseDate(values) { return this.parseDateHeader(values[0]); }</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+function writeDate(value) { this.addDate(value); }</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+// RFC 5322</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+addHeader(&quot;Date&quot;, parseDate, writeDate);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+addHeader(&quot;Resent-Date&quot;, parseDate, writeDate);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+// RFC 5536</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+addHeader(&quot;Expires&quot;, parseDate, writeDate);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+addHeader(&quot;Injection-Date&quot;, parseDate, writeDate);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+addHeader(&quot;NNTP-Posting-Date&quot;, parseDate, writeDate);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55"> // Miscellaneous headers (those that don't fall under the above schemes):</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57"> // RFC 2047</span>
<a href="#l1.58"></a><span id="l1.58"> structuredDecoders.set(&quot;Content-Transfer-Encoding&quot;, function (values) {</span>
<a href="#l1.59"></a><span id="l1.59">   return values[0].toLowerCase();</span>
<a href="#l1.60"></a><span id="l1.60"> });</span>
<a href="#l1.61"></a><span id="l1.61"> structuredEncoders.set(&quot;Content-Transfer-Encoding&quot;, writeUnstructured);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineat">@@ -305,21 +321,26 @@ var headerparser = {};</span>
<a href="#l1.63"></a><span id="l1.63">  * @param {String} delimiters A set of delimiters to include as individual</span>
<a href="#l1.64"></a><span id="l1.64">  *                            tokens.</span>
<a href="#l1.65"></a><span id="l1.65">  * @param {Object} opts       A set of options selecting what to parse.</span>
<a href="#l1.66"></a><span id="l1.66">  * @param {Boolean} [opts.qstring]  If true, recognize quoted strings.</span>
<a href="#l1.67"></a><span id="l1.67">  * @param {Boolean} [opts.dliteral] If true, recognize domain literals.</span>
<a href="#l1.68"></a><span id="l1.68">  * @param {Boolean} [opts.comments] If true, recognize comments.</span>
<a href="#l1.69"></a><span id="l1.69">  * @param {Boolean} [opts.rfc2047]  If true, parse and decode RFC 2047</span>
<a href="#l1.70"></a><span id="l1.70">  *                                  encoded-words.</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">- * @returns {(Token|String)*} A sequence of Token objects (which have a</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">- *                            toString method returning their value) or String</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">- *                            objects (representing delimiters).</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+ * @returns {(Token|String)[]} An array of Token objects (which have a toString</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+ *                             method returning their value) or String objects</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+ *                             (representing delimiters).</span>
<a href="#l1.77"></a><span id="l1.77">  */</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-function* getHeaderTokens(value, delimiters, opts) {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+function getHeaderTokens(value, delimiters, opts) {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  // The array of parsed tokens. This method used to be a generator, but it</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+  // appears that generators are poorly optimized in current engines, so it was</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+  // converted to not be one.</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  let tokenList = [];</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+</span>
<a href="#l1.85"></a><span id="l1.85">   /// Represents a non-delimiter token</span>
<a href="#l1.86"></a><span id="l1.86">   function Token(token) {</span>
<a href="#l1.87"></a><span id="l1.87">     // Unescape all quoted pairs. Any trailing \ is deleted.</span>
<a href="#l1.88"></a><span id="l1.88">     this.token = token.replace(/\\(.?)/g, &quot;$1&quot;);</span>
<a href="#l1.89"></a><span id="l1.89">   }</span>
<a href="#l1.90"></a><span id="l1.90">   Token.prototype.toString = function () { return this.token; };</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92">   // The start of the current token (e.g., atoms, strings)</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineat">@@ -353,22 +374,22 @@ function* getHeaderTokens(value, delimit</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95">         // If RFC 2047 is enabled, decode the qstring only if the entire string</span>
<a href="#l1.96"></a><span id="l1.96">         // appears to be a 2047 token. Don't unquote just yet (this will better</span>
<a href="#l1.97"></a><span id="l1.97">         // match people who incorrectly treat RFC 2047 decoding as a separate,</span>
<a href="#l1.98"></a><span id="l1.98">         // earlier step).</span>
<a href="#l1.99"></a><span id="l1.99">         if (opts.rfc2047 &amp;&amp; text.startsWith(&quot;=?&quot;) &amp;&amp; text.endsWith(&quot;?=&quot;))</span>
<a href="#l1.100"></a><span id="l1.100">           text = decodeRFC2047Words(text);</span>
<a href="#l1.101"></a><span id="l1.101"> </span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-        yield new Token(text);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+        tokenList.push(new Token(text));</span>
<a href="#l1.104"></a><span id="l1.104">         endQuote = undefined;</span>
<a href="#l1.105"></a><span id="l1.105">         tokenStart = undefined;</span>
<a href="#l1.106"></a><span id="l1.106">       } else if (ch == endQuote &amp;&amp; ch == ']') {</span>
<a href="#l1.107"></a><span id="l1.107">         // Domain literals include their delimiters.</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-        yield new Token(value.slice(tokenStart, i + 1));</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+        tokenList.push(new Token(value.slice(tokenStart, i + 1)));</span>
<a href="#l1.110"></a><span id="l1.110">         endQuote = undefined;</span>
<a href="#l1.111"></a><span id="l1.111">         tokenStart = undefined;</span>
<a href="#l1.112"></a><span id="l1.112">       }</span>
<a href="#l1.113"></a><span id="l1.113">       // Avoid any further processing.</span>
<a href="#l1.114"></a><span id="l1.114">       continue;</span>
<a href="#l1.115"></a><span id="l1.115">     }</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117">     // If we can match the RFC 2047 encoded-word pattern, we need to decode the</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineat">@@ -377,27 +398,27 @@ function* getHeaderTokens(value, delimit</span>
<a href="#l1.119"></a><span id="l1.119">       // RFC 2047 tokens separated only by whitespace are conceptually part of</span>
<a href="#l1.120"></a><span id="l1.120">       // the same output token, so we need to decode them all at once.</span>
<a href="#l1.121"></a><span id="l1.121">       let encodedWordsRE = /([ \t\r\n]*=\?[^?]*\?[BbQq]\?[^?]*\?=)+/;</span>
<a href="#l1.122"></a><span id="l1.122">       let result = encodedWordsRE.exec(value.slice(i));</span>
<a href="#l1.123"></a><span id="l1.123">       if (result !== null) {</span>
<a href="#l1.124"></a><span id="l1.124">         // If we were in the middle of a prior token (i.e., something like</span>
<a href="#l1.125"></a><span id="l1.125">         // foobar=?UTF-8?Q?blah?=), yield the previous segment as a token.</span>
<a href="#l1.126"></a><span id="l1.126">         if (tokenStart !== undefined) {</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-          yield new Token(value.slice(tokenStart, i));</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+          tokenList.push(new Token(value.slice(tokenStart, i)));</span>
<a href="#l1.129"></a><span id="l1.129">           tokenStart = undefined;</span>
<a href="#l1.130"></a><span id="l1.130">         }</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132">         // Find out how much we need to decode...</span>
<a href="#l1.133"></a><span id="l1.133">         let encWordsLen = result[0].length;</span>
<a href="#l1.134"></a><span id="l1.134">         let string = decodeRFC2047Words(value.slice(i, i + encWordsLen),</span>
<a href="#l1.135"></a><span id="l1.135">           &quot;UTF-8&quot;);</span>
<a href="#l1.136"></a><span id="l1.136">         // Don't make a new Token variable, since we do not want to unescape the</span>
<a href="#l1.137"></a><span id="l1.137">         // decoded string.</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-        yield { toString: function() { return string; }};</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+        tokenList.push({ toString: function() { return string; }});</span>
<a href="#l1.140"></a><span id="l1.140"> </span>
<a href="#l1.141"></a><span id="l1.141">         // Skip everything we decoded. The -1 is because we don't want to</span>
<a href="#l1.142"></a><span id="l1.142">         // include the starting character.</span>
<a href="#l1.143"></a><span id="l1.143">         i += encWordsLen - 1;</span>
<a href="#l1.144"></a><span id="l1.144">         continue;</span>
<a href="#l1.145"></a><span id="l1.145">       }</span>
<a href="#l1.146"></a><span id="l1.146"> </span>
<a href="#l1.147"></a><span id="l1.147">       // If we are here, then we failed to match the simple 2047 encoded-word</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineat">@@ -455,39 +476,41 @@ function* getHeaderTokens(value, delimit</span>
<a href="#l1.149"></a><span id="l1.149">       // Not a delimiter, whitespace, comment, domain literal, or quoted string.</span>
<a href="#l1.150"></a><span id="l1.150">       // Must be part of an atom then!</span>
<a href="#l1.151"></a><span id="l1.151">       tokenIsStarting = true;</span>
<a href="#l1.152"></a><span id="l1.152">     }</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154">     // If our analysis concluded that we closed an open token, and there is an</span>
<a href="#l1.155"></a><span id="l1.155">     // open token, then yield that token.</span>
<a href="#l1.156"></a><span id="l1.156">     if (tokenIsEnding &amp;&amp; tokenStart !== undefined) {</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-      yield new Token(value.slice(tokenStart, i));</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+      tokenList.push(new Token(value.slice(tokenStart, i)));</span>
<a href="#l1.159"></a><span id="l1.159">       tokenStart = undefined;</span>
<a href="#l1.160"></a><span id="l1.160">     }</span>
<a href="#l1.161"></a><span id="l1.161">     // If we need to output a delimiter, do so.</span>
<a href="#l1.162"></a><span id="l1.162">     if (isSpecial)</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-      yield ch;</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+      tokenList.push(ch);</span>
<a href="#l1.165"></a><span id="l1.165">     // If our analysis concluded that we could open a token, and no token is</span>
<a href="#l1.166"></a><span id="l1.166">     // opened yet, then start the token.</span>
<a href="#l1.167"></a><span id="l1.167">     if (tokenIsStarting &amp;&amp; tokenStart === undefined) {</span>
<a href="#l1.168"></a><span id="l1.168">       tokenStart = i;</span>
<a href="#l1.169"></a><span id="l1.169">     }</span>
<a href="#l1.170"></a><span id="l1.170">   }</span>
<a href="#l1.171"></a><span id="l1.171"> </span>
<a href="#l1.172"></a><span id="l1.172">   // That concludes the loop! If there is a currently open token, close that</span>
<a href="#l1.173"></a><span id="l1.173">   // token now.</span>
<a href="#l1.174"></a><span id="l1.174">   if (tokenStart !== undefined) {</span>
<a href="#l1.175"></a><span id="l1.175">     // Error case: a partially-open quoted string is assumed to have a trailing</span>
<a href="#l1.176"></a><span id="l1.176">     // &quot; character.</span>
<a href="#l1.177"></a><span id="l1.177">     if (endQuote == '&quot;')</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-      yield new Token(value.slice(tokenStart + 1));</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+      tokenList.push(new Token(value.slice(tokenStart + 1)));</span>
<a href="#l1.180"></a><span id="l1.180">     else</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-      yield new Token(value.slice(tokenStart));</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+      tokenList.push(new Token(value.slice(tokenStart)));</span>
<a href="#l1.183"></a><span id="l1.183">   }</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+  return tokenList;</span>
<a href="#l1.186"></a><span id="l1.186"> }</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188"> /**</span>
<a href="#l1.189"></a><span id="l1.189">  * Convert a header value into UTF-16 strings by attempting to decode as UTF-8</span>
<a href="#l1.190"></a><span id="l1.190">  * or another legacy charset. If the header is valid UTF-8, it will be decoded</span>
<a href="#l1.191"></a><span id="l1.191">  * as UTF-8; if it is not, the fallbackCharset will be attempted instead.</span>
<a href="#l1.192"></a><span id="l1.192">  *</span>
<a href="#l1.193"></a><span id="l1.193">  * @param {String} headerValue       The header (as a binary string) to attempt</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineat">@@ -1010,16 +1033,123 @@ function decode2231Value(value) {</span>
<a href="#l1.195"></a><span id="l1.195">   let typedarray = mimeutils.stringToTypedArray(value);</span>
<a href="#l1.196"></a><span id="l1.196"> </span>
<a href="#l1.197"></a><span id="l1.197">   // Decode the charset. If the charset isn't found, we throw an error. Try to</span>
<a href="#l1.198"></a><span id="l1.198">   // fallback in that case.</span>
<a href="#l1.199"></a><span id="l1.199">   return new TextDecoder(charset, {fatal: true})</span>
<a href="#l1.200"></a><span id="l1.200">     .decode(typedarray, {stream: false});</span>
<a href="#l1.201"></a><span id="l1.201"> }</span>
<a href="#l1.202"></a><span id="l1.202"> </span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+// This is a map of known timezone abbreviations, for fallback in obsolete Date</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+// productions.</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+const kKnownTZs = {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+  // The following timezones are explicitly listed in RFC 5322.</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+  &quot;UT&quot;:  &quot;+0000&quot;, &quot;GMT&quot;: &quot;+0000&quot;,</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+  &quot;EST&quot;: &quot;-0500&quot;, &quot;EDT&quot;: &quot;-0400&quot;,</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  &quot;CST&quot;: &quot;-0600&quot;, &quot;CDT&quot;: &quot;-0500&quot;,</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+  &quot;MST&quot;: &quot;-0700&quot;, &quot;MDT&quot;: &quot;-0600&quot;,</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+  &quot;PST&quot;: &quot;-0800&quot;, &quot;PDT&quot;: &quot;-0700&quot;,</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+  // The following are time zones copied from NSPR's prtime.c</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+  &quot;AST&quot;: &quot;-0400&quot;, // Atlantic Standard Time</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+  &quot;NST&quot;: &quot;-0330&quot;, // Newfoundland Standard Time</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  &quot;BST&quot;: &quot;+0100&quot;, // British Summer Time</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+  &quot;MET&quot;: &quot;+0100&quot;, // Middle Europe Time</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+  &quot;EET&quot;: &quot;+0200&quot;, // Eastern Europe Time</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+  &quot;JST&quot;: &quot;+0900&quot;  // Japan Standard Time</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+};</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+/**</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+ * Parse a header that contains a date-time definition according to RFC 5322.</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+ * The result is a JS date object with the same timestamp as the header.</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+ *</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+ * The dates returned by this parser cannot be reliably converted back into the</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+ * original header for two reasons. First, JS date objects cannot retain the</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+ * timezone information they were initialized with, so reserializing a date</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+ * header would necessarily produce a date in either the current timezone or in</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+ * UTC. Second, JS dates measure time as seconds elapsed from the POSIX epoch</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+ * excluding leap seconds. Any timestamp containing a leap second is instead</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+ * converted into one that represents the next second.</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+ *</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+ * Dates that do not match the RFC 5322 production are instead attempted to</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+ * parse using the Date.parse function. The strings that are accepted by</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+ * Date.parse are not fully defined by the standard, but most implementations</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+ * should accept strings that look rather close to RFC 5322 strings. Truly</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+ * invalid dates produce a formulation that results in an invalid date,</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+ * detectable by having its .getTime() method return NaN.</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+ *</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+ * @param {String} header The MIME header value to parse.</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+ * @returns {Date}        The date contained within the header, as described</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+ *                        above.</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+ */</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+function parseDateHeader(header) {</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+  let tokens = [for (x of getHeaderTokens(header, &quot;,:&quot;, {})) x.toString()];</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+  // What does a Date header look like? In practice, most date headers devolve</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+  // into Date: [dow ,] dom mon year hh:mm:ss tzoff [(abbrev)], with the day of</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+  // week mostly present and the timezone abbreviation mostly absent.</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+  // First, ignore the day-of-the-week if present. This would be the first two</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+  // tokens.</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+  if (tokens.length &gt; 1 &amp;&amp; tokens[1] === ',')</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+    tokens = tokens.slice(2);</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+  // If there are too few tokens, the date is obviously invalid.</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+  if (tokens.length &lt; 8)</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+    return new Date(NaN);</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+  // Save off the numeric tokens</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+  let day = parseInt(tokens[0]);</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+  // month is tokens[1]</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+  let year = parseInt(tokens[2]);</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+  let hours = parseInt(tokens[3]);</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+  // tokens[4] === ':'</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+  let minutes = parseInt(tokens[5]);</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+  // tokens[6] === ':'</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+  let seconds = parseInt(tokens[7]);</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+  // Compute the month. Check only the first three digits for equality; this</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+  // allows us to accept, e.g., &quot;January&quot; in lieu of &quot;Jan.&quot;</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+  let month = mimeutils.kMonthNames.indexOf(tokens[1].slice(0, 3));</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+  // If the month name is not recognized, make the result illegal.</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+  if (month &lt; 0)</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+    month = NaN;</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+  // Compute the full year if it's only 2 digits. RFC 5322 states that the</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+  // cutoff is 50 instead of 70.</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+  if (year &lt; 100) {</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+    year += year &lt; 50 ? 2000 : 1900;</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+  }</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+  // Compute the timezone offset. If it's not in the form Â±hhmm, convert it to</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+  // that form.</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+  let tzoffset = tokens[8];</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+  if (tzoffset in kKnownTZs)</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+    tzoffset = kKnownTZs[tzoffset];</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+  let decompose = /^([+-])(\d\d)(\d\d)$/.exec(tzoffset);</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+  // Unknown? Make it +0000</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+  if (decompose === null)</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+    decompose = ['+0000', '+', '00', '00'];</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+  let tzOffsetInMin = parseInt(decompose[2]) * 60 + parseInt(decompose[3]);</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+  if (decompose[1] == '-')</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+    tzOffsetInMin = -tzOffsetInMin;</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+  // How do we make the date at this point? Well, the JS date's constructor</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+  // builds the time in terms of the local timezone. To account for the offset</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+  // properly, we need to build in UTC.</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+  let finalDate = new Date(Date.UTC(year, month, day, hours, minutes, seconds)</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+    - tzOffsetInMin * 60 * 1000);</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+  // Suppose our header was mangled and we couldn't read it--some of the fields</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+  // became undefined. In that case, the date would become invalid, and the</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+  // indication that it is so is that the underlying number is a NaN. In that</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+  // scenario, we could build attempt to use JS Date parsing as a last-ditch</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+  // attempt. But it's not clear that such messages really exist in practice,</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+  // and the valid formats for Date in ES6 are unspecified.</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+  return finalDate;</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+}</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+</span>
<a href="#l1.310"></a><span id="l1.310"> ////////////////////////////////////////</span>
<a href="#l1.311"></a><span id="l1.311"> // Structured header decoding support //</span>
<a href="#l1.312"></a><span id="l1.312"> ////////////////////////////////////////</span>
<a href="#l1.313"></a><span id="l1.313"> </span>
<a href="#l1.314"></a><span id="l1.314"> // Load the default structured decoders</span>
<a href="#l1.315"></a><span id="l1.315"> var structuredDecoders = new Map();</span>
<a href="#l1.316"></a><span id="l1.316"> var structuredHeaders = require('./structuredHeaders');</span>
<a href="#l1.317"></a><span id="l1.317"> var preferredSpellings = structuredHeaders.spellings;</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineat">@@ -1059,17 +1189,21 @@ for (let pair of structuredHeaders.decod</span>
<a href="#l1.319"></a><span id="l1.319">  * - Resent-From</span>
<a href="#l1.320"></a><span id="l1.320">  * - Resent-Sender</span>
<a href="#l1.321"></a><span id="l1.321">  * - Resent-To</span>
<a href="#l1.322"></a><span id="l1.322">  * - Return-Receipt-To</span>
<a href="#l1.323"></a><span id="l1.323">  * - Sender</span>
<a href="#l1.324"></a><span id="l1.324">  * - To</span>
<a href="#l1.325"></a><span id="l1.325">  *</span>
<a href="#l1.326"></a><span id="l1.326">  * Date headers (results are the same as parseDateHeader):</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">- * - (TODO: Parsing support for these headers is currently unsupported)</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+ * - Date</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+ * - Expires</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+ * - Injection-Date</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+ * - NNTP-Posting-Date</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+ * - Resent-Date</span>
<a href="#l1.333"></a><span id="l1.333">  *</span>
<a href="#l1.334"></a><span id="l1.334">  * References headers (results are the same as parseReferencesHeader):</span>
<a href="#l1.335"></a><span id="l1.335">  * - (TODO: Parsing support for these headers is currently unsupported)</span>
<a href="#l1.336"></a><span id="l1.336">  *</span>
<a href="#l1.337"></a><span id="l1.337">  * Message-ID headers (results are the first entry of the result of</span>
<a href="#l1.338"></a><span id="l1.338">  * parseReferencesHeader):</span>
<a href="#l1.339"></a><span id="l1.339">  * - (TODO: Parsing support for these headers is currently unsupported)</span>
<a href="#l1.340"></a><span id="l1.340">  *</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineat">@@ -1149,16 +1283,17 @@ function addStructuredDecoder(header, de</span>
<a href="#l1.342"></a><span id="l1.342">     preferredSpellings.set(lowerHeader, header);</span>
<a href="#l1.343"></a><span id="l1.343"> }</span>
<a href="#l1.344"></a><span id="l1.344"> </span>
<a href="#l1.345"></a><span id="l1.345"> headerparser.addStructuredDecoder = addStructuredDecoder;</span>
<a href="#l1.346"></a><span id="l1.346"> headerparser.convert8BitHeader = convert8BitHeader;</span>
<a href="#l1.347"></a><span id="l1.347"> headerparser.decodeRFC2047Words = decodeRFC2047Words;</span>
<a href="#l1.348"></a><span id="l1.348"> headerparser.getHeaderTokens = getHeaderTokens;</span>
<a href="#l1.349"></a><span id="l1.349"> headerparser.parseAddressingHeader = parseAddressingHeader;</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+headerparser.parseDateHeader = parseDateHeader;</span>
<a href="#l1.351"></a><span id="l1.351"> headerparser.parseParameterHeader = parseParameterHeader;</span>
<a href="#l1.352"></a><span id="l1.352"> headerparser.parseStructuredHeader = parseStructuredHeader;</span>
<a href="#l1.353"></a><span id="l1.353"> return Object.freeze(headerparser);</span>
<a href="#l1.354"></a><span id="l1.354"> </span>
<a href="#l1.355"></a><span id="l1.355"> });</span>
<a href="#l1.356"></a><span id="l1.356"> </span>
<a href="#l1.357"></a><span id="l1.357"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.358"></a><span id="l1.358"> //                        JavaScript Raw MIME Parser                          //</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineat">@@ -2230,17 +2365,17 @@ def('headeremitter', function(require) {</span>
<a href="#l1.360"></a><span id="l1.360">  * same forms that would be parsed.</span>
<a href="#l1.361"></a><span id="l1.361">  */</span>
<a href="#l1.362"></a><span id="l1.362"> </span>
<a href="#l1.363"></a><span id="l1.363"> &quot;use strict&quot;;</span>
<a href="#l1.364"></a><span id="l1.364"> </span>
<a href="#l1.365"></a><span id="l1.365"> var mimeutils = require('./mimeutils');</span>
<a href="#l1.366"></a><span id="l1.366"> </span>
<a href="#l1.367"></a><span id="l1.367"> // Get the default structured encoders and add them to the map</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-var structuredHeaders = require('structuredHeaders');</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+var structuredHeaders = require('./structuredHeaders');</span>
<a href="#l1.370"></a><span id="l1.370"> var encoders = new Map();</span>
<a href="#l1.371"></a><span id="l1.371"> var preferredSpellings = structuredHeaders.spellings;</span>
<a href="#l1.372"></a><span id="l1.372"> for (let [header, encoder] of structuredHeaders.encoders) {</span>
<a href="#l1.373"></a><span id="l1.373">   addStructuredEncoder(header, encoder);</span>
<a href="#l1.374"></a><span id="l1.374"> }</span>
<a href="#l1.375"></a><span id="l1.375"> </span>
<a href="#l1.376"></a><span id="l1.376"> /// Clamp a value in the range [min, max], defaulting to def if it is undefined.</span>
<a href="#l1.377"></a><span id="l1.377"> function clamp(value, min, max, def) {</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineat">@@ -2493,21 +2628,23 @@ HeaderEmitter.prototype.addText = functi</span>
<a href="#l1.379"></a><span id="l1.379">  * @protected</span>
<a href="#l1.380"></a><span id="l1.380">  * @param {String}  text          The text to add to the output.</span>
<a href="#l1.381"></a><span id="l1.381">  * @param {String}  qchars        The set of characters that cannot appear</span>
<a href="#l1.382"></a><span id="l1.382">  *                                outside of a quoted string.</span>
<a href="#l1.383"></a><span id="l1.383">  * @param {Boolean} mayBreakAfter If true, the end of this text is a preferred</span>
<a href="#l1.384"></a><span id="l1.384">  *                                breakpoint.</span>
<a href="#l1.385"></a><span id="l1.385">  */</span>
<a href="#l1.386"></a><span id="l1.386"> HeaderEmitter.prototype.addQuotable = function (text, qchars, mayBreakAfter) {</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+  // No text -&gt; no need to be quoted (prevents strict warning errors).</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+  if (text.length == 0)</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+    return;</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+</span>
<a href="#l1.391"></a><span id="l1.391">   // Figure out if we need to quote the string. Don't quote a string which</span>
<a href="#l1.392"></a><span id="l1.392">   // already appears to be quoted.</span>
<a href="#l1.393"></a><span id="l1.393">   let needsQuote = false;</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-  if (!text.length)</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-    return;</span>
<a href="#l1.396"></a><span id="l1.396"> </span>
<a href="#l1.397"></a><span id="l1.397">   if (!(text[0] == '&quot;' &amp;&amp; text[text.length - 1] == '&quot;') &amp;&amp; qchars != '') {</span>
<a href="#l1.398"></a><span id="l1.398">     for (let i = 0; i &lt; text.length; i++) {</span>
<a href="#l1.399"></a><span id="l1.399">       if (qchars.contains(text[i])) {</span>
<a href="#l1.400"></a><span id="l1.400">         needsQuote = true;</span>
<a href="#l1.401"></a><span id="l1.401">         break;</span>
<a href="#l1.402"></a><span id="l1.402">       }</span>
<a href="#l1.403"></a><span id="l1.403">     }</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineat">@@ -2740,16 +2877,23 @@ HeaderEmitter.prototype.addStructuredHea</span>
<a href="#l1.405"></a><span id="l1.405">  * @see headerparser.parseAddressingHeader</span>
<a href="#l1.406"></a><span id="l1.406">  */</span>
<a href="#l1.407"></a><span id="l1.407"> HeaderEmitter.prototype.addAddress = function (addr) {</span>
<a href="#l1.408"></a><span id="l1.408">   // If we have a display name, add that first.</span>
<a href="#l1.409"></a><span id="l1.409">   if (addr.name) {</span>
<a href="#l1.410"></a><span id="l1.410">     // This is a simple estimate that keeps names on one line if possible.</span>
<a href="#l1.411"></a><span id="l1.411">     this._reserveTokenSpace(addr.name.length + addr.email.length + 3);</span>
<a href="#l1.412"></a><span id="l1.412">     this.addPhrase(addr.name, &quot;,()&lt;&gt;:;.\&quot;&quot;, true);</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+    // If we don't have an email address, don't write out the angle brackets for</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+    // the address. It's already an abnormal situation should this appear, and</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+    // this has better round-tripping properties.</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+    if (!addr.email)</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineplus">+      return;</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+</span>
<a href="#l1.420"></a><span id="l1.420">     this.addText(&quot;&lt;&quot;, false);</span>
<a href="#l1.421"></a><span id="l1.421">   }</span>
<a href="#l1.422"></a><span id="l1.422"> </span>
<a href="#l1.423"></a><span id="l1.423">   // Find the local-part and domain of the address, since the local-part may</span>
<a href="#l1.424"></a><span id="l1.424">   // need to be quoted separately. Note that the @ goes to the domain, so that</span>
<a href="#l1.425"></a><span id="l1.425">   // the local-part may be quoted if it needs to be.</span>
<a href="#l1.426"></a><span id="l1.426">   let at = addr.email.lastIndexOf(&quot;@&quot;);</span>
<a href="#l1.427"></a><span id="l1.427">   let localpart = &quot;&quot;, domain = &quot;&quot;</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineat">@@ -2777,20 +2921,16 @@ HeaderEmitter.prototype.addAddress = fun</span>
<a href="#l1.429"></a><span id="l1.429">  * @param {String}    [addrs[i].email] The email of the address to add.</span>
<a href="#l1.430"></a><span id="l1.430">  * @param {Address[]} [addrs[i].group] A list of email addresses in the group.</span>
<a href="#l1.431"></a><span id="l1.431">  * @see HeaderEmitter.addAddress</span>
<a href="#l1.432"></a><span id="l1.432">  * @see headerparser.parseAddressingHeader</span>
<a href="#l1.433"></a><span id="l1.433">  */</span>
<a href="#l1.434"></a><span id="l1.434"> HeaderEmitter.prototype.addAddresses = function (addresses) {</span>
<a href="#l1.435"></a><span id="l1.435">   let needsComma = false;</span>
<a href="#l1.436"></a><span id="l1.436">   for (let addr of addresses) {</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-    // Ignore a dummy empty address.</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-    if (&quot;email&quot; in addr &amp;&amp; addr.email === &quot;&quot;)</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-      continue;</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-</span>
<a href="#l1.441"></a><span id="l1.441">     // Add a comma if this is not the first element.</span>
<a href="#l1.442"></a><span id="l1.442">     if (needsComma)</span>
<a href="#l1.443"></a><span id="l1.443">       this.addText(&quot;, &quot;, true);</span>
<a href="#l1.444"></a><span id="l1.444">     needsComma = true;</span>
<a href="#l1.445"></a><span id="l1.445"> </span>
<a href="#l1.446"></a><span id="l1.446">     if (&quot;email&quot; in addr) {</span>
<a href="#l1.447"></a><span id="l1.447">       this.addAddress(addr);</span>
<a href="#l1.448"></a><span id="l1.448">     } else {</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineat">@@ -2817,16 +2957,75 @@ HeaderEmitter.prototype.addUnstructured </span>
<a href="#l1.450"></a><span id="l1.450">   if (text.length == 0)</span>
<a href="#l1.451"></a><span id="l1.451">     return;</span>
<a href="#l1.452"></a><span id="l1.452"> </span>
<a href="#l1.453"></a><span id="l1.453">   // Unstructured text is basically a phrase that can't be quoted. So, if we</span>
<a href="#l1.454"></a><span id="l1.454">   // have nothing in qchars, nothing should be quoted.</span>
<a href="#l1.455"></a><span id="l1.455">   this.addPhrase(text, &quot;&quot;, false);</span>
<a href="#l1.456"></a><span id="l1.456"> };</span>
<a href="#l1.457"></a><span id="l1.457"> </span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+/** RFC 822 labels for days of the week. */</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+const kDaysOfWeek = [&quot;Sun&quot;, &quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;];</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineplus">+/**</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+ * Formatting helper to output numbers between 0-9 as 00-09 instead.</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+ */</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+function padTo2Digits(num) {</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+  return num &lt; 10 ? &quot;0&quot; + num : num.toString();</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+}</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineplus">+</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineplus">+/**</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+ * Add a date/time field to the output, using the JS date object as the time</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+ * representation. The value will be output using the timezone offset of the</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineplus">+ * date object, which is usually the timezone of the user (modulo timezone and</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineplus">+ * DST changes).</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineplus">+ *</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineplus">+ * Note that if the date is an invalid date (its internal date parameter is a</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineplus">+ * NaN value), this method throws an error instead of generating an invalid</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineplus">+ * string.</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+ *</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+ * @public</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+ * @param {Date} date The date to be added to the output string.</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+ */</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineplus">+HeaderEmitter.prototype.addDate = function (date) {</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineplus">+  // Rather than make a header plastered with NaN values, throw an error on</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+  // specific invalid dates.</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+  if (isNaN(date.getTime()))</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+    throw new Error(&quot;Cannot encode an invalid date&quot;);</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineplus">+</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+  // RFC 5322 says years can't be before 1900. The after 9999 is a bit that</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+  // derives from the specification saying that years have 4 digits.</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+  if (date.getFullYear() &lt; 1900 || date.getFullYear() &gt; 9999)</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+    throw new Error(&quot;Date year is out of encodable range&quot;);</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineplus">+</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+  // Start by computing the timezone offset for a day. We lack a good format, so</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+  // the the 0-padding is done by hand. Note that the tzoffset we output is in</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+  // the form Â±hhmm, so we need to separate the offset (in minutes) into an hour</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+  // and minute pair.</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+  let tzOffset = date.getTimezoneOffset();</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+  let tzOffHours = Math.abs(Math.trunc(tzOffset / 60));</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineplus">+  let tzOffMinutes = Math.abs(tzOffset) % 60;</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineplus">+  let tzOffsetStr = (tzOffset &gt; 0 ? &quot;-&quot; : &quot;+&quot;) +</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+    padTo2Digits(tzOffHours) + padTo2Digits(tzOffMinutes);</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineplus">+</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+  // Convert the day-time figure into a single value to avoid unwanted line</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineplus">+  // breaks in the middle.</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineplus">+  let dayTime = [</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineplus">+    kDaysOfWeek[date.getDay()] + &quot;,&quot;,</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineplus">+    date.getDate(),</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineplus">+    mimeutils.kMonthNames[date.getMonth()],</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+    date.getFullYear(),</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineplus">+    padTo2Digits(date.getHours()) + &quot;:&quot; +</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+      padTo2Digits(date.getMinutes()) + &quot;:&quot; +</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+      padTo2Digits(date.getSeconds()),</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+    tzOffsetStr</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+  ].join(&quot; &quot;);</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+  this.addText(dayTime, false);</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+};</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+</span>
<a href="#l1.517"></a><span id="l1.517"> /**</span>
<a href="#l1.518"></a><span id="l1.518">  * Signal that the current header has been finished encoding.</span>
<a href="#l1.519"></a><span id="l1.519">  *</span>
<a href="#l1.520"></a><span id="l1.520">  * @public</span>
<a href="#l1.521"></a><span id="l1.521">  * @param {Boolean} deliverEOF If true, signal to the handler that no more text</span>
<a href="#l1.522"></a><span id="l1.522">  *                             will be arriving.</span>
<a href="#l1.523"></a><span id="l1.523">  */</span>
<a href="#l1.524"></a><span id="l1.524"> HeaderEmitter.prototype.finish = function (deliverEOF) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/head_xpcshell_glue.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/head_xpcshell_glue.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -48,17 +48,23 @@ var fs = {</span>
<a href="#l2.4"></a><span id="l2.4"> requireCache.set(&quot;fs&quot;, fs);</span>
<a href="#l2.5"></a><span id="l2.5"> Services.scriptloader.loadSubScript(&quot;resource:///modules/jsmime/jsmime.js&quot;);</span>
<a href="#l2.6"></a><span id="l2.6"> requireCache.set(&quot;jsmime&quot;, jsmime);</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> function require(path) {</span>
<a href="#l2.9"></a><span id="l2.9">   if (requireCache.has(path))</span>
<a href="#l2.10"></a><span id="l2.10">     return requireCache.get(path);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  var file = &quot;resource:///modules/jsmime/&quot; + path + &quot;.js&quot;;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  if (path.startsWith(&quot;test/&quot;)) {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    let name = path.substring(&quot;test/&quot;.length);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    var file = &quot;resource://testing-common/jsmime/&quot; + name + &quot;.js&quot;;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  } else {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    var file = &quot;resource:///modules/jsmime/&quot; + path + &quot;.js&quot;;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  }</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+</span>
<a href="#l2.20"></a><span id="l2.20">   var globalObject = {</span>
<a href="#l2.21"></a><span id="l2.21">     define: innerDefine.bind(this, path),</span>
<a href="#l2.22"></a><span id="l2.22">   };</span>
<a href="#l2.23"></a><span id="l2.23">   Services.scriptloader.loadSubScript(file, globalObject);</span>
<a href="#l2.24"></a><span id="l2.24">   return requireCache.get(path);</span>
<a href="#l2.25"></a><span id="l2.25"> }</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> function innerDefine(moduleName, dfn) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/mime/jsmime/test/mock_date.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,72 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+define(function (require) {</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+/**</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * A class which appears to act like the Date class with customizable timezone</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * offsets.</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * @param {String} iso8601String An ISO-8601 date/time string including a</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *                               timezone offset.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ */</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+function MockDate(iso8601String) {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  // Find the timezone offset (Z or Â±hhmm) from the ISO-8601 date string, and</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  // then convert that into a number of minutes.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  let parse = /\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(Z|[+-]\d{4})/.exec(iso8601String);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  let tzOffsetStr = parse[1];</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  if (tzOffsetStr == 'Z')</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    this._tzOffset = 0;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  else {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+    this._tzOffset = parseInt(tzOffsetStr.substring(1, 3)) * 60 +</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+      parseInt(tzOffsetStr.substring(3));</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    if (tzOffsetStr[0] == '-')</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+      this._tzOffset = -this._tzOffset;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  }</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  // To store the offset, we store both the real time in _realDate and a time</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  // that is offset by the tzOffset in _shiftedDate. Only the getUTC* methods</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  // should be used on these properties, to avoid problems caused by daylight</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  // savings time or other timezone effects. This shifting is always legal</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  // because ES6 is specified to assume that leap seconds do not exist, so there</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  // are always 60 seconds in a minute.</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  this._realDate = new Date(iso8601String);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  this._shiftedDate = new Date(this._realDate.getTime() +</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    this._tzOffset * 60 * 1000);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+}</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+MockDate.prototype = {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  getTimezoneOffset: function () {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+    // This property is reversed from how it's defined in ISO 8601, i.e.,</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    // UTC +0100 needs to return -60.</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    return -this._tzOffset;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  },</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  getTime: function () {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    return this._realDate.getTime();</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  }</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+};</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+// Provide an implementation of Date methods that will be need in JSMime. For</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+// the time being, we only need .get* methods.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+for (let name of Object.getOwnPropertyNames(Date.prototype)) {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+  // Only copy getters, not setters or x.toString.</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  if (!name.startsWith('get'))</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    continue;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  // No redefining any other names on MockDate.</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+  if (MockDate.prototype.hasOwnProperty(name))</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    continue;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  if (name.contains('UTC')) {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    // 'name' is already supposed to be freshly bound per newest ES6 drafts, but</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    // current ES6 implementations reuse the bindings. Until implementations</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    // catch up, use a new let to bind it freshly.</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    let boundName = name;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+    Object.defineProperty(MockDate.prototype, name, { value: function () {</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+      return Date.prototype[boundName].call(this._realDate, arguments);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    }});</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  } else {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+    let newName = 'getUTC' + name.substr(3);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    Object.defineProperty(MockDate.prototype, name, { value: function () {</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+      return Date.prototype[newName].call(this._shiftedDate, arguments);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    }});</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  }</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+}</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+return MockDate;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_header.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_header.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -323,16 +323,17 @@ suite('headerparser', function () {</span>
<a href="#l4.4"></a><span id="l4.4">          {name: &quot;extra&quot;, group: [{name: &quot;&quot;, email: &quot;a@foo.invalid&quot;}]}]],</span>
<a href="#l4.5"></a><span id="l4.5">       [&quot;a &lt; &lt;a@b.c&gt;&quot;, [{name: &quot;a&quot;, email: &quot;a@b.c&quot;}]],</span>
<a href="#l4.6"></a><span id="l4.6">       [&quot;Name &lt;incomplete@email&quot;, [{name: &quot;Name&quot;, email: &quot;incomplete@email&quot;}]],</span>
<a href="#l4.7"></a><span id="l4.7">       [&quot;Name &lt;space here@email.invalid&gt;&quot;,</span>
<a href="#l4.8"></a><span id="l4.8">         [{name: 'Name', email: '&quot;space here&quot;@email.invalid'}]],</span>
<a href="#l4.9"></a><span id="l4.9">       [&quot;Name &lt;not an email&gt;&quot;, [{name: &quot;Name&quot;, email: &quot;not an email&quot;}]],</span>
<a href="#l4.10"></a><span id="l4.10">       [&quot;=?UTF-8?Q?Simple?= &lt;a@b.c&gt;&quot;,</span>
<a href="#l4.11"></a><span id="l4.11">         [{name: &quot;=?UTF-8?Q?Simple?=&quot;, email: &quot;a@b.c&quot;}]],</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+      [&quot;No email address&quot;, [{name: &quot;No email address&quot;, email: &quot;&quot;}]],</span>
<a href="#l4.13"></a><span id="l4.13">     ];</span>
<a href="#l4.14"></a><span id="l4.14">     header_tests.forEach(function (data) {</span>
<a href="#l4.15"></a><span id="l4.15">       arrayTest(data, function () {</span>
<a href="#l4.16"></a><span id="l4.16">         assert.deepEqual(headerparser.parseAddressingHeader(data[0], false),</span>
<a href="#l4.17"></a><span id="l4.17">           data[1]);</span>
<a href="#l4.18"></a><span id="l4.18">       });</span>
<a href="#l4.19"></a><span id="l4.19">     });</span>
<a href="#l4.20"></a><span id="l4.20">   });</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -352,16 +353,112 @@ suite('headerparser', function () {</span>
<a href="#l4.22"></a><span id="l4.22">     ];</span>
<a href="#l4.23"></a><span id="l4.23">     header_tests.forEach(function (data) {</span>
<a href="#l4.24"></a><span id="l4.24">       arrayTest(data, function () {</span>
<a href="#l4.25"></a><span id="l4.25">         assert.deepEqual(headerparser.parseAddressingHeader(data[0], true),</span>
<a href="#l4.26"></a><span id="l4.26">           data[1]);</span>
<a href="#l4.27"></a><span id="l4.27">       });</span>
<a href="#l4.28"></a><span id="l4.28">     });</span>
<a href="#l4.29"></a><span id="l4.29">   });</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  suite('parseDateHeader', function () {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    let header_tests = [</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+      // Some basic tests, derived from searching for Date headers in a mailing</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+      // list archive.</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+      [&quot;Thu, 06 Sep 2012 08:08:21 -0700&quot;, &quot;2012-09-06T08:08:21-0700&quot;],</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+      [&quot;Thu, 6 Sep 2012 14:49:05 -0400&quot;, &quot;2012-09-06T14:49:05-0400&quot;],</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+      [&quot;Fri, 07 Sep 2012 07:30:11 -0700 (PDT)&quot;, &quot;2012-09-07T07:30:11-0700&quot;],</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+      [&quot;9 Sep 2012 21:03:59 -0000&quot;, &quot;2012-09-09T21:03:59Z&quot;],</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+      [&quot;Sun, 09 Sep 2012 19:10:59 -0400&quot;, &quot;2012-09-09T19:10:59-0400&quot;],</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      [&quot;Wed, 17 Jun 2009 10:12:25 +0530&quot;, &quot;2009-06-17T10:12:25+0530&quot;],</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+      // Exercise all the months.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      [&quot;Mon, 28 Jan 2013 13:35:05 -0500&quot;, &quot;2013-01-28T13:35:05-0500&quot;],</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+      [&quot;Wed, 29 Feb 2012 23:43:26 +0000&quot;, &quot;2012-02-29T23:43:26+0000&quot;],</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+      [&quot;Sat, 09 Mar 2013 18:24:47 -0500&quot;, &quot;2013-03-09T18:24:47-0500&quot;],</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+      [&quot;Sat, 27 Apr 2013 12:51:48 -0400&quot;, &quot;2013-04-27T12:51:48-0400&quot;],</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+      [&quot;Tue, 28 May 2013 17:21:13 +0800&quot;, &quot;2013-05-28T17:21:13+0800&quot;],</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+      [&quot;Mon, 17 Jun 2013 22:15:41 +0200&quot;, &quot;2013-06-17T22:15:41+0200&quot;],</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+      [&quot;Wed, 18 Jul 2012 13:50:47 +0900&quot;, &quot;2012-07-18T13:50:47+0900&quot;],</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+      [&quot;Mon, 13 Aug 2012 13:55:16 +0200&quot;, &quot;2012-08-13T13:55:16+0200&quot;],</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+      [&quot;Thu, 06 Sep 2012 19:49:47 -0400&quot;, &quot;2012-09-06T19:49:47-0400&quot;],</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+      [&quot;Mon, 22 Oct 2012 02:27:23 -0700&quot;, &quot;2012-10-22T02:27:23-0700&quot;],</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+      [&quot;Thu, 22 Nov 2012 09:04:24 +0800&quot;, &quot;2012-11-22T09:04:24+0800&quot;],</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+      [&quot;Sun, 25 Dec 2011 12:27:13 +0000&quot;, &quot;2011-12-25T12:27:13+0000&quot;],</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+      // Try out less common timezone offsets.</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      [&quot;Sun, 25 Dec 2011 12:27:13 +1337&quot;, &quot;2011-12-25T12:27:13+1337&quot;],</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+      [&quot;Sun, 25 Dec 2011 12:27:13 -1337&quot;, &quot;2011-12-25T12:27:13-1337&quot;],</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+      // Leap seconds! Except that since dates in JS don't believe they exist,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      // they get shoved to the next second.</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+      [&quot;30 Jun 2012 23:59:60 +0000&quot;, &quot;2012-07-01T00:00:00Z&quot;],</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+      [&quot;31 Dec 2008 23:59:60 +0000&quot;, &quot;2009-01-01T00:00:00Z&quot;],</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+      // This one doesn't exist (they are added only as needed on an irregular</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+      // basis), but it's plausible...</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+      [&quot;30 Jun 2030 23:59:60 +0000&quot;, &quot;2030-07-01T00:00:00Z&quot;],</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+      // ... and this one isn't.</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      [&quot;10 Jun 2030 13:39:60 +0000&quot;, &quot;2030-06-10T13:40:00Z&quot;],</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+      // How about leap seconds in other timezones?</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+      [&quot;30 Jun 2012 18:59:60 -0500&quot;, &quot;2012-07-01T00:00:00Z&quot;],</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+      // RFC 5322 obsolete date productions</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+      [&quot;Sun, 26 Jan 14 17:14:22 -0600&quot;, &quot;2014-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+      [&quot;Tue, 26 Jan 49 17:14:22 -0600&quot;, &quot;2049-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+      [&quot;Thu, 26 Jan 50 17:14:22 -0600&quot;, &quot;1950-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 EST&quot;, &quot;2014-01-26T17:14:22-0500&quot;],</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 CST&quot;, &quot;2014-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 MST&quot;, &quot;2014-01-26T17:14:22-0700&quot;],</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 PST&quot;, &quot;2014-01-26T17:14:22-0800&quot;],</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 AST&quot;, &quot;2014-01-26T17:14:22-0400&quot;],</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 NST&quot;, &quot;2014-01-26T17:14:22-0330&quot;],</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 MET&quot;, &quot;2014-01-26T17:14:22+0100&quot;],</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 EET&quot;, &quot;2014-01-26T17:14:22+0200&quot;],</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 JST&quot;, &quot;2014-01-26T17:14:22+0900&quot;],</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 GMT&quot;, &quot;2014-01-26T17:14:22+0000&quot;],</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 UT&quot;, &quot;2014-01-26T17:14:22+0000&quot;],</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+      // Daylight savings timezones, even though these aren't actually during</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+      // daylight savings time for the relevant jurisdictions.</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 EDT&quot;, &quot;2014-01-26T17:14:22-0400&quot;],</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 CDT&quot;, &quot;2014-01-26T17:14:22-0500&quot;],</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 MDT&quot;, &quot;2014-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 PDT&quot;, &quot;2014-01-26T17:14:22-0700&quot;],</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 BST&quot;, &quot;2014-01-26T17:14:22+0100&quot;],</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+      // Unknown time zone--assume UTC</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+      [&quot;Sun, 26 Jan 2014 17:14:22 QMT&quot;, &quot;2014-01-26T17:14:22+0000&quot;],</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+      // The following days of the week are incorrect.</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+      [&quot;Tue, 28 Jan 2013 13:35:05 -0500&quot;, &quot;2013-01-28T13:35:05-0500&quot;],</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+      [&quot;Thu, 26 Jan 14 17:14:22 -0600&quot;, &quot;2014-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+      [&quot;Fri, 26 Jan 49 17:14:22 -0600&quot;, &quot;2049-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+      [&quot;Mon, 26 Jan 50 17:14:22 -0600&quot;, &quot;1950-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+      // And for these 2 digit years, they are correct for the other century.</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+      [&quot;Mon, 26 Jan 14 17:14:22 -0600&quot;, &quot;2014-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+      [&quot;Wed, 26 Jan 49 17:14:22 -0600&quot;, &quot;2049-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+      [&quot;Wed, 26 Jan 50 17:14:22 -0600&quot;, &quot;1950-01-26T17:14:22-0600&quot;],</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+      // Try with some illegal names for days of the week or months of the year.</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      [&quot;Sam, 05 Apr 2014 15:04:13 -0500&quot;, &quot;2014-04-05T15:04:13-0500&quot;],</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      [&quot;Lun, 01 Apr 2014 15:04:13 -0500&quot;, &quot;2014-04-01T15:04:13-0500&quot;],</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      [&quot;Mar, 02 Apr 2014 15:04:13 -0500&quot;, &quot;2014-04-02T15:04:13-0500&quot;],</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+      [&quot;Mar, 02 April 2014 15:04:13 -0500&quot;, &quot;2014-04-02T15:04:13-0500&quot;],</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+      [&quot;Mar, 02 Avr 2014 15:04:13 -0500&quot;, NaN],</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+      [&quot;Tue, 02 A 2014 15:04:13 -0500&quot;, NaN],</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+      // A truly invalid date</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+      [&quot;Coincident with the rapture&quot;, NaN]</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    ];</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+    header_tests.forEach(function (data) {</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+      arrayTest(data, function () {</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+        assert.equal(headerparser.parseDateHeader(data[0]).toString(),</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+          new Date(data[1]).toString());</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+      });</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+    });</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+  });</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+</span>
<a href="#l4.126"></a><span id="l4.126">   suite('decodeRFC2047Words', function () {</span>
<a href="#l4.127"></a><span id="l4.127">     let header_tests = [</span>
<a href="#l4.128"></a><span id="l4.128">       // Some basic sanity tests for the test process</span>
<a href="#l4.129"></a><span id="l4.129">       [&quot;Test&quot;, &quot;Test&quot;],</span>
<a href="#l4.130"></a><span id="l4.130">       [&quot;Test 2&quot;, &quot;Test 2&quot;],</span>
<a href="#l4.131"></a><span id="l4.131">       [&quot;Basic  words&quot;, &quot;Basic  words&quot;],</span>
<a href="#l4.132"></a><span id="l4.132">       [&quot;Not a =? word&quot;, &quot;Not a =? word&quot;],</span>
<a href="#l4.133"></a><span id="l4.133"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_header_emitter.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_header_emitter.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l5.4"></a><span id="l5.4"> &quot;use strict&quot;;</span>
<a href="#l5.5"></a><span id="l5.5"> define(function(require) {</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> var assert = require('assert');</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-var headeremitter = require('jsmime').headeremitter;</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+var jsmime = require('jsmime');</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+var headeremitter = jsmime.headeremitter;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+var MockDate = require('test/mock_date');</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13"> function arrayTest(data, fn) {</span>
<a href="#l5.14"></a><span id="l5.14">   fn.toString = function () {</span>
<a href="#l5.15"></a><span id="l5.15">     let text = Function.prototype.toString.call(this);</span>
<a href="#l5.16"></a><span id="l5.16">     text = text.replace(/data\[([0-9]*)\]/g, function (m, p) {</span>
<a href="#l5.17"></a><span id="l5.17">       return JSON.stringify(data[p]);</span>
<a href="#l5.18"></a><span id="l5.18">     });</span>
<a href="#l5.19"></a><span id="l5.19">     return text;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineat">@@ -52,16 +54,17 @@ suite('headeremitter', function () {</span>
<a href="#l5.21"></a><span id="l5.21">       [[{name: &quot;&quot;, email: &quot;\&quot;hi!bad\&quot;@all.com&quot;}], &quot;\&quot;hi!bad\&quot;@all.com&quot;],</span>
<a href="#l5.22"></a><span id="l5.22">       [[{name: &quot;Doe, John&quot;, email: &quot;a@a.com&quot;}], &quot;\&quot;Doe, John\&quot; &lt;a@a.com&gt;&quot;],</span>
<a href="#l5.23"></a><span id="l5.23">       // This one violates the line length, so it underquotes instead.</span>
<a href="#l5.24"></a><span id="l5.24">       [[{name: &quot;A really, really long name to quote&quot;, email: &quot;a@example.com&quot;}],</span>
<a href="#l5.25"></a><span id="l5.25">         &quot;A \&quot;really,\&quot; really long name\r\n to quote &lt;a@example.com&gt;&quot;],</span>
<a href="#l5.26"></a><span id="l5.26">       [[{name: &quot;Group&quot;, group: [{name: &quot;&quot;, email: &quot;a@a.c&quot;},</span>
<a href="#l5.27"></a><span id="l5.27">                                 {name: &quot;&quot;, email: &quot;b@b.c&quot;}]}],</span>
<a href="#l5.28"></a><span id="l5.28">         &quot;Group: a@a.c, b@b.c;&quot;],</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+      [[{name: &quot;No email address&quot;, email: &quot;&quot;}], &quot;No email address&quot;],</span>
<a href="#l5.30"></a><span id="l5.30">     ];</span>
<a href="#l5.31"></a><span id="l5.31">     header_tests.forEach(function (data) {</span>
<a href="#l5.32"></a><span id="l5.32">       arrayTest(data, function () {</span>
<a href="#l5.33"></a><span id="l5.33">         let emitter = headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l5.34"></a><span id="l5.34">           softMargin: 30,</span>
<a href="#l5.35"></a><span id="l5.35">           useASCII: false,</span>
<a href="#l5.36"></a><span id="l5.36">         });</span>
<a href="#l5.37"></a><span id="l5.37">         handler.reset(data[1]);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineat">@@ -177,16 +180,136 @@ suite('headeremitter', function () {</span>
<a href="#l5.39"></a><span id="l5.39">           useASCII: true</span>
<a href="#l5.40"></a><span id="l5.40">         });</span>
<a href="#l5.41"></a><span id="l5.41">         handler.reset(data[1]);</span>
<a href="#l5.42"></a><span id="l5.42">         emitter.addUnstructured(data[0]);</span>
<a href="#l5.43"></a><span id="l5.43">         emitter.finish(true);</span>
<a href="#l5.44"></a><span id="l5.44">       });</span>
<a href="#l5.45"></a><span id="l5.45">     });</span>
<a href="#l5.46"></a><span id="l5.46">   });</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  suite(&quot;addDate&quot;, function () {</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+    let handler = {</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+      reset: function (expected) {</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+        this.output = '';</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+        this.expected = expected;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+      },</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+      deliverData: function (data) { this.output += data; },</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+      deliverEOF: function () {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+        assert.equal(this.output, this.expected + '\r\n');</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+      }</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+    };</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+    let header_tests = [</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+      // Test basic day/month names</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      [&quot;2000-01-01T00:00:00Z&quot;, &quot;Sat, 1 Jan 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      [&quot;2000-02-01T00:00:00Z&quot;, &quot;Tue, 1 Feb 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+      [&quot;2000-03-01T00:00:00Z&quot;, &quot;Wed, 1 Mar 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+      [&quot;2000-04-01T00:00:00Z&quot;, &quot;Sat, 1 Apr 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+      [&quot;2000-05-01T00:00:00Z&quot;, &quot;Mon, 1 May 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+      [&quot;2000-06-01T00:00:00Z&quot;, &quot;Thu, 1 Jun 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+      [&quot;2000-07-01T00:00:00Z&quot;, &quot;Sat, 1 Jul 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+      [&quot;2000-08-01T00:00:00Z&quot;, &quot;Tue, 1 Aug 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+      [&quot;2000-09-01T00:00:00Z&quot;, &quot;Fri, 1 Sep 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+      [&quot;2000-10-01T00:00:00Z&quot;, &quot;Sun, 1 Oct 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+      [&quot;2000-11-01T00:00:00Z&quot;, &quot;Wed, 1 Nov 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+      [&quot;2000-12-01T00:00:00Z&quot;, &quot;Fri, 1 Dec 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+      // Test timezone offsets</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+      [&quot;2000-06-01T12:00:00Z&quot;, &quot;Thu, 1 Jun 2000 12:00:00 +0000&quot;],</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+      [&quot;2000-06-01T12:00:00+0100&quot;, &quot;Thu, 1 Jun 2000 12:00:00 +0100&quot;],</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+      [&quot;2000-06-01T12:00:00+0130&quot;, &quot;Thu, 1 Jun 2000 12:00:00 +0130&quot;],</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+      [&quot;2000-06-01T12:00:00-0100&quot;, &quot;Thu, 1 Jun 2000 12:00:00 -0100&quot;],</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+      [&quot;2000-06-01T12:00:00-0130&quot;, &quot;Thu, 1 Jun 2000 12:00:00 -0130&quot;],</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+      [&quot;2000-06-01T12:00:00+1345&quot;, &quot;Thu, 1 Jun 2000 12:00:00 +1345&quot;],</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+      [&quot;2000-06-01T12:00:00-1200&quot;, &quot;Thu, 1 Jun 2000 12:00:00 -1200&quot;],</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+      [&quot;2000-06-01T12:00:00+1337&quot;, &quot;Thu, 1 Jun 2000 12:00:00 +1337&quot;],</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+      [&quot;2000-06-01T12:00:00+0101&quot;, &quot;Thu, 1 Jun 2000 12:00:00 +0101&quot;],</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+      [&quot;2000-06-01T12:00:00-1337&quot;, &quot;Thu, 1 Jun 2000 12:00:00 -1337&quot;],</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+      // Try some varying hour, minute, and second amounts, to double-check</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+      // padding and time dates.</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+      [&quot;2000-06-01T01:02:03Z&quot;, &quot;Thu, 1 Jun 2000 01:02:03 +0000&quot;],</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+      [&quot;2000-06-01T23:13:17Z&quot;, &quot;Thu, 1 Jun 2000 23:13:17 +0000&quot;],</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+      [&quot;2000-06-01T00:05:04Z&quot;, &quot;Thu, 1 Jun 2000 00:05:04 +0000&quot;],</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+      [&quot;2000-06-01T23:59:59Z&quot;, &quot;Thu, 1 Jun 2000 23:59:59 +0000&quot;],</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+      [&quot;2000-06-01T13:17:40Z&quot;, &quot;Thu, 1 Jun 2000 13:17:40 +0000&quot;],</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+      [&quot;2000-06-01T11:15:34Z&quot;, &quot;Thu, 1 Jun 2000 11:15:34 +0000&quot;],</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+      [&quot;2000-06-01T04:09:09Z&quot;, &quot;Thu, 1 Jun 2000 04:09:09 +0000&quot;],</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+      [&quot;2000-06-01T04:10:10Z&quot;, &quot;Thu, 1 Jun 2000 04:10:10 +0000&quot;],</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+      [&quot;2000-06-01T09:13:17Z&quot;, &quot;Thu, 1 Jun 2000 09:13:17 +0000&quot;],</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+      [&quot;2000-06-01T13:12:14Z&quot;, &quot;Thu, 1 Jun 2000 13:12:14 +0000&quot;],</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+      [&quot;2000-06-01T14:16:48Z&quot;, &quot;Thu, 1 Jun 2000 14:16:48 +0000&quot;],</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+      // Try varying month, date, and year values.</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+      [&quot;2000-01-31T00:00:00Z&quot;, &quot;Mon, 31 Jan 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+      [&quot;2000-02-28T00:00:00Z&quot;, &quot;Mon, 28 Feb 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+      [&quot;2000-02-29T00:00:00Z&quot;, &quot;Tue, 29 Feb 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+      [&quot;2001-02-28T00:00:00Z&quot;, &quot;Wed, 28 Feb 2001 00:00:00 +0000&quot;],</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+      [&quot;2000-03-31T00:00:00Z&quot;, &quot;Fri, 31 Mar 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+      [&quot;2000-04-30T00:00:00Z&quot;, &quot;Sun, 30 Apr 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+      [&quot;2000-05-31T00:00:00Z&quot;, &quot;Wed, 31 May 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+      [&quot;2000-06-30T00:00:00Z&quot;, &quot;Fri, 30 Jun 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+      [&quot;2000-07-31T00:00:00Z&quot;, &quot;Mon, 31 Jul 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+      [&quot;2000-08-31T00:00:00Z&quot;, &quot;Thu, 31 Aug 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+      [&quot;2000-09-30T00:00:00Z&quot;, &quot;Sat, 30 Sep 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+      [&quot;2000-10-31T00:00:00Z&quot;, &quot;Tue, 31 Oct 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+      [&quot;2000-11-30T00:00:00Z&quot;, &quot;Thu, 30 Nov 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+      [&quot;2000-12-31T00:00:00Z&quot;, &quot;Sun, 31 Dec 2000 00:00:00 +0000&quot;],</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+      [&quot;1900-01-01T00:00:00Z&quot;, &quot;Mon, 1 Jan 1900 00:00:00 +0000&quot;],</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+      [&quot;9999-12-31T23:59:59Z&quot;, &quot;Fri, 31 Dec 9999 23:59:59 +0000&quot;],</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+      // Tests that are not actually missing:</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+      // We don't actually need to test daylight savings time issues, so long as</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+      // getTimezoneOffset is correct. We've confirmed black-box that the value</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+      // is being directly queried on every instance, since we have tests that</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+      // make MockDate.getTimezoneOffset return different values.</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+      // In addition, ES6 Date objects don't support leap seconds. Invalid dates</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+      // per RFC 5322 are handled in a later run of code.</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+    ];</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+    header_tests.forEach(function (data) {</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+      arrayTest(data, function () {</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+        let emitter = headeremitter.makeStreamingEmitter(handler, { });</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+        handler.reset(data[1]);</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+        emitter.addDate(new MockDate(data[0]));</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+        emitter.finish(true);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+      });</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+    });</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+    // An invalid date should throw an error instead of make a malformed header.</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+    test('Invalid dates', function () {</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+      let emitter = headeremitter.makeStreamingEmitter(handler, { });</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+      assert.throws(function () { emitter.addDate(new Date(NaN)); });</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+      assert.throws(function () { emitter.addDate(new Date(&quot;1850-01-01&quot;)); });</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+      assert.throws(function () { emitter.addDate(new Date(&quot;10000-01-01&quot;)); });</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+    });</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+    // Test preferred breaking for the date header.</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    test('Break spot', function () {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+      let emitter = headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+        softMargin: 30</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+      });</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+      handler.reset(&quot;Overly-Long-Date:\r\n Sat, 1 Jan 2000 00:00:00 +0000&quot;);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+      emitter.addHeaderName(&quot;Overly-Long-Date&quot;);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+      emitter.addDate(new MockDate(&quot;2000-01-01T00:00:00Z&quot;));</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+      emitter.finish();</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+    });</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+    test('Correctness of date', function () {</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+      let emitter = headeremitter.makeStreamingEmitter(handler, { });</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+      handler.reset();</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+      let now = new Date();</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+      emitter.addDate(now);</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+      emitter.finish();</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+      // All engines can parse the date strings we produce</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+      let reparsed = new Date(handler.output);</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+      // Now and reparsed should be correct to second-level precision.</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+      assert.equal(reparsed.getMilliseconds(), 0);</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+      assert.equal(now.getTime() - now.getMilliseconds(), reparsed.getTime());</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+    });</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+  });</span>
<a href="#l5.167"></a><span id="l5.167"> </span>
<a href="#l5.168"></a><span id="l5.168">   suite(&quot;Header lengths&quot;, function () {</span>
<a href="#l5.169"></a><span id="l5.169">     let handler = {</span>
<a href="#l5.170"></a><span id="l5.170">       reset: function (expected) {</span>
<a href="#l5.171"></a><span id="l5.171">         this.output = '';</span>
<a href="#l5.172"></a><span id="l5.172">         this.expected = expected;</span>
<a href="#l5.173"></a><span id="l5.173">       },</span>
<a href="#l5.174"></a><span id="l5.174">       deliverData: function (data) { this.output += data; },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_structured_header_emitters.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_structured_header_emitters.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l6.4"></a><span id="l6.4"> &quot;use strict&quot;;</span>
<a href="#l6.5"></a><span id="l6.5"> define(function (require) {</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> var assert = require('assert');</span>
<a href="#l6.8"></a><span id="l6.8"> var headeremitter = require('jsmime').headeremitter;</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+var MockDate = require('test/mock_date');</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> function arrayTest(data, fn) {</span>
<a href="#l6.12"></a><span id="l6.12">   fn.toString = function () {</span>
<a href="#l6.13"></a><span id="l6.13">     let text = Function.prototype.toString.call(this);</span>
<a href="#l6.14"></a><span id="l6.14">     text = text.replace(/data\[([0-9]*)\]/g, function (m, p) {</span>
<a href="#l6.15"></a><span id="l6.15">       return JSON.stringify(data[p]);</span>
<a href="#l6.16"></a><span id="l6.16">     });</span>
<a href="#l6.17"></a><span id="l6.17">     return text;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineat">@@ -50,16 +51,25 @@ suite('Structured header emitters', func</span>
<a href="#l6.19"></a><span id="l6.19">       &quot;John Doe &lt;john.doe@test.invalid&gt;&quot;],</span>
<a href="#l6.20"></a><span id="l6.20">     [{name: &quot;undisclosed-recipients&quot;, group: []},</span>
<a href="#l6.21"></a><span id="l6.21">       &quot;undisclosed-recipients: ;&quot;],</span>
<a href="#l6.22"></a><span id="l6.22">   ];</span>
<a href="#l6.23"></a><span id="l6.23">   addressing_headers.forEach(function (header) {</span>
<a href="#l6.24"></a><span id="l6.24">     testHeader(header, address_tests);</span>
<a href="#l6.25"></a><span id="l6.25">   });</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  let date_headers = ['Date', 'Expires', 'Injection-Date', 'NNTP-Posting-Date',</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    'Resent-Date'];</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  let date_tests = [</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+    [new MockDate(&quot;2012-09-06T08:08:21-0700&quot;), &quot;Thu, 6 Sep 2012 08:08:21 -0700&quot;],</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  ];</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  date_headers.forEach(function (header) {</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    testHeader(header, date_tests);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  });</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+</span>
<a href="#l6.36"></a><span id="l6.36">   let unstructured_headers = ['Comments', 'Content-Description', 'Keywords',</span>
<a href="#l6.37"></a><span id="l6.37">     'Subject'];</span>
<a href="#l6.38"></a><span id="l6.38">   let unstructured_tests = [</span>
<a href="#l6.39"></a><span id="l6.39">     [&quot;&quot;, &quot;&quot;],</span>
<a href="#l6.40"></a><span id="l6.40">     [&quot;This is a subject&quot;, &quot;This is a subject&quot;],</span>
<a href="#l6.41"></a><span id="l6.41">     [&quot;\u79c1\u306f\u4ef6\u540d\u5348\u524d&quot;,</span>
<a href="#l6.42"></a><span id="l6.42">       &quot;=?UTF-8?B?56eB44Gv5Lu25ZCN5Y2I5YmN?=&quot;],</span>
<a href="#l6.43"></a><span id="l6.43">   ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_structured_headers.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_structured_headers.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -122,16 +122,26 @@ suite('Structured headers', function () </span>
<a href="#l7.4"></a><span id="l7.4">     [[&quot;a@example.invalid&quot;, &quot;b@example.invalid&quot;],</span>
<a href="#l7.5"></a><span id="l7.5">       [{name: &quot;&quot;, email: &quot;a@example.invalid&quot;},</span>
<a href="#l7.6"></a><span id="l7.6">        {name: &quot;&quot;, email: &quot;b@example.invalid&quot;}]],</span>
<a href="#l7.7"></a><span id="l7.7">   ];</span>
<a href="#l7.8"></a><span id="l7.8">   addressing_headers.forEach(function (header) {</span>
<a href="#l7.9"></a><span id="l7.9">     testHeader(header, address_tests);</span>
<a href="#l7.10"></a><span id="l7.10">   });</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  let date_headers = ['Date', 'Expires', 'Injection-Date', 'NNTP-Posting-Date',</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    'Resent-Date'];</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  let date_tests = [</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    [&quot;Thu, 06 Sep 2012 08:08:21 -0700&quot;, new Date(&quot;2012-09-06T08:08:21-0700&quot;)],</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    [&quot;This is so not a date&quot;, new Date(NaN)],</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  ];</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  date_headers.forEach(function (header) {</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+    testHeader(header, date_tests);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  });</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22">   let unstructured_headers = ['Comments', 'Content-Description', 'Keywords',</span>
<a href="#l7.23"></a><span id="l7.23">     'Subject'];</span>
<a href="#l7.24"></a><span id="l7.24">   let unstructured_tests = [</span>
<a href="#l7.25"></a><span id="l7.25">     [&quot;&quot;, &quot;&quot;],</span>
<a href="#l7.26"></a><span id="l7.26">     [&quot;This is a subject&quot;, &quot;This is a subject&quot;],</span>
<a href="#l7.27"></a><span id="l7.27">     [[&quot;Subject 1&quot;, &quot;Subject 2&quot;], &quot;Subject 1&quot;],</span>
<a href="#l7.28"></a><span id="l7.28">     [&quot;=?UTF-8?B?56eB44Gv5Lu25ZCN5Y2I5YmN?=&quot;,</span>
<a href="#l7.29"></a><span id="l7.29">       &quot;\u79c1\u306f\u4ef6\u540d\u5348\u524d&quot;],</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/moz.build</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/moz.build</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -11,9 +11,13 @@ DIRS += [</span>
<a href="#l8.4"></a><span id="l8.4"> ]</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> TEST_DIRS += ['test']</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> EXTRA_JS_MODULES.jsmime += [</span>
<a href="#l8.9"></a><span id="l8.9">     'jsmime/jsmime.js',</span>
<a href="#l8.10"></a><span id="l8.10"> ]</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+TESTING_JS_MODULES.jsmime += [</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    'jsmime/test/mock_date.js',</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+]</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+</span>
<a href="#l8.16"></a><span id="l8.16"> XPCSHELL_TESTS_MANIFESTS += ['jsmime/test/xpcshell.ini']</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

