<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25917:fe1eb4ebd5aeb256457fbaa482fc36f72128325a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ fe1eb4ebd5aeb256457fbaa482fc36f72128325a" />
<meta property="og:url" content="/comm-central/rev/fe1eb4ebd5aeb256457fbaa482fc36f72128325a" />
<meta property="og:description" content="Bug 1525190 - Run eslint --fix over all chat protocols code. r=florian" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / fe1eb4ebd5aeb256457fbaa482fc36f72128325a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/fe1eb4ebd5aeb256457fbaa482fc36f72128325a">shortlog</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/fe1eb4ebd5aeb256457fbaa482fc36f72128325a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a">files</a> |
changeset |
<a href="/comm-central/raw-rev/fe1eb4ebd5aeb256457fbaa482fc36f72128325a">raw</a>  | <a href="/comm-central/archive/fe1eb4ebd5aeb256457fbaa482fc36f72128325a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">Bug 1525190</a> - Run eslint --fix over all chat protocols code. r=florian
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#116;&#114;&#105;&#99;&#107;&#32;&#67;&#108;&#111;&#107;&#101;&#32;&#60;&#99;&#108;&#111;&#107;&#101;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 21 Feb 2019 16:19:04 -0500</td></tr>

<tr>
 <td>changeset 25917</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/fe1eb4ebd5aeb256457fbaa482fc36f72128325a">fe1eb4ebd5aeb256457fbaa482fc36f72128325a</a></td>
</tr>



<tr>
<td>parent 25916</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f9fa8017bac2b962c453186e2e6308a4783b04cd">f9fa8017bac2b962c453186e2e6308a4783b04cd</a>
</td>
</tr>

<tr>
<td>child 25918</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d0b6a5026d02ce8e4d65da21725d23e337a3337f">d0b6a5026d02ce8e4d65da21725d23e337a3337f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=fe1eb4ebd5aeb256457fbaa482fc36f72128325a">15550</a></td></tr>
<tr><td>push user</td><td>clokep@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 21 Feb 2019 21:24:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d0b6a5026d02 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d0b6a5026d02ce8e4d65da21725d23e337a3337f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d0b6a5026d02ce8e4d65da21725d23e337a3337f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d0b6a5026d02ce8e4d65da21725d23e337a3337f&newProject=comm-central&newRevision=fe1eb4ebd5aeb256457fbaa482fc36f72128325a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d0b6a5026d02ce8e4d65da21725d23e337a3337f&newProject=comm-central&newRevision=fe1eb4ebd5aeb256457fbaa482fc36f72128325a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d0b6a5026d02ce8e4d65da21725d23e337a3337f&newProject=comm-central&newRevision=fe1eb4ebd5aeb256457fbaa482fc36f72128325a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">1525190</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">Bug 1525190</a> - Run eslint --fix over all chat protocols code. r=florian</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/facebook/facebook.js">chat/protocols/facebook/facebook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/facebook/facebook.js">file</a> |
<a href="/comm-central/annotate/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/facebook/facebook.js">annotate</a> |
<a href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/facebook/facebook.js">diff</a> |
<a href="/comm-central/comparison/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/facebook/facebook.js">comparison</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/facebook/facebook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/jsTest/jsTestProtocol.js">chat/protocols/jsTest/jsTestProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/jsTest/jsTestProtocol.js">file</a> |
<a href="/comm-central/annotate/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/jsTest/jsTestProtocol.js">annotate</a> |
<a href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/jsTest/jsTestProtocol.js">diff</a> |
<a href="/comm-central/comparison/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/jsTest/jsTestProtocol.js">comparison</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/jsTest/jsTestProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix-sdk.jsm">chat/protocols/matrix/matrix-sdk.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix-sdk.jsm">file</a> |
<a href="/comm-central/annotate/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix-sdk.jsm">annotate</a> |
<a href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix-sdk.jsm">diff</a> |
<a href="/comm-central/comparison/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix-sdk.jsm">comparison</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix-sdk.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix.js">chat/protocols/matrix/matrix.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix.js">file</a> |
<a href="/comm-central/annotate/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix.js">annotate</a> |
<a href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix.js">diff</a> |
<a href="/comm-central/comparison/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix.js">comparison</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/matrix/matrix.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/skype.js">chat/protocols/skype/skype.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/skype.js">file</a> |
<a href="/comm-central/annotate/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/skype.js">annotate</a> |
<a href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/skype.js">diff</a> |
<a href="/comm-central/comparison/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/skype.js">comparison</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/skype.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_MagicSha256.js">chat/protocols/skype/test/test_MagicSha256.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_MagicSha256.js">file</a> |
<a href="/comm-central/annotate/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_MagicSha256.js">annotate</a> |
<a href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_MagicSha256.js">diff</a> |
<a href="/comm-central/comparison/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_MagicSha256.js">comparison</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_MagicSha256.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_contactUrlToName.js">chat/protocols/skype/test/test_contactUrlToName.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_contactUrlToName.js">file</a> |
<a href="/comm-central/annotate/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_contactUrlToName.js">annotate</a> |
<a href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_contactUrlToName.js">diff</a> |
<a href="/comm-central/comparison/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_contactUrlToName.js">comparison</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/skype/test/test_contactUrlToName.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/yahoo/yahoo.js">chat/protocols/yahoo/yahoo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/yahoo/yahoo.js">file</a> |
<a href="/comm-central/annotate/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/yahoo/yahoo.js">annotate</a> |
<a href="/comm-central/diff/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/yahoo/yahoo.js">diff</a> |
<a href="/comm-central/comparison/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/yahoo/yahoo.js">comparison</a> |
<a href="/comm-central/log/fe1eb4ebd5aeb256457fbaa482fc36f72128325a/chat/protocols/yahoo/yahoo.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/protocols/facebook/facebook.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/protocols/facebook/facebook.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -31,28 +31,28 @@ XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, (</span>
<a href="#l1.4"></a><span id="l1.4"> );</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> function FacebookAccount(aProtoInstance, aImAccount) {</span>
<a href="#l1.7"></a><span id="l1.7">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l1.8"></a><span id="l1.8"> }</span>
<a href="#l1.9"></a><span id="l1.9"> FacebookAccount.prototype = {</span>
<a href="#l1.10"></a><span id="l1.10">   __proto__: GenericAccountPrototype,</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  connect: function() {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  connect() {</span>
<a href="#l1.14"></a><span id="l1.14">     this.WARN(&quot;As Facebook deprecated its XMPP gateway, it is currently not &quot; +</span>
<a href="#l1.15"></a><span id="l1.15">               &quot;possible to connect to Facebook Chat. See bug 1141674.&quot;);</span>
<a href="#l1.16"></a><span id="l1.16">     this.reportDisconnecting(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l1.17"></a><span id="l1.17">                              _(&quot;facebook.disabled&quot;));</span>
<a href="#l1.18"></a><span id="l1.18">     this.reportDisconnected();</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  }</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+  },</span>
<a href="#l1.21"></a><span id="l1.21"> };</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> function FacebookProtocol() {}</span>
<a href="#l1.24"></a><span id="l1.24"> FacebookProtocol.prototype = {</span>
<a href="#l1.25"></a><span id="l1.25">   __proto__: GenericProtocolPrototype,</span>
<a href="#l1.26"></a><span id="l1.26">   get normalizedName() { return &quot;facebook&quot;; },</span>
<a href="#l1.27"></a><span id="l1.27">   get name() { return _(&quot;facebook.chat.name&quot;); },</span>
<a href="#l1.28"></a><span id="l1.28">   get iconBaseURI() { return &quot;chrome://prpl-facebook/skin/&quot;; },</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-  getAccount: function(aImAccount) { return new FacebookAccount(this, aImAccount); },</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  classID: Components.ID(&quot;{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}&quot;)</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  getAccount(aImAccount) { return new FacebookAccount(this, aImAccount); },</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  classID: Components.ID(&quot;{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}&quot;),</span>
<a href="#l1.33"></a><span id="l1.33"> };</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([FacebookProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -28,24 +28,24 @@ var {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> function Conversation(aAccount)</span>
<a href="#l2.6"></a><span id="l2.6"> {</span>
<a href="#l2.7"></a><span id="l2.7">   this._init(aAccount);</span>
<a href="#l2.8"></a><span id="l2.8"> }</span>
<a href="#l2.9"></a><span id="l2.9"> Conversation.prototype = {</span>
<a href="#l2.10"></a><span id="l2.10">   __proto__: GenericConvIMPrototype,</span>
<a href="#l2.11"></a><span id="l2.11">   _disconnected: false,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  _setDisconnected: function() {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  _setDisconnected() {</span>
<a href="#l2.14"></a><span id="l2.14">     this._disconnected = true;</span>
<a href="#l2.15"></a><span id="l2.15">   },</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  close: function() {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  close() {</span>
<a href="#l2.18"></a><span id="l2.18">     if (!this._disconnected)</span>
<a href="#l2.19"></a><span id="l2.19">       this.account.disconnect(true);</span>
<a href="#l2.20"></a><span id="l2.20">   },</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  sendMsg: function (aMsg) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l2.23"></a><span id="l2.23">     if (this._disconnected) {</span>
<a href="#l2.24"></a><span id="l2.24">       this.writeMessage(&quot;jstest&quot;, &quot;This message could not be sent because the conversation is no longer active: &quot; + aMsg, {system: true, error: true});</span>
<a href="#l2.25"></a><span id="l2.25">       return;</span>
<a href="#l2.26"></a><span id="l2.26">     }</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">     this.writeMessage(&quot;You&quot;, aMsg, {outgoing: true});</span>
<a href="#l2.29"></a><span id="l2.29">     this.writeMessage(&quot;/dev/null&quot;, &quot;Thanks! I appreciate your attention.&quot;,</span>
<a href="#l2.30"></a><span id="l2.30">                       {incoming: true, autoResponse: true});</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineat">@@ -55,27 +55,27 @@ Conversation.prototype = {</span>
<a href="#l2.32"></a><span id="l2.32"> };</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> function Account(aProtoInstance, aImAccount)</span>
<a href="#l2.35"></a><span id="l2.35"> {</span>
<a href="#l2.36"></a><span id="l2.36">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l2.37"></a><span id="l2.37"> }</span>
<a href="#l2.38"></a><span id="l2.38"> Account.prototype = {</span>
<a href="#l2.39"></a><span id="l2.39">   __proto__: GenericAccountPrototype,</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  connect: function() {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  connect() {</span>
<a href="#l2.42"></a><span id="l2.42">     this.reportConnecting();</span>
<a href="#l2.43"></a><span id="l2.43">     // do something here</span>
<a href="#l2.44"></a><span id="l2.44">     this.reportConnected();</span>
<a href="#l2.45"></a><span id="l2.45">     setTimeout((function() {</span>
<a href="#l2.46"></a><span id="l2.46">       this._conv = new Conversation(this);</span>
<a href="#l2.47"></a><span id="l2.47">       this._conv.writeMessage(&quot;jstest&quot;, &quot;You are now talking to /dev/null&quot;, {system: true});</span>
<a href="#l2.48"></a><span id="l2.48">     }).bind(this), 0);</span>
<a href="#l2.49"></a><span id="l2.49">   },</span>
<a href="#l2.50"></a><span id="l2.50">   _conv: null,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  disconnect: function(aSilent) {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  disconnect(aSilent) {</span>
<a href="#l2.53"></a><span id="l2.53">     this.reportDisconnecting(Ci.prplIAccount.NO_ERROR, &quot;&quot;);</span>
<a href="#l2.54"></a><span id="l2.54">     if (!aSilent)</span>
<a href="#l2.55"></a><span id="l2.55">       this._conv.writeMessage(&quot;jstest&quot;, &quot;You have disconnected.&quot;, {system: true});</span>
<a href="#l2.56"></a><span id="l2.56">     if (this._conv) {</span>
<a href="#l2.57"></a><span id="l2.57">       this._conv._setDisconnected();</span>
<a href="#l2.58"></a><span id="l2.58">       delete this._conv;</span>
<a href="#l2.59"></a><span id="l2.59">     }</span>
<a href="#l2.60"></a><span id="l2.60">     this.reportDisconnected();</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineat">@@ -83,34 +83,34 @@ Account.prototype = {</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63">   get canJoinChat() { return true; },</span>
<a href="#l2.64"></a><span id="l2.64">   chatRoomFields: {</span>
<a href="#l2.65"></a><span id="l2.65">     channel: {label: &quot;_Channel Field&quot;, required: true},</span>
<a href="#l2.66"></a><span id="l2.66">     channelDefault: {label: &quot;_Field with default&quot;, default: &quot;Default Value&quot;},</span>
<a href="#l2.67"></a><span id="l2.67">     password: {label: &quot;_Password Field&quot;, default: &quot;&quot;, isPassword: true,</span>
<a href="#l2.68"></a><span id="l2.68">                required: false},</span>
<a href="#l2.69"></a><span id="l2.69">     sampleIntField: {label: &quot;_Int Field&quot;, default: 4, min: 0, max: 10,</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-                     required: true}</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  }</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+                     required: true},</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  },</span>
<a href="#l2.74"></a><span id="l2.74"> };</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76"> function jsTestProtocol() { }</span>
<a href="#l2.77"></a><span id="l2.77"> jsTestProtocol.prototype = {</span>
<a href="#l2.78"></a><span id="l2.78">   __proto__: GenericProtocolPrototype,</span>
<a href="#l2.79"></a><span id="l2.79">   get name() { return &quot;JS Test&quot;; },</span>
<a href="#l2.80"></a><span id="l2.80">   options: {</span>
<a href="#l2.81"></a><span id="l2.81">     &quot;text&quot;: {label: &quot;Text option&quot;,    default: &quot;foo&quot;},</span>
<a href="#l2.82"></a><span id="l2.82">     &quot;bool&quot;: {label: &quot;Boolean option&quot;, default: true},</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-    &quot;int&quot; : {label: &quot;Integer option&quot;, default: 42},</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+    &quot;int&quot;: {label: &quot;Integer option&quot;, default: 42},</span>
<a href="#l2.85"></a><span id="l2.85">     &quot;list&quot;: {label: &quot;Select option&quot;,  default: &quot;option2&quot;,</span>
<a href="#l2.86"></a><span id="l2.86">              listValues: {&quot;option1&quot;: &quot;First option&quot;,</span>
<a href="#l2.87"></a><span id="l2.87">                           &quot;option2&quot;: &quot;Default option&quot;,</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-                          &quot;option3&quot;: &quot;Other option&quot;}}</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+                          &quot;option3&quot;: &quot;Other option&quot;}},</span>
<a href="#l2.90"></a><span id="l2.90">   },</span>
<a href="#l2.91"></a><span id="l2.91">   usernameSplits: [</span>
<a href="#l2.92"></a><span id="l2.92">     {label: &quot;Server&quot;, separator: &quot;@&quot;, defaultValue: &quot;default.server&quot;,</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-     reverse: true}</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+     reverse: true},</span>
<a href="#l2.95"></a><span id="l2.95">   ],</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-  getAccount: function(aImAccount) { return new Account(this, aImAccount); },</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  getAccount(aImAccount) { return new Account(this, aImAccount); },</span>
<a href="#l2.98"></a><span id="l2.98">   classID: Components.ID(&quot;{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}&quot;),</span>
<a href="#l2.99"></a><span id="l2.99"> };</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([jsTestProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/matrix/matrix-sdk.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -84,25 +84,25 @@ let loader = Loader({</span>
<a href="#l3.4"></a><span id="l3.4">       &quot;olmlib&quot;: matrixPath + &quot;crypto/olmlib.js&quot;,</span>
<a href="#l3.5"></a><span id="l3.5">       &quot;punycode&quot;: matrixPath + &quot;browserify/punycode.js&quot;,</span>
<a href="#l3.6"></a><span id="l3.6">       &quot;q&quot;: matrixPath + &quot;q/q.js&quot;,</span>
<a href="#l3.7"></a><span id="l3.7">       &quot;querystring&quot;: matrixPath + &quot;browserify/querystring/index.js&quot;,</span>
<a href="#l3.8"></a><span id="l3.8">       &quot;url&quot;: matrixPath + &quot;browserify/url.js&quot;,</span>
<a href="#l3.9"></a><span id="l3.9">   },</span>
<a href="#l3.10"></a><span id="l3.10">   globals: {</span>
<a href="#l3.11"></a><span id="l3.11">     global: {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      setInterval: setInterval,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-      clearInterval: clearInterval,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-      setTimeout: setTimeout,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-      clearTimeout: clearTimeout,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+      setInterval,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      clearInterval,</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+      setTimeout,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+      clearTimeout,</span>
<a href="#l3.20"></a><span id="l3.20">     },</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    console: console,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    XMLHttpRequest: XMLHttpRequest,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    setTimeout: setTimeout,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-    clearTimeout: clearTimeout,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    console,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    XMLHttpRequest,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    setTimeout,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+    clearTimeout,</span>
<a href="#l3.29"></a><span id="l3.29">     location: { href: &quot;&quot; }, // workaround for browser-request's is_crossDomain</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  }</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-})</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  },</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+});</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35"> let requirer = Module(&quot;matrix-module&quot;, &quot;&quot;);</span>
<a href="#l3.36"></a><span id="l3.36"> let require = Require(loader, requirer);</span>
<a href="#l3.37"></a><span id="l3.37"> let MatrixSDK = require(&quot;matrix.js&quot;);</span>
<a href="#l3.38"></a><span id="l3.38"> MatrixSDK.request(require(&quot;browser-request&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/protocols/matrix/matrix.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/protocols/matrix/matrix.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -51,35 +51,35 @@ MatrixParticipant.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">  *  setRoomTopic</span>
<a href="#l4.5"></a><span id="l4.5">  */</span>
<a href="#l4.6"></a><span id="l4.6"> function MatrixConversation(aAccount, aName, aNick)</span>
<a href="#l4.7"></a><span id="l4.7"> {</span>
<a href="#l4.8"></a><span id="l4.8">   this._init(aAccount, aName, aNick);</span>
<a href="#l4.9"></a><span id="l4.9"> }</span>
<a href="#l4.10"></a><span id="l4.10"> MatrixConversation.prototype = {</span>
<a href="#l4.11"></a><span id="l4.11">   __proto__: GenericConvChatPrototype,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  sendMsg: function(aMsg) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l4.14"></a><span id="l4.14">     this._account._client.sendTextMessage(this._roomId, aMsg);</span>
<a href="#l4.15"></a><span id="l4.15">   },</span>
<a href="#l4.16"></a><span id="l4.16">   get room() { return this._account._client.getRoom(this._roomId); },</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  addParticipant: function(aRoomMember) {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  addParticipant(aRoomMember) {</span>
<a href="#l4.19"></a><span id="l4.19">     if (this._participants.has(aRoomMember.userId))</span>
<a href="#l4.20"></a><span id="l4.20">       return;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">     let participant = new MatrixParticipant(aRoomMember);</span>
<a href="#l4.23"></a><span id="l4.23">     this._participants.set(aRoomMember.userId, participant);</span>
<a href="#l4.24"></a><span id="l4.24">     this.notifyObservers(new nsSimpleEnumerator([participant]),</span>
<a href="#l4.25"></a><span id="l4.25">                          &quot;chat-buddy-add&quot;);</span>
<a href="#l4.26"></a><span id="l4.26">   },</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  initListOfParticipants: function() {</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  initListOfParticipants() {</span>
<a href="#l4.29"></a><span id="l4.29">     let conv = this;</span>
<a href="#l4.30"></a><span id="l4.30">     let participants = [];</span>
<a href="#l4.31"></a><span id="l4.31">     this.room.getJoinedMembers().forEach(function(aRoomMember) {</span>
<a href="#l4.32"></a><span id="l4.32">       if (!conv._participants.has(aRoomMember.userId)) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-        let participant = new MatrixParticipant(aRoomMember)</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+        let participant = new MatrixParticipant(aRoomMember);</span>
<a href="#l4.35"></a><span id="l4.35">         participants.push(participant);</span>
<a href="#l4.36"></a><span id="l4.36">         conv._participants.set(aRoomMember.userId, participant);</span>
<a href="#l4.37"></a><span id="l4.37">       }</span>
<a href="#l4.38"></a><span id="l4.38">     });</span>
<a href="#l4.39"></a><span id="l4.39">     if (participants.length)</span>
<a href="#l4.40"></a><span id="l4.40">       this.notifyObservers(new nsSimpleEnumerator(participants),</span>
<a href="#l4.41"></a><span id="l4.41">                            &quot;chat-buddy-add&quot;);</span>
<a href="#l4.42"></a><span id="l4.42">   },</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineat">@@ -99,52 +99,52 @@ MatrixConversation.prototype = {</span>
<a href="#l4.44"></a><span id="l4.44">  *  setPresence</span>
<a href="#l4.45"></a><span id="l4.45">  */</span>
<a href="#l4.46"></a><span id="l4.46"> function MatrixAccount(aProtocol, aImAccount)</span>
<a href="#l4.47"></a><span id="l4.47"> {</span>
<a href="#l4.48"></a><span id="l4.48">   this._init(aProtocol, aImAccount);</span>
<a href="#l4.49"></a><span id="l4.49"> }</span>
<a href="#l4.50"></a><span id="l4.50"> MatrixAccount.prototype = {</span>
<a href="#l4.51"></a><span id="l4.51">   __proto__: GenericAccountPrototype,</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {},</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  remove: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  unInit: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  connect: function() {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  observe(aSubject, aTopic, aData) {},</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  remove() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  unInit() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  connect() {</span>
<a href="#l4.60"></a><span id="l4.60">     this.reportConnecting();</span>
<a href="#l4.61"></a><span id="l4.61">     let baseURL = this.getString(&quot;server&quot;) + &quot;:&quot; + this.getInt(&quot;port&quot;);</span>
<a href="#l4.62"></a><span id="l4.62">     let account = this;</span>
<a href="#l4.63"></a><span id="l4.63">     // We call MatrixSDK.createClient twice because loginWithPassword does not</span>
<a href="#l4.64"></a><span id="l4.64">     // properly set access token.</span>
<a href="#l4.65"></a><span id="l4.65">     // See https://github.com/matrix-org/matrix-js-sdk/issues/130</span>
<a href="#l4.66"></a><span id="l4.66">     MatrixSDK.createClient(baseURL)</span>
<a href="#l4.67"></a><span id="l4.67">       .loginWithPassword(this.name, this.imAccount.password)</span>
<a href="#l4.68"></a><span id="l4.68">       .then(function(data) {</span>
<a href="#l4.69"></a><span id="l4.69">         // TODO: Check data.errcode to pass more accurate value as the first</span>
<a href="#l4.70"></a><span id="l4.70">         // parameter of reportDisconnecting.</span>
<a href="#l4.71"></a><span id="l4.71">         if (data.error)</span>
<a href="#l4.72"></a><span id="l4.72">           throw new Error(data.error);</span>
<a href="#l4.73"></a><span id="l4.73">         account._client = MatrixSDK.createClient({</span>
<a href="#l4.74"></a><span id="l4.74">           baseUrl: baseURL,</span>
<a href="#l4.75"></a><span id="l4.75">           accessToken: data.access_token,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-          userId: data.user_id</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+          userId: data.user_id,</span>
<a href="#l4.78"></a><span id="l4.78">         });</span>
<a href="#l4.79"></a><span id="l4.79">         account.startClient();</span>
<a href="#l4.80"></a><span id="l4.80">       }).catch(function(error) {</span>
<a href="#l4.81"></a><span id="l4.81">         account.reportDisconnecting(Ci.prplIAccount.ERROR_OTHER_ERROR, error.message);</span>
<a href="#l4.82"></a><span id="l4.82">         account._client = null;</span>
<a href="#l4.83"></a><span id="l4.83">         account.reportDisconnected();</span>
<a href="#l4.84"></a><span id="l4.84">       }).done();</span>
<a href="#l4.85"></a><span id="l4.85">   },</span>
<a href="#l4.86"></a><span id="l4.86">   /*</span>
<a href="#l4.87"></a><span id="l4.87">    * Hook up the Matrix Client to callbacks to handle various events.</span>
<a href="#l4.88"></a><span id="l4.88">    *</span>
<a href="#l4.89"></a><span id="l4.89">    * These are documented at:</span>
<a href="#l4.90"></a><span id="l4.90">    * https://matrix-org.github.io/matrix-js-sdk/0.7.0/module-client.html#~event:MatrixClient%2522Call.incoming%2522</span>
<a href="#l4.91"></a><span id="l4.91">    */</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-  startClient: function() {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  startClient() {</span>
<a href="#l4.94"></a><span id="l4.94">     let account = this;</span>
<a href="#l4.95"></a><span id="l4.95">     this._client.on(&quot;sync&quot;, function(state, prevState, data) {</span>
<a href="#l4.96"></a><span id="l4.96">       switch (state) {</span>
<a href="#l4.97"></a><span id="l4.97">         case &quot;PREPARED&quot;:</span>
<a href="#l4.98"></a><span id="l4.98">           account.reportConnected();</span>
<a href="#l4.99"></a><span id="l4.99">         break;</span>
<a href="#l4.100"></a><span id="l4.100">         case &quot;STOPPED&quot;:</span>
<a href="#l4.101"></a><span id="l4.101">           // XXX Report disconnecting here?</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineat">@@ -193,37 +193,37 @@ MatrixAccount.prototype = {</span>
<a href="#l4.103"></a><span id="l4.103">     //  Session.logged_out</span>
<a href="#l4.104"></a><span id="l4.104">     //  User.avatarUrl</span>
<a href="#l4.105"></a><span id="l4.105">     //  User.currentlyActive</span>
<a href="#l4.106"></a><span id="l4.106">     //  User.displayName</span>
<a href="#l4.107"></a><span id="l4.107">     //  User.presence</span>
<a href="#l4.108"></a><span id="l4.108"> </span>
<a href="#l4.109"></a><span id="l4.109">     this._client.startClient();</span>
<a href="#l4.110"></a><span id="l4.110">   },</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-  disconnect: function() {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  disconnect() {</span>
<a href="#l4.113"></a><span id="l4.113">     if (this._client)</span>
<a href="#l4.114"></a><span id="l4.114">       this._client.stopClient();</span>
<a href="#l4.115"></a><span id="l4.115">   },</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117">   get canJoinChat() { return true; },</span>
<a href="#l4.118"></a><span id="l4.118">   chatRoomFields: {</span>
<a href="#l4.119"></a><span id="l4.119">     // XXX Does it make sense to split up the server into a separate field?</span>
<a href="#l4.120"></a><span id="l4.120">     roomIdOrAlias: {</span>
<a href="#l4.121"></a><span id="l4.121">       get label() { return _(&quot;chatRoomField.room&quot;); },</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-      required: true</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+      required: true,</span>
<a href="#l4.124"></a><span id="l4.124">     },</span>
<a href="#l4.125"></a><span id="l4.125">   },</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-  parseDefaultChatName: function(aDefaultName) {</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+  parseDefaultChatName(aDefaultName) {</span>
<a href="#l4.128"></a><span id="l4.128">     let chatFields = {</span>
<a href="#l4.129"></a><span id="l4.129">       roomIdOrAlias: aDefaultName,</span>
<a href="#l4.130"></a><span id="l4.130">     };</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">     return chatFields;</span>
<a href="#l4.133"></a><span id="l4.133">   },</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-  joinChat: function(aComponents) {</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+  joinChat(aComponents) {</span>
<a href="#l4.136"></a><span id="l4.136">     let roomIdOrAlias = aComponents.getValue(&quot;roomIdOrAlias&quot;).trim();</span>
<a href="#l4.137"></a><span id="l4.137">     let domain = this._client.getDomain();</span>
<a href="#l4.138"></a><span id="l4.138">     // For the format of room id and alias, see the matrix documentation:</span>
<a href="#l4.139"></a><span id="l4.139">     // https://matrix.org/docs/spec/intro.html#room-structure</span>
<a href="#l4.140"></a><span id="l4.140">     // https://matrix.org/docs/spec/intro.html#room-aliases</span>
<a href="#l4.141"></a><span id="l4.141">     if (!roomIdOrAlias.endsWith(&quot;:&quot; + domain))</span>
<a href="#l4.142"></a><span id="l4.142">       roomIdOrAlias += &quot;:&quot; + domain;</span>
<a href="#l4.143"></a><span id="l4.143">     if (!roomIdOrAlias.match(&quot;^[!#]&quot;))</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineat">@@ -244,42 +244,42 @@ MatrixAccount.prototype = {</span>
<a href="#l4.145"></a><span id="l4.145">         //     window and leave it as unjoined.</span>
<a href="#l4.146"></a><span id="l4.146">         account.ERROR(error);</span>
<a href="#l4.147"></a><span id="l4.147">         conv.close();</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149">         // TODO Perhaps we should call createRoom if the room doesn't exist.</span>
<a href="#l4.150"></a><span id="l4.150">     }).done();</span>
<a href="#l4.151"></a><span id="l4.151">     return conv;</span>
<a href="#l4.152"></a><span id="l4.152">   },</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-  createConversation: function(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+  createConversation(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l4.155"></a><span id="l4.155"> </span>
<a href="#l4.156"></a><span id="l4.156">   get userId() { return this._client.credentials.userId; },</span>
<a href="#l4.157"></a><span id="l4.157">   _client: null,</span>
<a href="#l4.158"></a><span id="l4.158">   _roomList: new Map(),</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-}</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+};</span>
<a href="#l4.161"></a><span id="l4.161"> </span>
<a href="#l4.162"></a><span id="l4.162"> function MatrixProtocol() {</span>
<a href="#l4.163"></a><span id="l4.163"> }</span>
<a href="#l4.164"></a><span id="l4.164"> MatrixProtocol.prototype = {</span>
<a href="#l4.165"></a><span id="l4.165">   __proto__: GenericProtocolPrototype,</span>
<a href="#l4.166"></a><span id="l4.166">   get normalizedName() { return &quot;matrix&quot;; },</span>
<a href="#l4.167"></a><span id="l4.167">   get name() { return &quot;Matrix&quot;; },</span>
<a href="#l4.168"></a><span id="l4.168">   get iconBaseURI() { return &quot;chrome://prpl-matrix/skin/&quot;; },</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-  getAccount: function(aImAccount) { return new MatrixAccount(this, aImAccount); },</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+  getAccount(aImAccount) { return new MatrixAccount(this, aImAccount); },</span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172">   options: {</span>
<a href="#l4.173"></a><span id="l4.173">     // XXX Default to matrix.org once we support connection as guest?</span>
<a href="#l4.174"></a><span id="l4.174">     server: {</span>
<a href="#l4.175"></a><span id="l4.175">       get label() { return _(&quot;options.connectServer&quot;); },</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-      default: &quot;https://&quot;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+      default: &quot;https://&quot;,</span>
<a href="#l4.178"></a><span id="l4.178">     },</span>
<a href="#l4.179"></a><span id="l4.179">     port: {</span>
<a href="#l4.180"></a><span id="l4.180">       get label() { return _(&quot;options.connectPort&quot;); },</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-      default: 443</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-    }</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+      default: 443,</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+    },</span>
<a href="#l4.185"></a><span id="l4.185">   },</span>
<a href="#l4.186"></a><span id="l4.186"> </span>
<a href="#l4.187"></a><span id="l4.187">   get chatHasTopic() { return true; },</span>
<a href="#l4.188"></a><span id="l4.188"> </span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-  classID: Components.ID(&quot;{e9653ac6-a671-11e6-bf84-60a44c717042}&quot;)</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  classID: Components.ID(&quot;{e9653ac6-a671-11e6-bf84-60a44c717042}&quot;),</span>
<a href="#l4.191"></a><span id="l4.191"> };</span>
<a href="#l4.192"></a><span id="l4.192"> </span>
<a href="#l4.193"></a><span id="l4.193"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([MatrixProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/protocols/skype/skype.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/protocols/skype/skype.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -41,17 +41,17 @@ var kContactsHost = &quot;api.skype.com&quot;;</span>
<a href="#l5.4"></a><span id="l5.4"> var kMessagesHost = &quot;client-s.gateway.messenger.live.com&quot;;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> // Map from strings returned by the SkypeWeb API to statuses.</span>
<a href="#l5.7"></a><span id="l5.7"> var kStatusMap = {</span>
<a href="#l5.8"></a><span id="l5.8">   &quot;Online&quot;: &quot;AVAILABLE&quot;,</span>
<a href="#l5.9"></a><span id="l5.9">   &quot;Offline&quot;: &quot;OFFLINE&quot;,</span>
<a href="#l5.10"></a><span id="l5.10">   &quot;Idle&quot;: &quot;IDLE&quot;,</span>
<a href="#l5.11"></a><span id="l5.11">   &quot;Away&quot;: &quot;AWAY&quot;,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  &quot;Hidden&quot;: &quot;INVISIBLE&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  &quot;Hidden&quot;: &quot;INVISIBLE&quot;,</span>
<a href="#l5.14"></a><span id="l5.14"> };</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l5.17"></a><span id="l5.17">   l10nHelper(&quot;chrome://chat/locale/skype.properties&quot;)</span>
<a href="#l5.18"></a><span id="l5.18"> );</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> /*</span>
<a href="#l5.21"></a><span id="l5.21">  * Convert a URL to a user's name.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -80,17 +80,17 @@ function contactUrlToName(aUrl) {</span>
<a href="#l5.23"></a><span id="l5.23"> function SkypeConversation(aAccount, aName) {</span>
<a href="#l5.24"></a><span id="l5.24">   this.buddy = aAccount._buddies.get(aName);</span>
<a href="#l5.25"></a><span id="l5.25">   this._init(aAccount, aName);</span>
<a href="#l5.26"></a><span id="l5.26"> }</span>
<a href="#l5.27"></a><span id="l5.27"> SkypeConversation.prototype = {</span>
<a href="#l5.28"></a><span id="l5.28">   __proto__: GenericConvIMPrototype,</span>
<a href="#l5.29"></a><span id="l5.29">   _account: null,</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  sendMsg: function(aMessage) {</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  sendMsg(aMessage) {</span>
<a href="#l5.33"></a><span id="l5.33">     if (!aMessage.length)</span>
<a href="#l5.34"></a><span id="l5.34">       return;</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">     let target = &quot;8:&quot; + this.name;</span>
<a href="#l5.37"></a><span id="l5.37">     let url = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/conversations/&quot; +</span>
<a href="#l5.38"></a><span id="l5.38">               target + &quot;/messages&quot;;</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">     let clientMessageId = Date.now().toString();</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineat">@@ -98,45 +98,44 @@ SkypeConversation.prototype = {</span>
<a href="#l5.42"></a><span id="l5.42">       &quot;clientmessageid&quot;: clientMessageId,</span>
<a href="#l5.43"></a><span id="l5.43">       &quot;content&quot;: aMessage,</span>
<a href="#l5.44"></a><span id="l5.44">       &quot;messagetype&quot;: &quot;RichText&quot;,</span>
<a href="#l5.45"></a><span id="l5.45">       &quot;contenttype&quot;: &quot;text&quot;,</span>
<a href="#l5.46"></a><span id="l5.46">     };</span>
<a href="#l5.47"></a><span id="l5.47">     let options = {</span>
<a href="#l5.48"></a><span id="l5.48">       onLoad: (aResponse, aXhr) =&gt; {</span>
<a href="#l5.49"></a><span id="l5.49">         this._account.LOG(&quot;Message response: &quot; + aResponse);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-        this._account.LOG(&quot;Successfully sent message: &quot; + aMessage)</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+        this._account.LOG(&quot;Successfully sent message: &quot; + aMessage);</span>
<a href="#l5.52"></a><span id="l5.52">       },</span>
<a href="#l5.53"></a><span id="l5.53">       onError: this._account._onHttpFailure(&quot;sending message&quot;),</span>
<a href="#l5.54"></a><span id="l5.54">       postData: JSON.stringify(message),</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-      logger: this._account.logger</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+      logger: this._account.logger,</span>
<a href="#l5.57"></a><span id="l5.57">     };</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59">     // TODO Track the messages we sent?</span>
<a href="#l5.60"></a><span id="l5.60">     this._account._messagesRequest(url, options);</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-  }</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+  },</span>
<a href="#l5.63"></a><span id="l5.63"> };</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65"> function SkypeAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l5.66"></a><span id="l5.66">   aAccount.LOG(&quot;Creating account buddy for &quot; + aUserName);</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l5.69"></a><span id="l5.69"> }</span>
<a href="#l5.70"></a><span id="l5.70"> SkypeAccountBuddy.prototype = {</span>
<a href="#l5.71"></a><span id="l5.71">   __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l5.72"></a><span id="l5.72">   _info: null,</span>
<a href="#l5.73"></a><span id="l5.73">   mood: null,</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">   // Called when the user wants to chat with the buddy.</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-  createConversation:</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    function() {return this._account.createConversation(this.userName); },</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  createConversation() { return this._account.createConversation(this.userName); },</span>
<a href="#l5.79"></a><span id="l5.79"> </span>
<a href="#l5.80"></a><span id="l5.80">   // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l5.81"></a><span id="l5.81">   // hovers over the buddy.</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-  getTooltipInfo: function() {</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l5.84"></a><span id="l5.84">     if (!this._info)</span>
<a href="#l5.85"></a><span id="l5.85">       return EmptyEnumerator;</span>
<a href="#l5.86"></a><span id="l5.86"> </span>
<a href="#l5.87"></a><span id="l5.87">     let tooltipInfo = [];</span>
<a href="#l5.88"></a><span id="l5.88">     for (let info in this._info) {</span>
<a href="#l5.89"></a><span id="l5.89">       // If there's no value, skip the element.</span>
<a href="#l5.90"></a><span id="l5.90">       if (!this._info[info])</span>
<a href="#l5.91"></a><span id="l5.91">         continue;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineat">@@ -145,20 +144,20 @@ SkypeAccountBuddy.prototype = {</span>
<a href="#l5.93"></a><span id="l5.93">       tooltipInfo.push(new TooltipInfo(info, this._info[info]));</span>
<a href="#l5.94"></a><span id="l5.94">     }</span>
<a href="#l5.95"></a><span id="l5.95">     if (this.mood)</span>
<a href="#l5.96"></a><span id="l5.96">       tooltipInfo.push(new TooltipInfo(&quot;Mood&quot;, this.mood));</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">     return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l5.99"></a><span id="l5.99">   },</span>
<a href="#l5.100"></a><span id="l5.100"> </span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-  remove: function() {</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+  remove() {</span>
<a href="#l5.103"></a><span id="l5.103">     this._account.removeBuddy(this);</span>
<a href="#l5.104"></a><span id="l5.104">     GenericAccountBuddyPrototype.remove.call(this);</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-  }</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  },</span>
<a href="#l5.107"></a><span id="l5.107"> };</span>
<a href="#l5.108"></a><span id="l5.108"> </span>
<a href="#l5.109"></a><span id="l5.109"> /*</span>
<a href="#l5.110"></a><span id="l5.110">  * Cut out a part of a larger string bordered by aStart and aEnd. Returns an</span>
<a href="#l5.111"></a><span id="l5.111">  * empty string if the needle is not found.</span>
<a href="#l5.112"></a><span id="l5.112">  */</span>
<a href="#l5.113"></a><span id="l5.113"> function extractString(aStr, aStart, aEnd) {</span>
<a href="#l5.114"></a><span id="l5.114">   // First find the start index, then offset by the string length.</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineat">@@ -280,17 +279,17 @@ function getTimezone() {</span>
<a href="#l5.116"></a><span id="l5.116">     let nLen = nStr.length;</span>
<a href="#l5.117"></a><span id="l5.117"> </span>
<a href="#l5.118"></a><span id="l5.118">     if (nLen &gt; aLen) {</span>
<a href="#l5.119"></a><span id="l5.119">       throw &quot;Can't zero-pad when longer than expected length: &quot; + nStr +</span>
<a href="#l5.120"></a><span id="l5.120">         &quot;.length &gt; &quot; + aLen;</span>
<a href="#l5.121"></a><span id="l5.121">     }</span>
<a href="#l5.122"></a><span id="l5.122"> </span>
<a href="#l5.123"></a><span id="l5.123">     return &quot;0&quot;.repeat(aLen - nLen) + nStr;</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-  };</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  }</span>
<a href="#l5.126"></a><span id="l5.126"> </span>
<a href="#l5.127"></a><span id="l5.127">   // Invert the sign of the timezone from JavaScript's date object.</span>
<a href="#l5.128"></a><span id="l5.128">   let sign = &quot;+&quot;;</span>
<a href="#l5.129"></a><span id="l5.129">   let timezone = new Date().getTimezoneOffset() * -1;</span>
<a href="#l5.130"></a><span id="l5.130">   if (timezone &lt; 0)</span>
<a href="#l5.131"></a><span id="l5.131">     sign = &quot;-&quot;;</span>
<a href="#l5.132"></a><span id="l5.132">   timezone = Math.abs(timezone);</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134" class="difflineat">@@ -331,80 +330,80 @@ SkypeAccount.prototype = {</span>
<a href="#l5.135"></a><span id="l5.135"> </span>
<a href="#l5.136"></a><span id="l5.136">   // Some tokens.</span>
<a href="#l5.137"></a><span id="l5.137">   _skypeToken: null,</span>
<a href="#l5.138"></a><span id="l5.138">   _registrationToken: null,</span>
<a href="#l5.139"></a><span id="l5.139"> </span>
<a href="#l5.140"></a><span id="l5.140">   // Logger used for HTTP requests.</span>
<a href="#l5.141"></a><span id="l5.141">   _logger: null,</span>
<a href="#l5.142"></a><span id="l5.142"> </span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-  mapStatusString: function(aStatus) {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+  mapStatusString(aStatus) {</span>
<a href="#l5.145"></a><span id="l5.145">     if (aStatus in kStatusMap)</span>
<a href="#l5.146"></a><span id="l5.146">       return Ci.imIStatusInfo[&quot;STATUS_&quot; + kStatusMap[aStatus]];</span>
<a href="#l5.147"></a><span id="l5.147"> </span>
<a href="#l5.148"></a><span id="l5.148">     // Uh-oh, we got something not in the map.</span>
<a href="#l5.149"></a><span id="l5.149">     this.WARN(&quot;Received unknown status type: &quot; + aStatus);</span>
<a href="#l5.150"></a><span id="l5.150">     return Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l5.151"></a><span id="l5.151">   },</span>
<a href="#l5.152"></a><span id="l5.152"> </span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-  connect: function() {</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+  connect() {</span>
<a href="#l5.155"></a><span id="l5.155">     this.reportConnecting();</span>
<a href="#l5.156"></a><span id="l5.156"> </span>
<a href="#l5.157"></a><span id="l5.157">     this.LOG(&quot;STARTING Login&quot;);</span>
<a href="#l5.158"></a><span id="l5.158"> </span>
<a href="#l5.159"></a><span id="l5.159">     // Perform the request to get the session token values.</span>
<a href="#l5.160"></a><span id="l5.160">     let loginUrl = &quot;https://&quot; + kLoginHost + &quot;/login&quot;;</span>
<a href="#l5.161"></a><span id="l5.161">     let options = {</span>
<a href="#l5.162"></a><span id="l5.162">       onLoad: this._onPieResponse.bind(this),</span>
<a href="#l5.163"></a><span id="l5.163">       onError: this._onHttpFailure(&quot;requesting pie&quot;),</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-      logger: this.logger</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-    }</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+      logger: this.logger,</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+    };</span>
<a href="#l5.168"></a><span id="l5.168">     httpRequest(loginUrl, options);</span>
<a href="#l5.169"></a><span id="l5.169">   },</span>
<a href="#l5.170"></a><span id="l5.170"> </span>
<a href="#l5.171"></a><span id="l5.171">   /*</span>
<a href="#l5.172"></a><span id="l5.172">    * Generates a callback which causes the account to enter an error state with</span>
<a href="#l5.173"></a><span id="l5.173">    * the given error string.</span>
<a href="#l5.174"></a><span id="l5.174">    */</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-  _onHttpFailure: function(aErrorStr) {</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+  _onHttpFailure(aErrorStr) {</span>
<a href="#l5.177"></a><span id="l5.177">     return (aError, aResponse, aXhr) =&gt; {</span>
<a href="#l5.178"></a><span id="l5.178">       this.ERROR(&quot;HTTP failure occurred: &quot; + aErrorStr + &quot;\n&quot; + aError);</span>
<a href="#l5.179"></a><span id="l5.179">       this._disconnectWithAuthFailure();</span>
<a href="#l5.180"></a><span id="l5.180">     };</span>
<a href="#l5.181"></a><span id="l5.181">   },</span>
<a href="#l5.182"></a><span id="l5.182"> </span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-  _onHttpError: function(aError, aResponse, aXhr) {</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+  _onHttpError(aError, aResponse, aXhr) {</span>
<a href="#l5.185"></a><span id="l5.185">     this.ERROR(&quot;Received error response:\n&quot; + aError);</span>
<a href="#l5.186"></a><span id="l5.186">   },</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188">   // Mmmmm...pie.</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-  _onPieResponse: function(aResponse, aXhr) {</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  _onPieResponse(aResponse, aXhr) {</span>
<a href="#l5.191"></a><span id="l5.191">     this.reportConnecting(_(&quot;connecting.authenticating&quot;));</span>
<a href="#l5.192"></a><span id="l5.192"> </span>
<a href="#l5.193"></a><span id="l5.193">     // Parse the pie/etm and do the actual login.</span>
<a href="#l5.194"></a><span id="l5.194">     let loginUrl = &quot;https://&quot; + kLoginHost + &quot;/login&quot;;</span>
<a href="#l5.195"></a><span id="l5.195"> </span>
<a href="#l5.196"></a><span id="l5.196">     let params = [[&quot;client_id&quot;, kClientId],</span>
<a href="#l5.197"></a><span id="l5.197">                   [&quot;redirect_uri&quot;, &quot;https://web.skype.com&quot;]];</span>
<a href="#l5.198"></a><span id="l5.198">     loginUrl += &quot;?&quot; +</span>
<a href="#l5.199"></a><span id="l5.199">       params.map(p =&gt; p.map(encodeURIComponent).join(&quot;=&quot;)).join(&quot;&amp;&quot;);</span>
<a href="#l5.200"></a><span id="l5.200"> </span>
<a href="#l5.201"></a><span id="l5.201">     this.LOG(&quot;Received PIE response:\n&quot; + aResponse);</span>
<a href="#l5.202"></a><span id="l5.202"> </span>
<a href="#l5.203"></a><span id="l5.203">     // Note that the response is really just an HTML page with some JavaScript</span>
<a href="#l5.204"></a><span id="l5.204">     // and forms that these values are being pulled from.</span>
<a href="#l5.205"></a><span id="l5.205">     let pie = extractString(aResponse, &quot;=\&quot;pie\&quot; value=\&quot;&quot;, &quot;\&quot;&quot;);</span>
<a href="#l5.206"></a><span id="l5.206">     if (!pie) {</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-      this.ERROR(&quot;pie value not found.&quot;)</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+      this.ERROR(&quot;pie value not found.&quot;);</span>
<a href="#l5.209"></a><span id="l5.209">       this._disconnectWithAuthFailure();</span>
<a href="#l5.210"></a><span id="l5.210">       return;</span>
<a href="#l5.211"></a><span id="l5.211">     }</span>
<a href="#l5.212"></a><span id="l5.212">     let etm = extractString(aResponse, &quot;=\&quot;etm\&quot; value=\&quot;&quot;, &quot;\&quot;&quot;);</span>
<a href="#l5.213"></a><span id="l5.213">     if (!etm) {</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-      this.ERROR(&quot;etm value not found.&quot;)</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+      this.ERROR(&quot;etm value not found.&quot;);</span>
<a href="#l5.216"></a><span id="l5.216">       this._disconnectWithAuthFailure();</span>
<a href="#l5.217"></a><span id="l5.217">       return;</span>
<a href="#l5.218"></a><span id="l5.218">     }</span>
<a href="#l5.219"></a><span id="l5.219"> </span>
<a href="#l5.220"></a><span id="l5.220">     let options = {</span>
<a href="#l5.221"></a><span id="l5.221">       onLoad: this._onLoginResponse.bind(this),</span>
<a href="#l5.222"></a><span id="l5.222">       onError: this._onHttpFailure(&quot;requesting skypetoken&quot;),</span>
<a href="#l5.223"></a><span id="l5.223">       postData: [[&quot;username&quot;, this.name],</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineat">@@ -416,27 +415,27 @@ SkypeAccount.prototype = {</span>
<a href="#l5.225"></a><span id="l5.225">                  [&quot;client_id&quot;, kClientId],</span>
<a href="#l5.226"></a><span id="l5.226">                  [&quot;redirect_uri&quot;, &quot;https://web.skype.com/&quot;]],</span>
<a href="#l5.227"></a><span id="l5.227">       headers: [[&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l5.228"></a><span id="l5.228">                 // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l5.229"></a><span id="l5.229">                 // response from doing a 302 Found Location redirect, since</span>
<a href="#l5.230"></a><span id="l5.230">                 // there are important headers that need to be plucked before</span>
<a href="#l5.231"></a><span id="l5.231">                 // the redirect happens.</span>
<a href="#l5.232"></a><span id="l5.232">                 [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;]],</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-      logger: this._logger</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-    }</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+      logger: this._logger,</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+    };</span>
<a href="#l5.237"></a><span id="l5.237">     httpRequest(loginUrl, options);</span>
<a href="#l5.238"></a><span id="l5.238">   },</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-  _onLoginResponse: function(aResponse, aXhr) {</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+  _onLoginResponse(aResponse, aXhr) {</span>
<a href="#l5.241"></a><span id="l5.241">     this.LOG(&quot;Received LOGIN response:\n&quot; + aResponse);</span>
<a href="#l5.242"></a><span id="l5.242"> </span>
<a href="#l5.243"></a><span id="l5.243">     let refreshToken =</span>
<a href="#l5.244"></a><span id="l5.244">       extractString(aResponse, &quot;=\&quot;skypetoken\&quot; value=\&quot;&quot;, &quot;\&quot;&quot;);</span>
<a href="#l5.245"></a><span id="l5.245">     if (!refreshToken) {</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-      this.ERROR(&quot;skypetoken value not found.&quot;)</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+      this.ERROR(&quot;skypetoken value not found.&quot;);</span>
<a href="#l5.248"></a><span id="l5.248">       this._disconnectWithAuthFailure();</span>
<a href="#l5.249"></a><span id="l5.249">       return;</span>
<a href="#l5.250"></a><span id="l5.250">     }</span>
<a href="#l5.251"></a><span id="l5.251"> </span>
<a href="#l5.252"></a><span id="l5.252">     // All done!</span>
<a href="#l5.253"></a><span id="l5.253">     this._skypeToken = refreshToken;</span>
<a href="#l5.254"></a><span id="l5.254">     this.LOG(&quot;Received Skype token: &quot; + this._skypeToken);</span>
<a href="#l5.255"></a><span id="l5.255"> </span>
<a href="#l5.256"></a><span id="l5.256" class="difflineat">@@ -467,80 +466,80 @@ SkypeAccount.prototype = {</span>
<a href="#l5.257"></a><span id="l5.257">                 // there are important headers that need to be plucked before</span>
<a href="#l5.258"></a><span id="l5.258">                 // the redirect happens.</span>
<a href="#l5.259"></a><span id="l5.259">                 [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;],</span>
<a href="#l5.260"></a><span id="l5.260">                 [&quot;LockAndKey&quot;, &quot;appId=&quot; + kLockAndKeyAppId +</span>
<a href="#l5.261"></a><span id="l5.261">                                &quot;; time=&quot; + curTime +</span>
<a href="#l5.262"></a><span id="l5.262">                                &quot;; lockAndKeyResponse=&quot; + response],</span>
<a href="#l5.263"></a><span id="l5.263">                 [&quot;ClientInfo&quot;, kClientInfo],</span>
<a href="#l5.264"></a><span id="l5.264">                 [&quot;Authentication&quot;, &quot;skypetoken=&quot; + this._skypeToken]],</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-      logger: this._logger</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-    }</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+      logger: this._logger,</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+    };</span>
<a href="#l5.269"></a><span id="l5.269">     httpRequest(messagesUrl, options);</span>
<a href="#l5.270"></a><span id="l5.270">   },</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-  _onRegistrationTokenReceived: function(aResponse, aXhr) {</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+  _onRegistrationTokenReceived(aResponse, aXhr) {</span>
<a href="#l5.273"></a><span id="l5.273">     this.LOG(&quot;Registration token received: &quot; + aResponse);</span>
<a href="#l5.274"></a><span id="l5.274"> </span>
<a href="#l5.275"></a><span id="l5.275">     let registrationToken = aXhr.getResponseHeader(&quot;Set-RegistrationToken&quot;);</span>
<a href="#l5.276"></a><span id="l5.276">     this.LOG(&quot;regToken: &quot; + registrationToken);</span>
<a href="#l5.277"></a><span id="l5.277">     if (!registrationToken) {</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-      this.ERROR(&quot;registraation token value not found.&quot;)</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+      this.ERROR(&quot;registraation token value not found.&quot;);</span>
<a href="#l5.280"></a><span id="l5.280">       this._disconnectWithAuthFailure();</span>
<a href="#l5.281"></a><span id="l5.281">       return;</span>
<a href="#l5.282"></a><span id="l5.282">     }</span>
<a href="#l5.283"></a><span id="l5.283"> </span>
<a href="#l5.284"></a><span id="l5.284">     this._registrationToken = registrationToken;</span>
<a href="#l5.285"></a><span id="l5.285">     this._subscribe();</span>
<a href="#l5.286"></a><span id="l5.286">   },</span>
<a href="#l5.287"></a><span id="l5.287"> </span>
<a href="#l5.288"></a><span id="l5.288">   // Subscribe to the events we want to see.</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-  _subscribe: function() {</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+  _subscribe() {</span>
<a href="#l5.291"></a><span id="l5.291">     this.LOG(&quot;Sending subscription.&quot;);</span>
<a href="#l5.292"></a><span id="l5.292"> </span>
<a href="#l5.293"></a><span id="l5.293">     // Subscribe to particular events.</span>
<a href="#l5.294"></a><span id="l5.294">     let messagesUrl =</span>
<a href="#l5.295"></a><span id="l5.295">       &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/endpoints/SELF/subscriptions&quot;;</span>
<a href="#l5.296"></a><span id="l5.296">     // The endpoints to subscribe to.</span>
<a href="#l5.297"></a><span id="l5.297">     let subscriptions = {</span>
<a href="#l5.298"></a><span id="l5.298">       &quot;interestedResources&quot;: [&quot;/v1/users/ME/conversations/ALL/properties&quot;,</span>
<a href="#l5.299"></a><span id="l5.299">                               &quot;/v1/users/ME/conversations/ALL/messages&quot;,</span>
<a href="#l5.300"></a><span id="l5.300">                               &quot;/v1/users/ME/contacts/ALL&quot;,</span>
<a href="#l5.301"></a><span id="l5.301">                               &quot;/v1/threads/ALL&quot;],</span>
<a href="#l5.302"></a><span id="l5.302">       &quot;template&quot;: &quot;raw&quot;,</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-      &quot;channelType&quot;: &quot;httpLongPoll&quot;</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+      &quot;channelType&quot;: &quot;httpLongPoll&quot;,</span>
<a href="#l5.305"></a><span id="l5.305">     };</span>
<a href="#l5.306"></a><span id="l5.306">     let options = {</span>
<a href="#l5.307"></a><span id="l5.307">       onLoad: this._onSubscription.bind(this),</span>
<a href="#l5.308"></a><span id="l5.308">       onError: this._onHttpFailure(&quot;subscribing to notifications&quot;),</span>
<a href="#l5.309"></a><span id="l5.309">       postData: JSON.stringify(subscriptions),</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-      logger: this._logger</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+      logger: this._logger,</span>
<a href="#l5.312"></a><span id="l5.312">     };</span>
<a href="#l5.313"></a><span id="l5.313">     this._messagesRequest(messagesUrl, options);</span>
<a href="#l5.314"></a><span id="l5.314">   },</span>
<a href="#l5.315"></a><span id="l5.315"> </span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-  _onSubscription: function(aResponse, aXhr) {</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+  _onSubscription(aResponse, aXhr) {</span>
<a href="#l5.318"></a><span id="l5.318">     this.LOG(&quot;Got subscription response: &quot; + aResponse);</span>
<a href="#l5.319"></a><span id="l5.319">     this.reportConnected();</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321">     // TODO Check auth requests.</span>
<a href="#l5.322"></a><span id="l5.322"> </span>
<a href="#l5.323"></a><span id="l5.323">     // Get friends list.</span>
<a href="#l5.324"></a><span id="l5.324">     let contactListUrl = &quot;https://&quot; + kContactsHost + &quot;/users/self/contacts&quot;;</span>
<a href="#l5.325"></a><span id="l5.325">     let options = {</span>
<a href="#l5.326"></a><span id="l5.326">       onLoad: this._onContactsList.bind(this),</span>
<a href="#l5.327"></a><span id="l5.327">       onError: this._onHttpError.bind(this),</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineminus">-      logger: this._logger</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-    }</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+      logger: this._logger,</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+    };</span>
<a href="#l5.332"></a><span id="l5.332">     this._contactsRequest(contactListUrl, options);</span>
<a href="#l5.333"></a><span id="l5.333"> </span>
<a href="#l5.334"></a><span id="l5.334">     // Poll for messages.</span>
<a href="#l5.335"></a><span id="l5.335">     this._getMessages();</span>
<a href="#l5.336"></a><span id="l5.336">   },</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-  _onContactsList: function(aResponse, aXhr) {</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+  _onContactsList(aResponse, aXhr) {</span>
<a href="#l5.340"></a><span id="l5.340">     this.LOG(&quot;Contacts list: &quot; + aResponse);</span>
<a href="#l5.341"></a><span id="l5.341"> </span>
<a href="#l5.342"></a><span id="l5.342">     let buddies = JSON.parse(aResponse);</span>
<a href="#l5.343"></a><span id="l5.343">     if (!buddies) {</span>
<a href="#l5.344"></a><span id="l5.344">       this.ERROR(&quot;Unable to parse JSON response: &quot; + aResponse);</span>
<a href="#l5.345"></a><span id="l5.345">       return;</span>
<a href="#l5.346"></a><span id="l5.346">     }</span>
<a href="#l5.347"></a><span id="l5.347"> </span>
<a href="#l5.348"></a><span id="l5.348" class="difflineat">@@ -578,38 +577,38 @@ SkypeAccount.prototype = {</span>
<a href="#l5.349"></a><span id="l5.349"> </span>
<a href="#l5.350"></a><span id="l5.350">     // Download profiles.</span>
<a href="#l5.351"></a><span id="l5.351">     let profilesUrl =</span>
<a href="#l5.352"></a><span id="l5.352">       &quot;https://&quot; + kContactsHost + &quot;/users/self/contacts/profiles&quot;;</span>
<a href="#l5.353"></a><span id="l5.353">     let options = {</span>
<a href="#l5.354"></a><span id="l5.354">       postData: buddies.map((b) =&gt; [&quot;contacts[]&quot;, b.skypename]),</span>
<a href="#l5.355"></a><span id="l5.355">       onLoad: this._onProfiles.bind(this),</span>
<a href="#l5.356"></a><span id="l5.356">       onError: this._onHttpError.bind(this),</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-      logger: this._logger</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+      logger: this._logger,</span>
<a href="#l5.359"></a><span id="l5.359">     };</span>
<a href="#l5.360"></a><span id="l5.360">     this.LOG(JSON.stringify(options));</span>
<a href="#l5.361"></a><span id="l5.361">     this._contactsRequest(profilesUrl, options);</span>
<a href="#l5.362"></a><span id="l5.362"> </span>
<a href="#l5.363"></a><span id="l5.363">     // Subscribe to user statuses.</span>
<a href="#l5.364"></a><span id="l5.364">     let contactsUrl = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/contacts&quot;;</span>
<a href="#l5.365"></a><span id="l5.365">     let contacts = buddies.map((b) =&gt; {</span>
<a href="#l5.366"></a><span id="l5.366">       return {&quot;id&quot;: &quot;8:&quot; + b.skypename};</span>
<a href="#l5.367"></a><span id="l5.367">     });</span>
<a href="#l5.368"></a><span id="l5.368">     options = {</span>
<a href="#l5.369"></a><span id="l5.369">       postData: JSON.stringify({&quot;contacts&quot;: contacts}),</span>
<a href="#l5.370"></a><span id="l5.370">       onLoad: (aResponse, aXhr) =&gt;</span>
<a href="#l5.371"></a><span id="l5.371">         this.LOG(&quot;Successfully subscribed to contacts.&quot;),</span>
<a href="#l5.372"></a><span id="l5.372">       onError: this._onHttpError.bind(this),</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-      logger: this._logger</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+      logger: this._logger,</span>
<a href="#l5.375"></a><span id="l5.375">     };</span>
<a href="#l5.376"></a><span id="l5.376">     this.LOG(JSON.stringify(options));</span>
<a href="#l5.377"></a><span id="l5.377">     this._messagesRequest(contactsUrl, options);</span>
<a href="#l5.378"></a><span id="l5.378">   },</span>
<a href="#l5.379"></a><span id="l5.379"> </span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-  _onProfiles: function(aResponse, aXhr) {</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+  _onProfiles(aResponse, aXhr) {</span>
<a href="#l5.382"></a><span id="l5.382">     this.LOG(&quot;Profiles: &quot; + aResponse);</span>
<a href="#l5.383"></a><span id="l5.383"> </span>
<a href="#l5.384"></a><span id="l5.384">     let skypeContacts = JSON.parse(aResponse);</span>
<a href="#l5.385"></a><span id="l5.385"> </span>
<a href="#l5.386"></a><span id="l5.386">     // TODO Error checking.</span>
<a href="#l5.387"></a><span id="l5.387"> </span>
<a href="#l5.388"></a><span id="l5.388">     for (let skypeContact of skypeContacts) {</span>
<a href="#l5.389"></a><span id="l5.389">       let username = skypeContact.username;</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineat">@@ -631,29 +630,29 @@ SkypeAccount.prototype = {</span>
<a href="#l5.391"></a><span id="l5.391">       }</span>
<a href="#l5.392"></a><span id="l5.392">       buddy.buddyIconFilename = skypeContact.avatarUrl;</span>
<a href="#l5.393"></a><span id="l5.393">     }</span>
<a href="#l5.394"></a><span id="l5.394">   },</span>
<a href="#l5.395"></a><span id="l5.395"> </span>
<a href="#l5.396"></a><span id="l5.396">   /*</span>
<a href="#l5.397"></a><span id="l5.397">    * Download the actual messages, this will recurse through its callback.</span>
<a href="#l5.398"></a><span id="l5.398">    */</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineminus">-  _getMessages: function() {</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+  _getMessages() {</span>
<a href="#l5.401"></a><span id="l5.401">     let messagesUrl = &quot;https://&quot; + kMessagesHost +</span>
<a href="#l5.402"></a><span id="l5.402">       &quot;/v1/users/ME/endpoints/SELF/subscriptions/0/poll&quot;;</span>
<a href="#l5.403"></a><span id="l5.403">     let options = {</span>
<a href="#l5.404"></a><span id="l5.404">       method: &quot;POST&quot;,</span>
<a href="#l5.405"></a><span id="l5.405">       onLoad: this._onMessages.bind(this),</span>
<a href="#l5.406"></a><span id="l5.406">       onError: this._onHttpError.bind(this),</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-      logger: this._logger</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+      logger: this._logger,</span>
<a href="#l5.409"></a><span id="l5.409">     };</span>
<a href="#l5.410"></a><span id="l5.410">     this._request = this._messagesRequest(messagesUrl, options);</span>
<a href="#l5.411"></a><span id="l5.411">   },</span>
<a href="#l5.412"></a><span id="l5.412"> </span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-  _onMessages: function(aResponse, aXhr) {</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+  _onMessages(aResponse, aXhr) {</span>
<a href="#l5.415"></a><span id="l5.415">     this.LOG(&quot;Messages: &quot; + aResponse);</span>
<a href="#l5.416"></a><span id="l5.416"> </span>
<a href="#l5.417"></a><span id="l5.417">     // Poll for new events by performing another XHR in 1 second.</span>
<a href="#l5.418"></a><span id="l5.418">     this._request = null;</span>
<a href="#l5.419"></a><span id="l5.419">     this._poller = setTimeout(this._getMessages.bind(this), 1000);</span>
<a href="#l5.420"></a><span id="l5.420"> </span>
<a href="#l5.421"></a><span id="l5.421">     // Empty responses are received as keep alives.</span>
<a href="#l5.422"></a><span id="l5.422">     if (!aResponse)</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineat">@@ -749,17 +748,17 @@ SkypeAccount.prototype = {</span>
<a href="#l5.424"></a><span id="l5.424">       }</span>
<a href="#l5.425"></a><span id="l5.425">     }</span>
<a href="#l5.426"></a><span id="l5.426">   },</span>
<a href="#l5.427"></a><span id="l5.427"> </span>
<a href="#l5.428"></a><span id="l5.428">   /*</span>
<a href="#l5.429"></a><span id="l5.429">    * Make a request to the Skype contacts API, this is essentially just</span>
<a href="#l5.430"></a><span id="l5.430">    * httpRequest, but auto-adds a bunch of headers that are necessary.</span>
<a href="#l5.431"></a><span id="l5.431">    */</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-  _contactsRequest: function(aUrl, aOptions = {}) {</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+  _contactsRequest(aUrl, aOptions = {}) {</span>
<a href="#l5.434"></a><span id="l5.434">     let headers = aOptions.headers || [];</span>
<a href="#l5.435"></a><span id="l5.435"> </span>
<a href="#l5.436"></a><span id="l5.436">     // Add some special Skype headers.</span>
<a href="#l5.437"></a><span id="l5.437">     headers = headers.concat([</span>
<a href="#l5.438"></a><span id="l5.438">       [&quot;X-Skypetoken&quot;, this._skypeToken],</span>
<a href="#l5.439"></a><span id="l5.439">       [&quot;X-Stratus-Caller&quot;, &quot;swx-skype.com&quot;],</span>
<a href="#l5.440"></a><span id="l5.440">       [&quot;X-Stratus-Request&quot;, &quot;abcd1234&quot;],</span>
<a href="#l5.441"></a><span id="l5.441">       [&quot;Origin&quot;, &quot;https://web.skype.com&quot;],</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineat">@@ -771,40 +770,40 @@ SkypeAccount.prototype = {</span>
<a href="#l5.443"></a><span id="l5.443"> </span>
<a href="#l5.444"></a><span id="l5.444">     return httpRequest(aUrl, aOptions);</span>
<a href="#l5.445"></a><span id="l5.445">   },</span>
<a href="#l5.446"></a><span id="l5.446"> </span>
<a href="#l5.447"></a><span id="l5.447">   /*</span>
<a href="#l5.448"></a><span id="l5.448">    * Make a request to the Skype messages API, this is essentially just</span>
<a href="#l5.449"></a><span id="l5.449">    * httpRequest, but auto-adds a bunch of headers that are necessary.</span>
<a href="#l5.450"></a><span id="l5.450">    */</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-  _messagesRequest: function(aUrl, aOptions = {}) {</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+  _messagesRequest(aUrl, aOptions = {}) {</span>
<a href="#l5.453"></a><span id="l5.453">     let headers = aOptions.headers || [];</span>
<a href="#l5.454"></a><span id="l5.454"> </span>
<a href="#l5.455"></a><span id="l5.455">     // Add some special Skype headers.</span>
<a href="#l5.456"></a><span id="l5.456">     headers = headers.concat([</span>
<a href="#l5.457"></a><span id="l5.457">       [&quot;RegistrationToken&quot;, this._registrationToken],</span>
<a href="#l5.458"></a><span id="l5.458">       [&quot;Referer&quot;, &quot;https://web.skype.com/main&quot;],</span>
<a href="#l5.459"></a><span id="l5.459">       [&quot;Accept&quot;, &quot;application/json; ver=1.0;&quot;],</span>
<a href="#l5.460"></a><span id="l5.460">       [&quot;ClientInfo&quot;, kClientInfo],</span>
<a href="#l5.461"></a><span id="l5.461">     ]);</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463">     aOptions.headers = headers;</span>
<a href="#l5.464"></a><span id="l5.464"> </span>
<a href="#l5.465"></a><span id="l5.465">     return httpRequest(aUrl, aOptions);</span>
<a href="#l5.466"></a><span id="l5.466">   },</span>
<a href="#l5.467"></a><span id="l5.467"> </span>
<a href="#l5.468"></a><span id="l5.468">   // Helper function to disconnect with authentication failed.</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-  _disconnectWithAuthFailure: function(aMessageId=&quot;error.auth&quot;) {</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+  _disconnectWithAuthFailure(aMessageId = &quot;error.auth&quot;) {</span>
<a href="#l5.471"></a><span id="l5.471">     this.reportDisconnecting(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l5.472"></a><span id="l5.472">                              _(aMessageId));</span>
<a href="#l5.473"></a><span id="l5.473">     this.reportDisconnected();</span>
<a href="#l5.474"></a><span id="l5.474">   },</span>
<a href="#l5.475"></a><span id="l5.475"> </span>
<a href="#l5.476"></a><span id="l5.476" class="difflineminus">-  disconnect: function() {</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+  disconnect() {</span>
<a href="#l5.478"></a><span id="l5.478">     if (this.disconnected || this.disconnecting)</span>
<a href="#l5.479"></a><span id="l5.479">       return;</span>
<a href="#l5.480"></a><span id="l5.480"> </span>
<a href="#l5.481"></a><span id="l5.481">     clearTimeout(this._poller);</span>
<a href="#l5.482"></a><span id="l5.482">     if (this._request)</span>
<a href="#l5.483"></a><span id="l5.483">       this._request.abort();</span>
<a href="#l5.484"></a><span id="l5.484"> </span>
<a href="#l5.485"></a><span id="l5.485">     this._request = null;</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineat">@@ -813,58 +812,58 @@ SkypeAccount.prototype = {</span>
<a href="#l5.487"></a><span id="l5.487">     // Mark all contacts on the account as having an unknown status.</span>
<a href="#l5.488"></a><span id="l5.488">     this._buddies.forEach(aBuddy =&gt;</span>
<a href="#l5.489"></a><span id="l5.489">       aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;));</span>
<a href="#l5.490"></a><span id="l5.490"> </span>
<a href="#l5.491"></a><span id="l5.491">     this.reportDisconnected();</span>
<a href="#l5.492"></a><span id="l5.492">   },</span>
<a href="#l5.493"></a><span id="l5.493"> </span>
<a href="#l5.494"></a><span id="l5.494">   // TODO?</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {},</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+  observe(aSubject, aTopic, aData) {},</span>
<a href="#l5.497"></a><span id="l5.497"> </span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-  remove: function() {</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+  remove() {</span>
<a href="#l5.500"></a><span id="l5.500">     this._conversations.forEach(conv =&gt; conv.close());</span>
<a href="#l5.501"></a><span id="l5.501">     delete this._conversations;</span>
<a href="#l5.502"></a><span id="l5.502">     this.buddies.forEach(aBuddy =&gt; aBuddy.remove());</span>
<a href="#l5.503"></a><span id="l5.503">     delete this.buddies;</span>
<a href="#l5.504"></a><span id="l5.504">   },</span>
<a href="#l5.505"></a><span id="l5.505"> </span>
<a href="#l5.506"></a><span id="l5.506" class="difflineminus">-  unInit: function() {</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+  unInit() {</span>
<a href="#l5.508"></a><span id="l5.508">     delete this.imAccount;</span>
<a href="#l5.509"></a><span id="l5.509">     clearTimeout(this._poller);</span>
<a href="#l5.510"></a><span id="l5.510">   },</span>
<a href="#l5.511"></a><span id="l5.511"> </span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-  createConversation: function(aName) {</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l5.514"></a><span id="l5.514">     let conv = new SkypeConversation(this, aName);</span>
<a href="#l5.515"></a><span id="l5.515">     this._conversations.set(aName, conv);</span>
<a href="#l5.516"></a><span id="l5.516">     return conv;</span>
<a href="#l5.517"></a><span id="l5.517">   },</span>
<a href="#l5.518"></a><span id="l5.518"> </span>
<a href="#l5.519"></a><span id="l5.519">   // Called when the user adds or authorizes a new contact.</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-  addBuddy: function(aTag, aName) {},</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+  addBuddy(aTag, aName) {},</span>
<a href="#l5.522"></a><span id="l5.522"> </span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-  loadBuddy: function(aBuddy, aTag) {</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+  loadBuddy(aBuddy, aTag) {</span>
<a href="#l5.525"></a><span id="l5.525">     let buddy = new SkypeAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l5.526"></a><span id="l5.526">     this._buddies.set(buddy.userName, buddy);</span>
<a href="#l5.527"></a><span id="l5.527"> </span>
<a href="#l5.528"></a><span id="l5.528">     return buddy;</span>
<a href="#l5.529"></a><span id="l5.529">   },</span>
<a href="#l5.530"></a><span id="l5.530"> </span>
<a href="#l5.531"></a><span id="l5.531">   // TODO Add support for MUCs.</span>
<a href="#l5.532"></a><span id="l5.532">   get canJoinChat() { return false; },</span>
<a href="#l5.533"></a><span id="l5.533">   chatRoomFields: {},</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-  joinChat: function(aComponents) {}</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+  joinChat(aComponents) {},</span>
<a href="#l5.536"></a><span id="l5.536"> };</span>
<a href="#l5.537"></a><span id="l5.537"> </span>
<a href="#l5.538"></a><span id="l5.538"> function SkypeProtocol() {}</span>
<a href="#l5.539"></a><span id="l5.539"> SkypeProtocol.prototype = {</span>
<a href="#l5.540"></a><span id="l5.540">   __proto__: GenericProtocolPrototype,</span>
<a href="#l5.541"></a><span id="l5.541">   get name() { return &quot;Skype&quot;; },</span>
<a href="#l5.542"></a><span id="l5.542">   get iconBaseURI() { return &quot;chrome://prpl-skype/skin/&quot;; },</span>
<a href="#l5.543"></a><span id="l5.543">   get baseId() { return &quot;prpl-skype&quot;; },</span>
<a href="#l5.544"></a><span id="l5.544"> </span>
<a href="#l5.545"></a><span id="l5.545">   get passwordOptional() { return false; },</span>
<a href="#l5.546"></a><span id="l5.546"> </span>
<a href="#l5.547"></a><span id="l5.547" class="difflineminus">-  getAccount: function(aImAccount) { return new SkypeAccount(this, aImAccount); },</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineminus">-  classID: Components.ID(&quot;{8446c0f6-9f59-4710-844e-eaa6c1f49d35}&quot;)</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+  getAccount(aImAccount) { return new SkypeAccount(this, aImAccount); },</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+  classID: Components.ID(&quot;{8446c0f6-9f59-4710-844e-eaa6c1f49d35}&quot;),</span>
<a href="#l5.551"></a><span id="l5.551"> };</span>
<a href="#l5.552"></a><span id="l5.552"> </span>
<a href="#l5.553"></a><span id="l5.553"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([SkypeProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/protocols/skype/test/test_MagicSha256.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/protocols/skype/test/test_MagicSha256.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.6"></a><span id="l6.6"> var skype = {};</span>
<a href="#l6.7"></a><span id="l6.7"> Services.scriptloader.loadSubScript(&quot;resource:///components/skype.js&quot;, skype);</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> var data = {</span>
<a href="#l6.10"></a><span id="l6.10">   &quot;1416264993&quot;: &quot;3a33ac47fe2ec1a33d569f4be5c69ddc&quot;,</span>
<a href="#l6.11"></a><span id="l6.11">   &quot;1416387358&quot;: &quot;eca9716e1eedcbe93320ba794cea3388&quot;,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  &quot;1416392361&quot;: &quot;2ed6fc80c3303caa137ae3fd4fcc7d80&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  &quot;1416392361&quot;: &quot;2ed6fc80c3303caa137ae3fd4fcc7d80&quot;,</span>
<a href="#l6.14"></a><span id="l6.14"> };</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> function run_test() {</span>
<a href="#l6.17"></a><span id="l6.17">   add_test(test_MagicSha256);</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   run_next_test();</span>
<a href="#l6.20"></a><span id="l6.20"> }</span>
<a href="#l6.21"></a><span id="l6.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/protocols/skype/test/test_contactUrlToName.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/protocols/skype/test/test_contactUrlToName.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.5"></a><span id="l7.5"> var skype = {};</span>
<a href="#l7.6"></a><span id="l7.6"> Services.scriptloader.loadSubScript(&quot;resource:///components/skype.js&quot;, skype);</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> var data = {</span>
<a href="#l7.9"></a><span id="l7.9">   &quot;https://bay-client-s.gateway.messenger.live.com/v1/users/ME/contacts/8:clokep&quot;:</span>
<a href="#l7.10"></a><span id="l7.10">     &quot;clokep&quot;,</span>
<a href="#l7.11"></a><span id="l7.11">   &quot;https://bay-client-s.gateway.messenger.live.com/v1/users/8:clokep/presenceDocs/messagingService&quot;:</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    &quot;clokep&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    &quot;clokep&quot;,</span>
<a href="#l7.14"></a><span id="l7.14"> };</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> function run_test() {</span>
<a href="#l7.17"></a><span id="l7.17">   add_test(test_contactUrlToName);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   run_next_test();</span>
<a href="#l7.20"></a><span id="l7.20"> }</span>
<a href="#l7.21"></a><span id="l7.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -32,29 +32,29 @@ XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, (</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> function YahooAccount(aProtoInstance, aImAccount)</span>
<a href="#l8.6"></a><span id="l8.6"> {</span>
<a href="#l8.7"></a><span id="l8.7">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l8.8"></a><span id="l8.8"> }</span>
<a href="#l8.9"></a><span id="l8.9"> YahooAccount.prototype = {</span>
<a href="#l8.10"></a><span id="l8.10">   __proto__: GenericAccountPrototype,</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  connect: function() {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  connect() {</span>
<a href="#l8.14"></a><span id="l8.14">     this.WARN(&quot;The legacy versions of Yahoo Messenger was disabled on August &quot; +</span>
<a href="#l8.15"></a><span id="l8.15">               &quot;5, 2016. It is currently not possible to connect to Yahoo &quot; +</span>
<a href="#l8.16"></a><span id="l8.16">               &quot;Messenger. See bug 1316000&quot;);</span>
<a href="#l8.17"></a><span id="l8.17">     this.reportDisconnecting(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l8.18"></a><span id="l8.18">                              _(&quot;yahoo.disabled&quot;));</span>
<a href="#l8.19"></a><span id="l8.19">     this.reportDisconnected();</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-  }</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  },</span>
<a href="#l8.22"></a><span id="l8.22"> };</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> function YahooProtocol() {}</span>
<a href="#l8.25"></a><span id="l8.25"> YahooProtocol.prototype = {</span>
<a href="#l8.26"></a><span id="l8.26">   __proto__: GenericProtocolPrototype,</span>
<a href="#l8.27"></a><span id="l8.27">   get id() { return &quot;prpl-yahoo&quot;; },</span>
<a href="#l8.28"></a><span id="l8.28">   get name() { return &quot;Yahoo&quot;; },</span>
<a href="#l8.29"></a><span id="l8.29">   get iconBaseURI() { return &quot;chrome://prpl-yahoo/skin/&quot;; },</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  getAccount: function(aImAccount) { return new YahooAccount(this, aImAccount); },</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  classID: Components.ID(&quot;{50ea817e-5d79-4657-91ae-aa0a52bdb98c}&quot;)</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  getAccount(aImAccount) { return new YahooAccount(this, aImAccount); },</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  classID: Components.ID(&quot;{50ea817e-5d79-4657-91ae-aa0a52bdb98c}&quot;),</span>
<a href="#l8.34"></a><span id="l8.34"> };</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([YahooProtocol]);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

