<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11006:8cd81ff229ebfb46b6e8f25490afd3af09672ad5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8cd81ff229ebfb46b6e8f25490afd3af09672ad5" />
<meta property="og:url" content="/comm-central/rev/8cd81ff229ebfb46b6e8f25490afd3af09672ad5" />
<meta property="og:description" content="Bug 783908 Implement remaining parts of GNOME shell service r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8cd81ff229ebfb46b6e8f25490afd3af09672ad5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8cd81ff229ebfb46b6e8f25490afd3af09672ad5">shortlog</a> |
<a href="/comm-central/log/8cd81ff229ebfb46b6e8f25490afd3af09672ad5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8cd81ff229ebfb46b6e8f25490afd3af09672ad5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8cd81ff229ebfb46b6e8f25490afd3af09672ad5">files</a> |
changeset |
<a href="/comm-central/raw-rev/8cd81ff229ebfb46b6e8f25490afd3af09672ad5">raw</a>  | <a href="/comm-central/archive/8cd81ff229ebfb46b6e8f25490afd3af09672ad5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=783908">Bug 783908</a> Implement remaining parts of GNOME shell service r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#78;&#101;&#105;&#108;&#32;&#82;&#97;&#115;&#104;&#98;&#114;&#111;&#111;&#107;&#32;&#60;&#110;&#101;&#105;&#108;&#64;&#112;&#97;&#114;&#107;&#119;&#97;&#121;&#99;&#99;&#46;&#99;&#111;&#46;&#117;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 02 Sep 2012 17:50:34 +0100</td></tr>

<tr>
 <td>changeset 11006</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8cd81ff229ebfb46b6e8f25490afd3af09672ad5">8cd81ff229ebfb46b6e8f25490afd3af09672ad5</a></td>
</tr>



<tr>
<td>parent 11005</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ff603e79f92ad7b5668d0ad865987b470c2e6749">ff603e79f92ad7b5668d0ad865987b470c2e6749</a>
</td>
</tr>

<tr>
<td>child 11007</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e77ae46c56d5dd9e04d5d4b6537546c5206d8128">e77ae46c56d5dd9e04d5d4b6537546c5206d8128</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8cd81ff229ebfb46b6e8f25490afd3af09672ad5">8256</a></td></tr>
<tr><td>push user</td><td>neil@parkwaycc.co.uk</td></tr>
<tr><td>push date</td><td class="date age">Sun, 02 Sep 2012 16:50:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8cd81ff229eb [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8cd81ff229ebfb46b6e8f25490afd3af09672ad5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8cd81ff229ebfb46b6e8f25490afd3af09672ad5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8cd81ff229ebfb46b6e8f25490afd3af09672ad5&newProject=comm-central&newRevision=8cd81ff229ebfb46b6e8f25490afd3af09672ad5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8cd81ff229ebfb46b6e8f25490afd3af09672ad5&newProject=comm-central&newRevision=8cd81ff229ebfb46b6e8f25490afd3af09672ad5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8cd81ff229ebfb46b6e8f25490afd3af09672ad5&newProject=comm-central&newRevision=8cd81ff229ebfb46b6e8f25490afd3af09672ad5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=783908">783908</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=783908">Bug 783908</a> Implement remaining parts of GNOME shell service r=IanN</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.js">suite/common/pref/pref-navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.js">file</a> |
<a href="/comm-central/annotate/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.js">annotate</a> |
<a href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.js">diff</a> |
<a href="/comm-central/comparison/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.js">comparison</a> |
<a href="/comm-central/log/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.xul">suite/common/pref/pref-navigator.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.xul">file</a> |
<a href="/comm-central/annotate/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.xul">annotate</a> |
<a href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.xul">diff</a> |
<a href="/comm-central/comparison/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.xul">comparison</a> |
<a href="/comm-central/log/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/common/pref/pref-navigator.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">suite/locales/en-US/chrome/common/pref/pref-navigator.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">file</a> |
<a href="/comm-central/annotate/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">annotate</a> |
<a href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">diff</a> |
<a href="/comm-central/comparison/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">comparison</a> |
<a href="/comm-central/log/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.cpp">suite/shell/src/nsGNOMEShellService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.cpp">file</a> |
<a href="/comm-central/annotate/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.cpp">annotate</a> |
<a href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.cpp">diff</a> |
<a href="/comm-central/comparison/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.cpp">comparison</a> |
<a href="/comm-central/log/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.h">suite/shell/src/nsGNOMEShellService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.h">file</a> |
<a href="/comm-central/annotate/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.h">annotate</a> |
<a href="/comm-central/diff/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.h">diff</a> |
<a href="/comm-central/comparison/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.h">comparison</a> |
<a href="/comm-central/log/8cd81ff229ebfb46b6e8f25490afd3af09672ad5/suite/shell/src/nsGNOMEShellService.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/pref/pref-navigator.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/pref/pref-navigator.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -272,48 +272,56 @@ function ApplySetAsDefaultBrowser()</span>
<a href="#l1.4"></a><span id="l1.4">   const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l1.5"></a><span id="l1.5">   var shellSvc = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l1.6"></a><span id="l1.6">                            .getService(nsIShellService);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   shellSvc.setDefaultClient(false, false, nsIShellService.BROWSER);</span>
<a href="#l1.9"></a><span id="l1.9">   shellSvc.shouldBeDefaultClientFor |= nsIShellService.BROWSER;</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+function IsDefaultBrowser()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+{</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  var shellSvc = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                           .getService(nsIShellService);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  return shellSvc.isDefaultClient(false, nsIShellService.BROWSER);</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+}</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+</span>
<a href="#l1.21"></a><span id="l1.21"> function InitPlatformIntegration()</span>
<a href="#l1.22"></a><span id="l1.22"> {</span>
<a href="#l1.23"></a><span id="l1.23">   const NS_SHELLSERVICE_CID = &quot;@mozilla.org/suite/shell-service;1&quot;;</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">   if (NS_SHELLSERVICE_CID in Components.classes) try {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    var shellSvc = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-                             .getService(nsIShellService);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-</span>
<a href="#l1.30"></a><span id="l1.30">     var desc = document.getElementById(&quot;defaultBrowserDesc&quot;);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    if (shellSvc.isDefaultClient(false, nsIShellService.BROWSER))</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    if (IsDefaultBrowser())</span>
<a href="#l1.33"></a><span id="l1.33">       desc.textContent = desc.getAttribute(&quot;desc1&quot;);</span>
<a href="#l1.34"></a><span id="l1.34">     else {</span>
<a href="#l1.35"></a><span id="l1.35">       desc.textContent = desc.getAttribute(&quot;desc0&quot;);</span>
<a href="#l1.36"></a><span id="l1.36">       document.getElementById(&quot;defaultBrowserButton&quot;).disabled = false;</span>
<a href="#l1.37"></a><span id="l1.37">     }</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39">     document.getElementById(&quot;defaultBrowserGroup&quot;).hidden = false;</span>
<a href="#l1.40"></a><span id="l1.40">   } catch (e) {</span>
<a href="#l1.41"></a><span id="l1.41">   }</span>
<a href="#l1.42"></a><span id="l1.42"> }</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44"> function SetAsDefaultBrowser()</span>
<a href="#l1.45"></a><span id="l1.45"> {</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-  document.getElementById(&quot;defaultBrowserButton&quot;).disabled = true;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  var desc = document.getElementById(&quot;defaultBrowserDesc&quot;);</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49">   if (document.documentElement.instantApply)</span>
<a href="#l1.50"></a><span id="l1.50">   {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-    var desc = document.getElementById(&quot;defaultBrowserDesc&quot;); </span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-    desc.textContent = desc.getAttribute(&quot;desc1&quot;);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-    ApplySetAsDefaultBrowser();</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    if (IsDefaultBrowser())</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+      desc.textContent = desc.getAttribute(&quot;desc1&quot;);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    else {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      desc.textContent = desc.getAttribute(&quot;desc3&quot;);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+      ApplySetAsDefaultBrowser();</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    }</span>
<a href="#l1.60"></a><span id="l1.60">   }</span>
<a href="#l1.61"></a><span id="l1.61">   else</span>
<a href="#l1.62"></a><span id="l1.62">   {</span>
<a href="#l1.63"></a><span id="l1.63">     // register OK handler for the capturing phase</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-    var desc = document.getElementById(&quot;defaultBrowserDesc&quot;);</span>
<a href="#l1.65"></a><span id="l1.65">     desc.textContent = desc.getAttribute(&quot;desc2&quot;);</span>
<a href="#l1.66"></a><span id="l1.66">     window.addEventListener(&quot;dialogaccept&quot;, this.ApplySetAsDefaultBrowser, true);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+    document.getElementById(&quot;defaultBrowserButton&quot;).disabled = true;</span>
<a href="#l1.68"></a><span id="l1.68">   }</span>
<a href="#l1.69"></a><span id="l1.69"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/common/pref/pref-navigator.xul</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/common/pref/pref-navigator.xul</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -101,25 +101,27 @@</span>
<a href="#l2.4"></a><span id="l2.4">                    accesskey=&quot;&amp;lastPageRadio.accesskey;&quot;/&gt;</span>
<a href="#l2.5"></a><span id="l2.5">           &lt;/radiogroup&gt;</span>
<a href="#l2.6"></a><span id="l2.6">         &lt;/deck&gt;</span>
<a href="#l2.7"></a><span id="l2.7">       &lt;/groupbox&gt;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">       &lt;!-- default browser settings are shown only if supported by the platform --&gt;</span>
<a href="#l2.10"></a><span id="l2.10">       &lt;groupbox id=&quot;defaultBrowserGroup&quot; flex=&quot;1000&quot; align=&quot;center&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l2.11"></a><span id="l2.11">         &lt;caption label=&quot;&amp;defaultBrowserGroup.label;&quot;/&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        &lt;!-- We have three use cases, identified by their index:</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        &lt;!-- We have four use cases, identified by their index:</span>
<a href="#l2.14"></a><span id="l2.14">              0: not already the default =&gt; button enabled</span>
<a href="#l2.15"></a><span id="l2.15">              1: already the default =&gt; button disabled</span>
<a href="#l2.16"></a><span id="l2.16">              2: user pushed button =&gt; button disabled with different text</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+             3: user pushed button (instant apply) =&gt; different text</span>
<a href="#l2.18"></a><span id="l2.18">         --&gt;</span>
<a href="#l2.19"></a><span id="l2.19">         &lt;description id=&quot;defaultBrowserDesc&quot;</span>
<a href="#l2.20"></a><span id="l2.20">                      desc0=&quot;&amp;makeDefaultText;&quot;</span>
<a href="#l2.21"></a><span id="l2.21">                      desc1=&quot;&amp;alreadyDefaultText;&quot;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-                     desc2=&quot;&amp;defaultPendingText;&quot;/&gt;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+                     desc2=&quot;&amp;defaultPendingText;&quot;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+                     desc3=&quot;&amp;wasMadeDefaultText;&quot;/&gt;</span>
<a href="#l2.25"></a><span id="l2.25">         &lt;button id=&quot;defaultBrowserButton&quot;</span>
<a href="#l2.26"></a><span id="l2.26">                 label=&quot;&amp;defaultBrowserButton.label;&quot;</span>
<a href="#l2.27"></a><span id="l2.27">                 accesskey=&quot;&amp;defaultBrowserButton.accesskey;&quot;</span>
<a href="#l2.28"></a><span id="l2.28">                 oncommand=&quot;SetAsDefaultBrowser()&quot;</span>
<a href="#l2.29"></a><span id="l2.29">                 disabled=&quot;true&quot;</span>
<a href="#l2.30"></a><span id="l2.30">                 preference=&quot;pref.browser.disable_button.default_browser&quot;/&gt;</span>
<a href="#l2.31"></a><span id="l2.31">       &lt;/groupbox&gt;</span>
<a href="#l2.32"></a><span id="l2.32">     &lt;/hbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -41,9 +41,10 @@</span>
<a href="#l3.4"></a><span id="l3.4"> &lt;!ENTITY useDefault.label               &quot;Restore Default&quot;&gt;</span>
<a href="#l3.5"></a><span id="l3.5"> &lt;!ENTITY useDefault.accesskey           &quot;R&quot;&gt;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> &lt;!ENTITY defaultBrowserGroup.label      &quot;Default Browser&quot;&gt;</span>
<a href="#l3.8"></a><span id="l3.8"> &lt;!ENTITY defaultBrowserButton.label     &quot;Set Default Browser&quot;&gt;</span>
<a href="#l3.9"></a><span id="l3.9"> &lt;!ENTITY defaultBrowserButton.accesskey &quot;D&quot;&gt;</span>
<a href="#l3.10"></a><span id="l3.10"> &lt;!ENTITY alreadyDefaultText             &quot;&amp;brandShortName; is already your default browser.&quot;&gt;</span>
<a href="#l3.11"></a><span id="l3.11"> &lt;!ENTITY defaultPendingText             &quot;&amp;brandShortName; will be set as your default browser when you click OK.&quot;&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+&lt;!ENTITY wasMadeDefaultText             &quot;&amp;brandShortName; has been set as your default browser.&quot;&gt;</span>
<a href="#l3.13"></a><span id="l3.13"> &lt;!ENTITY makeDefaultText                &quot;Set &amp;brandShortName; as your default browser.&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/shell/src/nsGNOMEShellService.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/shell/src/nsGNOMEShellService.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -7,25 +7,28 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsGNOMEShellService.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIGSettingsService.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIGConfService.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsIGnomeVFSService.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;nsIGIOService.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#include &quot;nsIPrefService.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsIImageLoadingContent.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsIDOMElement.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;imgIRequest.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;imgIContainer.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;nsIImageToPixbuf.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsIFile.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21"> #include &quot;nsIProcess.h&quot;</span>
<a href="#l4.22"></a><span id="l4.22"> #include &quot;prenv.h&quot;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+#include &quot;mozilla/Util.h&quot;</span>
<a href="#l4.24"></a><span id="l4.24"> #include &lt;glib.h&gt;</span>
<a href="#l4.25"></a><span id="l4.25"> #include &lt;glib-object.h&gt;</span>
<a href="#l4.26"></a><span id="l4.26"> #include &lt;gtk/gtk.h&gt;</span>
<a href="#l4.27"></a><span id="l4.27"> #include &lt;gdk/gdk.h&gt;</span>
<a href="#l4.28"></a><span id="l4.28"> #include &lt;gdk-pixbuf/gdk-pixbuf.h&gt;</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30"> // GConf registry key constants</span>
<a href="#l4.31"></a><span id="l4.31"> #define DG_BACKGROUND &quot;/desktop/gnome/background&quot;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineat">@@ -36,106 +39,290 @@</span>
<a href="#l4.33"></a><span id="l4.33"> #define DGB_COLOR DG_BACKGROUND &quot;/primary_color&quot;</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> #define OGDB_SCHEMA &quot;org.gnome.desktop.background&quot;</span>
<a href="#l4.36"></a><span id="l4.36"> #define OGDB_OPTIONS &quot;picture-options&quot;</span>
<a href="#l4.37"></a><span id="l4.37"> #define OGDB_IMAGE &quot;picture-uri&quot;</span>
<a href="#l4.38"></a><span id="l4.38"> #define OGDB_DRAWBG &quot;draw-background&quot;</span>
<a href="#l4.39"></a><span id="l4.39"> #define OGDB_COLOR &quot;primary-color&quot;</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+struct ProtocolAssociation {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  uint16_t app;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  const char* protocol;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+};</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+struct MimeTypeAssociation {</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  uint16_t app;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  const char* mimeType;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  const char* extensions;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+};</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+static const ProtocolAssociation gProtocols[] = {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  { nsIShellService::BROWSER, &quot;http&quot; },</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  { nsIShellService::BROWSER, &quot;https&quot; },</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  { nsIShellService::MAIL, &quot;mailto&quot; },</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  { nsIShellService::NEWS, &quot;news&quot; },</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  { nsIShellService::NEWS, &quot;snews&quot; },</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  { nsIShellService::RSS, &quot;feed&quot; }</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+};</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+static const MimeTypeAssociation gMimeTypes[] = {</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  { nsIShellService::BROWSER, &quot;text/html&quot;, &quot;htm html&quot; },</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  { nsIShellService::BROWSER, &quot;application/xhtml+xml&quot;, &quot;xhtml&quot; },</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  { nsIShellService::MAIL, &quot;message/rfc822&quot;, &quot;eml&quot; },</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  { nsIShellService::RSS, &quot;application/rss+xml&quot;, &quot;rss&quot; }</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+};</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68"> NS_IMPL_ISUPPORTS1(nsGNOMEShellService, nsIShellService)</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70"> nsresult</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+GetBrandName(nsACString&amp; aBrandName)</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+{</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  // get the product brand name from localized strings</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(&quot;@mozilla.org/intl/stringbundle;1&quot;, &amp;rv));</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; brandBundle;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(BRAND_PROPERTIES, getter_AddRefs(brandBundle));</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  NS_ENSURE_TRUE(brandBundle, rv);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  nsString brandName;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  rv = brandBundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;brandShortName&quot;).get(),</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+                                      getter_Copies(brandName));</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  CopyUTF16toUTF8(brandName, aBrandName);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  return rv;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+}</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+nsresult</span>
<a href="#l4.92"></a><span id="l4.92"> nsGNOMEShellService::Init()</span>
<a href="#l4.93"></a><span id="l4.93"> {</span>
<a href="#l4.94"></a><span id="l4.94">   nsresult rv;</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96">   // Check G_BROKEN_FILENAMES.  If it's set, then filenames in glib use</span>
<a href="#l4.97"></a><span id="l4.97">   // the locale encoding.  If it's not set, they use UTF-8.</span>
<a href="#l4.98"></a><span id="l4.98">   mUseLocaleFilenames = PR_GetEnv(&quot;G_BROKEN_FILENAMES&quot;) != nullptr;</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  const char* launcher = PR_GetEnv(&quot;MOZ_APP_LAUNCHER&quot;);</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+  if (launcher) {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    if (g_path_is_absolute(launcher)) {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+      mAppPath = launcher;</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+      gchar* basename = g_path_get_basename(launcher);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+      gchar* fullpath = g_find_program_in_path(basename);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+      mAppIsInPath = fullpath &amp;&amp; mAppPath.Equals(fullpath);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      g_free(fullpath);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      g_free(basename);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      return NS_OK;</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    }</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    gchar* fullpath = g_find_program_in_path(launcher);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    if (fullpath) {</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+      mAppPath = fullpath;</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+      mAppIsInPath = true;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+      g_free(fullpath);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+      return NS_OK;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+    }</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  }</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+</span>
<a href="#l4.121"></a><span id="l4.121">   nsCOMPtr&lt;nsIFile&gt; appPath;</span>
<a href="#l4.122"></a><span id="l4.122">   rv = NS_GetSpecialDirectory(NS_XPCOM_CURRENT_PROCESS_DIR,</span>
<a href="#l4.123"></a><span id="l4.123">                               getter_AddRefs(appPath));</span>
<a href="#l4.124"></a><span id="l4.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.125"></a><span id="l4.125"> </span>
<a href="#l4.126"></a><span id="l4.126">   rv = appPath-&gt;AppendNative(NS_LITERAL_CSTRING(MOZ_APP_NAME));</span>
<a href="#l4.127"></a><span id="l4.127">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129">   return appPath-&gt;GetNativePath(mAppPath);</span>
<a href="#l4.130"></a><span id="l4.130"> }</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+bool</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+nsGNOMEShellService::HandlerMatchesAppName(const char* aHandler)</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+{</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+  bool matches = false;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+  gint argc;</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+  gchar** argv;</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+  if (g_shell_parse_argv(aHandler, &amp;argc, &amp;argv, NULL) &amp;&amp; argc &gt; 0) {</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    gchar* command = NULL;</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    if (!mUseLocaleFilenames)</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+      command = g_find_program_in_path(argv[0]);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    else {</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+      gchar* nativeFile = g_filename_from_utf8(argv[0], -1, NULL, NULL, NULL);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+      if (nativeFile) {</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+        command = g_find_program_in_path(nativeFile);</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+        g_free(nativeFile);</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+      }</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    }</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+    matches = command &amp;&amp; mAppPath.Equals(command);</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+    g_free(command);</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+    g_strfreev(argv);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+  }</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+  return matches;</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+}</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+</span>
<a href="#l4.157"></a><span id="l4.157"> NS_IMETHODIMP</span>
<a href="#l4.158"></a><span id="l4.158"> nsGNOMEShellService::IsDefaultClient(bool aStartupCheck, uint16_t aApps,</span>
<a href="#l4.159"></a><span id="l4.159">                                      bool* aIsDefaultClient)</span>
<a href="#l4.160"></a><span id="l4.160"> {</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+  if (aStartupCheck)</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+    mCheckedThisSessionClient = true;</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+  *aIsDefaultClient = false;</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+  nsCString handler;</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+  nsCOMPtr&lt;nsIGIOMimeApp&gt; app;</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+  nsCOMPtr&lt;nsIGIOService&gt; giovfs = do_GetService(NS_GIOSERVICE_CONTRACTID);</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  nsCOMPtr&lt;nsIGConfService&gt; gconf = do_GetService(NS_GCONFSERVICE_CONTRACTID);</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+  for (unsigned i = 0; i &lt; mozilla::ArrayLength(gProtocols); i++) {</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+    if (aApps &amp; gProtocols[i].app) {</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+      nsDependentCString protocol(gProtocols[i].protocol);</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+      if (giovfs) {</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+        giovfs-&gt;GetAppForURIScheme(protocol, getter_AddRefs(app));</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+        if (!app)</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+          return NS_OK;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+        if (NS_SUCCEEDED(app-&gt;GetCommand(handler)) &amp;&amp;</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+            !HandlerMatchesAppName(handler.get()))</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+         return NS_OK;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+      }</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+      bool enabled;</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+      if (gconf &amp;&amp;</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+          NS_SUCCEEDED(gconf-&gt;GetAppForProtocol(protocol, &amp;enabled, handler)) &amp;&amp;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+          (!enabled || !HandlerMatchesAppName(handler.get())))</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+        return NS_OK;</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+    }</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  }</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+  *aIsDefaultClient = true;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.194"></a><span id="l4.194"> }</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196"> NS_IMETHODIMP</span>
<a href="#l4.197"></a><span id="l4.197"> nsGNOMEShellService::SetDefaultClient(bool aForAllUsers,</span>
<a href="#l4.198"></a><span id="l4.198">                                       bool aClaimAllTypes, uint16_t aApps)</span>
<a href="#l4.199"></a><span id="l4.199"> {</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+  nsCOMPtr&lt;nsIGIOMimeApp&gt; app;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+  nsCOMPtr&lt;nsIGIOService&gt; giovfs = do_GetService(NS_GIOSERVICE_CONTRACTID);</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+  if (giovfs) {</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+    nsCString brandName;</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+    rv = GetBrandName(brandName);</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+    rv = giovfs-&gt;CreateAppFromCommand(mAppPath, brandName, getter_AddRefs(app));</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    for (unsigned i = 0; i &lt; mozilla::ArrayLength(gMimeTypes); i++) {</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+      if (aApps &amp; gMimeTypes[i].app) {</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+        rv = app-&gt;SetAsDefaultForMimeType(nsDependentCString(gMimeTypes[i].mimeType));</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+        rv = app-&gt;SetAsDefaultForFileExtensions(nsDependentCString(gMimeTypes[i].extensions));</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+      }</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+    }</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+  }</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+  nsCString appKeyValue;</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+  nsCOMPtr&lt;nsIGConfService&gt; gconf = do_GetService(NS_GCONFSERVICE_CONTRACTID);</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  if (gconf) {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+    if (!mAppIsInPath)</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+      appKeyValue = mAppPath;</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    else {</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+      gchar* basename = g_path_get_basename(mAppPath.get());</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+      appKeyValue = basename;</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+      g_free(basename);</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+    }</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+    appKeyValue.AppendLiteral(&quot; %s&quot;);</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+  }</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+  for (unsigned i = 0; i &lt; mozilla::ArrayLength(gProtocols); i++) {</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+    if (aApps &amp; gProtocols[i].app) {</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+      nsDependentCString protocol(gProtocols[i].protocol);</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+      if (app) {</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+        rv = app-&gt;SetAsDefaultForURIScheme(protocol);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+      }</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+      if (gconf) {</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+        rv = gconf-&gt;SetAppForProtocol(protocol, appKeyValue);</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+      }</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    }</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+  }</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.251"></a><span id="l4.251"> }</span>
<a href="#l4.252"></a><span id="l4.252"> </span>
<a href="#l4.253"></a><span id="l4.253"> NS_IMETHODIMP</span>
<a href="#l4.254"></a><span id="l4.254"> nsGNOMEShellService::GetShouldCheckDefaultClient(bool* aResult)</span>
<a href="#l4.255"></a><span id="l4.255"> {</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+  if (mCheckedThisSessionClient) {</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    *aResult = false;</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+    return NS_OK;</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+  }</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+  return prefs-&gt;GetBoolPref(PREF_CHECKDEFAULTCLIENT, aResult);</span>
<a href="#l4.266"></a><span id="l4.266"> }</span>
<a href="#l4.267"></a><span id="l4.267"> </span>
<a href="#l4.268"></a><span id="l4.268"> NS_IMETHODIMP</span>
<a href="#l4.269"></a><span id="l4.269"> nsGNOMEShellService::SetShouldCheckDefaultClient(bool aShouldCheck)</span>
<a href="#l4.270"></a><span id="l4.270"> {</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+  return prefs-&gt;SetBoolPref(PREF_CHECKDEFAULTCLIENT, aShouldCheck);</span>
<a href="#l4.276"></a><span id="l4.276"> }</span>
<a href="#l4.277"></a><span id="l4.277"> </span>
<a href="#l4.278"></a><span id="l4.278"> NS_IMETHODIMP</span>
<a href="#l4.279"></a><span id="l4.279"> nsGNOMEShellService::GetShouldBeDefaultClientFor(uint16_t* aApps)</span>
<a href="#l4.280"></a><span id="l4.280"> {</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+  int32_t result;</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+  rv = prefs-&gt;GetIntPref(&quot;shell.checkDefaultApps&quot;, &amp;result);</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+  *aApps = result;</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+  return rv;</span>
<a href="#l4.289"></a><span id="l4.289"> }</span>
<a href="#l4.290"></a><span id="l4.290"> </span>
<a href="#l4.291"></a><span id="l4.291"> NS_IMETHODIMP</span>
<a href="#l4.292"></a><span id="l4.292"> nsGNOMEShellService::SetShouldBeDefaultClientFor(uint16_t aApps)</span>
<a href="#l4.293"></a><span id="l4.293"> {</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+  return prefs-&gt;SetIntPref(&quot;shell.checkDefaultApps&quot;, aApps);</span>
<a href="#l4.299"></a><span id="l4.299"> }</span>
<a href="#l4.300"></a><span id="l4.300"> </span>
<a href="#l4.301"></a><span id="l4.301"> NS_IMETHODIMP</span>
<a href="#l4.302"></a><span id="l4.302"> nsGNOMEShellService::GetCanSetDesktopBackground(bool* aResult)</span>
<a href="#l4.303"></a><span id="l4.303"> {</span>
<a href="#l4.304"></a><span id="l4.304">   nsCOMPtr&lt;nsIGConfService&gt; gconf(do_GetService(NS_GCONFSERVICE_CONTRACTID));</span>
<a href="#l4.305"></a><span id="l4.305">   *aResult = gconf &amp;&amp; getenv(&quot;GNOME_DESKTOP_SESSION_ID&quot;);</span>
<a href="#l4.306"></a><span id="l4.306">   return NS_OK;</span>
<a href="#l4.307"></a><span id="l4.307"> }</span>
<a href="#l4.308"></a><span id="l4.308"> </span>
<a href="#l4.309"></a><span id="l4.309"> NS_IMETHODIMP</span>
<a href="#l4.310"></a><span id="l4.310"> nsGNOMEShellService::SetDesktopBackground(nsIDOMElement* aElement, </span>
<a href="#l4.311"></a><span id="l4.311">                                           int32_t aPosition)</span>
<a href="#l4.312"></a><span id="l4.312"> {</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-  // get the product brand name from localized strings</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-  nsresult rv;</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-  nsString brandName;</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(&quot;@mozilla.org/intl/stringbundle;1&quot;, &amp;rv));</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; brandBundle;</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(BRAND_PROPERTIES, getter_AddRefs(brandBundle));</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-  NS_ENSURE_TRUE(brandBundle, rv);</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-  rv = brandBundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;brandShortName&quot;).get(),</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-                                      getter_Copies(brandName));</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+  nsCString brandName;</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+  nsresult rv = GetBrandName(brandName);</span>
<a href="#l4.327"></a><span id="l4.327">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.328"></a><span id="l4.328"> </span>
<a href="#l4.329"></a><span id="l4.329">   // build the file name</span>
<a href="#l4.330"></a><span id="l4.330">   nsCString filePath(PR_GetEnv(&quot;HOME&quot;));</span>
<a href="#l4.331"></a><span id="l4.331">   filePath.Append('/');</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-  filePath.Append(NS_ConvertUTF16toUTF8(brandName));</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+  filePath.Append(brandName);</span>
<a href="#l4.334"></a><span id="l4.334">   filePath.AppendLiteral(&quot;_wallpaper.png&quot;);</span>
<a href="#l4.335"></a><span id="l4.335"> </span>
<a href="#l4.336"></a><span id="l4.336">   // get the image container</span>
<a href="#l4.337"></a><span id="l4.337">   nsCOMPtr&lt;nsIImageLoadingContent&gt; imageContent(do_QueryInterface(aElement, &amp;rv));</span>
<a href="#l4.338"></a><span id="l4.338">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.339"></a><span id="l4.339"> </span>
<a href="#l4.340"></a><span id="l4.340">   nsCOMPtr&lt;imgIRequest&gt; request;</span>
<a href="#l4.341"></a><span id="l4.341">   rv = imageContent-&gt;GetRequest(nsIImageLoadingContent::CURRENT_REQUEST,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/shell/src/nsGNOMEShellService.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/shell/src/nsGNOMEShellService.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -21,16 +21,18 @@ public:</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   NS_DECL_ISUPPORTS</span>
<a href="#l5.6"></a><span id="l5.6">   NS_DECL_NSISHELLSERVICE</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">   nsresult Init() NS_HIDDEN;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> private:</span>
<a href="#l5.11"></a><span id="l5.11">   ~nsGNOMEShellService() {}</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  bool HandlerMatchesAppName(const char* aHandler);</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14">   nsCString mAppPath;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  bool mAppIsInPath;</span>
<a href="#l5.16"></a><span id="l5.16">   bool mUseLocaleFilenames;</span>
<a href="#l5.17"></a><span id="l5.17">   bool mCheckedThisSessionClient;</span>
<a href="#l5.18"></a><span id="l5.18"> };</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> #endif // nsgnomeshellservice_h____</span>
<a href="#l5.21"></a><span id="l5.21"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

