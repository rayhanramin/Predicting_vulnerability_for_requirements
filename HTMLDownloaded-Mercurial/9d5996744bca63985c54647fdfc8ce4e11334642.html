<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10141:9d5996744bca63985c54647fdfc8ce4e11334642</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9d5996744bca63985c54647fdfc8ce4e11334642" />
<meta property="og:url" content="/comm-central/rev/9d5996744bca63985c54647fdfc8ce4e11334642" />
<meta property="og:description" content="IMAP: Migrate trySTARTTLS pref depending on actual server capa -- bug 744676, patch&amp;r=benb&amp;bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9d5996744bca63985c54647fdfc8ce4e11334642 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9d5996744bca63985c54647fdfc8ce4e11334642">shortlog</a> |
<a href="/comm-central/log/9d5996744bca63985c54647fdfc8ce4e11334642">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9d5996744bca63985c54647fdfc8ce4e11334642">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9d5996744bca63985c54647fdfc8ce4e11334642">files</a> |
changeset |
<a href="/comm-central/raw-rev/9d5996744bca63985c54647fdfc8ce4e11334642">raw</a>  | <a href="/comm-central/archive/9d5996744bca63985c54647fdfc8ce4e11334642.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
IMAP: Migrate trySTARTTLS pref depending on actual server capa -- <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744676">bug 744676</a>, patch&amp;r=benb&amp;bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 12 May 2012 01:04:37 +0200</td></tr>

<tr>
 <td>changeset 10141</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9d5996744bca63985c54647fdfc8ce4e11334642">9d5996744bca63985c54647fdfc8ce4e11334642</a></td>
</tr>



<tr>
<td>parent 10140</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a3307f98beb6537854bc682ad0fe5914d5d8fb22">a3307f98beb6537854bc682ad0fe5914d5d8fb22</a>
</td>
</tr>

<tr>
<td>child 10142</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5c06691e28179069f1e807f3d105d73cb8009ef8">5c06691e28179069f1e807f3d105d73cb8009ef8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9d5996744bca63985c54647fdfc8ce4e11334642">7712</a></td></tr>
<tr><td>push user</td><td>mozilla.BenB@bucksch.org</td></tr>
<tr><td>push date</td><td class="date age">Fri, 11 May 2012 23:20:13 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9d5996744bca [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9d5996744bca63985c54647fdfc8ce4e11334642">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9d5996744bca63985c54647fdfc8ce4e11334642&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9d5996744bca63985c54647fdfc8ce4e11334642&newProject=comm-central&newRevision=a3307f98beb6537854bc682ad0fe5914d5d8fb22&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9d5996744bca63985c54647fdfc8ce4e11334642&newProject=comm-central&newRevision=a3307f98beb6537854bc682ad0fe5914d5d8fb22&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9d5996744bca63985c54647fdfc8ce4e11334642&newProject=comm-central&newRevision=a3307f98beb6537854bc682ad0fe5914d5d8fb22&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744676">744676</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=558659">558659</a></td></tr>




</table></div>

<div class="page_body description">IMAP: Migrate trySTARTTLS pref depending on actual server capa -- <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744676">bug 744676</a>, patch&amp;r=benb&amp;bienvenu

The pref trySTARTTLS was deprecated long ago, but may still be in prefs,
and is also created by our Outlook setting importers.
It is known to be insecure, so we'll migrate it to either alwaysSTARTTLS or
plain socket (no SSL), depending on what the server actually supports.
This secures those users who can use STARTTLS for the future.

This was made necessary by the capability bitflag changes for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=558659">bug 558659</a> Part 1.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/public/nsIImapServerSink.idl">mailnews/imap/public/nsIImapServerSink.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/public/nsIImapServerSink.idl">file</a> |
<a href="/comm-central/annotate/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/public/nsIImapServerSink.idl">annotate</a> |
<a href="/comm-central/diff/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/public/nsIImapServerSink.idl">diff</a> |
<a href="/comm-central/comparison/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/public/nsIImapServerSink.idl">comparison</a> |
<a href="/comm-central/log/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/public/nsIImapServerSink.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsSyncRunnableHelpers.cpp">mailnews/imap/src/nsSyncRunnableHelpers.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsSyncRunnableHelpers.cpp">file</a> |
<a href="/comm-central/annotate/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsSyncRunnableHelpers.cpp">annotate</a> |
<a href="/comm-central/diff/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsSyncRunnableHelpers.cpp">diff</a> |
<a href="/comm-central/comparison/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsSyncRunnableHelpers.cpp">comparison</a> |
<a href="/comm-central/log/9d5996744bca63985c54647fdfc8ce4e11334642/mailnews/imap/src/nsSyncRunnableHelpers.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapServerSink.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapServerSink.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -43,17 +43,17 @@ interface nsIMsgMailNewsUrl;</span>
<a href="#l1.4"></a><span id="l1.4"> interface nsIImapProtocol;</span>
<a href="#l1.5"></a><span id="l1.5"> interface nsIImapUrl;</span>
<a href="#l1.6"></a><span id="l1.6"> interface nsIImapMockChannel;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> /**</span>
<a href="#l1.9"></a><span id="l1.9">  * nsIImapServerSink is designed to be used as a proxy to the application's UI</span>
<a href="#l1.10"></a><span id="l1.10">  * thread from the running IMAP threads.</span>
<a href="#l1.11"></a><span id="l1.11">  */</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(24136ca7-0000-4731-8d5f-fc0908aa7c75)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(33184087-eadc-4b5d-aad6-14cf6e6a43af)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIImapServerSink : nsISupports {</span>
<a href="#l1.15"></a><span id="l1.15">   /**</span>
<a href="#l1.16"></a><span id="l1.16">    * Check if the given folder path is a possible IMAP mailbox.</span>
<a href="#l1.17"></a><span id="l1.17">    * @param folderPath folder path to check</span>
<a href="#l1.18"></a><span id="l1.18">    * @param hierarchyDelimiter IMAP hierarchy delimiter in canonical format,</span>
<a href="#l1.19"></a><span id="l1.19">    *                           i.e., hierarchy delimiter has been replaced</span>
<a href="#l1.20"></a><span id="l1.20">    *                           with '/'</span>
<a href="#l1.21"></a><span id="l1.21">    * @param boxFlags IMAP folder flags (for subscription, namespaces etc.)</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -165,16 +165,23 @@ interface nsIImapServerSink : nsISupport</span>
<a href="#l1.23"></a><span id="l1.23">    */</span>
<a href="#l1.24"></a><span id="l1.24">   void asyncGetPassword(in nsIImapProtocol aProtocol,</span>
<a href="#l1.25"></a><span id="l1.25">                         in boolean aNewPasswordRequested,</span>
<a href="#l1.26"></a><span id="l1.26">                         out ACString aPassword);</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">   attribute boolean userAuthenticated;</span>
<a href="#l1.29"></a><span id="l1.29">   void setMailServerUrls(in ACString manageMailAccount, in ACString manageLists, in ACString manageFilters);</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  /** Used by the imap thread when upgrading from the socketType</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+   * trySTARTTLS.</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+   * @param aSucceeded whether STARTTLS succeeded. If it did, the server</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+   * will set the socket type to alwaysSTARTTLS, otherwise plain.</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+   */</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  void UpdateTrySTARTTLSPref(in boolean aSucceeded);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+</span>
<a href="#l1.38"></a><span id="l1.38">   readonly attribute ACString arbitraryHeaders;</span>
<a href="#l1.39"></a><span id="l1.39">   void forgetPassword();</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41">   readonly attribute boolean showAttachmentsInline;</span>
<a href="#l1.42"></a><span id="l1.42">   string cramMD5Hash(in string decodedChallenge, in string key);</span>
<a href="#l1.43"></a><span id="l1.43">   /// String to send to the imap server as the login user name.</span>
<a href="#l1.44"></a><span id="l1.44">   readonly attribute ACString loginUsername;</span>
<a href="#l1.45"></a><span id="l1.45"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -435,16 +435,24 @@ nsImapIncomingServer::SetIsAOLServer(boo</span>
<a href="#l2.4"></a><span id="l2.4">   if (aBool)</span>
<a href="#l2.5"></a><span id="l2.5">     m_capability |= kAOLImapCapability;</span>
<a href="#l2.6"></a><span id="l2.6">   else</span>
<a href="#l2.7"></a><span id="l2.7">     m_capability &amp;= ~kAOLImapCapability;</span>
<a href="#l2.8"></a><span id="l2.8">   return NS_OK;</span>
<a href="#l2.9"></a><span id="l2.9"> }</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> NS_IMETHODIMP</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+nsImapIncomingServer::UpdateTrySTARTTLSPref(bool aStartTLSSucceeded)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  SetSocketType(aStartTLSSucceeded ? nsMsgSocketType::alwaysSTARTTLS :</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+                                     nsMsgSocketType::plain);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+}</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l2.20"></a><span id="l2.20"> nsImapIncomingServer::GetImapConnectionAndLoadUrl(nsIImapUrl* aImapUrl,</span>
<a href="#l2.21"></a><span id="l2.21">                                                   nsISupports* aConsumer)</span>
<a href="#l2.22"></a><span id="l2.22"> {</span>
<a href="#l2.23"></a><span id="l2.23">   nsCOMPtr&lt;nsIImapProtocol&gt; aProtocol;</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   nsresult rv = GetImapConnection(aImapUrl, getter_AddRefs(aProtocol));</span>
<a href="#l2.26"></a><span id="l2.26">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.27"></a><span id="l2.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -807,16 +807,20 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l3.4"></a><span id="l3.4">         Log(&quot;SetupWithUrl&quot;, nsnull, &quot;clearing IMAP_CONNECTION_IS_OPEN&quot;);</span>
<a href="#l3.5"></a><span id="l3.5">         ClearFlag(IMAP_CONNECTION_IS_OPEN);</span>
<a href="#l3.6"></a><span id="l3.6">         const char *connectionType = nsnull;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">         if (m_socketType == nsMsgSocketType::SSL)</span>
<a href="#l3.9"></a><span id="l3.9">           connectionType = &quot;ssl&quot;;</span>
<a href="#l3.10"></a><span id="l3.10">         else if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l3.11"></a><span id="l3.11">           connectionType = &quot;starttls&quot;;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+        // This can go away once we think everyone is migrated</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        // away from the trySTARTTLS socket type.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+        else if (m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+          connectionType =  &quot;starttls&quot;;</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">         nsCOMPtr&lt;nsIProxyInfo&gt; proxyInfo;</span>
<a href="#l3.18"></a><span id="l3.18">         rv = MsgExamineForProxy(&quot;imap&quot;, m_realHostName.get(), port, getter_AddRefs(proxyInfo));</span>
<a href="#l3.19"></a><span id="l3.19">         if (NS_FAILED(rv))</span>
<a href="#l3.20"></a><span id="l3.20">           proxyInfo = nsnull;</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">         const nsACString *socketHost;</span>
<a href="#l3.23"></a><span id="l3.23">         PRUint16 socketPort;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -1648,24 +1652,18 @@ bool nsImapProtocol::ProcessCurrentURL()</span>
<a href="#l3.25"></a><span id="l3.25">             {</span>
<a href="#l3.26"></a><span id="l3.26">               nsCOMPtr&lt;nsISSLSocketControl&gt; sslControl = do_QueryInterface(secInfo, &amp;rv);</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">               if (NS_SUCCEEDED(rv) &amp;&amp; sslControl)</span>
<a href="#l3.29"></a><span id="l3.29">               {</span>
<a href="#l3.30"></a><span id="l3.30">                 rv = sslControl-&gt;StartTLS();</span>
<a href="#l3.31"></a><span id="l3.31">                 if (NS_SUCCEEDED(rv))</span>
<a href="#l3.32"></a><span id="l3.32">                 {</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-                  // Upgrade &quot;trySTARTTLS&quot; accounts to &quot;alwaysSTARTTLS&quot; in prefs</span>
<a href="#l3.34"></a><span id="l3.34">                   if (m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-                  {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-                    nsCOMPtr&lt;nsIMsgIncomingServer&gt; imapServer =</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-                        do_QueryReferent(m_server);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-                    imapServer-&gt;SetSocketType(nsMsgSocketType::alwaysSTARTTLS);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-                  }</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                    m_imapServerSink-&gt;UpdateTrySTARTTLSPref(true);</span>
<a href="#l3.42"></a><span id="l3.42">                   // force re-issue of &quot;capability&quot;, because servers may</span>
<a href="#l3.43"></a><span id="l3.43">                   // enable other auth features (e.g. remove LOGINDISABLED</span>
<a href="#l3.44"></a><span id="l3.44">                   // and add AUTH=PLAIN) after we upgraded to SSL.</span>
<a href="#l3.45"></a><span id="l3.45">                   Capability();</span>
<a href="#l3.46"></a><span id="l3.46">                   eIMAPCapabilityFlags capabilityFlag = GetServerStateParser().GetCapabilityFlag();</span>
<a href="#l3.47"></a><span id="l3.47">                   // Courier imap doesn't return STARTTLS capability if we've done</span>
<a href="#l3.48"></a><span id="l3.48">                   // a STARTTLS! But we need to remember this capability so we'll</span>
<a href="#l3.49"></a><span id="l3.49">                   // try to use STARTTLS next time.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineat">@@ -1683,35 +1681,50 @@ bool nsImapProtocol::ProcessCurrentURL()</span>
<a href="#l3.51"></a><span id="l3.51">               nsCAutoString logLine(&quot;STARTTLS negotiation failed. Error 0x&quot;);</span>
<a href="#l3.52"></a><span id="l3.52">               logLine.AppendInt(rv, 16);</span>
<a href="#l3.53"></a><span id="l3.53">               Log(&quot;ProcessCurrentURL&quot;, nsnull, logLine.get());</span>
<a href="#l3.54"></a><span id="l3.54">               if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l3.55"></a><span id="l3.55">               {</span>
<a href="#l3.56"></a><span id="l3.56">                 SetConnectionStatus(rv);        // stop netlib</span>
<a href="#l3.57"></a><span id="l3.57">                 m_transport-&gt;Close(rv);</span>
<a href="#l3.58"></a><span id="l3.58">               }</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+              else if (m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+                m_imapServerSink-&gt;UpdateTrySTARTTLSPref(false);</span>
<a href="#l3.61"></a><span id="l3.61">             }</span>
<a href="#l3.62"></a><span id="l3.62">           }</span>
<a href="#l3.63"></a><span id="l3.63">           else if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l3.64"></a><span id="l3.64">           {</span>
<a href="#l3.65"></a><span id="l3.65">             SetConnectionStatus(NS_ERROR_FAILURE);        // stop netlib</span>
<a href="#l3.66"></a><span id="l3.66">             if (m_transport)</span>
<a href="#l3.67"></a><span id="l3.67">               m_transport-&gt;Close(rv);</span>
<a href="#l3.68"></a><span id="l3.68">           }</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+          else if (m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+          {</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+            // STARTTLS failed, so downgrade socket type</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+            m_imapServerSink-&gt;UpdateTrySTARTTLSPref(false);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+          }</span>
<a href="#l3.74"></a><span id="l3.74">         }</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-        // in this case, we didn't know the server supported TLS when</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-        // we created the socket, so we're going to retry with</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-        // STARTTLS.</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-        else if (m_socketType == nsMsgSocketType::trySTARTTLS</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-            &amp;&amp; (GetServerStateParser().GetCapabilityFlag() &amp; kHasStartTLSCapability))</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+        else if (m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l3.81"></a><span id="l3.81">         {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-          ClearFlag(IMAP_CONNECTION_IS_OPEN);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-          TellThreadToDie();</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-          SetConnectionStatus(NS_ERROR_FAILURE);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-          return RetryUrl();</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+          // we didn't know the server supported TLS when we created</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+          // the socket, so we're going to retry with a STARTTLS socket</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+          if (GetServerStateParser().GetCapabilityFlag() &amp; kHasStartTLSCapability)</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+          {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+            ClearFlag(IMAP_CONNECTION_IS_OPEN);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+            TellThreadToDie();</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+            SetConnectionStatus(NS_ERROR_FAILURE);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+            return RetryUrl();</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+          }</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+          else</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+          {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+            // trySTARTTLS set, but server doesn't have TLS capability,</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+            // so downgrade socket type</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+            m_imapServerSink-&gt;UpdateTrySTARTTLSPref(false);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+            m_socketType = nsMsgSocketType::plain;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+          }</span>
<a href="#l3.102"></a><span id="l3.102">         }</span>
<a href="#l3.103"></a><span id="l3.103">         logonFailed = !TryToLogon();</span>
<a href="#l3.104"></a><span id="l3.104">         if (m_retryUrlOnError)</span>
<a href="#l3.105"></a><span id="l3.105">           return RetryUrl();</span>
<a href="#l3.106"></a><span id="l3.106">       }</span>
<a href="#l3.107"></a><span id="l3.107">   } // if death signal not received</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109">   if (!DeathSignalReceived() &amp;&amp; (NS_SUCCEEDED(GetConnectionStatus())))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/src/nsSyncRunnableHelpers.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/src/nsSyncRunnableHelpers.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -474,8 +474,9 @@ NS_SYNCRUNNABLEMETHOD0(ImapServerSink, C</span>
<a href="#l4.4"></a><span id="l4.4"> NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AsyncGetPassword, nsIImapProtocol *, bool, nsACString &amp;)</span>
<a href="#l4.5"></a><span id="l4.5"> NS_SYNCRUNNABLEATTRIBUTE(ImapServerSink, UserAuthenticated, bool)</span>
<a href="#l4.6"></a><span id="l4.6"> NS_SYNCRUNNABLEMETHOD3(ImapServerSink, SetMailServerUrls, const nsACString &amp;, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l4.7"></a><span id="l4.7"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetArbitraryHeaders, nsACString &amp;)</span>
<a href="#l4.8"></a><span id="l4.8"> NS_SYNCRUNNABLEMETHOD0(ImapServerSink, ForgetPassword)</span>
<a href="#l4.9"></a><span id="l4.9"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetShowAttachmentsInline, bool *)</span>
<a href="#l4.10"></a><span id="l4.10"> NS_SYNCRUNNABLEMETHOD3(ImapServerSink, CramMD5Hash, const char *, const char *, char **)</span>
<a href="#l4.11"></a><span id="l4.11"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetLoginUsername, nsACString &amp;)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, UpdateTrySTARTTLSPref, bool)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

