<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9928:69177e1f55f4d86d903d2301499f45716f71409e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 69177e1f55f4d86d903d2301499f45716f71409e" />
<meta property="og:url" content="/comm-central/rev/69177e1f55f4d86d903d2301499f45716f71409e" />
<meta property="og:description" content="account creation guessConfig: Make SSL cert temporary and remove them, too -- bug 721369, r=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 69177e1f55f4d86d903d2301499f45716f71409e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/69177e1f55f4d86d903d2301499f45716f71409e">shortlog</a> |
<a href="/comm-central/log/69177e1f55f4d86d903d2301499f45716f71409e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/69177e1f55f4d86d903d2301499f45716f71409e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/69177e1f55f4d86d903d2301499f45716f71409e">files</a> |
changeset |
<a href="/comm-central/raw-rev/69177e1f55f4d86d903d2301499f45716f71409e">raw</a>  | <a href="/comm-central/archive/69177e1f55f4d86d903d2301499f45716f71409e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
account creation guessConfig: Make SSL cert temporary and remove them, too -- <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721369">bug 721369</a>, r=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 17 Apr 2012 18:30:43 +0200</td></tr>

<tr>
 <td>changeset 9928</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/69177e1f55f4d86d903d2301499f45716f71409e">69177e1f55f4d86d903d2301499f45716f71409e</a></td>
</tr>



<tr>
<td>parent 9927</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0cf9322009b86c910bd08f180e83aa463d5fb342">0cf9322009b86c910bd08f180e83aa463d5fb342</a>
</td>
</tr>

<tr>
<td>child 9929</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bca6a0a0abb1b6525010211a8325857ed18d7095">bca6a0a0abb1b6525010211a8325857ed18d7095</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=69177e1f55f4d86d903d2301499f45716f71409e">7557</a></td></tr>
<tr><td>push user</td><td>mozilla.BenB@bucksch.org</td></tr>
<tr><td>push date</td><td class="date age">Tue, 17 Apr 2012 16:32:02 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@69177e1f55f4 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=69177e1f55f4d86d903d2301499f45716f71409e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=69177e1f55f4d86d903d2301499f45716f71409e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=69177e1f55f4d86d903d2301499f45716f71409e&newProject=comm-central&newRevision=69177e1f55f4d86d903d2301499f45716f71409e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=69177e1f55f4d86d903d2301499f45716f71409e&newProject=comm-central&newRevision=69177e1f55f4d86d903d2301499f45716f71409e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=69177e1f55f4d86d903d2301499f45716f71409e&newProject=comm-central&newRevision=69177e1f55f4d86d903d2301499f45716f71409e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721369">721369</a></td></tr>




</table></div>

<div class="page_body description">account creation guessConfig: Make SSL cert temporary and remove them, too -- <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721369">bug 721369</a>, r=bienvenu

When we were probing hostnames, and encountered SSL cert errors,
we let the current connection pass and also added a cert override,
without user confirmation. The idea was to try the host again later
with a lower priority and try other hosts first.

But that means the user wouldn't get any warning anymore at later stages,
particularly during the password check in verifyConfig,
so we didn't warn about man-in-the-middle attacks anymore,
which means we removed all SSL protections. Great.
To add to it, the overrides were explicitly marked permanent, not temporary.
And the removal of the override didn't happen in all situations.

So, now we mark the overrides as temporary. The patch also fixes the
flags so that we should now remove all overrides (as long as we're not
being aborted or similar).</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/69177e1f55f4d86d903d2301499f45716f71409e/mailnews/base/prefs/content/accountcreation/guessConfig.js">mailnews/base/prefs/content/accountcreation/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/69177e1f55f4d86d903d2301499f45716f71409e/mailnews/base/prefs/content/accountcreation/guessConfig.js">file</a> |
<a href="/comm-central/annotate/69177e1f55f4d86d903d2301499f45716f71409e/mailnews/base/prefs/content/accountcreation/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/69177e1f55f4d86d903d2301499f45716f71409e/mailnews/base/prefs/content/accountcreation/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/69177e1f55f4d86d903d2301499f45716f71409e/mailnews/base/prefs/content/accountcreation/guessConfig.js">comparison</a> |
<a href="/comm-central/log/69177e1f55f4d86d903d2301499f45716f71409e/mailnews/base/prefs/content/accountcreation/guessConfig.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -514,16 +514,23 @@ HostDetector.prototype =</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   /**</span>
<a href="#l1.6"></a><span id="l1.6">    * @param thisTry {HostTry}</span>
<a href="#l1.7"></a><span id="l1.7">    * @param wiredata {Array of {String}} what the server returned</span>
<a href="#l1.8"></a><span id="l1.8">    *     in response to our protocol chat</span>
<a href="#l1.9"></a><span id="l1.9">    */</span>
<a href="#l1.10"></a><span id="l1.10">   _processResult : function(thisTry, wiredata)</span>
<a href="#l1.11"></a><span id="l1.11">   {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    if (thisTry._gotCertError)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+      this._log.info(&quot;clearing validity override for &quot; + thisTry.hostname);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+      Cc[&quot;@mozilla.org/security/certoverride;1&quot;]</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+        .getService(Ci.nsICertOverrideService)</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+        .clearValidityOverride(thisTry.hostname, thisTry.port);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    }</span>
<a href="#l1.19"></a><span id="l1.19">     if (thisTry._gotCertError == Ci.nsICertOverrideService.ERROR_MISMATCH)</span>
<a href="#l1.20"></a><span id="l1.20">     {</span>
<a href="#l1.21"></a><span id="l1.21">       thisTry._gotCertError = false;</span>
<a href="#l1.22"></a><span id="l1.22">       thisTry.status = kFailed;</span>
<a href="#l1.23"></a><span id="l1.23">       return;</span>
<a href="#l1.24"></a><span id="l1.24">     }</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">     if (thisTry._gotCertError == Ci.nsICertOverrideService.ERROR_UNTRUSTED ||</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineat">@@ -547,25 +554,16 @@ HostDetector.prototype =</span>
<a href="#l1.28"></a><span id="l1.28">     thisTry.authMethods =</span>
<a href="#l1.29"></a><span id="l1.29">         this._advertisesAuthMethods(thisTry.protocol, wiredata);</span>
<a href="#l1.30"></a><span id="l1.30">     if (thisTry.ssl == TLS &amp;&amp; !this._hasTLS(thisTry, wiredata))</span>
<a href="#l1.31"></a><span id="l1.31">     {</span>
<a href="#l1.32"></a><span id="l1.32">       this._log.info(&quot;STARTTLS wanted, but not offered&quot;);</span>
<a href="#l1.33"></a><span id="l1.33">       thisTry.status = kFailed;</span>
<a href="#l1.34"></a><span id="l1.34">       return;</span>
<a href="#l1.35"></a><span id="l1.35">     }</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    if (thisTry.selfSignedCert)</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-      // the callback will put up the cert exception dialog, so</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-      // clear the override here.</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-      this._log.info(&quot;clearing validity override for &quot; + thisTry.hostname);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-      Cc[&quot;@mozilla.org/security/certoverride;1&quot;]</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-        .getService(Ci.nsICertOverrideService)</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-        .clearValidityOverride(thisTry.hostname, thisTry.port);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-    }</span>
<a href="#l1.45"></a><span id="l1.45">     this._log.info(&quot;success with &quot; + thisTry.hostname + &quot;:&quot; +</span>
<a href="#l1.46"></a><span id="l1.46">         thisTry.port + &quot; &quot; + protocolToString(thisTry.protocol) +</span>
<a href="#l1.47"></a><span id="l1.47">         &quot; ssl &quot; + thisTry.ssl +</span>
<a href="#l1.48"></a><span id="l1.48">         (thisTry.selfSignedCert ? &quot; (selfSignedCert)&quot; : &quot;&quot;));</span>
<a href="#l1.49"></a><span id="l1.49">     thisTry.status = kSuccess;</span>
<a href="#l1.50"></a><span id="l1.50">   },</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   _checkFinished : function()</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineat">@@ -800,25 +798,25 @@ function getIncomingTryOrder(host, proto</span>
<a href="#l1.54"></a><span id="l1.54">       (!lowerCaseHost.indexOf(&quot;pop.&quot;) || !lowerCaseHost.indexOf(&quot;pop3.&quot;)))</span>
<a href="#l1.55"></a><span id="l1.55">     protocol = POP;</span>
<a href="#l1.56"></a><span id="l1.56">   else if (protocol == UNKNOWN &amp;&amp; !lowerCaseHost.indexOf(&quot;imap.&quot;))</span>
<a href="#l1.57"></a><span id="l1.57">     protocol = IMAP;</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">   if (protocol != UNKNOWN) {</span>
<a href="#l1.60"></a><span id="l1.60">     if (ssl == UNKNOWN)</span>
<a href="#l1.61"></a><span id="l1.61">       return [getHostEntry(protocol, TLS, port),</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-              getHostEntry(protocol, SSL, port),</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+              //getHostEntry(protocol, SSL, port),</span>
<a href="#l1.64"></a><span id="l1.64">               getHostEntry(protocol, NONE, port)];</span>
<a href="#l1.65"></a><span id="l1.65">     return [getHostEntry(protocol, ssl, port)];</span>
<a href="#l1.66"></a><span id="l1.66">   }</span>
<a href="#l1.67"></a><span id="l1.67">   if (ssl == UNKNOWN)</span>
<a href="#l1.68"></a><span id="l1.68">     return [getHostEntry(IMAP, TLS, port),</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-            getHostEntry(IMAP, SSL, port),</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+            //getHostEntry(IMAP, SSL, port),</span>
<a href="#l1.71"></a><span id="l1.71">             getHostEntry(POP, TLS, port),</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-            getHostEntry(POP, SSL, port),</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+            //getHostEntry(POP, SSL, port),</span>
<a href="#l1.74"></a><span id="l1.74">             getHostEntry(IMAP, NONE, port),</span>
<a href="#l1.75"></a><span id="l1.75">             getHostEntry(POP, NONE, port)];</span>
<a href="#l1.76"></a><span id="l1.76">   return [getHostEntry(IMAP, ssl, port),</span>
<a href="#l1.77"></a><span id="l1.77">           getHostEntry(POP, ssl, port)];</span>
<a href="#l1.78"></a><span id="l1.78"> };</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80"> /**</span>
<a href="#l1.81"></a><span id="l1.81">  * @returns {Array of {HostTry}}</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineat">@@ -827,22 +825,22 @@ function getOutgoingTryOrder(host, proto</span>
<a href="#l1.83"></a><span id="l1.83"> {</span>
<a href="#l1.84"></a><span id="l1.84">   assert(protocol == SMTP, &quot;need SMTP as protocol for outgoing&quot;);</span>
<a href="#l1.85"></a><span id="l1.85">   if (ssl == UNKNOWN)</span>
<a href="#l1.86"></a><span id="l1.86">   {</span>
<a href="#l1.87"></a><span id="l1.87">     if (port == UNKNOWN)</span>
<a href="#l1.88"></a><span id="l1.88">       // neither SSL nor port known</span>
<a href="#l1.89"></a><span id="l1.89">       return [getHostEntry(SMTP, TLS, UNKNOWN),</span>
<a href="#l1.90"></a><span id="l1.90">               getHostEntry(SMTP, TLS, 25),</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-              getHostEntry(SMTP, SSL, UNKNOWN),</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+              //getHostEntry(SMTP, SSL, UNKNOWN),</span>
<a href="#l1.93"></a><span id="l1.93">               getHostEntry(SMTP, NONE, UNKNOWN),</span>
<a href="#l1.94"></a><span id="l1.94">               getHostEntry(SMTP, NONE, 25)];</span>
<a href="#l1.95"></a><span id="l1.95">     // port known, SSL not</span>
<a href="#l1.96"></a><span id="l1.96">     return [getHostEntry(SMTP, TLS, port),</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-            getHostEntry(SMTP, SSL, port),</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+            //getHostEntry(SMTP, SSL, port),</span>
<a href="#l1.99"></a><span id="l1.99">             getHostEntry(SMTP, NONE, port)];</span>
<a href="#l1.100"></a><span id="l1.100">   }</span>
<a href="#l1.101"></a><span id="l1.101">   // SSL known, port not</span>
<a href="#l1.102"></a><span id="l1.102">   if (port == UNKNOWN)</span>
<a href="#l1.103"></a><span id="l1.103">   {</span>
<a href="#l1.104"></a><span id="l1.104">     if (ssl == SSL)</span>
<a href="#l1.105"></a><span id="l1.105">       return [getHostEntry(SMTP, SSL, UNKNOWN)];</span>
<a href="#l1.106"></a><span id="l1.106">     else // TLS or NONE</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineat">@@ -954,65 +952,75 @@ SSLErrorHandler.prototype =</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">     let cert = status.QueryInterface(Ci.nsISSLStatus).serverCert;</span>
<a href="#l1.110"></a><span id="l1.110">     let flags = 0;</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112">     let parts = targetSite.split(&quot;:&quot;);</span>
<a href="#l1.113"></a><span id="l1.113">     let host = parts[0];</span>
<a href="#l1.114"></a><span id="l1.114">     let port = parts[1];</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    /* The following 2 cert problems are unfortunately common:</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+     * 1) hostname mismatch:</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+     * user is custeromer at a domain hoster, he owns yourname.org,</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+     * and the IMAP server is imap.hoster.com (but also reachable as</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+     * imap.yourname.org), and has a cert for imap.hoster.com.</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+     * 2) self-signed:</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+     * a company has an internal IMAP server, and it's only for</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+     * 30 employees, and they didn't want to buy a cert, so</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+     * they use a self-signed cert.</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+     *</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+     * We would like the above to pass, somehow, with user confirmation.</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+     * The following case should *not* pass:</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+     *</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+     * 1) MITM</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+     * User has @gmail.com, and an attacker is between the user and</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+     * the Internet and runs a man-in-the-middle (MITM) attack.</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+     * Attacker controls DNS and sends imap.gmail.com to his own</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+     * imap.attacker.com. He has either a valid, CA-issued</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+     * cert for imap.attacker.com, or a self-signed cert.</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+     * Of course, attacker.com could also be legit-sounding gmailservers.com.</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+     *</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+     * What makes it dangerous is that we (!) propose the server to the user,</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+     * and he cannot judge whether imap.gmailservers.com is correct or not,</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+     * and he will likely approve it.</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+     */</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+</span>
<a href="#l1.142"></a><span id="l1.142">     if (status.isDomainMismatch) {</span>
<a href="#l1.143"></a><span id="l1.143">       this._try._gotCertError = Ci.nsICertOverrideService.ERROR_MISMATCH;</span>
<a href="#l1.144"></a><span id="l1.144">       flags |= Ci.nsICertOverrideService.ERROR_MISMATCH;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-      // If it was just a domain mismatch error</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-      // TODO &quot;just&quot;??? disabling it for now</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-      if (false &amp;&amp; !(status.isUntrusted || status.isNotValidAtThisTime)) {</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-        // then, if we didn't get a wildcard in the certificate,</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-        if (cert.commonName.charAt(0) != &quot;*&quot;) {</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-          // then add this host to the hosts to try, and skip to the end.</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-          /* TODO This is logically broken, I think</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-           * The hostname is in the cert, because the cert is only valid for</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-           * this host. Anybody can get a cert (even from a CA) for</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-           * imap.badsite.com . If you MITM me (which is what SSL certs try</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-           * to prevent), we'll get imap.badsite.com here. Now, if we treat</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-           * this as &quot;cool, let's see whether imap.badsite.com also works!&quot;,</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-           * the SSL cert was kind of pointless, no?</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-           * Sure, we can let the user confirm it first (not sure whether we</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-           * do that!), but that may be too risky, because users are likely</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-           * to just accept. See phishing. */</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-          if (this._hostsToTry.indexOf(cert.commonName) == -1) </span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-            this._hostsToTry.push(cert.commonName);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-          this._tryIndex = this.tryOrder.length - 1;</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-        }</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-        return true;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-      }</span>
<a href="#l1.168"></a><span id="l1.168">     }</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-    if (status.isUntrusted) {</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+    else if (status.isUntrusted) {</span>
<a href="#l1.172"></a><span id="l1.172">       this._try._gotCertError = Ci.nsICertOverrideService.ERROR_UNTRUSTED;</span>
<a href="#l1.173"></a><span id="l1.173">       flags |= Ci.nsICertOverrideService.ERROR_UNTRUSTED;</span>
<a href="#l1.174"></a><span id="l1.174">     }</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-    if (status.isNotValidAtThisTime) {</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+    else if (status.isNotValidAtThisTime) {</span>
<a href="#l1.177"></a><span id="l1.177">       this._try._gotCertError = Ci.nsICertOverrideService.ERROR_TIME;</span>
<a href="#l1.178"></a><span id="l1.178">       flags |= Ci.nsICertOverrideService.ERROR_TIME;</span>
<a href="#l1.179"></a><span id="l1.179">     }</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+    else {</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+      this._try._gotCertError = -1; // other</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+    }</span>
<a href="#l1.183"></a><span id="l1.183"> </span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-    // If domain mismatch, then we shouldn't accept, and instead try the domain</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-    // in the cert to the list of tries.</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-    // Not skipping mismatches for now because it's too common, and until we can</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-    // poke around the cert and find out what domain to try, best to live</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-    // w/ orange than red.</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+    /* We will add a temporary cert exception here, so that</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+     * we can continue and connect and try.</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+     * But we will remove it again as soon as we close the</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+     * connection, in _processResult().</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+     * _gotCertError will serve as the marker that we</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+     * have to clear the override later.</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+     *</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+     * In verifyConfig(), before we send the password, we *must*</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+     * get another cert exception, this time with dialog to the user</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+     * so that he gets informed about this and can make a choice.</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+     */</span>
<a href="#l1.200"></a><span id="l1.200"> </span>
<a href="#l1.201"></a><span id="l1.201">     this._try.targetSite = targetSite;</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-    this._try._certOverrideProcessed = false;</span>
<a href="#l1.203"></a><span id="l1.203">     Cc[&quot;@mozilla.org/security/certoverride;1&quot;]</span>
<a href="#l1.204"></a><span id="l1.204">       .getService(Ci.nsICertOverrideService)</span>
<a href="#l1.205"></a><span id="l1.205">       .rememberValidityOverride(host, port, cert, flags,</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-        false); // last bit is temporary -- should it be true? XXX</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+        true); // temporary override</span>
<a href="#l1.208"></a><span id="l1.208">     this._log.warn(&quot;!! Overrode bad cert temporarily &quot; + host + &quot; &quot; + port +</span>
<a href="#l1.209"></a><span id="l1.209">                    &quot;flags = &quot; + flags + &quot;\n&quot;);</span>
<a href="#l1.210"></a><span id="l1.210">     return true;</span>
<a href="#l1.211"></a><span id="l1.211">   },</span>
<a href="#l1.212"></a><span id="l1.212"> </span>
<a href="#l1.213"></a><span id="l1.213">   processSSLError : function(socketInfo, status, targetSite)</span>
<a href="#l1.214"></a><span id="l1.214">   {</span>
<a href="#l1.215"></a><span id="l1.215">     this._log.error(&quot;got SSL error, please implement the handler!&quot;);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

