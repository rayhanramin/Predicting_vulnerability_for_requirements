<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10292:02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c" />
<meta property="og:url" content="/comm-central/rev/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c" />
<meta property="og:description" content="Bug 745081 - Allow access to individual filter properties to support customizable item filters. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c">shortlog</a> |
<a href="/comm-central/log/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c">files</a> |
changeset |
<a href="/comm-central/raw-rev/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c">raw</a>  | <a href="/comm-central/archive/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=745081">Bug 745081</a> - Allow access to individual filter properties to support customizable item filters. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#116;&#116;&#104;&#101;&#119;&#32;&#77;&#101;&#99;&#99;&#97;&#32;&#60;&#109;&#97;&#116;&#116;&#104;&#101;&#119;&#46;&#109;&#101;&#99;&#99;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 28 May 2012 00:13:00 -0400</td></tr>

<tr>
 <td>changeset 10292</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c">02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c</a></td>
</tr>



<tr>
<td>parent 10291</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a87aff0360cc543b11f4d65b89662e49bde3ea90">a87aff0360cc543b11f4d65b89662e49bde3ea90</a>
</td>
</tr>

<tr>
<td>child 10293</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3301cdb8b397d34ef7a2c0e12f6828c46bacacb3">3301cdb8b397d34ef7a2c0e12f6828c46bacacb3</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c">7795</a></td></tr>
<tr><td>push user</td><td>matthew.mecca@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 28 May 2012 04:18:54 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@02bb6cc0fe6e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c&newProject=comm-central&newRevision=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c&newProject=comm-central&newRevision=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c&newProject=comm-central&newRevision=02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=745081">745081</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=745081">Bug 745081</a> - Allow access to individual filter properties to support customizable item filters. r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder-todo.js">calendar/base/content/calendar-unifinder-todo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder-todo.js">file</a> |
<a href="/comm-central/annotate/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder-todo.js">annotate</a> |
<a href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder-todo.js">diff</a> |
<a href="/comm-central/comparison/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder-todo.js">comparison</a> |
<a href="/comm-central/log/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder-todo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.xul">calendar/base/content/calendar-unifinder.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.xul">file</a> |
<a href="/comm-central/annotate/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.xul">annotate</a> |
<a href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.xul">diff</a> |
<a href="/comm-central/comparison/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.xul">comparison</a> |
<a href="/comm-central/log/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/content/calendar-unifinder.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/src/calFilter.js">calendar/base/src/calFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/src/calFilter.js">file</a> |
<a href="/comm-central/annotate/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/src/calFilter.js">annotate</a> |
<a href="/comm-central/diff/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/src/calFilter.js">diff</a> |
<a href="/comm-central/comparison/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/src/calFilter.js">comparison</a> |
<a href="/comm-central/log/02bb6cc0fe6e1e7cc5c4329de8dc543e8a94835c/calendar/base/src/calFilter.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -436,16 +436,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">           modifyItems: function tTV_modifyItems(aNewItems, aOldItems, aDontSort, aSelectNew) {</span>
<a href="#l1.5"></a><span id="l1.5">               let selItem = this.binding.currentTask;</span>
<a href="#l1.6"></a><span id="l1.6">               let selIndex = this.tree.currentIndex;</span>
<a href="#l1.7"></a><span id="l1.7">               let firstHash = null;</span>
<a href="#l1.8"></a><span id="l1.8">               let remIndexes = [];</span>
<a href="#l1.9"></a><span id="l1.9">               let itemsToAdd = [];</span>
<a href="#l1.10"></a><span id="l1.10">               aNewItems = aNewItems || [];</span>
<a href="#l1.11"></a><span id="l1.11">               aOldItems = aOldItems || [];</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+              let _this = this;</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14">               this.treebox.beginUpdateBatch();</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">               let idiff = new itemDiff();</span>
<a href="#l1.17"></a><span id="l1.17">               idiff.load(aOldItems);</span>
<a href="#l1.18"></a><span id="l1.18">               idiff.difference(aNewItems);</span>
<a href="#l1.19"></a><span id="l1.19">               idiff.complete();</span>
<a href="#l1.20"></a><span id="l1.20">               let delItems = idiff.deletedItems;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -457,41 +458,35 @@</span>
<a href="#l1.22"></a><span id="l1.22">                   if (item.hashId in this.binding.mHash2Index) {</span>
<a href="#l1.23"></a><span id="l1.23">                       // the old item needs to be removed</span>
<a href="#l1.24"></a><span id="l1.24">                       remIndexes.push(this.binding.mHash2Index[item.hashId]);</span>
<a href="#l1.25"></a><span id="l1.25">                       delete this.binding.mHash2Index[item.hashId];</span>
<a href="#l1.26"></a><span id="l1.26">                   }</span>
<a href="#l1.27"></a><span id="l1.27">               }, this);</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">               // modified items may need to be added, update, or removed</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-              modItems.mArray.forEach(function(item) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-                  let inFilter = this.binding.mFilter.isItemInFilters(item) &amp;&amp; </span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-                                 !(item.isCompleted &amp;&amp; !this.binding.showCompleted);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-                  if (item.hashId in this.binding.mHash2Index) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+              this.binding.mFilter.filterItems(modItems.mArray, function(item, inFilter) {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+                  if (item.hashId in _this.binding.mHash2Index) {</span>
<a href="#l1.37"></a><span id="l1.37">                       if (inFilter) {</span>
<a href="#l1.38"></a><span id="l1.38">                           // make sure we're using the new version of a modified item</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-                          this.binding.mTaskArray[this.binding.mHash2Index[item.hashId]] = item;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                          _this.binding.mTaskArray[_this.binding.mHash2Index[item.hashId]] = item;</span>
<a href="#l1.41"></a><span id="l1.41">                       } else {</span>
<a href="#l1.42"></a><span id="l1.42">                           // the modified item needs to be removed, it no longer matches the</span>
<a href="#l1.43"></a><span id="l1.43">                           // applied filter.</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-                          remIndexes.push(this.binding.mHash2Index[item.hashId]);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-                          delete this.binding.mHash2Index[item.hashId];</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+                          remIndexes.push(_this.binding.mHash2Index[item.hashId]);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                          delete _this.binding.mHash2Index[item.hashId];</span>
<a href="#l1.48"></a><span id="l1.48">                       }</span>
<a href="#l1.49"></a><span id="l1.49">                   } else if (inFilter) {</span>
<a href="#l1.50"></a><span id="l1.50">                       // the modified item needs to be added, it now matches the applied filter.</span>
<a href="#l1.51"></a><span id="l1.51">                       itemsToAdd.push(item);</span>
<a href="#l1.52"></a><span id="l1.52">                   }</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-              }, this);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+              });</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56">               // find new items that need to be added</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-              itemsToAdd = itemsToAdd.concat(addItems.mArray.filter(function(item) {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-                  return this.binding.mFilter.isItemInFilters(item) &amp;&amp; </span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-                         !(item.isCompleted &amp;&amp; !this.binding.showCompleted);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-              }, this));</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+              itemsToAdd = itemsToAdd.concat(this.binding.mFilter.filterItems(addItems.mArray));</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">               // remove the old items working backward from the end so the indexes stay valid</span>
<a href="#l1.64"></a><span id="l1.64">               remIndexes.sort(function(a, b) {return b - a;}).forEach(function(index) {</span>
<a href="#l1.65"></a><span id="l1.65">                   this.binding.mTaskArray.splice(index, 1);</span>
<a href="#l1.66"></a><span id="l1.66">                   this.treebox.rowCountChanged(index, -1);</span>
<a href="#l1.67"></a><span id="l1.67">               }, this);</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">               // add the new items</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineat">@@ -904,33 +899,36 @@</span>
<a href="#l1.71"></a><span id="l1.71">               this.binding.refresh();</span>
<a href="#l1.72"></a><span id="l1.72">           },</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74">           onAddItem: function tTO_onAddItem(aItem) {</span>
<a href="#l1.75"></a><span id="l1.75">               if (cal.isToDo(aItem)) {</span>
<a href="#l1.76"></a><span id="l1.76">                   let occs = [aItem];</span>
<a href="#l1.77"></a><span id="l1.77">                   if (this.binding.mFilter.endDate) {</span>
<a href="#l1.78"></a><span id="l1.78">                       // get occurrences of repeating items</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-                      occs = aItem.getOccurrencesBetween(this.binding.mFilter.startDate,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+                      occs = aItem.getOccurrencesBetween(this.binding.mFilter.startDate || </span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+                                                         cal.createDateTime(),</span>
<a href="#l1.82"></a><span id="l1.82">                                                          this.binding.mFilter.endDate,</span>
<a href="#l1.83"></a><span id="l1.83">                                                          {});</span>
<a href="#l1.84"></a><span id="l1.84">                   }</span>
<a href="#l1.85"></a><span id="l1.85">                   this.binding.mTreeView.addItems(occs);</span>
<a href="#l1.86"></a><span id="l1.86">               }</span>
<a href="#l1.87"></a><span id="l1.87">           },</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89">           onModifyItem: function tTO_onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l1.90"></a><span id="l1.90">               if ((cal.isToDo(aNewItem) || cal.isToDo(aOldItem))) {</span>
<a href="#l1.91"></a><span id="l1.91">                   let newOccs = [aNewItem];</span>
<a href="#l1.92"></a><span id="l1.92">                   let oldOccs = [aOldItem];</span>
<a href="#l1.93"></a><span id="l1.93">                   if (this.binding.mFilter.endDate) {</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-                      newOccs = aNewItem.getOccurrencesBetween(this.binding.mFilter.startDate,</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+                      newOccs = aNewItem.getOccurrencesBetween(this.binding.mFilter.startDate ||</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+                                                               cal.createDateTime(),</span>
<a href="#l1.97"></a><span id="l1.97">                                                                this.binding.mFilter.endDate,</span>
<a href="#l1.98"></a><span id="l1.98">                                                                {});</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-                      oldOccs = aOldItem.getOccurrencesBetween(this.binding.mFilter.startDate,</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+                      oldOccs = aOldItem.getOccurrencesBetween(this.binding.mFilter.startDate ||</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+                                                               cal.createDateTime(),</span>
<a href="#l1.102"></a><span id="l1.102">                                                                this.binding.mFilter.endDate,</span>
<a href="#l1.103"></a><span id="l1.103">                                                                {});</span>
<a href="#l1.104"></a><span id="l1.104">                   }</span>
<a href="#l1.105"></a><span id="l1.105">                   this.binding.mTreeView.modifyItems(newOccs, oldOccs);</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">                   // we also need to notify potential listeners.</span>
<a href="#l1.108"></a><span id="l1.108">                   var event = document.createEvent('Events');</span>
<a href="#l1.109"></a><span id="l1.109">                   event.initEvent('select', true, false);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineat">@@ -938,17 +936,18 @@</span>
<a href="#l1.111"></a><span id="l1.111">               }</span>
<a href="#l1.112"></a><span id="l1.112">           },</span>
<a href="#l1.113"></a><span id="l1.113"> </span>
<a href="#l1.114"></a><span id="l1.114">           onDeleteItem: function tTO_onDeleteItem(aDeletedItem) {</span>
<a href="#l1.115"></a><span id="l1.115">               if (cal.isToDo(aDeletedItem)) {</span>
<a href="#l1.116"></a><span id="l1.116">                   let occs = [aDeletedItem];</span>
<a href="#l1.117"></a><span id="l1.117">                   if (this.binding.mFilter.endDate) {</span>
<a href="#l1.118"></a><span id="l1.118">                       // get occurrences of repeating items</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-                      occs = aDeletedItem.getOccurrencesBetween(this.binding.mFilter.startDate,</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+                      occs = aDeletedItem.getOccurrencesBetween(this.binding.mFilter.startDate ||</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+                                                                cal.createDateTime(),</span>
<a href="#l1.122"></a><span id="l1.122">                                                                 this.binding.mFilter.endDate,</span>
<a href="#l1.123"></a><span id="l1.123">                                                                 {});</span>
<a href="#l1.124"></a><span id="l1.124">                   }</span>
<a href="#l1.125"></a><span id="l1.125">                   this.binding.mTreeView.removeItems(occs);</span>
<a href="#l1.126"></a><span id="l1.126">               }</span>
<a href="#l1.127"></a><span id="l1.127">           },</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">           onError: function tTO_onError(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineat">@@ -1033,22 +1032,24 @@</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132">           var refreshJob = {</span>
<a href="#l1.133"></a><span id="l1.133">               execute: function() {</span>
<a href="#l1.134"></a><span id="l1.134">                   var filter = aFilter || !savedThis.mShowCompletedTasks ?</span>
<a href="#l1.135"></a><span id="l1.135">                       aCalendar.ITEM_FILTER_COMPLETED_NO :</span>
<a href="#l1.136"></a><span id="l1.136">                       aCalendar.ITEM_FILTER_COMPLETED_ALL;</span>
<a href="#l1.137"></a><span id="l1.137">                   filter |= aCalendar.ITEM_FILTER_TYPE_TODO;</span>
<a href="#l1.138"></a><span id="l1.138"> </span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+                  let startDate = savedThis.mFilter.startDate;</span>
<a href="#l1.140"></a><span id="l1.140">                   if (savedThis.mFilter.endDate) {</span>
<a href="#l1.141"></a><span id="l1.141">                       filter |= aCalendar.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+                      startDate = startDate || cal.createDateTime();</span>
<a href="#l1.143"></a><span id="l1.143">                   }</span>
<a href="#l1.144"></a><span id="l1.144">                   aCalendar.getItems(filter,</span>
<a href="#l1.145"></a><span id="l1.145">                                      0,</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-                                     savedThis.mFilter.startDate,</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+                                     startDate,</span>
<a href="#l1.148"></a><span id="l1.148">                                      savedThis.mFilter.endDate,</span>
<a href="#l1.149"></a><span id="l1.149">                                      refreshListener);</span>
<a href="#l1.150"></a><span id="l1.150">               }</span>
<a href="#l1.151"></a><span id="l1.151">           };</span>
<a href="#l1.152"></a><span id="l1.152">           this.mRefreshQueue.push(refreshJob);</span>
<a href="#l1.153"></a><span id="l1.153">           this.popRefreshQueue();</span>
<a href="#l1.154"></a><span id="l1.154">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.155"></a><span id="l1.155">       &lt;/method&gt;</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineat">@@ -1183,26 +1184,21 @@</span>
<a href="#l1.157"></a><span id="l1.157">           return initialDate ? initialDate : now();</span>
<a href="#l1.158"></a><span id="l1.158">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.159"></a><span id="l1.159">       &lt;/method&gt;</span>
<a href="#l1.160"></a><span id="l1.160"> </span>
<a href="#l1.161"></a><span id="l1.161">       &lt;method name=&quot;updateFilter&quot;&gt;</span>
<a href="#l1.162"></a><span id="l1.162">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l1.163"></a><span id="l1.163">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.164"></a><span id="l1.164">             this.mFilter.textFilterField = this.mTextFilterField;</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-            this.mFilter.propertyFilter = aFilter || this.mFilter.propertyFilter || &quot;all&quot;;</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-            this.mDateRangeFilter = aFilter || this.mDateRangeFilter;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-            if (this.mDateRangeFilter) {</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-                this.mFilter.setDateFilter(this.mDateRangeFilter);</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+            if (aFilter) {</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+                this.mFilter.applyFilter(aFilter);</span>
<a href="#l1.172"></a><span id="l1.172">             } else {</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-                let oneDay = cal.createDuration();</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-                oneDay.days = 1;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-                this.mFilter.startDate = cal.createDateTime();</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-                this.mFilter.endDate = this.getInitialDate().clone();</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-                this.mFilter.endDate.addDuration(oneDay);</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+                this.mFilter.updateFilterDates();</span>
<a href="#l1.179"></a><span id="l1.179">             }</span>
<a href="#l1.180"></a><span id="l1.180"> </span>
<a href="#l1.181"></a><span id="l1.181">             this.refresh();</span>
<a href="#l1.182"></a><span id="l1.182">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.183"></a><span id="l1.183">       &lt;/method&gt;</span>
<a href="#l1.184"></a><span id="l1.184"> </span>
<a href="#l1.185"></a><span id="l1.185">       &lt;method name=&quot;updateFocus&quot;&gt;</span>
<a href="#l1.186"></a><span id="l1.186">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineat">@@ -1302,18 +1298,21 @@</span>
<a href="#l1.188"></a><span id="l1.188">               return initialDate ? initialDate : now();</span>
<a href="#l1.189"></a><span id="l1.189">             ]]&gt;&lt;/body&gt;</span>
<a href="#l1.190"></a><span id="l1.190">       &lt;/method&gt;</span>
<a href="#l1.191"></a><span id="l1.191">       &lt;method name=&quot;updateFilter&quot;&gt;</span>
<a href="#l1.192"></a><span id="l1.192">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l1.193"></a><span id="l1.193">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.194"></a><span id="l1.194">             this.mFilter.selectedDate = agendaListbox.today &amp;&amp; agendaListbox.today.start ? </span>
<a href="#l1.195"></a><span id="l1.195">                                         agendaListbox.today.start : now();</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-            this.mFilter.propertyFilter = aFilter || this.mFilter.propertyFilter || &quot;all&quot;;</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-            this.mDateRangeFilter = aFilter || this.mDateRangeFilter || &quot;all&quot;;</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-            this.mFilter.setDateFilter(this.mDateRangeFilter);</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+            if (aFilter) {</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+                this.mFilter.applyFilter(aFilter);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+            } else {</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+                this.mFilter.updateFilterDates();</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+            }</span>
<a href="#l1.205"></a><span id="l1.205"> </span>
<a href="#l1.206"></a><span id="l1.206">             this.refresh();</span>
<a href="#l1.207"></a><span id="l1.207">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.208"></a><span id="l1.208">       &lt;/method&gt;</span>
<a href="#l1.209"></a><span id="l1.209">     &lt;/implementation&gt;    </span>
<a href="#l1.210"></a><span id="l1.210">   &lt;/binding&gt;</span>
<a href="#l1.211"></a><span id="l1.211"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder-todo.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder-todo.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -75,16 +75,26 @@ function updateCalendarToDoUnifinder(aFi</span>
<a href="#l2.4"></a><span id="l2.4">     if (aFilter &amp;&amp; !(aFilter instanceof Event)) {</span>
<a href="#l2.5"></a><span id="l2.5">         filter = aFilter;</span>
<a href="#l2.6"></a><span id="l2.6">     }</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     if (filter &amp;&amp; (filter != oldFilter)) {</span>
<a href="#l2.9"></a><span id="l2.9">         document.getElementById(&quot;unifinder-todo-filter-broadcaster&quot;).setAttribute(&quot;value&quot;, aFilter);</span>
<a href="#l2.10"></a><span id="l2.10">     }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    if (filter &amp;&amp; !showCompleted) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        let filterProps = tree.mFilter.getDefinedFilterProperties(filter);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+        if (filterProps) {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+            filterProps.status = (filterProps.status || filterProps.FILTER_STATUS_ALL) &amp;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+                                 (filterProps.FILTER_STATUS_INCOMPLETE |</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+                                  filterProps.FILTER_STATUS_IN_PROGRESS);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+            filter = filterProps;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+        }</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    }</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+</span>
<a href="#l2.22"></a><span id="l2.22">     // update the filter</span>
<a href="#l2.23"></a><span id="l2.23">     tree.showCompleted = showCompleted;</span>
<a href="#l2.24"></a><span id="l2.24">     tree.updateFilter(filter);</span>
<a href="#l2.25"></a><span id="l2.25"> }</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> /**</span>
<a href="#l2.28"></a><span id="l2.28">  * Called when the window is unloaded to clean up the unifinder-todo.</span>
<a href="#l2.29"></a><span id="l2.29">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -243,17 +243,17 @@ function prepareCalendarUnifinder() {</span>
<a href="#l3.4"></a><span id="l3.4">         // set up our calendar event observer</span>
<a href="#l3.5"></a><span id="l3.5">         let ccalendar = getCompositeCalendar();</span>
<a href="#l3.6"></a><span id="l3.6">         ccalendar.addObserver(unifinderObserver);</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">         kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">         // Set up the filter</span>
<a href="#l3.11"></a><span id="l3.11">         unifinderTreeView.mFilter = new calFilter();</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        unifinderTreeView.mFilter.propertyFilter = &quot;unifinder-search-field&quot;;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        unifinderTreeView.mFilter.textFilterField = &quot;unifinder-search-field&quot;;</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">         // Set up the unifinder views.</span>
<a href="#l3.16"></a><span id="l3.16">         unifinderTreeView.treeElement = unifinderTree;</span>
<a href="#l3.17"></a><span id="l3.17">         unifinderTree.view = unifinderTreeView;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">         // Listen for changes in the selected day, so we can update if need be</span>
<a href="#l3.20"></a><span id="l3.20">         let viewDeck = getViewDeck();</span>
<a href="#l3.21"></a><span id="l3.21">         viewDeck.addEventListener(&quot;dayselect&quot;, unifinderDaySelect, false);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -947,17 +947,17 @@ function addItemsFromCalendar(aCalendar,</span>
<a href="#l3.23"></a><span id="l3.23">     let filter = 0;</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">     filter |= aCalendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     // Not all xul might be there yet...</span>
<a href="#l3.28"></a><span id="l3.28">     if (!document.getElementById(unifinderTreeView.mFilter.textFilterField)) {</span>
<a href="#l3.29"></a><span id="l3.29">         return;</span>
<a href="#l3.30"></a><span id="l3.30">     }</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    unifinderTreeView.mFilter.setDateFilter(getCurrentUnifinderFilter());</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    unifinderTreeView.mFilter.applyFilter(getCurrentUnifinderFilter());</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">     if (unifinderTreeView.mFilter.startDate &amp;&amp; unifinderTreeView.mFilter.endDate) {</span>
<a href="#l3.35"></a><span id="l3.35">         filter |= aCalendar.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l3.36"></a><span id="l3.36">     }</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">     aCalendar.getItems(filter,</span>
<a href="#l3.39"></a><span id="l3.39">                        0,</span>
<a href="#l3.40"></a><span id="l3.40">                        unifinderTreeView.mFilter.startDate,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -55,33 +55,33 @@</span>
<a href="#l4.4"></a><span id="l4.4"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l4.5"></a><span id="l4.5">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-unifinder.js&quot;/&gt;</span>
<a href="#l4.6"></a><span id="l4.6">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   &lt;vbox id=&quot;calendar-view-box&quot;&gt;</span>
<a href="#l4.9"></a><span id="l4.9">     &lt;vbox id=&quot;bottom-events-box&quot; insertbefore=&quot;calendar-nav-control&quot; persist=&quot;height&quot;&gt;</span>
<a href="#l4.10"></a><span id="l4.10">       &lt;hbox id=&quot;unifinder-searchBox&quot; persist=&quot;collapsed&quot;&gt;</span>
<a href="#l4.11"></a><span id="l4.11">         &lt;box align=&quot;center&quot;&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-          &lt;menulist id=&quot;event-filter-menulist&quot; value=&quot;next7days&quot; persist=&quot;value&quot;&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+          &lt;menulist id=&quot;event-filter-menulist&quot; value=&quot;P7D&quot; persist=&quot;value&quot;&gt;</span>
<a href="#l4.14"></a><span id="l4.14">             &lt;menupopup id=&quot;event-filter-menupopup&quot; oncommand=&quot;refreshEventTree()&quot;&gt;</span>
<a href="#l4.15"></a><span id="l4.15">               &lt;menuitem id=&quot;event-filter-all&quot;</span>
<a href="#l4.16"></a><span id="l4.16">                         label=&quot;&amp;calendar.events.filter.all.label;&quot;</span>
<a href="#l4.17"></a><span id="l4.17">                         value=&quot;all&quot;/&gt;</span>
<a href="#l4.18"></a><span id="l4.18">               &lt;menuitem id=&quot;event-filter-today&quot;</span>
<a href="#l4.19"></a><span id="l4.19">                         label=&quot;&amp;calendar.events.filter.today.label;&quot;</span>
<a href="#l4.20"></a><span id="l4.20">                         value=&quot;today&quot;/&gt;</span>
<a href="#l4.21"></a><span id="l4.21">               &lt;menuitem id=&quot;event-filter-next7days&quot;</span>
<a href="#l4.22"></a><span id="l4.22">                         label=&quot;&amp;calendar.events.filter.next7Days.label;&quot;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-                        value=&quot;next7days&quot;/&gt;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+                        value=&quot;P7D&quot;/&gt;</span>
<a href="#l4.25"></a><span id="l4.25">               &lt;menuitem id=&quot;event-filter-next14Days&quot;</span>
<a href="#l4.26"></a><span id="l4.26">                         label=&quot;&amp;calendar.events.filter.next14Days.label;&quot;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-                        value=&quot;next14days&quot;/&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+                        value=&quot;P14D&quot;/&gt;</span>
<a href="#l4.29"></a><span id="l4.29">               &lt;menuitem id=&quot;event-filter-next31Days&quot;</span>
<a href="#l4.30"></a><span id="l4.30">                         label=&quot;&amp;calendar.events.filter.next31Days.label;&quot;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                        value=&quot;next31days&quot;/&gt;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+                        value=&quot;P31D&quot;/&gt;</span>
<a href="#l4.33"></a><span id="l4.33">               &lt;menuitem id=&quot;event-filter-thisCalendarMonth&quot;</span>
<a href="#l4.34"></a><span id="l4.34">                         label=&quot;&amp;calendar.events.filter.thisCalendarMonth.label;&quot;</span>
<a href="#l4.35"></a><span id="l4.35">                         value=&quot;thisCalendarMonth&quot;/&gt;</span>
<a href="#l4.36"></a><span id="l4.36">               &lt;menuitem id=&quot;event-filter-future&quot;</span>
<a href="#l4.37"></a><span id="l4.37">                         label=&quot;&amp;calendar.events.filter.future.label;&quot;</span>
<a href="#l4.38"></a><span id="l4.38">                         value=&quot;future&quot;/&gt;</span>
<a href="#l4.39"></a><span id="l4.39">               &lt;menuitem id=&quot;event-filter-current&quot;</span>
<a href="#l4.40"></a><span id="l4.40">                         label=&quot;&amp;calendar.events.filter.current.label;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/src/calFilter.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/src/calFilter.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -31,388 +31,738 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.5"></a><span id="l5.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.6"></a><span id="l5.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.7"></a><span id="l5.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.8"></a><span id="l5.8">  *</span>
<a href="#l5.9"></a><span id="l5.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> /**</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">- * This object gives you the possibility to filter items for its properties.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">- * It has the following properties:</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * Object that contains a set of filter properties that may be used by a calFilter object</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * to filter a set of items.</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ * Supported filter properties:</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+ *   start, end:   Specifies the relative date range to use when calculating the filter date </span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+ *               range. The relative date range may relative to the current date and time, the</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+ *               currently selected date, or the dates range of the current view. The actual </span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+ *               date range used to filter items will be calculated by the calFilter object </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+ *               by using the updateFilterDates function, which may be called multiple times </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+ *               to reflect changes in the current date and time, and changes to the view.</span>
<a href="#l5.23"></a><span id="l5.23">  *</span>
<a href="#l5.24"></a><span id="l5.24">  *</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">- * private Attributes:</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">- *  mStartDate</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">- *  mEndDate            - the limits for the item to be in the filter</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">- *  mPropertyFilter     - a boolean function to filter items in a costumized way</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">- *  mPropertyFilterBag  - an object with a number of predefined filterFunctions</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">- *  mTextFilterField    - the id of a text - field that is associated with the filter</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+ *                 The properties may be set to one of the folowing values:</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+ *               - FILTER_DATE_ALL: An unbound date range.</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+ *               - FILTER_DATE_XXX: One of the defined relative date ranges.</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+ *               - A string that may be converted to a calIDuration object that will be used</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+ *                 as an offset to the current date and time.</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+ *</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+ *                 The start and end properties may have values representing different relative </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+ *               date ranges, in which case the filter start date will be calculated as the start</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+ *               of the relative range specified by the start property, while the filter end date</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+ *               will be calculated as the end of the relative range specified by the end </span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+ *               property.</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+ *</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+ *   due:          Specifies the filter property for the due date of tasks. This filter has no</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+ *               effect when filtering events. </span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+ *</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+ *                 The property has a bit field value, with the FILTER_DUE_XXX bit flags set </span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+ *               to indicate that tasks with the corresponding due property value should match</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+ *               the filter.</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+ *</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+ *                 If the value is set to null the due date will not be considered when filtering.</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+ *</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+ *   status:       Specifies the filter property for the status of tasks. This filter has no </span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+ *               effect when filtering events.</span>
<a href="#l5.54"></a><span id="l5.54">  *</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">- *  setting up the dateFilter:</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">- *  setDateFilter       - this function takes a string and sets the start and endDate of</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">- *                        the filter by using the getDatesForFilter function, please look</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">- *                        on the documentation for this function for further informations</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+ *                 The property has a bit field value, with the FILTER_STATUS_XXX bit flags set </span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+ *               to indicate that tasks with the corresponding status property value should match</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+ *               the filter.</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+ *</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+ *                 If the value is set to null the status will not be considered when filtering.</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+ *</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+ *   category:     Specifies the filter property for the item category.</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+ *</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+ *                 The property may be set to one of the folowing values:</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+ *               - null: The item category will not be considered when filtering.</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+ *               - A string: The item will match the filter if any of it's categories match the </span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+ *               category specified by the property.</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+ *               - An array: The item will match the filter if any of it's categories match any</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+ *               of the categories contained in the Array specified by the property.</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+ *</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+ *   onfilter:     A callback function that may be used to apply additional custom filter </span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+ *               constraints. If specified, the callback function will be called after any other</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+ *               specified filter properties are tested.</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+ *</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+ *                 The callback function will be called with the following parameters:</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+ *               - function(aItem, aResults, aFilterProperties, aFilter)</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+ *                   @param aItem               The item being tested.</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+ *                   @param aResults            The results of the test of the other specified</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+ *                                              filter properties.</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+ *                   @param aFilterProperties   The current filter properties being tested.</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+ *                   @param aFilter             The calFilter object performing the filter test.</span>
<a href="#l5.85"></a><span id="l5.85">  *</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">- * setting up the propertyFilter:</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">- *  you can associate a textFilter, a built-in filter or a custom function with the </span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">- *  propertyFilter. It is always set up by using calFilter.propertyFilter = aFilter</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">- *    1.) Use a built-in filter:</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">- *        - aFilter is a string </span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">- *        - the string has to be the name of one of the members of mPropertyFilterBag</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">- *        the propertyFilter is set to this built-in function</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">- *    2.) Use a text filter:</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">- *        - aFilter is a string</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">- *        - the string is a id of a text-field</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">- *        the propertyFilter will always filter out by regular expression items whose</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">- *        properties contain the value of the text-field</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">- *    3.) Use a costumized filter:</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">- *        - aFilter is a function</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">- *        propertyFilter is set this function</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">- * </span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">- * using the filter:</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">- * isItemInFilters        - this takes an item and returns the result of</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">- *                          checkIfInRange and propertyFilter</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+ *                 If specified, the callback function is responsible for returning a value that</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+ *               can be converted to true if the item should match the filter, or a value that </span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+ *               can be converted to false otherwise. The return value will override the results</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+ *               of the testing of any other specified filter properties.</span>
<a href="#l5.109"></a><span id="l5.109">  */</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+function calFilterProperties() {</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+}</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+calFilterProperties.prototype = {</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+    FILTER_DATE_ALL: 0,</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+    FILTER_DATE_VIEW: 1,</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+    FILTER_DATE_SELECTED: 2,</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+    FILTER_DATE_SELECTED_OR_NOW: 3,</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+    FILTER_DATE_NOW: 4,</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    FILTER_DATE_TODAY: 5,</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+    FILTER_DATE_CURRENT_WEEK: 6,</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+    FILTER_DATE_CURRENT_MONTH: 7,</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+    FILTER_DATE_CURRENT_YEAR: 8,</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+    FILTER_STATUS_INCOMPLETE: 1,</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+    FILTER_STATUS_IN_PROGRESS: 2,</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+    FILTER_STATUS_COMPLETED_TODAY: 4,</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+    FILTER_STATUS_COMPLETED_BEFORE: 8,</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+    FILTER_STATUS_ALL: 15,</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+    FILTER_DUE_PAST: 1,</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+    FILTER_DUE_TODAY: 2,</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+    FILTER_DUE_FUTURE: 4,</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+    FILTER_DUE_NONE: 8,</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+    FILTER_DUE_ALL: 15,</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+    start: null,</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+    end: null,</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+    due: null,</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+    status: null,</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+    category: null,</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    onfilter: null,</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+    </span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    equals: function cFP_equals(aFilterProps) {</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+        if (!(aFilterProps instanceof calFilterProperties)) {</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+            return false;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+        }</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+        let props = [&quot;start&quot;, &quot;end&quot;, &quot;due&quot;, &quot;status&quot;, &quot;category&quot;, &quot;onfilter&quot;];</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+        return props.every(function(prop) {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+            return (this[prop] == aFilterProps[prop]);</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+        }, this);</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+    },</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+    clone: function cFP_clone() {</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+        let cl = new calFilterProperties();</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+        let props = [&quot;start&quot;, &quot;end&quot;, &quot;due&quot;, &quot;status&quot;, &quot;category&quot;, &quot;onfilter&quot;];</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+        props.forEach(function(prop) {</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+            cl[prop] = this[prop];</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+        }, this);</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+        return cl;</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+    },</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+    LOG: function cFP_LOG(aString) {</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+        cal.LOG(&quot;[calFilterProperties] &quot; +</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+                (aString || &quot;&quot;) +</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+                &quot;\n  start: &quot; + this.start +</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+                &quot;\n  end: &quot; + this.end +</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+                &quot;\n  status: &quot; + this.status +</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+                &quot;\n  due: &quot; + this.due +</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+                &quot;\n  category: &quot; + this.category);</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+    }</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+};</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+/**</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+ * Object that allows filtering of a set of items using a set of filter properties. A set</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+ * of property filters may be defined by a filter name, which may then be used to apply </span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+ * the defined filter properties. A set of commonly used property filters are predefined.</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+ */</span>
<a href="#l5.181"></a><span id="l5.181"> function calFilter() {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  this.wrappedJSObject = this;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+    this.mFilterProperties = new calFilterProperties();</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+    this.initDefinedFilters();</span>
<a href="#l5.186"></a><span id="l5.186"> }</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188"> calFilter.prototype = {</span>
<a href="#l5.189"></a><span id="l5.189">     mStartDate: null,</span>
<a href="#l5.190"></a><span id="l5.190">     mEndDate: null,</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+    mSelectedDate: null,</span>
<a href="#l5.192"></a><span id="l5.192">     mTextFilterField: null,</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-    mPropertyFilter: filterAll,</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-    mSelectedDate: null,</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+    mDefinedFilters: {},</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+    mFilterProperties: null,</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+    mToday: null,</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+    mTomorrow: null,</span>
<a href="#l5.199"></a><span id="l5.199"> </span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-    // a number of prefined Filters for properties</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-    mPropertyFilterBag: { </span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-        all: filterAll,</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-        notstarted: function cF_filterNotStarted(item) {</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-            return !item.isCompleted &amp;&amp;</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-                   (percentCompleted(item) &lt;= 0);</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-        },</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-        overdue: function cF_filterOverdue(item) {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-            // in case the item has no due date</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-            // it can't be overdue by definition</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-            if (item.dueDate == null) {</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-                return false;</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+    /**</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+     * Initializes the predefined filters.</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+     */</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+    initDefinedFilters: function cF_initDefinedFilters() {</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+        let filters = [&quot;all&quot;, &quot;notstarted&quot;, &quot;overdue&quot;, &quot;open&quot;, &quot;completed&quot;, &quot;throughcurrent&quot;, </span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+                       &quot;throughtoday&quot;, &quot;throughsevendays&quot;, &quot;today&quot;, &quot;thisCalendarMonth&quot;, </span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+                       &quot;future&quot;, &quot;current&quot;, &quot;currentview&quot;];</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+        filters.forEach(function(filter) {</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+            if (!(filter in this.mDefinedFilters)) {</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+                this.defineFilter(filter, this.getPreDefinedFilterProperties(filter));</span>
<a href="#l5.222"></a><span id="l5.222">             }</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-            return !item.isCompleted &amp;&amp;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-                   !(item.dueDate.compare(now()) &gt; 0);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-        },</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-        open: function cF_filterOpen(item) {</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-            return !item.isCompleted;</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-        },</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-        completed: function cF_filterCompleted(item) {</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-            return item.isCompleted;</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-        },</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-        repeating: function cF_filterRepeating(item) {</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-            return (item.recurrenceInfo != null);</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-        },</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-        throughcurrent: function cF_filterThroughCurrent(item) {</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-            return completionIsCurrent(item);</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-        },</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-        throughtoday: function cF_filterThroughToday(item) {</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-            return completionIsCurrent(item);</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-        },</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-        throughsevendays: function cF_filterThroughSevenDays(item) {</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-            return completionIsCurrent(item);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+        }, this);</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+    },</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+    /**</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+     * Gets the filter properties for a predefined filter.</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+     *</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+     * @param aFilter   The name of the filter to retrieve the filter properties for.</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+     * @result          The filter properties for the specified filter, or null if the filter </span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+     *                  not predefined.</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+     */</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+    getPreDefinedFilterProperties: function cF_getPreDefinedFilterProperties(aFilter) {</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+        let props = new calFilterProperties();</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+        if (!aFilter) {</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+            return props;</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+        }</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+        switch (aFilter) {</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+            // Predefined Task filters</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+            case &quot;notstarted&quot;:</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+                props.status = props.FILTER_STATUS_INCOMPLETE;</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+                props.due = props.FILTER_DUE_ALL;</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+                props.start = props.FILTER_DATE_ALL;</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+                props.end = props.FILTER_DATE_SELECTED_OR_NOW;</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+                break;</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+            case &quot;overdue&quot;:</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+                props.status = props.FILTER_STATUS_INCOMPLETE | props.FILTER_STATUS_IN_PROGRESS;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+                props.due = props.FILTER_DUE_PAST;</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+                props.start = props.FILTER_DATE_ALL;</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+                props.end = props.FILTER_DATE_SELECTED_OR_NOW;</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+                break;</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+            case &quot;open&quot;:</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+                props.status = props.FILTER_STATUS_INCOMPLETE | props.FILTER_STATUS_IN_PROGRESS;</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+                props.due = props.FILTER_DUE_ALL;</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+                props.start = props.FILTER_DATE_ALL;</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+                props.end = props.FILTER_DATE_SELECTED_OR_NOW;</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+                break;</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+            case &quot;completed&quot;:</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+                props.status = props.FILTER_STATUS_COMPLETED_TODAY | props.FILTER_STATUS_COMPLETED_BEFORE;</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+                props.due = props.FILTER_DUE_ALL;</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+                props.start = props.FILTER_DATE_ALL;</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+                props.end = props.FILTER_DATE_SELECTED_OR_NOW;</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+                break;</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+            case &quot;throughcurrent&quot;:</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+                props.status = props.FILTER_STATUS_INCOMPLETE | props.FILTER_STATUS_IN_PROGRESS | </span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+                               props.FILTER_STATUS_COMPLETED_TODAY;</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+                props.due = props.FILTER_DUE_ALL;</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+                props.start = props.FILTER_DATE_ALL;</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+                props.end = props.FILTER_DATE_SELECTED_OR_NOW;</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+                break;</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+            case &quot;throughtoday&quot;:</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+                props.status = props.FILTER_STATUS_INCOMPLETE | props.FILTER_STATUS_IN_PROGRESS | </span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+                               props.FILTER_STATUS_COMPLETED_TODAY;</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+                props.due = props.FILTER_DUE_ALL;</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+                props.start = props.FILTER_DATE_ALL;</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+                props.end = props.FILTER_DATE_TODAY;</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+                break;</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+            case &quot;throughsevendays&quot;:</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+                props.status = props.FILTER_STATUS_INCOMPLETE | props.FILTER_STATUS_IN_PROGRESS | </span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+                               props.FILTER_STATUS_COMPLETED_TODAY;</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+                props.due = props.FILTER_DUE_ALL;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+                props.start = props.FILTER_DATE_ALL;</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+                props.end = &quot;P7D&quot;;</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+                break;</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+            // Predefined Event filters</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+            case &quot;today&quot;:</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+                props.start = props.FILTER_DATE_TODAY;</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+                props.end = props.FILTER_DATE_TODAY;</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+                break;</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+            case &quot;thisCalendarMonth&quot;:</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+                props.start = props.FILTER_DATE_CURRENT_MONTH;</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+                props.end = props.FILTER_DATE_CURRENT_MONTH;</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+                break;</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+            case &quot;future&quot;:</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+                props.start = props.FILTER_DATE_NOW;</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+                props.end = props.FILTER_DATE_ALL;</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+                break;</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+            case &quot;current&quot;:</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+                props.start = props.FILTER_DATE_SELECTED;</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+                props.end = props.FILTER_DATE_SELECTED;</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+                break;</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+            case &quot;currentview&quot;:</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+                props.start = props.FILTER_DATE_VIEW;</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+                props.end = props.FILTER_DATE_VIEW;</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+                break;</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+            case &quot;all&quot;:</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+            default:</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+                props.status = props.FILTER_STATUS_ALL;</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+                props.due = props.FILTER_DUE_ALL;</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+                props.start = props.FILTER_DATE_ALL;</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+                props.end = props.FILTER_DATE_ALL;</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+        }</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+        return props;</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+    },</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+    /**</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+     * Defines a set of filter properties so that they may be applied by the filter name. If</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+     * the specified filter name is already defined, it's associated filter properties will be </span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+     * replaced.</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+     *</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+     * @param aFilterName         The name to define the filter properties as.</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+     * @param aFilterProperties   The filter properties to define.</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+     */</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+    defineFilter: function cF_defineFilter(aFilterName, aFilterProperties) {</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+        if (!(aFilterProperties instanceof calFilterProperties)) {</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+            return;</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+        }</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+        this.mDefinedFilters[aFilterName] = aFilterProperties;</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+    },</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+    /**</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+     * Returns the set of filter properties that were previously defined by a filter name.</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+     *</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+     * @param aFilter             The filter name of the defined filter properties.</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+     * @return                    The properties defined by the filter name, or null if</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+     *                            the filter name was not previously defined.</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+     */</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+    getDefinedFilterProperties: function cF_getDefinedFilterProperties(aFilter) {</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+        if (aFilter in this.mDefinedFilters) {</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+            return this.mDefinedFilters[aFilter].clone();</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+        } else {</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+            return null;</span>
<a href="#l5.370"></a><span id="l5.370">         }</span>
<a href="#l5.371"></a><span id="l5.371">     },</span>
<a href="#l5.372"></a><span id="l5.372"> </span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-    get startDate() {</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-        return this.mStartDate;</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-    },</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-    set startDate(aStartDate) {</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineminus">-        return (this.mStartDate = aStartDate);</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineminus">-    },</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-    get endDate() {</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-        return this.mEndDate;</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-    },</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-    set endDate(aEndDate) {</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-        return (this.mEndDate = aEndDate);</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+    /**</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+     * Returns the filter name that a set of filter properties were previously defined as.</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+     *</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+     * @param aFilterProperties   The filter properties previously defined.</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+     * @return                    The name of the first filter name that the properties </span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+     *                            were defined as, or null if the filter properties were</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+     *                            not previously defined.</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+     */</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+    getDefinedFilterName: function cF_getDefinedFilterName(aFilterProperties) {</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+        for (filter in this.mDefinedFilters) {</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+            if (this.mDefinedFilters[filter].equals(aFilterProperties)) {</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+                return filter;</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+            }</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+        }</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+        return null;</span>
<a href="#l5.402"></a><span id="l5.402">     },</span>
<a href="#l5.403"></a><span id="l5.403"> </span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-    set textFilterField(aId) {</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-        return (this.mTextFilterField = aId);</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-    },</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-    get textFilterField() {</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-        return this.mTextFilterField;</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-    },</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineminus">-</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-    get selectedDate() {</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-        return this.mSelectedDate;</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-    },</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-    set selectedDate(aSelectedDate) {</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-        return (this.mSelectedDate = aSelectedDate);</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-    },</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineminus">-</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineminus">-    // checks if the item contains the text of mTextFilterField</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+    /**</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+     * Checks if the item matches the filter text of the mTextFilterField element</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+     *</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+     * @param aItem               The item to check.</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+     * @return                    Returns true if the item matches the text filter</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+     *                            or the mTextFilterField is not set, false otherwise.</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+     */</span>
<a href="#l5.428"></a><span id="l5.428">     textFilter: function cF_filterByText(aItem) {</span>
<a href="#l5.429"></a><span id="l5.429">         if (!this.mTextFilterField) {</span>
<a href="#l5.430"></a><span id="l5.430">             return true;</span>
<a href="#l5.431"></a><span id="l5.431">         }</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-        filterByText.mTextFilterField = this.mTextFilterField;</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-        let inIt = filterByText(aItem);</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-        return inIt;</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-    },</span>
<a href="#l5.436"></a><span id="l5.436"> </span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-    get propertyFilter() {</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-        if(!this.mPropertyFilter) {</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineminus">-            this.mPropertyFilter = filterAll;</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+        let searchText = document.getElementById(this.mTextFilterField)</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+                                 .value.toLowerCase();</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+        if (!searchText.length || searchText.match(/^\s*$/)) {</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+            return true;</span>
<a href="#l5.445"></a><span id="l5.445">         }</span>
<a href="#l5.446"></a><span id="l5.446"> </span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-        return this.mPropertyFilter;</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+        //XXX TODO: Support specifying which fields to search on</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+        for each (let field in [&quot;SUMMARY&quot;, &quot;DESCRIPTION&quot;, &quot;LOCATION&quot;, &quot;URL&quot;]) {</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+            let val = aItem.getProperty(field);</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+            if (val &amp;&amp; val.toLowerCase().indexOf(searchText) != -1) {</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+                return true;</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+            }</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+        }</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+        return aItem.getCategories({}).some(function(cat) {</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+            return (cat.toLowerCase().indexOf(searchText) != -1);</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+        });</span>
<a href="#l5.459"></a><span id="l5.459">     },</span>
<a href="#l5.460"></a><span id="l5.460"> </span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-    /*</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineminus">-     * @param aFilter if -  aFilter is a string, propertyFilter is textFilter</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineminus">-     *                      if aFilter has to be the id of the textFilterField then</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-     *                      if aFilter is the number of a number of predefined </span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-     *                          propertyFilters, propertyFilters is set to be this</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-     *                   -  aFilter is a function, the propertyFilter is set to be this</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineminus">-     *                      function</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+    /**</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+     * Checks if the item matches the current filter date range.</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+     *</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+     * @param aItem               The item to check.</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+     * @return                    Returns true if the item falls within the date range</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+     *                            specified by mStartDate and mEndDate, false otherwise.</span>
<a href="#l5.474"></a><span id="l5.474">      */</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-    set propertyFilter(aFilter) {</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineminus">-        if (typeof(aFilter) == &quot;string&quot;) {</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-            // check if it is one of the build in filters</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-            if (this.mPropertyFilterBag[aFilter]) {</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-                return (this.mPropertyFilter = this.mPropertyFilterBag[aFilter]);</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-            }</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-            // check if the aFilter is the id of an item, otherwise </span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-            // return set the filter to all</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineminus">-            if (document.getElementById(aFilter)) {</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineminus">-                this.mTextFilterField = aFilter;</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineminus">-                return (this.mPropertyFilter = this.textFilter);</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineminus">-            }</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-        } else if (typeof(aFilter) == &quot;function&quot;) {</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-          return (this.mPropertyFilter = aFilter);</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineminus">-        }  </span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-        </span>
<a href="#l5.491"></a><span id="l5.491" class="difflineminus">-        return (this.mPropertyFilter = filterAll);</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineminus">-    },</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-    // set's the startDate and the endDate by using getDatesForFilter </span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-    setDateFilter: function cF_setDateFilter(aFilter) {</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineminus">-      var [startDate, endDate] = getDatesForFilter(aFilter, this.mSelectedDate);</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-      this.mStartDate = startDate;</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-      this.mEndDate = endDate;</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineminus">-      return [this.mStartdate, this.mEndDate];</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineminus">-    },</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineminus">-</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineminus">-    // checks if the item is between startDate and endDate</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineminus">-    isItemWithinRange: function cF_isDateWithinRange(aItem) {</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+    dateRangeFilter: function cF_dateRangeFilter(aItem) {</span>
<a href="#l5.505"></a><span id="l5.505">         return checkIfInRange(aItem, this.mStartDate, this.mEndDate);</span>
<a href="#l5.506"></a><span id="l5.506">     },</span>
<a href="#l5.507"></a><span id="l5.507"> </span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-    // checks if the item is between startDate and endDate, matches its properties, and</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-    // contains the text of mTextFilterField if set</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+    /**</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+     * Checks if the item matches the currently applied filter properties. Filter properties</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+     * with a value of null or that are not applicable to the item's type are not tested.</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+     *</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+     * @param aItem               The item to check.</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+     * @return                    Returns true if the item matches the filter properties</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+     *                            currently applied, false otherwise.</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+     */</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+    propertyFilter: function cF_propertyFilter(aItem) {</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+        let result;</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+        let props = this.mFilterProperties;</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+        if (!props) {</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+            return false;</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+        }</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+        // the today and tomorrow properties are precalculated in the updateFilterDates function</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+        // for better performance when filtering batches of items.</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+        let today = this.mToday;</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+        if (!today) {</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+            today = cal.now();</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineplus">+            today.isDate = true;</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+        }</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+        let tomorrow = this.mTomorrow;</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+        if (!tomorrow) {</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+            tomorrow = today.clone();</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+            tomorrow.day++;</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+        }</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+        // test the date range of the applied filter.</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+        result = this.dateRangeFilter(aItem);</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+        // test the category property. If the property value is an array, only one category must</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+        // match.</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+        if (result &amp;&amp; props.category) {</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+            let cats = [];</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+            if (typeof(props.category) == &quot;string&quot;) {</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+                cats.push(props.category);</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+            } else if (Array.isArray(props.category)) {</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+                cats = props.category;</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+            }</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+            result = cats.some(function(cat) {</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+                return aItem.getCategories({}).indexOf(cat) &gt; -1;</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+            });</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+        }</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+        // test the status property. Only applies to tasks.</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+        if (result &amp;&amp; props.status != null &amp;&amp; cal.isToDo(aItem)) {</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+            let completed = aItem.isCompleted;</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+            let current = !aItem.completedDate || today.compare(aItem.completedDate) &lt;= 0;</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+            let percent = aItem.percentComplete || 0;</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+            result = ((props.status &amp; props.FILTER_STATUS_INCOMPLETE) ||</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+                      !(!completed &amp;&amp; (percent == 0))) &amp;&amp;</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+                     ((props.status &amp; props.FILTER_STATUS_IN_PROGRESS) ||</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+                      !(!completed &amp;&amp; (percent &gt; 0))) &amp;&amp;</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+                     ((props.status &amp; props.FILTER_STATUS_COMPLETED_TODAY) ||</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+                      !(completed &amp;&amp; current)) &amp;&amp;</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+                     ((props.status &amp; props.FILTER_STATUS_COMPLETED_BEFORE) ||</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+                      !(completed &amp;&amp; !current));</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineplus">+        }</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineplus">+</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineplus">+        // test the due property. Only applies to tasks.</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+        if (result &amp;&amp; props.due != null &amp;&amp; cal.isToDo(aItem)) {</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+            let due = aItem.dueDate;</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineplus">+            let now = cal.now();</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineplus">+            result = ((props.due &amp; props.FILTER_DUE_PAST) ||</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineplus">+                      !(due &amp;&amp; (due.compare(now) &lt; 0))) &amp;&amp;</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+                     ((props.due &amp; props.FILTER_DUE_TODAY) ||</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+                      !(due &amp;&amp; (due.compare(now) &gt;= 0) &amp;&amp; (due.compare(tomorrow) &lt; 0))) &amp;&amp;</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineplus">+                     ((props.due &amp; props.FILTER_DUE_FUTURE) ||</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineplus">+                      !(due &amp;&amp; (due.compare(tomorrow) &gt;= 0))) &amp;&amp;</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+                     ((props.due &amp; props.FILTER_DUE_NONE) ||</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineplus">+                      !(due == null));</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineplus">+        }</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineplus">+</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+        // Call the filter properties onfilter callback if set. The return value of the </span>
<a href="#l5.589"></a><span id="l5.589" class="difflineplus">+        // callback function will override the result of this function.</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+        if (props.onfilter &amp;&amp; (typeof(props.onfilter) == &quot;function&quot;)) {</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineplus">+            return props.onfilter(aItem, result, props, this);</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+        }</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+        return result;</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+    },</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+    /**</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineplus">+     * Calculates the date from a date filter property.</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+     *</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+     * @param prop                The value of the date filter property to calculate for. May</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+     *                            be a constant specifying a relative date range, or a string</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineplus">+     *                            representing a duration offset from the current date time.</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+     * @param start               If true, the function will return the date value for the </span>
<a href="#l5.604"></a><span id="l5.604" class="difflineplus">+     *                            start of the relative date range, otherwise it will return the</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineplus">+     *                            date value for the end of the date range.</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineplus">+     * @return                    The calculated date for the property.</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineplus">+     */</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+    getDateForProperty: function cF_getDateForProperty(prop, start) {</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineplus">+        let props = this.mFilterProperties || new calFilterProperties();</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+        let result = null;</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineplus">+        let selectedDate = this.mSelectedDate || currentView().selectedDay || cal.now();</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineplus">+</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+        if (typeof(prop) == &quot;string&quot;) {</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineplus">+            let duration = cal.createDuration(prop);</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+            if (duration) {</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+                result = cal.now();</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineplus">+                result.addDuration(duration);</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+            }</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+        } else {</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineplus">+            switch (prop) {</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+                case props.FILTER_DATE_ALL:</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineplus">+                    result = null;</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineplus">+                    break;</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineplus">+                case props.FILTER_DATE_VIEW:</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineplus">+                    result = start ? currentView().startDay.clone() :</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineplus">+                                     currentView().endDay.clone();</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineplus">+                    break;</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+                case props.FILTER_DATE_SELECTED:</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+                    result = selectedDate.clone();</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+                    result.isDate = true;</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+                    break;</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+                case props.FILTER_DATE_SELECTED_OR_NOW:</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineplus">+                    result = selectedDate.clone();</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+                    if ((start &amp;&amp; result.jsDate &gt; cal.now().jsDate) ||</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+                        (!start &amp;&amp; result.jsDate &lt; cal.now().jsDate)) {</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+                        result = cal.now();</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+                    }</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+                    result.isDate = true;</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineplus">+                    break;</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineplus">+                case props.FILTER_DATE_NOW:</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineplus">+                    result = cal.now();</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+                    break;</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+                case props.FILTER_DATE_TODAY:</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+                    result = cal.now();</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+                    result.isDate = true;</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineplus">+                    break;</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+                case props.FILTER_DATE_CURRENT_WEEK:</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+                    result = start ? cal.now().startOfWeek : cal.now().endOfWeek;</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+                    break;</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineplus">+                case props.FILTER_DATE_CURRENT_MONTH:</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineplus">+                    result = start ? cal.now().startOfMonth : cal.now().endOfMonth;</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+                    break;</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+                case props.FILTER_DATE_CURRENT_YEAR:</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineplus">+                    result = start ? cal.now().startOfYear : cal.now().endOfYear;</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+                    break;</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+            }</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+            // date ranges are inclusive, so we need to include the day for the end date</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+            if (!start &amp;&amp; result &amp;&amp; prop != props.FILTER_DATE_NOW) {</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+                result.day++;</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+            }</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineplus">+        }</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineplus">+</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineplus">+        return result;</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+    },</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+    /**</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+     * Calculates the current start and end dates for the currently applied filter.</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+     *</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+     * @return                    The current [startDate, endDate] for the applied filter.</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+     */</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+    getDatesForFilter: function cfp_getDatesForFilter() {</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+        let startDate = null;</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+        let endDate = null;</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineplus">+        if (this.mFilterProperties) {</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+            startDate = this.getDateForProperty(this.mFilterProperties.start, true);</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineplus">+            endDate = this.getDateForProperty(this.mFilterProperties.end, false);</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineplus">+</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineplus">+            // swap the start and end dates if necessary</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineplus">+            if (startDate &amp;&amp; endDate &amp;&amp; startDate.compare(endDate) &gt; 0) {</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineplus">+                let swap = startDate;</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+                endDate = startDate;</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineplus">+                startDate = swap;</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineplus">+            }</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineplus">+        }</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineplus">+</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+        return [startDate, endDate];</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+    },</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+    /**</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+     * Gets the start date for the current filter date range.</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+     *</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+     * @return:                    The start date of the current filter date range, or null if</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+     *                             the date range has an unbound start date.</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineplus">+     */</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineplus">+    get startDate() {</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineplus">+        return this.mStartDate;</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineplus">+    },</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineplus">+    /** </span>
<a href="#l5.702"></a><span id="l5.702" class="difflineplus">+     * Sets the start date for the current filter date range. This will override the date range</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+     * calculated from the filter properties by the getDatesForFilter function.</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineplus">+     */</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineplus">+    set startDate(aStartDate) {</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineplus">+        return (this.mStartDate = aStartDate);</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineplus">+    },</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineplus">+</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineplus">+    /**</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+     * Gets the end date for the current filter date range.</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+     *</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+     * @return:                    The end date of the current filter date range, or null if</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineplus">+     *                             the date range has an unbound end date.</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineplus">+     */</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineplus">+    get endDate() {</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineplus">+        return this.mEndDate;</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineplus">+    },</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineplus">+    /** </span>
<a href="#l5.720"></a><span id="l5.720" class="difflineplus">+     * Sets the end date for the current filter date range. This will override the date range</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+     * calculated from the filter properties by the getDatesForFilter function.</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineplus">+     */</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineplus">+    set endDate(aEndDate) {</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineplus">+        return (this.mEndDate = aEndDate);</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+    },</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+    /**</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineplus">+     * Gets the ID of the DOM element used to perform the text filter.</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+     */</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+    get textFilterField() {</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+        return this.mTextFilterField;</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+    },</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineplus">+    /**</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineplus">+     * Sets the DOM element used to perform the text filter.</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+     *</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineplus">+     * @param aId                 The Id of the DOM element.</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineplus">+     */</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineplus">+    set textFilterField(aId) {</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+        return (this.mTextFilterField = aId);</span>
<a href="#l5.741"></a><span id="l5.741" class="difflineplus">+    },</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineplus">+</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineplus">+    /**</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineplus">+     * Gets the selected date used by the getDatesForFilter function to calculate date ranges</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineplus">+     * that are relative to the selected date.</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+     */</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+    get selectedDate() {</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+        return this.mSelectedDate;</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+    },</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineplus">+</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineplus">+    /**</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineplus">+     * Sets the selected date used by the getDatesForFilter function to calculate date ranges</span>
<a href="#l5.753"></a><span id="l5.753" class="difflineplus">+     * that are relative to the selected date.</span>
<a href="#l5.754"></a><span id="l5.754" class="difflineplus">+     */</span>
<a href="#l5.755"></a><span id="l5.755" class="difflineplus">+    set selectedDate(aSelectedDate) {</span>
<a href="#l5.756"></a><span id="l5.756" class="difflineplus">+        return (this.mSelectedDate = aSelectedDate);</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineplus">+    },</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineplus">+</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineplus">+    /**</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineplus">+     * Gets the currently applied filter properties.</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineplus">+     *</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineplus">+     * @return                    The currently applied filter properties.</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+     */</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineplus">+    get filterProperties() {</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineplus">+        return this.mFilterProperties ? this.mFilterProperties.clone() : null;</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineplus">+    },</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineplus">+</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineplus">+    /**</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineplus">+     * Gets the name of the currently applied filter.</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+     *</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineplus">+     * @return                    The current defined name of the currently applied filter</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+     *                            properties, or null if the current properties were not</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+     *                            previously defined.</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineplus">+     */</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineplus">+    get filterName() {</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineplus">+        if (!this.mFilterProperties) {</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineplus">+            return null;</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+        }</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineplus">+</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+        return this.getDefinedFilterName(this.mFilterProperties);</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+    },</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineplus">+    /**</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineplus">+     * Applies the specified filter.</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineplus">+     *</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineplus">+     * @param aFilter           The filter to apply. May be one of the following types:</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+     *                          - a calFilterProperties object specifying the filter properties</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineplus">+     *                          - a String representing a previously defined filter name</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+     *                          - a String representing a duration offset from now</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineplus">+     *                          - a Function to use for the onfilter callback for a custom filter</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+     */</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineplus">+    applyFilter: function cF_applyFilter(aFilter) {</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineplus">+        this.mFilterProperties = null;</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineplus">+</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineplus">+        if (typeof(aFilter) == &quot;string&quot;) {</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineplus">+            if (aFilter in this.mDefinedFilters) {</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+                this.mFilterProperties = this.getDefinedFilterProperties(aFilter);</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineplus">+            } else {</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+                let dur = cal.createDuration(aFilter);</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+                if (dur.inSeconds &gt; 0) {</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+                    this.mFilterProperties = new calFilterProperties();</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+                    this.mFilterProperties.start = this.mFilterProperties.FILTER_DATE_NOW;</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineplus">+                    this.mFilterProperties.end = aFilter;</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineplus">+                }</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineplus">+            }</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineplus">+        } else if (typeof(aFilter) == &quot;object&quot; &amp;&amp; (aFilter instanceof calFilterProperties)) {</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+            this.mFilterProperties = aFilter;</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineplus">+        } else if (typeof(aFilter) == &quot;function&quot;) {</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+            this.mFilterProperties = new calFilterProperties();</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+            this.mFilterProperties.onfilter = aFilter;</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+        } else {</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineplus">+            this.mFilterProperties = new calFilterProperties();</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineplus">+        }</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineplus">+        if (!this.mFilterProperties) {</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineplus">+            cal.WARN(&quot;[calFilter] Unable to apply filter &quot; + aFilter);</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineplus">+        } else {</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineplus">+            this.updateFilterDates();</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineplus">+            this.mFilterProperties.LOG(&quot;Applying filter:&quot;);</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineplus">+        }</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineplus">+    },</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineplus">+</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineplus">+    /**</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineplus">+     * Calculates the current start and end dates for the currently applied filter, and updates</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineplus">+     * the current filter start and end dates. This function can be used to update the date range</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineplus">+     * for date range filters that are relative to the selected date or current date and time.</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineplus">+     *</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+     * @return                    The current [startDate, endDate] for the applied filter.</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineplus">+     */</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineplus">+    updateFilterDates: function cF_updateFilterDates() {</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineplus">+        let [startDate, endDate] = this.getDatesForFilter();</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineplus">+        this.mStartDate = startDate;</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineplus">+        this.mEndDate = endDate;</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineplus">+</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+        // the today and tomorrow properties are precalculated here</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineplus">+        // for better performance when filtering batches of items.</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+        this.mToday = cal.now();</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineplus">+        this.mToday.isDate = true;</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineplus">+        this.mTomorrow = this.mToday.clone();</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+        this.mTomorrow.day++;</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineplus">+</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineplus">+        return [startDate, endDate];</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineplus">+    },</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineplus">+</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineplus">+    /**</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineplus">+     * Filters an array of items, returning a new array containing the items that match</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+     * the currently applied filter properties and the filter text of the text filter</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineplus">+     * element.</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineplus">+     *</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineplus">+     * @param aItems              The array of items to check.</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineplus">+     * @param aCallback           An optional callback function to be called with each item and </span>
<a href="#l5.853"></a><span id="l5.853" class="difflineplus">+     *                            the result of it's filter test.</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineplus">+     * @return                    A new array containing the items that match the filters, or </span>
<a href="#l5.855"></a><span id="l5.855" class="difflineplus">+     *                            null if no filter has been applied.</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineplus">+     */  </span>
<a href="#l5.857"></a><span id="l5.857" class="difflineplus">+    filterItems: function cF_filterItems(aItems, aCallback) {</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineplus">+        if (!this.mFilterProperties) {</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineplus">+            return null;</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineplus">+        }</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineplus">+</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineplus">+        return aItems.filter(function(aItem) {</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineplus">+            let result = this.propertyFilter(aItem) &amp;&amp; this.textFilter(aItem);</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineplus">+</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineplus">+            if (aCallback &amp;&amp; (typeof(aCallback) == &quot;function&quot;)) {</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineplus">+                aCallback(aItem, result, this.mFilterProperties, this);</span>
<a href="#l5.867"></a><span id="l5.867" class="difflineplus">+            }</span>
<a href="#l5.868"></a><span id="l5.868" class="difflineplus">+</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineplus">+            return result;</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineplus">+        }, this);</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineplus">+    },</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineplus">+</span>
<a href="#l5.873"></a><span id="l5.873" class="difflineplus">+    /**</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineplus">+     * Checks if the item matches the currently applied filter properties and the </span>
<a href="#l5.875"></a><span id="l5.875" class="difflineplus">+     * filter text of the text filter element.</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineplus">+     *</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineplus">+     * @param aItem               The item to check.</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineplus">+     * @return                    Returns true if the item matches the filters, </span>
<a href="#l5.879"></a><span id="l5.879" class="difflineplus">+     *                            false otherwise.</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineplus">+     */     </span>
<a href="#l5.881"></a><span id="l5.881">     isItemInFilters: function cF_isItemInFilters(aItem) {</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineminus">-        return (this.isItemWithinRange(aItem) &amp;&amp; this.propertyFilter(aItem) &amp;&amp; this.textFilter(aItem));</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineplus">+        return (this.propertyFilter(aItem) &amp;&amp; this.textFilter(aItem));</span>
<a href="#l5.884"></a><span id="l5.884">     }</span>
<a href="#l5.885"></a><span id="l5.885"> };</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineminus">-</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineminus">-/**</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineminus">- * @param aFilter         a String describing the filter, it should met a regEx to call </span>
<a href="#l5.889"></a><span id="l5.889" class="difflineminus">- *                        duration from filter otherwise a costumized filter is called</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineminus">- * @param aSelectedDate   Optional - the selected date to use for filters that require it.</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineminus">- *                        The selected day of the current view will be used by default.</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineminus">- * @return        [startDate, endDate]</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineminus">- */</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineminus">-</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineminus">-function getDatesForFilter(aFilter, aSelectedDate) {</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineminus">-    let endDate = cal.createDateTime();</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineminus">-    let startDate = cal.createDateTime();</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineminus">-    let duration = cal.createDuration();</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineminus">-    let oneDay = cal.createDuration();</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineminus">-    oneDay.days = 1;</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineminus">-    let selectedDate = aSelectedDate || currentView().selectedDay;</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineminus">-</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineminus">-    let durFilterReg = /next|last\d+\D+$/</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineminus">-    if (durFilterReg.exec(aFilter)) {</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineminus">-        duration =  durationFromFilter(aFilter);</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineminus">-        if (!duration) {</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineminus">-            endDate = null;</span>
<a href="#l5.908"></a><span id="l5.908" class="difflineminus">-            startDate = null;</span>
<a href="#l5.909"></a><span id="l5.909" class="difflineminus">-        } else {</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineminus">-            startDate = cal.now();</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineminus">-            endDate = cal.now();</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineminus">-            endDate.addDuration(duration);</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineminus">-        }</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineminus">-    } else {</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineminus">-      switch (aFilter) {</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineminus">-        case &quot;all&quot;:</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineminus">-            startDate = null;</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineminus">-            endDate = null;</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineminus">-            break;</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineminus">-</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineminus">-        case &quot;today&quot;:</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineminus">-            startDate = cal.now();</span>
<a href="#l5.923"></a><span id="l5.923" class="difflineminus">-            startDate.isDate = true;</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineminus">-            endDate = cal.now();</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineminus">-            endDate.isDate = true;</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineminus">-            endDate.addDuration(oneDay);</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineminus">-            break;</span>
<a href="#l5.928"></a><span id="l5.928" class="difflineminus">-</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineminus">-        case &quot;thisCalendarMonth&quot;:</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineminus">-            startDate = cal.now().startOfMonth;</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineminus">-            endDate = cal.now().endOfMonth;</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineminus">-            endDate.addDuration(oneDay);</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineminus">-            break;</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineminus">-</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineminus">-        case &quot;future&quot;:</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineminus">-            startDate = cal.now();</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineminus">-            endDate = null;</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineminus">-            break;</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineminus">-</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineminus">-        case &quot;current&quot;:</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineminus">-            startDate = selectedDate ? selectedDate.clone() : cal.now();</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineminus">-            startDate.isDate = true;</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineminus">-            endDate = startDate.clone();</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineminus">-            endDate.addDuration(oneDay);</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineminus">-            break;</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineminus">-</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineminus">-        case &quot;currentview&quot;:</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineminus">-            startDate = currentView().startDay;</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineminus">-            endDate = currentView().endDay;</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineminus">-            break;</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineminus">-</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineminus">-        case &quot;throughcurrent&quot;:</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineminus">-        case &quot;open&quot;:</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineminus">-        case &quot;overdue&quot;:</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineminus">-        case &quot;completed&quot;:</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineminus">-        case &quot;notstarted&quot;:</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineminus">-            // use the later of the current date or the selected date of the current view</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineminus">-            endDate = selectedDate ? selectedDate.clone() : cal.now();</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineminus">-            if (endDate.jsDate &lt; cal.now().jsDate) {</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineminus">-                endDate = cal.now();</span>
<a href="#l5.961"></a><span id="l5.961" class="difflineminus">-            }</span>
<a href="#l5.962"></a><span id="l5.962" class="difflineminus">-            endDate.isDate = true;</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineminus">-            endDate.addDuration(oneDay);</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineminus">-            break;</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineminus">-</span>
<a href="#l5.966"></a><span id="l5.966" class="difflineminus">-        case &quot;throughtoday&quot;:</span>
<a href="#l5.967"></a><span id="l5.967" class="difflineminus">-            endDate = cal.now();</span>
<a href="#l5.968"></a><span id="l5.968" class="difflineminus">-            endDate.isDate = true;</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineminus">-            endDate.addDuration(oneDay);</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineminus">-            break;</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineminus">-</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineminus">-        case &quot;throughsevendays&quot;:</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineminus">-            let dur = cal.createDuration();</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineminus">-            dur.days = 8;</span>
<a href="#l5.975"></a><span id="l5.975" class="difflineminus">-            endDate = cal.now();</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineminus">-            endDate.isDate = true;</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineminus">-            endDate.addDuration(dur);</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineminus">-            break;</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineminus">-</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineminus">-        default:</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineminus">-            startDate = null;</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineminus">-            endDate = null;</span>
<a href="#l5.983"></a><span id="l5.983" class="difflineminus">-            break;</span>
<a href="#l5.984"></a><span id="l5.984" class="difflineminus">-      }</span>
<a href="#l5.985"></a><span id="l5.985" class="difflineminus">-    }</span>
<a href="#l5.986"></a><span id="l5.986" class="difflineminus">-    return [startDate, endDate];</span>
<a href="#l5.987"></a><span id="l5.987" class="difflineminus">-}</span>
<a href="#l5.988"></a><span id="l5.988" class="difflineminus">-</span>
<a href="#l5.989"></a><span id="l5.989" class="difflineminus">-/**</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineminus">- * Functions to create a duration based on a filter string.</span>
<a href="#l5.991"></a><span id="l5.991" class="difflineminus">- * </span>
<a href="#l5.992"></a><span id="l5.992" class="difflineminus">- * @param aFilter the filter string, it has has to match the pattern</span>
<a href="#l5.993"></a><span id="l5.993" class="difflineminus">- *                [last|next] Period [UnitOfThePeriod]</span>
<a href="#l5.994"></a><span id="l5.994" class="difflineminus">- * @return        the duration or null</span>
<a href="#l5.995"></a><span id="l5.995" class="difflineminus">- */</span>
<a href="#l5.996"></a><span id="l5.996" class="difflineminus">-function durationFromFilter(aFilter) {</span>
<a href="#l5.997"></a><span id="l5.997" class="difflineminus">-  var durReg = /(last|next)/</span>
<a href="#l5.998"></a><span id="l5.998" class="difflineminus">-  var periodReg = /(\d+)/</span>
<a href="#l5.999"></a><span id="l5.999" class="difflineminus">-  var unitReg = /\d+(\D+)$/</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineminus">-  try {</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineminus">-    // Create the direction of the duration</span>
<a href="#l5.1002"></a><span id="l5.1002" class="difflineminus">-    var modifier = (durReg.exec(aFilter)[1] == &quot;next&quot;) ? 1 : -1;</span>
<a href="#l5.1003"></a><span id="l5.1003" class="difflineminus">-</span>
<a href="#l5.1004"></a><span id="l5.1004" class="difflineminus">-    // Get the numerical value</span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineminus">-    var period = periodReg.exec(aFilter)[1];</span>
<a href="#l5.1006"></a><span id="l5.1006" class="difflineminus">-</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineminus">-    //Get the unit</span>
<a href="#l5.1008"></a><span id="l5.1008" class="difflineminus">-    var duration = createDuration();</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineminus">-    switch( unitReg.exec(aFilter)[1]) {</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineminus">-      case &quot;weeks&quot;:</span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineminus">-        duration.weeks = modifier*period;</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineminus">-        break;</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineminus">-      case &quot;days&quot;:</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineminus">-        duration.days = modifier*period;</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineminus">-        break;</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineminus">-      case &quot;hours&quot;:</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineminus">-        duration.hours = modifier*period;</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineminus">-        break;</span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineminus">-      default:</span>
<a href="#l5.1020"></a><span id="l5.1020" class="difflineminus">-        return null;</span>
<a href="#l5.1021"></a><span id="l5.1021" class="difflineminus">-    }</span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineminus">-    return duration;</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineminus">-  } catch(e) {</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineminus">-    dump(e);</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineminus">-    return null;</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineminus">-  }</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineminus">-}</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineminus">-</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineminus">-/**</span>
<a href="#l5.1030"></a><span id="l5.1030" class="difflineminus">- * @param aItem             Is a normal calIItemBase</span>
<a href="#l5.1031"></a><span id="l5.1031" class="difflineminus">- * @param mTextFilterField  Has to be set from the outside of the function</span>
<a href="#l5.1032"></a><span id="l5.1032" class="difflineminus">- * @return                  Filters if the item is contains the searchText</span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineminus">- */</span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineminus">-function filterByText(aItem) {</span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineminus">-    var searchText = document.getElementById(filterByText.mTextFilterField)</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineminus">-                             .value.toLowerCase();</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineminus">-</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineminus">-    if (!searchText.length || searchText.match(/^\s*$/)) {</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineminus">-        return true;</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineminus">-    }</span>
<a href="#l5.1041"></a><span id="l5.1041" class="difflineminus">-</span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineminus">-    const fieldsToSearch = [&quot;SUMMARY&quot;, &quot;DESCRIPTION&quot;, &quot;LOCATION&quot;, &quot;URL&quot;];</span>
<a href="#l5.1043"></a><span id="l5.1043" class="difflineminus">-</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineminus">-    for each (var field in fieldsToSearch) {</span>
<a href="#l5.1045"></a><span id="l5.1045" class="difflineminus">-        var val = aItem.getProperty(field);</span>
<a href="#l5.1046"></a><span id="l5.1046" class="difflineminus">-        if (val &amp;&amp; val.toLowerCase().indexOf(searchText) != -1) {</span>
<a href="#l5.1047"></a><span id="l5.1047" class="difflineminus">-            return true;</span>
<a href="#l5.1048"></a><span id="l5.1048" class="difflineminus">-        }</span>
<a href="#l5.1049"></a><span id="l5.1049" class="difflineminus">-    }</span>
<a href="#l5.1050"></a><span id="l5.1050" class="difflineminus">-</span>
<a href="#l5.1051"></a><span id="l5.1051" class="difflineminus">-    return aItem.getCategories({}).some(</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineminus">-        function someFunc(cat) {</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineminus">-            return (cat.toLowerCase().indexOf(searchText) != -1);</span>
<a href="#l5.1054"></a><span id="l5.1054" class="difflineminus">-        });</span>
<a href="#l5.1055"></a><span id="l5.1055" class="difflineminus">-}</span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineminus">-</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineminus">-function percentCompleted(item) {</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineminus">-    var percent = 0;</span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineminus">-    var property = item.getProperty(&quot;PERCENT-COMPLETE&quot;);</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineminus">-    if (property != null) {</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineminus">-        var percent = parseInt(property);</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineminus">-    }</span>
<a href="#l5.1063"></a><span id="l5.1063" class="difflineminus">-    return percent;</span>
<a href="#l5.1064"></a><span id="l5.1064" class="difflineminus">-} </span>
<a href="#l5.1065"></a><span id="l5.1065" class="difflineminus">-</span>
<a href="#l5.1066"></a><span id="l5.1066" class="difflineminus">-/**</span>
<a href="#l5.1067"></a><span id="l5.1067" class="difflineminus">- * Check if a task is still incomplete or was completed today.</span>
<a href="#l5.1068"></a><span id="l5.1068" class="difflineminus">- */</span>
<a href="#l5.1069"></a><span id="l5.1069" class="difflineminus">-function completionIsCurrent(aItem) {</span>
<a href="#l5.1070"></a><span id="l5.1070" class="difflineminus">-    // tasks not completed yet are still current</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineminus">-    if (!aItem.completedDate) {</span>
<a href="#l5.1072"></a><span id="l5.1072" class="difflineminus">-        return true;</span>
<a href="#l5.1073"></a><span id="l5.1073" class="difflineminus">-    }</span>
<a href="#l5.1074"></a><span id="l5.1074" class="difflineminus">-</span>
<a href="#l5.1075"></a><span id="l5.1075" class="difflineminus">-    // filter out tasks completed earlier than today</span>
<a href="#l5.1076"></a><span id="l5.1076" class="difflineminus">-    let today = cal.now();</span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineminus">-    today.isDate = true;</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineminus">-</span>
<a href="#l5.1079"></a><span id="l5.1079" class="difflineminus">-    return (today.compare(aItem.completedDate) &lt;= 0);</span>
<a href="#l5.1080"></a><span id="l5.1080" class="difflineminus">-}</span>
<a href="#l5.1081"></a><span id="l5.1081" class="difflineminus">-</span>
<a href="#l5.1082"></a><span id="l5.1082" class="difflineminus">-function filterAll(aItem) {</span>
<a href="#l5.1083"></a><span id="l5.1083" class="difflineminus">-    return true;</span>
<a href="#l5.1084"></a><span id="l5.1084" class="difflineminus">-}</span>
<a href="#l5.1085"></a><span id="l5.1085" class="difflineminus">-</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

