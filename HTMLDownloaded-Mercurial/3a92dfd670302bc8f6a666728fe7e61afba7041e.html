<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24917:3a92dfd670302bc8f6a666728fe7e61afba7041e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 3a92dfd670302bc8f6a666728fe7e61afba7041e" />
<meta property="og:url" content="/comm-central/rev/3a92dfd670302bc8f6a666728fe7e61afba7041e" />
<meta property="og:description" content="Bug 1478572 - Turn on ESLint in mail/components/search. r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 3a92dfd670302bc8f6a666728fe7e61afba7041e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/3a92dfd670302bc8f6a666728fe7e61afba7041e">shortlog</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/3a92dfd670302bc8f6a666728fe7e61afba7041e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e">files</a> |
changeset |
<a href="/comm-central/raw-rev/3a92dfd670302bc8f6a666728fe7e61afba7041e">raw</a>  | <a href="/comm-central/archive/3a92dfd670302bc8f6a666728fe7e61afba7041e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/search. r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 07 Oct 2018 00:01:20 +1300</td></tr>

<tr>
 <td>changeset 24917</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/3a92dfd670302bc8f6a666728fe7e61afba7041e">3a92dfd670302bc8f6a666728fe7e61afba7041e</a></td>
</tr>



<tr>
<td>parent 24916</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/da7cae0efc9d380eae26d9ef2f1b571bf8fcf811">da7cae0efc9d380eae26d9ef2f1b571bf8fcf811</a>
</td>
</tr>

<tr>
<td>child 24918</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/66a106452d933ed5485af880731cf83918fe47da">66a106452d933ed5485af880731cf83918fe47da</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=3a92dfd670302bc8f6a666728fe7e61afba7041e">14982</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 07 Oct 2018 22:33:12 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@3a92dfd67030 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3a92dfd670302bc8f6a666728fe7e61afba7041e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3a92dfd670302bc8f6a666728fe7e61afba7041e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3a92dfd670302bc8f6a666728fe7e61afba7041e&newProject=comm-central&newRevision=d3a3e12d2654959356b71569177b6ede3790fd9e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3a92dfd670302bc8f6a666728fe7e61afba7041e&newProject=comm-central&newRevision=d3a3e12d2654959356b71569177b6ede3790fd9e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3a92dfd670302bc8f6a666728fe7e61afba7041e&newProject=comm-central&newRevision=d3a3e12d2654959356b71569177b6ede3790fd9e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">1478572</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/search. r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/.eslintignore">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/.eslintignore">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/.eslintignore">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/.eslintignore">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/systemIntegrationDialog.js">mail/base/content/systemIntegrationDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/systemIntegrationDialog.js">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/systemIntegrationDialog.js">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/systemIntegrationDialog.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/systemIntegrationDialog.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/base/content/systemIntegrationDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/nsMailDefaultHandler.js">mail/components/nsMailDefaultHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/nsMailDefaultHandler.js">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/nsMailDefaultHandler.js">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/nsMailDefaultHandler.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/nsMailDefaultHandler.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/nsMailDefaultHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/preferences/advanced.js">mail/components/preferences/advanced.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/preferences/advanced.js">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/preferences/advanced.js">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/preferences/advanced.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/preferences/advanced.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/preferences/advanced.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.js">mail/components/search/SearchIntegration.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.jsm">mail/components/search/SearchIntegration.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.jsm">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.jsm">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.jsm">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.jsm">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SearchIntegration.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SpotlightIntegration.js">mail/components/search/SpotlightIntegration.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SpotlightIntegration.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SpotlightIntegration.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/SpotlightIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/WinSearchIntegration.js">mail/components/search/WinSearchIntegration.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/WinSearchIntegration.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/WinSearchIntegration.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/WinSearchIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/SpotlightIntegration.js">mail/components/search/content/SpotlightIntegration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/SpotlightIntegration.js">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/SpotlightIntegration.js">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/SpotlightIntegration.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/SpotlightIntegration.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/SpotlightIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/WinSearchIntegration.js">mail/components/search/content/WinSearchIntegration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/WinSearchIntegration.js">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/WinSearchIntegration.js">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/WinSearchIntegration.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/WinSearchIntegration.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/content/WinSearchIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/jar.mn">mail/components/search/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/jar.mn">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/jar.mn">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/jar.mn">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/jar.mn">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/moz.build">mail/components/search/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/moz.build">file</a> |
<a href="/comm-central/annotate/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/moz.build">annotate</a> |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/moz.build">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/moz.build">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/searchCommon.js">mail/components/search/searchCommon.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/searchCommon.js">diff</a> |
<a href="/comm-central/comparison/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/searchCommon.js">comparison</a> |
<a href="/comm-central/log/3a92dfd670302bc8f6a666728fe7e61afba7041e/mail/components/search/searchCommon.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -46,17 +46,16 @@ mailnews/test/*</span>
<a href="#l1.4"></a><span id="l1.4"> # mailnews/extensions exclusions</span>
<a href="#l1.5"></a><span id="l1.5"> mailnews/extensions/*</span>
<a href="#l1.6"></a><span id="l1.6"> !mailnews/extensions/newsblog</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # mail exclusions</span>
<a href="#l1.9"></a><span id="l1.9"> mail/app/**</span>
<a href="#l1.10"></a><span id="l1.10"> mail/base/**</span>
<a href="#l1.11"></a><span id="l1.11"> mail/branding/**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mail/components/search/**</span>
<a href="#l1.13"></a><span id="l1.13"> mail/config/**</span>
<a href="#l1.14"></a><span id="l1.14"> mail/extensions/**</span>
<a href="#l1.15"></a><span id="l1.15"> mail/installer/**</span>
<a href="#l1.16"></a><span id="l1.16"> mail/locales/**</span>
<a href="#l1.17"></a><span id="l1.17"> mail/test/**</span>
<a href="#l1.18"></a><span id="l1.18"> mail/themes/**</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> # prefs files</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -514,17 +514,17 @@ function LoadPostAccountWizard()</span>
<a href="#l2.4"></a><span id="l2.4">       var defaultAccount;</span>
<a href="#l2.5"></a><span id="l2.5">       try {</span>
<a href="#l2.6"></a><span id="l2.6">         shellService = Cc[&quot;@mozilla.org/mail/shell-service;1&quot;].getService(nsIShellService);</span>
<a href="#l2.7"></a><span id="l2.7">         defaultAccount = accountManager.defaultAccount;</span>
<a href="#l2.8"></a><span id="l2.8">       } catch (ex) {}</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">       // Next, try loading the search integration module</span>
<a href="#l2.11"></a><span id="l2.11">       // We'll get a null SearchIntegration if we don't have one</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      ChromeUtils.import(&quot;resource:///modules/SearchIntegration.js&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      ChromeUtils.import(&quot;resource:///modules/SearchIntegration.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">       // Show the default client dialog only if</span>
<a href="#l2.16"></a><span id="l2.16">       // EITHER: we have at least one account, and we aren't already the default</span>
<a href="#l2.17"></a><span id="l2.17">       // for mail,</span>
<a href="#l2.18"></a><span id="l2.18">       // OR: we have the search integration module, the OS version is suitable,</span>
<a href="#l2.19"></a><span id="l2.19">       // and the first run hasn't already been completed.</span>
<a href="#l2.20"></a><span id="l2.20">       // Needs to be shown outside the he normal load sequence so it doesn't appear</span>
<a href="#l2.21"></a><span id="l2.21">       // before any other displays, in the wrong place of the screen.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/systemIntegrationDialog.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/systemIntegrationDialog.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -19,17 +19,17 @@ var gSystemIntegrationDialog = {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   _searchCheckbox: null,</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   onLoad: function()</span>
<a href="#l3.8"></a><span id="l3.8">   {</span>
<a href="#l3.9"></a><span id="l3.9">     // Makes Services and SearchIntegration accessible via this.Services</span>
<a href="#l3.10"></a><span id="l3.10">     // and this.SearchIntegration.</span>
<a href="#l3.11"></a><span id="l3.11">     ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    ChromeUtils.import(&quot;resource:///modules/SearchIntegration.js&quot;, this);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    ChromeUtils.import(&quot;resource:///modules/SearchIntegration.jsm&quot;, this);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">     // initialize elements</span>
<a href="#l3.16"></a><span id="l3.16">     this._mailCheckbox    = document.getElementById(&quot;checkMail&quot;);</span>
<a href="#l3.17"></a><span id="l3.17">     this._newsCheckbox    = document.getElementById(&quot;checkNews&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">     this._rssCheckbox     = document.getElementById(&quot;checkRSS&quot;);</span>
<a href="#l3.19"></a><span id="l3.19">     this._startupCheckbox = document.getElementById(&quot;checkOnStartup&quot;);</span>
<a href="#l3.20"></a><span id="l3.20">     this._searchCheckbox  = document.getElementById(&quot;searchIntegration&quot;);</span>
<a href="#l3.21"></a><span id="l3.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/nsMailDefaultHandler.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/nsMailDefaultHandler.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -40,17 +40,17 @@ function resolveURIInternal(aCmdLine, aA</span>
<a href="#l4.4"></a><span id="l4.4"> function handleIndexerResult(aFile) {</span>
<a href="#l4.5"></a><span id="l4.5">   // Do this here because xpcshell isn't too happy with this at startup</span>
<a href="#l4.6"></a><span id="l4.6">   ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l4.7"></a><span id="l4.7">   // Make sure the folder tree is initialized</span>
<a href="#l4.8"></a><span id="l4.8">   MailUtils.discoverFolders();</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">   // Use the search integration module to convert the indexer result into a</span>
<a href="#l4.11"></a><span id="l4.11">   // message header</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/SearchIntegration.js&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/SearchIntegration.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14">   let msgHdr = SearchIntegration.handleResult(aFile);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">   // If we found a message header, open it, otherwise throw an exception</span>
<a href="#l4.17"></a><span id="l4.17">   if (msgHdr)</span>
<a href="#l4.18"></a><span id="l4.18">     MailUtils.displayMessage(msgHdr);</span>
<a href="#l4.19"></a><span id="l4.19">   else</span>
<a href="#l4.20"></a><span id="l4.20">     throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l4.21"></a><span id="l4.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/preferences/advanced.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/preferences/advanced.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -50,17 +50,17 @@ var gAdvancedPane = {</span>
<a href="#l5.4"></a><span id="l5.4">     if (AppConstants.MOZ_CRASHREPORTER)</span>
<a href="#l5.5"></a><span id="l5.5">       this.initSubmitCrashes();</span>
<a href="#l5.6"></a><span id="l5.6">     this.initTelemetry();</span>
<a href="#l5.7"></a><span id="l5.7">     this.updateActualCacheSize();</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">     // Search integration -- check whether we should hide or disable integration</span>
<a href="#l5.10"></a><span id="l5.10">     let hideSearchUI = false;</span>
<a href="#l5.11"></a><span id="l5.11">     let disableSearchUI = false;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    ChromeUtils.import(&quot;resource:///modules/SearchIntegration.js&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    ChromeUtils.import(&quot;resource:///modules/SearchIntegration.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14">     if (SearchIntegration) {</span>
<a href="#l5.15"></a><span id="l5.15">       if (SearchIntegration.osVersionTooLow)</span>
<a href="#l5.16"></a><span id="l5.16">         hideSearchUI = true;</span>
<a href="#l5.17"></a><span id="l5.17">       else if (SearchIntegration.osComponentsNotRunning)</span>
<a href="#l5.18"></a><span id="l5.18">         disableSearchUI = true;</span>
<a href="#l5.19"></a><span id="l5.19">     } else {</span>
<a href="#l5.20"></a><span id="l5.20">       hideSearchUI = true;</span>
<a href="#l5.21"></a><span id="l5.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mail/components/search/SearchIntegration.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,20 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;SearchIntegration&quot;];</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/WinSearchIntegration.js&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-#else</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/SpotlightIntegration.js&quot;);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-#else</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-// Set SearchIntegration to null, as we don't have it</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-var SearchIntegration = null;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-#endif</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">rename from mail/components/search/searchCommon.js</span>
<a href="#l7.2"></a><span id="l7.2">rename to mail/components/search/SearchIntegration.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineminus">--- a/mail/components/search/searchCommon.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineplus">+++ b/mail/components/search/SearchIntegration.jsm</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineat">@@ -1,81 +1,75 @@</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-#if 0</span>
<a href="#l7.7"></a><span id="l7.7"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.8"></a><span id="l7.8"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.9"></a><span id="l7.9">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.10"></a><span id="l7.10">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12"> /*</span>
<a href="#l7.13"></a><span id="l7.13">  * Common, useful functions for desktop search integration components.</span>
<a href="#l7.14"></a><span id="l7.14">  *</span>
<a href="#l7.15"></a><span id="l7.15">  * The following symbols have to be defined for each component that includes this:</span>
<a href="#l7.16"></a><span id="l7.16">  * - gHdrIndexedProperty: the property in the database that indicates whether a message</span>
<a href="#l7.17"></a><span id="l7.17">  *   has been indexed</span>
<a href="#l7.18"></a><span id="l7.18">  * - gFileExt: the file extension to be used for support files</span>
<a href="#l7.19"></a><span id="l7.19">  * - gPrefBase: the base for preferences that are stored</span>
<a href="#l7.20"></a><span id="l7.20">  * - gStreamListener: an nsIStreamListener to read message text</span>
<a href="#l7.21"></a><span id="l7.21">  */</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-#endif</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+/* exported SearchSupport */</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;SearchIntegration&quot;];</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+var { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l7.33"></a><span id="l7.33"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l7.35"></a><span id="l7.35"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-var PERM_DIRECTORY = parseInt(&quot;0755&quot;, 8);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-var PERM_FILE = parseInt(&quot;0644&quot;, 8);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+var PERM_DIRECTORY = 0o755;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+var PERM_FILE = 0o644;</span>
<a href="#l7.41"></a><span id="l7.41"> </span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-var SearchSupport =</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-{</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+var SearchIntegration = null;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+var SearchSupport = {</span>
<a href="#l7.47"></a><span id="l7.47">   /**</span>
<a href="#l7.48"></a><span id="l7.48">    * URI of last folder indexed. Kept in sync with the pref</span>
<a href="#l7.49"></a><span id="l7.49">    */</span>
<a href="#l7.50"></a><span id="l7.50">   __lastFolderIndexedUri: null,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  set _lastFolderIndexedUri(uri)</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  {</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  set _lastFolderIndexedUri(uri) {</span>
<a href="#l7.54"></a><span id="l7.54">     this._prefBranch.setCharPref(&quot;lastFolderIndexedUri&quot;, uri);</span>
<a href="#l7.55"></a><span id="l7.55">     this.__lastFolderIndexedUri = uri;</span>
<a href="#l7.56"></a><span id="l7.56">   },</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  get _lastFolderIndexedUri()</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  get _lastFolderIndexedUri() {</span>
<a href="#l7.60"></a><span id="l7.60">     // If we don't know about it, get it from the pref branch</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-    if (this.__lastFolderIndexedUri === null)</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-      this.__lastFolderIndexedUri = &quot;&quot;;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-      try {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-        this.__lastFolderIndexedUri =</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-          this._prefBranch.getCharPref(&quot;lastFolderIndexedUri&quot;);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    if (this.__lastFolderIndexedUri === null) {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+      this.__lastFolderIndexedUri = this._prefBranch.getCharPref(&quot;lastFolderIndexedUri&quot;, &quot;&quot;);</span>
<a href="#l7.70"></a><span id="l7.70">     }</span>
<a href="#l7.71"></a><span id="l7.71">     return this.__lastFolderIndexedUri;</span>
<a href="#l7.72"></a><span id="l7.72">   },</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74">   /**</span>
<a href="#l7.75"></a><span id="l7.75">    * Queue of message headers to index, along with reindex times for each header</span>
<a href="#l7.76"></a><span id="l7.76">    */</span>
<a href="#l7.77"></a><span id="l7.77">   _msgHdrsToIndex: [],</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79">   /**</span>
<a href="#l7.80"></a><span id="l7.80">    * Messenger object, used primarily to get message URIs</span>
<a href="#l7.81"></a><span id="l7.81">    */</span>
<a href="#l7.82"></a><span id="l7.82">   __messenger: null,</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-  get _messenger()</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  get _messenger() {</span>
<a href="#l7.86"></a><span id="l7.86">     if (!this.__messenger)</span>
<a href="#l7.87"></a><span id="l7.87">       this.__messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l7.88"></a><span id="l7.88">                          .createInstance(Ci.nsIMessenger);</span>
<a href="#l7.89"></a><span id="l7.89">     return this.__messenger;</span>
<a href="#l7.90"></a><span id="l7.90">   },</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-  /// The preferences branch to use</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  // The preferences branch to use</span>
<a href="#l7.94"></a><span id="l7.94">   __prefBranch: null,</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-  get _prefBranch()</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-  {</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  get _prefBranch() {</span>
<a href="#l7.98"></a><span id="l7.98">     if (!this.__prefBranch)</span>
<a href="#l7.99"></a><span id="l7.99">       this.__prefBranch = Services.prefs.getBranch(this._prefBase);</span>
<a href="#l7.100"></a><span id="l7.100">     return this.__prefBranch;</span>
<a href="#l7.101"></a><span id="l7.101">   },</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103">   /**</span>
<a href="#l7.104"></a><span id="l7.104">    * If this is true, we won't show any UI because the OS doesn't have the</span>
<a href="#l7.105"></a><span id="l7.105">    * support we need</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineat">@@ -87,63 +81,54 @@ var SearchSupport =</span>
<a href="#l7.107"></a><span id="l7.107">    * the support we need, not all the OS components we need are running</span>
<a href="#l7.108"></a><span id="l7.108">    */</span>
<a href="#l7.109"></a><span id="l7.109">   osComponentsNotRunning: false,</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">   /**</span>
<a href="#l7.112"></a><span id="l7.112">    * Whether the preference is enabled. The module might be in a state where</span>
<a href="#l7.113"></a><span id="l7.113">    * the preference is on but &quot;enabled&quot; is false, so take care of that.</span>
<a href="#l7.114"></a><span id="l7.114">    */</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-  get prefEnabled()</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-  {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  get prefEnabled() {</span>
<a href="#l7.118"></a><span id="l7.118">     // Don't cache the value</span>
<a href="#l7.119"></a><span id="l7.119">     return this._prefBranch.getBoolPref(&quot;enable&quot;);</span>
<a href="#l7.120"></a><span id="l7.120">   },</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  set prefEnabled(aEnabled)</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-  {</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  set prefEnabled(aEnabled) {</span>
<a href="#l7.124"></a><span id="l7.124">     if (this.prefEnabled != aEnabled)</span>
<a href="#l7.125"></a><span id="l7.125">       this._prefBranch.setBoolPref(&quot;enable&quot;, aEnabled);</span>
<a href="#l7.126"></a><span id="l7.126">   },</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128">   /**</span>
<a href="#l7.129"></a><span id="l7.129">    * Whether the first run has occurred. This will be used to determine if</span>
<a href="#l7.130"></a><span id="l7.130">    * a dialog box needs to be displayed.</span>
<a href="#l7.131"></a><span id="l7.131">    */</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-  get firstRunDone()</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-  {</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  get firstRunDone() {</span>
<a href="#l7.135"></a><span id="l7.135">     // Don't cache this value either</span>
<a href="#l7.136"></a><span id="l7.136">     return this._prefBranch.getBoolPref(&quot;firstRunDone&quot;);</span>
<a href="#l7.137"></a><span id="l7.137">   },</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-  set firstRunDone(aAlwaysTrue)</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-  {</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  set firstRunDone(aAlwaysTrue) {</span>
<a href="#l7.141"></a><span id="l7.141">     this._prefBranch.setBoolPref(&quot;firstRunDone&quot;, true);</span>
<a href="#l7.142"></a><span id="l7.142">   },</span>
<a href="#l7.143"></a><span id="l7.143"> </span>
<a href="#l7.144"></a><span id="l7.144">   /**</span>
<a href="#l7.145"></a><span id="l7.145">    * Last global reindex time, used to check if reindexing is required.</span>
<a href="#l7.146"></a><span id="l7.146">    * Kept in sync with the pref</span>
<a href="#l7.147"></a><span id="l7.147">    */</span>
<a href="#l7.148"></a><span id="l7.148">   _globalReindexTime: null,</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  set globalReindexTime(aTime)</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  {</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  set globalReindexTime(aTime) {</span>
<a href="#l7.152"></a><span id="l7.152">     this._globalReindexTime = aTime;</span>
<a href="#l7.153"></a><span id="l7.153">     // Set the pref as well</span>
<a href="#l7.154"></a><span id="l7.154">     this._prefBranch.setCharPref(&quot;global_reindex_time&quot;, &quot;&quot; + aTime);</span>
<a href="#l7.155"></a><span id="l7.155">   },</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  get globalReindexTime()</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-  {</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-    if (!this._globalReindexTime)</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-    {</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  get globalReindexTime() {</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    if (!this._globalReindexTime) {</span>
<a href="#l7.162"></a><span id="l7.162">       // Try getting the time from the preferences</span>
<a href="#l7.163"></a><span id="l7.163">       try {</span>
<a href="#l7.164"></a><span id="l7.164">         this._globalReindexTime = parseInt(this._prefBranch</span>
<a href="#l7.165"></a><span id="l7.165">                                     .getCharPref(&quot;global_reindex_time&quot;));</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-      }</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-      catch (e)</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-      {</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+      } catch (e) {</span>
<a href="#l7.170"></a><span id="l7.170">         // We don't have it defined, so set it (Unix time, in seconds)</span>
<a href="#l7.171"></a><span id="l7.171">         this._globalReindexTime = parseInt(Date.now() / 1000);</span>
<a href="#l7.172"></a><span id="l7.172">         this._prefBranch.setCharPref(&quot;global_reindex_time&quot;,</span>
<a href="#l7.173"></a><span id="l7.173">                                      &quot;&quot; + this._globalReindexTime);</span>
<a href="#l7.174"></a><span id="l7.174">       }</span>
<a href="#l7.175"></a><span id="l7.175">     }</span>
<a href="#l7.176"></a><span id="l7.176">     return this._globalReindexTime;</span>
<a href="#l7.177"></a><span id="l7.177">   },</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineat">@@ -152,118 +137,109 @@ var SearchSupport =</span>
<a href="#l7.179"></a><span id="l7.179">    * Amount of time the user is idle before we (re)start an indexing sweep</span>
<a href="#l7.180"></a><span id="l7.180">    */</span>
<a href="#l7.181"></a><span id="l7.181">   _idleThresholdSecs: 30,</span>
<a href="#l7.182"></a><span id="l7.182"> </span>
<a href="#l7.183"></a><span id="l7.183">   /**</span>
<a href="#l7.184"></a><span id="l7.184">    * Reference to timer object</span>
<a href="#l7.185"></a><span id="l7.185">    */</span>
<a href="#l7.186"></a><span id="l7.186">   __timer: null,</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-  get _timer()</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-  {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  get _timer() {</span>
<a href="#l7.190"></a><span id="l7.190">     if (!this.__timer)</span>
<a href="#l7.191"></a><span id="l7.191">       this.__timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l7.192"></a><span id="l7.192">     return this.__timer;</span>
<a href="#l7.193"></a><span id="l7.193">   },</span>
<a href="#l7.194"></a><span id="l7.194"> </span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-  _cancelTimer: function()</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  {</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  _cancelTimer() {</span>
<a href="#l7.198"></a><span id="l7.198">     try {</span>
<a href="#l7.199"></a><span id="l7.199">       this._timer.cancel();</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-    }</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-    catch (ex) {}</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l7.203"></a><span id="l7.203">   },</span>
<a href="#l7.204"></a><span id="l7.204"> </span>
<a href="#l7.205"></a><span id="l7.205">   /**</span>
<a href="#l7.206"></a><span id="l7.206">    * Enabled status.</span>
<a href="#l7.207"></a><span id="l7.207">    *</span>
<a href="#l7.208"></a><span id="l7.208">    * When we're enabled, then we get notifications about every message or folder</span>
<a href="#l7.209"></a><span id="l7.209">    * operation, including &quot;message displayed&quot; operations which we bump up in</span>
<a href="#l7.210"></a><span id="l7.210">    * priority. We also have a background sweep which we do on idle.</span>
<a href="#l7.211"></a><span id="l7.211">    *</span>
<a href="#l7.212"></a><span id="l7.212">    * We aren't fully disabled when we're &quot;disabled&quot;, though. We still observe</span>
<a href="#l7.213"></a><span id="l7.213">    * message and folder moves and deletes, as we don't want to have support</span>
<a href="#l7.214"></a><span id="l7.214">    * files for non-existent messages.</span>
<a href="#l7.215"></a><span id="l7.215">    */</span>
<a href="#l7.216"></a><span id="l7.216">   _enabled: null,</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-  set enabled(aEnable)</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-  {</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+  set enabled(aEnable) {</span>
<a href="#l7.220"></a><span id="l7.220">     // Nothing to do if there's no change in state</span>
<a href="#l7.221"></a><span id="l7.221">     if (this._enabled == aEnable)</span>
<a href="#l7.222"></a><span id="l7.222">       return;</span>
<a href="#l7.223"></a><span id="l7.223"> </span>
<a href="#l7.224"></a><span id="l7.224">     this._log.info(&quot;Enabled status changing from &quot; + this._enabled + &quot; to &quot; +</span>
<a href="#l7.225"></a><span id="l7.225">                    aEnable);</span>
<a href="#l7.226"></a><span id="l7.226"> </span>
<a href="#l7.227"></a><span id="l7.227">     this._removeObservers();</span>
<a href="#l7.228"></a><span id="l7.228"> </span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-    if (aEnable)</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-    {</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+    if (aEnable) {</span>
<a href="#l7.232"></a><span id="l7.232">       // This stuff we always need to do</span>
<a href="#l7.233"></a><span id="l7.233">       MailServices.mfn.addListener(this._msgFolderListener,</span>
<a href="#l7.234"></a><span id="l7.234">         MailServices.mfn.msgAdded |</span>
<a href="#l7.235"></a><span id="l7.235">         MailServices.mfn.msgsDeleted |</span>
<a href="#l7.236"></a><span id="l7.236">         MailServices.mfn.msgsMoveCopyCompleted |</span>
<a href="#l7.237"></a><span id="l7.237">         // this code pre-dates msgsClassified</span>
<a href="#l7.238"></a><span id="l7.238">         // folderAdded intentionally omitted</span>
<a href="#l7.239"></a><span id="l7.239">         MailServices.mfn.folderDeleted |</span>
<a href="#l7.240"></a><span id="l7.240">         MailServices.mfn.folderMoveCopyCompleted |</span>
<a href="#l7.241"></a><span id="l7.241">         MailServices.mfn.folderRenamed);</span>
<a href="#l7.242"></a><span id="l7.242">         // itemEvent intentionally omitted</span>
<a href="#l7.243"></a><span id="l7.243">       Services.obs.addObserver(this, &quot;MsgMsgDisplayed&quot;);</span>
<a href="#l7.244"></a><span id="l7.244">       let idleService = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;]</span>
<a href="#l7.245"></a><span id="l7.245">                           .getService(Ci.nsIIdleService);</span>
<a href="#l7.246"></a><span id="l7.246">       idleService.addIdleObserver(this, this._idleThresholdSecs);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-    }</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-    else</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+    } else {</span>
<a href="#l7.250"></a><span id="l7.250">       // We want to observe moves, deletes and renames in case we're disabled</span>
<a href="#l7.251"></a><span id="l7.251">       // If we don't, we'll have no idea the support files exist later</span>
<a href="#l7.252"></a><span id="l7.252">       MailServices.mfn.addListener(this._msgFolderListener,</span>
<a href="#l7.253"></a><span id="l7.253">         MailServices.mfn.msgsMoveCopyCompleted |</span>
<a href="#l7.254"></a><span id="l7.254">         MailServices.mfn.msgsDeleted |</span>
<a href="#l7.255"></a><span id="l7.255">         // folderAdded intentionally omitted</span>
<a href="#l7.256"></a><span id="l7.256">         MailServices.mfn.folderDeleted |</span>
<a href="#l7.257"></a><span id="l7.257">         MailServices.mfn.folderMoveCopyCompleted |</span>
<a href="#l7.258"></a><span id="l7.258">         MailServices.mfn.folderRenamed);</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+    }</span>
<a href="#l7.260"></a><span id="l7.260"> </span>
<a href="#l7.261"></a><span id="l7.261">     this._enabled = aEnable;</span>
<a href="#l7.262"></a><span id="l7.262">   },</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-  get enabled()</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-  {</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+  get enabled() {</span>
<a href="#l7.266"></a><span id="l7.266">     return this._enabled;</span>
<a href="#l7.267"></a><span id="l7.267">   },</span>
<a href="#l7.268"></a><span id="l7.268"> </span>
<a href="#l7.269"></a><span id="l7.269">   /**</span>
<a href="#l7.270"></a><span id="l7.270">    * Remove whatever observers are present. This is done while switching states</span>
<a href="#l7.271"></a><span id="l7.271">    */</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-  _removeObservers: function()</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-  {</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+  _removeObservers() {</span>
<a href="#l7.275"></a><span id="l7.275">     if (this.enabled === null)</span>
<a href="#l7.276"></a><span id="l7.276">       return;</span>
<a href="#l7.277"></a><span id="l7.277"> </span>
<a href="#l7.278"></a><span id="l7.278">     MailServices.mfn.removeListener(this._msgFolderListener);</span>
<a href="#l7.279"></a><span id="l7.279"> </span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-    if (this.enabled)</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-    {</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-      Services.obs.removeObserver(this, &quot;MsgMsgDisplayed&quot;, false);</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+    if (this.enabled) {</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+      Services.obs.removeObserver(this, &quot;MsgMsgDisplayed&quot;);</span>
<a href="#l7.285"></a><span id="l7.285">       let idleService = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;]</span>
<a href="#l7.286"></a><span id="l7.286">                           .getService(Ci.nsIIdleService);</span>
<a href="#l7.287"></a><span id="l7.287">       idleService.removeIdleObserver(this, this._idleThresholdSecs);</span>
<a href="#l7.288"></a><span id="l7.288"> </span>
<a href="#l7.289"></a><span id="l7.289">       // in case there's a background sweep going on</span>
<a href="#l7.290"></a><span id="l7.290">       this._cancelTimer();</span>
<a href="#l7.291"></a><span id="l7.291">     }</span>
<a href="#l7.292"></a><span id="l7.292">     // We don't need to do anything extra if we're disabled</span>
<a href="#l7.293"></a><span id="l7.293">   },</span>
<a href="#l7.294"></a><span id="l7.294"> </span>
<a href="#l7.295"></a><span id="l7.295">   /**</span>
<a href="#l7.296"></a><span id="l7.296">    * Init function -- this should be called from the component's init function</span>
<a href="#l7.297"></a><span id="l7.297">    */</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-  _initSupport: function search_init_support(enabled)</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-  {</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+  _initSupport(enabled) {</span>
<a href="#l7.301"></a><span id="l7.301">     this._log.info(&quot;Search integration running in &quot; +</span>
<a href="#l7.302"></a><span id="l7.302">                    (enabled ? &quot;active&quot; : &quot;backoff&quot;) + &quot; mode&quot;);</span>
<a href="#l7.303"></a><span id="l7.303">     this.enabled = enabled;</span>
<a href="#l7.304"></a><span id="l7.304"> </span>
<a href="#l7.305"></a><span id="l7.305">     // Set up a pref observer</span>
<a href="#l7.306"></a><span id="l7.306">     this._prefBranch.addObserver(&quot;enable&quot;, this);</span>
<a href="#l7.307"></a><span id="l7.307">   },</span>
<a href="#l7.308"></a><span id="l7.308"> </span>
<a href="#l7.309"></a><span id="l7.309" class="difflineat">@@ -291,65 +267,56 @@ var SearchSupport =</span>
<a href="#l7.310"></a><span id="l7.310">    *</span>
<a href="#l7.311"></a><span id="l7.311">    * Next, it looks for the next folder after the lastFolderIndexedUri. If it is</span>
<a href="#l7.312"></a><span id="l7.312">    * in such a folder, it'll yield return that folder, then set the</span>
<a href="#l7.313"></a><span id="l7.313">    * lastFolderIndexedUrl to the URI of that folder.</span>
<a href="#l7.314"></a><span id="l7.314">    *</span>
<a href="#l7.315"></a><span id="l7.315">    * It resets lastFolderIndexedUri to an empty string, then yield returns null</span>
<a href="#l7.316"></a><span id="l7.316">    * once iteration across all folders is complete.</span>
<a href="#l7.317"></a><span id="l7.317">    */</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-  _foldersToIndexGenerator: function* search_find_next_folder()</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-  {</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+  _foldersToIndexGenerator: function* search_find_next_folder() {</span>
<a href="#l7.321"></a><span id="l7.321">     let servers = MailServices.accounts.allServers;</span>
<a href="#l7.322"></a><span id="l7.322"> </span>
<a href="#l7.323"></a><span id="l7.323">     // Stores whether we're after the last folder indexed or before that --</span>
<a href="#l7.324"></a><span id="l7.324">     // if the last folder indexed is empty, this needs to be true initially</span>
<a href="#l7.325"></a><span id="l7.325">     let afterLastFolderIndexed = (this._lastFolderIndexedUri.length == 0);</span>
<a href="#l7.326"></a><span id="l7.326"> </span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-    for (var server of fixIterator(servers, Ci.nsIMsgIncomingServer))</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-    {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+    for (var server of fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l7.330"></a><span id="l7.330">       let allFolders = server.rootFolder.descendants;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-      let numFolders = allFolders.length;</span>
<a href="#l7.332"></a><span id="l7.332">       this._log.debug(&quot;in find next folder, lastFolderIndexedUri = &quot; +</span>
<a href="#l7.333"></a><span id="l7.333">                       this._lastFolderIndexedUri);</span>
<a href="#l7.334"></a><span id="l7.334"> </span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-      for (var folder of fixIterator(allFolders, Ci.nsIMsgFolder))</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-      {</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+      for (var folder of fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l7.338"></a><span id="l7.338">         let searchPath = this._getSearchPathForFolder(folder);</span>
<a href="#l7.339"></a><span id="l7.339">         searchPath.leafName = searchPath.leafName + &quot;.mozmsgs&quot;;</span>
<a href="#l7.340"></a><span id="l7.340">         // If after the last folder indexed, definitely index this</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-        if (afterLastFolderIndexed)</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-        {</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+        if (afterLastFolderIndexed) {</span>
<a href="#l7.344"></a><span id="l7.344">           // Create the folder if it doesn't exist, so that we don't hit the</span>
<a href="#l7.345"></a><span id="l7.345">           // condition below later</span>
<a href="#l7.346"></a><span id="l7.346">           if (!searchPath.exists())</span>
<a href="#l7.347"></a><span id="l7.347">             searchPath.create(Ci.nsIFile.DIRECTORY_TYPE, PERM_DIRECTORY);</span>
<a href="#l7.348"></a><span id="l7.348"> </span>
<a href="#l7.349"></a><span id="l7.349">           yield folder;</span>
<a href="#l7.350"></a><span id="l7.350">           // We're back after yielding -- set the last folder indexed</span>
<a href="#l7.351"></a><span id="l7.351">           this._lastFolderIndexedUri = folder.URI;</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-        }</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-        else</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-        {</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+        } else {</span>
<a href="#l7.356"></a><span id="l7.356">           // If a folder's entire corresponding search results folder is</span>
<a href="#l7.357"></a><span id="l7.357">           // missing, we need to index it, and force a reindex of all the</span>
<a href="#l7.358"></a><span id="l7.358">           // messages in it</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-          if (!searchPath.exists())</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-          {</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+          if (!searchPath.exists()) {</span>
<a href="#l7.362"></a><span id="l7.362">             this._log.debug(&quot;using folder &quot; + folder.URI + &quot; because &quot; +</span>
<a href="#l7.363"></a><span id="l7.363">                             &quot;corresponding search folder does not exist&quot;);</span>
<a href="#l7.364"></a><span id="l7.364">             // Create the folder, so that next time we're checking we don't hit</span>
<a href="#l7.365"></a><span id="l7.365">             // this</span>
<a href="#l7.366"></a><span id="l7.366">             searchPath.create(Ci.nsIFile.DIRECTORY_TYPE, PERM_DIRECTORY);</span>
<a href="#l7.367"></a><span id="l7.367">             folder.setStringProperty(this._hdrIndexedProperty,</span>
<a href="#l7.368"></a><span id="l7.368">                                      &quot;&quot; + (Date.now() / 1000));</span>
<a href="#l7.369"></a><span id="l7.369">             yield folder;</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-          }</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-          // folder may need reindexing for other reasons</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-          else if (this._pathNeedsReindexing(searchPath)) {</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+          } else if (this._pathNeedsReindexing(searchPath)) {</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+            // folder may need reindexing for other reasons</span>
<a href="#l7.375"></a><span id="l7.375">             folder.setStringProperty(this._hdrIndexedProperty,</span>
<a href="#l7.376"></a><span id="l7.376">                                      &quot;&quot; + (Date.now() / 1000));</span>
<a href="#l7.377"></a><span id="l7.377">             yield folder;</span>
<a href="#l7.378"></a><span id="l7.378">           }</span>
<a href="#l7.379"></a><span id="l7.379"> </span>
<a href="#l7.380"></a><span id="l7.380">           // Even if we yielded above, check if this is the last folder</span>
<a href="#l7.381"></a><span id="l7.381">           // indexed</span>
<a href="#l7.382"></a><span id="l7.382">           if (this._lastFolderIndexedUri == folder.URI)</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineat">@@ -359,101 +326,93 @@ var SearchSupport =</span>
<a href="#l7.384"></a><span id="l7.384">     }</span>
<a href="#l7.385"></a><span id="l7.385">     // We're done with one iteration of all the folders; time to reset the</span>
<a href="#l7.386"></a><span id="l7.386">     // lastFolderIndexedUri</span>
<a href="#l7.387"></a><span id="l7.387">     this._lastFolderIndexedUri = &quot;&quot;;</span>
<a href="#l7.388"></a><span id="l7.388">     yield null;</span>
<a href="#l7.389"></a><span id="l7.389">   },</span>
<a href="#l7.390"></a><span id="l7.390"> </span>
<a href="#l7.391"></a><span id="l7.391">   __foldersToIndex: null,</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-  get _foldersToIndex()</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-  {</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+  get _foldersToIndex() {</span>
<a href="#l7.395"></a><span id="l7.395">     if (!this.__foldersToIndex)</span>
<a href="#l7.396"></a><span id="l7.396">       this.__foldersToIndex = this._foldersToIndexGenerator();</span>
<a href="#l7.397"></a><span id="l7.397">     return this.__foldersToIndex;</span>
<a href="#l7.398"></a><span id="l7.398">   },</span>
<a href="#l7.399"></a><span id="l7.399"> </span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-  _findNextHdrToIndex: function search_find_next_header()</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-  {</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-    try</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-    {</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+  _findNextHdrToIndex() {</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+    try {</span>
<a href="#l7.406"></a><span id="l7.406">       let reindexTime = this._getLastReindexTime(this._currentFolderToIndex);</span>
<a href="#l7.407"></a><span id="l7.407">       this._log.debug(&quot;Reindex time for this folder is &quot; + reindexTime);</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-      if (!this._headerEnumerator)</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-      {</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+      if (!this._headerEnumerator) {</span>
<a href="#l7.411"></a><span id="l7.411">         //  we need to create search terms for messages to index</span>
<a href="#l7.412"></a><span id="l7.412">         let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l7.413"></a><span id="l7.413">                               .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l7.414"></a><span id="l7.414">         let searchTerms = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l7.415"></a><span id="l7.415"> </span>
<a href="#l7.416"></a><span id="l7.416">         searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, this._currentFolderToIndex);</span>
<a href="#l7.417"></a><span id="l7.417">         let nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l7.418"></a><span id="l7.418">         let nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l7.419"></a><span id="l7.419">         // first term: (_hdrIndexProperty &lt; reindexTime)</span>
<a href="#l7.420"></a><span id="l7.420">         let searchTerm = searchSession.createTerm();</span>
<a href="#l7.421"></a><span id="l7.421">         searchTerm.booleanAnd = false; // actually don't care here</span>
<a href="#l7.422"></a><span id="l7.422">         searchTerm.attrib = nsMsgSearchAttrib.Uint32HdrProperty;</span>
<a href="#l7.423"></a><span id="l7.423">         searchTerm.op = nsMsgSearchOp.IsLessThan;</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-        value = searchTerm.value;</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+        let value = searchTerm.value;</span>
<a href="#l7.426"></a><span id="l7.426">         value.attrib = searchTerm.attrib;</span>
<a href="#l7.427"></a><span id="l7.427">         searchTerm.hdrProperty = this._hdrIndexedProperty;</span>
<a href="#l7.428"></a><span id="l7.428">         value.status = reindexTime;</span>
<a href="#l7.429"></a><span id="l7.429">         searchTerm.value = value;</span>
<a href="#l7.430"></a><span id="l7.430">         searchTerms.appendElement(searchTerm);</span>
<a href="#l7.431"></a><span id="l7.431">         this._headerEnumerator = this._currentFolderToIndex.msgDatabase</span>
<a href="#l7.432"></a><span id="l7.432">                                  .getFilterEnumerator(searchTerms);</span>
<a href="#l7.433"></a><span id="l7.433">       }</span>
<a href="#l7.434"></a><span id="l7.434"> </span>
<a href="#l7.435"></a><span id="l7.435">       // iterate over the folder finding the next message to index</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineminus">-      while (this._headerEnumerator.hasMoreElements())</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-      {</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+      while (this._headerEnumerator.hasMoreElements()) {</span>
<a href="#l7.439"></a><span id="l7.439">         let msgHdr = this._headerEnumerator.getNext()</span>
<a href="#l7.440"></a><span id="l7.440">                          .QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l7.441"></a><span id="l7.441"> </span>
<a href="#l7.442"></a><span id="l7.442">         // Check if the file exists. If it does, then assume indexing to be</span>
<a href="#l7.443"></a><span id="l7.443">         // complete for this file</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineminus">-        if (this._getSupportFile(msgHdr).exists())</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineminus">-        {</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+        if (this._getSupportFile(msgHdr).exists()) {</span>
<a href="#l7.447"></a><span id="l7.447">           this._log.debug(&quot;Message time not set but file exists; setting &quot; +</span>
<a href="#l7.448"></a><span id="l7.448">                           &quot;time to &quot; + reindexTime);</span>
<a href="#l7.449"></a><span id="l7.449">           msgHdr.setUint32Property(this._hdrIndexedProperty, reindexTime);</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-        }</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-        else</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-        {</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+        } else {</span>
<a href="#l7.454"></a><span id="l7.454">           return [msgHdr, reindexTime];</span>
<a href="#l7.455"></a><span id="l7.455">         }</span>
<a href="#l7.456"></a><span id="l7.456">       }</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+    } catch (ex) {</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+      this._log.debug(&quot;Error while finding next header: &quot; + ex);</span>
<a href="#l7.459"></a><span id="l7.459">     }</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineminus">-    catch(ex) { this._log.debug(&quot;Error while finding next header: &quot; + ex); }</span>
<a href="#l7.461"></a><span id="l7.461"> </span>
<a href="#l7.462"></a><span id="l7.462">     // If we couldn't find any headers to index, null out the enumerator</span>
<a href="#l7.463"></a><span id="l7.463">     this._headerEnumerator = null;</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-    if (! (this._currentFolderToIndex.flags &amp; Ci.nsMsgFolderFlags.Inbox))</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+    if (!(this._currentFolderToIndex.flags &amp; Ci.nsMsgFolderFlags.Inbox))</span>
<a href="#l7.466"></a><span id="l7.466">       this._currentFolderToIndex.msgDatabase = null;</span>
<a href="#l7.467"></a><span id="l7.467">     return null;</span>
<a href="#l7.468"></a><span id="l7.468">   },</span>
<a href="#l7.469"></a><span id="l7.469"> </span>
<a href="#l7.470"></a><span id="l7.470">   /**</span>
<a href="#l7.471"></a><span id="l7.471">    * Get the last reindex time for this folder. This will be whichever's</span>
<a href="#l7.472"></a><span id="l7.472">    * greater, the global reindex time or the folder reindex time</span>
<a href="#l7.473"></a><span id="l7.473">    */</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineminus">-  _getLastReindexTime: function search_get_last_reindex_time(aFolder)</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineminus">-  {</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+  _getLastReindexTime(aFolder) {</span>
<a href="#l7.477"></a><span id="l7.477">     let reindexTime = this.globalReindexTime;</span>
<a href="#l7.478"></a><span id="l7.478"> </span>
<a href="#l7.479"></a><span id="l7.479">     // Check if this folder has a separate string property set</span>
<a href="#l7.480"></a><span id="l7.480">     let folderReindexTime;</span>
<a href="#l7.481"></a><span id="l7.481">     try {</span>
<a href="#l7.482"></a><span id="l7.482">       folderReindexTime = this._currentFolderToIndex</span>
<a href="#l7.483"></a><span id="l7.483">         .getStringProperty(this._hdrIndexedProperty);</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+    } catch (e) {</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+      folderReindexTime = &quot;&quot;;</span>
<a href="#l7.486"></a><span id="l7.486">     }</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-    catch (e) { folderReindexTime = &quot;&quot;; }</span>
<a href="#l7.488"></a><span id="l7.488"> </span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-    if (folderReindexTime.length &gt; 0)</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineminus">-    {</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+    if (folderReindexTime.length &gt; 0) {</span>
<a href="#l7.492"></a><span id="l7.492">       let folderReindexTimeInt = parseInt(folderReindexTime);</span>
<a href="#l7.493"></a><span id="l7.493">       if (folderReindexTimeInt &gt; reindexTime)</span>
<a href="#l7.494"></a><span id="l7.494">         reindexTime = folderReindexTimeInt;</span>
<a href="#l7.495"></a><span id="l7.495">     }</span>
<a href="#l7.496"></a><span id="l7.496">     return reindexTime;</span>
<a href="#l7.497"></a><span id="l7.497">   },</span>
<a href="#l7.498"></a><span id="l7.498"> </span>
<a href="#l7.499"></a><span id="l7.499">   /**</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineat">@@ -462,18 +421,17 @@ var SearchSupport =</span>
<a href="#l7.501"></a><span id="l7.501">   __backgroundIndexingDone: false,</span>
<a href="#l7.502"></a><span id="l7.502"> </span>
<a href="#l7.503"></a><span id="l7.503">   /**</span>
<a href="#l7.504"></a><span id="l7.504">    * The main background sweeping function. It first looks for a folder to</span>
<a href="#l7.505"></a><span id="l7.505">    * start or continue indexing in, then for a header. If it can't find anything</span>
<a href="#l7.506"></a><span id="l7.506">    * to index, it resets the last folder indexed URI so that the sweep can</span>
<a href="#l7.507"></a><span id="l7.507">    * be restarted</span>
<a href="#l7.508"></a><span id="l7.508">    */</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-  _continueSweep: function search_continue_sweep()</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-  {</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+  _continueSweep() {</span>
<a href="#l7.512"></a><span id="l7.512">     let msgHdrAndReindexTime = null;</span>
<a href="#l7.513"></a><span id="l7.513"> </span>
<a href="#l7.514"></a><span id="l7.514">     if (this.__backgroundIndexingDone)</span>
<a href="#l7.515"></a><span id="l7.515">       return;</span>
<a href="#l7.516"></a><span id="l7.516"> </span>
<a href="#l7.517"></a><span id="l7.517">     // find the current folder we're working on</span>
<a href="#l7.518"></a><span id="l7.518">     if (!this._currentFolderToIndex)</span>
<a href="#l7.519"></a><span id="l7.519">       this._currentFolderToIndex = this._foldersToIndex.next().value;</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineat">@@ -483,430 +441,381 @@ var SearchSupport =</span>
<a href="#l7.521"></a><span id="l7.521">     // it's going to take to stream any particular message.</span>
<a href="#l7.522"></a><span id="l7.522">     if (this._currentFolderToIndex)</span>
<a href="#l7.523"></a><span id="l7.523">       msgHdrAndReindexTime = this._findNextHdrToIndex();</span>
<a href="#l7.524"></a><span id="l7.524">     else</span>
<a href="#l7.525"></a><span id="l7.525">       // we've cycled through all the folders, we should take a break</span>
<a href="#l7.526"></a><span id="l7.526">       // from indexing of existing messages</span>
<a href="#l7.527"></a><span id="l7.527">       this.__backgroundIndexingDone = true;</span>
<a href="#l7.528"></a><span id="l7.528"> </span>
<a href="#l7.529"></a><span id="l7.529" class="difflineminus">-    if (!msgHdrAndReindexTime)</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineminus">-    {</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+    if (!msgHdrAndReindexTime) {</span>
<a href="#l7.532"></a><span id="l7.532">       this._log.debug(&quot;reached end of folder&quot;);</span>
<a href="#l7.533"></a><span id="l7.533">       if (this._currentFolderToIndex)</span>
<a href="#l7.534"></a><span id="l7.534">         this._currentFolderToIndex = null;</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+    } else {</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+      this._queueMessage(msgHdrAndReindexTime[0], msgHdrAndReindexTime[1]);</span>
<a href="#l7.537"></a><span id="l7.537">     }</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-    else</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineminus">-      this._queueMessage(msgHdrAndReindexTime[0], msgHdrAndReindexTime[1]);</span>
<a href="#l7.540"></a><span id="l7.540"> </span>
<a href="#l7.541"></a><span id="l7.541">     // Restart the timer, and call ourselves</span>
<a href="#l7.542"></a><span id="l7.542">     this._cancelTimer();</span>
<a href="#l7.543"></a><span id="l7.543">     this._timer.initWithCallback(this._wrapContinueSweep,</span>
<a href="#l7.544"></a><span id="l7.544">                                  this._msgHdrsToIndex.length &gt; 1 ? 5000 : 1000,</span>
<a href="#l7.545"></a><span id="l7.545">                                  Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l7.546"></a><span id="l7.546">   },</span>
<a href="#l7.547"></a><span id="l7.547"> </span>
<a href="#l7.548"></a><span id="l7.548">   /**</span>
<a href="#l7.549"></a><span id="l7.549">    * A simple wrapper to make &quot;this&quot; be right for _continueSweep</span>
<a href="#l7.550"></a><span id="l7.550">    */</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineminus">-  _wrapContinueSweep: function search_wrap_continue_sweep()</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineminus">-  {</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineplus">+  _wrapContinueSweep() {</span>
<a href="#l7.554"></a><span id="l7.554">     SearchIntegration._continueSweep();</span>
<a href="#l7.555"></a><span id="l7.555">   },</span>
<a href="#l7.556"></a><span id="l7.556"> </span>
<a href="#l7.557"></a><span id="l7.557">   /**</span>
<a href="#l7.558"></a><span id="l7.558">    * Observer implementation. Consists of</span>
<a href="#l7.559"></a><span id="l7.559">    * - idle observer; starts running through folders when it receives an &quot;idle&quot;</span>
<a href="#l7.560"></a><span id="l7.560">    * notification, and cancels any timers when it receives a &quot;back&quot; notification</span>
<a href="#l7.561"></a><span id="l7.561">    * - msg displayed observer, queues the message if necessary</span>
<a href="#l7.562"></a><span id="l7.562">    * - pref observer, to see if the preference has been poked</span>
<a href="#l7.563"></a><span id="l7.563">    */</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-  observe: function search_observe(aSubject, aTopic, aData)</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-  {</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineminus">-    if (aTopic == &quot;idle&quot;)</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineminus">-    {</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineminus">-      this._log.debug(&quot;Idle detected, continuing sweep&quot;)</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineplus">+    if (aTopic == &quot;idle&quot;) {</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineplus">+      this._log.debug(&quot;Idle detected, continuing sweep&quot;);</span>
<a href="#l7.572"></a><span id="l7.572">       this._continueSweep();</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineminus">-    }</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineminus">-    else if (aTopic == &quot;back&quot;)</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineminus">-    {</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-      this._log.debug(&quot;Non-idle, so suspending sweep&quot;)</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineplus">+    } else if (aTopic == &quot;back&quot;) {</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineplus">+      this._log.debug(&quot;Non-idle, so suspending sweep&quot;);</span>
<a href="#l7.579"></a><span id="l7.579">       this._cancelTimer();</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineminus">-    }</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineminus">-    else if (aTopic == &quot;MsgMsgDisplayed&quot;)</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineminus">-    {</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+    } else if (aTopic == &quot;MsgMsgDisplayed&quot;) {</span>
<a href="#l7.584"></a><span id="l7.584">       this._log.debug(&quot;topic = &quot; + aTopic + &quot; uri = &quot; + aData);</span>
<a href="#l7.585"></a><span id="l7.585">       let msgHdr = this._messenger.msgHdrFromURI(aData);</span>
<a href="#l7.586"></a><span id="l7.586">       let reindexTime = this._getLastReindexTime(msgHdr.folder);</span>
<a href="#l7.587"></a><span id="l7.587">       this._log.debug(&quot;Reindex time for this folder is &quot; + reindexTime);</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineminus">-      if (msgHdr.getUint32Property(this._hdrIndexedProperty) &lt; reindexTime)</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineminus">-      {</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineplus">+      if (msgHdr.getUint32Property(this._hdrIndexedProperty) &lt; reindexTime) {</span>
<a href="#l7.591"></a><span id="l7.591">         // Check if the file exists. If it does, then assume indexing to be</span>
<a href="#l7.592"></a><span id="l7.592">         // complete for this file</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-        if (this._getSupportFile(msgHdr).exists())</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-        {</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineplus">+        if (this._getSupportFile(msgHdr).exists()) {</span>
<a href="#l7.596"></a><span id="l7.596">           this._log.debug(&quot;Message time not set but file exists; setting &quot; +</span>
<a href="#l7.597"></a><span id="l7.597">                           &quot; time to &quot; + reindexTime);</span>
<a href="#l7.598"></a><span id="l7.598">           msgHdr.setUint32Property(this._hdrIndexedProperty, reindexTime);</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineminus">-        }</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineminus">-        else</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineminus">-        {</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineplus">+        } else {</span>
<a href="#l7.603"></a><span id="l7.603">           this._queueMessage(msgHdr, reindexTime);</span>
<a href="#l7.604"></a><span id="l7.604">         }</span>
<a href="#l7.605"></a><span id="l7.605">       }</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineminus">-    }</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineminus">-    else if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aData == &quot;enable&quot;)</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineminus">-    {</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineplus">+    } else if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aData == &quot;enable&quot;) {</span>
<a href="#l7.610"></a><span id="l7.610">       let prefEnabled = this.prefEnabled;</span>
<a href="#l7.611"></a><span id="l7.611">       // Search integration turned on</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineminus">-      if (prefEnabled &amp;&amp; this.register())</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineminus">-      {</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineplus">+      if (prefEnabled &amp;&amp; this.register()) {</span>
<a href="#l7.615"></a><span id="l7.615">         this.enabled = true;</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineminus">-      }</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineminus">-      // Search integration turned off</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineminus">-      else if (!prefEnabled &amp;&amp; this.deregister())</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineminus">-      {</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+      } else if (!prefEnabled &amp;&amp; this.deregister()) {</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+        // Search integration turned off</span>
<a href="#l7.622"></a><span id="l7.622">         this.enabled = false;</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineminus">-      }</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineminus">-      else</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineminus">-      {</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineplus">+      } else {</span>
<a href="#l7.627"></a><span id="l7.627">         // The call to register or deregister has failed.</span>
<a href="#l7.628"></a><span id="l7.628">         // This is a hack to handle this case</span>
<a href="#l7.629"></a><span id="l7.629">         let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l7.630"></a><span id="l7.630">         timer.initWithCallback(function() {</span>
<a href="#l7.631"></a><span id="l7.631">           SearchIntegration._handleRegisterFailure(!prefEnabled);</span>
<a href="#l7.632"></a><span id="l7.632">         }, 200, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l7.633"></a><span id="l7.633">       }</span>
<a href="#l7.634"></a><span id="l7.634">     }</span>
<a href="#l7.635"></a><span id="l7.635">   },</span>
<a href="#l7.636"></a><span id="l7.636"> </span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-  /// Handle failure to register or deregister</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineminus">-  _handleRegisterFailure: function search_handle_register_failure(enabled)</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineminus">-  {</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineplus">+  // Handle failure to register or deregister</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineplus">+  _handleRegisterFailure(enabled) {</span>
<a href="#l7.642"></a><span id="l7.642">     // Remove ourselves from the observer list, flip the pref,</span>
<a href="#l7.643"></a><span id="l7.643">     // and add ourselves back</span>
<a href="#l7.644"></a><span id="l7.644">     this._prefBranch.removeObserver(&quot;enable&quot;, this);</span>
<a href="#l7.645"></a><span id="l7.645">     this.prefEnabled = enabled;</span>
<a href="#l7.646"></a><span id="l7.646">     this._prefBranch.addObserver(&quot;enable&quot;, this);</span>
<a href="#l7.647"></a><span id="l7.647">   },</span>
<a href="#l7.648"></a><span id="l7.648"> </span>
<a href="#l7.649"></a><span id="l7.649">   /**</span>
<a href="#l7.650"></a><span id="l7.650">    * This object gets notifications for new/moved/copied/deleted messages/folders</span>
<a href="#l7.651"></a><span id="l7.651">    */</span>
<a href="#l7.652"></a><span id="l7.652">   _msgFolderListener: {</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineminus">-    msgAdded: function(aMsg)</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineminus">-    {</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineplus">+    msgAdded(aMsg) {</span>
<a href="#l7.656"></a><span id="l7.656">       SearchIntegration._log.info(&quot;in msgAdded&quot;);</span>
<a href="#l7.657"></a><span id="l7.657">       // The message already being there is an expected case</span>
<a href="#l7.658"></a><span id="l7.658">       let file = SearchIntegration._getSupportFile(aMsg);</span>
<a href="#l7.659"></a><span id="l7.659">       if (!file.exists())</span>
<a href="#l7.660"></a><span id="l7.660">         SearchIntegration._queueMessage(aMsg,</span>
<a href="#l7.661"></a><span id="l7.661">           SearchIntegration._getLastReindexTime(aMsg.folder));</span>
<a href="#l7.662"></a><span id="l7.662">     },</span>
<a href="#l7.663"></a><span id="l7.663"> </span>
<a href="#l7.664"></a><span id="l7.664" class="difflineminus">-    msgsDeleted: function(aMsgs)</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineminus">-    {</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+    msgsDeleted(aMsgs) {</span>
<a href="#l7.667"></a><span id="l7.667">       SearchIntegration._log.info(&quot;in msgsDeleted&quot;);</span>
<a href="#l7.668"></a><span id="l7.668">       let count = aMsgs.length;</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineminus">-      for (let i = 0; i &lt; count; i++)</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineminus">-      {</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+      for (let i = 0; i &lt; count; i++) {</span>
<a href="#l7.672"></a><span id="l7.672">         let file = SearchIntegration._getSupportFile(</span>
<a href="#l7.673"></a><span id="l7.673">                      aMsgs.queryElementAt(i, Ci.nsIMsgDBHdr));</span>
<a href="#l7.674"></a><span id="l7.674">         if (file.exists())</span>
<a href="#l7.675"></a><span id="l7.675">           file.remove(false);</span>
<a href="#l7.676"></a><span id="l7.676">       }</span>
<a href="#l7.677"></a><span id="l7.677">     },</span>
<a href="#l7.678"></a><span id="l7.678"> </span>
<a href="#l7.679"></a><span id="l7.679" class="difflineminus">-    msgsMoveCopyCompleted: function(aMove, aSrcMsgs, aDestFolder)</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineminus">-    {</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+    msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder) {</span>
<a href="#l7.682"></a><span id="l7.682">       SearchIntegration._log.info(&quot;in msgsMoveCopyCompleted, aMove = &quot; + aMove);</span>
<a href="#l7.683"></a><span id="l7.683">       // Forget about copies if disabled</span>
<a href="#l7.684"></a><span id="l7.684">       if (!aMove &amp;&amp; !this.enabled)</span>
<a href="#l7.685"></a><span id="l7.685">         return;</span>
<a href="#l7.686"></a><span id="l7.686"> </span>
<a href="#l7.687"></a><span id="l7.687">       let count = aSrcMsgs.length;</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineminus">-      for (let i = 0; i &lt; count; i++)</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineminus">-      {</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+      for (let i = 0; i &lt; count; i++) {</span>
<a href="#l7.691"></a><span id="l7.691">         let srcFile = SearchIntegration._getSupportFile(</span>
<a href="#l7.692"></a><span id="l7.692">                         aSrcMsgs.queryElementAt(i, Ci.nsIMsgDBHdr));</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineminus">-        if (srcFile &amp;&amp; srcFile.exists())</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-        {</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+        if (srcFile &amp;&amp; srcFile.exists()) {</span>
<a href="#l7.696"></a><span id="l7.696">           let destFile = SearchIntegration._getSearchPathForFolder(aDestFolder);</span>
<a href="#l7.697"></a><span id="l7.697">           destFile.leafName = destFile.leafName + &quot;.mozmsgs&quot;;</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineminus">-          if (!destFile.exists())</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineminus">-          {</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineplus">+          if (!destFile.exists()) {</span>
<a href="#l7.701"></a><span id="l7.701">             try {</span>
<a href="#l7.702"></a><span id="l7.702">               // create the directory, if it doesn't exist</span>
<a href="#l7.703"></a><span id="l7.703">               destFile.create(Ci.nsIFile.DIRECTORY_TYPE, PERM_DIRECTORY);</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineplus">+            } catch (ex) {</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineplus">+              SearchIntegration._log.warn(ex);</span>
<a href="#l7.706"></a><span id="l7.706">             }</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineminus">-            catch(ex) {SearchIntegration._log.warn(ex);}</span>
<a href="#l7.708"></a><span id="l7.708">           }</span>
<a href="#l7.709"></a><span id="l7.709">           SearchIntegration._log.debug(&quot;dst file path = &quot; + destFile.path);</span>
<a href="#l7.710"></a><span id="l7.710">           SearchIntegration._log.debug(&quot;src file path = &quot; + srcFile.path);</span>
<a href="#l7.711"></a><span id="l7.711">           // We're not going to copy in case we're not in active mode</span>
<a href="#l7.712"></a><span id="l7.712">           if (destFile.exists())</span>
<a href="#l7.713"></a><span id="l7.713">             if (aMove)</span>
<a href="#l7.714"></a><span id="l7.714">               srcFile.moveTo(destFile, &quot;&quot;);</span>
<a href="#l7.715"></a><span id="l7.715">             else</span>
<a href="#l7.716"></a><span id="l7.716">               srcFile.copyTo(destFile, &quot;&quot;);</span>
<a href="#l7.717"></a><span id="l7.717">         }</span>
<a href="#l7.718"></a><span id="l7.718">       }</span>
<a href="#l7.719"></a><span id="l7.719">     },</span>
<a href="#l7.720"></a><span id="l7.720"> </span>
<a href="#l7.721"></a><span id="l7.721" class="difflineminus">-    folderDeleted: function(aFolder)</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineminus">-    {</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+    folderDeleted(aFolder) {</span>
<a href="#l7.724"></a><span id="l7.724">       SearchIntegration._log.info(&quot;in folderDeleted, folder name = &quot; +</span>
<a href="#l7.725"></a><span id="l7.725">                                   aFolder.prettyName);</span>
<a href="#l7.726"></a><span id="l7.726">       let srcFile = SearchIntegration._getSearchPathForFolder(aFolder);</span>
<a href="#l7.727"></a><span id="l7.727">       srcFile.leafName = srcFile.leafName + &quot;.mozmsgs&quot;;</span>
<a href="#l7.728"></a><span id="l7.728">       if (srcFile.exists())</span>
<a href="#l7.729"></a><span id="l7.729">         srcFile.remove(true);</span>
<a href="#l7.730"></a><span id="l7.730">     },</span>
<a href="#l7.731"></a><span id="l7.731"> </span>
<a href="#l7.732"></a><span id="l7.732" class="difflineminus">-    folderMoveCopyCompleted: function(aMove, aSrcFolder, aDestFolder)</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineminus">-    {</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineplus">+    folderMoveCopyCompleted(aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l7.735"></a><span id="l7.735">       SearchIntegration._log.info(&quot;in folderMoveCopyCompleted, aMove = &quot; +</span>
<a href="#l7.736"></a><span id="l7.736">                                   aMove);</span>
<a href="#l7.737"></a><span id="l7.737"> </span>
<a href="#l7.738"></a><span id="l7.738">       // Forget about copies if disabled</span>
<a href="#l7.739"></a><span id="l7.739">       if (!aMove &amp;&amp; !this.enabled)</span>
<a href="#l7.740"></a><span id="l7.740">         return;</span>
<a href="#l7.741"></a><span id="l7.741"> </span>
<a href="#l7.742"></a><span id="l7.742">       let srcFile = SearchIntegration._getSearchPathForFolder(aSrcFolder);</span>
<a href="#l7.743"></a><span id="l7.743">       let destFile = SearchIntegration._getSearchPathForFolder(aDestFolder);</span>
<a href="#l7.744"></a><span id="l7.744">       srcFile.leafName = srcFile.leafName + &quot;.mozmsgs&quot;;</span>
<a href="#l7.745"></a><span id="l7.745">       destFile.leafName += &quot;.sbd&quot;;</span>
<a href="#l7.746"></a><span id="l7.746">       SearchIntegration._log.debug(&quot;src file path = &quot; + srcFile.path);</span>
<a href="#l7.747"></a><span id="l7.747">       SearchIntegration._log.debug(&quot;dst file path = &quot; + destFile.path);</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineminus">-      if (srcFile.exists())</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineminus">-      {</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+      if (srcFile.exists()) {</span>
<a href="#l7.751"></a><span id="l7.751">         // We're not going to copy if we aren't in active mode</span>
<a href="#l7.752"></a><span id="l7.752">         if (aMove)</span>
<a href="#l7.753"></a><span id="l7.753">           srcFile.moveTo(destFile, &quot;&quot;);</span>
<a href="#l7.754"></a><span id="l7.754">         else</span>
<a href="#l7.755"></a><span id="l7.755">           srcFile.copyTo(destFile, &quot;&quot;);</span>
<a href="#l7.756"></a><span id="l7.756">       }</span>
<a href="#l7.757"></a><span id="l7.757">     },</span>
<a href="#l7.758"></a><span id="l7.758"> </span>
<a href="#l7.759"></a><span id="l7.759" class="difflineminus">-    folderRenamed: function(aOrigFolder, aNewFolder)</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineminus">-    {</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+    folderRenamed(aOrigFolder, aNewFolder) {</span>
<a href="#l7.762"></a><span id="l7.762">       SearchIntegration._log.info(&quot;in folderRenamed, aOrigFolder = &quot; +</span>
<a href="#l7.763"></a><span id="l7.763">                                   aOrigFolder.prettyName +</span>
<a href="#l7.764"></a><span id="l7.764">                                   &quot;, aNewFolder = &quot; + aNewFolder.prettyName);</span>
<a href="#l7.765"></a><span id="l7.765">       let srcFile = SearchIntegration._getSearchPathForFolder(aOrigFolder);</span>
<a href="#l7.766"></a><span id="l7.766">       srcFile.leafName = srcFile.leafName + &quot;.mozmsgs&quot;;</span>
<a href="#l7.767"></a><span id="l7.767">       let destName = aNewFolder.name + &quot;.mozmsgs&quot;;</span>
<a href="#l7.768"></a><span id="l7.768">       SearchIntegration._log.debug(&quot;src file path = &quot; + srcFile.path);</span>
<a href="#l7.769"></a><span id="l7.769">       SearchIntegration._log.debug(&quot;dst name = &quot; + destName);</span>
<a href="#l7.770"></a><span id="l7.770">       if (srcFile.exists())</span>
<a href="#l7.771"></a><span id="l7.771">         srcFile.moveTo(null, destName);</span>
<a href="#l7.772"></a><span id="l7.772">     },</span>
<a href="#l7.773"></a><span id="l7.773"> </span>
<a href="#l7.774"></a><span id="l7.774" class="difflineminus">-    itemEvent: function(aItem, aEvent, aData, aString)</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineminus">-    {</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineplus">+    itemEvent(aItem, aEvent, aData, aString) {</span>
<a href="#l7.777"></a><span id="l7.777">       SearchIntegration._log.info(&quot;in itemEvent, aItem = &quot; + aItem +</span>
<a href="#l7.778"></a><span id="l7.778">                                   &quot;, aEvent = &quot; + aEvent +</span>
<a href="#l7.779"></a><span id="l7.779">                                   &quot;, aData = &quot; + aData +</span>
<a href="#l7.780"></a><span id="l7.780">                                   &quot;, aString = &quot; + aString);</span>
<a href="#l7.781"></a><span id="l7.781" class="difflineminus">-    }</span>
<a href="#l7.782"></a><span id="l7.782" class="difflineplus">+    },</span>
<a href="#l7.783"></a><span id="l7.783">   },</span>
<a href="#l7.784"></a><span id="l7.784"> </span>
<a href="#l7.785"></a><span id="l7.785">   /*</span>
<a href="#l7.786"></a><span id="l7.786">    * Support functions to queue/generate files</span>
<a href="#l7.787"></a><span id="l7.787">    */</span>
<a href="#l7.788"></a><span id="l7.788" class="difflineminus">-  _queueMessage: function search_queue_message(msgHdr, reindexTime)</span>
<a href="#l7.789"></a><span id="l7.789" class="difflineminus">-  {</span>
<a href="#l7.790"></a><span id="l7.790" class="difflineminus">-    if (this._msgHdrsToIndex.push([msgHdr, reindexTime]) == 1)</span>
<a href="#l7.791"></a><span id="l7.791" class="difflineminus">-    {</span>
<a href="#l7.792"></a><span id="l7.792" class="difflineplus">+  _queueMessage(msgHdr, reindexTime) {</span>
<a href="#l7.793"></a><span id="l7.793" class="difflineplus">+    if (this._msgHdrsToIndex.push([msgHdr, reindexTime]) == 1) {</span>
<a href="#l7.794"></a><span id="l7.794">       this._log.info(&quot;generating support file for id = &quot; + msgHdr.messageId);</span>
<a href="#l7.795"></a><span id="l7.795">       this._streamListener.startStreaming(msgHdr, reindexTime);</span>
<a href="#l7.796"></a><span id="l7.796" class="difflineplus">+    } else {</span>
<a href="#l7.797"></a><span id="l7.797" class="difflineplus">+      this._log.info(&quot;queueing support file generation for id = &quot; + msgHdr.messageId);</span>
<a href="#l7.798"></a><span id="l7.798">     }</span>
<a href="#l7.799"></a><span id="l7.799" class="difflineminus">-    else</span>
<a href="#l7.800"></a><span id="l7.800" class="difflineminus">-      this._log.info(&quot;queueing support file generation for id = &quot; +</span>
<a href="#l7.801"></a><span id="l7.801" class="difflineminus">-                     msgHdr.messageId);</span>
<a href="#l7.802"></a><span id="l7.802">   },</span>
<a href="#l7.803"></a><span id="l7.803"> </span>
<a href="#l7.804"></a><span id="l7.804">   /**</span>
<a href="#l7.805"></a><span id="l7.805">    * Handle results from the command line. This method is the inverse of the</span>
<a href="#l7.806"></a><span id="l7.806">    * _getSupportFile method below.</span>
<a href="#l7.807"></a><span id="l7.807">    *</span>
<a href="#l7.808"></a><span id="l7.808">    * @param aFile the file passed in by the command line</span>
<a href="#l7.809"></a><span id="l7.809">    * @return the nsIMsgDBHdr corresponding to the file passed in</span>
<a href="#l7.810"></a><span id="l7.810">    */</span>
<a href="#l7.811"></a><span id="l7.811" class="difflineminus">-  handleResult: function search_handle_result(aFile)</span>
<a href="#l7.812"></a><span id="l7.812" class="difflineminus">-  {</span>
<a href="#l7.813"></a><span id="l7.813" class="difflineplus">+  handleResult(aFile) {</span>
<a href="#l7.814"></a><span id="l7.814">     // The file path has two components -- the search path, which needs to be</span>
<a href="#l7.815"></a><span id="l7.815">     // converted into a folder, and the message ID.</span>
<a href="#l7.816"></a><span id="l7.816">     let searchPath = aFile.parent;</span>
<a href="#l7.817"></a><span id="l7.817">     // Strip off &quot;.mozmsgs&quot; from the end (8 characters)</span>
<a href="#l7.818"></a><span id="l7.818">     searchPath.leafName = searchPath.leafName.slice(0, -8);</span>
<a href="#l7.819"></a><span id="l7.819"> </span>
<a href="#l7.820"></a><span id="l7.820">     let folder = this._getFolderForSearchPath(searchPath);</span>
<a href="#l7.821"></a><span id="l7.821"> </span>
<a href="#l7.822"></a><span id="l7.822">     // Get rid of the file extension at the end (7 characters), and unescape</span>
<a href="#l7.823"></a><span id="l7.823">     let messageID = decodeURIComponent(aFile.leafName.slice(0, -7));</span>
<a href="#l7.824"></a><span id="l7.824"> </span>
<a href="#l7.825"></a><span id="l7.825">     // Look for the message ID in the folder</span>
<a href="#l7.826"></a><span id="l7.826">     return folder.msgDatabase.getMsgHdrForMessageID(messageID);</span>
<a href="#l7.827"></a><span id="l7.827">   },</span>
<a href="#l7.828"></a><span id="l7.828"> </span>
<a href="#l7.829"></a><span id="l7.829" class="difflineminus">-  _getSupportFile: function search_get_support_file(msgHdr)</span>
<a href="#l7.830"></a><span id="l7.830" class="difflineminus">-  {</span>
<a href="#l7.831"></a><span id="l7.831" class="difflineplus">+  _getSupportFile(msgHdr) {</span>
<a href="#l7.832"></a><span id="l7.832">     let folder = msgHdr.folder;</span>
<a href="#l7.833"></a><span id="l7.833" class="difflineminus">-    if (folder)</span>
<a href="#l7.834"></a><span id="l7.834" class="difflineminus">-    {</span>
<a href="#l7.835"></a><span id="l7.835" class="difflineplus">+    if (folder) {</span>
<a href="#l7.836"></a><span id="l7.836">       let messageId = encodeURIComponent(msgHdr.messageId);</span>
<a href="#l7.837"></a><span id="l7.837">       this._log.debug(&quot;encoded message id = &quot; + messageId);</span>
<a href="#l7.838"></a><span id="l7.838">       let file = this._getSearchPathForFolder(folder);</span>
<a href="#l7.839"></a><span id="l7.839">       file.leafName = file.leafName + &quot;.mozmsgs&quot;;</span>
<a href="#l7.840"></a><span id="l7.840">       file.appendRelativePath(messageId + this._fileExt);</span>
<a href="#l7.841"></a><span id="l7.841">       this._log.debug(&quot;getting support file path = &quot; + file.path);</span>
<a href="#l7.842"></a><span id="l7.842">       return file;</span>
<a href="#l7.843"></a><span id="l7.843">     }</span>
<a href="#l7.844"></a><span id="l7.844">     return null;</span>
<a href="#l7.845"></a><span id="l7.845">   },</span>
<a href="#l7.846"></a><span id="l7.846"> </span>
<a href="#l7.847"></a><span id="l7.847">   /**</span>
<a href="#l7.848"></a><span id="l7.848">    * Base to use for stream listeners, extended by the respective</span>
<a href="#l7.849"></a><span id="l7.849">    * implementations</span>
<a href="#l7.850"></a><span id="l7.850">    */</span>
<a href="#l7.851"></a><span id="l7.851">   _streamListenerBase: {</span>
<a href="#l7.852"></a><span id="l7.852" class="difflineminus">-    /// Output file</span>
<a href="#l7.853"></a><span id="l7.853" class="difflineplus">+    // Output file</span>
<a href="#l7.854"></a><span id="l7.854">     _outputFile: null,</span>
<a href="#l7.855"></a><span id="l7.855"> </span>
<a href="#l7.856"></a><span id="l7.856" class="difflineminus">-    /// Stream to use to write to the output file</span>
<a href="#l7.857"></a><span id="l7.857" class="difflineplus">+    // Stream to use to write to the output file</span>
<a href="#l7.858"></a><span id="l7.858">     __outputStream: null,</span>
<a href="#l7.859"></a><span id="l7.859" class="difflineminus">-    set _outputStream(stream)</span>
<a href="#l7.860"></a><span id="l7.860" class="difflineminus">-    {</span>
<a href="#l7.861"></a><span id="l7.861" class="difflineplus">+    set _outputStream(stream) {</span>
<a href="#l7.862"></a><span id="l7.862">       if (this.__outputStream)</span>
<a href="#l7.863"></a><span id="l7.863">         this.__outputStream.close();</span>
<a href="#l7.864"></a><span id="l7.864">       this.__outputStream = stream;</span>
<a href="#l7.865"></a><span id="l7.865">     },</span>
<a href="#l7.866"></a><span id="l7.866" class="difflineminus">-    get _outputStream()</span>
<a href="#l7.867"></a><span id="l7.867" class="difflineminus">-    {</span>
<a href="#l7.868"></a><span id="l7.868" class="difflineplus">+    get _outputStream() {</span>
<a href="#l7.869"></a><span id="l7.869">       return this.__outputStream;</span>
<a href="#l7.870"></a><span id="l7.870">     },</span>
<a href="#l7.871"></a><span id="l7.871"> </span>
<a href="#l7.872"></a><span id="l7.872" class="difflineminus">-    /// Reference to message header</span>
<a href="#l7.873"></a><span id="l7.873" class="difflineplus">+    // Reference to message header</span>
<a href="#l7.874"></a><span id="l7.874">     _msgHdr: null,</span>
<a href="#l7.875"></a><span id="l7.875"> </span>
<a href="#l7.876"></a><span id="l7.876" class="difflineminus">-    /// Reindex time for this message header</span>
<a href="#l7.877"></a><span id="l7.877" class="difflineplus">+    // Reindex time for this message header</span>
<a href="#l7.878"></a><span id="l7.878">     _reindexTime: null,</span>
<a href="#l7.879"></a><span id="l7.879"> </span>
<a href="#l7.880"></a><span id="l7.880">     QueryInterface: ChromeUtils.generateQI([&quot;nsIStreamListener&quot;]),</span>
<a href="#l7.881"></a><span id="l7.881"> </span>
<a href="#l7.882"></a><span id="l7.882" class="difflineminus">-    /// &quot;Finish&quot; function, cleans up behind itself if unsuccessful</span>
<a href="#l7.883"></a><span id="l7.883" class="difflineminus">-    _onDoneStreaming: function search_on_done_streaming(successful)</span>
<a href="#l7.884"></a><span id="l7.884" class="difflineminus">-    {</span>
<a href="#l7.885"></a><span id="l7.885" class="difflineplus">+    // &quot;Finish&quot; function, cleans up behind itself if unsuccessful</span>
<a href="#l7.886"></a><span id="l7.886" class="difflineplus">+    _onDoneStreaming(successful) {</span>
<a href="#l7.887"></a><span id="l7.887">       this._outputStream = null;</span>
<a href="#l7.888"></a><span id="l7.888" class="difflineminus">-      if (!successful &amp;&amp; this._msgHdr)</span>
<a href="#l7.889"></a><span id="l7.889" class="difflineminus">-      {</span>
<a href="#l7.890"></a><span id="l7.890" class="difflineplus">+      if (!successful &amp;&amp; this._msgHdr) {</span>
<a href="#l7.891"></a><span id="l7.891">         let file = SearchIntegration._getSupportFile(this._msgHdr);</span>
<a href="#l7.892"></a><span id="l7.892">         if (file &amp;&amp; file.exists())</span>
<a href="#l7.893"></a><span id="l7.893">           file.remove(false);</span>
<a href="#l7.894"></a><span id="l7.894">       }</span>
<a href="#l7.895"></a><span id="l7.895">       // should we try to delete the file on disk in case not successful?</span>
<a href="#l7.896"></a><span id="l7.896">       SearchIntegration._msgHdrsToIndex.shift();</span>
<a href="#l7.897"></a><span id="l7.897"> </span>
<a href="#l7.898"></a><span id="l7.898" class="difflineminus">-      if (SearchIntegration._msgHdrsToIndex.length &gt; 0)</span>
<a href="#l7.899"></a><span id="l7.899" class="difflineminus">-      {</span>
<a href="#l7.900"></a><span id="l7.900" class="difflineminus">-        [msgHdr, reindexTime] = SearchIntegration._msgHdrsToIndex[0];</span>
<a href="#l7.901"></a><span id="l7.901" class="difflineplus">+      if (SearchIntegration._msgHdrsToIndex.length &gt; 0) {</span>
<a href="#l7.902"></a><span id="l7.902" class="difflineplus">+        let [msgHdr, reindexTime] = SearchIntegration._msgHdrsToIndex[0];</span>
<a href="#l7.903"></a><span id="l7.903">         this.startStreaming(msgHdr, reindexTime);</span>
<a href="#l7.904"></a><span id="l7.904">       }</span>
<a href="#l7.905"></a><span id="l7.905">     },</span>
<a href="#l7.906"></a><span id="l7.906"> </span>
<a href="#l7.907"></a><span id="l7.907" class="difflineminus">-    /// &quot;Start&quot; function</span>
<a href="#l7.908"></a><span id="l7.908" class="difflineminus">-    startStreaming: function search_start_streaming(msgHdr, reindexTime)</span>
<a href="#l7.909"></a><span id="l7.909" class="difflineminus">-    {</span>
<a href="#l7.910"></a><span id="l7.910" class="difflineminus">-      try</span>
<a href="#l7.911"></a><span id="l7.911" class="difflineminus">-      {</span>
<a href="#l7.912"></a><span id="l7.912" class="difflineplus">+    // &quot;Start&quot; function</span>
<a href="#l7.913"></a><span id="l7.913" class="difflineplus">+    startStreaming(msgHdr, reindexTime) {</span>
<a href="#l7.914"></a><span id="l7.914" class="difflineplus">+      try {</span>
<a href="#l7.915"></a><span id="l7.915">         let folder = msgHdr.folder;</span>
<a href="#l7.916"></a><span id="l7.916" class="difflineminus">-        if (folder)</span>
<a href="#l7.917"></a><span id="l7.917" class="difflineminus">-        {</span>
<a href="#l7.918"></a><span id="l7.918" class="difflineplus">+        if (folder) {</span>
<a href="#l7.919"></a><span id="l7.919">           let messageId = encodeURIComponent(msgHdr.messageId);</span>
<a href="#l7.920"></a><span id="l7.920">           SearchIntegration._log.info(&quot;generating support file, id = &quot; +</span>
<a href="#l7.921"></a><span id="l7.921">                                       messageId);</span>
<a href="#l7.922"></a><span id="l7.922">           let file = SearchIntegration._getSearchPathForFolder(folder);</span>
<a href="#l7.923"></a><span id="l7.923"> </span>
<a href="#l7.924"></a><span id="l7.924">           file.leafName = file.leafName + &quot;.mozmsgs&quot;;</span>
<a href="#l7.925"></a><span id="l7.925">           SearchIntegration._log.debug(&quot;file leafname = &quot; + file.leafName);</span>
<a href="#l7.926"></a><span id="l7.926" class="difflineminus">-          if (!file.exists())</span>
<a href="#l7.927"></a><span id="l7.927" class="difflineminus">-          {</span>
<a href="#l7.928"></a><span id="l7.928" class="difflineplus">+          if (!file.exists()) {</span>
<a href="#l7.929"></a><span id="l7.929">             try {</span>
<a href="#l7.930"></a><span id="l7.930">               // create the directory, if it doesn't exist</span>
<a href="#l7.931"></a><span id="l7.931">               file.create(Ci.nsIFile.DIRECTORY_TYPE, PERM_DIRECTORY);</span>
<a href="#l7.932"></a><span id="l7.932" class="difflineplus">+            } catch (ex) {</span>
<a href="#l7.933"></a><span id="l7.933" class="difflineplus">+              this._log.error(ex);</span>
<a href="#l7.934"></a><span id="l7.934">             }</span>
<a href="#l7.935"></a><span id="l7.935" class="difflineminus">-            catch(ex) { this._log.error(ex); }</span>
<a href="#l7.936"></a><span id="l7.936">           }</span>
<a href="#l7.937"></a><span id="l7.937"> </span>
<a href="#l7.938"></a><span id="l7.938">           file.appendRelativePath(messageId + SearchIntegration._fileExt);</span>
<a href="#l7.939"></a><span id="l7.939">           SearchIntegration._log.debug(&quot;file path = &quot; + file.path);</span>
<a href="#l7.940"></a><span id="l7.940">           file.create(0, PERM_FILE);</span>
<a href="#l7.941"></a><span id="l7.941">           let uri = folder.getUriForMsg(msgHdr);</span>
<a href="#l7.942"></a><span id="l7.942">           let msgService = SearchIntegration._messenger</span>
<a href="#l7.943"></a><span id="l7.943">             .messageServiceFromURI(uri);</span>
<a href="#l7.944"></a><span id="l7.944">           this._msgHdr = msgHdr;</span>
<a href="#l7.945"></a><span id="l7.945">           this._outputFile = file;</span>
<a href="#l7.946"></a><span id="l7.946">           this._reindexTime = reindexTime;</span>
<a href="#l7.947"></a><span id="l7.947" class="difflineminus">-          try</span>
<a href="#l7.948"></a><span id="l7.948" class="difflineminus">-          {</span>
<a href="#l7.949"></a><span id="l7.949" class="difflineplus">+          try {</span>
<a href="#l7.950"></a><span id="l7.950">             // XXX For now, try getting the messages from the server. This has</span>
<a href="#l7.951"></a><span id="l7.951">             // to be improved so that we don't generate any excess network</span>
<a href="#l7.952"></a><span id="l7.952">             // traffic</span>
<a href="#l7.953"></a><span id="l7.953">             msgService.streamMessage(uri, this, null, null, false, &quot;&quot;, false);</span>
<a href="#l7.954"></a><span id="l7.954" class="difflineminus">-          }</span>
<a href="#l7.955"></a><span id="l7.955" class="difflineminus">-          catch (ex)</span>
<a href="#l7.956"></a><span id="l7.956" class="difflineminus">-          {</span>
<a href="#l7.957"></a><span id="l7.957" class="difflineplus">+          } catch (ex) {</span>
<a href="#l7.958"></a><span id="l7.958">             // This is an expected case, in case we're offline</span>
<a href="#l7.959"></a><span id="l7.959">             SearchIntegration._log.warn(&quot;StreamMessage unsuccessful for id = &quot; +</span>
<a href="#l7.960"></a><span id="l7.960">                                         messageId);</span>
<a href="#l7.961"></a><span id="l7.961">             this._onDoneStreaming(false);</span>
<a href="#l7.962"></a><span id="l7.962">           }</span>
<a href="#l7.963"></a><span id="l7.963">         }</span>
<a href="#l7.964"></a><span id="l7.964" class="difflineminus">-      }</span>
<a href="#l7.965"></a><span id="l7.965" class="difflineminus">-      catch (ex)</span>
<a href="#l7.966"></a><span id="l7.966" class="difflineminus">-      {</span>
<a href="#l7.967"></a><span id="l7.967" class="difflineplus">+      } catch (ex) {</span>
<a href="#l7.968"></a><span id="l7.968">         SearchIntegration._log.error(ex);</span>
<a href="#l7.969"></a><span id="l7.969">         this._onDoneStreaming(false);</span>
<a href="#l7.970"></a><span id="l7.970">       }</span>
<a href="#l7.971"></a><span id="l7.971" class="difflineminus">-    }</span>
<a href="#l7.972"></a><span id="l7.972" class="difflineplus">+    },</span>
<a href="#l7.973"></a><span id="l7.973">   },</span>
<a href="#l7.974"></a><span id="l7.974"> </span>
<a href="#l7.975"></a><span id="l7.975">   /**</span>
<a href="#l7.976"></a><span id="l7.976">    * Logging functionality, shamelessly ripped from gloda</span>
<a href="#l7.977"></a><span id="l7.977">    * If enabled, warnings and above are logged to the error console, while dump</span>
<a href="#l7.978"></a><span id="l7.978">    * gets everything</span>
<a href="#l7.979"></a><span id="l7.979">    */</span>
<a href="#l7.980"></a><span id="l7.980">   _log: null,</span>
<a href="#l7.981"></a><span id="l7.981" class="difflineminus">-  _initLogging: function search_init_logging()</span>
<a href="#l7.982"></a><span id="l7.982" class="difflineminus">-  {</span>
<a href="#l7.983"></a><span id="l7.983" class="difflineplus">+  _initLogging() {</span>
<a href="#l7.984"></a><span id="l7.984">     let formatter = new Log4Moz.BasicFormatter();</span>
<a href="#l7.985"></a><span id="l7.985">   let root = Log4Moz.repository.rootLogger;</span>
<a href="#l7.986"></a><span id="l7.986">     root.level = Log4Moz.Level.Debug;</span>
<a href="#l7.987"></a><span id="l7.987"> </span>
<a href="#l7.988"></a><span id="l7.988">   this._log = Log4Moz.repository.getLogger(&quot;SearchInt&quot;);</span>
<a href="#l7.989"></a><span id="l7.989"> </span>
<a href="#l7.990"></a><span id="l7.990">     let enableConsoleLogging = false;</span>
<a href="#l7.991"></a><span id="l7.991">     let enableDumpLogging = false;</span>
<a href="#l7.992"></a><span id="l7.992"> </span>
<a href="#l7.993"></a><span id="l7.993" class="difflineminus">-    try</span>
<a href="#l7.994"></a><span id="l7.994" class="difflineminus">-    {</span>
<a href="#l7.995"></a><span id="l7.995" class="difflineplus">+    try {</span>
<a href="#l7.996"></a><span id="l7.996">       enableConsoleLogging = this._prefBranch.getBoolPref(&quot;logging.console&quot;);</span>
<a href="#l7.997"></a><span id="l7.997">       enableDumpLogging = this._prefBranch.getBoolPref(&quot;logging.dump&quot;);</span>
<a href="#l7.998"></a><span id="l7.998" class="difflineminus">-    }</span>
<a href="#l7.999"></a><span id="l7.999" class="difflineminus">-    catch (ex) {}</span>
<a href="#l7.1000"></a><span id="l7.1000" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l7.1001"></a><span id="l7.1001"> </span>
<a href="#l7.1002"></a><span id="l7.1002" class="difflineminus">-    if (enableConsoleLogging)</span>
<a href="#l7.1003"></a><span id="l7.1003" class="difflineminus">-    {</span>
<a href="#l7.1004"></a><span id="l7.1004" class="difflineplus">+    if (enableConsoleLogging) {</span>
<a href="#l7.1005"></a><span id="l7.1005">       let capp = new Log4Moz.ConsoleAppender(formatter);</span>
<a href="#l7.1006"></a><span id="l7.1006">       capp.level = Log4Moz.Level.Warn;</span>
<a href="#l7.1007"></a><span id="l7.1007">       this._log.addAppender(capp);</span>
<a href="#l7.1008"></a><span id="l7.1008">     }</span>
<a href="#l7.1009"></a><span id="l7.1009" class="difflineminus">-    if (enableDumpLogging)</span>
<a href="#l7.1010"></a><span id="l7.1010" class="difflineminus">-    {</span>
<a href="#l7.1011"></a><span id="l7.1011" class="difflineplus">+    if (enableDumpLogging) {</span>
<a href="#l7.1012"></a><span id="l7.1012">       let dapp = new Log4Moz.DumpAppender(formatter);</span>
<a href="#l7.1013"></a><span id="l7.1013">       dapp.level = Log4Moz.Level.All;</span>
<a href="#l7.1014"></a><span id="l7.1014">       this._log.addAppender(dapp);</span>
<a href="#l7.1015"></a><span id="l7.1015">     }</span>
<a href="#l7.1016"></a><span id="l7.1016"> </span>
<a href="#l7.1017"></a><span id="l7.1017">     this._log.info(&quot;Logging initialized&quot;);</span>
<a href="#l7.1018"></a><span id="l7.1018" class="difflineminus">-  }</span>
<a href="#l7.1019"></a><span id="l7.1019" class="difflineplus">+  },</span>
<a href="#l7.1020"></a><span id="l7.1020"> };</span>
<a href="#l7.1021"></a><span id="l7.1021" class="difflineplus">+</span>
<a href="#l7.1022"></a><span id="l7.1022" class="difflineplus">+if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l7.1023"></a><span id="l7.1023" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger/content/WinSearchIntegration.js&quot;);</span>
<a href="#l7.1024"></a><span id="l7.1024" class="difflineplus">+} else if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l7.1025"></a><span id="l7.1025" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger/content/SpotlightIntegration.js&quot;);</span>
<a href="#l7.1026"></a><span id="l7.1026" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">rename from mail/components/search/SpotlightIntegration.js</span>
<a href="#l8.2"></a><span id="l8.2">rename to mail/components/search/content/SpotlightIntegration.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineminus">--- a/mail/components/search/SpotlightIntegration.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineplus">+++ b/mail/components/search/content/SpotlightIntegration.js</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineat">@@ -1,138 +1,124 @@</span>
<a href="#l8.6"></a><span id="l8.6"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.7"></a><span id="l8.7"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.8"></a><span id="l8.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.9"></a><span id="l8.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-#include searchCommon.js</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+// SearchIntegration.jsm</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+/* globals SearchIntegration, SearchSupport, Services */</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;SearchIntegration&quot;];</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> var MSG_DB_LARGE_COMMIT = 1;</span>
<a href="#l8.21"></a><span id="l8.21"> var gFileHeader = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&lt;!DOCTYPE plist PUBLIC \&quot;-//Apple Computer//DTD PLIST 1.0//EN\&quot; \&quot;http://www.apple.\ncom/DTDs/PropertyList-1.0.dtd\&quot;&gt;\n&lt;plist version=\&quot;1.0\&quot;&gt;\n&lt;dict&gt;&quot;;</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-var SearchIntegration =</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-{</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+SearchIntegration = { // eslint-disable-line no-global-assign</span>
<a href="#l8.26"></a><span id="l8.26">   __proto__: SearchSupport,</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-  /// The property of the header and (sometimes) folders that's used to check</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  /// if a message is indexed</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  // The property of the header and (sometimes) folders that's used to check</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  // if a message is indexed</span>
<a href="#l8.32"></a><span id="l8.32">   _hdrIndexedProperty: &quot;spotlight_reindex_time&quot;,</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  /// The file extension that is used for support files of this component</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  // The file extension that is used for support files of this component</span>
<a href="#l8.36"></a><span id="l8.36">   _fileExt: &quot;.mozeml&quot;,</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  /// The Spotlight pref base</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  // The Spotlight pref base</span>
<a href="#l8.40"></a><span id="l8.40">   _prefBase: &quot;mail.spotlight.&quot;,</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  /// The user's profile dir, which we'll cache and use a lot for path clean-up</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  get _profileDir()</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  // The user's profile dir, which we'll cache and use a lot for path clean-up</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  get _profileDir() {</span>
<a href="#l8.47"></a><span id="l8.47">     delete this._profileDir;</span>
<a href="#l8.48"></a><span id="l8.48">     return this._profileDir = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l8.49"></a><span id="l8.49">   },</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  get _metadataDir()</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-  {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  get _metadataDir() {</span>
<a href="#l8.54"></a><span id="l8.54">     delete this._metadataDir;</span>
<a href="#l8.55"></a><span id="l8.55">     let metadataDir = Services.dirsvc.get(&quot;Home&quot;, Ci.nsIFile);</span>
<a href="#l8.56"></a><span id="l8.56">     metadataDir.append(&quot;Library&quot;);</span>
<a href="#l8.57"></a><span id="l8.57">     metadataDir.append(&quot;Caches&quot;);</span>
<a href="#l8.58"></a><span id="l8.58">     metadataDir.append(&quot;Metadata&quot;);</span>
<a href="#l8.59"></a><span id="l8.59">     metadataDir.append(&quot;Thunderbird&quot;);</span>
<a href="#l8.60"></a><span id="l8.60">     return this._metadataDir = metadataDir;</span>
<a href="#l8.61"></a><span id="l8.61">   },</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-  /// Spotlight won't index files in the profile dir, but will use ~/Library/Caches/Metadata</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  _getSearchPathForFolder: function spotlight_get_search_path(aFolder)</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-  {</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  // Spotlight won't index files in the profile dir, but will use ~/Library/Caches/Metadata</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  _getSearchPathForFolder(aFolder) {</span>
<a href="#l8.68"></a><span id="l8.68">     // Swap the metadata dir for the profile dir prefix in the folder's path</span>
<a href="#l8.69"></a><span id="l8.69">     let folderPath = aFolder.filePath.path;</span>
<a href="#l8.70"></a><span id="l8.70">     let fixedPath = folderPath.replace(this._profileDir.path,</span>
<a href="#l8.71"></a><span id="l8.71">                                        this._metadataDir.path);</span>
<a href="#l8.72"></a><span id="l8.72">     let searchPath = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l8.73"></a><span id="l8.73">                        .createInstance(Ci.nsIFile);</span>
<a href="#l8.74"></a><span id="l8.74">     searchPath.initWithPath(fixedPath);</span>
<a href="#l8.75"></a><span id="l8.75">     return searchPath;</span>
<a href="#l8.76"></a><span id="l8.76">   },</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-  /// Replace ~/Library/Caches/Metadata with the profile directory, then convert</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  _getFolderForSearchPath: function spotlight_get_folder_for_search_path(aPath)</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-  {</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  // Replace ~/Library/Caches/Metadata with the profile directory, then convert</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  _getFolderForSearchPath(aPath) {</span>
<a href="#l8.83"></a><span id="l8.83">     let folderPath = aPath.path.replace(this._metadataDir.path,</span>
<a href="#l8.84"></a><span id="l8.84">                                         this._profileDir.path);</span>
<a href="#l8.85"></a><span id="l8.85">     let folderFile = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l8.86"></a><span id="l8.86">                       .createInstance(Ci.nsIFile);</span>
<a href="#l8.87"></a><span id="l8.87">     folderFile.initWithPath(folderPath);</span>
<a href="#l8.88"></a><span id="l8.88">     return MailUtils.getFolderForFileInProfile(folderFile);</span>
<a href="#l8.89"></a><span id="l8.89">   },</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-  _pathNeedsReindexing: function spotlight_pathNeedsReindexing(aPath) {</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  _pathNeedsReindexing(aPath) {</span>
<a href="#l8.93"></a><span id="l8.93">     // We used to set permissions incorrectly (see bug 670566).</span>
<a href="#l8.94"></a><span id="l8.94">     const PERM_DIRECTORY = parseInt(&quot;0755&quot;, 8);</span>
<a href="#l8.95"></a><span id="l8.95">     if (aPath.permissions != PERM_DIRECTORY) {</span>
<a href="#l8.96"></a><span id="l8.96">       aPath.permissions = PERM_DIRECTORY;</span>
<a href="#l8.97"></a><span id="l8.97">       return true;</span>
<a href="#l8.98"></a><span id="l8.98">     }</span>
<a href="#l8.99"></a><span id="l8.99">     return false;</span>
<a href="#l8.100"></a><span id="l8.100">   },</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102">   /**</span>
<a href="#l8.103"></a><span id="l8.103">    * These two functions won't do anything, as Spotlight integration is handled</span>
<a href="#l8.104"></a><span id="l8.104">    * using Info.plist files</span>
<a href="#l8.105"></a><span id="l8.105">    */</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-  register: function spotlight_register()</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-    return true;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-  },</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-  deregister: function spotlight_deregister()</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-  {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  register() {</span>
<a href="#l8.114"></a><span id="l8.114">     return true;</span>
<a href="#l8.115"></a><span id="l8.115">   },</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-  _init: function spotlight_init()</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-  {</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  deregister() {</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+    return true;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  },</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  _init() {</span>
<a href="#l8.124"></a><span id="l8.124">     this._initLogging();</span>
<a href="#l8.125"></a><span id="l8.125"> </span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-    let enabled;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-    try {</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-      enabled = this._prefBranch.getBoolPref(&quot;enable&quot;);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+    let enabled = this._prefBranch.getBoolPref(&quot;enable&quot;, false);</span>
<a href="#l8.132"></a><span id="l8.132">     if (enabled)</span>
<a href="#l8.133"></a><span id="l8.133">       this._log.info(&quot;Initializing Spotlight integration&quot;);</span>
<a href="#l8.134"></a><span id="l8.134">     this._initSupport(enabled);</span>
<a href="#l8.135"></a><span id="l8.135">   },</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-  /// The stream listener to read messages</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+  // The stream listener to read messages</span>
<a href="#l8.139"></a><span id="l8.139">   _streamListener: {</span>
<a href="#l8.140"></a><span id="l8.140">     __proto__: SearchSupport._streamListenerBase,</span>
<a href="#l8.141"></a><span id="l8.141"> </span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-    /// Buffer to store the message</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+    // Buffer to store the message</span>
<a href="#l8.144"></a><span id="l8.144">     _message: null,</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    /// Encodes reserved XML characters</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-    _xmlEscapeString: function spotlight_xml_escape_string(s)</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-    {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+    // Encodes reserved XML characters</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+    _xmlEscapeString(s) {</span>
<a href="#l8.151"></a><span id="l8.151">       return s.replace(/[&lt;&gt;&amp;]/g, function(s) {</span>
<a href="#l8.152"></a><span id="l8.152">         switch (s) {</span>
<a href="#l8.153"></a><span id="l8.153">           case &quot;&lt;&quot;: return &quot;&amp;lt;&quot;;</span>
<a href="#l8.154"></a><span id="l8.154">           case &quot;&gt;&quot;: return &quot;&amp;gt;&quot;;</span>
<a href="#l8.155"></a><span id="l8.155">           case &quot;&amp;&quot;: return &quot;&amp;amp;&quot;;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-          default: throw Error(&quot;Unexpected match&quot;);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+          default: throw &quot;Unexpected match&quot;;</span>
<a href="#l8.158"></a><span id="l8.158">           }</span>
<a href="#l8.159"></a><span id="l8.159">         }</span>
<a href="#l8.160"></a><span id="l8.160">       );</span>
<a href="#l8.161"></a><span id="l8.161">     },</span>
<a href="#l8.162"></a><span id="l8.162"> </span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-    onStartRequest: function(request, context) {</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    onStartRequest(request, context) {</span>
<a href="#l8.165"></a><span id="l8.165">       try {</span>
<a href="#l8.166"></a><span id="l8.166">         let outputFileStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l8.167"></a><span id="l8.167">                                .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l8.168"></a><span id="l8.168">         outputFileStream.init(this._outputFile, -1, -1, 0);</span>
<a href="#l8.169"></a><span id="l8.169">         this._outputStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l8.170"></a><span id="l8.170">                                .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l8.171"></a><span id="l8.171">         this._outputStream.init(outputFileStream, &quot;UTF-8&quot;);</span>
<a href="#l8.172"></a><span id="l8.172"> </span>
<a href="#l8.173"></a><span id="l8.173" class="difflineat">@@ -159,21 +145,22 @@ var SearchIntegration =</span>
<a href="#l8.174"></a><span id="l8.174">           &quot;&lt;/string&gt;\n&lt;key&gt;kMDItemTextContent&lt;/key&gt;\n&lt;string&gt;&quot;);</span>
<a href="#l8.175"></a><span id="l8.175">         this._outputStream.writeString(this._xmlEscapeString(</span>
<a href="#l8.176"></a><span id="l8.176">           this._msgHdr.mime2DecodedAuthor));</span>
<a href="#l8.177"></a><span id="l8.177">         this._outputStream.writeString(this._xmlEscapeString(</span>
<a href="#l8.178"></a><span id="l8.178">           this._msgHdr.mime2DecodedRecipients));</span>
<a href="#l8.179"></a><span id="l8.179"> </span>
<a href="#l8.180"></a><span id="l8.180">         this._outputStream.writeString(escapedSubject);</span>
<a href="#l8.181"></a><span id="l8.181">         this._outputStream.writeString(&quot; &quot;);</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+      } catch (ex) {</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+        this._onDoneStreaming(false);</span>
<a href="#l8.184"></a><span id="l8.184">       }</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-      catch (ex) { this._onDoneStreaming(false); }</span>
<a href="#l8.186"></a><span id="l8.186">     },</span>
<a href="#l8.187"></a><span id="l8.187"> </span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-    onStopRequest: function(request, context, status, errorMsg) {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+    onStopRequest(request, context, status, errorMsg) {</span>
<a href="#l8.190"></a><span id="l8.190">       try {</span>
<a href="#l8.191"></a><span id="l8.191">         // we want to write out the from, to, cc, and subject headers into the</span>
<a href="#l8.192"></a><span id="l8.192">         // Text Content value, so they'll be indexed.</span>
<a href="#l8.193"></a><span id="l8.193">         let stringStream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l8.194"></a><span id="l8.194">                              .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l8.195"></a><span id="l8.195">         stringStream.setData(this._message, this._message.length);</span>
<a href="#l8.196"></a><span id="l8.196">         let folder = this._msgHdr.folder;</span>
<a href="#l8.197"></a><span id="l8.197">         let text = folder.getMsgTextFromStream(stringStream,</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineat">@@ -185,42 +172,39 @@ var SearchIntegration =</span>
<a href="#l8.199"></a><span id="l8.199">         // close out the content, dict, and plist</span>
<a href="#l8.200"></a><span id="l8.200">         this._outputStream.writeString(&quot;&lt;/string&gt;\n&lt;/dict&gt;\n&lt;/plist&gt;\n&quot;);</span>
<a href="#l8.201"></a><span id="l8.201"> </span>
<a href="#l8.202"></a><span id="l8.202">         this._msgHdr.setUint32Property(SearchIntegration._hdrIndexedProperty,</span>
<a href="#l8.203"></a><span id="l8.203">                                        this._reindexTime);</span>
<a href="#l8.204"></a><span id="l8.204">         folder.msgDatabase.Commit(MSG_DB_LARGE_COMMIT);</span>
<a href="#l8.205"></a><span id="l8.205"> </span>
<a href="#l8.206"></a><span id="l8.206">         this._message = &quot;&quot;;</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-      }</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-      catch (ex) {</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+      } catch (ex) {</span>
<a href="#l8.210"></a><span id="l8.210">         SearchIntegration._log.error(ex);</span>
<a href="#l8.211"></a><span id="l8.211">         this._onDoneStreaming(false);</span>
<a href="#l8.212"></a><span id="l8.212">         return;</span>
<a href="#l8.213"></a><span id="l8.213">       }</span>
<a href="#l8.214"></a><span id="l8.214">       this._onDoneStreaming(true);</span>
<a href="#l8.215"></a><span id="l8.215">     },</span>
<a href="#l8.216"></a><span id="l8.216"> </span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-    onDataAvailable: function(request, context, inputStream, offset, count) {</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+    onDataAvailable(request, context, inputStream, offset, count) {</span>
<a href="#l8.219"></a><span id="l8.219">       try {</span>
<a href="#l8.220"></a><span id="l8.220">         let inStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l8.221"></a><span id="l8.221">                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l8.222"></a><span id="l8.222">         inStream.init(inputStream);</span>
<a href="#l8.223"></a><span id="l8.223"> </span>
<a href="#l8.224"></a><span id="l8.224">         // It is necessary to read in data from the input stream</span>
<a href="#l8.225"></a><span id="l8.225">         let inData = inStream.read(count);</span>
<a href="#l8.226"></a><span id="l8.226"> </span>
<a href="#l8.227"></a><span id="l8.227">         // ignore stuff after the first 20K or so</span>
<a href="#l8.228"></a><span id="l8.228">         if (this._message &amp;&amp; this._message.length &gt; 20000)</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-          return 0;</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+          return;</span>
<a href="#l8.231"></a><span id="l8.231"> </span>
<a href="#l8.232"></a><span id="l8.232">         this._message += inData;</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-        return 0;</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-      }</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-      catch (ex) {</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+      } catch (ex) {</span>
<a href="#l8.237"></a><span id="l8.237">         SearchIntegration._log.error(ex);</span>
<a href="#l8.238"></a><span id="l8.238">         this._onDoneStreaming(false);</span>
<a href="#l8.239"></a><span id="l8.239">       }</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-    }</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-  }</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+    },</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+  },</span>
<a href="#l8.244"></a><span id="l8.244"> };</span>
<a href="#l8.245"></a><span id="l8.245"> </span>
<a href="#l8.246"></a><span id="l8.246"> SearchIntegration._init();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">rename from mail/components/search/WinSearchIntegration.js</span>
<a href="#l9.2"></a><span id="l9.2">rename to mail/components/search/content/WinSearchIntegration.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineminus">--- a/mail/components/search/WinSearchIntegration.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineplus">+++ b/mail/components/search/content/WinSearchIntegration.js</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineat">@@ -1,178 +1,165 @@</span>
<a href="#l9.6"></a><span id="l9.6"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.7"></a><span id="l9.7"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.8"></a><span id="l9.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.9"></a><span id="l9.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-#include searchCommon.js</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+// SearchIntegration.jsm</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+/* globals SearchIntegration, SearchSupport, Services */</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;SearchIntegration&quot;];</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> var MSG_DB_LARGE_COMMIT = 1;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-var CRLF=&quot;\r\n&quot;;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+var CRLF = &quot;\r\n&quot;;</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24"> /**</span>
<a href="#l9.25"></a><span id="l9.25">  * Required to access the 64-bit registry, even though we're probably a 32-bit</span>
<a href="#l9.26"></a><span id="l9.26">  * program</span>
<a href="#l9.27"></a><span id="l9.27">  */</span>
<a href="#l9.28"></a><span id="l9.28"> var ACCESS_WOW64_64KEY = 0x0100;</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30"> /**</span>
<a href="#l9.31"></a><span id="l9.31">  * The contract ID for the helper service.</span>
<a href="#l9.32"></a><span id="l9.32">  */</span>
<a href="#l9.33"></a><span id="l9.33"> var WINSEARCHHELPER_CONTRACTID = &quot;@mozilla.org/mail/windows-search-helper;1&quot;;</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35"> /**</span>
<a href="#l9.36"></a><span id="l9.36">  * All the registry keys required for integration</span>
<a href="#l9.37"></a><span id="l9.37">  */</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-var gRegKeys =</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-[</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+var gRegKeys = [</span>
<a href="#l9.41"></a><span id="l9.41">   // This is the property handler</span>
<a href="#l9.42"></a><span id="l9.42">   {</span>
<a href="#l9.43"></a><span id="l9.43">     root: Ci.nsIWindowsRegKey.ROOT_KEY_LOCAL_MACHINE,</span>
<a href="#l9.44"></a><span id="l9.44">     key: &quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PropertySystem\\PropertyHandlers\\.wdseml&quot;,</span>
<a href="#l9.45"></a><span id="l9.45">     name: &quot;&quot;,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-    value: &quot;{5FA29220-36A1-40f9-89C6-F4B384B7642E}&quot;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    value: &quot;{5FA29220-36A1-40f9-89C6-F4B384B7642E}&quot;,</span>
<a href="#l9.48"></a><span id="l9.48">   },</span>
<a href="#l9.49"></a><span id="l9.49">   // These two are the association with the MIME IFilter</span>
<a href="#l9.50"></a><span id="l9.50">   {</span>
<a href="#l9.51"></a><span id="l9.51">     root: Ci.nsIWindowsRegKey.ROOT_KEY_CLASSES_ROOT,</span>
<a href="#l9.52"></a><span id="l9.52">     key: &quot;.wdseml&quot;,</span>
<a href="#l9.53"></a><span id="l9.53">     name: &quot;Content Type&quot;,</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    value: &quot;message/rfc822&quot;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    value: &quot;message/rfc822&quot;,</span>
<a href="#l9.56"></a><span id="l9.56">   },</span>
<a href="#l9.57"></a><span id="l9.57">   {</span>
<a href="#l9.58"></a><span id="l9.58">     root: Ci.nsIWindowsRegKey.ROOT_KEY_CLASSES_ROOT,</span>
<a href="#l9.59"></a><span id="l9.59">     key: &quot;.wdseml\\PersistentHandler&quot;,</span>
<a href="#l9.60"></a><span id="l9.60">     name: &quot;&quot;,</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-    value: &quot;{5645c8c4-e277-11cf-8fda-00aa00a14f93}&quot;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    value: &quot;{5645c8c4-e277-11cf-8fda-00aa00a14f93}&quot;,</span>
<a href="#l9.63"></a><span id="l9.63">   },</span>
<a href="#l9.64"></a><span id="l9.64">   // This is the association with the Windows mail preview handler</span>
<a href="#l9.65"></a><span id="l9.65">   {</span>
<a href="#l9.66"></a><span id="l9.66">     root: Ci.nsIWindowsRegKey.ROOT_KEY_CLASSES_ROOT,</span>
<a href="#l9.67"></a><span id="l9.67">     key: &quot;.wdseml\\shellex\\{8895B1C6-B41F-4C1C-A562-0D564250836F}&quot;,</span>
<a href="#l9.68"></a><span id="l9.68">     name: &quot;&quot;,</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    value: &quot;{b9815375-5d7f-4ce2-9245-c9d4da436930}&quot;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+    value: &quot;{b9815375-5d7f-4ce2-9245-c9d4da436930}&quot;,</span>
<a href="#l9.71"></a><span id="l9.71">   },</span>
<a href="#l9.72"></a><span id="l9.72">   // This is the association made to display results under email</span>
<a href="#l9.73"></a><span id="l9.73">   {</span>
<a href="#l9.74"></a><span id="l9.74">     root: Ci.nsIWindowsRegKey.ROOT_KEY_LOCAL_MACHINE,</span>
<a href="#l9.75"></a><span id="l9.75">     key: &quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\explorer\\KindMap&quot;,</span>
<a href="#l9.76"></a><span id="l9.76">     name: &quot;.wdseml&quot;,</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-    value: &quot;email;communication&quot;</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-  }</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+    value: &quot;email;communication&quot;,</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  },</span>
<a href="#l9.81"></a><span id="l9.81"> ];</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83"> /**</span>
<a href="#l9.84"></a><span id="l9.84">  * @namespace Windows Search-specific desktop search integration functionality</span>
<a href="#l9.85"></a><span id="l9.85">  */</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-var SearchIntegration =</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-{</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+SearchIntegration = { // eslint-disable-line no-global-assign</span>
<a href="#l9.89"></a><span id="l9.89">   __proto__: SearchSupport,</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-  /// The property of the header and (sometimes) folders that's used to check</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-  /// if a message is indexed</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+  // The property of the header and (sometimes) folders that's used to check</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  // if a message is indexed</span>
<a href="#l9.95"></a><span id="l9.95">   _hdrIndexedProperty: &quot;winsearch_reindex_time&quot;,</span>
<a href="#l9.96"></a><span id="l9.96"> </span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-  /// The file extension that is used for support files of this component</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+  // The file extension that is used for support files of this component</span>
<a href="#l9.99"></a><span id="l9.99">   _fileExt: &quot;.wdseml&quot;,</span>
<a href="#l9.100"></a><span id="l9.100"> </span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-  /// The Windows Search pref base</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  // The Windows Search pref base</span>
<a href="#l9.103"></a><span id="l9.103">   _prefBase: &quot;mail.winsearch.&quot;,</span>
<a href="#l9.104"></a><span id="l9.104"> </span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-  /// Helper (native) component</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  // Helper (native) component</span>
<a href="#l9.107"></a><span id="l9.107">   __winSearchHelper: null,</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-  get _winSearchHelper()</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-  {</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+  get _winSearchHelper() {</span>
<a href="#l9.111"></a><span id="l9.111">     if (!this.__winSearchHelper)</span>
<a href="#l9.112"></a><span id="l9.112">       this.__winSearchHelper = Cc[WINSEARCHHELPER_CONTRACTID]</span>
<a href="#l9.113"></a><span id="l9.113">                                  .getService(Ci.nsIMailWinSearchHelper);</span>
<a href="#l9.114"></a><span id="l9.114">     return this.__winSearchHelper;</span>
<a href="#l9.115"></a><span id="l9.115">   },</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-  /// Whether the folders are already in the crawl scope</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  get _foldersInCrawlScope()</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-  {</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  // Whether the folders are already in the crawl scope</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+  get _foldersInCrawlScope() {</span>
<a href="#l9.122"></a><span id="l9.122">     return this._winSearchHelper.foldersInCrawlScope;</span>
<a href="#l9.123"></a><span id="l9.123">   },</span>
<a href="#l9.124"></a><span id="l9.124"> </span>
<a href="#l9.125"></a><span id="l9.125">   /**</span>
<a href="#l9.126"></a><span id="l9.126">    * Whether all the required registry keys are present</span>
<a href="#l9.127"></a><span id="l9.127">    * We'll be optimistic here and assume that once the registry keys have been</span>
<a href="#l9.128"></a><span id="l9.128">    * added, they won't be removed, at least while Thunderbird is open</span>
<a href="#l9.129"></a><span id="l9.129">    */</span>
<a href="#l9.130"></a><span id="l9.130">   __regKeysPresent: false,</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-  get _regKeysPresent()</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-  {</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-    if (!this.__regKeysPresent)</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-    {</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-      for (let i = 0; i &lt; gRegKeys.length; i++)</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-      {</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+  get _regKeysPresent() {</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    if (!this.__regKeysPresent) {</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+      for (let i = 0; i &lt; gRegKeys.length; i++) {</span>
<a href="#l9.140"></a><span id="l9.140">         let regKey = Cc[&quot;@mozilla.org/windows-registry-key;1&quot;]</span>
<a href="#l9.141"></a><span id="l9.141">                        .createInstance(Ci.nsIWindowsRegKey);</span>
<a href="#l9.142"></a><span id="l9.142">         try {</span>
<a href="#l9.143"></a><span id="l9.143">           regKey.open(gRegKeys[i].root, gRegKeys[i].key, regKey.ACCESS_READ |</span>
<a href="#l9.144"></a><span id="l9.144">                                                          ACCESS_WOW64_64KEY);</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+        } catch (e) {</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+          return false;</span>
<a href="#l9.147"></a><span id="l9.147">         }</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-        catch (e) { return false; }</span>
<a href="#l9.149"></a><span id="l9.149">         let valuePresent = regKey.hasValue(gRegKeys[i].name) &amp;&amp;</span>
<a href="#l9.150"></a><span id="l9.150">                            (regKey.readStringValue(gRegKeys[i].name) ==</span>
<a href="#l9.151"></a><span id="l9.151">                             gRegKeys[i].value);</span>
<a href="#l9.152"></a><span id="l9.152">         regKey.close();</span>
<a href="#l9.153"></a><span id="l9.153">         if (!valuePresent)</span>
<a href="#l9.154"></a><span id="l9.154">           return false;</span>
<a href="#l9.155"></a><span id="l9.155">       }</span>
<a href="#l9.156"></a><span id="l9.156">       this.__regKeysPresent = true;</span>
<a href="#l9.157"></a><span id="l9.157">     }</span>
<a href="#l9.158"></a><span id="l9.158">     return true;</span>
<a href="#l9.159"></a><span id="l9.159">   },</span>
<a href="#l9.160"></a><span id="l9.160"> </span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-  /// Use the folder's path (i.e., in profile dir) as is</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-  _getSearchPathForFolder: function winsearch_get_search_path(aFolder)</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-  {</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+  // Use the folder's path (i.e., in profile dir) as is</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  _getSearchPathForFolder(aFolder) {</span>
<a href="#l9.166"></a><span id="l9.166">     return aFolder.filePath;</span>
<a href="#l9.167"></a><span id="l9.167">   },</span>
<a href="#l9.168"></a><span id="l9.168"> </span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-  /// Use the search path as is</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-  _getFolderForSearchPath: function winsearch_get_folder_for_search_path(aDir)</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-  {</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+  // Use the search path as is</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+  _getFolderForSearchPath(aDir) {</span>
<a href="#l9.174"></a><span id="l9.174">     return MailUtils.getFolderForFileInProfile(aDir);</span>
<a href="#l9.175"></a><span id="l9.175">   },</span>
<a href="#l9.176"></a><span id="l9.176"> </span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-  _pathNeedsReindexing: function winsearch_pathNeedsReindexing(aPath) {</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+  _pathNeedsReindexing(aPath) {</span>
<a href="#l9.179"></a><span id="l9.179">     // only needed on MacOSX (see bug 670566).</span>
<a href="#l9.180"></a><span id="l9.180">     return false;</span>
<a href="#l9.181"></a><span id="l9.181">   },</span>
<a href="#l9.182"></a><span id="l9.182"> </span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-  _init: function winsearch_init()</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-  {</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+  _init() {</span>
<a href="#l9.186"></a><span id="l9.186">     this._initLogging();</span>
<a href="#l9.187"></a><span id="l9.187">     // If the helper service isn't present, we weren't compiled with the needed</span>
<a href="#l9.188"></a><span id="l9.188">     // support. Mark ourselves null and return</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-    if (!(WINSEARCHHELPER_CONTRACTID in Cc))</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-    {</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-      SearchIntegration = null;</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+    if (!(WINSEARCHHELPER_CONTRACTID in Cc)) {</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+      SearchIntegration = null; // eslint-disable-line no-global-assign</span>
<a href="#l9.194"></a><span id="l9.194">       return;</span>
<a href="#l9.195"></a><span id="l9.195">     }</span>
<a href="#l9.196"></a><span id="l9.196"> </span>
<a href="#l9.197"></a><span id="l9.197">     // The search module is currently only enabled on Vista and above,</span>
<a href="#l9.198"></a><span id="l9.198">     // and the app can only be installed on Windows 7 and above.</span>
<a href="#l9.199"></a><span id="l9.199">     this.osVersionTooLow = false;</span>
<a href="#l9.200"></a><span id="l9.200"> </span>
<a href="#l9.201"></a><span id="l9.201">     let serviceRunning = false;</span>
<a href="#l9.202"></a><span id="l9.202">     try {</span>
<a href="#l9.203"></a><span id="l9.203">       serviceRunning = this._winSearchHelper.serviceRunning;</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-    }</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-    catch (e) {}</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+    } catch (e) {}</span>
<a href="#l9.207"></a><span id="l9.207">     // If the service isn't running, then we should stay in backoff mode</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-    if (!serviceRunning)</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-    {</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+    if (!serviceRunning) {</span>
<a href="#l9.211"></a><span id="l9.211">       this._log.info(&quot;Windows Search service not running&quot;);</span>
<a href="#l9.212"></a><span id="l9.212">       this.osComponentsNotRunning = true;</span>
<a href="#l9.213"></a><span id="l9.213">       this._initSupport(false);</span>
<a href="#l9.214"></a><span id="l9.214">       return;</span>
<a href="#l9.215"></a><span id="l9.215">     }</span>
<a href="#l9.216"></a><span id="l9.216"> </span>
<a href="#l9.217"></a><span id="l9.217">     let enabled = this.prefEnabled;</span>
<a href="#l9.218"></a><span id="l9.218"> </span>
<a href="#l9.219"></a><span id="l9.219" class="difflineat">@@ -182,78 +169,78 @@ var SearchIntegration =</span>
<a href="#l9.220"></a><span id="l9.220">   },</span>
<a href="#l9.221"></a><span id="l9.221"> </span>
<a href="#l9.222"></a><span id="l9.222">   /**</span>
<a href="#l9.223"></a><span id="l9.223">    * Add necessary hooks to Windows</span>
<a href="#l9.224"></a><span id="l9.224">    *</span>
<a href="#l9.225"></a><span id="l9.225">    * @return false if registration did not succeed, because the elevation</span>
<a href="#l9.226"></a><span id="l9.226">    * request was denied</span>
<a href="#l9.227"></a><span id="l9.227">    */</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-  register: function winsearch_register()</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-  {</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+  register() {</span>
<a href="#l9.231"></a><span id="l9.231">     // If any of the two are not present, we need to elevate.</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-    if (!this._foldersInCrawlScope || !this._regKeysPresent)</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-    {</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+    if (!this._foldersInCrawlScope || !this._regKeysPresent) {</span>
<a href="#l9.235"></a><span id="l9.235">       try {</span>
<a href="#l9.236"></a><span id="l9.236">         this._winSearchHelper.runSetup(true);</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+      } catch (e) {</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+        return false;</span>
<a href="#l9.239"></a><span id="l9.239">       }</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-      catch (e) { return false; }</span>
<a href="#l9.241"></a><span id="l9.241">     }</span>
<a href="#l9.242"></a><span id="l9.242"> </span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-    if (!this._winSearchHelper.isFileAssociationSet)</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-    {</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+    if (!this._winSearchHelper.isFileAssociationSet) {</span>
<a href="#l9.246"></a><span id="l9.246">       try {</span>
<a href="#l9.247"></a><span id="l9.247">         this._winSearchHelper.setFileAssociation();</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+      } catch (e) {</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+        this._log.warn(&quot;File association not set&quot;);</span>
<a href="#l9.250"></a><span id="l9.250">       }</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-      catch (e) { this._log.warn(&quot;File association not set&quot;); }</span>
<a href="#l9.252"></a><span id="l9.252">     }</span>
<a href="#l9.253"></a><span id="l9.253">     // Also set the FANCI bit to 0 for the profile directory</span>
<a href="#l9.254"></a><span id="l9.254">     let profD = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l9.255"></a><span id="l9.255">     this._winSearchHelper.setFANCIBit(profD, false, true);</span>
<a href="#l9.256"></a><span id="l9.256"> </span>
<a href="#l9.257"></a><span id="l9.257">     return true;</span>
<a href="#l9.258"></a><span id="l9.258">   },</span>
<a href="#l9.259"></a><span id="l9.259"> </span>
<a href="#l9.260"></a><span id="l9.260">   /**</span>
<a href="#l9.261"></a><span id="l9.261">    * Remove integration from Windows. The only thing removed is the directory</span>
<a href="#l9.262"></a><span id="l9.262">    * from the index list. This will ask for elevation.</span>
<a href="#l9.263"></a><span id="l9.263">    *</span>
<a href="#l9.264"></a><span id="l9.264">    * @return false if deregistration did not succeed, because the elevation</span>
<a href="#l9.265"></a><span id="l9.265">    * request was denied</span>
<a href="#l9.266"></a><span id="l9.266">    */</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-  deregister: function winsearch_deregister()</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-  {</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+  deregister() {</span>
<a href="#l9.270"></a><span id="l9.270">     try {</span>
<a href="#l9.271"></a><span id="l9.271">       this._winSearchHelper.runSetup(false);</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+    } catch (e) {</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineplus">+      return false;</span>
<a href="#l9.274"></a><span id="l9.274">     }</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-    catch (e) { return false; }</span>
<a href="#l9.276"></a><span id="l9.276"> </span>
<a href="#l9.277"></a><span id="l9.277">     return true;</span>
<a href="#l9.278"></a><span id="l9.278">   },</span>
<a href="#l9.279"></a><span id="l9.279"> </span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-  /// The stream listener to read messages</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+  // The stream listener to read messages</span>
<a href="#l9.282"></a><span id="l9.282">   _streamListener: {</span>
<a href="#l9.283"></a><span id="l9.283">     __proto__: SearchSupport._streamListenerBase,</span>
<a href="#l9.284"></a><span id="l9.284"> </span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-    /// Buffer to store the message</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineplus">+    // Buffer to store the message</span>
<a href="#l9.287"></a><span id="l9.287">     _message: &quot;&quot;,</span>
<a href="#l9.288"></a><span id="l9.288"> </span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-    onStartRequest: function(request, context) {</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+    onStartRequest(request, context) {</span>
<a href="#l9.291"></a><span id="l9.291">       try {</span>
<a href="#l9.292"></a><span id="l9.292">         let outputFileStream =  Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l9.293"></a><span id="l9.293">                                   .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l9.294"></a><span id="l9.294">         outputFileStream.init(this._outputFile, -1, -1, 0);</span>
<a href="#l9.295"></a><span id="l9.295">         this._outputStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l9.296"></a><span id="l9.296">                                .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l9.297"></a><span id="l9.297">         this._outputStream.init(outputFileStream, &quot;UTF-8&quot;);</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineplus">+      } catch (ex) {</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineplus">+        this._onDoneStreaming(false);</span>
<a href="#l9.300"></a><span id="l9.300">       }</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-      catch (ex) { this._onDoneStreaming(false); }</span>
<a href="#l9.302"></a><span id="l9.302">     },</span>
<a href="#l9.303"></a><span id="l9.303"> </span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-    onStopRequest: function(request, context, status, errorMsg) {</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineplus">+    onStopRequest(request, context, status, errorMsg) {</span>
<a href="#l9.306"></a><span id="l9.306">       try {</span>
<a href="#l9.307"></a><span id="l9.307">         // XXX Once the JS emitter gets checked in, this code should probably be</span>
<a href="#l9.308"></a><span id="l9.308">         // switched over to use that</span>
<a href="#l9.309"></a><span id="l9.309">         // Decode using getMsgTextFromStream</span>
<a href="#l9.310"></a><span id="l9.310">         let stringStream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l9.311"></a><span id="l9.311">                              .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l9.312"></a><span id="l9.312">         stringStream.setData(this._message, this._message.length);</span>
<a href="#l9.313"></a><span id="l9.313">         let contentType = {};</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineat">@@ -293,42 +280,39 @@ var SearchIntegration =</span>
<a href="#l9.315"></a><span id="l9.315">         this._outputStream.writeString(text + CRLF + CRLF);</span>
<a href="#l9.316"></a><span id="l9.316"> </span>
<a href="#l9.317"></a><span id="l9.317">         this._msgHdr.setUint32Property(SearchIntegration._hdrIndexedProperty,</span>
<a href="#l9.318"></a><span id="l9.318">                                        this._reindexTime);</span>
<a href="#l9.319"></a><span id="l9.319">         folder.msgDatabase.Commit(MSG_DB_LARGE_COMMIT);</span>
<a href="#l9.320"></a><span id="l9.320"> </span>
<a href="#l9.321"></a><span id="l9.321">         this._message = &quot;&quot;;</span>
<a href="#l9.322"></a><span id="l9.322">         SearchIntegration._log.info(&quot;Successfully written file&quot;);</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-      }</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-      catch (ex) {</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineplus">+      } catch (ex) {</span>
<a href="#l9.326"></a><span id="l9.326">         SearchIntegration._log.error(ex);</span>
<a href="#l9.327"></a><span id="l9.327">         this._onDoneStreaming(false);</span>
<a href="#l9.328"></a><span id="l9.328">         return;</span>
<a href="#l9.329"></a><span id="l9.329">       }</span>
<a href="#l9.330"></a><span id="l9.330">       this._onDoneStreaming(true);</span>
<a href="#l9.331"></a><span id="l9.331">     },</span>
<a href="#l9.332"></a><span id="l9.332"> </span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-    onDataAvailable: function(request, context, inputStream, offset, count) {</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineplus">+    onDataAvailable(request, context, inputStream, offset, count) {</span>
<a href="#l9.335"></a><span id="l9.335">       try {</span>
<a href="#l9.336"></a><span id="l9.336">         let inStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l9.337"></a><span id="l9.337">                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l9.338"></a><span id="l9.338">         inStream.init(inputStream);</span>
<a href="#l9.339"></a><span id="l9.339"> </span>
<a href="#l9.340"></a><span id="l9.340">         // It is necessary to read in data from the input stream</span>
<a href="#l9.341"></a><span id="l9.341">         let inData = inStream.read(count);</span>
<a href="#l9.342"></a><span id="l9.342"> </span>
<a href="#l9.343"></a><span id="l9.343">         // Ignore stuff after the first 50K or so</span>
<a href="#l9.344"></a><span id="l9.344">         if (this._message &amp;&amp; this._message.length &gt; 50000)</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-          return 0;</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+          return;</span>
<a href="#l9.347"></a><span id="l9.347"> </span>
<a href="#l9.348"></a><span id="l9.348">         this._message += inData;</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-        return 0;</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-      }</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-      catch (ex) {</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+      } catch (ex) {</span>
<a href="#l9.353"></a><span id="l9.353">         SearchIntegration._log.error(ex);</span>
<a href="#l9.354"></a><span id="l9.354">         this._onDoneStreaming(false);</span>
<a href="#l9.355"></a><span id="l9.355">       }</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-    }</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-  }</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+    },</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+  },</span>
<a href="#l9.360"></a><span id="l9.360"> };</span>
<a href="#l9.361"></a><span id="l9.361"> </span>
<a href="#l9.362"></a><span id="l9.362"> SearchIntegration._init();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/search/jar.mn</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/search/jar.mn</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,8 +1,14 @@</span>
<a href="#l10.4"></a><span id="l10.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> messenger.jar:</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-        searchplugins/                                              (searchplugins/**)</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+    searchplugins/                            (searchplugins/**)</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+    content/messenger/SpotlightIntegration.js (content/SpotlightIntegration.js)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#endif</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+    content/messenger/WinSearchIntegration.js (content/WinSearchIntegration.js)</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+#endif</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18"> % resource search-plugins %searchplugins/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/search/moz.build</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/search/moz.build</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,21 +1,19 @@</span>
<a href="#l11.4"></a><span id="l11.4"> # vim: set filetype=python:</span>
<a href="#l11.5"></a><span id="l11.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'cocoa':</span>
<a href="#l11.10"></a><span id="l11.10">     DIRS += ['mdimporter']</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-    EXTRA_PP_JS_MODULES += ['SpotlightIntegration.js']</span>
<a href="#l11.12"></a><span id="l11.12"> elif CONFIG['MOZ_WIDGET_TOOLKIT'] == 'windows':</span>
<a href="#l11.13"></a><span id="l11.13">     DIRS += ['wsenable']</span>
<a href="#l11.14"></a><span id="l11.14">     SOURCES += ['nsMailWinSearchHelper.cpp']</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-    EXTRA_PP_JS_MODULES += ['WinSearchIntegration.js']</span>
<a href="#l11.16"></a><span id="l11.16">     FINAL_LIBRARY = 'mailcomps'</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> DIRS += ['public']</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-EXTRA_PP_JS_MODULES += [</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-    'SearchIntegration.js',</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+    'SearchIntegration.jsm',</span>
<a href="#l11.24"></a><span id="l11.24"> ]</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26"> JAR_MANIFESTS += ['jar.mn']</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

