<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5911:7d067bc2575cbcdd6c283eafd15f0077fb3299e0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7d067bc2575cbcdd6c283eafd15f0077fb3299e0" />
<meta property="og:url" content="/comm-central/rev/7d067bc2575cbcdd6c283eafd15f0077fb3299e0" />
<meta property="og:description" content="fix bug 562104, crash when subscribed to imap folder '/', r/sr=standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7d067bc2575cbcdd6c283eafd15f0077fb3299e0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7d067bc2575cbcdd6c283eafd15f0077fb3299e0">shortlog</a> |
<a href="/comm-central/log/7d067bc2575cbcdd6c283eafd15f0077fb3299e0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7d067bc2575cbcdd6c283eafd15f0077fb3299e0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7d067bc2575cbcdd6c283eafd15f0077fb3299e0">files</a> |
changeset |
<a href="/comm-central/raw-rev/7d067bc2575cbcdd6c283eafd15f0077fb3299e0">raw</a>  | <a href="/comm-central/archive/7d067bc2575cbcdd6c283eafd15f0077fb3299e0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=562104">bug 562104</a>, crash when subscribed to imap folder '/', r/sr=standard8
<span class="logtags"><span class="inbranchtag" title="COMM193a5_20100623_RELBRANCH">COMM193a5_20100623_RELBRANCH</span> </span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 24 Jun 2010 07:24:31 -0700</td></tr>
<tr><td>branch</td><td>COMM193a5_20100623_RELBRANCH</td></tr>
<tr>
 <td>changeset 5911</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7d067bc2575cbcdd6c283eafd15f0077fb3299e0">7d067bc2575cbcdd6c283eafd15f0077fb3299e0</a></td>
</tr>



<tr>
<td>parent 5910</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/51b6b3c86072ca4edb6fb43f572cade8cae4ee1b">51b6b3c86072ca4edb6fb43f572cade8cae4ee1b</a>
</td>
</tr>

<tr>
<td>child 5912</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e0c779269296c7cb2b91b23754c80b4a32e340b7">e0c779269296c7cb2b91b23754c80b4a32e340b7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7d067bc2575cbcdd6c283eafd15f0077fb3299e0">4576</a></td></tr>
<tr><td>push user</td><td>kairo@kairo.at</td></tr>
<tr><td>push date</td><td class="date age">Tue, 29 Jun 2010 15:27:32 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e0c779269296 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e0c779269296c7cb2b91b23754c80b4a32e340b7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e0c779269296c7cb2b91b23754c80b4a32e340b7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0c779269296c7cb2b91b23754c80b4a32e340b7&newProject=comm-central&newRevision=c2d2f31db138a52a9f2b5ecc339ffe4b222bc0db&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0c779269296c7cb2b91b23754c80b4a32e340b7&newProject=comm-central&newRevision=c2d2f31db138a52a9f2b5ecc339ffe4b222bc0db&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0c779269296c7cb2b91b23754c80b4a32e340b7&newProject=comm-central&newRevision=c2d2f31db138a52a9f2b5ecc339ffe4b222bc0db&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=562104">562104</a></td></tr>




</table></div>

<div class="page_body description">fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=562104">bug 562104</a>, crash when subscribed to imap folder '/', r/sr=standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/test/unit/test_mailboxes.js">mailnews/imap/test/unit/test_mailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/test/unit/test_mailboxes.js">file</a> |
<a href="/comm-central/annotate/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/test/unit/test_mailboxes.js">annotate</a> |
<a href="/comm-central/diff/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/test/unit/test_mailboxes.js">diff</a> |
<a href="/comm-central/comparison/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/test/unit/test_mailboxes.js">comparison</a> |
<a href="/comm-central/log/7d067bc2575cbcdd6c283eafd15f0077fb3299e0/mailnews/imap/test/unit/test_mailboxes.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1052,16 +1052,18 @@ NS_IMETHODIMP nsImapIncomingServer::Poss</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   if(NS_FAILED(rv))</span>
<a href="#l1.6"></a><span id="l1.6">     return rv;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   nsCAutoString dupFolderPath(folderPath);</span>
<a href="#l1.9"></a><span id="l1.9">   if (dupFolderPath.Last() == '/')</span>
<a href="#l1.10"></a><span id="l1.10">   {</span>
<a href="#l1.11"></a><span id="l1.11">     dupFolderPath.SetLength(dupFolderPath.Length()-1);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    if (dupFolderPath.IsEmpty())</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l1.14"></a><span id="l1.14">     // *** this is what we did in 4.x in order to list uw folder only</span>
<a href="#l1.15"></a><span id="l1.15">     // mailbox in order to get the \NoSelect flag</span>
<a href="#l1.16"></a><span id="l1.16">     explicitlyVerify = !(boxFlags &amp; kNameSpace);</span>
<a href="#l1.17"></a><span id="l1.17">   }</span>
<a href="#l1.18"></a><span id="l1.18">   if (mDoingSubscribeDialog)</span>
<a href="#l1.19"></a><span id="l1.19">   {</span>
<a href="#l1.20"></a><span id="l1.20">     // Make sure the imapmailfolder object has the right delimiter because the unsubscribed</span>
<a href="#l1.21"></a><span id="l1.21">     // folders (those not in the 'lsub' list) have the delimiter set to the default ('^').</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -1160,17 +1162,18 @@ NS_IMETHODIMP nsImapIncomingServer::Poss</span>
<a href="#l1.23"></a><span id="l1.23">       a_nsIFolder-&gt;GetChildWithURI(parentUri, PR_TRUE, caseInsensitive, getter_AddRefs(parent));</span>
<a href="#l1.24"></a><span id="l1.24">       if (!parent /* || parentFolder-&gt;GetFolderNeedsAdded()*/)</span>
<a href="#l1.25"></a><span id="l1.25">       {</span>
<a href="#l1.26"></a><span id="l1.26">         PossibleImapMailbox(parentName, hierarchyDelimiter, kNoselect | // be defensive</span>
<a href="#l1.27"></a><span id="l1.27">           ((boxFlags  &amp; //only inherit certain flags from the child</span>
<a href="#l1.28"></a><span id="l1.28">           (kPublicMailbox | kOtherUsersMailbox | kPersonalMailbox))), &amp;parentIsNew);</span>
<a href="#l1.29"></a><span id="l1.29">       }</span>
<a href="#l1.30"></a><span id="l1.30">     }</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    hostFolder-&gt;CreateClientSubfolderInfo(dupFolderPath, hierarchyDelimiter,boxFlags, PR_FALSE);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    rv = hostFolder-&gt;CreateClientSubfolderInfo(dupFolderPath, hierarchyDelimiter,boxFlags, PR_FALSE);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.34"></a><span id="l1.34">     caseInsensitive = MsgLowerCaseEqualsLiteral(dupFolderPath, &quot;inbox&quot;);</span>
<a href="#l1.35"></a><span id="l1.35">     a_nsIFolder-&gt;GetChildWithURI(uri, PR_TRUE, caseInsensitive, getter_AddRefs(child));</span>
<a href="#l1.36"></a><span id="l1.36">   }</span>
<a href="#l1.37"></a><span id="l1.37">   if (child)</span>
<a href="#l1.38"></a><span id="l1.38">   {</span>
<a href="#l1.39"></a><span id="l1.39">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(child);</span>
<a href="#l1.40"></a><span id="l1.40">     if (imapFolder)</span>
<a href="#l1.41"></a><span id="l1.41">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -54,16 +54,26 @@ const gTestArray =</span>
<a href="#l2.4"></a><span id="l2.4">     gIMAPService.renameLeaf(uiThread, i18nChild, &quot;test \u00E4&quot;, UrlListener, null);</span>
<a href="#l2.5"></a><span id="l2.5">   },</span>
<a href="#l2.6"></a><span id="l2.6">   function checkRename() {</span>
<a href="#l2.7"></a><span id="l2.7">     do_check_true(rootFolder.containsChildNamed(&quot;test \u00E4&quot;));</span>
<a href="#l2.8"></a><span id="l2.8">     let newChild = rootFolder.getChildNamed(&quot;test \u00E4&quot;).</span>
<a href="#l2.9"></a><span id="l2.9">                    QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l2.10"></a><span id="l2.10">     newChild.updateFolderWithListener(null, UrlListener);</span>
<a href="#l2.11"></a><span id="l2.11">   },</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  function checkEmptyFolder() {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    try {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    let serverSink = gLocalServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+      serverSink.possibleImapMailbox(&quot;/&quot;, '/', 0);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    }</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    catch (ex) {</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+      // we expect this to fail, but not crash or assert.</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    }</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    do_timeout_function(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  },</span>
<a href="#l2.22"></a><span id="l2.22"> ];</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> function endTest()</span>
<a href="#l2.25"></a><span id="l2.25"> {</span>
<a href="#l2.26"></a><span id="l2.26">   // Clean up the server in preparation</span>
<a href="#l2.27"></a><span id="l2.27">   gServer.resetTest();</span>
<a href="#l2.28"></a><span id="l2.28">   gLocalServer.closeCachedConnections();</span>
<a href="#l2.29"></a><span id="l2.29">   gServer.performTest();</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineat">@@ -75,17 +85,17 @@ function doTest(test)</span>
<a href="#l2.31"></a><span id="l2.31"> {</span>
<a href="#l2.32"></a><span id="l2.32">   if (test &lt;= gTestArray.length)</span>
<a href="#l2.33"></a><span id="l2.33">   {</span>
<a href="#l2.34"></a><span id="l2.34">     dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l2.35"></a><span id="l2.35">     gCurTestNum = test;</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">     var testFn = gTestArray[test-1];</span>
<a href="#l2.38"></a><span id="l2.38">     // Set a limit of 10 seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    do_timeout_function(10000, function(){</span>
<a href="#l2.41"></a><span id="l2.41">         if (gCurTestNum == test) </span>
<a href="#l2.42"></a><span id="l2.42">           do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name + </span>
<a href="#l2.43"></a><span id="l2.43">             &quot;, current status is &quot; + gCurrStatus);</span>
<a href="#l2.44"></a><span id="l2.44">         }</span>
<a href="#l2.45"></a><span id="l2.45">       );</span>
<a href="#l2.46"></a><span id="l2.46">     try {</span>
<a href="#l2.47"></a><span id="l2.47">     testFn();</span>
<a href="#l2.48"></a><span id="l2.48">     } catch(ex) {do_throw(ex);}</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineat">@@ -108,11 +118,11 @@ var UrlListener =</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l2.52"></a><span id="l2.52">     // Check: message successfully copied.</span>
<a href="#l2.53"></a><span id="l2.53">     do_check_eq(aExitCode, 0);</span>
<a href="#l2.54"></a><span id="l2.54">     // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l2.55"></a><span id="l2.55">     // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l2.56"></a><span id="l2.56">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l2.57"></a><span id="l2.57">     // to return</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    do_timeout_function(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l2.60"></a><span id="l2.60">   }</span>
<a href="#l2.61"></a><span id="l2.61"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

