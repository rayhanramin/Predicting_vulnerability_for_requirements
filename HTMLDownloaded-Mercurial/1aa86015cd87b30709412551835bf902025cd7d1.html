<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 30034:1aa86015cd87b30709412551835bf902025cd7d1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1aa86015cd87b30709412551835bf902025cd7d1" />
<meta property="og:url" content="/comm-central/rev/1aa86015cd87b30709412551835bf902025cd7d1" />
<meta property="og:description" content="Bug 1648802 - Replace Thunderbird uses of NS_LITERAL_STRING/NS_LITERAL_CSTRING macros by _ns literals.. r=sg" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1aa86015cd87b30709412551835bf902025cd7d1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1aa86015cd87b30709412551835bf902025cd7d1">shortlog</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1aa86015cd87b30709412551835bf902025cd7d1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1">files</a> |
changeset |
<a href="/comm-central/raw-rev/1aa86015cd87b30709412551835bf902025cd7d1">raw</a>  | <a href="/comm-central/archive/1aa86015cd87b30709412551835bf902025cd7d1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1648802">Bug 1648802</a> - Replace Thunderbird uses of NS_LITERAL_STRING/NS_LITERAL_CSTRING macros by _ns literals.. r=sg
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#103;&#110;&#117;&#115;&#32;&#77;&#101;&#108;&#105;&#110;&#32;&#60;&#109;&#107;&#109;&#101;&#108;&#105;&#110;&#43;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#105;&#107;&#105;&#46;&#102;&#105;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 01 Jul 2020 16:15:43 +0300</td></tr>

<tr>
 <td>changeset 30034</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1aa86015cd87b30709412551835bf902025cd7d1">1aa86015cd87b30709412551835bf902025cd7d1</a></td>
</tr>



<tr>
<td>parent 30033</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/732ab4ae2b4e30db9f43178763f60ecf43574f72">732ab4ae2b4e30db9f43178763f60ecf43574f72</a>
</td>
</tr>

<tr>
<td>child 30035</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9e21e4f7e980493fb6bf1478c3ae4f8ca1182bbd">9e21e4f7e980493fb6bf1478c3ae4f8ca1182bbd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1aa86015cd87b30709412551835bf902025cd7d1">17658</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 01 Jul 2020 22:55:35 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1aa86015cd87 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1aa86015cd87b30709412551835bf902025cd7d1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1aa86015cd87b30709412551835bf902025cd7d1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1aa86015cd87b30709412551835bf902025cd7d1&newProject=comm-central&newRevision=732ab4ae2b4e30db9f43178763f60ecf43574f72&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1aa86015cd87b30709412551835bf902025cd7d1&newProject=comm-central&newRevision=732ab4ae2b4e30db9f43178763f60ecf43574f72&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1aa86015cd87b30709412551835bf902025cd7d1&newProject=comm-central&newRevision=732ab4ae2b4e30db9f43178763f60ecf43574f72&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28sg%29&revcount=50">sg</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1648802">1648802</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1648802">Bug 1648802</a> - Replace Thunderbird uses of NS_LITERAL_STRING/NS_LITERAL_CSTRING macros by _ns literals.. r=sg

compare <a href="https://phabricator.services.mozilla.com/D80861">https://phabricator.services.mozilla.com/D80861</a>#change-Yu2oZ2Beo1MA

# NS_LITERAL_CSTRING(&quot;foo&quot;) -&gt; &quot;foo&quot;_ns
find . -type f -not -path &quot;*.hg/*&quot; -not -path &quot;third_party/*&quot; -regex &quot;.*\.\(c\|h\|cpp\|mm\)$&quot; -exec sed -i -E 's/NS_LITERAL_CSTRING\(&quot;([^\)]+)&quot;\)/&quot;\1&quot;_ns/g' {} \;

# NS_LITERAL_STRING(&quot;foo&quot;) -&gt; u&quot;foo&quot;_ns
find . -type f -not -path &quot;*.hg/*&quot; -not -path &quot;third_party/*&quot; -regex &quot;.*\.\(c\|h\|cpp\|mm\)$&quot; -exec sed -i -E 's/NS_LITERAL_STRING\(&quot;([^\)]+)&quot;\)/u&quot;\1&quot;_ns/g' {} \;

 + manual replacements at least in

mailnews/imap/src/nsImapService.cpp
mailnews/local/src/nsPop3Sink.cpp
mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp
mailnews/base/test/TestMsgStripRE.cpp
mailnews/base/util/nsMsgIncomingServer.cpp
mailnews/base/util/nsMsgDBFolder.cpp
mailnews/mime/src/mimemult.cpp
mailnews/mime/src/mimethtm.cpp


mailnews/compose/src/nsMsgCompose.cpp
mailnews/import/text/src/nsTextImport.cpp
mailnews/import/outlook/src/nsOutlookMail.cpp
mailnews/import/winlivemail/nsWMUtils.cpp
mailnews/import/becky/src/nsBeckyUtils.cpp
mailnews/extensions/smime/src/nsCertPicker.cpp
calendar/base/backend/libical/calUtils.cpp
suite/components/shell/nsWindowsShellService.cpp
mail/components/search/nsMailWinSearchHelper.cpp

+ clang-format</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/calendar/base/backend/libical/calUtils.cpp">calendar/base/backend/libical/calUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/calendar/base/backend/libical/calUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/calendar/base/backend/libical/calUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/calendar/base/backend/libical/calUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/calendar/base/backend/libical/calUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/calendar/base/backend/libical/calUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/common/saxparser/nsSAXXMLReader.cpp">common/saxparser/nsSAXXMLReader.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/common/saxparser/nsSAXXMLReader.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/common/saxparser/nsSAXXMLReader.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/common/saxparser/nsSAXXMLReader.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/common/saxparser/nsSAXXMLReader.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/common/saxparser/nsSAXXMLReader.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">mail/components/migration/src/nsMailProfileMigratorUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsMailProfileMigratorUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/search/nsMailWinSearchHelper.cpp">mail/components/search/nsMailWinSearchHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/search/nsMailWinSearchHelper.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/search/nsMailWinSearchHelper.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/search/nsMailWinSearchHelper.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/search/nsMailWinSearchHelper.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/search/nsMailWinSearchHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/DirectoryProvider.cpp">mail/components/shell/DirectoryProvider.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/DirectoryProvider.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/DirectoryProvider.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/DirectoryProvider.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/DirectoryProvider.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/DirectoryProvider.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/nsWindowsShellService.cpp">mail/components/shell/nsWindowsShellService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/nsWindowsShellService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/nsWindowsShellService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/nsWindowsShellService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/nsWindowsShellService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mail/components/shell/nsWindowsShellService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbCardProperty.cpp">mailnews/addrbook/src/nsAbCardProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbCardProperty.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbCardProperty.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbCardProperty.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbCardProperty.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbCardProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbContentHandler.cpp">mailnews/addrbook/src/nsAbContentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbContentHandler.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbContentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbContentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbContentHandler.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbContentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgBodyHandler.cpp">mailnews/base/search/src/nsMsgBodyHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgBodyHandler.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgBodyHandler.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgBodyHandler.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgBodyHandler.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgBodyHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilter.cpp">mailnews/base/search/src/nsMsgFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilter.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilter.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilter.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilter.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterList.cpp">mailnews/base/search/src/nsMsgFilterList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterList.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterList.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterList.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterList.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterList.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchAdapter.cpp">mailnews/base/search/src/nsMsgSearchAdapter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchAdapter.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchAdapter.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchAdapter.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchAdapter.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchAdapter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMailDirProvider.cpp">mailnews/base/src/nsMailDirProvider.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMailDirProvider.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMailDirProvider.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMailDirProvider.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMailDirProvider.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMailDirProvider.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerOSXIntegration.mm">mailnews/base/src/nsMessengerOSXIntegration.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerOSXIntegration.mm">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerOSXIntegration.mm">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerOSXIntegration.mm">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerOSXIntegration.mm">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerOSXIntegration.mm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerUnixIntegration.cpp">mailnews/base/src/nsMessengerUnixIntegration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerUnixIntegration.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerUnixIntegration.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerUnixIntegration.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerUnixIntegration.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerUnixIntegration.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerWinIntegration.cpp">mailnews/base/src/nsMessengerWinIntegration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerWinIntegration.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerWinIntegration.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerWinIntegration.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerWinIntegration.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMessengerWinIntegration.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgContentPolicy.cpp">mailnews/base/src/nsMsgContentPolicy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgContentPolicy.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgContentPolicy.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgContentPolicy.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgContentPolicy.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgContentPolicy.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgFolderCompactor.cpp">mailnews/base/src/nsMsgFolderCompactor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgFolderCompactor.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgFolderCompactor.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgFolderCompactor.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgFolderCompactor.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgFolderCompactor.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgMailSession.cpp">mailnews/base/src/nsMsgMailSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgMailSession.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgMailSession.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgMailSession.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgMailSession.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgMailSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgPrintEngine.cpp">mailnews/base/src/nsMsgPrintEngine.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgPrintEngine.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgPrintEngine.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgPrintEngine.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgPrintEngine.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgPrintEngine.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgProgress.cpp">mailnews/base/src/nsMsgProgress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgProgress.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgProgress.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgProgress.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgProgress.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgProgress.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgWindow.cpp">mailnews/base/src/nsMsgWindow.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgWindow.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgWindow.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgWindow.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgWindow.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgWindow.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSpamSettings.cpp">mailnews/base/src/nsSpamSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSpamSettings.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSpamSettings.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSpamSettings.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSpamSettings.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSpamSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSubscribableServer.cpp">mailnews/base/src/nsSubscribableServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSubscribableServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSubscribableServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSubscribableServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSubscribableServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/src/nsSubscribableServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/test/TestMsgStripRE.cpp">mailnews/base/test/TestMsgStripRE.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/test/TestMsgStripRE.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/test/TestMsgStripRE.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/test/TestMsgStripRE.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/test/TestMsgStripRE.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/test/TestMsgStripRE.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgMailNewsUrl.cpp">mailnews/base/util/nsMsgMailNewsUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgMailNewsUrl.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgMailNewsUrl.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgMailNewsUrl.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgMailNewsUrl.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgMailNewsUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgTxn.cpp">mailnews/base/util/nsMsgTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgTxn.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgTxn.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgTxn.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgTxn.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompFields.cpp">mailnews/compose/src/nsMsgCompFields.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompFields.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompFields.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompFields.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompFields.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompFields.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompUtils.cpp">mailnews/compose/src/nsMsgCompUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgQuote.cpp">mailnews/compose/src/nsMsgQuote.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgQuote.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgQuote.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgQuote.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgQuote.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgQuote.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSendLater.cpp">mailnews/compose/src/nsMsgSendLater.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSendLater.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSendLater.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSendLater.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSendLater.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsMsgSendLater.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpServer.cpp">mailnews/compose/src/nsSmtpServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/smime/src/nsCertPicker.cpp">mailnews/extensions/smime/src/nsCertPicker.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/smime/src/nsCertPicker.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/smime/src/nsCertPicker.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/smime/src/nsCertPicker.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/smime/src/nsCertPicker.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/extensions/smime/src/nsCertPicker.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapUtils.cpp">mailnews/imap/src/nsImapUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/imap/src/nsImapUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsAppleMailImport.cpp">mailnews/import/applemail/src/nsAppleMailImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsAppleMailImport.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsAppleMailImport.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsAppleMailImport.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsAppleMailImport.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsAppleMailImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">mailnews/import/applemail/src/nsEmlxHelperUtils.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">mailnews/import/becky/src/nsBeckyAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyFilters.cpp">mailnews/import/becky/src/nsBeckyFilters.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyFilters.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyFilters.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyFilters.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyFilters.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyFilters.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyMail.cpp">mailnews/import/becky/src/nsBeckyMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyMail.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyMail.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyMail.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyMail.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckySettings.cpp">mailnews/import/becky/src/nsBeckySettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckySettings.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckySettings.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckySettings.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckySettings.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckySettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyUtils.cpp">mailnews/import/becky/src/nsBeckyUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/becky/src/nsBeckyUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookCompose.cpp">mailnews/import/outlook/src/nsOutlookCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookCompose.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookCompose.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookCompose.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookCompose.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookMail.cpp">mailnews/import/outlook/src/nsOutlookMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookMail.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookMail.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookMail.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookMail.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookSettings.cpp">mailnews/import/outlook/src/nsOutlookSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookSettings.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookSettings.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookSettings.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookSettings.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/outlook/src/nsOutlookSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/src/nsImportStringBundle.cpp">mailnews/import/src/nsImportStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/src/nsImportStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/src/nsImportStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/src/nsImportStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/src/nsImportStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/src/nsImportStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/text/src/nsTextImport.cpp">mailnews/import/text/src/nsTextImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/text/src/nsTextImport.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/text/src/nsTextImport.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/text/src/nsTextImport.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/text/src/nsTextImport.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/text/src/nsTextImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMSettings.cpp">mailnews/import/winlivemail/nsWMSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMSettings.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMSettings.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMSettings.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMSettings.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMUtils.cpp">mailnews/import/winlivemail/nsWMUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/import/winlivemail/nsWMUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/intl/nsCharsetConverterManager.cpp">mailnews/intl/nsCharsetConverterManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/intl/nsCharsetConverterManager.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/intl/nsCharsetConverterManager.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/intl/nsCharsetConverterManager.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/intl/nsCharsetConverterManager.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/intl/nsCharsetConverterManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/jsaccount/src/JaUrl.cpp">mailnews/jsaccount/src/JaUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/jsaccount/src/JaUrl.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/jsaccount/src/JaUrl.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/jsaccount/src/JaUrl.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/jsaccount/src/JaUrl.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/jsaccount/src/JaUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalUtils.cpp">mailnews/local/src/nsLocalUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsLocalUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxService.cpp">mailnews/local/src/nsMailboxService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxUrl.cpp">mailnews/local/src/nsMailboxUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxUrl.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxUrl.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxUrl.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxUrl.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMailboxUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailIncomingServer.cpp">mailnews/local/src/nsMovemailIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailService.cpp">mailnews/local/src/nsMovemailService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMovemailService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgLocalStoreUtils.cpp">mailnews/local/src/nsMsgLocalStoreUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgLocalStoreUtils.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgLocalStoreUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgLocalStoreUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgLocalStoreUtils.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgLocalStoreUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgMaildirStore.cpp">mailnews/local/src/nsMsgMaildirStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgMaildirStore.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgMaildirStore.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgMaildirStore.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgMaildirStore.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsMsgMaildirStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsNoIncomingServer.cpp">mailnews/local/src/nsNoIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsNoIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsNoIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsNoIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsNoIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsNoIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3IncomingServer.cpp">mailnews/local/src/nsPop3IncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3IncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3IncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3IncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3IncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3IncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Sink.cpp">mailnews/local/src/nsPop3Sink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Sink.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Sink.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Sink.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Sink.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsPop3Sink.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsRssIncomingServer.cpp">mailnews/local/src/nsRssIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsRssIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsRssIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsRssIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsRssIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/local/src/nsRssIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mapi/mapihook/src/msgMapiHook.cpp">mailnews/mapi/mapihook/src/msgMapiHook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mapi/mapihook/src/msgMapiHook.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mapi/mapihook/src/msgMapiHook.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mapi/mapihook/src/msgMapiHook.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mapi/mapihook/src/msgMapiHook.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mapi/mapihook/src/msgMapiHook.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">mailnews/mime/emitters/nsMimeBaseEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeTextHTMLParsed.cpp">mailnews/mime/src/mimeTextHTMLParsed.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeTextHTMLParsed.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeTextHTMLParsed.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeTextHTMLParsed.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeTextHTMLParsed.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeTextHTMLParsed.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeebod.cpp">mailnews/mime/src/mimeebod.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeebod.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeebod.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeebod.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeebod.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimeebod.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemult.cpp">mailnews/mime/src/mimemult.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemult.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemult.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemult.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemult.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimemult.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimethtm.cpp">mailnews/mime/src/mimethtm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimethtm.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimethtm.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimethtm.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimethtm.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/mime/src/mimethtm.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpService.cpp">mailnews/news/src/nsNntpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpUrl.cpp">mailnews/news/src/nsNntpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpUrl.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpUrl.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/mailnews/news/src/nsNntpUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/feeds/nsFeedSniffer.cpp">suite/components/feeds/nsFeedSniffer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/feeds/nsFeedSniffer.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/feeds/nsFeedSniffer.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/feeds/nsFeedSniffer.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/feeds/nsFeedSniffer.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/feeds/nsFeedSniffer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsSuiteProfileMigratorBase.cpp">suite/components/migration/src/nsSuiteProfileMigratorBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsSuiteProfileMigratorBase.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsSuiteProfileMigratorBase.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsSuiteProfileMigratorBase.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsSuiteProfileMigratorBase.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsSuiteProfileMigratorBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsThunderbirdProfileMigrator.cpp">suite/components/migration/src/nsThunderbirdProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsThunderbirdProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsThunderbirdProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsThunderbirdProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsThunderbirdProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/migration/src/nsThunderbirdProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/profile/nsSuiteDirectoryProvider.cpp">suite/components/profile/nsSuiteDirectoryProvider.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/profile/nsSuiteDirectoryProvider.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/profile/nsSuiteDirectoryProvider.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/profile/nsSuiteDirectoryProvider.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/profile/nsSuiteDirectoryProvider.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/profile/nsSuiteDirectoryProvider.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/shell/nsWindowsShellService.cpp">suite/components/shell/nsWindowsShellService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/shell/nsWindowsShellService.cpp">file</a> |
<a href="/comm-central/annotate/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/shell/nsWindowsShellService.cpp">annotate</a> |
<a href="/comm-central/diff/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/shell/nsWindowsShellService.cpp">diff</a> |
<a href="/comm-central/comparison/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/shell/nsWindowsShellService.cpp">comparison</a> |
<a href="/comm-central/log/1aa86015cd87b30709412551835bf902025cd7d1/suite/components/shell/nsWindowsShellService.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/backend/libical/calUtils.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/backend/libical/calUtils.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -59,19 +59,19 @@ nsCOMPtr&lt;calITimezone&gt; detectTimezone(ic</span>
<a href="#l1.4"></a><span id="l1.4">       logMissingTimezone(tzid);</span>
<a href="#l1.5"></a><span id="l1.5">     }</span>
<a href="#l1.6"></a><span id="l1.6">   }</span>
<a href="#l1.7"></a><span id="l1.7">   return floating();</span>
<a href="#l1.8"></a><span id="l1.8"> }</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> void logMissingTimezone(char const* tzid) {</span>
<a href="#l1.11"></a><span id="l1.11">   // xxx todo: needs l10n</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  nsString msg(NS_LITERAL_STRING(&quot;Timezone \&quot;&quot;));</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  nsString msg(u&quot;Timezone \&quot;&quot;_ns);</span>
<a href="#l1.14"></a><span id="l1.14">   msg += NS_ConvertUTF8toUTF16(tzid);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  msg += NS_LITERAL_STRING(&quot;\&quot; not found, falling back to floating!&quot;);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  msg += u&quot;\&quot; not found, falling back to floating!&quot;_ns;</span>
<a href="#l1.17"></a><span id="l1.17">   logError(msg);</span>
<a href="#l1.18"></a><span id="l1.18"> }</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> icaltimezone* getIcalTimezone(calITimezone* tz) {</span>
<a href="#l1.21"></a><span id="l1.21">   icaltimezone* icaltz = nullptr;</span>
<a href="#l1.22"></a><span id="l1.22">   if (!tz) {</span>
<a href="#l1.23"></a><span id="l1.23">     NS_ASSERTION(false, &quot;No Timezone passed to getIcalTimezone&quot;);</span>
<a href="#l1.24"></a><span id="l1.24">     return nullptr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/common/saxparser/nsSAXXMLReader.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/common/saxparser/nsSAXXMLReader.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -331,15 +331,14 @@ nsresult nsSAXXMLReader::SplitExpatName(</span>
<a href="#l2.4"></a><span id="l2.4">   } else {</span>
<a href="#l2.5"></a><span id="l2.5">     aURI = StringHead(expatStr, break1);</span>
<a href="#l2.6"></a><span id="l2.6">     break2 = expatStr.FindChar(char16_t(0xFFFF), break1 + 1);</span>
<a href="#l2.7"></a><span id="l2.7">     if (break2 == kNotFound) {  // namespace, but no prefix</span>
<a href="#l2.8"></a><span id="l2.8">       aLocalName = Substring(expatStr, break1 + 1);</span>
<a href="#l2.9"></a><span id="l2.9">       aQName = aLocalName;</span>
<a href="#l2.10"></a><span id="l2.10">     } else {  // namespace with prefix</span>
<a href="#l2.11"></a><span id="l2.11">       aLocalName = Substring(expatStr, break1 + 1, break2 - break1 - 1);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      aQName =</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-          Substring(expatStr, break2 + 1) + NS_LITERAL_STRING(&quot;:&quot;) + aLocalName;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      aQName = Substring(expatStr, break2 + 1) + u&quot;:&quot;_ns + aLocalName;</span>
<a href="#l2.15"></a><span id="l2.15">     }</span>
<a href="#l2.16"></a><span id="l2.16">   }</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   return NS_OK;</span>
<a href="#l2.19"></a><span id="l2.19"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/migration/src/nsMailProfileMigratorUtils.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/migration/src/nsMailProfileMigratorUtils.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -36,20 +36,20 @@ void ParseOverrideServers(const char* aS</span>
<a href="#l3.4"></a><span id="l3.4">   // must be translated to &quot;localhost,127.0.0.1&quot;</span>
<a href="#l3.5"></a><span id="l3.5">   nsAutoCString override(aServers);</span>
<a href="#l3.6"></a><span id="l3.6">   int32_t left = 0, right = 0;</span>
<a href="#l3.7"></a><span id="l3.7">   for (;;) {</span>
<a href="#l3.8"></a><span id="l3.8">     right = override.FindChar(';', right);</span>
<a href="#l3.9"></a><span id="l3.9">     const nsACString&amp; host = Substring(</span>
<a href="#l3.10"></a><span id="l3.10">         override, left, (right &lt; 0 ? override.Length() : right) - left);</span>
<a href="#l3.11"></a><span id="l3.11">     if (host.Equals(&quot;&lt;local&gt;&quot;))</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      override.Replace(left, 7, NS_LITERAL_CSTRING(&quot;localhost,127.0.0.1&quot;));</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      override.Replace(left, 7, &quot;localhost,127.0.0.1&quot;_ns);</span>
<a href="#l3.14"></a><span id="l3.14">     if (right &lt; 0) break;</span>
<a href="#l3.15"></a><span id="l3.15">     left = right + 1;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    override.Replace(right, 1, NS_LITERAL_CSTRING(&quot;,&quot;));</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    override.Replace(right, 1, &quot;,&quot;_ns);</span>
<a href="#l3.18"></a><span id="l3.18">   }</span>
<a href="#l3.19"></a><span id="l3.19">   aBranch-&gt;SetCharPref(&quot;network.proxy.no_proxies_on&quot;, override);</span>
<a href="#l3.20"></a><span id="l3.20"> }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> void GetMigrateDataFromArray(MigrationData* aDataArray,</span>
<a href="#l3.23"></a><span id="l3.23">                              int32_t aDataArrayLength, bool aReplace,</span>
<a href="#l3.24"></a><span id="l3.24">                              nsIFile* aSourceProfile, uint16_t* aResult) {</span>
<a href="#l3.25"></a><span id="l3.25">   nsCOMPtr&lt;nsIFile&gt; sourceFile;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -21,17 +21,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsINIParser.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsMailProfileMigratorUtils.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsIDirectoryEnumerator.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #define MIGRATION_BUNDLE \</span>
<a href="#l4.10"></a><span id="l4.10">   &quot;chrome://messenger/locale/migration/migration.properties&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#define FILE_NAME_PREFS_5X NS_LITERAL_STRING(&quot;prefs.js&quot;)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#define FILE_NAME_PREFS_5X u&quot;prefs.js&quot;_ns</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.16"></a><span id="l4.16"> // nsNetscapeProfileMigratorBase</span>
<a href="#l4.17"></a><span id="l4.17"> nsNetscapeProfileMigratorBase::nsNetscapeProfileMigratorBase() {</span>
<a href="#l4.18"></a><span id="l4.18">   mObserverService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;);</span>
<a href="#l4.19"></a><span id="l4.19">   mMaxProgress = 0;</span>
<a href="#l4.20"></a><span id="l4.20">   mCurrentProgress = 0;</span>
<a href="#l4.21"></a><span id="l4.21">   mFileCopyTransactionIndex = 0;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -42,17 +42,17 @@ NS_IMPL_ISUPPORTS(nsNetscapeProfileMigra</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> nsresult nsNetscapeProfileMigratorBase::GetProfileDataFromProfilesIni(</span>
<a href="#l4.25"></a><span id="l4.25">     nsIFile* aDataDir, nsIMutableArray* aProfileNames,</span>
<a href="#l4.26"></a><span id="l4.26">     nsIMutableArray* aProfileLocations) {</span>
<a href="#l4.27"></a><span id="l4.27">   nsCOMPtr&lt;nsIFile&gt; profileIni;</span>
<a href="#l4.28"></a><span id="l4.28">   nsresult rv = aDataDir-&gt;Clone(getter_AddRefs(profileIni));</span>
<a href="#l4.29"></a><span id="l4.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  profileIni-&gt;Append(NS_LITERAL_STRING(&quot;profiles.ini&quot;));</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  profileIni-&gt;Append(u&quot;profiles.ini&quot;_ns);</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">   // Does it exist?</span>
<a href="#l4.35"></a><span id="l4.35">   bool profileFileExists = false;</span>
<a href="#l4.36"></a><span id="l4.36">   rv = profileIni-&gt;Exists(&amp;profileFileExists);</span>
<a href="#l4.37"></a><span id="l4.37">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39">   if (!profileFileExists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l4.40"></a><span id="l4.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -19,31 +19,31 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsSeamonkeyProfileMigrator.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsComponentManagerUtils.h&quot;  // for do_CreateInstance</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> // Mail specific folder paths</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#define MAIL_DIR_50_NAME NS_LITERAL_STRING(&quot;Mail&quot;)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-#define IMAP_MAIL_DIR_50_NAME NS_LITERAL_STRING(&quot;ImapMail&quot;)</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-#define NEWS_DIR_50_NAME NS_LITERAL_STRING(&quot;News&quot;)</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+#define MAIL_DIR_50_NAME u&quot;Mail&quot;_ns</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+#define IMAP_MAIL_DIR_50_NAME u&quot;ImapMail&quot;_ns</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+#define NEWS_DIR_50_NAME u&quot;News&quot;_ns</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.20"></a><span id="l5.20"> // nsSeamonkeyProfileMigrator</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-#define FILE_NAME_JUNKTRAINING NS_LITERAL_STRING(&quot;training.dat&quot;)</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-#define FILE_NAME_PERSONALDICTIONARY NS_LITERAL_STRING(&quot;persdict.dat&quot;)</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-#define FILE_NAME_PERSONAL_ADDRESSBOOK NS_LITERAL_STRING(&quot;abook.mab&quot;)</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-#define FILE_NAME_MAILVIEWS NS_LITERAL_STRING(&quot;mailviews.dat&quot;)</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-#define FILE_NAME_CERT9DB NS_LITERAL_STRING(&quot;cert9.db&quot;)</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-#define FILE_NAME_KEY4DB NS_LITERAL_STRING(&quot;key4.db&quot;)</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-#define FILE_NAME_SECMODDB NS_LITERAL_STRING(&quot;secmod.db&quot;)</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-#define FILE_NAME_PREFS NS_LITERAL_STRING(&quot;prefs.js&quot;)</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-#define FILE_NAME_USER_PREFS NS_LITERAL_STRING(&quot;user.js&quot;)</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+#define FILE_NAME_JUNKTRAINING u&quot;training.dat&quot;_ns</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+#define FILE_NAME_PERSONALDICTIONARY u&quot;persdict.dat&quot;_ns</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+#define FILE_NAME_PERSONAL_ADDRESSBOOK u&quot;abook.mab&quot;_ns</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+#define FILE_NAME_MAILVIEWS u&quot;mailviews.dat&quot;_ns</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+#define FILE_NAME_CERT9DB u&quot;cert9.db&quot;_ns</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+#define FILE_NAME_KEY4DB u&quot;key4.db&quot;_ns</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+#define FILE_NAME_SECMODDB u&quot;secmod.db&quot;_ns</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+#define FILE_NAME_PREFS u&quot;prefs.js&quot;_ns</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+#define FILE_NAME_USER_PREFS u&quot;user.js&quot;_ns</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40"> struct PrefBranchStruct {</span>
<a href="#l5.41"></a><span id="l5.41">   char* prefName;</span>
<a href="#l5.42"></a><span id="l5.42">   int32_t type;</span>
<a href="#l5.43"></a><span id="l5.43">   union {</span>
<a href="#l5.44"></a><span id="l5.44">     char* stringValue;</span>
<a href="#l5.45"></a><span id="l5.45">     int32_t intValue;</span>
<a href="#l5.46"></a><span id="l5.46">     bool boolValue;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineat">@@ -446,17 +446,17 @@ nsresult nsSeamonkeyProfileMigrator::Cop</span>
<a href="#l5.48"></a><span id="l5.48">   //     destination directory pref</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">   nsresult rv;</span>
<a href="#l5.51"></a><span id="l5.51">   uint32_t count = aMailServers.Length();</span>
<a href="#l5.52"></a><span id="l5.52">   for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l5.53"></a><span id="l5.53">     PrefBranchStruct* pref = aMailServers.ElementAt(i);</span>
<a href="#l5.54"></a><span id="l5.54">     nsDependentCString prefName(pref-&gt;prefName);</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    if (StringEndsWith(prefName, NS_LITERAL_CSTRING(&quot;.directory-rel&quot;))) {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+    if (StringEndsWith(prefName, &quot;.directory-rel&quot;_ns)) {</span>
<a href="#l5.58"></a><span id="l5.58">       // When the directories are modified below, we may change the .directory</span>
<a href="#l5.59"></a><span id="l5.59">       // pref. As we don't have a pref branch to modify at this stage and set</span>
<a href="#l5.60"></a><span id="l5.60">       // up the relative folders properly, we'll just remove all the</span>
<a href="#l5.61"></a><span id="l5.61">       // *.directory-rel prefs. Mailnews will cope with this, creating them</span>
<a href="#l5.62"></a><span id="l5.62">       // when it first needs them.</span>
<a href="#l5.63"></a><span id="l5.63">       if (pref-&gt;type == nsIPrefBranch::PREF_STRING) free(pref-&gt;stringValue);</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65">       aMailServers.RemoveElementAt(i);</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineat">@@ -616,17 +616,17 @@ nsresult nsSeamonkeyProfileMigrator::Imp</span>
<a href="#l5.67"></a><span id="l5.67">   nsCOMPtr&lt;nsIPrefService&gt; psvc(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.68"></a><span id="l5.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70">   // Because all operations on nsIPrefService or nsIPrefBranch will update</span>
<a href="#l5.71"></a><span id="l5.71">   // prefs.js directly, we need to backup the current pref file to be used as a</span>
<a href="#l5.72"></a><span id="l5.72">   // base later.</span>
<a href="#l5.73"></a><span id="l5.73">   nsCOMPtr&lt;nsIFile&gt; targetPrefsFile;</span>
<a href="#l5.74"></a><span id="l5.74">   mTargetProfile-&gt;Clone(getter_AddRefs(targetPrefsFile));</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-  targetPrefsFile-&gt;Append(aTargetPrefFileName + NS_LITERAL_STRING(&quot;.orig&quot;));</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  targetPrefsFile-&gt;Append(aTargetPrefFileName + u&quot;.orig&quot;_ns);</span>
<a href="#l5.77"></a><span id="l5.77">   rv = psvc-&gt;SavePrefFile(targetPrefsFile);</span>
<a href="#l5.78"></a><span id="l5.78">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.79"></a><span id="l5.79"> </span>
<a href="#l5.80"></a><span id="l5.80">   // Load the source pref file.</span>
<a href="#l5.81"></a><span id="l5.81">   rv = psvc-&gt;ResetPrefs();</span>
<a href="#l5.82"></a><span id="l5.82">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.83"></a><span id="l5.83">   nsCOMPtr&lt;nsIFile&gt; sourcePrefsFile;</span>
<a href="#l5.84"></a><span id="l5.84">   mSourceProfile-&gt;Clone(getter_AddRefs(sourcePrefsFile));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/search/nsMailWinSearchHelper.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/search/nsMailWinSearchHelper.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -81,17 +81,17 @@ NS_IMETHODIMP nsMailWinSearchHelper::Get</span>
<a href="#l6.4"></a><span id="l6.4">     rv = subdir-&gt;AppendNative(relativeStr);</span>
<a href="#l6.5"></a><span id="l6.5">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">     nsString subdirPath;</span>
<a href="#l6.8"></a><span id="l6.8">     rv = subdir-&gt;GetPath(subdirPath);</span>
<a href="#l6.9"></a><span id="l6.9">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">     // Form a URL as required by the crawl scope manager</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    nsString subdirURL(NS_LITERAL_STRING(&quot;file:///&quot;));</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    nsString subdirURL(u&quot;file:///&quot;_ns);</span>
<a href="#l6.14"></a><span id="l6.14">     subdirURL.Append(subdirPath);</span>
<a href="#l6.15"></a><span id="l6.15">     subdirURL.Append('\\');</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">     BOOL included;</span>
<a href="#l6.18"></a><span id="l6.18">     if (FAILED(crawlScopeManager-&gt;IncludedInCrawlScope(subdirURL.get(),</span>
<a href="#l6.19"></a><span id="l6.19">                                                        &amp;included)))</span>
<a href="#l6.20"></a><span id="l6.20">       return NS_ERROR_FAILURE;</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -201,33 +201,32 @@ NS_IMETHODIMP nsMailWinSearchHelper::Set</span>
<a href="#l6.23"></a><span id="l6.23">   return SUCCEEDED(hr) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l6.24"></a><span id="l6.24"> }</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> NS_IMETHODIMP nsMailWinSearchHelper::RunSetup(bool aEnable) {</span>
<a href="#l6.27"></a><span id="l6.27">   nsresult rv;</span>
<a href="#l6.28"></a><span id="l6.28">   if (!mCurProcD) {</span>
<a href="#l6.29"></a><span id="l6.29">     rv = NS_GetSpecialDirectory(&quot;CurProcD&quot;, getter_AddRefs(mCurProcD));</span>
<a href="#l6.30"></a><span id="l6.30">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    rv = mCurProcD-&gt;Append(NS_LITERAL_STRING(&quot;WSEnable.exe&quot;));</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    rv = mCurProcD-&gt;Append(u&quot;WSEnable.exe&quot;_ns);</span>
<a href="#l6.33"></a><span id="l6.33">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.34"></a><span id="l6.34">   }</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">   nsAutoString filePath;</span>
<a href="#l6.37"></a><span id="l6.37">   rv = mCurProcD-&gt;GetPath(filePath);</span>
<a href="#l6.38"></a><span id="l6.38">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">   // The parameters are of the format &quot;1 &lt;path&gt;&quot; for enabling and &quot;0 &lt;path&gt;&quot; for</span>
<a href="#l6.41"></a><span id="l6.41">   // disabling</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  nsAutoString params(aEnable ? NS_LITERAL_STRING(&quot;1 \&quot;&quot;)</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-                              : NS_LITERAL_STRING(&quot;0 \&quot;&quot;));</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  nsAutoString params(aEnable ? u&quot;1 \&quot;&quot;_ns : u&quot;0 \&quot;&quot;_ns);</span>
<a href="#l6.45"></a><span id="l6.45">   nsAutoString profDPath;</span>
<a href="#l6.46"></a><span id="l6.46">   rv = mProfD-&gt;GetPath(profDPath);</span>
<a href="#l6.47"></a><span id="l6.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.48"></a><span id="l6.48">   params.Append(profDPath);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  params.Append(NS_LITERAL_STRING(&quot;\&quot;&quot;));</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  params.Append(u&quot;\&quot;&quot;_ns);</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">   // We need an hWnd to cause UAC to pop up immediately</span>
<a href="#l6.53"></a><span id="l6.53">   // If GetForegroundWindow returns NULL, then the UAC prompt will still appear,</span>
<a href="#l6.54"></a><span id="l6.54">   // but minimized.</span>
<a href="#l6.55"></a><span id="l6.55">   HWND hWnd = GetForegroundWindow();</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">   SHELLEXECUTEINFOW executeInfo = {0};</span>
<a href="#l6.58"></a><span id="l6.58"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/shell/DirectoryProvider.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/shell/DirectoryProvider.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -53,39 +53,39 @@ DirectoryProvider::GetFile(const char* a</span>
<a href="#l7.4"></a><span id="l7.4"> // which specifies a default locale to use.</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> static void AppendDistroSearchDirs(nsIProperties* aDirSvc,</span>
<a href="#l7.7"></a><span id="l7.7">                                    nsCOMArray&lt;nsIFile&gt;&amp; array) {</span>
<a href="#l7.8"></a><span id="l7.8">   nsCOMPtr&lt;nsIFile&gt; searchPlugins;</span>
<a href="#l7.9"></a><span id="l7.9">   nsresult rv = aDirSvc-&gt;Get(XRE_APP_DISTRIBUTION_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l7.10"></a><span id="l7.10">                              getter_AddRefs(searchPlugins));</span>
<a href="#l7.11"></a><span id="l7.11">   if (NS_FAILED(rv)) return;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  searchPlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;searchplugins&quot;));</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  searchPlugins-&gt;AppendNative(&quot;searchplugins&quot;_ns);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">   bool exists;</span>
<a href="#l7.16"></a><span id="l7.16">   rv = searchPlugins-&gt;Exists(&amp;exists);</span>
<a href="#l7.17"></a><span id="l7.17">   if (NS_FAILED(rv) || !exists) return;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   nsCOMPtr&lt;nsIFile&gt; commonPlugins;</span>
<a href="#l7.20"></a><span id="l7.20">   rv = searchPlugins-&gt;Clone(getter_AddRefs(commonPlugins));</span>
<a href="#l7.21"></a><span id="l7.21">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-    commonPlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;common&quot;));</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+    commonPlugins-&gt;AppendNative(&quot;common&quot;_ns);</span>
<a href="#l7.24"></a><span id="l7.24">     rv = commonPlugins-&gt;Exists(&amp;exists);</span>
<a href="#l7.25"></a><span id="l7.25">     if (NS_SUCCEEDED(rv) &amp;&amp; exists) {</span>
<a href="#l7.26"></a><span id="l7.26">       array.AppendObject(commonPlugins);</span>
<a href="#l7.27"></a><span id="l7.27">     }</span>
<a href="#l7.28"></a><span id="l7.28">   }</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l7.31"></a><span id="l7.31">   if (prefs) {</span>
<a href="#l7.32"></a><span id="l7.32">     nsCOMPtr&lt;nsIFile&gt; localePlugins;</span>
<a href="#l7.33"></a><span id="l7.33">     rv = searchPlugins-&gt;Clone(getter_AddRefs(localePlugins));</span>
<a href="#l7.34"></a><span id="l7.34">     if (NS_FAILED(rv)) return;</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-    localePlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;locale&quot;));</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    localePlugins-&gt;AppendNative(&quot;locale&quot;_ns);</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">     AutoTArray&lt;nsCString, 10&gt; requestedLocales;</span>
<a href="#l7.40"></a><span id="l7.40">     mozilla::intl::LocaleService::GetInstance()-&gt;GetRequestedLocales(</span>
<a href="#l7.41"></a><span id="l7.41">         requestedLocales);</span>
<a href="#l7.42"></a><span id="l7.42">     nsAutoCString locale(requestedLocales[0]);</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">     nsCOMPtr&lt;nsIFile&gt; curLocalePlugins;</span>
<a href="#l7.45"></a><span id="l7.45">     rv = localePlugins-&gt;Clone(getter_AddRefs(curLocalePlugins));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/shell/nsWindowsShellService.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/shell/nsWindowsShellService.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -109,20 +109,20 @@ nsresult GetHelperPath(nsAutoString&amp; aPa</span>
<a href="#l8.4"></a><span id="l8.4">       do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.5"></a><span id="l8.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   nsCOMPtr&lt;nsIFile&gt; appHelper;</span>
<a href="#l8.8"></a><span id="l8.8">   rv = directoryService-&gt;Get(NS_XPCOM_CURRENT_PROCESS_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l8.9"></a><span id="l8.9">                              getter_AddRefs(appHelper));</span>
<a href="#l8.10"></a><span id="l8.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  rv = appHelper-&gt;Append(NS_LITERAL_STRING(&quot;uninstall&quot;));</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  rv = appHelper-&gt;Append(u&quot;uninstall&quot;_ns);</span>
<a href="#l8.14"></a><span id="l8.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  rv = appHelper-&gt;Append(NS_LITERAL_STRING(&quot;helper.exe&quot;));</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  rv = appHelper-&gt;Append(u&quot;helper.exe&quot;_ns);</span>
<a href="#l8.18"></a><span id="l8.18">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   return appHelper-&gt;GetPath(aPath);</span>
<a href="#l8.21"></a><span id="l8.21"> }</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23"> nsresult LaunchHelper(nsAutoString&amp; aPath, nsAutoString&amp; aParams) {</span>
<a href="#l8.24"></a><span id="l8.24">   SHELLEXECUTEINFOW executeInfo = {0};</span>
<a href="#l8.25"></a><span id="l8.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -620,29 +620,29 @@ nsresult nsAbCardProperty::ConvertToXMLP</span>
<a href="#l9.4"></a><span id="l9.4">   rv = AppendSection(NAME_ATTRS_ARRAY,</span>
<a href="#l9.5"></a><span id="l9.5">                      sizeof(NAME_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l9.6"></a><span id="l9.6">                      EmptyString(), bundle, conv, xmlStr);</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">   xmlStr.AppendLiteral(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">   rv = AppendSection(PHONE_ATTRS_ARRAY,</span>
<a href="#l9.11"></a><span id="l9.11">                      sizeof(PHONE_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                     NS_LITERAL_STRING(&quot;headingPhone&quot;), bundle, conv, xmlStr);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                     u&quot;headingPhone&quot;_ns, bundle, conv, xmlStr);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   if (!m_IsMailList) {</span>
<a href="#l9.16"></a><span id="l9.16">     rv = AppendSection(CUSTOM_ATTRS_ARRAY,</span>
<a href="#l9.17"></a><span id="l9.17">                        sizeof(CUSTOM_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-                       NS_LITERAL_STRING(&quot;headingOther&quot;), bundle, conv, xmlStr);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+                       u&quot;headingOther&quot;_ns, bundle, conv, xmlStr);</span>
<a href="#l9.20"></a><span id="l9.20">     rv = AppendSection(CHAT_ATTRS_ARRAY,</span>
<a href="#l9.21"></a><span id="l9.21">                        sizeof(CHAT_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-                       NS_LITERAL_STRING(&quot;headingChat&quot;), bundle, conv, xmlStr);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+                       u&quot;headingChat&quot;_ns, bundle, conv, xmlStr);</span>
<a href="#l9.24"></a><span id="l9.24">   } else {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-    rv = AppendSection(</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-        CUSTOM_ATTRS_ARRAY, sizeof(CUSTOM_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-        NS_LITERAL_STRING(&quot;headingDescription&quot;), bundle, conv, xmlStr);</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+    rv = AppendSection(CUSTOM_ATTRS_ARRAY,</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+                       sizeof(CUSTOM_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+                       u&quot;headingDescription&quot;_ns, bundle, conv, xmlStr);</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32">     xmlStr.AppendLiteral(&quot;&lt;section&gt;&lt;sectiontitle&gt;&quot;);</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">     nsString headingAddresses;</span>
<a href="#l9.35"></a><span id="l9.35">     rv = bundle-&gt;GetStringFromName(&quot;headingAddresses&quot;, headingAddresses);</span>
<a href="#l9.36"></a><span id="l9.36">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">     xmlStr.Append(headingAddresses);</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineat">@@ -696,20 +696,20 @@ nsresult nsAbCardProperty::ConvertToXMLP</span>
<a href="#l9.40"></a><span id="l9.40">     }</span>
<a href="#l9.41"></a><span id="l9.41">     xmlStr.AppendLiteral(&quot;&lt;/section&gt;&quot;);</span>
<a href="#l9.42"></a><span id="l9.42">   }</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44">   xmlStr.AppendLiteral(&quot;&lt;/td&gt;&lt;td&gt;&quot;);</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46">   rv = AppendSection(HOME_ATTRS_ARRAY,</span>
<a href="#l9.47"></a><span id="l9.47">                      sizeof(HOME_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-                     NS_LITERAL_STRING(&quot;headingHome&quot;), bundle, conv, xmlStr);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+                     u&quot;headingHome&quot;_ns, bundle, conv, xmlStr);</span>
<a href="#l9.50"></a><span id="l9.50">   rv = AppendSection(WORK_ATTRS_ARRAY,</span>
<a href="#l9.51"></a><span id="l9.51">                      sizeof(WORK_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-                     NS_LITERAL_STRING(&quot;headingWork&quot;), bundle, conv, xmlStr);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+                     u&quot;headingWork&quot;_ns, bundle, conv, xmlStr);</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55">   xmlStr.AppendLiteral(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57">   aXMLSubstr = xmlStr;</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">   return NS_OK;</span>
<a href="#l9.60"></a><span id="l9.60"> }</span>
<a href="#l9.61"></a><span id="l9.61"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbContentHandler.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbContentHandler.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -157,12 +157,11 @@ nsAbContentHandler::OnStreamComplete(nsI</span>
<a href="#l10.4"></a><span id="l10.4">   NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l10.5"></a><span id="l10.5">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow =</span>
<a href="#l10.6"></a><span id="l10.6">       nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   RefPtr&lt;mozilla::dom::BrowsingContext&gt; dialogWindow;</span>
<a href="#l10.9"></a><span id="l10.9">   return parentWindow-&gt;OpenDialog(</span>
<a href="#l10.10"></a><span id="l10.10">       NS_LITERAL_STRING(</span>
<a href="#l10.11"></a><span id="l10.11">           &quot;chrome://messenger/content/addressbook/abNewCardDialog.xhtml&quot;),</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-      EmptyString(),</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-      NS_LITERAL_STRING(&quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;),</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+      EmptyString(), u&quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;_ns,</span>
<a href="#l10.15"></a><span id="l10.15">       cardFromVCard, getter_AddRefs(dialogWindow));</span>
<a href="#l10.16"></a><span id="l10.16"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -183,17 +183,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetLDAP</span>
<a href="#l11.4"></a><span id="l11.4">      * or more importantly needing to be able to change the</span>
<a href="#l11.5"></a><span id="l11.5">      * preferences entries. Thus to set the URI Spec now, it is</span>
<a href="#l11.6"></a><span id="l11.6">      * only necessary to read the uri pref entry, while in the</span>
<a href="#l11.7"></a><span id="l11.7">      * case where it is not a preference, we need to replace the</span>
<a href="#l11.8"></a><span id="l11.8">      * &quot;moz-abldapdirectory&quot;.</span>
<a href="#l11.9"></a><span id="l11.9">      */</span>
<a href="#l11.10"></a><span id="l11.10">     URI = mURINoQuery;</span>
<a href="#l11.11"></a><span id="l11.11">     if (StringBeginsWith(URI, NS_LITERAL_CSTRING(kLDAPDirectoryRoot)))</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-      URI.Replace(0, kLDAPDirectoryRootLen, NS_LITERAL_CSTRING(&quot;ldap://&quot;));</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+      URI.Replace(0, kLDAPDirectoryRootLen, &quot;ldap://&quot;_ns);</span>
<a href="#l11.14"></a><span id="l11.14">   }</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16">   nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l11.17"></a><span id="l11.17">   NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">   nsCOMPtr&lt;nsIURI&gt; result;</span>
<a href="#l11.20"></a><span id="l11.20">   rv = ioService-&gt;NewURI(URI, nullptr, nullptr, getter_AddRefs(result));</span>
<a href="#l11.21"></a><span id="l11.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -216,21 +216,20 @@ NS_IMETHODIMP nsAbLDAPDirectory::SetLDAP</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">   rv = SetStringValue(&quot;uri&quot;, tempLDAPURL);</span>
<a href="#l11.25"></a><span id="l11.25">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27">   // Now we need to send an update which will ensure our indicators and</span>
<a href="#l11.28"></a><span id="l11.28">   // listeners get updated correctly.</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30">   // See if they both start with ldaps: or ldap:</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  bool newIsNotSecure =</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-      StringBeginsWith(tempLDAPURL, NS_LITERAL_CSTRING(&quot;ldap:&quot;));</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  bool newIsNotSecure = StringBeginsWith(tempLDAPURL, &quot;ldap:&quot;_ns);</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35">   if (oldUrl.IsEmpty() ||</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-      StringBeginsWith(oldUrl, NS_LITERAL_CSTRING(&quot;ldap:&quot;)) != newIsNotSecure) {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+      StringBeginsWith(oldUrl, &quot;ldap:&quot;_ns) != newIsNotSecure) {</span>
<a href="#l11.38"></a><span id="l11.38">     // They don't so its time to send round an update.</span>
<a href="#l11.39"></a><span id="l11.39">     nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l11.40"></a><span id="l11.40">         do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l11.41"></a><span id="l11.41">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43">     // We inherit from nsIAbDirectory, so this static cast should be safe.</span>
<a href="#l11.44"></a><span id="l11.44">     constexpr auto trueString = u&quot;true&quot;_ns;</span>
<a href="#l11.45"></a><span id="l11.45">     constexpr auto falseString = u&quot;false&quot;_ns;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineat">@@ -483,34 +482,32 @@ NS_IMETHODIMP nsAbLDAPDirectory::UseForA</span>
<a href="#l11.47"></a><span id="l11.47">   }</span>
<a href="#l11.48"></a><span id="l11.48">   return NS_OK;</span>
<a href="#l11.49"></a><span id="l11.49"> }</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51"> NS_IMETHODIMP nsAbLDAPDirectory::GetProtocolVersion(</span>
<a href="#l11.52"></a><span id="l11.52">     uint32_t* aProtocolVersion) {</span>
<a href="#l11.53"></a><span id="l11.53">   nsAutoCString versionString;</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  nsresult rv =</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-      GetStringValue(&quot;protocolVersion&quot;, NS_LITERAL_CSTRING(&quot;3&quot;), versionString);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  nsresult rv = GetStringValue(&quot;protocolVersion&quot;, &quot;3&quot;_ns, versionString);</span>
<a href="#l11.58"></a><span id="l11.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">   *aProtocolVersion = versionString.EqualsLiteral(&quot;3&quot;)</span>
<a href="#l11.61"></a><span id="l11.61">                           ? (uint32_t)nsILDAPConnection::VERSION3</span>
<a href="#l11.62"></a><span id="l11.62">                           : (uint32_t)nsILDAPConnection::VERSION2;</span>
<a href="#l11.63"></a><span id="l11.63"> </span>
<a href="#l11.64"></a><span id="l11.64">   return NS_OK;</span>
<a href="#l11.65"></a><span id="l11.65"> }</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67"> NS_IMETHODIMP nsAbLDAPDirectory::SetProtocolVersion(uint32_t aProtocolVersion) {</span>
<a href="#l11.68"></a><span id="l11.68">   // XXX We should cancel any existing LDAP connections here and</span>
<a href="#l11.69"></a><span id="l11.69">   // be ready to re-initialise them with the new auth details.</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  return SetStringValue(&quot;protocolVersion&quot;,</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-                        aProtocolVersion == nsILDAPConnection::VERSION3</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-                            ? NS_LITERAL_CSTRING(&quot;3&quot;)</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-                            : NS_LITERAL_CSTRING(&quot;2&quot;));</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  return SetStringValue(</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+      &quot;protocolVersion&quot;,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+      aProtocolVersion == nsILDAPConnection::VERSION3 ? &quot;3&quot;_ns : &quot;2&quot;_ns);</span>
<a href="#l11.77"></a><span id="l11.77"> }</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79"> NS_IMETHODIMP nsAbLDAPDirectory::GetMaxHits(int32_t* aMaxHits) {</span>
<a href="#l11.80"></a><span id="l11.80">   return GetIntValue(&quot;maxHits&quot;, kDefaultMaxHits, aMaxHits);</span>
<a href="#l11.81"></a><span id="l11.81"> }</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83"> NS_IMETHODIMP nsAbLDAPDirectory::SetMaxHits(int32_t aMaxHits) {</span>
<a href="#l11.84"></a><span id="l11.84">   return SetIntValue(&quot;maxHits&quot;, aMaxHits);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineat">@@ -608,18 +605,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::DeleteC</span>
<a href="#l11.86"></a><span id="l11.86">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.87"></a><span id="l11.87"> }</span>
<a href="#l11.88"></a><span id="l11.88"> </span>
<a href="#l11.89"></a><span id="l11.89"> NS_IMETHODIMP nsAbLDAPDirectory::ModifyCard(nsIAbCard* aUpdatedCard) {</span>
<a href="#l11.90"></a><span id="l11.90">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.91"></a><span id="l11.91"> }</span>
<a href="#l11.92"></a><span id="l11.92"> </span>
<a href="#l11.93"></a><span id="l11.93"> NS_IMETHODIMP nsAbLDAPDirectory::GetRdnAttributes(nsACString&amp; aRdnAttributes) {</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-  return GetStringValue(&quot;rdnAttributes&quot;, NS_LITERAL_CSTRING(&quot;cn&quot;),</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-                        aRdnAttributes);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  return GetStringValue(&quot;rdnAttributes&quot;, &quot;cn&quot;_ns, aRdnAttributes);</span>
<a href="#l11.97"></a><span id="l11.97"> }</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99"> NS_IMETHODIMP nsAbLDAPDirectory::SetRdnAttributes(</span>
<a href="#l11.100"></a><span id="l11.100">     const nsACString&amp; aRdnAttributes) {</span>
<a href="#l11.101"></a><span id="l11.101">   return SetStringValue(&quot;rdnAttributes&quot;, aRdnAttributes);</span>
<a href="#l11.102"></a><span id="l11.102"> }</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104"> NS_IMETHODIMP nsAbLDAPDirectory::GetObjectClasses(nsACString&amp; aObjectClasses) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -359,17 +359,17 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l12.4"></a><span id="l12.4">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">   rv = url-&gt;SetAttributes(returnAttributes);</span>
<a href="#l12.7"></a><span id="l12.7">   // Now do the error check</span>
<a href="#l12.8"></a><span id="l12.8">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">   // Also require the objectClass attribute, it is used by</span>
<a href="#l12.11"></a><span id="l12.11">   // nsAbLDAPCard::SetMetaProperties</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  rv = url-&gt;AddAttribute(NS_LITERAL_CSTRING(&quot;objectClass&quot;));</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  rv = url-&gt;AddAttribute(&quot;objectClass&quot;_ns);</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15">   nsAutoCString filter;</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17">   // Get filter from arguments if set:</span>
<a href="#l12.18"></a><span id="l12.18">   rv = aArguments-&gt;GetFilter(filter);</span>
<a href="#l12.19"></a><span id="l12.19">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">   if (filter.IsEmpty()) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -80,29 +80,29 @@ nsresult nsAddbookProtocolHandler::Gener</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5">   NS_ConvertUTF16toUTF8 utf8String(aOutput.get());</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">   rv = inStr-&gt;SetData(utf8String.get(), utf8String.Length());</span>
<a href="#l13.8"></a><span id="l13.8">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">   if (aLoadInfo) {</span>
<a href="#l13.11"></a><span id="l13.11">     return NS_NewInputStreamChannelInternal(_retval, aURI, inStr.forget(),</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-                                            NS_LITERAL_CSTRING(&quot;text/xml&quot;),</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                                            EmptyCString(), aLoadInfo);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+                                            &quot;text/xml&quot;_ns, EmptyCString(),</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+                                            aLoadInfo);</span>
<a href="#l13.16"></a><span id="l13.16">   }</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18">   nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l13.19"></a><span id="l13.19">       do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l13.20"></a><span id="l13.20">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipalfailed.&quot;);</span>
<a href="#l13.21"></a><span id="l13.21">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   return NS_NewInputStreamChannel(</span>
<a href="#l13.24"></a><span id="l13.24">       _retval, aURI, inStr.forget(), nullPrincipal,</span>
<a href="#l13.25"></a><span id="l13.25">       nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-      nsIContentPolicy::TYPE_OTHER, NS_LITERAL_CSTRING(&quot;text/xml&quot;));</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+      nsIContentPolicy::TYPE_OTHER, &quot;text/xml&quot;_ns);</span>
<a href="#l13.28"></a><span id="l13.28"> }</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30"> NS_IMETHODIMP</span>
<a href="#l13.31"></a><span id="l13.31"> nsAddbookProtocolHandler::NewChannel(nsIURI* aURI, nsILoadInfo* aLoadInfo,</span>
<a href="#l13.32"></a><span id="l13.32">                                      nsIChannel** _retval) {</span>
<a href="#l13.33"></a><span id="l13.33">   nsresult rv;</span>
<a href="#l13.34"></a><span id="l13.34">   nsCOMPtr&lt;nsIAddbookUrl&gt; addbookUrl = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l13.35"></a><span id="l13.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineat">@@ -134,32 +134,30 @@ nsAddbookProtocolHandler::NewChannel(nsI</span>
<a href="#l13.37"></a><span id="l13.37">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39">     // These always succeed because the pipe is initialized above.</span>
<a href="#l13.40"></a><span id="l13.40">     MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetInputStream(getter_AddRefs(pipeIn)));</span>
<a href="#l13.41"></a><span id="l13.41">     MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetOutputStream(getter_AddRefs(pipeOut)));</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">     pipeOut-&gt;Close();</span>
<a href="#l13.44"></a><span id="l13.44">     if (aLoadInfo) {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-      return NS_NewInputStreamChannelInternal(</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-          _retval, aURI, pipeIn.forget(),</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-          NS_LITERAL_CSTRING(&quot;application/x-addvcard&quot;), EmptyCString(),</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-          aLoadInfo);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+      return NS_NewInputStreamChannelInternal(_retval, aURI, pipeIn.forget(),</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+                                              &quot;application/x-addvcard&quot;_ns,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+                                              EmptyCString(), aLoadInfo);</span>
<a href="#l13.52"></a><span id="l13.52">     }</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54">     nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l13.55"></a><span id="l13.55">         do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l13.56"></a><span id="l13.56">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipal failed.&quot;);</span>
<a href="#l13.57"></a><span id="l13.57">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59">     return NS_NewInputStreamChannel(</span>
<a href="#l13.60"></a><span id="l13.60">         _retval, aURI, pipeIn.forget(), nullPrincipal,</span>
<a href="#l13.61"></a><span id="l13.61">         nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-        nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-        NS_LITERAL_CSTRING(&quot;application/x-addvcard&quot;));</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+        nsIContentPolicy::TYPE_OTHER, &quot;application/x-addvcard&quot;_ns);</span>
<a href="#l13.65"></a><span id="l13.65">   }</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">   nsString output;</span>
<a href="#l13.68"></a><span id="l13.68">   rv = GeneratePrintOutput(addbookUrl, output);</span>
<a href="#l13.69"></a><span id="l13.69">   if (NS_FAILED(rv)) {</span>
<a href="#l13.70"></a><span id="l13.70">     output.AssignLiteral(&quot;failed to print. url=&quot;);</span>
<a href="#l13.71"></a><span id="l13.71">     nsAutoCString spec;</span>
<a href="#l13.72"></a><span id="l13.72">     rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineat">@@ -345,17 +343,17 @@ nsresult nsAddbookProtocolHandler::Build</span>
<a href="#l13.74"></a><span id="l13.74">   for (CardEnclosure enclosure : cards) {</span>
<a href="#l13.75"></a><span id="l13.75">     bool isMailList;</span>
<a href="#l13.76"></a><span id="l13.76">     if (NS_FAILED(enclosure.card-&gt;GetIsMailList(&amp;isMailList)) || isMailList) {</span>
<a href="#l13.77"></a><span id="l13.77">       continue;</span>
<a href="#l13.78"></a><span id="l13.78">     }</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80">     nsCString xmlSubstr;</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-    rv = enclosure.card-&gt;TranslateTo(NS_LITERAL_CSTRING(&quot;xml&quot;), xmlSubstr);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+    rv = enclosure.card-&gt;TranslateTo(&quot;xml&quot;_ns, xmlSubstr);</span>
<a href="#l13.84"></a><span id="l13.84">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.85"></a><span id="l13.85"> </span>
<a href="#l13.86"></a><span id="l13.86">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span>
<a href="#l13.87"></a><span id="l13.87">     aOutput.Append(NS_ConvertUTF8toUTF16(xmlSubstr));</span>
<a href="#l13.88"></a><span id="l13.88">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span>
<a href="#l13.89"></a><span id="l13.89">   }</span>
<a href="#l13.90"></a><span id="l13.90"> </span>
<a href="#l13.91"></a><span id="l13.91">   aOutput.AppendLiteral(&quot;&lt;/directory&gt;\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgBodyHandler.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgBodyHandler.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -310,18 +310,17 @@ int32_t nsMsgBodyHandler::ApplyTransform</span>
<a href="#l14.4"></a><span id="l14.4">     eatThisLine = true;</span>
<a href="#l14.5"></a><span id="l14.5">     return 0;</span>
<a href="#l14.6"></a><span id="l14.6">   }</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8">   // Accumulate base64 parts and HTML parts for later decoding or tag stripping.</span>
<a href="#l14.9"></a><span id="l14.9">   if (m_base64part || m_partIsHtml) {</span>
<a href="#l14.10"></a><span id="l14.10">     if (m_partIsHtml &amp;&amp; !m_base64part) {</span>
<a href="#l14.11"></a><span id="l14.11">       size_t bufLength = buf.Length();</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-      if (!m_partIsQP || bufLength == 0 ||</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-          !StringEndsWith(buf, NS_LITERAL_CSTRING(&quot;=&quot;))) {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+      if (!m_partIsQP || bufLength == 0 || !StringEndsWith(buf, &quot;=&quot;_ns)) {</span>
<a href="#l14.15"></a><span id="l14.15">         // Replace newline in HTML with a space.</span>
<a href="#l14.16"></a><span id="l14.16">         buf.Append(' ');</span>
<a href="#l14.17"></a><span id="l14.17">       } else {</span>
<a href="#l14.18"></a><span id="l14.18">         // Strip the soft line break.</span>
<a href="#l14.19"></a><span id="l14.19">         buf.SetLength(bufLength - 1);</span>
<a href="#l14.20"></a><span id="l14.20">       }</span>
<a href="#l14.21"></a><span id="l14.21">     }</span>
<a href="#l14.22"></a><span id="l14.22">     buf.Append(line);</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -369,22 +368,21 @@ void nsMsgBodyHandler::StripHtml(nsCStri</span>
<a href="#l14.24"></a><span id="l14.24"> void nsMsgBodyHandler::SniffPossibleMIMEHeader(const nsCString&amp; line) {</span>
<a href="#l14.25"></a><span id="l14.25">   // Some parts of MIME are case-sensitive and other parts are case-insensitive;</span>
<a href="#l14.26"></a><span id="l14.26">   // specifically, the headers are all case-insensitive and the values we care</span>
<a href="#l14.27"></a><span id="l14.27">   // about are also case-insensitive, with the sole exception of the boundary</span>
<a href="#l14.28"></a><span id="l14.28">   // string, so we can't just take the input line and make it lower case.</span>
<a href="#l14.29"></a><span id="l14.29">   nsCString lowerCaseLine(line);</span>
<a href="#l14.30"></a><span id="l14.30">   ToLowerCase(lowerCaseLine);</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  if (StringBeginsWith(lowerCaseLine,</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;content-transfer-encoding:&quot;)))</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+  if (StringBeginsWith(lowerCaseLine, &quot;content-transfer-encoding:&quot;_ns))</span>
<a href="#l14.35"></a><span id="l14.35">     m_partIsQP =</span>
<a href="#l14.36"></a><span id="l14.36">         lowerCaseLine.Find(&quot;quoted-printable&quot;, /* ignoreCase = */ true) != -1;</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-  if (StringBeginsWith(lowerCaseLine, NS_LITERAL_CSTRING(&quot;content-type:&quot;))) {</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+  if (StringBeginsWith(lowerCaseLine, &quot;content-type:&quot;_ns)) {</span>
<a href="#l14.40"></a><span id="l14.40">     if (lowerCaseLine.Find(&quot;text/html&quot;, /* ignoreCase = */ true) != -1) {</span>
<a href="#l14.41"></a><span id="l14.41">       m_partIsText = true;</span>
<a href="#l14.42"></a><span id="l14.42">       m_partIsHtml = true;</span>
<a href="#l14.43"></a><span id="l14.43">     } else if (lowerCaseLine.Find(&quot;multipart/&quot;, /* ignoreCase = */ true) !=</span>
<a href="#l14.44"></a><span id="l14.44">                -1) {</span>
<a href="#l14.45"></a><span id="l14.45">       if (m_isMultipart) {</span>
<a href="#l14.46"></a><span id="l14.46">         // Nested multipart, get ready for new headers.</span>
<a href="#l14.47"></a><span id="l14.47">         m_base64part = false;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineat">@@ -436,18 +434,17 @@ void nsMsgBodyHandler::SniffPossibleMIME</span>
<a href="#l14.49"></a><span id="l14.49">       foundQuote = true;</span>
<a href="#l14.50"></a><span id="l14.50">     }</span>
<a href="#l14.51"></a><span id="l14.51">     int32_t end = line.FindChar(foundQuote ? '\&quot;' : ';', start);</span>
<a href="#l14.52"></a><span id="l14.52">     if (end == -1) end = line.Length();</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54">     m_partCharset.Assign(Substring(line, start, end - start));</span>
<a href="#l14.55"></a><span id="l14.55">   }</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-  if (StringBeginsWith(lowerCaseLine,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;content-transfer-encoding:&quot;)) &amp;&amp;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  if (StringBeginsWith(lowerCaseLine, &quot;content-transfer-encoding:&quot;_ns) &amp;&amp;</span>
<a href="#l14.60"></a><span id="l14.60">       lowerCaseLine.Find(ENCODING_BASE64, /* ignoreCase = */ true) != kNotFound)</span>
<a href="#l14.61"></a><span id="l14.61">     m_base64part = true;</span>
<a href="#l14.62"></a><span id="l14.62"> }</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64"> /**</span>
<a href="#l14.65"></a><span id="l14.65">  * Decodes the given base64 string.</span>
<a href="#l14.66"></a><span id="l14.66">  *</span>
<a href="#l14.67"></a><span id="l14.67">  * It returns its decoded string in its input.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -545,17 +545,17 @@ nsresult nsMsgFilter::LogRuleHitGeneric(</span>
<a href="#l15.4"></a><span id="l15.4">     if (NS_SUCCEEDED(rv) &amp;&amp; customAction)</span>
<a href="#l15.5"></a><span id="l15.5">       customAction-&gt;GetName(filterActionName);</span>
<a href="#l15.6"></a><span id="l15.6">     if (filterActionName.IsEmpty())</span>
<a href="#l15.7"></a><span id="l15.7">       bundle-&gt;GetStringFromName(&quot;filterMissingCustomAction&quot;, filterActionName);</span>
<a href="#l15.8"></a><span id="l15.8">     buffer += filterActionName;</span>
<a href="#l15.9"></a><span id="l15.9">   } else {</span>
<a href="#l15.10"></a><span id="l15.10">     nsString actionValue;</span>
<a href="#l15.11"></a><span id="l15.11">     nsAutoCString filterActionID;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    filterActionID = NS_LITERAL_CSTRING(&quot;filterAction&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    filterActionID = &quot;filterAction&quot;_ns;</span>
<a href="#l15.14"></a><span id="l15.14">     filterActionID.AppendInt(actionType);</span>
<a href="#l15.15"></a><span id="l15.15">     rv = bundle-&gt;GetStringFromName(filterActionID.get(), actionValue);</span>
<a href="#l15.16"></a><span id="l15.16">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">     buffer += actionValue;</span>
<a href="#l15.19"></a><span id="l15.19">   }</span>
<a href="#l15.20"></a><span id="l15.20">   buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -644,17 +644,17 @@ nsresult nsMsgFilter::ConvertMoveOrCopyT</span>
<a href="#l15.23"></a><span id="l15.23">     } else {</span>
<a href="#l15.24"></a><span id="l15.24">       // start off leaving the value the same.</span>
<a href="#l15.25"></a><span id="l15.25">       filterAction-&gt;SetTargetFolderUri(moveValue);</span>
<a href="#l15.26"></a><span id="l15.26">       nsresult rv = NS_OK;</span>
<a href="#l15.27"></a><span id="l15.27">       nsCOMPtr&lt;nsIMsgFolder&gt; localMailRoot;</span>
<a href="#l15.28"></a><span id="l15.28">       rootFolder-&gt;GetURI(folderUri);</span>
<a href="#l15.29"></a><span id="l15.29">       // if the root folder is not imap, than the local mail root is the server</span>
<a href="#l15.30"></a><span id="l15.30">       // root. otherwise, it's the migrated local folders.</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-      if (!StringBeginsWith(folderUri, NS_LITERAL_CSTRING(&quot;imap:&quot;)))</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+      if (!StringBeginsWith(folderUri, &quot;imap:&quot;_ns))</span>
<a href="#l15.33"></a><span id="l15.33">         localMailRoot = rootFolder;</span>
<a href="#l15.34"></a><span id="l15.34">       else {</span>
<a href="#l15.35"></a><span id="l15.35">         nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l15.36"></a><span id="l15.36">             do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.37"></a><span id="l15.37">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.38"></a><span id="l15.38">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.39"></a><span id="l15.39">         rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l15.40"></a><span id="l15.40">         if (NS_SUCCEEDED(rv) &amp;&amp; server)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -206,17 +206,17 @@ nsresult nsMsgFilterList::GetLogFile(nsI</span>
<a href="#l16.4"></a><span id="l16.4">     rv = filterLogFile-&gt;SetLeafName(filterLogName);</span>
<a href="#l16.5"></a><span id="l16.5">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">     filterLogFile.forget(aFile);</span>
<a href="#l16.8"></a><span id="l16.8">   } else {</span>
<a href="#l16.9"></a><span id="l16.9">     rv = server-&gt;GetLocalPath(aFile);</span>
<a href="#l16.10"></a><span id="l16.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    rv = (*aFile)-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;filterlog.html&quot;));</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    rv = (*aFile)-&gt;AppendNative(&quot;filterlog.html&quot;_ns);</span>
<a href="#l16.14"></a><span id="l16.14">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.15"></a><span id="l16.15">   }</span>
<a href="#l16.16"></a><span id="l16.16">   return EnsureLogFile(*aFile);</span>
<a href="#l16.17"></a><span id="l16.17"> }</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19"> NS_IMETHODIMP</span>
<a href="#l16.20"></a><span id="l16.20"> nsMsgFilterList::GetLogURL(nsACString&amp; aLogURL) {</span>
<a href="#l16.21"></a><span id="l16.21">   nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -349,34 +349,32 @@ nsMsgFilterList::ApplyFiltersToHdr(nsMsg</span>
<a href="#l16.23"></a><span id="l16.23">           MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l16.24"></a><span id="l16.24">                   (&quot;(Auto) Matched message ID: %s&quot;, msgId.get()));</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26">           bool applyMore = true;</span>
<a href="#l16.27"></a><span id="l16.27">           rv = listener-&gt;ApplyFilterHit(filter, msgWindow, &amp;applyMore);</span>
<a href="#l16.28"></a><span id="l16.28">           if (NS_FAILED(rv)) {</span>
<a href="#l16.29"></a><span id="l16.29">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l16.30"></a><span id="l16.30">                     (&quot;(Auto) Applying filter actions failed&quot;));</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-            LogFilterMessage(</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                NS_LITERAL_STRING(&quot;Applying filter actions failed&quot;), filter);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+            LogFilterMessage(u&quot;Applying filter actions failed&quot;_ns, filter);</span>
<a href="#l16.34"></a><span id="l16.34">           } else {</span>
<a href="#l16.35"></a><span id="l16.35">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l16.36"></a><span id="l16.36">                     (&quot;(Auto) Applying filter actions succeeded&quot;));</span>
<a href="#l16.37"></a><span id="l16.37">           }</span>
<a href="#l16.38"></a><span id="l16.38">           if (NS_FAILED(rv) || !applyMore) {</span>
<a href="#l16.39"></a><span id="l16.39">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l16.40"></a><span id="l16.40">                     (&quot;(Auto) Stopping further filter execution&quot;</span>
<a href="#l16.41"></a><span id="l16.41">                      &quot; on this message&quot;));</span>
<a href="#l16.42"></a><span id="l16.42">             break;</span>
<a href="#l16.43"></a><span id="l16.43">           }</span>
<a href="#l16.44"></a><span id="l16.44">         } else {</span>
<a href="#l16.45"></a><span id="l16.45">           if (NS_FAILED(matchTermStatus)) {</span>
<a href="#l16.46"></a><span id="l16.46">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l16.47"></a><span id="l16.47">                     (&quot;(Auto) Filter evaluation failed&quot;));</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-            LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;),</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-                             filter);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+            LogFilterMessage(u&quot;Filter evaluation failed&quot;_ns, filter);</span>
<a href="#l16.51"></a><span id="l16.51">           }</span>
<a href="#l16.52"></a><span id="l16.52">           if (!result)</span>
<a href="#l16.53"></a><span id="l16.53">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l16.54"></a><span id="l16.54">                     (&quot;(Auto) Filter didn't match&quot;));</span>
<a href="#l16.55"></a><span id="l16.55">         }</span>
<a href="#l16.56"></a><span id="l16.56">       } else {</span>
<a href="#l16.57"></a><span id="l16.57">         MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l16.58"></a><span id="l16.58">                 (&quot;(Auto) Skipping filter of non-matching type&quot;</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineat">@@ -385,17 +383,17 @@ nsMsgFilterList::ApplyFiltersToHdr(nsMsg</span>
<a href="#l16.60"></a><span id="l16.60">       }</span>
<a href="#l16.61"></a><span id="l16.61">     }</span>
<a href="#l16.62"></a><span id="l16.62">   }</span>
<a href="#l16.63"></a><span id="l16.63">   if (NS_FAILED(rv)) {</span>
<a href="#l16.64"></a><span id="l16.64">     // clang-format off</span>
<a href="#l16.65"></a><span id="l16.65">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l16.66"></a><span id="l16.66">             (&quot;(Auto) Filter run failed (%&quot; PRIx32 &quot;)&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l16.67"></a><span id="l16.67">     // clang-format on</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-    LogFilterMessage(NS_LITERAL_STRING(&quot;Filter run failed&quot;), nullptr);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+    LogFilterMessage(u&quot;Filter run failed&quot;_ns, nullptr);</span>
<a href="#l16.70"></a><span id="l16.70">   }</span>
<a href="#l16.71"></a><span id="l16.71">   return rv;</span>
<a href="#l16.72"></a><span id="l16.72"> }</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74"> NS_IMETHODIMP</span>
<a href="#l16.75"></a><span id="l16.75"> nsMsgFilterList::SetDefaultFile(nsIFile* aFile) {</span>
<a href="#l16.76"></a><span id="l16.76">   m_defaultFile = aFile;</span>
<a href="#l16.77"></a><span id="l16.77">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -248,23 +248,22 @@ nsresult nsMsgFilterService::BackUpFilte</span>
<a href="#l17.4"></a><span id="l17.4">   nsCOMPtr&lt;nsIFile&gt; localParentDir;</span>
<a href="#l17.5"></a><span id="l17.5">   nsresult rv = aFilterFile-&gt;GetParent(getter_AddRefs(localParentDir));</span>
<a href="#l17.6"></a><span id="l17.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8">   // if back-up file exists delete the back up file otherwise copy fails.</span>
<a href="#l17.9"></a><span id="l17.9">   nsCOMPtr&lt;nsIFile&gt; backupFile;</span>
<a href="#l17.10"></a><span id="l17.10">   rv = localParentDir-&gt;Clone(getter_AddRefs(backupFile));</span>
<a href="#l17.11"></a><span id="l17.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  backupFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;rulesbackup.dat&quot;));</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  backupFile-&gt;AppendNative(&quot;rulesbackup.dat&quot;_ns);</span>
<a href="#l17.14"></a><span id="l17.14">   bool exists;</span>
<a href="#l17.15"></a><span id="l17.15">   backupFile-&gt;Exists(&amp;exists);</span>
<a href="#l17.16"></a><span id="l17.16">   if (exists) backupFile-&gt;Remove(false);</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-  return aFilterFile-&gt;CopyToNative(localParentDir,</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-                                   NS_LITERAL_CSTRING(&quot;rulesbackup.dat&quot;));</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  return aFilterFile-&gt;CopyToNative(localParentDir, &quot;rulesbackup.dat&quot;_ns);</span>
<a href="#l17.21"></a><span id="l17.21"> }</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> nsresult nsMsgFilterService::AlertBackingUpFilterFile(</span>
<a href="#l17.24"></a><span id="l17.24">     nsIMsgWindow* aMsgWindow) {</span>
<a href="#l17.25"></a><span id="l17.25">   return ThrowAlertMsg(&quot;filterListBackUpMsg&quot;, aMsgWindow);</span>
<a href="#l17.26"></a><span id="l17.26"> }</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28"> // Do not use this routine if you have to call it very often because it creates</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineat">@@ -483,18 +482,17 @@ nsresult nsMsgFilterAfterTheFact::RunNex</span>
<a href="#l17.30"></a><span id="l17.30">     rv = m_searchSession-&gt;Search(m_msgWindow);</span>
<a href="#l17.31"></a><span id="l17.31">     CONTINUE_IF_FAILURE(rv, &quot;Search failed&quot;);</span>
<a href="#l17.32"></a><span id="l17.32">     return NS_OK;  // OnSearchDone will continue</span>
<a href="#l17.33"></a><span id="l17.33">   }</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">   if (NS_FAILED(rv)) {</span>
<a href="#l17.36"></a><span id="l17.36">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l17.37"></a><span id="l17.37">             (&quot;(Post) Filter evaluation failed&quot;));</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;),</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-                                m_curFilter);</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+    m_filters-&gt;LogFilterMessage(u&quot;Filter evaluation failed&quot;_ns, m_curFilter);</span>
<a href="#l17.41"></a><span id="l17.41">   }</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43">   m_curFilter = nullptr;</span>
<a href="#l17.44"></a><span id="l17.44">   NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;Search failed&quot;);</span>
<a href="#l17.45"></a><span id="l17.45">   return AdvanceToNextFolder();</span>
<a href="#l17.46"></a><span id="l17.46"> }</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48"> nsresult nsMsgFilterAfterTheFact::AdvanceToNextFolder() {</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineat">@@ -894,21 +892,21 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l17.50"></a><span id="l17.50">           BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l17.51"></a><span id="l17.51">           for (auto msgHdr : hitHdrs) {</span>
<a href="#l17.52"></a><span id="l17.52">             rv = compService-&gt;ReplyWithTemplate(msgHdr, replyTemplateUri.get(),</span>
<a href="#l17.53"></a><span id="l17.53">                                                 m_msgWindow, server);</span>
<a href="#l17.54"></a><span id="l17.54">             if (NS_FAILED(rv)) {</span>
<a href="#l17.55"></a><span id="l17.55">               if (rv == NS_ERROR_ABORT) {</span>
<a href="#l17.56"></a><span id="l17.56">                 (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l17.57"></a><span id="l17.57">                     filterAction, msgHdr, rv,</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+                    &quot;filterFailureSendingReplyAborted&quot;_ns);</span>
<a href="#l17.60"></a><span id="l17.60">               } else {</span>
<a href="#l17.61"></a><span id="l17.61">                 (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l17.62"></a><span id="l17.62">                     filterAction, msgHdr, rv,</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+                    &quot;filterFailureSendingReplyError&quot;_ns);</span>
<a href="#l17.65"></a><span id="l17.65">               }</span>
<a href="#l17.66"></a><span id="l17.66">             }</span>
<a href="#l17.67"></a><span id="l17.67">             BREAK_ACTION_IF_FAILURE(rv, &quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l17.68"></a><span id="l17.68">           }</span>
<a href="#l17.69"></a><span id="l17.69">         } break;</span>
<a href="#l17.70"></a><span id="l17.70">         case nsMsgFilterAction::DeleteFromPop3Server: {</span>
<a href="#l17.71"></a><span id="l17.71">           nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l17.72"></a><span id="l17.72">               do_QueryInterface(curFolder, &amp;rv);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineat">@@ -1002,19 +1000,18 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l17.74"></a><span id="l17.74">       }</span>
<a href="#l17.75"></a><span id="l17.75">       if (NS_FAILED(finalResult)) {</span>
<a href="#l17.76"></a><span id="l17.76">         mFinalResult = finalResult;</span>
<a href="#l17.77"></a><span id="l17.77">         MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l17.78"></a><span id="l17.78">                 (&quot;(Post) Action execution failed with error: %&quot; PRIx32,</span>
<a href="#l17.79"></a><span id="l17.79">                  static_cast&lt;uint32_t&gt;(mFinalResult)));</span>
<a href="#l17.80"></a><span id="l17.80">         if (loggingEnabled) {</span>
<a href="#l17.81"></a><span id="l17.81">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, 0);</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-          (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-              filterAction, msgHdr, mFinalResult,</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-              NS_LITERAL_CSTRING(&quot;filterActionFailed&quot;));</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+          (void)m_curFilter-&gt;LogRuleHitFail(filterAction, msgHdr, mFinalResult,</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+                                            &quot;filterActionFailed&quot;_ns);</span>
<a href="#l17.87"></a><span id="l17.87">         }</span>
<a href="#l17.88"></a><span id="l17.88">       } else {</span>
<a href="#l17.89"></a><span id="l17.89">         MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l17.90"></a><span id="l17.90">                 (&quot;(Post) Action execution succeeded&quot;));</span>
<a href="#l17.91"></a><span id="l17.91">       }</span>
<a href="#l17.92"></a><span id="l17.92">     }</span>
<a href="#l17.93"></a><span id="l17.93">   } while (false);  // end error management block</span>
<a href="#l17.94"></a><span id="l17.94">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineat">@@ -1261,18 +1258,17 @@ nsresult nsMsgApplyFiltersToMessages::Ru</span>
<a href="#l17.96"></a><span id="l17.96">   }</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98">   if (NS_FAILED(rv)) {</span>
<a href="#l17.99"></a><span id="l17.99">     // clang-format off</span>
<a href="#l17.100"></a><span id="l17.100">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l17.101"></a><span id="l17.101">             (&quot;(Post) Filter run failed (%&quot; PRIx32 &quot;)&quot;,</span>
<a href="#l17.102"></a><span id="l17.102">              static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l17.103"></a><span id="l17.103">     // clang-format on</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(&quot;Filter run failed&quot;),</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-                                m_curFilter);</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+    m_filters-&gt;LogFilterMessage(u&quot;Filter run failed&quot;_ns, m_curFilter);</span>
<a href="#l17.107"></a><span id="l17.107">     NS_WARNING_ASSERTION(false, &quot;Failed to run filters&quot;);</span>
<a href="#l17.108"></a><span id="l17.108">   } else {</span>
<a href="#l17.109"></a><span id="l17.109">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l17.110"></a><span id="l17.110">             (&quot;(Post) Filter run finished on the current folder&quot;));</span>
<a href="#l17.111"></a><span id="l17.111">   }</span>
<a href="#l17.112"></a><span id="l17.112"> </span>
<a href="#l17.113"></a><span id="l17.113">   m_curFilter = nullptr;</span>
<a href="#l17.114"></a><span id="l17.114"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -204,20 +204,19 @@ nsresult nsMsgSearchAdapter::GetSearchCh</span>
<a href="#l18.4"></a><span id="l18.4">       rv = prefs-&gt;GetComplexValue(&quot;mailnews.view_default_charset&quot;,</span>
<a href="#l18.5"></a><span id="l18.5">                                   NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l18.6"></a><span id="l18.6">                                   getter_AddRefs(localizedstr));</span>
<a href="#l18.7"></a><span id="l18.7">       if (NS_SUCCEEDED(rv)) localizedstr-&gt;GetData(m_defaultCharset);</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">       prefs-&gt;GetBoolPref(&quot;mailnews.force_ascii_search&quot;, &amp;forceAsciiSearch);</span>
<a href="#l18.10"></a><span id="l18.10">     }</span>
<a href="#l18.11"></a><span id="l18.11">   }</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  srcCharset =</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-      m_defaultCharset.IsEmpty()</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-          ? static_cast&lt;const nsAString&amp;&gt;(NS_LITERAL_STRING(&quot;ISO-8859-1&quot;))</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-          : m_defaultCharset;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+  srcCharset = m_defaultCharset.IsEmpty()</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+                   ? static_cast&lt;const nsAString&amp;&gt;(u&quot;ISO-8859-1&quot;_ns)</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+                   : m_defaultCharset;</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20">   if (m_scope) {</span>
<a href="#l18.21"></a><span id="l18.21">     // ### DMB is there a way to get the charset for the &quot;window&quot;?</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l18.24"></a><span id="l18.24">     rv = m_scope-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26">     // Ask the newsgroup/folder for its csid.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -845,17 +845,17 @@ nsresult nsMsgSearchTerm::MatchBody(nsIM</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">   nsCString compare;</span>
<a href="#l19.6"></a><span id="l19.6">   nsCString charset;</span>
<a href="#l19.7"></a><span id="l19.7">   while (!endOfFile &amp;&amp; result == boolContinueLoop) {</span>
<a href="#l19.8"></a><span id="l19.8">     if (bodyHan-&gt;GetNextLine(buf, charset) &gt;= 0) {</span>
<a href="#l19.9"></a><span id="l19.9">       bool softLineBreak = false;</span>
<a href="#l19.10"></a><span id="l19.10">       // Do in-place decoding of quoted printable</span>
<a href="#l19.11"></a><span id="l19.11">       if (bodyHan-&gt;IsQP()) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-        softLineBreak = StringEndsWith(buf, NS_LITERAL_CSTRING(&quot;=&quot;));</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+        softLineBreak = StringEndsWith(buf, &quot;=&quot;_ns);</span>
<a href="#l19.14"></a><span id="l19.14">         MsgStripQuotedPrintable(buf);</span>
<a href="#l19.15"></a><span id="l19.15">         // If soft line break, chop off the last char as well.</span>
<a href="#l19.16"></a><span id="l19.16">         size_t bufLength = buf.Length();</span>
<a href="#l19.17"></a><span id="l19.17">         if ((bufLength &gt; 0) &amp;&amp; softLineBreak) buf.SetLength(bufLength - 1);</span>
<a href="#l19.18"></a><span id="l19.18">       }</span>
<a href="#l19.19"></a><span id="l19.19">       compare.Append(buf);</span>
<a href="#l19.20"></a><span id="l19.20">       // If this line ends with a soft line break, loop around</span>
<a href="#l19.21"></a><span id="l19.21">       // and get the next line before looking for the search string.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/src/nsMailDirProvider.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/src/nsMailDirProvider.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -134,17 +134,17 @@ nsMailDirProvider::AppendingEnumerator::</span>
<a href="#l20.4"></a><span id="l20.4">     mBase-&gt;GetNext(getter_AddRefs(nextbasesupp));</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6">     nsCOMPtr&lt;nsIFile&gt; nextbase(do_QueryInterface(nextbasesupp));</span>
<a href="#l20.7"></a><span id="l20.7">     if (!nextbase) continue;</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9">     nextbase-&gt;Clone(getter_AddRefs(mNext));</span>
<a href="#l20.10"></a><span id="l20.10">     if (!mNext) continue;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    mNext-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;isp&quot;));</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    mNext-&gt;AppendNative(&quot;isp&quot;_ns);</span>
<a href="#l20.14"></a><span id="l20.14">     bool exists;</span>
<a href="#l20.15"></a><span id="l20.15">     nsresult rv = mNext-&gt;Exists(&amp;exists);</span>
<a href="#l20.16"></a><span id="l20.16">     if (NS_SUCCEEDED(rv) &amp;&amp; exists) {</span>
<a href="#l20.17"></a><span id="l20.17">       break;</span>
<a href="#l20.18"></a><span id="l20.18">     }</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20">     mNext = nullptr;</span>
<a href="#l20.21"></a><span id="l20.21">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -234,18 +234,18 @@ NS_IMETHODIMP nsMessenger::SetWindow(moz</span>
<a href="#l21.4"></a><span id="l21.4">     mWindow = aWin;</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6">     rv = mailSession-&gt;AddFolderListener(this, nsIFolderListener::removed);</span>
<a href="#l21.7"></a><span id="l21.7">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9">     NS_ENSURE_TRUE(aWin, NS_ERROR_FAILURE);</span>
<a href="#l21.10"></a><span id="l21.10">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; win = nsPIDOMWindowOuter::From(aWin);</span>
<a href="#l21.11"></a><span id="l21.11">     nsIDocShell* rootShell = win-&gt;GetDocShell();</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    RefPtr&lt;mozilla::dom::Element&gt; el = rootShell-&gt;GetDocument()-&gt;GetElementById(</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-        NS_LITERAL_STRING(&quot;messagepane&quot;));</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+    RefPtr&lt;mozilla::dom::Element&gt; el =</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+        rootShell-&gt;GetDocument()-&gt;GetElementById(u&quot;messagepane&quot;_ns);</span>
<a href="#l21.16"></a><span id="l21.16">     RefPtr&lt;mozilla::dom::XULFrameElement&gt; frame =</span>
<a href="#l21.17"></a><span id="l21.17">         mozilla::dom::XULFrameElement::FromNodeOrNull(el);</span>
<a href="#l21.18"></a><span id="l21.18">     mDocShell = nullptr;</span>
<a href="#l21.19"></a><span id="l21.19">     RefPtr&lt;mozilla::dom::Document&gt; doc;</span>
<a href="#l21.20"></a><span id="l21.20">     if (frame) doc = frame-&gt;GetContentDocument();</span>
<a href="#l21.21"></a><span id="l21.21">     if (doc) mDocShell = doc-&gt;GetDocShell();</span>
<a href="#l21.22"></a><span id="l21.22">     if (mDocShell) {</span>
<a href="#l21.23"></a><span id="l21.23">       // Important! Clear out mCurrentDisplayCharset so we reset a default</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineat">@@ -356,17 +356,17 @@ nsresult nsMessenger::PromptIfFileExists</span>
<a href="#l21.25"></a><span id="l21.25">   currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l21.26"></a><span id="l21.26">   if (!leafName.IsEmpty())</span>
<a href="#l21.27"></a><span id="l21.27">     path.Assign(leafName);  // path should be a copy of leafName</span>
<a href="#l21.28"></a><span id="l21.28"> </span>
<a href="#l21.29"></a><span id="l21.29">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l21.30"></a><span id="l21.30">       do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l21.31"></a><span id="l21.31">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.32"></a><span id="l21.32">   nsString saveAttachmentStr;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-  GetString(NS_LITERAL_STRING(&quot;SaveAttachment&quot;), saveAttachmentStr);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+  GetString(u&quot;SaveAttachment&quot;_ns, saveAttachmentStr);</span>
<a href="#l21.35"></a><span id="l21.35">   filePicker-&gt;Init(mWindow, saveAttachmentStr, nsIFilePicker::modeSave);</span>
<a href="#l21.36"></a><span id="l21.36">   filePicker-&gt;SetDefaultString(path);</span>
<a href="#l21.37"></a><span id="l21.37">   filePicker-&gt;AppendFilters(nsIFilePicker::filterAll);</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l21.40"></a><span id="l21.40">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l21.41"></a><span id="l21.41">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir) {</span>
<a href="#l21.42"></a><span id="l21.42">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineat">@@ -418,17 +418,17 @@ nsMessenger::AddMsgUrlToNavigateHistory(</span>
<a href="#l21.44"></a><span id="l21.44">     // more interesting to prune the back and forward menu.</span>
<a href="#l21.45"></a><span id="l21.45">   }</span>
<a href="#l21.46"></a><span id="l21.46">   return NS_OK;</span>
<a href="#l21.47"></a><span id="l21.47"> }</span>
<a href="#l21.48"></a><span id="l21.48"> </span>
<a href="#l21.49"></a><span id="l21.49"> NS_IMETHODIMP</span>
<a href="#l21.50"></a><span id="l21.50"> nsMessenger::OpenURL(const nsACString&amp; aURL) {</span>
<a href="#l21.51"></a><span id="l21.51">   // This is to setup the display DocShell as UTF-8 capable...</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-  SetDisplayCharset(NS_LITERAL_CSTRING(&quot;UTF-8&quot;));</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+  SetDisplayCharset(&quot;UTF-8&quot;_ns);</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">   nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l21.56"></a><span id="l21.56">   nsresult rv = GetMessageServiceFromURI(aURL, getter_AddRefs(messageService));</span>
<a href="#l21.57"></a><span id="l21.57"> </span>
<a href="#l21.58"></a><span id="l21.58">   if (NS_SUCCEEDED(rv) &amp;&amp; messageService) {</span>
<a href="#l21.59"></a><span id="l21.59">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l21.60"></a><span id="l21.60">     messageService-&gt;DisplayMessage(PromiseFlatCString(aURL).get(), mDocShell,</span>
<a href="#l21.61"></a><span id="l21.61">                                    mMsgWindow, nullptr, nullptr,</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineat">@@ -459,59 +459,58 @@ NS_IMETHODIMP nsMessenger::LaunchExterna</span>
<a href="#l21.63"></a><span id="l21.63">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.64"></a><span id="l21.64">   return extProtService-&gt;LoadURI(uri, nullptr, nullptr);</span>
<a href="#l21.65"></a><span id="l21.65"> }</span>
<a href="#l21.66"></a><span id="l21.66"> </span>
<a href="#l21.67"></a><span id="l21.67"> NS_IMETHODIMP</span>
<a href="#l21.68"></a><span id="l21.68"> nsMessenger::LoadURL(mozIDOMWindowProxy* aWin, const nsACString&amp; aURL) {</span>
<a href="#l21.69"></a><span id="l21.69">   nsresult rv;</span>
<a href="#l21.70"></a><span id="l21.70"> </span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  SetDisplayCharset(NS_LITERAL_CSTRING(&quot;UTF-8&quot;));</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+  SetDisplayCharset(&quot;UTF-8&quot;_ns);</span>
<a href="#l21.73"></a><span id="l21.73"> </span>
<a href="#l21.74"></a><span id="l21.74">   NS_ConvertASCIItoUTF16 uriString(aURL);</span>
<a href="#l21.75"></a><span id="l21.75">   // Cleanup the empty spaces that might be on each end.</span>
<a href="#l21.76"></a><span id="l21.76">   uriString.Trim(&quot; &quot;);</span>
<a href="#l21.77"></a><span id="l21.77">   // Eliminate embedded newlines, which single-line text fields now allow:</span>
<a href="#l21.78"></a><span id="l21.78">   uriString.StripChars(&quot;\r\n&quot;);</span>
<a href="#l21.79"></a><span id="l21.79">   NS_ENSURE_TRUE(!uriString.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81">   bool loadingFromFile = false;</span>
<a href="#l21.82"></a><span id="l21.82">   bool getDummyMsgHdr = false;</span>
<a href="#l21.83"></a><span id="l21.83">   int64_t fileSize;</span>
<a href="#l21.84"></a><span id="l21.84"> </span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-  if (StringBeginsWith(uriString, NS_LITERAL_STRING(&quot;file:&quot;))) {</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+  if (StringBeginsWith(uriString, u&quot;file:&quot;_ns)) {</span>
<a href="#l21.87"></a><span id="l21.87">     nsCOMPtr&lt;nsIURI&gt; fileUri;</span>
<a href="#l21.88"></a><span id="l21.88">     rv = NS_NewURI(getter_AddRefs(fileUri), uriString);</span>
<a href="#l21.89"></a><span id="l21.89">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.90"></a><span id="l21.90">     nsCOMPtr&lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l21.91"></a><span id="l21.91">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.92"></a><span id="l21.92">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l21.93"></a><span id="l21.93">     rv = fileUrl-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l21.94"></a><span id="l21.94">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.95"></a><span id="l21.95">     file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-    uriString.Replace(0, 5, NS_LITERAL_STRING(&quot;mailbox:&quot;));</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+    uriString.Replace(0, 5, u&quot;mailbox:&quot;_ns);</span>
<a href="#l21.98"></a><span id="l21.98">     uriString.AppendLiteral(u&quot;&amp;number=0&quot;);</span>
<a href="#l21.99"></a><span id="l21.99">     loadingFromFile = true;</span>
<a href="#l21.100"></a><span id="l21.100">     getDummyMsgHdr = true;</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-  } else if (StringBeginsWith(uriString, NS_LITERAL_STRING(&quot;mailbox:&quot;)) &amp;&amp;</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-             (CaseInsensitiveFindInReadable(NS_LITERAL_STRING(&quot;.eml?&quot;),</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-                                            uriString))) {</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+  } else if (StringBeginsWith(uriString, u&quot;mailbox:&quot;_ns) &amp;&amp;</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+             (CaseInsensitiveFindInReadable(u&quot;.eml?&quot;_ns, uriString))) {</span>
<a href="#l21.106"></a><span id="l21.106">     // if we have a mailbox:// url that points to an .eml file, we have to read</span>
<a href="#l21.107"></a><span id="l21.107">     // the file size as well</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-    uriString.Replace(0, 8, NS_LITERAL_STRING(&quot;file:&quot;));</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+    uriString.Replace(0, 8, u&quot;file:&quot;_ns);</span>
<a href="#l21.110"></a><span id="l21.110">     nsCOMPtr&lt;nsIURI&gt; fileUri;</span>
<a href="#l21.111"></a><span id="l21.111">     rv = NS_NewURI(getter_AddRefs(fileUri), uriString);</span>
<a href="#l21.112"></a><span id="l21.112">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.113"></a><span id="l21.113">     nsCOMPtr&lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l21.114"></a><span id="l21.114">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.115"></a><span id="l21.115">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l21.116"></a><span id="l21.116">     rv = fileUrl-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l21.117"></a><span id="l21.117">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.118"></a><span id="l21.118">     file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-    uriString.Replace(0, 5, NS_LITERAL_STRING(&quot;mailbox:&quot;));</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+    uriString.Replace(0, 5, u&quot;mailbox:&quot;_ns);</span>
<a href="#l21.121"></a><span id="l21.121">     loadingFromFile = true;</span>
<a href="#l21.122"></a><span id="l21.122">     getDummyMsgHdr = true;</span>
<a href="#l21.123"></a><span id="l21.123">   } else if (uriString.Find(&quot;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l21.124"></a><span id="l21.124">     getDummyMsgHdr = true;</span>
<a href="#l21.125"></a><span id="l21.125"> </span>
<a href="#l21.126"></a><span id="l21.126">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l21.127"></a><span id="l21.127">   rv = NS_NewURI(getter_AddRefs(uri), uriString);</span>
<a href="#l21.128"></a><span id="l21.128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineat">@@ -756,19 +755,19 @@ nsresult nsMessenger::SaveOneAttachment(</span>
<a href="#l21.130"></a><span id="l21.130">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l21.131"></a><span id="l21.131">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l21.132"></a><span id="l21.132">   nsCString filePath;</span>
<a href="#l21.133"></a><span id="l21.133">   nsString saveAttachmentStr;</span>
<a href="#l21.134"></a><span id="l21.134">   nsString defaultDisplayString;</span>
<a href="#l21.135"></a><span id="l21.135">   ConvertAndSanitizeFileName(aDisplayName, defaultDisplayString);</span>
<a href="#l21.136"></a><span id="l21.136"> </span>
<a href="#l21.137"></a><span id="l21.137">   if (detaching) {</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineminus">-    GetString(NS_LITERAL_STRING(&quot;DetachAttachment&quot;), saveAttachmentStr);</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+    GetString(u&quot;DetachAttachment&quot;_ns, saveAttachmentStr);</span>
<a href="#l21.140"></a><span id="l21.140">   } else {</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-    GetString(NS_LITERAL_STRING(&quot;SaveAttachment&quot;), saveAttachmentStr);</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineplus">+    GetString(u&quot;SaveAttachment&quot;_ns, saveAttachmentStr);</span>
<a href="#l21.143"></a><span id="l21.143">   }</span>
<a href="#l21.144"></a><span id="l21.144">   filePicker-&gt;Init(mWindow, saveAttachmentStr, nsIFilePicker::modeSave);</span>
<a href="#l21.145"></a><span id="l21.145">   filePicker-&gt;SetDefaultString(defaultDisplayString);</span>
<a href="#l21.146"></a><span id="l21.146"> </span>
<a href="#l21.147"></a><span id="l21.147">   // Check if the attachment file name has an extension (which must not</span>
<a href="#l21.148"></a><span id="l21.148">   // contain spaces) and set it as the default extension for the attachment.</span>
<a href="#l21.149"></a><span id="l21.149">   int32_t extensionIndex = defaultDisplayString.RFindChar('.');</span>
<a href="#l21.150"></a><span id="l21.150">   if (extensionIndex &gt; 0 &amp;&amp;</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineat">@@ -844,19 +843,19 @@ nsresult nsMessenger::SaveAllAttachments</span>
<a href="#l21.152"></a><span id="l21.152">       do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l21.153"></a><span id="l21.153">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l21.154"></a><span id="l21.154">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l21.155"></a><span id="l21.155">   int16_t dialogResult;</span>
<a href="#l21.156"></a><span id="l21.156">   nsString saveAttachmentStr;</span>
<a href="#l21.157"></a><span id="l21.157"> </span>
<a href="#l21.158"></a><span id="l21.158">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.159"></a><span id="l21.159">   if (detaching) {</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineminus">-    GetString(NS_LITERAL_STRING(&quot;DetachAllAttachments&quot;), saveAttachmentStr);</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineplus">+    GetString(u&quot;DetachAllAttachments&quot;_ns, saveAttachmentStr);</span>
<a href="#l21.162"></a><span id="l21.162">   } else {</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-    GetString(NS_LITERAL_STRING(&quot;SaveAllAttachments&quot;), saveAttachmentStr);</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+    GetString(u&quot;SaveAllAttachments&quot;_ns, saveAttachmentStr);</span>
<a href="#l21.165"></a><span id="l21.165">   }</span>
<a href="#l21.166"></a><span id="l21.166">   filePicker-&gt;Init(mWindow, saveAttachmentStr, nsIFilePicker::modeGetFolder);</span>
<a href="#l21.167"></a><span id="l21.167"> </span>
<a href="#l21.168"></a><span id="l21.168">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l21.169"></a><span id="l21.169">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir)</span>
<a href="#l21.170"></a><span id="l21.170">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l21.171"></a><span id="l21.171"> </span>
<a href="#l21.172"></a><span id="l21.172">   rv = ShowPicker(filePicker, &amp;dialogResult);</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineat">@@ -1064,20 +1063,20 @@ nsMessenger::SaveAs(const nsACString&amp; aU</span>
<a href="#l21.174"></a><span id="l21.174">     // The saveListener is owned by whoever we ultimately register the</span>
<a href="#l21.175"></a><span id="l21.175">     // listener with, generally a URL.</span>
<a href="#l21.176"></a><span id="l21.176">     saveListener = new nsSaveMsgListener(tmpFile, this, nullptr);</span>
<a href="#l21.177"></a><span id="l21.177"> </span>
<a href="#l21.178"></a><span id="l21.178">     if (aIdentity)</span>
<a href="#l21.179"></a><span id="l21.179">       rv = aIdentity-&gt;GetStationeryFolder(saveListener-&gt;m_templateUri);</span>
<a href="#l21.180"></a><span id="l21.180">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l21.181"></a><span id="l21.181"> </span>
<a href="#l21.182"></a><span id="l21.182" class="difflineminus">-    bool needDummyHeader = StringBeginsWith(saveListener-&gt;m_templateUri,</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineminus">-                                            NS_LITERAL_CSTRING(&quot;mailbox://&quot;));</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineminus">-    bool canonicalLineEnding = StringBeginsWith(saveListener-&gt;m_templateUri,</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineminus">-                                                NS_LITERAL_CSTRING(&quot;imap://&quot;));</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineplus">+    bool needDummyHeader =</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineplus">+        StringBeginsWith(saveListener-&gt;m_templateUri, &quot;mailbox://&quot;_ns);</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineplus">+    bool canonicalLineEnding =</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineplus">+        StringBeginsWith(saveListener-&gt;m_templateUri, &quot;imap://&quot;_ns);</span>
<a href="#l21.190"></a><span id="l21.190"> </span>
<a href="#l21.191"></a><span id="l21.191">     rv = saveListener-&gt;QueryInterface(NS_GET_IID(nsIUrlListener),</span>
<a href="#l21.192"></a><span id="l21.192">                                       getter_AddRefs(urlListener));</span>
<a href="#l21.193"></a><span id="l21.193">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l21.194"></a><span id="l21.194"> </span>
<a href="#l21.195"></a><span id="l21.195">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l21.196"></a><span id="l21.196">     rv = messageService-&gt;SaveMessageToDisk(</span>
<a href="#l21.197"></a><span id="l21.197">         PromiseFlatCString(aURI).get(), tmpFile, needDummyHeader, urlListener,</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineat">@@ -1094,48 +1093,48 @@ done:</span>
<a href="#l21.199"></a><span id="l21.199"> nsresult nsMessenger::GetSaveAsFile(const nsAString&amp; aMsgFilename,</span>
<a href="#l21.200"></a><span id="l21.200">                                     int32_t* aSaveAsFileType,</span>
<a href="#l21.201"></a><span id="l21.201">                                     nsIFile** aSaveAsFile) {</span>
<a href="#l21.202"></a><span id="l21.202">   nsresult rv;</span>
<a href="#l21.203"></a><span id="l21.203">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l21.204"></a><span id="l21.204">       do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l21.205"></a><span id="l21.205">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.206"></a><span id="l21.206">   nsString saveMailAsStr;</span>
<a href="#l21.207"></a><span id="l21.207" class="difflineminus">-  GetString(NS_LITERAL_STRING(&quot;SaveMailAs&quot;), saveMailAsStr);</span>
<a href="#l21.208"></a><span id="l21.208" class="difflineplus">+  GetString(u&quot;SaveMailAs&quot;_ns, saveMailAsStr);</span>
<a href="#l21.209"></a><span id="l21.209">   filePicker-&gt;Init(mWindow, saveMailAsStr, nsIFilePicker::modeSave);</span>
<a href="#l21.210"></a><span id="l21.210"> </span>
<a href="#l21.211"></a><span id="l21.211">   // if we have a non-null filename use it, otherwise use default save message</span>
<a href="#l21.212"></a><span id="l21.212">   // one</span>
<a href="#l21.213"></a><span id="l21.213">   if (aMsgFilename.IsEmpty()) {</span>
<a href="#l21.214"></a><span id="l21.214">     nsString saveMsgStr;</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineminus">-    GetString(NS_LITERAL_STRING(&quot;defaultSaveMessageAsFileName&quot;), saveMsgStr);</span>
<a href="#l21.216"></a><span id="l21.216" class="difflineplus">+    GetString(u&quot;defaultSaveMessageAsFileName&quot;_ns, saveMsgStr);</span>
<a href="#l21.217"></a><span id="l21.217">     filePicker-&gt;SetDefaultString(saveMsgStr);</span>
<a href="#l21.218"></a><span id="l21.218">   } else {</span>
<a href="#l21.219"></a><span id="l21.219">     filePicker-&gt;SetDefaultString(aMsgFilename);</span>
<a href="#l21.220"></a><span id="l21.220">   }</span>
<a href="#l21.221"></a><span id="l21.221"> </span>
<a href="#l21.222"></a><span id="l21.222">   // because we will be using GetFilterIndex()</span>
<a href="#l21.223"></a><span id="l21.223">   // we must call AppendFilters() one at a time,</span>
<a href="#l21.224"></a><span id="l21.224">   // in MESSENGER_SAVEAS_FILE_TYPE order</span>
<a href="#l21.225"></a><span id="l21.225">   nsString emlFilesStr;</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineminus">-  GetString(NS_LITERAL_STRING(&quot;EMLFiles&quot;), emlFilesStr);</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineminus">-  filePicker-&gt;AppendFilter(emlFilesStr, NS_LITERAL_STRING(&quot;*.eml&quot;));</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineplus">+  GetString(u&quot;EMLFiles&quot;_ns, emlFilesStr);</span>
<a href="#l21.229"></a><span id="l21.229" class="difflineplus">+  filePicker-&gt;AppendFilter(emlFilesStr, u&quot;*.eml&quot;_ns);</span>
<a href="#l21.230"></a><span id="l21.230">   filePicker-&gt;AppendFilters(nsIFilePicker::filterHTML);</span>
<a href="#l21.231"></a><span id="l21.231">   filePicker-&gt;AppendFilters(nsIFilePicker::filterText);</span>
<a href="#l21.232"></a><span id="l21.232">   filePicker-&gt;AppendFilters(nsIFilePicker::filterAll);</span>
<a href="#l21.233"></a><span id="l21.233"> </span>
<a href="#l21.234"></a><span id="l21.234">   // Save as the &quot;All Files&quot; file type by default. We want to save as .eml by</span>
<a href="#l21.235"></a><span id="l21.235">   // default, but the filepickers on some platforms don't switch extensions</span>
<a href="#l21.236"></a><span id="l21.236">   // based on the file type selected (bug 508597).</span>
<a href="#l21.237"></a><span id="l21.237">   filePicker-&gt;SetFilterIndex(ANY_FILE_TYPE);</span>
<a href="#l21.238"></a><span id="l21.238">   // Yes, this is fine even if we ultimately save as HTML or text. On Windows,</span>
<a href="#l21.239"></a><span id="l21.239">   // this actually is a boolean telling the file picker to automatically add</span>
<a href="#l21.240"></a><span id="l21.240">   // the correct extension depending on the filter. On Mac or Linux this is a</span>
<a href="#l21.241"></a><span id="l21.241">   // no-op.</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineminus">-  filePicker-&gt;SetDefaultExtension(NS_LITERAL_STRING(&quot;eml&quot;));</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineplus">+  filePicker-&gt;SetDefaultExtension(u&quot;eml&quot;_ns);</span>
<a href="#l21.244"></a><span id="l21.244"> </span>
<a href="#l21.245"></a><span id="l21.245">   int16_t dialogResult;</span>
<a href="#l21.246"></a><span id="l21.246"> </span>
<a href="#l21.247"></a><span id="l21.247">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l21.248"></a><span id="l21.248">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l21.249"></a><span id="l21.249">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir)</span>
<a href="#l21.250"></a><span id="l21.250">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l21.251"></a><span id="l21.251"> </span>
<a href="#l21.252"></a><span id="l21.252" class="difflineat">@@ -1204,17 +1203,17 @@ nsresult nsMessenger::GetSaveAsFile(cons</span>
<a href="#l21.253"></a><span id="l21.253">  */</span>
<a href="#l21.254"></a><span id="l21.254"> nsresult nsMessenger::GetSaveToDir(nsIFile** aSaveDir) {</span>
<a href="#l21.255"></a><span id="l21.255">   nsresult rv;</span>
<a href="#l21.256"></a><span id="l21.256">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l21.257"></a><span id="l21.257">       do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l21.258"></a><span id="l21.258">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.259"></a><span id="l21.259"> </span>
<a href="#l21.260"></a><span id="l21.260">   nsString chooseFolderStr;</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineminus">-  GetString(NS_LITERAL_STRING(&quot;ChooseFolder&quot;), chooseFolderStr);</span>
<a href="#l21.262"></a><span id="l21.262" class="difflineplus">+  GetString(u&quot;ChooseFolder&quot;_ns, chooseFolderStr);</span>
<a href="#l21.263"></a><span id="l21.263">   filePicker-&gt;Init(mWindow, chooseFolderStr, nsIFilePicker::modeGetFolder);</span>
<a href="#l21.264"></a><span id="l21.264"> </span>
<a href="#l21.265"></a><span id="l21.265">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l21.266"></a><span id="l21.266">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l21.267"></a><span id="l21.267">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir)</span>
<a href="#l21.268"></a><span id="l21.268">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l21.269"></a><span id="l21.269"> </span>
<a href="#l21.270"></a><span id="l21.270">   int16_t dialogResult;</span>
<a href="#l21.271"></a><span id="l21.271" class="difflineat">@@ -1322,17 +1321,17 @@ nsMessenger::MessageServiceFromURI(const</span>
<a href="#l21.272"></a><span id="l21.272"> }</span>
<a href="#l21.273"></a><span id="l21.273"> </span>
<a href="#l21.274"></a><span id="l21.274"> NS_IMETHODIMP</span>
<a href="#l21.275"></a><span id="l21.275"> nsMessenger::MsgHdrFromURI(const nsACString&amp; aUri, nsIMsgDBHdr** aMsgHdr) {</span>
<a href="#l21.276"></a><span id="l21.276">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l21.277"></a><span id="l21.277">   nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l21.278"></a><span id="l21.278">   nsresult rv;</span>
<a href="#l21.279"></a><span id="l21.279"> </span>
<a href="#l21.280"></a><span id="l21.280" class="difflineminus">-  if (mMsgWindow &amp;&amp; (StringBeginsWith(aUri, NS_LITERAL_CSTRING(&quot;file:&quot;)) ||</span>
<a href="#l21.281"></a><span id="l21.281" class="difflineplus">+  if (mMsgWindow &amp;&amp; (StringBeginsWith(aUri, &quot;file:&quot;_ns) ||</span>
<a href="#l21.282"></a><span id="l21.282">                      PromiseFlatCString(aUri).Find(</span>
<a href="#l21.283"></a><span id="l21.283">                          &quot;type=application/x-message-display&quot;) &gt;= 0)) {</span>
<a href="#l21.284"></a><span id="l21.284">     nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l21.285"></a><span id="l21.285">     mMsgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l21.286"></a><span id="l21.286">     if (headerSink) {</span>
<a href="#l21.287"></a><span id="l21.287">       rv = headerSink-&gt;GetDummyMsgHeader(aMsgHdr);</span>
<a href="#l21.288"></a><span id="l21.288">       // Is there a way to check if they're asking for the hdr currently</span>
<a href="#l21.289"></a><span id="l21.289">       // displayed in a stand-alone msg window from a .eml file?</span>
<a href="#l21.290"></a><span id="l21.290" class="difflineat">@@ -1352,17 +1351,17 @@ NS_IMETHODIMP nsMessenger::GetUndoTransa</span>
<a href="#l21.291"></a><span id="l21.291"> </span>
<a href="#l21.292"></a><span id="l21.292">   nsresult rv;</span>
<a href="#l21.293"></a><span id="l21.293">   *txnType = nsMessenger::eUnknown;</span>
<a href="#l21.294"></a><span id="l21.294">   nsCOMPtr&lt;nsITransaction&gt; txn;</span>
<a href="#l21.295"></a><span id="l21.295">   rv = mTxnMgr-&gt;PeekUndoStack(getter_AddRefs(txn));</span>
<a href="#l21.296"></a><span id="l21.296">   if (NS_SUCCEEDED(rv) &amp;&amp; txn) {</span>
<a href="#l21.297"></a><span id="l21.297">     nsCOMPtr&lt;nsIPropertyBag2&gt; propertyBag = do_QueryInterface(txn, &amp;rv);</span>
<a href="#l21.298"></a><span id="l21.298">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.299"></a><span id="l21.299" class="difflineminus">-    return propertyBag-&gt;GetPropertyAsUint32(NS_LITERAL_STRING(&quot;type&quot;), txnType);</span>
<a href="#l21.300"></a><span id="l21.300" class="difflineplus">+    return propertyBag-&gt;GetPropertyAsUint32(u&quot;type&quot;_ns, txnType);</span>
<a href="#l21.301"></a><span id="l21.301">   }</span>
<a href="#l21.302"></a><span id="l21.302">   return rv;</span>
<a href="#l21.303"></a><span id="l21.303"> }</span>
<a href="#l21.304"></a><span id="l21.304"> </span>
<a href="#l21.305"></a><span id="l21.305"> NS_IMETHODIMP nsMessenger::CanUndo(bool* bValue) {</span>
<a href="#l21.306"></a><span id="l21.306">   NS_ENSURE_TRUE(bValue &amp;&amp; mTxnMgr, NS_ERROR_NULL_POINTER);</span>
<a href="#l21.307"></a><span id="l21.307"> </span>
<a href="#l21.308"></a><span id="l21.308">   nsresult rv;</span>
<a href="#l21.309"></a><span id="l21.309" class="difflineat">@@ -1378,17 +1377,17 @@ NS_IMETHODIMP nsMessenger::GetRedoTransa</span>
<a href="#l21.310"></a><span id="l21.310"> </span>
<a href="#l21.311"></a><span id="l21.311">   nsresult rv;</span>
<a href="#l21.312"></a><span id="l21.312">   *txnType = nsMessenger::eUnknown;</span>
<a href="#l21.313"></a><span id="l21.313">   nsCOMPtr&lt;nsITransaction&gt; txn;</span>
<a href="#l21.314"></a><span id="l21.314">   rv = mTxnMgr-&gt;PeekRedoStack(getter_AddRefs(txn));</span>
<a href="#l21.315"></a><span id="l21.315">   if (NS_SUCCEEDED(rv) &amp;&amp; txn) {</span>
<a href="#l21.316"></a><span id="l21.316">     nsCOMPtr&lt;nsIPropertyBag2&gt; propertyBag = do_QueryInterface(txn, &amp;rv);</span>
<a href="#l21.317"></a><span id="l21.317">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.318"></a><span id="l21.318" class="difflineminus">-    return propertyBag-&gt;GetPropertyAsUint32(NS_LITERAL_STRING(&quot;type&quot;), txnType);</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineplus">+    return propertyBag-&gt;GetPropertyAsUint32(u&quot;type&quot;_ns, txnType);</span>
<a href="#l21.320"></a><span id="l21.320">   }</span>
<a href="#l21.321"></a><span id="l21.321">   return rv;</span>
<a href="#l21.322"></a><span id="l21.322"> }</span>
<a href="#l21.323"></a><span id="l21.323"> </span>
<a href="#l21.324"></a><span id="l21.324"> NS_IMETHODIMP nsMessenger::CanRedo(bool* bValue) {</span>
<a href="#l21.325"></a><span id="l21.325">   NS_ENSURE_TRUE(bValue &amp;&amp; mTxnMgr, NS_ERROR_NULL_POINTER);</span>
<a href="#l21.326"></a><span id="l21.326"> </span>
<a href="#l21.327"></a><span id="l21.327">   nsresult rv;</span>
<a href="#l21.328"></a><span id="l21.328" class="difflineat">@@ -1445,17 +1444,17 @@ nsMessenger::GetTransactionManager(nsITr</span>
<a href="#l21.329"></a><span id="l21.329">   NS_ADDREF(*aTxnMgr = mTxnMgr);</span>
<a href="#l21.330"></a><span id="l21.330">   return NS_OK;</span>
<a href="#l21.331"></a><span id="l21.331"> }</span>
<a href="#l21.332"></a><span id="l21.332"> </span>
<a href="#l21.333"></a><span id="l21.333"> NS_IMETHODIMP nsMessenger::SetDocumentCharset(const nsACString&amp; aCharacterSet) {</span>
<a href="#l21.334"></a><span id="l21.334">   // We want to redisplay the currently selected message (if any) but forcing</span>
<a href="#l21.335"></a><span id="l21.335">   // the redisplay to use characterSet</span>
<a href="#l21.336"></a><span id="l21.336">   if (!mLastDisplayURI.IsEmpty()) {</span>
<a href="#l21.337"></a><span id="l21.337" class="difflineminus">-    SetDisplayCharset(NS_LITERAL_CSTRING(&quot;UTF-8&quot;));</span>
<a href="#l21.338"></a><span id="l21.338" class="difflineplus">+    SetDisplayCharset(&quot;UTF-8&quot;_ns);</span>
<a href="#l21.339"></a><span id="l21.339"> </span>
<a href="#l21.340"></a><span id="l21.340">     nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l21.341"></a><span id="l21.341">     nsresult rv = GetMessageServiceFromURI(mLastDisplayURI,</span>
<a href="#l21.342"></a><span id="l21.342">                                            getter_AddRefs(messageService));</span>
<a href="#l21.343"></a><span id="l21.343"> </span>
<a href="#l21.344"></a><span id="l21.344">     if (NS_SUCCEEDED(rv) &amp;&amp; messageService) {</span>
<a href="#l21.345"></a><span id="l21.345">       nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l21.346"></a><span id="l21.346">       messageService-&gt;DisplayMessage(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerOSXIntegration.mm</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerOSXIntegration.mm</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -324,20 +324,19 @@ void nsMessengerOSXIntegration::FillTool</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> nsresult nsMessengerOSXIntegration::ShowAlertMessage(const nsAString&amp; aAlertTitle,</span>
<a href="#l22.6"></a><span id="l22.6">                                                      const nsAString&amp; aAlertText,</span>
<a href="#l22.7"></a><span id="l22.7">                                                      const nsACString&amp; aFolderURI) {</span>
<a href="#l22.8"></a><span id="l22.8">   nsCOMPtr&lt;nsIAlertsService&gt; alertsService = mozilla::components::Alerts::Service();</span>
<a href="#l22.9"></a><span id="l22.9">   nsresult rv = alertsService ? NS_OK : NS_ERROR_UNEXPECTED;</span>
<a href="#l22.10"></a><span id="l22.10">   // If we have an nsIAlertsService implementation, use it:</span>
<a href="#l22.11"></a><span id="l22.11">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    alertsService-&gt;ShowAlertNotification(EmptyString(), aAlertTitle, aAlertText, true,</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-                                         NS_ConvertASCIItoUTF16(aFolderURI), this, EmptyString(),</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-                                         NS_LITERAL_STRING(&quot;auto&quot;), EmptyString(), EmptyString(),</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-                                         nullptr, false, false);</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+    alertsService-&gt;ShowAlertNotification(</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+        EmptyString(), aAlertTitle, aAlertText, true, NS_ConvertASCIItoUTF16(aFolderURI), this,</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+        EmptyString(), u&quot;auto&quot;_ns, EmptyString(), EmptyString(), nullptr, false, false);</span>
<a href="#l22.19"></a><span id="l22.19">   }</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21">   BounceDockIcon();</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23">   if (NS_FAILED(rv)) OnAlertFinished();</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25">   return rv;</span>
<a href="#l22.26"></a><span id="l22.26"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerUnixIntegration.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerUnixIntegration.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -304,18 +304,17 @@ nsresult nsMessengerUnixIntegration::Sho</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5">   if (useSystemAlert) {</span>
<a href="#l23.6"></a><span id="l23.6">     nsCOMPtr&lt;nsIAlertsService&gt; alertsService(</span>
<a href="#l23.7"></a><span id="l23.7">         do_GetService(NS_SYSTEMALERTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.8"></a><span id="l23.8">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.9"></a><span id="l23.9">       rv = alertsService-&gt;ShowAlertNotification(</span>
<a href="#l23.10"></a><span id="l23.10">           NS_LITERAL_STRING(NEW_MAIL_ALERT_ICON), aAlertTitle, aAlertText,</span>
<a href="#l23.11"></a><span id="l23.11">           false, NS_ConvertASCIItoUTF16(aFolderURI), this, EmptyString(),</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-          NS_LITERAL_STRING(&quot;auto&quot;), EmptyString(), EmptyString(), nullptr,</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-          false, false);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+          u&quot;auto&quot;_ns, EmptyString(), EmptyString(), nullptr, false, false);</span>
<a href="#l23.15"></a><span id="l23.15">       if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l23.16"></a><span id="l23.16">     }</span>
<a href="#l23.17"></a><span id="l23.17">   }</span>
<a href="#l23.18"></a><span id="l23.18">   AlertFinished();</span>
<a href="#l23.19"></a><span id="l23.19">   rv = ShowNewAlertNotification(false);</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">   if (NS_FAILED(rv))  // go straight to showing the system tray icon.</span>
<a href="#l23.22"></a><span id="l23.22">     AlertFinished();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerWinIntegration.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerWinIntegration.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -405,19 +405,18 @@ nsresult nsMessengerWinIntegration::Show</span>
<a href="#l24.4"></a><span id="l24.4">   prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREF, &amp;showAlert);</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6">   if (showAlert) {</span>
<a href="#l24.7"></a><span id="l24.7">     nsCOMPtr&lt;nsIAlertsService&gt; alertsService =</span>
<a href="#l24.8"></a><span id="l24.8">         mozilla::components::Alerts::Service();</span>
<a href="#l24.9"></a><span id="l24.9">     if (alertsService) {</span>
<a href="#l24.10"></a><span id="l24.10">       rv = alertsService-&gt;ShowAlertNotification(</span>
<a href="#l24.11"></a><span id="l24.11">           NS_LITERAL_STRING(NEW_MAIL_ALERT_ICON), aAlertTitle, aAlertText, true,</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-          NS_ConvertASCIItoUTF16(aFolderURI), this, EmptyString(),</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-          NS_LITERAL_STRING(&quot;auto&quot;), EmptyString(), EmptyString(), nullptr,</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-          false, false);</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+          NS_ConvertASCIItoUTF16(aFolderURI), this, EmptyString(), u&quot;auto&quot;_ns,</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+          EmptyString(), EmptyString(), nullptr, false, false);</span>
<a href="#l24.17"></a><span id="l24.17">       mAlertInProgress = true;</span>
<a href="#l24.18"></a><span id="l24.18">     }</span>
<a href="#l24.19"></a><span id="l24.19">   }</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21">   if (!showAlert ||</span>
<a href="#l24.22"></a><span id="l24.22">       NS_FAILED(rv))  // go straight to showing the system tray icon.</span>
<a href="#l24.23"></a><span id="l24.23">     AlertFinished();</span>
<a href="#l24.24"></a><span id="l24.24"> </span>
<a href="#l24.25"></a><span id="l24.25" class="difflineat">@@ -596,17 +595,17 @@ static void EscapeAmpersands(nsString&amp; a</span>
<a href="#l24.26"></a><span id="l24.26">   if (pos == kNotFound) return;</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">   // Next, see if we only have bare ampersands.</span>
<a href="#l24.29"></a><span id="l24.29">   pos = aToolTip.Find(&quot;&amp;&amp;&quot;, false, pos);</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31">   // Windows tooltip code removes one ampersand from each run,</span>
<a href="#l24.32"></a><span id="l24.32">   // then collapses pairs of amperands. This means that in the easy case,</span>
<a href="#l24.33"></a><span id="l24.33">   // we need to replace each ampersand with three.</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  aToolTip.ReplaceSubstring(NS_LITERAL_STRING(&quot;&amp;&quot;), NS_LITERAL_STRING(&quot;&amp;&amp;&amp;&quot;));</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  aToolTip.ReplaceSubstring(u&quot;&amp;&quot;_ns, u&quot;&amp;&amp;&amp;&quot;_ns);</span>
<a href="#l24.36"></a><span id="l24.36">   if (pos == kNotFound) return;</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38">   // We inserted too many ampersands. Remove some.</span>
<a href="#l24.39"></a><span id="l24.39">   for (;;) {</span>
<a href="#l24.40"></a><span id="l24.40">     pos = aToolTip.Find(&quot;&amp;&amp;&amp;&amp;&amp;&amp;&quot;, false, pos);</span>
<a href="#l24.41"></a><span id="l24.41">     if (pos == kNotFound) return;</span>
<a href="#l24.42"></a><span id="l24.42"> </span>
<a href="#l24.43"></a><span id="l24.43">     aToolTip.Cut(pos, 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -216,17 +216,17 @@ NS_IMETHODIMP nsMsgAccountManager::Obser</span>
<a href="#l25.4"></a><span id="l25.4">     return NS_OK;</span>
<a href="#l25.5"></a><span id="l25.5">   }</span>
<a href="#l25.6"></a><span id="l25.6">   if (!strcmp(aTopic, &quot;quit-application-granted&quot;)) {</span>
<a href="#l25.7"></a><span id="l25.7">     // CleanupOnExit will set m_shutdownInProgress to true.</span>
<a href="#l25.8"></a><span id="l25.8">     CleanupOnExit();</span>
<a href="#l25.9"></a><span id="l25.9">     return NS_OK;</span>
<a href="#l25.10"></a><span id="l25.10">   }</span>
<a href="#l25.11"></a><span id="l25.11">   if (!strcmp(aTopic, ABOUT_TO_GO_OFFLINE_TOPIC)) {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-    nsAutoString dataString(NS_LITERAL_STRING(&quot;offline&quot;));</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+    nsAutoString dataString(u&quot;offline&quot;_ns);</span>
<a href="#l25.14"></a><span id="l25.14">     if (someData) {</span>
<a href="#l25.15"></a><span id="l25.15">       nsAutoString someDataString(someData);</span>
<a href="#l25.16"></a><span id="l25.16">       if (dataString.Equals(someDataString)) CloseCachedConnections();</span>
<a href="#l25.17"></a><span id="l25.17">     }</span>
<a href="#l25.18"></a><span id="l25.18">     return NS_OK;</span>
<a href="#l25.19"></a><span id="l25.19">   }</span>
<a href="#l25.20"></a><span id="l25.20">   if (!strcmp(aTopic, &quot;sleep_notification&quot;)) return CloseCachedConnections();</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -1971,28 +1971,23 @@ NS_IMETHODIMP nsMsgAccountManager::GetLo</span>
<a href="#l25.23"></a><span id="l25.23">   if (NS_SUCCEEDED(rv) &amp;&amp; !serverKey.IsEmpty()) {</span>
<a href="#l25.24"></a><span id="l25.24">     rv = GetIncomingServer(serverKey, aServer);</span>
<a href="#l25.25"></a><span id="l25.25">     if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l25.26"></a><span id="l25.26">     // otherwise, we're going to fall through to looking for an existing local</span>
<a href="#l25.27"></a><span id="l25.27">     // folders account, because now we fail creating one if one already exists.</span>
<a href="#l25.28"></a><span id="l25.28">   }</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30">   // try (&quot;nobody&quot;,&quot;Local Folders&quot;,&quot;none&quot;), and work down to any &quot;none&quot; server.</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  rv = FindServer(NS_LITERAL_CSTRING(&quot;nobody&quot;),</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-                  NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-                  NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+  rv = FindServer(&quot;nobody&quot;_ns, &quot;Local Folders&quot;_ns, &quot;none&quot;_ns, aServer);</span>
<a href="#l25.35"></a><span id="l25.35">   if (NS_FAILED(rv) || !*aServer) {</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-    rv = FindServer(NS_LITERAL_CSTRING(&quot;nobody&quot;), EmptyCString(),</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+    rv = FindServer(&quot;nobody&quot;_ns, EmptyCString(), &quot;none&quot;_ns, aServer);</span>
<a href="#l25.39"></a><span id="l25.39">     if (NS_FAILED(rv) || !*aServer) {</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-      rv = FindServer(EmptyCString(), NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-                      NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+      rv = FindServer(EmptyCString(), &quot;Local Folders&quot;_ns, &quot;none&quot;_ns, aServer);</span>
<a href="#l25.43"></a><span id="l25.43">       if (NS_FAILED(rv) || !*aServer)</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-        rv = FindServer(EmptyCString(), EmptyCString(),</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+        rv = FindServer(EmptyCString(), EmptyCString(), &quot;none&quot;_ns, aServer);</span>
<a href="#l25.47"></a><span id="l25.47">     }</span>
<a href="#l25.48"></a><span id="l25.48">   }</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.51"></a><span id="l25.51">   if (!*aServer) return NS_ERROR_FAILURE;</span>
<a href="#l25.52"></a><span id="l25.52"> </span>
<a href="#l25.53"></a><span id="l25.53">   // we don't want the Smart Mailboxes server to be the local server.</span>
<a href="#l25.54"></a><span id="l25.54">   bool hidden;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineat">@@ -2019,19 +2014,18 @@ nsresult nsMsgAccountManager::GetLocalFo</span>
<a href="#l25.56"></a><span id="l25.56"> </span>
<a href="#l25.57"></a><span id="l25.57">   return bundle-&gt;GetStringFromName(&quot;localFolders&quot;, localFoldersName);</span>
<a href="#l25.58"></a><span id="l25.58"> }</span>
<a href="#l25.59"></a><span id="l25.59"> </span>
<a href="#l25.60"></a><span id="l25.60"> NS_IMETHODIMP</span>
<a href="#l25.61"></a><span id="l25.61"> nsMsgAccountManager::CreateLocalMailAccount() {</span>
<a href="#l25.62"></a><span id="l25.62">   // create the server</span>
<a href="#l25.63"></a><span id="l25.63">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-  nsresult rv = CreateIncomingServer(</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-      NS_LITERAL_CSTRING(&quot;nobody&quot;), NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-      NS_LITERAL_CSTRING(&quot;none&quot;), getter_AddRefs(server));</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+  nsresult rv = CreateIncomingServer(&quot;nobody&quot;_ns, &quot;Local Folders&quot;_ns, &quot;none&quot;_ns,</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+                                     getter_AddRefs(server));</span>
<a href="#l25.69"></a><span id="l25.69">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71">   nsString localFoldersName;</span>
<a href="#l25.72"></a><span id="l25.72">   rv = GetLocalFoldersPrettyName(localFoldersName);</span>
<a href="#l25.73"></a><span id="l25.73">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.74"></a><span id="l25.74">   server-&gt;SetPrettyName(localFoldersName);</span>
<a href="#l25.75"></a><span id="l25.75"> </span>
<a href="#l25.76"></a><span id="l25.76">   nsCOMPtr&lt;nsINoIncomingServer&gt; noServer;</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineat">@@ -2239,18 +2233,17 @@ nsresult VirtualFolderChangeListener::In</span>
<a href="#l25.78"></a><span id="l25.78">     dbFolderInfo-&gt;GetCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l25.79"></a><span id="l25.79">     nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l25.80"></a><span id="l25.80">         do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l25.81"></a><span id="l25.81">     nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l25.82"></a><span id="l25.82">     rv = filterService-&gt;GetTempFilterList(m_virtualFolder,</span>
<a href="#l25.83"></a><span id="l25.83">                                           getter_AddRefs(filterList));</span>
<a href="#l25.84"></a><span id="l25.84">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.85"></a><span id="l25.85">     nsCOMPtr&lt;nsIMsgFilter&gt; tempFilter;</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-    filterList-&gt;CreateFilter(NS_LITERAL_STRING(&quot;temp&quot;),</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-                             getter_AddRefs(tempFilter));</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+    filterList-&gt;CreateFilter(u&quot;temp&quot;_ns, getter_AddRefs(tempFilter));</span>
<a href="#l25.89"></a><span id="l25.89">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.90"></a><span id="l25.90">     filterList-&gt;ParseCondition(tempFilter, searchTermString.get());</span>
<a href="#l25.91"></a><span id="l25.91">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.92"></a><span id="l25.92">     m_searchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l25.93"></a><span id="l25.93">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.94"></a><span id="l25.94"> </span>
<a href="#l25.95"></a><span id="l25.95">     nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l25.96"></a><span id="l25.96">     rv = tempFilter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineat">@@ -2619,17 +2612,17 @@ NS_IMETHODIMP nsMsgAccountManager::LoadV</span>
<a href="#l25.98"></a><span id="l25.98">     while (isMore &amp;&amp; NS_SUCCEEDED(lineInputStream-&gt;ReadLine(buffer, &amp;isMore))) {</span>
<a href="#l25.99"></a><span id="l25.99">       if (!buffer.IsEmpty()) {</span>
<a href="#l25.100"></a><span id="l25.100">         if (version == -1) {</span>
<a href="#l25.101"></a><span id="l25.101">           buffer.Cut(0, 8);</span>
<a href="#l25.102"></a><span id="l25.102">           nsresult irv;</span>
<a href="#l25.103"></a><span id="l25.103">           version = buffer.ToInteger(&amp;irv);</span>
<a href="#l25.104"></a><span id="l25.104">           continue;</span>
<a href="#l25.105"></a><span id="l25.105">         }</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-        if (StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;uri=&quot;))) {</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+        if (StringBeginsWith(buffer, &quot;uri=&quot;_ns)) {</span>
<a href="#l25.108"></a><span id="l25.108">           buffer.Cut(0, 4);</span>
<a href="#l25.109"></a><span id="l25.109">           dbFolderInfo = nullptr;</span>
<a href="#l25.110"></a><span id="l25.110"> </span>
<a href="#l25.111"></a><span id="l25.111">           rv = GetOrCreateFolder(buffer, getter_AddRefs(virtualFolder));</span>
<a href="#l25.112"></a><span id="l25.112">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.113"></a><span id="l25.113"> </span>
<a href="#l25.114"></a><span id="l25.114">           nsCOMPtr&lt;nsIMsgFolder&gt; grandParent;</span>
<a href="#l25.115"></a><span id="l25.115">           nsCOMPtr&lt;nsIMsgFolder&gt; oldParent;</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineat">@@ -2676,33 +2669,30 @@ NS_IMETHODIMP nsMsgAccountManager::LoadV</span>
<a href="#l25.117"></a><span id="l25.117">             // here we make sure if our parent is rooted - if not, we're</span>
<a href="#l25.118"></a><span id="l25.118">             // going to loop and add our parent as a child of its grandparent</span>
<a href="#l25.119"></a><span id="l25.119">             // and repeat until we get to the server, or a folder that</span>
<a href="#l25.120"></a><span id="l25.120">             // has its parent set.</span>
<a href="#l25.121"></a><span id="l25.121">             parentFolder-&gt;GetParent(getter_AddRefs(grandParent));</span>
<a href="#l25.122"></a><span id="l25.122">             parentFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l25.123"></a><span id="l25.123">             buffer.SetLength(lastSlash);</span>
<a href="#l25.124"></a><span id="l25.124">           } while (!grandParent &amp;&amp; !isServer);</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-        } else if (dbFolderInfo &amp;&amp;</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-                   StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;scope=&quot;))) {</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+        } else if (dbFolderInfo &amp;&amp; StringBeginsWith(buffer, &quot;scope=&quot;_ns)) {</span>
<a href="#l25.128"></a><span id="l25.128">           buffer.Cut(0, 6);</span>
<a href="#l25.129"></a><span id="l25.129">           // if this is a cross folder virtual folder, we have a list of folders</span>
<a href="#l25.130"></a><span id="l25.130">           // uris, and we have to add a pending listener for each of them.</span>
<a href="#l25.131"></a><span id="l25.131">           if (!buffer.IsEmpty()) {</span>
<a href="#l25.132"></a><span id="l25.132">             ParseAndVerifyVirtualFolderScope(buffer);</span>
<a href="#l25.133"></a><span id="l25.133">             dbFolderInfo-&gt;SetCharProperty(kSearchFolderUriProp, buffer);</span>
<a href="#l25.134"></a><span id="l25.134">             AddVFListenersForVF(virtualFolder, buffer, msgDBService);</span>
<a href="#l25.135"></a><span id="l25.135">           }</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-        } else if (dbFolderInfo &amp;&amp;</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-                   StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;terms=&quot;))) {</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineplus">+        } else if (dbFolderInfo &amp;&amp; StringBeginsWith(buffer, &quot;terms=&quot;_ns)) {</span>
<a href="#l25.139"></a><span id="l25.139">           buffer.Cut(0, 6);</span>
<a href="#l25.140"></a><span id="l25.140">           dbFolderInfo-&gt;SetCharProperty(&quot;searchStr&quot;, buffer);</span>
<a href="#l25.141"></a><span id="l25.141">         } else if (dbFolderInfo &amp;&amp;</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-                   StringBeginsWith(buffer,</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineminus">-                                    NS_LITERAL_CSTRING(&quot;searchOnline=&quot;))) {</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+                   StringBeginsWith(buffer, &quot;searchOnline=&quot;_ns)) {</span>
<a href="#l25.145"></a><span id="l25.145">           buffer.Cut(0, 13);</span>
<a href="#l25.146"></a><span id="l25.146">           dbFolderInfo-&gt;SetBooleanProperty(&quot;searchOnline&quot;,</span>
<a href="#l25.147"></a><span id="l25.147">                                            buffer.EqualsLiteral(&quot;true&quot;));</span>
<a href="#l25.148"></a><span id="l25.148">         } else if (dbFolderInfo &amp;&amp;</span>
<a href="#l25.149"></a><span id="l25.149">                    Substring(buffer, 0, SEARCH_FOLDER_FLAG_LEN + 1)</span>
<a href="#l25.150"></a><span id="l25.150">                        .Equals(SEARCH_FOLDER_FLAG &quot;=&quot;)) {</span>
<a href="#l25.151"></a><span id="l25.151">           buffer.Cut(0, SEARCH_FOLDER_FLAG_LEN + 1);</span>
<a href="#l25.152"></a><span id="l25.152">           dbFolderInfo-&gt;SetCharProperty(SEARCH_FOLDER_FLAG, buffer);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -109,18 +109,18 @@ bool nsMsgContentPolicy::ShouldAcceptRem</span>
<a href="#l26.4"></a><span id="l26.4">   rv = ios-&gt;NewURI(emailAddress, nullptr, nullptr, getter_AddRefs(mailURI));</span>
<a href="#l26.5"></a><span id="l26.5">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">   // check with permission manager</span>
<a href="#l26.8"></a><span id="l26.8">   uint32_t permission = 0;</span>
<a href="#l26.9"></a><span id="l26.9">   mozilla::OriginAttributes attrs;</span>
<a href="#l26.10"></a><span id="l26.10">   RefPtr&lt;mozilla::BasePrincipal&gt; principal =</span>
<a href="#l26.11"></a><span id="l26.11">       mozilla::BasePrincipal::CreateContentPrincipal(mailURI, attrs);</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  rv = mPermissionManager-&gt;TestPermissionFromPrincipal(</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-      principal, NS_LITERAL_CSTRING(&quot;image&quot;), &amp;permission);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+  rv = mPermissionManager-&gt;TestPermissionFromPrincipal(principal, &quot;image&quot;_ns,</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+                                                       &amp;permission);</span>
<a href="#l26.16"></a><span id="l26.16">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l26.17"></a><span id="l26.17"> </span>
<a href="#l26.18"></a><span id="l26.18">   // Only return true if the permission manager has an explicit allow</span>
<a href="#l26.19"></a><span id="l26.19">   return (permission == nsIPermissionManager::ALLOW_ACTION);</span>
<a href="#l26.20"></a><span id="l26.20"> }</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22"> /**</span>
<a href="#l26.23"></a><span id="l26.23">  * Extract the host name from aContentLocation, and look it up in our list</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineat">@@ -360,18 +360,18 @@ nsMsgContentPolicy::ShouldLoad(nsIURI* a</span>
<a href="#l26.25"></a><span id="l26.25">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l26.26"></a><span id="l26.26">     return NS_OK;</span>
<a href="#l26.27"></a><span id="l26.27">   }</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29">   uint32_t permission;</span>
<a href="#l26.30"></a><span id="l26.30">   mozilla::OriginAttributes attrs;</span>
<a href="#l26.31"></a><span id="l26.31">   RefPtr&lt;mozilla::BasePrincipal&gt; principal =</span>
<a href="#l26.32"></a><span id="l26.32">       mozilla::BasePrincipal::CreateContentPrincipal(aContentLocation, attrs);</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-  mPermissionManager-&gt;TestPermissionFromPrincipal(</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-      principal, NS_LITERAL_CSTRING(&quot;image&quot;), &amp;permission);</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+  mPermissionManager-&gt;TestPermissionFromPrincipal(principal, &quot;image&quot;_ns,</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+                                                  &amp;permission);</span>
<a href="#l26.37"></a><span id="l26.37">   switch (permission) {</span>
<a href="#l26.38"></a><span id="l26.38">     case nsIPermissionManager::UNKNOWN_ACTION: {</span>
<a href="#l26.39"></a><span id="l26.39">       // No exception was found for this location.</span>
<a href="#l26.40"></a><span id="l26.40">       break;</span>
<a href="#l26.41"></a><span id="l26.41">     }</span>
<a href="#l26.42"></a><span id="l26.42">     case nsIPermissionManager::ALLOW_ACTION: {</span>
<a href="#l26.43"></a><span id="l26.43">       *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l26.44"></a><span id="l26.44">       return NS_OK;</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineat">@@ -740,18 +740,18 @@ void nsMsgContentPolicy::ComposeShouldLo</span>
<a href="#l26.46"></a><span id="l26.46">         }</span>
<a href="#l26.47"></a><span id="l26.47"> </span>
<a href="#l26.48"></a><span id="l26.48">         // Test whitelist.</span>
<a href="#l26.49"></a><span id="l26.49">         uint32_t permission;</span>
<a href="#l26.50"></a><span id="l26.50">         mozilla::OriginAttributes attrs;</span>
<a href="#l26.51"></a><span id="l26.51">         RefPtr&lt;mozilla::BasePrincipal&gt; principal =</span>
<a href="#l26.52"></a><span id="l26.52">             mozilla::BasePrincipal::CreateContentPrincipal(aContentLocation,</span>
<a href="#l26.53"></a><span id="l26.53">                                                            attrs);</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-        mPermissionManager-&gt;TestPermissionFromPrincipal(</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-            principal, NS_LITERAL_CSTRING(&quot;image&quot;), &amp;permission);</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+        mPermissionManager-&gt;TestPermissionFromPrincipal(principal, &quot;image&quot;_ns,</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+                                                        &amp;permission);</span>
<a href="#l26.58"></a><span id="l26.58">         if (permission == nsIPermissionManager::ALLOW_ACTION)</span>
<a href="#l26.59"></a><span id="l26.59">           *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l26.60"></a><span id="l26.60">       }</span>
<a href="#l26.61"></a><span id="l26.61">     }</span>
<a href="#l26.62"></a><span id="l26.62">   }</span>
<a href="#l26.63"></a><span id="l26.63"> }</span>
<a href="#l26.64"></a><span id="l26.64"> </span>
<a href="#l26.65"></a><span id="l26.65"> already_AddRefed&lt;nsIMsgCompose&gt; nsMsgContentPolicy::GetMsgComposeForContext(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -2935,20 +2935,18 @@ nsresult nsMsgDBView::ApplyCommandToIndi</span>
<a href="#l27.4"></a><span id="l27.4">     // Provide junk-related batch notifications.</span>
<a href="#l27.5"></a><span id="l27.5">     if (command == nsMsgViewCommandType::junk ||</span>
<a href="#l27.6"></a><span id="l27.6">         command == nsMsgViewCommandType::unjunk) {</span>
<a href="#l27.7"></a><span id="l27.7">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l27.8"></a><span id="l27.8">           do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10">       if (notifier)</span>
<a href="#l27.11"></a><span id="l27.11">         notifier-&gt;NotifyItemEvent(</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-            messageArray, NS_LITERAL_CSTRING(&quot;JunkStatusChanged&quot;), nullptr,</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-            (command == nsMsgViewCommandType::junk)</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-                ? NS_LITERAL_CSTRING(&quot;junk&quot;)</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-                : NS_LITERAL_CSTRING(&quot;notjunk&quot;));</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+            messageArray, &quot;JunkStatusChanged&quot;_ns, nullptr,</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+            (command == nsMsgViewCommandType::junk) ? &quot;junk&quot;_ns : &quot;notjunk&quot;_ns);</span>
<a href="#l27.18"></a><span id="l27.18">     }</span>
<a href="#l27.19"></a><span id="l27.19">   }</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21">   folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l27.22"></a><span id="l27.22"> </span>
<a href="#l27.23"></a><span id="l27.23">   if (thisIsImapFolder) {</span>
<a href="#l27.24"></a><span id="l27.24">     imapMessageFlagsType flags = kNoImapMsgFlag;</span>
<a href="#l27.25"></a><span id="l27.25">     bool addFlags = false;</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineat">@@ -2958,32 +2956,30 @@ nsresult nsMsgDBView::ApplyCommandToIndi</span>
<a href="#l27.27"></a><span id="l27.27">         flags |= kImapMsgSeenFlag;</span>
<a href="#l27.28"></a><span id="l27.28">         addFlags = true;</span>
<a href="#l27.29"></a><span id="l27.29">         break;</span>
<a href="#l27.30"></a><span id="l27.30">       case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l27.31"></a><span id="l27.31">         flags = kImapMsgDeletedFlag;</span>
<a href="#l27.32"></a><span id="l27.32">         addFlags = false;</span>
<a href="#l27.33"></a><span id="l27.33">         break;</span>
<a href="#l27.34"></a><span id="l27.34">       case nsMsgViewCommandType::junk:</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-        return imapFolder-&gt;StoreCustomKeywords(</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-            msgWindow, NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;NonJunk&quot;), imapUids, nullptr);</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+        return imapFolder-&gt;StoreCustomKeywords(msgWindow, &quot;Junk&quot;_ns,</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+                                               &quot;NonJunk&quot;_ns, imapUids, nullptr);</span>
<a href="#l27.40"></a><span id="l27.40">       case nsMsgViewCommandType::unjunk: {</span>
<a href="#l27.41"></a><span id="l27.41">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l27.42"></a><span id="l27.42">         GetHdrForFirstSelectedMessage(getter_AddRefs(msgHdr));</span>
<a href="#l27.43"></a><span id="l27.43">         uint32_t msgFlags = 0;</span>
<a href="#l27.44"></a><span id="l27.44">         if (msgHdr) msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l27.45"></a><span id="l27.45"> </span>
<a href="#l27.46"></a><span id="l27.46">         if (msgFlags &amp; nsMsgMessageFlags::IMAPDeleted)</span>
<a href="#l27.47"></a><span id="l27.47">           imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false, imapUids,</span>
<a href="#l27.48"></a><span id="l27.48">                                      nullptr);</span>
<a href="#l27.49"></a><span id="l27.49"> </span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-        return imapFolder-&gt;StoreCustomKeywords(</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-            msgWindow, NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;Junk&quot;), imapUids, nullptr);</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+        return imapFolder-&gt;StoreCustomKeywords(msgWindow, &quot;NonJunk&quot;_ns,</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+                                               &quot;Junk&quot;_ns, imapUids, nullptr);</span>
<a href="#l27.55"></a><span id="l27.55">       }</span>
<a href="#l27.56"></a><span id="l27.56">       default:</span>
<a href="#l27.57"></a><span id="l27.57">         break;</span>
<a href="#l27.58"></a><span id="l27.58">     }</span>
<a href="#l27.59"></a><span id="l27.59"> </span>
<a href="#l27.60"></a><span id="l27.60">     // Can't get here without thisIsImapThreadPane == TRUE.</span>
<a href="#l27.61"></a><span id="l27.61">     if (flags != kNoImapMsgFlag) {</span>
<a href="#l27.62"></a><span id="l27.62">       imapFolder-&gt;StoreImapFlags(flags, addFlags, imapUids, nullptr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -323,17 +323,17 @@ nsresult nsFolderCompactState::Init(nsIM</span>
<a href="#l28.4"></a><span id="l28.4">   nsresult rv;</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6">   m_folder = folder;</span>
<a href="#l28.7"></a><span id="l28.7">   m_baseMessageUri = baseMsgUri;</span>
<a href="#l28.8"></a><span id="l28.8">   m_file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l28.9"></a><span id="l28.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.10"></a><span id="l28.10">   m_file-&gt;InitWithFile(path);</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  m_file-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;nstmp&quot;));</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  m_file-&gt;SetNativeLeafName(&quot;nstmp&quot;_ns);</span>
<a href="#l28.14"></a><span id="l28.14">   // Make sure we are not crunching existing nstmp file.</span>
<a href="#l28.15"></a><span id="l28.15">   rv = m_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l28.16"></a><span id="l28.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18">   m_window = aMsgWindow;</span>
<a href="#l28.19"></a><span id="l28.19">   m_keyArray = new nsMsgKeyArray;</span>
<a href="#l28.20"></a><span id="l28.20">   m_size = 0;</span>
<a href="#l28.21"></a><span id="l28.21">   m_totalMsgSize = 0;</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -401,18 +401,17 @@ nsresult nsFolderCompactState::StartComp</span>
<a href="#l28.23"></a><span id="l28.23">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25">   // Notify that compaction is beginning.  We do this even if there are no</span>
<a href="#l28.26"></a><span id="l28.26">   // messages to be copied because the summary database still gets blown away</span>
<a href="#l28.27"></a><span id="l28.27">   // which is still pretty interesting.  (And we like consistency.)</span>
<a href="#l28.28"></a><span id="l28.28">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l28.29"></a><span id="l28.29">       do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l28.30"></a><span id="l28.30">   if (notifier)</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-    notifier-&gt;NotifyItemEvent(m_folder,</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-                              NS_LITERAL_CSTRING(&quot;FolderCompactStart&quot;), nullptr,</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+    notifier-&gt;NotifyItemEvent(m_folder, &quot;FolderCompactStart&quot;_ns, nullptr,</span>
<a href="#l28.34"></a><span id="l28.34">                               EmptyCString());</span>
<a href="#l28.35"></a><span id="l28.35"> </span>
<a href="#l28.36"></a><span id="l28.36">   // TODO: test whether sorting the messages (m_keyArray) by messageOffset</span>
<a href="#l28.37"></a><span id="l28.37">   // would improve performance on large files (less seeks).</span>
<a href="#l28.38"></a><span id="l28.38">   // The m_keyArray is in the order as stored in DB and on IMAP or News</span>
<a href="#l28.39"></a><span id="l28.39">   // the messages stored on the mbox file are not necessarily in the same order.</span>
<a href="#l28.40"></a><span id="l28.40">   if (m_size &gt; 0) {</span>
<a href="#l28.41"></a><span id="l28.41">     nsCOMPtr&lt;nsIURI&gt; notUsed;</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineat">@@ -577,19 +576,18 @@ nsresult nsFolderCompactState::FinishCom</span>
<a href="#l28.43"></a><span id="l28.43">   }</span>
<a href="#l28.44"></a><span id="l28.44">   if (m_db) m_db-&gt;Close(true);</span>
<a href="#l28.45"></a><span id="l28.45">   m_db = nullptr;</span>
<a href="#l28.46"></a><span id="l28.46"> </span>
<a href="#l28.47"></a><span id="l28.47">   // Notify that compaction of the folder is completed.</span>
<a href="#l28.48"></a><span id="l28.48">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l28.49"></a><span id="l28.49">       do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l28.50"></a><span id="l28.50">   if (notifier)</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-    notifier-&gt;NotifyItemEvent(m_folder,</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-                              NS_LITERAL_CSTRING(&quot;FolderCompactFinish&quot;),</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-                              nullptr, EmptyCString());</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+    notifier-&gt;NotifyItemEvent(m_folder, &quot;FolderCompactFinish&quot;_ns, nullptr,</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+                              EmptyCString());</span>
<a href="#l28.56"></a><span id="l28.56">   m_folder-&gt;NotifyCompactCompleted();</span>
<a href="#l28.57"></a><span id="l28.57"> </span>
<a href="#l28.58"></a><span id="l28.58">   if (m_compactAll)</span>
<a href="#l28.59"></a><span id="l28.59">     rv = CompactNextFolder();</span>
<a href="#l28.60"></a><span id="l28.60">   else</span>
<a href="#l28.61"></a><span id="l28.61">     CompactCompleted(rv);</span>
<a href="#l28.62"></a><span id="l28.62"> </span>
<a href="#l28.63"></a><span id="l28.63">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -257,17 +257,17 @@ nsresult nsMsgMailSession::GetTopmostMsg</span>
<a href="#l29.4"></a><span id="l29.4">       NS_ENSURE_TRUE(topMostWindow, NS_ERROR_FAILURE);</span>
<a href="#l29.5"></a><span id="l29.5"> </span>
<a href="#l29.6"></a><span id="l29.6">       mozilla::dom::Document* domDocument = topMostWindow-&gt;GetDoc();</span>
<a href="#l29.7"></a><span id="l29.7">       NS_ENSURE_TRUE(domDocument, NS_ERROR_FAILURE);</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9">       mozilla::dom::Element* domElement = domDocument-&gt;GetDocumentElement();</span>
<a href="#l29.10"></a><span id="l29.10">       NS_ENSURE_TRUE(domElement, NS_ERROR_FAILURE);</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-      domElement-&gt;GetAttribute(NS_LITERAL_STRING(&quot;windowtype&quot;), windowType);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+      domElement-&gt;GetAttribute(u&quot;windowtype&quot;_ns, windowType);</span>
<a href="#l29.14"></a><span id="l29.14">       if (windowType.EqualsLiteral(&quot;mail:3pane&quot;) ||</span>
<a href="#l29.15"></a><span id="l29.15">           windowType.EqualsLiteral(&quot;mail:messageWindow&quot;))</span>
<a href="#l29.16"></a><span id="l29.16">         break;</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18">       windowEnum-&gt;HasMoreElements(&amp;more);</span>
<a href="#l29.19"></a><span id="l29.19">     }</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21">     // identified the top most window</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPrintEngine.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPrintEngine.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -215,17 +215,17 @@ nsMsgPrintEngine::SetWindow(mozIDOMWindo</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5">   NS_ENSURE_TRUE(mWindow, NS_ERROR_FAILURE);</span>
<a href="#l30.6"></a><span id="l30.6">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(mWindow);</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8">   window-&gt;GetDocShell()-&gt;SetAppType(nsIDocShell::APP_TYPE_MAIL);</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10">   nsIDocShell* rootShell = window-&gt;GetDocShell();</span>
<a href="#l30.11"></a><span id="l30.11">   RefPtr&lt;mozilla::dom::Element&gt; el =</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-      rootShell-&gt;GetDocument()-&gt;GetElementById(NS_LITERAL_STRING(&quot;content&quot;));</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+      rootShell-&gt;GetDocument()-&gt;GetElementById(u&quot;content&quot;_ns);</span>
<a href="#l30.14"></a><span id="l30.14">   RefPtr&lt;mozilla::dom::XULFrameElement&gt; frame =</span>
<a href="#l30.15"></a><span id="l30.15">       mozilla::dom::XULFrameElement::FromNodeOrNull(el);</span>
<a href="#l30.16"></a><span id="l30.16">   NS_ENSURE_TRUE(frame, NS_ERROR_FAILURE);</span>
<a href="#l30.17"></a><span id="l30.17">   RefPtr&lt;mozilla::dom::Document&gt; doc = frame-&gt;GetContentDocument();</span>
<a href="#l30.18"></a><span id="l30.18">   NS_ENSURE_TRUE(doc, NS_ERROR_FAILURE);</span>
<a href="#l30.19"></a><span id="l30.19">   mDocShell = doc-&gt;GetDocShell();</span>
<a href="#l30.20"></a><span id="l30.20">   NS_ENSURE_TRUE(mDocShell, NS_ERROR_FAILURE);</span>
<a href="#l30.21"></a><span id="l30.21">   SetupObserver();</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -433,18 +433,17 @@ nsresult nsMsgPrintEngine::FireThatLoadO</span>
<a href="#l30.23"></a><span id="l30.23">   // if this is a message part (or .eml file on disk)</span>
<a href="#l30.24"></a><span id="l30.24">   // skip it, because we don't want to print the parent message</span>
<a href="#l30.25"></a><span id="l30.25">   // we want to print the part.</span>
<a href="#l30.26"></a><span id="l30.26">   // example:</span>
<a href="#l30.27"></a><span id="l30.27">   // imap://sspitzer@nsmail-1:143/fetch%3EUID%3E/INBOX%3E180958?part=1.1.2&amp;type=application/x-message-display&amp;filename=test&quot;</span>
<a href="#l30.28"></a><span id="l30.28">   if (!StringBeginsWith(uriCStr, NS_LITERAL_CSTRING(DATA_URL_PREFIX)) &amp;&amp;</span>
<a href="#l30.29"></a><span id="l30.29">       !StringBeginsWith(uriCStr, NS_LITERAL_CSTRING(ADDBOOK_URL_PREFIX)) &amp;&amp;</span>
<a href="#l30.30"></a><span id="l30.30">       !uriCStr.EqualsLiteral(&quot;about:blank&quot;) &amp;&amp;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-      uriCStr.Find(NS_LITERAL_CSTRING(&quot;type=application/x-message-display&quot;)) ==</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-          -1) {</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+      uriCStr.Find(&quot;type=application/x-message-display&quot;_ns) == -1) {</span>
<a href="#l30.34"></a><span id="l30.34">     rv = GetMessageServiceFromURI(uriCStr, getter_AddRefs(messageService));</span>
<a href="#l30.35"></a><span id="l30.35">   }</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37">   if (NS_SUCCEEDED(rv) &amp;&amp; messageService) {</span>
<a href="#l30.38"></a><span id="l30.38">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l30.39"></a><span id="l30.39">     rv = messageService-&gt;DisplayMessageForPrinting(</span>
<a href="#l30.40"></a><span id="l30.40">         uriCStr.get(), mDocShell, nullptr, nullptr, getter_AddRefs(dummyNull));</span>
<a href="#l30.41"></a><span id="l30.41">   }</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineat">@@ -530,17 +529,17 @@ void nsMsgPrintEngine::PrintMsgWindow() </span>
<a href="#l30.43"></a><span id="l30.43">         webBrowserPrint-&gt;GetGlobalPrintSettings(getter_AddRefs(mPrintSettings));</span>
<a href="#l30.44"></a><span id="l30.44">       }</span>
<a href="#l30.45"></a><span id="l30.45"> </span>
<a href="#l30.46"></a><span id="l30.46">       // fix for bug #118887 and bug #176016</span>
<a href="#l30.47"></a><span id="l30.47">       // don't show the actual url when printing mail messages or addressbook</span>
<a href="#l30.48"></a><span id="l30.48">       // cards. for mail, it can review the salt.  for addrbook, it's a data://</span>
<a href="#l30.49"></a><span id="l30.49">       // url, which means nothing to the end user. needs to be &quot; &quot; and not &quot;&quot; or</span>
<a href="#l30.50"></a><span id="l30.50">       // nullptr, otherwise, we'll still print the url</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-      mPrintSettings-&gt;SetDocURL(NS_LITERAL_STRING(&quot; &quot;));</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+      mPrintSettings-&gt;SetDocURL(u&quot; &quot;_ns);</span>
<a href="#l30.53"></a><span id="l30.53"> </span>
<a href="#l30.54"></a><span id="l30.54">       nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l30.55"></a><span id="l30.55">       if (mIsDoingPrintPreview) {</span>
<a href="#l30.56"></a><span id="l30.56">         if (mStartupPPObs) {</span>
<a href="#l30.57"></a><span id="l30.57">           rv = mStartupPPObs-&gt;Observe(nullptr, nullptr, nullptr);</span>
<a href="#l30.58"></a><span id="l30.58">         }</span>
<a href="#l30.59"></a><span id="l30.59">       } else {</span>
<a href="#l30.60"></a><span id="l30.60">         mPrintSettings-&gt;SetPrintSilent(mCurrentlyPrintingURI != 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/src/nsMsgProgress.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgProgress.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -60,22 +60,21 @@ NS_IMETHODIMP nsMsgProgress::OpenProgres</span>
<a href="#l31.4"></a><span id="l31.4">   ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIMsgProgress));</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6">   array-&gt;AppendElement(ifptr);</span>
<a href="#l31.7"></a><span id="l31.7">   array-&gt;AppendElement(parameters);</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9">   // Open the dialog.</span>
<a href="#l31.10"></a><span id="l31.10">   RefPtr&lt;mozilla::dom::BrowsingContext&gt; newWindow;</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  nsString chromeOptions(NS_LITERAL_STRING(&quot;chrome,dependent,centerscreen&quot;));</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  nsString chromeOptions(u&quot;chrome,dependent,centerscreen&quot;_ns);</span>
<a href="#l31.14"></a><span id="l31.14">   if (inDisplayModal) chromeOptions.AppendLiteral(&quot;,modal&quot;);</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-  return parent-&gt;OpenDialog(NS_ConvertASCIItoUTF16(dialogURL),</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-                            NS_LITERAL_STRING(&quot;_blank&quot;), chromeOptions, array,</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-                            getter_AddRefs(newWindow));</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+  return parent-&gt;OpenDialog(NS_ConvertASCIItoUTF16(dialogURL), u&quot;_blank&quot;_ns,</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+                            chromeOptions, array, getter_AddRefs(newWindow));</span>
<a href="#l31.21"></a><span id="l31.21"> }</span>
<a href="#l31.22"></a><span id="l31.22"> </span>
<a href="#l31.23"></a><span id="l31.23"> NS_IMETHODIMP nsMsgProgress::CloseProgressDialog(bool forceClose) {</span>
<a href="#l31.24"></a><span id="l31.24">   m_closeProgress = true;</span>
<a href="#l31.25"></a><span id="l31.25">   return OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP,</span>
<a href="#l31.26"></a><span id="l31.26">                        forceClose ? NS_ERROR_FAILURE : NS_OK);</span>
<a href="#l31.27"></a><span id="l31.27"> }</span>
<a href="#l31.28"></a><span id="l31.28"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/src/nsMsgWindow.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgWindow.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -69,18 +69,17 @@ NS_IMETHODIMP nsMsgWindow::GetMessageWin</span>
<a href="#l32.4"></a><span id="l32.4">       // but really, we shouldn't even get here in such cases.</span>
<a href="#l32.5"></a><span id="l32.5">       bool doomed;</span>
<a href="#l32.6"></a><span id="l32.6">       rootShell-&gt;IsBeingDestroyed(&amp;doomed);</span>
<a href="#l32.7"></a><span id="l32.7">       if (doomed) {</span>
<a href="#l32.8"></a><span id="l32.8">         return NS_ERROR_ILLEGAL_DURING_SHUTDOWN;</span>
<a href="#l32.9"></a><span id="l32.9">       }</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11">       RefPtr&lt;mozilla::dom::Element&gt; el =</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-          rootShell-&gt;GetDocument()-&gt;GetElementById(</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-              NS_LITERAL_STRING(&quot;messagepane&quot;));</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+          rootShell-&gt;GetDocument()-&gt;GetElementById(u&quot;messagepane&quot;_ns);</span>
<a href="#l32.15"></a><span id="l32.15">       RefPtr&lt;mozilla::dom::XULFrameElement&gt; frame =</span>
<a href="#l32.16"></a><span id="l32.16">           mozilla::dom::XULFrameElement::FromNodeOrNull(el);</span>
<a href="#l32.17"></a><span id="l32.17">       NS_ENSURE_TRUE(frame, NS_ERROR_FAILURE);</span>
<a href="#l32.18"></a><span id="l32.18">       RefPtr&lt;mozilla::dom::Document&gt; doc = frame-&gt;GetContentDocument();</span>
<a href="#l32.19"></a><span id="l32.19">       NS_ENSURE_TRUE(doc, NS_ERROR_FAILURE);</span>
<a href="#l32.20"></a><span id="l32.20">       docShell = doc-&gt;GetDocShell();</span>
<a href="#l32.21"></a><span id="l32.21">       NS_ENSURE_TRUE(docShell, NS_ERROR_FAILURE);</span>
<a href="#l32.22"></a><span id="l32.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -384,20 +384,19 @@ nsMsgXFVirtualFolderDBView::OnNewSearch(</span>
<a href="#l33.4"></a><span id="l33.4">   nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l33.5"></a><span id="l33.5">   rv = searchSession-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l33.6"></a><span id="l33.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.7"></a><span id="l33.7">   nsCString curSearchAsString;</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9">   rv = MsgTermListToString(searchTerms, curSearchAsString);</span>
<a href="#l33.10"></a><span id="l33.10">   // Trim off the initial AND/OR, which is irrelevant and inconsistent between</span>
<a href="#l33.11"></a><span id="l33.11">   // what SearchSpec.jsm generates, and what's in virtualFolders.dat.</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  curSearchAsString.Cut(</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-      0,</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-      StringBeginsWith(curSearchAsString, NS_LITERAL_CSTRING(&quot;AND&quot;)) ? 3 : 2);</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-  terms.Cut(0, StringBeginsWith(terms, NS_LITERAL_CSTRING(&quot;AND&quot;)) ? 3 : 2);</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+  curSearchAsString.Cut(0,</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+                        StringBeginsWith(curSearchAsString, &quot;AND&quot;_ns) ? 3 : 2);</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+  terms.Cut(0, StringBeginsWith(terms, &quot;AND&quot;_ns) ? 3 : 2);</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.21"></a><span id="l33.21">   // If the search session search string doesn't match the vf search str,</span>
<a href="#l33.22"></a><span id="l33.22">   // then we're doing quick search, which means we don't want to invalidate</span>
<a href="#l33.23"></a><span id="l33.23">   // cached results, or used cached results.</span>
<a href="#l33.24"></a><span id="l33.24">   m_doingQuickSearch = !curSearchAsString.Equals(terms);</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26">   if (mTree &amp;&amp; !m_doingQuickSearch) mTree-&gt;BeginUpdateBatch();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -43,17 +43,17 @@ nsSpamSettings::nsSpamSettings() {</span>
<a href="#l34.4"></a><span id="l34.4"> </span>
<a href="#l34.5"></a><span id="l34.5">   mServerFilterTrustFlags = 0;</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7">   mUseWhiteList = false;</span>
<a href="#l34.8"></a><span id="l34.8">   mUseServerFilter = false;</span>
<a href="#l34.9"></a><span id="l34.9"> </span>
<a href="#l34.10"></a><span id="l34.10">   nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l34.11"></a><span id="l34.11">                                        getter_AddRefs(mLogFile));</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  if (NS_SUCCEEDED(rv)) mLogFile-&gt;Append(NS_LITERAL_STRING(&quot;junklog.html&quot;));</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  if (NS_SUCCEEDED(rv)) mLogFile-&gt;Append(u&quot;junklog.html&quot;_ns);</span>
<a href="#l34.14"></a><span id="l34.14"> }</span>
<a href="#l34.15"></a><span id="l34.15"> </span>
<a href="#l34.16"></a><span id="l34.16"> nsSpamSettings::~nsSpamSettings() {}</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18"> NS_IMPL_ISUPPORTS(nsSpamSettings, nsISpamSettings, nsIUrlListener)</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20"> NS_IMETHODIMP</span>
<a href="#l34.21"></a><span id="l34.21"> nsSpamSettings::GetLevel(int32_t* aLevel) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -797,18 +797,17 @@ nsSubscribableServer::GetCellText(int32_</span>
<a href="#l35.4"></a><span id="l35.4"> NS_IMETHODIMP</span>
<a href="#l35.5"></a><span id="l35.5"> nsSubscribableServer::GetCellValue(int32_t aRow, nsTreeColumn* aCol,</span>
<a href="#l35.6"></a><span id="l35.6">                                    nsAString&amp; retval) {</span>
<a href="#l35.7"></a><span id="l35.7">   nsString colId;</span>
<a href="#l35.8"></a><span id="l35.8">   aCol-&gt;GetId(colId);</span>
<a href="#l35.9"></a><span id="l35.9">   if (colId.EqualsLiteral(&quot;nameColumn&quot;))</span>
<a href="#l35.10"></a><span id="l35.10">     retval = NS_ConvertUTF8toUTF16(mRowMap[aRow]-&gt;path);</span>
<a href="#l35.11"></a><span id="l35.11">   if (colId.EqualsLiteral(&quot;subscribedColumn&quot;)) {</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-    retval = mRowMap[aRow]-&gt;isSubscribed ? NS_LITERAL_STRING(&quot;true&quot;)</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-                                         : NS_LITERAL_STRING(&quot;false&quot;);</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+    retval = mRowMap[aRow]-&gt;isSubscribed ? u&quot;true&quot;_ns : u&quot;false&quot;_ns;</span>
<a href="#l35.15"></a><span id="l35.15">   }</span>
<a href="#l35.16"></a><span id="l35.16">   return NS_OK;</span>
<a href="#l35.17"></a><span id="l35.17"> }</span>
<a href="#l35.18"></a><span id="l35.18"> </span>
<a href="#l35.19"></a><span id="l35.19"> NS_IMETHODIMP</span>
<a href="#l35.20"></a><span id="l35.20"> nsSubscribableServer::SetCellText(int32_t aRow, nsTreeColumn* aCol,</span>
<a href="#l35.21"></a><span id="l35.21">                                   const nsAString&amp; aText) {</span>
<a href="#l35.22"></a><span id="l35.22">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/base/test/TestMsgStripRE.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/base/test/TestMsgStripRE.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -46,19 +46,18 @@ TEST(TestMsgStripRE, TestMsgStripREMain)</span>
<a href="#l36.4"></a><span id="l36.4"> {</span>
<a href="#l36.5"></a><span id="l36.5">   nsresult rv;</span>
<a href="#l36.6"></a><span id="l36.6">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l36.7"></a><span id="l36.7">       do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l36.8"></a><span id="l36.8">   EXPECT_TRUE(NS_SUCCEEDED(rv));</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10">   // set localizedRe pref, value &quot;SV,ÆØÅ&quot;,</span>
<a href="#l36.11"></a><span id="l36.11">   // \xC3\x86, \xC3\x98 and \xC3\x85 are the UTF-8 encodings of Æ, Ø and Å.</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  rv = prefBranch-&gt;SetStringPref(</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-      &quot;mailnews.localizedRe&quot;,</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-      NS_LITERAL_CSTRING(&quot;SV,\xC3\x86\xC3\x98\xC3\x85&quot;));</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+  rv = prefBranch-&gt;SetStringPref(&quot;mailnews.localizedRe&quot;,</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+                                 &quot;SV,\xC3\x86\xC3\x98\xC3\x85&quot;_ns);</span>
<a href="#l36.17"></a><span id="l36.17">   EXPECT_TRUE(NS_SUCCEEDED(rv));</span>
<a href="#l36.18"></a><span id="l36.18"> </span>
<a href="#l36.19"></a><span id="l36.19">   // run our tests</span>
<a href="#l36.20"></a><span id="l36.20">   struct testInfo testInfoStructs[] = {</span>
<a href="#l36.21"></a><span id="l36.21">       // Note that re-encoding always happens in UTF-8.</span>
<a href="#l36.22"></a><span id="l36.22">       {&quot;SV: =?ISO-8859-1?Q?=C6blegr=F8d?=&quot;, &quot;=?UTF-8?B?w4ZibGVncsO4ZA==?=&quot;,</span>
<a href="#l36.23"></a><span id="l36.23">        true},</span>
<a href="#l36.24"></a><span id="l36.24">       {&quot;=?ISO-8859-1?Q?SV=3A=C6blegr=F8d?=&quot;, &quot;=?UTF-8?B?w4ZibGVncsO4ZA==?=&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -2040,18 +2040,17 @@ nsMsgDBFolder::GetForcePropertyEmpty(con</span>
<a href="#l37.4"></a><span id="l37.4">   *_retval = value.EqualsLiteral(&quot;true&quot;);</span>
<a href="#l37.5"></a><span id="l37.5">   return NS_OK;</span>
<a href="#l37.6"></a><span id="l37.6"> }</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> NS_IMETHODIMP</span>
<a href="#l37.9"></a><span id="l37.9"> nsMsgDBFolder::SetForcePropertyEmpty(const char* aPropertyName, bool aValue) {</span>
<a href="#l37.10"></a><span id="l37.10">   nsAutoCString nameEmpty(aPropertyName);</span>
<a href="#l37.11"></a><span id="l37.11">   nameEmpty.AppendLiteral(&quot;.empty&quot;);</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  return SetStringProperty(nameEmpty.get(), aValue ? NS_LITERAL_CSTRING(&quot;true&quot;)</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-                                                   : NS_LITERAL_CSTRING(&quot;&quot;));</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+  return SetStringProperty(nameEmpty.get(), aValue ? &quot;true&quot;_ns : &quot;&quot;_ns);</span>
<a href="#l37.15"></a><span id="l37.15"> }</span>
<a href="#l37.16"></a><span id="l37.16"> </span>
<a href="#l37.17"></a><span id="l37.17"> NS_IMETHODIMP</span>
<a href="#l37.18"></a><span id="l37.18"> nsMsgDBFolder::GetInheritedStringProperty(const char* aPropertyName,</span>
<a href="#l37.19"></a><span id="l37.19">                                           nsACString&amp; aPropertyValue) {</span>
<a href="#l37.20"></a><span id="l37.20">   NS_ENSURE_ARG_POINTER(aPropertyName);</span>
<a href="#l37.21"></a><span id="l37.21">   nsCString value;</span>
<a href="#l37.22"></a><span id="l37.22">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineat">@@ -3069,20 +3068,19 @@ NS_IMETHODIMP nsMsgDBFolder::GetPrettyNa</span>
<a href="#l37.24"></a><span id="l37.24"> </span>
<a href="#l37.25"></a><span id="l37.25"> // -1: not retrieved yet, 1: English, 0: non-English.</span>
<a href="#l37.26"></a><span id="l37.26"> static int isEnglish = -1;</span>
<a href="#l37.27"></a><span id="l37.27"> </span>
<a href="#l37.28"></a><span id="l37.28"> static bool nonEnglishApp() {</span>
<a href="#l37.29"></a><span id="l37.29">   if (isEnglish == -1) {</span>
<a href="#l37.30"></a><span id="l37.30">     nsAutoCString locale;</span>
<a href="#l37.31"></a><span id="l37.31">     mozilla::intl::LocaleService::GetInstance()-&gt;GetAppLocaleAsBCP47(locale);</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-    isEnglish = (locale.EqualsLiteral(&quot;en&quot;) ||</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">-                 StringBeginsWith(locale, NS_LITERAL_CSTRING(&quot;en-&quot;)))</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-                    ? 1</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-                    : 0;</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+    isEnglish =</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+        (locale.EqualsLiteral(&quot;en&quot;) || StringBeginsWith(locale, &quot;en-&quot;_ns)) ? 1</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+                                                                           : 0;</span>
<a href="#l37.39"></a><span id="l37.39">   }</span>
<a href="#l37.40"></a><span id="l37.40">   return isEnglish ? false : true;</span>
<a href="#l37.41"></a><span id="l37.41"> }</span>
<a href="#l37.42"></a><span id="l37.42"> </span>
<a href="#l37.43"></a><span id="l37.43"> static bool hasTrashName(const nsAString&amp; name) {</span>
<a href="#l37.44"></a><span id="l37.44">   // Microsoft calls the folder &quot;Deleted&quot;. If the application is non-English,</span>
<a href="#l37.45"></a><span id="l37.45">   // we want to use the localised name instead.</span>
<a href="#l37.46"></a><span id="l37.46">   return name.LowerCaseEqualsLiteral(&quot;trash&quot;) ||</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineat">@@ -3588,17 +3586,17 @@ nsresult nsMsgDBFolder::CreateDirectoryF</span>
<a href="#l37.48"></a><span id="l37.48">    drive. If that path doesn't currently exist then it will create it. Path is</span>
<a href="#l37.49"></a><span id="l37.49">    strictly an out parameter.</span>
<a href="#l37.50"></a><span id="l37.50">   */</span>
<a href="#l37.51"></a><span id="l37.51"> nsresult nsMsgDBFolder::CreateBackupDirectory(nsIFile** resultFile) {</span>
<a href="#l37.52"></a><span id="l37.52">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l37.53"></a><span id="l37.53">   nsresult rv = NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(path));</span>
<a href="#l37.54"></a><span id="l37.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.55"></a><span id="l37.55"> </span>
<a href="#l37.56"></a><span id="l37.56" class="difflineminus">-  rv = path-&gt;Append(NS_LITERAL_STRING(&quot;MozillaMailnews&quot;));</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+  rv = path-&gt;Append(u&quot;MozillaMailnews&quot;_ns);</span>
<a href="#l37.58"></a><span id="l37.58">   bool pathIsDirectory;</span>
<a href="#l37.59"></a><span id="l37.59">   path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l37.60"></a><span id="l37.60"> </span>
<a href="#l37.61"></a><span id="l37.61">   // If that doesn't exist, then we have to create this directory</span>
<a href="#l37.62"></a><span id="l37.62">   if (!pathIsDirectory) {</span>
<a href="#l37.63"></a><span id="l37.63">     bool pathExists;</span>
<a href="#l37.64"></a><span id="l37.64">     path-&gt;Exists(&amp;pathExists);</span>
<a href="#l37.65"></a><span id="l37.65">     // If for some reason there's a file with the directory separator</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineat">@@ -4933,34 +4931,34 @@ NS_IMETHODIMP nsMsgDBFolder::GetMsgTextF</span>
<a href="#l37.67"></a><span id="l37.67">       contentType.AssignLiteral(u&quot;text/plain&quot;);</span>
<a href="#l37.68"></a><span id="l37.68">     else</span>
<a href="#l37.69"></a><span id="l37.69">       mimeHdrParam-&gt;GetParameter(contentTypeHdr, nullptr, EmptyCString(), false,</span>
<a href="#l37.70"></a><span id="l37.70">                                  nullptr, contentType);</span>
<a href="#l37.71"></a><span id="l37.71"> </span>
<a href="#l37.72"></a><span id="l37.72">     justPassedEndBoundary = false;</span>
<a href="#l37.73"></a><span id="l37.73"> </span>
<a href="#l37.74"></a><span id="l37.74">     // If we are multipart, then we need to get the boundary</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineminus">-    if (StringBeginsWith(contentType, NS_LITERAL_STRING(&quot;multipart/&quot;),</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+    if (StringBeginsWith(contentType, u&quot;multipart/&quot;_ns,</span>
<a href="#l37.77"></a><span id="l37.77">                          nsCaseInsensitiveStringComparator)) {</span>
<a href="#l37.78"></a><span id="l37.78">       nsAutoString boundaryParam;</span>
<a href="#l37.79"></a><span id="l37.79">       mimeHdrParam-&gt;GetParameter(contentTypeHdr, &quot;boundary&quot;, EmptyCString(),</span>
<a href="#l37.80"></a><span id="l37.80">                                  false, nullptr, boundaryParam);</span>
<a href="#l37.81"></a><span id="l37.81">       if (!boundaryParam.IsEmpty()) {</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-        nsAutoCString boundary(NS_LITERAL_CSTRING(&quot;--&quot;));</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+        nsAutoCString boundary(&quot;--&quot;_ns);</span>
<a href="#l37.84"></a><span id="l37.84">         boundary.Append(NS_ConvertUTF16toUTF8(boundaryParam));</span>
<a href="#l37.85"></a><span id="l37.85">         boundaryStack.AppendElement(boundary);</span>
<a href="#l37.86"></a><span id="l37.86">       }</span>
<a href="#l37.87"></a><span id="l37.87">     }</span>
<a href="#l37.88"></a><span id="l37.88"> </span>
<a href="#l37.89"></a><span id="l37.89">     // If we are message/rfc822, then there's another header block coming up</span>
<a href="#l37.90"></a><span id="l37.90">     else if (contentType.LowerCaseEqualsLiteral(&quot;message/rfc822&quot;))</span>
<a href="#l37.91"></a><span id="l37.91">       continue;</span>
<a href="#l37.92"></a><span id="l37.92"> </span>
<a href="#l37.93"></a><span id="l37.93">     // If we are a text part, then we want it</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineminus">-    else if (StringBeginsWith(contentType, NS_LITERAL_STRING(&quot;text/&quot;),</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+    else if (StringBeginsWith(contentType, u&quot;text/&quot;_ns,</span>
<a href="#l37.96"></a><span id="l37.96">                               nsCaseInsensitiveStringComparator)) {</span>
<a href="#l37.97"></a><span id="l37.97">       inMsgBody = true;</span>
<a href="#l37.98"></a><span id="l37.98"> </span>
<a href="#l37.99"></a><span id="l37.99">       if (contentType.LowerCaseEqualsLiteral(&quot;text/html&quot;)) msgBodyIsHtml = true;</span>
<a href="#l37.100"></a><span id="l37.100"> </span>
<a href="#l37.101"></a><span id="l37.101">       // Also get the charset if required</span>
<a href="#l37.102"></a><span id="l37.102">       if (charset.IsEmpty()) {</span>
<a href="#l37.103"></a><span id="l37.103">         nsAutoString charsetW;</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineat">@@ -5098,24 +5096,24 @@ void nsMsgDBFolder::compressQuotesInMsgS</span>
<a href="#l37.105"></a><span id="l37.105">     if (lineFeedPos != -1) {</span>
<a href="#l37.106"></a><span id="l37.106">       const nsAString&amp; currentLine =</span>
<a href="#l37.107"></a><span id="l37.107">           Substring(aMsgSnippet, offset, lineFeedPos - offset);</span>
<a href="#l37.108"></a><span id="l37.108">       // this catches quoted text (&quot;&gt; &quot;), nested quotes of any level (&quot;&gt;&gt; &quot;,</span>
<a href="#l37.109"></a><span id="l37.109">       // &quot;&gt;&gt;&gt; &quot;, ...) it also catches empty line quoted text (&quot;&gt;&quot;). It might be</span>
<a href="#l37.110"></a><span id="l37.110">       // over aggressive and require tweaking later. Try to strip the citation.</span>
<a href="#l37.111"></a><span id="l37.111">       // If the current line ends with a ':' and the next line looks like a</span>
<a href="#l37.112"></a><span id="l37.112">       // quoted reply (starts with a &quot;&gt;&quot;) skip the current line</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-      if (StringBeginsWith(currentLine, NS_LITERAL_STRING(&quot;&gt;&quot;)) ||</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineplus">+      if (StringBeginsWith(currentLine, u&quot;&gt;&quot;_ns) ||</span>
<a href="#l37.115"></a><span id="l37.115">           (lineFeedPos + 1 &lt; msgBodyStrLen &amp;&amp; lineFeedPos &amp;&amp;</span>
<a href="#l37.116"></a><span id="l37.116">            aMsgSnippet[lineFeedPos - 1] == char16_t(':') &amp;&amp;</span>
<a href="#l37.117"></a><span id="l37.117">            aMsgSnippet[lineFeedPos + 1] == char16_t('&gt;'))) {</span>
<a href="#l37.118"></a><span id="l37.118">         lastLineWasAQuote = true;</span>
<a href="#l37.119"></a><span id="l37.119">       } else if (!currentLine.IsEmpty()) {</span>
<a href="#l37.120"></a><span id="l37.120">         if (lastLineWasAQuote) {</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineminus">-          aCompressedQuotes += NS_LITERAL_STRING(&quot; ... &quot;);</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineplus">+          aCompressedQuotes += u&quot; ... &quot;_ns;</span>
<a href="#l37.123"></a><span id="l37.123">           lastLineWasAQuote = false;</span>
<a href="#l37.124"></a><span id="l37.124">         }</span>
<a href="#l37.125"></a><span id="l37.125"> </span>
<a href="#l37.126"></a><span id="l37.126">         aCompressedQuotes += currentLine;</span>
<a href="#l37.127"></a><span id="l37.127">         // Don't forget to substitute a space for the line feed.</span>
<a href="#l37.128"></a><span id="l37.128">         aCompressedQuotes += char16_t(' ');</span>
<a href="#l37.129"></a><span id="l37.129">       }</span>
<a href="#l37.130"></a><span id="l37.130"> </span>
<a href="#l37.131"></a><span id="l37.131" class="difflineat">@@ -5237,20 +5235,19 @@ NS_IMETHODIMP nsMsgDBFolder::RemoveKeywo</span>
<a href="#l37.132"></a><span id="l37.132">     // If the tag is also a label, we should remove the label too...</span>
<a href="#l37.133"></a><span id="l37.133"> </span>
<a href="#l37.134"></a><span id="l37.134">     for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l37.135"></a><span id="l37.135">       nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l37.136"></a><span id="l37.136">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.137"></a><span id="l37.137">       rv = message-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l37.138"></a><span id="l37.138">       uint32_t removeCount = 0;</span>
<a href="#l37.139"></a><span id="l37.139">       for (uint32_t j = 0; j &lt; keywordArray.Length(); j++) {</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineminus">-        bool keywordIsLabel =</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineminus">-            (StringBeginsWith(keywordArray[j], NS_LITERAL_CSTRING(&quot;$label&quot;)) &amp;&amp;</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineminus">-             keywordArray[j].CharAt(6) &gt;= '1' &amp;&amp;</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineminus">-             keywordArray[j].CharAt(6) &lt;= '5');</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineplus">+        bool keywordIsLabel = (StringBeginsWith(keywordArray[j], &quot;$label&quot;_ns) &amp;&amp;</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineplus">+                               keywordArray[j].CharAt(6) &gt;= '1' &amp;&amp;</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+                               keywordArray[j].CharAt(6) &lt;= '5');</span>
<a href="#l37.147"></a><span id="l37.147">         if (keywordIsLabel) {</span>
<a href="#l37.148"></a><span id="l37.148">           nsMsgLabelValue labelValue;</span>
<a href="#l37.149"></a><span id="l37.149">           message-&gt;GetLabel(&amp;labelValue);</span>
<a href="#l37.150"></a><span id="l37.150">           // if we're removing the keyword that corresponds to a pre 2.0 label,</span>
<a href="#l37.151"></a><span id="l37.151">           // we need to clear the old label attribute on the message.</span>
<a href="#l37.152"></a><span id="l37.152">           if (labelValue == (nsMsgLabelValue)(keywordArray[j].CharAt(6) - '0'))</span>
<a href="#l37.153"></a><span id="l37.153">             message-&gt;SetLabel((nsMsgLabelValue)0);</span>
<a href="#l37.154"></a><span id="l37.154">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -988,33 +988,32 @@ nsMsgIncomingServer::GetFilterList(nsIMs</span>
<a href="#l38.4"></a><span id="l38.4">     rv = msgFolder-&gt;GetFilePath(getter_AddRefs(thisFolder));</span>
<a href="#l38.5"></a><span id="l38.5">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7">     mFilterFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l38.8"></a><span id="l38.8">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.9"></a><span id="l38.9">     rv = mFilterFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l38.10"></a><span id="l38.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-    mFilterFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;msgFilterRules.dat&quot;));</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+    mFilterFile-&gt;AppendNative(&quot;msgFilterRules.dat&quot;_ns);</span>
<a href="#l38.14"></a><span id="l38.14"> </span>
<a href="#l38.15"></a><span id="l38.15">     bool fileExists;</span>
<a href="#l38.16"></a><span id="l38.16">     mFilterFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l38.17"></a><span id="l38.17">     if (!fileExists) {</span>
<a href="#l38.18"></a><span id="l38.18">       nsCOMPtr&lt;nsIFile&gt; oldFilterFile =</span>
<a href="#l38.19"></a><span id="l38.19">           do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l38.20"></a><span id="l38.20">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.21"></a><span id="l38.21">       rv = oldFilterFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l38.22"></a><span id="l38.22">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-      oldFilterFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;rules.dat&quot;));</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+      oldFilterFile-&gt;AppendNative(&quot;rules.dat&quot;_ns);</span>
<a href="#l38.25"></a><span id="l38.25"> </span>
<a href="#l38.26"></a><span id="l38.26">       oldFilterFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l38.27"></a><span id="l38.27">       if (fileExists)  // copy rules.dat --&gt; msgFilterRules.dat</span>
<a href="#l38.28"></a><span id="l38.28">       {</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-        rv = oldFilterFile-&gt;CopyToNative(</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-            thisFolder, NS_LITERAL_CSTRING(&quot;msgFilterRules.dat&quot;));</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+        rv = oldFilterFile-&gt;CopyToNative(thisFolder, &quot;msgFilterRules.dat&quot;_ns);</span>
<a href="#l38.32"></a><span id="l38.32">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.33"></a><span id="l38.33">       }</span>
<a href="#l38.34"></a><span id="l38.34">     }</span>
<a href="#l38.35"></a><span id="l38.35">     nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l38.36"></a><span id="l38.36">         do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l38.37"></a><span id="l38.37">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.38"></a><span id="l38.38"> </span>
<a href="#l38.39"></a><span id="l38.39">     rv = filterService-&gt;OpenFilterList(mFilterFile, msgFolder, aMsgWindow,</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineat">@@ -1758,17 +1757,17 @@ nsresult nsMsgIncomingServer::ConfigureT</span>
<a href="#l38.41"></a><span id="l38.41">     searchTerm-&gt;SetAttrib(nsMsgSearchAttrib::JunkScoreOrigin);</span>
<a href="#l38.42"></a><span id="l38.42">     searchTerm-&gt;SetOp(nsMsgSearchOp::Isnt);</span>
<a href="#l38.43"></a><span id="l38.43">     searchTerm-&gt;SetBooleanAnd(true);</span>
<a href="#l38.44"></a><span id="l38.44"> </span>
<a href="#l38.45"></a><span id="l38.45">     nsCOMPtr&lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l38.46"></a><span id="l38.46">     searchTerm-&gt;GetValue(getter_AddRefs(searchValue));</span>
<a href="#l38.47"></a><span id="l38.47">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.48"></a><span id="l38.48">     searchValue-&gt;SetAttrib(nsMsgSearchAttrib::JunkScoreOrigin);</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineminus">-    searchValue-&gt;SetStr(NS_LITERAL_STRING(&quot;user&quot;));</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+    searchValue-&gt;SetStr(u&quot;user&quot;_ns);</span>
<a href="#l38.51"></a><span id="l38.51">     searchTerm-&gt;SetValue(searchValue);</span>
<a href="#l38.52"></a><span id="l38.52"> </span>
<a href="#l38.53"></a><span id="l38.53">     searchTerms-&gt;InsertElementAt(searchTerm, count);</span>
<a href="#l38.54"></a><span id="l38.54"> </span>
<a href="#l38.55"></a><span id="l38.55">     bool moveOnSpam, markAsReadOnSpam;</span>
<a href="#l38.56"></a><span id="l38.56">     spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l38.57"></a><span id="l38.57">     if (moveOnSpam) {</span>
<a href="#l38.58"></a><span id="l38.58">       nsCString spamFolderURI;</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineat">@@ -1859,38 +1858,38 @@ nsresult nsMsgIncomingServer::ConfigureT</span>
<a href="#l38.60"></a><span id="l38.60"> </span>
<a href="#l38.61"></a><span id="l38.61">         rv = newFilter-&gt;CreateTerm(getter_AddRefs(term));</span>
<a href="#l38.62"></a><span id="l38.62">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l38.63"></a><span id="l38.63">           rv = term-&gt;GetValue(getter_AddRefs(value));</span>
<a href="#l38.64"></a><span id="l38.64">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l38.65"></a><span id="l38.65">             // we need to use OtherHeader + 1 so nsMsgFilter::GetTerm will</span>
<a href="#l38.66"></a><span id="l38.66">             // return our custom header.</span>
<a href="#l38.67"></a><span id="l38.67">             value-&gt;SetAttrib(nsMsgSearchAttrib::OtherHeader + 1);</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-            value-&gt;SetStr(NS_LITERAL_STRING(&quot;multipart/report&quot;));</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+            value-&gt;SetStr(u&quot;multipart/report&quot;_ns);</span>
<a href="#l38.70"></a><span id="l38.70">             term-&gt;SetAttrib(nsMsgSearchAttrib::OtherHeader + 1);</span>
<a href="#l38.71"></a><span id="l38.71">             term-&gt;SetOp(nsMsgSearchOp::Contains);</span>
<a href="#l38.72"></a><span id="l38.72">             term-&gt;SetBooleanAnd(true);</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-            term-&gt;SetArbitraryHeader(NS_LITERAL_CSTRING(&quot;Content-Type&quot;));</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+            term-&gt;SetArbitraryHeader(&quot;Content-Type&quot;_ns);</span>
<a href="#l38.75"></a><span id="l38.75">             term-&gt;SetValue(value);</span>
<a href="#l38.76"></a><span id="l38.76">             newFilter-&gt;AppendTerm(term);</span>
<a href="#l38.77"></a><span id="l38.77">           }</span>
<a href="#l38.78"></a><span id="l38.78">         }</span>
<a href="#l38.79"></a><span id="l38.79">         rv = newFilter-&gt;CreateTerm(getter_AddRefs(term));</span>
<a href="#l38.80"></a><span id="l38.80">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l38.81"></a><span id="l38.81">           rv = term-&gt;GetValue(getter_AddRefs(value));</span>
<a href="#l38.82"></a><span id="l38.82">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l38.83"></a><span id="l38.83">             // XXX todo</span>
<a href="#l38.84"></a><span id="l38.84">             // determine if ::OtherHeader is the best way to do this.</span>
<a href="#l38.85"></a><span id="l38.85">             // see nsMsgSearchOfflineMail::MatchTerms()</span>
<a href="#l38.86"></a><span id="l38.86">             value-&gt;SetAttrib(nsMsgSearchAttrib::OtherHeader + 1);</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineminus">-            value-&gt;SetStr(NS_LITERAL_STRING(&quot;disposition-notification&quot;));</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+            value-&gt;SetStr(u&quot;disposition-notification&quot;_ns);</span>
<a href="#l38.89"></a><span id="l38.89">             term-&gt;SetAttrib(nsMsgSearchAttrib::OtherHeader + 1);</span>
<a href="#l38.90"></a><span id="l38.90">             term-&gt;SetOp(nsMsgSearchOp::Contains);</span>
<a href="#l38.91"></a><span id="l38.91">             term-&gt;SetBooleanAnd(true);</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-            term-&gt;SetArbitraryHeader(NS_LITERAL_CSTRING(&quot;Content-Type&quot;));</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+            term-&gt;SetArbitraryHeader(&quot;Content-Type&quot;_ns);</span>
<a href="#l38.94"></a><span id="l38.94">             term-&gt;SetValue(value);</span>
<a href="#l38.95"></a><span id="l38.95">             newFilter-&gt;AppendTerm(term);</span>
<a href="#l38.96"></a><span id="l38.96">           }</span>
<a href="#l38.97"></a><span id="l38.97">         }</span>
<a href="#l38.98"></a><span id="l38.98">         nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction;</span>
<a href="#l38.99"></a><span id="l38.99">         rv = newFilter-&gt;CreateAction(getter_AddRefs(filterAction));</span>
<a href="#l38.100"></a><span id="l38.100">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l38.101"></a><span id="l38.101">           filterAction-&gt;SetType(nsMsgFilterAction::MoveToFolder);</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineat">@@ -1904,17 +1903,17 @@ nsresult nsMsgIncomingServer::ConfigureT</span>
<a href="#l38.103"></a><span id="l38.103">   return rv;</span>
<a href="#l38.104"></a><span id="l38.104"> }</span>
<a href="#l38.105"></a><span id="l38.105"> </span>
<a href="#l38.106"></a><span id="l38.106"> NS_IMETHODIMP</span>
<a href="#l38.107"></a><span id="l38.107"> nsMsgIncomingServer::ClearTemporaryReturnReceiptsFilter() {</span>
<a href="#l38.108"></a><span id="l38.108">   if (mFilterList) {</span>
<a href="#l38.109"></a><span id="l38.109">     nsCOMPtr&lt;nsIMsgFilter&gt; mdnFilter;</span>
<a href="#l38.110"></a><span id="l38.110">     nsresult rv = mFilterList-&gt;GetFilterNamed(</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineminus">-        NS_LITERAL_STRING(&quot;mozilla-temporary-internal-MDN-receipt-filter&quot;),</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+        u&quot;mozilla-temporary-internal-MDN-receipt-filter&quot;_ns,</span>
<a href="#l38.113"></a><span id="l38.113">         getter_AddRefs(mdnFilter));</span>
<a href="#l38.114"></a><span id="l38.114">     if (NS_SUCCEEDED(rv) &amp;&amp; mdnFilter)</span>
<a href="#l38.115"></a><span id="l38.115">       return mFilterList-&gt;RemoveFilter(mdnFilter);</span>
<a href="#l38.116"></a><span id="l38.116">   }</span>
<a href="#l38.117"></a><span id="l38.117">   return NS_OK;</span>
<a href="#l38.118"></a><span id="l38.118"> }</span>
<a href="#l38.119"></a><span id="l38.119"> </span>
<a href="#l38.120"></a><span id="l38.120"> NS_IMETHODIMP</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineat">@@ -2091,18 +2090,17 @@ nsMsgIncomingServer::GetForcePropertyEmp</span>
<a href="#l38.122"></a><span id="l38.122">   return NS_OK;</span>
<a href="#l38.123"></a><span id="l38.123"> }</span>
<a href="#l38.124"></a><span id="l38.124"> </span>
<a href="#l38.125"></a><span id="l38.125"> NS_IMETHODIMP</span>
<a href="#l38.126"></a><span id="l38.126"> nsMsgIncomingServer::SetForcePropertyEmpty(const char* aPropertyName,</span>
<a href="#l38.127"></a><span id="l38.127">                                            bool aValue) {</span>
<a href="#l38.128"></a><span id="l38.128">   nsAutoCString nameEmpty(aPropertyName);</span>
<a href="#l38.129"></a><span id="l38.129">   nameEmpty.AppendLiteral(&quot;.empty&quot;);</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineminus">-  return SetCharValue(nameEmpty.get(), aValue ? NS_LITERAL_CSTRING(&quot;true&quot;)</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineminus">-                                              : NS_LITERAL_CSTRING(&quot;&quot;));</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineplus">+  return SetCharValue(nameEmpty.get(), aValue ? &quot;true&quot;_ns : &quot;&quot;_ns);</span>
<a href="#l38.133"></a><span id="l38.133"> }</span>
<a href="#l38.134"></a><span id="l38.134"> </span>
<a href="#l38.135"></a><span id="l38.135"> NS_IMETHODIMP</span>
<a href="#l38.136"></a><span id="l38.136"> nsMsgIncomingServer::GetSortOrder(int32_t* aSortOrder) {</span>
<a href="#l38.137"></a><span id="l38.137">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l38.138"></a><span id="l38.138">   *aSortOrder = 100000000;</span>
<a href="#l38.139"></a><span id="l38.139">   return NS_OK;</span>
<a href="#l38.140"></a><span id="l38.140"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1033,17 +1033,17 @@ NS_IMETHODIMP nsMsgMailNewsUrl::SetMsgHe</span>
<a href="#l39.4"></a><span id="l39.4">   mMsgHeaderSink = aMsgHdrSink;</span>
<a href="#l39.5"></a><span id="l39.5">   return NS_OK;</span>
<a href="#l39.6"></a><span id="l39.6"> }</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> NS_IMETHODIMP nsMsgMailNewsUrl::GetIsMessageUri(bool* aIsMessageUri) {</span>
<a href="#l39.9"></a><span id="l39.9">   NS_ENSURE_ARG(aIsMessageUri);</span>
<a href="#l39.10"></a><span id="l39.10">   nsAutoCString scheme;</span>
<a href="#l39.11"></a><span id="l39.11">   m_baseURL-&gt;GetScheme(scheme);</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  *aIsMessageUri = StringEndsWith(scheme, NS_LITERAL_CSTRING(&quot;-message&quot;));</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+  *aIsMessageUri = StringEndsWith(scheme, &quot;-message&quot;_ns);</span>
<a href="#l39.14"></a><span id="l39.14">   return NS_OK;</span>
<a href="#l39.15"></a><span id="l39.15"> }</span>
<a href="#l39.16"></a><span id="l39.16"> </span>
<a href="#l39.17"></a><span id="l39.17"> NS_IMPL_ISUPPORTS(nsMsgMailNewsUrl::Mutator, nsIURISetters, nsIURIMutator)</span>
<a href="#l39.18"></a><span id="l39.18"> </span>
<a href="#l39.19"></a><span id="l39.19"> NS_IMETHODIMP</span>
<a href="#l39.20"></a><span id="l39.20"> nsMsgMailNewsUrl::Mutate(nsIURIMutator** aMutator) {</span>
<a href="#l39.21"></a><span id="l39.21">   RefPtr&lt;nsMsgMailNewsUrl::Mutator&gt; mutator = new nsMsgMailNewsUrl::Mutator();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/base/util/nsMsgTxn.cpp</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgTxn.cpp</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -211,17 +211,17 @@ nsresult nsMsgTxn::GetMsgWindow(nsIMsgWi</span>
<a href="#l40.4"></a><span id="l40.4"> }</span>
<a href="#l40.5"></a><span id="l40.5"> </span>
<a href="#l40.6"></a><span id="l40.6"> nsresult nsMsgTxn::SetMsgWindow(nsIMsgWindow* msgWindow) {</span>
<a href="#l40.7"></a><span id="l40.7">   m_msgWindow = msgWindow;</span>
<a href="#l40.8"></a><span id="l40.8">   return NS_OK;</span>
<a href="#l40.9"></a><span id="l40.9"> }</span>
<a href="#l40.10"></a><span id="l40.10"> </span>
<a href="#l40.11"></a><span id="l40.11"> nsresult nsMsgTxn::SetTransactionType(uint32_t txnType) {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  return SetPropertyAsUint32(NS_LITERAL_STRING(&quot;type&quot;), txnType);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+  return SetPropertyAsUint32(u&quot;type&quot;_ns, txnType);</span>
<a href="#l40.14"></a><span id="l40.14"> }</span>
<a href="#l40.15"></a><span id="l40.15"> </span>
<a href="#l40.16"></a><span id="l40.16"> /*none of the callers pass null aFolder,</span>
<a href="#l40.17"></a><span id="l40.17">   we always initialize aResult (before we pass in) for the case where the key is</span>
<a href="#l40.18"></a><span id="l40.18">   not in the db*/</span>
<a href="#l40.19"></a><span id="l40.19"> nsresult nsMsgTxn::CheckForToggleDelete(nsIMsgFolder* aFolder,</span>
<a href="#l40.20"></a><span id="l40.20">                                         const nsMsgKey&amp; aMsgKey,</span>
<a href="#l40.21"></a><span id="l40.21">                                         bool* aResult) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -836,17 +836,17 @@ nsresult GetOrCreateJunkFolder(const nsA</span>
<a href="#l41.4"></a><span id="l41.4">     if (!exists) {</span>
<a href="#l41.5"></a><span id="l41.5">       // Hack to work around a localization bug with the Junk Folder.</span>
<a href="#l41.6"></a><span id="l41.6">       // Please see Bug #270261 for more information...</span>
<a href="#l41.7"></a><span id="l41.7">       nsString localizedJunkName;</span>
<a href="#l41.8"></a><span id="l41.8">       msgFolder-&gt;GetName(localizedJunkName);</span>
<a href="#l41.9"></a><span id="l41.9"> </span>
<a href="#l41.10"></a><span id="l41.10">       // force the junk folder name to be Junk so it gets created on disk</span>
<a href="#l41.11"></a><span id="l41.11">       // correctly...</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-      msgFolder-&gt;SetName(NS_LITERAL_STRING(&quot;Junk&quot;));</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+      msgFolder-&gt;SetName(u&quot;Junk&quot;_ns);</span>
<a href="#l41.14"></a><span id="l41.14">       msgFolder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l41.15"></a><span id="l41.15">       rv = msgFolder-&gt;CreateStorageIfMissing(aListener);</span>
<a href="#l41.16"></a><span id="l41.16">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l41.17"></a><span id="l41.17"> </span>
<a href="#l41.18"></a><span id="l41.18">       // now restore the localized folder name...</span>
<a href="#l41.19"></a><span id="l41.19">       msgFolder-&gt;SetName(localizedJunkName);</span>
<a href="#l41.20"></a><span id="l41.20"> </span>
<a href="#l41.21"></a><span id="l41.21">       // XXX TODO</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -347,19 +347,19 @@ nsresult nsMsgAttachmentHandler::PickEnc</span>
<a href="#l42.4"></a><span id="l42.4">       // If there are nulls, we must always encode, because sendmail will</span>
<a href="#l42.5"></a><span id="l42.5">       // blow up.</span>
<a href="#l42.6"></a><span id="l42.6">       encode_p = true;</span>
<a href="#l42.7"></a><span id="l42.7">     } else {</span>
<a href="#l42.8"></a><span id="l42.8">       encode_p = false;</span>
<a href="#l42.9"></a><span id="l42.9">     }</span>
<a href="#l42.10"></a><span id="l42.10"> </span>
<a href="#l42.11"></a><span id="l42.11">     // MIME requires a special case that these types never be encoded.</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-    if (StringBeginsWith(m_type, NS_LITERAL_CSTRING(&quot;message&quot;),</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+    if (StringBeginsWith(m_type, &quot;message&quot;_ns,</span>
<a href="#l42.14"></a><span id="l42.14">                          nsCaseInsensitiveCStringComparator) ||</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-        StringBeginsWith(m_type, NS_LITERAL_CSTRING(&quot;multipart&quot;),</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+        StringBeginsWith(m_type, &quot;multipart&quot;_ns,</span>
<a href="#l42.17"></a><span id="l42.17">                          nsCaseInsensitiveCStringComparator)) {</span>
<a href="#l42.18"></a><span id="l42.18">       encode_p = false;</span>
<a href="#l42.19"></a><span id="l42.19">       if (m_desiredType.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l42.20"></a><span id="l42.20">         m_desiredType.Truncate();</span>
<a href="#l42.21"></a><span id="l42.21">     }</span>
<a href="#l42.22"></a><span id="l42.22"> </span>
<a href="#l42.23"></a><span id="l42.23">     // If the Mail charset is multibyte, we force it to use Base64 for</span>
<a href="#l42.24"></a><span id="l42.24">     // attachments.</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineat">@@ -448,18 +448,17 @@ DONE:</span>
<a href="#l42.26"></a><span id="l42.26">     else</span>
<a href="#l42.27"></a><span id="l42.27">       m_type = TEXT_PLAIN;</span>
<a href="#l42.28"></a><span id="l42.28">   }</span>
<a href="#l42.29"></a><span id="l42.29">   return NS_OK;</span>
<a href="#l42.30"></a><span id="l42.30"> }</span>
<a href="#l42.31"></a><span id="l42.31"> </span>
<a href="#l42.32"></a><span id="l42.32"> nsresult nsMsgAttachmentHandler::PickCharset() {</span>
<a href="#l42.33"></a><span id="l42.33">   if (!m_charset.IsEmpty() ||</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-      !StringBeginsWith(m_type, NS_LITERAL_CSTRING(&quot;text/&quot;),</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-                        nsCaseInsensitiveCStringComparator))</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+      !StringBeginsWith(m_type, &quot;text/&quot;_ns, nsCaseInsensitiveCStringComparator))</span>
<a href="#l42.37"></a><span id="l42.37">     return NS_OK;</span>
<a href="#l42.38"></a><span id="l42.38"> </span>
<a href="#l42.39"></a><span id="l42.39">   if (!mTmpFile) return NS_OK;</span>
<a href="#l42.40"></a><span id="l42.40"> </span>
<a href="#l42.41"></a><span id="l42.41">   return MsgDetectCharsetFromFile(mTmpFile, m_charset);</span>
<a href="#l42.42"></a><span id="l42.42"> }</span>
<a href="#l42.43"></a><span id="l42.43"> </span>
<a href="#l42.44"></a><span id="l42.44"> static nsresult FetcherURLDoneCallback(nsresult aStatus,</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineat">@@ -643,18 +642,17 @@ nsresult nsMsgAttachmentHandler::SnarfAt</span>
<a href="#l42.46"></a><span id="l42.46">     mTmpFile = nullptr;</span>
<a href="#l42.47"></a><span id="l42.47">     return NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l42.48"></a><span id="l42.48">   }</span>
<a href="#l42.49"></a><span id="l42.49"> </span>
<a href="#l42.50"></a><span id="l42.50">   nsCString sourceURISpec;</span>
<a href="#l42.51"></a><span id="l42.51">   rv = mURL-&gt;GetSpec(sourceURISpec);</span>
<a href="#l42.52"></a><span id="l42.52">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.53"></a><span id="l42.53"> #ifdef XP_MACOSX</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-  if (!m_bogus_attachment &amp;&amp;</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineminus">-      StringBeginsWith(sourceURISpec, NS_LITERAL_CSTRING(&quot;file://&quot;))) {</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+  if (!m_bogus_attachment &amp;&amp; StringBeginsWith(sourceURISpec, &quot;file://&quot;_ns)) {</span>
<a href="#l42.57"></a><span id="l42.57">     // Unescape the path (i.e. un-URLify it) before making a FSSpec</span>
<a href="#l42.58"></a><span id="l42.58">     nsAutoCString filePath;</span>
<a href="#l42.59"></a><span id="l42.59">     filePath.Adopt(nsMsgGetLocalFileFromURL(sourceURISpec.get()));</span>
<a href="#l42.60"></a><span id="l42.60">     nsAutoCString unescapedFilePath;</span>
<a href="#l42.61"></a><span id="l42.61">     MsgUnescapeString(filePath, 0, unescapedFilePath);</span>
<a href="#l42.62"></a><span id="l42.62"> </span>
<a href="#l42.63"></a><span id="l42.63">     nsCOMPtr&lt;nsIFile&gt; sourceFile;</span>
<a href="#l42.64"></a><span id="l42.64">     NS_NewNativeLocalFile(unescapedFilePath, true, getter_AddRefs(sourceFile));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -76,18 +76,17 @@ nsMsgCompFields::nsMsgCompFields()</span>
<a href="#l43.4"></a><span id="l43.4">   m_forceMsgEncoding = false;</span>
<a href="#l43.5"></a><span id="l43.5">   m_needToCheckCharset = true;</span>
<a href="#l43.6"></a><span id="l43.6">   m_attachmentReminder = false;</span>
<a href="#l43.7"></a><span id="l43.7">   m_deliveryFormat = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l43.8"></a><span id="l43.8"> </span>
<a href="#l43.9"></a><span id="l43.9">   // Get the default charset from pref, use this as a mail charset.</span>
<a href="#l43.10"></a><span id="l43.10">   nsString charset;</span>
<a href="#l43.11"></a><span id="l43.11">   NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-      nullptr, &quot;mailnews.send_default_charset&quot;, NS_LITERAL_STRING(&quot;UTF-8&quot;),</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-      charset);</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+      nullptr, &quot;mailnews.send_default_charset&quot;, u&quot;UTF-8&quot;_ns, charset);</span>
<a href="#l43.15"></a><span id="l43.15"> </span>
<a href="#l43.16"></a><span id="l43.16">   LossyCopyUTF16toASCII(charset,</span>
<a href="#l43.17"></a><span id="l43.17">                         m_DefaultCharacterSet);  // Charsets better be ASCII</span>
<a href="#l43.18"></a><span id="l43.18">   SetCharacterSet(m_DefaultCharacterSet.get());</span>
<a href="#l43.19"></a><span id="l43.19"> }</span>
<a href="#l43.20"></a><span id="l43.20"> </span>
<a href="#l43.21"></a><span id="l43.21"> nsMsgCompFields::~nsMsgCompFields() {}</span>
<a href="#l43.22"></a><span id="l43.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -290,17 +290,17 @@ nsresult mime_generate_headers(nsIMsgCom</span>
<a href="#l44.4"></a><span id="l44.4">     // Ignore error since we're testing the return value.</span>
<a href="#l44.5"></a><span id="l44.5">     mozilla::Unused &lt;&lt; pHTTPHandler-&gt;GetUserAgent(userAgentString);</span>
<a href="#l44.6"></a><span id="l44.6"> </span>
<a href="#l44.7"></a><span id="l44.7">     if (!userAgentString.IsEmpty())</span>
<a href="#l44.8"></a><span id="l44.8">       finalHeaders-&gt;SetUnstructuredHeader(</span>
<a href="#l44.9"></a><span id="l44.9">           &quot;User-Agent&quot;, NS_ConvertUTF8toUTF16(userAgentString));</span>
<a href="#l44.10"></a><span id="l44.10">   }</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-  finalHeaders-&gt;SetUnstructuredHeader(&quot;MIME-Version&quot;, NS_LITERAL_STRING(&quot;1.0&quot;));</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+  finalHeaders-&gt;SetUnstructuredHeader(&quot;MIME-Version&quot;, u&quot;1.0&quot;_ns);</span>
<a href="#l44.14"></a><span id="l44.14"> </span>
<a href="#l44.15"></a><span id="l44.15">   nsAutoCString newsgroups;</span>
<a href="#l44.16"></a><span id="l44.16">   finalHeaders-&gt;GetRawHeader(&quot;Newsgroups&quot;, newsgroups);</span>
<a href="#l44.17"></a><span id="l44.17">   if (!newsgroups.IsEmpty()) {</span>
<a href="#l44.18"></a><span id="l44.18">     // Since the newsgroup header can contain data in the form of:</span>
<a href="#l44.19"></a><span id="l44.19">     // &quot;news://news.mozilla.org/netscape.test,news://news.mozilla.org/netscape.junk&quot;</span>
<a href="#l44.20"></a><span id="l44.20">     // we need to turn that into: &quot;netscape.test,netscape.junk&quot;</span>
<a href="#l44.21"></a><span id="l44.21">     // (XXX: can it really?)</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineat">@@ -503,19 +503,18 @@ char* mime_generate_attachment_headers(</span>
<a href="#l44.23"></a><span id="l44.23">   nsAutoString realName;</span>
<a href="#l44.24"></a><span id="l44.24">   if (real_name) {</span>
<a href="#l44.25"></a><span id="l44.25">     encodedRealName = RFC2231ParmFolding(&quot;filename&quot;, real_name);</span>
<a href="#l44.26"></a><span id="l44.26">     // somehow RFC2231ParamFolding failed. fall back to legacy method</span>
<a href="#l44.27"></a><span id="l44.27">     if (!encodedRealName || !*encodedRealName) {</span>
<a href="#l44.28"></a><span id="l44.28">       PR_FREEIF(encodedRealName);</span>
<a href="#l44.29"></a><span id="l44.29">       parmFolding = 0;</span>
<a href="#l44.30"></a><span id="l44.30">       // Not RFC 2231 style encoding (it's not standard-compliant)</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-      encodedRealName =</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineminus">-          LegacyParmFolding(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineminus">-                            nsDependentCString(real_name), parmFolding);</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+      encodedRealName = LegacyParmFolding(</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+          &quot;UTF-8&quot;_ns, nsDependentCString(real_name), parmFolding);</span>
<a href="#l44.36"></a><span id="l44.36">     }</span>
<a href="#l44.37"></a><span id="l44.37">   }</span>
<a href="#l44.38"></a><span id="l44.38"> </span>
<a href="#l44.39"></a><span id="l44.39">   nsCString buf;  // very likely to be longer than 64 characters</span>
<a href="#l44.40"></a><span id="l44.40">   buf.AppendLiteral(&quot;Content-Type: &quot;);</span>
<a href="#l44.41"></a><span id="l44.41">   buf.Append(type);</span>
<a href="#l44.42"></a><span id="l44.42">   if (type_param &amp;&amp; *type_param) {</span>
<a href="#l44.43"></a><span id="l44.43">     if (*type_param != ';') buf.AppendLiteral(&quot;; &quot;);</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineat">@@ -601,19 +600,18 @@ char* mime_generate_attachment_headers(</span>
<a href="#l44.45"></a><span id="l44.45">   }</span>
<a href="#l44.46"></a><span id="l44.46"> </span>
<a href="#l44.47"></a><span id="l44.47"> #ifdef EMIT_NAME_IN_CONTENT_TYPE</span>
<a href="#l44.48"></a><span id="l44.48">   if (encodedRealName &amp;&amp; *encodedRealName) {</span>
<a href="#l44.49"></a><span id="l44.49">     // Note that we don't need to output the name field if the name encoding is</span>
<a href="#l44.50"></a><span id="l44.50">     // RFC 2231. If the MUA knows the RFC 2231, it should know the RFC 2183 too.</span>
<a href="#l44.51"></a><span id="l44.51">     if (parmFolding != 2) {</span>
<a href="#l44.52"></a><span id="l44.52">       // The underlying JS MIME code will only handle UTF-8 here.</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineminus">-      char* nameValue =</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineminus">-          LegacyParmFolding(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineminus">-                            nsDependentCString(real_name), parmFolding);</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+      char* nameValue = LegacyParmFolding(</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+          &quot;UTF-8&quot;_ns, nsDependentCString(real_name), parmFolding);</span>
<a href="#l44.58"></a><span id="l44.58">       if (!nameValue || !*nameValue) {</span>
<a href="#l44.59"></a><span id="l44.59">         PR_FREEIF(nameValue);</span>
<a href="#l44.60"></a><span id="l44.60">         nameValue = encodedRealName;</span>
<a href="#l44.61"></a><span id="l44.61">       }</span>
<a href="#l44.62"></a><span id="l44.62">       buf.AppendLiteral(&quot;;\r\n name=\&quot;&quot;);</span>
<a href="#l44.63"></a><span id="l44.63">       buf.Append(nameValue);</span>
<a href="#l44.64"></a><span id="l44.64">       buf.Append('&quot;');</span>
<a href="#l44.65"></a><span id="l44.65">       if (nameValue != encodedRealName) PR_FREEIF(nameValue);</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineat">@@ -1177,28 +1175,25 @@ void msg_pick_real_name(nsMsgAttachmentH</span>
<a href="#l44.67"></a><span id="l44.67">     nsresult rv = attachment-&gt;mURL-&gt;GetSpec(url);</span>
<a href="#l44.68"></a><span id="l44.68">     if (NS_FAILED(rv)) return;</span>
<a href="#l44.69"></a><span id="l44.69"> </span>
<a href="#l44.70"></a><span id="l44.70">     s = url.get();</span>
<a href="#l44.71"></a><span id="l44.71">     s2 = PL_strchr(s, ':');</span>
<a href="#l44.72"></a><span id="l44.72">     if (s2) s = s2 + 1;</span>
<a href="#l44.73"></a><span id="l44.73">     // If we know the URL doesn't have a sensible file name in it,</span>
<a href="#l44.74"></a><span id="l44.74">     // don't bother emitting a content-disposition.</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineminus">-    if (StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;news:&quot;),</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineminus">-                         nsCaseInsensitiveCStringComparator) ||</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineminus">-        StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;snews:&quot;),</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineplus">+    if (StringBeginsWith(url, &quot;news:&quot;_ns, nsCaseInsensitiveCStringComparator) ||</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineplus">+        StringBeginsWith(url, &quot;snews:&quot;_ns,</span>
<a href="#l44.80"></a><span id="l44.80">                          nsCaseInsensitiveCStringComparator) ||</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineminus">-        StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;IMAP:&quot;),</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineminus">-                         nsCaseInsensitiveCStringComparator) ||</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineminus">-        StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;mailbox:&quot;),</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+        StringBeginsWith(url, &quot;IMAP:&quot;_ns, nsCaseInsensitiveCStringComparator) ||</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+        StringBeginsWith(url, &quot;mailbox:&quot;_ns,</span>
<a href="#l44.86"></a><span id="l44.86">                          nsCaseInsensitiveCStringComparator))</span>
<a href="#l44.87"></a><span id="l44.87">       return;</span>
<a href="#l44.88"></a><span id="l44.88"> </span>
<a href="#l44.89"></a><span id="l44.89" class="difflineminus">-    if (StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;data:&quot;),</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineminus">-                         nsCaseInsensitiveCStringComparator)) {</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+    if (StringBeginsWith(url, &quot;data:&quot;_ns, nsCaseInsensitiveCStringComparator)) {</span>
<a href="#l44.92"></a><span id="l44.92">       int32_t endNonData = url.FindChar(',');</span>
<a href="#l44.93"></a><span id="l44.93">       if (endNonData == -1) return;</span>
<a href="#l44.94"></a><span id="l44.94">       nsCString nonDataPart(Substring(url, 5, endNonData - 5));</span>
<a href="#l44.95"></a><span id="l44.95">       int32_t filenamePos = nonDataPart.Find(&quot;filename=&quot;);</span>
<a href="#l44.96"></a><span id="l44.96">       if (filenamePos != -1) {</span>
<a href="#l44.97"></a><span id="l44.97">         filenamePos += 9;</span>
<a href="#l44.98"></a><span id="l44.98">         int32_t endFilename = nonDataPart.FindChar(';', filenamePos);</span>
<a href="#l44.99"></a><span id="l44.99">         if (endFilename == -1) endFilename = endNonData;</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineat">@@ -1275,36 +1270,34 @@ void msg_pick_real_name(nsMsgAttachmentH</span>
<a href="#l44.101"></a><span id="l44.101">     // understand which traditionally has an extension, we just special-</span>
<a href="#l44.102"></a><span id="l44.102">     // case it here!</span>
<a href="#l44.103"></a><span id="l44.103"> </span>
<a href="#l44.104"></a><span id="l44.104">     // Note that it's special-cased in a similar way in libmime/mimei.c.</span>
<a href="#l44.105"></a><span id="l44.105">     if (attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE) ||</span>
<a href="#l44.106"></a><span id="l44.106">         attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE2) ||</span>
<a href="#l44.107"></a><span id="l44.107">         attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE3) ||</span>
<a href="#l44.108"></a><span id="l44.108">         attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE4)) {</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineminus">-      if (StringEndsWith(attachment-&gt;m_realName, NS_LITERAL_CSTRING(&quot;.uu&quot;)))</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+      if (StringEndsWith(attachment-&gt;m_realName, &quot;.uu&quot;_ns))</span>
<a href="#l44.111"></a><span id="l44.111">         attachment-&gt;m_realName.Cut(attachment-&gt;m_realName.Length() - 3, 3);</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineminus">-      else if (StringEndsWith(attachment-&gt;m_realName,</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineminus">-                              NS_LITERAL_CSTRING(&quot;.uue&quot;)))</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+      else if (StringEndsWith(attachment-&gt;m_realName, &quot;.uue&quot;_ns))</span>
<a href="#l44.115"></a><span id="l44.115">         attachment-&gt;m_realName.Cut(attachment-&gt;m_realName.Length() - 4, 4);</span>
<a href="#l44.116"></a><span id="l44.116">     }</span>
<a href="#l44.117"></a><span id="l44.117">   }</span>
<a href="#l44.118"></a><span id="l44.118"> }</span>
<a href="#l44.119"></a><span id="l44.119"> </span>
<a href="#l44.120"></a><span id="l44.120"> // Utility to create a nsIURI object...</span>
<a href="#l44.121"></a><span id="l44.121"> nsresult nsMsgNewURL(nsIURI** aInstancePtrResult, const nsCString&amp; aSpec) {</span>
<a href="#l44.122"></a><span id="l44.122">   nsresult rv = NS_OK;</span>
<a href="#l44.123"></a><span id="l44.123">   if (nullptr == aInstancePtrResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l44.124"></a><span id="l44.124">   nsCOMPtr&lt;nsIIOService&gt; pNetService = mozilla::services::GetIOService();</span>
<a href="#l44.125"></a><span id="l44.125">   NS_ENSURE_TRUE(pNetService, NS_ERROR_UNEXPECTED);</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineminus">-  if (aSpec.Find(&quot;://&quot;) == kNotFound &amp;&amp;</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineminus">-      !StringBeginsWith(aSpec, NS_LITERAL_CSTRING(&quot;data:&quot;))) {</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineplus">+  if (aSpec.Find(&quot;://&quot;) == kNotFound &amp;&amp; !StringBeginsWith(aSpec, &quot;data:&quot;_ns)) {</span>
<a href="#l44.129"></a><span id="l44.129">     // XXXjag Temporary fix for bug 139362 until the real problem(bug 70083) get</span>
<a href="#l44.130"></a><span id="l44.130">     // fixed</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineminus">-    nsAutoCString uri(NS_LITERAL_CSTRING(&quot;http://&quot;));</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+    nsAutoCString uri(&quot;http://&quot;_ns);</span>
<a href="#l44.133"></a><span id="l44.133">     uri.Append(aSpec);</span>
<a href="#l44.134"></a><span id="l44.134">     rv = pNetService-&gt;NewURI(uri, nullptr, nullptr, aInstancePtrResult);</span>
<a href="#l44.135"></a><span id="l44.135">   } else</span>
<a href="#l44.136"></a><span id="l44.136">     rv = pNetService-&gt;NewURI(aSpec, nullptr, nullptr, aInstancePtrResult);</span>
<a href="#l44.137"></a><span id="l44.137">   return rv;</span>
<a href="#l44.138"></a><span id="l44.138"> }</span>
<a href="#l44.139"></a><span id="l44.139"> </span>
<a href="#l44.140"></a><span id="l44.140"> char* nsMsgGetLocalFileFromURL(const char* url) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -468,18 +468,17 @@ nsresult nsMsgCompose::TagEmbeddedObject</span>
<a href="#l45.4"></a><span id="l45.4">     nsCOMPtr&lt;Element&gt; domElement = do_QueryElementAt(aNodeList, i);</span>
<a href="#l45.5"></a><span id="l45.5">     if (!domElement) continue;</span>
<a href="#l45.6"></a><span id="l45.6">     if (IsEmbeddedObjectSafe(originalScheme.get(), originalHost.get(),</span>
<a href="#l45.7"></a><span id="l45.7">                              originalPath.get(), domElement))</span>
<a href="#l45.8"></a><span id="l45.8">       continue;  // Don't need to tag this object, it's safe to send it.</span>
<a href="#l45.9"></a><span id="l45.9"> </span>
<a href="#l45.10"></a><span id="l45.10">     // The source of this object should not be sent with the message.</span>
<a href="#l45.11"></a><span id="l45.11">     IgnoredErrorResult rv2;</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-    domElement-&gt;SetAttribute(NS_LITERAL_STRING(&quot;moz-do-not-send&quot;),</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-                             NS_LITERAL_STRING(&quot;true&quot;), rv2);</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+    domElement-&gt;SetAttribute(u&quot;moz-do-not-send&quot;_ns, u&quot;true&quot;_ns, rv2);</span>
<a href="#l45.15"></a><span id="l45.15">   }</span>
<a href="#l45.16"></a><span id="l45.16"> </span>
<a href="#l45.17"></a><span id="l45.17">   return NS_OK;</span>
<a href="#l45.18"></a><span id="l45.18"> }</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20"> NS_IMETHODIMP</span>
<a href="#l45.21"></a><span id="l45.21"> nsMsgCompose::GetInsertingQuotedContent(bool* aInsertingQuotedText) {</span>
<a href="#l45.22"></a><span id="l45.22">   NS_ENSURE_ARG_POINTER(aInsertingQuotedText);</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineat">@@ -497,18 +496,18 @@ MOZ_CAN_RUN_SCRIPT void nsMsgCompose::In</span>
<a href="#l45.24"></a><span id="l45.24">     const nsAString&amp; aText, const nsAString&amp; classStr) {</span>
<a href="#l45.25"></a><span id="l45.25">   NS_ASSERTION(m_editor,</span>
<a href="#l45.26"></a><span id="l45.26">                &quot;InsertDivWrappedTextAtSelection called, but no editor exists&quot;);</span>
<a href="#l45.27"></a><span id="l45.27">   if (!m_editor) return;</span>
<a href="#l45.28"></a><span id="l45.28"> </span>
<a href="#l45.29"></a><span id="l45.29">   RefPtr&lt;Element&gt; divElem;</span>
<a href="#l45.30"></a><span id="l45.30">   nsCOMPtr&lt;nsIHTMLEditor&gt; htmlEditor(do_QueryInterface(m_editor));</span>
<a href="#l45.31"></a><span id="l45.31"> </span>
<a href="#l45.32"></a><span id="l45.32" class="difflineminus">-  nsresult rv = htmlEditor-&gt;CreateElementWithDefaults(NS_LITERAL_STRING(&quot;div&quot;),</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineminus">-                                                      getter_AddRefs(divElem));</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+  nsresult rv =</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineplus">+      htmlEditor-&gt;CreateElementWithDefaults(u&quot;div&quot;_ns, getter_AddRefs(divElem));</span>
<a href="#l45.36"></a><span id="l45.36"> </span>
<a href="#l45.37"></a><span id="l45.37">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l45.38"></a><span id="l45.38"> </span>
<a href="#l45.39"></a><span id="l45.39">   // We need the document</span>
<a href="#l45.40"></a><span id="l45.40">   nsCOMPtr&lt;Document&gt; doc;</span>
<a href="#l45.41"></a><span id="l45.41">   rv = m_editor-&gt;GetDocument(getter_AddRefs(doc));</span>
<a href="#l45.42"></a><span id="l45.42">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l45.43"></a><span id="l45.43"> </span>
<a href="#l45.44"></a><span id="l45.44" class="difflineat">@@ -527,18 +526,18 @@ MOZ_CAN_RUN_SCRIPT void nsMsgCompose::In</span>
<a href="#l45.45"></a><span id="l45.45">     IgnoredErrorResult rv2;</span>
<a href="#l45.46"></a><span id="l45.46">     divElem-&gt;AppendChild(*textNode, rv2);</span>
<a href="#l45.47"></a><span id="l45.47">     if (rv2.Failed()) {</span>
<a href="#l45.48"></a><span id="l45.48">       return;</span>
<a href="#l45.49"></a><span id="l45.49">     }</span>
<a href="#l45.50"></a><span id="l45.50"> </span>
<a href="#l45.51"></a><span id="l45.51">     // Now create and insert a BR</span>
<a href="#l45.52"></a><span id="l45.52">     RefPtr&lt;Element&gt; brElem;</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineminus">-    rv = htmlEditor-&gt;CreateElementWithDefaults(NS_LITERAL_STRING(&quot;br&quot;),</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineminus">-                                               getter_AddRefs(brElem));</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineplus">+    rv =</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineplus">+        htmlEditor-&gt;CreateElementWithDefaults(u&quot;br&quot;_ns, getter_AddRefs(brElem));</span>
<a href="#l45.57"></a><span id="l45.57">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l45.58"></a><span id="l45.58">     divElem-&gt;AppendChild(*brElem, rv2);</span>
<a href="#l45.59"></a><span id="l45.59">     if (rv2.Failed()) {</span>
<a href="#l45.60"></a><span id="l45.60">       return;</span>
<a href="#l45.61"></a><span id="l45.61">     }</span>
<a href="#l45.62"></a><span id="l45.62"> </span>
<a href="#l45.63"></a><span id="l45.63">     if (delimiter == end) break;</span>
<a href="#l45.64"></a><span id="l45.64">     start = ++delimiter;</span>
<a href="#l45.65"></a><span id="l45.65" class="difflineat">@@ -554,17 +553,17 @@ MOZ_CAN_RUN_SCRIPT void nsMsgCompose::In</span>
<a href="#l45.66"></a><span id="l45.66">     RefPtr&lt;Selection&gt; selection;</span>
<a href="#l45.67"></a><span id="l45.67">     m_editor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l45.68"></a><span id="l45.68"> </span>
<a href="#l45.69"></a><span id="l45.69">     if (selection) selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l45.70"></a><span id="l45.70">   }</span>
<a href="#l45.71"></a><span id="l45.71">   if (divElem) {</span>
<a href="#l45.72"></a><span id="l45.72">     RefPtr&lt;Element&gt; divElem2 = divElem;</span>
<a href="#l45.73"></a><span id="l45.73">     IgnoredErrorResult rv2;</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineminus">-    divElem2-&gt;SetAttribute(NS_LITERAL_STRING(&quot;class&quot;), classStr, rv2);</span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+    divElem2-&gt;SetAttribute(u&quot;class&quot;_ns, classStr, rv2);</span>
<a href="#l45.76"></a><span id="l45.76">   }</span>
<a href="#l45.77"></a><span id="l45.77"> }</span>
<a href="#l45.78"></a><span id="l45.78"> </span>
<a href="#l45.79"></a><span id="l45.79"> /*</span>
<a href="#l45.80"></a><span id="l45.80">  * The following function replaces &lt;plaintext&gt; tags with &lt;x-plaintext&gt;.</span>
<a href="#l45.81"></a><span id="l45.81">  * &lt;plaintext&gt; is a funny beast: It leads to everything following it</span>
<a href="#l45.82"></a><span id="l45.82">  * being displayed verbatim, even a &lt;/plaintext&gt; tag is ignored.</span>
<a href="#l45.83"></a><span id="l45.83">  */</span>
<a href="#l45.84"></a><span id="l45.84" class="difflineat">@@ -659,18 +658,17 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l45.85"></a><span id="l45.85">             htmlEditor-&gt;InsertLineBreak();</span>
<a href="#l45.86"></a><span id="l45.86">           else {</span>
<a href="#l45.87"></a><span id="l45.87">             htmlEditor-&gt;InsertLineBreak();</span>
<a href="#l45.88"></a><span id="l45.88">             htmlEditor-&gt;InsertLineBreak();</span>
<a href="#l45.89"></a><span id="l45.89">           }</span>
<a href="#l45.90"></a><span id="l45.90">         }</span>
<a href="#l45.91"></a><span id="l45.91">       }</span>
<a href="#l45.92"></a><span id="l45.92"> </span>
<a href="#l45.93"></a><span id="l45.93" class="difflineminus">-      InsertDivWrappedTextAtSelection(aPrefix,</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineminus">-                                      NS_LITERAL_STRING(&quot;moz-cite-prefix&quot;));</span>
<a href="#l45.95"></a><span id="l45.95" class="difflineplus">+      InsertDivWrappedTextAtSelection(aPrefix, u&quot;moz-cite-prefix&quot;_ns);</span>
<a href="#l45.96"></a><span id="l45.96">     }</span>
<a href="#l45.97"></a><span id="l45.97"> </span>
<a href="#l45.98"></a><span id="l45.98">     if (!aBuf.IsEmpty()) {</span>
<a href="#l45.99"></a><span id="l45.99">       // This leaves the caret at the right place to insert a bottom signature.</span>
<a href="#l45.100"></a><span id="l45.100">       if (aHTMLEditor) {</span>
<a href="#l45.101"></a><span id="l45.101">         nsAutoString body(aBuf);</span>
<a href="#l45.102"></a><span id="l45.102">         remove_plaintext_tag(body);</span>
<a href="#l45.103"></a><span id="l45.103">         htmlEditor-&gt;InsertAsCitedQuotation(body, mCiteReference, true,</span>
<a href="#l45.104"></a><span id="l45.104" class="difflineat">@@ -688,18 +686,17 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l45.105"></a><span id="l45.105">       // we cannot add it on top earlier, because TagEmbeddedObjects will mark</span>
<a href="#l45.106"></a><span id="l45.106">       // all images in the signature as &quot;moz-do-not-send&quot;</span>
<a href="#l45.107"></a><span id="l45.107">       if (sigOnTop) MoveToBeginningOfDocument();</span>
<a href="#l45.108"></a><span id="l45.108"> </span>
<a href="#l45.109"></a><span id="l45.109">       if (aHTMLEditor)</span>
<a href="#l45.110"></a><span id="l45.110">         htmlEditor-&gt;InsertHTML(aSignature);</span>
<a href="#l45.111"></a><span id="l45.111">       else {</span>
<a href="#l45.112"></a><span id="l45.112">         htmlEditor-&gt;InsertLineBreak();</span>
<a href="#l45.113"></a><span id="l45.113" class="difflineminus">-        InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l45.114"></a><span id="l45.114" class="difflineminus">-                                        NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l45.115"></a><span id="l45.115" class="difflineplus">+        InsertDivWrappedTextAtSelection(aSignature, u&quot;moz-signature&quot;_ns);</span>
<a href="#l45.116"></a><span id="l45.116">       }</span>
<a href="#l45.117"></a><span id="l45.117"> </span>
<a href="#l45.118"></a><span id="l45.118">       if (sigOnTop) htmlEditor-&gt;EndOfDocument();</span>
<a href="#l45.119"></a><span id="l45.119">     }</span>
<a href="#l45.120"></a><span id="l45.120">   } else {</span>
<a href="#l45.121"></a><span id="l45.121">     if (aHTMLEditor) {</span>
<a href="#l45.122"></a><span id="l45.122">       mInsertingQuotedContent = true;</span>
<a href="#l45.123"></a><span id="l45.123">       if (isForwarded &amp;&amp;</span>
<a href="#l45.124"></a><span id="l45.124" class="difflineat">@@ -751,43 +748,42 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l45.125"></a><span id="l45.125">         htmlEditor-&gt;InsertHTML(aSignature);</span>
<a href="#l45.126"></a><span id="l45.126">         if (isForwarded &amp;&amp; sigOnTop) htmlEditor-&gt;EndOfDocument();</span>
<a href="#l45.127"></a><span id="l45.127">       } else</span>
<a href="#l45.128"></a><span id="l45.128">         htmlEditor-&gt;EndOfDocument();</span>
<a href="#l45.129"></a><span id="l45.129">     } else {</span>
<a href="#l45.130"></a><span id="l45.130">       bool sigOnTopInserted = false;</span>
<a href="#l45.131"></a><span id="l45.131">       if (isForwarded &amp;&amp; sigOnTop &amp;&amp; !aSignature.IsEmpty()) {</span>
<a href="#l45.132"></a><span id="l45.132">         htmlEditor-&gt;InsertLineBreak();</span>
<a href="#l45.133"></a><span id="l45.133" class="difflineminus">-        InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l45.134"></a><span id="l45.134" class="difflineminus">-                                        NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l45.135"></a><span id="l45.135" class="difflineplus">+        InsertDivWrappedTextAtSelection(aSignature, u&quot;moz-signature&quot;_ns);</span>
<a href="#l45.136"></a><span id="l45.136">         htmlEditor-&gt;EndOfDocument();</span>
<a href="#l45.137"></a><span id="l45.137">         sigOnTopInserted = true;</span>
<a href="#l45.138"></a><span id="l45.138">       }</span>
<a href="#l45.139"></a><span id="l45.139"> </span>
<a href="#l45.140"></a><span id="l45.140">       if (!aBuf.IsEmpty()) {</span>
<a href="#l45.141"></a><span id="l45.141">         nsresult rv;</span>
<a href="#l45.142"></a><span id="l45.142">         RefPtr&lt;Element&gt; divElem;</span>
<a href="#l45.143"></a><span id="l45.143">         RefPtr&lt;Element&gt; extraBr;</span>
<a href="#l45.144"></a><span id="l45.144"> </span>
<a href="#l45.145"></a><span id="l45.145">         if (isForwarded) {</span>
<a href="#l45.146"></a><span id="l45.146">           // Special treatment for forwarded messages: Part 1.</span>
<a href="#l45.147"></a><span id="l45.147">           // Create a &lt;div&gt; of the required class.</span>
<a href="#l45.148"></a><span id="l45.148" class="difflineminus">-          rv = htmlEditor-&gt;CreateElementWithDefaults(NS_LITERAL_STRING(&quot;div&quot;),</span>
<a href="#l45.149"></a><span id="l45.149" class="difflineplus">+          rv = htmlEditor-&gt;CreateElementWithDefaults(u&quot;div&quot;_ns,</span>
<a href="#l45.150"></a><span id="l45.150">                                                      getter_AddRefs(divElem));</span>
<a href="#l45.151"></a><span id="l45.151">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l45.152"></a><span id="l45.152"> </span>
<a href="#l45.153"></a><span id="l45.153">           nsAutoString attributeName;</span>
<a href="#l45.154"></a><span id="l45.154">           nsAutoString attributeValue;</span>
<a href="#l45.155"></a><span id="l45.155">           attributeName.AssignLiteral(&quot;class&quot;);</span>
<a href="#l45.156"></a><span id="l45.156">           attributeValue.AssignLiteral(&quot;moz-forward-container&quot;);</span>
<a href="#l45.157"></a><span id="l45.157">           IgnoredErrorResult rv1;</span>
<a href="#l45.158"></a><span id="l45.158">           divElem-&gt;SetAttribute(attributeName, attributeValue, rv1);</span>
<a href="#l45.159"></a><span id="l45.159"> </span>
<a href="#l45.160"></a><span id="l45.160">           // We can't insert an empty &lt;div&gt;, so fill it with something.</span>
<a href="#l45.161"></a><span id="l45.161" class="difflineminus">-          rv = htmlEditor-&gt;CreateElementWithDefaults(NS_LITERAL_STRING(&quot;br&quot;),</span>
<a href="#l45.162"></a><span id="l45.162" class="difflineplus">+          rv = htmlEditor-&gt;CreateElementWithDefaults(u&quot;br&quot;_ns,</span>
<a href="#l45.163"></a><span id="l45.163">                                                      getter_AddRefs(extraBr));</span>
<a href="#l45.164"></a><span id="l45.164">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l45.165"></a><span id="l45.165"> </span>
<a href="#l45.166"></a><span id="l45.166">           ErrorResult rv2;</span>
<a href="#l45.167"></a><span id="l45.167">           divElem-&gt;AppendChild(*extraBr, rv2);</span>
<a href="#l45.168"></a><span id="l45.168">           if (rv2.Failed()) {</span>
<a href="#l45.169"></a><span id="l45.169">             return rv2.StealNSResult();</span>
<a href="#l45.170"></a><span id="l45.170">           }</span>
<a href="#l45.171"></a><span id="l45.171" class="difflineat">@@ -833,18 +829,17 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l45.172"></a><span id="l45.172">         // It's OK to use, even if we're not forwarding and didn't create a</span>
<a href="#l45.173"></a><span id="l45.173">         // &lt;div&gt;.</span>
<a href="#l45.174"></a><span id="l45.174">         rv = MoveToEndOfDocument();</span>
<a href="#l45.175"></a><span id="l45.175">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l45.176"></a><span id="l45.176">       }</span>
<a href="#l45.177"></a><span id="l45.177"> </span>
<a href="#l45.178"></a><span id="l45.178">       if ((!isForwarded || !sigOnTop) &amp;&amp; !aSignature.IsEmpty()) {</span>
<a href="#l45.179"></a><span id="l45.179">         htmlEditor-&gt;InsertLineBreak();</span>
<a href="#l45.180"></a><span id="l45.180" class="difflineminus">-        InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l45.181"></a><span id="l45.181" class="difflineminus">-                                        NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l45.182"></a><span id="l45.182" class="difflineplus">+        InsertDivWrappedTextAtSelection(aSignature, u&quot;moz-signature&quot;_ns);</span>
<a href="#l45.183"></a><span id="l45.183">       }</span>
<a href="#l45.184"></a><span id="l45.184">     }</span>
<a href="#l45.185"></a><span id="l45.185">   }</span>
<a href="#l45.186"></a><span id="l45.186"> </span>
<a href="#l45.187"></a><span id="l45.187">   if (aBuf.IsEmpty())</span>
<a href="#l45.188"></a><span id="l45.188">     htmlEditor-&gt;BeginningOfDocument();</span>
<a href="#l45.189"></a><span id="l45.189">   else {</span>
<a href="#l45.190"></a><span id="l45.190">     switch (reply_on_top) {</span>
<a href="#l45.191"></a><span id="l45.191" class="difflineat">@@ -1234,18 +1229,17 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l45.192"></a><span id="l45.192"> </span>
<a href="#l45.193"></a><span id="l45.193">   // i'm assuming the compose window is still up at this point...</span>
<a href="#l45.194"></a><span id="l45.194">   if (m_window) {</span>
<a href="#l45.195"></a><span id="l45.195">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(m_window);</span>
<a href="#l45.196"></a><span id="l45.196">     window-&gt;GetPrompter(getter_AddRefs(prompt));</span>
<a href="#l45.197"></a><span id="l45.197">   }</span>
<a href="#l45.198"></a><span id="l45.198"> </span>
<a href="#l45.199"></a><span id="l45.199">   // Set content type based on which type of compose window we had.</span>
<a href="#l45.200"></a><span id="l45.200" class="difflineminus">-  nsString contentType = (m_composeHTML) ? NS_LITERAL_STRING(&quot;text/html&quot;)</span>
<a href="#l45.201"></a><span id="l45.201" class="difflineminus">-                                         : NS_LITERAL_STRING(&quot;text/plain&quot;);</span>
<a href="#l45.202"></a><span id="l45.202" class="difflineplus">+  nsString contentType = (m_composeHTML) ? u&quot;text/html&quot;_ns : u&quot;text/plain&quot;_ns;</span>
<a href="#l45.203"></a><span id="l45.203">   nsString msgBody;</span>
<a href="#l45.204"></a><span id="l45.204">   const char* charset = m_compFields-&gt;GetCharacterSet();</span>
<a href="#l45.205"></a><span id="l45.205">   if (m_editor) {</span>
<a href="#l45.206"></a><span id="l45.206">     // Reset message body previously stored in the compose fields</span>
<a href="#l45.207"></a><span id="l45.207">     // There is 2 nsIMsgCompFields::SetBody() functions using a pointer as</span>
<a href="#l45.208"></a><span id="l45.208">     // argument, therefore a casting is required.</span>
<a href="#l45.209"></a><span id="l45.209">     m_compFields-&gt;SetBody((const char*)nullptr);</span>
<a href="#l45.210"></a><span id="l45.210"> </span>
<a href="#l45.211"></a><span id="l45.211" class="difflineat">@@ -1268,18 +1262,17 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l45.212"></a><span id="l45.212">     }</span>
<a href="#l45.213"></a><span id="l45.213">     rv = m_editor-&gt;OutputToString(contentType, flags, msgBody);</span>
<a href="#l45.214"></a><span id="l45.214">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l45.215"></a><span id="l45.215">   } else {</span>
<a href="#l45.216"></a><span id="l45.216">     m_compFields-&gt;GetBody(msgBody);</span>
<a href="#l45.217"></a><span id="l45.217">   }</span>
<a href="#l45.218"></a><span id="l45.218">   if (!msgBody.IsEmpty()) {</span>
<a href="#l45.219"></a><span id="l45.219">     // Ensure body ends in CRLF to avoid SMTP server timeout when sent.</span>
<a href="#l45.220"></a><span id="l45.220" class="difflineminus">-    if (!StringEndsWith(msgBody, NS_LITERAL_STRING(&quot;\r\n&quot;)))</span>
<a href="#l45.221"></a><span id="l45.221" class="difflineminus">-      msgBody.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l45.222"></a><span id="l45.222" class="difflineplus">+    if (!StringEndsWith(msgBody, u&quot;\r\n&quot;_ns)) msgBody.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l45.223"></a><span id="l45.223">     bool isAsciiOnly = mozilla::IsAsciiNullTerminated(</span>
<a href="#l45.224"></a><span id="l45.224">         static_cast&lt;const char16_t*&gt;(msgBody.get()));</span>
<a href="#l45.225"></a><span id="l45.225">     // Convert body to mail charset</span>
<a href="#l45.226"></a><span id="l45.226">     nsCString outCString;</span>
<a href="#l45.227"></a><span id="l45.227">     rv = nsMsgI18NConvertFromUnicode(</span>
<a href="#l45.228"></a><span id="l45.228">         charset ? nsDependentCString(charset) : EmptyCString(), msgBody,</span>
<a href="#l45.229"></a><span id="l45.229">         outCString, true);</span>
<a href="#l45.230"></a><span id="l45.230">     if (m_compFields-&gt;GetForceMsgEncoding()) isAsciiOnly = false;</span>
<a href="#l45.231"></a><span id="l45.231" class="difflineat">@@ -1378,17 +1371,17 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l45.232"></a><span id="l45.232">         // Eudora, which saves off the attachments separately from the message</span>
<a href="#l45.233"></a><span id="l45.233">         // body</span>
<a href="#l45.234"></a><span id="l45.234">         nsCString userid;</span>
<a href="#l45.235"></a><span id="l45.235">         (void)identity-&gt;GetEmail(userid);</span>
<a href="#l45.236"></a><span id="l45.236">         int32_t index = userid.FindChar('@');</span>
<a href="#l45.237"></a><span id="l45.237">         if (index != kNotFound) userid.SetLength(index);</span>
<a href="#l45.238"></a><span id="l45.238"> </span>
<a href="#l45.239"></a><span id="l45.239">         if (userid.IsEmpty())</span>
<a href="#l45.240"></a><span id="l45.240" class="difflineminus">-          attachment-&gt;SetName(NS_LITERAL_STRING(&quot;vcard.vcf&quot;));</span>
<a href="#l45.241"></a><span id="l45.241" class="difflineplus">+          attachment-&gt;SetName(u&quot;vcard.vcf&quot;_ns);</span>
<a href="#l45.242"></a><span id="l45.242">         else {</span>
<a href="#l45.243"></a><span id="l45.243">           // Replace any dot with underscore to stop vCards</span>
<a href="#l45.244"></a><span id="l45.244">           // generating false positives with some heuristic scanners</span>
<a href="#l45.245"></a><span id="l45.245">           userid.ReplaceChar('.', '_');</span>
<a href="#l45.246"></a><span id="l45.246">           userid.AppendLiteral(&quot;.vcf&quot;);</span>
<a href="#l45.247"></a><span id="l45.247">           attachment-&gt;SetName(NS_ConvertASCIItoUTF16(userid));</span>
<a href="#l45.248"></a><span id="l45.248">         }</span>
<a href="#l45.249"></a><span id="l45.249"> </span>
<a href="#l45.250"></a><span id="l45.250" class="difflineat">@@ -1528,26 +1521,25 @@ static nsresult fixCharset(nsCString&amp; aC</span>
<a href="#l45.251"></a><span id="l45.251"> </span>
<a href="#l45.252"></a><span id="l45.252">   // Replace an unrecognized charset with the default.</span>
<a href="#l45.253"></a><span id="l45.253">   if (NS_FAILED(rv)) {</span>
<a href="#l45.254"></a><span id="l45.254">     nsCOMPtr&lt;nsIPrefBranch&gt; prefs(</span>
<a href="#l45.255"></a><span id="l45.255">         do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l45.256"></a><span id="l45.256">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l45.257"></a><span id="l45.257">     nsString defaultCharset;</span>
<a href="#l45.258"></a><span id="l45.258">     NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l45.259"></a><span id="l45.259" class="difflineminus">-        prefs, &quot;mailnews.send_default_charset&quot;, NS_LITERAL_STRING(&quot;UTF-8&quot;),</span>
<a href="#l45.260"></a><span id="l45.260" class="difflineminus">-        defaultCharset);</span>
<a href="#l45.261"></a><span id="l45.261" class="difflineplus">+        prefs, &quot;mailnews.send_default_charset&quot;, u&quot;UTF-8&quot;_ns, defaultCharset);</span>
<a href="#l45.262"></a><span id="l45.262">     LossyCopyUTF16toASCII(defaultCharset, aCharset);</span>
<a href="#l45.263"></a><span id="l45.263">     return NS_OK;</span>
<a href="#l45.264"></a><span id="l45.264">   }</span>
<a href="#l45.265"></a><span id="l45.265"> </span>
<a href="#l45.266"></a><span id="l45.266">   // Don't accept UTF-16 ever. UTF-16 should never be selected as an</span>
<a href="#l45.267"></a><span id="l45.267">   // outgoing encoding for e-mail. MIME can't handle those messages</span>
<a href="#l45.268"></a><span id="l45.268">   // encoded in ASCII-incompatible encodings.</span>
<a href="#l45.269"></a><span id="l45.269" class="difflineminus">-  if (StringBeginsWith(aCharset, NS_LITERAL_CSTRING(&quot;UTF-16&quot;))) {</span>
<a href="#l45.270"></a><span id="l45.270" class="difflineplus">+  if (StringBeginsWith(aCharset, &quot;UTF-16&quot;_ns)) {</span>
<a href="#l45.271"></a><span id="l45.271">     aCharset.AssignLiteral(&quot;UTF-8&quot;);</span>
<a href="#l45.272"></a><span id="l45.272">   }</span>
<a href="#l45.273"></a><span id="l45.273">   return NS_OK;</span>
<a href="#l45.274"></a><span id="l45.274"> }</span>
<a href="#l45.275"></a><span id="l45.275"> </span>
<a href="#l45.276"></a><span id="l45.276"> // This used to be called BEFORE editor was created</span>
<a href="#l45.277"></a><span id="l45.277"> //  (it did the loadURI that triggered editor creation)</span>
<a href="#l45.278"></a><span id="l45.278"> // It is called from JS after editor creation</span>
<a href="#l45.279"></a><span id="l45.279" class="difflineat">@@ -1657,17 +1649,17 @@ nsresult nsMsgCompose::CreateMessage(con</span>
<a href="#l45.280"></a><span id="l45.280">                                      MSG_ComposeType type,</span>
<a href="#l45.281"></a><span id="l45.281">                                      nsIMsgCompFields* compFields) {</span>
<a href="#l45.282"></a><span id="l45.282">   nsresult rv = NS_OK;</span>
<a href="#l45.283"></a><span id="l45.283">   mType = type;</span>
<a href="#l45.284"></a><span id="l45.284">   mDraftDisposition = nsIMsgFolder::nsMsgDispositionState_None;</span>
<a href="#l45.285"></a><span id="l45.285"> </span>
<a href="#l45.286"></a><span id="l45.286">   mDeleteDraft = (type == nsIMsgCompType::Draft);</span>
<a href="#l45.287"></a><span id="l45.287">   nsAutoCString msgUri(originalMsgURI);</span>
<a href="#l45.288"></a><span id="l45.288" class="difflineminus">-  bool fileUrl = StringBeginsWith(msgUri, NS_LITERAL_CSTRING(&quot;file:&quot;));</span>
<a href="#l45.289"></a><span id="l45.289" class="difflineplus">+  bool fileUrl = StringBeginsWith(msgUri, &quot;file:&quot;_ns);</span>
<a href="#l45.290"></a><span id="l45.290">   int32_t typeIndex = msgUri.Find(&quot;type=application/x-message-display&quot;);</span>
<a href="#l45.291"></a><span id="l45.291">   if (typeIndex != kNotFound &amp;&amp; typeIndex &gt; 0) {</span>
<a href="#l45.292"></a><span id="l45.292">     // Strip out type=application/x-message-display because it confuses libmime.</span>
<a href="#l45.293"></a><span id="l45.293">     msgUri.Cut(typeIndex, sizeof(&quot;type=application/x-message-display&quot;));</span>
<a href="#l45.294"></a><span id="l45.294">     if (fileUrl)  // we're dealing with an .eml file msg</span>
<a href="#l45.295"></a><span id="l45.295">     {</span>
<a href="#l45.296"></a><span id="l45.296">       // We have now removed the type from the uri. Make sure we don't have</span>
<a href="#l45.297"></a><span id="l45.297">       // an uri with &quot;&amp;&amp;&quot; now. If we do, remove the second '&amp;'.</span>
<a href="#l45.298"></a><span id="l45.298" class="difflineat">@@ -1918,17 +1910,17 @@ nsresult nsMsgCompose::CreateMessage(con</span>
<a href="#l45.299"></a><span id="l45.299">       if (isFirstPass &amp;&amp; !charset.IsEmpty())</span>
<a href="#l45.300"></a><span id="l45.300">         m_compFields-&gt;SetCharacterSet(charset.get());</span>
<a href="#l45.301"></a><span id="l45.301"> </span>
<a href="#l45.302"></a><span id="l45.302">       nsString subject;</span>
<a href="#l45.303"></a><span id="l45.303">       rv = msgHdr-&gt;GetMime2DecodedSubject(subject);</span>
<a href="#l45.304"></a><span id="l45.304">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l45.305"></a><span id="l45.305"> </span>
<a href="#l45.306"></a><span id="l45.306">       // Check if (was: is present in the subject</span>
<a href="#l45.307"></a><span id="l45.307" class="difflineminus">-      int32_t wasOffset = subject.RFind(NS_LITERAL_STRING(&quot; (was:&quot;));</span>
<a href="#l45.308"></a><span id="l45.308" class="difflineplus">+      int32_t wasOffset = subject.RFind(u&quot; (was:&quot;_ns);</span>
<a href="#l45.309"></a><span id="l45.309">       bool strip = true;</span>
<a href="#l45.310"></a><span id="l45.310"> </span>
<a href="#l45.311"></a><span id="l45.311">       if (wasOffset &gt;= 0) {</span>
<a href="#l45.312"></a><span id="l45.312">         // Check the number of references, to check if was: should be stripped</span>
<a href="#l45.313"></a><span id="l45.313">         // First, assume that it should be stripped; the variable will be set to</span>
<a href="#l45.314"></a><span id="l45.314">         // false later if stripping should not happen.</span>
<a href="#l45.315"></a><span id="l45.315">         uint16_t numRef;</span>
<a href="#l45.316"></a><span id="l45.316">         msgHdr-&gt;GetNumReferences(&amp;numRef);</span>
<a href="#l45.317"></a><span id="l45.317" class="difflineat">@@ -3006,19 +2998,19 @@ nsresult nsMsgCompose::QuoteOriginalMess</span>
<a href="#l45.318"></a><span id="l45.318"> </span>
<a href="#l45.319"></a><span id="l45.319">   nsCOMPtr&lt;nsIMsgDBHdr&gt; originalMsgHdr = mOrigMsgHdr;</span>
<a href="#l45.320"></a><span id="l45.320">   if (!originalMsgHdr) {</span>
<a href="#l45.321"></a><span id="l45.321">     rv = GetMsgDBHdrFromURI(mOriginalMsgURI.get(),</span>
<a href="#l45.322"></a><span id="l45.322">                             getter_AddRefs(originalMsgHdr));</span>
<a href="#l45.323"></a><span id="l45.323">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l45.324"></a><span id="l45.324">   }</span>
<a href="#l45.325"></a><span id="l45.325"> </span>
<a href="#l45.326"></a><span id="l45.326" class="difflineminus">-  bool fileUrl = StringBeginsWith(mOriginalMsgURI, NS_LITERAL_CSTRING(&quot;file:&quot;));</span>
<a href="#l45.327"></a><span id="l45.327" class="difflineplus">+  bool fileUrl = StringBeginsWith(mOriginalMsgURI, &quot;file:&quot;_ns);</span>
<a href="#l45.328"></a><span id="l45.328">   if (fileUrl) {</span>
<a href="#l45.329"></a><span id="l45.329" class="difflineminus">-    mOriginalMsgURI.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l45.330"></a><span id="l45.330" class="difflineplus">+    mOriginalMsgURI.Replace(0, 5, &quot;mailbox:&quot;_ns);</span>
<a href="#l45.331"></a><span id="l45.331">     mOriginalMsgURI.AppendLiteral(&quot;?number=0&quot;);</span>
<a href="#l45.332"></a><span id="l45.332">   }</span>
<a href="#l45.333"></a><span id="l45.333"> </span>
<a href="#l45.334"></a><span id="l45.334">   // Create the consumer output stream.. this will receive all the HTML from</span>
<a href="#l45.335"></a><span id="l45.335">   // libmime</span>
<a href="#l45.336"></a><span id="l45.336">   mQuoteStreamListener = new QuotingOutputStreamListener(</span>
<a href="#l45.337"></a><span id="l45.337">       mOriginalMsgURI.get(), originalMsgHdr, mWhatHolder != 1,</span>
<a href="#l45.338"></a><span id="l45.338">       !bAutoQuote || !mHtmlToQuote.IsEmpty(), m_identity, mQuote,</span>
<a href="#l45.339"></a><span id="l45.339" class="difflineat">@@ -4068,18 +4060,17 @@ nsresult nsMsgCompose::ProcessSignature(</span>
<a href="#l45.340"></a><span id="l45.340">             // type is for this signature...if we can't, we assume text</span>
<a href="#l45.341"></a><span id="l45.341">             nsAutoCString sigContentType;</span>
<a href="#l45.342"></a><span id="l45.342">             nsresult rv2;  // don't want to clobber the other rv</span>
<a href="#l45.343"></a><span id="l45.343">             nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(</span>
<a href="#l45.344"></a><span id="l45.344">                 do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv2));</span>
<a href="#l45.345"></a><span id="l45.345">             if (NS_SUCCEEDED(rv2)) {</span>
<a href="#l45.346"></a><span id="l45.346">               rv2 = mimeFinder-&gt;GetTypeFromFile(sigFile, sigContentType);</span>
<a href="#l45.347"></a><span id="l45.347">               if (NS_SUCCEEDED(rv2)) {</span>
<a href="#l45.348"></a><span id="l45.348" class="difflineminus">-                if (StringBeginsWith(sigContentType,</span>
<a href="#l45.349"></a><span id="l45.349" class="difflineminus">-                                     NS_LITERAL_CSTRING(&quot;image/&quot;),</span>
<a href="#l45.350"></a><span id="l45.350" class="difflineplus">+                if (StringBeginsWith(sigContentType, &quot;image/&quot;_ns,</span>
<a href="#l45.351"></a><span id="l45.351">                                      nsCaseInsensitiveCStringComparator))</span>
<a href="#l45.352"></a><span id="l45.352">                   imageSig = true;</span>
<a href="#l45.353"></a><span id="l45.353">                 else if (sigContentType.Equals(</span>
<a href="#l45.354"></a><span id="l45.354">                              TEXT_HTML, nsCaseInsensitiveCStringComparator))</span>
<a href="#l45.355"></a><span id="l45.355">                   htmlSig = true;</span>
<a href="#l45.356"></a><span id="l45.356">               }</span>
<a href="#l45.357"></a><span id="l45.357">             }</span>
<a href="#l45.358"></a><span id="l45.358">           }</span>
<a href="#l45.359"></a><span id="l45.359" class="difflineat">@@ -4293,17 +4284,17 @@ nsresult nsMsgCompose::BuildBodyMessageA</span>
<a href="#l45.360"></a><span id="l45.360">   nsAutoString tSignature;</span>
<a href="#l45.361"></a><span id="l45.361">   if (addSignature) ProcessSignature(m_identity, isQuoted, &amp;tSignature);</span>
<a href="#l45.362"></a><span id="l45.362"> </span>
<a href="#l45.363"></a><span id="l45.363">   // if type is new, but we have body, this is probably a mapi send, so we need</span>
<a href="#l45.364"></a><span id="l45.364">   // to replace '\n' with &lt;br&gt; so that the line breaks won't be lost by html. if</span>
<a href="#l45.365"></a><span id="l45.365">   // mailtourl, do the same.</span>
<a href="#l45.366"></a><span id="l45.366">   if (m_composeHTML &amp;&amp;</span>
<a href="#l45.367"></a><span id="l45.367">       (mType == nsIMsgCompType::New || mType == nsIMsgCompType::MailToUrl))</span>
<a href="#l45.368"></a><span id="l45.368" class="difflineminus">-    body.ReplaceSubstring(NS_LITERAL_STRING(&quot;\n&quot;), NS_LITERAL_STRING(&quot;&lt;br&gt;&quot;));</span>
<a href="#l45.369"></a><span id="l45.369" class="difflineplus">+    body.ReplaceSubstring(u&quot;\n&quot;_ns, u&quot;&lt;br&gt;&quot;_ns);</span>
<a href="#l45.370"></a><span id="l45.370"> </span>
<a href="#l45.371"></a><span id="l45.371">   // Restore flowed text wrapping for Drafts/Templates.</span>
<a href="#l45.372"></a><span id="l45.372">   // Look for unquoted lines - if we have an unquoted line</span>
<a href="#l45.373"></a><span id="l45.373">   // that ends in a space, join this line with the next one</span>
<a href="#l45.374"></a><span id="l45.374">   // by removing the end of line char(s).</span>
<a href="#l45.375"></a><span id="l45.375">   int32_t wrapping_enabled = 0;</span>
<a href="#l45.376"></a><span id="l45.376">   GetWrapLength(&amp;wrapping_enabled);</span>
<a href="#l45.377"></a><span id="l45.377">   if (!m_composeHTML &amp;&amp; wrapping_enabled) {</span>
<a href="#l45.378"></a><span id="l45.378" class="difflineat">@@ -4311,23 +4302,23 @@ nsresult nsMsgCompose::BuildBodyMessageA</span>
<a href="#l45.379"></a><span id="l45.379">     for (uint32_t i = 0; i &lt; body.Length(); i++) {</span>
<a href="#l45.380"></a><span id="l45.380">       if (i == 0 || body[i - 1] == '\n')  // newline</span>
<a href="#l45.381"></a><span id="l45.381">       {</span>
<a href="#l45.382"></a><span id="l45.382">         if (body[i] == '&gt;') {</span>
<a href="#l45.383"></a><span id="l45.383">           quote = true;</span>
<a href="#l45.384"></a><span id="l45.384">           continue;</span>
<a href="#l45.385"></a><span id="l45.385">         }</span>
<a href="#l45.386"></a><span id="l45.386">         nsString s(Substring(body, i, 10));</span>
<a href="#l45.387"></a><span id="l45.387" class="difflineminus">-        if (StringBeginsWith(s, NS_LITERAL_STRING(&quot;-- \r&quot;)) ||</span>
<a href="#l45.388"></a><span id="l45.388" class="difflineminus">-            StringBeginsWith(s, NS_LITERAL_STRING(&quot;-- \n&quot;))) {</span>
<a href="#l45.389"></a><span id="l45.389" class="difflineplus">+        if (StringBeginsWith(s, u&quot;-- \r&quot;_ns) ||</span>
<a href="#l45.390"></a><span id="l45.390" class="difflineplus">+            StringBeginsWith(s, u&quot;-- \n&quot;_ns)) {</span>
<a href="#l45.391"></a><span id="l45.391">           i += 4;</span>
<a href="#l45.392"></a><span id="l45.392">           continue;</span>
<a href="#l45.393"></a><span id="l45.393">         }</span>
<a href="#l45.394"></a><span id="l45.394" class="difflineminus">-        if (StringBeginsWith(s, NS_LITERAL_STRING(&quot;- -- \r&quot;)) ||</span>
<a href="#l45.395"></a><span id="l45.395" class="difflineminus">-            StringBeginsWith(s, NS_LITERAL_STRING(&quot;- -- \n&quot;))) {</span>
<a href="#l45.396"></a><span id="l45.396" class="difflineplus">+        if (StringBeginsWith(s, u&quot;- -- \r&quot;_ns) ||</span>
<a href="#l45.397"></a><span id="l45.397" class="difflineplus">+            StringBeginsWith(s, u&quot;- -- \n&quot;_ns)) {</span>
<a href="#l45.398"></a><span id="l45.398">           i += 6;</span>
<a href="#l45.399"></a><span id="l45.399">           continue;</span>
<a href="#l45.400"></a><span id="l45.400">         }</span>
<a href="#l45.401"></a><span id="l45.401">       }</span>
<a href="#l45.402"></a><span id="l45.402">       if (body[i] == '\n' &amp;&amp; i &gt; 1) {</span>
<a href="#l45.403"></a><span id="l45.403">         if (quote) {</span>
<a href="#l45.404"></a><span id="l45.404">           quote = false;</span>
<a href="#l45.405"></a><span id="l45.405">           continue;  // skip quoted lines</span>
<a href="#l45.406"></a><span id="l45.406" class="difflineat">@@ -4993,59 +4984,59 @@ void nsMsgCompose::TagConvertible(Elemen</span>
<a href="#l45.407"></a><span id="l45.407">   *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l45.408"></a><span id="l45.408"> </span>
<a href="#l45.409"></a><span id="l45.409">   nsAutoString element;</span>
<a href="#l45.410"></a><span id="l45.410">   element = node-&gt;NodeName();</span>
<a href="#l45.411"></a><span id="l45.411"> </span>
<a href="#l45.412"></a><span id="l45.412">   // A style attribute on any element can change layout in any way,</span>
<a href="#l45.413"></a><span id="l45.413">   // so that is not convertible.</span>
<a href="#l45.414"></a><span id="l45.414">   nsAutoString attribValue;</span>
<a href="#l45.415"></a><span id="l45.415" class="difflineminus">-  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;style&quot;), attribValue);</span>
<a href="#l45.416"></a><span id="l45.416" class="difflineplus">+  node-&gt;GetAttribute(u&quot;style&quot;_ns, attribValue);</span>
<a href="#l45.417"></a><span id="l45.417">   if (!attribValue.IsEmpty()) {</span>
<a href="#l45.418"></a><span id="l45.418">     *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l45.419"></a><span id="l45.419">     return;</span>
<a href="#l45.420"></a><span id="l45.420">   }</span>
<a href="#l45.421"></a><span id="l45.421"> </span>
<a href="#l45.422"></a><span id="l45.422">   // moz-* classes are used internally by the editor and mail composition</span>
<a href="#l45.423"></a><span id="l45.423">   // (like moz-cite-prefix or moz-signature). Those can be discarded.</span>
<a href="#l45.424"></a><span id="l45.424">   // But any other ones are unconvertible. Style can be attached to them or any</span>
<a href="#l45.425"></a><span id="l45.425">   // other context (e.g. in microformats).</span>
<a href="#l45.426"></a><span id="l45.426" class="difflineminus">-  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;class&quot;), attribValue);</span>
<a href="#l45.427"></a><span id="l45.427" class="difflineplus">+  node-&gt;GetAttribute(u&quot;class&quot;_ns, attribValue);</span>
<a href="#l45.428"></a><span id="l45.428">   if (!attribValue.IsEmpty()) {</span>
<a href="#l45.429"></a><span id="l45.429" class="difflineminus">-    if (StringBeginsWith(attribValue, NS_LITERAL_STRING(&quot;moz-&quot;),</span>
<a href="#l45.430"></a><span id="l45.430" class="difflineplus">+    if (StringBeginsWith(attribValue, u&quot;moz-&quot;_ns,</span>
<a href="#l45.431"></a><span id="l45.431">                          nsCaseInsensitiveStringComparator)) {</span>
<a href="#l45.432"></a><span id="l45.432">       // We assume that anything with a moz-* class is convertible regardless of</span>
<a href="#l45.433"></a><span id="l45.433">       // the tag, because we add, for example, class=&quot;moz-signature&quot; to HTML</span>
<a href="#l45.434"></a><span id="l45.434">       // messages and we still want to be able to downgrade them.</span>
<a href="#l45.435"></a><span id="l45.435">       *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l45.436"></a><span id="l45.436">     } else {</span>
<a href="#l45.437"></a><span id="l45.437">       *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l45.438"></a><span id="l45.438">     }</span>
<a href="#l45.439"></a><span id="l45.439"> </span>
<a href="#l45.440"></a><span id="l45.440">     return;</span>
<a href="#l45.441"></a><span id="l45.441">   }</span>
<a href="#l45.442"></a><span id="l45.442"> </span>
<a href="#l45.443"></a><span id="l45.443">   // ID attributes can contain attached style/context or be target of links</span>
<a href="#l45.444"></a><span id="l45.444">   // so we should preserve them.</span>
<a href="#l45.445"></a><span id="l45.445" class="difflineminus">-  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;id&quot;), attribValue);</span>
<a href="#l45.446"></a><span id="l45.446" class="difflineplus">+  node-&gt;GetAttribute(u&quot;id&quot;_ns, attribValue);</span>
<a href="#l45.447"></a><span id="l45.447">   if (!attribValue.IsEmpty()) {</span>
<a href="#l45.448"></a><span id="l45.448">     *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l45.449"></a><span id="l45.449">     return;</span>
<a href="#l45.450"></a><span id="l45.450">   }</span>
<a href="#l45.451"></a><span id="l45.451"> </span>
<a href="#l45.452"></a><span id="l45.452">   // Alignment is not convertible to plaintext; editor currently uses this.</span>
<a href="#l45.453"></a><span id="l45.453" class="difflineminus">-  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;align&quot;), attribValue);</span>
<a href="#l45.454"></a><span id="l45.454" class="difflineplus">+  node-&gt;GetAttribute(u&quot;align&quot;_ns, attribValue);</span>
<a href="#l45.455"></a><span id="l45.455">   if (!attribValue.IsEmpty()) {</span>
<a href="#l45.456"></a><span id="l45.456">     *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l45.457"></a><span id="l45.457">     return;</span>
<a href="#l45.458"></a><span id="l45.458">   }</span>
<a href="#l45.459"></a><span id="l45.459"> </span>
<a href="#l45.460"></a><span id="l45.460">   // Title attribute is not convertible to plaintext;</span>
<a href="#l45.461"></a><span id="l45.461">   // this also preserves any links with titles.</span>
<a href="#l45.462"></a><span id="l45.462" class="difflineminus">-  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;title&quot;), attribValue);</span>
<a href="#l45.463"></a><span id="l45.463" class="difflineplus">+  node-&gt;GetAttribute(u&quot;title&quot;_ns, attribValue);</span>
<a href="#l45.464"></a><span id="l45.464">   if (!attribValue.IsEmpty()) {</span>
<a href="#l45.465"></a><span id="l45.465">     *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l45.466"></a><span id="l45.466">     return;</span>
<a href="#l45.467"></a><span id="l45.467">   }</span>
<a href="#l45.468"></a><span id="l45.468"> </span>
<a href="#l45.469"></a><span id="l45.469">   if (  // Considered convertible to plaintext: Some &quot;simple&quot; elements</span>
<a href="#l45.470"></a><span id="l45.470">         // without non-convertible attributes like style, class, id,</span>
<a href="#l45.471"></a><span id="l45.471">         // or align (see above).</span>
<a href="#l45.472"></a><span id="l45.472" class="difflineat">@@ -5081,59 +5072,58 @@ void nsMsgCompose::TagConvertible(Elemen</span>
<a href="#l45.473"></a><span id="l45.473">                            element.LowerCaseEqualsLiteral(&quot;code&quot;) ||</span>
<a href="#l45.474"></a><span id="l45.474">                            element.LowerCaseEqualsLiteral(&quot;b&quot;) ||</span>
<a href="#l45.475"></a><span id="l45.475">                            element.LowerCaseEqualsLiteral(&quot;i&quot;) ||</span>
<a href="#l45.476"></a><span id="l45.476">                            element.LowerCaseEqualsLiteral(&quot;u&quot;)))) {</span>
<a href="#l45.477"></a><span id="l45.477">     *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l45.478"></a><span id="l45.478">   } else if (element.LowerCaseEqualsLiteral(&quot;body&quot;)) {</span>
<a href="#l45.479"></a><span id="l45.479">     *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l45.480"></a><span id="l45.480"> </span>
<a href="#l45.481"></a><span id="l45.481" class="difflineminus">-    if (node-&gt;HasAttribute(</span>
<a href="#l45.482"></a><span id="l45.482" class="difflineminus">-            NS_LITERAL_STRING(&quot;background&quot;)) ||  // There is a background image</span>
<a href="#l45.483"></a><span id="l45.483" class="difflineminus">-        node-&gt;HasAttribute(NS_LITERAL_STRING(</span>
<a href="#l45.484"></a><span id="l45.484" class="difflineminus">-            &quot;dir&quot;))) {  // dir=rtl attributes should not downconvert</span>
<a href="#l45.485"></a><span id="l45.485" class="difflineplus">+    if (node-&gt;HasAttribute(u&quot;background&quot;_ns) ||  // There is a background image</span>
<a href="#l45.486"></a><span id="l45.486" class="difflineplus">+        node-&gt;HasAttribute(</span>
<a href="#l45.487"></a><span id="l45.487" class="difflineplus">+            u&quot;dir&quot;_ns)) {  // dir=rtl attributes should not downconvert</span>
<a href="#l45.488"></a><span id="l45.488">       *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l45.489"></a><span id="l45.489">     } else {</span>
<a href="#l45.490"></a><span id="l45.490">       nsAutoString color;</span>
<a href="#l45.491"></a><span id="l45.491" class="difflineminus">-      if (node-&gt;HasAttribute(NS_LITERAL_STRING(&quot;text&quot;))) {</span>
<a href="#l45.492"></a><span id="l45.492" class="difflineminus">-        node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;text&quot;), color);</span>
<a href="#l45.493"></a><span id="l45.493" class="difflineplus">+      if (node-&gt;HasAttribute(u&quot;text&quot;_ns)) {</span>
<a href="#l45.494"></a><span id="l45.494" class="difflineplus">+        node-&gt;GetAttribute(u&quot;text&quot;_ns, color);</span>
<a href="#l45.495"></a><span id="l45.495">         if (!color.EqualsLiteral(&quot;#000000&quot;))</span>
<a href="#l45.496"></a><span id="l45.496">           *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l45.497"></a><span id="l45.497">       }</span>
<a href="#l45.498"></a><span id="l45.498">       if (*_retval != nsIMsgCompConvertible::Altering &amp;&amp;  // small optimization</span>
<a href="#l45.499"></a><span id="l45.499" class="difflineminus">-          node-&gt;HasAttribute(NS_LITERAL_STRING(&quot;bgcolor&quot;))) {</span>
<a href="#l45.500"></a><span id="l45.500" class="difflineminus">-        node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;bgcolor&quot;), color);</span>
<a href="#l45.501"></a><span id="l45.501" class="difflineplus">+          node-&gt;HasAttribute(u&quot;bgcolor&quot;_ns)) {</span>
<a href="#l45.502"></a><span id="l45.502" class="difflineplus">+        node-&gt;GetAttribute(u&quot;bgcolor&quot;_ns, color);</span>
<a href="#l45.503"></a><span id="l45.503">         if (!color.LowerCaseEqualsLiteral(&quot;#ffffff&quot;))</span>
<a href="#l45.504"></a><span id="l45.504">           *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l45.505"></a><span id="l45.505">       }</span>
<a href="#l45.506"></a><span id="l45.506">     }</span>
<a href="#l45.507"></a><span id="l45.507"> </span>
<a href="#l45.508"></a><span id="l45.508">     // ignore special color setting for link, vlink and alink at this point.</span>
<a href="#l45.509"></a><span id="l45.509">   } else if (element.LowerCaseEqualsLiteral(&quot;blockquote&quot;)) {</span>
<a href="#l45.510"></a><span id="l45.510">     // Skip &lt;blockquote type=&quot;cite&quot;&gt;</span>
<a href="#l45.511"></a><span id="l45.511">     *_retval = nsIMsgCompConvertible::Yes;</span>
<a href="#l45.512"></a><span id="l45.512"> </span>
<a href="#l45.513"></a><span id="l45.513" class="difflineminus">-    node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;type&quot;), attribValue);</span>
<a href="#l45.514"></a><span id="l45.514" class="difflineplus">+    node-&gt;GetAttribute(u&quot;type&quot;_ns, attribValue);</span>
<a href="#l45.515"></a><span id="l45.515">     if (attribValue.LowerCaseEqualsLiteral(&quot;cite&quot;)) {</span>
<a href="#l45.516"></a><span id="l45.516">       *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l45.517"></a><span id="l45.517">     }</span>
<a href="#l45.518"></a><span id="l45.518">   } else if (element.LowerCaseEqualsLiteral(&quot;div&quot;) ||</span>
<a href="#l45.519"></a><span id="l45.519">              element.LowerCaseEqualsLiteral(&quot;span&quot;) ||</span>
<a href="#l45.520"></a><span id="l45.520">              element.LowerCaseEqualsLiteral(&quot;a&quot;)) {</span>
<a href="#l45.521"></a><span id="l45.521">     // Do some special checks for these tags. They are inside this |else if|</span>
<a href="#l45.522"></a><span id="l45.522">     // for performance reasons.</span>
<a href="#l45.523"></a><span id="l45.523"> </span>
<a href="#l45.524"></a><span id="l45.524">     // Maybe, it's an &lt;a&gt; element inserted by another recognizer (e.g. 4.x')</span>
<a href="#l45.525"></a><span id="l45.525">     if (element.LowerCaseEqualsLiteral(&quot;a&quot;)) {</span>
<a href="#l45.526"></a><span id="l45.526">       // Ignore anchor tag, if the URI is the same as the text</span>
<a href="#l45.527"></a><span id="l45.527">       // (as inserted by recognizers).</span>
<a href="#l45.528"></a><span id="l45.528">       *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l45.529"></a><span id="l45.529"> </span>
<a href="#l45.530"></a><span id="l45.530">       nsAutoString hrefValue;</span>
<a href="#l45.531"></a><span id="l45.531" class="difflineminus">-      node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;href&quot;), hrefValue);</span>
<a href="#l45.532"></a><span id="l45.532" class="difflineplus">+      node-&gt;GetAttribute(u&quot;href&quot;_ns, hrefValue);</span>
<a href="#l45.533"></a><span id="l45.533">       nsINodeList* children = node-&gt;ChildNodes();</span>
<a href="#l45.534"></a><span id="l45.534">       if (children-&gt;Length() &gt; 0) {</span>
<a href="#l45.535"></a><span id="l45.535">         nsINode* pItem = children-&gt;Item(0);</span>
<a href="#l45.536"></a><span id="l45.536">         nsAutoString textValue;</span>
<a href="#l45.537"></a><span id="l45.537">         pItem-&gt;GetNodeValue(textValue);</span>
<a href="#l45.538"></a><span id="l45.538">         if (textValue == hrefValue) *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l45.539"></a><span id="l45.539">       }</span>
<a href="#l45.540"></a><span id="l45.540">     }</span>
<a href="#l45.541"></a><span id="l45.541" class="difflineat">@@ -5422,18 +5412,17 @@ nsMsgCompose::SetIdentity(nsIMsgIdentity</span>
<a href="#l45.542"></a><span id="l45.542">       rv = MoveToEndOfDocument();</span>
<a href="#l45.543"></a><span id="l45.543">     }</span>
<a href="#l45.544"></a><span id="l45.544"> </span>
<a href="#l45.545"></a><span id="l45.545">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l45.546"></a><span id="l45.546">       if (m_composeHTML) {</span>
<a href="#l45.547"></a><span id="l45.547">         rv = MOZ_KnownLive(editor-&gt;AsHTMLEditor())-&gt;InsertHTML(aSignature);</span>
<a href="#l45.548"></a><span id="l45.548">       } else {</span>
<a href="#l45.549"></a><span id="l45.549">         rv = editor-&gt;InsertLineBreak();</span>
<a href="#l45.550"></a><span id="l45.550" class="difflineminus">-        InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l45.551"></a><span id="l45.551" class="difflineminus">-                                        NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l45.552"></a><span id="l45.552" class="difflineplus">+        InsertDivWrappedTextAtSelection(aSignature, u&quot;moz-signature&quot;_ns);</span>
<a href="#l45.553"></a><span id="l45.553">       }</span>
<a href="#l45.554"></a><span id="l45.554">     }</span>
<a href="#l45.555"></a><span id="l45.555">     editor-&gt;EndTransaction();</span>
<a href="#l45.556"></a><span id="l45.556">   }</span>
<a href="#l45.557"></a><span id="l45.557"> </span>
<a href="#l45.558"></a><span id="l45.558">   return rv;</span>
<a href="#l45.559"></a><span id="l45.559"> }</span>
<a href="#l45.560"></a><span id="l45.560"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -246,18 +246,18 @@ nsMsgComposeService::GetOrigWindowSelect</span>
<a href="#l46.4"></a><span id="l46.4"> </span>
<a href="#l46.5"></a><span id="l46.5">   // Now delve down in to the message to get the HTML representation of the</span>
<a href="#l46.6"></a><span id="l46.6">   // selection</span>
<a href="#l46.7"></a><span id="l46.7">   nsCOMPtr&lt;nsIDocShell&gt; rootShell;</span>
<a href="#l46.8"></a><span id="l46.8">   rv = aMsgWindow-&gt;GetRootDocShell(getter_AddRefs(rootShell));</span>
<a href="#l46.9"></a><span id="l46.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.10"></a><span id="l46.10"> </span>
<a href="#l46.11"></a><span id="l46.11">   nsCOMPtr&lt;nsIDocShell&gt; messagePaneDocShell;</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-  RefPtr&lt;mozilla::dom::Element&gt; el = rootShell-&gt;GetDocument()-&gt;GetElementById(</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-      NS_LITERAL_STRING(&quot;messagepane&quot;));</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+  RefPtr&lt;mozilla::dom::Element&gt; el =</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+      rootShell-&gt;GetDocument()-&gt;GetElementById(u&quot;messagepane&quot;_ns);</span>
<a href="#l46.16"></a><span id="l46.16">   RefPtr&lt;mozilla::dom::XULFrameElement&gt; frame =</span>
<a href="#l46.17"></a><span id="l46.17">       mozilla::dom::XULFrameElement::FromNodeOrNull(el);</span>
<a href="#l46.18"></a><span id="l46.18">   NS_ENSURE_TRUE(frame, NS_ERROR_FAILURE);</span>
<a href="#l46.19"></a><span id="l46.19">   RefPtr&lt;mozilla::dom::Document&gt; doc = frame-&gt;GetContentDocument();</span>
<a href="#l46.20"></a><span id="l46.20">   NS_ENSURE_TRUE(doc, NS_ERROR_FAILURE);</span>
<a href="#l46.21"></a><span id="l46.21">   messagePaneDocShell = doc-&gt;GetDocShell();</span>
<a href="#l46.22"></a><span id="l46.22">   NS_ENSURE_TRUE(messagePaneDocShell, NS_ERROR_FAILURE);</span>
<a href="#l46.23"></a><span id="l46.23"> </span>
<a href="#l46.24"></a><span id="l46.24" class="difflineat">@@ -313,17 +313,17 @@ nsMsgComposeService::GetOrigWindowSelect</span>
<a href="#l46.25"></a><span id="l46.25">   nsCOMPtr&lt;nsIContentViewer&gt; contentViewer;</span>
<a href="#l46.26"></a><span id="l46.26">   rv = messagePaneDocShell-&gt;GetContentViewer(getter_AddRefs(contentViewer));</span>
<a href="#l46.27"></a><span id="l46.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.28"></a><span id="l46.28"> </span>
<a href="#l46.29"></a><span id="l46.29">   nsCOMPtr&lt;mozilla::dom::Document&gt; domDocument(contentViewer-&gt;GetDocument());</span>
<a href="#l46.30"></a><span id="l46.30"> </span>
<a href="#l46.31"></a><span id="l46.31">   nsCOMPtr&lt;nsIDocumentEncoder&gt; docEncoder = do_createHTMLCopyEncoder();</span>
<a href="#l46.32"></a><span id="l46.32"> </span>
<a href="#l46.33"></a><span id="l46.33" class="difflineminus">-  rv = docEncoder-&gt;Init(domDocument, NS_LITERAL_STRING(&quot;text/html&quot;), 0);</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+  rv = docEncoder-&gt;Init(domDocument, u&quot;text/html&quot;_ns, 0);</span>
<a href="#l46.35"></a><span id="l46.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.36"></a><span id="l46.36"> </span>
<a href="#l46.37"></a><span id="l46.37">   rv = docEncoder-&gt;SetSelection(sel);</span>
<a href="#l46.38"></a><span id="l46.38">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.39"></a><span id="l46.39"> </span>
<a href="#l46.40"></a><span id="l46.40">   nsAutoString selHTML;</span>
<a href="#l46.41"></a><span id="l46.41">   rv = docEncoder-&gt;EncodeToString(selHTML);</span>
<a href="#l46.42"></a><span id="l46.42">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineat">@@ -691,27 +691,26 @@ NS_IMETHODIMP nsMsgTemplateReplyHelper::</span>
<a href="#l46.44"></a><span id="l46.44">   if (replyTo.IsEmpty()) mHdrToReplyTo-&gt;GetAuthor(getter_Copies(replyTo));</span>
<a href="#l46.45"></a><span id="l46.45">   compFields-&gt;SetTo(NS_ConvertUTF8toUTF16(replyTo));</span>
<a href="#l46.46"></a><span id="l46.46"> </span>
<a href="#l46.47"></a><span id="l46.47">   nsString body;</span>
<a href="#l46.48"></a><span id="l46.48">   nsString templateSubject, replySubject;</span>
<a href="#l46.49"></a><span id="l46.49"> </span>
<a href="#l46.50"></a><span id="l46.50">   mHdrToReplyTo-&gt;GetMime2DecodedSubject(replySubject);</span>
<a href="#l46.51"></a><span id="l46.51">   mTemplateHdr-&gt;GetMime2DecodedSubject(templateSubject);</span>
<a href="#l46.52"></a><span id="l46.52" class="difflineminus">-  nsString subject(NS_LITERAL_STRING(&quot;Auto: &quot;));  // RFC 3834 3.1.5.</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineplus">+  nsString subject(u&quot;Auto: &quot;_ns);  // RFC 3834 3.1.5.</span>
<a href="#l46.54"></a><span id="l46.54">   subject.Append(templateSubject);</span>
<a href="#l46.55"></a><span id="l46.55">   if (!replySubject.IsEmpty()) {</span>
<a href="#l46.56"></a><span id="l46.56">     subject.AppendLiteral(u&quot; (was: &quot;);</span>
<a href="#l46.57"></a><span id="l46.57">     subject.Append(replySubject);</span>
<a href="#l46.58"></a><span id="l46.58">     subject.Append(u')');</span>
<a href="#l46.59"></a><span id="l46.59">   }</span>
<a href="#l46.60"></a><span id="l46.60"> </span>
<a href="#l46.61"></a><span id="l46.61">   compFields-&gt;SetSubject(subject);</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineminus">-  compFields-&gt;SetRawHeader(&quot;Auto-Submitted&quot;, NS_LITERAL_CSTRING(&quot;auto-replied&quot;),</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineminus">-                           nullptr);</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineplus">+  compFields-&gt;SetRawHeader(&quot;Auto-Submitted&quot;, &quot;auto-replied&quot;_ns, nullptr);</span>
<a href="#l46.65"></a><span id="l46.65"> </span>
<a href="#l46.66"></a><span id="l46.66">   nsCString charset;</span>
<a href="#l46.67"></a><span id="l46.67">   rv = mTemplateHdr-&gt;GetCharset(getter_Copies(charset));</span>
<a href="#l46.68"></a><span id="l46.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.69"></a><span id="l46.69">   compFields-&gt;SetCharacterSet(charset.get());</span>
<a href="#l46.70"></a><span id="l46.70">   rv = nsMsgI18NConvertToUnicode(charset, mTemplateBody, body);</span>
<a href="#l46.71"></a><span id="l46.71">   NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l46.72"></a><span id="l46.72">                        &quot;couldn't convert templ body to unicode&quot;);</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineat">@@ -1241,21 +1240,21 @@ nsresult nsMsgComposeService::RunMessage</span>
<a href="#l46.74"></a><span id="l46.74">     mimeConverter-&gt;SetForwardToAddress(aForwardTo);</span>
<a href="#l46.75"></a><span id="l46.75">   }</span>
<a href="#l46.76"></a><span id="l46.76">   mimeConverter-&gt;SetOverrideComposeFormat(aOverrideComposeFormat);</span>
<a href="#l46.77"></a><span id="l46.77">   mimeConverter-&gt;SetIdentity(aIdentity);</span>
<a href="#l46.78"></a><span id="l46.78">   mimeConverter-&gt;SetOriginalMsgURI(aOriginalMsgURI);</span>
<a href="#l46.79"></a><span id="l46.79">   mimeConverter-&gt;SetOrigMsgHdr(aOrigMsgHdr);</span>
<a href="#l46.80"></a><span id="l46.80"> </span>
<a href="#l46.81"></a><span id="l46.81">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l46.82"></a><span id="l46.82" class="difflineminus">-  bool fileUrl = StringBeginsWith(aMsgURI, NS_LITERAL_CSTRING(&quot;file:&quot;));</span>
<a href="#l46.83"></a><span id="l46.83" class="difflineplus">+  bool fileUrl = StringBeginsWith(aMsgURI, &quot;file:&quot;_ns);</span>
<a href="#l46.84"></a><span id="l46.84">   nsCString mailboxUri(aMsgURI);</span>
<a href="#l46.85"></a><span id="l46.85">   if (fileUrl) {</span>
<a href="#l46.86"></a><span id="l46.86">     // We loaded a .eml file from a file: url. Construct equivalent mailbox url.</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineminus">-    mailboxUri.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+    mailboxUri.Replace(0, 5, &quot;mailbox:&quot;_ns);</span>
<a href="#l46.89"></a><span id="l46.89">     mailboxUri.AppendLiteral(&quot;&amp;number=0&quot;);</span>
<a href="#l46.90"></a><span id="l46.90">     // Need this to prevent nsMsgCompose::TagEmbeddedObjects from setting</span>
<a href="#l46.91"></a><span id="l46.91">     // inline images as moz-do-not-send.</span>
<a href="#l46.92"></a><span id="l46.92">     mimeConverter-&gt;SetOriginalMsgURI(mailboxUri.get());</span>
<a href="#l46.93"></a><span id="l46.93">   }</span>
<a href="#l46.94"></a><span id="l46.94">   if (fileUrl || PromiseFlatCString(aMsgURI).Find(</span>
<a href="#l46.95"></a><span id="l46.95">                      &quot;&amp;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l46.96"></a><span id="l46.96">     rv = NS_NewURI(getter_AddRefs(url), mailboxUri);</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineat">@@ -1320,51 +1319,51 @@ NS_IMETHODIMP</span>
<a href="#l46.98"></a><span id="l46.98"> nsMsgComposeService::Handle(nsICommandLine* aCmdLine) {</span>
<a href="#l46.99"></a><span id="l46.99">   NS_ENSURE_ARG_POINTER(aCmdLine);</span>
<a href="#l46.100"></a><span id="l46.100"> </span>
<a href="#l46.101"></a><span id="l46.101">   nsresult rv;</span>
<a href="#l46.102"></a><span id="l46.102">   int32_t found, end, count;</span>
<a href="#l46.103"></a><span id="l46.103">   nsAutoString uristr;</span>
<a href="#l46.104"></a><span id="l46.104">   bool composeShouldHandle = true;</span>
<a href="#l46.105"></a><span id="l46.105"> </span>
<a href="#l46.106"></a><span id="l46.106" class="difflineminus">-  rv = aCmdLine-&gt;FindFlag(NS_LITERAL_STRING(&quot;compose&quot;), false, &amp;found);</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineplus">+  rv = aCmdLine-&gt;FindFlag(u&quot;compose&quot;_ns, false, &amp;found);</span>
<a href="#l46.108"></a><span id="l46.108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.109"></a><span id="l46.109"> </span>
<a href="#l46.110"></a><span id="l46.110"> #ifndef MOZ_SUITE</span>
<a href="#l46.111"></a><span id="l46.111">   // MAC OS X passes in -url mailto:mscott@mozilla.org into the command line</span>
<a href="#l46.112"></a><span id="l46.112">   // instead of -compose.</span>
<a href="#l46.113"></a><span id="l46.113">   if (found == -1) {</span>
<a href="#l46.114"></a><span id="l46.114" class="difflineminus">-    rv = aCmdLine-&gt;FindFlag(NS_LITERAL_STRING(&quot;url&quot;), false, &amp;found);</span>
<a href="#l46.115"></a><span id="l46.115" class="difflineplus">+    rv = aCmdLine-&gt;FindFlag(u&quot;url&quot;_ns, false, &amp;found);</span>
<a href="#l46.116"></a><span id="l46.116">     // we don't want to consume the argument for -url unless we're sure it is a</span>
<a href="#l46.117"></a><span id="l46.117">     // mailto url and we'll figure that out shortly.</span>
<a href="#l46.118"></a><span id="l46.118">     composeShouldHandle = false;</span>
<a href="#l46.119"></a><span id="l46.119">   }</span>
<a href="#l46.120"></a><span id="l46.120"> #endif</span>
<a href="#l46.121"></a><span id="l46.121"> </span>
<a href="#l46.122"></a><span id="l46.122">   if (found == -1) return NS_OK;</span>
<a href="#l46.123"></a><span id="l46.123"> </span>
<a href="#l46.124"></a><span id="l46.124">   end = found;</span>
<a href="#l46.125"></a><span id="l46.125"> </span>
<a href="#l46.126"></a><span id="l46.126">   rv = aCmdLine-&gt;GetLength(&amp;count);</span>
<a href="#l46.127"></a><span id="l46.127">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.128"></a><span id="l46.128"> </span>
<a href="#l46.129"></a><span id="l46.129">   if (count &gt; found + 1) {</span>
<a href="#l46.130"></a><span id="l46.130">     aCmdLine-&gt;GetArgument(found + 1, uristr);</span>
<a href="#l46.131"></a><span id="l46.131" class="difflineminus">-    if (StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;mailto:&quot;)) ||</span>
<a href="#l46.132"></a><span id="l46.132" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;preselectid=&quot;)) ||</span>
<a href="#l46.133"></a><span id="l46.133" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;to=&quot;)) ||</span>
<a href="#l46.134"></a><span id="l46.134" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;cc=&quot;)) ||</span>
<a href="#l46.135"></a><span id="l46.135" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;bcc=&quot;)) ||</span>
<a href="#l46.136"></a><span id="l46.136" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;newsgroups=&quot;)) ||</span>
<a href="#l46.137"></a><span id="l46.137" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;subject=&quot;)) ||</span>
<a href="#l46.138"></a><span id="l46.138" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;format=&quot;)) ||</span>
<a href="#l46.139"></a><span id="l46.139" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;body=&quot;)) ||</span>
<a href="#l46.140"></a><span id="l46.140" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;attachment=&quot;)) ||</span>
<a href="#l46.141"></a><span id="l46.141" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;message=&quot;)) ||</span>
<a href="#l46.142"></a><span id="l46.142" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;from=&quot;))) {</span>
<a href="#l46.143"></a><span id="l46.143" class="difflineplus">+    if (StringBeginsWith(uristr, u&quot;mailto:&quot;_ns) ||</span>
<a href="#l46.144"></a><span id="l46.144" class="difflineplus">+        StringBeginsWith(uristr, u&quot;preselectid=&quot;_ns) ||</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineplus">+        StringBeginsWith(uristr, u&quot;to=&quot;_ns) ||</span>
<a href="#l46.146"></a><span id="l46.146" class="difflineplus">+        StringBeginsWith(uristr, u&quot;cc=&quot;_ns) ||</span>
<a href="#l46.147"></a><span id="l46.147" class="difflineplus">+        StringBeginsWith(uristr, u&quot;bcc=&quot;_ns) ||</span>
<a href="#l46.148"></a><span id="l46.148" class="difflineplus">+        StringBeginsWith(uristr, u&quot;newsgroups=&quot;_ns) ||</span>
<a href="#l46.149"></a><span id="l46.149" class="difflineplus">+        StringBeginsWith(uristr, u&quot;subject=&quot;_ns) ||</span>
<a href="#l46.150"></a><span id="l46.150" class="difflineplus">+        StringBeginsWith(uristr, u&quot;format=&quot;_ns) ||</span>
<a href="#l46.151"></a><span id="l46.151" class="difflineplus">+        StringBeginsWith(uristr, u&quot;body=&quot;_ns) ||</span>
<a href="#l46.152"></a><span id="l46.152" class="difflineplus">+        StringBeginsWith(uristr, u&quot;attachment=&quot;_ns) ||</span>
<a href="#l46.153"></a><span id="l46.153" class="difflineplus">+        StringBeginsWith(uristr, u&quot;message=&quot;_ns) ||</span>
<a href="#l46.154"></a><span id="l46.154" class="difflineplus">+        StringBeginsWith(uristr, u&quot;from=&quot;_ns)) {</span>
<a href="#l46.155"></a><span id="l46.155">       composeShouldHandle = true;  // the -url argument looks like mailto</span>
<a href="#l46.156"></a><span id="l46.156">       end++;</span>
<a href="#l46.157"></a><span id="l46.157">       // mailto: URIs are frequently passed with spaces in them. They should be</span>
<a href="#l46.158"></a><span id="l46.158">       // escaped with %20, but we hack around broken clients. See bug 231032.</span>
<a href="#l46.159"></a><span id="l46.159">       while (end + 1 &lt; count) {</span>
<a href="#l46.160"></a><span id="l46.160">         nsAutoString curarg;</span>
<a href="#l46.161"></a><span id="l46.161">         aCmdLine-&gt;GetArgument(end + 1, curarg);</span>
<a href="#l46.162"></a><span id="l46.162">         if (curarg.First() == '-') break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -95,17 +95,17 @@ nsresult nsMsgQuote::QuoteMessage(</span>
<a href="#l47.4"></a><span id="l47.4">   mStreamListener = aQuoteMsgStreamListener;</span>
<a href="#l47.5"></a><span id="l47.5"> </span>
<a href="#l47.6"></a><span id="l47.6">   nsAutoCString msgUri(msgURI);</span>
<a href="#l47.7"></a><span id="l47.7">   bool fileUrl = !strncmp(msgURI, &quot;file:&quot;, 5);</span>
<a href="#l47.8"></a><span id="l47.8">   bool forwardedMessage =</span>
<a href="#l47.9"></a><span id="l47.9">       PL_strstr(msgURI, &quot;&amp;realtype=message/rfc822&quot;) != nullptr;</span>
<a href="#l47.10"></a><span id="l47.10">   nsCOMPtr&lt;nsIURI&gt; newURI;</span>
<a href="#l47.11"></a><span id="l47.11">   if (fileUrl) {</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-    msgUri.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+    msgUri.Replace(0, 5, &quot;mailbox:&quot;_ns);</span>
<a href="#l47.14"></a><span id="l47.14">     msgUri.AppendLiteral(&quot;?number=0&quot;);</span>
<a href="#l47.15"></a><span id="l47.15">     rv = NS_NewURI(getter_AddRefs(newURI), msgUri);</span>
<a href="#l47.16"></a><span id="l47.16">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; mailUrl(do_QueryInterface(newURI));</span>
<a href="#l47.17"></a><span id="l47.17">     if (mailUrl) mailUrl-&gt;SetMessageHeader(aMsgHdr);</span>
<a href="#l47.18"></a><span id="l47.18">   } else if (forwardedMessage)</span>
<a href="#l47.19"></a><span id="l47.19">     rv = NS_NewURI(getter_AddRefs(newURI), msgURI);</span>
<a href="#l47.20"></a><span id="l47.20">   else {</span>
<a href="#l47.21"></a><span id="l47.21">     nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -1542,18 +1542,17 @@ nsresult nsMsgComposeAndSend::ProcessMul</span>
<a href="#l48.4"></a><span id="l48.4">                  (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l48.5"></a><span id="l48.5">           (*aNewsCount)++;</span>
<a href="#l48.6"></a><span id="l48.6">         else {</span>
<a href="#l48.7"></a><span id="l48.7">           // Additional account types need a mechanism to report that they are</span>
<a href="#l48.8"></a><span id="l48.8">           // message protocols. If there is an nsIMsgProtocolInfo component</span>
<a href="#l48.9"></a><span id="l48.9">           // registered for this scheme, we'll consider it a mailbox</span>
<a href="#l48.10"></a><span id="l48.10">           // attachment.</span>
<a href="#l48.11"></a><span id="l48.11">           nsAutoCString contractID;</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-          contractID.Assign(</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-              NS_LITERAL_CSTRING(&quot;@mozilla.org/messenger/protocol/info;1&quot;));</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+          contractID.Assign(&quot;@mozilla.org/messenger/protocol/info;1&quot;_ns);</span>
<a href="#l48.15"></a><span id="l48.15">           nsAutoCString scheme;</span>
<a href="#l48.16"></a><span id="l48.16">           uri-&gt;GetScheme(scheme);</span>
<a href="#l48.17"></a><span id="l48.17">           contractID.Append(scheme);</span>
<a href="#l48.18"></a><span id="l48.18">           nsCOMPtr&lt;nsIMsgProtocolInfo&gt; msgProtocolInfo =</span>
<a href="#l48.19"></a><span id="l48.19">               do_CreateInstance(contractID.get());</span>
<a href="#l48.20"></a><span id="l48.20">           if (msgProtocolInfo) (*aMailboxCount)++;</span>
<a href="#l48.21"></a><span id="l48.21">         }</span>
<a href="#l48.22"></a><span id="l48.22">       }</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineat">@@ -1565,17 +1564,17 @@ nsresult nsMsgComposeAndSend::ProcessMul</span>
<a href="#l48.24"></a><span id="l48.24">     //</span>
<a href="#l48.25"></a><span id="l48.25">     // Ok, while we are here, we should whack the DOM with the generated</span>
<a href="#l48.26"></a><span id="l48.26">     // Content-ID for this object. This will be necessary for generating</span>
<a href="#l48.27"></a><span id="l48.27">     // the HTML we need.</span>
<a href="#l48.28"></a><span id="l48.28">     //</span>
<a href="#l48.29"></a><span id="l48.29">     if (domSaveArray[j].element &amp;&amp;</span>
<a href="#l48.30"></a><span id="l48.30">         !m_attachments[duplicateOf == -1 ? i : duplicateOf]</span>
<a href="#l48.31"></a><span id="l48.31">              -&gt;m_contentId.IsEmpty()) {</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineminus">-      nsString newSpec(NS_LITERAL_STRING(&quot;cid:&quot;));</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+      nsString newSpec(u&quot;cid:&quot;_ns);</span>
<a href="#l48.34"></a><span id="l48.34">       newSpec.AppendASCII(m_attachments[duplicateOf == -1 ? i : duplicateOf]</span>
<a href="#l48.35"></a><span id="l48.35">                               -&gt;m_contentId.get());</span>
<a href="#l48.36"></a><span id="l48.36"> </span>
<a href="#l48.37"></a><span id="l48.37">       // We know the types of objects this element can be, let's see what we</span>
<a href="#l48.38"></a><span id="l48.38">       // come up with.</span>
<a href="#l48.39"></a><span id="l48.39">       RefPtr&lt;HTMLImageElement&gt; image =</span>
<a href="#l48.40"></a><span id="l48.40">           HTMLImageElement::FromNode(domSaveArray[j].element);</span>
<a href="#l48.41"></a><span id="l48.41">       RefPtr&lt;HTMLAnchorElement&gt; anchor =</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineat">@@ -1924,18 +1923,17 @@ nsresult nsMsgComposeAndSend::AddCompFie</span>
<a href="#l48.43"></a><span id="l48.43">           nsCOMPtr&lt;nsIURI&gt; nsiuri;</span>
<a href="#l48.44"></a><span id="l48.44">           rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l48.45"></a><span id="l48.45">                    .SetSpec(url)</span>
<a href="#l48.46"></a><span id="l48.46">                    .Finalize(nsiuri);</span>
<a href="#l48.47"></a><span id="l48.47">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.48"></a><span id="l48.48"> </span>
<a href="#l48.49"></a><span id="l48.49">           nsAutoCString scheme;</span>
<a href="#l48.50"></a><span id="l48.50">           nsiuri-&gt;GetScheme(scheme);</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-          bool isAMessageAttachment =</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-              StringEndsWith(scheme, NS_LITERAL_CSTRING(&quot;-message&quot;));</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+          bool isAMessageAttachment = StringEndsWith(scheme, &quot;-message&quot;_ns);</span>
<a href="#l48.54"></a><span id="l48.54"> </span>
<a href="#l48.55"></a><span id="l48.55">           m_attachments[newLoc]-&gt;mDeleteFile = true;</span>
<a href="#l48.56"></a><span id="l48.56">           m_attachments[newLoc]-&gt;m_done = false;</span>
<a href="#l48.57"></a><span id="l48.57">           m_attachments[newLoc]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l48.58"></a><span id="l48.58"> </span>
<a href="#l48.59"></a><span id="l48.59">           if (!isAMessageAttachment)</span>
<a href="#l48.60"></a><span id="l48.60">             nsMsgNewURL(getter_AddRefs(m_attachments[newLoc]-&gt;mURL), url);</span>
<a href="#l48.61"></a><span id="l48.61"> </span>
<a href="#l48.62"></a><span id="l48.62" class="difflineat">@@ -2160,18 +2158,17 @@ nsresult nsMsgComposeAndSend::HackAttach</span>
<a href="#l48.63"></a><span id="l48.63">                  (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l48.64"></a><span id="l48.64">           news_count++;</span>
<a href="#l48.65"></a><span id="l48.65">         else {</span>
<a href="#l48.66"></a><span id="l48.66">           // Additional account types need a mechanism to report that they are</span>
<a href="#l48.67"></a><span id="l48.67">           // message protocols. If there is an nsIMsgProtocolInfo component</span>
<a href="#l48.68"></a><span id="l48.68">           // registered for this scheme, we'll consider it a mailbox</span>
<a href="#l48.69"></a><span id="l48.69">           // attachment.</span>
<a href="#l48.70"></a><span id="l48.70">           nsAutoCString contractID;</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineminus">-          contractID.Assign(</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineminus">-              NS_LITERAL_CSTRING(&quot;@mozilla.org/messenger/protocol/info;1&quot;));</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+          contractID.Assign(&quot;@mozilla.org/messenger/protocol/info;1&quot;_ns);</span>
<a href="#l48.74"></a><span id="l48.74">           nsAutoCString scheme;</span>
<a href="#l48.75"></a><span id="l48.75">           uri-&gt;GetScheme(scheme);</span>
<a href="#l48.76"></a><span id="l48.76">           contractID.Append(scheme);</span>
<a href="#l48.77"></a><span id="l48.77">           nsCOMPtr&lt;nsIMsgProtocolInfo&gt; msgProtocolInfo =</span>
<a href="#l48.78"></a><span id="l48.78">               do_CreateInstance(contractID.get());</span>
<a href="#l48.79"></a><span id="l48.79">           if (msgProtocolInfo) mailbox_count++;</span>
<a href="#l48.80"></a><span id="l48.80">         }</span>
<a href="#l48.81"></a><span id="l48.81">         if (uri)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1388,11 +1388,11 @@ nsMsgSendLater::DoShutdownTask(nsIUrlLis</span>
<a href="#l49.4"></a><span id="l49.4"> </span>
<a href="#l49.5"></a><span id="l49.5">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l49.6"></a><span id="l49.6"> }</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> NS_IMETHODIMP</span>
<a href="#l49.9"></a><span id="l49.9"> nsMsgSendLater::GetCurrentTaskName(nsAString&amp; aResult) {</span>
<a href="#l49.10"></a><span id="l49.10">   // XXX Bug 440794 will localize this, left as non-localized whilst we decide</span>
<a href="#l49.11"></a><span id="l49.11">   // on the actual strings and try out the UI.</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-  aResult = NS_LITERAL_STRING(&quot;Sending Messages&quot;);</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+  aResult = u&quot;Sending Messages&quot;_ns;</span>
<a href="#l49.14"></a><span id="l49.14">   return NS_OK;</span>
<a href="#l49.15"></a><span id="l49.15"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -119,17 +119,17 @@ nsresult nsExplainErrorDetails(nsISmtpUr</span>
<a href="#l50.4"></a><span id="l50.4">         // message string smtpPermSizeExceeded1 contains a %d.</span>
<a href="#l50.5"></a><span id="l50.5">         // (The special case can be removed if that string ever changes, then</span>
<a href="#l50.6"></a><span id="l50.6">         // %d should be changed to %S.)</span>
<a href="#l50.7"></a><span id="l50.7">         nsTextFormatter::ssprintf(msg, eMsg.get(), atoi(arg1), (void*)nullptr);</span>
<a href="#l50.8"></a><span id="l50.8">       } else {</span>
<a href="#l50.9"></a><span id="l50.9">         // Some error strings contain %s. We're supplying 16-bit strings,</span>
<a href="#l50.10"></a><span id="l50.10">         // so replace those with %S. It's a bit hacky. but it saves</span>
<a href="#l50.11"></a><span id="l50.11">         // us tweaking some pretty old message strings.</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-        eMsg.ReplaceSubstring(NS_LITERAL_STRING(&quot;%s&quot;), NS_LITERAL_STRING(&quot;%S&quot;));</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+        eMsg.ReplaceSubstring(u&quot;%s&quot;_ns, u&quot;%S&quot;_ns);</span>
<a href="#l50.14"></a><span id="l50.14">         nsTextFormatter::ssprintf(</span>
<a href="#l50.15"></a><span id="l50.15">             msg, eMsg.get(), NS_ConvertUTF8toUTF16(arg1).get(),</span>
<a href="#l50.16"></a><span id="l50.16">             arg2 ? NS_ConvertUTF8toUTF16(arg2).get() : nullptr);</span>
<a href="#l50.17"></a><span id="l50.17">       }</span>
<a href="#l50.18"></a><span id="l50.18">       break;</span>
<a href="#l50.19"></a><span id="l50.19">     default:</span>
<a href="#l50.20"></a><span id="l50.20">       NS_WARNING(&quot;falling to default error code&quot;);</span>
<a href="#l50.21"></a><span id="l50.21">       bundle-&gt;GetStringFromName(&quot;communicationsError&quot;, eMsg);</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -859,57 +859,57 @@ nsresult nsSmtpProtocol::SendEhloRespons</span>
<a href="#l50.23"></a><span id="l50.23">     if (responseLine.LowerCaseEqualsLiteral(&quot;starttls&quot;)) {</span>
<a href="#l50.24"></a><span id="l50.24">       SetFlag(SMTP_EHLO_STARTTLS_ENABLED);</span>
<a href="#l50.25"></a><span id="l50.25">     } else if (responseLine.LowerCaseEqualsLiteral(&quot;dsn&quot;)) {</span>
<a href="#l50.26"></a><span id="l50.26">       SetFlag(SMTP_EHLO_DSN_ENABLED);</span>
<a href="#l50.27"></a><span id="l50.27">     } else if (responseLine.LowerCaseEqualsLiteral(&quot;clientid&quot;)) {</span>
<a href="#l50.28"></a><span id="l50.28">       SetFlag(SMTP_EHLO_CLIENTID_ENABLED);</span>
<a href="#l50.29"></a><span id="l50.29">       // If we have &quot;clientid&quot; in the ehlo response, then TLS must be present.</span>
<a href="#l50.30"></a><span id="l50.30">       if (m_prefSocketType == nsMsgSocketType::SSL) m_tlsEnabled = true;</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-    } else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;AUTH&quot;),</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+    } else if (StringBeginsWith(responseLine, &quot;AUTH&quot;_ns,</span>
<a href="#l50.33"></a><span id="l50.33">                                 nsCaseInsensitiveCStringComparator)) {</span>
<a href="#l50.34"></a><span id="l50.34">       SetFlag(SMTP_AUTH);</span>
<a href="#l50.35"></a><span id="l50.35"> </span>
<a href="#l50.36"></a><span id="l50.36" class="difflineminus">-      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;GSSAPI&quot;),</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineplus">+      if (responseLine.Find(&quot;GSSAPI&quot;_ns,</span>
<a href="#l50.38"></a><span id="l50.38">                             /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l50.39"></a><span id="l50.39">         SetFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l50.40"></a><span id="l50.40"> </span>
<a href="#l50.41"></a><span id="l50.41" class="difflineminus">-      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;CRAM-MD5&quot;),</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineplus">+      if (responseLine.Find(&quot;CRAM-MD5&quot;_ns,</span>
<a href="#l50.43"></a><span id="l50.43">                             /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l50.44"></a><span id="l50.44">         SetFlag(SMTP_AUTH_CRAM_MD5_ENABLED);</span>
<a href="#l50.45"></a><span id="l50.45"> </span>
<a href="#l50.46"></a><span id="l50.46" class="difflineminus">-      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;NTLM&quot;),</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineplus">+      if (responseLine.Find(&quot;NTLM&quot;_ns,</span>
<a href="#l50.48"></a><span id="l50.48">                             /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l50.49"></a><span id="l50.49">         SetFlag(SMTP_AUTH_NTLM_ENABLED);</span>
<a href="#l50.50"></a><span id="l50.50"> </span>
<a href="#l50.51"></a><span id="l50.51" class="difflineminus">-      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;MSN&quot;),</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineplus">+      if (responseLine.Find(&quot;MSN&quot;_ns,</span>
<a href="#l50.53"></a><span id="l50.53">                             /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l50.54"></a><span id="l50.54">         SetFlag(SMTP_AUTH_MSN_ENABLED);</span>
<a href="#l50.55"></a><span id="l50.55"> </span>
<a href="#l50.56"></a><span id="l50.56" class="difflineminus">-      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;PLAIN&quot;),</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineplus">+      if (responseLine.Find(&quot;PLAIN&quot;_ns,</span>
<a href="#l50.58"></a><span id="l50.58">                             /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l50.59"></a><span id="l50.59">         SetFlag(SMTP_AUTH_PLAIN_ENABLED);</span>
<a href="#l50.60"></a><span id="l50.60"> </span>
<a href="#l50.61"></a><span id="l50.61" class="difflineminus">-      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;LOGIN&quot;),</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineplus">+      if (responseLine.Find(&quot;LOGIN&quot;_ns,</span>
<a href="#l50.63"></a><span id="l50.63">                             /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l50.64"></a><span id="l50.64">         SetFlag(SMTP_AUTH_LOGIN_ENABLED);</span>
<a href="#l50.65"></a><span id="l50.65"> </span>
<a href="#l50.66"></a><span id="l50.66" class="difflineminus">-      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;EXTERNAL&quot;),</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineplus">+      if (responseLine.Find(&quot;EXTERNAL&quot;_ns,</span>
<a href="#l50.68"></a><span id="l50.68">                             /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l50.69"></a><span id="l50.69">         SetFlag(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l50.70"></a><span id="l50.70"> </span>
<a href="#l50.71"></a><span id="l50.71" class="difflineminus">-      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;XOAUTH2&quot;),</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineplus">+      if (responseLine.Find(&quot;XOAUTH2&quot;_ns,</span>
<a href="#l50.73"></a><span id="l50.73">                             /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l50.74"></a><span id="l50.74">         SetFlag(SMTP_AUTH_OAUTH2_ENABLED);</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineminus">-    } else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;SIZE&quot;),</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineplus">+    } else if (StringBeginsWith(responseLine, &quot;SIZE&quot;_ns,</span>
<a href="#l50.77"></a><span id="l50.77">                                 nsCaseInsensitiveCStringComparator)) {</span>
<a href="#l50.78"></a><span id="l50.78">       SetFlag(SMTP_EHLO_SIZE_ENABLED);</span>
<a href="#l50.79"></a><span id="l50.79"> </span>
<a href="#l50.80"></a><span id="l50.80">       m_sizelimit = atol((responseLine.get()) + 4);</span>
<a href="#l50.81"></a><span id="l50.81" class="difflineminus">-    } else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;8BITMIME&quot;),</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineplus">+    } else if (StringBeginsWith(responseLine, &quot;8BITMIME&quot;_ns,</span>
<a href="#l50.83"></a><span id="l50.83">                                 nsCaseInsensitiveCStringComparator)) {</span>
<a href="#l50.84"></a><span id="l50.84">       SetFlag(SMTP_EHLO_8BIT_ENABLED);</span>
<a href="#l50.85"></a><span id="l50.85">     }</span>
<a href="#l50.86"></a><span id="l50.86"> </span>
<a href="#l50.87"></a><span id="l50.87">     startPos = endPos + 1;</span>
<a href="#l50.88"></a><span id="l50.88">   } while (endPos &gt;= 0);</span>
<a href="#l50.89"></a><span id="l50.89"> </span>
<a href="#l50.90"></a><span id="l50.90">   if (TestFlag(SMTP_EHLO_SIZE_ENABLED) &amp;&amp; m_sizelimit &gt; 0 &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -592,17 +592,17 @@ nsSmtpServer::ForgetPassword() {</span>
<a href="#l51.4"></a><span id="l51.4"> </span>
<a href="#l51.5"></a><span id="l51.5"> NS_IMETHODIMP</span>
<a href="#l51.6"></a><span id="l51.6"> nsSmtpServer::GetServerURI(nsACString&amp; aResult) {</span>
<a href="#l51.7"></a><span id="l51.7">   aResult = GetServerURIInternal(true);</span>
<a href="#l51.8"></a><span id="l51.8">   return NS_OK;</span>
<a href="#l51.9"></a><span id="l51.9"> }</span>
<a href="#l51.10"></a><span id="l51.10"> </span>
<a href="#l51.11"></a><span id="l51.11"> nsCString nsSmtpServer::GetServerURIInternal(const bool aIncludeUsername) {</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  nsCString uri(NS_LITERAL_CSTRING(&quot;smtp://&quot;));</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+  nsCString uri(&quot;smtp://&quot;_ns);</span>
<a href="#l51.14"></a><span id="l51.14">   nsresult rv;</span>
<a href="#l51.15"></a><span id="l51.15"> </span>
<a href="#l51.16"></a><span id="l51.16">   if (aIncludeUsername) {</span>
<a href="#l51.17"></a><span id="l51.17">     nsCString username;</span>
<a href="#l51.18"></a><span id="l51.18">     rv = GetUsername(username);</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20">     if (NS_SUCCEEDED(rv) &amp;&amp; !username.IsEmpty()) {</span>
<a href="#l51.21"></a><span id="l51.21">       nsCString escapedUsername;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -318,30 +318,30 @@ NS_IMETHODIMP nsSmtpService::NewChannel(</span>
<a href="#l52.4"></a><span id="l52.4"> </span>
<a href="#l52.5"></a><span id="l52.5">   // These always succeed because the pipe is initialized above.</span>
<a href="#l52.6"></a><span id="l52.6">   MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetInputStream(getter_AddRefs(pipeIn)));</span>
<a href="#l52.7"></a><span id="l52.7">   MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetOutputStream(getter_AddRefs(pipeOut)));</span>
<a href="#l52.8"></a><span id="l52.8"> </span>
<a href="#l52.9"></a><span id="l52.9">   pipeOut-&gt;Close();</span>
<a href="#l52.10"></a><span id="l52.10"> </span>
<a href="#l52.11"></a><span id="l52.11">   if (aLoadInfo) {</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-    return NS_NewInputStreamChannelInternal(</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-        _retval, aURI, pipeIn.forget(),</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineminus">-        NS_LITERAL_CSTRING(&quot;application/x-mailto&quot;), EmptyCString(), aLoadInfo);</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+    return NS_NewInputStreamChannelInternal(_retval, aURI, pipeIn.forget(),</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+                                            &quot;application/x-mailto&quot;_ns,</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+                                            EmptyCString(), aLoadInfo);</span>
<a href="#l52.18"></a><span id="l52.18">   }</span>
<a href="#l52.19"></a><span id="l52.19"> </span>
<a href="#l52.20"></a><span id="l52.20">   nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l52.21"></a><span id="l52.21">       do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l52.22"></a><span id="l52.22">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipal failed.&quot;);</span>
<a href="#l52.23"></a><span id="l52.23">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l52.24"></a><span id="l52.24"> </span>
<a href="#l52.25"></a><span id="l52.25">   return NS_NewInputStreamChannel(</span>
<a href="#l52.26"></a><span id="l52.26">       _retval, aURI, pipeIn.forget(), nullPrincipal,</span>
<a href="#l52.27"></a><span id="l52.27">       nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineminus">-      nsIContentPolicy::TYPE_OTHER, NS_LITERAL_CSTRING(&quot;application/x-mailto&quot;));</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineplus">+      nsIContentPolicy::TYPE_OTHER, &quot;application/x-mailto&quot;_ns);</span>
<a href="#l52.30"></a><span id="l52.30"> }</span>
<a href="#l52.31"></a><span id="l52.31"> </span>
<a href="#l52.32"></a><span id="l52.32"> NS_IMETHODIMP</span>
<a href="#l52.33"></a><span id="l52.33"> nsSmtpService::GetServers(nsISimpleEnumerator** aResult) {</span>
<a href="#l52.34"></a><span id="l52.34">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l52.35"></a><span id="l52.35"> </span>
<a href="#l52.36"></a><span id="l52.36">   // now read in the servers from prefs if necessary</span>
<a href="#l52.37"></a><span id="l52.37">   uint32_t serverCount = mSmtpServers.Count();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -920,21 +920,20 @@ class MsgDBReporter final : public nsIMe</span>
<a href="#l53.4"></a><span id="l53.4"> </span>
<a href="#l53.5"></a><span id="l53.5">   NS_IMETHOD CollectReports(nsIHandleReportCallback* aCb, nsISupports* aClosure,</span>
<a href="#l53.6"></a><span id="l53.6">                             bool aAnonymize) override {</span>
<a href="#l53.7"></a><span id="l53.7">     nsCString path;</span>
<a href="#l53.8"></a><span id="l53.8">     GetPath(path, aAnonymize);</span>
<a href="#l53.9"></a><span id="l53.9">     nsCOMPtr&lt;nsIMsgDatabase&gt; database = do_QueryReferent(mDatabase);</span>
<a href="#l53.10"></a><span id="l53.10">     nsMsgDatabase* db =</span>
<a href="#l53.11"></a><span id="l53.11">         database ? static_cast&lt;nsMsgDatabase*&gt;(database.get()) : nullptr;</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-    return aCb-&gt;Callback(</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-        EmptyCString(), path, nsIMemoryReporter::KIND_HEAP,</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-        nsIMemoryReporter::UNITS_BYTES,</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineminus">-        db ? db-&gt;SizeOfIncludingThis(GetMallocSize) : 0,</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineminus">-        NS_LITERAL_CSTRING(&quot;Memory used for the folder database.&quot;), aClosure);</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+    return aCb-&gt;Callback(EmptyCString(), path, nsIMemoryReporter::KIND_HEAP,</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineplus">+                         nsIMemoryReporter::UNITS_BYTES,</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+                         db ? db-&gt;SizeOfIncludingThis(GetMallocSize) : 0,</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineplus">+                         &quot;Memory used for the folder database.&quot;_ns, aClosure);</span>
<a href="#l53.21"></a><span id="l53.21">   }</span>
<a href="#l53.22"></a><span id="l53.22"> </span>
<a href="#l53.23"></a><span id="l53.23">   void GetPath(nsACString&amp; memoryPath, bool aAnonymize) {</span>
<a href="#l53.24"></a><span id="l53.24">     memoryPath.AssignLiteral(&quot;explicit/maildb/database(&quot;);</span>
<a href="#l53.25"></a><span id="l53.25">     nsCOMPtr&lt;nsIMsgDatabase&gt; database = do_QueryReferent(mDatabase);</span>
<a href="#l53.26"></a><span id="l53.26">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l53.27"></a><span id="l53.27">     if (database) database-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l53.28"></a><span id="l53.28">     if (folder) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -56,17 +56,17 @@ static mozilla::LazyLogModule BayesianFi</span>
<a href="#l54.4"></a><span id="l54.4"> static const char* kBayesianFilterTokenDelimiters = &quot; \t\n\r\f.&quot;;</span>
<a href="#l54.5"></a><span id="l54.5"> static unsigned int kMinLengthForToken =</span>
<a href="#l54.6"></a><span id="l54.6">     3;  // lower bound on the number of characters in a word before we treat it</span>
<a href="#l54.7"></a><span id="l54.7">         // as a token</span>
<a href="#l54.8"></a><span id="l54.8"> static unsigned int kMaxLengthForToken =</span>
<a href="#l54.9"></a><span id="l54.9">     12;  // upper bound on the number of characters in a word to be declared as</span>
<a href="#l54.10"></a><span id="l54.10">          // a token</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-#define FORGED_RECEIVED_HEADER_HINT NS_LITERAL_CSTRING(&quot;may be forged&quot;)</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+#define FORGED_RECEIVED_HEADER_HINT &quot;may be forged&quot;_ns</span>
<a href="#l54.14"></a><span id="l54.14"> </span>
<a href="#l54.15"></a><span id="l54.15"> #ifndef M_LN2</span>
<a href="#l54.16"></a><span id="l54.16"> #  define M_LN2 0.69314718055994530942</span>
<a href="#l54.17"></a><span id="l54.17"> #endif</span>
<a href="#l54.18"></a><span id="l54.18"> </span>
<a href="#l54.19"></a><span id="l54.19"> #ifndef M_E</span>
<a href="#l54.20"></a><span id="l54.20"> #  define M_E 2.7182818284590452354</span>
<a href="#l54.21"></a><span id="l54.21"> #endif</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineat">@@ -495,18 +495,17 @@ void Tokenizer::tokenizeHeaders(nsIUTF8S</span>
<a href="#l54.23"></a><span id="l54.23">         }</span>
<a href="#l54.24"></a><span id="l54.24"> </span>
<a href="#l54.25"></a><span id="l54.25">         // important: leave out sender field. Too strong of an indicator</span>
<a href="#l54.26"></a><span id="l54.26">         break;</span>
<a href="#l54.27"></a><span id="l54.27">       case 'x':  // (2) X-Mailer / user-agent works best if it is untokenized,</span>
<a href="#l54.28"></a><span id="l54.28">                  // just fold the case and any leading/trailing white space</span>
<a href="#l54.29"></a><span id="l54.29">         // all headers beginning with x-mozilla are being changed by us, so</span>
<a href="#l54.30"></a><span id="l54.30">         // ignore</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-        if (StringBeginsWith(headerName, NS_LITERAL_CSTRING(&quot;x-mozilla&quot;)))</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineminus">-          break;</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineplus">+        if (StringBeginsWith(headerName, &quot;x-mozilla&quot;_ns)) break;</span>
<a href="#l54.34"></a><span id="l54.34">         // fall through</span>
<a href="#l54.35"></a><span id="l54.35">         [[fallthrough]];</span>
<a href="#l54.36"></a><span id="l54.36">       case 'u':</span>
<a href="#l54.37"></a><span id="l54.37">         addTokenForHeader(headerName.get(), headerValue);</span>
<a href="#l54.38"></a><span id="l54.38">         break;</span>
<a href="#l54.39"></a><span id="l54.39">       default:</span>
<a href="#l54.40"></a><span id="l54.40">         addTokenForHeader(headerName.get(), headerValue);</span>
<a href="#l54.41"></a><span id="l54.41">         break;</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineat">@@ -737,20 +736,18 @@ void Tokenizer::tokenize(const char* aTe</span>
<a href="#l54.43"></a><span id="l54.43"> </span>
<a href="#l54.44"></a><span id="l54.44">   // RSS feeds store their summary information as an iframe. But due to</span>
<a href="#l54.45"></a><span id="l54.45">   // bug 365953, we can't see those in the plaintext serializer. As a</span>
<a href="#l54.46"></a><span id="l54.46">   // workaround, allow an option to replace iframe with div in the message</span>
<a href="#l54.47"></a><span id="l54.47">   // text. We disable by default, since most people won't be applying bayes</span>
<a href="#l54.48"></a><span id="l54.48">   // to RSS</span>
<a href="#l54.49"></a><span id="l54.49"> </span>
<a href="#l54.50"></a><span id="l54.50">   if (mIframeToDiv) {</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineminus">-    text.ReplaceSubstring(NS_LITERAL_STRING(&quot;&lt;iframe&quot;),</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineminus">-                          NS_LITERAL_STRING(&quot;&lt;div&quot;));</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineminus">-    text.ReplaceSubstring(NS_LITERAL_STRING(&quot;/iframe&gt;&quot;),</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineminus">-                          NS_LITERAL_STRING(&quot;/div&gt;&quot;));</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineplus">+    text.ReplaceSubstring(u&quot;&lt;iframe&quot;_ns, u&quot;&lt;div&quot;_ns);</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineplus">+    text.ReplaceSubstring(u&quot;/iframe&gt;&quot;_ns, u&quot;/div&gt;&quot;_ns);</span>
<a href="#l54.57"></a><span id="l54.57">   }</span>
<a href="#l54.58"></a><span id="l54.58"> </span>
<a href="#l54.59"></a><span id="l54.59">   stripHTML(text, strippedUCS2);</span>
<a href="#l54.60"></a><span id="l54.60"> </span>
<a href="#l54.61"></a><span id="l54.61">   // convert 0x3000(full width space) into 0x0020</span>
<a href="#l54.62"></a><span id="l54.62">   char16_t* substr_start = strippedUCS2.BeginWriting();</span>
<a href="#l54.63"></a><span id="l54.63">   char16_t* substr_end = strippedUCS2.EndWriting();</span>
<a href="#l54.64"></a><span id="l54.64">   while (substr_start != substr_end) {</span>
<a href="#l54.65"></a><span id="l54.65" class="difflineat">@@ -1278,20 +1275,19 @@ nsresult nsBayesianFilter::tokenizeMessa</span>
<a href="#l54.66"></a><span id="l54.66"> </span>
<a href="#l54.67"></a><span id="l54.67">   nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l54.68"></a><span id="l54.68">   nsresult rv = GetMessageServiceFromURI(nsDependentCString(aMessageURI),</span>
<a href="#l54.69"></a><span id="l54.69">                                          getter_AddRefs(msgService));</span>
<a href="#l54.70"></a><span id="l54.70">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.71"></a><span id="l54.71"> </span>
<a href="#l54.72"></a><span id="l54.72">   aAnalyzer-&gt;setSource(aMessageURI);</span>
<a href="#l54.73"></a><span id="l54.73">   nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineminus">-  return msgService-&gt;StreamMessage(aMessageURI, aAnalyzer-&gt;mTokenListener,</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineminus">-                                   aMsgWindow, nullptr, true /* convert data */,</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineminus">-                                   NS_LITERAL_CSTRING(&quot;filter&quot;), false,</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineminus">-                                   getter_AddRefs(dummyNull));</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+  return msgService-&gt;StreamMessage(</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineplus">+      aMessageURI, aAnalyzer-&gt;mTokenListener, aMsgWindow, nullptr,</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineplus">+      true /* convert data */, &quot;filter&quot;_ns, false, getter_AddRefs(dummyNull));</span>
<a href="#l54.81"></a><span id="l54.81"> }</span>
<a href="#l54.82"></a><span id="l54.82"> </span>
<a href="#l54.83"></a><span id="l54.83"> // a TraitAnalysis is the per-token representation of the statistical</span>
<a href="#l54.84"></a><span id="l54.84"> // calculations, basically created to group information that is then</span>
<a href="#l54.85"></a><span id="l54.85"> // sorted by mDistance</span>
<a href="#l54.86"></a><span id="l54.86"> struct TraitAnalysis {</span>
<a href="#l54.87"></a><span id="l54.87">   uint32_t mTokenIndex;</span>
<a href="#l54.88"></a><span id="l54.88">   double mDistance;</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineat">@@ -2163,31 +2159,31 @@ bool CorpusStore::readTokens(FILE* strea</span>
<a href="#l54.90"></a><span id="l54.90"> </span>
<a href="#l54.91"></a><span id="l54.91"> nsresult CorpusStore::getTrainingFile(nsIFile** aTrainingFile) {</span>
<a href="#l54.92"></a><span id="l54.92">   // should we cache the profile manager's directory?</span>
<a href="#l54.93"></a><span id="l54.93">   nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l54.94"></a><span id="l54.94"> </span>
<a href="#l54.95"></a><span id="l54.95">   nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l54.96"></a><span id="l54.96">                                        getter_AddRefs(profileDir));</span>
<a href="#l54.97"></a><span id="l54.97">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineminus">-  rv = profileDir-&gt;Append(NS_LITERAL_STRING(&quot;training.dat&quot;));</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+  rv = profileDir-&gt;Append(u&quot;training.dat&quot;_ns);</span>
<a href="#l54.100"></a><span id="l54.100">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.101"></a><span id="l54.101"> </span>
<a href="#l54.102"></a><span id="l54.102">   return profileDir-&gt;QueryInterface(NS_GET_IID(nsIFile), (void**)aTrainingFile);</span>
<a href="#l54.103"></a><span id="l54.103"> }</span>
<a href="#l54.104"></a><span id="l54.104"> </span>
<a href="#l54.105"></a><span id="l54.105"> nsresult CorpusStore::getTraitFile(nsIFile** aTraitFile) {</span>
<a href="#l54.106"></a><span id="l54.106">   // should we cache the profile manager's directory?</span>
<a href="#l54.107"></a><span id="l54.107">   nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l54.108"></a><span id="l54.108"> </span>
<a href="#l54.109"></a><span id="l54.109">   nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l54.110"></a><span id="l54.110">                                        getter_AddRefs(profileDir));</span>
<a href="#l54.111"></a><span id="l54.111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.112"></a><span id="l54.112"> </span>
<a href="#l54.113"></a><span id="l54.113" class="difflineminus">-  rv = profileDir-&gt;Append(NS_LITERAL_STRING(&quot;traits.dat&quot;));</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineplus">+  rv = profileDir-&gt;Append(u&quot;traits.dat&quot;_ns);</span>
<a href="#l54.115"></a><span id="l54.115">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.116"></a><span id="l54.116"> </span>
<a href="#l54.117"></a><span id="l54.117">   return profileDir-&gt;QueryInterface(NS_GET_IID(nsIFile), (void**)aTraitFile);</span>
<a href="#l54.118"></a><span id="l54.118"> }</span>
<a href="#l54.119"></a><span id="l54.119"> </span>
<a href="#l54.120"></a><span id="l54.120"> static const char kMagicCookie[] = {'\xFE', '\xED', '\xFA', '\xCE'};</span>
<a href="#l54.121"></a><span id="l54.121"> </span>
<a href="#l54.122"></a><span id="l54.122"> // random string used to identify trait file and version (last byte is version)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -25,37 +25,35 @@ nsFts3Tokenizer::nsFts3Tokenizer() {}</span>
<a href="#l55.4"></a><span id="l55.4"> nsFts3Tokenizer::~nsFts3Tokenizer() {}</span>
<a href="#l55.5"></a><span id="l55.5"> </span>
<a href="#l55.6"></a><span id="l55.6"> NS_IMETHODIMP</span>
<a href="#l55.7"></a><span id="l55.7"> nsFts3Tokenizer::RegisterTokenizer(mozIStorageConnection* connection) {</span>
<a href="#l55.8"></a><span id="l55.8">   nsresult rv;</span>
<a href="#l55.9"></a><span id="l55.9">   nsCOMPtr&lt;mozIStorageStatement&gt; selectStatement;</span>
<a href="#l55.10"></a><span id="l55.10"> </span>
<a href="#l55.11"></a><span id="l55.11">   // -- register the tokenizer</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-  rv = connection-&gt;CreateStatement(</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-      NS_LITERAL_CSTRING(&quot;SELECT fts3_tokenizer(?1, ?2)&quot;),</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-      getter_AddRefs(selectStatement));</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+  rv = connection-&gt;CreateStatement(&quot;SELECT fts3_tokenizer(?1, ?2)&quot;_ns,</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineplus">+                                   getter_AddRefs(selectStatement));</span>
<a href="#l55.17"></a><span id="l55.17">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l55.18"></a><span id="l55.18"> </span>
<a href="#l55.19"></a><span id="l55.19">   const sqlite3_tokenizer_module* module = nullptr;</span>
<a href="#l55.20"></a><span id="l55.20">   sqlite3Fts3PorterTokenizerModule(&amp;module);</span>
<a href="#l55.21"></a><span id="l55.21">   if (!module) return NS_ERROR_FAILURE;</span>
<a href="#l55.22"></a><span id="l55.22"> </span>
<a href="#l55.23"></a><span id="l55.23" class="difflineminus">-  rv = selectStatement-&gt;BindUTF8StringByIndex(0,</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-                                              NS_LITERAL_CSTRING(&quot;mozporter&quot;));</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineplus">+  rv = selectStatement-&gt;BindUTF8StringByIndex(0, &quot;mozporter&quot;_ns);</span>
<a href="#l55.26"></a><span id="l55.26">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l55.27"></a><span id="l55.27">   rv = selectStatement-&gt;BindBlobByIndex(1, (uint8_t*)&amp;module, sizeof(module));</span>
<a href="#l55.28"></a><span id="l55.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l55.29"></a><span id="l55.29"> </span>
<a href="#l55.30"></a><span id="l55.30">   bool hasMore;</span>
<a href="#l55.31"></a><span id="l55.31">   rv = selectStatement-&gt;ExecuteStep(&amp;hasMore);</span>
<a href="#l55.32"></a><span id="l55.32">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l55.33"></a><span id="l55.33"> </span>
<a href="#l55.34"></a><span id="l55.34">   // -- register the ranking function</span>
<a href="#l55.35"></a><span id="l55.35">   nsCOMPtr&lt;mozIStorageFunction&gt; func = new nsGlodaRankerFunction();</span>
<a href="#l55.36"></a><span id="l55.36">   NS_ENSURE_TRUE(func, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineminus">-  rv = connection-&gt;CreateFunction(NS_LITERAL_CSTRING(&quot;glodaRank&quot;),</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineplus">+  rv = connection-&gt;CreateFunction(&quot;glodaRank&quot;_ns,</span>
<a href="#l55.39"></a><span id="l55.39">                                   -1,  // variable argument support</span>
<a href="#l55.40"></a><span id="l55.40">                                   func);</span>
<a href="#l55.41"></a><span id="l55.41">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l55.42"></a><span id="l55.42"> </span>
<a href="#l55.43"></a><span id="l55.43">   return rv;</span>
<a href="#l55.44"></a><span id="l55.44"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsCertPicker.cpp</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsCertPicker.cpp</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -360,18 +360,18 @@ NS_IMETHODIMP nsCertPicker::PickByUsage(</span>
<a href="#l56.4"></a><span id="l56.4">           /* for the case when selectedNickname refers to nickname + serial */</span>
<a href="#l56.5"></a><span id="l56.5">           if (nickWithSerial == nsDependentString(selectedNickname)) {</span>
<a href="#l56.6"></a><span id="l56.6">             selectedIndex = CertsToUse;</span>
<a href="#l56.7"></a><span id="l56.7">             selectionFound = true;</span>
<a href="#l56.8"></a><span id="l56.8">           }</span>
<a href="#l56.9"></a><span id="l56.9">         }</span>
<a href="#l56.10"></a><span id="l56.10">       } else {</span>
<a href="#l56.11"></a><span id="l56.11">         // Placeholder, to keep the indexes valid.</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-        certNicknameList.AppendElement(NS_LITERAL_STRING(&quot;&quot;));</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-        certDetailsList.AppendElement(NS_LITERAL_STRING(&quot;&quot;));</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+        certNicknameList.AppendElement(u&quot;&quot;_ns);</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+        certDetailsList.AppendElement(u&quot;&quot;_ns);</span>
<a href="#l56.16"></a><span id="l56.16">       }</span>
<a href="#l56.17"></a><span id="l56.17"> </span>
<a href="#l56.18"></a><span id="l56.18">       ++CertsToUse;</span>
<a href="#l56.19"></a><span id="l56.19">     }</span>
<a href="#l56.20"></a><span id="l56.20">   }</span>
<a href="#l56.21"></a><span id="l56.21"> </span>
<a href="#l56.22"></a><span id="l56.22">   if (certNicknameList.IsEmpty()) {</span>
<a href="#l56.23"></a><span id="l56.23">     return NS_ERROR_NOT_AVAILABLE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -1092,17 +1092,17 @@ NS_IMETHODIMP nsImapIncomingServer::Poss</span>
<a href="#l57.4"></a><span id="l57.4">       // or the canonical path - one or the other, but be consistent.</span>
<a href="#l57.5"></a><span id="l57.5">       dupFolderPath.ReplaceChar('/', hierarchyDelimiter);</span>
<a href="#l57.6"></a><span id="l57.6">       if (hierarchyDelimiter != '/')</span>
<a href="#l57.7"></a><span id="l57.7">         nsImapUrl::UnescapeSlashes(dupFolderPath.BeginWriting());</span>
<a href="#l57.8"></a><span id="l57.8"> </span>
<a href="#l57.9"></a><span id="l57.9">       // GMail gives us a localized name for the inbox but doesn't let</span>
<a href="#l57.10"></a><span id="l57.10">       // us select that localized name.</span>
<a href="#l57.11"></a><span id="l57.11">       if (boxFlags &amp; kImapInbox)</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-        imapFolder-&gt;SetOnlineName(NS_LITERAL_CSTRING(&quot;INBOX&quot;));</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+        imapFolder-&gt;SetOnlineName(&quot;INBOX&quot;_ns);</span>
<a href="#l57.14"></a><span id="l57.14">       else if (onlineName.IsEmpty() || !onlineName.Equals(dupFolderPath))</span>
<a href="#l57.15"></a><span id="l57.15">         imapFolder-&gt;SetOnlineName(dupFolderPath);</span>
<a href="#l57.16"></a><span id="l57.16"> </span>
<a href="#l57.17"></a><span id="l57.17">       if (hierarchyDelimiter != '/')</span>
<a href="#l57.18"></a><span id="l57.18">         nsImapUrl::UnescapeSlashes(folderName.BeginWriting());</span>
<a href="#l57.19"></a><span id="l57.19">       if (NS_SUCCEEDED(CopyMUTF7toUTF16(folderName, unicodeName)))</span>
<a href="#l57.20"></a><span id="l57.20">         child-&gt;SetPrettyName(unicodeName);</span>
<a href="#l57.21"></a><span id="l57.21">     }</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineat">@@ -1317,32 +1317,32 @@ NS_IMETHODIMP nsImapIncomingServer::Disc</span>
<a href="#l57.23"></a><span id="l57.23">     if (NS_SUCCEEDED(rv) &amp;&amp; identity) {</span>
<a href="#l57.24"></a><span id="l57.24">       nsCString folderUri;</span>
<a href="#l57.25"></a><span id="l57.25">       identity-&gt;GetFccFolder(folderUri);</span>
<a href="#l57.26"></a><span id="l57.26">       nsCString existingUri;</span>
<a href="#l57.27"></a><span id="l57.27"> </span>
<a href="#l57.28"></a><span id="l57.28">       if (CheckSpecialFolder(folderUri, nsMsgFolderFlags::SentMail,</span>
<a href="#l57.29"></a><span id="l57.29">                              existingUri)) {</span>
<a href="#l57.30"></a><span id="l57.30">         identity-&gt;SetFccFolder(existingUri);</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineminus">-        identity-&gt;SetFccFolderPickerMode(NS_LITERAL_CSTRING(&quot;1&quot;));</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineplus">+        identity-&gt;SetFccFolderPickerMode(&quot;1&quot;_ns);</span>
<a href="#l57.33"></a><span id="l57.33">       }</span>
<a href="#l57.34"></a><span id="l57.34">       identity-&gt;GetDraftFolder(folderUri);</span>
<a href="#l57.35"></a><span id="l57.35">       if (CheckSpecialFolder(folderUri, nsMsgFolderFlags::Drafts,</span>
<a href="#l57.36"></a><span id="l57.36">                              existingUri)) {</span>
<a href="#l57.37"></a><span id="l57.37">         identity-&gt;SetDraftFolder(existingUri);</span>
<a href="#l57.38"></a><span id="l57.38" class="difflineminus">-        identity-&gt;SetDraftsFolderPickerMode(NS_LITERAL_CSTRING(&quot;1&quot;));</span>
<a href="#l57.39"></a><span id="l57.39" class="difflineplus">+        identity-&gt;SetDraftsFolderPickerMode(&quot;1&quot;_ns);</span>
<a href="#l57.40"></a><span id="l57.40">       }</span>
<a href="#l57.41"></a><span id="l57.41">       bool archiveEnabled;</span>
<a href="#l57.42"></a><span id="l57.42">       identity-&gt;GetArchiveEnabled(&amp;archiveEnabled);</span>
<a href="#l57.43"></a><span id="l57.43">       if (archiveEnabled) {</span>
<a href="#l57.44"></a><span id="l57.44">         identity-&gt;GetArchiveFolder(folderUri);</span>
<a href="#l57.45"></a><span id="l57.45">         if (CheckSpecialFolder(folderUri, nsMsgFolderFlags::Archive,</span>
<a href="#l57.46"></a><span id="l57.46">                                existingUri)) {</span>
<a href="#l57.47"></a><span id="l57.47">           identity-&gt;SetArchiveFolder(existingUri);</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineminus">-          identity-&gt;SetArchivesFolderPickerMode(NS_LITERAL_CSTRING(&quot;1&quot;));</span>
<a href="#l57.49"></a><span id="l57.49" class="difflineplus">+          identity-&gt;SetArchivesFolderPickerMode(&quot;1&quot;_ns);</span>
<a href="#l57.50"></a><span id="l57.50">         }</span>
<a href="#l57.51"></a><span id="l57.51">       }</span>
<a href="#l57.52"></a><span id="l57.52">       identity-&gt;GetStationeryFolder(folderUri);</span>
<a href="#l57.53"></a><span id="l57.53">       if (!folderUri.IsEmpty()) {</span>
<a href="#l57.54"></a><span id="l57.54">         nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l57.55"></a><span id="l57.55">         rv = GetOrCreateFolder(folderUri, getter_AddRefs(folder));</span>
<a href="#l57.56"></a><span id="l57.56">         if (NS_SUCCEEDED(rv)) rv = folder-&gt;SetFlag(nsMsgFolderFlags::Templates);</span>
<a href="#l57.57"></a><span id="l57.57">       }</span>
<a href="#l57.58"></a><span id="l57.58" class="difflineat">@@ -1679,17 +1679,17 @@ nsImapIncomingServer::FEAlert(const nsAS</span>
<a href="#l57.59"></a><span id="l57.59">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l57.60"></a><span id="l57.60">       nsString message;</span>
<a href="#l57.61"></a><span id="l57.61">       nsString tempString(aAlertString);</span>
<a href="#l57.62"></a><span id="l57.62">       AutoTArray&lt;nsString, 2&gt; params = {hostName, tempString};</span>
<a href="#l57.63"></a><span id="l57.63"> </span>
<a href="#l57.64"></a><span id="l57.64">       rv = m_stringBundle-&gt;FormatStringFromName(&quot;imapServerAlert&quot;, params,</span>
<a href="#l57.65"></a><span id="l57.65">                                                 message);</span>
<a href="#l57.66"></a><span id="l57.66">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l57.67"></a><span id="l57.67" class="difflineminus">-        aUrl-&gt;SetErrorCode(NS_LITERAL_CSTRING(&quot;imap-server-alert&quot;));</span>
<a href="#l57.68"></a><span id="l57.68" class="difflineplus">+        aUrl-&gt;SetErrorCode(&quot;imap-server-alert&quot;_ns);</span>
<a href="#l57.69"></a><span id="l57.69">         aUrl-&gt;SetErrorMessage(message);</span>
<a href="#l57.70"></a><span id="l57.70"> </span>
<a href="#l57.71"></a><span id="l57.71">         return AlertUser(message, aUrl);</span>
<a href="#l57.72"></a><span id="l57.72">       }</span>
<a href="#l57.73"></a><span id="l57.73">     }</span>
<a href="#l57.74"></a><span id="l57.74">   }</span>
<a href="#l57.75"></a><span id="l57.75">   return AlertUser(aAlertString, aUrl);</span>
<a href="#l57.76"></a><span id="l57.76"> }</span>
<a href="#l57.77"></a><span id="l57.77" class="difflineat">@@ -1769,17 +1769,17 @@ NS_IMETHODIMP nsImapIncomingServer::FEAl</span>
<a href="#l57.78"></a><span id="l57.78">   nsImapAction imapAction;</span>
<a href="#l57.79"></a><span id="l57.79"> </span>
<a href="#l57.80"></a><span id="l57.80">   imapUrl-&gt;GetRequiredImapState(&amp;imapState);</span>
<a href="#l57.81"></a><span id="l57.81">   imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l57.82"></a><span id="l57.82">   nsString folderName;</span>
<a href="#l57.83"></a><span id="l57.83"> </span>
<a href="#l57.84"></a><span id="l57.84">   NS_ConvertUTF8toUTF16 unicodeMsg(message);</span>
<a href="#l57.85"></a><span id="l57.85"> </span>
<a href="#l57.86"></a><span id="l57.86" class="difflineminus">-  aUrl-&gt;SetErrorCode(NS_LITERAL_CSTRING(&quot;imap-server-error&quot;));</span>
<a href="#l57.87"></a><span id="l57.87" class="difflineplus">+  aUrl-&gt;SetErrorCode(&quot;imap-server-error&quot;_ns);</span>
<a href="#l57.88"></a><span id="l57.88">   aUrl-&gt;SetErrorMessage(unicodeMsg);</span>
<a href="#l57.89"></a><span id="l57.89"> </span>
<a href="#l57.90"></a><span id="l57.90">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l57.91"></a><span id="l57.91">   if (imapState == nsIImapUrl::nsImapSelectedState ||</span>
<a href="#l57.92"></a><span id="l57.92">       imapAction == nsIImapUrl::nsImapFolderStatus) {</span>
<a href="#l57.93"></a><span id="l57.93">     aUrl-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l57.94"></a><span id="l57.94">     if (folder) folder-&gt;GetPrettyName(folderName);</span>
<a href="#l57.95"></a><span id="l57.95">     msgName = &quot;imapFolderCommandFailed&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -549,18 +549,18 @@ NS_IMETHODIMP nsImapMailFolder::GetSubFo</span>
<a href="#l58.4"></a><span id="l58.4">       rv = CreateSubFolders(pathFile);</span>
<a href="#l58.5"></a><span id="l58.5">     }</span>
<a href="#l58.6"></a><span id="l58.6">     if (isServer) {</span>
<a href="#l58.7"></a><span id="l58.7">       nsCOMPtr&lt;nsIMsgFolder&gt; inboxFolder;</span>
<a href="#l58.8"></a><span id="l58.8"> </span>
<a href="#l58.9"></a><span id="l58.9">       GetFolderWithFlags(nsMsgFolderFlags::Inbox, getter_AddRefs(inboxFolder));</span>
<a href="#l58.10"></a><span id="l58.10">       if (!inboxFolder) {</span>
<a href="#l58.11"></a><span id="l58.11">         // create an inbox if we don't have one.</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-        CreateClientSubfolderInfo(NS_LITERAL_CSTRING(&quot;INBOX&quot;),</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-                                  kOnlineHierarchySeparatorUnknown, 0, true);</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+        CreateClientSubfolderInfo(&quot;INBOX&quot;_ns, kOnlineHierarchySeparatorUnknown,</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+                                  0, true);</span>
<a href="#l58.16"></a><span id="l58.16">       }</span>
<a href="#l58.17"></a><span id="l58.17">     }</span>
<a href="#l58.18"></a><span id="l58.18"> </span>
<a href="#l58.19"></a><span id="l58.19">     int32_t count = mSubFolders.Count();</span>
<a href="#l58.20"></a><span id="l58.20">     nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l58.21"></a><span id="l58.21">     for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l58.22"></a><span id="l58.22">       mSubFolders[i]-&gt;GetSubFolders(getter_AddRefs(dummy));</span>
<a href="#l58.23"></a><span id="l58.23"> </span>
<a href="#l58.24"></a><span id="l58.24" class="difflineat">@@ -740,19 +740,18 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l58.25"></a><span id="l58.25"> </span>
<a href="#l58.26"></a><span id="l58.26">   bool isServer;</span>
<a href="#l58.27"></a><span id="l58.27">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l58.28"></a><span id="l58.28">   if (NS_SUCCEEDED(rv) &amp;&amp; isServer) {</span>
<a href="#l58.29"></a><span id="l58.29">     if (!m_haveDiscoveredAllFolders) {</span>
<a href="#l58.30"></a><span id="l58.30">       bool hasSubFolders = false;</span>
<a href="#l58.31"></a><span id="l58.31">       GetHasSubFolders(&amp;hasSubFolders);</span>
<a href="#l58.32"></a><span id="l58.32">       if (!hasSubFolders) {</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineminus">-        rv = CreateClientSubfolderInfo(NS_LITERAL_CSTRING(&quot;Inbox&quot;),</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineminus">-                                       kOnlineHierarchySeparatorUnknown, 0,</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineminus">-                                       false);</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+        rv = CreateClientSubfolderInfo(</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineplus">+            &quot;Inbox&quot;_ns, kOnlineHierarchySeparatorUnknown, 0, false);</span>
<a href="#l58.38"></a><span id="l58.38">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.39"></a><span id="l58.39">       }</span>
<a href="#l58.40"></a><span id="l58.40">       m_haveDiscoveredAllFolders = true;</span>
<a href="#l58.41"></a><span id="l58.41">     }</span>
<a href="#l58.42"></a><span id="l58.42">     selectFolder = false;</span>
<a href="#l58.43"></a><span id="l58.43">   }</span>
<a href="#l58.44"></a><span id="l58.44">   rv = GetDatabase();</span>
<a href="#l58.45"></a><span id="l58.45">   if (NS_FAILED(rv)) {</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineat">@@ -2959,22 +2958,19 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l58.47"></a><span id="l58.47">   }</span>
<a href="#l58.48"></a><span id="l58.48"> </span>
<a href="#l58.49"></a><span id="l58.49">   if (m_isGmailServer) {</span>
<a href="#l58.50"></a><span id="l58.50">     nsCOMPtr&lt;nsIImapFlagAndUidState&gt; flagState;</span>
<a href="#l58.51"></a><span id="l58.51">     aProtocol-&gt;GetFlagAndUidState(getter_AddRefs(flagState));</span>
<a href="#l58.52"></a><span id="l58.52">     nsCString msgIDValue;</span>
<a href="#l58.53"></a><span id="l58.53">     nsCString threadIDValue;</span>
<a href="#l58.54"></a><span id="l58.54">     nsCString labelsValue;</span>
<a href="#l58.55"></a><span id="l58.55" class="difflineminus">-    flagState-&gt;GetCustomAttribute(m_curMsgUid, NS_LITERAL_CSTRING(&quot;X-GM-MSGID&quot;),</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineminus">-                                  msgIDValue);</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineminus">-    flagState-&gt;GetCustomAttribute(m_curMsgUid, NS_LITERAL_CSTRING(&quot;X-GM-THRID&quot;),</span>
<a href="#l58.58"></a><span id="l58.58" class="difflineminus">-                                  threadIDValue);</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineminus">-    flagState-&gt;GetCustomAttribute(</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineminus">-        m_curMsgUid, NS_LITERAL_CSTRING(&quot;X-GM-LABELS&quot;), labelsValue);</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineplus">+    flagState-&gt;GetCustomAttribute(m_curMsgUid, &quot;X-GM-MSGID&quot;_ns, msgIDValue);</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineplus">+    flagState-&gt;GetCustomAttribute(m_curMsgUid, &quot;X-GM-THRID&quot;_ns, threadIDValue);</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineplus">+    flagState-&gt;GetCustomAttribute(m_curMsgUid, &quot;X-GM-LABELS&quot;_ns, labelsValue);</span>
<a href="#l58.64"></a><span id="l58.64">     newMsgHdr-&gt;SetStringProperty(&quot;X-GM-MSGID&quot;, msgIDValue.get());</span>
<a href="#l58.65"></a><span id="l58.65">     newMsgHdr-&gt;SetStringProperty(&quot;X-GM-THRID&quot;, threadIDValue.get());</span>
<a href="#l58.66"></a><span id="l58.66">     newMsgHdr-&gt;SetStringProperty(&quot;X-GM-LABELS&quot;, labelsValue.get());</span>
<a href="#l58.67"></a><span id="l58.67">   }</span>
<a href="#l58.68"></a><span id="l58.68"> </span>
<a href="#l58.69"></a><span id="l58.69">   m_msgParser-&gt;Clear();  // clear out parser, because it holds onto a msg hdr.</span>
<a href="#l58.70"></a><span id="l58.70">   m_msgParser-&gt;SetMailDB(nullptr);  // tell it to let go of the db too.</span>
<a href="#l58.71"></a><span id="l58.71">   // I don't think we want to do this - it does bad things like set the size</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineat">@@ -3309,19 +3305,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l58.73"></a><span id="l58.73">               mDatabase-&gt;MarkMDNSent(msgKey, true, nullptr);</span>
<a href="#l58.74"></a><span id="l58.74">             }</span>
<a href="#l58.75"></a><span id="l58.75">             nsresult rv = MoveIncorporatedMessage(</span>
<a href="#l58.76"></a><span id="l58.76">                 msgHdr, mDatabase, actionTargetFolderUri, filter, msgWindow);</span>
<a href="#l58.77"></a><span id="l58.77">             if (NS_SUCCEEDED(rv)) {</span>
<a href="#l58.78"></a><span id="l58.78">               m_msgMovedByFilter = true;</span>
<a href="#l58.79"></a><span id="l58.79">             } else {</span>
<a href="#l58.80"></a><span id="l58.80">               if (loggingEnabled) {</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineminus">-                (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l58.82"></a><span id="l58.82" class="difflineminus">-                    filterAction, msgHdr, rv,</span>
<a href="#l58.83"></a><span id="l58.83" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;filterFailureMoveFailed&quot;));</span>
<a href="#l58.84"></a><span id="l58.84" class="difflineplus">+                (void)filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l58.85"></a><span id="l58.85" class="difflineplus">+                                             &quot;filterFailureMoveFailed&quot;_ns);</span>
<a href="#l58.86"></a><span id="l58.86">               }</span>
<a href="#l58.87"></a><span id="l58.87">             }</span>
<a href="#l58.88"></a><span id="l58.88">           }</span>
<a href="#l58.89"></a><span id="l58.89">           // don't apply any more filters, even if it was a move to the same</span>
<a href="#l58.90"></a><span id="l58.90">           // folder</span>
<a href="#l58.91"></a><span id="l58.91">           *applyMore = false;</span>
<a href="#l58.92"></a><span id="l58.92">         } break;</span>
<a href="#l58.93"></a><span id="l58.93">         case nsMsgFilterAction::CopyToFolder: {</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineat">@@ -3351,19 +3346,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l58.95"></a><span id="l58.95"> </span>
<a href="#l58.96"></a><span id="l58.96">             nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l58.97"></a><span id="l58.97">                 do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l58.98"></a><span id="l58.98">             if (NS_FAILED(rv)) break;</span>
<a href="#l58.99"></a><span id="l58.99">             rv = copyService-&gt;CopyMessages(this, messageArray, dstFolder, false,</span>
<a href="#l58.100"></a><span id="l58.100">                                            nullptr, msgWindow, false);</span>
<a href="#l58.101"></a><span id="l58.101">             if (NS_FAILED(rv)) {</span>
<a href="#l58.102"></a><span id="l58.102">               if (loggingEnabled) {</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineminus">-                (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineminus">-                    filterAction, msgHdr, rv,</span>
<a href="#l58.105"></a><span id="l58.105" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l58.106"></a><span id="l58.106" class="difflineplus">+                (void)filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l58.107"></a><span id="l58.107" class="difflineplus">+                                             &quot;filterFailureCopyFailed&quot;_ns);</span>
<a href="#l58.108"></a><span id="l58.108">               }</span>
<a href="#l58.109"></a><span id="l58.109">             }</span>
<a href="#l58.110"></a><span id="l58.110">           }</span>
<a href="#l58.111"></a><span id="l58.111">         } break;</span>
<a href="#l58.112"></a><span id="l58.112">         case nsMsgFilterAction::MarkRead: {</span>
<a href="#l58.113"></a><span id="l58.113">           mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l58.114"></a><span id="l58.114">           rv = StoreImapFlags(kImapMsgSeenFlag, true, {msgKey}, nullptr);</span>
<a href="#l58.115"></a><span id="l58.115">           msgIsNew = false;</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineat">@@ -3498,21 +3492,21 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l58.117"></a><span id="l58.117">             if (NS_SUCCEEDED(rv) &amp;&amp; compService) {</span>
<a href="#l58.118"></a><span id="l58.118">               rv = compService-&gt;ReplyWithTemplate(</span>
<a href="#l58.119"></a><span id="l58.119">                   msgHdr, replyTemplateUri.get(), msgWindow, server);</span>
<a href="#l58.120"></a><span id="l58.120">               if (NS_FAILED(rv)) {</span>
<a href="#l58.121"></a><span id="l58.121">                 NS_WARNING(&quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l58.122"></a><span id="l58.122">                 if (rv == NS_ERROR_ABORT) {</span>
<a href="#l58.123"></a><span id="l58.123">                   (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l58.124"></a><span id="l58.124">                       filterAction, msgHdr, rv,</span>
<a href="#l58.125"></a><span id="l58.125" class="difflineminus">-                      NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l58.126"></a><span id="l58.126" class="difflineplus">+                      &quot;filterFailureSendingReplyAborted&quot;_ns);</span>
<a href="#l58.127"></a><span id="l58.127">                 } else {</span>
<a href="#l58.128"></a><span id="l58.128">                   (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l58.129"></a><span id="l58.129">                       filterAction, msgHdr, rv,</span>
<a href="#l58.130"></a><span id="l58.130" class="difflineminus">-                      NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span>
<a href="#l58.131"></a><span id="l58.131" class="difflineplus">+                      &quot;filterFailureSendingReplyError&quot;_ns);</span>
<a href="#l58.132"></a><span id="l58.132">                 }</span>
<a href="#l58.133"></a><span id="l58.133">               }</span>
<a href="#l58.134"></a><span id="l58.134">             }</span>
<a href="#l58.135"></a><span id="l58.135">           }</span>
<a href="#l58.136"></a><span id="l58.136">         } break;</span>
<a href="#l58.137"></a><span id="l58.137"> </span>
<a href="#l58.138"></a><span id="l58.138">         case nsMsgFilterAction::StopExecution: {</span>
<a href="#l58.139"></a><span id="l58.139">           // don't apply any more filters</span>
<a href="#l58.140"></a><span id="l58.140" class="difflineat">@@ -3550,17 +3544,17 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l58.141"></a><span id="l58.141">     }</span>
<a href="#l58.142"></a><span id="l58.142">     if (NS_FAILED(rv)) {</span>
<a href="#l58.143"></a><span id="l58.143">       finalResult = rv;</span>
<a href="#l58.144"></a><span id="l58.144">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l58.145"></a><span id="l58.145">               (&quot;(Imap) Action execution failed with error: %&quot; PRIx32,</span>
<a href="#l58.146"></a><span id="l58.146">                static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l58.147"></a><span id="l58.147">       if (loggingEnabled) {</span>
<a href="#l58.148"></a><span id="l58.148">         (void)filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l58.149"></a><span id="l58.149" class="difflineminus">-                                     NS_LITERAL_CSTRING(&quot;filterFailureAction&quot;));</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineplus">+                                     &quot;filterFailureAction&quot;_ns);</span>
<a href="#l58.151"></a><span id="l58.151">       }</span>
<a href="#l58.152"></a><span id="l58.152">     } else {</span>
<a href="#l58.153"></a><span id="l58.153">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l58.154"></a><span id="l58.154">               (&quot;(Imap) Action execution succeeded&quot;));</span>
<a href="#l58.155"></a><span id="l58.155">     }</span>
<a href="#l58.156"></a><span id="l58.156">   }</span>
<a href="#l58.157"></a><span id="l58.157">   if (!msgIsNew) {</span>
<a href="#l58.158"></a><span id="l58.158">     int32_t numNewMessages;</span>
<a href="#l58.159"></a><span id="l58.159" class="difflineat">@@ -4838,39 +4832,36 @@ nsImapMailFolder::GetCurMoveCopyMessageI</span>
<a href="#l58.160"></a><span id="l58.160">             isJunk = true;</span>
<a href="#l58.161"></a><span id="l58.161">         }</span>
<a href="#l58.162"></a><span id="l58.162"> </span>
<a href="#l58.163"></a><span id="l58.163">         nsCString keywords;  // MsgFindKeyword can't use nsACString</span>
<a href="#l58.164"></a><span id="l58.164">         mailCopyState-&gt;m_message-&gt;GetStringProperty(&quot;keywords&quot;,</span>
<a href="#l58.165"></a><span id="l58.165">                                                     getter_Copies(keywords));</span>
<a href="#l58.166"></a><span id="l58.166">         int32_t start;</span>
<a href="#l58.167"></a><span id="l58.167">         int32_t length;</span>
<a href="#l58.168"></a><span id="l58.168" class="difflineminus">-        bool hasJunk = MsgFindKeyword(NS_LITERAL_CSTRING(&quot;junk&quot;), keywords,</span>
<a href="#l58.169"></a><span id="l58.169" class="difflineminus">-                                      &amp;start, &amp;length);</span>
<a href="#l58.170"></a><span id="l58.170" class="difflineplus">+        bool hasJunk = MsgFindKeyword(&quot;junk&quot;_ns, keywords, &amp;start, &amp;length);</span>
<a href="#l58.171"></a><span id="l58.171">         if (hasJunk &amp;&amp; !isJunk)</span>
<a href="#l58.172"></a><span id="l58.172">           keywords.Cut(start, length);</span>
<a href="#l58.173"></a><span id="l58.173">         else if (!hasJunk &amp;&amp; isJunk)</span>
<a href="#l58.174"></a><span id="l58.174">           keywords.AppendLiteral(&quot; Junk&quot;);</span>
<a href="#l58.175"></a><span id="l58.175" class="difflineminus">-        bool hasNonJunk = MsgFindKeyword(NS_LITERAL_CSTRING(&quot;nonjunk&quot;),</span>
<a href="#l58.176"></a><span id="l58.176" class="difflineminus">-                                         keywords, &amp;start, &amp;length);</span>
<a href="#l58.177"></a><span id="l58.177" class="difflineplus">+        bool hasNonJunk =</span>
<a href="#l58.178"></a><span id="l58.178" class="difflineplus">+            MsgFindKeyword(&quot;nonjunk&quot;_ns, keywords, &amp;start, &amp;length);</span>
<a href="#l58.179"></a><span id="l58.179">         if (!hasNonJunk)</span>
<a href="#l58.180"></a><span id="l58.180" class="difflineminus">-          hasNonJunk = MsgFindKeyword(NS_LITERAL_CSTRING(&quot;notjunk&quot;), keywords,</span>
<a href="#l58.181"></a><span id="l58.181" class="difflineminus">-                                      &amp;start, &amp;length);</span>
<a href="#l58.182"></a><span id="l58.182" class="difflineplus">+          hasNonJunk = MsgFindKeyword(&quot;notjunk&quot;_ns, keywords, &amp;start, &amp;length);</span>
<a href="#l58.183"></a><span id="l58.183">         if (hasNonJunk &amp;&amp; !isNotJunk)</span>
<a href="#l58.184"></a><span id="l58.184">           keywords.Cut(start, length);</span>
<a href="#l58.185"></a><span id="l58.185">         else if (!hasNonJunk &amp;&amp; isNotJunk)</span>
<a href="#l58.186"></a><span id="l58.186">           keywords.AppendLiteral(&quot; NonJunk&quot;);</span>
<a href="#l58.187"></a><span id="l58.187"> </span>
<a href="#l58.188"></a><span id="l58.188">         // Cleanup extra spaces</span>
<a href="#l58.189"></a><span id="l58.189">         while (!keywords.IsEmpty() &amp;&amp; keywords.First() == ' ')</span>
<a href="#l58.190"></a><span id="l58.190">           keywords.Cut(0, 1);</span>
<a href="#l58.191"></a><span id="l58.191">         while (!keywords.IsEmpty() &amp;&amp; keywords.Last() == ' ')</span>
<a href="#l58.192"></a><span id="l58.192">           keywords.Cut(keywords.Length() - 1, 1);</span>
<a href="#l58.193"></a><span id="l58.193" class="difflineminus">-        while (!keywords.IsEmpty() &amp;&amp;</span>
<a href="#l58.194"></a><span id="l58.194" class="difflineminus">-               (start = keywords.Find(NS_LITERAL_CSTRING(&quot;  &quot;))) &gt;= 0)</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineplus">+        while (!keywords.IsEmpty() &amp;&amp; (start = keywords.Find(&quot;  &quot;_ns)) &gt;= 0)</span>
<a href="#l58.196"></a><span id="l58.196">           keywords.Cut(start, 1);</span>
<a href="#l58.197"></a><span id="l58.197">         aKeywords.Assign(keywords);</span>
<a href="#l58.198"></a><span id="l58.198">       }</span>
<a href="#l58.199"></a><span id="l58.199">     }</span>
<a href="#l58.200"></a><span id="l58.200">     // if we don't have a source header, and it's not the drafts folder,</span>
<a href="#l58.201"></a><span id="l58.201">     // then mark the message read, since it must be an append to the</span>
<a href="#l58.202"></a><span id="l58.202">     // fcc or templates folder.</span>
<a href="#l58.203"></a><span id="l58.203">     else if (mailCopyState) {</span>
<a href="#l58.204"></a><span id="l58.204" class="difflineat">@@ -6874,17 +6865,17 @@ void nsImapMailFolder::SetPendingAttribu</span>
<a href="#l58.205"></a><span id="l58.205">   if (aIsMove)</span>
<a href="#l58.206"></a><span id="l58.206">     prefBranch-&gt;GetCharPref(&quot;mailnews.database.summary.dontPreserveOnMove&quot;,</span>
<a href="#l58.207"></a><span id="l58.207">                             dontPreserve);</span>
<a href="#l58.208"></a><span id="l58.208">   else</span>
<a href="#l58.209"></a><span id="l58.209">     prefBranch-&gt;GetCharPref(&quot;mailnews.database.summary.dontPreserveOnCopy&quot;,</span>
<a href="#l58.210"></a><span id="l58.210">                             dontPreserve);</span>
<a href="#l58.211"></a><span id="l58.211"> </span>
<a href="#l58.212"></a><span id="l58.212">   // We'll add spaces at beginning and end so we can search for space-name-space</span>
<a href="#l58.213"></a><span id="l58.213" class="difflineminus">-  nsCString dontPreserveEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l58.214"></a><span id="l58.214" class="difflineplus">+  nsCString dontPreserveEx(&quot; &quot;_ns);</span>
<a href="#l58.215"></a><span id="l58.215">   dontPreserveEx.Append(dontPreserve);</span>
<a href="#l58.216"></a><span id="l58.216">   dontPreserveEx.Append(' ');</span>
<a href="#l58.217"></a><span id="l58.217"> </span>
<a href="#l58.218"></a><span id="l58.218">   // these properties are set as integers below, so don't set them again</span>
<a href="#l58.219"></a><span id="l58.219">   // in the iteration through the properties</span>
<a href="#l58.220"></a><span id="l58.220">   dontPreserveEx.AppendLiteral(</span>
<a href="#l58.221"></a><span id="l58.221">       &quot;offlineMsgSize msgOffset flags priority pseudoHdr &quot;);</span>
<a href="#l58.222"></a><span id="l58.222"> </span>
<a href="#l58.223"></a><span id="l58.223" class="difflineat">@@ -6916,17 +6907,17 @@ void nsImapMailFolder::SetPendingAttribu</span>
<a href="#l58.224"></a><span id="l58.224">         msgDBHdr-&gt;GetPropertyEnumerator(getter_AddRefs(propertyEnumerator));</span>
<a href="#l58.225"></a><span id="l58.225">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l58.226"></a><span id="l58.226"> </span>
<a href="#l58.227"></a><span id="l58.227">     nsAutoCString property;</span>
<a href="#l58.228"></a><span id="l58.228">     nsCString sourceString;</span>
<a href="#l58.229"></a><span id="l58.229">     bool hasMore;</span>
<a href="#l58.230"></a><span id="l58.230">     while (NS_SUCCEEDED(propertyEnumerator-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l58.231"></a><span id="l58.231">       propertyEnumerator-&gt;GetNext(property);</span>
<a href="#l58.232"></a><span id="l58.232" class="difflineminus">-      nsAutoCString propertyEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l58.233"></a><span id="l58.233" class="difflineplus">+      nsAutoCString propertyEx(&quot; &quot;_ns);</span>
<a href="#l58.234"></a><span id="l58.234">       propertyEx.Append(property);</span>
<a href="#l58.235"></a><span id="l58.235">       propertyEx.Append(' ');</span>
<a href="#l58.236"></a><span id="l58.236">       if (dontPreserveEx.Find(propertyEx) != kNotFound) continue;</span>
<a href="#l58.237"></a><span id="l58.237"> </span>
<a href="#l58.238"></a><span id="l58.238">       nsCString sourceString;</span>
<a href="#l58.239"></a><span id="l58.239">       msgDBHdr-&gt;GetStringProperty(property.get(), getter_Copies(sourceString));</span>
<a href="#l58.240"></a><span id="l58.240">       mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, property.get(),</span>
<a href="#l58.241"></a><span id="l58.241">                                           sourceString.get());</span>
<a href="#l58.242"></a><span id="l58.242" class="difflineat">@@ -8384,26 +8375,24 @@ bool nsImapMailFolder::ShowPreviewText()</span>
<a href="#l58.243"></a><span id="l58.243">     prefBranch-&gt;GetBoolPref(&quot;mail.biff.alert.show_preview&quot;, &amp;showPreviewText);</span>
<a href="#l58.244"></a><span id="l58.244">   return showPreviewText;</span>
<a href="#l58.245"></a><span id="l58.245"> }</span>
<a href="#l58.246"></a><span id="l58.246"> </span>
<a href="#l58.247"></a><span id="l58.247"> nsresult nsImapMailFolder::PlaybackCoalescedOperations() {</span>
<a href="#l58.248"></a><span id="l58.248">   if (m_moveCoalescer) {</span>
<a href="#l58.249"></a><span id="l58.249">     nsTArray&lt;nsMsgKey&gt;* junkKeysToClassify = m_moveCoalescer-&gt;GetKeyBucket(0);</span>
<a href="#l58.250"></a><span id="l58.250">     if (junkKeysToClassify &amp;&amp; !junkKeysToClassify-&gt;IsEmpty())</span>
<a href="#l58.251"></a><span id="l58.251" class="difflineminus">-      StoreCustomKeywords(m_moveCoalescer-&gt;GetMsgWindow(),</span>
<a href="#l58.252"></a><span id="l58.252" class="difflineminus">-                          NS_LITERAL_CSTRING(&quot;Junk&quot;), EmptyCString(),</span>
<a href="#l58.253"></a><span id="l58.253" class="difflineminus">-                          *junkKeysToClassify, nullptr);</span>
<a href="#l58.254"></a><span id="l58.254" class="difflineplus">+      StoreCustomKeywords(m_moveCoalescer-&gt;GetMsgWindow(), &quot;Junk&quot;_ns,</span>
<a href="#l58.255"></a><span id="l58.255" class="difflineplus">+                          EmptyCString(), *junkKeysToClassify, nullptr);</span>
<a href="#l58.256"></a><span id="l58.256">     junkKeysToClassify-&gt;Clear();</span>
<a href="#l58.257"></a><span id="l58.257">     nsTArray&lt;nsMsgKey&gt;* nonJunkKeysToClassify =</span>
<a href="#l58.258"></a><span id="l58.258">         m_moveCoalescer-&gt;GetKeyBucket(1);</span>
<a href="#l58.259"></a><span id="l58.259">     if (nonJunkKeysToClassify &amp;&amp; !nonJunkKeysToClassify-&gt;IsEmpty())</span>
<a href="#l58.260"></a><span id="l58.260" class="difflineminus">-      StoreCustomKeywords(m_moveCoalescer-&gt;GetMsgWindow(),</span>
<a href="#l58.261"></a><span id="l58.261" class="difflineminus">-                          NS_LITERAL_CSTRING(&quot;NonJunk&quot;), EmptyCString(),</span>
<a href="#l58.262"></a><span id="l58.262" class="difflineminus">-                          *nonJunkKeysToClassify, nullptr);</span>
<a href="#l58.263"></a><span id="l58.263" class="difflineplus">+      StoreCustomKeywords(m_moveCoalescer-&gt;GetMsgWindow(), &quot;NonJunk&quot;_ns,</span>
<a href="#l58.264"></a><span id="l58.264" class="difflineplus">+                          EmptyCString(), *nonJunkKeysToClassify, nullptr);</span>
<a href="#l58.265"></a><span id="l58.265">     nonJunkKeysToClassify-&gt;Clear();</span>
<a href="#l58.266"></a><span id="l58.266">     return m_moveCoalescer-&gt;PlaybackMoves(ShowPreviewText());</span>
<a href="#l58.267"></a><span id="l58.267">   }</span>
<a href="#l58.268"></a><span id="l58.268">   return NS_OK;  // must not be any coalesced operations</span>
<a href="#l58.269"></a><span id="l58.269"> }</span>
<a href="#l58.270"></a><span id="l58.270"> </span>
<a href="#l58.271"></a><span id="l58.271"> NS_IMETHODIMP</span>
<a href="#l58.272"></a><span id="l58.272"> nsImapMailFolder::SetJunkScoreForMessages(</span>
<a href="#l58.273"></a><span id="l58.273" class="difflineat">@@ -8411,22 +8400,19 @@ nsImapMailFolder::SetJunkScoreForMessage</span>
<a href="#l58.274"></a><span id="l58.274">     const nsACString&amp; aJunkScore) {</span>
<a href="#l58.275"></a><span id="l58.275">   nsresult rv = nsMsgDBFolder::SetJunkScoreForMessages(aMessages, aJunkScore);</span>
<a href="#l58.276"></a><span id="l58.276">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l58.277"></a><span id="l58.277">     nsAutoCString messageIds;</span>
<a href="#l58.278"></a><span id="l58.278">     nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l58.279"></a><span id="l58.279">     nsresult rv = BuildIdsAndKeyArray2(aMessages, messageIds, keys);</span>
<a href="#l58.280"></a><span id="l58.280">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.281"></a><span id="l58.281">     StoreCustomKeywords(</span>
<a href="#l58.282"></a><span id="l58.282" class="difflineminus">-        nullptr,</span>
<a href="#l58.283"></a><span id="l58.283" class="difflineminus">-        aJunkScore.EqualsLiteral(&quot;0&quot;) ? NS_LITERAL_CSTRING(&quot;NonJunk&quot;)</span>
<a href="#l58.284"></a><span id="l58.284" class="difflineminus">-                                      : NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l58.285"></a><span id="l58.285" class="difflineminus">-        aJunkScore.EqualsLiteral(&quot;0&quot;) ? NS_LITERAL_CSTRING(&quot;Junk&quot;)</span>
<a href="#l58.286"></a><span id="l58.286" class="difflineminus">-                                      : NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l58.287"></a><span id="l58.287" class="difflineminus">-        keys, nullptr);</span>
<a href="#l58.288"></a><span id="l58.288" class="difflineplus">+        nullptr, aJunkScore.EqualsLiteral(&quot;0&quot;) ? &quot;NonJunk&quot;_ns : &quot;Junk&quot;_ns,</span>
<a href="#l58.289"></a><span id="l58.289" class="difflineplus">+        aJunkScore.EqualsLiteral(&quot;0&quot;) ? &quot;Junk&quot;_ns : &quot;NonJunk&quot;_ns, keys,</span>
<a href="#l58.290"></a><span id="l58.290" class="difflineplus">+        nullptr);</span>
<a href="#l58.291"></a><span id="l58.291">     if (mDatabase) mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l58.292"></a><span id="l58.292">   }</span>
<a href="#l58.293"></a><span id="l58.293">   return rv;</span>
<a href="#l58.294"></a><span id="l58.294"> }</span>
<a href="#l58.295"></a><span id="l58.295"> </span>
<a href="#l58.296"></a><span id="l58.296"> NS_IMETHODIMP</span>
<a href="#l58.297"></a><span id="l58.297"> nsImapMailFolder::OnMessageClassified(const char* aMsgURI,</span>
<a href="#l58.298"></a><span id="l58.298">                                       nsMsgJunkStatus aClassification,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -2934,17 +2934,17 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l59.4"></a><span id="l59.4">             HandleMemoryFailure();</span>
<a href="#l59.5"></a><span id="l59.5">         } break;</span>
<a href="#l59.6"></a><span id="l59.6">         case nsIImapUrl::nsImapDeleteFolderAndMsgs:</span>
<a href="#l59.7"></a><span id="l59.7">           DeleteFolderAndMsgs(mailboxName.get());</span>
<a href="#l59.8"></a><span id="l59.8">           break;</span>
<a href="#l59.9"></a><span id="l59.9">         case nsIImapUrl::nsImapDeleteAllMsgs: {</span>
<a href="#l59.10"></a><span id="l59.10">           uint32_t numberOfMessages = GetServerStateParser().NumberOfMessages();</span>
<a href="#l59.11"></a><span id="l59.11">           if (numberOfMessages) {</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-            Store(NS_LITERAL_CSTRING(&quot;1:*&quot;), &quot;+FLAGS.SILENT (\\Deleted)&quot;,</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+            Store(&quot;1:*&quot;_ns, &quot;+FLAGS.SILENT (\\Deleted)&quot;,</span>
<a href="#l59.14"></a><span id="l59.14">                   false);  // use sequence #'s</span>
<a href="#l59.15"></a><span id="l59.15"> </span>
<a href="#l59.16"></a><span id="l59.16">             if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l59.17"></a><span id="l59.17">               Expunge();  // expunge messages with deleted flag</span>
<a href="#l59.18"></a><span id="l59.18">             if (GetServerStateParser().LastCommandSuccessful()) {</span>
<a href="#l59.19"></a><span id="l59.19">               // convert name back from utf7</span>
<a href="#l59.20"></a><span id="l59.20">               nsCString canonicalName;</span>
<a href="#l59.21"></a><span id="l59.21">               const char* selectedMailboxName =</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineat">@@ -4175,17 +4175,17 @@ void nsImapProtocol::ProcessMailboxUpdat</span>
<a href="#l59.23"></a><span id="l59.23">           bool expungeHappened = numNewUIDs != (numExists - numPrevExists);</span>
<a href="#l59.24"></a><span id="l59.24">           if (expungeHappened) {</span>
<a href="#l59.25"></a><span id="l59.25">             // Sanity check failed - need full fetch to remove expunged msgs.</span>
<a href="#l59.26"></a><span id="l59.26">             MOZ_LOG(IMAP_CS, LogLevel::Debug,</span>
<a href="#l59.27"></a><span id="l59.27">                     (&quot;Other client expunged msgs, do full fetch to remove &quot;</span>
<a href="#l59.28"></a><span id="l59.28">                      &quot;expunged msgs&quot;));</span>
<a href="#l59.29"></a><span id="l59.29">             m_flagState-&gt;Reset();</span>
<a href="#l59.30"></a><span id="l59.30">             m_flagState-&gt;SetPartialUIDFetch(false);</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineminus">-            FetchMessage(NS_LITERAL_CSTRING(&quot;1:*&quot;), kFlags);</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineplus">+            FetchMessage(&quot;1:*&quot;_ns, kFlags);</span>
<a href="#l59.33"></a><span id="l59.33">           } else if (numNewUIDs == 0) {</span>
<a href="#l59.34"></a><span id="l59.34">             // Nothing has been expunged and no new UIDs, so if just a flag</span>
<a href="#l59.35"></a><span id="l59.35">             // change on existing message(s), avoid unneeded fetch of flags for</span>
<a href="#l59.36"></a><span id="l59.36">             // messages with UIDs at and above uid (see var uid above) when</span>
<a href="#l59.37"></a><span id="l59.37">             // &quot;highwater mark&quot; fetch occurs below.</span>
<a href="#l59.38"></a><span id="l59.38">             if (mFolderHighestUID &amp;&amp; flagChangeDetected) {</span>
<a href="#l59.39"></a><span id="l59.39">               MOZ_LOG(IMAP_CS, LogLevel::Debug,</span>
<a href="#l59.40"></a><span id="l59.40">                       (&quot;Avoid unneeded fetches after just flag changes&quot;));</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineat">@@ -4895,17 +4895,17 @@ void nsImapProtocol::DiscoverMailboxSpec</span>
<a href="#l59.42"></a><span id="l59.42">           }</span>
<a href="#l59.43"></a><span id="l59.43">         }</span>
<a href="#l59.44"></a><span id="l59.44"> </span>
<a href="#l59.45"></a><span id="l59.45">         // Don't set the Trash flag if not using the Trash model</span>
<a href="#l59.46"></a><span id="l59.46">         if (GetDeleteIsMoveToTrash() &amp;&amp; !onlineTrashFolderExists &amp;&amp;</span>
<a href="#l59.47"></a><span id="l59.47">             adoptedBoxSpec-&gt;mAllocatedPathName.Find(</span>
<a href="#l59.48"></a><span id="l59.48">                 m_trashFolderPath, /* ignoreCase = */ true) != -1) {</span>
<a href="#l59.49"></a><span id="l59.49">           bool trashExists = false;</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineminus">-          if (StringBeginsWith(m_trashFolderPath, NS_LITERAL_CSTRING(&quot;INBOX/&quot;),</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineplus">+          if (StringBeginsWith(m_trashFolderPath, &quot;INBOX/&quot;_ns,</span>
<a href="#l59.52"></a><span id="l59.52">                                nsCaseInsensitiveCStringComparator)) {</span>
<a href="#l59.53"></a><span id="l59.53">             nsAutoCString pathName(adoptedBoxSpec-&gt;mAllocatedPathName.get() +</span>
<a href="#l59.54"></a><span id="l59.54">                                    6);</span>
<a href="#l59.55"></a><span id="l59.55">             trashExists =</span>
<a href="#l59.56"></a><span id="l59.56">                 StringBeginsWith(</span>
<a href="#l59.57"></a><span id="l59.57">                     adoptedBoxSpec-&gt;mAllocatedPathName, m_trashFolderPath,</span>
<a href="#l59.58"></a><span id="l59.58">                     nsCaseInsensitiveCStringComparator) &amp;&amp; /* &quot;INBOX/&quot; */</span>
<a href="#l59.59"></a><span id="l59.59">                 pathName.Equals(Substring(m_trashFolderPath, 6),</span>
<a href="#l59.60"></a><span id="l59.60" class="difflineat">@@ -6844,17 +6844,17 @@ void nsImapProtocol::OnDeleteFolder(cons</span>
<a href="#l59.61"></a><span id="l59.61">     if (deleted) FolderDeleted(sourceMailbox);</span>
<a href="#l59.62"></a><span id="l59.62">   }</span>
<a href="#l59.63"></a><span id="l59.63"> }</span>
<a href="#l59.64"></a><span id="l59.64"> </span>
<a href="#l59.65"></a><span id="l59.65"> void nsImapProtocol::RemoveMsgsAndExpunge() {</span>
<a href="#l59.66"></a><span id="l59.66">   uint32_t numberOfMessages = GetServerStateParser().NumberOfMessages();</span>
<a href="#l59.67"></a><span id="l59.67">   if (numberOfMessages) {</span>
<a href="#l59.68"></a><span id="l59.68">     // Remove all msgs and expunge the folder (ie, compact it).</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineminus">-    Store(NS_LITERAL_CSTRING(&quot;1:*&quot;), &quot;+FLAGS.SILENT (\\Deleted)&quot;,</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineplus">+    Store(&quot;1:*&quot;_ns, &quot;+FLAGS.SILENT (\\Deleted)&quot;,</span>
<a href="#l59.71"></a><span id="l59.71">           false);  // use sequence #'s</span>
<a href="#l59.72"></a><span id="l59.72">     if (GetServerStateParser().LastCommandSuccessful()) Expunge();</span>
<a href="#l59.73"></a><span id="l59.73">   }</span>
<a href="#l59.74"></a><span id="l59.74"> }</span>
<a href="#l59.75"></a><span id="l59.75"> </span>
<a href="#l59.76"></a><span id="l59.76"> void nsImapProtocol::DeleteFolderAndMsgs(const char* sourceMailbox) {</span>
<a href="#l59.77"></a><span id="l59.77">   RemoveMsgsAndExpunge();</span>
<a href="#l59.78"></a><span id="l59.78">   if (GetServerStateParser().LastCommandSuccessful()) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -1126,52 +1126,50 @@ void nsImapServerResponseParser::msg_fet</span>
<a href="#l60.4"></a><span id="l60.4">       else {</span>
<a href="#l60.5"></a><span id="l60.5">         fMsgID = CreateAtom();</span>
<a href="#l60.6"></a><span id="l60.6">         AdvanceToNextToken();</span>
<a href="#l60.7"></a><span id="l60.7">         nsCString msgIDValue;</span>
<a href="#l60.8"></a><span id="l60.8">         msgIDValue.Assign(fMsgID);</span>
<a href="#l60.9"></a><span id="l60.9">         if (fCurrentResponseUID == 0)</span>
<a href="#l60.10"></a><span id="l60.10">           fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l60.11"></a><span id="l60.11">                                       &amp;fCurrentResponseUID);</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-        fFlagState-&gt;SetCustomAttribute(</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineminus">-            fCurrentResponseUID, NS_LITERAL_CSTRING(&quot;X-GM-MSGID&quot;), msgIDValue);</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+        fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID, &quot;X-GM-MSGID&quot;_ns,</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+                                       msgIDValue);</span>
<a href="#l60.16"></a><span id="l60.16">         PR_FREEIF(fMsgID);</span>
<a href="#l60.17"></a><span id="l60.17">       }</span>
<a href="#l60.18"></a><span id="l60.18">     } else if (!PL_strcasecmp(fNextToken, &quot;X-GM-THRID&quot;)) {</span>
<a href="#l60.19"></a><span id="l60.19">       AdvanceToNextToken();</span>
<a href="#l60.20"></a><span id="l60.20">       if (!fNextToken)</span>
<a href="#l60.21"></a><span id="l60.21">         SetSyntaxError(true);</span>
<a href="#l60.22"></a><span id="l60.22">       else {</span>
<a href="#l60.23"></a><span id="l60.23">         fThreadID = CreateAtom();</span>
<a href="#l60.24"></a><span id="l60.24">         AdvanceToNextToken();</span>
<a href="#l60.25"></a><span id="l60.25">         nsCString threadIDValue;</span>
<a href="#l60.26"></a><span id="l60.26">         threadIDValue.Assign(fThreadID);</span>
<a href="#l60.27"></a><span id="l60.27">         if (fCurrentResponseUID == 0)</span>
<a href="#l60.28"></a><span id="l60.28">           fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l60.29"></a><span id="l60.29">                                       &amp;fCurrentResponseUID);</span>
<a href="#l60.30"></a><span id="l60.30" class="difflineminus">-        fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineminus">-                                       NS_LITERAL_CSTRING(&quot;X-GM-THRID&quot;),</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+        fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID, &quot;X-GM-THRID&quot;_ns,</span>
<a href="#l60.33"></a><span id="l60.33">                                        threadIDValue);</span>
<a href="#l60.34"></a><span id="l60.34">         PR_FREEIF(fThreadID);</span>
<a href="#l60.35"></a><span id="l60.35">       }</span>
<a href="#l60.36"></a><span id="l60.36">     } else if (!PL_strcasecmp(fNextToken, &quot;X-GM-LABELS&quot;)) {</span>
<a href="#l60.37"></a><span id="l60.37">       AdvanceToNextToken();</span>
<a href="#l60.38"></a><span id="l60.38">       if (!fNextToken)</span>
<a href="#l60.39"></a><span id="l60.39">         SetSyntaxError(true);</span>
<a href="#l60.40"></a><span id="l60.40">       else {</span>
<a href="#l60.41"></a><span id="l60.41">         fLabels = CreateParenGroup();</span>
<a href="#l60.42"></a><span id="l60.42">         nsCString labelsValue;</span>
<a href="#l60.43"></a><span id="l60.43">         labelsValue.Assign(fLabels);</span>
<a href="#l60.44"></a><span id="l60.44">         labelsValue.Cut(0, 1);</span>
<a href="#l60.45"></a><span id="l60.45">         labelsValue.Cut(labelsValue.Length() - 1, 1);</span>
<a href="#l60.46"></a><span id="l60.46">         if (fCurrentResponseUID == 0)</span>
<a href="#l60.47"></a><span id="l60.47">           fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l60.48"></a><span id="l60.48">                                       &amp;fCurrentResponseUID);</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineminus">-        fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineminus">-                                       NS_LITERAL_CSTRING(&quot;X-GM-LABELS&quot;),</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+        fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID, &quot;X-GM-LABELS&quot;_ns,</span>
<a href="#l60.52"></a><span id="l60.52">                                        labelsValue);</span>
<a href="#l60.53"></a><span id="l60.53">         PR_FREEIF(fLabels);</span>
<a href="#l60.54"></a><span id="l60.54">       }</span>
<a href="#l60.55"></a><span id="l60.55">     }</span>
<a href="#l60.56"></a><span id="l60.56"> </span>
<a href="#l60.57"></a><span id="l60.57">     // I only fetch RFC822 so I should never see these BODY responses</span>
<a href="#l60.58"></a><span id="l60.58">     else if (!PL_strcasecmp(fNextToken, &quot;BODY&quot;))</span>
<a href="#l60.59"></a><span id="l60.59">       skip_to_CRLF();  // I never ask for this</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineat">@@ -1348,17 +1346,17 @@ void nsImapServerResponseParser::xaolenv</span>
<a href="#l60.61"></a><span id="l60.61">     if (ContinueParse()) {</span>
<a href="#l60.62"></a><span id="l60.62">       AdvanceToNextToken();</span>
<a href="#l60.63"></a><span id="l60.63">       if (ContinueParse()) {</span>
<a href="#l60.64"></a><span id="l60.64">         nsAutoCString fromLine;</span>
<a href="#l60.65"></a><span id="l60.65">         if (!strcmp(GetSelectedMailboxName(), &quot;Sent Items&quot;)) {</span>
<a href="#l60.66"></a><span id="l60.66">           // xaol envelope switches the From with the To, so we switch them back</span>
<a href="#l60.67"></a><span id="l60.67">           // and create a fake from line From: user@aol.com</span>
<a href="#l60.68"></a><span id="l60.68">           fromLine.AppendLiteral(&quot;To: &quot;);</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineminus">-          nsAutoCString fakeFromLine(NS_LITERAL_CSTRING(&quot;From: &quot;));</span>
<a href="#l60.70"></a><span id="l60.70" class="difflineplus">+          nsAutoCString fakeFromLine(&quot;From: &quot;_ns);</span>
<a href="#l60.71"></a><span id="l60.71">           fakeFromLine.Append(fServerConnection.GetImapUserName());</span>
<a href="#l60.72"></a><span id="l60.72">           fakeFromLine.AppendLiteral(&quot;@aol.com&quot;);</span>
<a href="#l60.73"></a><span id="l60.73">           fServerConnection.HandleMessageDownLoadLine(fakeFromLine.get(),</span>
<a href="#l60.74"></a><span id="l60.74">                                                       false);</span>
<a href="#l60.75"></a><span id="l60.75">         } else {</span>
<a href="#l60.76"></a><span id="l60.76">           fromLine.AppendLiteral(&quot;From: &quot;);</span>
<a href="#l60.77"></a><span id="l60.77">         }</span>
<a href="#l60.78"></a><span id="l60.78">         parse_address(fromLine);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -216,18 +216,17 @@ NS_IMETHODIMP nsImapService::LiteSelectF</span>
<a href="#l61.4"></a><span id="l61.4">                        nsIImapUrl::nsImapLiteSelectFolder, aMsgWindow, aURL);</span>
<a href="#l61.5"></a><span id="l61.5"> }</span>
<a href="#l61.6"></a><span id="l61.6"> </span>
<a href="#l61.7"></a><span id="l61.7"> NS_IMETHODIMP nsImapService::GetUrlForUri(const char* aMessageURI,</span>
<a href="#l61.8"></a><span id="l61.8">                                           nsIURI** aURL,</span>
<a href="#l61.9"></a><span id="l61.9">                                           nsIMsgWindow* aMsgWindow) {</span>
<a href="#l61.10"></a><span id="l61.10">   nsAutoCString messageURI(aMessageURI);</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-  if (messageURI.Find(NS_LITERAL_CSTRING(</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineminus">-          &quot;&amp;type=application/x-message-display&quot;)) != kNotFound)</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+  if (messageURI.Find(&quot;&amp;type=application/x-message-display&quot;_ns) != kNotFound)</span>
<a href="#l61.15"></a><span id="l61.15">     return NS_NewURI(aURL, aMessageURI);</span>
<a href="#l61.16"></a><span id="l61.16"> </span>
<a href="#l61.17"></a><span id="l61.17">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l61.18"></a><span id="l61.18">   nsAutoCString msgKey;</span>
<a href="#l61.19"></a><span id="l61.19">   nsresult rv = DecomposeImapURI(messageURI, getter_AddRefs(folder), msgKey);</span>
<a href="#l61.20"></a><span id="l61.20">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.21"></a><span id="l61.21">     nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l61.22"></a><span id="l61.22">     nsAutoCString urlSpec;</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineat">@@ -521,19 +520,17 @@ NS_IMETHODIMP nsImapService::DisplayMess</span>
<a href="#l61.24"></a><span id="l61.24">                      (dontMarkAsReadPos != kNotFound));</span>
<a href="#l61.25"></a><span id="l61.25">       }</span>
<a href="#l61.26"></a><span id="l61.26"> </span>
<a href="#l61.27"></a><span id="l61.27">       rv = FetchMessage(imapUrl,</span>
<a href="#l61.28"></a><span id="l61.28">                         forcePeek ? nsIImapUrl::nsImapMsgFetchPeek</span>
<a href="#l61.29"></a><span id="l61.29">                                   : nsIImapUrl::nsImapMsgFetch,</span>
<a href="#l61.30"></a><span id="l61.30">                         folder, imapMessageSink, aMsgWindow, aDisplayConsumer,</span>
<a href="#l61.31"></a><span id="l61.31">                         msgKey, false,</span>
<a href="#l61.32"></a><span id="l61.32" class="difflineminus">-                        (mPrintingOperation) ? NS_LITERAL_CSTRING(&quot;print&quot;)</span>
<a href="#l61.33"></a><span id="l61.33" class="difflineminus">-                                             : NS_LITERAL_CSTRING(&quot;&quot;),</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineminus">-                        aURL);</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineplus">+                        (mPrintingOperation) ? &quot;print&quot;_ns : &quot;&quot;_ns, aURL);</span>
<a href="#l61.36"></a><span id="l61.36">     }</span>
<a href="#l61.37"></a><span id="l61.37">   }</span>
<a href="#l61.38"></a><span id="l61.38">   return rv;</span>
<a href="#l61.39"></a><span id="l61.39"> }</span>
<a href="#l61.40"></a><span id="l61.40"> </span>
<a href="#l61.41"></a><span id="l61.41"> nsresult nsImapService::FetchMimePart(</span>
<a href="#l61.42"></a><span id="l61.42">     nsIImapUrl* aImapUrl, nsImapAction aImapAction,</span>
<a href="#l61.43"></a><span id="l61.43">     nsIMsgFolder* aImapMailFolder, nsIImapMessageSink* aImapMessage,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUtils.cpp</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUtils.cpp</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -41,17 +41,17 @@ nsresult nsParseImapMessageURI(const cha</span>
<a href="#l62.4"></a><span id="l62.4">   if (!key) return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.5"></a><span id="l62.5"> </span>
<a href="#l62.6"></a><span id="l62.6">   nsAutoCString uriStr(uri);</span>
<a href="#l62.7"></a><span id="l62.7">   int32_t folderEnd = -1;</span>
<a href="#l62.8"></a><span id="l62.8">   // imap-message uri's can have imap:// url strings tacked on the end,</span>
<a href="#l62.9"></a><span id="l62.9">   // e.g., when opening/saving attachments. We don't want to look for '#'</span>
<a href="#l62.10"></a><span id="l62.10">   // in that part of the uri, if the attachment name contains '#',</span>
<a href="#l62.11"></a><span id="l62.11">   // so check for that here.</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-  if (StringBeginsWith(uriStr, NS_LITERAL_CSTRING(&quot;imap-message&quot;)))</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+  if (StringBeginsWith(uriStr, &quot;imap-message&quot;_ns))</span>
<a href="#l62.14"></a><span id="l62.14">     folderEnd = uriStr.Find(&quot;imap://&quot;);</span>
<a href="#l62.15"></a><span id="l62.15"> </span>
<a href="#l62.16"></a><span id="l62.16">   int32_t keySeparator = uriStr.RFindChar('#', folderEnd);</span>
<a href="#l62.17"></a><span id="l62.17">   if (keySeparator != -1) {</span>
<a href="#l62.18"></a><span id="l62.18">     int32_t keyEndSeparator = MsgFindCharInSet(uriStr, &quot;/?&amp;&quot;, keySeparator);</span>
<a href="#l62.19"></a><span id="l62.19">     nsAutoString folderPath;</span>
<a href="#l62.20"></a><span id="l62.20">     folderURI = StringHead(uriStr, keySeparator);</span>
<a href="#l62.21"></a><span id="l62.21">     folderURI.Cut(4, 8);  // cut out the _message part of imap-message:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/import/applemail/src/nsAppleMailImport.cpp</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/import/applemail/src/nsAppleMailImport.cpp</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -200,17 +200,17 @@ NS_IMETHODIMP nsAppleMailImportMail::Fin</span>
<a href="#l63.4"></a><span id="l63.4">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l63.5"></a><span id="l63.5">     // 2. look for &quot;global&quot; mailboxes, that don't belong to any specific</span>
<a href="#l63.6"></a><span id="l63.6">     // account. they are inside the</span>
<a href="#l63.7"></a><span id="l63.7">     //    root's Mailboxes/ folder</span>
<a href="#l63.8"></a><span id="l63.8">     nsCOMPtr&lt;nsIFile&gt; mailboxesDir(</span>
<a href="#l63.9"></a><span id="l63.9">         do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l63.10"></a><span id="l63.10">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l63.11"></a><span id="l63.11">       mailboxesDir-&gt;InitWithFile(aMailboxFile);</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-      rv = mailboxesDir-&gt;Append(NS_LITERAL_STRING(&quot;Mailboxes&quot;));</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+      rv = mailboxesDir-&gt;Append(u&quot;Mailboxes&quot;_ns);</span>
<a href="#l63.14"></a><span id="l63.14">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l63.15"></a><span id="l63.15">         IMPORT_LOG0(&quot;Looking for global Apple mailboxes&quot;);</span>
<a href="#l63.16"></a><span id="l63.16"> </span>
<a href="#l63.17"></a><span id="l63.17">         mCurDepth++;</span>
<a href="#l63.18"></a><span id="l63.18">         rv = FindMboxDirs(mailboxesDir, resultsArray, importService);</span>
<a href="#l63.19"></a><span id="l63.19">         mCurDepth--;</span>
<a href="#l63.20"></a><span id="l63.20">       }</span>
<a href="#l63.21"></a><span id="l63.21">     }</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineat">@@ -244,21 +244,21 @@ void nsAppleMailImportMail::FindAccountM</span>
<a href="#l63.23"></a><span id="l63.23"> </span>
<a href="#l63.24"></a><span id="l63.24">     if (isDirectory) {</span>
<a href="#l63.25"></a><span id="l63.25">       // now let's see if it's an account folder. if so, we want to traverse it</span>
<a href="#l63.26"></a><span id="l63.26">       // for .mbox children</span>
<a href="#l63.27"></a><span id="l63.27">       nsAutoString folderName;</span>
<a href="#l63.28"></a><span id="l63.28">       currentEntry-&gt;GetLeafName(folderName);</span>
<a href="#l63.29"></a><span id="l63.29">       bool isAccountFolder = false;</span>
<a href="#l63.30"></a><span id="l63.30"> </span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-      if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;POP-&quot;))) {</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+      if (StringBeginsWith(folderName, u&quot;POP-&quot;_ns)) {</span>
<a href="#l63.33"></a><span id="l63.33">         // cut off &quot;POP-&quot; prefix so we get a nice folder name</span>
<a href="#l63.34"></a><span id="l63.34">         folderName.Cut(0, 4);</span>
<a href="#l63.35"></a><span id="l63.35">         isAccountFolder = true;</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineminus">-      } else if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;IMAP-&quot;))) {</span>
<a href="#l63.37"></a><span id="l63.37" class="difflineplus">+      } else if (StringBeginsWith(folderName, u&quot;IMAP-&quot;_ns)) {</span>
<a href="#l63.38"></a><span id="l63.38">         // cut off &quot;IMAP-&quot; prefix so we get a nice folder name</span>
<a href="#l63.39"></a><span id="l63.39">         folderName.Cut(0, 5);</span>
<a href="#l63.40"></a><span id="l63.40">         isAccountFolder = true;</span>
<a href="#l63.41"></a><span id="l63.41">       }</span>
<a href="#l63.42"></a><span id="l63.42"> </span>
<a href="#l63.43"></a><span id="l63.43">       if (isAccountFolder) {</span>
<a href="#l63.44"></a><span id="l63.44">         IMPORT_LOG1(&quot;Found account: %s\n&quot;,</span>
<a href="#l63.45"></a><span id="l63.45">                     NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l63.46"></a><span id="l63.46" class="difflineat">@@ -298,32 +298,32 @@ nsresult nsAppleMailImportMail::AddMboxD</span>
<a href="#l63.47"></a><span id="l63.47">   nsAutoString folderName;</span>
<a href="#l63.48"></a><span id="l63.48">   aFolder-&gt;GetLeafName(folderName);</span>
<a href="#l63.49"></a><span id="l63.49"> </span>
<a href="#l63.50"></a><span id="l63.50">   // cut off the suffix, if any, or prefix if this is an account folder.</span>
<a href="#l63.51"></a><span id="l63.51">   if (StringEndsWith(folderName, NS_LITERAL_STRING(POP_MBOX_SUFFIX)))</span>
<a href="#l63.52"></a><span id="l63.52">     folderName.SetLength(folderName.Length() - 5);</span>
<a href="#l63.53"></a><span id="l63.53">   else if (StringEndsWith(folderName, NS_LITERAL_STRING(IMAP_MBOX_SUFFIX)))</span>
<a href="#l63.54"></a><span id="l63.54">     folderName.SetLength(folderName.Length() - 9);</span>
<a href="#l63.55"></a><span id="l63.55" class="difflineminus">-  else if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;POP-&quot;)))</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineplus">+  else if (StringBeginsWith(folderName, u&quot;POP-&quot;_ns))</span>
<a href="#l63.57"></a><span id="l63.57">     folderName.Cut(4, folderName.Length());</span>
<a href="#l63.58"></a><span id="l63.58" class="difflineminus">-  else if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;IMAP-&quot;)))</span>
<a href="#l63.59"></a><span id="l63.59" class="difflineplus">+  else if (StringBeginsWith(folderName, u&quot;IMAP-&quot;_ns))</span>
<a href="#l63.60"></a><span id="l63.60">     folderName.Cut(5, folderName.Length());</span>
<a href="#l63.61"></a><span id="l63.61"> </span>
<a href="#l63.62"></a><span id="l63.62">   nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; desc;</span>
<a href="#l63.63"></a><span id="l63.63">   nsresult rv =</span>
<a href="#l63.64"></a><span id="l63.64">       aImportService-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l63.65"></a><span id="l63.65">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l63.66"></a><span id="l63.66">     // find out number of messages in this .mbox</span>
<a href="#l63.67"></a><span id="l63.67">     uint32_t numMessages = 0;</span>
<a href="#l63.68"></a><span id="l63.68">     {</span>
<a href="#l63.69"></a><span id="l63.69">       // move to the .mbox's Messages folder</span>
<a href="#l63.70"></a><span id="l63.70">       nsCOMPtr&lt;nsIFile&gt; messagesFolder;</span>
<a href="#l63.71"></a><span id="l63.71">       aFolder-&gt;Clone(getter_AddRefs(messagesFolder));</span>
<a href="#l63.72"></a><span id="l63.72" class="difflineminus">-      nsresult rv = messagesFolder-&gt;Append(NS_LITERAL_STRING(&quot;Messages&quot;));</span>
<a href="#l63.73"></a><span id="l63.73" class="difflineplus">+      nsresult rv = messagesFolder-&gt;Append(u&quot;Messages&quot;_ns);</span>
<a href="#l63.74"></a><span id="l63.74">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l63.75"></a><span id="l63.75"> </span>
<a href="#l63.76"></a><span id="l63.76">       // count the number of messages in this folder. it sucks that we have to</span>
<a href="#l63.77"></a><span id="l63.77">       // iterate through the folder but XPCOM doesn't give us any way to just</span>
<a href="#l63.78"></a><span id="l63.78">       // get the file count, unfortunately. :-(</span>
<a href="#l63.79"></a><span id="l63.79">       nsCOMPtr&lt;nsIDirectoryEnumerator&gt; dirEnumerator;</span>
<a href="#l63.80"></a><span id="l63.80">       messagesFolder-&gt;GetDirectoryEntries(getter_AddRefs(dirEnumerator));</span>
<a href="#l63.81"></a><span id="l63.81">       if (dirEnumerator) {</span>
<a href="#l63.82"></a><span id="l63.82" class="difflineat">@@ -485,17 +485,17 @@ nsAppleMailImportMail::ImportMailbox(nsI</span>
<a href="#l63.83"></a><span id="l63.83">   // then we've got some messages to import!</span>
<a href="#l63.84"></a><span id="l63.84">   uint32_t mailboxIdentifier;</span>
<a href="#l63.85"></a><span id="l63.85">   aMailbox-&gt;GetIdentifier(&amp;mailboxIdentifier);</span>
<a href="#l63.86"></a><span id="l63.86"> </span>
<a href="#l63.87"></a><span id="l63.87">   if (mailboxIdentifier != kAccountMailboxID) {</span>
<a href="#l63.88"></a><span id="l63.88">     // move to the .mbox's Messages folder</span>
<a href="#l63.89"></a><span id="l63.89">     nsCOMPtr&lt;nsIFile&gt; messagesFolder;</span>
<a href="#l63.90"></a><span id="l63.90">     mboxFolder-&gt;Clone(getter_AddRefs(messagesFolder));</span>
<a href="#l63.91"></a><span id="l63.91" class="difflineminus">-    rv = messagesFolder-&gt;Append(NS_LITERAL_STRING(&quot;Messages&quot;));</span>
<a href="#l63.92"></a><span id="l63.92" class="difflineplus">+    rv = messagesFolder-&gt;Append(u&quot;Messages&quot;_ns);</span>
<a href="#l63.93"></a><span id="l63.93">     if (NS_FAILED(rv)) {</span>
<a href="#l63.94"></a><span id="l63.94">       // even if there are no messages, it might still be a valid mailbox, or</span>
<a href="#l63.95"></a><span id="l63.95">       // even a parent for other mailboxes.</span>
<a href="#l63.96"></a><span id="l63.96">       //</span>
<a href="#l63.97"></a><span id="l63.97">       // just indicate that we're done, using the same number that we used to</span>
<a href="#l63.98"></a><span id="l63.98">       // estimate number of messages earlier.</span>
<a href="#l63.99"></a><span id="l63.99">       uint32_t finalSize;</span>
<a href="#l63.100"></a><span id="l63.100">       aMailbox-&gt;GetSize(&amp;finalSize);</span>
<a href="#l63.101"></a><span id="l63.101" class="difflineat">@@ -540,17 +540,17 @@ nsAppleMailImportMail::ImportMailbox(nsI</span>
<a href="#l63.102"></a><span id="l63.102"> </span>
<a href="#l63.103"></a><span id="l63.103">       // make sure it's an .emlx file</span>
<a href="#l63.104"></a><span id="l63.104">       bool isFile = false;</span>
<a href="#l63.105"></a><span id="l63.105">       currentEntry-&gt;IsFile(&amp;isFile);</span>
<a href="#l63.106"></a><span id="l63.106">       if (!isFile) continue;</span>
<a href="#l63.107"></a><span id="l63.107"> </span>
<a href="#l63.108"></a><span id="l63.108">       nsAutoString leafName;</span>
<a href="#l63.109"></a><span id="l63.109">       currentEntry-&gt;GetLeafName(leafName);</span>
<a href="#l63.110"></a><span id="l63.110" class="difflineminus">-      if (!StringEndsWith(leafName, NS_LITERAL_STRING(&quot;.emlx&quot;))) continue;</span>
<a href="#l63.111"></a><span id="l63.111" class="difflineplus">+      if (!StringEndsWith(leafName, u&quot;.emlx&quot;_ns)) continue;</span>
<a href="#l63.112"></a><span id="l63.112"> </span>
<a href="#l63.113"></a><span id="l63.113">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l63.114"></a><span id="l63.114">       bool reusable;</span>
<a href="#l63.115"></a><span id="l63.115">       rv =</span>
<a href="#l63.116"></a><span id="l63.116">           msgStore-&gt;GetNewMsgOutputStream(aDstFolder, getter_AddRefs(msgHdr),</span>
<a href="#l63.117"></a><span id="l63.117">                                           &amp;reusable, getter_AddRefs(outStream));</span>
<a href="#l63.118"></a><span id="l63.118">       if (NS_FAILED(rv)) break;</span>
<a href="#l63.119"></a><span id="l63.119"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/import/applemail/src/nsEmlxHelperUtils.mm</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/import/applemail/src/nsEmlxHelperUtils.mm</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -81,17 +81,17 @@ nsresult nsEmlxHelperUtils::ConvertToMbo</span>
<a href="#l64.4"></a><span id="l64.4">     break;</span>
<a href="#l64.5"></a><span id="l64.5">   }</span>
<a href="#l64.6"></a><span id="l64.6"> </span>
<a href="#l64.7"></a><span id="l64.7">   // go through foundFromLines</span>
<a href="#l64.8"></a><span id="l64.8">   if (foundFromLines.Length()) {</span>
<a href="#l64.9"></a><span id="l64.9">     const char* chunkStart = aMessageBufferStart;</span>
<a href="#l64.10"></a><span id="l64.10">     for (unsigned i = 0; i &lt; foundFromLines.Length(); ++i) {</span>
<a href="#l64.11"></a><span id="l64.11">       aOutBuffer.Append(chunkStart, (foundFromLines[i] - chunkStart));</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-      aOutBuffer.Append(NS_LITERAL_CSTRING(&quot;&gt;&quot;));</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+      aOutBuffer.Append(&quot;&gt;&quot;_ns);</span>
<a href="#l64.14"></a><span id="l64.14"> </span>
<a href="#l64.15"></a><span id="l64.15">       chunkStart = foundFromLines[i];</span>
<a href="#l64.16"></a><span id="l64.16">     }</span>
<a href="#l64.17"></a><span id="l64.17">     aOutBuffer.Append(chunkStart, (aMessageBufferEnd - chunkStart));</span>
<a href="#l64.18"></a><span id="l64.18">   }</span>
<a href="#l64.19"></a><span id="l64.19"> </span>
<a href="#l64.20"></a><span id="l64.20">   return NS_OK;</span>
<a href="#l64.21"></a><span id="l64.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyAddressBooks.cpp</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyAddressBooks.cpp</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -60,17 +60,17 @@ nsBeckyAddressBooks::GetNeedsFieldMap(ns</span>
<a href="#l65.4"></a><span id="l65.4"> }</span>
<a href="#l65.5"></a><span id="l65.5"> </span>
<a href="#l65.6"></a><span id="l65.6"> nsresult nsBeckyAddressBooks::FindAddressBookDirectory(</span>
<a href="#l65.7"></a><span id="l65.7">     nsIFile** aAddressBookDirectory) {</span>
<a href="#l65.8"></a><span id="l65.8">   nsCOMPtr&lt;nsIFile&gt; userDirectory;</span>
<a href="#l65.9"></a><span id="l65.9">   nsresult rv = nsBeckyUtils::FindUserDirectory(getter_AddRefs(userDirectory));</span>
<a href="#l65.10"></a><span id="l65.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-  rv = userDirectory-&gt;Append(NS_LITERAL_STRING(&quot;AddrBook&quot;));</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+  rv = userDirectory-&gt;Append(u&quot;AddrBook&quot;_ns);</span>
<a href="#l65.14"></a><span id="l65.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.15"></a><span id="l65.15"> </span>
<a href="#l65.16"></a><span id="l65.16">   bool exists = false;</span>
<a href="#l65.17"></a><span id="l65.17">   rv = userDirectory-&gt;Exists(&amp;exists);</span>
<a href="#l65.18"></a><span id="l65.18">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.19"></a><span id="l65.19">   if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l65.20"></a><span id="l65.20"> </span>
<a href="#l65.21"></a><span id="l65.21">   bool isDirectory = false;</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -116,17 +116,17 @@ bool nsBeckyAddressBooks::IsAddressBookF</span>
<a href="#l65.23"></a><span id="l65.23"> </span>
<a href="#l65.24"></a><span id="l65.24">   nsresult rv;</span>
<a href="#l65.25"></a><span id="l65.25">   bool isFile = false;</span>
<a href="#l65.26"></a><span id="l65.26">   rv = aFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l65.27"></a><span id="l65.27">   if (NS_FAILED(rv) &amp;&amp; !isFile) return false;</span>
<a href="#l65.28"></a><span id="l65.28"> </span>
<a href="#l65.29"></a><span id="l65.29">   nsAutoString name;</span>
<a href="#l65.30"></a><span id="l65.30">   rv = aFile-&gt;GetLeafName(name);</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-  return StringEndsWith(name, NS_LITERAL_STRING(&quot;.bab&quot;));</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+  return StringEndsWith(name, u&quot;.bab&quot;_ns);</span>
<a href="#l65.33"></a><span id="l65.33"> }</span>
<a href="#l65.34"></a><span id="l65.34"> </span>
<a href="#l65.35"></a><span id="l65.35"> bool nsBeckyAddressBooks::HasAddressBookFile(nsIFile* aDirectory) {</span>
<a href="#l65.36"></a><span id="l65.36">   if (!aDirectory) return false;</span>
<a href="#l65.37"></a><span id="l65.37"> </span>
<a href="#l65.38"></a><span id="l65.38">   nsresult rv;</span>
<a href="#l65.39"></a><span id="l65.39">   bool isDirectory = false;</span>
<a href="#l65.40"></a><span id="l65.40">   rv = aDirectory-&gt;IsDirectory(&amp;isDirectory);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyFilters.cpp</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyFilters.cpp</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -55,19 +55,19 @@ nsresult nsBeckyFilters::GetFilterFile(b</span>
<a href="#l66.4"></a><span id="l66.4"> </span>
<a href="#l66.5"></a><span id="l66.5">   // We assume the caller has already checked that aLocation is a directory,</span>
<a href="#l66.6"></a><span id="l66.6">   // otherwise it would not make sense to call us.</span>
<a href="#l66.7"></a><span id="l66.7"> </span>
<a href="#l66.8"></a><span id="l66.8">   nsresult rv;</span>
<a href="#l66.9"></a><span id="l66.9">   nsCOMPtr&lt;nsIFile&gt; filter;</span>
<a href="#l66.10"></a><span id="l66.10">   aLocation-&gt;Clone(getter_AddRefs(filter));</span>
<a href="#l66.11"></a><span id="l66.11">   if (aIncoming)</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-    rv = filter-&gt;Append(NS_LITERAL_STRING(&quot;IFilter.def&quot;));</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+    rv = filter-&gt;Append(u&quot;IFilter.def&quot;_ns);</span>
<a href="#l66.14"></a><span id="l66.14">   else</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineminus">-    rv = filter-&gt;Append(NS_LITERAL_STRING(&quot;OFilter.def&quot;));</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+    rv = filter-&gt;Append(u&quot;OFilter.def&quot;_ns);</span>
<a href="#l66.17"></a><span id="l66.17">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.18"></a><span id="l66.18"> </span>
<a href="#l66.19"></a><span id="l66.19">   bool exists = false;</span>
<a href="#l66.20"></a><span id="l66.20">   rv = filter-&gt;Exists(&amp;exists);</span>
<a href="#l66.21"></a><span id="l66.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.22"></a><span id="l66.22">   if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l66.23"></a><span id="l66.23"> </span>
<a href="#l66.24"></a><span id="l66.24">   filter.forget(aFile);</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineat">@@ -224,17 +224,17 @@ nsresult nsBeckyFilters::SetSearchTerm(c</span>
<a href="#l66.26"></a><span id="l66.26">   rv = term-&gt;SetValue(value);</span>
<a href="#l66.27"></a><span id="l66.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.28"></a><span id="l66.28">   rv = term-&gt;SetBooleanAnd(false);</span>
<a href="#l66.29"></a><span id="l66.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.30"></a><span id="l66.30"> </span>
<a href="#l66.31"></a><span id="l66.31">   if (!searchKeyword.IsEmpty())</span>
<a href="#l66.32"></a><span id="l66.32">     rv = aFilter-&gt;SetFilterName(searchKeyword);</span>
<a href="#l66.33"></a><span id="l66.33">   else</span>
<a href="#l66.34"></a><span id="l66.34" class="difflineminus">-    rv = aFilter-&gt;SetFilterName(NS_LITERAL_STRING(&quot;No name&quot;));</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineplus">+    rv = aFilter-&gt;SetFilterName(u&quot;No name&quot;_ns);</span>
<a href="#l66.36"></a><span id="l66.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.37"></a><span id="l66.37"> </span>
<a href="#l66.38"></a><span id="l66.38">   return aFilter-&gt;AppendTerm(term);</span>
<a href="#l66.39"></a><span id="l66.39"> }</span>
<a href="#l66.40"></a><span id="l66.40"> </span>
<a href="#l66.41"></a><span id="l66.41"> nsresult nsBeckyFilters::CreateRuleAction(nsIMsgFilter* aFilter,</span>
<a href="#l66.42"></a><span id="l66.42">                                           nsMsgRuleActionType actionType,</span>
<a href="#l66.43"></a><span id="l66.43">                                           nsIMsgRuleAction** _retval) {</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineat">@@ -494,17 +494,17 @@ nsresult nsBeckyFilters::ParseFilterFile</span>
<a href="#l66.45"></a><span id="l66.45">         break;</span>
<a href="#l66.46"></a><span id="l66.46">       case '!':</span>
<a href="#l66.47"></a><span id="l66.47">         SetRuleAction(line, filter);</span>
<a href="#l66.48"></a><span id="l66.48">         break;</span>
<a href="#l66.49"></a><span id="l66.49">       case '@':</span>
<a href="#l66.50"></a><span id="l66.50">         SetSearchTerm(line, filter);</span>
<a href="#l66.51"></a><span id="l66.51">         break;</span>
<a href="#l66.52"></a><span id="l66.52">       case '$':  // $X: disabled</span>
<a href="#l66.53"></a><span id="l66.53" class="difflineminus">-        if (StringBeginsWith(line, NS_LITERAL_CSTRING(&quot;$X&quot;)) &amp;&amp; filter) {</span>
<a href="#l66.54"></a><span id="l66.54" class="difflineplus">+        if (StringBeginsWith(line, &quot;$X&quot;_ns) &amp;&amp; filter) {</span>
<a href="#l66.55"></a><span id="l66.55">           filter-&gt;SetEnabled(false);</span>
<a href="#l66.56"></a><span id="l66.56">         }</span>
<a href="#l66.57"></a><span id="l66.57">         break;</span>
<a href="#l66.58"></a><span id="l66.58">       default:</span>
<a href="#l66.59"></a><span id="l66.59">         break;</span>
<a href="#l66.60"></a><span id="l66.60">     }</span>
<a href="#l66.61"></a><span id="l66.61">   }</span>
<a href="#l66.62"></a><span id="l66.62"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyMail.cpp</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyMail.cpp</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -196,26 +196,25 @@ nsresult nsBeckyMail::CollectMailboxesIn</span>
<a href="#l67.4"></a><span id="l67.4">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l67.5"></a><span id="l67.5">     rv = entries-&gt;GetNextFile(getter_AddRefs(file));</span>
<a href="#l67.6"></a><span id="l67.6">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.7"></a><span id="l67.7"> </span>
<a href="#l67.8"></a><span id="l67.8">     nsAutoString name;</span>
<a href="#l67.9"></a><span id="l67.9">     rv = file-&gt;GetLeafName(name);</span>
<a href="#l67.10"></a><span id="l67.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.11"></a><span id="l67.11"> </span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-    if (StringEndsWith(name, NS_LITERAL_STRING(&quot;.bmf&quot;))) {</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+    if (StringEndsWith(name, u&quot;.bmf&quot;_ns)) {</span>
<a href="#l67.14"></a><span id="l67.14">       AppendMailboxDescriptor(file, mailboxName, aDepth, aCollected);</span>
<a href="#l67.15"></a><span id="l67.15">     }</span>
<a href="#l67.16"></a><span id="l67.16"> </span>
<a href="#l67.17"></a><span id="l67.17">     // The Folder.lst file is not created if there is only one sub folder,</span>
<a href="#l67.18"></a><span id="l67.18">     // so we need to find the sub folder by our hands.</span>
<a href="#l67.19"></a><span id="l67.19">     // The folder name does not begin with # or ! maybe. Yes, maybe...</span>
<a href="#l67.20"></a><span id="l67.20">     if (!folderListExists) {</span>
<a href="#l67.21"></a><span id="l67.21" class="difflineminus">-      if (StringBeginsWith(name, NS_LITERAL_STRING(&quot;#&quot;)) ||</span>
<a href="#l67.22"></a><span id="l67.22" class="difflineminus">-          StringBeginsWith(name, NS_LITERAL_STRING(&quot;!&quot;)))</span>
<a href="#l67.23"></a><span id="l67.23" class="difflineplus">+      if (StringBeginsWith(name, u&quot;#&quot;_ns) || StringBeginsWith(name, u&quot;!&quot;_ns))</span>
<a href="#l67.24"></a><span id="l67.24">         continue;</span>
<a href="#l67.25"></a><span id="l67.25"> </span>
<a href="#l67.26"></a><span id="l67.26">       bool isDirectory = false;</span>
<a href="#l67.27"></a><span id="l67.27">       rv = file-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l67.28"></a><span id="l67.28">       if (isDirectory) {</span>
<a href="#l67.29"></a><span id="l67.29">         CollectMailboxesInDirectory(file, aDepth + 1, aCollected);</span>
<a href="#l67.30"></a><span id="l67.30">         continue;</span>
<a href="#l67.31"></a><span id="l67.31">       }</span>
<a href="#l67.32"></a><span id="l67.32" class="difflineat">@@ -387,17 +386,17 @@ nsresult ImportMessageRunnable::GetAttac</span>
<a href="#l67.33"></a><span id="l67.33">                                                   const nsCString&amp; aHeader,</span>
<a href="#l67.34"></a><span id="l67.34">                                                   nsIFile** _retval) {</span>
<a href="#l67.35"></a><span id="l67.35">   nsresult rv;</span>
<a href="#l67.36"></a><span id="l67.36">   nsCOMPtr&lt;nsIFile&gt; attachmentFile;</span>
<a href="#l67.37"></a><span id="l67.37"> </span>
<a href="#l67.38"></a><span id="l67.38">   rv = aMailboxFile-&gt;Clone(getter_AddRefs(attachmentFile));</span>
<a href="#l67.39"></a><span id="l67.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.40"></a><span id="l67.40"> </span>
<a href="#l67.41"></a><span id="l67.41" class="difflineminus">-  rv = attachmentFile-&gt;Append(NS_LITERAL_STRING(&quot;#Attach&quot;));</span>
<a href="#l67.42"></a><span id="l67.42" class="difflineplus">+  rv = attachmentFile-&gt;Append(u&quot;#Attach&quot;_ns);</span>
<a href="#l67.43"></a><span id="l67.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.44"></a><span id="l67.44"> </span>
<a href="#l67.45"></a><span id="l67.45">   nsAutoCString nativeAttachmentPath;</span>
<a href="#l67.46"></a><span id="l67.46">   rv = GetBeckyIncludeValue(aHeader, nativeAttachmentPath);</span>
<a href="#l67.47"></a><span id="l67.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.48"></a><span id="l67.48"> </span>
<a href="#l67.49"></a><span id="l67.49">   rv = attachmentFile-&gt;AppendRelativeNativePath(nativeAttachmentPath);</span>
<a href="#l67.50"></a><span id="l67.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.51"></a><span id="l67.51" class="difflineat">@@ -479,17 +478,17 @@ NS_IMETHODIMP ImportMessageRunnable::Run</span>
<a href="#l67.52"></a><span id="l67.52">       if (!reusable) outputStream-&gt;Close();</span>
<a href="#l67.53"></a><span id="l67.53">       mResult = msgStore-&gt;GetNewMsgOutputStream(mFolder, getter_AddRefs(msgHdr),</span>
<a href="#l67.54"></a><span id="l67.54">                                                 &amp;reusable,</span>
<a href="#l67.55"></a><span id="l67.55">                                                 getter_AddRefs(outputStream));</span>
<a href="#l67.56"></a><span id="l67.56">     } else if (IsBeckyIncludeLine(line)) {</span>
<a href="#l67.57"></a><span id="l67.57">       mResult = WriteAttachmentFile(mMessageFile, line, outputStream);</span>
<a href="#l67.58"></a><span id="l67.58">     } else {</span>
<a href="#l67.59"></a><span id="l67.59">       uint32_t writtenBytes = 0;</span>
<a href="#l67.60"></a><span id="l67.60" class="difflineminus">-      if (StringBeginsWith(line, NS_LITERAL_CSTRING(&quot;..&quot;)))</span>
<a href="#l67.61"></a><span id="l67.61" class="difflineplus">+      if (StringBeginsWith(line, &quot;..&quot;_ns))</span>
<a href="#l67.62"></a><span id="l67.62">         line.Cut(0, 1);</span>
<a href="#l67.63"></a><span id="l67.63">       else if (CheckHeaderKey(line, &quot;From&quot;))</span>
<a href="#l67.64"></a><span id="l67.64">         line.Insert('&gt;', 0);</span>
<a href="#l67.65"></a><span id="l67.65"> </span>
<a href="#l67.66"></a><span id="l67.66">       line.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l67.67"></a><span id="l67.67">       mResult = outputStream-&gt;Write(line.get(), line.Length(), &amp;writtenBytes);</span>
<a href="#l67.68"></a><span id="l67.68">     }</span>
<a href="#l67.69"></a><span id="l67.69">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckySettings.cpp</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckySettings.cpp</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -129,52 +129,46 @@ nsresult nsBeckySettings::CreateIncoming</span>
<a href="#l68.4"></a><span id="l68.4"> </span>
<a href="#l68.5"></a><span id="l68.5">   return NS_OK;</span>
<a href="#l68.6"></a><span id="l68.6"> }</span>
<a href="#l68.7"></a><span id="l68.7"> </span>
<a href="#l68.8"></a><span id="l68.8"> nsresult nsBeckySettings::SetupSmtpServer(nsISmtpServer** aServer) {</span>
<a href="#l68.9"></a><span id="l68.9">   nsresult rv;</span>
<a href="#l68.10"></a><span id="l68.10">   nsAutoCString userName, serverName;</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;SMTPServer&quot;), serverName);</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;UserID&quot;), userName);</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;SMTPServer&quot;_ns, serverName);</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;UserID&quot;_ns, userName);</span>
<a href="#l68.18"></a><span id="l68.18"> </span>
<a href="#l68.19"></a><span id="l68.19">   nsCOMPtr&lt;nsISmtpServer&gt; server;</span>
<a href="#l68.20"></a><span id="l68.20">   bool existing = false;</span>
<a href="#l68.21"></a><span id="l68.21">   rv =</span>
<a href="#l68.22"></a><span id="l68.22">       CreateSmtpServer(userName, serverName, getter_AddRefs(server), &amp;existing);</span>
<a href="#l68.23"></a><span id="l68.23">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.24"></a><span id="l68.24"> </span>
<a href="#l68.25"></a><span id="l68.25">   // If we already have an existing server, do not touch it's settings.</span>
<a href="#l68.26"></a><span id="l68.26">   if (existing) {</span>
<a href="#l68.27"></a><span id="l68.27">     server.forget(aServer);</span>
<a href="#l68.28"></a><span id="l68.28">     return NS_OK;</span>
<a href="#l68.29"></a><span id="l68.29">   }</span>
<a href="#l68.30"></a><span id="l68.30"> </span>
<a href="#l68.31"></a><span id="l68.31">   nsAutoCString value;</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineminus">-  rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineminus">-                          NS_LITERAL_CSTRING(&quot;SMTPPort&quot;), value);</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+  rv = mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;SMTPPort&quot;_ns, value);</span>
<a href="#l68.35"></a><span id="l68.35">   int32_t port = 25;</span>
<a href="#l68.36"></a><span id="l68.36">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l68.37"></a><span id="l68.37">     nsresult errorCode;</span>
<a href="#l68.38"></a><span id="l68.38">     port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l68.39"></a><span id="l68.39">   }</span>
<a href="#l68.40"></a><span id="l68.40">   server-&gt;SetPort(port);</span>
<a href="#l68.41"></a><span id="l68.41"> </span>
<a href="#l68.42"></a><span id="l68.42" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.43"></a><span id="l68.43" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;SSLSMTP&quot;), value);</span>
<a href="#l68.44"></a><span id="l68.44" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;SSLSMTP&quot;_ns, value);</span>
<a href="#l68.45"></a><span id="l68.45">   if (value.EqualsLiteral(&quot;1&quot;)) server-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l68.46"></a><span id="l68.46"> </span>
<a href="#l68.47"></a><span id="l68.47" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;SMTPAUTH&quot;), value);</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;SMTPAUTH&quot;_ns, value);</span>
<a href="#l68.50"></a><span id="l68.50">   if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineminus">-    mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;SMTPAUTHMODE&quot;), value);</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineplus">+    mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;SMTPAUTHMODE&quot;_ns, value);</span>
<a href="#l68.54"></a><span id="l68.54">     nsMsgAuthMethodValue authMethod = nsMsgAuthMethod::none;</span>
<a href="#l68.55"></a><span id="l68.55">     if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l68.56"></a><span id="l68.56">       authMethod = nsMsgAuthMethod::passwordEncrypted;</span>
<a href="#l68.57"></a><span id="l68.57">     } else if (value.EqualsLiteral(&quot;2&quot;) || value.EqualsLiteral(&quot;4&quot;) ||</span>
<a href="#l68.58"></a><span id="l68.58">                value.EqualsLiteral(&quot;6&quot;)) {</span>
<a href="#l68.59"></a><span id="l68.59">       authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l68.60"></a><span id="l68.60">     } else {</span>
<a href="#l68.61"></a><span id="l68.61">       authMethod = nsMsgAuthMethod::anything;</span>
<a href="#l68.62"></a><span id="l68.62" class="difflineat">@@ -187,130 +181,114 @@ nsresult nsBeckySettings::SetupSmtpServe</span>
<a href="#l68.63"></a><span id="l68.63">   return NS_OK;</span>
<a href="#l68.64"></a><span id="l68.64"> }</span>
<a href="#l68.65"></a><span id="l68.65"> </span>
<a href="#l68.66"></a><span id="l68.66"> nsresult nsBeckySettings::SetPop3ServerProperties(</span>
<a href="#l68.67"></a><span id="l68.67">     nsIMsgIncomingServer* aServer) {</span>
<a href="#l68.68"></a><span id="l68.68">   nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(aServer);</span>
<a href="#l68.69"></a><span id="l68.69"> </span>
<a href="#l68.70"></a><span id="l68.70">   nsAutoCString value;</span>
<a href="#l68.71"></a><span id="l68.71" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.72"></a><span id="l68.72" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;POP3Auth&quot;),</span>
<a href="#l68.73"></a><span id="l68.73" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;POP3Auth&quot;_ns,</span>
<a href="#l68.74"></a><span id="l68.74">                      value);  // 0: plain, 1: APOP, 2: CRAM-MD5, 3: NTLM</span>
<a href="#l68.75"></a><span id="l68.75">   nsMsgAuthMethodValue authMethod;</span>
<a href="#l68.76"></a><span id="l68.76">   if (value.IsEmpty() || value.EqualsLiteral(&quot;0&quot;)) {</span>
<a href="#l68.77"></a><span id="l68.77">     authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l68.78"></a><span id="l68.78">   } else if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l68.79"></a><span id="l68.79">     authMethod = nsMsgAuthMethod::old;</span>
<a href="#l68.80"></a><span id="l68.80">   } else if (value.EqualsLiteral(&quot;2&quot;)) {</span>
<a href="#l68.81"></a><span id="l68.81">     authMethod = nsMsgAuthMethod::passwordEncrypted;</span>
<a href="#l68.82"></a><span id="l68.82">   } else if (value.EqualsLiteral(&quot;3&quot;)) {</span>
<a href="#l68.83"></a><span id="l68.83">     authMethod = nsMsgAuthMethod::NTLM;</span>
<a href="#l68.84"></a><span id="l68.84">   } else {</span>
<a href="#l68.85"></a><span id="l68.85">     authMethod = nsMsgAuthMethod::none;</span>
<a href="#l68.86"></a><span id="l68.86">   }</span>
<a href="#l68.87"></a><span id="l68.87">   aServer-&gt;SetAuthMethod(authMethod);</span>
<a href="#l68.88"></a><span id="l68.88"> </span>
<a href="#l68.89"></a><span id="l68.89" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.90"></a><span id="l68.90" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;LeaveServer&quot;), value);</span>
<a href="#l68.91"></a><span id="l68.91" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;LeaveServer&quot;_ns, value);</span>
<a href="#l68.92"></a><span id="l68.92">   if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l68.93"></a><span id="l68.93">     pop3Server-&gt;SetLeaveMessagesOnServer(true);</span>
<a href="#l68.94"></a><span id="l68.94" class="difflineminus">-    nsresult rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.95"></a><span id="l68.95" class="difflineminus">-                                     NS_LITERAL_CSTRING(&quot;KeepDays&quot;), value);</span>
<a href="#l68.96"></a><span id="l68.96" class="difflineplus">+    nsresult rv = mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;KeepDays&quot;_ns, value);</span>
<a href="#l68.97"></a><span id="l68.97">     if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l68.98"></a><span id="l68.98"> </span>
<a href="#l68.99"></a><span id="l68.99">     nsresult errorCode;</span>
<a href="#l68.100"></a><span id="l68.100">     int32_t leftDays = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l68.101"></a><span id="l68.101">     if (NS_SUCCEEDED(errorCode)) {</span>
<a href="#l68.102"></a><span id="l68.102">       pop3Server-&gt;SetNumDaysToLeaveOnServer(leftDays);</span>
<a href="#l68.103"></a><span id="l68.103">       pop3Server-&gt;SetDeleteByAgeFromServer(true);</span>
<a href="#l68.104"></a><span id="l68.104">     }</span>
<a href="#l68.105"></a><span id="l68.105">   }</span>
<a href="#l68.106"></a><span id="l68.106"> </span>
<a href="#l68.107"></a><span id="l68.107">   return NS_OK;</span>
<a href="#l68.108"></a><span id="l68.108"> }</span>
<a href="#l68.109"></a><span id="l68.109"> </span>
<a href="#l68.110"></a><span id="l68.110"> nsresult nsBeckySettings::SetupIncomingServer(nsIMsgIncomingServer** aServer) {</span>
<a href="#l68.111"></a><span id="l68.111">   nsAutoCString value;</span>
<a href="#l68.112"></a><span id="l68.112" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.113"></a><span id="l68.113" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;Protocol&quot;), value);</span>
<a href="#l68.114"></a><span id="l68.114" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;Protocol&quot;_ns, value);</span>
<a href="#l68.115"></a><span id="l68.115">   nsCString protocol;</span>
<a href="#l68.116"></a><span id="l68.116">   if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l68.117"></a><span id="l68.117" class="difflineminus">-    protocol = NS_LITERAL_CSTRING(&quot;imap&quot;);</span>
<a href="#l68.118"></a><span id="l68.118" class="difflineplus">+    protocol = &quot;imap&quot;_ns;</span>
<a href="#l68.119"></a><span id="l68.119">   } else {</span>
<a href="#l68.120"></a><span id="l68.120" class="difflineminus">-    protocol = NS_LITERAL_CSTRING(&quot;pop3&quot;);</span>
<a href="#l68.121"></a><span id="l68.121" class="difflineplus">+    protocol = &quot;pop3&quot;_ns;</span>
<a href="#l68.122"></a><span id="l68.122">   }</span>
<a href="#l68.123"></a><span id="l68.123"> </span>
<a href="#l68.124"></a><span id="l68.124">   nsAutoCString userName, serverName;</span>
<a href="#l68.125"></a><span id="l68.125" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.126"></a><span id="l68.126" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;MailServer&quot;), serverName);</span>
<a href="#l68.127"></a><span id="l68.127" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.128"></a><span id="l68.128" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;UserID&quot;), userName);</span>
<a href="#l68.129"></a><span id="l68.129" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;MailServer&quot;_ns, serverName);</span>
<a href="#l68.130"></a><span id="l68.130" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;UserID&quot;_ns, userName);</span>
<a href="#l68.131"></a><span id="l68.131"> </span>
<a href="#l68.132"></a><span id="l68.132">   nsresult rv;</span>
<a href="#l68.133"></a><span id="l68.133">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l68.134"></a><span id="l68.134">   rv = CreateIncomingServer(userName, serverName, protocol,</span>
<a href="#l68.135"></a><span id="l68.135">                             getter_AddRefs(server));</span>
<a href="#l68.136"></a><span id="l68.136">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.137"></a><span id="l68.137"> </span>
<a href="#l68.138"></a><span id="l68.138">   bool isSecure = false;</span>
<a href="#l68.139"></a><span id="l68.139">   int32_t port = 0;</span>
<a href="#l68.140"></a><span id="l68.140">   nsresult errorCode;</span>
<a href="#l68.141"></a><span id="l68.141">   if (protocol.EqualsLiteral(&quot;pop3&quot;)) {</span>
<a href="#l68.142"></a><span id="l68.142">     SetPop3ServerProperties(server);</span>
<a href="#l68.143"></a><span id="l68.143" class="difflineminus">-    rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.144"></a><span id="l68.144" class="difflineminus">-                            NS_LITERAL_CSTRING(&quot;POP3Port&quot;), value);</span>
<a href="#l68.145"></a><span id="l68.145" class="difflineplus">+    rv = mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;POP3Port&quot;_ns, value);</span>
<a href="#l68.146"></a><span id="l68.146">     if (NS_SUCCEEDED(rv))</span>
<a href="#l68.147"></a><span id="l68.147">       port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l68.148"></a><span id="l68.148">     else</span>
<a href="#l68.149"></a><span id="l68.149">       port = 110;</span>
<a href="#l68.150"></a><span id="l68.150" class="difflineminus">-    mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.151"></a><span id="l68.151" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;SSLPOP&quot;), value);</span>
<a href="#l68.152"></a><span id="l68.152" class="difflineplus">+    mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;SSLPOP&quot;_ns, value);</span>
<a href="#l68.153"></a><span id="l68.153">     if (value.EqualsLiteral(&quot;1&quot;)) isSecure = true;</span>
<a href="#l68.154"></a><span id="l68.154">   } else if (protocol.EqualsLiteral(&quot;imap&quot;)) {</span>
<a href="#l68.155"></a><span id="l68.155" class="difflineminus">-    rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.156"></a><span id="l68.156" class="difflineminus">-                            NS_LITERAL_CSTRING(&quot;IMAP4Port&quot;), value);</span>
<a href="#l68.157"></a><span id="l68.157" class="difflineplus">+    rv = mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;IMAP4Port&quot;_ns, value);</span>
<a href="#l68.158"></a><span id="l68.158">     if (NS_SUCCEEDED(rv))</span>
<a href="#l68.159"></a><span id="l68.159">       port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l68.160"></a><span id="l68.160">     else</span>
<a href="#l68.161"></a><span id="l68.161">       port = 143;</span>
<a href="#l68.162"></a><span id="l68.162" class="difflineminus">-    mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.163"></a><span id="l68.163" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;SSLIMAP&quot;), value);</span>
<a href="#l68.164"></a><span id="l68.164" class="difflineplus">+    mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;SSLIMAP&quot;_ns, value);</span>
<a href="#l68.165"></a><span id="l68.165">     if (value.EqualsLiteral(&quot;1&quot;)) isSecure = true;</span>
<a href="#l68.166"></a><span id="l68.166">   }</span>
<a href="#l68.167"></a><span id="l68.167"> </span>
<a href="#l68.168"></a><span id="l68.168">   server-&gt;SetPort(port);</span>
<a href="#l68.169"></a><span id="l68.169">   if (isSecure) server-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l68.170"></a><span id="l68.170"> </span>
<a href="#l68.171"></a><span id="l68.171" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.172"></a><span id="l68.172" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;CheckInt&quot;), value);</span>
<a href="#l68.173"></a><span id="l68.173" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;CheckInt&quot;_ns, value);</span>
<a href="#l68.174"></a><span id="l68.174">   if (value.EqualsLiteral(&quot;1&quot;)) server-&gt;SetDoBiff(true);</span>
<a href="#l68.175"></a><span id="l68.175" class="difflineminus">-  rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.176"></a><span id="l68.176" class="difflineminus">-                          NS_LITERAL_CSTRING(&quot;CheckEvery&quot;), value);</span>
<a href="#l68.177"></a><span id="l68.177" class="difflineplus">+  rv = mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;CheckEvery&quot;_ns, value);</span>
<a href="#l68.178"></a><span id="l68.178">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l68.179"></a><span id="l68.179">     int32_t minutes = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l68.180"></a><span id="l68.180">     if (NS_SUCCEEDED(errorCode)) server-&gt;SetBiffMinutes(minutes);</span>
<a href="#l68.181"></a><span id="l68.181">   }</span>
<a href="#l68.182"></a><span id="l68.182"> </span>
<a href="#l68.183"></a><span id="l68.183">   server.forget(aServer);</span>
<a href="#l68.184"></a><span id="l68.184"> </span>
<a href="#l68.185"></a><span id="l68.185">   return NS_OK;</span>
<a href="#l68.186"></a><span id="l68.186"> }</span>
<a href="#l68.187"></a><span id="l68.187"> </span>
<a href="#l68.188"></a><span id="l68.188"> nsresult nsBeckySettings::CreateIdentity(nsIMsgIdentity** aIdentity) {</span>
<a href="#l68.189"></a><span id="l68.189">   nsAutoCString email, fullName, identityName, bccAddress;</span>
<a href="#l68.190"></a><span id="l68.190"> </span>
<a href="#l68.191"></a><span id="l68.191" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;), NS_LITERAL_CSTRING(&quot;Name&quot;),</span>
<a href="#l68.192"></a><span id="l68.192" class="difflineminus">-                     identityName);</span>
<a href="#l68.193"></a><span id="l68.193" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.194"></a><span id="l68.194" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;YourName&quot;), fullName);</span>
<a href="#l68.195"></a><span id="l68.195" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.196"></a><span id="l68.196" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;MailAddress&quot;), email);</span>
<a href="#l68.197"></a><span id="l68.197" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l68.198"></a><span id="l68.198" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;PermBcc&quot;), bccAddress);</span>
<a href="#l68.199"></a><span id="l68.199" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;Name&quot;_ns, identityName);</span>
<a href="#l68.200"></a><span id="l68.200" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;YourName&quot;_ns, fullName);</span>
<a href="#l68.201"></a><span id="l68.201" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;MailAddress&quot;_ns, email);</span>
<a href="#l68.202"></a><span id="l68.202" class="difflineplus">+  mParser-&gt;GetString(&quot;Account&quot;_ns, &quot;PermBcc&quot;_ns, bccAddress);</span>
<a href="#l68.203"></a><span id="l68.203"> </span>
<a href="#l68.204"></a><span id="l68.204">   nsresult rv;</span>
<a href="#l68.205"></a><span id="l68.205">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l68.206"></a><span id="l68.206">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l68.207"></a><span id="l68.207">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.208"></a><span id="l68.208"> </span>
<a href="#l68.209"></a><span id="l68.209">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l68.210"></a><span id="l68.210">   rv = accountManager-&gt;CreateIdentity(getter_AddRefs(identity));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyUtils.cpp</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyUtils.cpp</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -31,17 +31,17 @@</span>
<a href="#l69.4"></a><span id="l69.4"> </span>
<a href="#l69.5"></a><span id="l69.5"> nsresult nsBeckyUtils::FindUserDirectoryOnWindows7(nsIFile** aLocation) {</span>
<a href="#l69.6"></a><span id="l69.6">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l69.7"></a><span id="l69.7"> </span>
<a href="#l69.8"></a><span id="l69.8">   nsresult rv;</span>
<a href="#l69.9"></a><span id="l69.9">   nsCOMPtr&lt;nsIFile&gt; directory;</span>
<a href="#l69.10"></a><span id="l69.10">   rv = GetSpecialSystemDirectory(Win_Documents, getter_AddRefs(directory));</span>
<a href="#l69.11"></a><span id="l69.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-  rv = directory-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Becky&quot;));</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+  rv = directory-&gt;AppendNative(&quot;Becky&quot;_ns);</span>
<a href="#l69.14"></a><span id="l69.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.15"></a><span id="l69.15"> </span>
<a href="#l69.16"></a><span id="l69.16">   bool exists = false;</span>
<a href="#l69.17"></a><span id="l69.17">   rv = directory-&gt;Exists(&amp;exists);</span>
<a href="#l69.18"></a><span id="l69.18">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.19"></a><span id="l69.19">   if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l69.20"></a><span id="l69.20"> </span>
<a href="#l69.21"></a><span id="l69.21">   bool isDirectory = false;</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineat">@@ -56,17 +56,17 @@ nsresult nsBeckyUtils::FindUserDirectory</span>
<a href="#l69.23"></a><span id="l69.23"> nsresult nsBeckyUtils::FindUserDirectoryOnWindowsXP(nsIFile** aLocation) {</span>
<a href="#l69.24"></a><span id="l69.24">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l69.25"></a><span id="l69.25"> </span>
<a href="#l69.26"></a><span id="l69.26">   nsresult rv;</span>
<a href="#l69.27"></a><span id="l69.27">   nsCOMPtr&lt;nsIFile&gt; directory =</span>
<a href="#l69.28"></a><span id="l69.28">       do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l69.29"></a><span id="l69.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.30"></a><span id="l69.30"> </span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-  rv = directory-&gt;InitWithPath(NS_LITERAL_STRING(&quot;C:\\Becky!&quot;));</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+  rv = directory-&gt;InitWithPath(u&quot;C:\\Becky!&quot;_ns);</span>
<a href="#l69.33"></a><span id="l69.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.34"></a><span id="l69.34"> </span>
<a href="#l69.35"></a><span id="l69.35">   bool exists = false;</span>
<a href="#l69.36"></a><span id="l69.36">   rv = directory-&gt;Exists(&amp;exists);</span>
<a href="#l69.37"></a><span id="l69.37">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.38"></a><span id="l69.38">   if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l69.39"></a><span id="l69.39"> </span>
<a href="#l69.40"></a><span id="l69.40">   bool isDirectory = false;</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineat">@@ -130,17 +130,17 @@ nsresult nsBeckyUtils::CreateLineInputSt</span>
<a href="#l69.42"></a><span id="l69.42"> </span>
<a href="#l69.43"></a><span id="l69.43"> nsresult nsBeckyUtils::GetFolderListFile(nsIFile* aLocation,</span>
<a href="#l69.44"></a><span id="l69.44">                                          nsIFile** _retval) {</span>
<a href="#l69.45"></a><span id="l69.45">   nsresult rv;</span>
<a href="#l69.46"></a><span id="l69.46">   nsCOMPtr&lt;nsIFile&gt; folderListFile;</span>
<a href="#l69.47"></a><span id="l69.47">   rv = aLocation-&gt;Clone(getter_AddRefs(folderListFile));</span>
<a href="#l69.48"></a><span id="l69.48">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.49"></a><span id="l69.49"> </span>
<a href="#l69.50"></a><span id="l69.50" class="difflineminus">-  rv = folderListFile-&gt;Append(NS_LITERAL_STRING(&quot;Folder.lst&quot;));</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+  rv = folderListFile-&gt;Append(u&quot;Folder.lst&quot;_ns);</span>
<a href="#l69.52"></a><span id="l69.52">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.53"></a><span id="l69.53"> </span>
<a href="#l69.54"></a><span id="l69.54">   bool exists;</span>
<a href="#l69.55"></a><span id="l69.55">   rv = folderListFile-&gt;Exists(&amp;exists);</span>
<a href="#l69.56"></a><span id="l69.56">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.57"></a><span id="l69.57"> </span>
<a href="#l69.58"></a><span id="l69.58">   if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l69.59"></a><span id="l69.59"> </span>
<a href="#l69.60"></a><span id="l69.60" class="difflineat">@@ -203,17 +203,17 @@ nsresult nsBeckyUtils::GetDefaultMailbox</span>
<a href="#l69.61"></a><span id="l69.61"> </span>
<a href="#l69.62"></a><span id="l69.62"> nsresult nsBeckyUtils::GetMailboxINIFile(nsIFile* aDirectory,</span>
<a href="#l69.63"></a><span id="l69.63">                                          nsIFile** _retval) {</span>
<a href="#l69.64"></a><span id="l69.64">   nsresult rv;</span>
<a href="#l69.65"></a><span id="l69.65">   nsCOMPtr&lt;nsIFile&gt; target;</span>
<a href="#l69.66"></a><span id="l69.66">   rv = aDirectory-&gt;Clone(getter_AddRefs(target));</span>
<a href="#l69.67"></a><span id="l69.67">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.68"></a><span id="l69.68"> </span>
<a href="#l69.69"></a><span id="l69.69" class="difflineminus">-  rv = target-&gt;Append(NS_LITERAL_STRING(&quot;Mailbox.ini&quot;));</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineplus">+  rv = target-&gt;Append(u&quot;Mailbox.ini&quot;_ns);</span>
<a href="#l69.71"></a><span id="l69.71">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.72"></a><span id="l69.72">   bool exists;</span>
<a href="#l69.73"></a><span id="l69.73">   rv = target-&gt;Exists(&amp;exists);</span>
<a href="#l69.74"></a><span id="l69.74">   if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l69.75"></a><span id="l69.75"> </span>
<a href="#l69.76"></a><span id="l69.76">   target.forget(_retval);</span>
<a href="#l69.77"></a><span id="l69.77">   return NS_OK;</span>
<a href="#l69.78"></a><span id="l69.78"> }</span>
<a href="#l69.79"></a><span id="l69.79" class="difflineat">@@ -230,18 +230,17 @@ nsresult nsBeckyUtils::CreateINIParserFo</span>
<a href="#l69.80"></a><span id="l69.80"> </span>
<a href="#l69.81"></a><span id="l69.81"> nsresult nsBeckyUtils::GetMailboxNameFromINIFile(nsIFile* aFile,</span>
<a href="#l69.82"></a><span id="l69.82">                                                  nsCString&amp; aName) {</span>
<a href="#l69.83"></a><span id="l69.83">   nsresult rv;</span>
<a href="#l69.84"></a><span id="l69.84">   nsCOMPtr&lt;nsIINIParser&gt; parser;</span>
<a href="#l69.85"></a><span id="l69.85">   rv = CreateINIParserForFile(aFile, getter_AddRefs(parser));</span>
<a href="#l69.86"></a><span id="l69.86">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.87"></a><span id="l69.87"> </span>
<a href="#l69.88"></a><span id="l69.88" class="difflineminus">-  return parser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l69.89"></a><span id="l69.89" class="difflineminus">-                           NS_LITERAL_CSTRING(&quot;Name&quot;), aName);</span>
<a href="#l69.90"></a><span id="l69.90" class="difflineplus">+  return parser-&gt;GetString(&quot;Account&quot;_ns, &quot;Name&quot;_ns, aName);</span>
<a href="#l69.91"></a><span id="l69.91"> }</span>
<a href="#l69.92"></a><span id="l69.92"> </span>
<a href="#l69.93"></a><span id="l69.93"> nsresult nsBeckyUtils::ConvertToUTF8File(nsIFile* aSourceFile,</span>
<a href="#l69.94"></a><span id="l69.94">                                          nsIFile** _retval) {</span>
<a href="#l69.95"></a><span id="l69.95">   nsresult rv;</span>
<a href="#l69.96"></a><span id="l69.96">   nsCOMPtr&lt;nsIFile&gt; convertedFile;</span>
<a href="#l69.97"></a><span id="l69.97">   rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l69.98"></a><span id="l69.98">                                        &quot;thunderbird-becky-import&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -199,17 +199,17 @@ nsresult nsOutlookCompose::CreateIdentit</span>
<a href="#l70.4"></a><span id="l70.4">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l70.5"></a><span id="l70.5">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l70.6"></a><span id="l70.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l70.7"></a><span id="l70.7">   rv = accMgr-&gt;CreateIdentity(getter_AddRefs(m_pIdentity));</span>
<a href="#l70.8"></a><span id="l70.8">   nsString name;</span>
<a href="#l70.9"></a><span id="l70.9">   name.AssignLiteral(&quot;Import Identity&quot;);</span>
<a href="#l70.10"></a><span id="l70.10">   if (m_pIdentity) {</span>
<a href="#l70.11"></a><span id="l70.11">     m_pIdentity-&gt;SetFullName(name);</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-    m_pIdentity-&gt;SetEmail(NS_LITERAL_CSTRING(&quot;import@service.invalid&quot;));</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+    m_pIdentity-&gt;SetEmail(&quot;import@service.invalid&quot;_ns);</span>
<a href="#l70.14"></a><span id="l70.14">   }</span>
<a href="#l70.15"></a><span id="l70.15">   return rv;</span>
<a href="#l70.16"></a><span id="l70.16"> }</span>
<a href="#l70.17"></a><span id="l70.17"> </span>
<a href="#l70.18"></a><span id="l70.18"> void nsOutlookCompose::ReleaseIdentity() { m_pIdentity = nullptr; }</span>
<a href="#l70.19"></a><span id="l70.19"> </span>
<a href="#l70.20"></a><span id="l70.20"> nsresult nsOutlookCompose::CreateComponents(void) {</span>
<a href="#l70.21"></a><span id="l70.21">   nsresult rv = NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -680,17 +680,17 @@ nsresult nsOutlookMail::CreateList(const</span>
<a href="#l71.4"></a><span id="l71.4">   m_mapi.MAPIFreeBuffer(value);</span>
<a href="#l71.5"></a><span id="l71.5"> </span>
<a href="#l71.6"></a><span id="l71.6">   nsIAbDirectory* outList;</span>
<a href="#l71.7"></a><span id="l71.7">   rv = pDirectory-&gt;AddMailList(newList, &amp;outList);</span>
<a href="#l71.8"></a><span id="l71.8">   return rv;</span>
<a href="#l71.9"></a><span id="l71.9"> }</span>
<a href="#l71.10"></a><span id="l71.10"> </span>
<a href="#l71.11"></a><span id="l71.11"> void nsOutlookMail::SanitizeValue(nsString&amp; val) {</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-  val.ReplaceSubstring(NS_LITERAL_STRING(&quot;\r\n&quot;), NS_LITERAL_STRING(&quot;, &quot;));</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+  val.ReplaceSubstring(u&quot;\r\n&quot;_ns, u&quot;, &quot;_ns);</span>
<a href="#l71.14"></a><span id="l71.14">   val.ReplaceChar(&quot;\r\n&quot;, ',');</span>
<a href="#l71.15"></a><span id="l71.15"> }</span>
<a href="#l71.16"></a><span id="l71.16"> </span>
<a href="#l71.17"></a><span id="l71.17"> void nsOutlookMail::SplitString(nsString&amp; val1, nsString&amp; val2) {</span>
<a href="#l71.18"></a><span id="l71.18">   // Find the last line if there is more than one!</span>
<a href="#l71.19"></a><span id="l71.19">   int32_t idx = val1.RFind(&quot;\x0D\x0A&quot;);</span>
<a href="#l71.20"></a><span id="l71.20">   int32_t cnt = 2;</span>
<a href="#l71.21"></a><span id="l71.21">   if (idx == -1) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookSettings.cpp</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookSettings.cpp</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -161,17 +161,17 @@ nsresult OutlookSettings::QueryAccountSu</span>
<a href="#l72.4"></a><span id="l72.4">   return NS_ERROR_FAILURE;</span>
<a href="#l72.5"></a><span id="l72.5"> }</span>
<a href="#l72.6"></a><span id="l72.6"> </span>
<a href="#l72.7"></a><span id="l72.7"> nsresult OutlookSettings::GetDefaultMailAccountName(nsAString&amp; aName) {</span>
<a href="#l72.8"></a><span id="l72.8">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l72.9"></a><span id="l72.9">   nsresult rv = QueryAccountSubKey(getter_AddRefs(key));</span>
<a href="#l72.10"></a><span id="l72.10">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-  return key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default Mail Account&quot;), aName);</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+  return key-&gt;ReadStringValue(u&quot;Default Mail Account&quot;_ns, aName);</span>
<a href="#l72.14"></a><span id="l72.14"> }</span>
<a href="#l72.15"></a><span id="l72.15"> </span>
<a href="#l72.16"></a><span id="l72.16"> bool OutlookSettings::DoImport(nsIMsgAccount** aAccount) {</span>
<a href="#l72.17"></a><span id="l72.17">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l72.18"></a><span id="l72.18">   nsresult rv = OutlookSettings::FindAccountsKey(getter_AddRefs(key));</span>
<a href="#l72.19"></a><span id="l72.19">   if (NS_FAILED(rv)) {</span>
<a href="#l72.20"></a><span id="l72.20">     IMPORT_LOG0(&quot;*** Error finding Outlook registry account keys\n&quot;);</span>
<a href="#l72.21"></a><span id="l72.21">     return false;</span>
<a href="#l72.22"></a><span id="l72.22" class="difflineat">@@ -202,22 +202,22 @@ bool OutlookSettings::DoImport(nsIMsgAcc</span>
<a href="#l72.23"></a><span id="l72.23"> </span>
<a href="#l72.24"></a><span id="l72.24">     // Get the values for this account.</span>
<a href="#l72.25"></a><span id="l72.25">     nsAutoCString nativeKeyName;</span>
<a href="#l72.26"></a><span id="l72.26">     NS_CopyUnicodeToNative(keyName, nativeKeyName);</span>
<a href="#l72.27"></a><span id="l72.27">     IMPORT_LOG1(&quot;Opened Outlook account: %s\n&quot;, nativeKeyName.get());</span>
<a href="#l72.28"></a><span id="l72.28"> </span>
<a href="#l72.29"></a><span id="l72.29">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l72.30"></a><span id="l72.30">     nsAutoString value;</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineminus">-    rv = subKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;IMAP Server&quot;), value);</span>
<a href="#l72.32"></a><span id="l72.32" class="difflineplus">+    rv = subKey-&gt;ReadStringValue(u&quot;IMAP Server&quot;_ns, value);</span>
<a href="#l72.33"></a><span id="l72.33">     if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l72.34"></a><span id="l72.34">         DoIMAPServer(accMgr, subKey, value, getter_AddRefs(account)))</span>
<a href="#l72.35"></a><span id="l72.35">       accounts++;</span>
<a href="#l72.36"></a><span id="l72.36"> </span>
<a href="#l72.37"></a><span id="l72.37" class="difflineminus">-    rv = subKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;POP3 Server&quot;), value);</span>
<a href="#l72.38"></a><span id="l72.38" class="difflineplus">+    rv = subKey-&gt;ReadStringValue(u&quot;POP3 Server&quot;_ns, value);</span>
<a href="#l72.39"></a><span id="l72.39">     if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l72.40"></a><span id="l72.40">         DoPOP3Server(accMgr, subKey, value, getter_AddRefs(account))) {</span>
<a href="#l72.41"></a><span id="l72.41">       popCount++;</span>
<a href="#l72.42"></a><span id="l72.42">       accounts++;</span>
<a href="#l72.43"></a><span id="l72.43">       if (aAccount &amp;&amp; account) {</span>
<a href="#l72.44"></a><span id="l72.44">         // If we created a mail account, get rid of it since</span>
<a href="#l72.45"></a><span id="l72.45">         // we have 2 POP accounts!</span>
<a href="#l72.46"></a><span id="l72.46">         if (popCount &gt; 1)</span>
<a href="#l72.47"></a><span id="l72.47" class="difflineat">@@ -238,48 +238,47 @@ bool OutlookSettings::DoImport(nsIMsgAcc</span>
<a href="#l72.48"></a><span id="l72.48"> </span>
<a href="#l72.49"></a><span id="l72.49">   return accounts != 0;</span>
<a href="#l72.50"></a><span id="l72.50"> }</span>
<a href="#l72.51"></a><span id="l72.51"> </span>
<a href="#l72.52"></a><span id="l72.52"> nsresult OutlookSettings::GetAccountName(nsIWindowsRegKey* aKey,</span>
<a href="#l72.53"></a><span id="l72.53">                                          const nsString&amp; aDefaultName,</span>
<a href="#l72.54"></a><span id="l72.54">                                          nsAString&amp; aAccountName) {</span>
<a href="#l72.55"></a><span id="l72.55">   nsresult rv;</span>
<a href="#l72.56"></a><span id="l72.56" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Account Name&quot;), aAccountName);</span>
<a href="#l72.57"></a><span id="l72.57" class="difflineplus">+  rv = aKey-&gt;ReadStringValue(u&quot;Account Name&quot;_ns, aAccountName);</span>
<a href="#l72.58"></a><span id="l72.58">   if (NS_FAILED(rv)) aAccountName.Assign(aDefaultName);</span>
<a href="#l72.59"></a><span id="l72.59"> </span>
<a href="#l72.60"></a><span id="l72.60">   return NS_OK;</span>
<a href="#l72.61"></a><span id="l72.61"> }</span>
<a href="#l72.62"></a><span id="l72.62"> </span>
<a href="#l72.63"></a><span id="l72.63"> bool OutlookSettings::DoIMAPServer(nsIMsgAccountManager* aMgr,</span>
<a href="#l72.64"></a><span id="l72.64">                                    nsIWindowsRegKey* aKey,</span>
<a href="#l72.65"></a><span id="l72.65">                                    const nsString&amp; aServerName,</span>
<a href="#l72.66"></a><span id="l72.66">                                    nsIMsgAccount** aAccount) {</span>
<a href="#l72.67"></a><span id="l72.67">   nsAutoString userName;</span>
<a href="#l72.68"></a><span id="l72.68">   nsresult rv;</span>
<a href="#l72.69"></a><span id="l72.69" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;IMAP User Name&quot;), userName);</span>
<a href="#l72.70"></a><span id="l72.70" class="difflineplus">+  rv = aKey-&gt;ReadStringValue(u&quot;IMAP User Name&quot;_ns, userName);</span>
<a href="#l72.71"></a><span id="l72.71">   if (NS_FAILED(rv)) return false;</span>
<a href="#l72.72"></a><span id="l72.72"> </span>
<a href="#l72.73"></a><span id="l72.73">   bool result = false;</span>
<a href="#l72.74"></a><span id="l72.74"> </span>
<a href="#l72.75"></a><span id="l72.75">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l72.76"></a><span id="l72.76">   nsAutoCString nativeUserName;</span>
<a href="#l72.77"></a><span id="l72.77">   NS_CopyUnicodeToNative(userName, nativeUserName);</span>
<a href="#l72.78"></a><span id="l72.78">   nsAutoCString nativeServerName;</span>
<a href="#l72.79"></a><span id="l72.79">   NS_CopyUnicodeToNative(aServerName, nativeServerName);</span>
<a href="#l72.80"></a><span id="l72.80">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l72.81"></a><span id="l72.81" class="difflineminus">-  rv = aMgr-&gt;FindServer(nativeUserName, nativeServerName,</span>
<a href="#l72.82"></a><span id="l72.82" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l72.83"></a><span id="l72.83" class="difflineplus">+  rv = aMgr-&gt;FindServer(nativeUserName, nativeServerName, &quot;imap&quot;_ns,</span>
<a href="#l72.84"></a><span id="l72.84" class="difflineplus">+                        getter_AddRefs(in));</span>
<a href="#l72.85"></a><span id="l72.85">   if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l72.86"></a><span id="l72.86">     // Create the incoming server and an account for it?</span>
<a href="#l72.87"></a><span id="l72.87" class="difflineminus">-    rv = aMgr-&gt;CreateIncomingServer(nativeUserName, nativeServerName,</span>
<a href="#l72.88"></a><span id="l72.88" class="difflineminus">-                                    NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l72.89"></a><span id="l72.89" class="difflineplus">+    rv = aMgr-&gt;CreateIncomingServer(nativeUserName, nativeServerName, &quot;imap&quot;_ns,</span>
<a href="#l72.90"></a><span id="l72.90">                                     getter_AddRefs(in));</span>
<a href="#l72.91"></a><span id="l72.91">     if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l72.92"></a><span id="l72.92" class="difflineminus">-      rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l72.93"></a><span id="l72.93" class="difflineplus">+      rv = in-&gt;SetType(&quot;imap&quot;_ns);</span>
<a href="#l72.94"></a><span id="l72.94">       // TODO SSL, auth method</span>
<a href="#l72.95"></a><span id="l72.95"> </span>
<a href="#l72.96"></a><span id="l72.96">       IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;,</span>
<a href="#l72.97"></a><span id="l72.97">                   nativeServerName.get(), nativeUserName.get());</span>
<a href="#l72.98"></a><span id="l72.98"> </span>
<a href="#l72.99"></a><span id="l72.99">       nsAutoString prettyName;</span>
<a href="#l72.100"></a><span id="l72.100">       if (NS_SUCCEEDED(GetAccountName(aKey, aServerName, prettyName)))</span>
<a href="#l72.101"></a><span id="l72.101">         rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l72.102"></a><span id="l72.102" class="difflineat">@@ -306,34 +305,33 @@ bool OutlookSettings::DoIMAPServer(nsIMs</span>
<a href="#l72.103"></a><span id="l72.103"> }</span>
<a href="#l72.104"></a><span id="l72.104"> </span>
<a href="#l72.105"></a><span id="l72.105"> bool OutlookSettings::DoPOP3Server(nsIMsgAccountManager* aMgr,</span>
<a href="#l72.106"></a><span id="l72.106">                                    nsIWindowsRegKey* aKey,</span>
<a href="#l72.107"></a><span id="l72.107">                                    const nsString&amp; aServerName,</span>
<a href="#l72.108"></a><span id="l72.108">                                    nsIMsgAccount** aAccount) {</span>
<a href="#l72.109"></a><span id="l72.109">   nsAutoString userName;</span>
<a href="#l72.110"></a><span id="l72.110">   nsresult rv;</span>
<a href="#l72.111"></a><span id="l72.111" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;POP3 User Name&quot;), userName);</span>
<a href="#l72.112"></a><span id="l72.112" class="difflineplus">+  rv = aKey-&gt;ReadStringValue(u&quot;POP3 User Name&quot;_ns, userName);</span>
<a href="#l72.113"></a><span id="l72.113">   if (NS_FAILED(rv)) return false;</span>
<a href="#l72.114"></a><span id="l72.114"> </span>
<a href="#l72.115"></a><span id="l72.115">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l72.116"></a><span id="l72.116">   nsAutoCString nativeUserName;</span>
<a href="#l72.117"></a><span id="l72.117">   NS_CopyUnicodeToNative(userName, nativeUserName);</span>
<a href="#l72.118"></a><span id="l72.118">   nsAutoCString nativeServerName;</span>
<a href="#l72.119"></a><span id="l72.119">   NS_CopyUnicodeToNative(aServerName, nativeServerName);</span>
<a href="#l72.120"></a><span id="l72.120">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l72.121"></a><span id="l72.121" class="difflineminus">-  rv = aMgr-&gt;FindServer(nativeUserName, nativeServerName,</span>
<a href="#l72.122"></a><span id="l72.122" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l72.123"></a><span id="l72.123" class="difflineplus">+  rv = aMgr-&gt;FindServer(nativeUserName, nativeServerName, &quot;pop3&quot;_ns,</span>
<a href="#l72.124"></a><span id="l72.124" class="difflineplus">+                        getter_AddRefs(in));</span>
<a href="#l72.125"></a><span id="l72.125">   if (NS_SUCCEEDED(rv)) return true;</span>
<a href="#l72.126"></a><span id="l72.126"> </span>
<a href="#l72.127"></a><span id="l72.127">   // Create the incoming server and an account for it?</span>
<a href="#l72.128"></a><span id="l72.128" class="difflineminus">-  rv = aMgr-&gt;CreateIncomingServer(nativeUserName, nativeServerName,</span>
<a href="#l72.129"></a><span id="l72.129" class="difflineminus">-                                  NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l72.130"></a><span id="l72.130" class="difflineplus">+  rv = aMgr-&gt;CreateIncomingServer(nativeUserName, nativeServerName, &quot;pop3&quot;_ns,</span>
<a href="#l72.131"></a><span id="l72.131">                                   getter_AddRefs(in));</span>
<a href="#l72.132"></a><span id="l72.132" class="difflineminus">-  rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l72.133"></a><span id="l72.133" class="difflineplus">+  rv = in-&gt;SetType(&quot;pop3&quot;_ns);</span>
<a href="#l72.134"></a><span id="l72.134"> </span>
<a href="#l72.135"></a><span id="l72.135">   // TODO SSL, auth method</span>
<a href="#l72.136"></a><span id="l72.136"> </span>
<a href="#l72.137"></a><span id="l72.137">   nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in);</span>
<a href="#l72.138"></a><span id="l72.138">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l72.139"></a><span id="l72.139"> </span>
<a href="#l72.140"></a><span id="l72.140">   // set local folders as the Inbox to use for this POP3 server</span>
<a href="#l72.141"></a><span id="l72.141">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; localFoldersServer;</span>
<a href="#l72.142"></a><span id="l72.142" class="difflineat">@@ -377,51 +375,49 @@ bool OutlookSettings::DoPOP3Server(nsIMs</span>
<a href="#l72.143"></a><span id="l72.143"> </span>
<a href="#l72.144"></a><span id="l72.144">   rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l72.145"></a><span id="l72.145"> </span>
<a href="#l72.146"></a><span id="l72.146">   IMPORT_LOG0(</span>
<a href="#l72.147"></a><span id="l72.147">       &quot;Created a new account and set the incoming server to the POP3 &quot;</span>
<a href="#l72.148"></a><span id="l72.148">       &quot;server.\n&quot;);</span>
<a href="#l72.149"></a><span id="l72.149"> </span>
<a href="#l72.150"></a><span id="l72.150">   uint32_t leaveOnServer;</span>
<a href="#l72.151"></a><span id="l72.151" class="difflineminus">-  rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Leave Mail On Server&quot;),</span>
<a href="#l72.152"></a><span id="l72.152" class="difflineminus">-                          &amp;leaveOnServer);</span>
<a href="#l72.153"></a><span id="l72.153" class="difflineplus">+  rv = aKey-&gt;ReadIntValue(u&quot;Leave Mail On Server&quot;_ns, &amp;leaveOnServer);</span>
<a href="#l72.154"></a><span id="l72.154">   if (NS_SUCCEEDED(rv))</span>
<a href="#l72.155"></a><span id="l72.155">     pop3Server-&gt;SetLeaveMessagesOnServer(leaveOnServer == 1 ? true : false);</span>
<a href="#l72.156"></a><span id="l72.156"> </span>
<a href="#l72.157"></a><span id="l72.157">   // Fiddle with the identities</span>
<a href="#l72.158"></a><span id="l72.158">   SetIdentities(aMgr, account, aKey);</span>
<a href="#l72.159"></a><span id="l72.159"> </span>
<a href="#l72.160"></a><span id="l72.160">   if (aAccount) account.forget(aAccount);</span>
<a href="#l72.161"></a><span id="l72.161"> </span>
<a href="#l72.162"></a><span id="l72.162">   return true;</span>
<a href="#l72.163"></a><span id="l72.163"> }</span>
<a href="#l72.164"></a><span id="l72.164"> </span>
<a href="#l72.165"></a><span id="l72.165"> void OutlookSettings::SetIdentities(nsIMsgAccountManager* aMgr,</span>
<a href="#l72.166"></a><span id="l72.166">                                     nsIMsgAccount* aAcc,</span>
<a href="#l72.167"></a><span id="l72.167">                                     nsIWindowsRegKey* aKey) {</span>
<a href="#l72.168"></a><span id="l72.168">   // Get the relevant information for an identity</span>
<a href="#l72.169"></a><span id="l72.169">   nsAutoString name;</span>
<a href="#l72.170"></a><span id="l72.170" class="difflineminus">-  aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Display Name&quot;), name);</span>
<a href="#l72.171"></a><span id="l72.171" class="difflineplus">+  aKey-&gt;ReadStringValue(u&quot;SMTP Display Name&quot;_ns, name);</span>
<a href="#l72.172"></a><span id="l72.172"> </span>
<a href="#l72.173"></a><span id="l72.173">   nsAutoString server;</span>
<a href="#l72.174"></a><span id="l72.174" class="difflineminus">-  aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Server&quot;), server);</span>
<a href="#l72.175"></a><span id="l72.175" class="difflineplus">+  aKey-&gt;ReadStringValue(u&quot;SMTP Server&quot;_ns, server);</span>
<a href="#l72.176"></a><span id="l72.176"> </span>
<a href="#l72.177"></a><span id="l72.177">   nsAutoString email;</span>
<a href="#l72.178"></a><span id="l72.178" class="difflineminus">-  aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Email Address&quot;), email);</span>
<a href="#l72.179"></a><span id="l72.179" class="difflineplus">+  aKey-&gt;ReadStringValue(u&quot;SMTP Email Address&quot;_ns, email);</span>
<a href="#l72.180"></a><span id="l72.180"> </span>
<a href="#l72.181"></a><span id="l72.181">   nsAutoString reply;</span>
<a href="#l72.182"></a><span id="l72.182" class="difflineminus">-  aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Reply To Email Address&quot;),</span>
<a href="#l72.183"></a><span id="l72.183" class="difflineminus">-                        reply);</span>
<a href="#l72.184"></a><span id="l72.184" class="difflineplus">+  aKey-&gt;ReadStringValue(u&quot;SMTP Reply To Email Address&quot;_ns, reply);</span>
<a href="#l72.185"></a><span id="l72.185"> </span>
<a href="#l72.186"></a><span id="l72.186">   nsAutoString userName;</span>
<a href="#l72.187"></a><span id="l72.187" class="difflineminus">-  aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP User Name&quot;), userName);</span>
<a href="#l72.188"></a><span id="l72.188" class="difflineplus">+  aKey-&gt;ReadStringValue(u&quot;SMTP User Name&quot;_ns, userName);</span>
<a href="#l72.189"></a><span id="l72.189"> </span>
<a href="#l72.190"></a><span id="l72.190">   nsAutoString orgName;</span>
<a href="#l72.191"></a><span id="l72.191" class="difflineminus">-  aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Organization Name&quot;), orgName);</span>
<a href="#l72.192"></a><span id="l72.192" class="difflineplus">+  aKey-&gt;ReadStringValue(u&quot;SMTP Organization Name&quot;_ns, orgName);</span>
<a href="#l72.193"></a><span id="l72.193"> </span>
<a href="#l72.194"></a><span id="l72.194">   nsresult rv;</span>
<a href="#l72.195"></a><span id="l72.195">   nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l72.196"></a><span id="l72.196">   if (!email.IsEmpty() &amp;&amp; !name.IsEmpty() &amp;&amp; !server.IsEmpty()) {</span>
<a href="#l72.197"></a><span id="l72.197">     // The default identity, nor any other identities matched,</span>
<a href="#l72.198"></a><span id="l72.198">     // create a new one and add it to the account.</span>
<a href="#l72.199"></a><span id="l72.199">     rv = aMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l72.200"></a><span id="l72.200">     if (id) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/mailnews/import/src/nsImportStringBundle.cpp</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/mailnews/import/src/nsImportStringBundle.cpp</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -33,17 +33,17 @@ void nsImportStringBundle::GetStringByID</span>
<a href="#l73.4"></a><span id="l73.4"> char16_t* nsImportStringBundle::GetStringByID(int32_t aStringID,</span>
<a href="#l73.5"></a><span id="l73.5">                                               nsIStringBundle* aBundle) {</span>
<a href="#l73.6"></a><span id="l73.6">   if (aBundle) {</span>
<a href="#l73.7"></a><span id="l73.7">     nsAutoString str;</span>
<a href="#l73.8"></a><span id="l73.8">     nsresult rv = aBundle-&gt;GetStringFromID(aStringID, str);</span>
<a href="#l73.9"></a><span id="l73.9">     if (NS_SUCCEEDED(rv)) return ToNewUnicode(str);</span>
<a href="#l73.10"></a><span id="l73.10">   }</span>
<a href="#l73.11"></a><span id="l73.11"> </span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-  nsString resultString(NS_LITERAL_STRING(&quot;[StringID &quot;));</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+  nsString resultString(u&quot;[StringID &quot;_ns);</span>
<a href="#l73.14"></a><span id="l73.14">   resultString.AppendInt(aStringID);</span>
<a href="#l73.15"></a><span id="l73.15">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l73.16"></a><span id="l73.16"> </span>
<a href="#l73.17"></a><span id="l73.17">   return ToNewUnicode(resultString);</span>
<a href="#l73.18"></a><span id="l73.18"> }</span>
<a href="#l73.19"></a><span id="l73.19"> </span>
<a href="#l73.20"></a><span id="l73.20"> void nsImportStringBundle::GetStringByName(const char* aName,</span>
<a href="#l73.21"></a><span id="l73.21">                                            nsIStringBundle* aBundle,</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineat">@@ -54,14 +54,14 @@ void nsImportStringBundle::GetStringByNa</span>
<a href="#l73.23"></a><span id="l73.23"> char16_t* nsImportStringBundle::GetStringByName(const char* aName,</span>
<a href="#l73.24"></a><span id="l73.24">                                                 nsIStringBundle* aBundle) {</span>
<a href="#l73.25"></a><span id="l73.25">   if (aBundle) {</span>
<a href="#l73.26"></a><span id="l73.26">     nsAutoString str;</span>
<a href="#l73.27"></a><span id="l73.27">     nsresult rv = aBundle-&gt;GetStringFromName(aName, str);</span>
<a href="#l73.28"></a><span id="l73.28">     if (NS_SUCCEEDED(rv)) return ToNewUnicode(str);</span>
<a href="#l73.29"></a><span id="l73.29">   }</span>
<a href="#l73.30"></a><span id="l73.30"> </span>
<a href="#l73.31"></a><span id="l73.31" class="difflineminus">-  nsString resultString(NS_LITERAL_STRING(&quot;[StringName &quot;));</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+  nsString resultString(u&quot;[StringName &quot;_ns);</span>
<a href="#l73.33"></a><span id="l73.33">   resultString.Append(NS_ConvertUTF8toUTF16(aName).get());</span>
<a href="#l73.34"></a><span id="l73.34">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l73.35"></a><span id="l73.35"> </span>
<a href="#l73.36"></a><span id="l73.36">   return ToNewUnicode(resultString);</span>
<a href="#l73.37"></a><span id="l73.37"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -461,20 +461,20 @@ NS_IMETHODIMP ImportAddressImpl::GetNeed</span>
<a href="#l74.4"></a><span id="l74.4"> </span>
<a href="#l74.5"></a><span id="l74.5">   if (isLDIF) *_retval = false;</span>
<a href="#l74.6"></a><span id="l74.6"> </span>
<a href="#l74.7"></a><span id="l74.7">   return NS_OK;</span>
<a href="#l74.8"></a><span id="l74.8"> }</span>
<a href="#l74.9"></a><span id="l74.9"> </span>
<a href="#l74.10"></a><span id="l74.10"> void ImportAddressImpl::SanitizeSampleData(nsString&amp; val) {</span>
<a href="#l74.11"></a><span id="l74.11">   // remove any line-feeds...</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-  int32_t offset = val.Find(NS_LITERAL_STRING(&quot;\x0D\x0A&quot;));</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+  int32_t offset = val.Find(u&quot;\x0D\x0A&quot;_ns);</span>
<a href="#l74.14"></a><span id="l74.14">   while (offset != -1) {</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineminus">-    val.Replace(offset, 2, NS_LITERAL_STRING(&quot;, &quot;));</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineminus">-    offset = val.Find(NS_LITERAL_STRING(&quot;\x0D\x0A&quot;), offset + 2);</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineplus">+    val.Replace(offset, 2, u&quot;, &quot;_ns);</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+    offset = val.Find(u&quot;\x0D\x0A&quot;_ns, offset + 2);</span>
<a href="#l74.19"></a><span id="l74.19">   }</span>
<a href="#l74.20"></a><span id="l74.20">   offset = val.FindChar(13);</span>
<a href="#l74.21"></a><span id="l74.21">   while (offset != -1) {</span>
<a href="#l74.22"></a><span id="l74.22">     val.Replace(offset, 1, ',');</span>
<a href="#l74.23"></a><span id="l74.23">     offset = val.FindChar(13, offset + 2);</span>
<a href="#l74.24"></a><span id="l74.24">   }</span>
<a href="#l74.25"></a><span id="l74.25">   offset = val.FindChar(10);</span>
<a href="#l74.26"></a><span id="l74.26">   while (offset != -1) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMSettings.cpp</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMSettings.cpp</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -120,35 +120,35 @@ bool WMSettings::DoImport(nsIMsgAccount*</span>
<a href="#l75.4"></a><span id="l75.4">   }</span>
<a href="#l75.5"></a><span id="l75.5">   // 'poll for messages' setting in WM is a global setting-Like OE</span>
<a href="#l75.6"></a><span id="l75.6">   // for all accounts dword ==0xffffffff for don't poll else 1/60000 = minutes</span>
<a href="#l75.7"></a><span id="l75.7">   checkNewMailTime = 30;</span>
<a href="#l75.8"></a><span id="l75.8">   checkNewMail = false;</span>
<a href="#l75.9"></a><span id="l75.9"> </span>
<a href="#l75.10"></a><span id="l75.10">   nsresult rv;</span>
<a href="#l75.11"></a><span id="l75.11">   nsCOMPtr&lt;nsIWindowsRegKey&gt; subKey;</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-  if (NS_SUCCEEDED(key-&gt;OpenChild(NS_LITERAL_STRING(&quot;mail&quot;),</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+  if (NS_SUCCEEDED(key-&gt;OpenChild(u&quot;mail&quot;_ns,</span>
<a href="#l75.14"></a><span id="l75.14">                                   nsIWindowsRegKey::ACCESS_QUERY_VALUE,</span>
<a href="#l75.15"></a><span id="l75.15">                                   getter_AddRefs(subKey)))) {</span>
<a href="#l75.16"></a><span id="l75.16">     uint32_t dwordResult = -1;</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineminus">-    rv = subKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Poll For Mail&quot;),</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineplus">+    rv = subKey-&gt;ReadIntValue(u&quot;Poll For Mail&quot;_ns,</span>
<a href="#l75.19"></a><span id="l75.19">                               &amp;dwordResult);  // reg_dword</span>
<a href="#l75.20"></a><span id="l75.20">     subKey-&gt;Close();</span>
<a href="#l75.21"></a><span id="l75.21">     if (NS_SUCCEEDED(rv) &amp;&amp; dwordResult != -1) {</span>
<a href="#l75.22"></a><span id="l75.22">       checkNewMail = true;</span>
<a href="#l75.23"></a><span id="l75.23">       checkNewMailTime = dwordResult / 60000;</span>
<a href="#l75.24"></a><span id="l75.24">     }</span>
<a href="#l75.25"></a><span id="l75.25">   }</span>
<a href="#l75.26"></a><span id="l75.26">   // these are in main windowsmail key and if they don't exist-not to worry</span>
<a href="#l75.27"></a><span id="l75.27">   // (less than 64 chars) e.g.</span>
<a href="#l75.28"></a><span id="l75.28">   // account{4A18B81E-83CA-472A-8D7F-5301C0B97B8D}.oeaccount</span>
<a href="#l75.29"></a><span id="l75.29">   nsAutoString defMailAcct, defNewsAcct;</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineminus">-  key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default Mail Account&quot;),</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineplus">+  key-&gt;ReadStringValue(u&quot;Default Mail Account&quot;_ns,</span>
<a href="#l75.32"></a><span id="l75.32">                        defMailAcct);  // ref_sz</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineminus">-  key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default News Account&quot;),</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineplus">+  key-&gt;ReadStringValue(u&quot;Default News Account&quot;_ns,</span>
<a href="#l75.35"></a><span id="l75.35">                        defNewsAcct);  // ref_sz</span>
<a href="#l75.36"></a><span id="l75.36"> </span>
<a href="#l75.37"></a><span id="l75.37">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l75.38"></a><span id="l75.38">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l75.39"></a><span id="l75.39">   if (NS_FAILED(rv)) {</span>
<a href="#l75.40"></a><span id="l75.40">     IMPORT_LOG0(&quot;*** Failed to create an account manager!\n&quot;);</span>
<a href="#l75.41"></a><span id="l75.41">     return false;</span>
<a href="#l75.42"></a><span id="l75.42">   }</span>
<a href="#l75.43"></a><span id="l75.43" class="difflineat">@@ -205,24 +205,24 @@ bool WMSettings::DoIMAPServer(nsIMsgAcco</span>
<a href="#l75.44"></a><span id="l75.44">   if (ppAccount) *ppAccount = nullptr;</span>
<a href="#l75.45"></a><span id="l75.45"> </span>
<a href="#l75.46"></a><span id="l75.46">   nsAutoString userName, value;</span>
<a href="#l75.47"></a><span id="l75.47">   if (NS_FAILED(nsWMUtils::GetValueForTag(xmlDoc, &quot;IMAP_User_Name&quot;, userName)))</span>
<a href="#l75.48"></a><span id="l75.48">     return false;</span>
<a href="#l75.49"></a><span id="l75.49">   bool result = false;</span>
<a href="#l75.50"></a><span id="l75.50">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l75.51"></a><span id="l75.51">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l75.52"></a><span id="l75.52" class="difflineminus">-  nsresult rv = pMgr-&gt;FindServer(</span>
<a href="#l75.53"></a><span id="l75.53" class="difflineminus">-      NS_ConvertUTF16toUTF8(userName), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.54"></a><span id="l75.54" class="difflineminus">-      NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l75.55"></a><span id="l75.55" class="difflineplus">+  nsresult rv = pMgr-&gt;FindServer(NS_ConvertUTF16toUTF8(userName),</span>
<a href="#l75.56"></a><span id="l75.56" class="difflineplus">+                                 NS_ConvertUTF16toUTF8(serverName), &quot;imap&quot;_ns,</span>
<a href="#l75.57"></a><span id="l75.57" class="difflineplus">+                                 getter_AddRefs(in));</span>
<a href="#l75.58"></a><span id="l75.58">   if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l75.59"></a><span id="l75.59">     // Create the incoming server and an account for it?</span>
<a href="#l75.60"></a><span id="l75.60" class="difflineminus">-    rv = pMgr-&gt;CreateIncomingServer(</span>
<a href="#l75.61"></a><span id="l75.61" class="difflineminus">-        NS_ConvertUTF16toUTF8(userName), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineminus">-        NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineplus">+    rv = pMgr-&gt;CreateIncomingServer(NS_ConvertUTF16toUTF8(userName),</span>
<a href="#l75.64"></a><span id="l75.64" class="difflineplus">+                                    NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineplus">+                                    &quot;imap&quot;_ns, getter_AddRefs(in));</span>
<a href="#l75.66"></a><span id="l75.66">     if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l75.67"></a><span id="l75.67">       nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(in);</span>
<a href="#l75.68"></a><span id="l75.68">       if (!imapServer) {</span>
<a href="#l75.69"></a><span id="l75.69">         IMPORT_LOG1(&quot;*** Failed to create nsIImapIncomingServer for %S!\n&quot;,</span>
<a href="#l75.70"></a><span id="l75.70">                     serverName.get());</span>
<a href="#l75.71"></a><span id="l75.71">         return false;</span>
<a href="#l75.72"></a><span id="l75.72">       }</span>
<a href="#l75.73"></a><span id="l75.73">       if (NS_SUCCEEDED(</span>
<a href="#l75.74"></a><span id="l75.74" class="difflineat">@@ -300,24 +300,24 @@ bool WMSettings::DoPOP3Server(nsIMsgAcco</span>
<a href="#l75.75"></a><span id="l75.75">   if (ppAccount) *ppAccount = nullptr;</span>
<a href="#l75.76"></a><span id="l75.76"> </span>
<a href="#l75.77"></a><span id="l75.77">   nsAutoString userName, value;</span>
<a href="#l75.78"></a><span id="l75.78">   if (NS_FAILED(nsWMUtils::GetValueForTag(xmlDoc, &quot;POP3_User_Name&quot;, userName)))</span>
<a href="#l75.79"></a><span id="l75.79">     return false;</span>
<a href="#l75.80"></a><span id="l75.80">   bool result = false;</span>
<a href="#l75.81"></a><span id="l75.81">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l75.82"></a><span id="l75.82">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineminus">-  nsresult rv = pMgr-&gt;FindServer(</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineminus">-      NS_ConvertUTF16toUTF8(userName), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineminus">-      NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineplus">+  nsresult rv = pMgr-&gt;FindServer(NS_ConvertUTF16toUTF8(userName),</span>
<a href="#l75.87"></a><span id="l75.87" class="difflineplus">+                                 NS_ConvertUTF16toUTF8(serverName), &quot;pop3&quot;_ns,</span>
<a href="#l75.88"></a><span id="l75.88" class="difflineplus">+                                 getter_AddRefs(in));</span>
<a href="#l75.89"></a><span id="l75.89">   if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l75.90"></a><span id="l75.90">     // Create the incoming server and an account for it?</span>
<a href="#l75.91"></a><span id="l75.91" class="difflineminus">-    rv = pMgr-&gt;CreateIncomingServer(</span>
<a href="#l75.92"></a><span id="l75.92" class="difflineminus">-        NS_ConvertUTF16toUTF8(userName), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.93"></a><span id="l75.93" class="difflineminus">-        NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l75.94"></a><span id="l75.94" class="difflineplus">+    rv = pMgr-&gt;CreateIncomingServer(NS_ConvertUTF16toUTF8(userName),</span>
<a href="#l75.95"></a><span id="l75.95" class="difflineplus">+                                    NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineplus">+                                    &quot;pop3&quot;_ns, getter_AddRefs(in));</span>
<a href="#l75.97"></a><span id="l75.97">     if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l75.98"></a><span id="l75.98">       nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in);</span>
<a href="#l75.99"></a><span id="l75.99">       if (!pop3Server) {</span>
<a href="#l75.100"></a><span id="l75.100">         IMPORT_LOG1(&quot;*** Failed to create nsIPop3IncomingServer for %S!\n&quot;,</span>
<a href="#l75.101"></a><span id="l75.101">                     serverName.get());</span>
<a href="#l75.102"></a><span id="l75.102">         return false;</span>
<a href="#l75.103"></a><span id="l75.103">       }</span>
<a href="#l75.104"></a><span id="l75.104"> </span>
<a href="#l75.105"></a><span id="l75.105" class="difflineat">@@ -451,22 +451,22 @@ bool WMSettings::DoNNTPServer(nsIMsgAcco</span>
<a href="#l75.106"></a><span id="l75.106">   nsWMUtils::GetValueForTag(xmlDoc, &quot;NNTP_User_Name&quot;, userName);</span>
<a href="#l75.107"></a><span id="l75.107">   bool result = false;</span>
<a href="#l75.108"></a><span id="l75.108"> </span>
<a href="#l75.109"></a><span id="l75.109">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l75.110"></a><span id="l75.110">   // NNTP can have empty user name.  This is wild card in findserver</span>
<a href="#l75.111"></a><span id="l75.111">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l75.112"></a><span id="l75.112">   nsresult rv =</span>
<a href="#l75.113"></a><span id="l75.113">       pMgr-&gt;FindServer(EmptyCString(), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.114"></a><span id="l75.114" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;nntp&quot;), getter_AddRefs(in));</span>
<a href="#l75.115"></a><span id="l75.115" class="difflineplus">+                       &quot;nntp&quot;_ns, getter_AddRefs(in));</span>
<a href="#l75.116"></a><span id="l75.116">   if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l75.117"></a><span id="l75.117">     // Create the incoming server and an account for it?</span>
<a href="#l75.118"></a><span id="l75.118" class="difflineminus">-    rv = pMgr-&gt;CreateIncomingServer(</span>
<a href="#l75.119"></a><span id="l75.119" class="difflineminus">-        nsDependentCString(&quot;&quot;), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.120"></a><span id="l75.120" class="difflineminus">-        NS_LITERAL_CSTRING(&quot;nntp&quot;), getter_AddRefs(in));</span>
<a href="#l75.121"></a><span id="l75.121" class="difflineplus">+    rv = pMgr-&gt;CreateIncomingServer(nsDependentCString(&quot;&quot;),</span>
<a href="#l75.122"></a><span id="l75.122" class="difflineplus">+                                    NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l75.123"></a><span id="l75.123" class="difflineplus">+                                    &quot;nntp&quot;_ns, getter_AddRefs(in));</span>
<a href="#l75.124"></a><span id="l75.124">     if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l75.125"></a><span id="l75.125">       nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer = do_QueryInterface(in);</span>
<a href="#l75.126"></a><span id="l75.126">       if (!nntpServer) {</span>
<a href="#l75.127"></a><span id="l75.127">         IMPORT_LOG1(&quot;*** Failed to create nsINnntpIncomingServer for %S!\n&quot;,</span>
<a href="#l75.128"></a><span id="l75.128">                     serverName.get());</span>
<a href="#l75.129"></a><span id="l75.129">         return false;</span>
<a href="#l75.130"></a><span id="l75.130">       }</span>
<a href="#l75.131"></a><span id="l75.131">       if (!userName.IsEmpty()) {  // if username req'd then auth req'd</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMUtils.cpp</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMUtils.cpp</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -22,42 +22,41 @@</span>
<a href="#l76.4"></a><span id="l76.4"> </span>
<a href="#l76.5"></a><span id="l76.5"> nsresult nsWMUtils::FindWMKey(nsIWindowsRegKey** aKey) {</span>
<a href="#l76.6"></a><span id="l76.6">   nsresult rv;</span>
<a href="#l76.7"></a><span id="l76.7">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l76.8"></a><span id="l76.8">       do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l76.9"></a><span id="l76.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l76.10"></a><span id="l76.10"> </span>
<a href="#l76.11"></a><span id="l76.11">   rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-                 NS_LITERAL_STRING(&quot;Software\\Microsoft\\Windows Live Mail&quot;),</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+                 u&quot;Software\\Microsoft\\Windows Live Mail&quot;_ns),</span>
<a href="#l76.14"></a><span id="l76.14">                  nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l76.15"></a><span id="l76.15">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.16"></a><span id="l76.16">     key.forget(aKey);</span>
<a href="#l76.17"></a><span id="l76.17">     return rv;</span>
<a href="#l76.18"></a><span id="l76.18">   }</span>
<a href="#l76.19"></a><span id="l76.19"> </span>
<a href="#l76.20"></a><span id="l76.20">   rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l76.21"></a><span id="l76.21" class="difflineminus">-                 NS_LITERAL_STRING(&quot;Software\\Microsoft\\Windows Mail&quot;),</span>
<a href="#l76.22"></a><span id="l76.22" class="difflineplus">+                 u&quot;Software\\Microsoft\\Windows Mail&quot;_ns,</span>
<a href="#l76.23"></a><span id="l76.23">                  nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l76.24"></a><span id="l76.24">   key.forget(aKey);</span>
<a href="#l76.25"></a><span id="l76.25">   return rv;</span>
<a href="#l76.26"></a><span id="l76.26"> }</span>
<a href="#l76.27"></a><span id="l76.27"> </span>
<a href="#l76.28"></a><span id="l76.28"> nsresult nsWMUtils::GetRootFolder(nsIFile** aRootFolder) {</span>
<a href="#l76.29"></a><span id="l76.29">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l76.30"></a><span id="l76.30">   if (NS_FAILED(nsWMUtils::FindWMKey(getter_AddRefs(key)))) {</span>
<a href="#l76.31"></a><span id="l76.31">     IMPORT_LOG0(&quot;*** Error finding Windows Live Mail registry account keys\n&quot;);</span>
<a href="#l76.32"></a><span id="l76.32">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l76.33"></a><span id="l76.33">   }</span>
<a href="#l76.34"></a><span id="l76.34">   // This is essential to proceed; it is the location on disk of xml-type</span>
<a href="#l76.35"></a><span id="l76.35">   // account files; it is in reg_expand_sz so it will need expanding to absolute</span>
<a href="#l76.36"></a><span id="l76.36">   // path.</span>
<a href="#l76.37"></a><span id="l76.37">   nsString storeRoot;</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineminus">-  nsresult rv =</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-      key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Store Root&quot;), storeRoot);</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+  nsresult rv = key-&gt;ReadStringValue(u&quot;Store Root&quot;_ns, storeRoot);</span>
<a href="#l76.41"></a><span id="l76.41">   key-&gt;Close();  // Finished with windows registry key. We do not want to return</span>
<a href="#l76.42"></a><span id="l76.42">                  // before this closing</span>
<a href="#l76.43"></a><span id="l76.43">   if (NS_FAILED(rv) || storeRoot.IsEmpty()) {</span>
<a href="#l76.44"></a><span id="l76.44">     IMPORT_LOG0(&quot;*** Error finding Windows Live Mail Store Root\n&quot;);</span>
<a href="#l76.45"></a><span id="l76.45">     return rv;</span>
<a href="#l76.46"></a><span id="l76.46">   }</span>
<a href="#l76.47"></a><span id="l76.47"> </span>
<a href="#l76.48"></a><span id="l76.48">   uint32_t size =</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineat">@@ -107,18 +106,17 @@ nsresult nsWMUtils::GetOEAccountFilesInF</span>
<a href="#l76.50"></a><span id="l76.50">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l76.51"></a><span id="l76.51"> </span>
<a href="#l76.52"></a><span id="l76.52">     if (isDirectory) {</span>
<a href="#l76.53"></a><span id="l76.53">       GetOEAccountFilesInFolder(file, aFileArray);</span>
<a href="#l76.54"></a><span id="l76.54">     } else {</span>
<a href="#l76.55"></a><span id="l76.55">       nsString name;</span>
<a href="#l76.56"></a><span id="l76.56">       rv = file-&gt;GetLeafName(name);</span>
<a href="#l76.57"></a><span id="l76.57">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l76.58"></a><span id="l76.58" class="difflineminus">-      if (StringEndsWith(name, NS_LITERAL_STRING(&quot;.oeaccount&quot;)))</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineminus">-        aFileArray.AppendObject(file);</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+      if (StringEndsWith(name, u&quot;.oeaccount&quot;_ns)) aFileArray.AppendObject(file);</span>
<a href="#l76.61"></a><span id="l76.61">     }</span>
<a href="#l76.62"></a><span id="l76.62">   }</span>
<a href="#l76.63"></a><span id="l76.63">   return NS_OK;</span>
<a href="#l76.64"></a><span id="l76.64"> }</span>
<a href="#l76.65"></a><span id="l76.65"> </span>
<a href="#l76.66"></a><span id="l76.66"> nsresult nsWMUtils::MakeXMLdoc(mozilla::dom::Document** aXmlDoc,</span>
<a href="#l76.67"></a><span id="l76.67">                                nsIFile* aFile) {</span>
<a href="#l76.68"></a><span id="l76.68">   nsresult rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/mailnews/intl/nsCharsetConverterManager.cpp</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/mailnews/intl/nsCharsetConverterManager.cpp</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -120,18 +120,17 @@ nsCharsetConverterManager::GetCharsetTit</span>
<a href="#l77.4"></a><span id="l77.4"> </span>
<a href="#l77.5"></a><span id="l77.5">   if (!sTitleBundle) {</span>
<a href="#l77.6"></a><span id="l77.6">     nsresult rv =</span>
<a href="#l77.7"></a><span id="l77.7">         LoadBundle(&quot;chrome://messenger/locale/charsetTitles.properties&quot;,</span>
<a href="#l77.8"></a><span id="l77.8">                    getter_AddRefs(sTitleBundle));</span>
<a href="#l77.9"></a><span id="l77.9">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.10"></a><span id="l77.10">   }</span>
<a href="#l77.11"></a><span id="l77.11"> </span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-  return GetBundleValue(sTitleBundle, aCharset, NS_LITERAL_STRING(&quot;.title&quot;),</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-                        aResult);</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+  return GetBundleValue(sTitleBundle, aCharset, u&quot;.title&quot;_ns, aResult);</span>
<a href="#l77.15"></a><span id="l77.15"> }</span>
<a href="#l77.16"></a><span id="l77.16"> </span>
<a href="#l77.17"></a><span id="l77.17"> NS_IMETHODIMP</span>
<a href="#l77.18"></a><span id="l77.18"> nsCharsetConverterManager::GetCharsetData(const char* aCharset,</span>
<a href="#l77.19"></a><span id="l77.19">                                           const char16_t* aProp,</span>
<a href="#l77.20"></a><span id="l77.20">                                           nsAString&amp; aResult) {</span>
<a href="#l77.21"></a><span id="l77.21">   return GetCharsetDataImpl(aCharset, aProp, aResult);</span>
<a href="#l77.22"></a><span id="l77.22"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/mailnews/jsaccount/src/JaUrl.cpp</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/mailnews/jsaccount/src/JaUrl.cpp</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -105,17 +105,17 @@ NS_IMETHODIMP JaBaseCppUrl::GetNormalize</span>
<a href="#l78.4"></a><span id="l78.4">   nsAutoCString spec;</span>
<a href="#l78.5"></a><span id="l78.5">   mailnewsURL-&gt;GetSpecIgnoringRef(spec);</span>
<a href="#l78.6"></a><span id="l78.6"> </span>
<a href="#l78.7"></a><span id="l78.7">   nsCString queryPart = MsgExtractQueryPart(spec, &quot;number=&quot;);</span>
<a href="#l78.8"></a><span id="l78.8"> </span>
<a href="#l78.9"></a><span id="l78.9">   // Strip any query part beginning with ? or /;</span>
<a href="#l78.10"></a><span id="l78.10">   MsgRemoveQueryPart(spec);</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-  if (!queryPart.IsEmpty()) spec += NS_LITERAL_CSTRING(&quot;?&quot;) + queryPart;</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+  if (!queryPart.IsEmpty()) spec += &quot;?&quot;_ns + queryPart;</span>
<a href="#l78.14"></a><span id="l78.14"> </span>
<a href="#l78.15"></a><span id="l78.15">   aPrincipalSpec.Assign(spec);</span>
<a href="#l78.16"></a><span id="l78.16">   return NS_OK;</span>
<a href="#l78.17"></a><span id="l78.17"> }</span>
<a href="#l78.18"></a><span id="l78.18"> </span>
<a href="#l78.19"></a><span id="l78.19"> NS_IMETHODIMP JaBaseCppUrl::GetMessageHeader(nsIMsgDBHdr** aMessageHeader) {</span>
<a href="#l78.20"></a><span id="l78.20">   // This routine does a lookup using messenger, assuming that the message URI</span>
<a href="#l78.21"></a><span id="l78.21">   // has been set in mUri.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -561,17 +561,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Empt</span>
<a href="#l79.4"></a><span id="l79.4">     }</span>
<a href="#l79.5"></a><span id="l79.5">     nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l79.6"></a><span id="l79.6">     rv = trashFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l79.7"></a><span id="l79.7">     if (NS_SUCCEEDED(rv) &amp;&amp; parentFolder) {</span>
<a href="#l79.8"></a><span id="l79.8">       nsCOMPtr&lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l79.9"></a><span id="l79.9">       trashFolder-&gt;GetDBTransferInfo(getter_AddRefs(transferInfo));</span>
<a href="#l79.10"></a><span id="l79.10">       trashFolder-&gt;SetParent(nullptr);</span>
<a href="#l79.11"></a><span id="l79.11">       parentFolder-&gt;PropagateDelete(trashFolder, true, msgWindow);</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-      parentFolder-&gt;CreateSubfolder(NS_LITERAL_STRING(&quot;Trash&quot;), nullptr);</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+      parentFolder-&gt;CreateSubfolder(u&quot;Trash&quot;_ns, nullptr);</span>
<a href="#l79.14"></a><span id="l79.14">       nsCOMPtr&lt;nsIMsgFolder&gt; newTrashFolder;</span>
<a href="#l79.15"></a><span id="l79.15">       rv = GetTrashFolder(getter_AddRefs(newTrashFolder));</span>
<a href="#l79.16"></a><span id="l79.16">       if (NS_SUCCEEDED(rv) &amp;&amp; newTrashFolder) {</span>
<a href="#l79.17"></a><span id="l79.17">         nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localTrash =</span>
<a href="#l79.18"></a><span id="l79.18">             do_QueryInterface(newTrashFolder);</span>
<a href="#l79.19"></a><span id="l79.19">         newTrashFolder-&gt;SetDBTransferInfo(transferInfo);</span>
<a href="#l79.20"></a><span id="l79.20">         if (localTrash) localTrash-&gt;RefreshSizeOnDisk();</span>
<a href="#l79.21"></a><span id="l79.21">         // update the summary totals so the front end will</span>
<a href="#l79.22"></a><span id="l79.22" class="difflineat">@@ -2042,26 +2042,26 @@ void nsMsgLocalMailFolder::CopyPropertie</span>
<a href="#l79.23"></a><span id="l79.23"> void nsMsgLocalMailFolder::CopyHdrPropertiesWithSkipList(</span>
<a href="#l79.24"></a><span id="l79.24">     nsIMsgDBHdr* destHdr, nsIMsgDBHdr* srcHdr, const nsCString&amp; skipList) {</span>
<a href="#l79.25"></a><span id="l79.25">   nsCOMPtr&lt;nsIUTF8StringEnumerator&gt; propertyEnumerator;</span>
<a href="#l79.26"></a><span id="l79.26">   nsresult rv =</span>
<a href="#l79.27"></a><span id="l79.27">       srcHdr-&gt;GetPropertyEnumerator(getter_AddRefs(propertyEnumerator));</span>
<a href="#l79.28"></a><span id="l79.28">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l79.29"></a><span id="l79.29"> </span>
<a href="#l79.30"></a><span id="l79.30">   // We'll add spaces at beginning and end so we can search for space-name-space</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineminus">-  nsCString dontPreserveEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+  nsCString dontPreserveEx(&quot; &quot;_ns);</span>
<a href="#l79.33"></a><span id="l79.33">   dontPreserveEx.Append(skipList);</span>
<a href="#l79.34"></a><span id="l79.34">   dontPreserveEx.Append(' ');</span>
<a href="#l79.35"></a><span id="l79.35"> </span>
<a href="#l79.36"></a><span id="l79.36">   nsAutoCString property;</span>
<a href="#l79.37"></a><span id="l79.37">   nsCString sourceString;</span>
<a href="#l79.38"></a><span id="l79.38">   bool hasMore;</span>
<a href="#l79.39"></a><span id="l79.39">   while (NS_SUCCEEDED(propertyEnumerator-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l79.40"></a><span id="l79.40">     propertyEnumerator-&gt;GetNext(property);</span>
<a href="#l79.41"></a><span id="l79.41" class="difflineminus">-    nsAutoCString propertyEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l79.42"></a><span id="l79.42" class="difflineplus">+    nsAutoCString propertyEx(&quot; &quot;_ns);</span>
<a href="#l79.43"></a><span id="l79.43">     propertyEx.Append(property);</span>
<a href="#l79.44"></a><span id="l79.44">     propertyEx.Append(' ');</span>
<a href="#l79.45"></a><span id="l79.45">     if (dontPreserveEx.Find(propertyEx) != -1)  // -1 is not found</span>
<a href="#l79.46"></a><span id="l79.46">       continue;</span>
<a href="#l79.47"></a><span id="l79.47"> </span>
<a href="#l79.48"></a><span id="l79.48">     srcHdr-&gt;GetStringProperty(property.get(), getter_Copies(sourceString));</span>
<a href="#l79.49"></a><span id="l79.49">     destHdr-&gt;SetStringProperty(property.get(), sourceString.get());</span>
<a href="#l79.50"></a><span id="l79.50">   }</span>
<a href="#l79.51"></a><span id="l79.51" class="difflineat">@@ -2138,19 +2138,18 @@ nsMsgLocalMailFolder::EndCopy(bool aCopy</span>
<a href="#l79.52"></a><span id="l79.52">   // Copy the header to the new database</span>
<a href="#l79.53"></a><span id="l79.53">   if (mCopyState-&gt;m_message) {</span>
<a href="#l79.54"></a><span id="l79.54">     //  CopyMessages() goes here, and CopyFileMessages() with metadata to save;</span>
<a href="#l79.55"></a><span id="l79.55">     nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l79.56"></a><span id="l79.56">     if (!mCopyState-&gt;m_parseMsgState) {</span>
<a href="#l79.57"></a><span id="l79.57">       if (mCopyState-&gt;m_destDB) {</span>
<a href="#l79.58"></a><span id="l79.58">         if (mCopyState-&gt;m_newHdr) {</span>
<a href="#l79.59"></a><span id="l79.59">           newHdr = mCopyState-&gt;m_newHdr;</span>
<a href="#l79.60"></a><span id="l79.60" class="difflineminus">-          CopyHdrPropertiesWithSkipList(</span>
<a href="#l79.61"></a><span id="l79.61" class="difflineminus">-              newHdr, mCopyState-&gt;m_message,</span>
<a href="#l79.62"></a><span id="l79.62" class="difflineminus">-              NS_LITERAL_CSTRING(&quot;storeToken msgOffset&quot;));</span>
<a href="#l79.63"></a><span id="l79.63" class="difflineplus">+          CopyHdrPropertiesWithSkipList(newHdr, mCopyState-&gt;m_message,</span>
<a href="#l79.64"></a><span id="l79.64" class="difflineplus">+                                        &quot;storeToken msgOffset&quot;_ns);</span>
<a href="#l79.65"></a><span id="l79.65">           //          UpdateNewMsgHdr(mCopyState-&gt;m_message, newHdr);</span>
<a href="#l79.66"></a><span id="l79.66">           // We need to copy more than just what UpdateNewMsgHdr does. In fact,</span>
<a href="#l79.67"></a><span id="l79.67">           // I think we want to copy almost every property other than</span>
<a href="#l79.68"></a><span id="l79.68">           // storeToken and msgOffset.</span>
<a href="#l79.69"></a><span id="l79.69">           mCopyState-&gt;m_destDB-&gt;AddNewHdrToDB(newHdr, true);</span>
<a href="#l79.70"></a><span id="l79.70">         } else {</span>
<a href="#l79.71"></a><span id="l79.71">           rv = mCopyState-&gt;m_destDB-&gt;CopyHdrFromExistingHdr(</span>
<a href="#l79.72"></a><span id="l79.72">               mCopyState-&gt;m_curDstKey, mCopyState-&gt;m_message, true,</span>
<a href="#l79.73"></a><span id="l79.73" class="difflineat">@@ -2827,45 +2826,40 @@ nsMsgLocalMailFolder::GetIncomingServerT</span>
<a href="#l79.74"></a><span id="l79.74">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l79.75"></a><span id="l79.75"> </span>
<a href="#l79.76"></a><span id="l79.76">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l79.77"></a><span id="l79.77">         do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l79.78"></a><span id="l79.78">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l79.79"></a><span id="l79.79"> </span>
<a href="#l79.80"></a><span id="l79.80">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l79.81"></a><span id="l79.81">     // try &quot;none&quot; first</span>
<a href="#l79.82"></a><span id="l79.82" class="difflineminus">-    rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;)).Finalize(url);</span>
<a href="#l79.83"></a><span id="l79.83" class="difflineplus">+    rv = NS_MutateURI(url).SetScheme(&quot;none&quot;_ns).Finalize(url);</span>
<a href="#l79.84"></a><span id="l79.84">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.85"></a><span id="l79.85">     rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l79.86"></a><span id="l79.86">     if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l79.87"></a><span id="l79.87">       mType.AssignLiteral(&quot;none&quot;);</span>
<a href="#l79.88"></a><span id="l79.88">     else {</span>
<a href="#l79.89"></a><span id="l79.89">       // next try &quot;pop3&quot;</span>
<a href="#l79.90"></a><span id="l79.90" class="difflineminus">-      rv =</span>
<a href="#l79.91"></a><span id="l79.91" class="difflineminus">-          NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;)).Finalize(url);</span>
<a href="#l79.92"></a><span id="l79.92" class="difflineplus">+      rv = NS_MutateURI(url).SetScheme(&quot;pop3&quot;_ns).Finalize(url);</span>
<a href="#l79.93"></a><span id="l79.93">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.94"></a><span id="l79.94">       rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l79.95"></a><span id="l79.95">       if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l79.96"></a><span id="l79.96">         mType.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l79.97"></a><span id="l79.97">       else {</span>
<a href="#l79.98"></a><span id="l79.98">         // next try &quot;rss&quot;</span>
<a href="#l79.99"></a><span id="l79.99" class="difflineminus">-        rv = NS_MutateURI(url)</span>
<a href="#l79.100"></a><span id="l79.100" class="difflineminus">-                 .SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;))</span>
<a href="#l79.101"></a><span id="l79.101" class="difflineminus">-                 .Finalize(url);</span>
<a href="#l79.102"></a><span id="l79.102" class="difflineplus">+        rv = NS_MutateURI(url).SetScheme(&quot;rss&quot;_ns).Finalize(url);</span>
<a href="#l79.103"></a><span id="l79.103">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.104"></a><span id="l79.104">         rv =</span>
<a href="#l79.105"></a><span id="l79.105">             accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l79.106"></a><span id="l79.106">         if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l79.107"></a><span id="l79.107">           mType.AssignLiteral(&quot;rss&quot;);</span>
<a href="#l79.108"></a><span id="l79.108">         else {</span>
<a href="#l79.109"></a><span id="l79.109"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l79.110"></a><span id="l79.110">           // next try &quot;movemail&quot;</span>
<a href="#l79.111"></a><span id="l79.111" class="difflineminus">-          rv = NS_MutateURI(url)</span>
<a href="#l79.112"></a><span id="l79.112" class="difflineminus">-                   .SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;))</span>
<a href="#l79.113"></a><span id="l79.113" class="difflineminus">-                   .Finalize(url);</span>
<a href="#l79.114"></a><span id="l79.114" class="difflineplus">+          rv = NS_MutateURI(url).SetScheme(&quot;movemail&quot;_ns).Finalize(url);</span>
<a href="#l79.115"></a><span id="l79.115">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.116"></a><span id="l79.116">           rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l79.117"></a><span id="l79.117">                                                getter_AddRefs(server));</span>
<a href="#l79.118"></a><span id="l79.118">           if (NS_SUCCEEDED(rv) &amp;&amp; server) mType.AssignLiteral(&quot;movemail&quot;);</span>
<a href="#l79.119"></a><span id="l79.119"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l79.120"></a><span id="l79.120">         }</span>
<a href="#l79.121"></a><span id="l79.121">       }</span>
<a href="#l79.122"></a><span id="l79.122">     }</span>
<a href="#l79.123"></a><span id="l79.123" class="difflineat">@@ -3053,40 +3047,38 @@ nsresult nsMsgLocalMailFolder::DisplayMo</span>
<a href="#l79.124"></a><span id="l79.124">     }</span>
<a href="#l79.125"></a><span id="l79.125">   }</span>
<a href="#l79.126"></a><span id="l79.126">   return rv;</span>
<a href="#l79.127"></a><span id="l79.127"> }</span>
<a href="#l79.128"></a><span id="l79.128"> </span>
<a href="#l79.129"></a><span id="l79.129"> NS_IMETHODIMP</span>
<a href="#l79.130"></a><span id="l79.130"> nsMsgLocalMailFolder::SetFlagsOnDefaultMailboxes(uint32_t flags) {</span>
<a href="#l79.131"></a><span id="l79.131">   if (flags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l79.132"></a><span id="l79.132" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Inbox&quot;), nsMsgFolderFlags::Inbox);</span>
<a href="#l79.133"></a><span id="l79.133" class="difflineplus">+    setSubfolderFlag(u&quot;Inbox&quot;_ns, nsMsgFolderFlags::Inbox);</span>
<a href="#l79.134"></a><span id="l79.134"> </span>
<a href="#l79.135"></a><span id="l79.135">   if (flags &amp; nsMsgFolderFlags::SentMail)</span>
<a href="#l79.136"></a><span id="l79.136" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Sent&quot;), nsMsgFolderFlags::SentMail);</span>
<a href="#l79.137"></a><span id="l79.137" class="difflineplus">+    setSubfolderFlag(u&quot;Sent&quot;_ns, nsMsgFolderFlags::SentMail);</span>
<a href="#l79.138"></a><span id="l79.138"> </span>
<a href="#l79.139"></a><span id="l79.139">   if (flags &amp; nsMsgFolderFlags::Drafts)</span>
<a href="#l79.140"></a><span id="l79.140" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Drafts&quot;), nsMsgFolderFlags::Drafts);</span>
<a href="#l79.141"></a><span id="l79.141" class="difflineplus">+    setSubfolderFlag(u&quot;Drafts&quot;_ns, nsMsgFolderFlags::Drafts);</span>
<a href="#l79.142"></a><span id="l79.142"> </span>
<a href="#l79.143"></a><span id="l79.143">   if (flags &amp; nsMsgFolderFlags::Templates)</span>
<a href="#l79.144"></a><span id="l79.144" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Templates&quot;),</span>
<a href="#l79.145"></a><span id="l79.145" class="difflineminus">-                     nsMsgFolderFlags::Templates);</span>
<a href="#l79.146"></a><span id="l79.146" class="difflineplus">+    setSubfolderFlag(u&quot;Templates&quot;_ns, nsMsgFolderFlags::Templates);</span>
<a href="#l79.147"></a><span id="l79.147"> </span>
<a href="#l79.148"></a><span id="l79.148">   if (flags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l79.149"></a><span id="l79.149" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Trash&quot;), nsMsgFolderFlags::Trash);</span>
<a href="#l79.150"></a><span id="l79.150" class="difflineplus">+    setSubfolderFlag(u&quot;Trash&quot;_ns, nsMsgFolderFlags::Trash);</span>
<a href="#l79.151"></a><span id="l79.151"> </span>
<a href="#l79.152"></a><span id="l79.152">   if (flags &amp; nsMsgFolderFlags::Queue)</span>
<a href="#l79.153"></a><span id="l79.153" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Unsent Messages&quot;),</span>
<a href="#l79.154"></a><span id="l79.154" class="difflineminus">-                     nsMsgFolderFlags::Queue);</span>
<a href="#l79.155"></a><span id="l79.155" class="difflineplus">+    setSubfolderFlag(u&quot;Unsent Messages&quot;_ns, nsMsgFolderFlags::Queue);</span>
<a href="#l79.156"></a><span id="l79.156"> </span>
<a href="#l79.157"></a><span id="l79.157">   if (flags &amp; nsMsgFolderFlags::Junk)</span>
<a href="#l79.158"></a><span id="l79.158" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Junk&quot;), nsMsgFolderFlags::Junk);</span>
<a href="#l79.159"></a><span id="l79.159" class="difflineplus">+    setSubfolderFlag(u&quot;Junk&quot;_ns, nsMsgFolderFlags::Junk);</span>
<a href="#l79.160"></a><span id="l79.160"> </span>
<a href="#l79.161"></a><span id="l79.161">   if (flags &amp; nsMsgFolderFlags::Archive)</span>
<a href="#l79.162"></a><span id="l79.162" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Archives&quot;), nsMsgFolderFlags::Archive);</span>
<a href="#l79.163"></a><span id="l79.163" class="difflineplus">+    setSubfolderFlag(u&quot;Archives&quot;_ns, nsMsgFolderFlags::Archive);</span>
<a href="#l79.164"></a><span id="l79.164"> </span>
<a href="#l79.165"></a><span id="l79.165">   return NS_OK;</span>
<a href="#l79.166"></a><span id="l79.166"> }</span>
<a href="#l79.167"></a><span id="l79.167"> </span>
<a href="#l79.168"></a><span id="l79.168"> nsresult nsMsgLocalMailFolder::setSubfolderFlag(const nsAString&amp; aFolderName,</span>
<a href="#l79.169"></a><span id="l79.169">                                                 uint32_t flags) {</span>
<a href="#l79.170"></a><span id="l79.170">   // FindSubFolder() expects the folder name to be escaped</span>
<a href="#l79.171"></a><span id="l79.171">   // see bug #192043</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUtils.cpp</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUtils.cpp</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -34,61 +34,59 @@ static nsresult nsGetMailboxServer(const</span>
<a href="#l80.4"></a><span id="l80.4"> </span>
<a href="#l80.5"></a><span id="l80.5">   // retrieve the AccountManager</span>
<a href="#l80.6"></a><span id="l80.6">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l80.7"></a><span id="l80.7">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l80.8"></a><span id="l80.8">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l80.9"></a><span id="l80.9"> </span>
<a href="#l80.10"></a><span id="l80.10">   // find all local mail &quot;no servers&quot; matching the given hostname</span>
<a href="#l80.11"></a><span id="l80.11">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; none_server;</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-  rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;)).Finalize(url);</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+  rv = NS_MutateURI(url).SetScheme(&quot;none&quot;_ns).Finalize(url);</span>
<a href="#l80.14"></a><span id="l80.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l80.15"></a><span id="l80.15">   // No unescaping of username or hostname done here.</span>
<a href="#l80.16"></a><span id="l80.16">   // The unescaping is done inside of FindServerByURI</span>
<a href="#l80.17"></a><span id="l80.17">   rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(none_server));</span>
<a href="#l80.18"></a><span id="l80.18">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l80.19"></a><span id="l80.19">     none_server.forget(aResult);</span>
<a href="#l80.20"></a><span id="l80.20">     return rv;</span>
<a href="#l80.21"></a><span id="l80.21">   }</span>
<a href="#l80.22"></a><span id="l80.22"> </span>
<a href="#l80.23"></a><span id="l80.23">   // if that fails, look for the rss hosts matching the given hostname</span>
<a href="#l80.24"></a><span id="l80.24">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; rss_server;</span>
<a href="#l80.25"></a><span id="l80.25" class="difflineminus">-  rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;)).Finalize(url);</span>
<a href="#l80.26"></a><span id="l80.26" class="difflineplus">+  rv = NS_MutateURI(url).SetScheme(&quot;rss&quot;_ns).Finalize(url);</span>
<a href="#l80.27"></a><span id="l80.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l80.28"></a><span id="l80.28">   rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(rss_server));</span>
<a href="#l80.29"></a><span id="l80.29">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l80.30"></a><span id="l80.30">     rss_server.forget(aResult);</span>
<a href="#l80.31"></a><span id="l80.31">     return rv;</span>
<a href="#l80.32"></a><span id="l80.32">   }</span>
<a href="#l80.33"></a><span id="l80.33"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l80.34"></a><span id="l80.34">   // find all movemail &quot;servers&quot; matching the given hostname</span>
<a href="#l80.35"></a><span id="l80.35">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; movemail_server;</span>
<a href="#l80.36"></a><span id="l80.36" class="difflineminus">-  rv =</span>
<a href="#l80.37"></a><span id="l80.37" class="difflineminus">-      NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;)).Finalize(url);</span>
<a href="#l80.38"></a><span id="l80.38" class="difflineplus">+  rv = NS_MutateURI(url).SetScheme(&quot;movemail&quot;_ns).Finalize(url);</span>
<a href="#l80.39"></a><span id="l80.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l80.40"></a><span id="l80.40">   rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l80.41"></a><span id="l80.41">                                        getter_AddRefs(movemail_server));</span>
<a href="#l80.42"></a><span id="l80.42">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l80.43"></a><span id="l80.43">     movemail_server.forget(aResult);</span>
<a href="#l80.44"></a><span id="l80.44">     return rv;</span>
<a href="#l80.45"></a><span id="l80.45">   }</span>
<a href="#l80.46"></a><span id="l80.46"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l80.47"></a><span id="l80.47"> </span>
<a href="#l80.48"></a><span id="l80.48">   // if that fails, look for the pop hosts matching the given hostname</span>
<a href="#l80.49"></a><span id="l80.49">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l80.50"></a><span id="l80.50">   if (NS_FAILED(rv)) {</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineminus">-    rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;)).Finalize(url);</span>
<a href="#l80.52"></a><span id="l80.52" class="difflineplus">+    rv = NS_MutateURI(url).SetScheme(&quot;pop3&quot;_ns).Finalize(url);</span>
<a href="#l80.53"></a><span id="l80.53">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l80.54"></a><span id="l80.54">     rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l80.55"></a><span id="l80.55"> </span>
<a href="#l80.56"></a><span id="l80.56">     // if we can't find a pop server, maybe it's a local message</span>
<a href="#l80.57"></a><span id="l80.57">     // in an imap hierarchy. look for an imap server.</span>
<a href="#l80.58"></a><span id="l80.58">     if (NS_FAILED(rv)) {</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineminus">-      rv =</span>
<a href="#l80.60"></a><span id="l80.60" class="difflineminus">-          NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;imap&quot;)).Finalize(url);</span>
<a href="#l80.61"></a><span id="l80.61" class="difflineplus">+      rv = NS_MutateURI(url).SetScheme(&quot;imap&quot;_ns).Finalize(url);</span>
<a href="#l80.62"></a><span id="l80.62">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l80.63"></a><span id="l80.63">       rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l80.64"></a><span id="l80.64">     }</span>
<a href="#l80.65"></a><span id="l80.65">   }</span>
<a href="#l80.66"></a><span id="l80.66">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l80.67"></a><span id="l80.67">     server.forget(aResult);</span>
<a href="#l80.68"></a><span id="l80.68">     return rv;</span>
<a href="#l80.69"></a><span id="l80.69">   }</span>
<a href="#l80.70"></a><span id="l80.70" class="difflineat">@@ -150,20 +148,19 @@ nsresult nsLocalURI2Path(const char* roo</span>
<a href="#l80.71"></a><span id="l80.71"> </span>
<a href="#l80.72"></a><span id="l80.72">     nsAutoCString newPath(&quot;&quot;);</span>
<a href="#l80.73"></a><span id="l80.73"> </span>
<a href="#l80.74"></a><span id="l80.74">     // Unescape folder name</span>
<a href="#l80.75"></a><span id="l80.75">     if (curPos) {</span>
<a href="#l80.76"></a><span id="l80.76">       nsCString unescapedStr;</span>
<a href="#l80.77"></a><span id="l80.77">       MsgUnescapeString(nsDependentCString(curPos), 0, unescapedStr);</span>
<a href="#l80.78"></a><span id="l80.78">       NS_MsgCreatePathStringFromFolderURI(unescapedStr.get(), newPath,</span>
<a href="#l80.79"></a><span id="l80.79" class="difflineminus">-                                          NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l80.80"></a><span id="l80.80" class="difflineplus">+                                          &quot;none&quot;_ns);</span>
<a href="#l80.81"></a><span id="l80.81">     } else</span>
<a href="#l80.82"></a><span id="l80.82" class="difflineminus">-      NS_MsgCreatePathStringFromFolderURI(curPos, newPath,</span>
<a href="#l80.83"></a><span id="l80.83" class="difflineminus">-                                          NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l80.84"></a><span id="l80.84" class="difflineplus">+      NS_MsgCreatePathStringFromFolderURI(curPos, newPath, &quot;none&quot;_ns);</span>
<a href="#l80.85"></a><span id="l80.85"> </span>
<a href="#l80.86"></a><span id="l80.86">     pathResult.Append('/');</span>
<a href="#l80.87"></a><span id="l80.87">     pathResult.Append(newPath);</span>
<a href="#l80.88"></a><span id="l80.88">   }</span>
<a href="#l80.89"></a><span id="l80.89"> </span>
<a href="#l80.90"></a><span id="l80.90">   return NS_OK;</span>
<a href="#l80.91"></a><span id="l80.91"> }</span>
<a href="#l80.92"></a><span id="l80.92"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -153,17 +153,17 @@ nsresult nsMailboxService::FetchMessage(</span>
<a href="#l81.4"></a><span id="l81.4">     rv = NS_NewURI(getter_AddRefs(fileUri), aMessageURI);</span>
<a href="#l81.5"></a><span id="l81.5">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l81.6"></a><span id="l81.6">     nsCOMPtr&lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l81.7"></a><span id="l81.7">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l81.8"></a><span id="l81.8">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l81.9"></a><span id="l81.9">     rv = fileUrl-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l81.10"></a><span id="l81.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l81.11"></a><span id="l81.11">     file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-    uriString.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+    uriString.Replace(0, 5, &quot;mailbox:&quot;_ns);</span>
<a href="#l81.14"></a><span id="l81.14">     uriString.AppendLiteral(&quot;&amp;number=0&quot;);</span>
<a href="#l81.15"></a><span id="l81.15">     rv = NS_NewURI(getter_AddRefs(url), uriString);</span>
<a href="#l81.16"></a><span id="l81.16">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l81.17"></a><span id="l81.17"> </span>
<a href="#l81.18"></a><span id="l81.18">     msgUrl = do_QueryInterface(url);</span>
<a href="#l81.19"></a><span id="l81.19">     if (msgUrl) {</span>
<a href="#l81.20"></a><span id="l81.20">       msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l81.21"></a><span id="l81.21">       nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(msgUrl, &amp;rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxUrl.cpp</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxUrl.cpp</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -133,22 +133,22 @@ NS_IMETHODIMP nsMailboxUrl::GetNormalize</span>
<a href="#l82.4"></a><span id="l82.4">     nsCString folderPath;</span>
<a href="#l82.5"></a><span id="l82.5">     nsresult rv = nsLocalURI2Path(kMailboxRootURI, spec.get(), folderPath);</span>
<a href="#l82.6"></a><span id="l82.6">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l82.7"></a><span id="l82.7">       nsAutoCString buf;</span>
<a href="#l82.8"></a><span id="l82.8">       MsgEscapeURL(</span>
<a href="#l82.9"></a><span id="l82.9">           folderPath,</span>
<a href="#l82.10"></a><span id="l82.10">           nsINetUtil::ESCAPE_URL_DIRECTORY | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l82.11"></a><span id="l82.11">           buf);</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-      spec = NS_LITERAL_CSTRING(&quot;mailbox://&quot;) + buf;</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+      spec = &quot;mailbox://&quot;_ns + buf;</span>
<a href="#l82.14"></a><span id="l82.14">     }</span>
<a href="#l82.15"></a><span id="l82.15">   }</span>
<a href="#l82.16"></a><span id="l82.16"> </span>
<a href="#l82.17"></a><span id="l82.17">   if (messageKey) {</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineminus">-    spec += NS_LITERAL_CSTRING(&quot;?number=&quot;);</span>
<a href="#l82.19"></a><span id="l82.19" class="difflineplus">+    spec += &quot;?number=&quot;_ns;</span>
<a href="#l82.20"></a><span id="l82.20">     spec.Append(messageKey);</span>
<a href="#l82.21"></a><span id="l82.21">     PR_Free(messageKey);</span>
<a href="#l82.22"></a><span id="l82.22">   }</span>
<a href="#l82.23"></a><span id="l82.23"> </span>
<a href="#l82.24"></a><span id="l82.24">   aPrincipalSpec.Assign(spec);</span>
<a href="#l82.25"></a><span id="l82.25">   return NS_OK;</span>
<a href="#l82.26"></a><span id="l82.26"> }</span>
<a href="#l82.27"></a><span id="l82.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailIncomingServer.cpp</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailIncomingServer.cpp</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -83,20 +83,20 @@ nsMovemailIncomingServer::SetFlagsOnDefa</span>
<a href="#l83.4"></a><span id="l83.4">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l83.5"></a><span id="l83.5">       do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l83.6"></a><span id="l83.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l83.7"></a><span id="l83.7"> </span>
<a href="#l83.8"></a><span id="l83.8">   return localFolder-&gt;SetFlagsOnDefaultMailboxes(nsMsgFolderFlags::SpecialUse);</span>
<a href="#l83.9"></a><span id="l83.9"> }</span>
<a href="#l83.10"></a><span id="l83.10"> </span>
<a href="#l83.11"></a><span id="l83.11"> NS_IMETHODIMP nsMovemailIncomingServer::CreateDefaultMailboxes() {</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-  nsresult rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+  nsresult rv = CreateLocalFolder(u&quot;Inbox&quot;_ns);</span>
<a href="#l83.14"></a><span id="l83.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l83.15"></a><span id="l83.15"> </span>
<a href="#l83.16"></a><span id="l83.16" class="difflineminus">-  return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l83.17"></a><span id="l83.17" class="difflineplus">+  return CreateLocalFolder(u&quot;Trash&quot;_ns);</span>
<a href="#l83.18"></a><span id="l83.18"> }</span>
<a href="#l83.19"></a><span id="l83.19"> </span>
<a href="#l83.20"></a><span id="l83.20"> NS_IMETHODIMP</span>
<a href="#l83.21"></a><span id="l83.21"> nsMovemailIncomingServer::GetNewMail(nsIMsgWindow* aMsgWindow,</span>
<a href="#l83.22"></a><span id="l83.22">                                      nsIUrlListener* aUrlListener,</span>
<a href="#l83.23"></a><span id="l83.23">                                      nsIMsgFolder* aMsgFolder,</span>
<a href="#l83.24"></a><span id="l83.24">                                      nsIURI** aResult) {</span>
<a href="#l83.25"></a><span id="l83.25">   nsresult rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -431,17 +431,17 @@ nsresult nsMovemailService::GetNewMail(</span>
<a href="#l84.4"></a><span id="l84.4">     // If first string is empty and we're now at EOF then abort parsing.</span>
<a href="#l84.5"></a><span id="l84.5">     if (buffer.IsEmpty() &amp;&amp; !isMore &amp;&amp; !bytesWritten) {</span>
<a href="#l84.6"></a><span id="l84.6">       LOG((&quot;Empty spool file&quot;));</span>
<a href="#l84.7"></a><span id="l84.7">       break;</span>
<a href="#l84.8"></a><span id="l84.8">     }</span>
<a href="#l84.9"></a><span id="l84.9"> </span>
<a href="#l84.10"></a><span id="l84.10">     buffer.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l84.11"></a><span id="l84.11"> </span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-    if (isMore &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;From &quot;))) {</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+    if (isMore &amp;&amp; StringBeginsWith(buffer, &quot;From &quot;_ns)) {</span>
<a href="#l84.14"></a><span id="l84.14">       // Finish previous header and message, if any.</span>
<a href="#l84.15"></a><span id="l84.15">       if (newHdr) {</span>
<a href="#l84.16"></a><span id="l84.16">         outputStream-&gt;Flush();</span>
<a href="#l84.17"></a><span id="l84.17">         newMailParser-&gt;PublishMsgHeader(nullptr);</span>
<a href="#l84.18"></a><span id="l84.18">         rv = msgStore-&gt;FinishNewMessage(outputStream, newHdr);</span>
<a href="#l84.19"></a><span id="l84.19">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.20"></a><span id="l84.20">         newMailParser-&gt;Clear();</span>
<a href="#l84.21"></a><span id="l84.21">       }</span>
<a href="#l84.22"></a><span id="l84.22" class="difflineat">@@ -464,17 +464,17 @@ nsresult nsMovemailService::GetNewMail(</span>
<a href="#l84.23"></a><span id="l84.23">     }</span>
<a href="#l84.24"></a><span id="l84.24"> </span>
<a href="#l84.25"></a><span id="l84.25">     newMailParser-&gt;HandleLine(buffer.BeginWriting(), buffer.Length());</span>
<a href="#l84.26"></a><span id="l84.26">     rv = outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l84.27"></a><span id="l84.27">     NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; (bytesWritten == buffer.Length()),</span>
<a href="#l84.28"></a><span id="l84.28">                    NS_ERROR_FAILURE);</span>
<a href="#l84.29"></a><span id="l84.29"> </span>
<a href="#l84.30"></a><span id="l84.30">     // &quot;From &quot; lines delimit messages, start a new one here.</span>
<a href="#l84.31"></a><span id="l84.31" class="difflineminus">-    if (isMore &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;From &quot;))) {</span>
<a href="#l84.32"></a><span id="l84.32" class="difflineplus">+    if (isMore &amp;&amp; StringBeginsWith(buffer, &quot;From &quot;_ns)) {</span>
<a href="#l84.33"></a><span id="l84.33">       buffer.AssignLiteral(&quot;X-Mozilla-Status: 8000&quot; MSG_LINEBREAK);</span>
<a href="#l84.34"></a><span id="l84.34">       newMailParser-&gt;HandleLine(buffer.BeginWriting(), buffer.Length());</span>
<a href="#l84.35"></a><span id="l84.35">       rv = outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l84.36"></a><span id="l84.36">       NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; (bytesWritten == buffer.Length()),</span>
<a href="#l84.37"></a><span id="l84.37">                      NS_ERROR_FAILURE);</span>
<a href="#l84.38"></a><span id="l84.38"> </span>
<a href="#l84.39"></a><span id="l84.39">       buffer.AssignLiteral(&quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l84.40"></a><span id="l84.40">       newMailParser-&gt;HandleLine(buffer.BeginWriting(), buffer.Length());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/mailnews/local/src/nsMsgLocalStoreUtils.cpp</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgLocalStoreUtils.cpp</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -33,42 +33,42 @@ bool nsMsgLocalStoreUtils::nsShouldIgnor</span>
<a href="#l85.4"></a><span id="l85.4">       name.LowerCaseEqualsLiteral(&quot;rules.dat&quot;) ||</span>
<a href="#l85.5"></a><span id="l85.5">       name.LowerCaseEqualsLiteral(&quot;filterlog.html&quot;) ||</span>
<a href="#l85.6"></a><span id="l85.6">       name.LowerCaseEqualsLiteral(&quot;junklog.html&quot;) ||</span>
<a href="#l85.7"></a><span id="l85.7">       name.LowerCaseEqualsLiteral(&quot;rulesbackup.dat&quot;))</span>
<a href="#l85.8"></a><span id="l85.8">     return true;</span>
<a href="#l85.9"></a><span id="l85.9"> </span>
<a href="#l85.10"></a><span id="l85.10">   // don't add summary files to the list of folders;</span>
<a href="#l85.11"></a><span id="l85.11">   // don't add popstate files to the list either, or rules (sort.dat).</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-  if (StringEndsWith(name, NS_LITERAL_STRING(&quot;.snm&quot;)) ||</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+  if (StringEndsWith(name, u&quot;.snm&quot;_ns) ||</span>
<a href="#l85.14"></a><span id="l85.14">       name.LowerCaseEqualsLiteral(&quot;popstate.dat&quot;) ||</span>
<a href="#l85.15"></a><span id="l85.15">       name.LowerCaseEqualsLiteral(&quot;sort.dat&quot;) ||</span>
<a href="#l85.16"></a><span id="l85.16">       name.LowerCaseEqualsLiteral(&quot;mailfilt.log&quot;) ||</span>
<a href="#l85.17"></a><span id="l85.17">       name.LowerCaseEqualsLiteral(&quot;filters.js&quot;) ||</span>
<a href="#l85.18"></a><span id="l85.18" class="difflineminus">-      StringEndsWith(name, NS_LITERAL_STRING(&quot;.toc&quot;)))</span>
<a href="#l85.19"></a><span id="l85.19" class="difflineplus">+      StringEndsWith(name, u&quot;.toc&quot;_ns))</span>
<a href="#l85.20"></a><span id="l85.20">     return true;</span>
<a href="#l85.21"></a><span id="l85.21"> </span>
<a href="#l85.22"></a><span id="l85.22">   // ignore RSS data source files (see FeedUtils.jsm)</span>
<a href="#l85.23"></a><span id="l85.23">   if (name.LowerCaseEqualsLiteral(&quot;feeds.json&quot;) ||</span>
<a href="#l85.24"></a><span id="l85.24">       name.LowerCaseEqualsLiteral(&quot;feeditems.json&quot;) ||</span>
<a href="#l85.25"></a><span id="l85.25">       name.LowerCaseEqualsLiteral(&quot;feeds.rdf&quot;) ||</span>
<a href="#l85.26"></a><span id="l85.26">       name.LowerCaseEqualsLiteral(&quot;feeditems.rdf&quot;) ||</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineminus">-      StringBeginsWith(name, NS_LITERAL_STRING(&quot;feeditems_error&quot;)))</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineplus">+      StringBeginsWith(name, u&quot;feeditems_error&quot;_ns))</span>
<a href="#l85.29"></a><span id="l85.29">     return true;</span>
<a href="#l85.30"></a><span id="l85.30"> </span>
<a href="#l85.31"></a><span id="l85.31">   // Ignore hidden and other special system files.</span>
<a href="#l85.32"></a><span id="l85.32">   bool specialFile = false;</span>
<a href="#l85.33"></a><span id="l85.33">   path-&gt;IsHidden(&amp;specialFile);</span>
<a href="#l85.34"></a><span id="l85.34">   if (specialFile) return true;</span>
<a href="#l85.35"></a><span id="l85.35">   specialFile = false;</span>
<a href="#l85.36"></a><span id="l85.36">   path-&gt;IsSpecial(&amp;specialFile);</span>
<a href="#l85.37"></a><span id="l85.37">   if (specialFile) return true;</span>
<a href="#l85.38"></a><span id="l85.38"> </span>
<a href="#l85.39"></a><span id="l85.39">   // The .mozmsgs dir is for spotlight support</span>
<a href="#l85.40"></a><span id="l85.40" class="difflineminus">-  return (StringEndsWith(name, NS_LITERAL_STRING(&quot;.mozmsgs&quot;)) ||</span>
<a href="#l85.41"></a><span id="l85.41" class="difflineplus">+  return (StringEndsWith(name, u&quot;.mozmsgs&quot;_ns) ||</span>
<a href="#l85.42"></a><span id="l85.42">           StringEndsWith(name, NS_LITERAL_STRING(FOLDER_SUFFIX)) ||</span>
<a href="#l85.43"></a><span id="l85.43">           StringEndsWith(name, NS_LITERAL_STRING(SUMMARY_SUFFIX)));</span>
<a href="#l85.44"></a><span id="l85.44"> }</span>
<a href="#l85.45"></a><span id="l85.45"> </span>
<a href="#l85.46"></a><span id="l85.46"> /**</span>
<a href="#l85.47"></a><span id="l85.47">  * We're passed a stream positioned at the start of the message.</span>
<a href="#l85.48"></a><span id="l85.48">  * We start reading lines, looking for x-mozilla-keys: headers; If we're</span>
<a href="#l85.49"></a><span id="l85.49">  * adding the keyword and we find a header with the desired keyword already</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -165,24 +165,24 @@ nsresult nsMsgMaildirStore::CreateMaildi</span>
<a href="#l86.4"></a><span id="l86.4">   }</span>
<a href="#l86.5"></a><span id="l86.5"> </span>
<a href="#l86.6"></a><span id="l86.6">   // Create tmp, cur leaves</span>
<a href="#l86.7"></a><span id="l86.7">   nsCOMPtr&lt;nsIFile&gt; leaf(do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l86.8"></a><span id="l86.8">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.9"></a><span id="l86.9"> </span>
<a href="#l86.10"></a><span id="l86.10">   leaf-&gt;InitWithFile(path);</span>
<a href="#l86.11"></a><span id="l86.11"> </span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-  leaf-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;tmp&quot;));</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineplus">+  leaf-&gt;AppendNative(&quot;tmp&quot;_ns);</span>
<a href="#l86.14"></a><span id="l86.14">   rv = leaf-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l86.15"></a><span id="l86.15">   if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS) {</span>
<a href="#l86.16"></a><span id="l86.16">     NS_WARNING(&quot;Could not create tmp directory for message folder&quot;);</span>
<a href="#l86.17"></a><span id="l86.17">     return rv;</span>
<a href="#l86.18"></a><span id="l86.18">   }</span>
<a href="#l86.19"></a><span id="l86.19"> </span>
<a href="#l86.20"></a><span id="l86.20" class="difflineminus">-  leaf-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;cur&quot;));</span>
<a href="#l86.21"></a><span id="l86.21" class="difflineplus">+  leaf-&gt;SetNativeLeafName(&quot;cur&quot;_ns);</span>
<a href="#l86.22"></a><span id="l86.22">   rv = leaf-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l86.23"></a><span id="l86.23">   if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS) {</span>
<a href="#l86.24"></a><span id="l86.24">     NS_WARNING(&quot;Could not create cur directory for message folder&quot;);</span>
<a href="#l86.25"></a><span id="l86.25">     return rv;</span>
<a href="#l86.26"></a><span id="l86.26">   }</span>
<a href="#l86.27"></a><span id="l86.27"> </span>
<a href="#l86.28"></a><span id="l86.28">   return NS_OK;</span>
<a href="#l86.29"></a><span id="l86.29"> }</span>
<a href="#l86.30"></a><span id="l86.30" class="difflineat">@@ -283,17 +283,17 @@ NS_IMETHODIMP nsMsgMaildirStore::IsSumma</span>
<a href="#l86.31"></a><span id="l86.31">   nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l86.32"></a><span id="l86.32">   aDB-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l86.33"></a><span id="l86.33">   nsresult rv =</span>
<a href="#l86.34"></a><span id="l86.34">       dbFolderInfo-&gt;GetBooleanProperty(&quot;maildirValid&quot;, false, aResult);</span>
<a href="#l86.35"></a><span id="l86.35">   if (!*aResult) {</span>
<a href="#l86.36"></a><span id="l86.36">     nsCOMPtr&lt;nsIFile&gt; newFile;</span>
<a href="#l86.37"></a><span id="l86.37">     rv = aFolder-&gt;GetFilePath(getter_AddRefs(newFile));</span>
<a href="#l86.38"></a><span id="l86.38">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.39"></a><span id="l86.39" class="difflineminus">-    newFile-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.40"></a><span id="l86.40" class="difflineplus">+    newFile-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.41"></a><span id="l86.41"> </span>
<a href="#l86.42"></a><span id="l86.42">     // If the &quot;cur&quot; sub-dir doesn't exist, and there are no messages</span>
<a href="#l86.43"></a><span id="l86.43">     // in the db, then the folder is probably new and the db is valid.</span>
<a href="#l86.44"></a><span id="l86.44">     bool exists;</span>
<a href="#l86.45"></a><span id="l86.45">     newFile-&gt;Exists(&amp;exists);</span>
<a href="#l86.46"></a><span id="l86.46">     if (!exists) {</span>
<a href="#l86.47"></a><span id="l86.47">       int32_t numMessages;</span>
<a href="#l86.48"></a><span id="l86.48">       dbFolderInfo-&gt;GetNumMessages(&amp;numMessages);</span>
<a href="#l86.49"></a><span id="l86.49" class="difflineat">@@ -580,17 +580,17 @@ nsMsgMaildirStore::GetNewMsgOutputStream</span>
<a href="#l86.50"></a><span id="l86.50">   // With maildir, messages have whole file to themselves.</span>
<a href="#l86.51"></a><span id="l86.51">   (*aNewMsgHdr)-&gt;SetMessageOffset(0);</span>
<a href="#l86.52"></a><span id="l86.52"> </span>
<a href="#l86.53"></a><span id="l86.53">   // We're going to save the new message into the maildir 'tmp' folder.</span>
<a href="#l86.54"></a><span id="l86.54">   // When the message is completed, it can be moved to 'cur'.</span>
<a href="#l86.55"></a><span id="l86.55">   nsCOMPtr&lt;nsIFile&gt; newFile;</span>
<a href="#l86.56"></a><span id="l86.56">   rv = aFolder-&gt;GetFilePath(getter_AddRefs(newFile));</span>
<a href="#l86.57"></a><span id="l86.57">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.58"></a><span id="l86.58" class="difflineminus">-  newFile-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l86.59"></a><span id="l86.59" class="difflineplus">+  newFile-&gt;Append(u&quot;tmp&quot;_ns);</span>
<a href="#l86.60"></a><span id="l86.60"> </span>
<a href="#l86.61"></a><span id="l86.61">   // let's check if the folder exists</span>
<a href="#l86.62"></a><span id="l86.62">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l86.63"></a><span id="l86.63">   bool exists;</span>
<a href="#l86.64"></a><span id="l86.64">   newFile-&gt;Exists(&amp;exists);</span>
<a href="#l86.65"></a><span id="l86.65">   if (!exists) {</span>
<a href="#l86.66"></a><span id="l86.66">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l86.67"></a><span id="l86.67">             (&quot;GetNewMsgOutputStream - tmp subfolder does not exist!!&quot;));</span>
<a href="#l86.68"></a><span id="l86.68" class="difflineat">@@ -630,17 +630,17 @@ nsMsgMaildirStore::DiscardNewMessage(nsI</span>
<a href="#l86.69"></a><span id="l86.69">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l86.70"></a><span id="l86.70">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l86.71"></a><span id="l86.71">   nsresult rv = aNewHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l86.72"></a><span id="l86.72">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.73"></a><span id="l86.73">   rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l86.74"></a><span id="l86.74">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.75"></a><span id="l86.75"> </span>
<a href="#l86.76"></a><span id="l86.76">   // path to the message download folder</span>
<a href="#l86.77"></a><span id="l86.77" class="difflineminus">-  path-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l86.78"></a><span id="l86.78" class="difflineplus">+  path-&gt;Append(u&quot;tmp&quot;_ns);</span>
<a href="#l86.79"></a><span id="l86.79">   path-&gt;AppendNative(fileName);</span>
<a href="#l86.80"></a><span id="l86.80"> </span>
<a href="#l86.81"></a><span id="l86.81">   return path-&gt;Remove(false);</span>
<a href="#l86.82"></a><span id="l86.82"> }</span>
<a href="#l86.83"></a><span id="l86.83"> </span>
<a href="#l86.84"></a><span id="l86.84"> NS_IMETHODIMP</span>
<a href="#l86.85"></a><span id="l86.85"> nsMsgMaildirStore::FinishNewMessage(nsIOutputStream* aOutputStream,</span>
<a href="#l86.86"></a><span id="l86.86">                                     nsIMsgDBHdr* aNewHdr) {</span>
<a href="#l86.87"></a><span id="l86.87" class="difflineat">@@ -663,31 +663,31 @@ nsMsgMaildirStore::FinishNewMessage(nsIO</span>
<a href="#l86.88"></a><span id="l86.88">   if (tmpName.IsEmpty()) {</span>
<a href="#l86.89"></a><span id="l86.89">     NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!&quot;);</span>
<a href="#l86.90"></a><span id="l86.90">     return NS_ERROR_FAILURE;</span>
<a href="#l86.91"></a><span id="l86.91">   }</span>
<a href="#l86.92"></a><span id="l86.92"> </span>
<a href="#l86.93"></a><span id="l86.93">   // path to the new destination</span>
<a href="#l86.94"></a><span id="l86.94">   nsCOMPtr&lt;nsIFile&gt; curPath;</span>
<a href="#l86.95"></a><span id="l86.95">   folderPath-&gt;Clone(getter_AddRefs(curPath));</span>
<a href="#l86.96"></a><span id="l86.96" class="difflineminus">-  curPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.97"></a><span id="l86.97" class="difflineplus">+  curPath-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.98"></a><span id="l86.98"> </span>
<a href="#l86.99"></a><span id="l86.99">   // let's check if the folder exists</span>
<a href="#l86.100"></a><span id="l86.100">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l86.101"></a><span id="l86.101">   bool exists;</span>
<a href="#l86.102"></a><span id="l86.102">   curPath-&gt;Exists(&amp;exists);</span>
<a href="#l86.103"></a><span id="l86.103">   if (!exists) {</span>
<a href="#l86.104"></a><span id="l86.104">     rv = curPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l86.105"></a><span id="l86.105">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.106"></a><span id="l86.106">   }</span>
<a href="#l86.107"></a><span id="l86.107"> </span>
<a href="#l86.108"></a><span id="l86.108">   // path to the downloaded message</span>
<a href="#l86.109"></a><span id="l86.109">   nsCOMPtr&lt;nsIFile&gt; fromPath;</span>
<a href="#l86.110"></a><span id="l86.110">   folderPath-&gt;Clone(getter_AddRefs(fromPath));</span>
<a href="#l86.111"></a><span id="l86.111" class="difflineminus">-  fromPath-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l86.112"></a><span id="l86.112" class="difflineplus">+  fromPath-&gt;Append(u&quot;tmp&quot;_ns);</span>
<a href="#l86.113"></a><span id="l86.113">   fromPath-&gt;AppendNative(tmpName);</span>
<a href="#l86.114"></a><span id="l86.114"> </span>
<a href="#l86.115"></a><span id="l86.115">   // Check that the message is still in tmp.</span>
<a href="#l86.116"></a><span id="l86.116">   // XXX TODO: revisit this. I think it's needed because the</span>
<a href="#l86.117"></a><span id="l86.117">   // pairing rules for:</span>
<a href="#l86.118"></a><span id="l86.118">   // GetNewMsgOutputStream(), FinishNewMessage(),</span>
<a href="#l86.119"></a><span id="l86.119">   // MoveNewlyDownloadedMessage() and DiscardNewMessage()</span>
<a href="#l86.120"></a><span id="l86.120">   // are not well defined.</span>
<a href="#l86.121"></a><span id="l86.121" class="difflineat">@@ -778,32 +778,32 @@ nsMsgMaildirStore::MoveNewlyDownloadedMe</span>
<a href="#l86.122"></a><span id="l86.122">   if (fileName.IsEmpty()) {</span>
<a href="#l86.123"></a><span id="l86.123">     NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!&quot;);</span>
<a href="#l86.124"></a><span id="l86.124">     return NS_ERROR_FAILURE;</span>
<a href="#l86.125"></a><span id="l86.125">   }</span>
<a href="#l86.126"></a><span id="l86.126"> </span>
<a href="#l86.127"></a><span id="l86.127">   // path to the downloaded message</span>
<a href="#l86.128"></a><span id="l86.128">   nsCOMPtr&lt;nsIFile&gt; fromPath;</span>
<a href="#l86.129"></a><span id="l86.129">   folderPath-&gt;Clone(getter_AddRefs(fromPath));</span>
<a href="#l86.130"></a><span id="l86.130" class="difflineminus">-  fromPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.131"></a><span id="l86.131" class="difflineplus">+  fromPath-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.132"></a><span id="l86.132">   fromPath-&gt;AppendNative(fileName);</span>
<a href="#l86.133"></a><span id="l86.133"> </span>
<a href="#l86.134"></a><span id="l86.134">   // let's check if the tmp file exists</span>
<a href="#l86.135"></a><span id="l86.135">   bool exists;</span>
<a href="#l86.136"></a><span id="l86.136">   fromPath-&gt;Exists(&amp;exists);</span>
<a href="#l86.137"></a><span id="l86.137">   if (!exists) {</span>
<a href="#l86.138"></a><span id="l86.138">     NS_ERROR(&quot;FinishNewMessage - oops! file does not exist!&quot;);</span>
<a href="#l86.139"></a><span id="l86.139">     return NS_ERROR_FAILURE;</span>
<a href="#l86.140"></a><span id="l86.140">   }</span>
<a href="#l86.141"></a><span id="l86.141"> </span>
<a href="#l86.142"></a><span id="l86.142">   // move to the &quot;cur&quot; subfolder</span>
<a href="#l86.143"></a><span id="l86.143">   nsCOMPtr&lt;nsIFile&gt; toPath;</span>
<a href="#l86.144"></a><span id="l86.144">   aDestFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l86.145"></a><span id="l86.145">   folderPath-&gt;Clone(getter_AddRefs(toPath));</span>
<a href="#l86.146"></a><span id="l86.146" class="difflineminus">-  toPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.147"></a><span id="l86.147" class="difflineplus">+  toPath-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.148"></a><span id="l86.148"> </span>
<a href="#l86.149"></a><span id="l86.149">   // let's check if the folder exists</span>
<a href="#l86.150"></a><span id="l86.150">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l86.151"></a><span id="l86.151">   toPath-&gt;Exists(&amp;exists);</span>
<a href="#l86.152"></a><span id="l86.152">   if (!exists) {</span>
<a href="#l86.153"></a><span id="l86.153">     rv = toPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l86.154"></a><span id="l86.154">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.155"></a><span id="l86.155">   }</span>
<a href="#l86.156"></a><span id="l86.156" class="difflineat">@@ -869,19 +869,18 @@ nsMsgMaildirStore::MoveNewlyDownloadedMe</span>
<a href="#l86.157"></a><span id="l86.157">       do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l86.158"></a><span id="l86.158">   if (notifier) notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l86.159"></a><span id="l86.159"> </span>
<a href="#l86.160"></a><span id="l86.160">   if (movedMsgIsNew) {</span>
<a href="#l86.161"></a><span id="l86.161">     aDestFolder-&gt;SetHasNewMessages(true);</span>
<a href="#l86.162"></a><span id="l86.162"> </span>
<a href="#l86.163"></a><span id="l86.163">     // Notify the message was moved.</span>
<a href="#l86.164"></a><span id="l86.164">     if (notifier) {</span>
<a href="#l86.165"></a><span id="l86.165" class="difflineminus">-      notifier-&gt;NotifyItemEvent(</span>
<a href="#l86.166"></a><span id="l86.166" class="difflineminus">-          folder, NS_LITERAL_CSTRING(&quot;UnincorporatedMessageMoved&quot;), newHdr,</span>
<a href="#l86.167"></a><span id="l86.167" class="difflineminus">-          EmptyCString());</span>
<a href="#l86.168"></a><span id="l86.168" class="difflineplus">+      notifier-&gt;NotifyItemEvent(folder, &quot;UnincorporatedMessageMoved&quot;_ns, newHdr,</span>
<a href="#l86.169"></a><span id="l86.169" class="difflineplus">+                                EmptyCString());</span>
<a href="#l86.170"></a><span id="l86.170">     }</span>
<a href="#l86.171"></a><span id="l86.171">   }</span>
<a href="#l86.172"></a><span id="l86.172"> </span>
<a href="#l86.173"></a><span id="l86.173">   nsCOMPtr&lt;nsIMsgDatabase&gt; sourceDB;</span>
<a href="#l86.174"></a><span id="l86.174">   rv = folder-&gt;GetMsgDatabase(getter_AddRefs(sourceDB));</span>
<a href="#l86.175"></a><span id="l86.175"> </span>
<a href="#l86.176"></a><span id="l86.176">   if (NS_SUCCEEDED(rv) &amp;&amp; sourceDB) sourceDB-&gt;RemoveHeaderMdbRow(aHdr);</span>
<a href="#l86.177"></a><span id="l86.177"> </span>
<a href="#l86.178"></a><span id="l86.178" class="difflineat">@@ -910,17 +909,17 @@ nsMsgMaildirStore::GetMsgInputStream(nsI</span>
<a href="#l86.179"></a><span id="l86.179">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.180"></a><span id="l86.180"> </span>
<a href="#l86.181"></a><span id="l86.181">   if (aMsgToken.IsEmpty()) {</span>
<a href="#l86.182"></a><span id="l86.182">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l86.183"></a><span id="l86.183">             (&quot;GetMsgInputStream - empty storeToken!!&quot;));</span>
<a href="#l86.184"></a><span id="l86.184">     return NS_ERROR_FAILURE;</span>
<a href="#l86.185"></a><span id="l86.185">   }</span>
<a href="#l86.186"></a><span id="l86.186"> </span>
<a href="#l86.187"></a><span id="l86.187" class="difflineminus">-  path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.188"></a><span id="l86.188" class="difflineplus">+  path-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.189"></a><span id="l86.189"> </span>
<a href="#l86.190"></a><span id="l86.190">   // let's check if the folder exists</span>
<a href="#l86.191"></a><span id="l86.191">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l86.192"></a><span id="l86.192">   bool exists;</span>
<a href="#l86.193"></a><span id="l86.193">   path-&gt;Exists(&amp;exists);</span>
<a href="#l86.194"></a><span id="l86.194">   if (!exists) {</span>
<a href="#l86.195"></a><span id="l86.195">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l86.196"></a><span id="l86.196">             (&quot;GetMsgInputStream - oops! cur subfolder does not exist!&quot;));</span>
<a href="#l86.197"></a><span id="l86.197" class="difflineat">@@ -946,17 +945,17 @@ NS_IMETHODIMP nsMsgMaildirStore::DeleteM</span>
<a href="#l86.198"></a><span id="l86.198"> </span>
<a href="#l86.199"></a><span id="l86.199">     if (fileName.IsEmpty()) {</span>
<a href="#l86.200"></a><span id="l86.200">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l86.201"></a><span id="l86.201">               (&quot;DeleteMessages - empty storeToken!!&quot;));</span>
<a href="#l86.202"></a><span id="l86.202">       // Perhaps an offline store has not downloaded this particular message.</span>
<a href="#l86.203"></a><span id="l86.203">       continue;</span>
<a href="#l86.204"></a><span id="l86.204">     }</span>
<a href="#l86.205"></a><span id="l86.205"> </span>
<a href="#l86.206"></a><span id="l86.206" class="difflineminus">-    path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.207"></a><span id="l86.207" class="difflineplus">+    path-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.208"></a><span id="l86.208">     path-&gt;AppendNative(fileName);</span>
<a href="#l86.209"></a><span id="l86.209"> </span>
<a href="#l86.210"></a><span id="l86.210">     // Let's check if the message exists.</span>
<a href="#l86.211"></a><span id="l86.211">     bool exists;</span>
<a href="#l86.212"></a><span id="l86.212">     path-&gt;Exists(&amp;exists);</span>
<a href="#l86.213"></a><span id="l86.213">     if (!exists) {</span>
<a href="#l86.214"></a><span id="l86.214">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l86.215"></a><span id="l86.215">               (&quot;DeleteMessages - file does not exist !!&quot;));</span>
<a href="#l86.216"></a><span id="l86.216" class="difflineat">@@ -1013,22 +1012,22 @@ nsMsgMaildirStore::CopyMessages(bool aIs</span>
<a href="#l86.217"></a><span id="l86.217"> </span>
<a href="#l86.218"></a><span id="l86.218">   // We should be able to use a file move for an efficient copy.</span>
<a href="#l86.219"></a><span id="l86.219"> </span>
<a href="#l86.220"></a><span id="l86.220">   nsCOMPtr&lt;nsIFile&gt; destFolderPath;</span>
<a href="#l86.221"></a><span id="l86.221">   nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l86.222"></a><span id="l86.222">   aDstFolder-&gt;GetMsgDatabase(getter_AddRefs(destDB));</span>
<a href="#l86.223"></a><span id="l86.223">   rv = aDstFolder-&gt;GetFilePath(getter_AddRefs(destFolderPath));</span>
<a href="#l86.224"></a><span id="l86.224">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.225"></a><span id="l86.225" class="difflineminus">-  destFolderPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.226"></a><span id="l86.226" class="difflineplus">+  destFolderPath-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.227"></a><span id="l86.227"> </span>
<a href="#l86.228"></a><span id="l86.228">   nsCOMPtr&lt;nsIFile&gt; srcFolderPath;</span>
<a href="#l86.229"></a><span id="l86.229">   rv = srcFolder-&gt;GetFilePath(getter_AddRefs(srcFolderPath));</span>
<a href="#l86.230"></a><span id="l86.230">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.231"></a><span id="l86.231" class="difflineminus">-  srcFolderPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.232"></a><span id="l86.232" class="difflineplus">+  srcFolderPath-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.233"></a><span id="l86.233"> </span>
<a href="#l86.234"></a><span id="l86.234">   nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l86.235"></a><span id="l86.235">   srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l86.236"></a><span id="l86.236">   RefPtr&lt;nsLocalMoveCopyMsgTxn&gt; msgTxn = new nsLocalMoveCopyMsgTxn;</span>
<a href="#l86.237"></a><span id="l86.237">   NS_ENSURE_TRUE(msgTxn, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l86.238"></a><span id="l86.238">   if (NS_SUCCEEDED(msgTxn-&gt;Init(srcFolder, aDstFolder, aIsMove))) {</span>
<a href="#l86.239"></a><span id="l86.239">     if (aIsMove)</span>
<a href="#l86.240"></a><span id="l86.240">       msgTxn-&gt;SetTransactionType(nsIMessenger::eMoveMsg);</span>
<a href="#l86.241"></a><span id="l86.241" class="difflineat">@@ -1253,17 +1252,17 @@ NS_IMETHODIMP nsMsgMaildirStore::Rebuild</span>
<a href="#l86.242"></a><span id="l86.242">                                               nsIMsgWindow* aMsgWindow,</span>
<a href="#l86.243"></a><span id="l86.243">                                               nsIUrlListener* aListener) {</span>
<a href="#l86.244"></a><span id="l86.244">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l86.245"></a><span id="l86.245">   // This code needs to iterate over the maildir files, and parse each</span>
<a href="#l86.246"></a><span id="l86.246">   // file and add a msg hdr to the db for the file.</span>
<a href="#l86.247"></a><span id="l86.247">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l86.248"></a><span id="l86.248">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l86.249"></a><span id="l86.249">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.250"></a><span id="l86.250" class="difflineminus">-  path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.251"></a><span id="l86.251" class="difflineplus">+  path-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.252"></a><span id="l86.252"> </span>
<a href="#l86.253"></a><span id="l86.253">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; directoryEnumerator;</span>
<a href="#l86.254"></a><span id="l86.254">   rv = path-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l86.255"></a><span id="l86.255">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.256"></a><span id="l86.256"> </span>
<a href="#l86.257"></a><span id="l86.257">   MaildirStoreParser* fileParser =</span>
<a href="#l86.258"></a><span id="l86.258">       new MaildirStoreParser(aFolder, aMsgDB, directoryEnumerator, aListener);</span>
<a href="#l86.259"></a><span id="l86.259">   NS_ENSURE_TRUE(fileParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l86.260"></a><span id="l86.260" class="difflineat">@@ -1300,17 +1299,17 @@ nsresult nsMsgMaildirStore::GetOutputStr</span>
<a href="#l86.261"></a><span id="l86.261">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.262"></a><span id="l86.262"> </span>
<a href="#l86.263"></a><span id="l86.263">   nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l86.264"></a><span id="l86.264">   rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l86.265"></a><span id="l86.265">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l86.266"></a><span id="l86.266"> </span>
<a href="#l86.267"></a><span id="l86.267">   nsCOMPtr&lt;nsIFile&gt; maildirFile;</span>
<a href="#l86.268"></a><span id="l86.268">   folderPath-&gt;Clone(getter_AddRefs(maildirFile));</span>
<a href="#l86.269"></a><span id="l86.269" class="difflineminus">-  maildirFile-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l86.270"></a><span id="l86.270" class="difflineplus">+  maildirFile-&gt;Append(u&quot;cur&quot;_ns);</span>
<a href="#l86.271"></a><span id="l86.271">   maildirFile-&gt;AppendNative(fileName);</span>
<a href="#l86.272"></a><span id="l86.272"> </span>
<a href="#l86.273"></a><span id="l86.273">   return MsgGetFileStream(maildirFile, getter_AddRefs(aOutputStream));</span>
<a href="#l86.274"></a><span id="l86.274"> }</span>
<a href="#l86.275"></a><span id="l86.275"> </span>
<a href="#l86.276"></a><span id="l86.276"> NS_IMETHODIMP nsMsgMaildirStore::ChangeKeywords(</span>
<a href="#l86.277"></a><span id="l86.277">     const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt;&amp; aHdrArray, const nsACString&amp; aKeywords,</span>
<a href="#l86.278"></a><span id="l86.278">     bool aAdd) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/mailnews/local/src/nsNoIncomingServer.cpp</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/mailnews/local/src/nsNoIncomingServer.cpp</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -128,28 +128,28 @@ NS_IMETHODIMP nsNoIncomingServer::Create</span>
<a href="#l87.4"></a><span id="l87.4">   nsresult rv;</span>
<a href="#l87.5"></a><span id="l87.5">   bool isHidden = false;</span>
<a href="#l87.6"></a><span id="l87.6">   GetHidden(&amp;isHidden);</span>
<a href="#l87.7"></a><span id="l87.7">   if (isHidden) return NS_OK;</span>
<a href="#l87.8"></a><span id="l87.8"> </span>
<a href="#l87.9"></a><span id="l87.9">   // notice, no Inbox, unless we're deferred to...</span>
<a href="#l87.10"></a><span id="l87.10">   bool isDeferredTo;</span>
<a href="#l87.11"></a><span id="l87.11">   if (NS_SUCCEEDED(GetIsDeferredTo(&amp;isDeferredTo)) &amp;&amp; isDeferredTo) {</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-    rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+    rv = CreateLocalFolder(u&quot;Inbox&quot;_ns);</span>
<a href="#l87.14"></a><span id="l87.14">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l87.15"></a><span id="l87.15">   }</span>
<a href="#l87.16"></a><span id="l87.16"> </span>
<a href="#l87.17"></a><span id="l87.17" class="difflineminus">-  rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l87.18"></a><span id="l87.18" class="difflineplus">+  rv = CreateLocalFolder(u&quot;Trash&quot;_ns);</span>
<a href="#l87.19"></a><span id="l87.19">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l87.20"></a><span id="l87.20"> </span>
<a href="#l87.21"></a><span id="l87.21">   // copy the default templates into the Templates folder</span>
<a href="#l87.22"></a><span id="l87.22">   rv = CopyDefaultMessages(&quot;Templates&quot;);</span>
<a href="#l87.23"></a><span id="l87.23">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l87.24"></a><span id="l87.24"> </span>
<a href="#l87.25"></a><span id="l87.25" class="difflineminus">-  return CreateLocalFolder(NS_LITERAL_STRING(&quot;Unsent Messages&quot;));</span>
<a href="#l87.26"></a><span id="l87.26" class="difflineplus">+  return CreateLocalFolder(u&quot;Unsent Messages&quot;_ns);</span>
<a href="#l87.27"></a><span id="l87.27"> }</span>
<a href="#l87.28"></a><span id="l87.28"> </span>
<a href="#l87.29"></a><span id="l87.29"> NS_IMETHODIMP</span>
<a href="#l87.30"></a><span id="l87.30"> nsNoIncomingServer::GetNewMail(nsIMsgWindow* aMsgWindow,</span>
<a href="#l87.31"></a><span id="l87.31">                                nsIUrlListener* aUrlListener,</span>
<a href="#l87.32"></a><span id="l87.32">                                nsIMsgFolder* aInbox, nsIURI** aResult) {</span>
<a href="#l87.33"></a><span id="l87.33">   nsTArray&lt;RefPtr&lt;nsIPop3IncomingServer&gt;&gt; deferredServers;</span>
<a href="#l87.34"></a><span id="l87.34">   nsresult rv = GetDeferredServers(this, deferredServers);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -1062,17 +1062,17 @@ nsresult nsParseMailMessageState::ParseH</span>
<a href="#l88.4"></a><span id="l88.4">                 PR_SUCCESS)</span>
<a href="#l88.5"></a><span id="l88.5">               m_receivedTime = resultTime;</span>
<a href="#l88.6"></a><span id="l88.6">             else</span>
<a href="#l88.7"></a><span id="l88.7">               NS_WARNING(&quot;PR_ParseTimeString failed in ParseHeaders().&quot;);</span>
<a href="#l88.8"></a><span id="l88.8">           }</span>
<a href="#l88.9"></a><span id="l88.9">         }</span>
<a href="#l88.10"></a><span id="l88.10">         // Someone might want the received header saved.</span>
<a href="#l88.11"></a><span id="l88.11">         if (m_customDBHeaders.Length()) {</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-          if (m_customDBHeaders.Contains(NS_LITERAL_CSTRING(&quot;received&quot;))) {</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+          if (m_customDBHeaders.Contains(&quot;received&quot;_ns)) {</span>
<a href="#l88.14"></a><span id="l88.14">             if (!m_receivedValue.IsEmpty()) m_receivedValue.Append(' ');</span>
<a href="#l88.15"></a><span id="l88.15">             m_receivedValue.Append(header-&gt;value, header-&gt;length);</span>
<a href="#l88.16"></a><span id="l88.16">           }</span>
<a href="#l88.17"></a><span id="l88.17">         }</span>
<a href="#l88.18"></a><span id="l88.18">       }</span>
<a href="#l88.19"></a><span id="l88.19"> </span>
<a href="#l88.20"></a><span id="l88.20">       MOZ_ASSERT(header-&gt;value[header-&gt;length] == 0,</span>
<a href="#l88.21"></a><span id="l88.21">                  &quot;Non-null-terminated strings cause very, very bad problems&quot;);</span>
<a href="#l88.22"></a><span id="l88.22" class="difflineat">@@ -1921,18 +1921,17 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l88.23"></a><span id="l88.23">                       (&quot;(Local) Target Folder for Move action does not exist&quot;));</span>
<a href="#l88.24"></a><span id="l88.24">               break;</span>
<a href="#l88.25"></a><span id="l88.25">             }</span>
<a href="#l88.26"></a><span id="l88.26">             bool msgMoved = false;</span>
<a href="#l88.27"></a><span id="l88.27">             // If we're moving to an imap folder, or this message has already</span>
<a href="#l88.28"></a><span id="l88.28">             // has a pending copy action, use the imap coalescer so that</span>
<a href="#l88.29"></a><span id="l88.29">             // we won't truncate the inbox before the copy fires.</span>
<a href="#l88.30"></a><span id="l88.30">             if (m_msgCopiedByFilter ||</span>
<a href="#l88.31"></a><span id="l88.31" class="difflineminus">-                StringBeginsWith(actionTargetFolderUri,</span>
<a href="#l88.32"></a><span id="l88.32" class="difflineminus">-                                 NS_LITERAL_CSTRING(&quot;imap:&quot;))) {</span>
<a href="#l88.33"></a><span id="l88.33" class="difflineplus">+                StringBeginsWith(actionTargetFolderUri, &quot;imap:&quot;_ns)) {</span>
<a href="#l88.34"></a><span id="l88.34">               if (!m_moveCoalescer)</span>
<a href="#l88.35"></a><span id="l88.35">                 m_moveCoalescer =</span>
<a href="#l88.36"></a><span id="l88.36">                     new nsImapMoveCoalescer(m_downloadFolder, m_msgWindow);</span>
<a href="#l88.37"></a><span id="l88.37">               NS_ENSURE_TRUE(m_moveCoalescer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l88.38"></a><span id="l88.38">               rv = m_moveCoalescer-&gt;AddMove(destIFolder, msgKey);</span>
<a href="#l88.39"></a><span id="l88.39">               msgIsNew = false;</span>
<a href="#l88.40"></a><span id="l88.40">               if (NS_FAILED(rv)) break;</span>
<a href="#l88.41"></a><span id="l88.41">             } else {</span>
<a href="#l88.42"></a><span id="l88.42" class="difflineat">@@ -1943,19 +1942,18 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l88.43"></a><span id="l88.43">                                                           &amp;msgMoved);</span>
<a href="#l88.44"></a><span id="l88.44">               if (NS_SUCCEEDED(rv) &amp;&amp; !msgMoved)</span>
<a href="#l88.45"></a><span id="l88.45">                 rv = MoveIncorporatedMessage(msgHdr, m_mailDB, destIFolder,</span>
<a href="#l88.46"></a><span id="l88.46">                                              filter, msgWindow);</span>
<a href="#l88.47"></a><span id="l88.47">               m_msgMovedByFilter = NS_SUCCEEDED(rv);</span>
<a href="#l88.48"></a><span id="l88.48">               if (!m_msgMovedByFilter /* == NS_FAILED(err) */) {</span>
<a href="#l88.49"></a><span id="l88.49">                 // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l88.50"></a><span id="l88.50">                 if (loggingEnabled) {</span>
<a href="#l88.51"></a><span id="l88.51" class="difflineminus">-                  (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l88.52"></a><span id="l88.52" class="difflineminus">-                      filterAction, msgHdr, rv,</span>
<a href="#l88.53"></a><span id="l88.53" class="difflineminus">-                      NS_LITERAL_CSTRING(&quot;filterFailureMoveFailed&quot;));</span>
<a href="#l88.54"></a><span id="l88.54" class="difflineplus">+                  (void)filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l88.55"></a><span id="l88.55" class="difflineplus">+                                               &quot;filterFailureMoveFailed&quot;_ns);</span>
<a href="#l88.56"></a><span id="l88.56">                 }</span>
<a href="#l88.57"></a><span id="l88.57">               }</span>
<a href="#l88.58"></a><span id="l88.58">             }</span>
<a href="#l88.59"></a><span id="l88.59">           } else {</span>
<a href="#l88.60"></a><span id="l88.60">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l88.61"></a><span id="l88.61">                     (&quot;(Local) Target folder is the same as source folder&quot;));</span>
<a href="#l88.62"></a><span id="l88.62">             rv = NS_OK;</span>
<a href="#l88.63"></a><span id="l88.63">           }</span>
<a href="#l88.64"></a><span id="l88.64" class="difflineat">@@ -1988,19 +1986,18 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l88.65"></a><span id="l88.65">             if (NS_SUCCEEDED(rv))</span>
<a href="#l88.66"></a><span id="l88.66">               rv = copyService-&gt;CopyMessages(m_downloadFolder, messageArray,</span>
<a href="#l88.67"></a><span id="l88.67">                                              dstFolder, false, nullptr,</span>
<a href="#l88.68"></a><span id="l88.68">                                              msgWindow, false);</span>
<a href="#l88.69"></a><span id="l88.69"> </span>
<a href="#l88.70"></a><span id="l88.70">             if (NS_FAILED(rv)) {</span>
<a href="#l88.71"></a><span id="l88.71">               // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l88.72"></a><span id="l88.72">               if (loggingEnabled) {</span>
<a href="#l88.73"></a><span id="l88.73" class="difflineminus">-                (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l88.74"></a><span id="l88.74" class="difflineminus">-                    filterAction, msgHdr, rv,</span>
<a href="#l88.75"></a><span id="l88.75" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l88.76"></a><span id="l88.76" class="difflineplus">+                (void)filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l88.77"></a><span id="l88.77" class="difflineplus">+                                             &quot;filterFailureCopyFailed&quot;_ns);</span>
<a href="#l88.78"></a><span id="l88.78">               }</span>
<a href="#l88.79"></a><span id="l88.79">             } else</span>
<a href="#l88.80"></a><span id="l88.80">               m_msgCopiedByFilter = true;</span>
<a href="#l88.81"></a><span id="l88.81">           } else {</span>
<a href="#l88.82"></a><span id="l88.82">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l88.83"></a><span id="l88.83">                     (&quot;(Local) Target folder is the same as source folder&quot;));</span>
<a href="#l88.84"></a><span id="l88.84">             break;</span>
<a href="#l88.85"></a><span id="l88.85">           }</span>
<a href="#l88.86"></a><span id="l88.86" class="difflineat">@@ -2152,17 +2149,17 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l88.87"></a><span id="l88.87">     }</span>
<a href="#l88.88"></a><span id="l88.88">     if (NS_FAILED(rv)) {</span>
<a href="#l88.89"></a><span id="l88.89">       finalResult = rv;</span>
<a href="#l88.90"></a><span id="l88.90">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l88.91"></a><span id="l88.91">               (&quot;(Local) Action execution failed with error: %&quot; PRIx32,</span>
<a href="#l88.92"></a><span id="l88.92">                static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l88.93"></a><span id="l88.93">       if (loggingEnabled) {</span>
<a href="#l88.94"></a><span id="l88.94">         (void)filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l88.95"></a><span id="l88.95" class="difflineminus">-                                     NS_LITERAL_CSTRING(&quot;filterFailureAction&quot;));</span>
<a href="#l88.96"></a><span id="l88.96" class="difflineplus">+                                     &quot;filterFailureAction&quot;_ns);</span>
<a href="#l88.97"></a><span id="l88.97">       }</span>
<a href="#l88.98"></a><span id="l88.98">     } else {</span>
<a href="#l88.99"></a><span id="l88.99">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l88.100"></a><span id="l88.100">               (&quot;(Local) Action execution succeeded&quot;));</span>
<a href="#l88.101"></a><span id="l88.101">     }</span>
<a href="#l88.102"></a><span id="l88.102">   }</span>
<a href="#l88.103"></a><span id="l88.103">   if (!msgIsNew) {</span>
<a href="#l88.104"></a><span id="l88.104">     int32_t numNewMessages;</span>
<a href="#l88.105"></a><span id="l88.105" class="difflineat">@@ -2238,21 +2235,21 @@ nsresult nsParseNewMailState::ApplyForwa</span>
<a href="#l88.106"></a><span id="l88.106">                                               msgWindow, server);</span>
<a href="#l88.107"></a><span id="l88.107">           if (NS_FAILED(rv)) {</span>
<a href="#l88.108"></a><span id="l88.108">             NS_WARNING(&quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l88.109"></a><span id="l88.109">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l88.110"></a><span id="l88.110">                     (&quot;(Local) Replying failed&quot;));</span>
<a href="#l88.111"></a><span id="l88.111">             if (rv == NS_ERROR_ABORT) {</span>
<a href="#l88.112"></a><span id="l88.112">               (void)m_filter-&gt;LogRuleHitFail(</span>
<a href="#l88.113"></a><span id="l88.113">                   m_ruleAction, m_msgToForwardOrReply, rv,</span>
<a href="#l88.114"></a><span id="l88.114" class="difflineminus">-                  NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l88.115"></a><span id="l88.115" class="difflineplus">+                  &quot;filterFailureSendingReplyAborted&quot;_ns);</span>
<a href="#l88.116"></a><span id="l88.116">             } else {</span>
<a href="#l88.117"></a><span id="l88.117">               (void)m_filter-&gt;LogRuleHitFail(</span>
<a href="#l88.118"></a><span id="l88.118">                   m_ruleAction, m_msgToForwardOrReply, rv,</span>
<a href="#l88.119"></a><span id="l88.119" class="difflineminus">-                  NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span>
<a href="#l88.120"></a><span id="l88.120" class="difflineplus">+                  &quot;filterFailureSendingReplyError&quot;_ns);</span>
<a href="#l88.121"></a><span id="l88.121">             }</span>
<a href="#l88.122"></a><span id="l88.122">           }</span>
<a href="#l88.123"></a><span id="l88.123">         }</span>
<a href="#l88.124"></a><span id="l88.124">       }</span>
<a href="#l88.125"></a><span id="l88.125">     }</span>
<a href="#l88.126"></a><span id="l88.126">   }</span>
<a href="#l88.127"></a><span id="l88.127">   m_replyTemplateUri.Clear();</span>
<a href="#l88.128"></a><span id="l88.128">   m_msgToForwardOrReply = nullptr;</span>
<a href="#l88.129"></a><span id="l88.129" class="difflineat">@@ -2476,19 +2473,18 @@ nsresult nsParseNewMailState::MoveIncorp</span>
<a href="#l88.130"></a><span id="l88.130"> </span>
<a href="#l88.131"></a><span id="l88.131">   (void)localFolder-&gt;RefreshSizeOnDisk();</span>
<a href="#l88.132"></a><span id="l88.132"> </span>
<a href="#l88.133"></a><span id="l88.133">   // Notify the message was moved.</span>
<a href="#l88.134"></a><span id="l88.134">   if (notifier) {</span>
<a href="#l88.135"></a><span id="l88.135">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l88.136"></a><span id="l88.136">     nsresult rv = mailHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l88.137"></a><span id="l88.137">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l88.138"></a><span id="l88.138" class="difflineminus">-      notifier-&gt;NotifyItemEvent(</span>
<a href="#l88.139"></a><span id="l88.139" class="difflineminus">-          folder, NS_LITERAL_CSTRING(&quot;UnincorporatedMessageMoved&quot;), newHdr,</span>
<a href="#l88.140"></a><span id="l88.140" class="difflineminus">-          EmptyCString());</span>
<a href="#l88.141"></a><span id="l88.141" class="difflineplus">+      notifier-&gt;NotifyItemEvent(folder, &quot;UnincorporatedMessageMoved&quot;_ns, newHdr,</span>
<a href="#l88.142"></a><span id="l88.142" class="difflineplus">+                                EmptyCString());</span>
<a href="#l88.143"></a><span id="l88.143">     } else {</span>
<a href="#l88.144"></a><span id="l88.144">       NS_WARNING(&quot;Can't get folder for message that was moved.&quot;);</span>
<a href="#l88.145"></a><span id="l88.145">     }</span>
<a href="#l88.146"></a><span id="l88.146">   }</span>
<a href="#l88.147"></a><span id="l88.147"> </span>
<a href="#l88.148"></a><span id="l88.148">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; store;</span>
<a href="#l88.149"></a><span id="l88.149">   rv = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(store));</span>
<a href="#l88.150"></a><span id="l88.150">   if (store) store-&gt;DiscardNewMessage(m_outputStream, mailHdr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -215,18 +215,17 @@ NS_IMETHODIMP nsPop3IncomingServer::SetD</span>
<a href="#l89.4"></a><span id="l89.4">               if (server) {</span>
<a href="#l89.5"></a><span id="l89.5">                 nsCOMPtr&lt;nsILocalMailIncomingServer&gt; incomingLocalServer =</span>
<a href="#l89.6"></a><span id="l89.6">                     do_QueryInterface(server);</span>
<a href="#l89.7"></a><span id="l89.7">                 if (incomingLocalServer) {</span>
<a href="#l89.8"></a><span id="l89.8">                   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l89.9"></a><span id="l89.9">                   rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l89.10"></a><span id="l89.10">                   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l89.11"></a><span id="l89.11">                   // this will fail if it already exists, which is fine.</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-                  rootFolder-&gt;CreateSubfolder(NS_LITERAL_STRING(&quot;Inbox&quot;),</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineminus">-                                              nullptr);</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineplus">+                  rootFolder-&gt;CreateSubfolder(u&quot;Inbox&quot;_ns, nullptr);</span>
<a href="#l89.15"></a><span id="l89.15">                 }</span>
<a href="#l89.16"></a><span id="l89.16">               }</span>
<a href="#l89.17"></a><span id="l89.17">             }</span>
<a href="#l89.18"></a><span id="l89.18">           }</span>
<a href="#l89.19"></a><span id="l89.19">         }</span>
<a href="#l89.20"></a><span id="l89.20">       }</span>
<a href="#l89.21"></a><span id="l89.21">     }</span>
<a href="#l89.22"></a><span id="l89.22">   }</span>
<a href="#l89.23"></a><span id="l89.23" class="difflineat">@@ -379,20 +378,20 @@ nsPop3IncomingServer::SetFlagsOnDefaultM</span>
<a href="#l89.24"></a><span id="l89.24"> </span>
<a href="#l89.25"></a><span id="l89.25">   // pop3 gets an inbox, but no queue (unsent messages)</span>
<a href="#l89.26"></a><span id="l89.26">   localFolder-&gt;SetFlagsOnDefaultMailboxes(nsMsgFolderFlags::SpecialUse &amp;</span>
<a href="#l89.27"></a><span id="l89.27">                                           ~nsMsgFolderFlags::Queue);</span>
<a href="#l89.28"></a><span id="l89.28">   return NS_OK;</span>
<a href="#l89.29"></a><span id="l89.29"> }</span>
<a href="#l89.30"></a><span id="l89.30"> </span>
<a href="#l89.31"></a><span id="l89.31"> NS_IMETHODIMP nsPop3IncomingServer::CreateDefaultMailboxes() {</span>
<a href="#l89.32"></a><span id="l89.32" class="difflineminus">-  nsresult rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l89.33"></a><span id="l89.33" class="difflineplus">+  nsresult rv = CreateLocalFolder(u&quot;Inbox&quot;_ns);</span>
<a href="#l89.34"></a><span id="l89.34">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l89.35"></a><span id="l89.35"> </span>
<a href="#l89.36"></a><span id="l89.36" class="difflineminus">-  return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l89.37"></a><span id="l89.37" class="difflineplus">+  return CreateLocalFolder(u&quot;Trash&quot;_ns);</span>
<a href="#l89.38"></a><span id="l89.38"> }</span>
<a href="#l89.39"></a><span id="l89.39"> </span>
<a href="#l89.40"></a><span id="l89.40"> // override this so we can say that deferred accounts can't have messages</span>
<a href="#l89.41"></a><span id="l89.41"> // filed to them, which will remove them as targets of all the move/copy</span>
<a href="#l89.42"></a><span id="l89.42"> // menu items.</span>
<a href="#l89.43"></a><span id="l89.43"> NS_IMETHODIMP</span>
<a href="#l89.44"></a><span id="l89.44"> nsPop3IncomingServer::GetCanFileMessagesOnServer(</span>
<a href="#l89.45"></a><span id="l89.45">     bool* aCanFileMessagesOnServer) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -135,17 +135,17 @@ static Pop3UidlHost* net_pop3_load_state</span>
<a href="#l90.4"></a><span id="l90.4">     if (result-&gt;hash) PL_HashTableDestroy(result-&gt;hash);</span>
<a href="#l90.5"></a><span id="l90.5">     PR_Free(result);</span>
<a href="#l90.6"></a><span id="l90.6">     return nullptr;</span>
<a href="#l90.7"></a><span id="l90.7">   }</span>
<a href="#l90.8"></a><span id="l90.8"> </span>
<a href="#l90.9"></a><span id="l90.9">   nsCOMPtr&lt;nsIFile&gt; popState;</span>
<a href="#l90.10"></a><span id="l90.10">   mailDirectory-&gt;Clone(getter_AddRefs(popState));</span>
<a href="#l90.11"></a><span id="l90.11">   if (!popState) return nullptr;</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-  popState-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;popstate.dat&quot;));</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+  popState-&gt;AppendNative(&quot;popstate.dat&quot;_ns);</span>
<a href="#l90.14"></a><span id="l90.14"> </span>
<a href="#l90.15"></a><span id="l90.15">   nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l90.16"></a><span id="l90.16">   nsresult rv =</span>
<a href="#l90.17"></a><span id="l90.17">       NS_NewLocalFileInputStream(getter_AddRefs(fileStream), popState);</span>
<a href="#l90.18"></a><span id="l90.18">   // It is OK if the file doesn't exist. No state is stored yet.</span>
<a href="#l90.19"></a><span id="l90.19">   // Return empty list without warning.</span>
<a href="#l90.20"></a><span id="l90.20">   if (rv == NS_ERROR_FILE_NOT_FOUND) return result;</span>
<a href="#l90.21"></a><span id="l90.21">   // Warn for other errors.</span>
<a href="#l90.22"></a><span id="l90.22" class="difflineat">@@ -276,17 +276,17 @@ static int net_pop3_delete_old_msgs_mapp</span>
<a href="#l90.23"></a><span id="l90.23"> }</span>
<a href="#l90.24"></a><span id="l90.24"> </span>
<a href="#l90.25"></a><span id="l90.25"> static void net_pop3_write_state(Pop3UidlHost* host, nsIFile* mailDirectory) {</span>
<a href="#l90.26"></a><span id="l90.26">   int32_t len = 0;</span>
<a href="#l90.27"></a><span id="l90.27">   nsCOMPtr&lt;nsIFile&gt; popState;</span>
<a href="#l90.28"></a><span id="l90.28"> </span>
<a href="#l90.29"></a><span id="l90.29">   mailDirectory-&gt;Clone(getter_AddRefs(popState));</span>
<a href="#l90.30"></a><span id="l90.30">   if (!popState) return;</span>
<a href="#l90.31"></a><span id="l90.31" class="difflineminus">-  popState-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;popstate.dat&quot;));</span>
<a href="#l90.32"></a><span id="l90.32" class="difflineplus">+  popState-&gt;AppendNative(&quot;popstate.dat&quot;_ns);</span>
<a href="#l90.33"></a><span id="l90.33"> </span>
<a href="#l90.34"></a><span id="l90.34">   nsCOMPtr&lt;nsIOutputStream&gt; fileOutputStream;</span>
<a href="#l90.35"></a><span id="l90.35">   nsresult rv = MsgNewSafeBufferedFileOutputStream(</span>
<a href="#l90.36"></a><span id="l90.36">       getter_AddRefs(fileOutputStream), popState, -1, 00600);</span>
<a href="#l90.37"></a><span id="l90.37">   if (NS_FAILED(rv)) return;</span>
<a href="#l90.38"></a><span id="l90.38"> </span>
<a href="#l90.39"></a><span id="l90.39">   const char tmpBuffer[] =</span>
<a href="#l90.40"></a><span id="l90.40">       &quot;# POP3 State File&quot; MSG_LINEBREAK</span>
<a href="#l90.41"></a><span id="l90.41" class="difflineat">@@ -2172,17 +2172,17 @@ int32_t nsPop3Protocol::SendPassword() {</span>
<a href="#l90.42"></a><span id="l90.42"> </span>
<a href="#l90.43"></a><span id="l90.43">     if (NS_FAILED(rv)) cmd = &quot;*&quot;;</span>
<a href="#l90.44"></a><span id="l90.44">   } else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN) {</span>
<a href="#l90.45"></a><span id="l90.45">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;PLAIN login&quot;)));</span>
<a href="#l90.46"></a><span id="l90.46">     // workaround for IPswitch's IMail server software</span>
<a href="#l90.47"></a><span id="l90.47">     // this server goes into LOGIN mode even if we send &quot;AUTH PLAIN&quot;</span>
<a href="#l90.48"></a><span id="l90.48">     // &quot;VXNlc&quot; is the beginning of the base64 encoded prompt (&quot;Username:&quot;) for</span>
<a href="#l90.49"></a><span id="l90.49">     // LOGIN</span>
<a href="#l90.50"></a><span id="l90.50" class="difflineminus">-    if (StringBeginsWith(m_commandResponse, NS_LITERAL_CSTRING(&quot;VXNlc&quot;))) {</span>
<a href="#l90.51"></a><span id="l90.51" class="difflineplus">+    if (StringBeginsWith(m_commandResponse, &quot;VXNlc&quot;_ns)) {</span>
<a href="#l90.52"></a><span id="l90.52">       // disable PLAIN and enable LOGIN (in case it's not already enabled)</span>
<a href="#l90.53"></a><span id="l90.53">       ClearCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l90.54"></a><span id="l90.54">       SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l90.55"></a><span id="l90.55">       m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l90.56"></a><span id="l90.56"> </span>
<a href="#l90.57"></a><span id="l90.57">       // reenter authentication again at LOGIN response handler</span>
<a href="#l90.58"></a><span id="l90.58">       m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN_RESPONSE;</span>
<a href="#l90.59"></a><span id="l90.59">       m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l90.60"></a><span id="l90.60" class="difflineat">@@ -3029,20 +3029,19 @@ int32_t nsPop3Protocol::SendRetr() {</span>
<a href="#l90.61"></a><span id="l90.61"> </span>
<a href="#l90.62"></a><span id="l90.62">     if (m_pop3ConData-&gt;only_uidl) {</span>
<a href="#l90.63"></a><span id="l90.63">       /* Display bytes if we're only downloading one message. */</span>
<a href="#l90.64"></a><span id="l90.64">       PR_ASSERT(!m_pop3ConData-&gt;graph_progress_bytes_p);</span>
<a href="#l90.65"></a><span id="l90.65">       UpdateProgressPercent(0, m_totalDownloadSize);</span>
<a href="#l90.66"></a><span id="l90.66">       m_pop3ConData-&gt;graph_progress_bytes_p = true;</span>
<a href="#l90.67"></a><span id="l90.67">     } else {</span>
<a href="#l90.68"></a><span id="l90.68">       nsString finalString;</span>
<a href="#l90.69"></a><span id="l90.69" class="difflineminus">-      mozilla::DebugOnly&lt;nsresult&gt; rv =</span>
<a href="#l90.70"></a><span id="l90.70" class="difflineminus">-          FormatCounterString(NS_LITERAL_STRING(&quot;receivingMessages&quot;),</span>
<a href="#l90.71"></a><span id="l90.71" class="difflineminus">-                              m_pop3ConData-&gt;real_new_counter,</span>
<a href="#l90.72"></a><span id="l90.72" class="difflineminus">-                              m_pop3ConData-&gt;really_new_messages, finalString);</span>
<a href="#l90.73"></a><span id="l90.73" class="difflineplus">+      mozilla::DebugOnly&lt;nsresult&gt; rv = FormatCounterString(</span>
<a href="#l90.74"></a><span id="l90.74" class="difflineplus">+          u&quot;receivingMessages&quot;_ns, m_pop3ConData-&gt;real_new_counter,</span>
<a href="#l90.75"></a><span id="l90.75" class="difflineplus">+          m_pop3ConData-&gt;really_new_messages, finalString);</span>
<a href="#l90.76"></a><span id="l90.76">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;couldn't format string&quot;);</span>
<a href="#l90.77"></a><span id="l90.77">       if (mProgressEventSink) {</span>
<a href="#l90.78"></a><span id="l90.78">         rv = mProgressEventSink-&gt;OnStatus(this, NS_OK, finalString.get());</span>
<a href="#l90.79"></a><span id="l90.79">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;dropping error result&quot;);</span>
<a href="#l90.80"></a><span id="l90.80">       }</span>
<a href="#l90.81"></a><span id="l90.81">     }</span>
<a href="#l90.82"></a><span id="l90.82"> </span>
<a href="#l90.83"></a><span id="l90.83">     status = Pop3SendData(cmd);</span>
<a href="#l90.84"></a><span id="l90.84" class="difflineat">@@ -3771,18 +3770,17 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l90.85"></a><span id="l90.85">               show the message there. */</span>
<a href="#l90.86"></a><span id="l90.86"> </span>
<a href="#l90.87"></a><span id="l90.87">             if (m_totalDownloadSize &lt;= 0) {</span>
<a href="#l90.88"></a><span id="l90.88">               UpdateStatus(&quot;noNewMessages&quot;);</span>
<a href="#l90.89"></a><span id="l90.89">               /* There are no new messages.  */</span>
<a href="#l90.90"></a><span id="l90.90">             } else {</span>
<a href="#l90.91"></a><span id="l90.91">               nsString statusString;</span>
<a href="#l90.92"></a><span id="l90.92">               nsresult rv = FormatCounterString(</span>
<a href="#l90.93"></a><span id="l90.93" class="difflineminus">-                  NS_LITERAL_STRING(&quot;receivedMsgs&quot;),</span>
<a href="#l90.94"></a><span id="l90.94" class="difflineminus">-                  m_pop3ConData-&gt;real_new_counter - 1,</span>
<a href="#l90.95"></a><span id="l90.95" class="difflineplus">+                  u&quot;receivedMsgs&quot;_ns, m_pop3ConData-&gt;real_new_counter - 1,</span>
<a href="#l90.96"></a><span id="l90.96">                   m_pop3ConData-&gt;really_new_messages, statusString);</span>
<a href="#l90.97"></a><span id="l90.97">               if (NS_SUCCEEDED(rv)) UpdateStatusWithString(statusString.get());</span>
<a href="#l90.98"></a><span id="l90.98">             }</span>
<a href="#l90.99"></a><span id="l90.99">           }</span>
<a href="#l90.100"></a><span id="l90.100">         }</span>
<a href="#l90.101"></a><span id="l90.101"> </span>
<a href="#l90.102"></a><span id="l90.102">         status = Pop3SendData(&quot;QUIT&quot; CRLF);</span>
<a href="#l90.103"></a><span id="l90.103">         m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_RESPONSE;</span>
<a href="#l90.104"></a><span id="l90.104" class="difflineat">@@ -3820,20 +3818,19 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l90.105"></a><span id="l90.105">         if (m_pop3ConData-&gt;msg_closure) {</span>
<a href="#l90.106"></a><span id="l90.106">           m_nsIPop3Sink-&gt;IncorporateAbort(m_pop3ConData-&gt;only_uidl != nullptr);</span>
<a href="#l90.107"></a><span id="l90.107">           m_pop3ConData-&gt;msg_closure = NULL;</span>
<a href="#l90.108"></a><span id="l90.108">           m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l90.109"></a><span id="l90.109">         }</span>
<a href="#l90.110"></a><span id="l90.110"> </span>
<a href="#l90.111"></a><span id="l90.111">         if (m_pop3ConData-&gt;msg_del_started) {</span>
<a href="#l90.112"></a><span id="l90.112">           nsString statusString;</span>
<a href="#l90.113"></a><span id="l90.113" class="difflineminus">-          nsresult rv = FormatCounterString(NS_LITERAL_STRING(&quot;receivedMsgs&quot;),</span>
<a href="#l90.114"></a><span id="l90.114" class="difflineminus">-                                            m_pop3ConData-&gt;real_new_counter - 1,</span>
<a href="#l90.115"></a><span id="l90.115" class="difflineminus">-                                            m_pop3ConData-&gt;really_new_messages,</span>
<a href="#l90.116"></a><span id="l90.116" class="difflineminus">-                                            statusString);</span>
<a href="#l90.117"></a><span id="l90.117" class="difflineplus">+          nsresult rv = FormatCounterString(</span>
<a href="#l90.118"></a><span id="l90.118" class="difflineplus">+              u&quot;receivedMsgs&quot;_ns, m_pop3ConData-&gt;real_new_counter - 1,</span>
<a href="#l90.119"></a><span id="l90.119" class="difflineplus">+              m_pop3ConData-&gt;really_new_messages, statusString);</span>
<a href="#l90.120"></a><span id="l90.120">           if (NS_SUCCEEDED(rv)) UpdateStatusWithString(statusString.get());</span>
<a href="#l90.121"></a><span id="l90.121"> </span>
<a href="#l90.122"></a><span id="l90.122">           NS_ASSERTION(!TestFlag(POP3_PASSWORD_FAILED),</span>
<a href="#l90.123"></a><span id="l90.123">                        &quot;POP3_PASSWORD_FAILED set when del_started&quot;);</span>
<a href="#l90.124"></a><span id="l90.124">           m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l90.125"></a><span id="l90.125">         }</span>
<a href="#l90.126"></a><span id="l90.126">         {  // this brace is to avoid compiler error about vars in switch case.</span>
<a href="#l90.127"></a><span id="l90.127">           nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -389,18 +389,17 @@ nsPop3Sink::IncorporateBegin(const char*</span>
<a href="#l91.4"></a><span id="l91.4">   if (pPrefBranch) {</span>
<a href="#l91.5"></a><span id="l91.5">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l91.6"></a><span id="l91.6">     m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l91.7"></a><span id="l91.7">     nsCString plugStoreContract;</span>
<a href="#l91.8"></a><span id="l91.8">     server-&gt;GetCharValue(&quot;storeContractID&quot;, plugStoreContract);</span>
<a href="#l91.9"></a><span id="l91.9">     // Maildir doesn't care about quaranting, but other stores besides berkeley</span>
<a href="#l91.10"></a><span id="l91.10">     // mailbox might. We should probably make this an attribute on the pluggable</span>
<a href="#l91.11"></a><span id="l91.11">     // store, though.</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-    if (plugStoreContract.Equals(</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;@mozilla.org/msgstore/berkeleystore;1&quot;)))</span>
<a href="#l91.14"></a><span id="l91.14" class="difflineplus">+    if (plugStoreContract.Equals(&quot;@mozilla.org/msgstore/berkeleystore;1&quot;_ns))</span>
<a href="#l91.15"></a><span id="l91.15">       pPrefBranch-&gt;GetBoolPref(&quot;mailnews.downloadToTempFile&quot;,</span>
<a href="#l91.16"></a><span id="l91.16">                                &amp;m_downloadingToTempFile);</span>
<a href="#l91.17"></a><span id="l91.17">   }</span>
<a href="#l91.18"></a><span id="l91.18"> </span>
<a href="#l91.19"></a><span id="l91.19">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l91.20"></a><span id="l91.20"> </span>
<a href="#l91.21"></a><span id="l91.21">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_popServer);</span>
<a href="#l91.22"></a><span id="l91.22">   if (!server) return NS_ERROR_UNEXPECTED;</span>
<a href="#l91.23"></a><span id="l91.23" class="difflineat">@@ -519,18 +518,17 @@ nsPop3Sink::IncorporateBegin(const char*</span>
<a href="#l91.24"></a><span id="l91.24"> </span>
<a href="#l91.25"></a><span id="l91.25">   // WriteLineToMailbox(&quot;X-Mozilla-Status: 8000&quot; MSG_LINEBREAK);</span>
<a href="#l91.26"></a><span id="l91.26">   char* statusLine = PR_smprintf(X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, flags);</span>
<a href="#l91.27"></a><span id="l91.27">   outputString.Assign(statusLine);</span>
<a href="#l91.28"></a><span id="l91.28">   rv = WriteLineToMailbox(outputString);</span>
<a href="#l91.29"></a><span id="l91.29">   PR_smprintf_free(statusLine);</span>
<a href="#l91.30"></a><span id="l91.30">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l91.31"></a><span id="l91.31"> </span>
<a href="#l91.32"></a><span id="l91.32" class="difflineminus">-  rv = WriteLineToMailbox(</span>
<a href="#l91.33"></a><span id="l91.33" class="difflineminus">-      NS_LITERAL_CSTRING(&quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK));</span>
<a href="#l91.34"></a><span id="l91.34" class="difflineplus">+  rv = WriteLineToMailbox(&quot;X-Mozilla-Status2: 00000000&quot;_ns MSG_LINEBREAK);</span>
<a href="#l91.35"></a><span id="l91.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l91.36"></a><span id="l91.36"> </span>
<a href="#l91.37"></a><span id="l91.37">   // leave space for 60 bytes worth of keys/tags</span>
<a href="#l91.38"></a><span id="l91.38">   rv = WriteLineToMailbox(NS_LITERAL_CSTRING(X_MOZILLA_KEYWORDS));</span>
<a href="#l91.39"></a><span id="l91.39">   return NS_OK;</span>
<a href="#l91.40"></a><span id="l91.40"> }</span>
<a href="#l91.41"></a><span id="l91.41"> </span>
<a href="#l91.42"></a><span id="l91.42"> NS_IMETHODIMP</span>
<a href="#l91.43"></a><span id="l91.43" class="difflineat">@@ -635,19 +633,18 @@ nsresult nsPop3Sink::WriteLineToMailbox(</span>
<a href="#l91.44"></a><span id="l91.44">                &quot;seekableOutStream-&gt;Tell(&amp;after_seek_pos) failed&quot;);</span>
<a href="#l91.45"></a><span id="l91.45"> </span>
<a href="#l91.46"></a><span id="l91.46">     if (NS_SUCCEEDED(rv2) &amp;&amp; NS_SUCCEEDED(rv3)) {</span>
<a href="#l91.47"></a><span id="l91.47">       if (before_seek_pos != after_seek_pos) {</span>
<a href="#l91.48"></a><span id="l91.48">         nsString folderName;</span>
<a href="#l91.49"></a><span id="l91.49">         if (m_folder) m_folder-&gt;GetPrettyName(folderName);</span>
<a href="#l91.50"></a><span id="l91.50">         // This merits a console message, it's poor man's telemetry.</span>
<a href="#l91.51"></a><span id="l91.51">         MsgLogToConsole4(</span>
<a href="#l91.52"></a><span id="l91.52" class="difflineminus">-            NS_LITERAL_STRING(&quot;Unexpected file position change detected&quot;) +</span>
<a href="#l91.53"></a><span id="l91.53" class="difflineminus">-                (folderName.IsEmpty() ? EmptyString()</span>
<a href="#l91.54"></a><span id="l91.54" class="difflineminus">-                                      : NS_LITERAL_STRING(&quot; in folder &quot;)) +</span>
<a href="#l91.55"></a><span id="l91.55" class="difflineplus">+            u&quot;Unexpected file position change detected&quot;_ns +</span>
<a href="#l91.56"></a><span id="l91.56" class="difflineplus">+                (folderName.IsEmpty() ? EmptyString() : u&quot; in folder &quot;_ns) +</span>
<a href="#l91.57"></a><span id="l91.57">                 (folderName.IsEmpty() ? EmptyString() : folderName) +</span>
<a href="#l91.58"></a><span id="l91.58">                 NS_LITERAL_STRING(</span>
<a href="#l91.59"></a><span id="l91.59">                     &quot;. &quot;</span>
<a href="#l91.60"></a><span id="l91.60">                     &quot;If you can reliably reproduce this, please report the &quot;</span>
<a href="#l91.61"></a><span id="l91.61">                     &quot;steps you used to dev-apps-thunderbird@lists.mozilla.org &quot;</span>
<a href="#l91.62"></a><span id="l91.62">                     &quot;or to bug 1308335 at bugzilla.mozilla.org. &quot;</span>
<a href="#l91.63"></a><span id="l91.63">                     &quot;Resolving this problem will allow speeding up message &quot;</span>
<a href="#l91.64"></a><span id="l91.64">                     &quot;downloads.&quot;),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -61,26 +61,26 @@ nsresult nsRssIncomingServer::FillInData</span>
<a href="#l92.4"></a><span id="l92.4">   // Append the name of the subscriptions data source.</span>
<a href="#l92.5"></a><span id="l92.5">   rv = localFile-&gt;Append(aDataSourceName);</span>
<a href="#l92.6"></a><span id="l92.6">   localFile.forget(aLocation);</span>
<a href="#l92.7"></a><span id="l92.7">   return rv;</span>
<a href="#l92.8"></a><span id="l92.8"> }</span>
<a href="#l92.9"></a><span id="l92.9"> </span>
<a href="#l92.10"></a><span id="l92.10"> // nsIRSSIncomingServer methods</span>
<a href="#l92.11"></a><span id="l92.11"> NS_IMETHODIMP nsRssIncomingServer::GetSubscriptionsPath(nsIFile** aLocation) {</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-  return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeds.json&quot;), aLocation);</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+  return FillInDataSourcePath(u&quot;feeds.json&quot;_ns, aLocation);</span>
<a href="#l92.14"></a><span id="l92.14"> }</span>
<a href="#l92.15"></a><span id="l92.15"> </span>
<a href="#l92.16"></a><span id="l92.16"> NS_IMETHODIMP nsRssIncomingServer::GetFeedItemsPath(nsIFile** aLocation) {</span>
<a href="#l92.17"></a><span id="l92.17" class="difflineminus">-  return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeditems.json&quot;), aLocation);</span>
<a href="#l92.18"></a><span id="l92.18" class="difflineplus">+  return FillInDataSourcePath(u&quot;feeditems.json&quot;_ns, aLocation);</span>
<a href="#l92.19"></a><span id="l92.19"> }</span>
<a href="#l92.20"></a><span id="l92.20"> </span>
<a href="#l92.21"></a><span id="l92.21"> NS_IMETHODIMP nsRssIncomingServer::CreateDefaultMailboxes() {</span>
<a href="#l92.22"></a><span id="l92.22">   // For Feeds, all we have is Trash.</span>
<a href="#l92.23"></a><span id="l92.23" class="difflineminus">-  return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l92.24"></a><span id="l92.24" class="difflineplus">+  return CreateLocalFolder(u&quot;Trash&quot;_ns);</span>
<a href="#l92.25"></a><span id="l92.25"> }</span>
<a href="#l92.26"></a><span id="l92.26"> </span>
<a href="#l92.27"></a><span id="l92.27"> NS_IMETHODIMP nsRssIncomingServer::SetFlagsOnDefaultMailboxes() {</span>
<a href="#l92.28"></a><span id="l92.28">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l92.29"></a><span id="l92.29">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l92.30"></a><span id="l92.30">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l92.31"></a><span id="l92.31"> </span>
<a href="#l92.32"></a><span id="l92.32">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -381,17 +381,17 @@ nsresult nsMapiHook::HandleAttachments(n</span>
<a href="#l93.4"></a><span id="l93.4">         return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l93.5"></a><span id="l93.5"> </span>
<a href="#l93.6"></a><span id="l93.6">       // Temp Directory</span>
<a href="#l93.7"></a><span id="l93.7">       nsCOMPtr&lt;nsIFile&gt; pTempDir;</span>
<a href="#l93.8"></a><span id="l93.8">       NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(pTempDir));</span>
<a href="#l93.9"></a><span id="l93.9"> </span>
<a href="#l93.10"></a><span id="l93.10">       // create a new sub directory called moz_mapi underneath the temp</span>
<a href="#l93.11"></a><span id="l93.11">       // directory</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-      pTempDir-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineplus">+      pTempDir-&gt;AppendRelativePath(u&quot;moz_mapi&quot;_ns);</span>
<a href="#l93.14"></a><span id="l93.14">       pTempDir-&gt;Exists(&amp;bExist);</span>
<a href="#l93.15"></a><span id="l93.15">       if (!bExist) {</span>
<a href="#l93.16"></a><span id="l93.16">         rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777);</span>
<a href="#l93.17"></a><span id="l93.17">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l93.18"></a><span id="l93.18">       }</span>
<a href="#l93.19"></a><span id="l93.19"> </span>
<a href="#l93.20"></a><span id="l93.20">       // rename or copy the existing temp file with the real file name</span>
<a href="#l93.21"></a><span id="l93.21"> </span>
<a href="#l93.22"></a><span id="l93.22" class="difflineat">@@ -496,17 +496,17 @@ nsresult nsMapiHook::HandleAttachmentsW(</span>
<a href="#l93.23"></a><span id="l93.23">         return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l93.24"></a><span id="l93.24"> </span>
<a href="#l93.25"></a><span id="l93.25">       // Temp Directory.</span>
<a href="#l93.26"></a><span id="l93.26">       nsCOMPtr&lt;nsIFile&gt; pTempDir;</span>
<a href="#l93.27"></a><span id="l93.27">       NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(pTempDir));</span>
<a href="#l93.28"></a><span id="l93.28"> </span>
<a href="#l93.29"></a><span id="l93.29">       // Create a new sub directory called moz_mapi underneath the temp</span>
<a href="#l93.30"></a><span id="l93.30">       // directory.</span>
<a href="#l93.31"></a><span id="l93.31" class="difflineminus">-      pTempDir-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l93.32"></a><span id="l93.32" class="difflineplus">+      pTempDir-&gt;AppendRelativePath(u&quot;moz_mapi&quot;_ns);</span>
<a href="#l93.33"></a><span id="l93.33">       pTempDir-&gt;Exists(&amp;bExist);</span>
<a href="#l93.34"></a><span id="l93.34">       if (!bExist) {</span>
<a href="#l93.35"></a><span id="l93.35">         rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777);</span>
<a href="#l93.36"></a><span id="l93.36">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l93.37"></a><span id="l93.37">       }</span>
<a href="#l93.38"></a><span id="l93.38"> </span>
<a href="#l93.39"></a><span id="l93.39">       // Rename or copy the existing temp file with the real file name.</span>
<a href="#l93.40"></a><span id="l93.40"> </span>
<a href="#l93.41"></a><span id="l93.41" class="difflineat">@@ -805,17 +805,17 @@ nsresult nsMapiHook::PopulateCompFieldsF</span>
<a href="#l93.42"></a><span id="l93.42">     char* newFilePaths = (char*)strFilePaths.get();</span>
<a href="#l93.43"></a><span id="l93.43">     while (offset != kNotFound) {</span>
<a href="#l93.44"></a><span id="l93.44">       // Temp Directory</span>
<a href="#l93.45"></a><span id="l93.45">       nsCOMPtr&lt;nsIFile&gt; pTempDir;</span>
<a href="#l93.46"></a><span id="l93.46">       NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(pTempDir));</span>
<a href="#l93.47"></a><span id="l93.47"> </span>
<a href="#l93.48"></a><span id="l93.48">       // if not already existing, create another temp dir for mapi within Win</span>
<a href="#l93.49"></a><span id="l93.49">       // temp dir this is windows only so we can do &quot;\\&quot;</span>
<a href="#l93.50"></a><span id="l93.50" class="difflineminus">-      pTempDir-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l93.51"></a><span id="l93.51" class="difflineplus">+      pTempDir-&gt;AppendRelativePath(u&quot;moz_mapi&quot;_ns);</span>
<a href="#l93.52"></a><span id="l93.52">       pTempDir-&gt;Exists(&amp;bExist);</span>
<a href="#l93.53"></a><span id="l93.53">       if (!bExist) {</span>
<a href="#l93.54"></a><span id="l93.54">         rv = pTempDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 777);</span>
<a href="#l93.55"></a><span id="l93.55">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l93.56"></a><span id="l93.56">       }</span>
<a href="#l93.57"></a><span id="l93.57"> </span>
<a href="#l93.58"></a><span id="l93.58">       nsAutoCString RemainingPaths;</span>
<a href="#l93.59"></a><span id="l93.59">       RemainingPaths.Assign(newFilePaths);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeBaseEmitter.cpp</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeBaseEmitter.cpp</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -515,17 +515,17 @@ nsMimeBaseEmitter::UpdateCharacterSet(co</span>
<a href="#l94.4"></a><span id="l94.4"> </span>
<a href="#l94.5"></a><span id="l94.5">           ++ptr;</span>
<a href="#l94.6"></a><span id="l94.6">         }</span>
<a href="#l94.7"></a><span id="l94.7">       }</span>
<a href="#l94.8"></a><span id="l94.8"> </span>
<a href="#l94.9"></a><span id="l94.9">       // have to set content-type since it could have an embedded null byte</span>
<a href="#l94.10"></a><span id="l94.10">       mChannel-&gt;SetContentType(nsDependentCString(cBegin));</span>
<a href="#l94.11"></a><span id="l94.11">       if (PL_strcasecmp(aCharset, &quot;US-ASCII&quot;) == 0) {</span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-        mChannel-&gt;SetContentCharset(NS_LITERAL_CSTRING(&quot;ISO-8859-1&quot;));</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineplus">+        mChannel-&gt;SetContentCharset(&quot;ISO-8859-1&quot;_ns);</span>
<a href="#l94.14"></a><span id="l94.14">       } else {</span>
<a href="#l94.15"></a><span id="l94.15">         mChannel-&gt;SetContentCharset(nsDependentCString(aCharset));</span>
<a href="#l94.16"></a><span id="l94.16">       }</span>
<a href="#l94.17"></a><span id="l94.17">     }</span>
<a href="#l94.18"></a><span id="l94.18">   }</span>
<a href="#l94.19"></a><span id="l94.19"> </span>
<a href="#l94.20"></a><span id="l94.20">   return NS_OK;</span>
<a href="#l94.21"></a><span id="l94.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/mailnews/mime/src/mimeTextHTMLParsed.cpp</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/mailnews/mime/src/mimeTextHTMLParsed.cpp</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -88,17 +88,17 @@ static int MimeInlineTextHTMLParsed_pars</span>
<a href="#l95.4"></a><span id="l95.4">       rawHTML, mozilla::dom::SupportedType::Text_html, rv2);</span>
<a href="#l95.5"></a><span id="l95.5">   if (rv2.Failed()) return -1;</span>
<a href="#l95.6"></a><span id="l95.6"> </span>
<a href="#l95.7"></a><span id="l95.7">   // Serialize it back to HTML source again.</span>
<a href="#l95.8"></a><span id="l95.8">   nsCOMPtr&lt;nsIDocumentEncoder&gt; encoder = do_createDocumentEncoder(&quot;text/html&quot;);</span>
<a href="#l95.9"></a><span id="l95.9">   NS_ENSURE_TRUE(encoder, -1);</span>
<a href="#l95.10"></a><span id="l95.10">   uint32_t aFlags = nsIDocumentEncoder::OutputRaw |</span>
<a href="#l95.11"></a><span id="l95.11">                     nsIDocumentEncoder::OutputDisallowLineBreaking;</span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-  rv = encoder-&gt;Init(document, NS_LITERAL_STRING(&quot;text/html&quot;), aFlags);</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineplus">+  rv = encoder-&gt;Init(document, u&quot;text/html&quot;_ns, aFlags);</span>
<a href="#l95.14"></a><span id="l95.14">   NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l95.15"></a><span id="l95.15">   rv = encoder-&gt;EncodeToString(parsed);</span>
<a href="#l95.16"></a><span id="l95.16">   NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l95.17"></a><span id="l95.17"> </span>
<a href="#l95.18"></a><span id="l95.18">   bool stripConditionalCSS = mozilla::Preferences::GetBool(</span>
<a href="#l95.19"></a><span id="l95.19">       &quot;mail.html_sanitize.drop_conditional_css&quot;, true);</span>
<a href="#l95.20"></a><span id="l95.20"> </span>
<a href="#l95.21"></a><span id="l95.21">   nsCString resultCStr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -179,18 +179,18 @@ nsresult CreateComposeParams(nsCOMPtr&lt;ns</span>
<a href="#l96.4"></a><span id="l96.4"> </span>
<a href="#l96.5"></a><span id="l96.5">     while (curAttachment &amp;&amp; curAttachment-&gt;m_url) {</span>
<a href="#l96.6"></a><span id="l96.6">       rv = curAttachment-&gt;m_url-&gt;GetSpec(spec);</span>
<a href="#l96.7"></a><span id="l96.7">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l96.8"></a><span id="l96.8">         nsCOMPtr&lt;nsIMsgAttachment&gt; attachment =</span>
<a href="#l96.9"></a><span id="l96.9">             do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l96.10"></a><span id="l96.10">         if (NS_SUCCEEDED(rv) &amp;&amp; attachment) {</span>
<a href="#l96.11"></a><span id="l96.11">           nsAutoString nameStr;</span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-          rv = nsMsgI18NConvertToUnicode(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineminus">-                                         curAttachment-&gt;m_realName, nameStr);</span>
<a href="#l96.14"></a><span id="l96.14" class="difflineplus">+          rv = nsMsgI18NConvertToUnicode(&quot;UTF-8&quot;_ns, curAttachment-&gt;m_realName,</span>
<a href="#l96.15"></a><span id="l96.15" class="difflineplus">+                                         nameStr);</span>
<a href="#l96.16"></a><span id="l96.16">           if (NS_FAILED(rv))</span>
<a href="#l96.17"></a><span id="l96.17">             CopyASCIItoUTF16(curAttachment-&gt;m_realName, nameStr);</span>
<a href="#l96.18"></a><span id="l96.18">           attachment-&gt;SetName(nameStr);</span>
<a href="#l96.19"></a><span id="l96.19">           attachment-&gt;SetUrl(spec);</span>
<a href="#l96.20"></a><span id="l96.20">           attachment-&gt;SetTemporary(true);</span>
<a href="#l96.21"></a><span id="l96.21">           attachment-&gt;SetContentType(curAttachment-&gt;m_realType.get());</span>
<a href="#l96.22"></a><span id="l96.22">           attachment-&gt;SetMacType(curAttachment-&gt;m_xMacType.get());</span>
<a href="#l96.23"></a><span id="l96.23">           attachment-&gt;SetMacCreator(curAttachment-&gt;m_xMacCreator.get());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/mailnews/mime/src/mimeebod.cpp</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/mailnews/mime/src/mimeebod.cpp</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -150,17 +150,17 @@ char* MimeExternalBody_make_url(const ch</span>
<a href="#l97.4"></a><span id="l97.4">     if (!name) return 0;</span>
<a href="#l97.5"></a><span id="l97.5"> </span>
<a href="#l97.6"></a><span id="l97.6"> #ifdef XP_UNIX</span>
<a href="#l97.7"></a><span id="l97.7">     if (!PL_strcasecmp(at, &quot;afs&quot;)) /* only if there is a /afs/ directory */</span>
<a href="#l97.8"></a><span id="l97.8">     {</span>
<a href="#l97.9"></a><span id="l97.9">       nsCOMPtr&lt;nsIFile&gt; fs = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l97.10"></a><span id="l97.10">       bool exists = false;</span>
<a href="#l97.11"></a><span id="l97.11">       if (fs) {</span>
<a href="#l97.12"></a><span id="l97.12" class="difflineminus">-        fs-&gt;InitWithNativePath(NS_LITERAL_CSTRING(&quot;/afs/.&quot;));</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineplus">+        fs-&gt;InitWithNativePath(&quot;/afs/.&quot;_ns);</span>
<a href="#l97.14"></a><span id="l97.14">         fs-&gt;Exists(&amp;exists);</span>
<a href="#l97.15"></a><span id="l97.15">       }</span>
<a href="#l97.16"></a><span id="l97.16">       if (!exists) return 0;</span>
<a href="#l97.17"></a><span id="l97.17">     }</span>
<a href="#l97.18"></a><span id="l97.18"> #else  /* !XP_UNIX */</span>
<a href="#l97.19"></a><span id="l97.19">     return 0; /* never, if not Unix. */</span>
<a href="#l97.20"></a><span id="l97.20"> #endif /* !XP_UNIX */</span>
<a href="#l97.21"></a><span id="l97.21"> </span>
<a href="#l97.22"></a><span id="l97.22" class="difflineat">@@ -421,17 +421,17 @@ static bool MimeExternalBody_displayable</span>
<a href="#l97.23"></a><span id="l97.23">            !PL_strcasecmp(at, &quot;mail-server&quot;) || !PL_strcasecmp(at, &quot;url&quot;))</span>
<a href="#l97.24"></a><span id="l97.24">     inline_p = true;</span>
<a href="#l97.25"></a><span id="l97.25"> #ifdef XP_UNIX</span>
<a href="#l97.26"></a><span id="l97.26">   else if (!PL_strcasecmp(at, &quot;afs&quot;)) /* only if there is a /afs/ directory */</span>
<a href="#l97.27"></a><span id="l97.27">   {</span>
<a href="#l97.28"></a><span id="l97.28">     nsCOMPtr&lt;nsIFile&gt; fs = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l97.29"></a><span id="l97.29">     bool exists = false;</span>
<a href="#l97.30"></a><span id="l97.30">     if (fs) {</span>
<a href="#l97.31"></a><span id="l97.31" class="difflineminus">-      fs-&gt;InitWithNativePath(NS_LITERAL_CSTRING(&quot;/afs/.&quot;));</span>
<a href="#l97.32"></a><span id="l97.32" class="difflineplus">+      fs-&gt;InitWithNativePath(&quot;/afs/.&quot;_ns);</span>
<a href="#l97.33"></a><span id="l97.33">       fs-&gt;Exists(&amp;exists);</span>
<a href="#l97.34"></a><span id="l97.34">     }</span>
<a href="#l97.35"></a><span id="l97.35">     if (!exists) return 0;</span>
<a href="#l97.36"></a><span id="l97.36"> </span>
<a href="#l97.37"></a><span id="l97.37">     inline_p = true;</span>
<a href="#l97.38"></a><span id="l97.38">   }</span>
<a href="#l97.39"></a><span id="l97.39"> #endif /* XP_UNIX */</span>
<a href="#l97.40"></a><span id="l97.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -132,17 +132,17 @@ nsresult ProcessBodyAsAttachment(MimeObj</span>
<a href="#l98.4"></a><span id="l98.4">       // generic name.</span>
<a href="#l98.5"></a><span id="l98.5">       tmp-&gt;m_realName = &quot;AttachedMessage.eml&quot;;</span>
<a href="#l98.6"></a><span id="l98.6">     }</span>
<a href="#l98.7"></a><span id="l98.7">   }</span>
<a href="#l98.8"></a><span id="l98.8"> </span>
<a href="#l98.9"></a><span id="l98.9">   tmp-&gt;m_hasFilename = !tmp-&gt;m_realName.IsEmpty();</span>
<a href="#l98.10"></a><span id="l98.10"> </span>
<a href="#l98.11"></a><span id="l98.11">   if (tmp-&gt;m_realName.IsEmpty() &amp;&amp;</span>
<a href="#l98.12"></a><span id="l98.12" class="difflineminus">-      StringBeginsWith(tmp-&gt;m_realType, NS_LITERAL_CSTRING(&quot;text&quot;),</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+      StringBeginsWith(tmp-&gt;m_realType, &quot;text&quot;_ns,</span>
<a href="#l98.14"></a><span id="l98.14">                        nsCaseInsensitiveCStringComparator))</span>
<a href="#l98.15"></a><span id="l98.15">     ValidateRealName(tmp, child-&gt;headers);</span>
<a href="#l98.16"></a><span id="l98.16"> </span>
<a href="#l98.17"></a><span id="l98.17">   tmp-&gt;m_displayableInline =</span>
<a href="#l98.18"></a><span id="l98.18">       obj-&gt;clazz-&gt;displayable_inline_p(obj-&gt;clazz, obj-&gt;headers);</span>
<a href="#l98.19"></a><span id="l98.19"> </span>
<a href="#l98.20"></a><span id="l98.20">   char* tmpURL = nullptr;</span>
<a href="#l98.21"></a><span id="l98.21">   char* id = nullptr;</span>
<a href="#l98.22"></a><span id="l98.22" class="difflineat">@@ -212,17 +212,17 @@ void ValidateRealName(nsMsgAttachmentDat</span>
<a href="#l98.23"></a><span id="l98.23">   // Sanity.</span>
<a href="#l98.24"></a><span id="l98.24">   if (!aAttach) return;</span>
<a href="#l98.25"></a><span id="l98.25"> </span>
<a href="#l98.26"></a><span id="l98.26">   // Do we need to validate?</span>
<a href="#l98.27"></a><span id="l98.27">   if (!aAttach-&gt;m_realName.IsEmpty()) return;</span>
<a href="#l98.28"></a><span id="l98.28"> </span>
<a href="#l98.29"></a><span id="l98.29">   // Internal MIME structures need not be named!</span>
<a href="#l98.30"></a><span id="l98.30">   if (aAttach-&gt;m_realType.IsEmpty() ||</span>
<a href="#l98.31"></a><span id="l98.31" class="difflineminus">-      StringBeginsWith(aAttach-&gt;m_realType, NS_LITERAL_CSTRING(&quot;multipart&quot;),</span>
<a href="#l98.32"></a><span id="l98.32" class="difflineplus">+      StringBeginsWith(aAttach-&gt;m_realType, &quot;multipart&quot;_ns,</span>
<a href="#l98.33"></a><span id="l98.33">                        nsCaseInsensitiveCStringComparator))</span>
<a href="#l98.34"></a><span id="l98.34">     return;</span>
<a href="#l98.35"></a><span id="l98.35"> </span>
<a href="#l98.36"></a><span id="l98.36">   //</span>
<a href="#l98.37"></a><span id="l98.37">   // Now validate any other name we have for the attachment!</span>
<a href="#l98.38"></a><span id="l98.38">   //</span>
<a href="#l98.39"></a><span id="l98.39">   if (aAttach-&gt;m_realName.IsEmpty()) {</span>
<a href="#l98.40"></a><span id="l98.40">     aAttach-&gt;m_realName = &quot;attachment&quot;;</span>
<a href="#l98.41"></a><span id="l98.41" class="difflineat">@@ -295,17 +295,17 @@ nsresult GenerateAttachmentData(MimeObje</span>
<a href="#l98.42"></a><span id="l98.42"> </span>
<a href="#l98.43"></a><span id="l98.43">   nsMsgAttachmentData* tmp = &amp;(aAttachData[attIndex++]);</span>
<a href="#l98.44"></a><span id="l98.44"> </span>
<a href="#l98.45"></a><span id="l98.45">   tmp-&gt;m_realType = object-&gt;content_type;</span>
<a href="#l98.46"></a><span id="l98.46">   tmp-&gt;m_realEncoding = object-&gt;encoding;</span>
<a href="#l98.47"></a><span id="l98.47">   tmp-&gt;m_isExternalAttachment = isExternalAttachment;</span>
<a href="#l98.48"></a><span id="l98.48">   tmp-&gt;m_isExternalLinkAttachment =</span>
<a href="#l98.49"></a><span id="l98.49">       (isExternalAttachment &amp;&amp;</span>
<a href="#l98.50"></a><span id="l98.50" class="difflineminus">-       StringBeginsWith(urlString, NS_LITERAL_CSTRING(&quot;http&quot;),</span>
<a href="#l98.51"></a><span id="l98.51" class="difflineplus">+       StringBeginsWith(urlString, &quot;http&quot;_ns,</span>
<a href="#l98.52"></a><span id="l98.52">                         nsCaseInsensitiveCStringComparator));</span>
<a href="#l98.53"></a><span id="l98.53">   tmp-&gt;m_size = attSize;</span>
<a href="#l98.54"></a><span id="l98.54">   tmp-&gt;m_sizeExternalStr = &quot;-1&quot;;</span>
<a href="#l98.55"></a><span id="l98.55">   tmp-&gt;m_disposition.Adopt(MimeHeaders_get(</span>
<a href="#l98.56"></a><span id="l98.56">       object-&gt;headers, HEADER_CONTENT_DISPOSITION, true, false));</span>
<a href="#l98.57"></a><span id="l98.57">   tmp-&gt;m_displayableInline =</span>
<a href="#l98.58"></a><span id="l98.58">       object-&gt;clazz-&gt;displayable_inline_p(object-&gt;clazz, object-&gt;headers);</span>
<a href="#l98.59"></a><span id="l98.59"> </span>
<a href="#l98.60"></a><span id="l98.60" class="difflineat">@@ -423,17 +423,17 @@ nsresult GenerateAttachmentData(MimeObje</span>
<a href="#l98.61"></a><span id="l98.61">     urlString.AppendLiteral(&quot;&amp;filename=&quot;);</span>
<a href="#l98.62"></a><span id="l98.62">     nsAutoCString aResult;</span>
<a href="#l98.63"></a><span id="l98.63">     if (NS_SUCCEEDED(MsgEscapeString(tmp-&gt;m_realName,</span>
<a href="#l98.64"></a><span id="l98.64">                                      nsINetUtil::ESCAPE_XALPHAS, aResult)))</span>
<a href="#l98.65"></a><span id="l98.65">       urlString.Append(aResult);</span>
<a href="#l98.66"></a><span id="l98.66">     else</span>
<a href="#l98.67"></a><span id="l98.67">       urlString.Append(tmp-&gt;m_realName);</span>
<a href="#l98.68"></a><span id="l98.68">     if (tmp-&gt;m_realType.EqualsLiteral(&quot;message/rfc822&quot;) &amp;&amp;</span>
<a href="#l98.69"></a><span id="l98.69" class="difflineminus">-        !StringEndsWith(urlString, NS_LITERAL_CSTRING(&quot;.eml&quot;),</span>
<a href="#l98.70"></a><span id="l98.70" class="difflineplus">+        !StringEndsWith(urlString, &quot;.eml&quot;_ns,</span>
<a href="#l98.71"></a><span id="l98.71">                         nsCaseInsensitiveCStringComparator))</span>
<a href="#l98.72"></a><span id="l98.72">       urlString.AppendLiteral(&quot;.eml&quot;);</span>
<a href="#l98.73"></a><span id="l98.73">   } else if (tmp-&gt;m_isExternalAttachment) {</span>
<a href="#l98.74"></a><span id="l98.74">     // Allows the JS mime emitter to figure out the part information.</span>
<a href="#l98.75"></a><span id="l98.75">     urlString.AppendLiteral(&quot;?part=&quot;);</span>
<a href="#l98.76"></a><span id="l98.76">     urlString.Append(part);</span>
<a href="#l98.77"></a><span id="l98.77">   } else if (tmp-&gt;m_realType.LowerCaseEqualsLiteral(MESSAGE_RFC822)) {</span>
<a href="#l98.78"></a><span id="l98.78">     // Special case...if this is a enclosed RFC822 message, give it a nice</span>
<a href="#l98.79"></a><span id="l98.79" class="difflineat">@@ -703,18 +703,17 @@ extern &quot;C&quot; nsresult SetMailCharacterSetT</span>
<a href="#l98.80"></a><span id="l98.80">         if (uri) {</span>
<a href="#l98.81"></a><span id="l98.81">           nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(uri));</span>
<a href="#l98.82"></a><span id="l98.82">           if (msgurl) {</span>
<a href="#l98.83"></a><span id="l98.83">             nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l98.84"></a><span id="l98.84">             msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l98.85"></a><span id="l98.85">             if (msgWindow)</span>
<a href="#l98.86"></a><span id="l98.86">               rv = msgWindow-&gt;SetMailCharacterSet(</span>
<a href="#l98.87"></a><span id="l98.87">                   !PL_strcasecmp(aCharacterSet, &quot;us-ascii&quot;)</span>
<a href="#l98.88"></a><span id="l98.88" class="difflineminus">-                      ? static_cast&lt;const nsCString&amp;&gt;(</span>
<a href="#l98.89"></a><span id="l98.89" class="difflineminus">-                            NS_LITERAL_CSTRING(&quot;ISO-8859-1&quot;))</span>
<a href="#l98.90"></a><span id="l98.90" class="difflineplus">+                      ? static_cast&lt;const nsCString&amp;&gt;(&quot;ISO-8859-1&quot;_ns)</span>
<a href="#l98.91"></a><span id="l98.91">                       : static_cast&lt;const nsCString&amp;&gt;(</span>
<a href="#l98.92"></a><span id="l98.92">                             nsDependentCString(aCharacterSet)));</span>
<a href="#l98.93"></a><span id="l98.93">           }</span>
<a href="#l98.94"></a><span id="l98.94">         }</span>
<a href="#l98.95"></a><span id="l98.95">       }</span>
<a href="#l98.96"></a><span id="l98.96">     }</span>
<a href="#l98.97"></a><span id="l98.97">   }</span>
<a href="#l98.98"></a><span id="l98.98"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1" class="difflineminus">--- a/mailnews/mime/src/mimemult.cpp</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineplus">+++ b/mailnews/mime/src/mimemult.cpp</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineat">@@ -219,52 +219,52 @@ static int MimeMultipart_parse_line(cons</span>
<a href="#l99.4"></a><span id="l99.4"> </span>
<a href="#l99.5"></a><span id="l99.5">             nsAutoCString fileName;</span>
<a href="#l99.6"></a><span id="l99.6">             fileName.Adopt(MimeHeaders_get_name(mult-&gt;hdrs, obj-&gt;options));</span>
<a href="#l99.7"></a><span id="l99.7">             // clang-format off</span>
<a href="#l99.8"></a><span id="l99.8">             if (detachingPart) {</span>
<a href="#l99.9"></a><span id="l99.9">               char *contentType =</span>
<a href="#l99.10"></a><span id="l99.10">                   MimeHeaders_get(mult-&gt;hdrs, &quot;Content-Type&quot;, false, false);</span>
<a href="#l99.11"></a><span id="l99.11">               if (contentType) {</span>
<a href="#l99.12"></a><span id="l99.12" class="difflineminus">-                MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;Content-Type: &quot;));</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineplus">+                MimeWriteAString(obj, &quot;Content-Type: &quot;_ns);</span>
<a href="#l99.14"></a><span id="l99.14">                 MimeWriteAString(obj, nsDependentCString(contentType));</span>
<a href="#l99.15"></a><span id="l99.15">                 PR_Free(contentType);</span>
<a href="#l99.16"></a><span id="l99.16">               }</span>
<a href="#l99.17"></a><span id="l99.17">               MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l99.18"></a><span id="l99.18" class="difflineminus">-              MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;Content-Disposition: attachment; filename=\&quot;&quot;));</span>
<a href="#l99.19"></a><span id="l99.19" class="difflineplus">+              MimeWriteAString(obj, &quot;Content-Disposition: attachment; filename=\&quot;&quot;_ns);</span>
<a href="#l99.20"></a><span id="l99.20">               MimeWriteAString(obj, fileName);</span>
<a href="#l99.21"></a><span id="l99.21" class="difflineminus">-              MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK));</span>
<a href="#l99.22"></a><span id="l99.22" class="difflineminus">-              MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;X-Mozilla-External-Attachment-URL: &quot;));</span>
<a href="#l99.23"></a><span id="l99.23" class="difflineplus">+              MimeWriteAString(obj, &quot;\&quot;&quot;_ns MSG_LINEBREAK);</span>
<a href="#l99.24"></a><span id="l99.24" class="difflineplus">+              MimeWriteAString(obj, &quot;X-Mozilla-External-Attachment-URL: &quot;_ns);</span>
<a href="#l99.25"></a><span id="l99.25">               MimeWriteAString(obj, obj-&gt;options-&gt;state-&gt;detachedFilePath);</span>
<a href="#l99.26"></a><span id="l99.26">               MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l99.27"></a><span id="l99.27" class="difflineminus">-              MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;X-Mozilla-Altered: AttachmentDetached; date=\&quot;&quot;));</span>
<a href="#l99.28"></a><span id="l99.28" class="difflineplus">+              MimeWriteAString(obj, &quot;X-Mozilla-Altered: AttachmentDetached; date=\&quot;&quot;_ns);</span>
<a href="#l99.29"></a><span id="l99.29">             } else {</span>
<a href="#l99.30"></a><span id="l99.30">               nsAutoCString header(&quot;Content-Type: text/x-moz-deleted; name=\&quot;Deleted: &quot;);</span>
<a href="#l99.31"></a><span id="l99.31">               header.Append(fileName);</span>
<a href="#l99.32"></a><span id="l99.32">               status = MimeWriteAString(obj, header);</span>
<a href="#l99.33"></a><span id="l99.33">               if (status &lt; 0) return status;</span>
<a href="#l99.34"></a><span id="l99.34" class="difflineminus">-              status = MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK</span>
<a href="#l99.35"></a><span id="l99.35" class="difflineminus">-                                                 &quot;Content-Transfer-Encoding: 8bit&quot; MSG_LINEBREAK));</span>
<a href="#l99.36"></a><span id="l99.36" class="difflineplus">+              status = MimeWriteAString(obj, &quot;\&quot;&quot;_ns MSG_LINEBREAK</span>
<a href="#l99.37"></a><span id="l99.37" class="difflineplus">+                                                 &quot;Content-Transfer-Encoding: 8bit&quot;_ns MSG_LINEBREAK);</span>
<a href="#l99.38"></a><span id="l99.38">               MimeWriteAString(obj, NS_LITERAL_CSTRING(</span>
<a href="#l99.39"></a><span id="l99.39">                                         &quot;Content-Disposition: inline; filename=\&quot;Deleted: &quot;));</span>
<a href="#l99.40"></a><span id="l99.40">               MimeWriteAString(obj, fileName);</span>
<a href="#l99.41"></a><span id="l99.41" class="difflineminus">-              MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK</span>
<a href="#l99.42"></a><span id="l99.42" class="difflineminus">-                                        &quot;X-Mozilla-Altered: AttachmentDeleted; date=\&quot;&quot;));</span>
<a href="#l99.43"></a><span id="l99.43" class="difflineplus">+              MimeWriteAString(obj, &quot;\&quot;&quot;_ns MSG_LINEBREAK</span>
<a href="#l99.44"></a><span id="l99.44" class="difflineplus">+                                        &quot;X-Mozilla-Altered: AttachmentDeleted; date=\&quot;&quot;_ns);</span>
<a href="#l99.45"></a><span id="l99.45">             }</span>
<a href="#l99.46"></a><span id="l99.46">             nsCString result;</span>
<a href="#l99.47"></a><span id="l99.47">             char timeBuffer[128];</span>
<a href="#l99.48"></a><span id="l99.48">             PRExplodedTime now;</span>
<a href="#l99.49"></a><span id="l99.49">             PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;now);</span>
<a href="#l99.50"></a><span id="l99.50">             PR_FormatTimeUSEnglish(timeBuffer, sizeof(timeBuffer),</span>
<a href="#l99.51"></a><span id="l99.51">                                    &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;now);</span>
<a href="#l99.52"></a><span id="l99.52">             MimeWriteAString(obj, nsDependentCString(timeBuffer));</span>
<a href="#l99.53"></a><span id="l99.53" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK));</span>
<a href="#l99.54"></a><span id="l99.54" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK</span>
<a href="#l99.55"></a><span id="l99.55" class="difflineminus">-                                      &quot;You deleted an attachment from this message. The original &quot;</span>
<a href="#l99.56"></a><span id="l99.56" class="difflineminus">-                                      &quot;MIME headers for the attachment were:&quot; MSG_LINEBREAK));</span>
<a href="#l99.57"></a><span id="l99.57" class="difflineplus">+            MimeWriteAString(obj, &quot;\&quot;&quot;_ns MSG_LINEBREAK);</span>
<a href="#l99.58"></a><span id="l99.58" class="difflineplus">+            MimeWriteAString(obj, MSG_LINEBREAK</span>
<a href="#l99.59"></a><span id="l99.59" class="difflineplus">+                                      &quot;You deleted an attachment from this message. The original &quot;_ns</span>
<a href="#l99.60"></a><span id="l99.60" class="difflineplus">+                                      &quot;MIME headers for the attachment were:&quot;_ns MSG_LINEBREAK);</span>
<a href="#l99.61"></a><span id="l99.61">             MimeHeaders_write_raw_headers(mult-&gt;hdrs, obj-&gt;options, false);</span>
<a href="#l99.62"></a><span id="l99.62">             // clang-format on</span>
<a href="#l99.63"></a><span id="l99.63">           }</span>
<a href="#l99.64"></a><span id="l99.64">           int32_t old_nchildren = container-&gt;nchildren;</span>
<a href="#l99.65"></a><span id="l99.65">           status = ((MimeMultipartClass*)obj-&gt;clazz)-&gt;create_child(obj);</span>
<a href="#l99.66"></a><span id="l99.66">           if (status &lt; 0) return status;</span>
<a href="#l99.67"></a><span id="l99.67">           NS_ASSERTION(mult-&gt;state != MimeMultipartHeaders,</span>
<a href="#l99.68"></a><span id="l99.68">                        &quot;mult-&gt;state shouldn't be MimeMultipartHeaders&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1" class="difflineminus">--- a/mailnews/mime/src/mimethtm.cpp</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineplus">+++ b/mailnews/mime/src/mimethtm.cpp</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineat">@@ -177,25 +177,24 @@ void MimeInlineTextHTML_insert_lang_div(</span>
<a href="#l100.4"></a><span id="l100.4">   // 1) Users can configure their HTML display via CSS for .moz-text-html.</span>
<a href="#l100.5"></a><span id="l100.5">   // 2) The language group in the 'lang' attribure is used by Gecko to determine</span>
<a href="#l100.6"></a><span id="l100.6">   //    which font to use.</span>
<a href="#l100.7"></a><span id="l100.7">   int32_t fontSize;            // default font size</span>
<a href="#l100.8"></a><span id="l100.8">   int32_t fontSizePercentage;  // size percentage</span>
<a href="#l100.9"></a><span id="l100.9">   nsAutoCString fontLang;      // langgroup of the font.</span>
<a href="#l100.10"></a><span id="l100.10">   if (NS_SUCCEEDED(GetMailNewsFont(obj, false, &amp;fontSize, &amp;fontSizePercentage,</span>
<a href="#l100.11"></a><span id="l100.11">                                    fontLang))) {</span>
<a href="#l100.12"></a><span id="l100.12" class="difflineminus">-    message.Insert(NS_LITERAL_CSTRING(&quot;&lt;div class=\&quot;moz-text-html\&quot; lang=\&quot;&quot;) +</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineminus">-                       fontLang + NS_LITERAL_CSTRING(&quot;\&quot;&gt;&quot;),</span>
<a href="#l100.14"></a><span id="l100.14" class="difflineminus">-                   index);</span>
<a href="#l100.15"></a><span id="l100.15" class="difflineplus">+    message.Insert(</span>
<a href="#l100.16"></a><span id="l100.16" class="difflineplus">+        &quot;&lt;div class=\&quot;moz-text-html\&quot; lang=\&quot;&quot;_ns + fontLang + &quot;\&quot;&gt;&quot;_ns, index);</span>
<a href="#l100.17"></a><span id="l100.17">   } else {</span>
<a href="#l100.18"></a><span id="l100.18" class="difflineminus">-    message.Insert(NS_LITERAL_CSTRING(&quot;&lt;div class=\&quot;moz-text-html\&quot;&gt;&quot;), index);</span>
<a href="#l100.19"></a><span id="l100.19" class="difflineplus">+    message.Insert(&quot;&lt;div class=\&quot;moz-text-html\&quot;&gt;&quot;_ns, index);</span>
<a href="#l100.20"></a><span id="l100.20">   }</span>
<a href="#l100.21"></a><span id="l100.21"> </span>
<a href="#l100.22"></a><span id="l100.22">   index = message.RFind(&quot;&lt;/body&gt;&quot;, /* ignoreCase = */ true);</span>
<a href="#l100.23"></a><span id="l100.23" class="difflineminus">-  if (index != kNotFound) message.Insert(NS_LITERAL_CSTRING(&quot;&lt;/div&gt;&quot;), index);</span>
<a href="#l100.24"></a><span id="l100.24" class="difflineplus">+  if (index != kNotFound) message.Insert(&quot;&lt;/div&gt;&quot;_ns, index);</span>
<a href="#l100.25"></a><span id="l100.25"> }</span>
<a href="#l100.26"></a><span id="l100.26"> </span>
<a href="#l100.27"></a><span id="l100.27"> /*</span>
<a href="#l100.28"></a><span id="l100.28">  * The following function replaces &lt;plaintext&gt; tags with &lt;x-plaintext&gt;.</span>
<a href="#l100.29"></a><span id="l100.29">  * &lt;plaintext&gt; is a funny beast: It leads to everything following it</span>
<a href="#l100.30"></a><span id="l100.30">  * being displayed verbatim, even a &lt;/plaintext&gt; tag is ignored.</span>
<a href="#l100.31"></a><span id="l100.31">  */</span>
<a href="#l100.32"></a><span id="l100.32"> void MimeInlineTextHTML_remove_plaintext_tag(MimeObject* obj,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineat">@@ -212,20 +212,19 @@ static nsresult openWindow(nsIMsgWindow*</span>
<a href="#l101.4"></a><span id="l101.4">   nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr =</span>
<a href="#l101.5"></a><span id="l101.5">       do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l101.6"></a><span id="l101.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l101.7"></a><span id="l101.7"> </span>
<a href="#l101.8"></a><span id="l101.8">   ifptr-&gt;SetData(param);</span>
<a href="#l101.9"></a><span id="l101.9">   ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsINewsDownloadDialogArgs));</span>
<a href="#l101.10"></a><span id="l101.10"> </span>
<a href="#l101.11"></a><span id="l101.11">   RefPtr&lt;mozilla::dom::BrowsingContext&gt; dialogWindow;</span>
<a href="#l101.12"></a><span id="l101.12" class="difflineminus">-  rv = parentWindow-&gt;OpenDialog(</span>
<a href="#l101.13"></a><span id="l101.13" class="difflineminus">-      NS_ConvertASCIItoUTF16(chromeURL), NS_LITERAL_STRING(&quot;_blank&quot;),</span>
<a href="#l101.14"></a><span id="l101.14" class="difflineminus">-      NS_LITERAL_STRING(&quot;centerscreen,chrome,modal,titlebar&quot;), ifptr,</span>
<a href="#l101.15"></a><span id="l101.15" class="difflineminus">-      getter_AddRefs(dialogWindow));</span>
<a href="#l101.16"></a><span id="l101.16" class="difflineplus">+  rv = parentWindow-&gt;OpenDialog(NS_ConvertASCIItoUTF16(chromeURL), u&quot;_blank&quot;_ns,</span>
<a href="#l101.17"></a><span id="l101.17" class="difflineplus">+                                u&quot;centerscreen,chrome,modal,titlebar&quot;_ns, ifptr,</span>
<a href="#l101.18"></a><span id="l101.18" class="difflineplus">+                                getter_AddRefs(dialogWindow));</span>
<a href="#l101.19"></a><span id="l101.19"> </span>
<a href="#l101.20"></a><span id="l101.20">   return rv;</span>
<a href="#l101.21"></a><span id="l101.21"> }</span>
<a href="#l101.22"></a><span id="l101.22"> </span>
<a href="#l101.23"></a><span id="l101.23"> nsresult nsNNTPNewsgroupList::GetRangeOfArtsToDownload(</span>
<a href="#l101.24"></a><span id="l101.24">     nsIMsgWindow* aMsgWindow, int32_t first_possible, int32_t last_possible,</span>
<a href="#l101.25"></a><span id="l101.25">     int32_t maxextra, int32_t* first, int32_t* last, int32_t* status) {</span>
<a href="#l101.26"></a><span id="l101.26">   nsresult rv = NS_OK;</span>
<a href="#l101.27"></a><span id="l101.27" class="difflineat">@@ -697,17 +696,17 @@ NS_IMETHODIMP nsNNTPNewsgroupList::Apply</span>
<a href="#l101.28"></a><span id="l101.28"> </span>
<a href="#l101.29"></a><span id="l101.29">     if (NS_FAILED(rv)) {</span>
<a href="#l101.30"></a><span id="l101.30">       finalResult = rv;</span>
<a href="#l101.31"></a><span id="l101.31">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l101.32"></a><span id="l101.32">               (&quot;(News) Action execution failed with error: %&quot; PRIx32,</span>
<a href="#l101.33"></a><span id="l101.33">                static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l101.34"></a><span id="l101.34">       if (loggingEnabled) {</span>
<a href="#l101.35"></a><span id="l101.35">         (void)aFilter-&gt;LogRuleHitFail(filterAction, m_newMsgHdr, rv,</span>
<a href="#l101.36"></a><span id="l101.36" class="difflineminus">-                                      NS_LITERAL_CSTRING(&quot;filterActionFailed&quot;));</span>
<a href="#l101.37"></a><span id="l101.37" class="difflineplus">+                                      &quot;filterActionFailed&quot;_ns);</span>
<a href="#l101.38"></a><span id="l101.38">       }</span>
<a href="#l101.39"></a><span id="l101.39">     } else {</span>
<a href="#l101.40"></a><span id="l101.40">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l101.41"></a><span id="l101.41">               (&quot;(News) Action execution succeeded&quot;));</span>
<a href="#l101.42"></a><span id="l101.42">     }</span>
<a href="#l101.43"></a><span id="l101.43">   }</span>
<a href="#l101.44"></a><span id="l101.44">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l101.45"></a><span id="l101.45">           (&quot;(News) Finished executing actions&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineat">@@ -1811,17 +1811,17 @@ nsresult nsNNTPProtocol::SendFirstNNTPCo</span>
<a href="#l102.4"></a><span id="l102.4">       m_nextState = NNTP_ERROR;</span>
<a href="#l102.5"></a><span id="l102.5">     // if we have no channel listener, then we're likely downloading</span>
<a href="#l102.6"></a><span id="l102.6">     // the message for offline use (or at least not displaying it)</span>
<a href="#l102.7"></a><span id="l102.7">     bool savingArticleOffline = (m_channelListener == nullptr);</span>
<a href="#l102.8"></a><span id="l102.8"> </span>
<a href="#l102.9"></a><span id="l102.9">     if (m_runningURL) FinishMemCacheEntry(false);  // cleanup mem cache entry</span>
<a href="#l102.10"></a><span id="l102.10"> </span>
<a href="#l102.11"></a><span id="l102.11">     if (NS_SUCCEEDED(rv) &amp;&amp; !group_name.IsEmpty() &amp;&amp; !savingArticleOffline) {</span>
<a href="#l102.12"></a><span id="l102.12" class="difflineminus">-      nsCString uri(NS_LITERAL_CSTRING(&quot;about:newserror?r=&quot;));</span>
<a href="#l102.13"></a><span id="l102.13" class="difflineplus">+      nsCString uri(&quot;about:newserror?r=&quot;_ns);</span>
<a href="#l102.14"></a><span id="l102.14">       nsCString escapedResponse;</span>
<a href="#l102.15"></a><span id="l102.15">       MsgEscapeURL(nsDependentCString(m_responseText),</span>
<a href="#l102.16"></a><span id="l102.16">                    nsINetUtil::ESCAPE_URL_QUERY, escapedResponse);</span>
<a href="#l102.17"></a><span id="l102.17">       uri.Append(escapedResponse);</span>
<a href="#l102.18"></a><span id="l102.18"> </span>
<a href="#l102.19"></a><span id="l102.19">       if ((m_key != nsMsgKey_None) &amp;&amp; m_newsFolder) {</span>
<a href="#l102.20"></a><span id="l102.20">         nsCString messageID;</span>
<a href="#l102.21"></a><span id="l102.21">         nsCString escapedMessageID;</span>
<a href="#l102.22"></a><span id="l102.22" class="difflineat">@@ -3141,17 +3141,17 @@ nsresult nsNNTPProtocol::ReadNewsgroupBo</span>
<a href="#l102.23"></a><span id="l102.23">   rv = m_newsgroupList-&gt;ProcessHEADLine(safe_line);</span>
<a href="#l102.24"></a><span id="l102.24">   PR_Free(lineToFree);</span>
<a href="#l102.25"></a><span id="l102.25">   return rv;</span>
<a href="#l102.26"></a><span id="l102.26"> }</span>
<a href="#l102.27"></a><span id="l102.27"> </span>
<a href="#l102.28"></a><span id="l102.28"> nsresult nsNNTPProtocol::GetNewsStringByID(int32_t stringID,</span>
<a href="#l102.29"></a><span id="l102.29">                                            char16_t** aString) {</span>
<a href="#l102.30"></a><span id="l102.30">   nsresult rv;</span>
<a href="#l102.31"></a><span id="l102.31" class="difflineminus">-  nsAutoString resultString(NS_LITERAL_STRING(&quot;???&quot;));</span>
<a href="#l102.32"></a><span id="l102.32" class="difflineplus">+  nsAutoString resultString(u&quot;???&quot;_ns);</span>
<a href="#l102.33"></a><span id="l102.33"> </span>
<a href="#l102.34"></a><span id="l102.34">   if (!m_stringBundle) {</span>
<a href="#l102.35"></a><span id="l102.35">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l102.36"></a><span id="l102.36">         mozilla::services::GetStringBundleService();</span>
<a href="#l102.37"></a><span id="l102.37">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l102.38"></a><span id="l102.38"> </span>
<a href="#l102.39"></a><span id="l102.39">     rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL,</span>
<a href="#l102.40"></a><span id="l102.40">                                      getter_AddRefs(m_stringBundle));</span>
<a href="#l102.41"></a><span id="l102.41" class="difflineat">@@ -3175,17 +3175,17 @@ nsresult nsNNTPProtocol::GetNewsStringBy</span>
<a href="#l102.42"></a><span id="l102.42">     *aString = ToNewUnicode(resultString);</span>
<a href="#l102.43"></a><span id="l102.43">   }</span>
<a href="#l102.44"></a><span id="l102.44">   return rv;</span>
<a href="#l102.45"></a><span id="l102.45"> }</span>
<a href="#l102.46"></a><span id="l102.46"> </span>
<a href="#l102.47"></a><span id="l102.47"> nsresult nsNNTPProtocol::GetNewsStringByName(const char* aName,</span>
<a href="#l102.48"></a><span id="l102.48">                                              char16_t** aString) {</span>
<a href="#l102.49"></a><span id="l102.49">   nsresult rv;</span>
<a href="#l102.50"></a><span id="l102.50" class="difflineminus">-  nsAutoString resultString(NS_LITERAL_STRING(&quot;???&quot;));</span>
<a href="#l102.51"></a><span id="l102.51" class="difflineplus">+  nsAutoString resultString(u&quot;???&quot;_ns);</span>
<a href="#l102.52"></a><span id="l102.52">   if (!m_stringBundle) {</span>
<a href="#l102.53"></a><span id="l102.53">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l102.54"></a><span id="l102.54">         mozilla::services::GetStringBundleService();</span>
<a href="#l102.55"></a><span id="l102.55">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l102.56"></a><span id="l102.56"> </span>
<a href="#l102.57"></a><span id="l102.57">     rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL,</span>
<a href="#l102.58"></a><span id="l102.58">                                      getter_AddRefs(m_stringBundle));</span>
<a href="#l102.59"></a><span id="l102.59">     NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineat">@@ -265,18 +265,18 @@ nsNntpIncomingServer::GetCharset(nsACStr</span>
<a href="#l103.4"></a><span id="l103.4">   nsresult rv = GetCharValue(&quot;charset&quot;, aCharset);</span>
<a href="#l103.5"></a><span id="l103.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l103.6"></a><span id="l103.6"> </span>
<a href="#l103.7"></a><span id="l103.7">   // if the per-server setting is empty,we get the default charset from</span>
<a href="#l103.8"></a><span id="l103.8">   // mailnews.view_default_charset setting and set it as per-server preference.</span>
<a href="#l103.9"></a><span id="l103.9">   if (aCharset.IsEmpty()) {</span>
<a href="#l103.10"></a><span id="l103.10">     nsString defaultCharset;</span>
<a href="#l103.11"></a><span id="l103.11">     rv = NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l103.12"></a><span id="l103.12" class="difflineminus">-        nullptr, PREF_MAILNEWS_VIEW_DEFAULT_CHARSET,</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineminus">-        NS_LITERAL_STRING(&quot;ISO-8859-1&quot;), defaultCharset);</span>
<a href="#l103.14"></a><span id="l103.14" class="difflineplus">+        nullptr, PREF_MAILNEWS_VIEW_DEFAULT_CHARSET, u&quot;ISO-8859-1&quot;_ns,</span>
<a href="#l103.15"></a><span id="l103.15" class="difflineplus">+        defaultCharset);</span>
<a href="#l103.16"></a><span id="l103.16">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l103.17"></a><span id="l103.17">     LossyCopyUTF16toASCII(defaultCharset, aCharset);</span>
<a href="#l103.18"></a><span id="l103.18">     SetCharset(aCharset);</span>
<a href="#l103.19"></a><span id="l103.19">   }</span>
<a href="#l103.20"></a><span id="l103.20">   return NS_OK;</span>
<a href="#l103.21"></a><span id="l103.21"> }</span>
<a href="#l103.22"></a><span id="l103.22"> </span>
<a href="#l103.23"></a><span id="l103.23"> NS_IMETHODIMP</span>
<a href="#l103.24"></a><span id="l103.24" class="difflineat">@@ -1732,17 +1732,17 @@ nsNntpIncomingServer::SetTree(mozilla::d</span>
<a href="#l103.25"></a><span id="l103.25"> </span>
<a href="#l103.26"></a><span id="l103.26">   RefPtr&lt;nsTreeColumn&gt; col = cols-&gt;GetKeyColumn();</span>
<a href="#l103.27"></a><span id="l103.27">   if (!col) return NS_OK;</span>
<a href="#l103.28"></a><span id="l103.28"> </span>
<a href="#l103.29"></a><span id="l103.29">   RefPtr&lt;mozilla::dom::Element&gt; element = col-&gt;Element();</span>
<a href="#l103.30"></a><span id="l103.30">   if (!element) return NS_OK;</span>
<a href="#l103.31"></a><span id="l103.31"> </span>
<a href="#l103.32"></a><span id="l103.32">   nsAutoString dir;</span>
<a href="#l103.33"></a><span id="l103.33" class="difflineminus">-  element-&gt;GetAttribute(NS_LITERAL_STRING(&quot;sortDirection&quot;), dir);</span>
<a href="#l103.34"></a><span id="l103.34" class="difflineplus">+  element-&gt;GetAttribute(u&quot;sortDirection&quot;_ns, dir);</span>
<a href="#l103.35"></a><span id="l103.35">   mSearchResultSortDescending = dir.EqualsLiteral(&quot;descending&quot;);</span>
<a href="#l103.36"></a><span id="l103.36">   return NS_OK;</span>
<a href="#l103.37"></a><span id="l103.37"> }</span>
<a href="#l103.38"></a><span id="l103.38"> </span>
<a href="#l103.39"></a><span id="l103.39"> NS_IMETHODIMP</span>
<a href="#l103.40"></a><span id="l103.40"> nsNntpIncomingServer::ToggleOpenState(int32_t index) {</span>
<a href="#l103.41"></a><span id="l103.41">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l103.42"></a><span id="l103.42"> }</span>
<a href="#l103.43"></a><span id="l103.43" class="difflineat">@@ -1752,21 +1752,19 @@ nsNntpIncomingServer::CycleHeader(nsTree</span>
<a href="#l103.44"></a><span id="l103.44">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l103.45"></a><span id="l103.45"> </span>
<a href="#l103.46"></a><span id="l103.46">   bool cycler = col-&gt;Cycler();</span>
<a href="#l103.47"></a><span id="l103.47">   if (!cycler) {</span>
<a href="#l103.48"></a><span id="l103.48">     constexpr auto dir = u&quot;sortDirection&quot;_ns;</span>
<a href="#l103.49"></a><span id="l103.49">     RefPtr&lt;mozilla::dom::Element&gt; element = col-&gt;Element();</span>
<a href="#l103.50"></a><span id="l103.50">     mSearchResultSortDescending = !mSearchResultSortDescending;</span>
<a href="#l103.51"></a><span id="l103.51">     mozilla::IgnoredErrorResult rv2;</span>
<a href="#l103.52"></a><span id="l103.52" class="difflineminus">-    element-&gt;SetAttribute(dir,</span>
<a href="#l103.53"></a><span id="l103.53" class="difflineminus">-                          mSearchResultSortDescending</span>
<a href="#l103.54"></a><span id="l103.54" class="difflineminus">-                              ? NS_LITERAL_STRING(&quot;descending&quot;)</span>
<a href="#l103.55"></a><span id="l103.55" class="difflineminus">-                              : NS_LITERAL_STRING(&quot;ascending&quot;),</span>
<a href="#l103.56"></a><span id="l103.56" class="difflineminus">-                          rv2);</span>
<a href="#l103.57"></a><span id="l103.57" class="difflineplus">+    element-&gt;SetAttribute(</span>
<a href="#l103.58"></a><span id="l103.58" class="difflineplus">+        dir, mSearchResultSortDescending ? u&quot;descending&quot;_ns : u&quot;ascending&quot;_ns,</span>
<a href="#l103.59"></a><span id="l103.59" class="difflineplus">+        rv2);</span>
<a href="#l103.60"></a><span id="l103.60">     mTree-&gt;Invalidate();</span>
<a href="#l103.61"></a><span id="l103.61">   }</span>
<a href="#l103.62"></a><span id="l103.62">   return NS_OK;</span>
<a href="#l103.63"></a><span id="l103.63"> }</span>
<a href="#l103.64"></a><span id="l103.64"> </span>
<a href="#l103.65"></a><span id="l103.65"> NS_IMETHODIMP</span>
<a href="#l103.66"></a><span id="l103.66"> nsNntpIncomingServer::SelectionChangedXPCOM() {</span>
<a href="#l103.67"></a><span id="l103.67">   return NS_ERROR_NOT_IMPLEMENTED;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineat">@@ -773,18 +773,18 @@ nsresult nsNntpService::GetNntpServerByA</span>
<a href="#l104.4"></a><span id="l104.4">     rv = accountManager-&gt;GetAccount(nsDependentCString(aAccountKey),</span>
<a href="#l104.5"></a><span id="l104.5">                                     getter_AddRefs(account));</span>
<a href="#l104.6"></a><span id="l104.6">     if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l104.7"></a><span id="l104.7">       rv = account-&gt;GetIncomingServer(aNntpServer);</span>
<a href="#l104.8"></a><span id="l104.8">   }</span>
<a href="#l104.9"></a><span id="l104.9"> </span>
<a href="#l104.10"></a><span id="l104.10">   // if we don't have a news host, find the first news server and use it</span>
<a href="#l104.11"></a><span id="l104.11">   if (NS_FAILED(rv) || !*aNntpServer)</span>
<a href="#l104.12"></a><span id="l104.12" class="difflineminus">-    rv = accountManager-&gt;FindServer(EmptyCString(), EmptyCString(),</span>
<a href="#l104.13"></a><span id="l104.13" class="difflineminus">-                                    NS_LITERAL_CSTRING(&quot;nntp&quot;), aNntpServer);</span>
<a href="#l104.14"></a><span id="l104.14" class="difflineplus">+    rv = accountManager-&gt;FindServer(EmptyCString(), EmptyCString(), &quot;nntp&quot;_ns,</span>
<a href="#l104.15"></a><span id="l104.15" class="difflineplus">+                                    aNntpServer);</span>
<a href="#l104.16"></a><span id="l104.16"> </span>
<a href="#l104.17"></a><span id="l104.17">   return rv;</span>
<a href="#l104.18"></a><span id="l104.18"> }</span>
<a href="#l104.19"></a><span id="l104.19"> </span>
<a href="#l104.20"></a><span id="l104.20"> NS_IMETHODIMP</span>
<a href="#l104.21"></a><span id="l104.21"> nsNntpService::PostMessage(nsIFile* aFileToPost, const char* newsgroupsNames,</span>
<a href="#l104.22"></a><span id="l104.22">                            const char* aAccountKey,</span>
<a href="#l104.23"></a><span id="l104.23">                            nsIUrlListener* aUrlListener,</span>
<a href="#l104.24"></a><span id="l104.24" class="difflineat">@@ -877,18 +877,17 @@ nsresult nsNntpService::CreateNewsAccoun</span>
<a href="#l104.25"></a><span id="l104.25">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l104.26"></a><span id="l104.26"> </span>
<a href="#l104.27"></a><span id="l104.27">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l104.28"></a><span id="l104.28">   rv = accountManager-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l104.29"></a><span id="l104.29">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l104.30"></a><span id="l104.30"> </span>
<a href="#l104.31"></a><span id="l104.31">   // for news, username is always null</span>
<a href="#l104.32"></a><span id="l104.32">   rv = accountManager-&gt;CreateIncomingServer(</span>
<a href="#l104.33"></a><span id="l104.33" class="difflineminus">-      EmptyCString(), nsDependentCString(aHostname), NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l104.34"></a><span id="l104.34" class="difflineminus">-      aServer);</span>
<a href="#l104.35"></a><span id="l104.35" class="difflineplus">+      EmptyCString(), nsDependentCString(aHostname), &quot;nntp&quot;_ns, aServer);</span>
<a href="#l104.36"></a><span id="l104.36">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l104.37"></a><span id="l104.37"> </span>
<a href="#l104.38"></a><span id="l104.38">   if (aUseSSL) {</span>
<a href="#l104.39"></a><span id="l104.39">     rv = (*aServer)-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l104.40"></a><span id="l104.40">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l104.41"></a><span id="l104.41">   }</span>
<a href="#l104.42"></a><span id="l104.42"> </span>
<a href="#l104.43"></a><span id="l104.43">   rv = (*aServer)-&gt;SetPort(aPort);</span>
<a href="#l104.44"></a><span id="l104.44" class="difflineat">@@ -1514,17 +1513,17 @@ nsNntpService::GetListOfGroupsOnServer(n</span>
<a href="#l104.45"></a><span id="l104.45"> </span>
<a href="#l104.46"></a><span id="l104.46"> NS_IMETHODIMP</span>
<a href="#l104.47"></a><span id="l104.47"> nsNntpService::Handle(nsICommandLine* aCmdLine) {</span>
<a href="#l104.48"></a><span id="l104.48">   NS_ENSURE_ARG_POINTER(aCmdLine);</span>
<a href="#l104.49"></a><span id="l104.49"> </span>
<a href="#l104.50"></a><span id="l104.50">   nsresult rv;</span>
<a href="#l104.51"></a><span id="l104.51">   bool found;</span>
<a href="#l104.52"></a><span id="l104.52"> </span>
<a href="#l104.53"></a><span id="l104.53" class="difflineminus">-  rv = aCmdLine-&gt;HandleFlag(NS_LITERAL_STRING(&quot;news&quot;), false, &amp;found);</span>
<a href="#l104.54"></a><span id="l104.54" class="difflineplus">+  rv = aCmdLine-&gt;HandleFlag(u&quot;news&quot;_ns, false, &amp;found);</span>
<a href="#l104.55"></a><span id="l104.55">   if (NS_SUCCEEDED(rv) &amp;&amp; found) {</span>
<a href="#l104.56"></a><span id="l104.56">     nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l104.57"></a><span id="l104.57">         do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l104.58"></a><span id="l104.58">     NS_ENSURE_TRUE(wwatch, NS_ERROR_FAILURE);</span>
<a href="#l104.59"></a><span id="l104.59"> </span>
<a href="#l104.60"></a><span id="l104.60">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; opened;</span>
<a href="#l104.61"></a><span id="l104.61">     wwatch-&gt;OpenWindow(</span>
<a href="#l104.62"></a><span id="l104.62">         nullptr, &quot;chrome://messenger/content/messenger.xhtml&quot;, &quot;_blank&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1" class="difflineminus">--- a/mailnews/news/src/nsNntpUrl.cpp</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpUrl.cpp</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineat">@@ -187,22 +187,21 @@ nsresult nsNntpUrl::DetermineNewsAction(</span>
<a href="#l105.4"></a><span id="l105.4">   if (query.EqualsLiteral(&quot;list-ids&quot;)) {</span>
<a href="#l105.5"></a><span id="l105.5">     m_newsAction = nsINntpUrl::ActionListIds;</span>
<a href="#l105.6"></a><span id="l105.6">     return NS_OK;</span>
<a href="#l105.7"></a><span id="l105.7">   }</span>
<a href="#l105.8"></a><span id="l105.8">   if (query.EqualsLiteral(&quot;newgroups&quot;)) {</span>
<a href="#l105.9"></a><span id="l105.9">     m_newsAction = nsINntpUrl::ActionListNewGroups;</span>
<a href="#l105.10"></a><span id="l105.10">     return NS_OK;</span>
<a href="#l105.11"></a><span id="l105.11">   }</span>
<a href="#l105.12"></a><span id="l105.12" class="difflineminus">-  if (StringBeginsWith(query, NS_LITERAL_CSTRING(&quot;search&quot;))) {</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineplus">+  if (StringBeginsWith(query, &quot;search&quot;_ns)) {</span>
<a href="#l105.14"></a><span id="l105.14">     m_newsAction = nsINntpUrl::ActionSearch;</span>
<a href="#l105.15"></a><span id="l105.15">     return NS_OK;</span>
<a href="#l105.16"></a><span id="l105.16">   }</span>
<a href="#l105.17"></a><span id="l105.17" class="difflineminus">-  if (StringBeginsWith(query, NS_LITERAL_CSTRING(&quot;part=&quot;)) ||</span>
<a href="#l105.18"></a><span id="l105.18" class="difflineminus">-      query.Find(&quot;&amp;part=&quot;) &gt; 0) {</span>
<a href="#l105.19"></a><span id="l105.19" class="difflineplus">+  if (StringBeginsWith(query, &quot;part=&quot;_ns) || query.Find(&quot;&amp;part=&quot;) &gt; 0) {</span>
<a href="#l105.20"></a><span id="l105.20">     // news://news.mozilla.org:119/3B98D201.3020100%40cs.com?part=1</span>
<a href="#l105.21"></a><span id="l105.21">     // news://news.mozilla.org:119/b58dme%24aia2%40ripley.netscape.com?header=print&amp;part=1.2&amp;type=image/jpeg&amp;filename=Pole.jpg</span>
<a href="#l105.22"></a><span id="l105.22">     m_newsAction = nsINntpUrl::ActionFetchPart;</span>
<a href="#l105.23"></a><span id="l105.23">     return NS_OK;</span>
<a href="#l105.24"></a><span id="l105.24">   }</span>
<a href="#l105.25"></a><span id="l105.25"> </span>
<a href="#l105.26"></a><span id="l105.26">   if (!m_messageID.IsEmpty() || m_key != nsMsgKey_None) {</span>
<a href="#l105.27"></a><span id="l105.27">     m_newsAction = nsINntpUrl::ActionFetchArticle;</span>
<a href="#l105.28"></a><span id="l105.28" class="difflineat">@@ -404,28 +403,25 @@ nsNntpUrl::GetServer(nsIMsgIncomingServe</span>
<a href="#l105.29"></a><span id="l105.29">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l105.30"></a><span id="l105.30">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l105.31"></a><span id="l105.31"> </span>
<a href="#l105.32"></a><span id="l105.32">   // Ignoring return results: it is perfectly acceptable for the server to not</span>
<a href="#l105.33"></a><span id="l105.33">   // exist, but FindServer (and not FindRealServer) throws NS_ERROR_UNEXPECTED</span>
<a href="#l105.34"></a><span id="l105.34">   // in this case.</span>
<a href="#l105.35"></a><span id="l105.35">   *aServer = nullptr;</span>
<a href="#l105.36"></a><span id="l105.36">   if (tryReal)</span>
<a href="#l105.37"></a><span id="l105.37" class="difflineminus">-    accountManager-&gt;FindRealServer(user, host, NS_LITERAL_CSTRING(&quot;nntp&quot;), 0,</span>
<a href="#l105.38"></a><span id="l105.38" class="difflineminus">-                                   aServer);</span>
<a href="#l105.39"></a><span id="l105.39" class="difflineplus">+    accountManager-&gt;FindRealServer(user, host, &quot;nntp&quot;_ns, 0, aServer);</span>
<a href="#l105.40"></a><span id="l105.40">   else</span>
<a href="#l105.41"></a><span id="l105.41" class="difflineminus">-    accountManager-&gt;FindServer(user, host, NS_LITERAL_CSTRING(&quot;nntp&quot;), aServer);</span>
<a href="#l105.42"></a><span id="l105.42" class="difflineplus">+    accountManager-&gt;FindServer(user, host, &quot;nntp&quot;_ns, aServer);</span>
<a href="#l105.43"></a><span id="l105.43">   if (!*aServer &amp;&amp; (isNews || isNntp)) {</span>
<a href="#l105.44"></a><span id="l105.44">     // Didn't find it, try the other option</span>
<a href="#l105.45"></a><span id="l105.45">     if (tryReal)</span>
<a href="#l105.46"></a><span id="l105.46" class="difflineminus">-      accountManager-&gt;FindServer(user, host, NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l105.47"></a><span id="l105.47" class="difflineminus">-                                 aServer);</span>
<a href="#l105.48"></a><span id="l105.48" class="difflineplus">+      accountManager-&gt;FindServer(user, host, &quot;nntp&quot;_ns, aServer);</span>
<a href="#l105.49"></a><span id="l105.49">     else</span>
<a href="#l105.50"></a><span id="l105.50" class="difflineminus">-      accountManager-&gt;FindRealServer(user, host, NS_LITERAL_CSTRING(&quot;nntp&quot;), 0,</span>
<a href="#l105.51"></a><span id="l105.51" class="difflineminus">-                                     aServer);</span>
<a href="#l105.52"></a><span id="l105.52" class="difflineplus">+      accountManager-&gt;FindRealServer(user, host, &quot;nntp&quot;_ns, 0, aServer);</span>
<a href="#l105.53"></a><span id="l105.53">   }</span>
<a href="#l105.54"></a><span id="l105.54">   return NS_OK;</span>
<a href="#l105.55"></a><span id="l105.55"> }</span>
<a href="#l105.56"></a><span id="l105.56"> </span>
<a href="#l105.57"></a><span id="l105.57"> NS_IMETHODIMP nsNntpUrl::GetFolder(nsIMsgFolder** msgFolder) {</span>
<a href="#l105.58"></a><span id="l105.58">   NS_ENSURE_ARG_POINTER(msgFolder);</span>
<a href="#l105.59"></a><span id="l105.59"> </span>
<a href="#l105.60"></a><span id="l105.60">   nsresult rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1" class="difflineminus">--- a/suite/components/feeds/nsFeedSniffer.cpp</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineplus">+++ b/suite/components/feeds/nsFeedSniffer.cpp</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineat">@@ -52,17 +52,17 @@ nsFeedSniffer::ConvertEncodedData(nsIReq</span>
<a href="#l106.4"></a><span id="l106.4"> </span>
<a href="#l106.5"></a><span id="l106.5">   mDecodedData = &quot;&quot;;</span>
<a href="#l106.6"></a><span id="l106.6">   nsCOMPtr&lt;nsIHttpChannel&gt; httpChannel(do_QueryInterface(request));</span>
<a href="#l106.7"></a><span id="l106.7">   if (!httpChannel)</span>
<a href="#l106.8"></a><span id="l106.8">     return NS_ERROR_NO_INTERFACE;</span>
<a href="#l106.9"></a><span id="l106.9"> </span>
<a href="#l106.10"></a><span id="l106.10">   nsAutoCString contentEncoding;</span>
<a href="#l106.11"></a><span id="l106.11"> </span>
<a href="#l106.12"></a><span id="l106.12" class="difflineminus">-  mozilla::Unused &lt;&lt; httpChannel-&gt;GetResponseHeader(NS_LITERAL_CSTRING(&quot;Content-Encoding&quot;),</span>
<a href="#l106.13"></a><span id="l106.13" class="difflineplus">+  mozilla::Unused &lt;&lt; httpChannel-&gt;GetResponseHeader(&quot;Content-Encoding&quot;_ns,</span>
<a href="#l106.14"></a><span id="l106.14">                                       contentEncoding);</span>
<a href="#l106.15"></a><span id="l106.15">   if (!contentEncoding.IsEmpty()) {</span>
<a href="#l106.16"></a><span id="l106.16">     nsCOMPtr&lt;nsIStreamConverterService&gt; converterService(do_GetService(NS_STREAMCONVERTERSERVICE_CONTRACTID));</span>
<a href="#l106.17"></a><span id="l106.17">     if (converterService) {</span>
<a href="#l106.18"></a><span id="l106.18">       ToLowerCase(contentEncoding);</span>
<a href="#l106.19"></a><span id="l106.19"> </span>
<a href="#l106.20"></a><span id="l106.20">       nsCOMPtr&lt;nsIStreamListener&gt; converter;</span>
<a href="#l106.21"></a><span id="l106.21">       rv = converterService-&gt;AsyncConvertData(contentEncoding.get(),</span>
<a href="#l106.22"></a><span id="l106.22" class="difflineat">@@ -247,18 +247,18 @@ nsFeedSniffer::GetMIMETypeFromContent(ns</span>
<a href="#l106.23"></a><span id="l106.23">     if(HasAttachmentDisposition(channel)) {</span>
<a href="#l106.24"></a><span id="l106.24">       sniffedType.Truncate();</span>
<a href="#l106.25"></a><span id="l106.25">       return NS_OK;</span>
<a href="#l106.26"></a><span id="l106.26">     }</span>
<a href="#l106.27"></a><span id="l106.27"> </span>
<a href="#l106.28"></a><span id="l106.28">     // set the feed header as a response header, since we have good metadata</span>
<a href="#l106.29"></a><span id="l106.29">     // telling us that the feed is supposed to be RSS or Atom</span>
<a href="#l106.30"></a><span id="l106.30">     mozilla::DebugOnly&lt;nsresult&gt; rv = </span>
<a href="#l106.31"></a><span id="l106.31" class="difflineminus">-      channel-&gt;SetResponseHeader(NS_LITERAL_CSTRING(&quot;X-Moz-Is-Feed&quot;),</span>
<a href="#l106.32"></a><span id="l106.32" class="difflineminus">-                                 NS_LITERAL_CSTRING(&quot;1&quot;), false);</span>
<a href="#l106.33"></a><span id="l106.33" class="difflineplus">+      channel-&gt;SetResponseHeader(&quot;X-Moz-Is-Feed&quot;_ns,</span>
<a href="#l106.34"></a><span id="l106.34" class="difflineplus">+                                 &quot;1&quot;_ns, false);</span>
<a href="#l106.35"></a><span id="l106.35">     MOZ_ASSERT(NS_SUCCEEDED(rv));</span>
<a href="#l106.36"></a><span id="l106.36">     sniffedType.AssignLiteral(TYPE_MAYBE_FEED);</span>
<a href="#l106.37"></a><span id="l106.37">     return NS_OK;</span>
<a href="#l106.38"></a><span id="l106.38">   }</span>
<a href="#l106.39"></a><span id="l106.39"> </span>
<a href="#l106.40"></a><span id="l106.40">   // Don't sniff arbitrary types.  Limit sniffing to situations that</span>
<a href="#l106.41"></a><span id="l106.41">   // we think can reasonably arise.</span>
<a href="#l106.42"></a><span id="l106.42">   if (!contentType.EqualsLiteral(TEXT_HTML) &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1" class="difflineminus">--- a/suite/components/migration/src/nsSuiteProfileMigratorBase.cpp</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineplus">+++ b/suite/components/migration/src/nsSuiteProfileMigratorBase.cpp</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineat">@@ -19,20 +19,20 @@</span>
<a href="#l107.4"></a><span id="l107.4"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l107.5"></a><span id="l107.5"> #include &quot;nsIDirectoryEnumerator.h&quot;</span>
<a href="#l107.6"></a><span id="l107.6"> #include &quot;nsIFileProtocolHandler.h&quot;</span>
<a href="#l107.7"></a><span id="l107.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l107.8"></a><span id="l107.8"> #include &quot;prtime.h&quot;</span>
<a href="#l107.9"></a><span id="l107.9"> #include &quot;nsINIParser.h&quot;</span>
<a href="#l107.10"></a><span id="l107.10"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l107.11"></a><span id="l107.11"> </span>
<a href="#l107.12"></a><span id="l107.12" class="difflineminus">-#define MAIL_DIR_50_NAME             NS_LITERAL_STRING(&quot;Mail&quot;)</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineminus">-#define IMAP_MAIL_DIR_50_NAME        NS_LITERAL_STRING(&quot;ImapMail&quot;)</span>
<a href="#l107.14"></a><span id="l107.14" class="difflineminus">-#define NEWS_DIR_50_NAME             NS_LITERAL_STRING(&quot;News&quot;)</span>
<a href="#l107.15"></a><span id="l107.15" class="difflineminus">-#define DIR_NAME_CHROME              NS_LITERAL_STRING(&quot;chrome&quot;)</span>
<a href="#l107.16"></a><span id="l107.16" class="difflineplus">+#define MAIL_DIR_50_NAME             u&quot;Mail&quot;_ns</span>
<a href="#l107.17"></a><span id="l107.17" class="difflineplus">+#define IMAP_MAIL_DIR_50_NAME        u&quot;ImapMail&quot;_ns</span>
<a href="#l107.18"></a><span id="l107.18" class="difflineplus">+#define NEWS_DIR_50_NAME             u&quot;News&quot;_ns</span>
<a href="#l107.19"></a><span id="l107.19" class="difflineplus">+#define DIR_NAME_CHROME              u&quot;chrome&quot;_ns</span>
<a href="#l107.20"></a><span id="l107.20"> </span>
<a href="#l107.21"></a><span id="l107.21"> NS_IMPL_ISUPPORTS(nsSuiteProfileMigratorBase, nsISuiteProfileMigrator,</span>
<a href="#l107.22"></a><span id="l107.22">                   nsITimerCallback)</span>
<a href="#l107.23"></a><span id="l107.23"> </span>
<a href="#l107.24"></a><span id="l107.24"> using namespace mozilla;</span>
<a href="#l107.25"></a><span id="l107.25"> </span>
<a href="#l107.26"></a><span id="l107.26"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l107.27"></a><span id="l107.27"> // nsITimerCallback</span>
<a href="#l107.28"></a><span id="l107.28" class="difflineat">@@ -254,17 +254,17 @@ nsresult</span>
<a href="#l107.29"></a><span id="l107.29"> nsSuiteProfileMigratorBase::GetProfileDataFromProfilesIni(nsIFile* aDataDir,</span>
<a href="#l107.30"></a><span id="l107.30">                                                           nsIMutableArray* aProfileNames,</span>
<a href="#l107.31"></a><span id="l107.31">                                                           nsIMutableArray* aProfileLocations) {</span>
<a href="#l107.32"></a><span id="l107.32">   nsresult rv;</span>
<a href="#l107.33"></a><span id="l107.33">   nsCOMPtr&lt;nsIFile&gt; profileIni;</span>
<a href="#l107.34"></a><span id="l107.34">   rv = aDataDir-&gt;Clone(getter_AddRefs(profileIni));</span>
<a href="#l107.35"></a><span id="l107.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l107.36"></a><span id="l107.36"> </span>
<a href="#l107.37"></a><span id="l107.37" class="difflineminus">-  profileIni-&gt;Append(NS_LITERAL_STRING(&quot;profiles.ini&quot;));</span>
<a href="#l107.38"></a><span id="l107.38" class="difflineplus">+  profileIni-&gt;Append(u&quot;profiles.ini&quot;_ns);</span>
<a href="#l107.39"></a><span id="l107.39"> </span>
<a href="#l107.40"></a><span id="l107.40">   // Does it exist?</span>
<a href="#l107.41"></a><span id="l107.41">   bool profileFileExists = false;</span>
<a href="#l107.42"></a><span id="l107.42">   rv = profileIni-&gt;Exists(&amp;profileFileExists);</span>
<a href="#l107.43"></a><span id="l107.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l107.44"></a><span id="l107.44"> </span>
<a href="#l107.45"></a><span id="l107.45">   if (!profileFileExists)</span>
<a href="#l107.46"></a><span id="l107.46">     return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l107.47"></a><span id="l107.47" class="difflineat">@@ -518,17 +518,17 @@ nsSuiteProfileMigratorBase::GetFileValue</span>
<a href="#l107.48"></a><span id="l107.48">                                          const char* aRelPrefName,</span>
<a href="#l107.49"></a><span id="l107.49">                                          const char* aPrefName,</span>
<a href="#l107.50"></a><span id="l107.50">                                          nsIFile** aReturnFile) {</span>
<a href="#l107.51"></a><span id="l107.51">   nsCString prefValue;</span>
<a href="#l107.52"></a><span id="l107.52">   nsCOMPtr&lt;nsIFile&gt; theFile;</span>
<a href="#l107.53"></a><span id="l107.53">   nsresult rv = aPrefBranch-&gt;GetCharPref(aRelPrefName, prefValue);</span>
<a href="#l107.54"></a><span id="l107.54">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l107.55"></a><span id="l107.55">     // The pref has the format: [ProfD]a/b/c</span>
<a href="#l107.56"></a><span id="l107.56" class="difflineminus">-    if (!StringBeginsWith(prefValue, NS_LITERAL_CSTRING(&quot;[ProfD]&quot;)))</span>
<a href="#l107.57"></a><span id="l107.57" class="difflineplus">+    if (!StringBeginsWith(prefValue, &quot;[ProfD]&quot;_ns))</span>
<a href="#l107.58"></a><span id="l107.58">       return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l107.59"></a><span id="l107.59"> </span>
<a href="#l107.60"></a><span id="l107.60">     rv = NS_NewNativeLocalFile(EmptyCString(), true, getter_AddRefs(theFile));</span>
<a href="#l107.61"></a><span id="l107.61">     if (NS_FAILED(rv))</span>
<a href="#l107.62"></a><span id="l107.62">       return rv;</span>
<a href="#l107.63"></a><span id="l107.63"> </span>
<a href="#l107.64"></a><span id="l107.64">     rv = theFile-&gt;SetRelativeDescriptor(mSourceProfile, Substring(prefValue, 7));</span>
<a href="#l107.65"></a><span id="l107.65">     if (NS_FAILED(rv))</span>
<a href="#l107.66"></a><span id="l107.66" class="difflineat">@@ -555,17 +555,17 @@ nsSuiteProfileMigratorBase::CopyAddressB</span>
<a href="#l107.67"></a><span id="l107.67">   index.AppendInt(nsISuiteProfileMigrator::ADDRESSBOOK_DATA);</span>
<a href="#l107.68"></a><span id="l107.68">   NOTIFY_OBSERVERS(MIGRATION_ITEMBEFOREMIGRATE, index.get());</span>
<a href="#l107.69"></a><span id="l107.69"> </span>
<a href="#l107.70"></a><span id="l107.70">   uint32_t count = aLdapServers.Length();</span>
<a href="#l107.71"></a><span id="l107.71">   for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l107.72"></a><span id="l107.72">     PrefBranchStruct* pref = aLdapServers.ElementAt(i);</span>
<a href="#l107.73"></a><span id="l107.73">     nsDependentCString prefName(pref-&gt;prefName);</span>
<a href="#l107.74"></a><span id="l107.74"> </span>
<a href="#l107.75"></a><span id="l107.75" class="difflineminus">-    if (StringEndsWith(prefName, NS_LITERAL_CSTRING(&quot;.filename&quot;))) {</span>
<a href="#l107.76"></a><span id="l107.76" class="difflineplus">+    if (StringEndsWith(prefName, &quot;.filename&quot;_ns)) {</span>
<a href="#l107.77"></a><span id="l107.77">       CopyFile(pref-&gt;stringValue, pref-&gt;stringValue);</span>
<a href="#l107.78"></a><span id="l107.78">     }</span>
<a href="#l107.79"></a><span id="l107.79"> </span>
<a href="#l107.80"></a><span id="l107.80">     // we don't need to do anything to the fileName pref itself</span>
<a href="#l107.81"></a><span id="l107.81">   }</span>
<a href="#l107.82"></a><span id="l107.82"> </span>
<a href="#l107.83"></a><span id="l107.83">   NOTIFY_OBSERVERS(MIGRATION_ITEMAFTERMIGRATE, index.get());</span>
<a href="#l107.84"></a><span id="l107.84"> </span>
<a href="#l107.85"></a><span id="l107.85" class="difflineat">@@ -583,17 +583,17 @@ nsSuiteProfileMigratorBase::CopySignatur</span>
<a href="#l107.86"></a><span id="l107.86">     PrefBranchStruct* pref = aIdentities.ElementAt(i);</span>
<a href="#l107.87"></a><span id="l107.87">     nsDependentCString prefName(pref-&gt;prefName);</span>
<a href="#l107.88"></a><span id="l107.88"> </span>
<a href="#l107.89"></a><span id="l107.89">     // a partial fix for bug #255043</span>
<a href="#l107.90"></a><span id="l107.90">     // if the user's signature file from seamonkey lives in the</span>
<a href="#l107.91"></a><span id="l107.91">     // old profile root, we'll copy it over to the new profile root and</span>
<a href="#l107.92"></a><span id="l107.92">     // then set the pref to the new value. Note, this doesn't work for</span>
<a href="#l107.93"></a><span id="l107.93">     // multiple signatures that live below the seamonkey profile root</span>
<a href="#l107.94"></a><span id="l107.94" class="difflineminus">-    if (StringEndsWith(prefName, NS_LITERAL_CSTRING(&quot;.sig_file&quot;)))</span>
<a href="#l107.95"></a><span id="l107.95" class="difflineplus">+    if (StringEndsWith(prefName, &quot;.sig_file&quot;_ns))</span>
<a href="#l107.96"></a><span id="l107.96">     {</span>
<a href="#l107.97"></a><span id="l107.97">       // turn the pref into a nsIFile</span>
<a href="#l107.98"></a><span id="l107.98">       nsCOMPtr&lt;nsIFile&gt; srcSigFile =</span>
<a href="#l107.99"></a><span id="l107.99">         do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l107.100"></a><span id="l107.100">       rv = srcSigFile-&gt;SetPersistentDescriptor(nsDependentCString(pref-&gt;stringValue));</span>
<a href="#l107.101"></a><span id="l107.101">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l107.102"></a><span id="l107.102"> </span>
<a href="#l107.103"></a><span id="l107.103">       nsCOMPtr&lt;nsIFile&gt; targetSigFile;</span>
<a href="#l107.104"></a><span id="l107.104" class="difflineat">@@ -641,17 +641,17 @@ nsSuiteProfileMigratorBase::CopyMailFold</span>
<a href="#l107.105"></a><span id="l107.105">   //     destination directory pref</span>
<a href="#l107.106"></a><span id="l107.106">   CopyFile(FILE_NAME_VIRTUALFOLDERS, FILE_NAME_VIRTUALFOLDERS);</span>
<a href="#l107.107"></a><span id="l107.107"> </span>
<a href="#l107.108"></a><span id="l107.108">   int32_t count = aMailServers.Length();</span>
<a href="#l107.109"></a><span id="l107.109">   for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l107.110"></a><span id="l107.110">     PrefBranchStruct* pref = aMailServers.ElementAt(i);</span>
<a href="#l107.111"></a><span id="l107.111">     nsDependentCString prefName(pref-&gt;prefName);</span>
<a href="#l107.112"></a><span id="l107.112"> </span>
<a href="#l107.113"></a><span id="l107.113" class="difflineminus">-    if (StringEndsWith(prefName, NS_LITERAL_CSTRING(&quot;.directory&quot;))) {</span>
<a href="#l107.114"></a><span id="l107.114" class="difflineplus">+    if (StringEndsWith(prefName, &quot;.directory&quot;_ns)) {</span>
<a href="#l107.115"></a><span id="l107.115">       // let's try to get a branch for this particular server to simplify things</span>
<a href="#l107.116"></a><span id="l107.116">       prefName.Cut(prefName.Length() - strlen(&quot;directory&quot;),</span>
<a href="#l107.117"></a><span id="l107.117">                    strlen(&quot;directory&quot;));</span>
<a href="#l107.118"></a><span id="l107.118">       prefName.Insert(&quot;mail.server.&quot;, 0);</span>
<a href="#l107.119"></a><span id="l107.119"> </span>
<a href="#l107.120"></a><span id="l107.120">       nsCOMPtr&lt;nsIPrefBranch&gt; serverBranch;</span>
<a href="#l107.121"></a><span id="l107.121">       aPrefService-&gt;GetBranch(prefName.get(), getter_AddRefs(serverBranch));</span>
<a href="#l107.122"></a><span id="l107.122"> </span>
<a href="#l107.123"></a><span id="l107.123" class="difflineat">@@ -704,17 +704,17 @@ nsSuiteProfileMigratorBase::CopyMailFold</span>
<a href="#l107.124"></a><span id="l107.124">         nsAutoCString descriptorString;</span>
<a href="#l107.125"></a><span id="l107.125">         rv = targetMailFolder-&gt;GetPersistentDescriptor(descriptorString);</span>
<a href="#l107.126"></a><span id="l107.126">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l107.127"></a><span id="l107.127"> </span>
<a href="#l107.128"></a><span id="l107.128">         free(pref-&gt;stringValue);</span>
<a href="#l107.129"></a><span id="l107.129">         pref-&gt;stringValue = ToNewCString(descriptorString);</span>
<a href="#l107.130"></a><span id="l107.130">       }</span>
<a href="#l107.131"></a><span id="l107.131">     }</span>
<a href="#l107.132"></a><span id="l107.132" class="difflineminus">-    else if (StringEndsWith(prefName, NS_LITERAL_CSTRING(&quot;.newsrc.file&quot;))) {</span>
<a href="#l107.133"></a><span id="l107.133" class="difflineplus">+    else if (StringEndsWith(prefName, &quot;.newsrc.file&quot;_ns)) {</span>
<a href="#l107.134"></a><span id="l107.134">       // copy the news RC file into \News. this won't work if the user has</span>
<a href="#l107.135"></a><span id="l107.135">       // different newsrc files for each account I don't know what to do in</span>
<a href="#l107.136"></a><span id="l107.136">       // that situation.</span>
<a href="#l107.137"></a><span id="l107.137">       nsCOMPtr&lt;nsIFile&gt; targetNewsRCFile;</span>
<a href="#l107.138"></a><span id="l107.138">       mTargetProfile-&gt;Clone(getter_AddRefs(targetNewsRCFile));</span>
<a href="#l107.139"></a><span id="l107.139">       targetNewsRCFile-&gt;Append(NEWS_DIR_50_NAME);</span>
<a href="#l107.140"></a><span id="l107.140"> </span>
<a href="#l107.141"></a><span id="l107.141">       // turn the pref into a nsIFile</span>
<a href="#l107.142"></a><span id="l107.142" class="difflineat">@@ -746,17 +746,17 @@ nsSuiteProfileMigratorBase::CopyMailFold</span>
<a href="#l107.143"></a><span id="l107.143">   }</span>
<a href="#l107.144"></a><span id="l107.144"> </span>
<a href="#l107.145"></a><span id="l107.145">   // Remove all .directory-rel prefs as those might have changed; MailNews</span>
<a href="#l107.146"></a><span id="l107.146">   // will create those prefs again on first use</span>
<a href="#l107.147"></a><span id="l107.147">   for (int32_t i = count; i-- &gt; 0; ) {</span>
<a href="#l107.148"></a><span id="l107.148">     PrefBranchStruct* pref = aMailServers.ElementAt(i);</span>
<a href="#l107.149"></a><span id="l107.149">     nsDependentCString prefName(pref-&gt;prefName);</span>
<a href="#l107.150"></a><span id="l107.150"> </span>
<a href="#l107.151"></a><span id="l107.151" class="difflineminus">-    if (StringEndsWith(prefName, NS_LITERAL_CSTRING(&quot;.directory-rel&quot;))) {</span>
<a href="#l107.152"></a><span id="l107.152" class="difflineplus">+    if (StringEndsWith(prefName, &quot;.directory-rel&quot;_ns)) {</span>
<a href="#l107.153"></a><span id="l107.153">       if (pref-&gt;type == nsIPrefBranch::PREF_STRING)</span>
<a href="#l107.154"></a><span id="l107.154">         free(pref-&gt;stringValue);</span>
<a href="#l107.155"></a><span id="l107.155"> </span>
<a href="#l107.156"></a><span id="l107.156">       aMailServers.RemoveElementAt(i);</span>
<a href="#l107.157"></a><span id="l107.157">     }</span>
<a href="#l107.158"></a><span id="l107.158">   }</span>
<a href="#l107.159"></a><span id="l107.159"> </span>
<a href="#l107.160"></a><span id="l107.160">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1" class="difflineminus">--- a/suite/components/migration/src/nsThunderbirdProfileMigrator.cpp</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineplus">+++ b/suite/components/migration/src/nsThunderbirdProfileMigrator.cpp</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineat">@@ -176,29 +176,29 @@ nsThunderbirdProfileMigrator::FillProfil</span>
<a href="#l108.4"></a><span id="l108.4">   // Find the Thunderbird Registry</span>
<a href="#l108.5"></a><span id="l108.5">   nsCOMPtr&lt;nsIProperties&gt; fileLocator(</span>
<a href="#l108.6"></a><span id="l108.6">     do_GetService(&quot;@mozilla.org/file/directory_service;1&quot;));</span>
<a href="#l108.7"></a><span id="l108.7">   nsCOMPtr&lt;nsIFile&gt; thunderbirdData;</span>
<a href="#l108.8"></a><span id="l108.8"> #ifdef XP_WIN</span>
<a href="#l108.9"></a><span id="l108.9">   fileLocator-&gt;Get(NS_WIN_APPDATA_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l108.10"></a><span id="l108.10">                    getter_AddRefs(thunderbirdData));</span>
<a href="#l108.11"></a><span id="l108.11"> </span>
<a href="#l108.12"></a><span id="l108.12" class="difflineminus">-  thunderbirdData-&gt;Append(NS_LITERAL_STRING(&quot;Thunderbird&quot;));</span>
<a href="#l108.13"></a><span id="l108.13" class="difflineplus">+  thunderbirdData-&gt;Append(u&quot;Thunderbird&quot;_ns);</span>
<a href="#l108.14"></a><span id="l108.14"> </span>
<a href="#l108.15"></a><span id="l108.15"> #elif defined(XP_MACOSX)</span>
<a href="#l108.16"></a><span id="l108.16">   fileLocator-&gt;Get(NS_MAC_USER_LIB_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l108.17"></a><span id="l108.17">                    getter_AddRefs(thunderbirdData));</span>
<a href="#l108.18"></a><span id="l108.18"> </span>
<a href="#l108.19"></a><span id="l108.19" class="difflineminus">-  thunderbirdData-&gt;Append(NS_LITERAL_STRING(&quot;Thunderbird&quot;));</span>
<a href="#l108.20"></a><span id="l108.20" class="difflineplus">+  thunderbirdData-&gt;Append(u&quot;Thunderbird&quot;_ns);</span>
<a href="#l108.21"></a><span id="l108.21"> </span>
<a href="#l108.22"></a><span id="l108.22"> #elif defined(XP_UNIX)</span>
<a href="#l108.23"></a><span id="l108.23">   fileLocator-&gt;Get(NS_UNIX_HOME_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l108.24"></a><span id="l108.24">                    getter_AddRefs(thunderbirdData));</span>
<a href="#l108.25"></a><span id="l108.25"> </span>
<a href="#l108.26"></a><span id="l108.26" class="difflineminus">-  thunderbirdData-&gt;Append(NS_LITERAL_STRING(&quot;.thunderbird&quot;));</span>
<a href="#l108.27"></a><span id="l108.27" class="difflineplus">+  thunderbirdData-&gt;Append(u&quot;.thunderbird&quot;_ns);</span>
<a href="#l108.28"></a><span id="l108.28"> </span>
<a href="#l108.29"></a><span id="l108.29"> #else</span>
<a href="#l108.30"></a><span id="l108.30">   // On other OS just abort</span>
<a href="#l108.31"></a><span id="l108.31">   return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l108.32"></a><span id="l108.32"> #endif</span>
<a href="#l108.33"></a><span id="l108.33"> </span>
<a href="#l108.34"></a><span id="l108.34">   // Try profiles.ini first</span>
<a href="#l108.35"></a><span id="l108.35">   return GetProfileDataFromProfilesIni(thunderbirdData,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1" class="difflineminus">--- a/suite/components/profile/nsSuiteDirectoryProvider.cpp</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineplus">+++ b/suite/components/profile/nsSuiteDirectoryProvider.cpp</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineat">@@ -88,17 +88,17 @@ nsSuiteDirectoryProvider::EnsureProfileF</span>
<a href="#l109.4"></a><span id="l109.4"> {</span>
<a href="#l109.5"></a><span id="l109.5">   nsCOMPtr&lt;nsIFile&gt; defaultsDir;</span>
<a href="#l109.6"></a><span id="l109.6"> </span>
<a href="#l109.7"></a><span id="l109.7">   NS_GetSpecialDirectory(NS_APP_DEFAULTS_50_DIR,</span>
<a href="#l109.8"></a><span id="l109.8">                         getter_AddRefs(defaultsDir));</span>
<a href="#l109.9"></a><span id="l109.9">   if (!defaultsDir)</span>
<a href="#l109.10"></a><span id="l109.10">     return;</span>
<a href="#l109.11"></a><span id="l109.11"> </span>
<a href="#l109.12"></a><span id="l109.12" class="difflineminus">-  nsresult rv = defaultsDir-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;profile&quot;));</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineplus">+  nsresult rv = defaultsDir-&gt;AppendNative(&quot;profile&quot;_ns);</span>
<a href="#l109.14"></a><span id="l109.14">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l109.15"></a><span id="l109.15"> </span>
<a href="#l109.16"></a><span id="l109.16">   defaultsDir-&gt;AppendNative(aLeafName);</span>
<a href="#l109.17"></a><span id="l109.17"> </span>
<a href="#l109.18"></a><span id="l109.18">   defaultsDir-&gt;CopyToNative(aParentDir, aLeafName);</span>
<a href="#l109.19"></a><span id="l109.19"> }</span>
<a href="#l109.20"></a><span id="l109.20"> </span>
<a href="#l109.21"></a><span id="l109.21"> NS_IMPL_ISUPPORTS(nsSuiteDirectoryProvider::AppendingEnumerator,</span>
<a href="#l109.22"></a><span id="l109.22" class="difflineat">@@ -182,41 +182,41 @@ nsSuiteDirectoryProvider::AppendDistroSe</span>
<a href="#l109.23"></a><span id="l109.23">                                                  nsCOMArray&lt;nsIFile&gt; &amp;array)</span>
<a href="#l109.24"></a><span id="l109.24"> {</span>
<a href="#l109.25"></a><span id="l109.25">   nsCOMPtr&lt;nsIFile&gt; searchPlugins;</span>
<a href="#l109.26"></a><span id="l109.26">   nsresult rv = aDirSvc-&gt;Get(NS_XPCOM_CURRENT_PROCESS_DIR,</span>
<a href="#l109.27"></a><span id="l109.27">                              NS_GET_IID(nsIFile),</span>
<a href="#l109.28"></a><span id="l109.28">                              getter_AddRefs(searchPlugins));</span>
<a href="#l109.29"></a><span id="l109.29">   if (NS_FAILED(rv))</span>
<a href="#l109.30"></a><span id="l109.30">     return;</span>
<a href="#l109.31"></a><span id="l109.31" class="difflineminus">-  searchPlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;distribution&quot;));</span>
<a href="#l109.32"></a><span id="l109.32" class="difflineminus">-  searchPlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;searchplugins&quot;));</span>
<a href="#l109.33"></a><span id="l109.33" class="difflineplus">+  searchPlugins-&gt;AppendNative(&quot;distribution&quot;_ns);</span>
<a href="#l109.34"></a><span id="l109.34" class="difflineplus">+  searchPlugins-&gt;AppendNative(&quot;searchplugins&quot;_ns);</span>
<a href="#l109.35"></a><span id="l109.35"> </span>
<a href="#l109.36"></a><span id="l109.36">   bool exists;</span>
<a href="#l109.37"></a><span id="l109.37">   rv = searchPlugins-&gt;Exists(&amp;exists);</span>
<a href="#l109.38"></a><span id="l109.38">   if (NS_FAILED(rv) || !exists)</span>
<a href="#l109.39"></a><span id="l109.39">     return;</span>
<a href="#l109.40"></a><span id="l109.40"> </span>
<a href="#l109.41"></a><span id="l109.41">   nsCOMPtr&lt;nsIFile&gt; commonPlugins;</span>
<a href="#l109.42"></a><span id="l109.42">   rv = searchPlugins-&gt;Clone(getter_AddRefs(commonPlugins));</span>
<a href="#l109.43"></a><span id="l109.43">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l109.44"></a><span id="l109.44" class="difflineminus">-    commonPlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;common&quot;));</span>
<a href="#l109.45"></a><span id="l109.45" class="difflineplus">+    commonPlugins-&gt;AppendNative(&quot;common&quot;_ns);</span>
<a href="#l109.46"></a><span id="l109.46">     rv = commonPlugins-&gt;Exists(&amp;exists);</span>
<a href="#l109.47"></a><span id="l109.47">     if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l109.48"></a><span id="l109.48">         array.AppendObject(commonPlugins);</span>
<a href="#l109.49"></a><span id="l109.49">   }</span>
<a href="#l109.50"></a><span id="l109.50"> </span>
<a href="#l109.51"></a><span id="l109.51">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l109.52"></a><span id="l109.52">   if (prefs) {</span>
<a href="#l109.53"></a><span id="l109.53">     nsCOMPtr&lt;nsIFile&gt; localePlugins;</span>
<a href="#l109.54"></a><span id="l109.54">     rv = searchPlugins-&gt;Clone(getter_AddRefs(localePlugins));</span>
<a href="#l109.55"></a><span id="l109.55">     if (NS_FAILED(rv))</span>
<a href="#l109.56"></a><span id="l109.56">       return;</span>
<a href="#l109.57"></a><span id="l109.57"> </span>
<a href="#l109.58"></a><span id="l109.58" class="difflineminus">-    localePlugins-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;locale&quot;));</span>
<a href="#l109.59"></a><span id="l109.59" class="difflineplus">+    localePlugins-&gt;AppendNative(&quot;locale&quot;_ns);</span>
<a href="#l109.60"></a><span id="l109.60"> </span>
<a href="#l109.61"></a><span id="l109.61">     // we didn't append the locale dir - try the default one</span>
<a href="#l109.62"></a><span id="l109.62">     nsCString defLocale;</span>
<a href="#l109.63"></a><span id="l109.63">     rv = prefs-&gt;GetCharPref(&quot;distribution.searchplugins.defaultLocale&quot;,</span>
<a href="#l109.64"></a><span id="l109.64">                             defLocale);</span>
<a href="#l109.65"></a><span id="l109.65">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l109.66"></a><span id="l109.66">       nsCOMPtr&lt;nsIFile&gt; defLocalePlugins;</span>
<a href="#l109.67"></a><span id="l109.67">       rv = localePlugins-&gt;Clone(getter_AddRefs(defLocalePlugins));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1" class="difflineminus">--- a/suite/components/shell/nsWindowsShellService.cpp</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineplus">+++ b/suite/components/shell/nsWindowsShellService.cpp</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineat">@@ -312,20 +312,20 @@ GetHelperPath(nsString&amp; aPath)</span>
<a href="#l110.4"></a><span id="l110.4">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.5"></a><span id="l110.5"> </span>
<a href="#l110.6"></a><span id="l110.6">   nsCOMPtr&lt;nsIFile&gt; appHelper;</span>
<a href="#l110.7"></a><span id="l110.7">   rv = directoryService-&gt;Get(XRE_EXECUTABLE_FILE,</span>
<a href="#l110.8"></a><span id="l110.8">                              NS_GET_IID(nsIFile),</span>
<a href="#l110.9"></a><span id="l110.9">                              getter_AddRefs(appHelper));</span>
<a href="#l110.10"></a><span id="l110.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.11"></a><span id="l110.11"> </span>
<a href="#l110.12"></a><span id="l110.12" class="difflineminus">-  rv = appHelper-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;uninstall&quot;));</span>
<a href="#l110.13"></a><span id="l110.13" class="difflineplus">+  rv = appHelper-&gt;SetNativeLeafName(&quot;uninstall&quot;_ns);</span>
<a href="#l110.14"></a><span id="l110.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.15"></a><span id="l110.15"> </span>
<a href="#l110.16"></a><span id="l110.16" class="difflineminus">-  rv = appHelper-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;helper.exe&quot;));</span>
<a href="#l110.17"></a><span id="l110.17" class="difflineplus">+  rv = appHelper-&gt;AppendNative(&quot;helper.exe&quot;_ns);</span>
<a href="#l110.18"></a><span id="l110.18">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.19"></a><span id="l110.19"> </span>
<a href="#l110.20"></a><span id="l110.20">   rv = appHelper-&gt;GetPath(aPath);</span>
<a href="#l110.21"></a><span id="l110.21"> </span>
<a href="#l110.22"></a><span id="l110.22">   aPath.Insert('&quot;', 0);</span>
<a href="#l110.23"></a><span id="l110.23">   aPath.Append('&quot;');</span>
<a href="#l110.24"></a><span id="l110.24"> </span>
<a href="#l110.25"></a><span id="l110.25">   return rv;</span>
<a href="#l110.26"></a><span id="l110.26" class="difflineat">@@ -651,17 +651,17 @@ nsWindowsShellService::SetDesktopBackgro</span>
<a href="#l110.27"></a><span id="l110.27">   rv = WriteBitmap(file, container);</span>
<a href="#l110.28"></a><span id="l110.28"> </span>
<a href="#l110.29"></a><span id="l110.29">   // if the file was written successfully, set it as the system wallpaper</span>
<a href="#l110.30"></a><span id="l110.30">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l110.31"></a><span id="l110.31">     nsCOMPtr&lt;nsIWindowsRegKey&gt; key(do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv));</span>
<a href="#l110.32"></a><span id="l110.32">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.33"></a><span id="l110.33"> </span>
<a href="#l110.34"></a><span id="l110.34">     rv = key-&gt;Create(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l110.35"></a><span id="l110.35" class="difflineminus">-                     NS_LITERAL_STRING(&quot;Control Panel\\Desktop&quot;),</span>
<a href="#l110.36"></a><span id="l110.36" class="difflineplus">+                     u&quot;Control Panel\\Desktop&quot;_ns,</span>
<a href="#l110.37"></a><span id="l110.37">                      nsIWindowsRegKey::ACCESS_SET_VALUE);</span>
<a href="#l110.38"></a><span id="l110.38">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.39"></a><span id="l110.39"> </span>
<a href="#l110.40"></a><span id="l110.40">     int style = 0;</span>
<a href="#l110.41"></a><span id="l110.41">     switch (aPosition) {</span>
<a href="#l110.42"></a><span id="l110.42">       case BACKGROUND_STRETCH:</span>
<a href="#l110.43"></a><span id="l110.43">         style = 2;</span>
<a href="#l110.44"></a><span id="l110.44">         break;</span>
<a href="#l110.45"></a><span id="l110.45" class="difflineat">@@ -670,21 +670,21 @@ nsWindowsShellService::SetDesktopBackgro</span>
<a href="#l110.46"></a><span id="l110.46">         break;</span>
<a href="#l110.47"></a><span id="l110.47">       case BACKGROUND_FIT:</span>
<a href="#l110.48"></a><span id="l110.48">         style = 6;</span>
<a href="#l110.49"></a><span id="l110.49">         break;</span>
<a href="#l110.50"></a><span id="l110.50">     }</span>
<a href="#l110.51"></a><span id="l110.51"> </span>
<a href="#l110.52"></a><span id="l110.52">     nsString value;</span>
<a href="#l110.53"></a><span id="l110.53">     value.AppendInt(style);</span>
<a href="#l110.54"></a><span id="l110.54" class="difflineminus">-    rv = key-&gt;WriteStringValue(NS_LITERAL_STRING(&quot;WallpaperStyle&quot;), value);</span>
<a href="#l110.55"></a><span id="l110.55" class="difflineplus">+    rv = key-&gt;WriteStringValue(u&quot;WallpaperStyle&quot;_ns, value);</span>
<a href="#l110.56"></a><span id="l110.56">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.57"></a><span id="l110.57"> </span>
<a href="#l110.58"></a><span id="l110.58">     value.Assign(aPosition == BACKGROUND_TILE ? '1' : '0');</span>
<a href="#l110.59"></a><span id="l110.59" class="difflineminus">-    rv = key-&gt;WriteStringValue(NS_LITERAL_STRING(&quot;TileWallpaper&quot;), value);</span>
<a href="#l110.60"></a><span id="l110.60" class="difflineplus">+    rv = key-&gt;WriteStringValue(u&quot;TileWallpaper&quot;_ns, value);</span>
<a href="#l110.61"></a><span id="l110.61">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.62"></a><span id="l110.62"> </span>
<a href="#l110.63"></a><span id="l110.63">     rv = key-&gt;Close();</span>
<a href="#l110.64"></a><span id="l110.64">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.65"></a><span id="l110.65"> </span>
<a href="#l110.66"></a><span id="l110.66">     ::SystemParametersInfoW(SPI_SETDESKWALLPAPER, 0, (PVOID)path.get(),</span>
<a href="#l110.67"></a><span id="l110.67">                             SPIF_UPDATEINIFILE | SPIF_SENDWININICHANGE);</span>
<a href="#l110.68"></a><span id="l110.68">   }</span>
<a href="#l110.69"></a><span id="l110.69" class="difflineat">@@ -710,23 +710,23 @@ nsWindowsShellService::SetDesktopBackgro</span>
<a href="#l110.70"></a><span id="l110.70"> </span>
<a href="#l110.71"></a><span id="l110.71">   ::SetSysColors(1, &amp;parameter, &amp;color);</span>
<a href="#l110.72"></a><span id="l110.72"> </span>
<a href="#l110.73"></a><span id="l110.73">   nsresult rv;</span>
<a href="#l110.74"></a><span id="l110.74">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key(do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv));</span>
<a href="#l110.75"></a><span id="l110.75">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.76"></a><span id="l110.76"> </span>
<a href="#l110.77"></a><span id="l110.77">   rv = key-&gt;Create(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l110.78"></a><span id="l110.78" class="difflineminus">-                   NS_LITERAL_STRING(&quot;Control Panel\\Colors&quot;),</span>
<a href="#l110.79"></a><span id="l110.79" class="difflineplus">+                   u&quot;Control Panel\\Colors&quot;_ns,</span>
<a href="#l110.80"></a><span id="l110.80">                    nsIWindowsRegKey::ACCESS_SET_VALUE);</span>
<a href="#l110.81"></a><span id="l110.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.82"></a><span id="l110.82"> </span>
<a href="#l110.83"></a><span id="l110.83">   wchar_t rgb[12];</span>
<a href="#l110.84"></a><span id="l110.84">   _snwprintf(rgb, 12, L&quot;%u %u %u&quot;, r, g, b);</span>
<a href="#l110.85"></a><span id="l110.85" class="difflineminus">-  rv = key-&gt;WriteStringValue(NS_LITERAL_STRING(&quot;Background&quot;),</span>
<a href="#l110.86"></a><span id="l110.86" class="difflineplus">+  rv = key-&gt;WriteStringValue(u&quot;Background&quot;_ns,</span>
<a href="#l110.87"></a><span id="l110.87">                              nsDependentString(rgb));</span>
<a href="#l110.88"></a><span id="l110.88">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.89"></a><span id="l110.89"> </span>
<a href="#l110.90"></a><span id="l110.90">   return key-&gt;Close();</span>
<a href="#l110.91"></a><span id="l110.91"> }</span>
<a href="#l110.92"></a><span id="l110.92"> </span>
<a href="#l110.93"></a><span id="l110.93"> NS_IMETHODIMP</span>
<a href="#l110.94"></a><span id="l110.94"> nsWindowsShellService::OpenApplicationWithURI(nsIFile* aApplication,</span>
<a href="#l110.95"></a><span id="l110.95" class="difflineat">@@ -752,17 +752,17 @@ nsWindowsShellService::GetDefaultFeedRea</span>
<a href="#l110.96"></a><span id="l110.96"> {</span>
<a href="#l110.97"></a><span id="l110.97">   *_retval = nullptr;</span>
<a href="#l110.98"></a><span id="l110.98"> </span>
<a href="#l110.99"></a><span id="l110.99">   nsresult rv;</span>
<a href="#l110.100"></a><span id="l110.100">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key(do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv));</span>
<a href="#l110.101"></a><span id="l110.101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.102"></a><span id="l110.102"> </span>
<a href="#l110.103"></a><span id="l110.103">   rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CLASSES_ROOT,</span>
<a href="#l110.104"></a><span id="l110.104" class="difflineminus">-                 NS_LITERAL_STRING(&quot;feed\\shell\\open\\command&quot;),</span>
<a href="#l110.105"></a><span id="l110.105" class="difflineplus">+                 u&quot;feed\\shell\\open\\command&quot;_ns,</span>
<a href="#l110.106"></a><span id="l110.106">                  nsIWindowsRegKey::ACCESS_READ);</span>
<a href="#l110.107"></a><span id="l110.107">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.108"></a><span id="l110.108"> </span>
<a href="#l110.109"></a><span id="l110.109">   nsString path;</span>
<a href="#l110.110"></a><span id="l110.110">   rv = key-&gt;ReadStringValue(EmptyString(), path);</span>
<a href="#l110.111"></a><span id="l110.111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.112"></a><span id="l110.112">   if (path.IsEmpty())</span>
<a href="#l110.113"></a><span id="l110.113">     return NS_ERROR_FAILURE;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

